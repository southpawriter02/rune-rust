# Milestone v0.4.1: Specializations & Ability Trees

> **Status:** Planned
> **Theme:** "The Specialist"
> **Focus:** Character build diversity, ability unlock trees, and progression points.

---

## 1. Overview

**Goal:** Implement a deep specialization system where players spend Progression Points (PP) to unlock abilities within distinct trees. This replaces the linear "unlock by level" model with a choice-driven system.

**Key Features:**
- **Specializations:** Distinct from Archetypes (e.g., a Warrior can specialize as a *Berserkr* or *Guardian*).
- **Ability Trees:** Visual and logical structures of dependent abilities (Tier 1 → Tier 2 → Tier 3 → Capstone).
- **Progression Points (PP):** A new currency earned via Saga/XP milestones, used to purchase nodes.
- **Tree Visualization:** A TUI screen to view and interact with the tree.

---

## 2. Detailed Implementation Plans

### v0.4.1a: Specialization Data & Seeding
**Goal:** Define the data structures for Specializations and Ability Trees, and seed initial content.

**Tasks:**
1.  **Define Models:**
    -   `Specialization` (Id, Name, Description, ArchetypeRequirement).
    -   `SpecializationNode` (Id, AbilityId, Tier, ParentNodeIds, CostPP, PositionX/Y for UI).
    -   `SpecializationTree` (Collection of Nodes).
2.  **Define Entities:**
    -   Update `Character` to hold `UnlockedSpecializationIds` and `UnlockedAbilityNodeIds`.
    -   Update `Character` to hold `ProgressionPoints` (PP).
3.  **Seed Data:**
    -   **Skald** (Investigator Spec): Focus on buffs/debuffs/shouts.
    -   **Berserkr** (Warrior Spec): Focus on rage/damage-for-health.
    -   *Note: Use existing abilities or create placeholder new ones.*
4.  **Repository Layer:**
    -   `ISpecializationRepository` to fetch specs and trees.

### v0.4.1b: The Unlock Service
**Goal:** Implement the logic for unlocking specializations and purchasing nodes.

**Tasks:**
1.  **SpecializationService:**
    -   `UnlockSpecialization(Character, SpecId)`: Checks requirements (e.g., Archetype, Level, Quest items?).
    -   `CanUnlockNode(Character, NodeId)`: Checks PP, Parent Nodes unlocked, Tier requirements.
    -   `UnlockNode(Character, NodeId)`: Deducts PP, adds Ability to `Character.Abilities` (or distinct list), saves state.
2.  **Validation Logic:**
    -   Ensure no cycles in tree (though data structure should prevent this).
    -   Ensure Tier gates (e.g., Tier 2 requires X points in Tier 1? Or just parent connection?). *Design Decision: Strict Parent Connection.*

### v0.4.1c: Ability Integration
**Goal:** Ensure unlocked abilities are usable in combat.

**Tasks:**
1.  **Character Ability List:**
    -   Refactor `Character.Abilities` to be a union of `Archetype.StartingAbilities` + `UnlockedSpecializationAbilities`.
2.  **Combat Integration:**
    -   Ensure `CombatService` loads all unlocked abilities.
    -   Verify resource costs (PP vs Stamina/Ap usage).
    -   *Note: PP is for unlocking, Stamina/AP is for usage.*

### v0.4.1d: The Specialization UI (The Grid)
**Goal:** A TUI screen to visualize the tree and spend points.

**Tasks:**
1.  **Tree Visualization:**
    -   Render nodes in a grid or list format.
    -   Show connections (arrows or indentation).
    -   Visual feedback for Unlocked vs Locked vs Affordable.
2.  **Interaction:**
    -   Cursor movement to select nodes.
    -   "Buy" action.
    -   "View Details" action.
3.  **Integration:**
    -   Add "Specializations" tab to Character Sheet or Main Menu.

---

## 3. Specifications to Create

-   `docs/specs/character/SPEC-SPECIALIZATION-001.md`: The core logic for trees, nodes, and PP.

---

## 4. Risks & Considerations

-   **UI Complexity:** Rendering a tree in TUI can be messy. *Mitigation: Start with a Tier-grouped list view if the tree visual is too hard, but aim for a simple grid.*
-   **Content Load:** Creating distinct abilities for trees requires design work. *Mitigation: Seed with placeholders or reuse existing abilities first.*
-   **Save Compatibility:** Adding `UnlockedNodes` to Character requires DB migration.

---

## 5. Domain 4 Compliance (Narrative)

-   **"Progression Points":** Rename to "Memory Fragments" or "Echoes" in flavor text?
    -   *Decision:* Keep "Progression Points" in code/mechanics, but UI can label them "Saga Echoes".
-   **"Specialization":** "Path" or "Discipline".
-   **"Unlock":** "Remember" or "Inscribe".

*Example:* "You spend 1 Saga Echo to Inscribe the 'Rage' rune."
