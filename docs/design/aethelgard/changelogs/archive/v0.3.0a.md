> **Archived** - This changelog has been consolidated. See the complete version at [v0.3.0](../v0.3.x/v0.3.0.md).

# v0.3.0a Changelog: The Weight (Psychic Stress & Resolve)

**Release Date:** 2025-12-20
**Milestone:** v0.3.0 - The Trauma Economy (1 of 3)
**Test Count:** 1555 tests (46 new)

---

## Summary

This release introduces the **Psychic Stress** system, a 0-100 accumulating resource that represents psychological trauma and mental strain. Unlike HP which depletes, stress builds up during combat and dangerous encounters. The core mechanic features **WILL-based Resolve Checks** where each success on a WILL dice pool roll reduces incoming stress by 1. Stress affects combat performance through a **Defense Penalty** (stress / 20, max 5), making high-stress combatants easier to hit. The Combat UI now displays stress with a **6-tier color-coded status indicator** (Stable → Unsettled → Shaken → Distressed → Fractured → BREAKING). This lays the foundation for the full Trauma Economy system in subsequent v0.3.0 releases.

---

## New Features

### Psychic Stress System

Core stress mechanics:

| Component | Formula | Description |
|-----------|---------|-------------|
| **Max Stress** | 100 (fixed) | All combatants have 100 max stress |
| **Resolve Check** | Roll WILL d10 pool | Each success reduces incoming stress by 1 |
| **Net Stress** | Raw - Mitigation | Minimum 0 (cannot go negative) |
| **Breaking Point** | Stress = 100 | Triggers special event (implemented in v0.3.0c) |

### Stress Status Tiers

| Status | Range | Defense Penalty | UI Color |
|--------|-------|-----------------|----------|
| Stable | 0-19 | 0 | Green |
| Unsettled | 20-39 | 1 | Cyan |
| Shaken | 40-59 | 2 | Yellow |
| Distressed | 60-79 | 3 | Magenta |
| Fractured | 80-99 | 4 | Red |
| BREAKING | 100 | 5 | Bold Red |

### Defense Integration

Stress now affects the defense calculation:

```
Defense Score = 10 + FINESSE - Stress Penalty
Stress Penalty = stress / 20 (max 5)
```

**Example:** A combatant with FINESSE 5 and 60 stress:
- Defense = 10 + 5 - 3 = 12 (instead of 15)

### Combat UI Stress Display

The combat header now shows stress alongside HP and Stamina:

```
──────── COMBAT ────────────────────────────────────────────────
  HP: 45/60    Stamina: 35/50    Stress: 45 (Shaken)
```

Stress color changes based on tier for immediate visual feedback.

---

## New Files

| File | Purpose |
|------|---------|
| `RuneAndRust.Core/Enums/StressStatus.cs` | 6-tier stress classification enum |
| `RuneAndRust.Core/Models/Combat/StressResult.cs` | Record for stress infliction/recovery results |
| `RuneAndRust.Core/Interfaces/ITraumaService.cs` | Service contract for stress mechanics |
| `RuneAndRust.Engine/Services/TraumaService.cs` | Implementation of stress mechanics with WILL-based resolve |
| `RuneAndRust.Tests/Engine/TraumaServiceTests.cs` | 24 unit tests for TraumaService |

---

## Modified Files

| File | Changes |
|------|---------|
| `RuneAndRust.Core/Entities/Character.cs` | Added `PsychicStress` (0-100) and `MaxPsychicStress` (always 100) properties |
| `RuneAndRust.Core/Models/Combat/Combatant.cs` | Added `CurrentStress`, `MaxStress`; updated `FromCharacter()` and `FromEnemy()` factory methods |
| `RuneAndRust.Core/ViewModels/CombatViewModel.cs` | Added `CurrentStress`, `MaxStress` to `PlayerStatsView` record |
| `RuneAndRust.Engine/Services/AttackResolutionService.cs` | Injected `ITraumaService`; `CalculateDefenseScore()` now includes stress penalty |
| `RuneAndRust.Engine/Services/CombatService.cs` | Updated `GetViewModel()` to pass stress to `PlayerStatsView` |
| `RuneAndRust.Terminal/Services/CombatScreenRenderer.cs` | Added 6-tier stress color coding and label display in `RenderHeader()` |
| `RuneAndRust.Terminal/Program.cs` | Registered `ITraumaService` as Singleton; updated version to v0.3.0a |
| `RuneAndRust.Tests/Engine/AttackResolutionServiceTests.cs` | Added `ITraumaService` mock; added stress penalty tests |

---

## Code Implementation Details

### StressStatus Enum

```csharp
public enum StressStatus
{
    Stable = 0,      // 0-19
    Unsettled = 1,   // 20-39
    Shaken = 2,      // 40-59
    Distressed = 3,  // 60-79
    Fractured = 4,   // 80-99
    Breaking = 5     // 100
}
```

### StressResult Record

```csharp
public record StressResult(
    int RawStress,           // Initial stress amount
    int MitigatedAmount,     // Stress reduced by WILL successes
    int NetStressApplied,    // Actual stress added (Raw - Mitigated)
    int CurrentTotal,        // New stress total after application
    StressStatus PreviousStatus,
    StressStatus NewStatus,
    bool IsBreakingPoint,    // True if stress just hit 100
    int ResolveSuccesses,    // WILL roll successes
    string Source            // What caused the stress
);
```

### ITraumaService Interface

```csharp
public interface ITraumaService
{
    StressResult InflictStress(Combatant target, int amount, string source);
    StressResult RecoverStress(Combatant target, int amount, string source);
    StressStatus GetStressStatus(int stressValue);
    int GetDefensePenalty(int stressValue);
    void HandleBreakingPoint(Combatant target); // Stub for v0.3.0c
}
```

### Key TraumaService Methods

**InflictStress:**
```csharp
public StressResult InflictStress(Combatant target, int amount, string source)
{
    // 1. Roll WILL dice pool for resolve check
    var willValue = target.GetAttribute(CharacterAttribute.Will);
    var resolveRoll = _dice.Roll(willValue, $"{target.Name} Resolve Check");

    // 2. Each success mitigates 1 stress
    var mitigation = resolveRoll.Successes;
    var netStress = Math.Max(0, amount - mitigation);

    // 3. Apply stress, clamped to 0-100
    target.CurrentStress = Math.Clamp(target.CurrentStress + netStress, 0, 100);

    // 4. Check for breaking point (first time hitting 100)
    var isBreakingPoint = target.CurrentStress >= 100 && previousStress < 100;

    return new StressResult(...);
}
```

**GetDefensePenalty:**
```csharp
public int GetDefensePenalty(int stressValue)
{
    // Defense penalty = stress / 20, max 5
    // 0-19 = 0, 20-39 = 1, 40-59 = 2, 60-79 = 3, 80-99 = 4, 100 = 5
    return Math.Min(5, stressValue / 20);
}
```

### AttackResolutionService Defense Integration

```csharp
public int CalculateDefenseScore(Combatant defender)
{
    var finesse = defender.GetAttribute(CharacterAttribute.Finesse);
    var stressPenalty = _traumaService.GetDefensePenalty(defender.CurrentStress);
    var defense = 10 + finesse - stressPenalty;
    return defense;
}
```

### Combat Screen Stress Display

```csharp
// Stress color mapping based on tier
var stressColor = stats.CurrentStress switch
{
    >= 100 => "bold red",   // Breaking
    >= 80 => "red",          // Fractured
    >= 60 => "magenta",      // Distressed
    >= 40 => "yellow",       // Shaken
    >= 20 => "cyan",         // Unsettled
    _ => "green"             // Stable
};

AnsiConsole.MarkupLine(
    $"  [bold]HP:[/] [{hpColor}]{stats.CurrentHp}/{stats.MaxHp}[/]    " +
    $"[bold]Stamina:[/] [{staminaColor}]{stats.CurrentStamina}/{stats.MaxStamina}[/]    " +
    $"[bold]Stress:[/] [{stressColor}]{stats.CurrentStress}[/] [grey]({stressLabel})[/]");
```

---

## Architecture

### Stress Infliction Flow

```
Trauma Event (e.g., witness ally death, encounter horror)
    │
    └─ TraumaService.InflictStress(target, rawAmount, "Witnessed Ally Death")
          │
          ├─ Get target.GetAttribute(WILL) → willValue
          │
          ├─ DiceService.Roll(willValue, "Resolve Check")
          │     └─ Returns: successes, botches, individual rolls
          │
          ├─ mitigation = successes
          │
          ├─ netStress = Max(0, rawAmount - mitigation)
          │
          ├─ target.CurrentStress = Clamp(current + net, 0, 100)
          │
          ├─ If CurrentStress >= 100 && was < 100
          │     └─ HandleBreakingPoint(target) [stub for v0.3.0c]
          │
          └─ Return StressResult with all details
```

### Defense Calculation Flow

```
AttackResolutionService.ResolveMeleeAttack()
    │
    └─ CalculateDefenseScore(defender)
          │
          ├─ finesse = defender.GetAttribute(FINESSE)
          │
          ├─ stressPenalty = _traumaService.GetDefensePenalty(defender.CurrentStress)
          │     └─ Returns: stress / 20 (capped at 5)
          │
          └─ defense = 10 + finesse - stressPenalty
```

---

## Logging Matrix

### TraumaService Logs

| Event | Level | Template |
|-------|-------|----------|
| Stress Infliction Start | Information | `"Inflicting {Amount} stress on {Target} from {Source}"` |
| Resolve Check Result | Debug | `"Resolve check: {Will}d10 = {Successes} successes. Raw {Raw} - Mitigated {Mit} = Net {Net}"` |
| Stress Change | Debug | `"{Target} stress: {Previous} -> {Current} (Status: {Status})"` |
| Status Transition | Information | `"{Target} stress status changed: {Previous} -> {New}"` |
| Breaking Point | Warning | `"{Target} has reached the BREAKING POINT!"` |
| Stress Recovery Start | Information | `"Recovering {Amount} stress from {Target} via {Source}"` |
| Stress Recovery Result | Debug | `"{Target} stress recovered: {Previous} -> {Current} (Status: {Status})"` |
| Status Improvement | Information | `"{Target} stress status improved: {Previous} -> {New}"` |

### AttackResolutionService Logs

| Event | Level | Template |
|-------|-------|----------|
| Defense Calculation | Trace | `"Defense: 10 + Finesse({Finesse}) - StressPenalty({Penalty}) = {Defense}"` |

---

## Test Coverage Matrix

### TraumaServiceTests (24 tests)

| Test Name | Category | Validates |
|-----------|----------|-----------|
| `GetStressStatus_ReturnsCorrectTier` | Unit | 17 inline data cases for all tier boundaries |
| `GetDefensePenalty_ReturnsCorrectValue` | Unit | 12 inline data cases including cap at 5 |
| `GetDefensePenalty_CapsAtFive` | Unit | Penalty never exceeds 5 |
| `InflictStress_ReducesByWillSuccesses` | Unit | WILL mitigation math |
| `InflictStress_ZeroNetOnHighResistance` | Unit | Full mitigation scenario |
| `InflictStress_ClampsAt100` | Unit | Max stress cap |
| `InflictStress_TriggersBreakingPointAt100` | Unit | Breaking point flag |
| `InflictStress_NoBreakingPointIfAlreadyAt100` | Unit | No repeat breaking |
| `InflictStress_TracksStatusTransition` | Unit | Status tracking |
| `InflictStress_StoresSourceInResult` | Unit | Source preservation |
| `InflictStress_UsesCorrectWillAttribute` | Integration | WILL attribute lookup |
| `InflictStress_WorksWithEnemyCombatant` | Integration | Enemy compatibility |
| `RecoverStress_ReducesStress` | Unit | Recovery math |
| `RecoverStress_ClampsAtZero` | Unit | Min stress cap |
| `RecoverStress_TracksStatusTransition` | Unit | Status improvement |
| `RecoverStress_NeverTriggersBreakingPoint` | Unit | No breaking on recovery |
| `RecoverStress_ReturnsNegativeRawStress` | Unit | Negative raw for recovery |

### AttackResolutionServiceTests (2 new tests)

| Test Name | Category | Validates |
|-----------|----------|-----------|
| `CalculateDefenseScore_IncludesStressPenalty` | Integration | Defense uses stress penalty |
| `CalculateDefenseScore_WithMaxStressPenalty` | Integration | Max penalty of 5 at breaking point |

---

## DI Registration

### Program.cs Changes

```csharp
// Register Trauma Service (v0.3.0a) - BEFORE AttackResolutionService
services.AddSingleton<ITraumaService, TraumaService>();

// AttackResolutionService now depends on ITraumaService
services.AddSingleton<IAttackResolutionService, AttackResolutionService>();
```

**Registration Order:** `ITraumaService` must be registered before `IAttackResolutionService` since the latter depends on the former.

### AttackResolutionService Constructor (Breaking Change)

**Before (v0.2.3c):**
```csharp
public AttackResolutionService(
    IDiceService dice,
    IStatusEffectService statusEffects,
    ILogger<AttackResolutionService> logger)
```

**After (v0.3.0a):**
```csharp
public AttackResolutionService(
    IDiceService dice,
    IStatusEffectService statusEffects,
    ITraumaService traumaService,  // NEW
    ILogger<AttackResolutionService> logger)
```

---

## Migration Notes

### For Developers

If you have custom `AttackResolutionService` instantiations, add the `ITraumaService`:

```csharp
// Update your mocks in tests
var mockTraumaService = new Mock<ITraumaService>();
mockTraumaService.Setup(t => t.GetDefensePenalty(It.IsAny<int>())).Returns(0);

_sut = new AttackResolutionService(
    _mockDice.Object,
    _mockStatusEffects.Object,
    mockTraumaService.Object,  // NEW
    _mockLogger.Object);
```

### Entity Updates

`Character` entities now include `PsychicStress`:
```csharp
// New property (default 0)
character.PsychicStress = 0;

// Read-only max (always 100)
var max = character.MaxPsychicStress; // 100
```

`Combatant` adapters now include stress:
```csharp
// FromCharacter copies stress
combatant.CurrentStress = character.PsychicStress;

// FromEnemy starts at 0
combatant.CurrentStress = 0;
```

---

## Known Limitations

1. **Stress Sources Not Implemented:** No game events currently inflict stress (coming in v0.3.0b)
2. **Breaking Point Is Stub:** Reaching 100 stress logs a warning but has no gameplay effect (v0.3.0c)
3. **No Stress Recovery Mechanics:** Recovery method exists but nothing calls it yet
4. **Stress Not Persisted:** Character.PsychicStress is not saved to database yet
5. **Enemy Stress Ignored:** Enemies start at 0 and never gain stress in current implementation

---

## Verification Results

### Build Output

```
Build succeeded.
    63 Warning(s)
    0 Error(s)
```

### Test Output

```
Test run for RuneAndRust.Tests.dll (.NETCoreApp,Version=v9.0)
VSTest version 17.14.1 (arm64)

Starting test execution, please wait...
A total of 1 test files matched the specified pattern.

Passed!  - Failed:     0, Passed:  1555, Skipped:     0, Total:  1555, Duration: 575 ms
```

---

## Directory Structure After Release

```
RuneAndRust.Core/
├── Entities/
│   └── Character.cs                    [MODIFIED - added PsychicStress, MaxPsychicStress]
├── Enums/
│   └── StressStatus.cs                 [NEW]
├── Interfaces/
│   └── ITraumaService.cs               [NEW]
├── Models/Combat/
│   ├── Combatant.cs                    [MODIFIED - added CurrentStress, MaxStress]
│   └── StressResult.cs                 [NEW]
├── ViewModels/
│   └── CombatViewModel.cs              [MODIFIED - added stress to PlayerStatsView]

RuneAndRust.Engine/Services/
├── AttackResolutionService.cs          [MODIFIED - injected ITraumaService, stress penalty]
├── CombatService.cs                    [MODIFIED - stress in GetViewModel]
├── TraumaService.cs                    [NEW]

RuneAndRust.Terminal/
├── Program.cs                          [MODIFIED - registered ITraumaService, version bump]
├── Services/
│   └── CombatScreenRenderer.cs         [MODIFIED - stress bar display]

RuneAndRust.Tests/Engine/
├── AttackResolutionServiceTests.cs     [MODIFIED - added ITraumaService mock, stress tests]
├── TraumaServiceTests.cs               [NEW - 24 tests]
```

---

## Milestone v0.3.0 Progress

This release begins the v0.3.0 milestone "The Trauma Economy":

| Sub-version | Feature | Status |
|-------------|---------|--------|
| v0.3.0a | Psychic Stress & Resolve | **Complete** |
| v0.3.0b | Stress Sources (Combat Events) | Pending |
| v0.3.0c | Breaking Point & Trauma Selection | Pending |

---

## Next Steps (v0.3.0b)

- Implement stress sources for combat events:
  - Ally death: 15-25 stress
  - Critical hit received: 5-10 stress
  - Fumble attack: 3-5 stress
  - Horror creature encounter: 10-20 stress
- Add stress to combat log messages
- Implement stress recovery during rest
- Add visual/audio feedback for stress tier changes
- Create Breaking Point event placeholder for v0.3.0c

---

## Contributors

- Implementation: Claude Opus 4.5
