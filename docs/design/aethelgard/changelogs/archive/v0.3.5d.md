> **Archived** - This changelog has been consolidated. See the complete version at [v0.3.5](../v0.3.x/v0.3.5.md).

# Changelog: v0.3.5d - The Stabilizer (Bug Fixes & Polish)

**Release Date:** 2025-12-21
**Codename:** The Stabilizer
**Status:** Complete

---

## Summary

Version 0.3.5d addresses critical runtime issues discovered after v0.3.5c deployment, including an EF Core TPH index conflict that prevented application startup, missing database migrations, mouse event interference with console input, and improved UX for duplicate character name handling.

---

## Bug Fixes

### 1. EF Core TPH Index Conflict (Critical)

**Issue:** Application crashed on startup with `InvalidOperationException`:
```
The index {'RoomId'} cannot be added to the entity type 'InteractableObject'
because an unnamed index on the same properties already exists on entity type 'DynamicHazard'.
```

**Root Cause:** EF Core's Table-per-Hierarchy (TPH) configuration for `InteractableObject` and `DynamicHazard` created conflicting unnamed indexes when both entities mapped to the same table.

**Fix:**
- Removed explicit `HasIndex()` call from `InteractableObject` configuration
- Added `HasBaseType<InteractableObject>()` to `DynamicHazard` configuration
- Index on `RoomId` should be created via database migration instead

**Files Modified:**
| File | Change |
|------|--------|
| `RuneAndRust.Persistence/Data/RuneAndRustDbContext.cs` | Removed index definition, added HasBaseType |

### 2. Missing Database Tables

**Issue:** Application failed with `relation "AmbientConditions" does not exist` after fixing the TPH issue.

**Root Cause:** The `AmbientConditions` and `HazardTemplates` tables were defined in the DbContext but never migrated to the database.

**Fix:**
- Created new EF Core migration `AddEnvironmentEcosystemTables`
- Applied pending migrations to PostgreSQL database

**Files Created:**
| File | Purpose |
|------|---------|
| `RuneAndRust.Persistence/Migrations/20251222025251_AddEnvironmentEcosystemTables.cs` | Migration for new tables |

### 3. Mouse Event Interference (Terminal)

**Issue:** "Press any key to continue" prompts triggered repeatedly due to mouse movement events being interpreted as key presses by `Console.ReadKey()`.

**Root Cause:** Some terminals send mouse tracking escape sequences that `Console.ReadKey()` interprets as valid key presses, causing unwanted screen refreshes and infinite loops.

**Fix:**
- Created `ConsoleInputHelper` utility class that filters out:
  - Escape sequences from mouse events
  - Null/empty key events from mouse tracking
- Updated all "Press any key" prompts to use `ConsoleInputHelper.WaitForKeyPress()`

**Files Created:**
| File | Purpose |
|------|---------|
| `RuneAndRust.Terminal/Helpers/ConsoleInputHelper.cs` | Mouse event filtering utility |

**Files Modified:**
| File | Change |
|------|--------|
| `RuneAndRust.Terminal/Services/CreationWizard.cs` | Uses ConsoleInputHelper |
| `RuneAndRust.Terminal/Rendering/TypewriterRenderer.cs` | Uses ConsoleInputHelper |
| `RuneAndRust.Terminal/Services/VictoryScreenRenderer.cs` | Uses ConsoleInputHelper |
| `RuneAndRust.Terminal/Services/RestScreenRenderer.cs` | Uses ConsoleInputHelper |

### 4. Duplicate Character Name Handling

**Issue:** When entering a duplicate character name, the wizard cancelled entirely instead of allowing retry.

**Root Cause:** The name validation logic returned `null` immediately on duplicate detection.

**Fix:**
- Changed name entry to loop until valid name is provided or user cancels
- Added helpful error message: "A character with that name already exists. Please choose another."

**Files Modified:**
| File | Change |
|------|--------|
| `RuneAndRust.Terminal/Services/CreationWizard.cs` | Name entry now loops on duplicate |

---

## New Files

| File | Layer | Purpose |
|------|-------|---------|
| `RuneAndRust.Terminal/Helpers/ConsoleInputHelper.cs` | Terminal | Mouse event filtering for console input |
| `RuneAndRust.Persistence/Migrations/20251222025251_AddEnvironmentEcosystemTables.cs` | Persistence | Database migration |

---

## Implementation Details

### ConsoleInputHelper

```csharp
public static class ConsoleInputHelper
{
    public static ConsoleKeyInfo ReadKeyFiltered(bool intercept = true)
    {
        while (true)
        {
            var key = Console.ReadKey(intercept);

            // Filter out escape sequences from mouse events
            if (key.Key == ConsoleKey.Escape)
            {
                DrainEscapeSequence();
                continue;
            }

            // Filter out null/empty key events
            if (key.KeyChar == '\0' && key.Key == 0)
                continue;

            return key;
        }
    }

    public static void WaitForKeyPress() => ReadKeyFiltered(intercept: true);

    private static void DrainEscapeSequence()
    {
        Thread.Sleep(10);
        while (Console.KeyAvailable)
            Console.ReadKey(intercept: true);
    }
}
```

### TPH Index Resolution

The EF Core configuration was updated to avoid index conflicts:

```csharp
// InteractableObject configuration
modelBuilder.Entity<InteractableObject>(entity =>
{
    // ... discriminator setup ...

    // Note: Index on RoomId is created via migration, not here.
    // TPH inheritance with DynamicHazard causes EF Core to create
    // conflicting unnamed indexes.

    entity.Property(o => o.RoomId).IsRequired();
});

// DynamicHazard configuration
modelBuilder.Entity<DynamicHazard>(entity =>
{
    // Explicitly set base type to prevent duplicate index creation
    entity.HasBaseType<InteractableObject>();
    // ... property configurations ...
});
```

### Character Name Retry Loop

```csharp
// Step 0: Name entry with duplicate check loop (v0.3.5d)
string? name = null;
while (name == null)
{
    var enteredName = PromptForName();
    if (string.IsNullOrEmpty(enteredName) ||
        enteredName.Equals("cancel", StringComparison.OrdinalIgnoreCase))
    {
        return null;
    }

    if (await _characterRepository.NameExistsAsync(enteredName))
    {
        AnsiConsole.MarkupLine(
            "[red]A character with that name already exists. Please choose another.[/]");
    }
    else
    {
        name = enteredName;
    }
}
```

---

## Test Coverage

All 1880 existing unit tests continue to pass. No new tests were added as changes were primarily infrastructure/UX fixes.

---

## Logging Matrix

| Context | Level | Template |
|---------|-------|----------|
| Duplicate Name | Warning | `"[Wizard] Duplicate character name attempted: {Name}"` |
| Name Entry Cancel | Info | `"[Wizard] Character creation cancelled at name entry"` |

---

## Breaking Changes

None. All changes are backwards compatible.

---

## Known Limitations

1. **Alternative Mouse Fix:** Users can also disable mouse reporting in terminal settings as an alternative to the code fix.

2. **Terminal Compatibility:** The `ConsoleInputHelper` has been tested with common terminals. Exotic terminal emulators may have different escape sequence patterns.

---

## Migration Required

After updating to v0.3.5d, run the following to apply database migrations:

```bash
dotnet ef database update --project RuneAndRust.Persistence --startup-project RuneAndRust.Terminal
```

---

## Version History

| Version | Codename | Focus |
|---------|----------|-------|
| v0.3.5a | The Cartographer's Easel | ExplorationScreenRenderer foundation |
| v0.3.5b | The Cartographer | MinimapRenderer with Fog of War |
| v0.3.5c | The Surveyor | RoomRenderer with entity display |
| v0.3.5d | The Stabilizer | Bug fixes and polish |

---

## Next Steps (v0.3.6 Candidates)

1. **CommandBarRenderer** - Display available commands at the bottom
2. **ContextualHelpPanel** - Show context-sensitive help based on room contents
3. **NotificationToast** - Display transient messages for actions
