# v0.7.3a Design Specification: Combat Grid Display

**Version:** 0.7.3a
**Parent:** v0.7.3 (Combat Integration)
**Prerequisites:** v0.7.2c Complete (Interactive Panels - Command Input)
**Status:** Design Complete
**Estimated Unit Tests:** ~10

---

## Table of Contents

1. [Overview](#1-overview)
2. [Feature Overview](#2-feature-overview)
3. [Architecture](#3-architecture)
4. [Combat Grid Panel](#4-combat-grid-panel)
5. [Combat Grid Panel ViewModel](#5-combat-grid-panel-viewmodel)
6. [Grid Cell Control](#6-grid-cell-control)
7. [Entity Token Control](#7-entity-token-control)
8. [Grid Cell ViewModel](#8-grid-cell-viewmodel)
9. [Entity Token ViewModel](#9-entity-token-viewmodel)
10. [Styles](#10-styles)
11. [Data Model Changes](#11-data-model-changes)
12. [Logging Specifications](#12-logging-specifications)
13. [Unit Testing Requirements](#13-unit-testing-requirements)
14. [Use Cases](#14-use-cases)
15. [Deliverable Checklist](#15-deliverable-checklist)
16. [Acceptance Criteria](#16-acceptance-criteria)
17. [Dependencies](#17-dependencies)
18. [Future Considerations](#18-future-considerations)

---

## 1. Overview

### Purpose

This phase implements the visual combat grid that displays the tactical battlefield. The grid shows cells with terrain types (floor, walls, water, hazards, cover), entity tokens representing players and monsters, coordinate labels for reference, and a legend explaining symbols. The combat grid appears when combat begins and hides when combat ends.

### Key Deliverables

| Category | Items |
|----------|-------|
| **User Controls** | `CombatGridPanel`, `GridCellControl`, `EntityTokenControl` |
| **ViewModels** | `CombatGridPanelViewModel`, `GridCellViewModel`, `EntityTokenViewModel` |
| **Enums** | `GridCellType`, `HighlightType` |
| **Styles** | `CombatGridStyles.axaml` |
| **Tests** | ~10 unit tests |

### Design Principles

1. **Clear Visualization**: Terrain and entities easily distinguishable
2. **Faction Colors**: Token colors indicate friend vs foe
3. **Responsive Updates**: Grid reflects combat state changes immediately
4. **Accessibility**: Coordinate labels and legend for clarity

---

## 2. Feature Overview

```
v0.7.3a Features
├── Combat Grid Panel (UserControl)
│   ├── Grid container
│   ├── Coordinate labels (A-H, 1-8)
│   ├── Cell grid (8x8 default)
│   ├── Entity token overlay
│   └── Legend display
├── Grid Cell Control (TemplatedControl)
│   ├── CellType property (Floor, Wall, Water, Hazard, Cover)
│   ├── IsHighlighted property
│   ├── HighlightType property
│   ├── HasEntity property
│   ├── Cell background brush
│   └── Cell symbol display
├── Entity Token Control (TemplatedControl)
│   ├── Entity property
│   ├── IsSelected property
│   ├── IsCurrentTurn property
│   ├── Token symbol (@, M, etc.)
│   ├── Token color by faction
│   ├── Facing indicator
│   └── Tooltip (name, HP)
├── Grid Cell ViewModel
│   ├── Position property
│   ├── CellType property
│   ├── IsWalkable property
│   ├── IsHighlighted property
│   └── HighlightType property
├── Entity Token ViewModel
│   ├── Combatant property
│   ├── Position property
│   ├── Symbol property
│   ├── Color property
│   ├── IsPlayer property
│   └── IsCurrentTurn property
└── Enums
    ├── GridCellType (Floor, Wall, Water, Hazard, Cover)
    └── HighlightType (None, Movement, Attack, Ability, Hover)
```

---

## 3. Architecture

### Component Diagram

```
┌─────────────────────────────────────────────────────────────────────────┐
│                       PRESENTATION LAYER                                │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  VIEWS                                                                  │
│  ┌───────────────────────────────────────────────────────────────────┐ │
│  │                      CombatGridPanel                               │ │
│  ├───────────────────────────────────────────────────────────────────┤ │
│  │ - CoordinateLabels (Row: A-H, Column: 1-8)                        │ │
│  │ - GridContainer (UniformGrid of GridCellControls)                 │ │
│  │ - TokenOverlay (Canvas with EntityTokenControls)                  │ │
│  │ - LegendPanel (Grid symbol explanations)                          │ │
│  └────────────────────────────────┬──────────────────────────────────┘ │
│                                   │ DataContext                        │
│                                   ▼                                    │
│  VIEWMODELS                                                             │
│  ┌───────────────────────────────────────────────────────────────────┐ │
│  │                  CombatGridPanelViewModel                          │ │
│  ├───────────────────────────────────────────────────────────────────┤ │
│  │ + Cells: ObservableCollection<ObservableCollection<GridCellVM>>   │ │
│  │ + Tokens: ObservableCollection<EntityTokenViewModel>              │ │
│  │ + GridWidth: int (default 8)                                      │ │
│  │ + GridHeight: int (default 8)                                     │ │
│  │ + IsInCombat: bool                                                │ │
│  │ + RowLabels: IReadOnlyList<string> (A-H)                          │ │
│  │ + ColumnLabels: IReadOnlyList<int> (1-8)                          │ │
│  │ + LegendItems: IReadOnlyList<LegendItem>                          │ │
│  │ - HandleCombatStateChanged(bool)                                  │ │
│  │ - InitializeGrid()                                                │ │
│  │ - RefreshGrid()                                                   │ │
│  │ - RefreshTokens()                                                 │ │
│  └───────────────────────────────────────────────────────────────────┘ │
│                                                                         │
│  CUSTOM CONTROLS                                                        │
│  ┌───────────────────────────────────────────────────────────────────┐ │
│  │                      GridCellControl                               │ │
│  ├───────────────────────────────────────────────────────────────────┤ │
│  │ + CellType: GridCellType (StyledProperty)                         │ │
│  │ + IsHighlighted: bool (StyledProperty)                            │ │
│  │ + HighlightType: HighlightType (StyledProperty)                   │ │
│  │ + HasEntity: bool (StyledProperty)                                │ │
│  │ + CellBackground: IBrush (computed)                               │ │
│  │ + CellSymbol: string (computed)                                   │ │
│  └───────────────────────────────────────────────────────────────────┘ │
│  ┌───────────────────────────────────────────────────────────────────┐ │
│  │                      EntityTokenControl                            │ │
│  ├───────────────────────────────────────────────────────────────────┤ │
│  │ + Entity: Combatant? (StyledProperty)                             │ │
│  │ + IsSelected: bool (StyledProperty)                               │ │
│  │ + IsCurrentTurn: bool (StyledProperty)                            │ │
│  │ + TokenSymbol: string (computed)                                  │ │
│  │ + TokenColor: IBrush (computed)                                   │ │
│  │ + Tooltip: string (computed)                                      │ │
│  └───────────────────────────────────────────────────────────────────┘ │
│                                                                         │
└────────────────────────────────────┬────────────────────────────────────┘
                                     │
                                     ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                         APPLICATION LAYER                               │
├─────────────────────────────────────────────────────────────────────────┤
│  ┌────────────────────────────────────────────────────────────────────┐│
│  │                      IGameSessionService                           ││
│  ├────────────────────────────────────────────────────────────────────┤│
│  │ + OnCombatStateChanged: event Action<bool>                         ││
│  │ + IsInCombat: bool                                                 ││
│  └────────────────────────────────────────────────────────────────────┘│
│  ┌────────────────────────────────────────────────────────────────────┐│
│  │                        ICombatService                              ││
│  ├────────────────────────────────────────────────────────────────────┤│
│  │ + OnGridUpdated: event Action                                      ││
│  │ + CurrentGrid: CombatGrid                                          ││
│  │ + AllCombatants: IReadOnlyList<Combatant>                          ││
│  │ + CurrentTurn: Combatant                                           ││
│  │ + GetCell(x, y): GridCell                                          ││
│  └────────────────────────────────────────────────────────────────────┘│
└─────────────────────────────────────────────────────────────────────────┘
```

### Data Flow

```
┌─────────────────────────────────────────────────────────────────────────┐
│                     COMBAT GRID UPDATE FLOW                             │
└─────────────────────────────────────────────────────────────────────────┘

    Combat Starts / Entity Moves / Turn Changes
            │
            ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                   CombatService Events                                  │
├─────────────────────────────────────────────────────────────────────────┤
│  OnCombatStateChanged(true)                                            │
│  OnGridUpdated()                                                       │
│  OnTurnChanged(combatant)                                              │
└─────────────────────────────────────────────────────────────────────────┘
            │
            ▼
┌─────────────────────────────────────────────────────────────────────────┐
│        CombatGridPanelViewModel Event Handlers                          │
├─────────────────────────────────────────────────────────────────────────┤
│  1. HandleCombatStateChanged(inCombat)                                 │
│     - Set IsInCombat                                                   │
│     - InitializeGrid() if entering combat                              │
│  2. RefreshGrid()                                                      │
│     - Update cell types from CombatGrid                                │
│  3. RefreshTokens()                                                    │
│     - Clear and rebuild token collection                               │
│     - Set IsCurrentTurn on active entity                               │
└─────────────────────────────────────────────────────────────────────────┘
            │
            ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                   CombatGridPanel (UI Updates)                          │
├─────────────────────────────────────────────────────────────────────────┤
│  - Panel visibility controlled by IsInCombat                           │
│  - GridCellControls update from Cells collection                       │
│  - EntityTokenControls positioned on Canvas                            │
│  - Current turn token gets visual indicator                            │
└─────────────────────────────────────────────────────────────────────────┘
```

---

## 4. Combat Grid Panel

### Panel Layout

```
┌─────────────────────────────────────────────────────────────────────────┐
│                         COMBAT GRID PANEL                                │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                          │
│       1     2     3     4     5     6     7     8                       │
│    ┌─────┬─────┬─────┬─────┬─────┬─────┬─────┬─────┐                    │
│  A │  ░  │  ░  │  █  │  █  │  ░  │  ░  │  ░  │  ░  │                    │
│    ├─────┼─────┼─────┼─────┼─────┼─────┼─────┼─────┤                    │
│  B │  ░  │  ░  │  ░  │  ░  │  ░  │  ░  │  ░  │  ░  │                    │
│    ├─────┼─────┼─────┼─────┼─────┼─────┼─────┼─────┤                    │
│  C │  ░  │  ░  │ [S] │  ░  │  ░  │  ░  │  ░  │  ░  │                    │
│    ├─────┼─────┼─────┼─────┼─────┼─────┼─────┼─────┤                    │
│  D │  ░  │  ░  │  ░  │  ░  │ [@] │  ░  │  ░  │  ░  │                    │
│    ├─────┼─────┼─────┼─────┼─────┼─────┼─────┼─────┤                    │
│  E │  ░  │  ~  │  ~  │  ~  │  ░  │  ░  │  ░  │  ░  │                    │
│    ├─────┼─────┼─────┼─────┼─────┼─────┼─────┼─────┤                    │
│  F │  ░  │  ░  │  ~  │  ░  │  ░  │ [G] │  ░  │  ░  │                    │
│    ├─────┼─────┼─────┼─────┼─────┼─────┼─────┼─────┤                    │
│  G │  ░  │  ░  │  ░  │  ░  │  ░  │  ░  │  ░  │  ░  │                    │
│    ├─────┼─────┼─────┼─────┼─────┼─────┼─────┼─────┤                    │
│  H │  ░  │  ░  │  ░  │  ░  │  ░  │  ░  │  ░  │  ░  │                    │
│    └─────┴─────┴─────┴─────┴─────┴─────┴─────┴─────┘                    │
│                                                                          │
│  Legend:  @ = You   S = Skeleton   G = Goblin                           │
│           ░ = Floor   █ = Wall   ~ = Water                               │
│                                                                          │
└─────────────────────────────────────────────────────────────────────────┘
```

### XAML Implementation

**File:** `src/Presentation/RuneAndRust.Avalonia/Controls/CombatGridPanel.axaml`

```xml
<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:vm="using:RuneAndRust.Avalonia.ViewModels"
             xmlns:ctrl="using:RuneAndRust.Avalonia.Controls"
             x:Class="RuneAndRust.Avalonia.Controls.CombatGridPanel"
             x:DataType="vm:CombatGridPanelViewModel"
             IsVisible="{Binding IsInCombat}">
    
    <Design.DataContext>
        <vm:CombatGridPanelViewModel />
    </Design.DataContext>
    
    <Border Classes="panel" Padding="8">
        <Grid RowDefinitions="Auto,*,Auto">
            
            <!-- Header -->
            <TextBlock Grid.Row="0" 
                       Text="COMBAT GRID"
                       Classes="secondary"
                       FontWeight="SemiBold"
                       Margin="0,0,0,8" />
            
            <!-- Grid Area -->
            <Grid Grid.Row="1" RowDefinitions="Auto,*" ColumnDefinitions="Auto,*">
                
                <!-- Empty corner -->
                <Border Grid.Row="0" Grid.Column="0" Width="24" Height="24" />
                
                <!-- Column labels (1-8) -->
                <ItemsControl Grid.Row="0" Grid.Column="1"
                              ItemsSource="{Binding ColumnLabels}">
                    <ItemsControl.ItemsPanel>
                        <ItemsPanelTemplate>
                            <UniformGrid Columns="{Binding GridWidth}" />
                        </ItemsPanelTemplate>
                    </ItemsControl.ItemsPanel>
                    <ItemsControl.ItemTemplate>
                        <DataTemplate>
                            <TextBlock Text="{Binding}"
                                       HorizontalAlignment="Center"
                                       Classes="muted coord-label" />
                        </DataTemplate>
                    </ItemsControl.ItemTemplate>
                </ItemsControl>
                
                <!-- Row labels (A-H) -->
                <ItemsControl Grid.Row="1" Grid.Column="0"
                              ItemsSource="{Binding RowLabels}">
                    <ItemsControl.ItemsPanel>
                        <ItemsPanelTemplate>
                            <UniformGrid Rows="{Binding GridHeight}" />
                        </ItemsPanelTemplate>
                    </ItemsControl.ItemsPanel>
                    <ItemsControl.ItemTemplate>
                        <DataTemplate>
                            <TextBlock Text="{Binding}"
                                       VerticalAlignment="Center"
                                       HorizontalAlignment="Center"
                                       Width="24"
                                       Classes="muted coord-label" />
                        </DataTemplate>
                    </ItemsControl.ItemTemplate>
                </ItemsControl>
                
                <!-- Grid cells container -->
                <Grid Grid.Row="1" Grid.Column="1" x:Name="GridContainer">
                    <!-- Cells layer -->
                    <ItemsControl ItemsSource="{Binding FlatCells}">
                        <ItemsControl.ItemsPanel>
                            <ItemsPanelTemplate>
                                <UniformGrid Rows="{Binding GridHeight}" 
                                             Columns="{Binding GridWidth}" />
                            </ItemsPanelTemplate>
                        </ItemsControl.ItemsPanel>
                        <ItemsControl.ItemTemplate>
                            <DataTemplate DataType="vm:GridCellViewModel">
                                <ctrl:GridCellControl 
                                    CellType="{Binding CellType}"
                                    IsHighlighted="{Binding IsHighlighted}"
                                    HighlightType="{Binding HighlightType}"
                                    HasEntity="{Binding HasEntity}"
                                    ToolTip.Tip="{Binding Tooltip}" />
                            </DataTemplate>
                        </ItemsControl.ItemTemplate>
                    </ItemsControl>
                    
                    <!-- Tokens layer (positioned on Canvas) -->
                    <Canvas x:Name="TokenCanvas">
                        <ItemsControl ItemsSource="{Binding Tokens}">
                            <ItemsControl.ItemsPanel>
                                <ItemsPanelTemplate>
                                    <Canvas />
                                </ItemsPanelTemplate>
                            </ItemsControl.ItemsPanel>
                            <ItemsControl.ItemContainerStyle>
                                <Style TargetType="ContentPresenter">
                                    <Setter Property="Canvas.Left" Value="{Binding CanvasX}" />
                                    <Setter Property="Canvas.Top" Value="{Binding CanvasY}" />
                                </Style>
                            </ItemsControl.ItemContainerStyle>
                            <ItemsControl.ItemTemplate>
                                <DataTemplate DataType="vm:EntityTokenViewModel">
                                    <ctrl:EntityTokenControl 
                                        Entity="{Binding Combatant}"
                                        IsSelected="{Binding IsSelected}"
                                        IsCurrentTurn="{Binding IsCurrentTurn}" />
                                </DataTemplate>
                            </ItemsControl.ItemTemplate>
                        </ItemsControl>
                    </Canvas>
                </Grid>
            </Grid>
            
            <!-- Legend -->
            <Border Grid.Row="2" Classes="panel-footer" Margin="0,8,0,0" Padding="8">
                <WrapPanel>
                    <ItemsControl ItemsSource="{Binding LegendItems}">
                        <ItemsControl.ItemsPanel>
                            <ItemsPanelTemplate>
                                <WrapPanel />
                            </ItemsPanelTemplate>
                        </ItemsControl.ItemsPanel>
                        <ItemsControl.ItemTemplate>
                            <DataTemplate>
                                <StackPanel Orientation="Horizontal" Margin="0,0,16,0">
                                    <TextBlock Text="{Binding Symbol}"
                                               FontFamily="{StaticResource MonoFont}"
                                               Foreground="{Binding Color}"
                                               Margin="0,0,4,0" />
                                    <TextBlock Text="{Binding Label}"
                                               Classes="muted"
                                               FontSize="11" />
                                </StackPanel>
                            </DataTemplate>
                        </ItemsControl.ItemTemplate>
                    </ItemsControl>
                </WrapPanel>
            </Border>
            
        </Grid>
    </Border>
</UserControl>
```

**File:** `src/Presentation/RuneAndRust.Avalonia/Controls/CombatGridPanel.axaml.cs`

```csharp
namespace RuneAndRust.Avalonia.Controls;

using global::Avalonia.Controls;

/// <summary>
/// Panel control displaying the combat grid.
/// </summary>
public partial class CombatGridPanel : UserControl
{
    public CombatGridPanel()
    {
        InitializeComponent();
    }
}
```

---

## 5. Combat Grid Panel ViewModel

**File:** `src/Presentation/RuneAndRust.Avalonia/ViewModels/CombatGridPanelViewModel.cs`

```csharp
namespace RuneAndRust.Avalonia.ViewModels;

using CommunityToolkit.Mvvm.ComponentModel;
using RuneAndRust.Application.Interfaces;
using RuneAndRust.Domain.ValueObjects;
using Serilog;
using System.Collections.ObjectModel;

/// <summary>
/// View model for the combat grid panel.
/// </summary>
public partial class CombatGridPanelViewModel : ViewModelBase
{
    private readonly IGameSessionService? _gameSession;
    private readonly ICombatService? _combatService;

    [ObservableProperty]
    private ObservableCollection<ObservableCollection<GridCellViewModel>> _cells = new();

    [ObservableProperty]
    private ObservableCollection<GridCellViewModel> _flatCells = new();

    [ObservableProperty]
    private ObservableCollection<EntityTokenViewModel> _tokens = new();

    [ObservableProperty]
    private int _gridWidth = 8;

    [ObservableProperty]
    private int _gridHeight = 8;

    [ObservableProperty]
    private bool _isInCombat;

    private const int CellSize = 40;

    /// <summary>
    /// Row labels for coordinate display (A-H).
    /// </summary>
    public IReadOnlyList<string> RowLabels { get; private set; } = Array.Empty<string>();

    /// <summary>
    /// Column labels for coordinate display (1-8).
    /// </summary>
    public IReadOnlyList<int> ColumnLabels { get; private set; } = Array.Empty<int>();

    /// <summary>
    /// Legend items explaining grid symbols.
    /// </summary>
    public IReadOnlyList<LegendItem> LegendItems { get; } = new List<LegendItem>
    {
        new("@", "You", "#32CD32"),
        new("░", "Floor", "#696969"),
        new("█", "Wall", "#2F4F4F"),
        new("~", "Water", "#00008B"),
        new("☼", "Hazard", "#8B0000"),
        new("▓", "Cover", "#8B4513")
    };

    /// <summary>
    /// Creates a new CombatGridPanelViewModel with services.
    /// </summary>
    public CombatGridPanelViewModel(
        IGameSessionService gameSession,
        ICombatService combatService)
    {
        _gameSession = gameSession;
        _combatService = combatService;

        _gameSession.OnCombatStateChanged += HandleCombatStateChanged;
        _combatService.OnGridUpdated += RefreshGrid;
        _combatService.OnTurnChanged += HandleTurnChanged;
    }

    /// <summary>
    /// Design-time constructor with sample data.
    /// </summary>
    public CombatGridPanelViewModel()
    {
        IsInCombat = true;
        InitializeSampleGrid();
    }

    private void HandleCombatStateChanged(bool inCombat)
    {
        IsInCombat = inCombat;

        if (inCombat)
        {
            Log.Information("Combat started, initializing grid");
            InitializeGrid();
            RefreshGrid();
            RefreshTokens();
        }
        else
        {
            Log.Information("Combat ended, clearing grid");
            Cells.Clear();
            FlatCells.Clear();
            Tokens.Clear();
        }
    }

    private void HandleTurnChanged(Combatant current)
    {
        foreach (var token in Tokens)
        {
            token.IsCurrentTurn = token.Combatant.Id == current.Id;
        }
        Log.Debug("Turn changed to {Name}", current.Name);
    }

    private void InitializeGrid()
    {
        if (_combatService?.CurrentGrid is null)
            return;

        var grid = _combatService.CurrentGrid;
        GridWidth = grid.Width;
        GridHeight = grid.Height;

        // Generate coordinate labels
        RowLabels = Enumerable.Range(0, GridHeight)
            .Select(i => ((char)('A' + i)).ToString())
            .ToList();
        ColumnLabels = Enumerable.Range(1, GridWidth).ToList();

        OnPropertyChanged(nameof(RowLabels));
        OnPropertyChanged(nameof(ColumnLabels));

        // Create cell view models
        Cells.Clear();
        FlatCells.Clear();

        for (int row = 0; row < GridHeight; row++)
        {
            var rowCells = new ObservableCollection<GridCellViewModel>();
            for (int col = 0; col < GridWidth; col++)
            {
                var position = new GridPosition(col, row);
                var cell = grid.GetCell(position);
                var cellVm = new GridCellViewModel(position, cell);
                rowCells.Add(cellVm);
                FlatCells.Add(cellVm);
            }
            Cells.Add(rowCells);
        }

        Log.Debug("Grid initialized: {Width}x{Height}", GridWidth, GridHeight);
    }

    private void RefreshGrid()
    {
        if (_combatService?.CurrentGrid is null)
            return;

        var grid = _combatService.CurrentGrid;

        foreach (var cellVm in FlatCells)
        {
            var cell = grid.GetCell(cellVm.Position);
            cellVm.UpdateFromCell(cell);
        }

        RefreshTokens();
    }

    private void RefreshTokens()
    {
        if (_combatService is null)
            return;

        var currentTurnId = _combatService.CurrentTurn?.Id;

        Tokens.Clear();
        foreach (var combatant in _combatService.AllCombatants)
        {
            var token = new EntityTokenViewModel(combatant, CellSize)
            {
                IsCurrentTurn = combatant.Id == currentTurnId
            };
            Tokens.Add(token);
        }

        Log.Debug("Tokens refreshed: {Count} combatants", Tokens.Count);
    }

    private void InitializeSampleGrid()
    {
        GridWidth = 8;
        GridHeight = 8;

        RowLabels = new[] { "A", "B", "C", "D", "E", "F", "G", "H" };
        ColumnLabels = new[] { 1, 2, 3, 4, 5, 6, 7, 8 };

        for (int row = 0; row < GridHeight; row++)
        {
            var rowCells = new ObservableCollection<GridCellViewModel>();
            for (int col = 0; col < GridWidth; col++)
            {
                var position = new GridPosition(col, row);
                var cellType = GetSampleCellType(col, row);
                var cellVm = new GridCellViewModel(position, cellType);
                rowCells.Add(cellVm);
                FlatCells.Add(cellVm);
            }
            Cells.Add(rowCells);
        }

        // Sample tokens
        Tokens.Add(new EntityTokenViewModel("Hero", "@", "#32CD32", 4, 3, CellSize) { IsCurrentTurn = true });
        Tokens.Add(new EntityTokenViewModel("Skeleton", "S", "#FF4500", 2, 2, CellSize));
        Tokens.Add(new EntityTokenViewModel("Goblin", "G", "#FF4500", 5, 5, CellSize));
    }

    private static GridCellType GetSampleCellType(int col, int row)
    {
        // Walls at A3, A4
        if (row == 0 && (col == 2 || col == 3))
            return GridCellType.Wall;

        // Water at E2, E3, E4, F3
        if ((row == 4 && col >= 1 && col <= 3) || (row == 5 && col == 2))
            return GridCellType.Water;

        return GridCellType.Floor;
    }
}

/// <summary>
/// Legend item for grid symbols.
/// </summary>
public record LegendItem(string Symbol, string Label, string Color);
```

---

## 6. Grid Cell Control

**File:** `src/Presentation/RuneAndRust.Avalonia/Controls/GridCellControl.cs`

```csharp
namespace RuneAndRust.Avalonia.Controls;

using global::Avalonia;
using global::Avalonia.Controls.Primitives;
using global::Avalonia.Media;

/// <summary>
/// Represents a single cell in the combat grid.
/// </summary>
public class GridCellControl : TemplatedControl
{
    public static readonly StyledProperty<GridCellType> CellTypeProperty =
        AvaloniaProperty.Register<GridCellControl, GridCellType>(nameof(CellType));

    public static readonly StyledProperty<bool> IsHighlightedProperty =
        AvaloniaProperty.Register<GridCellControl, bool>(nameof(IsHighlighted));

    public static readonly StyledProperty<HighlightType> HighlightTypeProperty =
        AvaloniaProperty.Register<GridCellControl, HighlightType>(nameof(HighlightType));

    public static readonly StyledProperty<bool> HasEntityProperty =
        AvaloniaProperty.Register<GridCellControl, bool>(nameof(HasEntity));

    /// <summary>
    /// Gets or sets the cell terrain type.
    /// </summary>
    public GridCellType CellType
    {
        get => GetValue(CellTypeProperty);
        set => SetValue(CellTypeProperty, value);
    }

    /// <summary>
    /// Gets or sets whether the cell is highlighted.
    /// </summary>
    public bool IsHighlighted
    {
        get => GetValue(IsHighlightedProperty);
        set => SetValue(IsHighlightedProperty, value);
    }

    /// <summary>
    /// Gets or sets the highlight type.
    /// </summary>
    public HighlightType HighlightType
    {
        get => GetValue(HighlightTypeProperty);
        set => SetValue(HighlightTypeProperty, value);
    }

    /// <summary>
    /// Gets or sets whether the cell contains an entity.
    /// </summary>
    public bool HasEntity
    {
        get => GetValue(HasEntityProperty);
        set => SetValue(HasEntityProperty, value);
    }

    /// <summary>
    /// Gets the background brush for this cell type.
    /// </summary>
    public IBrush CellBackground => CellType switch
    {
        GridCellType.Floor => Brushes.DimGray,
        GridCellType.Wall => Brushes.DarkSlateGray,
        GridCellType.Water => Brushes.DarkBlue,
        GridCellType.Hazard => Brushes.DarkRed,
        GridCellType.Cover => Brushes.SaddleBrown,
        _ => Brushes.Black
    };

    /// <summary>
    /// Gets the symbol for this cell type.
    /// </summary>
    public string CellSymbol => CellType switch
    {
        GridCellType.Floor => "░",
        GridCellType.Wall => "█",
        GridCellType.Water => "~",
        GridCellType.Hazard => "☼",
        GridCellType.Cover => "▓",
        _ => " "
    };

    /// <summary>
    /// Gets the highlight color.
    /// </summary>
    public IBrush HighlightColor => HighlightType switch
    {
        HighlightType.Movement => new SolidColorBrush(Color.FromArgb(128, 0, 128, 255)),
        HighlightType.Attack => new SolidColorBrush(Color.FromArgb(128, 255, 0, 0)),
        HighlightType.Ability => new SolidColorBrush(Color.FromArgb(128, 128, 0, 255)),
        HighlightType.Hover => new SolidColorBrush(Color.FromArgb(64, 255, 255, 255)),
        _ => Brushes.Transparent
    };

    static GridCellControl()
    {
        CellTypeProperty.Changed.AddClassHandler<GridCellControl>((c, _) => c.OnCellTypeChanged());
        HighlightTypeProperty.Changed.AddClassHandler<GridCellControl>((c, _) => c.OnHighlightChanged());
    }

    private void OnCellTypeChanged()
    {
        Classes.Set("wall", CellType == GridCellType.Wall);
        Classes.Set("water", CellType == GridCellType.Water);
        Classes.Set("hazard", CellType == GridCellType.Hazard);
        Classes.Set("cover", CellType == GridCellType.Cover);
    }

    private void OnHighlightChanged()
    {
        Classes.Set("highlighted", IsHighlighted);
        Classes.Set("movement-highlight", HighlightType == HighlightType.Movement);
        Classes.Set("attack-highlight", HighlightType == HighlightType.Attack);
        Classes.Set("ability-highlight", HighlightType == HighlightType.Ability);
    }
}

/// <summary>
/// Types of terrain cells.
/// </summary>
public enum GridCellType
{
    Floor,
    Wall,
    Water,
    Hazard,
    Cover
}

/// <summary>
/// Types of cell highlighting.
/// </summary>
public enum HighlightType
{
    None,
    Movement,
    Attack,
    Ability,
    Hover
}
```

---

## 7. Entity Token Control

**File:** `src/Presentation/RuneAndRust.Avalonia/Controls/EntityTokenControl.cs`

```csharp
namespace RuneAndRust.Avalonia.Controls;

using global::Avalonia;
using global::Avalonia.Controls.Primitives;
using global::Avalonia.Media;
using RuneAndRust.Domain.Entities;
using RuneAndRust.Domain.Enums;

/// <summary>
/// Displays an entity token on the combat grid.
/// </summary>
public class EntityTokenControl : TemplatedControl
{
    public static readonly StyledProperty<Combatant?> EntityProperty =
        AvaloniaProperty.Register<EntityTokenControl, Combatant?>(nameof(Entity));

    public static readonly StyledProperty<bool> IsSelectedProperty =
        AvaloniaProperty.Register<EntityTokenControl, bool>(nameof(IsSelected));

    public static readonly StyledProperty<bool> IsCurrentTurnProperty =
        AvaloniaProperty.Register<EntityTokenControl, bool>(nameof(IsCurrentTurn));

    /// <summary>
    /// Gets or sets the entity this token represents.
    /// </summary>
    public Combatant? Entity
    {
        get => GetValue(EntityProperty);
        set => SetValue(EntityProperty, value);
    }

    /// <summary>
    /// Gets or sets whether this token is selected.
    /// </summary>
    public bool IsSelected
    {
        get => GetValue(IsSelectedProperty);
        set => SetValue(IsSelectedProperty, value);
    }

    /// <summary>
    /// Gets or sets whether it's this entity's turn.
    /// </summary>
    public bool IsCurrentTurn
    {
        get => GetValue(IsCurrentTurnProperty);
        set => SetValue(IsCurrentTurnProperty, value);
    }

    /// <summary>
    /// Gets the symbol for this entity.
    /// </summary>
    public string TokenSymbol => Entity?.IsPlayer == true 
        ? "@" 
        : Entity?.Name.FirstOrDefault().ToString() ?? "?";

    /// <summary>
    /// Gets the color for this entity's faction.
    /// </summary>
    public IBrush TokenColor => Entity?.Faction switch
    {
        Faction.Player => Brushes.LimeGreen,
        Faction.Ally => Brushes.Cyan,
        Faction.Enemy => Brushes.OrangeRed,
        Faction.Neutral => Brushes.Yellow,
        _ => Brushes.White
    };

    /// <summary>
    /// Gets the tooltip text for this entity.
    /// </summary>
    public string Tooltip => Entity is not null
        ? $"{Entity.Name}\nHP: {Entity.Health}/{Entity.MaxHealth}"
        : "";

    static EntityTokenControl()
    {
        EntityProperty.Changed.AddClassHandler<EntityTokenControl>((c, _) => c.OnEntityChanged());
        IsCurrentTurnProperty.Changed.AddClassHandler<EntityTokenControl>((c, _) => c.OnTurnChanged());
    }

    private void OnEntityChanged()
    {
        Classes.Set("player", Entity?.IsPlayer == true);
        Classes.Set("enemy", Entity?.Faction == Faction.Enemy);
        Classes.Set("ally", Entity?.Faction == Faction.Ally);
    }

    private void OnTurnChanged()
    {
        Classes.Set("current-turn", IsCurrentTurn);
    }
}
```

---

## 8. Grid Cell ViewModel

**File:** `src/Presentation/RuneAndRust.Avalonia/ViewModels/GridCellViewModel.cs`

```csharp
namespace RuneAndRust.Avalonia.ViewModels;

using CommunityToolkit.Mvvm.ComponentModel;
using RuneAndRust.Avalonia.Controls;
using RuneAndRust.Domain.Entities;
using RuneAndRust.Domain.ValueObjects;

/// <summary>
/// View model for a combat grid cell.
/// </summary>
public partial class GridCellViewModel : ViewModelBase
{
    /// <summary>
    /// Gets the grid position of this cell.
    /// </summary>
    public GridPosition Position { get; }

    [ObservableProperty]
    private GridCellType _cellType;

    [ObservableProperty]
    private bool _isWalkable;

    [ObservableProperty]
    private bool _isHighlighted;

    [ObservableProperty]
    private HighlightType _highlightType;

    [ObservableProperty]
    private bool _hasEntity;

    /// <summary>
    /// Gets the coordinate label (e.g., "A1", "B3").
    /// </summary>
    public string CoordinateLabel => $"{(char)('A' + Position.Y)}{Position.X + 1}";

    /// <summary>
    /// Gets the tooltip text.
    /// </summary>
    public string Tooltip => $"{CoordinateLabel}: {CellType}";

    /// <summary>
    /// Creates a new GridCellViewModel from a position and cell.
    /// </summary>
    public GridCellViewModel(GridPosition position, GridCell cell)
    {
        Position = position;
        UpdateFromCell(cell);
    }

    /// <summary>
    /// Creates a new GridCellViewModel with explicit type (design-time).
    /// </summary>
    public GridCellViewModel(GridPosition position, GridCellType cellType)
    {
        Position = position;
        CellType = cellType;
        IsWalkable = cellType != GridCellType.Wall;
    }

    /// <summary>
    /// Updates this view model from a grid cell.
    /// </summary>
    public void UpdateFromCell(GridCell cell)
    {
        CellType = MapCellType(cell.TerrainType);
        IsWalkable = cell.IsWalkable;
        HasEntity = cell.Occupant is not null;
    }

    private static GridCellType MapCellType(TerrainType terrain)
    {
        return terrain switch
        {
            TerrainType.Floor => GridCellType.Floor,
            TerrainType.Wall => GridCellType.Wall,
            TerrainType.Water => GridCellType.Water,
            TerrainType.Hazard => GridCellType.Hazard,
            TerrainType.Cover => GridCellType.Cover,
            _ => GridCellType.Floor
        };
    }
}
```

---

## 9. Entity Token ViewModel

**File:** `src/Presentation/RuneAndRust.Avalonia/ViewModels/EntityTokenViewModel.cs`

```csharp
namespace RuneAndRust.Avalonia.ViewModels;

using CommunityToolkit.Mvvm.ComponentModel;
using RuneAndRust.Domain.Entities;
using RuneAndRust.Domain.Enums;

/// <summary>
/// View model for an entity token on the combat grid.
/// </summary>
public partial class EntityTokenViewModel : ViewModelBase
{
    private readonly int _cellSize;

    /// <summary>
    /// Gets the combatant this token represents.
    /// </summary>
    public Combatant Combatant { get; }

    [ObservableProperty]
    private bool _isSelected;

    [ObservableProperty]
    private bool _isCurrentTurn;

    /// <summary>
    /// Gets the token symbol.
    /// </summary>
    public string Symbol => Combatant.IsPlayer ? "@" : Combatant.Name.FirstOrDefault().ToString();

    /// <summary>
    /// Gets the token color based on faction.
    /// </summary>
    public string Color => Combatant.Faction switch
    {
        Faction.Player => "#32CD32",
        Faction.Ally => "#00FFFF",
        Faction.Enemy => "#FF4500",
        Faction.Neutral => "#FFFF00",
        _ => "#FFFFFF"
    };

    /// <summary>
    /// Gets the X position on the canvas.
    /// </summary>
    public double CanvasX => Combatant.Position.X * _cellSize;

    /// <summary>
    /// Gets the Y position on the canvas.
    /// </summary>
    public double CanvasY => Combatant.Position.Y * _cellSize;

    /// <summary>
    /// Gets the tooltip text.
    /// </summary>
    public string Tooltip => $"{Combatant.Name}\nHP: {Combatant.Health}/{Combatant.MaxHealth}";

    /// <summary>
    /// Creates a new EntityTokenViewModel.
    /// </summary>
    public EntityTokenViewModel(Combatant combatant, int cellSize = 40)
    {
        Combatant = combatant;
        _cellSize = cellSize;
    }

    /// <summary>
    /// Design-time constructor.
    /// </summary>
    public EntityTokenViewModel(string name, string symbol, string color, int x, int y, int cellSize)
    {
        _cellSize = cellSize;
        // For design-time, create a mock combatant
        Combatant = CreateMockCombatant(name, x, y);
    }

    private static Combatant CreateMockCombatant(string name, int x, int y)
    {
        // This would be replaced with actual mock creation for design-time
        return new MockCombatant(name, x, y);
    }
}
```

---

## 10. Styles

**File:** `src/Presentation/RuneAndRust.Avalonia/Styles/CombatGridStyles.axaml`

```xml
<Styles xmlns="https://github.com/avaloniaui"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:ctrl="using:RuneAndRust.Avalonia.Controls">
    
    <!-- Grid Cell Control -->
    <Style Selector="ctrl|GridCellControl">
        <Setter Property="Width" Value="40" />
        <Setter Property="Height" Value="40" />
        <Setter Property="Template">
            <ControlTemplate>
                <Border x:Name="CellBorder"
                        Background="{TemplateBinding CellBackground}"
                        BorderBrush="{StaticResource BorderBrush}"
                        BorderThickness="0.5">
                    <Grid>
                        <!-- Cell symbol -->
                        <TextBlock Text="{TemplateBinding CellSymbol}"
                                   FontFamily="{StaticResource MonoFont}"
                                   FontSize="16"
                                   Foreground="{StaticResource TextMutedBrush}"
                                   HorizontalAlignment="Center"
                                   VerticalAlignment="Center"
                                   Opacity="0.5" />
                        
                        <!-- Highlight overlay -->
                        <Border x:Name="HighlightOverlay"
                                Background="{TemplateBinding HighlightColor}"
                                IsVisible="{TemplateBinding IsHighlighted}" />
                    </Grid>
                </Border>
            </ControlTemplate>
        </Setter>
    </Style>
    
    <!-- Cell type variations -->
    <Style Selector="ctrl|GridCellControl.wall">
        <Setter Property="Cursor" Value="No" />
    </Style>
    
    <Style Selector="ctrl|GridCellControl:pointerover /template/ Border#CellBorder">
        <Setter Property="BorderBrush" Value="{StaticResource AccentBrush}" />
        <Setter Property="BorderThickness" Value="2" />
    </Style>
    
    <!-- Entity Token Control -->
    <Style Selector="ctrl|EntityTokenControl">
        <Setter Property="Width" Value="36" />
        <Setter Property="Height" Value="36" />
        <Setter Property="Margin" Value="2" />
        <Setter Property="Template">
            <ControlTemplate>
                <Border x:Name="TokenBorder"
                        Background="{StaticResource SurfaceDarkBrush}"
                        BorderBrush="{TemplateBinding TokenColor}"
                        BorderThickness="2"
                        CornerRadius="18"
                        ToolTip.Tip="{TemplateBinding Tooltip}">
                    <TextBlock Text="{TemplateBinding TokenSymbol}"
                               Foreground="{TemplateBinding TokenColor}"
                               FontFamily="{StaticResource MonoFont}"
                               FontSize="18"
                               FontWeight="Bold"
                               HorizontalAlignment="Center"
                               VerticalAlignment="Center" />
                </Border>
            </ControlTemplate>
        </Setter>
    </Style>
    
    <!-- Current turn indicator -->
    <Style Selector="ctrl|EntityTokenControl.current-turn /template/ Border#TokenBorder">
        <Setter Property="BoxShadow" Value="0 0 8 2 Gold" />
    </Style>
    
    <Style Selector="ctrl|EntityTokenControl:pointerover /template/ Border#TokenBorder">
        <Setter Property="Background" Value="{StaticResource SurfaceBrush}" />
    </Style>
    
    <!-- Coordinate labels -->
    <Style Selector="TextBlock.coord-label">
        <Setter Property="FontFamily" Value="{StaticResource MonoFont}" />
        <Setter Property="FontSize" Value="12" />
    </Style>
    
</Styles>
```

---

## 11. Data Model Changes

### New Types

| Type | Layer | Description |
|------|-------|-------------|
| `CombatGridPanel` | Presentation | Grid UserControl |
| `CombatGridPanelViewModel` | Presentation | Grid state view model |
| `GridCellControl` | Presentation | Cell control |
| `GridCellViewModel` | Presentation | Cell state view model |
| `EntityTokenControl` | Presentation | Token control |
| `EntityTokenViewModel` | Presentation | Token state view model |
| `GridCellType` | Presentation | Terrain type enum |
| `HighlightType` | Presentation | Highlight type enum |
| `LegendItem` | Presentation | Legend entry record |

---

## 12. Logging Specifications

| Component | Level | Events |
|-----------|-------|--------|
| `CombatGridPanelViewModel` | Information | Combat start/end |
| `CombatGridPanelViewModel` | Debug | Grid initialization, token refresh |

---

## 13. Unit Testing Requirements

### Test Count by Feature

| Feature | Test Count |
|---------|------------|
| CombatGridPanelViewModel | ~4 |
| GridCellViewModel | ~2 |
| EntityTokenViewModel | ~2 |
| GridCellControl | ~2 |
| **Total** | **~10** |

### Test Specifications

**File:** `tests/RuneAndRust.Avalonia.UnitTests/ViewModels/CombatGridPanelViewModelTests.cs`

```csharp
[TestFixture]
public class CombatGridPanelViewModelTests
{
    [Test]
    public void HandleCombatStateChanged_WhenCombatStarts_InitializesGrid();

    [Test]
    public void HandleCombatStateChanged_WhenCombatEnds_ClearsGrid();

    [Test]
    public void RefreshTokens_UpdatesTokenCollection();

    [Test]
    public void HandleTurnChanged_SetsCorrectToken();
}

[TestFixture]
public class GridCellViewModelTests
{
    [Test]
    public void CoordinateLabel_ReturnsCorrectFormat();

    [Test]
    public void UpdateFromCell_SetsPropertiesCorrectly();
}

[TestFixture]
public class EntityTokenViewModelTests
{
    [Test]
    public void Symbol_ForPlayer_ReturnsAt();

    [Test]
    public void Color_ForEnemy_ReturnsOrangeRed();
}
```

---

## 14. Use Cases

### UC-073a-001: View Combat Grid
**Actor:** Player
**Flow:** Combat begins → Grid appears → Shows all cells and entities

### UC-073a-002: Identify Terrain
**Actor:** Player
**Flow:** View grid → Different symbols show terrain types → Legend explains

### UC-073a-003: Identify Entities
**Actor:** Player
**Flow:** View grid → Tokens show entity locations → Colors indicate faction

### UC-073a-004: Current Turn Indicator
**Actor:** Player
**Flow:** Turn changes → Active entity token glows → Player knows whose turn

### UC-073a-005: Use Coordinates
**Actor:** Player
**Flow:** View row/column labels → Can reference cell A3, B5, etc.

### UC-073a-006: Combat Ends
**Actor:** Player
**Flow:** All enemies defeated → Grid disappears → Returns to room view

---

## 15. Deliverable Checklist

### Controls
- [ ] `Controls/CombatGridPanel.axaml` created
- [ ] `Controls/CombatGridPanel.axaml.cs` created
- [ ] `Controls/GridCellControl.cs` created
- [ ] `Controls/EntityTokenControl.cs` created

### ViewModels
- [ ] `ViewModels/CombatGridPanelViewModel.cs` created
- [ ] `ViewModels/GridCellViewModel.cs` created
- [ ] `ViewModels/EntityTokenViewModel.cs` created

### Styles
- [ ] `Styles/CombatGridStyles.axaml` created

### Integration
- [ ] `App.axaml` includes CombatGridStyles
- [ ] GameWindow shows CombatGridPanel in MainContent when in combat

### Testing
- [ ] ~10 unit tests implemented
- [ ] All tests passing

---

## 16. Acceptance Criteria

### Grid Display
- [ ] Combat grid displays when combat starts
- [ ] Grid shows 8x8 cells (configurable)
- [ ] Coordinate labels display (A-H, 1-8)
- [ ] Grid hides when combat ends

### Terrain Visualization
- [ ] Floor cells render as ░
- [ ] Wall cells render as █
- [ ] Water cells render as ~
- [ ] Hazard cells render as ☼
- [ ] Cover cells render as ▓

### Entity Tokens
- [ ] Entity tokens display on grid
- [ ] Player token shows @
- [ ] Monster tokens show first letter
- [ ] Token colors indicate faction (green=player, red=enemy)
- [ ] Tooltips show entity name and HP

### Turn Indicator
- [ ] Current turn token has glow effect
- [ ] Turn indicator updates on turn change

### Legend
- [ ] Legend explains symbols
- [ ] Legend shows entity indicators

### Quality
- [ ] Build completes with 0 errors
- [ ] Build completes with 0 warnings
- [ ] ~10 unit tests pass
- [ ] Grid updates when combat state changes

---

## 17. Dependencies

### Required from v0.7.2c

| Type | Location | Usage |
|------|----------|-------|
| Panel patterns | v0.7.2c | Consistent structure |
| Style patterns | v0.7.2c | Theming consistency |

### Required from v0.7.0c

| Type | Location | Usage |
|------|----------|-------|
| `GameWindow` | `Views/GameWindow.axaml` | MainContent region |
| `IWindowLayoutService` | `Services/IWindowLayoutService.cs` | Panel registration |

### Required from Domain/Application Layer

| Type | Location | Usage |
|------|----------|-------|
| `CombatGrid` | Domain layer | Grid data |
| `GridCell` | Domain layer | Cell data |
| `Combatant` | Domain layer | Entity data |
| `ICombatService` | Application layer | Combat events |

### Provides to v0.7.3b

| Type | Usage |
|------|-------|
| `CombatGridPanel` | Click interaction target |
| `GridCellControl` | Cell click detection |
| `GridCellViewModel` | Highlight state binding |

---

## 18. Future Considerations

### Deferred to v0.7.3b
- **Click interaction**: Cell click detection and handling
- **Range highlighting**: Movement/attack range display
- **Hover effects**: Cell hover tooltips

### Deferred to v0.7.3c
- **Combatant list**: Sidebar with all combatants
- **Action bar**: Combat action buttons

### Deferred to v0.8.0
- **Grid zoom**: Scale grid display
- **Animation**: Token movement animation
- **Fog of war**: Hidden areas

### Out of Scope
- **3D view**: 2D grid only
- **Hex grid**: Square grid only

---

*Document Version: 1.0*
*Last Updated: 2026-01-10*
*Author: Assistant*
