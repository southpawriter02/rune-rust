> **Archived** - This changelog has been consolidated. See the complete version at [v0.2.2](../v0.2.x/v0.2.2.md).

# v0.2.2c Changelog: The Elite (Traits & Affixes)

**Release Date:** 2025-12-20
**Milestone:** v0.2.2 – The Adversary (3 of 3)
**Test Count:** 1436 tests (22 new)

---

## Summary

This release implements the **CreatureTraitService** to procedurally generate Elite enemies with unique behaviors (Affixes). Enemies are no longer uniform stat-blocks—Elite and higher tier enemies now gain traits that provide stat modifiers and reactive combat behaviors.

---

## New Features

### Creature Trait System (CreatureTraitService)

The core of v0.2.2c is a procedural trait assignment system that enhances Elite, Champion, and Boss tier enemies:

| Tier     | Trait Count | Stat Scaling |
|----------|-------------|--------------|
| Standard | 0           | 1.0x         |
| Elite    | 1           | 1.5x         |
| Champion | 2           | 1.5x         |
| Boss     | 3           | 2.5x         |

### Trait Types

| Trait        | Category    | Effect                              | Name Prefix    |
|--------------|-------------|-------------------------------------|----------------|
| Armored      | Stat        | +3 ArmorSoak                        | "Armored"      |
| Relentless   | Stat        | +50% HP, Stun Immune                | "Relentless"   |
| Berserker    | Stat        | +25% damage dealt/received (future) | "Berserk"      |
| Vampiric     | On-Hit      | Heal 25% of damage dealt            | "Vampiric"     |
| Corrosive    | On-Hit      | Apply Vulnerable on hit (future)    | "Corrosive"    |
| Explosive    | On-Death    | 15 AoE damage to all combatants     | "Volatile"     |
| Regenerating | Turn-Start  | Heal 10% MaxHP per turn             | "Regenerating" |
| Thorns       | On-Hit-Recv | Reflect 25% damage to attacker      | "Thorned"      |

### Trait Trigger Locations

| Trigger Point     | Location                          | Traits Active   |
|-------------------|-----------------------------------|-----------------|
| OnTurnStart       | CombatService.NextTurn()          | Regenerating    |
| OnDeath           | CombatService.RemoveDefeatedCombatant() | Explosive  |
| OnDamageDealt     | CombatService.ExecuteEnemyAttack()| Vampiric        |
| OnDamageReceived  | CombatService.ExecutePlayerAttack()| Thorns         |

### Trait Exclusion Rules

- **Mechanical/Construct** enemies cannot roll Vampiric (no blood to drain)

---

## New Files

| File | Purpose |
|------|---------|
| `RuneAndRust.Core/Enums/CreatureTraitType.cs` | Enum for trait types with numeric groupings |
| `RuneAndRust.Core/Interfaces/ICreatureTraitService.cs` | Interface for trait generation and runtime effects |
| `RuneAndRust.Engine/Services/CreatureTraitService.cs` | Trait assignment and effect processing |
| `RuneAndRust.Tests/Engine/CreatureTraitServiceTests.cs` | 22 unit tests for trait behaviors |

---

## Modified Files

| File | Changes |
|------|---------|
| `RuneAndRust.Core/Entities/Enemy.cs` | Added `ActiveTraits` property and `IsElite` computed property |
| `RuneAndRust.Core/Models/Combat/Combatant.cs` | Added `ActiveTraits` property, updated `FromEnemy()` to copy traits |
| `RuneAndRust.Engine/Factories/EnemyFactory.cs` | Added `ICreatureTraitService` dependency, calls `EnhanceEnemy()` for Elite+ |
| `RuneAndRust.Engine/Services/CombatService.cs` | Added `ICreatureTraitService` dependency, integrated 4 trait triggers |
| `RuneAndRust.Terminal/Program.cs` | Registered `ICreatureTraitService` in DI container |
| `RuneAndRust.Tests/Engine/EnemyFactoryTests.cs` | Added `ICreatureTraitService` mock to test setup |
| `RuneAndRust.Tests/Engine/CombatServiceTests.cs` | Added `ICreatureTraitService` mock with default returns |

---

## API Changes

### Enemy Entity

New properties added:

```csharp
public List<CreatureTraitType> ActiveTraits { get; set; } = new();
public bool IsElite => ActiveTraits.Count > 0;
```

### Combatant Model

New property added:

```csharp
public List<CreatureTraitType> ActiveTraits { get; set; } = new();
```

### EnemyFactory Constructor (Breaking Change)

The constructor now requires `ICreatureTraitService`:

```csharp
// Before
public EnemyFactory(ILogger<EnemyFactory>, IDiceService)

// After
public EnemyFactory(ILogger<EnemyFactory>, IDiceService, ICreatureTraitService)
```

### CombatService Constructor (Breaking Change)

The constructor now requires `ICreatureTraitService`:

```csharp
// Before (v0.2.2b)
public CombatService(..., IEnemyAIService, ILogger)

// After
public CombatService(..., IEnemyAIService, ICreatureTraitService, ILogger)
```

---

## Test Coverage

### New Tests (22 total)

**Enhancement Tests:**
- `EnhanceEnemy_EliteTier_AddsOneTrait`
- `EnhanceEnemy_ChampionTier_AddsTwoTraits`
- `EnhanceEnemy_BossTier_AddsThreeTraits`
- `EnhanceEnemy_StandardTier_NoTraits`
- `EnhanceEnemy_Armored_IncreasesArmorSoak`
- `EnhanceEnemy_Relentless_IncreasesHpAndAddsImmunity`
- `EnhanceEnemy_PrefixesName`
- `EnhanceEnemy_MechanicalEnemy_CannotBeVampiric`

**Turn Start Tests:**
- `ProcessTraitTurnStart_Regenerating_HealsEnemy`
- `ProcessTraitTurnStart_NoTrait_ReturnsZero`
- `ProcessTraitTurnStart_AtMaxHp_DoesNotOverheal`

**On Death Tests:**
- `ProcessTraitOnDeath_Explosive_DamagesAllCombatants`
- `ProcessTraitOnDeath_Explosive_DoesNotDamageSelf`
- `ProcessTraitOnDeath_NoTrait_ReturnsEmpty`

**On Damage Tests:**
- `ProcessTraitOnDamageDealt_Vampiric_HealsAttacker`
- `ProcessTraitOnDamageDealt_NoTrait_ReturnsZero`
- `ProcessTraitOnDamageDealt_Vampiric_DoesNotOverheal`
- `ProcessTraitOnDamageReceived_Thorns_ReturnsDamage`
- `ProcessTraitOnDamageReceived_NoTrait_ReturnsZero`

**Immunity Tests:**
- `IsImmuneToEffect_Relentless_ImmuneToStun`
- `IsImmuneToEffect_Relentless_NotImmuneToOtherEffects`
- `IsImmuneToEffect_NoTrait_NotImmune`

---

## Logging Matrix

| Event | Level | Template |
|-------|-------|----------|
| Enhancement Start | Information | `"Enhancing {Name} (Tier: {Tier}) with {Count} trait(s)"` |
| Trait Applied | Information | `"Trait {Trait} applied to {Name}. ActiveTraits: [{Traits}]"` |
| Trait Effect | Debug | `"Applied {Trait}: {Details}"` |
| Regeneration | Information | `"[Trait] {Name} regenerates {Amount} HP. HP: {Current}/{Max}"` |
| Explosion | Warning | `"[Trait] {Name} EXPLODES on death! Dealing {Damage} damage to all."` |
| Vampiric | Information | `"[Trait] {Name} drains {Amount} HP from the wound."` |
| Thorns | Information | `"[Trait] {Defender}'s thorns reflect {Damage} damage to {Attacker}!"` |
| Immunity | Debug | `"[Trait] {Name} is immune to {Effect} ({Trait})"` |

---

## Architecture

```
┌─────────────────────┐     ┌──────────────────────┐     ┌─────────────────────┐
│  EnemyFactory       │────▶│  CreatureTraitService│────▶│   Enemy Entity      │
│  (CreateFromTemplate)│     │  (EnhanceEnemy)      │     │   + ActiveTraits    │
└─────────────────────┘     └──────────────────────┘     └─────────────────────┘
         │                           │                            │
         │                           ▼                            │
         │                  ┌──────────────────────┐              │
         │                  │   Trait Effects:     │              │
         │                  │   - Stat Modifiers   │              │
         │                  │   - Name Prefixes    │              │
         │                  │   - Runtime Tags     │              │
         │                  └──────────────────────┘              │
         │                                                        │
         ▼                                                        ▼
┌─────────────────────┐                               ┌─────────────────────┐
│  CombatService      │◀──────────────────────────────│   Combatant         │
│  (Trait Triggers)   │                               │   + ActiveTraits    │
└─────────────────────┘                               └─────────────────────┘
```

---

## Known Limitations

1. **Berserker Damage Modifier**: +25% damage not yet integrated into AttackResolutionService
2. **Corrosive Vulnerable**: Status effect application not yet implemented
3. **Elite Spawn Chance**: Manual tag-based detection, no RNG promotion
4. **Single Tier Check**: Uses tag-based detection instead of proper tier property

---

## Migration Notes

### For Developers

If you have custom EnemyFactory or CombatService instantiations, you must now provide an `ICreatureTraitService`:

```csharp
// Update your DI registration
services.AddSingleton<ICreatureTraitService, CreatureTraitService>();
```

### For Tests

Existing EnemyFactory tests need to mock `ICreatureTraitService`:

```csharp
private readonly Mock<ICreatureTraitService> _mockTraitService = new Mock<ICreatureTraitService>();

_factory = new EnemyFactory(
    _mockLogger.Object,
    _mockDice.Object,
    _mockTraitService.Object);  // NEW
```

Existing CombatService tests need to mock `ICreatureTraitService` with default returns:

```csharp
private readonly Mock<ICreatureTraitService> _mockTraitService = new Mock<ICreatureTraitService>();

// Default setup for trait service
_mockTraitService.Setup(t => t.ProcessTraitTurnStart(It.IsAny<Combatant>())).Returns(0);
_mockTraitService.Setup(t => t.ProcessTraitOnDeath(It.IsAny<Combatant>(), It.IsAny<IEnumerable<Combatant>>()))
    .Returns(new List<(Combatant, int)>());
_mockTraitService.Setup(t => t.ProcessTraitOnDamageDealt(It.IsAny<Combatant>(), It.IsAny<int>())).Returns(0);
_mockTraitService.Setup(t => t.ProcessTraitOnDamageReceived(It.IsAny<Combatant>(), It.IsAny<Combatant>(), It.IsAny<int>())).Returns(0);
```

---

## Next Steps (v0.2.3+)

- Implement Berserker damage modifier in AttackResolutionService
- Implement Corrosive Vulnerable application via StatusEffectService
- Add RNG-based Elite promotion chance (15% + DangerLevel * 5%)
- Add trait exclusion rules (Fast incompatible with Stationary, etc.)
- Visual trait indicators in CombatScreenRenderer
- Add `ThreatTier` property to Enemy for proper tier tracking

---

## Contributors

- Implementation: Claude Opus 4.5
