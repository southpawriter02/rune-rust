# v0.1.2c Design Specification: Environmental Hazards

**Version:** 0.1.2c
**Phase Name:** Environmental Hazards
**Parent Version:** v0.1.2 (Dungeon Theming & Biomes)
**Prerequisites:** v0.1.2b Complete (Biome Content Pools)
**Estimated Tests:** ~28 unit tests

---

## Table of Contents

1. [Executive Summary](#1-executive-summary)
2. [Feature Overview](#2-feature-overview)
3. [Architecture Diagrams](#3-architecture-diagrams)
4. [BiomeHazard Entity](#4-biomehazard-entity)
5. [HazardTrigger Value Object](#5-hazardtrigger-value-object)
6. [BiomeDamageModifier Value Object](#6-biomedamagemodifier-value-object)
7. [HazardService](#7-hazardservice)
8. [ContentPlacementService Integration](#8-contentplacementservice-integration)
9. [Combat Integration](#9-combat-integration)
10. [Data Model Changes](#10-data-model-changes)
11. [Configuration File Schemas](#11-configuration-file-schemas)
12. [Logging Specifications](#12-logging-specifications)
13. [Unit Testing Requirements](#13-unit-testing-requirements)
14. [Use Cases](#14-use-cases)
15. [Deliverable Checklist](#15-deliverable-checklist)
16. [Acceptance Criteria](#16-acceptance-criteria)
17. [Dependencies](#17-dependencies)
18. [Future Considerations](#18-future-considerations)

---

## 1. Executive Summary

### 1.1 Purpose

Implement biome-specific environmental hazards that create danger zones within themed dungeon areas. Hazards deal damage, apply status effects, and add tactical considerations to exploration. This phase introduces the hazard entity, trigger mechanisms, damage modifiers, and skill-based avoidance/disarming systems.

### 1.2 Current State

| Area | Current State (v0.1.2b) | Target State (v0.1.2c) |
|------|------------------------|------------------------|
| Environmental dangers | None | BiomeHazard entities with triggers |
| Damage modifiers | None | BiomeDamageModifier per biome |
| Hazard placement | Placeholder in spawn tables | Full hazard slot filling |
| Hazard interaction | None | Trigger, avoid, disarm mechanics |
| Status application | Combat-only | Hazard-triggered status effects |

### 1.3 Key Deliverables

| Category | Items |
|----------|-------|
| **Entities** | `BiomeHazard` |
| **Value Objects** | `HazardTrigger`, `BiomeDamageModifier` |
| **Enums** | `HazardTriggerType` |
| **Services** | `HazardService` (with `IHazardService` interface) |
| **DTOs** | `HazardResult`, `DisarmResult` |
| **Service Updates** | `ContentPlacementService` hazard slot filling |
| **Configuration** | `hazards.json`, `hazards-schema.json` |
| **Tests** | ~28 new unit tests |

### 1.4 Architectural Significance

This version establishes the **environmental hazard pattern** that will be used for:
- Biome-themed environmental dangers
- Skill-based hazard avoidance and disarming
- Damage type modifiers per biome
- Persistent and one-time hazard mechanics
- Integration with status effect system

---

## 2. Feature Overview

```
v0.1.2c Environmental Hazards
├── BiomeHazard Entity
│   ├── Unique hazard identification (Id)
│   ├── Display name and descriptions
│   ├── Warning text for detection
│   ├── Biome associations (BiomeIds)
│   ├── Damage and damage type
│   ├── Status effects on trigger
│   ├── Trigger mechanism (HazardTrigger)
│   ├── Disarm configuration (skill, DC)
│   ├── Avoidance configuration (skill, DC)
│   ├── Persistence settings
│   └── Visual properties (symbol, color)
├── HazardTrigger Value Object
│   ├── Trigger type (enum)
│   ├── Trigger chance (0.0-1.0)
│   ├── Detection DC
│   └── Visibility flag
├── HazardTriggerType Enum
│   ├── OnEnter (room entry)
│   ├── PerTurn (each turn in room)
│   ├── OnAction (specific actions)
│   ├── Conditional (condition met)
│   └── Ambient (always active)
├── BiomeDamageModifier Value Object
│   ├── Biome ID reference
│   ├── Damage type modifiers (dictionary)
│   ├── Convenience properties (FireModifier, IceModifier)
│   └── ApplyModifier method
├── HazardService
│   ├── GetHazardsForBiome(biomeId)
│   ├── GetAllHazards()
│   ├── TriggerHazard(hazard, player, room)
│   ├── TryDisarm(hazard, player)
│   ├── TryDetect(hazard, player)
│   ├── GetBiomeDamageModifier(biomeId)
│   └── CheckHazardTrigger(hazard, triggerType)
├── ContentPlacementService Integration
│   ├── FillHazardSlot biome filtering
│   └── Hazard placement in rooms
├── Combat Integration
│   └── Biome damage modifiers applied
└── Configuration
    ├── hazards.json (5+ hazards)
    └── hazards-schema.json (validation)
```

---

## 3. Architecture Diagrams

### 3.1 Layer Diagram

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           PRESENTATION LAYER                                 │
├─────────────────────────────────────────────────────────────────────────────┤
│  GameView displays hazard warnings and effects                               │
│  ├── Hazard warning text on approach                                        │
│  ├── Hazard trigger messages                                                │
│  ├── Disarm/avoid result display                                            │
│  └── Status effect application messages                                     │
└─────────────────────────────────────────────────────────────────────────────┘
                                      │
                                      ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                           APPLICATION LAYER                                  │
├─────────────────────────────────────────────────────────────────────────────┤
│  HazardService                        ContentPlacementService (Updated)      │
│  ├── GetHazardsForBiome(biomeId)      ├── FillHazardSlot() // biome-aware   │
│  ├── GetAllHazards()                  └── PlaceHazard()                     │
│  ├── TriggerHazard(hazard, player)                                          │
│  ├── TryDisarm(hazard, player)        GameSessionService (Updated)          │
│  ├── TryDetect(hazard, player)        ├── ProcessRoomEntry() // hazards     │
│  ├── GetBiomeDamageModifier(biomeId)  └── ProcessTurnEnd() // per-turn      │
│  └── CheckHazardTrigger()                                                   │
│                                                                              │
│  Interfaces:                         DTOs:                                   │
│  └── IHazardService                  ├── HazardResult                       │
│                                      └── DisarmResult                       │
└─────────────────────────────────────────────────────────────────────────────┘
                                      │
                                      ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                             DOMAIN LAYER                                     │
├─────────────────────────────────────────────────────────────────────────────┤
│  Definitions:                  Value Objects:                                │
│  ┌─────────────────────────┐  ┌─────────────────────────┐                   │
│  │ BiomeHazard             │  │ HazardTrigger           │                   │
│  │ ├── Id: string          │  │ ├── Type: TriggerType   │                   │
│  │ ├── Name: string        │  │ ├── Chance: float       │                   │
│  │ ├── Description: string │  │ ├── DetectionDC: int    │                   │
│  │ ├── WarningText: string │  │ └── Visible: bool       │                   │
│  │ ├── BiomeIds: string[]  │  └─────────────────────────┘                   │
│  │ ├── Damage: int         │  ┌─────────────────────────┐                   │
│  │ ├── DamageType: string  │  │ BiomeDamageModifier     │                   │
│  │ ├── StatusEffects: []   │  │ ├── BiomeId: string     │                   │
│  │ ├── Trigger: HazardTrig │  │ ├── Modifiers: dict     │                   │
│  │ ├── CanDisarm: bool     │  │ ├── FireModifier        │                   │
│  │ ├── DisarmSkill: string?│  │ ├── IceModifier         │                   │
│  │ ├── DisarmDC: int       │  │ └── ApplyModifier()     │                   │
│  │ ├── CanAvoid: bool      │  └─────────────────────────┘                   │
│  │ ├── AvoidSkill: string? │                                                │
│  │ ├── AvoidDC: int        │  Enums:                                        │
│  │ ├── Persistent: bool    │  ┌─────────────────────────┐                   │
│  │ ├── TriggerInterval: int│  │ HazardTriggerType       │                   │
│  │ ├── MapSymbol: char     │  │ ├── OnEnter             │                   │
│  │ └── Color: string       │  │ ├── PerTurn             │                   │
│  └─────────────────────────┘  │ ├── OnAction            │                   │
│                               │ ├── Conditional         │                   │
│  Entities (Updated):          │ └── Ambient             │                   │
│  ┌─────────────────────────┐  └─────────────────────────┘                   │
│  │ Room                    │                                                │
│  │ └── Hazards: List<str>  │                                                │
│  └─────────────────────────┘                                                │
└─────────────────────────────────────────────────────────────────────────────┘
                                      │
                                      ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                         INFRASTRUCTURE LAYER                                 │
├─────────────────────────────────────────────────────────────────────────────┤
│  JsonConfigurationProvider                                                   │
│  ├── GetHazardDefinitions(): IReadOnlyList<BiomeHazard>                     │
│  ├── GetBiomeDamageModifiers(): IReadOnlyList<BiomeDamageModifier>          │
│  └── Loads and deserializes config/hazards.json                             │
│                                                                              │
│  Configuration Files:                                                        │
│  ├── config/hazards.json (5+ biome hazards + damage modifiers)              │
│  └── config/schemas/hazards-schema.json (validation schema)                 │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 3.2 Hazard Trigger Flow

```
┌───────────────────────────────────────┐
│ Player enters Room with hazard        │
│ Room.Hazards contains "lava-pool"     │
└───────────────┬───────────────────────┘
                │
                ▼
┌───────────────────────────────────────────────────────────────┐
│ Step 1: Get Hazard Definition                                 │
├───────────────────────────────────────────────────────────────┤
│ HazardService.GetHazard("lava-pool")                          │
│ └── Returns BiomeHazard with trigger configuration            │
└───────────────┬───────────────────────────────────────────────┘
                │
                ▼
┌───────────────────────────────────────────────────────────────┐
│ Step 2: Check Trigger Type                                    │
├───────────────────────────────────────────────────────────────┤
│ hazard.Trigger.Type == HazardTriggerType.OnEnter              │
│ └── This hazard triggers when entering the room               │
└───────────────┬───────────────────────────────────────────────┘
                │
                ▼
┌───────────────────────────────────────────────────────────────┐
│ Step 3: Check Detection (if not visible)                      │
├───────────────────────────────────────────────────────────────┤
│ hazard.Trigger.Visible == true                                │
│ └── Player sees warning: "Intense heat radiates from the      │
│     glowing floor ahead."                                     │
│                                                               │
│ If Visible == false:                                          │
│   PerformCheck(player, "perception", DetectionDC)             │
│   └── Success: Show warning; Failure: No warning              │
└───────────────┬───────────────────────────────────────────────┘
                │
                ▼
┌───────────────────────────────────────────────────────────────┐
│ Step 4: Attempt Avoidance (if applicable)                     │
├───────────────────────────────────────────────────────────────┤
│ hazard.CanAvoid == true                                       │
│ hazard.AvoidSkill == "acrobatics"                             │
│ hazard.AvoidDC == 15                                          │
│                                                               │
│ SkillCheckService.PerformCheck(player, "acrobatics", 15)      │
│ ├── Success: "You nimbly avoid the lava pool!"                │
│ │   └── Return HazardResult { WasAvoided = true }             │
│ └── Failure: Continue to trigger                              │
└───────────────┬───────────────────────────────────────────────┘
                │
                ▼
┌───────────────────────────────────────────────────────────────┐
│ Step 5: Check Trigger Chance                                  │
├───────────────────────────────────────────────────────────────┤
│ hazard.Trigger.Chance == 1.0 (100%)                           │
│ Roll: Random.Shared.NextDouble() → 0.42                       │
│ 0.42 <= 1.0 → Hazard triggers                                 │
│                                                               │
│ If roll > Chance:                                             │
│   Return HazardResult { DidNotTrigger = true }                │
└───────────────┬───────────────────────────────────────────────┘
                │
                ▼
┌───────────────────────────────────────────────────────────────┐
│ Step 6: Apply Biome Damage Modifier                           │
├───────────────────────────────────────────────────────────────┤
│ room.BiomeId == "volcanic-caverns"                            │
│ GetBiomeDamageModifier("volcanic-caverns")                    │
│ └── Modifiers: { fire: 0.5, ice: 1.5 }                        │
│                                                               │
│ hazard.Damage == 15, hazard.DamageType == "fire"              │
│ modifier.ApplyModifier(15, "fire")                            │
│ └── 15 × 0.5 = 7 (fire resistance in volcanic area)           │
└───────────────┬───────────────────────────────────────────────┘
                │
                ▼
┌───────────────────────────────────────────────────────────────┐
│ Step 7: Apply Damage and Status Effects                       │
├───────────────────────────────────────────────────────────────┤
│ CombatService.ApplyDamage(player, 7, "fire", "hazard:lava")   │
│ └── Player takes 7 fire damage                                │
│                                                               │
│ hazard.StatusEffects == ["burning"]                           │
│ StatusEffectService.ApplyEffect(player, "burning")            │
│ └── Player is now Burning                                     │
│                                                               │
│ Return HazardResult {                                         │
│   WasTriggered = true,                                        │
│   DamageDealt = 7,                                            │
│   DamageType = "fire",                                        │
│   StatusEffectsApplied = ["burning"]                          │
│ }                                                             │
└───────────────────────────────────────────────────────────────┘
```

### 3.3 Hazard Disarm Flow

```
┌───────────────────────────────────────┐
│ Player uses "disarm" command on       │
│ "bone-trap" hazard in room            │
└───────────────┬───────────────────────┘
                │
                ▼
┌───────────────────────────────────────────────────────────────┐
│ Step 1: Check if Hazard Can Be Disarmed                       │
├───────────────────────────────────────────────────────────────┤
│ hazard.CanDisarm == true                                      │
│                                                               │
│ If CanDisarm == false:                                        │
│   Return DisarmResult {                                       │
│     CannotDisarm = true,                                      │
│     Message = "The Bone Scythe Trap cannot be disarmed."      │
│   }                                                           │
└───────────────┬───────────────────────────────────────────────┘
                │
                ▼
┌───────────────────────────────────────────────────────────────┐
│ Step 2: Perform Disarm Skill Check                            │
├───────────────────────────────────────────────────────────────┤
│ hazard.DisarmSkill == "sleight-of-hand"                       │
│ hazard.DisarmDC == 15                                         │
│                                                               │
│ SkillCheckService.PerformCheck(player, "sleight-of-hand", 15) │
│ └── Roll: 2d6 + modifier vs DC 15                             │
└───────────────┬───────────────────────────────────────────────┘
                │
        ┌───────┴───────┐
        │               │
        ▼               ▼
┌───────────────┐ ┌───────────────────────────────────────────┐
│ Success       │ │ Failure                                   │
├───────────────┤ ├───────────────────────────────────────────┤
│ Return:       │ │ Check for Critical Failure:               │
│ DisarmResult {│ │ ├── Normal Failure:                       │
│   Success=true│ │ │   Return DisarmResult {                 │
│   Message=    │ │ │     Success = false,                    │
│   "You safely │ │ │     Message = "You fail to disarm..."   │
│   disarm the  │ │ │   }                                     │
│   trap."      │ │ │                                         │
│ }             │ │ └── Critical Failure (natural 2):         │
│               │ │     TriggerHazard(hazard, player, room)   │
│ Remove hazard │ │     Return DisarmResult {                 │
│ from room     │ │       Success = false,                    │
│               │ │       TriggeredHazard = true,             │
│               │ │       TriggerResult = result,             │
│               │ │       Message = "The trap springs!"       │
│               │ │     }                                     │
└───────────────┘ └───────────────────────────────────────────┘
```

---

## 4. BiomeHazard Entity

### 4.1 Entity Definition

**File:** `src/Core/RuneAndRust.Domain/Definitions/BiomeHazard.cs`

```csharp
namespace RuneAndRust.Domain.Definitions;

/// <summary>
/// Defines an environmental hazard specific to one or more biomes.
/// </summary>
/// <remarks>
/// Hazards create danger zones in dungeon rooms, dealing damage and applying
/// status effects when triggered. They can be avoided through skill checks
/// or disarmed (if supported).
/// </remarks>
public class BiomeHazard
{
    /// <summary>
    /// Gets the unique hazard identifier.
    /// </summary>
    /// <example>poison-gas-cloud, lava-pool, ice-patch</example>
    public string Id { get; init; } = string.Empty;

    /// <summary>
    /// Gets the display name shown to the player.
    /// </summary>
    public string Name { get; init; } = string.Empty;

    /// <summary>
    /// Gets the detailed description shown when the hazard is encountered.
    /// </summary>
    public string Description { get; init; } = string.Empty;

    /// <summary>
    /// Gets the warning text shown when approaching or detecting the hazard.
    /// </summary>
    public string WarningText { get; init; } = string.Empty;

    /// <summary>
    /// Gets the biome IDs where this hazard can appear.
    /// </summary>
    public IReadOnlyList<string> BiomeIds { get; init; } = Array.Empty<string>();

    /// <summary>
    /// Gets the base damage dealt per trigger.
    /// </summary>
    public int Damage { get; init; }

    /// <summary>
    /// Gets the damage type (e.g., fire, ice, poison, physical).
    /// </summary>
    public string DamageType { get; init; } = "physical";

    /// <summary>
    /// Gets the status effect IDs applied when the hazard triggers.
    /// </summary>
    public IReadOnlyList<string> StatusEffects { get; init; } = Array.Empty<string>();

    /// <summary>
    /// Gets the trigger mechanism configuration.
    /// </summary>
    public HazardTrigger Trigger { get; init; } = default;

    /// <summary>
    /// Gets whether this hazard can be disarmed.
    /// </summary>
    public bool CanDisarm { get; init; }

    /// <summary>
    /// Gets the skill used to disarm the hazard (if disarmable).
    /// </summary>
    public string? DisarmSkill { get; init; }

    /// <summary>
    /// Gets the difficulty class for disarming.
    /// </summary>
    public int DisarmDC { get; init; }

    /// <summary>
    /// Gets whether the hazard can be avoided with a skill check.
    /// </summary>
    public bool CanAvoid { get; init; }

    /// <summary>
    /// Gets the skill used to avoid the hazard.
    /// </summary>
    public string? AvoidSkill { get; init; }

    /// <summary>
    /// Gets the difficulty class for avoidance.
    /// </summary>
    public int AvoidDC { get; init; }

    /// <summary>
    /// Gets whether this hazard persists after triggering.
    /// </summary>
    /// <remarks>
    /// Persistent hazards remain active and can trigger again.
    /// Non-persistent hazards are removed after triggering once.
    /// </remarks>
    public bool Persistent { get; init; }

    /// <summary>
    /// Gets how many turns between triggers for persistent hazards.
    /// </summary>
    /// <remarks>
    /// A value of 1 means the hazard can trigger every turn.
    /// A value of 2 means every other turn, etc.
    /// </remarks>
    public int TriggerInterval { get; init; } = 1;

    /// <summary>
    /// Gets the character symbol used on maps.
    /// </summary>
    public char MapSymbol { get; init; } = '!';

    /// <summary>
    /// Gets the color for visual display.
    /// </summary>
    public string Color { get; init; } = "red";

    /// <summary>
    /// Creates a new BiomeHazard from configuration data.
    /// </summary>
    /// <param name="id">The unique hazard identifier.</param>
    /// <param name="name">The display name.</param>
    /// <param name="description">The encounter description.</param>
    /// <param name="warningText">The warning shown on detection.</param>
    /// <param name="biomeIds">The biomes where this hazard appears.</param>
    /// <param name="damage">Base damage dealt.</param>
    /// <param name="damageType">Type of damage.</param>
    /// <param name="statusEffects">Status effects applied on trigger.</param>
    /// <param name="trigger">Trigger mechanism configuration.</param>
    /// <param name="canDisarm">Whether the hazard can be disarmed.</param>
    /// <param name="disarmSkill">Skill required to disarm.</param>
    /// <param name="disarmDC">Difficulty class to disarm.</param>
    /// <param name="canAvoid">Whether the hazard can be avoided.</param>
    /// <param name="avoidSkill">Skill required to avoid.</param>
    /// <param name="avoidDC">Difficulty class to avoid.</param>
    /// <param name="persistent">Whether the hazard persists after triggering.</param>
    /// <param name="triggerInterval">Turns between triggers for persistent hazards.</param>
    /// <param name="mapSymbol">Character for map display.</param>
    /// <param name="color">Color for visual display.</param>
    /// <returns>A new BiomeHazard instance.</returns>
    public static BiomeHazard Create(
        string id,
        string name,
        string description,
        string warningText,
        IReadOnlyList<string> biomeIds,
        int damage,
        string damageType,
        IReadOnlyList<string> statusEffects,
        HazardTrigger trigger,
        bool canDisarm,
        string? disarmSkill,
        int disarmDC,
        bool canAvoid,
        string? avoidSkill,
        int avoidDC,
        bool persistent,
        int triggerInterval,
        char mapSymbol,
        string color)
    {
        return new BiomeHazard
        {
            Id = id,
            Name = name,
            Description = description,
            WarningText = warningText,
            BiomeIds = biomeIds,
            Damage = damage,
            DamageType = damageType,
            StatusEffects = statusEffects,
            Trigger = trigger,
            CanDisarm = canDisarm,
            DisarmSkill = disarmSkill,
            DisarmDC = disarmDC,
            CanAvoid = canAvoid,
            AvoidSkill = avoidSkill,
            AvoidDC = avoidDC,
            Persistent = persistent,
            TriggerInterval = triggerInterval,
            MapSymbol = mapSymbol,
            Color = color
        };
    }
}
```

### 4.2 BiomeHazard Properties Summary

| Property | Type | Description | Default |
|----------|------|-------------|---------|
| `Id` | `string` | Unique kebab-case identifier | `""` |
| `Name` | `string` | Display name | `""` |
| `Description` | `string` | Encounter description | `""` |
| `WarningText` | `string` | Detection warning | `""` |
| `BiomeIds` | `IReadOnlyList<string>` | Associated biomes | `[]` |
| `Damage` | `int` | Base damage per trigger | `0` |
| `DamageType` | `string` | Damage type ID | `"physical"` |
| `StatusEffects` | `IReadOnlyList<string>` | Applied status effects | `[]` |
| `Trigger` | `HazardTrigger` | Trigger configuration | `default` |
| `CanDisarm` | `bool` | Disarmable flag | `false` |
| `DisarmSkill` | `string?` | Skill to disarm | `null` |
| `DisarmDC` | `int` | Disarm difficulty | `0` |
| `CanAvoid` | `bool` | Avoidable flag | `false` |
| `AvoidSkill` | `string?` | Skill to avoid | `null` |
| `AvoidDC` | `int` | Avoid difficulty | `0` |
| `Persistent` | `bool` | Remains after trigger | `false` |
| `TriggerInterval` | `int` | Turns between triggers | `1` |
| `MapSymbol` | `char` | Map character | `'!'` |
| `Color` | `string` | Display color | `"red"` |

---

## 5. HazardTrigger Value Object

### 5.1 Value Object Definition

**File:** `src/Core/RuneAndRust.Domain/ValueObjects/HazardTrigger.cs`

```csharp
namespace RuneAndRust.Domain.ValueObjects;

/// <summary>
/// Defines how and when a hazard is triggered.
/// </summary>
public readonly record struct HazardTrigger
{
    /// <summary>
    /// Gets the type of trigger mechanism.
    /// </summary>
    public HazardTriggerType Type { get; init; }

    /// <summary>
    /// Gets the chance to trigger when conditions are met (0.0 to 1.0).
    /// </summary>
    /// <remarks>
    /// A value of 1.0 means the hazard always triggers when conditions are met.
    /// A value of 0.5 means 50% chance to trigger.
    /// </remarks>
    public float Chance { get; init; }

    /// <summary>
    /// Gets the difficulty class for detecting the hazard before triggering.
    /// </summary>
    /// <remarks>
    /// Players can make a perception check against this DC to detect hidden hazards.
    /// Lower values are easier to detect.
    /// </remarks>
    public int DetectionDC { get; init; }

    /// <summary>
    /// Gets whether the hazard is visible by default without a check.
    /// </summary>
    public bool Visible { get; init; }

    /// <summary>
    /// Creates a trigger that activates when entering a room.
    /// </summary>
    public static HazardTrigger OnEnter(float chance = 1.0f, int detectionDC = 10, bool visible = true)
        => new() { Type = HazardTriggerType.OnEnter, Chance = chance, DetectionDC = detectionDC, Visible = visible };

    /// <summary>
    /// Creates a trigger that activates each turn in the room.
    /// </summary>
    public static HazardTrigger PerTurn(float chance = 0.5f, int detectionDC = 10, bool visible = true)
        => new() { Type = HazardTriggerType.PerTurn, Chance = chance, DetectionDC = detectionDC, Visible = visible };

    /// <summary>
    /// Creates a trigger that activates on specific player actions.
    /// </summary>
    public static HazardTrigger OnAction(float chance = 1.0f, int detectionDC = 12, bool visible = false)
        => new() { Type = HazardTriggerType.OnAction, Chance = chance, DetectionDC = detectionDC, Visible = visible };

    /// <summary>
    /// Creates a conditional trigger based on game state.
    /// </summary>
    public static HazardTrigger Conditional(float chance = 0.3f, int detectionDC = 8, bool visible = true)
        => new() { Type = HazardTriggerType.Conditional, Chance = chance, DetectionDC = detectionDC, Visible = visible };

    /// <summary>
    /// Creates an always-active ambient hazard.
    /// </summary>
    public static HazardTrigger Ambient(float chance = 1.0f)
        => new() { Type = HazardTriggerType.Ambient, Chance = chance, DetectionDC = 0, Visible = true };
}
```

### 5.2 HazardTriggerType Enum

**File:** `src/Core/RuneAndRust.Domain/Definitions/HazardTriggerType.cs`

```csharp
namespace RuneAndRust.Domain.Definitions;

/// <summary>
/// Defines the types of hazard trigger mechanisms.
/// </summary>
public enum HazardTriggerType
{
    /// <summary>
    /// Triggers when the player enters the room containing the hazard.
    /// </summary>
    OnEnter,

    /// <summary>
    /// Triggers at the end of each turn while the player is in the room.
    /// </summary>
    PerTurn,

    /// <summary>
    /// Triggers when the player performs specific actions (search, interact, etc.).
    /// </summary>
    OnAction,

    /// <summary>
    /// Triggers when specific game conditions are met (e.g., combat, loud noise).
    /// </summary>
    Conditional,

    /// <summary>
    /// Always active environmental effect with no specific trigger.
    /// </summary>
    Ambient
}
```

### 5.3 Trigger Type Behaviors

| Type | When Triggered | Example Hazards |
|------|----------------|-----------------|
| `OnEnter` | Player enters room | Tripwires, pressure plates |
| `PerTurn` | Each turn in room | Poison gas clouds, extreme heat |
| `OnAction` | On specific actions | Hidden traps, cursed objects |
| `Conditional` | When condition met | Cave-ins (on combat noise) |
| `Ambient` | Always active | Extreme cold, low oxygen |

---

## 6. BiomeDamageModifier Value Object

### 6.1 Value Object Definition

**File:** `src/Core/RuneAndRust.Domain/ValueObjects/BiomeDamageModifier.cs`

```csharp
namespace RuneAndRust.Domain.ValueObjects;

/// <summary>
/// Defines damage type modifications for a specific biome.
/// </summary>
/// <remarks>
/// Biomes can modify damage effectiveness. For example, fire damage is less
/// effective in volcanic caverns (fire resistance) but more effective in
/// frozen depths (fire vulnerability).
/// </remarks>
public readonly record struct BiomeDamageModifier
{
    /// <summary>
    /// Gets the biome ID this modifier applies to.
    /// </summary>
    public string BiomeId { get; init; }

    /// <summary>
    /// Gets the damage type modifiers as a dictionary (damage type → multiplier).
    /// </summary>
    /// <remarks>
    /// Multiplier values:
    /// - 0.0 = Immune (no damage)
    /// - 0.5 = Resistant (half damage)
    /// - 1.0 = Normal (full damage)
    /// - 1.5 = Vulnerable (50% extra damage)
    /// - 2.0 = Very vulnerable (double damage)
    /// </remarks>
    public IReadOnlyDictionary<string, float> Modifiers { get; init; }

    /// <summary>
    /// Gets the fire damage modifier for this biome.
    /// </summary>
    public float FireModifier => Modifiers.GetValueOrDefault("fire", 1.0f);

    /// <summary>
    /// Gets the ice damage modifier for this biome.
    /// </summary>
    public float IceModifier => Modifiers.GetValueOrDefault("ice", 1.0f);

    /// <summary>
    /// Gets the poison damage modifier for this biome.
    /// </summary>
    public float PoisonModifier => Modifiers.GetValueOrDefault("poison", 1.0f);

    /// <summary>
    /// Gets the physical damage modifier for this biome.
    /// </summary>
    public float PhysicalModifier => Modifiers.GetValueOrDefault("physical", 1.0f);

    /// <summary>
    /// Applies the biome modifier to a damage value.
    /// </summary>
    /// <param name="baseDamage">The base damage before modification.</param>
    /// <param name="damageType">The type of damage being dealt.</param>
    /// <returns>The modified damage value, rounded down.</returns>
    public int ApplyModifier(int baseDamage, string damageType)
    {
        var multiplier = Modifiers.GetValueOrDefault(damageType.ToLowerInvariant(), 1.0f);
        return (int)(baseDamage * multiplier);
    }

    /// <summary>
    /// Gets the modifier multiplier for a specific damage type.
    /// </summary>
    /// <param name="damageType">The damage type to look up.</param>
    /// <returns>The multiplier (defaults to 1.0 if not specified).</returns>
    public float GetModifier(string damageType)
    {
        return Modifiers.GetValueOrDefault(damageType.ToLowerInvariant(), 1.0f);
    }

    /// <summary>
    /// Creates a neutral modifier with no damage adjustments.
    /// </summary>
    public static BiomeDamageModifier Neutral(string biomeId) => new()
    {
        BiomeId = biomeId,
        Modifiers = new Dictionary<string, float>()
    };

    /// <summary>
    /// Creates volcanic cavern modifiers (fire resistant, ice vulnerable).
    /// </summary>
    public static BiomeDamageModifier VolcanicCaverns => new()
    {
        BiomeId = "volcanic-caverns",
        Modifiers = new Dictionary<string, float>
        {
            ["fire"] = 0.5f,
            ["ice"] = 1.5f,
            ["physical"] = 1.0f
        }
    };

    /// <summary>
    /// Creates frozen depths modifiers (ice resistant, fire vulnerable).
    /// </summary>
    public static BiomeDamageModifier FrozenDepths => new()
    {
        BiomeId = "frozen-depths",
        Modifiers = new Dictionary<string, float>
        {
            ["ice"] = 0.5f,
            ["fire"] = 1.5f,
            ["physical"] = 1.0f
        }
    };

    /// <summary>
    /// Creates catacombs modifiers (holy vulnerable, dark resistant).
    /// </summary>
    public static BiomeDamageModifier Catacombs => new()
    {
        BiomeId = "catacombs",
        Modifiers = new Dictionary<string, float>
        {
            ["holy"] = 1.5f,
            ["dark"] = 0.75f,
            ["physical"] = 1.0f
        }
    };
}
```

### 6.2 Damage Modifier Examples

| Biome | Fire | Ice | Poison | Holy | Dark | Physical |
|-------|------|-----|--------|------|------|----------|
| Volcanic Caverns | 0.5× | 1.5× | 1.0× | 1.0× | 1.0× | 1.0× |
| Frozen Depths | 1.5× | 0.5× | 1.0× | 1.0× | 1.0× | 1.0× |
| Catacombs | 1.0× | 1.0× | 1.0× | 1.5× | 0.75× | 1.0× |
| Sewers | 1.0× | 1.0× | 0.75× | 1.0× | 1.0× | 1.0× |
| Mines | 1.0× | 1.0× | 1.0× | 1.0× | 1.0× | 1.0× |

---

## 7. HazardService

### 7.1 Interface Definition

**File:** `src/Core/RuneAndRust.Application/Interfaces/IHazardService.cs`

```csharp
namespace RuneAndRust.Application.Interfaces;

/// <summary>
/// Service for managing environmental hazards.
/// </summary>
public interface IHazardService
{
    /// <summary>
    /// Gets all hazards configured for a specific biome.
    /// </summary>
    /// <param name="biomeId">The biome identifier.</param>
    /// <returns>List of hazards that can appear in the biome.</returns>
    IReadOnlyList<BiomeHazard> GetHazardsForBiome(string biomeId);

    /// <summary>
    /// Gets all hazard definitions.
    /// </summary>
    /// <returns>All configured hazards.</returns>
    IReadOnlyList<BiomeHazard> GetAllHazards();

    /// <summary>
    /// Gets a specific hazard by ID.
    /// </summary>
    /// <param name="hazardId">The hazard identifier.</param>
    /// <returns>The hazard definition, or null if not found.</returns>
    BiomeHazard? GetHazard(string hazardId);

    /// <summary>
    /// Attempts to trigger a hazard on a player.
    /// </summary>
    /// <param name="hazard">The hazard to trigger.</param>
    /// <param name="player">The player affected.</param>
    /// <param name="room">The room containing the hazard.</param>
    /// <returns>The result of the trigger attempt.</returns>
    HazardResult TriggerHazard(BiomeHazard hazard, Player player, Room room);

    /// <summary>
    /// Attempts to disarm a hazard.
    /// </summary>
    /// <param name="hazard">The hazard to disarm.</param>
    /// <param name="player">The player attempting to disarm.</param>
    /// <returns>The result of the disarm attempt.</returns>
    DisarmResult TryDisarm(BiomeHazard hazard, Player player);

    /// <summary>
    /// Attempts to detect a hidden hazard.
    /// </summary>
    /// <param name="hazard">The hazard to detect.</param>
    /// <param name="player">The player attempting detection.</param>
    /// <returns>True if the hazard was detected.</returns>
    bool TryDetect(BiomeHazard hazard, Player player);

    /// <summary>
    /// Gets the damage modifier for a biome.
    /// </summary>
    /// <param name="biomeId">The biome identifier.</param>
    /// <returns>The damage modifier for the biome.</returns>
    BiomeDamageModifier GetBiomeDamageModifier(string biomeId);

    /// <summary>
    /// Checks if a hazard should trigger based on its trigger type.
    /// </summary>
    /// <param name="hazard">The hazard to check.</param>
    /// <param name="triggerType">The current trigger event type.</param>
    /// <returns>True if the hazard should attempt to trigger.</returns>
    bool CheckHazardTrigger(BiomeHazard hazard, HazardTriggerType triggerType);
}
```

### 7.2 Service Implementation

**File:** `src/Core/RuneAndRust.Application/Services/HazardService.cs`

```csharp
namespace RuneAndRust.Application.Services;

/// <summary>
/// Service for managing environmental hazards in biomes.
/// </summary>
public class HazardService : IHazardService
{
    private readonly IConfigurationProvider _config;
    private readonly ISkillCheckService _skillCheck;
    private readonly ICombatService _combat;
    private readonly IStatusEffectService _statusEffects;
    private readonly ILogger<HazardService> _logger;

    /// <summary>
    /// Initializes a new instance of the HazardService.
    /// </summary>
    public HazardService(
        IConfigurationProvider config,
        ISkillCheckService skillCheck,
        ICombatService combat,
        IStatusEffectService statusEffects,
        ILogger<HazardService> logger)
    {
        _config = config;
        _skillCheck = skillCheck;
        _combat = combat;
        _statusEffects = statusEffects;
        _logger = logger;
    }

    /// <inheritdoc />
    public IReadOnlyList<BiomeHazard> GetHazardsForBiome(string biomeId)
    {
        return _config.GetHazardDefinitions()
            .Where(h => h.BiomeIds.Contains(biomeId))
            .ToList();
    }

    /// <inheritdoc />
    public IReadOnlyList<BiomeHazard> GetAllHazards()
    {
        return _config.GetHazardDefinitions();
    }

    /// <inheritdoc />
    public BiomeHazard? GetHazard(string hazardId)
    {
        return _config.GetHazardDefinitions()
            .FirstOrDefault(h => h.Id == hazardId);
    }

    /// <inheritdoc />
    public HazardResult TriggerHazard(BiomeHazard hazard, Player player, Room room)
    {
        _logger.LogDebug(
            "Attempting to trigger hazard {HazardId} on player {PlayerId}",
            hazard.Id,
            player.Id);

        // Step 1: Check if hazard can be avoided
        if (hazard.CanAvoid && hazard.AvoidSkill != null)
        {
            var avoidCheck = _skillCheck.PerformCheck(
                player,
                hazard.AvoidSkill,
                hazard.AvoidDC);

            if (avoidCheck.IsSuccess)
            {
                _logger.LogInformation(
                    "Player {PlayerId} avoided hazard {HazardId} with {Skill} check (rolled {Roll} vs DC {DC})",
                    player.Id,
                    hazard.Id,
                    hazard.AvoidSkill,
                    avoidCheck.Total,
                    hazard.AvoidDC);

                return new HazardResult
                {
                    HazardId = hazard.Id,
                    HazardName = hazard.Name,
                    WasAvoided = true,
                    AvoidCheckResult = avoidCheck,
                    Message = $"You nimbly avoid the {hazard.Name}!"
                };
            }
        }

        // Step 2: Check trigger chance
        var triggerRoll = Random.Shared.NextDouble();
        if (triggerRoll > hazard.Trigger.Chance)
        {
            _logger.LogDebug(
                "Hazard {HazardId} did not trigger (rolled {Roll:F2} > chance {Chance:F2})",
                hazard.Id,
                triggerRoll,
                hazard.Trigger.Chance);

            return new HazardResult
            {
                HazardId = hazard.Id,
                HazardName = hazard.Name,
                DidNotTrigger = true,
                Message = $"The {hazard.Name} remains dormant."
            };
        }

        // Step 3: Get biome damage modifier
        var biomeModifier = GetBiomeDamageModifier(room.BiomeId);
        var modifiedDamage = biomeModifier.ApplyModifier(hazard.Damage, hazard.DamageType);

        // Step 4: Apply damage
        var damageResult = _combat.ApplyDamage(
            player,
            modifiedDamage,
            hazard.DamageType,
            $"hazard:{hazard.Id}");

        // Step 5: Apply status effects
        var appliedEffects = new List<string>();
        foreach (var effectId in hazard.StatusEffects)
        {
            if (_statusEffects.ApplyEffect(player, effectId))
            {
                appliedEffects.Add(effectId);
            }
        }

        _logger.LogInformation(
            "Hazard {HazardId} triggered on player {PlayerId}: {Damage} {DamageType} damage, effects: [{Effects}]",
            hazard.Id,
            player.Id,
            modifiedDamage,
            hazard.DamageType,
            string.Join(", ", appliedEffects));

        return new HazardResult
        {
            HazardId = hazard.Id,
            HazardName = hazard.Name,
            WasTriggered = true,
            DamageDealt = modifiedDamage,
            DamageType = hazard.DamageType,
            StatusEffectsApplied = appliedEffects,
            Message = BuildTriggerMessage(hazard, modifiedDamage, appliedEffects)
        };
    }

    /// <inheritdoc />
    public DisarmResult TryDisarm(BiomeHazard hazard, Player player)
    {
        _logger.LogDebug(
            "Player {PlayerId} attempting to disarm hazard {HazardId}",
            player.Id,
            hazard.Id);

        // Check if hazard can be disarmed
        if (!hazard.CanDisarm)
        {
            return new DisarmResult
            {
                HazardId = hazard.Id,
                HazardName = hazard.Name,
                CannotDisarm = true,
                Message = $"The {hazard.Name} cannot be disarmed."
            };
        }

        // Perform disarm skill check
        var check = _skillCheck.PerformCheck(
            player,
            hazard.DisarmSkill!,
            hazard.DisarmDC);

        if (check.IsSuccess)
        {
            _logger.LogInformation(
                "Player {PlayerId} successfully disarmed hazard {HazardId}",
                player.Id,
                hazard.Id);

            return new DisarmResult
            {
                HazardId = hazard.Id,
                HazardName = hazard.Name,
                Success = true,
                CheckResult = check,
                Message = $"You carefully disarm the {hazard.Name}."
            };
        }

        // Check for critical failure - triggers the hazard
        if (check.IsCriticalFailure)
        {
            _logger.LogWarning(
                "Player {PlayerId} critically failed disarming hazard {HazardId} - triggering!",
                player.Id,
                hazard.Id);

            // Note: Caller should call TriggerHazard separately to handle this
            return new DisarmResult
            {
                HazardId = hazard.Id,
                HazardName = hazard.Name,
                Success = false,
                TriggeredHazard = true,
                CheckResult = check,
                Message = $"Your attempt fails catastrophically! The {hazard.Name} triggers!"
            };
        }

        // Normal failure
        _logger.LogInformation(
            "Player {PlayerId} failed to disarm hazard {HazardId}",
            player.Id,
            hazard.Id);

        return new DisarmResult
        {
            HazardId = hazard.Id,
            HazardName = hazard.Name,
            Success = false,
            CheckResult = check,
            Message = $"You fail to disarm the {hazard.Name}."
        };
    }

    /// <inheritdoc />
    public bool TryDetect(BiomeHazard hazard, Player player)
    {
        // Visible hazards are automatically detected
        if (hazard.Trigger.Visible)
        {
            return true;
        }

        // Perform perception check against detection DC
        var check = _skillCheck.PerformCheck(
            player,
            "perception",
            hazard.Trigger.DetectionDC);

        var detected = check.IsSuccess;

        _logger.LogDebug(
            "Detection check for hazard {HazardId}: {Result} (rolled {Roll} vs DC {DC})",
            hazard.Id,
            detected ? "detected" : "not detected",
            check.Total,
            hazard.Trigger.DetectionDC);

        return detected;
    }

    /// <inheritdoc />
    public BiomeDamageModifier GetBiomeDamageModifier(string biomeId)
    {
        var modifiers = _config.GetBiomeDamageModifiers();
        return modifiers.FirstOrDefault(m => m.BiomeId == biomeId);
    }

    /// <inheritdoc />
    public bool CheckHazardTrigger(BiomeHazard hazard, HazardTriggerType triggerType)
    {
        return hazard.Trigger.Type == triggerType;
    }

    private static string BuildTriggerMessage(
        BiomeHazard hazard,
        int damage,
        IReadOnlyList<string> effects)
    {
        var message = $"{hazard.Description} You take {damage} {hazard.DamageType} damage!";

        if (effects.Count > 0)
        {
            message += $" You are now {string.Join(", ", effects)}!";
        }

        return message;
    }
}
```

### 7.3 HazardResult DTO

**File:** `src/Core/RuneAndRust.Application/DTOs/HazardResult.cs`

```csharp
namespace RuneAndRust.Application.DTOs;

/// <summary>
/// Represents the result of a hazard trigger attempt.
/// </summary>
public class HazardResult
{
    /// <summary>
    /// Gets the hazard ID that was involved.
    /// </summary>
    public string HazardId { get; init; } = string.Empty;

    /// <summary>
    /// Gets the hazard display name.
    /// </summary>
    public string HazardName { get; init; } = string.Empty;

    /// <summary>
    /// Gets whether the hazard was successfully avoided.
    /// </summary>
    public bool WasAvoided { get; init; }

    /// <summary>
    /// Gets the avoidance skill check result (if attempted).
    /// </summary>
    public SkillCheckResult? AvoidCheckResult { get; init; }

    /// <summary>
    /// Gets whether the hazard did not trigger (failed chance roll).
    /// </summary>
    public bool DidNotTrigger { get; init; }

    /// <summary>
    /// Gets whether the hazard was triggered.
    /// </summary>
    public bool WasTriggered { get; init; }

    /// <summary>
    /// Gets the damage dealt (if triggered).
    /// </summary>
    public int DamageDealt { get; init; }

    /// <summary>
    /// Gets the damage type (if triggered).
    /// </summary>
    public string DamageType { get; init; } = string.Empty;

    /// <summary>
    /// Gets the status effects applied (if triggered).
    /// </summary>
    public IReadOnlyList<string> StatusEffectsApplied { get; init; } = Array.Empty<string>();

    /// <summary>
    /// Gets a descriptive message about the result.
    /// </summary>
    public string Message { get; init; } = string.Empty;
}
```

### 7.4 DisarmResult DTO

**File:** `src/Core/RuneAndRust.Application/DTOs/DisarmResult.cs`

```csharp
namespace RuneAndRust.Application.DTOs;

/// <summary>
/// Represents the result of a hazard disarm attempt.
/// </summary>
public class DisarmResult
{
    /// <summary>
    /// Gets the hazard ID that was targeted.
    /// </summary>
    public string HazardId { get; init; } = string.Empty;

    /// <summary>
    /// Gets the hazard display name.
    /// </summary>
    public string HazardName { get; init; } = string.Empty;

    /// <summary>
    /// Gets whether the hazard cannot be disarmed.
    /// </summary>
    public bool CannotDisarm { get; init; }

    /// <summary>
    /// Gets whether the disarm attempt was successful.
    /// </summary>
    public bool Success { get; init; }

    /// <summary>
    /// Gets whether the failed disarm triggered the hazard.
    /// </summary>
    public bool TriggeredHazard { get; init; }

    /// <summary>
    /// Gets the hazard trigger result (if triggered on failure).
    /// </summary>
    public HazardResult? TriggerResult { get; init; }

    /// <summary>
    /// Gets the skill check result.
    /// </summary>
    public SkillCheckResult? CheckResult { get; init; }

    /// <summary>
    /// Gets a descriptive message about the result.
    /// </summary>
    public string Message { get; init; } = string.Empty;
}
```

---

## 8. ContentPlacementService Integration

### 8.1 Updated Service Methods

**File:** `src/Core/RuneAndRust.Application/Services/ContentPlacementService.cs` (updates)

```csharp
// Add to existing ContentPlacementService

private readonly IHazardService _hazardService;
private readonly IBiomeSpawnTableService _spawnTableService;

/// <summary>
/// Fills a hazard slot in a room with a biome-appropriate hazard.
/// </summary>
/// <param name="room">The room to place the hazard in.</param>
/// <param name="position">The position for seeded randomization.</param>
/// <returns>The placed hazard ID, or null if no hazard was placed.</returns>
public string? FillHazardSlot(Room room, Position3D position)
{
    // Get spawn table for the room's biome
    var spawnTable = _spawnTableService.GetSpawnTable(room.BiomeId);
    if (spawnTable == null || spawnTable.HazardPool.Count == 0)
    {
        _logger.LogDebug(
            "No hazard pool for biome {BiomeId}",
            room.BiomeId);
        return null;
    }

    // Filter hazards by depth
    var validHazards = spawnTable.HazardPool
        .Where(entry => IsValidForDepth(entry, position.Z))
        .ToList();

    if (validHazards.Count == 0)
    {
        _logger.LogDebug(
            "No valid hazards for depth {Depth} in biome {BiomeId}",
            position.Z,
            room.BiomeId);
        return null;
    }

    // Weighted random selection
    var selectedEntry = SelectWeightedEntry(validHazards, position, "hazard");
    if (selectedEntry == null)
    {
        return null;
    }

    // Verify the hazard exists
    var hazard = _hazardService.GetHazard(selectedEntry.Id);
    if (hazard == null)
    {
        _logger.LogWarning(
            "Hazard {HazardId} from spawn table not found in definitions",
            selectedEntry.Id);
        return null;
    }

    // Add hazard to room
    room.AddHazard(hazard.Id);

    _logger.LogInformation(
        "Placed hazard {HazardId} in room at {Position}",
        hazard.Id,
        position);

    return hazard.Id;
}

/// <summary>
/// Checks all hazards in a room for a specific trigger type.
/// </summary>
/// <param name="room">The room to check.</param>
/// <param name="player">The player to affect.</param>
/// <param name="triggerType">The type of trigger event.</param>
/// <returns>List of hazard results from any triggered hazards.</returns>
public IReadOnlyList<HazardResult> CheckRoomHazards(
    Room room,
    Player player,
    HazardTriggerType triggerType)
{
    var results = new List<HazardResult>();

    foreach (var hazardId in room.Hazards)
    {
        var hazard = _hazardService.GetHazard(hazardId);
        if (hazard == null)
        {
            continue;
        }

        // Check if this hazard responds to the trigger type
        if (!_hazardService.CheckHazardTrigger(hazard, triggerType))
        {
            continue;
        }

        // Attempt to trigger the hazard
        var result = _hazardService.TriggerHazard(hazard, player, room);
        results.Add(result);

        // Remove non-persistent hazards that triggered
        if (result.WasTriggered && !hazard.Persistent)
        {
            room.RemoveHazard(hazardId);
        }
    }

    return results;
}
```

### 8.2 Room Entity Updates

**File:** `src/Core/RuneAndRust.Domain/Entities/Room.cs` (updates)

```csharp
// Add to existing Room entity

private readonly List<string> _hazards = new();

/// <summary>
/// Gets the hazard IDs present in this room.
/// </summary>
public IReadOnlyList<string> Hazards => _hazards.AsReadOnly();

/// <summary>
/// Adds a hazard to the room.
/// </summary>
/// <param name="hazardId">The hazard identifier to add.</param>
public void AddHazard(string hazardId)
{
    if (!_hazards.Contains(hazardId))
    {
        _hazards.Add(hazardId);
    }
}

/// <summary>
/// Removes a hazard from the room.
/// </summary>
/// <param name="hazardId">The hazard identifier to remove.</param>
/// <returns>True if the hazard was removed.</returns>
public bool RemoveHazard(string hazardId)
{
    return _hazards.Remove(hazardId);
}

/// <summary>
/// Checks if the room contains a specific hazard.
/// </summary>
/// <param name="hazardId">The hazard identifier to check.</param>
/// <returns>True if the room contains the hazard.</returns>
public bool HasHazard(string hazardId)
{
    return _hazards.Contains(hazardId);
}
```

---

## 9. Combat Integration

### 9.1 Damage Modifier Application

The `CombatService` should apply biome damage modifiers when calculating damage in biome-specific contexts.

**File:** `src/Core/RuneAndRust.Application/Services/CombatService.cs` (updates)

```csharp
// Add to existing CombatService

private readonly IHazardService _hazardService;

/// <summary>
/// Applies damage to a target with biome modifiers.
/// </summary>
/// <param name="target">The entity receiving damage.</param>
/// <param name="baseDamage">The base damage amount.</param>
/// <param name="damageType">The type of damage.</param>
/// <param name="source">The source of damage for logging.</param>
/// <param name="biomeId">Optional biome ID for modifier application.</param>
/// <returns>The actual damage dealt after modifiers.</returns>
public int ApplyDamageWithBiomeModifier(
    IHasHealth target,
    int baseDamage,
    string damageType,
    string source,
    string? biomeId)
{
    var finalDamage = baseDamage;

    // Apply biome damage modifier if specified
    if (!string.IsNullOrEmpty(biomeId))
    {
        var modifier = _hazardService.GetBiomeDamageModifier(biomeId);
        finalDamage = modifier.ApplyModifier(baseDamage, damageType);

        if (finalDamage != baseDamage)
        {
            _logger.LogDebug(
                "Biome {BiomeId} modified {DamageType} damage: {Base} → {Final}",
                biomeId,
                damageType,
                baseDamage,
                finalDamage);
        }
    }

    // Apply standard damage
    return ApplyDamage(target, finalDamage, damageType, source);
}
```

---

## 10. Data Model Changes

### 10.1 New Entities

| Entity | Layer | Description |
|--------|-------|-------------|
| `BiomeHazard` | Domain/Definitions | Environmental hazard definition |

### 10.2 New Value Objects

| Value Object | Layer | Description |
|--------------|-------|-------------|
| `HazardTrigger` | Domain/ValueObjects | Hazard trigger mechanism |
| `BiomeDamageModifier` | Domain/ValueObjects | Biome damage adjustments |

### 10.3 New Enums

| Enum | Layer | Description |
|------|-------|-------------|
| `HazardTriggerType` | Domain/Definitions | Trigger type categories |

### 10.4 New DTOs

| DTO | Layer | Description |
|-----|-------|-------------|
| `HazardResult` | Application/DTOs | Hazard trigger result |
| `DisarmResult` | Application/DTOs | Disarm attempt result |

### 10.5 Entity Updates

| Entity | Change | Description |
|--------|--------|-------------|
| `Room` | Add `Hazards` property | List of hazard IDs in room |
| `Room` | Add hazard methods | `AddHazard`, `RemoveHazard`, `HasHazard` |

---

## 11. Configuration File Schemas

### 11.1 Hazards Configuration

**File:** `config/hazards.json`

```json
{
  "$schema": "./schemas/hazards-schema.json",
  "hazards": [
    {
      "id": "poison-gas-cloud",
      "name": "Poison Gas Cloud",
      "description": "A cloud of toxic green gas fills the passage.",
      "warningText": "You notice a sickly green haze ahead...",
      "biomeIds": ["sewers"],
      "damage": 5,
      "damageType": "poison",
      "statusEffects": ["poisoned"],
      "trigger": {
        "type": "PerTurn",
        "chance": 0.6,
        "detectionDC": 10,
        "visible": true
      },
      "canAvoid": true,
      "avoidSkill": "athletics",
      "avoidDC": 12,
      "canDisarm": false,
      "disarmSkill": null,
      "disarmDC": 0,
      "persistent": true,
      "triggerInterval": 1,
      "mapSymbol": "~",
      "color": "green"
    },
    {
      "id": "lava-pool",
      "name": "Lava Pool",
      "description": "Molten rock bubbles dangerously at your feet.",
      "warningText": "Intense heat radiates from the glowing floor ahead.",
      "biomeIds": ["volcanic-caverns"],
      "damage": 15,
      "damageType": "fire",
      "statusEffects": ["burning"],
      "trigger": {
        "type": "OnEnter",
        "chance": 1.0,
        "detectionDC": 5,
        "visible": true
      },
      "canAvoid": true,
      "avoidSkill": "acrobatics",
      "avoidDC": 15,
      "canDisarm": false,
      "disarmSkill": null,
      "disarmDC": 0,
      "persistent": true,
      "triggerInterval": 1,
      "mapSymbol": "~",
      "color": "red"
    },
    {
      "id": "ice-patch",
      "name": "Slippery Ice",
      "description": "A treacherous patch of black ice covers the floor.",
      "warningText": "The floor ahead glistens with a thin layer of ice.",
      "biomeIds": ["frozen-depths"],
      "damage": 3,
      "damageType": "physical",
      "statusEffects": ["prone", "slowed"],
      "trigger": {
        "type": "OnEnter",
        "chance": 0.5,
        "detectionDC": 12,
        "visible": false
      },
      "canAvoid": true,
      "avoidSkill": "acrobatics",
      "avoidDC": 13,
      "canDisarm": false,
      "disarmSkill": null,
      "disarmDC": 0,
      "persistent": true,
      "triggerInterval": 1,
      "mapSymbol": ".",
      "color": "cyan"
    },
    {
      "id": "bone-trap",
      "name": "Bone Scythe Trap",
      "description": "Sharpened bones swing from the ceiling in a deadly arc.",
      "warningText": "You notice thin wires strung across the passage.",
      "biomeIds": ["catacombs"],
      "damage": 12,
      "damageType": "physical",
      "statusEffects": ["bleeding"],
      "trigger": {
        "type": "OnEnter",
        "chance": 1.0,
        "detectionDC": 14,
        "visible": false
      },
      "canAvoid": true,
      "avoidSkill": "acrobatics",
      "avoidDC": 14,
      "canDisarm": true,
      "disarmSkill": "sleight-of-hand",
      "disarmDC": 15,
      "persistent": false,
      "triggerInterval": 1,
      "mapSymbol": "^",
      "color": "gray"
    },
    {
      "id": "cave-in-zone",
      "name": "Unstable Ceiling",
      "description": "The ceiling above looks ready to collapse.",
      "warningText": "Dust and pebbles rain down from the crumbling ceiling.",
      "biomeIds": ["mines"],
      "damage": 20,
      "damageType": "physical",
      "statusEffects": ["stunned"],
      "trigger": {
        "type": "Conditional",
        "chance": 0.2,
        "detectionDC": 8,
        "visible": true
      },
      "canAvoid": true,
      "avoidSkill": "perception",
      "avoidDC": 13,
      "canDisarm": false,
      "disarmSkill": null,
      "disarmDC": 0,
      "persistent": false,
      "triggerInterval": 1,
      "mapSymbol": "!",
      "color": "brown"
    }
  ],
  "damageModifiers": [
    {
      "biomeId": "volcanic-caverns",
      "modifiers": {
        "fire": 0.5,
        "ice": 1.5,
        "physical": 1.0
      }
    },
    {
      "biomeId": "frozen-depths",
      "modifiers": {
        "ice": 0.5,
        "fire": 1.5,
        "physical": 1.0
      }
    },
    {
      "biomeId": "catacombs",
      "modifiers": {
        "holy": 1.5,
        "dark": 0.75,
        "physical": 1.0
      }
    },
    {
      "biomeId": "sewers",
      "modifiers": {
        "poison": 0.75,
        "fire": 1.0,
        "physical": 1.0
      }
    },
    {
      "biomeId": "mines",
      "modifiers": {
        "physical": 1.0
      }
    }
  ]
}
```

### 11.2 JSON Schema

**File:** `config/schemas/hazards-schema.json`

```json
{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "hazards-schema.json",
  "title": "Hazards Configuration",
  "description": "Schema for environmental hazards and biome damage modifiers",
  "type": "object",
  "required": ["hazards", "damageModifiers"],
  "properties": {
    "hazards": {
      "type": "array",
      "description": "Environmental hazard definitions",
      "items": {
        "$ref": "#/$defs/hazard"
      }
    },
    "damageModifiers": {
      "type": "array",
      "description": "Biome damage modifier definitions",
      "items": {
        "$ref": "#/$defs/damageModifier"
      }
    }
  },
  "$defs": {
    "hazard": {
      "type": "object",
      "required": [
        "id", "name", "description", "warningText", "biomeIds",
        "damage", "damageType", "trigger", "persistent"
      ],
      "properties": {
        "id": {
          "type": "string",
          "pattern": "^[a-z][a-z0-9-]*$",
          "description": "Unique identifier in kebab-case"
        },
        "name": {
          "type": "string",
          "minLength": 1,
          "description": "Display name"
        },
        "description": {
          "type": "string",
          "minLength": 1,
          "description": "Description shown when hazard triggers"
        },
        "warningText": {
          "type": "string",
          "minLength": 1,
          "description": "Warning shown when hazard is detected"
        },
        "biomeIds": {
          "type": "array",
          "items": { "type": "string" },
          "minItems": 1,
          "description": "Biomes where this hazard appears"
        },
        "damage": {
          "type": "integer",
          "minimum": 0,
          "description": "Base damage dealt"
        },
        "damageType": {
          "type": "string",
          "description": "Type of damage (fire, ice, poison, physical, etc.)"
        },
        "statusEffects": {
          "type": "array",
          "items": { "type": "string" },
          "description": "Status effects applied on trigger"
        },
        "trigger": {
          "$ref": "#/$defs/trigger"
        },
        "canAvoid": {
          "type": "boolean",
          "description": "Whether the hazard can be avoided"
        },
        "avoidSkill": {
          "type": ["string", "null"],
          "description": "Skill used to avoid"
        },
        "avoidDC": {
          "type": "integer",
          "minimum": 0,
          "description": "Difficulty to avoid"
        },
        "canDisarm": {
          "type": "boolean",
          "description": "Whether the hazard can be disarmed"
        },
        "disarmSkill": {
          "type": ["string", "null"],
          "description": "Skill used to disarm"
        },
        "disarmDC": {
          "type": "integer",
          "minimum": 0,
          "description": "Difficulty to disarm"
        },
        "persistent": {
          "type": "boolean",
          "description": "Whether hazard remains after triggering"
        },
        "triggerInterval": {
          "type": "integer",
          "minimum": 1,
          "description": "Turns between triggers for persistent hazards"
        },
        "mapSymbol": {
          "type": "string",
          "maxLength": 1,
          "description": "Character for map display"
        },
        "color": {
          "type": "string",
          "description": "Color for visual display"
        }
      }
    },
    "trigger": {
      "type": "object",
      "required": ["type", "chance"],
      "properties": {
        "type": {
          "type": "string",
          "enum": ["OnEnter", "PerTurn", "OnAction", "Conditional", "Ambient"],
          "description": "When the hazard triggers"
        },
        "chance": {
          "type": "number",
          "minimum": 0.0,
          "maximum": 1.0,
          "description": "Probability of triggering (0.0-1.0)"
        },
        "detectionDC": {
          "type": "integer",
          "minimum": 0,
          "description": "Difficulty to detect hidden hazard"
        },
        "visible": {
          "type": "boolean",
          "description": "Whether hazard is visible without check"
        }
      }
    },
    "damageModifier": {
      "type": "object",
      "required": ["biomeId", "modifiers"],
      "properties": {
        "biomeId": {
          "type": "string",
          "description": "Biome this modifier applies to"
        },
        "modifiers": {
          "type": "object",
          "additionalProperties": {
            "type": "number",
            "minimum": 0.0,
            "description": "Damage multiplier (0.5=resistant, 1.5=vulnerable)"
          },
          "description": "Damage type to multiplier mapping"
        }
      }
    }
  }
}
```

---

## 12. Logging Specifications

### 12.1 Log Levels by Component

| Component | Level | Events |
|-----------|-------|--------|
| `HazardService` | Information | Hazard triggers, disarm results, detection results |
| `HazardService` | Debug | Trigger chance rolls, modifier calculations |
| `HazardService` | Warning | Critical failure on disarm |
| `ContentPlacementService` | Information | Hazard placement in rooms |
| `ContentPlacementService` | Debug | Hazard pool filtering, selection |
| `JsonConfigurationProvider` | Information | Hazard configuration loaded |
| `JsonConfigurationProvider` | Error | Invalid hazard configuration |

### 12.2 Log Message Examples

```
[Information] HazardService: Hazard lava-pool triggered on player 123: 7 fire damage, effects: [burning]
[Information] HazardService: Player 123 avoided hazard poison-gas-cloud with athletics check (rolled 14 vs DC 12)
[Information] HazardService: Player 123 successfully disarmed hazard bone-trap
[Warning] HazardService: Player 123 critically failed disarming hazard bone-trap - triggering!
[Debug] HazardService: Hazard ice-patch did not trigger (rolled 0.72 > chance 0.50)
[Debug] HazardService: Biome volcanic-caverns modified fire damage: 15 → 7
[Information] ContentPlacementService: Placed hazard lava-pool in room at (5, 3, 2)
```

---

## 13. Unit Testing Requirements

### 13.1 Test Count by Feature

| Feature | Test Count |
|---------|------------|
| BiomeHazard entity | ~4 |
| HazardTrigger value object | ~4 |
| BiomeDamageModifier value object | ~5 |
| HazardService core methods | ~8 |
| ContentPlacementService hazard methods | ~4 |
| Room hazard methods | ~3 |
| **Total** | **~28** |

### 13.2 Test Categories

#### BiomeHazard Tests
- `Create_WithValidData_ReturnsHazard`
- `Create_WithDefaults_HasExpectedDefaults`
- `BiomeIds_ContainsBiome_ReturnsTrue`
- `StatusEffects_WhenEmpty_ReturnsEmptyList`

#### HazardTrigger Tests
- `OnEnter_CreatesCorrectType`
- `PerTurn_CreatesCorrectType`
- `Chance_BetweenZeroAndOne_IsValid`
- `Factory_Methods_SetCorrectDefaults`

#### BiomeDamageModifier Tests
- `ApplyModifier_WithFireInVolcanic_AppliesResistance`
- `ApplyModifier_WithIceInVolcanic_AppliesVulnerability`
- `ApplyModifier_UnknownType_ReturnsBaseDamage`
- `GetModifier_KnownType_ReturnsCorrectValue`
- `StaticFactories_CreateCorrectModifiers`

#### HazardService Tests
- `GetHazardsForBiome_ReturnsMatchingHazards`
- `GetHazard_ExistingId_ReturnsHazard`
- `GetHazard_UnknownId_ReturnsNull`
- `TriggerHazard_WhenAvoided_ReturnsAvoidedResult`
- `TriggerHazard_WhenTriggered_AppliesDamageAndEffects`
- `TryDisarm_CannotDisarm_ReturnsCannotDisarmResult`
- `TryDisarm_Success_ReturnsSuccessResult`
- `TryDisarm_CriticalFailure_ReturnsTriggerResult`

#### ContentPlacementService Tests
- `FillHazardSlot_ValidBiome_PlacesHazard`
- `FillHazardSlot_EmptyPool_ReturnsNull`
- `CheckRoomHazards_MatchingTrigger_TriggersHazard`
- `CheckRoomHazards_NonPersistent_RemovesAfterTrigger`

#### Room Hazard Tests
- `AddHazard_NewHazard_AddsToList`
- `RemoveHazard_ExistingHazard_RemovesFromList`
- `HasHazard_ExistingHazard_ReturnsTrue`

---

## 14. Use Cases

### UC-001: Player Enters Room with Hazard
**Actor:** Player
**Flow:** Enter room → Check OnEnter hazards → Detection check (if hidden) → Avoidance check (if applicable) → Apply effects (if triggered) → Display result

### UC-002: Player Triggers Per-Turn Hazard
**Actor:** System
**Flow:** Turn ends → Check PerTurn hazards in room → Trigger chance roll → Avoidance check → Apply damage/effects → Display result

### UC-003: Player Disarms Hazard
**Actor:** Player
**Flow:** Use disarm command → Validate hazard is disarmable → Skill check → Success removes hazard / Failure may trigger

### UC-004: Player Detects Hidden Hazard
**Actor:** Player
**Flow:** Enter room with hidden hazard → Perception check vs DetectionDC → Success shows warning / Failure gives no warning

### UC-005: Biome Damage Modifier Applied
**Actor:** System
**Flow:** Hazard triggers → Get biome damage modifier → Calculate modified damage → Apply to target

### UC-006: Hazard Applies Status Effect
**Actor:** System
**Flow:** Hazard triggers → Iterate status effects → Apply each effect → Log applied effects

---

## 15. Deliverable Checklist

### Domain Layer
- [ ] `BiomeHazard` entity created with all properties
- [ ] `HazardTrigger` value object created
- [ ] `HazardTriggerType` enum created
- [ ] `BiomeDamageModifier` value object created
- [ ] `Room` entity updated with hazard collection

### Application Layer
- [ ] `IHazardService` interface created
- [ ] `HazardService` implementation complete
- [ ] `HazardResult` DTO created
- [ ] `DisarmResult` DTO created
- [ ] `ContentPlacementService` hazard methods added

### Infrastructure Layer
- [ ] `IConfigurationProvider` updated for hazards
- [ ] `JsonConfigurationProvider` loads hazards
- [ ] Hazard configuration DTO created

### Configuration Files
- [ ] `config/hazards.json` created with 5+ hazards
- [ ] `config/schemas/hazards-schema.json` created
- [ ] Configuration validates against schema

### Testing
- [ ] ~28 unit tests implemented
- [ ] All tests passing
- [ ] Edge cases covered

---

## 16. Acceptance Criteria

### Functional
- [ ] BiomeHazard entity created with all 18 properties
- [ ] HazardTrigger supports all 5 trigger types (OnEnter, PerTurn, OnAction, Conditional, Ambient)
- [ ] BiomeDamageModifier correctly adjusts damage by type
- [ ] Hazards load from JSON configuration
- [ ] HazardService triggers hazards with proper mechanics
- [ ] Hazard avoidance uses skill checks correctly
- [ ] Hazard disarming uses skill checks with critical failure handling
- [ ] Persistent hazards remain after triggering
- [ ] Non-persistent hazards are removed after triggering
- [ ] Damage modifiers apply per biome
- [ ] Status effects are applied on hazard trigger
- [ ] Hidden hazards require perception checks to detect

### Quality
- [ ] Build succeeds with 0 errors/warnings
- [ ] All ~28 unit tests pass
- [ ] Configuration files validate against schemas
- [ ] XML documentation complete on all public members
- [ ] Logging covers all major operations

---

## 17. Dependencies

### 17.1 Prerequisites (from v0.1.2b)
- `BiomeSpawnTable` with `HazardPool` placeholder
- `ContentPlacementService` for slot filling
- `BiomeService` for biome lookups
- Skill check system for avoidance/disarm
- Status effect system for effect application

### 17.2 Provides (for v0.1.2d)
- `BiomeHazard` entity and configuration
- `HazardService` for hazard management
- Biome damage modifier system
- Room hazard tracking

---

## 18. Future Considerations

### Deferred to v0.1.2d
- **Biome Transition Hazards**: Hazards that appear specifically at biome boundaries
- **Discovery Integration**: Hazard types appearing in biome codex

### Deferred to v0.1.3+
- **Conditional Trigger Expansion**: More complex trigger conditions
- **Hazard Chains**: Multiple hazards triggering in sequence
- **Environmental Hazard Interactions**: Hazards affecting each other

### Out of Scope
- **Player-Created Hazards**: Traps placed by players
- **Monster Hazard Immunity**: Monsters ignoring certain hazards
- **Hazard Visual Effects**: Advanced TUI animations for hazards

---

*Document Version: 1.0*
*Last Updated: 2026-01-09*
*Author: Claude*
