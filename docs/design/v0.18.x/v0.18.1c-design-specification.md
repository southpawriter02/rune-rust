# v0.18.1c Design Specification: ICorruptionService Interface

**Version:** 0.18.1c
**Parent:** v0.18.1 (Runic Blight Corruption)
**Prerequisites:** v0.18.1a (Corruption Enums & State), v0.18.1b (CorruptionTracker Entity & Result Objects)
**Status:** Design Complete
**Estimated Unit Tests:** ~0 (Interface only)

---

## Table of Contents

1. [Executive Summary](#1-executive-summary)
2. [Feature Overview](#2-feature-overview)
3. [Architecture Diagrams](#3-architecture-diagrams)
4. [User Stories](#4-user-stories)
5. [ICorruptionService Interface](#5-icorruptionservice-interface)
6. [Method Specifications](#6-method-specifications)
7. [Data Flow Diagrams](#7-data-flow-diagrams)
8. [Logging Specifications](#8-logging-specifications)
9. [Unit Testing Requirements](#9-unit-testing-requirements)
10. [Use Cases](#10-use-cases)
11. [Deliverable Checklist](#11-deliverable-checklist)
12. [Acceptance Criteria](#12-acceptance-criteria)
13. [Dependencies](#13-dependencies)
14. [Future Considerations](#14-future-considerations)

---

## 1. Executive Summary

This design specification defines the `ICorruptionService` interface — the service contract for all corruption management operations in the Runic Blight Corruption system.

v0.18.1c establishes the **Application Layer Contract** that will be implemented in v0.18.1d. By defining the interface first, we enable:

- Mock-based testing of dependent systems
- Clear separation between contract and implementation
- Parallel development of consumers and implementation

### Key Deliverables

| Category                   | Items                          |
| -------------------------- | ------------------------------ |
| **Application Interfaces** | `ICorruptionService`           |
| **Tests**                  | ~0 (interface definition only) |

### Interface Method Summary

| Category     | Methods | Description                                 |
| ------------ | ------- | ------------------------------------------- |
| **Queries**  | 5       | Read corruption state and derived penalties |
| **Commands** | 3       | Add, transfer, and remove corruption        |
| **Terminal** | 1       | Perform Terminal Error survival check       |

---

## 2. Feature Overview

```
v0.18.1c Features
└── ICorruptionService Interface (9 methods)
    │
    ├── QUERY METHODS
    │   ├── GetCorruptionState(characterId) → CorruptionState
    │   ├── GetMaxHpPenaltyPercent(characterId) → int
    │   ├── GetMaxApPenaltyPercent(characterId) → int
    │   ├── GetResolveDicePenalty(characterId) → int
    │   └── GetSkillModifiers(characterId) → CorruptionSkillModifiers
    │
    ├── COMMAND METHODS
    │   ├── AddCorruption(characterId, amount, source) → CorruptionAddResult
    │   ├── TransferCorruption(fromId, toId, amount) → CorruptionTransferResult
    │   └── RemoveCorruption(characterId, amount, reason) → bool
    │
    └── TERMINAL METHOD
        └── PerformTerminalErrorCheck(characterId) → TerminalErrorResult
```

### Comparison: Stress vs Corruption Service Interfaces

| Aspect          | IStressService (v0.18.0c)      | ICorruptionService (v0.18.1c)   |
| --------------- | ------------------------------ | ------------------------------- |
| State Query     | `GetStressState`               | `GetCorruptionState`            |
| Penalty Queries | `GetDefensePenalty`, `Has...`  | `GetMaxHp/Ap/Resolve...`        |
| Apply Negative  | `ApplyStress`                  | `AddCorruption`                 |
| Remove Negative | `RecoverStress`                | `RemoveCorruption`              |
| Transfer        | N/A                            | `TransferCorruption` (unique)   |
| Terminal Check  | N/A (Trauma via TraumaService) | `PerformTerminalErrorCheck`     |
| Skill Modifiers | `HasSkillDisadvantage`         | `GetSkillModifiers` (composite) |

---

## 3. Architecture Diagrams

### 3.1 Layer Diagram

```
┌─────────────────────────────────────────────────────────────────────────┐
│                       APPLICATION LAYER                                 │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │                    ICorruptionService                            │   │
│  ├─────────────────────────────────────────────────────────────────┤   │
│  │                                                                  │   │
│  │  QUERIES                                                         │   │
│  │  ─────────────────────────────────────────────────────────────   │   │
│  │  + GetCorruptionState(characterId: Guid): CorruptionState       │   │
│  │  + GetMaxHpPenaltyPercent(characterId: Guid): int               │   │
│  │  + GetMaxApPenaltyPercent(characterId: Guid): int               │   │
│  │  + GetResolveDicePenalty(characterId: Guid): int                │   │
│  │  + GetSkillModifiers(characterId: Guid): CorruptionSkillModifiers│  │
│  │                                                                  │   │
│  │  COMMANDS                                                        │   │
│  │  ─────────────────────────────────────────────────────────────   │   │
│  │  + AddCorruption(characterId, amount, source):                  │   │
│  │        CorruptionAddResult                                       │   │
│  │  + TransferCorruption(fromId, toId, amount):                    │   │
│  │        CorruptionTransferResult                                  │   │
│  │  + RemoveCorruption(characterId, amount, reason): bool          │   │
│  │                                                                  │   │
│  │  TERMINAL                                                        │   │
│  │  ─────────────────────────────────────────────────────────────   │   │
│  │  + PerformTerminalErrorCheck(characterId): TerminalErrorResult  │   │
│  │                                                                  │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                               │                                         │
│                               │ Uses                                    │
│                               ▼                                         │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │                    DOMAIN ENTITIES & VALUE OBJECTS               │   │
│  │  ┌────────────────────┐ ┌───────────────────┐ ┌───────────────┐ │   │
│  │  │ CorruptionTracker  │ │CorruptionAddResult│ │CorruptionState│ │   │
│  │  │     (Entity)       │ │  (Value Object)   │ │ (Value Object)│ │   │
│  │  └────────────────────┘ └───────────────────┘ └───────────────┘ │   │
│  │  ┌────────────────────┐ ┌───────────────────┐ ┌───────────────┐ │   │
│  │  │CorruptionStage     │ │TerminalErrorResult│ │CorruptionSource││   │
│  │  │     (Enum)         │ │  (Value Object)   │ │    (Enum)     │ │   │
│  │  └────────────────────┘ └───────────────────┘ └───────────────┘ │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

### 3.2 Service Integration Diagram

```
    ┌─────────────────────────────────────────────────────────────────┐
    │                       CONSUMERS                                  │
    ├───────────────┬───────────────┬───────────────┬────────────────┤
    │ CombatService │AbilityService │  BlótPriest   │   TUI/GUI      │
    │               │               │  Mechanics    │                │
    └───────┬───────┴───────┬───────┴───────┬───────┴───────┬────────┘
            │               │               │               │
            │   Query       │   Add         │   Transfer    │  Display
            │   HP/AP       │   Corruption  │   Corruption  │  Corruption
            │   Penalty     │   (Heretical) │   (BlótPriest)│  Bar
            │               │               │               │
            └───────────────┴───────┬───────┴───────────────┘
                                    │
                                    ▼
                    ┌───────────────────────────────┐
                    │      ICorruptionService       │
                    └───────────────┬───────────────┘
                                    │
                                    ▼
                    ┌───────────────────────────────┐
                    │  CorruptionService (v0.18.1d) │
                    │  Implements ICorruptionService│
                    └───────────────┬───────────────┘
                                    │
                          ┌─────────┴─────────┐
                          │                   │
                          ▼                   ▼
            ┌────────────────────┐   ┌───────────────────┐
            │ICorruptionRepository│   │   IDiceService    │
            │(Tracker Persistence)│   │(Terminal Error DC)│
            └────────────────────┘   └───────────────────┘
```

### 3.3 Method Flow Decision Tree

```
                    ┌────────────────────────────┐
                    │  ICorruptionService Call   │
                    └─────────────┬──────────────┘
                                  │
          ┌───────────────────────┼───────────────────────┐
          │                       │                       │
          ▼                       ▼                       ▼
    ┌──────────────┐       ┌──────────────┐       ┌──────────────┐
    │    QUERY     │       │   COMMAND    │       │   TERMINAL   │
    │              │       │              │       │              │
    │GetCorruption │       │AddCorruption │       │PerformTerminal│
    │  State       │       │TransferCor...│       │  ErrorCheck  │
    │GetMaxHp/Ap..│       │RemoveCorrupt │       │              │
    │GetResolve...│       │              │       │              │
    │GetSkillMods │       │              │       │              │
    └──────┬───────┘       └──────┬───────┘       └──────┬───────┘
           │                      │                      │
           ▼                      ▼                      ▼
    ┌──────────────┐       ┌──────────────┐       ┌──────────────┐
    │  Read-Only   │       │ State Change │       │ WILL Roll +  │
    │  No Side     │       │ + Returns    │       │ State Change │
    │  Effects     │       │ Result Object│       │ + Result     │
    └──────────────┘       └──────────────┘       └──────────────┘
```

### 3.4 Corruption vs Stress: Parallel Interface Structure

```
┌─────────────────────────────────────────────────────────────────────────┐
│            PARALLEL SERVICE INTERFACE ARCHITECTURE                       │
├────────────────────────────────┬────────────────────────────────────────┤
│         IStressService         │          ICorruptionService            │
│          (v0.18.0c)            │            (v0.18.1c)                   │
├────────────────────────────────┼────────────────────────────────────────┤
│ QUERY                          │ QUERY                                  │
│ ├── GetStressState()           │ ├── GetCorruptionState()               │
│ ├── GetDefensePenalty()        │ ├── GetMaxHpPenaltyPercent()           │
│ ├── HasSkillDisadvantage()     │ ├── GetMaxApPenaltyPercent()           │
│ └── RequiresTraumaCheck()      │ ├── GetResolveDicePenalty()            │
│                                │ └── GetSkillModifiers()                │
├────────────────────────────────┼────────────────────────────────────────┤
│ COMMAND                        │ COMMAND                                │
│ ├── ApplyStress()              │ ├── AddCorruption()                    │
│ ├── RecoverStress() (overloads)│ ├── TransferCorruption()  ← UNIQUE     │
│ └── ResetAfterTraumaCheck()    │ └── RemoveCorruption()    ← RARE       │
├────────────────────────────────┼────────────────────────────────────────┤
│ INTERNAL                       │ TERMINAL                               │
│ └── PerformResistanceCheck()   │ └── PerformTerminalErrorCheck()        │
├────────────────────────────────┼────────────────────────────────────────┤
│ Recovery: WILL-based, common   │ Recovery: Near-impossible (lore-based) │
│ Terminal: Trauma Check (ext)   │ Terminal: Built-in survival check      │
│ Transfer: N/A                  │ Transfer: Blót-Priest mechanic         │
└────────────────────────────────┴────────────────────────────────────────┘
```

---

## 4. User Stories

### US-18.1c-1: Query Corruption Penalties

**As a** combat service developer
**I want to** query a character's HP/AP/Resolve penalties from corruption
**So that** I can apply penalties to combat calculations

**Acceptance Criteria:**

- Methods return integer penalty values
- Works without modifying character state
- Penalties calculated per documented formula

### US-18.1c-2: Add Heretical Corruption

**As a** ability system
**I want to** add corruption when heretical abilities are used
**So that** there is a meaningful cost for powerful abilities

**Acceptance Criteria:**

- Accepts corruption amount and source category
- Returns full result with threshold crossing info
- Triggers Terminal Error flag when corruption reaches 100

### US-18.1c-3: Transfer Corruption (Blót-Priest)

**As a** Blót-Priest specialization system
**I want to** transfer corruption between characters
**So that** Blót-Priests can cleanse allies at personal cost

**Acceptance Criteria:**

- Moves corruption from source to target
- Both characters' states updated atomically
- Detects if transfer causes Terminal Error

### US-18.1c-4: Query Skill Modifiers

**As a** skill check system
**I want to** query tech bonus and social penalty from corruption
**So that** I can apply stage-based modifiers to appropriate checks

**Acceptance Criteria:**

- Returns composite `CorruptionSkillModifiers` object
- Includes TechBonus, SocialPenalty, and FactionLocked

### US-18.1c-5: Perform Terminal Error Check

**As a** game master system
**I want to** perform Terminal Error survival checks
**So that** characters have a chance to survive reaching 100 corruption

**Acceptance Criteria:**

- Rolls WILL dice pool vs DC 3
- Returns survival/failure outcome
- Sets corruption to 99 on survival

---

## 5. ICorruptionService Interface

### 5.1 Purpose

Defines the service contract for corruption management, enabling dependency injection and mock-based testing.

### 5.2 Definition

**File:** `src/Core/RuneAndRust.Application/Interfaces/ICorruptionService.cs`

```csharp
namespace RuneAndRust.Application.Interfaces;

using RuneAndRust.Domain.Enums;
using RuneAndRust.Domain.ValueObjects;

/// <summary>
/// Service interface for managing character Runic Blight Corruption.
/// </summary>
/// <remarks>
/// <para>
/// The corruption service handles all aspects of the Runic Blight system:
/// <list type="bullet">
/// <item>Querying current corruption state and derived penalties</item>
/// <item>Adding corruption from heretical sources</item>
/// <item>Transferring corruption between characters (Blót-Priest)</item>
/// <item>Performing Terminal Error survival checks</item>
/// <item>Rare corruption removal (purification rituals)</item>
/// </list>
/// </para>
/// <para>
/// Corruption is a near-permanent negative resource (0-100) that accumulates
/// and imposes escalating penalties. Reaching 100 corruption triggers a
/// Terminal Error check — failure means the character becomes Forlorn.
/// </para>
/// <para>
/// Unlike Psychic Stress, corruption does NOT recover naturally with rest.
/// Only specific narrative events (purification, divine intervention) can
/// reduce corruption, and even then at great cost.
/// </para>
/// </remarks>
/// <example>
/// <code>
/// // Query corruption penalties
/// var hpPenalty = _corruptionService.GetMaxHpPenaltyPercent(characterId);
/// var resolePenalty = _corruptionService.GetResolveDicePenalty(characterId);
///
/// // Add corruption from heretical ability
/// var result = _corruptionService.AddCorruption(
///     characterId,
///     amount: 15,
///     source: CorruptionSource.HereticalAbility);
///
/// if (result.IsTerminalError)
///     InitiateTerminalErrorCheck(characterId);
///
/// // Blót-Priest cleanses ally (at personal cost)
/// var transfer = _corruptionService.TransferCorruption(
///     fromId: targetAllyId,
///     toId: blotPriestId,
///     amount: 10);
/// </code>
/// </example>
public interface ICorruptionService
{
    #region Query Methods

    /// <summary>
    /// Gets the current corruption state for a character.
    /// </summary>
    /// <param name="characterId">The character's unique identifier.</param>
    /// <returns>
    /// A <see cref="CorruptionState"/> snapshot containing current corruption,
    /// stage, and computed flags.
    /// </returns>
    /// <exception cref="CharacterNotFoundException">
    /// Thrown when no character exists with the specified ID.
    /// </exception>
    CorruptionState GetCorruptionState(Guid characterId);

    /// <summary>
    /// Gets the maximum HP percentage penalty from current corruption level.
    /// </summary>
    /// <param name="characterId">The character's unique identifier.</param>
    /// <returns>
    /// The HP penalty percentage (0-50) calculated as floor(corruption/10) × 5.
    /// </returns>
    /// <remarks>
    /// At corruption 0-9: 0% penalty.
    /// At corruption 100: 50% penalty (half max HP).
    /// </remarks>
    int GetMaxHpPenaltyPercent(Guid characterId);

    /// <summary>
    /// Gets the maximum AP percentage penalty from current corruption level.
    /// </summary>
    /// <param name="characterId">The character's unique identifier.</param>
    /// <returns>
    /// The AP penalty percentage (0-50) calculated as floor(corruption/10) × 5.
    /// </returns>
    /// <remarks>
    /// Same formula as HP penalty. Represents diminished vitality.
    /// </remarks>
    int GetMaxApPenaltyPercent(Guid characterId);

    /// <summary>
    /// Gets the Resolve dice pool penalty from current corruption level.
    /// </summary>
    /// <param name="characterId">The character's unique identifier.</param>
    /// <returns>
    /// The Resolve penalty (0-5) calculated as floor(corruption/20).
    /// </returns>
    /// <remarks>
    /// Affects all WILL-based checks including stress resistance
    /// and trauma checks. Creates a dangerous feedback loop.
    /// </remarks>
    int GetResolveDicePenalty(Guid characterId);

    /// <summary>
    /// Gets the skill check modifiers from current corruption stage.
    /// </summary>
    /// <param name="characterId">The character's unique identifier.</param>
    /// <returns>
    /// A <see cref="CorruptionSkillModifiers"/> containing TechBonus,
    /// SocialPenalty, and FactionLocked status.
    /// </returns>
    /// <remarks>
    /// <para>Stage-based modifiers:</para>
    /// <list type="bullet">
    /// <item>Uncorrupted: +0 Tech, -0 Social</item>
    /// <item>Tainted: +1 Tech, -1 Social</item>
    /// <item>Infected+: +2 Tech, -2 Social, Faction Locked</item>
    /// </list>
    /// </remarks>
    CorruptionSkillModifiers GetSkillModifiers(Guid characterId);

    #endregion

    #region Command Methods

    /// <summary>
    /// Adds corruption to a character from a specified source.
    /// </summary>
    /// <param name="characterId">The character's unique identifier.</param>
    /// <param name="amount">
    /// The corruption amount to add. Must be positive.
    /// </param>
    /// <param name="source">
    /// The category of corruption source (HereticalAbility, BlightExposure, etc.).
    /// </param>
    /// <returns>
    /// A <see cref="CorruptionAddResult"/> containing before/after state,
    /// threshold crossings, and Terminal Error flag.
    /// </returns>
    /// <exception cref="ArgumentOutOfRangeException">
    /// Thrown if amount is negative.
    /// </exception>
    /// <remarks>
    /// <para>
    /// Corruption sources have narrative significance:
    /// <list type="bullet">
    /// <item>HereticalAbility: Voluntary use of forbidden power</item>
    /// <item>BlightExposure: Environmental hazard</item>
    /// <item>Artifact: Corrupted item handling</item>
    /// <item>CurseAffliction: Enemy curse attacks</item>
    /// <item>MysticMagic: Failed containment of wild magic</item>
    /// </list>
    /// </para>
    /// <para>
    /// After adding corruption, check <see cref="CorruptionAddResult.IsTerminalError"/>
    /// to determine if a Terminal Error check should be initiated.
    /// </para>
    /// </remarks>
    CorruptionAddResult AddCorruption(Guid characterId, int amount, CorruptionSource source);

    /// <summary>
    /// Transfers corruption from one character to another.
    /// </summary>
    /// <param name="fromCharacterId">
    /// The source character (being cleansed).
    /// </param>
    /// <param name="toCharacterId">
    /// The target character (absorbing corruption).
    /// </param>
    /// <param name="amount">
    /// The amount of corruption to transfer.
    /// </param>
    /// <returns>
    /// A <see cref="CorruptionTransferResult"/> containing both characters'
    /// new corruption values and Terminal Error status.
    /// </returns>
    /// <exception cref="ArgumentOutOfRangeException">
    /// Thrown if amount is negative or exceeds source's corruption.
    /// </exception>
    /// <remarks>
    /// <para>
    /// This is the signature ability of the Blót-Priest specialization.
    /// The Blót-Priest willingly absorbs Blight from others, sacrificing
    /// their own purity for the good of their allies.
    /// </para>
    /// <para>
    /// Transfer rules:
    /// <list type="bullet">
    /// <item>Cannot transfer more corruption than source has</item>
    /// <item>Source's corruption reduced by amount</item>
    /// <item>Target's corruption increased by amount</item>
    /// <item>If target reaches 100, Terminal Error is triggered</item>
    /// </list>
    /// </para>
    /// </remarks>
    CorruptionTransferResult TransferCorruption(
        Guid fromCharacterId,
        Guid toCharacterId,
        int amount);

    /// <summary>
    /// Removes corruption from a character (extremely rare).
    /// </summary>
    /// <param name="characterId">The character's unique identifier.</param>
    /// <param name="amount">The amount of corruption to remove.</param>
    /// <param name="reason">
    /// The narrative reason for corruption removal.
    /// Must be a significant story event or ritual.
    /// </param>
    /// <returns>
    /// True if corruption was successfully removed, false if the request
    /// was invalid (e.g., amount exceeds current corruption).
    /// </returns>
    /// <remarks>
    /// <para>
    /// Corruption removal is EXTREMELY rare in the setting. Valid reasons:
    /// <list type="bullet">
    /// <item>Divine purification ritual (major quest reward)</item>
    /// <item>Consuming a Pure Essence (consumable artifact)</item>
    /// <item>Story-specific narrative event</item>
    /// </list>
    /// </para>
    /// <para>
    /// Unlike stress recovery, there is NO natural corruption reduction.
    /// This method should be called sparingly by the narrative system.
    /// </para>
    /// </remarks>
    bool RemoveCorruption(Guid characterId, int amount, string reason);

    #endregion

    #region Terminal Error Methods

    /// <summary>
    /// Performs a Terminal Error survival check when corruption reaches 100.
    /// </summary>
    /// <param name="characterId">The character's unique identifier.</param>
    /// <returns>
    /// A <see cref="TerminalErrorResult"/> containing survival outcome,
    /// final corruption, and roll details.
    /// </returns>
    /// <exception cref="InvalidOperationException">
    /// Thrown if corruption is not at 100 (Terminal Error not applicable).
    /// </exception>
    /// <remarks>
    /// <para>
    /// Terminal Error Check:
    /// <list type="bullet">
    /// <item>Roll: WILL dice pool (affected by Resolve penalty)</item>
    /// <item>DC: 3 (default, may be modified by context)</item>
    /// <item>Success: Corruption set to 99, character survives</item>
    /// <item>Failure: Character becomes Forlorn (unplayable NPC)</item>
    /// </list>
    /// </para>
    /// <para>
    /// A Forlorn character is lost to the Blight. They become an NPC
    /// controlled by the GM and may appear as an antagonist in future
    /// encounters. This is the ultimate consequence of corruption.
    /// </para>
    /// </remarks>
    TerminalErrorResult PerformTerminalErrorCheck(Guid characterId);

    #endregion
}
```

---

## 6. Method Specifications

### 6.1 Query Methods

| Method                   | Parameters         | Returns                    | Side Effects |
| ------------------------ | ------------------ | -------------------------- | ------------ |
| `GetCorruptionState`     | `Guid characterId` | `CorruptionState`          | None         |
| `GetMaxHpPenaltyPercent` | `Guid characterId` | `int`                      | None         |
| `GetMaxApPenaltyPercent` | `Guid characterId` | `int`                      | None         |
| `GetResolveDicePenalty`  | `Guid characterId` | `int`                      | None         |
| `GetSkillModifiers`      | `Guid characterId` | `CorruptionSkillModifiers` | None         |

### 6.2 Command Methods

| Method               | Parameters                    | Returns                    | Side Effects          |
| -------------------- | ----------------------------- | -------------------------- | --------------------- |
| `AddCorruption`      | `characterId, amount, source` | `CorruptionAddResult`      | Updates tracker       |
| `TransferCorruption` | `fromId, toId, amount`        | `CorruptionTransferResult` | Updates both trackers |
| `RemoveCorruption`   | `characterId, amount, reason` | `bool`                     | Updates tracker       |

### 6.3 Terminal Method

| Method                      | Parameters         | Returns               | Side Effects             |
| --------------------------- | ------------------ | --------------------- | ------------------------ |
| `PerformTerminalErrorCheck` | `Guid characterId` | `TerminalErrorResult` | May set to 99 or Forlorn |

### 6.4 Penalty Calculation Reference

| Corruption | MaxHpPenalty | MaxApPenalty | ResolvePenalty |
| ---------- | ------------ | ------------ | -------------- |
| 0-9        | 0%           | 0%           | 0              |
| 10-19      | 5%           | 5%           | 0              |
| 20-39      | 10-15%       | 10-15%       | 1              |
| 40-59      | 20-25%       | 20-25%       | 2              |
| 60-79      | 30-35%       | 30-35%       | 3              |
| 80-99      | 40-45%       | 40-45%       | 4              |
| 100        | 50%          | 50%          | 5              |

---

## 7. Data Flow Diagrams

### 7.1 AddCorruption Flow

```
                     AddCorruption(characterId, amount, source)
                                      │
                                      ▼
                     ┌────────────────────────────────────┐
                     │     Validate Input Parameters      │
                     │   - characterId valid              │
                     │   - amount >= 0                    │
                     └────────────────┬───────────────────┘
                                      │
                                      ▼
                     ┌────────────────────────────────────┐
                     │   Load CorruptionTracker Entity    │
                     │   from ICorruptionRepository       │
                     └────────────────┬───────────────────┘
                                      │
                                      ▼
                     ┌────────────────────────────────────┐
                     │   Call tracker.AddCorruption()     │
                     │   (Domain method from v0.18.1b)    │
                     └────────────────┬───────────────────┘
                                      │
                                      ▼
                     ┌────────────────────────────────────┐
                     │   Log Corruption Change            │
                     │   Log Threshold Crossing (if any)  │
                     │   Log Terminal Error (if 100)      │
                     └────────────────┬───────────────────┘
                                      │
                                      ▼
                     ┌────────────────────────────────────┐
                     │   Persist Updated Tracker          │
                     └────────────────┬───────────────────┘
                                      │
                                      ▼
                     ┌────────────────────────────────────┐
                     │   Return CorruptionAddResult       │
                     └────────────────────────────────────┘
```

### 7.2 TransferCorruption Flow

```
           TransferCorruption(fromCharacterId, toCharacterId, amount)
                                      │
                                      ▼
                     ┌────────────────────────────────────┐
                     │     Validate Parameters            │
                     │   - Both characterIds valid        │
                     │   - from != to                     │
                     │   - amount > 0                     │
                     └────────────────┬───────────────────┘
                                      │
                                      ▼
                     ┌────────────────────────────────────┐
                     │   Load Source Tracker              │
                     │   Check: from.Corruption >= amount │
                     └────────────────┬───────────────────┘
                                      │
               ┌──────────────────────┴──────────────────────┐
               │                                              │
               ▼                                              ▼
     ┌──────────────────┐                        ┌──────────────────┐
     │ from.Corruption  │                        │ Amount exceeds   │
     │ >= amount: OK    │                        │ source: ERROR    │
     └────────┬─────────┘                        └──────────────────┘
              │                                            │
              ▼                                            ▼
     ┌────────────────────────────────┐        ┌──────────────────┐
     │ Reduce source by amount        │        │ Throw Exception  │
     │ Increase target by amount      │        │ or Return Failure│
     └────────────────┬───────────────┘        └──────────────────┘
                      │
                      ▼
     ┌────────────────────────────────────┐
     │   Check if target reached 100      │
     │   (Terminal Error triggered?)      │
     └────────────────┬───────────────────┘
                      │
                      ▼
     ┌────────────────────────────────────┐
     │   Log Transfer                     │
     │   Persist Both Trackers            │
     └────────────────┬───────────────────┘
                      │
                      ▼
     ┌────────────────────────────────────┐
     │   Return CorruptionTransferResult  │
     └────────────────────────────────────┘
```

### 7.3 PerformTerminalErrorCheck Flow

```
                 PerformTerminalErrorCheck(characterId)
                                │
                                ▼
                ┌──────────────────────────────────┐
                │   Load Tracker, Validate at 100  │
                └───────────────┬──────────────────┘
                                │
                ┌───────────────┴───────────────┐
                │                               │
                ▼                               ▼
       ┌──────────────────┐           ┌──────────────────┐
       │ Corruption = 100 │           │ Corruption < 100 │
       │ OK: Proceed      │           │ Invalid State    │
       └────────┬─────────┘           └────────┬─────────┘
                │                              │
                ▼                              ▼
       ┌──────────────────────────┐   ┌──────────────────┐
       │ Calculate WILL Pool      │   │ Throw Exception  │
       │ (Base WILL - Resolve     │   │ InvalidOperation │
       │  Penalty = 5)            │   │                  │
       └──────────┬───────────────┘   └──────────────────┘
                  │
                  ▼
       ┌──────────────────────────┐
       │ Roll via IDiceService    │
       │ vs DC 3                  │
       └──────────┬───────────────┘
                  │
       ┌──────────┴──────────┐
       │                     │
       ▼                     ▼
┌──────────────┐       ┌──────────────┐
│ Successes ≥ 3│       │ Successes < 3│
│   SURVIVED   │       │    FAILED    │
└──────┬───────┘       └──────┬───────┘
       │                      │
       ▼                      ▼
┌──────────────────┐   ┌──────────────────┐
│Set corruption=99 │   │Mark as Forlorn   │
│Log Survival      │   │Log Character Lost│
└──────────────────┘   └──────────────────┘
       │                      │
       └──────────┬───────────┘
                  │
                  ▼
       ┌──────────────────────────┐
       │ Return TerminalErrorResult│
       └──────────────────────────┘
```

---

## 8. Logging Specifications

### 8.1 Expected Log Events (Implementation in v0.18.1d)

| Event                    | Level       | Template                                                               |
| ------------------------ | ----------- | ---------------------------------------------------------------------- |
| Corruption Added         | Information | `"Corruption added: {CharacterId} +{Amount} [{Source}] → {NewValue}"`  |
| Threshold Crossed        | Warning     | `"Corruption threshold {Threshold}% crossed for {CharacterId}"`        |
| Stage Changed            | Information | `"Corruption stage changed: {CharacterId} {OldStage} → {NewStage}"`    |
| Faction Locked           | Warning     | `"Faction reputation LOCKED for {CharacterId}: Corruption at {Value}"` |
| Corruption Transferred   | Information | `"Corruption transferred: {FromId} → {ToId} amount={Amount}"`          |
| Corruption Removed       | Warning     | `"Corruption removed: {CharacterId} -{Amount} (Reason: {Reason})"`     |
| Terminal Error Triggered | Error       | `"TERMINAL ERROR: {CharacterId} at corruption 100"`                    |
| Terminal Error Survived  | Warning     | `"Terminal Error SURVIVED: {CharacterId} → corruption 99"`             |
| Terminal Error Failed    | Error       | `"Terminal Error FAILED: {CharacterId} became FORLORN"`                |

> **Note:** `ICorruptionService` is an interface and does not log directly.
> All logging occurs in `CorruptionService` implementation (v0.18.1d).

---

## 9. Unit Testing Requirements

### 9.1 Interface Testing

As `ICorruptionService` is an interface, there are **no direct unit tests**.

Testing strategy for interfaces:

- **Mock-based tests** validate that consumers call interface methods correctly
- **Implementation tests** (v0.18.1d) validate actual behavior

### 9.2 Consumer Mock Example

```csharp
// Example: Testing CombatService integration with ICorruptionService
[Test]
public void ApplyHereticalAbilityCost_CallsAddCorruption()
{
    // Arrange
    var mockCorruptionService = Substitute.For<ICorruptionService>();
    mockCorruptionService.AddCorruption(
        Arg.Any<Guid>(),
        Arg.Any<int>(),
        Arg.Any<CorruptionSource>())
        .Returns(new CorruptionAddResult(...));

    var combatService = new CombatService(mockCorruptionService, ...);

    // Act
    combatService.UseHereticalAbility(characterId, abilityId);

    // Assert
    mockCorruptionService.Received(1).AddCorruption(
        characterId,
        15, // Expected cost from ability
        CorruptionSource.HereticalAbility);
}
```

---

## 10. Use Cases

### UC-001: Combat HP/AP Calculation

**Actor:** CombatService
**Precondition:** Character is in combat
**Flow:**

1. Query `GetMaxHpPenaltyPercent(characterId)`
2. Query `GetMaxApPenaltyPercent(characterId)`
3. Calculate effective HP: `BaseMaxHP × (1 - penalty/100)`
4. Calculate effective AP: `BaseMaxAP × (1 - penalty/100)`

**Postcondition:** Combat service has accurate HP/AP values

### UC-002: Heretical Ability Usage

**Actor:** AbilityService
**Precondition:** Character uses a heretical ability
**Flow:**

1. Get ability corruption cost from definition
2. Call `AddCorruption(characterId, cost, CorruptionSource.HereticalAbility)`
3. Check `result.IsTerminalError`
4. If Terminal Error, pause game and call `PerformTerminalErrorCheck`

**Postcondition:** Corruption tracked, Terminal Error handled if triggered

### UC-003: Blót-Priest Cleansing

**Actor:** SpecializationAbilityService
**Precondition:** Blót-Priest uses cleanse ability on ally
**Flow:**

1. Validate Blót-Priest has ability available
2. Call `TransferCorruption(allyId, priestId, amount)`
3. Check `result.TargetTerminalError`
4. If Terminal Error, prompt priest survival check

**Postcondition:** Ally cleansed, priest absorbed corruption

### UC-004: Skill Check Modifier Application

**Actor:** SkillCheckService
**Precondition:** Character attempts tech or social check
**Flow:**

1. Call `GetSkillModifiers(characterId)`
2. If tech check: Apply `modifiers.TechBonus`
3. If social check: Apply `modifiers.SocialPenalty`
4. Check `modifiers.FactionLocked` for faction interactions

**Postcondition:** Check modifiers correctly applied

---

## 11. Deliverable Checklist

### Application Layer — Interface

- [x] `src/Core/RuneAndRust.Application/Interfaces/ICorruptionService.cs`

### Documentation

- [x] XML documentation on interface and all methods
- [x] Code examples in interface-level remarks
- [x] Parameter documentation with exceptions listed
- [x] Update scope breakdown to mark v0.18.1c complete

---

## 12. Acceptance Criteria

### Interface Definition Criteria

- [x] `ICorruptionService` defines all 9 methods as specified
- [x] All methods have complete XML documentation
- [x] All parameters have `<param>` tags with descriptions
- [x] All return types have `<returns>` tags
- [x] All exceptions have `<exception>` tags
- [x] Interface includes class-level `<example>` block
- [x] Interface compiles without implementation references

### Method Signature Criteria

- [x] `GetCorruptionState` returns `CorruptionState`
- [x] `GetMaxHpPenaltyPercent` returns `int`
- [x] `GetMaxApPenaltyPercent` returns `int`
- [x] `GetResolveDicePenalty` returns `int`
- [x] `GetSkillModifiers` returns `CorruptionSkillModifiers`
- [x] `AddCorruption` returns `CorruptionAddResult`
- [x] `TransferCorruption` returns `CorruptionTransferResult`
- [x] `RemoveCorruption` returns `bool`
- [x] `PerformTerminalErrorCheck` returns `TerminalErrorResult`

### Quality Criteria

- [x] Build succeeds with 0 errors
- [x] Build succeeds with 0 warnings
- [x] Code follows project conventions

---

## 13. Dependencies

### Required from v0.18.1a

| Type               | Usage                                |
| ------------------ | ------------------------------------ |
| `CorruptionStage`  | Referenced in method documentation   |
| `CorruptionSource` | Parameter type for `AddCorruption`   |
| `CorruptionState`  | Return type for `GetCorruptionState` |

### Required from v0.18.1b

| Type                  | Usage                                       |
| --------------------- | ------------------------------------------- |
| `CorruptionAddResult` | Return type for `AddCorruption`             |
| `TerminalErrorResult` | Return type for `PerformTerminalErrorCheck` |

### Defined in v0.18.1d (Implementation)

| Type                       | Usage                                |
| -------------------------- | ------------------------------------ |
| `CorruptionTransferResult` | Return type for `TransferCorruption` |
| `CorruptionSkillModifiers` | Return type for `GetSkillModifiers`  |

### Provides to v0.18.1d

| Type                 | Usage                        |
| -------------------- | ---------------------------- |
| `ICorruptionService` | Interface for implementation |

---

## 14. Future Considerations

### Deferred to v0.18.1d

- `CorruptionService` implementation
- `CorruptionTransferResult` value object
- `CorruptionSkillModifiers` value object
- Complete logging implementation
- ~5 unit tests for service behavior

### Deferred to v0.18.1e

- JSON configuration for thresholds
- Database persistence configuration

### Deferred to v0.18.5

- Stress-Corruption interaction methods
- Combined penalty calculations

### Out of Scope

- Wild Magic system (v0.20.x)
- Forlorn NPC conversion (v0.21.x)
- Advanced purification rituals (v0.22.x)
- UI corruption display (presentation layer)

---

_Document Version: 1.0_
_Last Updated: 2026-01-27_
