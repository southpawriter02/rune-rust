# Changelog: v0.17.3b - Archetype Resource Bonuses

**Release Date:** 2026-01-30
**Phase:** Archetype System (2/6)
**Status:** Complete

---

## Overview

Implements the `ArchetypeResourceBonuses` and `ArchetypeSpecialBonus` value objects that encapsulate the resource pool bonuses each archetype provides during character creation. These bonuses directly affect derived statistics and are core to archetype differentiation.

Each archetype has a distinct bonus profile reflecting its combat role:

| Archetype  | HP Bonus | Stamina Bonus | AP Bonus | Movement | Special              |
| ---------- | -------- | ------------- | -------- | -------- | -------------------- |
| Warrior    | +49      | +5            | 0        | 0        | —                    |
| Skirmisher | +30      | +5            | 0        | +1       | —                    |
| Mystic     | +20      | 0             | +20      | 0        | —                    |
| Adept      | +30      | 0             | 0        | 0        | +20% Consumables     |

The Warrior's massive HP bonus establishes it as the primary tank. The Skirmisher trades raw HP for mobility (+1 Movement). The Mystic sacrifices physical durability for Aether capacity (+20 AP). The Adept compensates for the lowest total resource bonus (30) with a unique +20% consumable effectiveness special bonus.

Both value objects are immutable `readonly record struct` types following the established codebase pattern (matching `DerivedStats`, `PointBuyCost`). They include static archetype properties, validated `Create()` factory methods, computed boolean properties, and display/debug formatting methods.

---

## Added

### Domain Layer

#### Value Objects

- **`ArchetypeResourceBonuses`** (`ValueObjects/ArchetypeResourceBonuses.cs`)
    - `readonly record struct` with primary constructor `(int MaxHpBonus, int MaxStaminaBonus, int MaxAetherPoolBonus, int MovementBonus, ArchetypeSpecialBonus? SpecialBonus)`
    - File header with `═══` borders, Version: 0.17.3b
    - Section separators: PRIVATE FIELDS, COMPUTED PROPERTIES, STATIC PROPERTIES, FACTORY METHODS, HELPER METHODS, DEBUGGING
    - Static `ILogger<ArchetypeResourceBonuses>?` field for diagnostic output
    - Computed properties: `HasHpBonus`, `HasStaminaBonus`, `HasAetherPoolBonus`, `HasMovementBonus`, `HasSpecialBonus`, `TotalResourceBonus`
    - Static properties: `None` (all zeros), `Warrior` (+49/+5/0/0), `Skirmisher` (+30/+5/0/+1), `Mystic` (+20/0/+20/0), `Adept` (+30/0/0/0 + special)
    - `Create()` factory method with `ArgumentOutOfRangeException.ThrowIfNegative` for all four numeric parameters
    - `GetDisplaySummary()`: Comma-separated active bonuses or "No bonuses"
    - `GetSpecialBonusDescription()`: Special bonus description or null
    - `ToString()`: Compact debug format `HP+{n}, Stam+{n}, AP+{n}, Mov+{n}`
    - Full XML documentation with `<summary>`, `<remarks>`, `<list>`, `<param>`, `<returns>`, `<example>`, `<seealso>`

- **`ArchetypeSpecialBonus`** (`ValueObjects/ArchetypeSpecialBonus.cs`)
    - `readonly record struct` with primary constructor `(string BonusType, float BonusValue, string Description)`
    - File header with `═══` borders, Version: 0.17.3b
    - Section separators: PRIVATE FIELDS, CONSTANTS, COMPUTED PROPERTIES, FACTORY METHODS, HELPER METHODS, DEBUGGING
    - Static `ILogger<ArchetypeSpecialBonus>?` field for diagnostic output
    - Constant: `ConsumableEffectivenessType = "ConsumableEffectiveness"`
    - Computed properties: `IsConsumableEffectiveness` (case-insensitive), `Multiplier` (1f + BonusValue), `PercentageValue` ((int)(BonusValue × 100))
    - `CreateConsumableEffectiveness(int percentageBonus)`: Convenience factory for the standard Adept bonus
    - `Create(string, float, string)`: General factory with `ArgumentException.ThrowIfNullOrWhiteSpace` validation
    - `ApplyTo(int)`: Integer multiplication with truncation
    - `ApplyTo(float)`: Float multiplication
    - `GetShortDisplay()`: Compact format `+{n}% {BonusType}`
    - `ToString()`: Debug format `{BonusType}: +{n}%`
    - Full XML documentation throughout

### Unit Tests

- **`ArchetypeResourceBonusesTests`** (`ValueObjects/ArchetypeResourceBonusesTests.cs`) — 24 tests
    - `Warrior_HasCorrectBonuses`: All 5 properties verified (HP=49, Stamina=5, AP=0, Movement=0, no special)
    - `Skirmisher_HasMovementBonus`: Movement=1, HasMovementBonus=true, no special
    - `Mystic_HasAetherPoolBonus`: AP=20, HasAetherPoolBonus=true, HasStaminaBonus=false
    - `Adept_HasSpecialBonus`: HasSpecialBonus=true, ConsumableEffectiveness, BonusValue=0.20f
    - `None_HasNoActiveBonuses`: All Has* false, TotalResourceBonus=0
    - `TotalResourceBonus_Warrior_Returns54`: 49+5+0=54
    - `TotalResourceBonus_Skirmisher_Returns35`: 30+5+0=35
    - `TotalResourceBonus_Mystic_Returns40`: 20+0+20=40
    - `TotalResourceBonus_Adept_Returns30`: 30+0+0=30
    - `Create_WithValidData_CreatesBonuses`: Factory creates correct properties
    - `Create_WithSpecialBonus_IncludesSpecialBonus`: Factory passes special bonus through
    - `Create_WithNegativeHpBonus_ThrowsArgumentOutOfRangeException`
    - `Create_WithNegativeStaminaBonus_ThrowsArgumentOutOfRangeException`
    - `Create_WithNegativeAetherPoolBonus_ThrowsArgumentOutOfRangeException`
    - `Create_WithNegativeMovementBonus_ThrowsArgumentOutOfRangeException`
    - `GetDisplaySummary_Warrior_ReturnsFormattedString`: Contains "+49 HP", "+5 Stamina"
    - `GetDisplaySummary_Skirmisher_IncludesMovementBonus`: Contains "+1 Movement"
    - `GetDisplaySummary_Mystic_IncludesAetherPoolBonus`: Contains "+20 Aether Pool"
    - `GetDisplaySummary_Adept_IncludesSpecialBonusDescription`: Contains "+20% effectiveness..."
    - `GetDisplaySummary_None_ReturnsNoBonuses`: Returns "No bonuses"
    - `GetSpecialBonusDescription_Adept_ReturnsDescription`: Returns description string
    - `GetSpecialBonusDescription_Warrior_ReturnsNull`: Returns null
    - `ToString_Warrior_ReturnsFormattedString`: "HP+49, Stam+5, AP+0, Mov+0"
    - `ToString_Adept_IncludesSpecialBonusType`: Includes "Special: ConsumableEffectiveness"

- **`ArchetypeSpecialBonusTests`** (`ValueObjects/ArchetypeSpecialBonusTests.cs`) — 16 tests
    - `CreateConsumableEffectiveness_CreatesCorrectBonus`: BonusType, BonusValue=0.20f, PercentageValue=20
    - `CreateConsumableEffectiveness_IsConsumableEffectiveness_ReturnsTrue`
    - `Create_WithValidData_CreatesBonus`: General factory creates correct properties
    - `Create_WithNullBonusType_ThrowsArgumentException`
    - `Create_WithWhitespaceBonusType_ThrowsArgumentException`
    - `Create_WithNullDescription_ThrowsArgumentException`
    - `Create_WithWhitespaceDescription_ThrowsArgumentException`
    - `Multiplier_Returns1Point2_ForTwentyPercentBonus`: 1f + 0.20f = 1.20f
    - `PercentageValue_ReturnsIntegerPercentage`: 0.50f → 50
    - `IsConsumableEffectiveness_ReturnsFalse_ForOtherBonusTypes`
    - `ApplyTo_Int_MultipliesCorrectly`: 100 × 1.20 = 120
    - `ApplyTo_Float_MultipliesCorrectly`: 50.0f × 1.20f ≈ 60.0f
    - `ApplyTo_Int_TruncatesFractionalResult`: 55 × 1.20 = 66
    - `GetShortDisplay_ReturnsFormattedString`: "+20% ConsumableEffectiveness"
    - `ToString_ReturnsFormattedString`: "ConsumableEffectiveness: +20%"
    - `ConsumableEffectivenessType_HasExpectedValue`: Constant verification

### Glossary

- **`config/glossary.json`** — Added 2 glossary entries
    - `archetype-resource-bonuses`: Resource pool bonuses (HP, Stamina, AP, Movement) per archetype (sortOrder: 27)
    - `archetype-special-bonus`: Unique archetype effects beyond standard resource bonuses (sortOrder: 28)

---

## Changed

### Configuration Files

- **`config/archetypes.json`** — Added `resourceBonuses` section to all 4 archetypes
    - Each archetype entry now includes a `resourceBonuses` object with `maxHpBonus`, `maxStaminaBonus`, `maxAetherPoolBonus`, `movementBonus`, and `specialBonus` fields
    - Warrior: +49 HP, +5 Stamina
    - Skirmisher: +30 HP, +5 Stamina, +1 Movement
    - Mystic: +20 HP, +20 Aether Pool
    - Adept: +30 HP, special bonus (ConsumableEffectiveness, 0.20)

- **`config/schemas/archetypes.schema.json`** — Extended with resource bonus definitions
    - Added `resourceBonuses` definition with 4 required numeric fields and optional `specialBonus`
    - Added `specialBonus` definition with `bonusType` (enum: ["ConsumableEffectiveness"]), `bonusValue` (number, 0-1), `description` (string)
    - Added `resourceBonuses` as required property in `archetypeDefinition`
    - `specialBonus` uses `oneOf` with `null` type for nullable support
    - All definitions use `additionalProperties: false`

### Documentation

- **`docs/design/v0.17.x/v0.17.3-scope-breakdown.md`** — Checked off v0.17.3b unit test items
    - `[x] Warrior HP bonus is 49`
    - `[x] Adept has +20% consumable effectiveness`

- **`docs/design/v0.17.x/v0.17.x-overview.md`** — Checked off v0.17.3 deliverable
    - `[x] ArchetypeResourceBonus value object`

---

## Design Decisions

### readonly record struct Pattern

Both `ArchetypeResourceBonuses` and `ArchetypeSpecialBonus` use the `readonly record struct` pattern, matching `DerivedStats` (v0.17.2d) and `PointBuyCost` (v0.17.2c). This provides value equality semantics, immutability, and zero-allocation access for frequently-used bonus lookups during character creation and stat calculation.

### Static Archetype Properties vs. Dictionary Lookup

The design specification defines static properties (`Warrior`, `Skirmisher`, `Mystic`, `Adept`) directly on `ArchetypeResourceBonuses` for canonical bonus values. This approach was followed because:
- It provides compile-time type safety and IntelliSense discoverability
- The four archetype profiles are fixed game design constants
- It avoids dictionary allocation for the most common access pattern
- The `Create()` factory method exists for configuration-loaded custom values

### Separate ArchetypeSpecialBonus Type

The `ArchetypeSpecialBonus` is a separate value object rather than inline fields on `ArchetypeResourceBonuses` because:
- Only Adept has a special bonus (3 of 4 archetypes have null)
- The bonus type/value/description pattern supports future special bonus types
- Separation of concerns: numeric resource bonuses vs. percentage-based effects
- The `ApplyTo()` methods encapsulate the multiplier calculation logic

### Nullable SpecialBonus via Nullable Value Type

`ArchetypeSpecialBonus?` (nullable struct) was chosen over an interface or class hierarchy because:
- Matches the design specification's `ArchetypeSpecialBonus?` signature
- Avoids heap allocation for the common null case (Warrior, Skirmisher, Mystic)
- `HasValue` check is efficient and idiomatic for nullable structs
- The `.Value` accessor is explicit about unwrapping

### JSON Schema Draft-07 Consistency

The schema extension uses Draft-07 with `definitions` (not `$defs`) matching the existing v0.17.3a schema and all other schemas in the codebase (`backgrounds.schema.json`, `lineages.schema.json`, `attributes.schema.json`).

---

## Dependencies

### Prerequisites

| Type                  | Phase    | Usage                                        |
| --------------------- | -------- | -------------------------------------------- |
| `Archetype`           | v0.17.3a | Archetype identification for bonus profiles  |
| `ArchetypeDefinition` | v0.17.3a | Will compose with resource bonuses in v0.17.3e |

### Provides to Future Phases

| Type                       | Phase    | Usage                                        |
| -------------------------- | -------- | -------------------------------------------- |
| `ArchetypeResourceBonuses` | v0.17.3e | Provider returns bonuses per archetype        |
| `ArchetypeResourceBonuses` | v0.17.3f | Application service applies bonuses           |
| `ArchetypeResourceBonuses` | v0.17.2g | DerivedStatCalculator uses for bonus formulas |
| `ArchetypeSpecialBonus`    | v0.17.3f | Applied to character during creation          |

---

## Logging Strategy

| Level       | When                                                              |
|-------------|-------------------------------------------------------------------|
| Debug       | Factory method entry with input parameters                        |
| Debug       | Validation passed confirmation with validated values              |
| Information | Successful creation with all property values and computed totals  |

---

## Files Created

| Path | Description |
|------|-------------|
| `src/Core/RuneAndRust.Domain/ValueObjects/ArchetypeResourceBonuses.cs` | Resource pool bonuses value object |
| `src/Core/RuneAndRust.Domain/ValueObjects/ArchetypeSpecialBonus.cs` | Special bonus value object |
| `tests/RuneAndRust.Domain.UnitTests/ValueObjects/ArchetypeResourceBonusesTests.cs` | Resource bonuses unit tests |
| `tests/RuneAndRust.Domain.UnitTests/ValueObjects/ArchetypeSpecialBonusTests.cs` | Special bonus unit tests |

## Files Modified

| Path | Description |
|------|-------------|
| `config/archetypes.json` | Added resourceBonuses section to all 4 archetypes |
| `config/schemas/archetypes.schema.json` | Added resourceBonuses and specialBonus definitions |
| `config/glossary.json` | Added 2 glossary entries (archetype-resource-bonuses, archetype-special-bonus) |
| `docs/design/v0.17.x/v0.17.3-scope-breakdown.md` | Checked off v0.17.3b deliverables |
| `docs/design/v0.17.x/v0.17.x-overview.md` | Updated v0.17.3 deliverable checkboxes |

---

## Notes

- Total unit tests for v0.17.3b: 40 tests (24 + 16)
- The design specification estimated ~8 tests; 40 were implemented for comprehensive coverage of all static profiles, validation paths, computed properties, helper methods, and edge cases
- Only Adept has a non-null `ArchetypeSpecialBonus` among the four archetypes
- The `ApplyTo(float)` test uses `BeApproximately` for floating-point comparison tolerance
- `TotalResourceBonus` excludes Movement and Special bonuses as they represent different value types not directly comparable to resource pool points
- Warrior has the highest total resource bonus (54) while Adept has the lowest (30), compensated by the +20% consumable effectiveness special bonus
- Resource bonuses, starting abilities, specialization mappings, and provider/application services integration deferred to v0.17.3c-f
