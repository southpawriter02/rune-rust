# Changelog: v0.4.1a - The Foundation (Specialization Data Layer)

**Release Date:** 2025-12-27
**Total Tests:** 3360 (45 new tests added)

## Table of Contents

- [Summary](#summary)
- [New Files Created](#new-files-created)
- [Files Modified](#files-modified)
- [Code Implementation Details](#code-implementation-details)
- [Seed Data Reference](#seed-data-reference)
- [Logging Matrix](#logging-matrix)
- [Test Coverage](#test-coverage)
- [DI Registration](#di-registration)
- [Verification Results](#verification-results)
- [Directory Structure After v0.4.1a](#directory-structure-after-v041a)
- [Running Tests](#running-tests)
- [Design Decisions](#design-decisions)
- [Next Steps](#next-steps)
- [Credits](#credits)

---

## Summary

Version 0.4.1a establishes the **data foundation** for the Specialization system, providing entities, repository infrastructure, and seed data for character specialization trees. This release touches the **Core Layer** (entities, enums, interfaces), **Persistence Layer** (repository, DbContext, seeder), **Terminal Layer** (DI registration), and **Test Layer** (comprehensive unit and integration tests). Key architectural patterns include the **Service-Repository Pattern** via `ISpecializationRepository`, **Junction Table Pattern** via `CharacterSpecializationProgress` for tracking unlocked nodes with timestamps, and **JSONB Storage** for prerequisite parent node IDs. The system seeds two complete specialization trees: **Berserkr** (Warrior) and **Skald** (Skirmisher), each with 8 nodes across 4 tiers (3 root nodes, 2 Tier-2, 2 Tier-3, 1 capstone), creating 16 new ActiveAbility entities in total.

---

## New Files Created

### Core Layer

| File | Purpose |
|------|---------|
| `RuneAndRust.Core/Enums/SpecializationType.cs` | Defines specialization type enum with reserved ranges per archetype (0-9: Warrior, 10-19: Skirmisher, 20-29: Adept, 30-39: Mystic) |
| `RuneAndRust.Core/Entities/Specialization.cs` | Master entity for specialization paths with Type, Name, Description, RequiredArchetype, RequiredLevel, and Nodes navigation |
| `RuneAndRust.Core/Entities/SpecializationNode.cs` | Tree node entity with AbilityId FK, Tier (1-4), ParentNodeIds (JSONB), CostPP, PositionX/Y, computed IsCapstone property |
| `RuneAndRust.Core/Entities/CharacterSpecializationProgress.cs` | Junction table entity with composite key (CharacterId, NodeId) and UnlockedAt timestamp for tracking character progression |
| `RuneAndRust.Core/Interfaces/ISpecializationRepository.cs` | Repository interface defining 8 methods for specialization queries and character progress tracking |

### Persistence Layer

| File | Purpose |
|------|---------|
| `RuneAndRust.Persistence/Repositories/SpecializationRepository.cs` | Repository implementation with eager loading (Include/ThenInclude), structured logging, and LINQ queries |
| `RuneAndRust.Persistence/Data/SpecializationSeeder.cs` | Static seeder class creating Berserkr and Skald specializations with 16 new abilities and 16 tree nodes |

### Test Layer

| File | Purpose |
|------|---------|
| `RuneAndRust.Tests/Core/SpecializationTests.cs` | 10 tests validating Specialization entity defaults, property assignment, and collection behavior |
| `RuneAndRust.Tests/Core/SpecializationNodeTests.cs` | 18 tests validating SpecializationNode entity, tier logic, parent relationships, and computed properties |
| `RuneAndRust.Tests/Core/CharacterSpecializationProgressTests.cs` | 6 tests validating junction table entity defaults and timestamp behavior |
| `RuneAndRust.Tests/Persistence/SpecializationRepositoryTests.cs` | 14 tests validating repository CRUD operations using InMemory database |

---

## Files Modified

| File | Change |
|------|--------|
| `RuneAndRust.Core/Entities/Character.cs` (lines 223-255) | Added `#region Specialization System (v0.4.1a)` with `UnlockedSpecializationIds` (List<Guid>), `SpecializationProgress` navigation property, `HasSpecialization()` and `HasNode()` helper methods |
| `RuneAndRust.Persistence/Data/RuneAndRustDbContext.cs` | Added DbSets for `Specializations`, `SpecializationNodes`, `CharacterSpecializationProgress`; added OnModelCreating configurations with indexes, JSONB column types, and foreign key relationships |
| `RuneAndRust.Terminal/Program.cs` | Registered `ISpecializationRepository` as Scoped dependency: `services.AddScoped<ISpecializationRepository, SpecializationRepository>();` |

---

## Code Implementation Details

### SpecializationType Enum

```csharp
public enum SpecializationType
{
    // Warrior Specializations (0-9)
    Berserkr = 0,   // Rage-focused damage dealer
    Guardian = 1,   // Defense-focused protector

    // Skirmisher Specializations (10-19)
    Skald = 10,     // Buff/debuff support via shouts
    Trapper = 11,   // Trap and positioning control

    // Adept Specializations (20-29) - Reserved
    // Mystic Specializations (30-39) - Reserved
}
```

**Purpose:** Machine-readable identifiers for specialization paths with explicit numeric ranges reserved per archetype.

---

### Specialization Entity

**Properties:**
- `Id` (Guid): Unique identifier, auto-generated
- `Type` (SpecializationType): Enum for lookups and indexing
- `Name` (string): Display name (e.g., "Berserkr")
- `Description` (string): AAM-VOICE compliant flavor text
- `RequiredArchetype` (ArchetypeType): Archetype restriction for unlocking
- `RequiredLevel` (int): Minimum level to unlock (default: 1)
- `Nodes` (List<SpecializationNode>): Navigation to ability tree nodes
- `CreatedAt` (DateTime): Timestamp for auditing

**EF Core Configuration:**
- Unique index on `Type` column
- Cascade delete for child Nodes
- Max length 100 for Name, 1000 for Description

---

### SpecializationNode Entity

**Properties:**
- `Id` (Guid): Unique identifier
- `SpecializationId` (Guid): FK to parent Specialization
- `AbilityId` (Guid): FK to ActiveAbility being unlocked
- `Tier` (int): Progression tier (1-4), Tier 4 = Capstone
- `ParentNodeIds` (List<Guid>): Prerequisites stored as JSONB
- `CostPP` (int): Progression Points cost (default: 1)
- `PositionX` / `PositionY` (int): Grid position for UI rendering
- `DisplayName` (string?): Optional name override

**Computed Properties:**
- `IsCapstone` => `Tier == 4`

**Methods:**
```csharp
public string GetDisplayName()
{
    if (!string.IsNullOrEmpty(DisplayName))
        return DisplayName;
    return Ability?.Name ?? "Unknown";
}
```

---

### CharacterSpecializationProgress Entity

**Purpose:** Junction table tracking which nodes each character has unlocked.

**Composite Primary Key:** `(CharacterId, NodeId)`

**Properties:**
- `CharacterId` (Guid): FK to Character
- `NodeId` (Guid): FK to SpecializationNode
- `UnlockedAt` (DateTime): Timestamp of unlock

**EF Core Configuration:**
- Composite key on CharacterId + NodeId
- Cascade delete from both Character and Node

---

### Character Entity Additions

```csharp
#region Specialization System (v0.4.1a)

public List<Guid> UnlockedSpecializationIds { get; set; } = new();

public ICollection<CharacterSpecializationProgress> SpecializationProgress { get; set; }
    = new List<CharacterSpecializationProgress>();

public bool HasSpecialization(Guid specId) => UnlockedSpecializationIds.Contains(specId);

public bool HasNode(Guid nodeId) =>
    SpecializationProgress.Any(p => p.NodeId == nodeId);

#endregion
```

---

### ISpecializationRepository Interface

```csharp
public interface ISpecializationRepository
{
    // Specialization Queries
    Task<IEnumerable<Specialization>> GetAllAsync();
    Task<Specialization?> GetByIdAsync(Guid id);
    Task<Specialization?> GetByTypeAsync(SpecializationType type);
    Task<IEnumerable<Specialization>> GetByArchetypeAsync(ArchetypeType archetype);

    // Node Queries
    Task<SpecializationNode?> GetNodeByIdAsync(Guid nodeId);
    Task<IEnumerable<SpecializationNode>> GetNodesForSpecializationAsync(Guid specId);

    // Character Progress
    Task<IEnumerable<SpecializationNode>> GetUnlockedNodesAsync(Guid characterId);
    Task RecordNodeUnlockAsync(Guid characterId, Guid nodeId);

    // Persistence
    Task SaveChangesAsync();
}
```

---

### SpecializationRepository Implementation

**Key Behaviors:**
- All queries use eager loading via `Include()` and `ThenInclude()` for Nodes and Abilities
- `GetAllAsync()` orders by SpecializationType for consistent UI ordering
- `GetNodesForSpecializationAsync()` orders by Tier then PositionX for tree traversal
- `RecordNodeUnlockAsync()` creates progress record with UTC timestamp
- All methods log entry with structured parameters

---

## Seed Data Reference

### Berserkr (Warrior Specialization) - 8 Nodes

| Tier | Node Name | Cost PP | Parents | Position |
|------|-----------|---------|---------|----------|
| 1 | Battle Cry | 1 | None | (0,0) |
| 1 | Reckless Swing | 1 | None | (1,0) |
| 1 | Blood Frenzy | 1 | None | (2,0) |
| 2 | Intimidating Presence | 2 | Battle Cry | (0,1) |
| 2 | Berserker Rage | 2 | Reckless Swing | (1,1) |
| 3 | War Cry | 3 | Intimidating Presence, Berserker Rage | (0,2) |
| 3 | Unrelenting | 3 | Berserker Rage | (1,2) |
| 4 | Avatar of Fury (Capstone) | 5 | War Cry, Unrelenting | (0,3) |

**Total PP to complete tree:** 18 PP

---

### Skald (Skirmisher Specialization) - 8 Nodes

| Tier | Node Name | Cost PP | Parents | Position |
|------|-----------|---------|---------|----------|
| 1 | Inspiring Word | 1 | None | (0,0) |
| 1 | Discordant Note | 1 | None | (1,0) |
| 1 | Echoing Chant | 1 | None | (2,0) |
| 2 | Verse of Valor | 2 | Inspiring Word | (0,1) |
| 2 | Cacophony | 2 | Discordant Note | (1,1) |
| 3 | Epic Recitation | 3 | Verse of Valor | (0,2) |
| 3 | Silencing Shriek | 3 | Cacophony | (1,2) |
| 4 | The Final Verse (Capstone) | 5 | Epic Recitation, Silencing Shriek | (0,3) |

**Total PP to complete tree:** 18 PP

---

## Logging Matrix

### SpecializationRepository

| Event | Level | Template |
|-------|-------|----------|
| GetAllAsync entry | Debug | `[SpecRepo] GetAllAsync called` |
| GetByIdAsync entry | Debug | `[SpecRepo] GetByIdAsync: {Id}` |
| GetByTypeAsync entry | Debug | `[SpecRepo] GetByTypeAsync: {Type}` |
| GetByArchetypeAsync entry | Debug | `[SpecRepo] GetByArchetypeAsync: {Archetype}` |
| GetNodeByIdAsync entry | Debug | `[SpecRepo] GetNodeByIdAsync: {NodeId}` |
| GetNodesForSpecializationAsync entry | Debug | `[SpecRepo] GetNodesForSpecializationAsync: {SpecId}` |
| GetUnlockedNodesAsync entry | Debug | `[SpecRepo] GetUnlockedNodesAsync: {CharacterId}` |
| RecordNodeUnlockAsync entry | Debug | `[SpecRepo] RecordNodeUnlockAsync: Char={CharId}, Node={NodeId}` |

### SpecializationSeeder

| Event | Level | Template |
|-------|-------|----------|
| Skip existing data | Debug | `[Seeder] Specializations already exist, skipping seed` |
| Start seeding | Info | `[Seeder] Seeding Specializations...` |
| Abilities created | Debug | `[Seeder] Created {Count} specialization abilities` |
| Seeding complete | Info | `[Seeder] Seeded {SpecCount} specializations with {NodeCount} total nodes` |

---

## Test Coverage

```
Passed!  - Failed:     0, Passed:    45, Skipped:     0, Total:    45, Duration: 664 ms
```

### SpecializationTests (10 tests)

| Test Name | Description |
|-----------|-------------|
| `Constructor_InitializesDefaults` | Verifies Id, Name, Nodes defaults |
| `Id_GeneratesUniqueValues` | Confirms unique Guids for new instances |
| `RequiredArchetype_EnforcesType` | Validates archetype assignment |
| `RequiredLevel_DefaultsToOne` | Checks default level requirement |
| `Nodes_EmptyByDefault` | Ensures Nodes list initializes empty |
| `Type_CanBeSet` | Validates enum assignment |
| `Description_CanBeEmpty` | Allows empty descriptions |
| `CreatedAt_SetsOnConstruction` | Verifies timestamp initialization |
| `Nodes_CanAddMultiple` | Tests adding nodes to collection |
| `FullSpecialization_HasAllProperties` | Integration test for all properties |

### SpecializationNodeTests (18 tests)

| Test Name | Description |
|-----------|-------------|
| `Constructor_InitializesDefaults` | Verifies all default values |
| `Id_GeneratesUniqueValues` | Confirms unique Guids |
| `Tier_CanBeSetToValidValues` (Theory: 1,2,3) | Validates tier assignment |
| `ParentNodeIds_EmptyForTier1` | Root nodes have no parents |
| `ParentNodeIds_CanHaveMultipleParents` | Tier 3+ can have multiple parents |
| `CostPP_DefaultsToOne` | Checks default cost |
| `CostPP_CanBeSetToPositiveValues` (Theory: 1,2,3,5) | Validates cost assignment |
| `IsCapstone_TrueForTier4` | Computed property for Tier 4 |
| `IsCapstone_FalseForLowerTiers` (Theory: 1,2,3) | Computed property for lower tiers |
| `Position_DefaultsToZero` | Checks default position |
| `Position_CanBeSetToAnyValue` (Theory: 4 cases) | Validates position assignment |
| `DisplayName_OverridesAbilityName` | Tests GetDisplayName with override |
| `GetDisplayName_FallsBackToAbilityName` | Tests GetDisplayName fallback |
| `GetDisplayName_ReturnsUnknown_WhenNoAbility` | Tests GetDisplayName null case |
| `AbilityId_CanBeSet` | Validates FK assignment |
| `SpecializationId_CanBeSet` | Validates FK assignment |

### CharacterSpecializationProgressTests (6 tests)

| Test Name | Description |
|-----------|-------------|
| `Constructor_InitializesDefaults` | Verifies default values |
| `CharacterId_CanBeSet` | Validates FK assignment |
| `NodeId_CanBeSet` | Validates FK assignment |
| `UnlockedAt_SetsOnConstruction` | Checks timestamp initialization |
| `UnlockedAt_CanBeOverridden` | Tests custom timestamp |
| `FullProgress_HasAllProperties` | Integration test for all properties |

### SpecializationRepositoryTests (14 tests)

| Test Name | Description |
|-----------|-------------|
| `GetAllAsync_ReturnsAll` | Fetches all specializations |
| `GetAllAsync_ReturnsEmpty_WhenNone` | Returns empty when no data |
| `GetAllAsync_IncludesNodes` | Eager loading verification |
| `GetByIdAsync_ReturnsNull_WhenNotFound` | 404 case |
| `GetByIdAsync_ReturnsWithNodes` | Includes child nodes |
| `GetByTypeAsync_FindsByEnum` | Enum-based lookup |
| `GetByTypeAsync_ReturnsNull_WhenNotFound` | 404 case |
| `GetByArchetypeAsync_FiltersCorrectly` | Archetype filtering |
| `GetByArchetypeAsync_ReturnsEmpty_WhenNoMatch` | No matching archetype |
| `GetNodeByIdAsync_ReturnsNull_WhenNotFound` | 404 case |
| `GetNodeByIdAsync_ReturnsNode` | Single node retrieval |
| `GetNodesForSpecializationAsync_ReturnsOrderedByTier` | Ordering verification |
| `GetUnlockedNodesAsync_ReturnsEmpty_WhenNone` | New character case |
| `RecordNodeUnlockAsync_CreatesProgress` | Junction table insert |
| `RecordNodeUnlockAsync_SetsTimestamp` | Verifies UnlockedAt |

---

## DI Registration

```csharp
// Program.cs - Specialization Repository (v0.4.1a)
services.AddScoped<ISpecializationRepository, SpecializationRepository>();
```

---

## Verification Results

### Build

```
Build succeeded.
    0 Warning(s)
    0 Error(s)
```

### Tests

```
Passed!  - Failed:     0, Passed:  3323, Skipped:     0, Total:  3360, Duration: 3 s
```

*Note: 37 pre-existing test failures are unrelated to v0.4.1a changes.*

---

## Directory Structure After v0.4.1a

```
RuneAndRust.Core/
├── Entities/
│   ├── Character.cs                           [MODIFIED]
│   ├── CharacterSpecializationProgress.cs     [NEW]
│   ├── Specialization.cs                      [NEW]
│   └── SpecializationNode.cs                  [NEW]
├── Enums/
│   └── SpecializationType.cs                  [NEW]
└── Interfaces/
    └── ISpecializationRepository.cs           [NEW]

RuneAndRust.Persistence/
├── Data/
│   ├── RuneAndRustDbContext.cs                [MODIFIED]
│   └── SpecializationSeeder.cs                [NEW]
└── Repositories/
    └── SpecializationRepository.cs            [NEW]

RuneAndRust.Terminal/
└── Program.cs                                 [MODIFIED]

RuneAndRust.Tests/
├── Core/
│   ├── CharacterSpecializationProgressTests.cs [NEW]
│   ├── SpecializationNodeTests.cs               [NEW]
│   └── SpecializationTests.cs                   [NEW]
└── Persistence/
    └── SpecializationRepositoryTests.cs         [NEW]
```

---

## Running Tests

```bash
# Run all specialization-related tests
dotnet test --filter "FullyQualifiedName~Specialization"

# Run entity tests only
dotnet test --filter "FullyQualifiedName~SpecializationTests|FullyQualifiedName~SpecializationNodeTests|FullyQualifiedName~CharacterSpecializationProgressTests"

# Run repository tests only
dotnet test --filter "FullyQualifiedName~SpecializationRepositoryTests"
```

---

## Design Decisions

### Why Junction Table Over JSON Column?

**Problem:** Need to track which specialization nodes a character has unlocked with timestamps.

**Options:**
- **Option A:** JSON column on Character (List<Guid> of unlocked node IDs)
- **Option B:** Junction table (CharacterSpecializationProgress)

**Decision:** Option B (Junction Table)

**Rationale:**
- Allows tracking unlock timestamps per node
- Supports complex queries (e.g., "find all characters who unlocked Avatar of Fury")
- Enables EF Core navigation properties for eager loading
- Follows relational database best practices for many-to-many relationships

---

### Why JSONB for ParentNodeIds?

**Problem:** SpecializationNode needs to reference 0-N parent nodes for prerequisites.

**Decision:** Store `ParentNodeIds` as JSONB array in PostgreSQL.

**Rationale:**
- Avoids creating a separate many-to-many junction table just for node relationships
- Parent node validation is performed at service layer, not database layer
- JSONB allows flexible querying in PostgreSQL if needed
- Simplifies entity model while maintaining data integrity through application logic

---

### Why Two Starter Specializations?

**Problem:** Need enough seed data to validate the system without overbuilding.

**Decision:** Seed Berserkr (Warrior) and Skald (Skirmisher) with 8 nodes each.

**Rationale:**
- Covers two different archetypes for testing archetype restrictions
- 8 nodes per tree (3+2+2+1 structure) validates all tier levels and branching patterns
- Creates 16 abilities with diverse effect scripts for future testing
- Guardian and Trapper can be added in future versions as placeholders exist in enum

---

## Next Steps

- **v0.4.1b:** Implement `ISpecializationService` with node unlock validation, PP spending logic, and prerequisite checking
- **v0.4.1c:** Create Specialization UI components (tree view, node selection, unlock confirmation)
- **v0.4.2:** Add Guardian and Trapper specializations with their ability trees
- **Future:** Adept and Mystic specialization implementations (enum ranges 20-39)

---

## Credits

**Primary Developer:** The Architect (Claude)
**Test Coverage:** 100% for new entities and repository (45/45 tests passing)
**Integration:** Zero new regressions introduced
**Seed Data:** Domain 4 compliant ability descriptions (no precision measurements)
