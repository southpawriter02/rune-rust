# Changelog: v0.17.5f - TUI Screens (Character Creation Wizard)

**Release Date:** 2026-01-31
**Phase:** Character Creation Workflow (6/7)
**Status:** Complete

---

## Overview

Implements the TUI Screens phase: 6 step screens, 2 shared components, 1 interface with supporting types, 1 orchestrator view, and comprehensive unit tests (56 test methods). The screens present the six-step character creation wizard using Spectre.Console — selection prompts, detail tables, progress indicators, and validation error display. The `CreationWizardView` orchestrates the workflow loop, routing between screens based on controller state.

The implementation adapts the design specification's raw `Console.Write`/`ITerminalService` approach to Spectre.Console's blocking-prompt model (which all existing TUI views already use). The `ICreationScreen` interface is simplified from four methods to one (`DisplayAsync`) since Spectre.Console prompts handle rendering and input internally.

---

## Added

### Presentation Layer — Screens

#### Interface & Types

- **`ICreationScreen`** (`Screens/ICreationScreen.cs`)
    - Interface with `Step` property (`CharacterCreationStep`) and `DisplayAsync(viewModel, console, ct)` method
    - `ScreenResult` readonly record struct: `Action` (ScreenAction), `Selection` (object?)
    - Factory methods: `Selected(object)`, `GoBack()`, `Cancel()`
    - `ScreenAction` enum: `Continue` (0), `GoBack` (1), `Cancel` (2)
    - `ToString()` override for debugging

#### Step Screens

- **`LineageScreen`** (`Screens/LineageScreen.cs`)
    - Step 1: Lineage selection with 4 options (Clan-Born, Rune-Marked, Iron-Blooded, Vargr-Kin)
    - Detail table: attribute modifiers, passive bonuses, unique trait, trauma baseline
    - Clan-Born sub-prompt for flexible attribute bonus (+1 to any core attribute)
    - Dependencies: `ILineageProvider`, `ILogger<LineageScreen>`
    - Returns `(Lineage, CoreAttribute?)` tuple in ScreenResult

- **`BackgroundScreen`** (`Screens/BackgroundScreen.cs`)
    - Step 2: Background selection with 6 options
    - Detail table: tagline, skill grants (name + bonus), starting equipment preview
    - Dependencies: `IBackgroundProvider`, `ILogger<BackgroundScreen>`
    - Returns `Background` enum in ScreenResult

- **`AttributeScreen`** (`Screens/AttributeScreen.cs`)
    - Step 3: Attribute allocation with Simple/Advanced modes
    - Simple mode: `SelectionPrompt` with recommended builds from `IArchetypeProvider`
    - Advanced mode: interactive point-buy loop — increase/decrease per attribute, derived stats preview
    - Point cost logic: values 2-8 cost 1pt, values 9-10 cost 2pt each
    - Constants: MinAttributeValue=1, MaxAttributeValue=10, ExpensiveThreshold=8, StandardPointPool=15
    - Dependencies: `IArchetypeProvider`, `IViewModelBuilder`, `ILogger<AttributeScreen>`
    - Returns `AttributeAllocationState` in ScreenResult

- **`ArchetypeScreen`** (`Screens/ArchetypeScreen.cs`)
    - Step 4: Archetype selection with 4 options (Warrior, Skirmisher, Mystic, Adept)
    - PERMANENT choice — confirmation sub-prompt required
    - Detail table: role description, resource bonuses, starting abilities
    - Dependencies: `IArchetypeProvider`, `ILogger<ArchetypeScreen>`
    - Returns `Archetype` enum in ScreenResult

- **`SpecializationScreen`** (`Screens/SpecializationScreen.cs`)
    - Step 5: Specialization selection filtered by archetype
    - Detail table: path type (Coherent/Heretical), tagline, special resource
    - Heretical warning panel with confirmation prompt for Corruption risk
    - Dependencies: `ISpecializationProvider`, `ICharacterCreationController`, `ILogger<SpecializationScreen>`
    - Returns `SpecializationId` enum in ScreenResult

- **`SummaryScreen`** (`Screens/SummaryScreen.cs`)
    - Step 6: Full character summary, name input, and final confirmation
    - Renders: selections summary, derived stats preview, abilities list, equipment preview
    - `TextPrompt<string>` for name entry with `INameValidator` validation loop
    - Suggestion support: accepts sanitized name from validator
    - Final prompt: "Confirm & Begin Saga" / "Go Back" / "Cancel"
    - Dependencies: `INameValidator`, `ILogger<SummaryScreen>`
    - Returns character name string in ScreenResult

### Presentation Layer — Components

- **`StepHeaderRenderer`** (`Components/StepHeaderRenderer.cs`)
    - Static class: `Render(IAnsiConsole, CharacterCreationViewModel)`
    - Renders step number/title as Spectre `Rule`, description as markup
    - Permanent choice warning as yellow `Panel` when `IsPermanentChoice` is true
    - `RenderProgress(IAnsiConsole, CharacterCreationViewModel)`: filled/empty step indicators

- **`OptionListRenderer`** (`Components/OptionListRenderer.cs`)
    - Static class: `CreatePrompt(title, choices, canGoBack)` builds `SelectionPrompt<string>`
    - Navigation constants: `BackChoice` ("< Back"), `CancelChoice` ("Cancel Creation")
    - `TryParseNavigation(selection)`: maps navigation choices to `ScreenResult?`
    - `IsBack(string)` / `IsCancel(string)`: string matching helpers
    - `RenderValidationErrors(IAnsiConsole, IReadOnlyList<string>?)`: error display

### Presentation Layer — Views

- **`CreationWizardView`** (`Views/CreationWizardView.cs`)
    - Orchestrator driving the six-step wizard workflow
    - `Dictionary<CharacterCreationStep, ICreationScreen>` for O(1) screen routing
    - `RunAsync(CancellationToken)`: Initialize → loop (get state → route → display → process)
    - Cancel: calls `controller.Cancel()`, returns null
    - GoBack: calls `controller.GoBack()`, continues loop
    - Continue: routes to `ProcessSelectionAsync` by step type
    - Summary step: `ConfirmCharacterAsync(name)` returns Player entity
    - Dependencies: `ICharacterCreationController`, `IEnumerable<ICreationScreen>`, `IAnsiConsole`, `ILogger<CreationWizardView>`

### Unit Tests

- **`CreationScreenTests`** (`Screens/CreationScreenTests.cs`) — 56 test methods
    - **ScreenResult Factory (9 methods):** Selected/GoBack/Cancel action values, selection preservation (Archetype, tuple, AttributeAllocationState, string), ToString output
    - **ScreenAction Enum (3 methods):** Continue=0, GoBack=1, Cancel=2
    - **OptionListRenderer (10 methods):** BackChoice/CancelChoice constants, IsBack/IsCancel matching, TryParseNavigation (back/cancel/content), RenderValidationErrors (null/empty/with errors), CreatePrompt (with/without back)
    - **StepHeaderRenderer (5 methods):** Step number + title, description rendering, permanent warning presence/absence, progress indicators
    - **CreationWizardView (7 methods):** Constructor null validation (controller/screens/console), empty screens exception, Cancel returns null, GoBack calls controller.GoBack(), Initialize called
    - **AttributeAllocationState (4 methods):** CreateAdvancedDefault values, WithAttributeValue mutation, CreateFromRecommendedBuild, SwitchToAdvanced mode
    - **Screen Step Properties (6 methods):** Each screen returns correct CharacterCreationStep
    - **Constructor Null Guards (8 methods):** ArgumentNullException for all screen constructors
    - **SummaryScreen (4 methods):** Constructor null guard, Step property, constructor + step for NameValidator

### Glossary

- **`config/glossary.json`** — Added 6 glossary entries (sortOrder 66-71)
    - `creation-screen-interface`: ICreationScreen interface for step screen contracts
    - `creation-wizard-view`: Orchestrator view for the character creation wizard
    - `step-header-renderer`: Shared component for step header rendering
    - `option-list-renderer`: Shared component for selection prompt building
    - `screen-result`: Value object for screen display outcomes
    - `screen-action`: Enum for screen navigation actions

---

## Changed

### Documentation

- **`docs/design/v0.17.x/v0.17.5-scope-breakdown.md`** — Checked off v0.17.5f test item
    - `[x] TUI screens render correctly for all steps`

- **`docs/design/v0.17.x/v0.17.x-overview.md`** — Checked off v0.17.5f deliverable
    - `[x] TUI screens for all 6 steps`

---

## Design Decisions

### Spectre.Console Instead of Raw Console

The design specification uses `Console.WriteLine`, `Console.ReadKey`, and `ITerminalService.WriteLineAt` for rendering. The implementation uses **Spectre.Console** (`IAnsiConsole`, `SelectionPrompt<T>`, `Table`, `Panel`, `Rule`, `MarkupLine`) because all existing TUI views in the codebase use Spectre.Console. `ITerminalService` is a low-level abstraction not used by any view.

| Aspect | Design Spec | Implementation | Reason |
|---|---|---|---|
| Rendering | `Console.WriteLine`, `ITerminalService.WriteLineAt` | `IAnsiConsole`, `Panel`, `Table`, `Rule`, `MarkupLine` | Codebase standard |
| Input | `Console.ReadKey` + per-keystroke loop | `SelectionPrompt<T>`, `TextPrompt<string>` | Spectre handles navigation internally |
| Navigation | Arrow/number key handlers per screen | "< Back" and "Cancel" as selectable prompt choices | Spectre owns the input loop |

### Simplified ICreationScreen Interface

The design specification defines 4 methods on `ICreationScreen`: `Render()`, `HandleInput()`, `GetSelection()`, `Reset()`. The implementation uses a single `DisplayAsync()` method returning `ScreenResult`, because Spectre.Console prompts are blocking — render, input, and selection retrieval all happen in one call. `Reset()` is unnecessary because each `DisplayAsync()` call starts fresh.

### Provider Interfaces in Application Layer

All provider interfaces (`ILineageProvider`, `IBackgroundProvider`, `IArchetypeProvider`, `ISpecializationProvider`) are in `RuneAndRust.Application.Interfaces`, not `RuneAndRust.Domain.Interfaces`. The screens use `using RuneAndRust.Application.Interfaces;`.

### BackgroundSkillGrant.BonusAmount (Not BonusValue)

The `BackgroundSkillGrant` record struct uses `BonusAmount` as its bonus property, not `BonusValue` as initially referenced. Corrected during the build phase.

### LineageTrait Is a Value Type

`LineageTrait` is a `readonly record struct` (value type), not a reference type. It uses `TraitName` as its property name, not `DisplayName`. Null-conditional access (`trait?.DisplayName`) was replaced with `!string.IsNullOrEmpty(trait.TraitName)`.

### Spectre.Console AddChoices() Fluent Chain Break

`SelectionPrompt<T>.AddChoices(IEnumerable)` returns `ISelectionItem<T>`, not `SelectionPrompt<T>`. This prevents chaining `.AddChoice()` after `.AddChoices()`. The implementation uses separate statements: `prompt.AddChoices(choices); prompt.AddChoice(BackChoice);`.

### DerivedStatsPreview Property Names

The design specification references `MaxHealth` and `MaxAetherPool` on the derived stats preview. The actual properties are `MaxHp` and `MaxAp`.

### AttributeAllocationState API

The design specification uses `Increase()`/`Decrease()` methods and `CreateDefault()`. The actual API uses `WithAttributeValue(CoreAttribute, int newValue, int pointDelta)` and `CreateAdvancedDefault(int totalPoints)`.

---

## Dependencies

### Prerequisites

| Type | Phase | Usage |
| --- | --- | --- |
| `CharacterCreationState` | v0.17.5a | State routing in wizard loop |
| `CharacterCreationViewModel` | v0.17.5b | ViewModel passed to screens |
| `CharacterCreationController` | v0.17.5d | Wizard loop orchestration |
| `INameValidator` | v0.17.5c | SummaryScreen name validation |
| `IViewModelBuilder` | v0.17.5b | AttributeScreen derived stats preview |
| `AttributeAllocationState` | v0.17.1 | Point-buy allocation logic |
| `StepResult` | v0.17.5a | Controller response processing |
| `CharacterCreationResult` | v0.17.5d | Summary confirmation result |
| `ILineageProvider` | v0.17.0 | LineageScreen data |
| `IBackgroundProvider` | v0.17.1 | BackgroundScreen data |
| `IArchetypeProvider` | v0.17.3 | ArchetypeScreen + AttributeScreen data |
| `ISpecializationProvider` | v0.17.4 | SpecializationScreen data |
| `Spectre.Console` | External | All rendering and input |
| `Spectre.Console.Testing` | External (test) | TestConsole for component tests |

### Provides to Future Phases

| Type | Phase | Usage |
| --- | --- | --- |
| `CreationWizardView` | v0.17.5g | DI registration and startup wiring |
| `ICreationScreen` implementations | v0.17.5g | Registered in DI container |

---

## Logging Strategy

| Level | When |
|---|---|
| Debug | Screen initialized (per screen) |
| Debug | Displaying step screen (per screen) |
| Debug | Selection made (per screen, selection value) |
| Debug | Navigation action (GoBack/Cancel) |
| Debug | Clan-Born flexible bonus prompt displayed/cancelled |
| Debug | Heretical specialization warning shown/declined |
| Debug | Wizard loop: current step |
| Debug | Screen result (step, action, hasSelection) |
| Debug | GoBack result (success, currentStep) |
| Debug | Selection processing (step, selectionType) |
| Debug | Validation errors on re-display |
| Debug | Registered screen for step (per screen type) |
| Debug | Controller initialized (startingStep, sessionId) |
| Information | Starting character creation wizard |
| Information | Lineage/Background/Archetype/Specialization selected |
| Information | Archetype selected (PERMANENT) |
| Information | Character creation completed (playerName) |
| Information | Player cancelled at step |
| Information | Cancelled via cancellation token |
| Warning | Invalid selection index |
| Warning | No archetype selected (specialization screen) |
| Warning | Unknown ScreenAction |
| Error | No screen registered for step |

All logging uses structured format with `{Named}` parameters.

---

## Files Created

| Path | Description |
|------|-------------|
| `src/Presentation/RuneAndRust.Presentation.Tui/Screens/ICreationScreen.cs` | Interface, ScreenResult, and ScreenAction types |
| `src/Presentation/RuneAndRust.Presentation.Tui/Components/StepHeaderRenderer.cs` | Step header rendering component |
| `src/Presentation/RuneAndRust.Presentation.Tui/Components/OptionListRenderer.cs` | Selection prompt building component |
| `src/Presentation/RuneAndRust.Presentation.Tui/Screens/LineageScreen.cs` | Step 1: Lineage selection |
| `src/Presentation/RuneAndRust.Presentation.Tui/Screens/BackgroundScreen.cs` | Step 2: Background selection |
| `src/Presentation/RuneAndRust.Presentation.Tui/Screens/AttributeScreen.cs` | Step 3: Attribute allocation (Simple/Advanced) |
| `src/Presentation/RuneAndRust.Presentation.Tui/Screens/ArchetypeScreen.cs` | Step 4: Archetype selection (permanent) |
| `src/Presentation/RuneAndRust.Presentation.Tui/Screens/SpecializationScreen.cs` | Step 5: Specialization selection |
| `src/Presentation/RuneAndRust.Presentation.Tui/Screens/SummaryScreen.cs` | Step 6: Summary, name, and confirmation |
| `src/Presentation/RuneAndRust.Presentation.Tui/Views/CreationWizardView.cs` | Wizard orchestrator |
| `tests/RuneAndRust.Presentation.Tui.UnitTests/Screens/CreationScreenTests.cs` | 56 unit tests |
| `changelogs/v0.17.5f-changelog.md` | This changelog |

## Files Modified

| Path | Description |
|------|-------------|
| `config/glossary.json` | Added 6 glossary entries (sortOrder 66-71) |
| `tests/RuneAndRust.Presentation.Tui.UnitTests/RuneAndRust.Presentation.Tui.UnitTests.csproj` | Added Spectre.Console.Testing package reference |
| `docs/design/v0.17.x/v0.17.5-scope-breakdown.md` | Checked off TUI screens test item |
| `docs/design/v0.17.x/v0.17.x-overview.md` | Checked off TUI screens deliverable |

---

## Notes

- Total unit tests for v0.17.5f: 56 test methods (design spec estimated ~20)
- Build: 0 errors, 0 warnings
- The design specification had 8+ API discrepancies with the actual codebase (see Design Decisions above)
- `Spectre.Console.Testing` v0.50.0 added to test project for `TestConsole` usage in component tests
- Pre-existing broken `BossHealthBarTests.cs` (references removed `BossHealthBar` class from v0.13.1a) temporarily renamed to `.bak`
- All new files follow established codebase patterns: `═══════` section separators, file headers with Version tag, comprehensive XML documentation, exhaustive structured logging
