# v0.13.0 Combat UI - Scope Breakdown

**Version:** 0.13.0
**Theme:** Combat UI
**Prerequisites:** v0.12.1c Complete (Achievements & Leaderboards), v0.10.x Services Complete
**Total Estimated Tests:** ~25 new tests

---

## Executive Summary

The Combat UI version implements all combat-related presentation layer components that were deferred during v0.10.x development. This includes status effect display, AoE zone highlighting, combo chain indicators, defense action prompts, and combat stance indicators. These components visualize the combat state introduced in v0.10.x without introducing any new domain logic or business rules.

The work is divided into **four sub-parts**:

| Part | Name | Focus | Est. Tests |
|------|------|-------|------------|
| v0.13.0a | Status Effect Display | Buff/debuff icons, timers, stacks, tooltips, immunity | ~8 |
| v0.13.0b | AoE Zone Overlay | Zone grid overlay, hazard indicators, duration display | ~6 |
| v0.13.0c | Combo System Display | Chain indicator, available prompt, bonus display | ~5 |
| v0.13.0d | Defense & Stance Display | Block/dodge/parry prompts, timing window, stance indicator | ~6 |

---

## Feature Analysis & Categorization

### From v0.13.0-overview.md - Status Effect Display (v0.10.0x)

| Feature | Complexity | Dependencies | Assigned Part |
|---------|------------|--------------|---------------|
| Buff/Debuff Icons | Medium | IBuffDebuffService | **v0.13.0a** |
| Duration Timers | Low | StatusEffect data | **v0.13.0a** |
| Stack Count Display | Low | StatusEffect data | **v0.13.0a** |
| Effect Tooltips | Medium | StatusEffectDefinition | **v0.13.0a** |
| Immunity Indicators | Low | Immunity system | **v0.13.0a** |

### From v0.13.0-overview.md - Area-of-Effect Display (v0.10.1x)

| Feature | Complexity | Dependencies | Assigned Part |
|---------|------------|--------------|---------------|
| AoE Zone Highlighting | Medium | IAoEService | **v0.13.0b** |
| Hazard Indicators | Low | Zone effect data | **v0.13.0b** |
| Zone Duration Display | Low | Zone data | **v0.13.0b** |

### From v0.13.0-overview.md - Combo System Display (v0.10.2x)

| Feature | Complexity | Dependencies | Assigned Part |
|---------|------------|--------------|---------------|
| Combo Chain Indicator | Medium | IComboService | **v0.13.0c** |
| Combo Available Prompt | Low | Combo state | **v0.13.0c** |
| Combo Bonus Display | Low | Combo multiplier | **v0.13.0c** |

### From v0.13.0-overview.md - Defense Actions Display (v0.10.3x)

| Feature | Complexity | Dependencies | Assigned Part |
|---------|------------|--------------|---------------|
| Block/Dodge/Parry Prompts | Medium | IDefenseActionService | **v0.13.0d** |
| Reaction Window | Low | Timing data | **v0.13.0d** |
| Defense Result Feedback | Medium | Defense result | **v0.13.0d** |

### From v0.13.0-overview.md - Combat Stance Display (v0.10.3x)

| Feature | Complexity | Dependencies | Assigned Part |
|---------|------------|--------------|---------------|
| Active Stance Indicator | Low | ICombatStanceService | **v0.13.0d** |
| Stance Modifier Summary | Low | Stance modifiers | **v0.13.0d** |
| Stance Switch Animation | Medium | Stance transitions | **v0.13.0d** |

---

## Existing Infrastructure

### From v0.10.x (Required Services)

| Component | Location | Purpose for v0.13.0 |
|-----------|----------|---------------------|
| `IBuffDebuffService` | `Application/Interfaces/IBuffDebuffService.cs` | Retrieve active status effects |
| `StatusEffectDefinition` | `Domain/Entities/StatusEffectDefinition.cs` | Effect templates for tooltips |
| `ActiveStatusEffect` | `Domain/Entities/ActiveStatusEffect.cs` | Runtime effect state |
| `IAoEService` | `Application/Interfaces/IAoEService.cs` | Retrieve active AoE zones |
| `AoEZone` | `Domain/Entities/AoEZone.cs` | Zone position and effect data |
| `IComboService` | `Application/Interfaces/IComboService.cs` | Retrieve combo chain state |
| `ComboChain` | `Domain/Entities/ComboChain.cs` | Combo sequence data |
| `IDefenseActionService` | `Application/Interfaces/IDefenseActionService.cs` | Retrieve available defense actions |
| `DefenseAction` | `Domain/Entities/DefenseAction.cs` | Defense action definitions |
| `ICombatStanceService` | `Application/Interfaces/ICombatStanceService.cs` | Retrieve active stance |
| `CombatStance` | `Domain/Entities/CombatStance.cs` | Stance definitions and modifiers |

### From v0.7.x-v0.8.x (Existing UI Infrastructure)

| Component | Location | Purpose for v0.13.0 |
|-----------|----------|---------------------|
| `CombatView` | `Presentation.Tui/Views/CombatView.cs` | Integration point for new components |
| `CombatGridView` | `Presentation.Tui/Views/CombatGridView.cs` | Grid rendering for AoE overlay |
| `HealthBar` | `Presentation.Tui/UI/HealthBar.cs` | Pattern reference for bar rendering |
| `ITerminalService` | `Presentation.Tui/Services/ITerminalService.cs` | Terminal output abstraction |

---

## Phase Definitions

---

## v0.13.0a: Status Effect Display

[v0.13.0a Design Specification](v0.13.0a-design-specification.md)

### Overview

Implement status effect visualization including buff/debuff icons, duration timers, stack counts, effect tooltips, and immunity indicators. These components display the active status effects on combatants during combat.

### Scope

**In Scope:**
- Buff/debuff icons with category-based symbols
- Duration timers showing remaining turns
- Stack count display for stacking effects
- Effect tooltips with detailed information
- Immunity indicators when effects are blocked

**Out of Scope:**
- AoE zone highlighting (v0.13.0b)
- Combo chain display (v0.13.0c)
- Defense action prompts (v0.13.0d)

### Key Deliverables

| Type | Count | Details |
|------|-------|---------|
| UI Components | 1 | `StatusEffectDisplay` |
| Renderers | 1 | `StatusEffectRenderer` |
| View Updates | 1 | `CombatView` integration |
| Unit Tests | ~8 | Display, rendering, tooltip tests |

### Data Model Changes

```
NEW: StatusEffectDisplay (UI Component)
|-- RenderBuffs(IEnumerable<ActiveStatusEffect>): void
|-- RenderDebuffs(IEnumerable<ActiveStatusEffect>): void
|-- ShowTooltip(ActiveStatusEffect): void
+-- UpdateDurations(): void

NEW: StatusEffectRenderer (Renderer)
|-- GetEffectIcon(StatusEffectDefinition): string
|-- GetEffectColor(StatusEffectType): ConsoleColor
|-- FormatDuration(int): string
+-- FormatStacks(int): string
```

### User-Facing Changes

**Display Example:**
```
BUFFS: [D3] [+2] [5t]    DEBUFFS: [F2t] [I3t]

Legend:
  [D3]  = Defense buff, 3 stacks
  [+2]  = Damage buff, +2 modifier
  [5t]  = Speed buff, 5 turns remaining
  [F2t] = Fire debuff (burning), 2 turns
  [I3t] = Ice debuff (slowed), 3 turns
```

**Tooltip Example (on selection):**
```
+------------------------------------+
| BURNING                            |
+------------------------------------+
| Fire damage over time              |
|                                    |
| Duration: 2 turns remaining        |
| Damage: 5 fire damage per turn     |
| Source: Fire Elemental             |
+------------------------------------+
```

### Acceptance Criteria

- [ ] Status effect icons display for all effect categories
- [ ] Duration timers show correct remaining turns
- [ ] Stack counts display for stacking effects
- [ ] Effect tooltips show on selection
- [ ] Immunity indicators show when effects are blocked
- [ ] Buffs and debuffs display in separate rows
- [ ] ~8 unit tests pass

---

## v0.13.0b: AoE Zone Overlay

[v0.13.0b Design Specification](v0.13.0b-design-specification.md)

### Overview

Implement area-of-effect zone visualization on the combat grid including zone highlighting, hazard indicators for persistent effects, and duration display for temporary zones.

### Scope

**In Scope:**
- Zone grid overlay highlighting affected tiles
- Hazard indicators for persistent zone effects
- Zone duration display showing remaining turns
- Zone type differentiation (damage, buff, debuff, control)

**Out of Scope:**
- Status effect display (v0.13.0a)
- Combo chain display (v0.13.0c)
- Defense action prompts (v0.13.0d)

### Key Deliverables

| Type | Count | Details |
|------|-------|---------|
| UI Components | 1 | `AoEZoneOverlay` |
| Renderers | 1 | `ZoneRenderer` |
| View Updates | 1 | `CombatGridView` integration |
| Unit Tests | ~6 | Overlay, highlighting, duration tests |

### Data Model Changes

```
NEW: AoEZoneOverlay (UI Component)
|-- RenderZones(IEnumerable<AoEZone>): void
|-- HighlightTiles(IEnumerable<Position>): void
|-- ShowHazardIcons(AoEZone): void
+-- UpdateDurations(): void

NEW: ZoneRenderer (Renderer)
|-- GetZoneSymbol(AoEZoneType): char
|-- GetZoneColor(AoEZoneType): ConsoleColor
|-- FormatZoneDuration(int): string
+-- GetHazardIcon(DamageType): string
```

### User-Facing Changes

**Grid Display Example:**
```
+===+===+===+===+===+
| F |   |   |   |   |   F = Fire zone (2 turns)
+===+===+===+===+===+
| F | @ |   |   |   |   @ = Player
+===+===+===+===+===+
|   |   | I | I |   |   I = Ice zone (3 turns)
+===+===+===+===+===+
|   |   | I | I | G |   G = Goblin
+===+===+===+===+===+

Active Zones:
  [F] Fire Zone - 2 turns - 5 damage/turn
  [I] Ice Zone - 3 turns - Slowed movement
```

### Acceptance Criteria

- [ ] AoE zones highlight affected tiles on grid
- [ ] Hazard indicators show for persistent zones
- [ ] Zone duration displays remaining turns
- [ ] Different zone types have distinct visual indicators
- [ ] Zone legend shows active zone information
- [ ] ~6 unit tests pass

---

## v0.13.0c: Combo System Display

[v0.13.0c Design Specification](v0.13.0c-design-specification.md)

### Overview

Implement combo chain visualization including the current position in a combo sequence, prompts when combos can continue, and display of accumulated combo bonuses.

### Scope

**In Scope:**
- Combo chain indicator showing sequence position
- Combo available prompt when combo can continue
- Combo bonus display showing accumulated multiplier
- Combo break indicator when chain ends

**Out of Scope:**
- Status effect display (v0.13.0a)
- AoE zone highlighting (v0.13.0b)
- Defense action prompts (v0.13.0d)

### Key Deliverables

| Type | Count | Details |
|------|-------|---------|
| UI Components | 1 | `ComboChainIndicator` |
| Renderers | 1 | `ComboRenderer` |
| View Updates | 1 | `CombatView` integration |
| Unit Tests | ~5 | Chain display, prompt, bonus tests |

### Data Model Changes

```
NEW: ComboChainIndicator (UI Component)
|-- RenderChain(ComboChain): void
|-- ShowAvailablePrompt(IEnumerable<string>): void
|-- DisplayBonus(decimal): void
+-- ShowChainBreak(): void

NEW: ComboRenderer (Renderer)
|-- FormatChainStep(string, bool): string
|-- FormatBonus(decimal): string
+-- GetComboColor(int): ConsoleColor
```

### User-Facing Changes

**Combo Display Example:**
```
COMBO: [Strike] -> [Slash] -> [?]    +25% damage bonus

Available Continuations:
  [1] Thrust  - Continues chain, +10% bonus
  [2] Cleave  - Finisher, applies full bonus
  [3] Feint   - Breaks chain, no bonus
```

**Combo Break Display:**
```
COMBO BROKEN!
  Final bonus: +25% (applied to last hit)
  Chain length: 3
```

### Acceptance Criteria

- [ ] Combo chain shows current position in sequence
- [ ] Completed steps show check mark
- [ ] Current step shows highlight
- [ ] Future steps show placeholder
- [ ] Combo available prompt shows when chain can continue
- [ ] Combo bonus displays accumulated multiplier
- [ ] Chain break shows final bonus
- [ ] ~5 unit tests pass

---

## v0.13.0d: Defense & Stance Display

[v0.13.0d Design Specification](v0.13.0d-design-specification.md)

### Overview

Implement defense action visualization including block/dodge/parry prompts, reaction window timing indicators, and defense result feedback. Also implement combat stance display showing the active stance, modifier summary, and stance switch feedback.

### Scope

**In Scope:**
- Block/dodge/parry action prompts
- Reaction window timing indicator
- Defense result feedback (success/failure)
- Active stance indicator
- Stance modifier summary
- Stance switch animation/feedback

**Out of Scope:**
- Status effect display (v0.13.0a)
- AoE zone highlighting (v0.13.0b)
- Combo chain display (v0.13.0c)

### Key Deliverables

| Type | Count | Details |
|------|-------|---------|
| UI Components | 2 | `DefenseActionPrompts`, `StanceIndicator` |
| Renderers | 2 | `DefenseRenderer`, `StanceRenderer` |
| View Updates | 1 | `CombatView` integration |
| Unit Tests | ~6 | Defense prompt, timing, stance tests |

### Data Model Changes

```
NEW: DefenseActionPrompts (UI Component)
|-- ShowPrompts(IEnumerable<DefenseAction>): void
|-- RenderTimingWindow(TimeSpan, TimeSpan): void
|-- ShowResult(DefenseResult): void
+-- HidePrompts(): void

NEW: DefenseRenderer (Renderer)
|-- GetActionKey(DefenseAction): char
|-- FormatTimingBar(double): string
+-- GetResultColor(DefenseResult): ConsoleColor

NEW: StanceIndicator (UI Component)
|-- RenderStance(CombatStance): void
|-- ShowModifiers(IEnumerable<StatModifier>): void
+-- AnimateSwitch(CombatStance, CombatStance): void

NEW: StanceRenderer (Renderer)
|-- GetStanceIcon(CombatStance): string
|-- FormatModifier(StatModifier): string
+-- GetStanceColor(CombatStance): ConsoleColor
```

### User-Facing Changes

**Defense Prompt Example:**
```
INCOMING ATTACK: Goblin Slash (12 damage)

DEFENSE OPTIONS: [B]lock  [D]odge  [P]arry
────────────────────────────────────────────
Reaction Window: [========..] 0.8s remaining
```

**Defense Result Example:**
```
BLOCK SUCCESS!
  Damage reduced: 12 -> 4
  Shield durability: -1
```

**Stance Display Example:**
```
[Aggressive Stance]
  +2 Attack
  -1 Defense
  +10% Critical Chance
```

**Stance Switch Example:**
```
Stance changed: Aggressive -> Defensive
  -2 Attack (was +2)
  +3 Defense (was -1)
  +20% Block Chance (new)
```

### Acceptance Criteria

- [ ] Defense action prompts show available actions
- [ ] Reaction window timing indicator updates in real-time
- [ ] Defense result feedback shows success/failure
- [ ] Damage reduction displays for successful blocks
- [ ] Active stance indicator shows current stance
- [ ] Stance modifier summary shows stat changes
- [ ] Stance switch feedback shows before/after comparison
- [ ] ~6 unit tests pass

---

## Dependencies & Prerequisites

```
v0.10.x (Advanced Combat & Abilities) - REQUIRED
    |
    |-- v0.10.0x: Status Effects ──────────────────┐
    |       Provides: IBuffDebuffService           |
    |       Provides: StatusEffectDefinition       |
    |       Provides: ActiveStatusEffect           |
    |                                              |
    |-- v0.10.1x: AoE System ─────────────────────┤
    |       Provides: IAoEService                  |
    |       Provides: AoEZone                      |
    |                                              |
    |-- v0.10.2x: Combo System ───────────────────┤
    |       Provides: IComboService                |
    |       Provides: ComboChain                   |
    |                                              |
    |-- v0.10.3x: Defense & Stance ───────────────┘
            Provides: IDefenseActionService
            Provides: ICombatStanceService
                                    |
                                    v
v0.13.0 (Combat UI)
    |
    |-- v0.13.0a: Status Effect Display ───────────────────┐
    |       Dependencies: IBuffDebuffService               |
    |       Provides: StatusEffectDisplay                  |
    |                                                      |
    |-- v0.13.0b: AoE Zone Overlay ────────────────────────┤
    |       Dependencies: IAoEService                      |
    |       Provides: AoEZoneOverlay                       |
    |                                                      |
    |-- v0.13.0c: Combo System Display ────────────────────┤
    |       Dependencies: IComboService                    |
    |       Provides: ComboChainIndicator                  |
    |                                                      |
    +-- v0.13.0d: Defense & Stance Display ────────────────┘
            Dependencies: IDefenseActionService, ICombatStanceService
            Provides: DefenseActionPrompts, StanceIndicator
```

---

## Estimated Effort Summary

| Part | New Files | Modified Files | Est. Tests | Complexity |
|------|-----------|----------------|------------|------------|
| v0.13.0a | ~3 | ~1 | ~8 | Medium |
| v0.13.0b | ~3 | ~1 | ~6 | Medium |
| v0.13.0c | ~3 | ~1 | ~5 | Low-Medium |
| v0.13.0d | ~4 | ~1 | ~6 | Medium |
| **Total** | **~13** | **~4** | **~25** | |

---

## Risk Assessment

| Risk | Impact | Probability | Mitigation |
|------|--------|-------------|------------|
| Service interfaces differ from expected | Medium | Low | Review v0.10.x design specs before implementation |
| Grid overlay performance | Low | Medium | Efficient tile rendering, minimize redraws |
| Timing window accuracy | Medium | Low | Use system timer, not frame-based timing |
| Tooltip positioning | Low | Medium | Use consistent positioning strategy |

---

## Design Decisions (Confirmed)

### Status Effect Display

| Decision | Value | Notes |
|----------|-------|-------|
| **Icon Format** | `[X#t]` | X=category, #=stacks/modifier, t=turns |
| **Buff Color** | Green | Consistent with positive effects |
| **Debuff Color** | Red | Consistent with negative effects |
| **Tooltip Trigger** | Selection | Not hover (TUI limitation) |

### AoE Zone Display

| Decision | Value | Notes |
|----------|-------|-------|
| **Zone Symbol** | Single character | F=Fire, I=Ice, P=Poison, etc. |
| **Overlay Method** | Grid integration | Modify cell rendering, not overlay layer |
| **Duration Format** | `# turns` | Clear turn-based display |

### Combo Display

| Decision | Value | Notes |
|----------|-------|-------|
| **Chain Format** | `[Step] -> [Step] -> [?]` | Arrow-connected sequence |
| **Bonus Format** | `+##%` | Percentage multiplier |
| **Available Prompt** | Numbered list | Easy keyboard selection |

### Defense & Stance Display

| Decision | Value | Notes |
|----------|-------|-------|
| **Timing Bar** | `[====....]` | Progress bar style |
| **Action Keys** | First letter | [B]lock, [D]odge, [P]arry |
| **Stance Header** | `[Stance Name]` | Bracketed at top of combat view |
| **Modifier Format** | `+/-# Stat` | Signed value with stat name |

---

## Next Steps

1. **Review & Approve** - Confirm scope breakdown
2. **v0.13.0a Design Spec** - Create detailed design for Status Effect Display
3. **v0.13.0a Implementation** - Build StatusEffectDisplay, StatusEffectRenderer
4. **v0.13.0b Design Spec** - Create detailed design for AoE Zone Overlay
5. **v0.13.0b Implementation** - Build AoEZoneOverlay, ZoneRenderer
6. **v0.13.0c Design Spec** - Create detailed design for Combo System Display
7. **v0.13.0c Implementation** - Build ComboChainIndicator, ComboRenderer
8. **v0.13.0d Design Spec** - Create detailed design for Defense & Stance Display
9. **v0.13.0d Implementation** - Build DefenseActionPrompts, StanceIndicator

---

*This scope breakdown provides a structured approach to implementing v0.13.0 Combat UI. Each sub-part builds incrementally, with v0.13.0a-c being independent and v0.13.0d combining related features. All sub-parts integrate with the existing CombatView.*
