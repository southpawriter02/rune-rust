> **Archived** - This plan has been consolidated. See the complete version at [v0.3.17](../v0.3.x/v0.3.17.md).

Here is the comprehensive implementation plan for v0.3.17a: The Console (Overlay UI).
This sub-version establishes the "Quake-style" developer console infrastructure. It focuses strictly on the UI presentation, state management, and input interception required to have a toggleable overlay. The actual execution of cheat commands (God Mode, Teleport) will be implemented in v0.3.17b.

v0.3.17a: The Console (Overlay UI)
Goal: Implement DebugConsoleService and DebugOverlayRenderer to provide a toggleable, scrolling log window that intercepts keyboard input when active, allowing developers to type commands without triggering game actions.

1. Architecture & Data Flow
The Input Interceptor Pattern The Debug Console acts as a "Man-in-the-Middle" for the Input Handler.
	1	Input: User presses a key.
	2	Global Check: TerminalInputHandler checks if the key is ~ (OemTilde).
	◦	If True: Toggle DebugConsoleService.IsVisible. Consume input.
	3	State Gate:
	◦	If IsVisible == True: Route input string building to DebugConsoleService. Do not pass to GameLoop.
	◦	If IsVisible == False: Pass input to standard GameLoop logic.
	4	Rendering:
	◦	GameLoop renders the standard screen (Exploration/Combat).
	◦	If IsVisible, DebugOverlayRenderer renders a Panel over the bottom 30% of the buffer.

2. Logic Decision Trees
A. Input Routing Logic Input: ConsoleKeyInfo
	1	Is Key ~?
	◦	Toggle IsVisible.
	◦	Clear current input buffer.
	◦	Return.
	2	Is Console Visible?
	◦	Yes:
	▪	Is Key Enter? -> Submit Command string to Log (and later Execution). Clear Buffer.
	▪	Is Key Backspace? -> Remove last char.
	▪	Else -> Append char to Command Buffer.
	◦	No:
	▪	Return Key to Standard Game Loop.
B. Log Buffer Logic Input: New Log Message
	1	Add: Append message to LogHistory list.
	2	Check Capacity: Is Count > MaxHistory (e.g., 50)?
	◦	Yes: RemoveAt(0) (Oldest).
	3	Render: UI updates to show latest N lines.

3. Deliverable Checklist
	•	Core:
	◦	[ ] Define IDebugConsoleService interface.
	◦	[ ] Define DebugLogEntry record (Timestamp, Message, Severity).
	•	Engine:
	◦	[ ] Implement DebugConsoleService: Handles visibility state, command history, and log buffer.
	•	Terminal:
	◦	[ ] Implement DebugOverlayRenderer: Spectre.Console panel rendering.
	◦	[ ] Update TerminalInputHandler: Add ~ interception logic.
	◦	[ ] Register services in Program.cs.
	•	Tests:
	◦	[ ] DebugConsoleTests: Verify buffer rotation and toggle state.

4. Code Implementation
A. Service Implementation (RuneAndRust.Engine/Services/DebugConsoleService.cs)
public class DebugConsoleService : IDebugConsoleService
{
    private const int MaxHistory = 50;
    private readonly List<string> _log = new();

    public bool IsVisible { get; private set; }
    public IReadOnlyList<string> Log => _log;

    public void Toggle() => IsVisible = !IsVisible;

    public void WriteLog(string message, string source = "System")
    {
        var entry = $"[{DateTime.Now:HH:mm:ss}] [{source}] {message}";
        _log.Add(entry);

        if (_log.Count > MaxHistory)
        {
            _log.RemoveAt(0);
        }
    }

    public void SubmitCommand(string command)
    {
        WriteLog(command, "User");
        // v0.3.17b: Parse and Execute command here
    }
}
B. Renderer Implementation (RuneAndRust.Terminal/Rendering/DebugOverlayRenderer.cs)
public static class DebugOverlayRenderer
{
    public static void Render(IDebugConsoleService console)
    {
        if (!console.IsVisible) return;

        // Take last 10 lines for display
        var visibleLogs = console.Log.TakeLast(10);
        var content = string.Join("\n", visibleLogs);

        var panel = new Panel(new Markup(content))
            .Header("[bold yellow]DEBUG CONSOLE (~ to close)[/]")
            .BorderColor(Color.Purple)
            .Expand();

        // Render at bottom of screen (requires live display management in GameLoop)
        AnsiConsole.Write(panel);
    }
}

5. Logging Requirements
This system generates its own user-facing logs, but internal operations should still be logged to Serilog for crash diagnosis.
System
Event
Level
Message Template
Properties
DebugConsole
Toggle
Trace
"[Debug] Console visibility set to {State}"
State
DebugConsole
Input
Debug
"[Debug] User submitted raw command: {Command}"
Command

6. Testing Strategy
Unit Tests (DebugConsoleTests.cs)
	•	Buffer_Rotation:
	◦	Action: Add 55 messages to a service with Max 50.
	◦	Assert: Count is 50. First message is the 6th one added.
	•	Toggle_State:
	◦	Action: Instantiate (Default False) -> Toggle() -> Toggle().
	◦	Assert: State transitions False -> True -> False.
Manual Integration Test:
	•	Scenario:
	1	Start Game.
	2	Press ~.
	3	Verify Purple Panel appears.
	4	Type "Test Command". Press Enter.
	5	Verify "Test Command" appears in the panel log.
	6	Press ~. Verify Panel disappears.
	7	Type standard game command (e.g., look). Verify game responds normally.

7. Draft Changelog (v0.3.17a)
# v0.3.17a Changelog: The Console
**Release Date:** 2026-03-08

## Summary
This release implements the visual infrastructure for the Developer Debug Tools. It adds a toggleable overlay console (accessed via `~`) that intercepts input, allowing developers and testers to enter commands without affecting the game state directly.

## New Features
*   **Debug Overlay:** Press `~` to toggle a scrolling log window at the bottom of the screen.
*   **Command History:** The console retains the last 50 entries for review.

## Technical Changes
*   Implemented `DebugConsoleService` for state and log management.
*   Updated `TerminalInputHandler` to intercept the tilde key globally.
*   Created `DebugOverlayRenderer` using Spectre.Console.