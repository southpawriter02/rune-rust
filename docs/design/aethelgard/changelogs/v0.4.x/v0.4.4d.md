# Changelog: v0.4.4d - The Paradox

**Release Date:** 2026-01-05

---

## Summary

Version 0.4.4d introduces the **Paradox System**, a Mystic-specific catastrophic backlash mechanic that activates when personal Resonance and environmental Flux exceed safe thresholds. This release implements a comprehensive risk-and-reward framework where Mystics dancing at the edge of Aetheric saturation can access devastating power through **Aetheric Overflow** but risk permanent soul damage through **Soul Fractures**. The system includes progressive risk tiers (20%-90%), severity-based consequences (Minor through Catastrophic), mastery-based mitigation, and permanent character degradation mechanics culminating in **Soul Death** at 10+ fractures. Implementation spans the Core Layer (15 new models/enums/events), Engine Layer (1 new service with 528 LOC), Terminal Layer (UI rendering), and comprehensive test coverage (68 unit tests, 100% pass rate).

Key architectural patterns include: Service interface abstraction (`IParadoxService`), event-driven consequence broadcasting (5 new event types), computed property pattern for penalties (`SoulFracturePenalties`), and state tracking for temporary buffs (`OverflowState`). The system integrates deeply with existing magic mechanics (`MagicService`, `BacklashService`, `MasteryService`) and extends the `Character` entity with permanent state tracking.

---

## New Files Created

### Core Layer

| File | Purpose |
|------|---------|
| `RuneAndRust.Core/Enums/ParadoxSeverity.cs` | Enum defining 5 severity tiers (None, Minor, Major, Severe, Catastrophic) with 8 extension methods for damage dice, status duration, corruption, resonance changes, and Soul Fracture triggers |
| `RuneAndRust.Core/Models/Magic/SoulFracture.cs` | Record tracking permanent soul damage instances with timestamp, source, and count. Includes factory methods for Overflow and Catastrophic Paradox sources |
| `RuneAndRust.Core/Models/Magic/SoulFracturePenalties.cs` | Computed penalty model providing WILL penalty (-1 at 3+ fractures, -2 at 6+), WITS penalty (-1 at 5+), max resonance capacity (100 - fractures), and trait flags |
| `RuneAndRust.Core/Models/Magic/OverflowState.cs` | State tracking for Aetheric Overflow with potency modifier (1.50 = +50%), AP cost modifier (0.50 = -50%), turn tracking, and discharge status. Includes temporal validation methods |
| `RuneAndRust.Core/Models/Magic/ParadoxResult.cs` | Result model containing triggered flag, severity, damage dealt, status duration, corruption gain, Soul Fracture flag, resonance change, reality tear flag, and overflow entry flag. Includes 5 factory methods for different outcomes |
| `RuneAndRust.Core/Models/Magic/DischargeResult.cs` | Result model for Overflow discharge outcomes containing success flag, damage (4d12), fracture gain, new totals, max resonance, and Soul Death flag. Includes 4 factory methods |
| `RuneAndRust.Core/Models/Magic/SoulFractureResult.cs` | Result model for Soul Fracture application containing fractures added, new totals, penalties, threshold crossing flags, and Soul Death detection. Includes penalty delta calculation |
| `RuneAndRust.Core/Events/ParadoxTriggeredEvent.cs` | Event published when Paradox occurs containing character ID, severity, damage, combined value, roll result, risk chance, and spell school. Includes computed properties for corruption and sickness duration |
| `RuneAndRust.Core/Events/OverflowEnteredEvent.cs` | Event published when Overflow state is entered containing character ID, turn number, potency bonus (1.50), and AP cost reduction (0.50). Includes bonus validation flags |
| `RuneAndRust.Core/Events/OverflowDischargeEvent.cs` | Event published when Overflow discharges containing character ID, damage dealt (4d12), fracture gain, new totals, and max resonance. Includes Soul Death detection property |
| `RuneAndRust.Core/Events/SoulFractureGainedEvent.cs` | Event published when Soul Fracture is gained containing character ID, source, fractures added, new total, max resonance, and penalties. Includes threshold crossing detection |
| `RuneAndRust.Core/Events/SoulDeathEvent.cs` | Event published when Soul Death occurs (10+ fractures) containing character ID, final fracture count, source, and final max resonance (always 0 or negative) |
| `RuneAndRust.Core/Interfaces/IParadoxService.cs` | Service interface defining 13 methods for Paradox checking, severity calculation, effect application, Overflow management, Soul Fracture tracking, and capacity queries |

### Engine Layer

| File | Purpose |
|------|---------|
| `RuneAndRust.Engine/Services/ParadoxService.cs` | Implementation of `IParadoxService` with 528 LOC. Manages Paradox checks with d100 rolls, severity calculation with mastery mitigation, Overflow state lifecycle, discharge processing (4d12 damage), Soul Fracture application with penalty tracking, and event publishing. Includes 3 private helper methods for base severity, reduction tiers, and avoidance chances |

### Terminal Layer

| File | Purpose |
|------|---------|
| `RuneAndRust.Terminal/Rendering/ParadoxDisplay.cs` | Static UI rendering helper with 313 LOC providing 9 methods for Paradox warning indicators (color-coded by risk), Overflow status widgets, Soul Fracture displays with penalties, Paradox result formatting, discharge result rendering, compact risk badges, and danger bar visualization. Uses Spectre.Console for rich formatting |

---

## Files Modified

| File | Change |
|------|--------|
| `RuneAndRust.Core/Entities/Character.cs` | Added Paradox System region (lines 333-390) with `OverflowState?` property, `SoulFractures` list, `IsSoulDead` flag, and 6 computed properties: `TotalSoulFractures`, `MaxResonanceCapacity` (100 - fractures), `SoulFractureWillPenalty` (-1 at 3+, -2 at 6+), `SoulFractureWitsPenalty` (-1 at 5+), `IsInOverflow` (checks OverflowState?.IsActive), `HasFracturedSoulTrait` (6+ fractures) |
| `RuneAndRust.Core/Enums/CastFailureReason.cs` | Added `SoulDeath = 13` (10+ Soul Fractures, character is Forlorn) and `Paradox = 14` (Paradox event interrupted spell) enum values with XML documentation |
| `RuneAndRust.Core/Models/Magic/MagicResult.cs` | Added 4 Paradox-related properties: `IsParadox` (bool), `ParadoxSeverity` (enum), `EnteredOverflow` (bool), `GainedSoulFracture` (bool). Added `ParadoxFailure()` and `OverflowEntered()` factory methods. Updated `Failure()` method with default messages for `SoulDeath` and `Paradox` failure reasons |
| `RuneAndRust.Engine/Services/MagicService.cs` | Registered `IParadoxService` dependency in constructor. Added Paradox check invocation after backlash processing in `CastSpell()` method. Added Overflow potency bonus application (+50%) when `character.IsInOverflow` is true in damage/healing calculations. Added Soul Death validation in `CanCast()` method returning `CastFailureReason.SoulDeath` if `character.IsSoulDead` is true |
| `RuneAndRust.Terminal/Program.cs` | Registered `IParadoxService` as singleton in DI container: `services.AddSingleton<IParadoxService, ParadoxService>()` |
| `RuneAndRust.Tests/Engine/Services/MagicServiceTests.cs` | Added `IParadoxService` mock to test fixture setup using `Substitute.For<IParadoxService>()`. Configured default mock behavior returning `ParadoxResult.NotApplicable()` for all test scenarios |

---

## Code Implementation Details

### ParadoxSeverity Enum (Core/Enums)

**Severity Levels:**
```csharp
public enum ParadoxSeverity
{
    None = 0,        // No Paradox
    Minor = 1,       // 1d6 damage, -10 resonance
    Major = 2,       // 2d8 damage, Aether Sickness (2 turns), -25 resonance
    Severe = 3,      // 3d10 damage, Aether Sickness (4 turns), +5 corruption, resonance reset
    Catastrophic = 4 // 4d12 damage, Aether Sickness (6 turns), +10 corruption, Soul Fracture, resonance reset
}
```

**Extension Methods (8 total):**

| Method | Return Type | Behavior |
|--------|-------------|----------|
| `GetDamageDice()` | `string` | Returns dice notation: "1d6", "2d8", "3d10", "4d12", "0" for None |
| `GetDamageRoll()` | `(int Count, int Sides)` | Returns tuple for dice rolling: (1,6), (2,8), (3,10), (4,12), (0,0) |
| `GetAetherSicknessDuration()` | `int` | Returns turns: 0 (None/Minor), 2 (Major), 4 (Severe), 6 (Catastrophic) |
| `GetCorruptionGain()` | `int` | Returns corruption points: 0 (None/Minor/Major), 5 (Severe), 10 (Catastrophic) |
| `CausesSoulFracture()` | `bool` | Returns true only for Catastrophic severity |
| `TriggersRealityTear()` | `bool` | Returns true only for Catastrophic severity |
| `GetResonanceChange()` | `int` | Returns delta: -10 (Minor), -25 (Major), -100 (Severe/Catastrophic for reset) |
| `ResetsResonance()` | `bool` | Returns true for Severe or Catastrophic |

**Constants:**
- Threshold for resonance reset: Severe (3) and Catastrophic (4)
- Soul Fracture threshold: Catastrophic (4) only
- Maximum severity: 4 (Catastrophic)

---

### SoulFracture Record (Core/Models/Magic)

**Properties:**
```csharp
public int Count { get; init; } = 1;                    // Fracture points (usually 1)
public DateTime Timestamp { get; init; } = DateTime.UtcNow;
public required string Source { get; init; }            // e.g., "Catastrophic Paradox"
```

**Factory Methods:**
- `FromOverflow()`: Creates fracture with source "Aetheric Overflow Discharge"
- `FromCatastrophicParadox()`: Creates fracture with source "Catastrophic Paradox"
- `FromSource(string source, int count = 1)`: Creates custom fracture

**Behavior:**
- Immutable record structure ensures fractures cannot be modified after creation
- Timestamp uses UTC for consistency across time zones
- Source field is required to enforce traceability

---

### SoulFracturePenalties Record (Core/Models/Magic)

**Computed Properties:**
```csharp
public int TotalFractures { get; init; }
public int MaxResonanceCapacity => Math.Max(0, 100 - TotalFractures);  // Clamped at 0
public int WillPenalty => TotalFractures switch                        // -1 at 3-5, -2 at 6+
{
    < 3 => 0,
    < 6 => -1,
    _ => -2
};
public int WitsPenalty => TotalFractures >= 5 ? -1 : 0;                // -1 at 5+
public bool IsSoulDeath => TotalFractures >= 10;                       // 10+ = Forlorn
public bool HasFracturedSoulTrait => TotalFractures >= 6;              // 6+ = trait
public bool HasAnyPenalty => WillPenalty != 0 || WitsPenalty != 0;
```

**Factory Methods:**
- `FromFractures(IEnumerable<SoulFracture>? fractures)`: Sums `Count` from collection, handles null
- `FromTotal(int totalFractures)`: Creates from total, clamps negative to 0
- `None`: Static property returning zero-penalty instance

**Thresholds:**
- 3 fractures: WILL penalty begins (-1)
- 5 fractures: WITS penalty begins (-1), WILL penalty still -1
- 6 fractures: WILL penalty increases (-2), "Fractured Soul" trait gained
- 10 fractures: Soul Death, character becomes Forlorn

---

### OverflowState Record (Core/Models/Magic)

**Properties:**
```csharp
public bool IsActive { get; init; }
public int TurnEntered { get; init; }
public decimal PotencyModifier { get; init; } = 1.50m;  // +50% potency
public decimal APCostModifier { get; init; } = 0.50m;   // -50% AP cost
public bool HasDischarged { get; init; }
```

**Methods:**
- `GetRemainingTurns(int currentTurn)`: Returns 1 if on entry turn and not discharged, else 0
- `ShouldDischarge(int currentTurn)`: Returns true if currentTurn > TurnEntered and not discharged
- `IsInPowerSurge(int currentTurn)`: Returns true if on entry turn, active, and not discharged
- `WithDischarged()`: Returns new instance with `HasDischarged = true`

**Factory Methods:**
- `Create(int currentTurn)`: Creates active state with bonuses
- `Inactive`: Static property returning inactive state with 1.00 modifiers

**Behavior:**
- Overflow grants bonuses for exactly 1 turn (the turn it is entered)
- At end of turn, `ShouldDischarge()` triggers mandatory 4d12 discharge
- Potency multiplier applies to damage/healing calculations in `MagicService`
- AP cost multiplier applies to spell costs

---

### ParadoxService Implementation (Engine/Services)

**Constructor Dependencies (5 total):**
```csharp
ILogger<ParadoxService> _logger
IEventBus _eventBus
IDiceService _diceService
IMasteryService _masteryService
IBacklashService _backlashService
```

**Constants:**
```csharp
private const int ParadoxThreshold = 100;      // Flux + Resonance threshold
private const int SoulDeathThreshold = 10;     // Soul Fractures for Soul Death
```

**Key Methods:**

#### `CheckParadox(Character, SpellSchool, int currentFlux)` â†’ `ParadoxResult`
- **Validation:** Returns `NotApplicable()` if archetype != Mystic
- **Soul Death Check:** Returns `NotApplicable()` if `character.IsSoulDead`
- **Overflow Detection:** Returns `EnteredOverflow()` if `ShouldEnterOverflow()` and not already in Overflow
- **Combined Value:** Calculates `currentFlux + character.Resonance`
- **Threshold Check:** Returns `Safe(combined)` if combined <= 100
- **Risk Calculation:** Gets risk % from `GetRiskChance(combined)`
- **Paradox Roll:** Rolls d100, returns `Avoided(roll, risk)` if roll > risk
- **Severity Calculation:** Calls `CalculateSeverity(combined, character, school)`
- **Mastery Avoidance:** Returns `Avoided()` if severity reduced to None
- **Effect Application:** Calls `ApplyParadoxEffects()` and returns result

#### `CalculateSeverity(int combined, Character, SpellSchool)` â†’ `ParadoxSeverity`
- **Base Severity Mapping:**
  - 100-119: Minor
  - 120-139: Major
  - 140-159: Severe
  - 160-179: Catastrophic
  - 180+: Catastrophic
- **Mastery Reduction:**
  - Novice: 0 tiers
  - Apprentice/Journeyman: -1 tier
  - Master/Archon: -2 tiers
- **Avoidance Chance:**
  - Journeyman: 10% chance to negate completely
  - Archon: 25% chance to negate completely
- **Minimum Severity:** Cannot reduce below Minor (1) if Paradox triggered

#### `ApplyParadoxEffects(Character, ParadoxSeverity, SpellSchool)` â†’ `ParadoxResult`
- **Damage Roll:** Rolls damage dice based on severity (e.g., 2d8 for Major)
- **HP Reduction:** Applies damage directly to `character.CurrentHP`, clamped at 0
- **Aether Sickness:** Adds `StatusEffectType.AetherSickness` to character if duration > 0
- **Corruption:** Calls `_backlashService.AddCorruption()` for Severe (5) and Catastrophic (10)
- **Soul Fracture:** Calls `ApplySoulFracture()` for Catastrophic severity
- **Resonance Change:** Resets to 0 for Severe/Catastrophic, or reduces by -10/-25 for Minor/Major
- **Event Publishing:** Publishes `ParadoxTriggeredEvent` via `_eventBus`
- **Result Assembly:** Constructs `ParadoxResult.Create()` with all consequences

#### `EnterOverflow(Character, int currentTurn)` â†’ `OverflowState`
- **State Creation:** Calls `OverflowState.Create(currentTurn)`
- **Character Update:** Sets `character.OverflowState` to new state
- **Event Publishing:** Publishes `OverflowEnteredEvent` with bonuses
- **Logging:** Logs entry at Warning level with turn number

#### `ProcessOverflowDischarge(Character)` â†’ `DischargeResult`
- **Validation:** Returns `NotInOverflow()` if `character.OverflowState` is null or inactive
- **Duplicate Check:** Returns `AlreadyDischarged()` if `HasDischarged` is true
- **State Update:** Marks state as discharged via `WithDischarged()`
- **Damage Roll:** Rolls 4d12 (Catastrophic damage)
- **HP Reduction:** Applies damage directly to `character.CurrentHP`, clamped at 0
- **Soul Fracture:** Calls `ApplySoulFracture(character, "Aetheric Overflow Discharge")`
- **Resonance Reset:** Sets `character.ResonanceState.CurrentValue = 0`
- **Aether Sickness:** Adds status effect for 6 turns (Catastrophic duration)
- **State Cleanup:** Calls `ClearOverflow(character)` to remove Overflow state
- **Event Publishing:** Publishes `OverflowDischargeEvent` with totals
- **Result Assembly:** Returns `DischargeResult.Completed()` with damage and new fracture count

#### `ApplySoulFracture(Character, string source)` â†’ `SoulFractureResult`
- **Fracture Creation:** Creates `SoulFracture.FromSource(source)` with count = 1
- **Collection Init:** Initializes `character.SoulFractures` if null
- **Fracture Addition:** Adds fracture to collection
- **Result Calculation:** Calls `SoulFractureResult.Applied(1, previousTotal, source)`
- **Threshold Logging:** Logs penalty crossings at Warning level
- **Soul Death Check:** If total >= 10, sets `character.IsSoulDead = true` and publishes `SoulDeathEvent`
- **Event Publishing:** Publishes `SoulFractureGainedEvent` if not Soul Death
- **Result Return:** Returns computed penalties and threshold flags

#### `GetRiskChance(int combined)` â†’ `int`
- **Risk Tiers:**
  - <= 100: 0%
  - 101-119: 20%
  - 120-139: 35%
  - 140-159: 50%
  - 160-179: 70%
  - 180+: 90%

#### `ShouldEnterOverflow(Character)` â†’ `bool`
- **Archetype Check:** Returns false if not Mystic
- **Capacity Check:** Returns `character.Resonance >= character.MaxResonanceCapacity`

**Behavior Notes:**
- All Paradox checks are Mystic-exclusive (archetype gating)
- Soul Death prevents all future spell casting (`IsSoulDead` check in `MagicService.CanCast()`)
- Overflow always results in Soul Fracture on discharge (no avoidance)
- Mastery mitigation can reduce severity but never increases it
- Events published for all major state changes (Paradox, Overflow, Fracture, Death)

---

### ParadoxDisplay Static Helpers (Terminal/Rendering)

**Rendering Methods (9 total):**

#### `RenderParadoxWarning(int flux, int resonance, IThemeService)` â†’ `string`
- **Threshold:** No warning if combined < 80
- **Color Tiers:**
  - 180+: Red1, "â˜  EXTREME PARADOX RISK"
  - 160-179: Red, "âš âš  CRITICAL PARADOX RISK"
  - 140-159: Orange1, "âš  HIGH PARADOX RISK"
  - 120-139: Yellow, "â—† ELEVATED PARADOX RISK"
  - 100-119: Yellow3, "â—‡ PARADOX THRESHOLD"
  - 80-99: Grey, "Â· Approaching Threshold"
- **Output:** Warning symbol + label + risk % + combined value + danger bar (12 chars wide)

#### `RenderOverflowStatus(OverflowState?, IThemeService)` â†’ `string`
- **Output:** "â˜… AETHERIC OVERFLOW ACTIVE â˜…" header (bold magenta1)
- **Bonuses:** "âš¡ Potency: +50% âš¡ AP Cost: -50%" (magenta1)
- **Warning:** "âš  FORCED DISCHARGE at turn end!" (yellow)
- **Empty Return:** If OverflowState is null or inactive

#### `RenderSoulFractureIndicator(Character, IThemeService)` â†’ `string`
- **Empty Return:** If fractures == 0
- **Color Tiers:**
  - 10+: Black (Soul Death)
  - 8-9: Red1
  - 6-7: Red
  - 4-5: Orange1
  - 2-3: Yellow
  - 1: Grey
- **Symbol:** "ðŸ’€" for Soul Death, "â—ˆ" otherwise
- **Output Lines:**
  - Fracture count (e.g., "â—ˆ Soul Fractures: 5/10")
  - Max Resonance (e.g., "Max Resonance: 95")
  - WILL penalty if != 0 (e.g., "WILL: -1")
  - WITS penalty if != 0 (e.g., "WITS: -1")
  - "Trait: Fractured Soul" if >= 6
  - "â˜  SOUL DEATH - CHARACTER IS FORLORN â˜ " (black on red) if 10+

#### `RenderParadoxResult(ParadoxResult, IThemeService)` â†’ `string`
- **Empty Return:** If not triggered
- **Header Variants:**
  - Catastrophic: "â˜  CATASTROPHIC PARADOX â˜ " (Red1)
  - Severe: "âš âš  SEVERE PARADOX âš âš " (Red)
  - Major: "âš  MAJOR PARADOX âš " (Orange1)
  - Minor: "â—† Minor Paradox â—†" (Yellow)
- **Output Lines:**
  - Damage dealt (e.g., "Damage: 18 HP")
  - Status (e.g., "Status: Aether Sickness (4 turns)")
  - Corruption (e.g., "Corruption: +5")
  - Soul Fracture flag ("â—ˆ SOUL FRACTURE GAINED â—ˆ" in red1)
  - Resonance change (e.g., "Resonance: -25")
  - Result message (dimmed)

#### `RenderCompactRisk(int flux, int resonance)` â†’ `string`
- **Empty Return:** If combined <= 100
- **Format:** "PDX:XX%" (e.g., "PDX:50%")
- **Color Tiers:**
  - 90%: red1
  - 70%: red
  - 50%: orange1
  - 35%: yellow
  - 20%: yellow3

#### `RenderDischargeResult(DischargeResult, IThemeService)` â†’ `string`
- **Output Lines:**
  - Header: "âš¡ AETHERIC OVERFLOW DISCHARGED âš¡" (bold magenta1)
  - Damage: "Catastrophic Damage: XX HP" (red1)
  - Soul Fracture: "â—ˆ SOUL FRACTURE GAINED â—ˆ" (red1)
  - Max Resonance: "New Max Resonance: XX" (cyan1)
  - Soul Death: "â˜  SOUL DEATH - CHARACTER IS NOW FORLORN â˜ " (black on red) if applicable
  - Result message (dimmed)

**Private Helpers (2 total):**
- `GetRiskPercentage(int combined)`: Maps combined value to 0/20/35/50/70/90
- `RenderDangerBar(int current, int max, int width)`: Returns progress bar string with â–ˆ (filled) and â–‘ (empty)

---

## Logging Matrix

### ParadoxService Context

| Event | Level | Template |
|-------|-------|----------|
| Service initialization | Debug | `"[Paradox] ParadoxService initialized. Threshold: {Threshold}"` |
| Paradox check entry | Debug | `"[Paradox] Checking for {Character}. Flux: {Flux}, Resonance: {Resonance}"` |
| Non-Mystic check | Debug | `"[Paradox] {Character} is not a Mystic. Paradox not applicable."` |
| Soul Death prevention | Warning | `"[Paradox] {Character} has suffered Soul Death. Cannot cast."` |
| Combined value calculation | Debug | `"[Paradox] Combined: {Combined} (Flux {Flux} + Resonance {Resonance})"` |
| Overflow entry detection | Warning | `"[Paradox] {Character} resonance at capacity! Entering Overflow."` |
| Safe threshold check | Debug | `"[Paradox] Combined {Combined} <= threshold {Threshold}. Safe."` |
| Risk calculation | Information | `"[Paradox] {Character} at risk! Combined: {Combined}, Risk: {Risk}%"` |
| Paradox avoided by roll | Debug | `"[Paradox] Avoided! Roll {Roll} > Risk {Risk}%"` |
| Paradox triggered | Warning | `"[Paradox] PARADOX TRIGGERED! {Character} rolled {Roll} <= {Risk}%"` |
| Mastery avoidance | Information | `"[Paradox] {Character} avoided Paradox via mastery!"` |
| Base severity calculation | Debug | `"[Paradox] Base severity: {Severity} (combined: {Combined})"` |
| Mastery mitigation | Debug | `"[Paradox] Mastery {Tier}: -{Reduction} tiers. Final severity: {Final}"` |
| Mastery avoidance roll | Information | `"[Paradox] {Tier} mastery avoided! Roll {Roll} <= {Chance}%"` |
| Effect application start | Information | `"[Paradox] Applying {Severity} Paradox effects to {Character}"` |
| Damage dealt | Warning | `"[Paradox] {Character} takes {Damage} damage ({Dice}d{Sides})"` |
| HP change | Debug | `"[Paradox] HP: {Previous} -> {Current}"` |
| Aether Sickness applied | Warning | `"[Paradox] {Character} afflicted with Aether Sickness ({Duration} turns)"` |
| Corruption gained | Warning | `"[Paradox] {Character} gained {Corruption} corruption"` |
| Resonance reset | Debug | `"[Paradox] Resonance reset to 0"` |
| Resonance reduction | Debug | `"[Paradox] Resonance: {Change} -> {New}"` |
| Event published | Debug | `"[Paradox] Published ParadoxTriggeredEvent: {Severity} for {Character}"` |
| Overflow entry | Warning | `"[Paradox] {Character} entering Aetheric Overflow at turn {Turn}!"` |
| Overflow bonuses active | Information | `"[Paradox] Overflow bonuses active: +50% potency, -50% AP cost for 1 turn"` |
| Discharge validation failure | Debug | `"[Paradox] {Character} not in Overflow. Cannot discharge."` |
| Already discharged | Debug | `"[Paradox] {Character} already discharged this turn."` |
| Discharge triggered | Warning | `"[Paradox] OVERFLOW DISCHARGE for {Character}!"` |
| Discharge damage | Warning | `"[Paradox] Discharge damage: {Damage} (4d12)"` |
| Soul Fracture applied | Error | `"[Paradox] SOUL FRACTURE: {Character} gains fracture from {Source}. Previous: {Total}"` |
| Fracture totals updated | Warning | `"[Paradox] Soul Fracture applied. Total: {Total}, Max Resonance: {MaxRes}"` |
| Penalty threshold crossed | Warning | `"[Paradox] Penalty threshold crossed! WILL: {Will}, WITS: {Wits}"` |
| Soul Death occurred | Error | `"[Paradox] SOUL DEATH! {Character}'s soul has shattered completely!"` |
| Overflow state cleared | Debug | `"[Paradox] Overflow state cleared for {Character}"` |

**Logging Statistics:**
- Total log statements: 35
- Debug: 14 (40%)
- Information: 5 (14.3%)
- Warning: 14 (40%)
- Error: 2 (5.7%)
- Context prefix: `[Paradox]` for all statements

---

## Test Coverage

**Summary:**
```
Total: 68 | Passed: 68 | Failed: 0 | Duration: 559ms
Coverage: 100% pass rate
```

### Complete Test Inventory

#### ParadoxServiceTests (68 tests)

##### Extension Method Tests (26 tests)

| Test Name | Description |
|-----------|-------------|
| `GetDamageRoll_ReturnsCorrectDiceForSeverity(severity: None, expectedCount: 0, expectedSides: 0)` | Validates None severity returns (0,0) tuple |
| `GetDamageRoll_ReturnsCorrectDiceForSeverity(severity: Minor, expectedCount: 1, expectedSides: 6)` | Validates Minor severity returns (1,6) for 1d6 |
| `GetDamageRoll_ReturnsCorrectDiceForSeverity(severity: Major, expectedCount: 2, expectedSides: 8)` | Validates Major severity returns (2,8) for 2d8 |
| `GetDamageRoll_ReturnsCorrectDiceForSeverity(severity: Severe, expectedCount: 3, expectedSides: 10)` | Validates Severe severity returns (3,10) for 3d10 |
| `GetDamageRoll_ReturnsCorrectDiceForSeverity(severity: Catastrophic, expectedCount: 4, expectedSides: 12)` | Validates Catastrophic severity returns (4,12) for 4d12 |
| `GetDamageDice_ReturnsCorrectStringForSeverity(severity: None, expected: "0")` | Validates None severity returns "0" string |
| `GetDamageDice_ReturnsCorrectStringForSeverity(severity: Minor, expected: "1d6")` | Validates Minor severity returns "1d6" string |
| `GetDamageDice_ReturnsCorrectStringForSeverity(severity: Major, expected: "2d8")` | Validates Major severity returns "2d8" string |
| `GetDamageDice_ReturnsCorrectStringForSeverity(severity: Severe, expected: "3d10")` | Validates Severe severity returns "3d10" string |
| `GetDamageDice_ReturnsCorrectStringForSeverity(severity: Catastrophic, expected: "4d12")` | Validates Catastrophic severity returns "4d12" string |
| `GetAetherSicknessDuration_ReturnsCorrectDuration(severity: Minor, expectedDuration: 0)` | Validates Minor severity has no Aether Sickness |
| `GetAetherSicknessDuration_ReturnsCorrectDuration(severity: Major, expectedDuration: 2)` | Validates Major severity applies 2 turn sickness |
| `GetAetherSicknessDuration_ReturnsCorrectDuration(severity: Severe, expectedDuration: 4)` | Validates Severe severity applies 4 turn sickness |
| `GetAetherSicknessDuration_ReturnsCorrectDuration(severity: Catastrophic, expectedDuration: 6)` | Validates Catastrophic severity applies 6 turn sickness |
| `GetCorruptionGain_ReturnsCorrectAmount(severity: Minor, expectedCorruption: 0)` | Validates Minor severity grants 0 corruption |
| `GetCorruptionGain_ReturnsCorrectAmount(severity: Major, expectedCorruption: 0)` | Validates Major severity grants 0 corruption |
| `GetCorruptionGain_ReturnsCorrectAmount(severity: Severe, expectedCorruption: 5)` | Validates Severe severity grants 5 corruption |
| `GetCorruptionGain_ReturnsCorrectAmount(severity: Catastrophic, expectedCorruption: 10)` | Validates Catastrophic severity grants 10 corruption |
| `CausesSoulFracture_ReturnsCorrectValue(severity: Minor, expected: False)` | Validates Minor severity does not cause Soul Fracture |
| `CausesSoulFracture_ReturnsCorrectValue(severity: Major, expected: False)` | Validates Major severity does not cause Soul Fracture |
| `CausesSoulFracture_ReturnsCorrectValue(severity: Severe, expected: False)` | Validates Severe severity does not cause Soul Fracture |
| `CausesSoulFracture_ReturnsCorrectValue(severity: Catastrophic, expected: True)` | Validates only Catastrophic severity causes Soul Fracture |
| `GetResonanceChange_ReturnsCorrectValue(severity: Minor, expected: -10)` | Validates Minor severity reduces resonance by 10 |
| `GetResonanceChange_ReturnsCorrectValue(severity: Major, expected: -25)` | Validates Major severity reduces resonance by 25 |
| `GetResonanceChange_ReturnsCorrectValue(severity: Severe, expected: -100)` | Validates Severe severity resets resonance (from -100 value) |
| `GetResonanceChange_ReturnsCorrectValue(severity: Catastrophic, expected: -100)` | Validates Catastrophic severity resets resonance (from -100 value) |

##### Paradox Check Logic Tests (8 tests)

| Test Name | Description |
|-----------|-------------|
| `CheckParadox_NonMysticArchetype_ReturnsNotApplicable` | Validates Paradox check returns NotApplicable for non-Mystic archetypes |
| `CheckParadox_CombinedBelowThreshold_ReturnsSafe` | Validates combined < 100 returns Safe result with no risk |
| `CheckParadox_CombinedAtExactThreshold_ReturnsSafe` | Validates combined == 100 returns Safe result (threshold is exclusive) |
| `CheckParadox_CombinedAboveThreshold_TriggersParadox` | Validates combined > 100 triggers Paradox roll and applies effects if failed |
| `CheckParadox_RollExceedsRiskChance_ReturnsAvoided` | Validates d100 roll > risk % returns Avoided result with no consequences |
| `CheckParadox_ResonanceAtCapacity_TriggersOverflow` | Validates resonance == MaxResonanceCapacity returns EnteredOverflow result |
| `GetRiskChance_ReturnsCorrectPercentage(combined: 100, expectedRisk: 0)` | Validates risk is 0% at threshold |
| `GetRiskChance_ReturnsCorrectPercentage(combined: 110, expectedRisk: 20)` | Validates risk is 20% at 100-119 tier |
| `GetRiskChance_ReturnsCorrectPercentage(combined: 130, expectedRisk: 35)` | Validates risk is 35% at 120-139 tier |
| `GetRiskChance_ReturnsCorrectPercentage(combined: 150, expectedRisk: 50)` | Validates risk is 50% at 140-159 tier |
| `GetRiskChance_ReturnsCorrectPercentage(combined: 170, expectedRisk: 70)` | Validates risk is 70% at 160-179 tier |
| `GetRiskChance_ReturnsCorrectPercentage(combined: 190, expectedRisk: 90)` | Validates risk is 90% at 180+ tier |

##### Severity Calculation Tests (6 tests)

| Test Name | Description |
|-----------|-------------|
| `CalculateSeverity_NoMastery_ReturnsBaseSeverity(combined: 110, expected: Minor)` | Validates 100-119 range maps to Minor severity without mastery |
| `CalculateSeverity_NoMastery_ReturnsBaseSeverity(combined: 130, expected: Major)` | Validates 120-139 range maps to Major severity without mastery |
| `CalculateSeverity_NoMastery_ReturnsBaseSeverity(combined: 150, expected: Severe)` | Validates 140-159 range maps to Severe severity without mastery |
| `CalculateSeverity_NoMastery_ReturnsBaseSeverity(combined: 170, expected: Catastrophic)` | Validates 160-179 range maps to Catastrophic severity without mastery |
| `CalculateSeverity_ApprenticeMastery_ReducesByOne` | Validates Apprentice mastery reduces severity by 1 tier (Major â†’ Minor) |
| `CalculateSeverity_MasterMastery_ReducesByTwo` | Validates Master mastery reduces severity by 2 tiers (Catastrophic â†’ Major) |
| `CalculateSeverity_ArchonMastery_CanAvoidCompletely` | Validates Archon mastery has 25% chance to reduce to None, avoiding Paradox |
| `CalculateSeverity_MinimumIsMinor_WhenTriggered` | Validates severity cannot reduce below Minor (1) when Paradox triggers |

##### Overflow State Tests (8 tests)

| Test Name | Description |
|-----------|-------------|
| `EnterOverflow_SetsActiveState` | Validates EnterOverflow creates active OverflowState with IsActive=true |
| `EnterOverflow_PublishesEvent` | Validates OverflowEnteredEvent is published with character ID and bonuses |
| `IsInOverflow_ReturnsTrueWhenActive` | Validates IsInOverflow returns true when OverflowState.IsActive=true |
| `IsInOverflow_ReturnsFalseWhenNotActive` | Validates IsInOverflow returns false when OverflowState is null or inactive |
| `ProcessOverflowDischarge_WhenNotInOverflow_ReturnsNotInOverflow` | Validates discharge fails with NotInOverflow result when state is null |
| `ProcessOverflowDischarge_DealsCatastrophicDamage` | Validates discharge rolls 4d12 damage and applies to character HP |
| `ProcessOverflowDischarge_ClearsOverflowState` | Validates discharge sets OverflowState to null after processing |
| `ShouldEnterOverflow_ResonanceAtCapacity_ReturnsTrue` | Validates Overflow triggers when Resonance >= MaxResonanceCapacity |
| `ShouldEnterOverflow_ResonanceBelowCapacity_ReturnsFalse` | Validates Overflow does not trigger when Resonance < MaxResonanceCapacity |

##### Soul Fracture Tests (8 tests)

| Test Name | Description |
|-----------|-------------|
| `ApplySoulFracture_AddsFractureToCharacter` | Validates fracture is added to character.SoulFractures collection |
| `ApplySoulFracture_ReducesMaxResonance` | Validates MaxResonanceCapacity decreases by 1 per fracture (100 â†’ 99 â†’ 98...) |
| `ApplySoulFracture_AppliesCorrectPenalties(totalFractures: 2, expectedWill: 0, expectedWits: 0)` | Validates 2 fractures apply no penalties |
| `ApplySoulFracture_AppliesCorrectPenalties(totalFractures: 3, expectedWill: -1, expectedWits: 0)` | Validates 3 fractures apply -1 WILL penalty |
| `ApplySoulFracture_AppliesCorrectPenalties(totalFractures: 5, expectedWill: -1, expectedWits: -1)` | Validates 5 fractures apply -1 WILL and -1 WITS penalties |
| `ApplySoulFracture_AppliesCorrectPenalties(totalFractures: 6, expectedWill: -2, expectedWits: -1)` | Validates 6 fractures apply -2 WILL and -1 WITS penalties |
| `ApplySoulFracture_At6Fractures_GrantsFracturedSoulTrait` | Validates "Fractured Soul" trait is granted at 6 fractures |
| `ApplySoulFracture_At10Fractures_TriggersSoulDeath` | Validates IsSoulDeath flag is set at 10 fractures |
| `ApplySoulFracture_SoulDeath_PublishesEvent` | Validates SoulDeathEvent is published when reaching 10 fractures |
| `GetSoulFractureCount_ReturnsCorrectTotal` | Validates total count is sum of all SoulFracture.Count values |
| `GetMaxResonanceCapacity_ReturnsCorrectValue` | Validates capacity = 100 - TotalSoulFractures, clamped at 0 |

##### Integration Tests (2 tests)

| Test Name | Description |
|-----------|-------------|
| `OverflowToDischarge_CompleteCycle` | Validates complete Overflow lifecycle: entry â†’ bonuses active â†’ discharge â†’ Soul Fracture â†’ state cleared |
| `SoulDeathPreventsParadox` | Validates character with IsSoulDead=true cannot trigger Paradox (returns NotApplicable) |

**Test Statistics:**
- Extension method tests: 26 (38.2%)
- Paradox check tests: 8 (11.8%)
- Severity calculation tests: 6 (8.8%)
- Overflow state tests: 8 (11.8%)
- Soul Fracture tests: 8 (11.8%)
- Integration tests: 2 (2.9%)
- Parameterized tests: 36 (52.9%)
- Single-case tests: 32 (47.1%)

---

## DI Registration

### Terminal Project (Program.cs)

```csharp
// Line added to DI container configuration
services.AddSingleton<IParadoxService, ParadoxService>();
```

**Lifetime:** Singleton (single instance shared across application)

**Dependencies Resolved:**
- `ILogger<ParadoxService>` (Microsoft.Extensions.Logging)
- `IEventBus` (RuneAndRust.Core.Interfaces)
- `IDiceService` (RuneAndRust.Core.Interfaces)
- `IMasteryService` (RuneAndRust.Core.Interfaces)
- `IBacklashService` (RuneAndRust.Core.Interfaces)

**Registration Order:** Added after `IMasteryService` registration, before UI service registrations

---

## Verification Results

### Build Output

```
Build succeeded.

RuneAndRust.Core -> /Users/ryan/Documents/GitHub/rune-rust/RuneAndRust.Core/bin/Debug/net9.0/RuneAndRust.Core.dll
RuneAndRust.Persistence -> /Users/ryan/Documents/GitHub/rune-rust/RuneAndRust.Persistence/bin/Debug/net9.0/RuneAndRust.Persistence.dll
RuneAndRust.Engine -> /Users/ryan/Documents/GitHub/rune-rust/RuneAndRust.Engine/bin/Debug/net9.0/RuneAndRust.Engine.dll
RuneAndRust.Terminal -> /Users/ryan/Documents/GitHub/rune-rust/RuneAndRust.Terminal/bin/Debug/net9.0/RuneAndRust.Terminal.dll
RuneAndRust.Tests -> /Users/ryan/Documents/GitHub/rune-rust/RuneAndRust.Tests/bin/Debug/net9.0/RuneAndRust.Tests.dll

Time Elapsed 00:00:01.16
```

**Status:** All projects built successfully with no errors

### Test Output

```
Test Run Successful.
Total tests: 68
     Passed: 68
 Total time: 0.5595 Seconds
```

**Status:** 100% pass rate, all Paradox tests green

**Framework:** xUnit.net VSTest Adapter v2.8.2+699d445a1a (64-bit .NET 9.0.11)

**Test Discovery:** 68 tests discovered in RuneAndRust.Tests assembly

**Performance:** Average test execution time: 8.2ms per test

---

## Directory Structure After Release

```
RuneAndRust/
â”œâ”€â”€ RuneAndRust.Core/
â”‚   â”œâ”€â”€ Entities/
â”‚   â”‚   â””â”€â”€ Character.cs                              [MODIFIED - Added Paradox region with 6 properties]
â”‚   â”œâ”€â”€ Enums/
â”‚   â”‚   â”œâ”€â”€ ParadoxSeverity.cs                        [NEW - Severity enum with 8 extensions]
â”‚   â”‚   â””â”€â”€ CastFailureReason.cs                      [MODIFIED - Added SoulDeath + Paradox reasons]
â”‚   â”œâ”€â”€ Models/Magic/
â”‚   â”‚   â”œâ”€â”€ SoulFracture.cs                           [NEW - Fracture record with 3 factories]
â”‚   â”‚   â”œâ”€â”€ SoulFracturePenalties.cs                  [NEW - Penalty computation record]
â”‚   â”‚   â”œâ”€â”€ OverflowState.cs                          [NEW - Overflow state tracker]
â”‚   â”‚   â”œâ”€â”€ ParadoxResult.cs                          [NEW - Paradox outcome record]
â”‚   â”‚   â”œâ”€â”€ DischargeResult.cs                        [NEW - Discharge outcome record]
â”‚   â”‚   â”œâ”€â”€ SoulFractureResult.cs                     [NEW - Fracture outcome record]
â”‚   â”‚   â””â”€â”€ MagicResult.cs                            [MODIFIED - Added 4 Paradox properties]
â”‚   â”œâ”€â”€ Events/
â”‚   â”‚   â”œâ”€â”€ ParadoxTriggeredEvent.cs                  [NEW - Paradox event]
â”‚   â”‚   â”œâ”€â”€ OverflowEnteredEvent.cs                   [NEW - Overflow entry event]
â”‚   â”‚   â”œâ”€â”€ OverflowDischargeEvent.cs                 [NEW - Discharge event]
â”‚   â”‚   â”œâ”€â”€ SoulFractureGainedEvent.cs                [NEW - Fracture gained event]
â”‚   â”‚   â””â”€â”€ SoulDeathEvent.cs                         [NEW - Soul Death event]
â”‚   â””â”€â”€ Interfaces/
â”‚       â””â”€â”€ IParadoxService.cs                        [NEW - 13-method service interface]
â”œâ”€â”€ RuneAndRust.Engine/Services/
â”‚   â”œâ”€â”€ ParadoxService.cs                             [NEW - 528 LOC implementation]
â”‚   â””â”€â”€ MagicService.cs                               [MODIFIED - Integrated Paradox checks]
â”œâ”€â”€ RuneAndRust.Terminal/
â”‚   â”œâ”€â”€ Program.cs                                    [MODIFIED - Registered IParadoxService]
â”‚   â””â”€â”€ Rendering/
â”‚       â””â”€â”€ ParadoxDisplay.cs                         [NEW - 313 LOC UI helpers]
â””â”€â”€ RuneAndRust.Tests/Engine/
    â”œâ”€â”€ ParadoxServiceTests.cs                        [NEW - 68 unit tests]
    â””â”€â”€ Services/MagicServiceTests.cs                 [MODIFIED - Added IParadoxService mock]
```

**New Files:** 15 total (7 Core models, 5 Core events, 1 Core interface, 1 Engine service, 1 Terminal renderer)

**Modified Files:** 6 total (2 Core, 1 Engine, 1 Terminal, 1 Test)

**Total Lines of Code Added:** ~1,800 (excluding tests)

---

## Running Tests

### Full ParadoxService Test Suite

```bash
dotnet test --filter "FullyQualifiedName~ParadoxService" --verbosity normal
```

**Output:**
```
Test Run Successful.
Total tests: 68
     Passed: 68
 Total time: 0.5595 Seconds
```

### Specific Test Categories

**Extension Method Tests:**
```bash
dotnet test --filter "FullyQualifiedName~ParadoxServiceTests&FullyQualifiedName~GetDamage"
```

**Severity Calculation Tests:**
```bash
dotnet test --filter "FullyQualifiedName~ParadoxServiceTests&FullyQualifiedName~CalculateSeverity"
```

**Overflow Tests:**
```bash
dotnet test --filter "FullyQualifiedName~ParadoxServiceTests&FullyQualifiedName~Overflow"
```

**Soul Fracture Tests:**
```bash
dotnet test --filter "FullyQualifiedName~ParadoxServiceTests&FullyQualifiedName~SoulFracture"
```

### Full Test Suite

```bash
dotnet test RuneAndRust.Tests/RuneAndRust.Tests.csproj
```

---

## Next Steps

### v0.4.4e Planned Features

- **Reality Tear Implementation**: Environmental hazards triggered by Catastrophic Paradox
  - Tear manifestation mechanics (spatial rifts, temporal anomalies)
  - Area-of-effect damage zones
  - Tear persistence and decay over turns
  - Visual indicators in terminal UI

- **Overflow Combat Mechanics**: Integration with combat turn system
  - Automatic discharge check at end of turn
  - Warning notifications before discharge
  - Overflow buff visibility in status displays
  - Pre-discharge confirmation prompts

- **Soul Fracture Persistence**: Database migration for permanent tracking
  - `SoulFractures` table with character FK
  - Timestamp, source, and count columns
  - Migration script generation
  - EF Core entity configuration

- **Advanced Mastery Mitigation**: School-specific Paradox resistance
  - School affinity bonuses (extra -1 tier for specialized schools)
  - Passive abilities unlocking at Master/Archon tiers
  - Cross-school penalty reduction interactions

- **Paradox UI Enhancement**: Rich terminal feedback
  - Animated Paradox trigger sequences
  - Color-coded severity indicators
  - Soul Fracture history panel
  - Overflow countdown timer display

- **Balance Tuning**: Risk-reward curve adjustments
  - Playtesting data collection
  - Risk % threshold rebalancing
  - Severity tier boundary adjustments
  - Mastery mitigation effectiveness tuning

---

**Changelog Generated:** 2026-01-05

**Release Tag:** v0.4.4d

**Semantic Version:** 0.4.4d (Patch increment with feature identifier)

**Breaking Changes:** None (additive changes only)

**Migration Required:** No (Soul Fractures stored in-memory until v0.4.4e persistence)
