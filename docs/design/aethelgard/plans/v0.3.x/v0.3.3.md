# Version 0.3.3: Dynamic Environment

**Status:** Complete
**Milestone:** Milestone 4 - Core Systems Layer
**Theme:** Interactive World & Environmental Mechanics

## Table of Contents
- [Overview](#overview)
- [Phase A: The Ground (Dynamic Hazards)](#phase-a-the-ground-dynamic-hazards)
- [Phase B: The Air (Ambient Conditions)](#phase-b-the-air-ambient-conditions)
- [Phase C: The Ecosystem (Integration)](#phase-c-the-ecosystem-integration)
- [Changelog (v0.3.3)](#changelog-v033)

## Overview

This milestone brings the world to life. It transforms static rooms into active participants in gameplay through Dynamic Hazards (physical threats like steam vents) and Ambient Conditions (metaphysical states like Psychic Resonance).

The Dynamic Environment system is implemented across three phases:

- **Phase A (v0.3.3a): The Ground** - Interactive battlefield objects, traps, and triggers
- **Phase B (v0.3.3b): The Air** - Room-wide atmospheric modifiers and periodic effects
- **Phase C (v0.3.3c): The Ecosystem** - Generation logic, AI awareness, and persistence

---

## Phase A: The Ground (Dynamic Hazards)

**Goal:** Implement the HazardService, define the DynamicHazard entity, and wire the trigger logic (Movement, Damage, Interaction) into the engine.

### Architecture & Data Flow

The HazardService acts as an event listener within the GameLoop and CombatService. It intercepts specific actions (Movement, Damage Application) to check for hazard triggers before or after the action resolves.

**Workflow: The Hazard Trigger Cycle**

1. **Event:** A character attempts to move into a tile OR takes damage in a specific tile.
2. **Lookup:** HazardService queries the Room for hazards at that Coordinate.
3. **State Validation:**
   - Is the hazard [Dormant]? → Proceed.
   - Is it [Triggered], [Cooldown], or [Destroyed]? → Abort.
4. **Condition Check:** Does the event match the TriggerType (e.g., PhysicalDamage, WeightPressure)?
5. **Execution:**
   - Call AbilityService to parse the hazard's EffectScript (e.g., DAMAGE:Fire:2d6).
   - Update Hazard State (e.g., set CooldownRemaining = 2).
   - Chain Reaction: Check if the effect triggers adjacent hazards.
6. **Feedback:** Emit HazardTriggeredEvent for UI/Log.

### Logic Decision Trees

#### A. Trigger Evaluation Logic
**Input:** EventType, TargetTile, SourceAmount (optional)

1. **Scan:** Find hazards at TargetTile.
2. **Loop:** For each hazard:
   - **State Check:** If State != Dormant, Skip.
   - **Type Check:**
     - If Trigger == Movement: Activate.
     - If Trigger == Damage: Is DamageAmount > DamageThreshold?
       - Yes: Activate.
       - No: Log "The hazard shudders but holds."
3. **Activate:**
   - Execute EffectScript against entities in TargetArea.
   - If OneTimeUse → Set State Destroyed.
   - Else → Set State Cooldown.

#### B. Chain Reaction Logic
**Input:** Hazard A activates

1. **Identify Area:** Get all tiles affected by Hazard A's effect (e.g., Blast Radius).
2. **Scan Neighbors:** Find Dormant hazards in those tiles.
3. **Evaluate:** Does Hazard A's DamageType trigger Hazard B?
   - Example: Fire explosion hits a "Gas Canister" (Trigger: Fire).
4. **Execute:** Trigger Hazard B immediately (Recursion limited to depth 5 to prevent infinite loops).

### Testing Requirements

**Unit Tests (HazardServiceTests.cs)**
- Trigger_Validation
- Cooldowns
- OneTimeUse

**Integration Tests**
- Chain_Reaction
- Combat_Integration

### Deliverable Checklist (Phase A)

- **Core:**
  - [ ] Define DynamicHazard entity extending InteractableObject.
  - [ ] Define HazardState and TriggerType enums.
  - [ ] Add List<DynamicHazard> to Room entity.
- **Engine:**
  - [ ] Implement HazardService with ActivateHazardAsync.
  - [ ] Update CombatService to call HazardService.ProcessDamageTrigger on every attack.
  - [ ] Update NavigationService to call HazardService.ProcessMovementTrigger on every step.
- **Data:**
  - [ ] Seed Steam Vent: Trigger=Damage/Phys|Fire, Effect=2d6 Fire.
  - [ ] Seed Pressure Plate: Trigger=Movement, Effect=Arrow Trap (1d8 Phys).
  - [ ] Seed Volatile Spore Pod: Trigger=Damage, Effect=Poison Cloud.
- **UI:**
  - [ ] Update TUI to render Hazards (Grey=Dormant, Red=Triggered).
  - [ ] Add "Hazard" column to look command output.

---

## Phase B: The Air (Ambient Conditions)

**Goal:** Implement the ConditionService to manage room-wide buffs/debuffs (Passive) and turn-based environmental ticks (Active), reusing the EffectScript engine from v0.3.3a.

### Architecture & Data Flow

The Ambient Condition System operates on two distinct triggers: Presence (Stat Modifiers) and Time (Tick Effects).

- **Data Structure:**
  - AmbientCondition: A static definition (Name, Description, StatModifiers, TickScript).
  - Room: Holds a nullable ConditionId.

**Workflow: Room Entry (Passive)**

1. **Trigger:** Player enters a Room.
2. **Lookup:** NavigationService checks Room.ConditionId.
3. **Notification:** UI appends the Condition's description to the room text.
4. **Stat Integration:** StatCalculationService queries ConditionService to apply penalties (e.g., -2 WITS).

**Workflow: Turn Start (Active)**

1. **Trigger:** CombatService.NextTurn starts.
2. **Execution:** ConditionService executes the TickScript (e.g., STRESS:2) against the active combatant.
3. **Mitigation:** Service checks for specific Traits/Gear that negate the condition.

### Logic Decision Trees

#### A. Stat Calculation Logic
**Input:** Character, Attribute Type

1. **Get Base:** Retrieve base Attribute value.
2. **Check Room:** Does CurrentRoom have a Condition?
3. **Check Modifiers:** Does the Condition modify this Attribute?
   - Yes: Apply modifier (e.g., Psychic Resonance → -1 WILL).
4. **Check Mitigation:** Does Character have [Psychic Shielding]?
   - Yes: Ignore modifier.
5. **Output:** Return effective Attribute.

#### B. Tick Processing Logic
**Input:** Combatant, Condition

1. **Validate:** Is Condition active?
2. **Check Script:** Does Condition have a TickScript?
   - No: Return.
3. **Execute:** Pass TickScript to EffectScriptExecutor (reused from v0.3.3a).
   - Example: Toxic Atmosphere → DAMAGE:Poison:1d4.
4. **Log:** "The toxic air burns [Name] for 3 damage."

### Testing Requirements

**Unit Tests (ConditionServiceTests.cs)**
- Tick_Execution
- Stat_Modifiers

**Integration Tests**
- Combat_Loop
- Room_Description

### Deliverable Checklist (Phase B)

- **Core:**
  - [ ] Define AmbientCondition class.
  - [ ] Create IConditionRegistry and IConditionService.
  - [ ] Update Room entity with string? ConditionId.
- **Data:**
  - [ ] Seed Psychic Resonance: -1 WILL, Tick: STRESS:2.
  - [ ] Seed Toxic Atmosphere: No Mod, Tick: DAMAGE:Poison:1d4.
  - [ ] Seed Deep Cold: -1 FINESSE, Tick: DAMAGE:Ice:1.
- **Engine:**
  - [ ] Implement ConditionService.
  - [ ] Update StatCalculationService to check ConditionService.
  - [ ] Update CombatService to call ProcessTurnTickAsync.
- **UI:**
  - [ ] Update NavigationService (Look) to append condition descriptions.
  - [ ] Add condition indicator to HUD (e.g., [PSYCHIC]).

---

## Phase C: The Ecosystem (Integration)

**Goal:** Update DungeonGenerator to seed biome-appropriate hazards/conditions and upgrade EnemyAIService to factor environmental dangers into decision-making.

### Architecture & Data Flow

**Workflow A: Thematic Generation**

1. **Trigger:** DungeonGenerator creates a Room.
2. **Context:** Generator checks Room.BiomeType (e.g., Industrial) and Room.DangerLevel.
3. **Selection:**
   - **Condition:** Roll against DangerLevel to apply a room-wide AmbientCondition (e.g., ToxicAtmosphere).
   - **Hazards:** Consult BiomeHazardTable. Select hazards matching the Biome (e.g., SteamVent for Industrial).
4. **Placement:** Add entities to Room.Hazards and set Room.ConditionId.

**Workflow B: AI Hazard Avoidance**

1. **Trigger:** Enemy turn starts. EnemyAIService evaluates movement options.
2. **Scan:** Identify adjacent tiles.
3. **Analysis:** Check tiles for DynamicHazard.
   - If Hazard is Active and Harmful: Check Enemy Traits (e.g., is it IronHeart vs Poison?).
4. **Scoring:** Apply negative weight to hazardous tiles.
5. **Action:** Select move with best score.

### Logic Decision Trees

#### A. Biome Population Logic
**Input:** BiomeType, DangerLevel

1. **Ambient Condition Roll:**
   - Chance = DangerLevel × 10%.
   - If Hit: Select from ConditionRegistry where Biome matches.
2. **Hazard Density Roll:**
   - Count = Random(Min, Max) scaled by DangerLevel.
3. **Hazard Selection:**
   - Filter HazardRegistry by BiomeType.
   - Instantiate DynamicHazard.
   - Assign random X/Y coordinates within Room bounds.

#### B. AI Move Evaluation
**Input:** Enemy, TargetTile

1. **Is there a Hazard?** → No: Score = 0.
2. **Is Hazard Dangerous?** (State != Destroyed/Cooldown) → No: Score = 0.
3. **Is Enemy Immune?**
   - Hazard is Poison AND Enemy has Mechanical tag? → Yes: Score = 0.
   - Hazard is Fire AND Enemy has Thermal trait? → Yes: Score = 0.
4. **Result:** Apply -50 Score (Strong deterrent, but overrides if it's the only path to a kill).

### Testing Requirements

**Unit Tests (DungeonGeneratorTests.cs)**
- Biome_Consistency
- Density

**Unit Tests (EnemyAIServiceTests.cs)**
- Avoidance
- Intelligence

### Deliverable Checklist (Phase C)

- **Data:**
  - [ ] Update HazardRegistry with Biome tags (e.g., SteamVent → Industrial).
  - [ ] Update ConditionRegistry with Biome tags (e.g., Toxic → Industrial/Helheim).
- **Engine:**
  - [ ] Update DungeonGenerator to call PopulateEnvironmentAsync.
  - [ ] Update EnemyAIService to include EvaluateTileSafety.
  - [ ] Inject ICreatureTraitService into AI to check for "Mindless" or Immunities.
- **Persistence:**
  - [ ] Ensure Room.Hazards and Room.ConditionId are saved/loaded correctly (JsonB verification).

---

## Changelog (v0.3.3)

**Release Date:** 2025-XX-XX

### Summary
Milestone 4 is complete. The dungeon environment is no longer static scenery but an active participant in exploration and combat. This update integrates the Hazard and Condition systems into procedural generation and enemy artificial intelligence.

### Features
- **Thematic Generation:**
  - **Biome Alignment:** Rooms now spawn hazards and conditions matching their theme. Industrial zones feature Steam Vents and Toxic Air; Organic zones feature Spore Pods.
  - **Danger Scaling:** 'Lethal' rooms now contain significantly denser hazard fields.
- **Intelligent AI:**
  - **Self-Preservation:** Enemies (mostly) avoid walking into active traps or fire vents.
  - **Mindless Enemies:** Undying and certain beasts ignore hazards, relentlessly pursuing the player even through fire.
  - **Immunity Logic:** Mechanical enemies will now wade through Poison clouds to reach you, exploiting their natural immunities.
- **Dynamic Hazards:**
  - Interactive objects that trigger on movement or damage.
  - **Steam Vents:** Erupt periodically or when damaged.
  - **Pressure Plates:** Trigger traps when stepped on.
  - **Spore Pods:** Explode into poison clouds when hit.
- **Ambient Conditions:**
  - Room-wide modifiers affecting all combatants.
  - **Psychic Resonance:** +Stress per turn, Magic deal +Damage.
  - **Deep Cold:** Freezing damage per turn, Slows movement.
  - **Toxic Atmosphere:** Corrosive air damage.

### Technical
- Implemented `HazardService` and `ConditionService`.
- Integrated `EffectScript` system for environmental effects.
- Updated Dungeon Generation to seed biome-specific hazards.
- Enhanced Enemy AI with environmental awareness.
