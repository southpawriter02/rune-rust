# v0.16.2c Design Specification: Archetype Armor Matrix

**Version:** 0.16.2c  
**Phase Name:** Archetype Armor Matrix  
**Parent Version:** v0.16.2 (Armor Proficiency System)  
**Prerequisites:** v0.16.2a (Proficiency Levels), v0.16.2b (Armor Categories)  
**Estimated Tests:** ~3 unit tests

---

## Table of Contents

1. [Executive Summary](#1-executive-summary)
2. [Feature Overview](#2-feature-overview)
3. [Architecture Diagrams](#3-architecture-diagrams)
4. [ArchetypeArmorProficiencySet Entity](#4-archetypearmorproficiencyset-entity)
5. [GaldrInterference Value Object](#5-galdrinterference-value-object)
6. [IArchetypeArmorProficiencyProvider Interface](#6-iarchetypearmorproficiencyprovider-interface)
7. [Data Model Changes](#7-data-model-changes)
8. [Configuration File Schemas](#8-configuration-file-schemas)
9. [Logging Specifications](#9-logging-specifications)
10. [Unit Testing Requirements](#10-unit-testing-requirements)
11. [Use Cases](#11-use-cases)
12. [Deliverable Checklist](#12-deliverable-checklist)
13. [Acceptance Criteria](#13-acceptance-criteria)
14. [Dependencies](#14-dependencies)
15. [Future Considerations](#15-future-considerations)

---

## 1. Executive Summary

### 1.1 Purpose

This specification defines the archetype-to-armor-category proficiency matrix, establishing which archetypes can wear which armor types. It also introduces Galdr interference rules that restrict magical abilities when characters wear armor they lack proficiency for.

The four archetypes have distinct armor limitations:

- **Warrior**: Proficient with Light, Medium, Heavy, and Shields
- **Skirmisher**: Proficient with Light and Medium; Non-proficient with Heavy and Tower Shields
- **Mystic**: Proficient with Light only; Medium/Heavy interferes with Galdr casting
- **Adept**: Proficient with Light only; Medium/Heavy impairs WITS-based abilities

Galdr interference is a key mechanic for Mystics:

- **Medium Armor**: -2 penalty to all Galdr checks
- **Heavy Armor**: Cannot cast Galdr (Faraday-cage effect)

### 1.2 Key Deliverables

| Category          | Items                                                                             |
| ----------------- | --------------------------------------------------------------------------------- |
| **Entities**      | `ArchetypeArmorProficiencySet`                                                    |
| **Value Objects** | `GaldrInterference`                                                               |
| **Interfaces**    | `IArchetypeArmorProficiencyProvider`                                              |
| **Configuration** | `archetype-armor-proficiencies.json`, `archetype-armor-proficiencies.schema.json` |
| **Tests**         | ~3 unit tests                                                                     |

### 1.3 Architectural Significance

This version establishes the **Archetype Restriction Pattern**:

- **Matrix-Based Lookup**: Starting proficiency is determined by archetype + category
- **Galdr Interference System**: Armor category affects magical ability availability
- **Provider Pattern**: `IArchetypeArmorProficiencyProvider` centralizes matrix access
- **Configuration-Driven**: All archetype restrictions loaded from JSON

---

## 2. Feature Overview

```
v0.16.2c Archetype Armor Matrix
├── ArchetypeArmorProficiencySet Entity
│   ├── ArchetypeId: string
│   ├── ProficientCategories: IReadOnlyList<ArmorCategory>
│   ├── NonProficientCategories: IReadOnlyList<ArmorCategory>
│   ├── GaldrInterference: GaldrInterference
│   └── SpecialRestrictions: string (e.g., "Tower Shields")
├── GaldrInterference Value Object
│   ├── MediumArmorPenalty: int (-2)
│   ├── HeavyArmorBlocked: bool (true)
│   ├── AffectsWits: bool (for Adept)
│   └── Description: string
├── IArchetypeArmorProficiencyProvider Interface
│   ├── GetProficiencySet(archetypeId): ArchetypeArmorProficiencySet
│   ├── GetStartingProficiency(archetypeId, category): ArmorProficiencyLevel
│   ├── GetGaldrInterference(archetypeId, category): GaldrInterference?
│   └── IsProficient(archetypeId, category): bool
└── Configuration
    └── archetype-armor-proficiencies.json
```

### 2.1 Archetype Armor Proficiency Matrix

| Archetype  | Light | Medium | Heavy | Shields | Specialized | Notes                    |
| ---------- | ----- | ------ | ----- | ------- | ----------- | ------------------------ |
| Warrior    | ✓     | ✓      | ✓     | ✓       | ✗           | Full armor access        |
| Skirmisher | ✓     | ✓      | ✗     | Partial | ✗           | No Tower Shields         |
| Mystic     | ✓     | ✗      | ✗     | ✗       | ✗           | Galdr interference       |
| Adept      | ✓     | ✗      | ✗     | ✗       | ✗           | WITS impairment in armor |

### 2.2 Scope Alignment

**In Scope:**

- `ArchetypeArmorProficiencySet` entity with proficiency mapping
- `GaldrInterference` value object for Galdr casting restrictions
- `IArchetypeArmorProficiencyProvider` interface
- `archetype-armor-proficiencies.json` configuration
- Galdr interference: Medium -2, Heavy blocked

**Out of Scope:**

- Non-proficiency penalty calculation (v0.16.2d)
- Proficiency acquisition methods (v0.16.2e)
- Combat integration (v0.16.2f)

---

## 3. Architecture Diagrams

### 3.1 Archetype Armor Matrix System Overview

```
┌─────────────────────────────────────────────────────────────────────┐
│              ARCHETYPE ARMOR MATRIX SYSTEM OVERVIEW                  │
└─────────────────────────────────────────────────────────────────────┘

    Character (has Archetype)
           │
           │  Lookup archetype armor proficiencies
           ▼
┌─────────────────────────────────────────────────────────────────────┐
│               IArchetypeArmorProficiencyProvider                     │
├─────────────────────────────────────────────────────────────────────┤
│  + GetProficiencySet(archetypeId): ArchetypeArmorProficiencySet     │
│  + GetStartingProficiency(archetypeId, category): ArmorProficiencyLevel│
│  + GetGaldrInterference(archetypeId, category): GaldrInterference?  │
│  + IsProficient(archetypeId, category): bool                        │
└─────────────────────────────────────────────────────────────────────┘
           │
           │  Returns archetype data
           ▼
┌─────────────────────────────────────────────────────────────────────┐
│                  ArchetypeArmorProficiencySet                        │
├─────────────────────────────────────────────────────────────────────┤
│  ArchetypeId: string              (e.g., "warrior", "mystic")       │
│  DisplayName: string              (e.g., "Warrior")                 │
│  ProficientCategories: List       (e.g., [Light, Medium, Heavy])    │
│  NonProficientCategories: List    (e.g., [Specialized])             │
│  GaldrInterference: GaldrInterference (null for non-casters)        │
│  SpecialRestrictions: string      (e.g., "No Tower Shields")        │
└─────────────────────────────────────────────────────────────────────┘
           │
           │  Contains interference rules (for casters)
           ▼
┌─────────────────────────────────────────────────────────────────────┐
│                      GaldrInterference                               │
├─────────────────────────────────────────────────────────────────────┤
│  MediumArmorPenalty: int        (-2 to Galdr checks)                │
│  HeavyArmorBlocked: bool        (true = cannot cast)                │
│  AffectsWits: bool              (true for Adept WITS impairment)    │
│  ShieldsBlocked: bool           (true for Mystic)                   │
│  Description: string            (explanation text)                  │
└─────────────────────────────────────────────────────────────────────┘
```

### 3.2 Proficiency Lookup Decision Tree

```
┌─────────────────────────────────────────────────────────────────────┐
│              PROFICIENCY LOOKUP DECISION TREE                        │
└─────────────────────────────────────────────────────────────────────┘

    Character Equips Armor
           │
           ▼
    ┌──────────────────────────────────────────────────────────────────┐
    │  GET ARCHETYPE PROFICIENCY SET                                   │
    └──────────────────────────────────────────────────────────────────┘
           │
           ▼
    ┌──────────────────────────────────────────────────────────────────┐
    │  IS CATEGORY IN PROFICIENT LIST?                                 │
    ├──────────────────────────────────────────────────────────────────┤
    │    YES → Return ArmorProficiencyLevel.Proficient                 │
    │    NO  → Continue to special checks                              │
    └──────────────────────────────────────────────────────────────────┘
           │ NO
           ▼
    ┌──────────────────────────────────────────────────────────────────┐
    │  CHECK SPECIAL RESTRICTIONS                                      │
    ├──────────────────────────────────────────────────────────────────┤
    │  Skirmisher + Heavy Armor?                                       │
    │    → NonProficient (doubled penalties)                           │
    │                                                                  │
    │  Skirmisher + Tower Shield?                                      │
    │    → NonProficient (cannot use effectively)                      │
    │                                                                  │
    │  Mystic/Adept + Medium/Heavy/Shields?                            │
    │    → NonProficient + Galdr/WITS interference                     │
    └──────────────────────────────────────────────────────────────────┘
           │
           ▼
    ┌──────────────────────────────────────────────────────────────────┐
    │  RETURN ArmorProficiencyLevel.NonProficient                      │
    └──────────────────────────────────────────────────────────────────┘
```

### 3.3 Galdr Interference Flow

```
┌─────────────────────────────────────────────────────────────────────┐
│                   GALDR INTERFERENCE FLOW                            │
└─────────────────────────────────────────────────────────────────────┘

    Mystic Attempts Galdr
           │
           ▼
    ┌──────────────────────────────────────────────────────────────────┐
    │  CHECK EQUIPPED ARMOR CATEGORY                                   │
    └──────────────────────────────────────────────────────────────────┘
           │
           ├─── Light Armor ────────────────────────────────────────────┐
           │         │                                                  │
           │         ▼                                                  │
           │    No interference                                         │
           │    Galdr cast normally                                     │
           │                                                           │
           ├─── Medium Armor ───────────────────────────────────────────┤
           │         │                                                  │
           │         ▼                                                  │
           │    ┌─────────────────────────────────────────────────┐    │
           │    │  APPLY -2 GALDR CHECK PENALTY                   │    │
           │    ├─────────────────────────────────────────────────┤    │
           │    │  Galdr roll = Normal roll - 2                   │    │
           │    │  May still succeed with penalty                 │    │
           │    └─────────────────────────────────────────────────┘    │
           │                                                           │
           └─── Heavy Armor ────────────────────────────────────────────┤
                     │                                                  │
                     ▼                                                  │
                ┌─────────────────────────────────────────────────┐    │
                │  GALDR BLOCKED (Faraday-Cage Effect)            │    │
                ├─────────────────────────────────────────────────┤    │
                │  Cannot cast any Galdr abilities                │    │
                │  Display warning: "Heavy armor blocks Galdr"    │    │
                │  Ability grayed out in UI                       │    │
                └─────────────────────────────────────────────────┘    │


ADEPT WITS IMPAIRMENT (similar flow):
┌─────────────────────────────────────────────────────────────────────┐
│  Medium Armor: -2 to WITS-based ability checks                      │
│  Heavy Armor: -4 to WITS-based ability checks (severely impaired)   │
│  Note: Adepts can still attempt WITS abilities, but with penalties  │
└─────────────────────────────────────────────────────────────────────┘
```

### 3.4 Layer Diagram

```
┌─────────────────────────────────────────────────────────────────────┐
│                        PRESENTATION LAYER                            │
├─────────────────────────────────────────────────────────────────────┤
│  CharacterCreation                                                   │
│  └── Shows armor proficiencies for selected archetype               │
│                                                                      │
│  EquipmentView                                                       │
│  └── Warns when equipping non-proficient armor                      │
│  └── Shows Galdr interference warnings for casters                  │
│                                                                      │
│  AbilityBar                                                          │
│  └── Grays out Galdr abilities when blocked by armor                │
└───────┬─────────────────────────────────────────────────────────────┘
        │
        ▼
┌─────────────────────────────────────────────────────────────────────┐
│                       APPLICATION LAYER                              │
├─────────────────────────────────────────────────────────────────────┤
│  ┌───────────────────────────────────────────────────────────────┐  │
│  │          ArchetypeArmorProficiencyProvider                     │  │
│  │     (implements IArchetypeArmorProficiencyProvider)            │  │
│  ├───────────────────────────────────────────────────────────────┤  │
│  │  + GetProficiencySet(archetypeId)                             │  │
│  │  + GetStartingProficiency(archetypeId, category)              │  │
│  │  + GetGaldrInterference(archetypeId, category)                │  │
│  │  + IsProficient(archetypeId, category)                        │  │
│  │  + CanCastGaldr(archetypeId, equippedCategory)                │  │
│  │                                                               │  │
│  │  - _proficiencySets: Dictionary<string, Set>                  │  │
│  │  - LoadConfiguration(): void (from JSON)                      │  │
│  └───────────────────────────────────────────────────────────────┘  │
└───────┬─────────────────────────────────────────────────────────────┘
        │
        ▼
┌─────────────────────────────────────────────────────────────────────┐
│                         DOMAIN LAYER                                 │
├─────────────────────────────────────────────────────────────────────┤
│  ┌───────────────────────────────┐  ┌─────────────────────────────┐ │
│  │ ArchetypeArmorProficiencySet  │  │    GaldrInterference        │ │
│  │          (Entity)             │  │      (Value Object)         │ │
│  ├───────────────────────────────┤  ├─────────────────────────────┤ │
│  │ ArchetypeId: string           │  │ MediumArmorPenalty: int     │ │
│  │ DisplayName: string           │  │ HeavyArmorBlocked: bool     │ │
│  │ ProficientCategories: List    │  │ AffectsWits: bool           │ │
│  │ NonProficientCategories: List │  │ ShieldsBlocked: bool        │ │
│  │ GaldrInterference: nullable   │  │ Description: string         │ │
│  │ SpecialRestrictions: string   │  └─────────────────────────────┘ │
│  └───────────────────────────────┘                                  │
│                                                                      │
│  Uses from v0.16.2a-b:                                              │
│  ┌────────────────────┐  ┌────────────────────┐                     │
│  │ ArmorProficiencyLevel│  │   ArmorCategory    │                     │
│  │       (Enum)        │  │      (Enum)        │                     │
│  └────────────────────┘  └────────────────────┘                     │
└─────────────────────────────────────────────────────────────────────┘
```

---

## 4. ArchetypeArmorProficiencySet Entity

### 4.1 Purpose

The `ArchetypeArmorProficiencySet` entity defines which armor categories an archetype is proficient with, along with any special restrictions or Galdr interference rules.

### 4.2 Implementation

**File:** `src/Core/RuneAndRust.Domain/Entities/ArchetypeArmorProficiencySet.cs`

```csharp
namespace RuneAndRust.Domain.Entities;

using RuneAndRust.Domain.Enums;
using RuneAndRust.Domain.ValueObjects;

/// <summary>
/// Defines armor proficiencies for an archetype.
/// </summary>
/// <remarks>
/// <para>
/// Each archetype has a set of armor categories they are proficient with.
/// Non-proficient categories result in doubled penalties and attack reductions.
/// </para>
/// <para>
/// Caster archetypes (Mystic, Adept) have additional Galdr/WITS interference
/// rules when wearing non-proficient armor.
/// </para>
/// </remarks>
public class ArchetypeArmorProficiencySet : IEntity
{
    /// <summary>
    /// Gets the unique identifier.
    /// </summary>
    public Guid Id { get; private set; }

    /// <summary>
    /// Gets the archetype identifier (e.g., "warrior", "mystic").
    /// </summary>
    public string ArchetypeId { get; private set; }

    /// <summary>
    /// Gets the display name (e.g., "Warrior").
    /// </summary>
    public string DisplayName { get; private set; }

    /// <summary>
    /// Gets armor categories this archetype is proficient with.
    /// </summary>
    public IReadOnlyList<ArmorCategory> ProficientCategories { get; private set; }

    /// <summary>
    /// Gets armor categories this archetype is NOT proficient with.
    /// </summary>
    public IReadOnlyList<ArmorCategory> NonProficientCategories { get; private set; }

    /// <summary>
    /// Gets Galdr interference rules, or null if not a caster.
    /// </summary>
    public GaldrInterference? GaldrInterference { get; private set; }

    /// <summary>
    /// Gets special restriction notes (e.g., "No Tower Shields").
    /// </summary>
    public string? SpecialRestrictions { get; private set; }

    /// <summary>
    /// Private constructor for EF Core.
    /// </summary>
    private ArchetypeArmorProficiencySet()
    {
        ArchetypeId = null!;
        DisplayName = null!;
        ProficientCategories = null!;
        NonProficientCategories = null!;
    }

    /// <summary>
    /// Creates a new ArchetypeArmorProficiencySet.
    /// </summary>
    public static ArchetypeArmorProficiencySet Create(
        string archetypeId,
        string displayName,
        IReadOnlyList<ArmorCategory> proficientCategories,
        IReadOnlyList<ArmorCategory> nonProficientCategories,
        GaldrInterference? galdrInterference = null,
        string? specialRestrictions = null)
    {
        ArgumentException.ThrowIfNullOrWhiteSpace(archetypeId);
        ArgumentException.ThrowIfNullOrWhiteSpace(displayName);
        ArgumentNullException.ThrowIfNull(proficientCategories);
        ArgumentNullException.ThrowIfNull(nonProficientCategories);

        return new ArchetypeArmorProficiencySet
        {
            Id = Guid.NewGuid(),
            ArchetypeId = archetypeId.ToLowerInvariant(),
            DisplayName = displayName,
            ProficientCategories = proficientCategories,
            NonProficientCategories = nonProficientCategories,
            GaldrInterference = galdrInterference,
            SpecialRestrictions = specialRestrictions
        };
    }

    /// <summary>
    /// Checks if this archetype is proficient with a category.
    /// </summary>
    public bool IsProficientWith(ArmorCategory category) =>
        ProficientCategories.Contains(category);

    /// <summary>
    /// Gets the starting proficiency level for a category.
    /// </summary>
    public ArmorProficiencyLevel GetStartingProficiency(ArmorCategory category) =>
        IsProficientWith(category)
            ? ArmorProficiencyLevel.Proficient
            : ArmorProficiencyLevel.NonProficient;

    /// <summary>
    /// Checks if this archetype has any Galdr interference rules.
    /// </summary>
    public bool HasGaldrInterference => GaldrInterference != null;

    /// <summary>
    /// Checks if Galdr is blocked by an armor category for this archetype.
    /// </summary>
    public bool IsGaldrBlockedBy(ArmorCategory category)
    {
        if (GaldrInterference == null) return false;

        return category switch
        {
            ArmorCategory.Heavy => GaldrInterference.Value.HeavyArmorBlocked,
            ArmorCategory.Shields => GaldrInterference.Value.ShieldsBlocked,
            _ => false
        };
    }

    /// <summary>
    /// Gets Galdr penalty for an armor category.
    /// </summary>
    public int GetGaldrPenalty(ArmorCategory category)
    {
        if (GaldrInterference == null) return 0;

        return category switch
        {
            ArmorCategory.Medium => GaldrInterference.Value.MediumArmorPenalty,
            _ => 0
        };
    }

    /// <summary>
    /// Creates a display string for debug/logging.
    /// </summary>
    public override string ToString() =>
        $"{DisplayName}: Proficient [{string.Join(", ", ProficientCategories)}]" +
        (HasGaldrInterference ? " [Has Galdr Rules]" : "");
}
```

---

## 5. GaldrInterference Value Object

### 5.1 Purpose

The `GaldrInterference` value object encapsulates Galdr casting restrictions for caster archetypes wearing inappropriate armor.

### 5.2 Implementation

**File:** `src/Core/RuneAndRust.Domain/ValueObjects/GaldrInterference.cs`

```csharp
namespace RuneAndRust.Domain.ValueObjects;

/// <summary>
/// Defines Galdr/WITS interference rules for armor usage.
/// </summary>
/// <remarks>
/// <para>
/// Caster archetypes suffer penalties or complete blocking of magical
/// abilities when wearing armor they are not trained for.
/// </para>
/// <para>
/// Mystics: Medium armor -2 Galdr, Heavy armor blocks Galdr completely.
/// Adepts: Medium armor -2 WITS, Heavy armor -4 WITS.
/// </para>
/// </remarks>
/// <param name="MediumArmorPenalty">Penalty to Galdr/WITS in Medium armor.</param>
/// <param name="HeavyArmorBlocked">Whether Heavy armor blocks Galdr entirely.</param>
/// <param name="HeavyArmorPenalty">Penalty in Heavy armor (if not blocked).</param>
/// <param name="AffectsWits">Whether penalties apply to WITS instead of Galdr.</param>
/// <param name="ShieldsBlocked">Whether shields interfere with casting.</param>
/// <param name="Description">Explanation text for UI.</param>
public readonly record struct GaldrInterference(
    int MediumArmorPenalty,
    bool HeavyArmorBlocked,
    int HeavyArmorPenalty,
    bool AffectsWits,
    bool ShieldsBlocked,
    string Description)
{
    /// <summary>
    /// Gets standard Mystic interference (Medium -2, Heavy blocked).
    /// </summary>
    public static GaldrInterference MysticRules => new(
        MediumArmorPenalty: -2,
        HeavyArmorBlocked: true,
        HeavyArmorPenalty: 0,
        AffectsWits: false,
        ShieldsBlocked: true,
        Description: "Heavy armor creates a Faraday-cage effect that blocks Galdr entirely. " +
                     "Medium armor and shields interfere with the subtle gestures required for channeling."
    );

    /// <summary>
    /// Gets standard Adept interference (Medium -2 WITS, Heavy -4 WITS).
    /// </summary>
    public static GaldrInterference AdeptRules => new(
        MediumArmorPenalty: -2,
        HeavyArmorBlocked: false,
        HeavyArmorPenalty: -4,
        AffectsWits: true,
        ShieldsBlocked: true,
        Description: "Armor bulk impairs the mental focus required for WITS-based abilities. " +
                     "Medium armor causes minor distraction, heavy armor severely impairs concentration."
    );

    /// <summary>
    /// Gets whether this has any Medium armor penalty.
    /// </summary>
    public bool HasMediumPenalty => MediumArmorPenalty != 0;

    /// <summary>
    /// Gets whether Heavy armor completely blocks abilities.
    /// </summary>
    public bool BlocksInHeavy => HeavyArmorBlocked;

    /// <summary>
    /// Gets the penalty for a specific armor category.
    /// </summary>
    public int GetPenalty(ArmorCategory category) => category switch
    {
        ArmorCategory.Medium => MediumArmorPenalty,
        ArmorCategory.Heavy when !HeavyArmorBlocked => HeavyArmorPenalty,
        _ => 0
    };

    /// <summary>
    /// Checks if abilities are blocked by a category.
    /// </summary>
    public bool IsBlockedBy(ArmorCategory category) => category switch
    {
        ArmorCategory.Heavy => HeavyArmorBlocked,
        ArmorCategory.Shields => ShieldsBlocked,
        _ => false
    };

    /// <summary>
    /// Creates a new GaldrInterference with validation.
    /// </summary>
    public static GaldrInterference Create(
        int mediumArmorPenalty,
        bool heavyArmorBlocked,
        int heavyArmorPenalty,
        bool affectsWits,
        bool shieldsBlocked,
        string description)
    {
        ArgumentException.ThrowIfNullOrWhiteSpace(description);
        ArgumentOutOfRangeException.ThrowIfGreaterThan(mediumArmorPenalty, 0);
        ArgumentOutOfRangeException.ThrowIfLessThan(mediumArmorPenalty, -10);
        ArgumentOutOfRangeException.ThrowIfGreaterThan(heavyArmorPenalty, 0);
        ArgumentOutOfRangeException.ThrowIfLessThan(heavyArmorPenalty, -10);

        return new GaldrInterference(
            mediumArmorPenalty,
            heavyArmorBlocked,
            heavyArmorPenalty,
            affectsWits,
            shieldsBlocked,
            description);
    }

    /// <summary>
    /// Formats the interference for display.
    /// </summary>
    public string FormatPenalties()
    {
        var parts = new List<string>();

        if (HasMediumPenalty)
            parts.Add($"Medium: {MediumArmorPenalty} {(AffectsWits ? "WITS" : "Galdr")}");

        if (HeavyArmorBlocked)
            parts.Add("Heavy: BLOCKED");
        else if (HeavyArmorPenalty != 0)
            parts.Add($"Heavy: {HeavyArmorPenalty} {(AffectsWits ? "WITS" : "Galdr")}");

        if (ShieldsBlocked)
            parts.Add("Shields: BLOCKED");

        return parts.Count > 0 ? string.Join(", ", parts) : "None";
    }

    /// <summary>
    /// Creates a display string for debug/logging.
    /// </summary>
    public override string ToString() =>
        $"{(AffectsWits ? "WITS" : "Galdr")} Interference: {FormatPenalties()}";
}
```

---

## 6. IArchetypeArmorProficiencyProvider Interface

### 6.1 Purpose

The `IArchetypeArmorProficiencyProvider` interface abstracts access to the archetype-armor proficiency matrix.

### 6.2 Implementation

**File:** `src/Core/RuneAndRust.Application/Interfaces/IArchetypeArmorProficiencyProvider.cs`

```csharp
namespace RuneAndRust.Application.Interfaces;

using RuneAndRust.Domain.Entities;
using RuneAndRust.Domain.Enums;
using RuneAndRust.Domain.ValueObjects;

/// <summary>
/// Provides archetype-to-armor proficiency mapping.
/// </summary>
public interface IArchetypeArmorProficiencyProvider
{
    /// <summary>
    /// Gets the full proficiency set for an archetype.
    /// </summary>
    ArchetypeArmorProficiencySet GetProficiencySet(string archetypeId);

    /// <summary>
    /// Gets the starting proficiency level for an archetype + category.
    /// </summary>
    ArmorProficiencyLevel GetStartingProficiency(string archetypeId, ArmorCategory category);

    /// <summary>
    /// Checks if an archetype is proficient with a category.
    /// </summary>
    bool IsProficient(string archetypeId, ArmorCategory category);

    /// <summary>
    /// Gets Galdr interference for an archetype + category.
    /// </summary>
    /// <returns>Interference rules, or null if no interference.</returns>
    GaldrInterference? GetGaldrInterference(string archetypeId, ArmorCategory category);

    /// <summary>
    /// Checks if Galdr is blocked for an archetype wearing a category.
    /// </summary>
    bool IsGaldrBlocked(string archetypeId, ArmorCategory category);

    /// <summary>
    /// Gets the Galdr penalty for an archetype wearing a category.
    /// </summary>
    int GetGaldrPenalty(string archetypeId, ArmorCategory category);

    /// <summary>
    /// Checks if an archetype can cast Galdr in current armor.
    /// </summary>
    bool CanCastGaldr(string archetypeId, ArmorCategory equippedCategory);

    /// <summary>
    /// Gets all configured proficiency sets.
    /// </summary>
    IReadOnlyList<ArchetypeArmorProficiencySet> GetAllProficiencySets();

    /// <summary>
    /// Validates that all archetypes have proficiency sets.
    /// </summary>
    bool ValidateConfiguration();
}
```

### 6.3 Usage Examples

```csharp
// Check if Warrior is proficient with Heavy armor
var isProficient = _provider.IsProficient("warrior", ArmorCategory.Heavy);
Console.WriteLine($"Warrior + Heavy: {isProficient}");  // True

// Get starting proficiency for Mystic + Medium
var level = _provider.GetStartingProficiency("mystic", ArmorCategory.Medium);
Console.WriteLine($"Mystic + Medium: {level}");  // NonProficient

// Check Galdr blocking for Mystic in Heavy
var blocked = _provider.IsGaldrBlocked("mystic", ArmorCategory.Heavy);
Console.WriteLine($"Mystic Galdr blocked in Heavy: {blocked}");  // True

// Get Galdr penalty for Mystic in Medium
var penalty = _provider.GetGaldrPenalty("mystic", ArmorCategory.Medium);
Console.WriteLine($"Mystic Galdr penalty in Medium: {penalty}");  // -2

// Full check for ability usage
if (!_provider.CanCastGaldr("mystic", equippedArmor.Category))
{
    Console.WriteLine("Cannot cast Galdr in current armor!");
}
```

---

## 7. Data Model Changes

### 7.1 New Types Summary

| Type                                 | Layer       | Category     | Description                     |
| ------------------------------------ | ----------- | ------------ | ------------------------------- |
| `ArchetypeArmorProficiencySet`       | Domain      | Entity       | Archetype proficiency mapping   |
| `GaldrInterference`                  | Domain      | Value Object | Galdr/WITS casting restrictions |
| `IArchetypeArmorProficiencyProvider` | Application | Interface    | Matrix access abstraction       |

### 7.2 File Locations

```
src/Core/RuneAndRust.Domain/
├── Entities/
│   └── ArchetypeArmorProficiencySet.cs    ← NEW
└── ValueObjects/
    └── GaldrInterference.cs               ← NEW

src/Core/RuneAndRust.Application/
└── Interfaces/
    └── IArchetypeArmorProficiencyProvider.cs ← NEW

config/
├── archetype-armor-proficiencies.json     ← NEW
└── schemas/
    └── archetype-armor-proficiencies.schema.json ← NEW
```

---

## 8. Configuration File Schemas

### 8.1 archetype-armor-proficiencies.json

**File:** `config/archetype-armor-proficiencies.json`

```json
{
    "$schema": "./schemas/archetype-armor-proficiencies.schema.json",
    "proficiencySets": [
        {
            "archetypeId": "warrior",
            "displayName": "Warrior",
            "proficientCategories": ["Light", "Medium", "Heavy", "Shields"],
            "nonProficientCategories": ["Specialized"],
            "galdrInterference": null,
            "specialRestrictions": null
        },
        {
            "archetypeId": "skirmisher",
            "displayName": "Skirmisher",
            "proficientCategories": ["Light", "Medium", "Shields"],
            "nonProficientCategories": ["Heavy", "Specialized"],
            "galdrInterference": null,
            "specialRestrictions": "Cannot effectively use Tower Shields"
        },
        {
            "archetypeId": "mystic",
            "displayName": "Mystic",
            "proficientCategories": ["Light"],
            "nonProficientCategories": [
                "Medium",
                "Heavy",
                "Shields",
                "Specialized"
            ],
            "galdrInterference": {
                "mediumArmorPenalty": -2,
                "heavyArmorBlocked": true,
                "heavyArmorPenalty": 0,
                "affectsWits": false,
                "shieldsBlocked": true,
                "description": "Heavy armor creates a Faraday-cage effect blocking Galdr. Medium armor and shields interfere with channeling gestures."
            },
            "specialRestrictions": "Galdr blocked in Heavy armor"
        },
        {
            "archetypeId": "adept",
            "displayName": "Adept",
            "proficientCategories": ["Light"],
            "nonProficientCategories": [
                "Medium",
                "Heavy",
                "Shields",
                "Specialized"
            ],
            "galdrInterference": {
                "mediumArmorPenalty": -2,
                "heavyArmorBlocked": false,
                "heavyArmorPenalty": -4,
                "affectsWits": true,
                "shieldsBlocked": true,
                "description": "Armor bulk impairs the mental focus required for WITS-based abilities."
            },
            "specialRestrictions": "WITS impaired in Medium/Heavy armor"
        }
    ]
}
```

### 8.2 archetype-armor-proficiencies.schema.json

**File:** `config/schemas/archetype-armor-proficiencies.schema.json`

```json
{
    "$schema": "http://json-schema.org/draft-07/schema#",
    "$id": "archetype-armor-proficiencies.schema.json",
    "title": "Archetype Armor Proficiencies Configuration",
    "description": "Defines archetype-to-armor proficiency mappings",
    "type": "object",
    "required": ["proficiencySets"],
    "properties": {
        "$schema": { "type": "string" },
        "proficiencySets": {
            "type": "array",
            "minItems": 1,
            "items": { "$ref": "#/$defs/proficiencySet" }
        }
    },
    "$defs": {
        "proficiencySet": {
            "type": "object",
            "required": [
                "archetypeId",
                "displayName",
                "proficientCategories",
                "nonProficientCategories"
            ],
            "properties": {
                "archetypeId": { "type": "string", "minLength": 1 },
                "displayName": {
                    "type": "string",
                    "minLength": 1,
                    "maxLength": 50
                },
                "proficientCategories": {
                    "type": "array",
                    "items": { "$ref": "#/$defs/armorCategory" }
                },
                "nonProficientCategories": {
                    "type": "array",
                    "items": { "$ref": "#/$defs/armorCategory" }
                },
                "galdrInterference": {
                    "oneOf": [
                        { "type": "null" },
                        { "$ref": "#/$defs/galdrInterference" }
                    ]
                },
                "specialRestrictions": {
                    "oneOf": [
                        { "type": "null" },
                        { "type": "string", "maxLength": 200 }
                    ]
                }
            }
        },
        "armorCategory": {
            "type": "string",
            "enum": ["Light", "Medium", "Heavy", "Shields", "Specialized"]
        },
        "galdrInterference": {
            "type": "object",
            "required": [
                "mediumArmorPenalty",
                "heavyArmorBlocked",
                "affectsWits",
                "description"
            ],
            "properties": {
                "mediumArmorPenalty": {
                    "type": "integer",
                    "minimum": -10,
                    "maximum": 0
                },
                "heavyArmorBlocked": { "type": "boolean" },
                "heavyArmorPenalty": {
                    "type": "integer",
                    "minimum": -10,
                    "maximum": 0
                },
                "affectsWits": { "type": "boolean" },
                "shieldsBlocked": { "type": "boolean" },
                "description": {
                    "type": "string",
                    "minLength": 10,
                    "maxLength": 500
                }
            }
        }
    }
}
```

---

## 9. Logging Specifications

### 9.1 Log Levels by Component

| Component                           | Level       | Events                          |
| ----------------------------------- | ----------- | ------------------------------- |
| `ArchetypeArmorProficiencyProvider` | Information | Configuration loaded            |
| `ArchetypeArmorProficiencyProvider` | Debug       | Proficiency lookup performed    |
| `ArchetypeArmorProficiencyProvider` | Warning     | Missing archetype configuration |
| `ArchetypeArmorProficiencyProvider` | Warning     | Galdr blocked by armor          |

### 9.2 Log Message Templates

```csharp
// Information - Configuration loaded
_logger.LogInformation(
    "Loaded {Count} archetype armor proficiency sets",
    sets.Count);

// Debug - Proficiency lookup
_logger.LogDebug(
    "Archetype {ArchetypeId} proficiency for {Category}: {Level}",
    archetypeId, category, level);

// Warning - Galdr blocked
_logger.LogWarning(
    "Galdr blocked for archetype {ArchetypeId} wearing {Category} armor",
    archetypeId, category);
```

---

## 10. Unit Testing Requirements

### 10.1 Test Count by Feature

| Feature                      | Test Count |
| ---------------------------- | ---------- |
| ArchetypeArmorProficiencySet | ~1         |
| GaldrInterference            | ~1         |
| Provider Integration         | ~1         |
| **Total**                    | **~3**     |

### 10.2 Test Specifications

**File:** `tests/RuneAndRust.Domain.UnitTests/Entities/ArchetypeArmorProficiencySetTests.cs`

```csharp
[TestFixture]
public class ArchetypeArmorProficiencySetTests
{
    [Test]
    public void IsProficientWith_WarriorWithHeavy_ReturnsTrue()
    {
        // Arrange
        var set = ArchetypeArmorProficiencySet.Create(
            "warrior", "Warrior",
            new[] { ArmorCategory.Light, ArmorCategory.Medium, ArmorCategory.Heavy, ArmorCategory.Shields },
            new[] { ArmorCategory.Specialized });

        // Act
        var result = set.IsProficientWith(ArmorCategory.Heavy);

        // Assert
        result.Should().BeTrue();
    }

    [Test]
    public void IsGaldrBlockedBy_MysticWithHeavy_ReturnsTrue()
    {
        // Arrange
        var set = ArchetypeArmorProficiencySet.Create(
            "mystic", "Mystic",
            new[] { ArmorCategory.Light },
            new[] { ArmorCategory.Medium, ArmorCategory.Heavy, ArmorCategory.Shields, ArmorCategory.Specialized },
            GaldrInterference.MysticRules);

        // Act
        var blocked = set.IsGaldrBlockedBy(ArmorCategory.Heavy);

        // Assert
        blocked.Should().BeTrue();
    }

    [Test]
    public void GetGaldrPenalty_MysticWithMedium_ReturnsMinusTwo()
    {
        // Arrange
        var set = ArchetypeArmorProficiencySet.Create(
            "mystic", "Mystic",
            new[] { ArmorCategory.Light },
            new[] { ArmorCategory.Medium, ArmorCategory.Heavy },
            GaldrInterference.MysticRules);

        // Act
        var penalty = set.GetGaldrPenalty(ArmorCategory.Medium);

        // Assert
        penalty.Should().Be(-2);
    }
}
```

---

## 11. Use Cases

### UC-001: Determine Starting Proficiency

**Actor:** System  
**Flow:** Character selects archetype → System loads proficiency set → System determines proficiency for equipped armor

### UC-002: Block Galdr in Heavy Armor

**Actor:** Player (Mystic)  
**Flow:** Mystic equips Heavy armor → System detects Galdr interference → Galdr abilities grayed out in UI

### UC-003: Apply Galdr Penalty in Medium Armor

**Actor:** Player (Mystic)  
**Flow:** Mystic equips Medium armor → System applies -2 Galdr penalty → Galdr checks modified

---

## 12. Deliverable Checklist

### Domain Layer

- [ ] `ArchetypeArmorProficiencySet` entity created
- [ ] `GaldrInterference` value object created

### Application Layer

- [ ] `IArchetypeArmorProficiencyProvider` interface created

### Configuration Files

- [ ] `config/archetype-armor-proficiencies.json` created
- [ ] `config/schemas/archetype-armor-proficiencies.schema.json` created

### Testing

- [ ] ~3 unit tests implemented
- [ ] All tests passing

---

## 13. Acceptance Criteria

### Functional

- [ ] Warrior proficient with Light, Medium, Heavy, Shields
- [ ] Skirmisher proficient with Light, Medium; non-proficient Heavy
- [ ] Mystic proficient with Light only
- [ ] Adept proficient with Light only
- [ ] Mystic Galdr blocked in Heavy armor
- [ ] Mystic Galdr -2 penalty in Medium armor
- [ ] Adept WITS -4 penalty in Heavy armor

### Quality

- [ ] Build succeeds with 0 errors/warnings
- [ ] All ~3 tests pass
- [ ] XML documentation complete

---

## 14. Dependencies

### 14.1 Required from Previous Phases

| Type                    | Source   | Usage                              |
| ----------------------- | -------- | ---------------------------------- |
| `ArmorProficiencyLevel` | v0.16.2a | Return type for proficiency lookup |
| `ArmorCategory`         | v0.16.2b | Category parameter for lookups     |

### 14.2 Provides to Future Phases

| Type                                 | Usage                              |
| ------------------------------------ | ---------------------------------- |
| `ArchetypeArmorProficiencySet`       | v0.16.2d-f: Proficiency resolution |
| `GaldrInterference`                  | v0.16.2f: Combat Galdr checks      |
| `IArchetypeArmorProficiencyProvider` | v0.16.2d-f: Matrix access          |

---

## 15. Future Considerations

### 15.1 Deferred to v0.16.2d

- **Non-proficiency Penalty Calculation Service**: Applies doubled penalties

### 15.2 Deferred to v0.16.2e

- **Proficiency Acquisition**: Training to gain proficiency

### 15.3 Deferred to v0.16.2f

- **Combat Integration**: Actual Galdr blocking in combat

### 15.4 Out of Scope

- **Multi-class Proficiencies**: Combining archetype proficiencies
- **Feat-based Proficiency**: Gaining proficiency through feats

---

_Document Version: 1.0_  
_Last Updated: 2026-01-27_  
_Author: Assistant_
