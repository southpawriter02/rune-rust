# Design Specification: v0.20.6c - Bone-Setter Tier 3 & Capstone Abilities

**Version:** v0.20.6c
**Status:** Design Phase
**Last Updated:** 2026-01-28
**Target Tests:** ~7 unit and integration tests
**Specialization:** Bone-Setter (Tier 3 & Capstone)
**Path Type:** Coherent (NO Corruption risk)
**Archetype:** Adept

---

## Table of Contents

1. [Executive Summary](#1-executive-summary)
2. [Tier 3 & Capstone Overview](#2-tier-3--capstone-overview)
3. [Architecture Diagrams](#3-architecture-diagrams)
4. [Domain Model Specifications](#4-domain-model-specifications)
5. [Resuscitate Ability Specification](#5-resuscitate-ability-specification)
6. [Preventive Care Ability Specification](#6-preventive-care-ability-specification)
7. [Miracle Worker Capstone Specification](#7-miracle-worker-capstone-specification)
8. [Cooldown & Resource Management](#8-cooldown--resource-management)
9. [User Stories & Scenarios](#9-user-stories--scenarios)
10. [Application Service Layer](#10-application-service-layer)
11. [Configuration Specifications](#11-configuration-specifications)
12. [Command Examples & Output](#12-command-examples--output)
13. [State Machine Diagrams](#13-state-machine-diagrams)
14. [Logging Specifications](#14-logging-specifications)
15. [Unit Testing Requirements](#15-unit-testing-requirements)
16. [Deliverable Checklist](#16-deliverable-checklist)
17. [Acceptance Criteria](#17-acceptance-criteria)
18. [Dependencies & Prerequisites](#18-dependencies--prerequisites)
19. [Design Decisions & Rationale](#19-design-decisions--rationale)

---

## 1. Executive Summary

Version 0.20.6c introduces **Tier 3 Bone-Setter abilities** and the **Capstone**, establishing the Bone-Setter as the legendary healer archetype:

- **Resuscitate:** Bring unconscious allies back from the brink (1 HP) with resource cost
- **Preventive Care:** Passive aura granting +1 to poison/disease saving throws
- **Miracle Worker (Capstone):** Full heal + condition removal with long-rest cooldown

This phase also establishes:

- **Resurrection Mechanics:** Framework for bringing unconscious characters back into combat
- **Aura Effects:** Passive benefits affecting the entire party
- **Ultimate Ability Framework:** Long cooldown capstone mechanics
- **Healing Specialization Completion:** Final establishment of Bone-Setter as healer

### Key Deliverables

| Category | Count | Details |
|----------|-------|---------|
| **Domain Value Objects** | 4 | ResuscitateResult, PreventiveCareAura, MiracleWorkerResult, CapstoneUsageTracker |
| **Domain Enums** | 1 | ResurrectionMethod |
| **Application Services** | 2 | ResuscitateService, MiracleWorkerService |
| **Ability Implementations** | 3 | Resuscitate, Preventive Care, Miracle Worker |
| **Configuration Files** | 1 | abilities.json (Tier 3 + Capstone) |
| **Unit Tests** | ~7 | Critical path coverage |

---

## 2. Tier 3 & Capstone Overview

### 2.1 Final Tier Identity

**Tier 3 Abilities (Unlocked after v0.20.6b completion):**

| Ability | Type | AP Cost | Resource Cost | Range | Effect |
|---------|------|---------|---------------|-------|--------|
| Resuscitate | Active | 4 AP | 2 Medical Supplies | 2 spaces | Revive unconscious to 1 HP |
| Preventive Care | Passive | — | — | 5 space aura | +1 poison/disease saving throws |
| Miracle Worker | Ultimate | 5 AP | None | Self | Full heal + clear conditions (1x/long rest) |

### 2.2 Thematic Completion

**Quote:** "Where there is breath, there is hope. Where there is hope, there is life."

**Tier Progression:**
- T1: Foundation - Basic healing and information
- T2: Advancement - Emergency response and resource creation
- T3: Mastery - Resurrection, protection, and miraculous intervention

### 2.3 Bone-Setter Archetype Role

The Bone-Setter becomes the definitive **Legendary Healer**:

| Aspect | Role |
|--------|------|
| **Combat Support** | Primary healing source, miracle intervention |
| **Party Protection** | Prevent conditions via Preventive Care aura |
| **Crisis Management** | Resuscitate brings back fallen allies |
| **Tactical Value** | Essential for surviving difficult encounters |

---

## 3. Architecture Diagrams

### 3.1 Tier 3 System Architecture

```
┌─────────────────────────────────────────────────────────────────┐
│         Bone-Setter Tier 3 & Capstone Abilities                 │
└─────────────────────────────────────────────────────────────────┘
                              │
        ┌─────────────────────┼─────────────────────┐
        │                     │                     │
    ┌───▼──────────┐  ┌──────▼────────┐  ┌────────▼────┐
    │ Resuscitate  │  │ Preventive    │  │   Miracle   │
    │  (Active)    │  │  Care         │  │   Worker    │
    │              │  │  (Passive)    │  │  (Ultimate) │
    └───┬──────────┘  └──────┬────────┘  └────────┬────┘
        │                    │                    │
        └────────────────────┼────────────────────┘
                             │
                 ┌───────────▼──────────────┐
                 │ BoneSetterCapstoneService│
                 └───────────┬──────────────┘
                             │
        ┌────────────────────┼────────────────────┐
        │                    │                    │
    ┌───▼──────────┐  ┌──────▼────────┐  ┌──────▼────┐
    │ Resurrection │  │  Aura         │  │ Capstone  │
    │ Service      │  │  Management   │  │ Cooldown  │
    │              │  │               │  │ Tracking  │
    └──────────────┘  └───────────────┘  └───────────┘
```

### 3.2 Miracle Worker Cooldown Tracking

```
Miracle Worker Capability State Machine

READY STATE:
├─ Ability available for use
├─ Cooldown remaining: 0 turns
└─ Button/UI shows "AVAILABLE"

   │ Player activates Miracle Worker
   │
   ▼

ACTIVATED STATE:
├─ Heal party member (or self)
├─ Clear all conditions
├─ Full restoration
└─ Record usage timestamp

   │ Effect applies
   │
   ▼

COOLDOWN STATE:
├─ Cooldown starts: current time
├─ Cooldown duration: until next long rest
├─ Ability locked for remainder of long rest cycle
└─ Button/UI shows "ON COOLDOWN - Next available: after rest"

   │ Party completes long rest
   │ Time advanced, new day/period begins
   │
   ▼

READY STATE (cycle repeats)
```

### 3.3 Preventive Care Aura Radius

```
Preventive Care - Save Throw Aura

         ╔════════════════════════════╗
         ║    5-Space Aura Radius     ║
         ║                            ║
         ║      ◇ ◇ ◇ ◇ ◇ ◇ ◇       ║
         ║    ◇  [Ally1]  *  [Ally2]  ◇ ║
         ║   ◇   [Ally3][BS][Ally4]   ◇ ║
         ║   ◇    [Ally5]  *  [Ally6]  ◇ ║
         ║    ◇  ◇ ◇ ◇ ◇ ◇ ◇       ║
         ║                            ║
         ║  All allies within 5 spaces║
         ║  gain +1 to poison/disease ║
         ║  saving throws while aura  ║
         ║  is active (always)        ║
         ║                            ║
         ╚════════════════════════════╝

Aura Coverage:
  ✓ Adjacent spaces (1 space away)
  ✓ Diagonal spaces
  ✓ Full 5-space radius in all directions
  ✓ No line-of-sight requirement
  ✓ Always active (passive ability)
```

---

## 4. Domain Model Specifications

### 4.1 Enumerations

#### ResurrectionMethod

```csharp
/// <summary>
/// Enumeration of methods used to bring unconscious characters back to life.
/// Determines mechanical effects and narrative flavor.
/// </summary>
public enum ResurrectionMethod
{
    /// <summary>
    /// Resuscitate ability - Emergency revival via Bone-Setter skill.
    /// Brings target to 1 HP (barely conscious).
    /// </summary>
    SkillBasedResuscitation = 0,

    /// <summary>
    /// Miracle Worker capstone - Full restoration and condition clearing.
    /// Brings target to full HP with all conditions removed.
    /// </summary>
    MiracleIntervention = 1,

    /// <summary>
    /// Natural revival - Target recovers via rest/natural healing (future).
    /// </summary>
    NaturalRecovery = 2,

    /// <summary>
    /// Divine/magical intervention (future for other specializations).
    /// </summary>
    DivineGrace = 3
}
```

### 4.2 Value Objects

#### ResuscitateResult

```csharp
/// <summary>
/// Immutable result object from Resuscitate ability execution.
/// Records resurrection of unconscious character.
/// </summary>
public sealed class ResuscitateResult : ValueObject
{
    /// <summary>
    /// Unique identifier of the resurrected target.
    /// </summary>
    public Guid TargetId { get; }

    /// <summary>
    /// Display name of the resurrected target.
    /// </summary>
    public string TargetName { get; }

    /// <summary>
    /// HP value before resuscitation (0, unconscious).
    /// </summary>
    public int HpBefore { get; }

    /// <summary>
    /// HP value after resuscitation (always 1 HP).
    /// </summary>
    public int HpAfter => 1;

    /// <summary>
    /// Number of Medical Supplies consumed (always 2 for Resuscitate).
    /// </summary>
    public int SuppliesUsed => 2;

    /// <summary>
    /// Number of Medical Supplies remaining after spending.
    /// </summary>
    public int SuppliesRemaining { get; }

    /// <summary>
    /// Method of resurrection used.
    /// </summary>
    public ResurrectionMethod Method { get; }

    /// <summary>
    /// Whether target returns to conscious state (always true for Resuscitate).
    /// </summary>
    public bool IsConscious => true;

    /// <summary>
    /// Message describing the revival.
    /// </summary>
    public string ResurrectionMessage { get; }

    /// <summary>
    /// Timestamp when resuscitation was performed.
    /// </summary>
    public DateTime ResurrectedAt { get; }

    public ResuscitateResult(
        Guid targetId,
        string targetName,
        int hpBefore,
        int suppliesRemaining,
        ResurrectionMethod method,
        string resurrectMessage)
    {
        if (string.IsNullOrWhiteSpace(targetName))
            throw new ArgumentException("Target name cannot be empty.", nameof(targetName));

        if (targetId == Guid.Empty)
            throw new ArgumentException("Target ID cannot be empty.", nameof(targetId));

        if (hpBefore != 0)
            throw new ArgumentException("Target must be at 0 HP to resuscitate.", nameof(hpBefore));

        TargetId = targetId;
        TargetName = targetName;
        HpBefore = hpBefore;
        SuppliesRemaining = suppliesRemaining;
        Method = method;
        ResurrectionMessage = resurrectMessage;
        ResurrectedAt = DateTime.UtcNow;
    }

    /// <summary>
    /// Returns human-readable status message of resuscitation.
    /// </summary>
    public string GetStatusMessage() =>
        $"{TargetName} has been RESUSCITATED! ({HpBefore} → {HpAfter} HP, conscious)";

    protected override IEnumerable<object> GetEqualityComponents()
    {
        yield return TargetId;
        yield return Method;
        yield return ResurrectedAt;
    }
}
```

#### PreventiveCareAura

```csharp
/// <summary>
/// Represents the Preventive Care passive ability aura.
/// Grants saving throw bonuses to all allies within radius.
/// </summary>
public sealed class PreventiveCareAura : ValueObject
{
    /// <summary>
    /// Unique identifier of the Bone-Setter providing the aura.
    /// </summary>
    public Guid BoneSetterId { get; }

    /// <summary>
    /// Radius of the aura in spaces (always 5).
    /// </summary>
    public int AuraRadius => 5;

    /// <summary>
    /// Bonus granted to poison saving throws (+1).
    /// </summary>
    public int PoisonSaveBonus => 1;

    /// <summary>
    /// Bonus granted to disease saving throws (+1).
    /// </summary>
    public int DiseaseSaveBonus => 1;

    /// <summary>
    /// List of all characters currently benefiting from the aura.
    /// </summary>
    public IReadOnlyList<Guid> AffectedCharacterIds { get; }

    /// <summary>
    /// Whether the aura is currently active.
    /// Always true for passive abilities.
    /// </summary>
    public bool IsActive => true;

    /// <summary>
    /// Timestamp when aura was last recalculated.
    /// </summary>
    public DateTime LastRecalculatedAt { get; }

    public PreventiveCareAura(
        Guid boneSetterId,
        IEnumerable<Guid> affectedCharacterIds)
    {
        if (boneSetterId == Guid.Empty)
            throw new ArgumentException("Bone-Setter ID cannot be empty.", nameof(boneSetterId));

        BoneSetterId = boneSetterId;
        AffectedCharacterIds = affectedCharacterIds?.ToList().AsReadOnly() ?? new List<Guid>().AsReadOnly();
        LastRecalculatedAt = DateTime.UtcNow;
    }

    /// <summary>
    /// Checks if a character is within the aura radius.
    /// </summary>
    public bool IsCharacterAffected(Guid characterId) =>
        AffectedCharacterIds.Contains(characterId);

    /// <summary>
    /// Returns formatted summary of aura effect.
    /// </summary>
    public string GetAuraSummary() =>
        $"Preventive Care Aura (5 spaces): +1 poison/disease saves " +
        $"for {AffectedCharacterIds.Count} allies";

    protected override IEnumerable<object> GetEqualityComponents()
    {
        yield return BoneSetterId;
        yield return AuraRadius;
        yield return AffectedCharacterIds.Count;
        yield return LastRecalculatedAt;
    }
}
```

#### MiracleWorkerResult

```csharp
/// <summary>
/// Immutable result object from Miracle Worker capstone execution.
/// Records the miraculous intervention and all effects applied.
/// </summary>
public sealed class MiracleWorkerResult : ValueObject
{
    /// <summary>
    /// Unique identifier of the healed target.
    /// </summary>
    public Guid TargetId { get; }

    /// <summary>
    /// Display name of the healed target.
    /// </summary>
    public string TargetName { get; }

    /// <summary>
    /// HP before Miracle Worker was applied.
    /// </summary>
    public int HpBefore { get; }

    /// <summary>
    /// Target's maximum HP (healing restores to this value).
    /// </summary>
    public int MaxHp { get; }

    /// <summary>
    /// HP after healing (always MaxHp).
    /// </summary>
    public int HpAfter => MaxHp;

    /// <summary>
    /// Total HP healed = MaxHp - HpBefore
    /// </summary>
    public int TotalHealing => MaxHp - HpBefore;

    /// <summary>
    /// Collection of conditions that were cleared.
    /// </summary>
    public IReadOnlyList<string> ClearedConditions { get; }

    /// <summary>
    /// Number of conditions that were removed.
    /// </summary>
    public int ConditionsCleared => ClearedConditions.Count;

    /// <summary>
    /// Timestamp when Miracle Worker was activated.
    /// Records for cooldown tracking.
    /// </summary>
    public DateTime UsedAt { get; }

    /// <summary>
    /// Next time Miracle Worker can be used (after long rest).
    /// </summary>
    public DateTime AvailableAgainAt { get; }

    /// <summary>
    /// Narrative message describing the miracle.
    /// </summary>
    public string MiracleMessage { get; }

    public MiracleWorkerResult(
        Guid targetId,
        string targetName,
        int hpBefore,
        int maxHp,
        IEnumerable<string> clearedConditions,
        DateTime availableAt,
        string miracleMessage)
    {
        if (string.IsNullOrWhiteSpace(targetName))
            throw new ArgumentException("Target name cannot be empty.", nameof(targetName));

        if (targetId == Guid.Empty)
            throw new ArgumentException("Target ID cannot be empty.", nameof(targetId));

        if (maxHp <= 0)
            throw new ArgumentException("Max HP must be positive.", nameof(maxHp));

        TargetId = targetId;
        TargetName = targetName;
        HpBefore = hpBefore;
        MaxHp = maxHp;
        ClearedConditions = clearedConditions?.ToList().AsReadOnly() ?? new List<string>().AsReadOnly();
        UsedAt = DateTime.UtcNow;
        AvailableAgainAt = availableAt;
        MiracleMessage = miracleMessage;
    }

    /// <summary>
    /// Returns human-readable status message of the miracle.
    /// </summary>
    public string GetStatusMessage() =>
        $"MIRACLE WORKER: {TargetName} FULLY RESTORED! " +
        $"({HpBefore} → {HpAfter} HP{(ConditionsCleared > 0 ? $", {ConditionsCleared} conditions cleared" : "")})";

    /// <summary>
    /// Returns detailed breakdown of effects.
    /// </summary>
    public string GetFullBreakdown()
    {
        var lines = new List<string>
        {
            "═══ MIRACLE WORKER ═══",
            $"Target: {TargetName}",
            $"HP Restored: {HpBefore} → {HpAfter} (+{TotalHealing})",
            $"Conditions Cleared: {ConditionsCleared}"
        };

        if (ClearedConditions.Any())
            lines.Add($"  Removed: {string.Join(", ", ClearedConditions)}");

        lines.Add($"Next Available: After long rest");
        lines.Add("═════════════════════");

        return string.Join("\n", lines);
    }

    protected override IEnumerable<object> GetEqualityComponents()
    {
        yield return TargetId;
        yield return HpBefore;
        yield return ConditionsCleared;
        yield return UsedAt;
    }
}
```

#### CapstoneUsageTracker

```csharp
/// <summary>
/// Tracks usage of capstone abilities with cooldown information.
/// Used for Miracle Worker and future capstone tracking.
/// </summary>
public sealed class CapstoneUsageTracker : ValueObject
{
    /// <summary>
    /// Unique identifier of the character with capstone ability.
    /// </summary>
    public Guid CharacterId { get; }

    /// <summary>
    /// ID of the capstone ability being tracked.
    /// </summary>
    public int CapstoneAbilityId { get; }

    /// <summary>
    /// Timestamp when the capstone was last used.
    /// Null if never used.
    /// </summary>
    public DateTime? LastUsedAt { get; }

    /// <summary>
    /// Timestamp when the capstone will be available again.
    /// Used for cooldown display and enforcement.
    /// </summary>
    public DateTime? NextAvailableAt { get; }

    /// <summary>
    /// Cooldown duration (e.g., 1 long rest cycle).
    /// </summary>
    public TimeSpan CooldownDuration { get; }

    /// <summary>
    /// Whether the capstone is currently available for use.
    /// </summary>
    public bool IsAvailable => NextAvailableAt == null || DateTime.UtcNow >= NextAvailableAt.Value;

    /// <summary>
    /// How many times the capstone has been used (lifetime).
    /// </summary>
    public int TimesUsed { get; }

    public CapstoneUsageTracker(
        Guid characterId,
        int capstoneAbilityId,
        TimeSpan cooldownDuration,
        DateTime? lastUsedAt = null,
        DateTime? nextAvailableAt = null,
        int timesUsed = 0)
    {
        if (characterId == Guid.Empty)
            throw new ArgumentException("Character ID cannot be empty.", nameof(characterId));

        CharacterId = characterId;
        CapstoneAbilityId = capstoneAbilityId;
        LastUsedAt = lastUsedAt;
        NextAvailableAt = nextAvailableAt;
        CooldownDuration = cooldownDuration;
        TimesUsed = timesUsed;
    }

    /// <summary>
    /// Returns a new tracker with updated usage information.
    /// Called after capstone is activated.
    /// </summary>
    public CapstoneUsageTracker RecordUsage(TimeSpan cooldownDuration)
    {
        var now = DateTime.UtcNow;
        var nextAvailable = now.Add(cooldownDuration);

        return new CapstoneUsageTracker(
            CharacterId,
            CapstoneAbilityId,
            cooldownDuration,
            lastUsedAt: now,
            nextAvailableAt: nextAvailable,
            timesUsed: TimesUsed + 1);
    }

    /// <summary>
    /// Returns remaining cooldown time, or zero if available.
    /// </summary>
    public TimeSpan GetRemainingCooldown()
    {
        if (!NextAvailableAt.HasValue || DateTime.UtcNow >= NextAvailableAt.Value)
            return TimeSpan.Zero;

        return NextAvailableAt.Value - DateTime.UtcNow;
    }

    /// <summary>
    /// Returns human-readable cooldown status.
    /// </summary>
    public string GetCooldownStatus()
    {
        if (IsAvailable)
            return "AVAILABLE";

        var remaining = GetRemainingCooldown();
        var days = remaining.Days;
        var hours = remaining.Hours;

        if (days > 0)
            return $"On cooldown ({days}d {hours}h remaining)";

        return $"On cooldown ({hours}h remaining)";
    }

    protected override IEnumerable<object> GetEqualityComponents()
    {
        yield return CharacterId;
        yield return CapstoneAbilityId;
        yield return LastUsedAt;
        yield return TimesUsed;
    }
}
```

---

## 5. Resuscitate Ability Specification

### 5.1 Ability Overview

| Attribute | Value |
|-----------|-------|
| **Ability Name** | Resuscitate |
| **Tier** | 3 (Tier 3) |
| **Type** | Active (Resurrection, Emergency) |
| **AP Cost** | 4 |
| **Range** | 2 spaces (melee range) |
| **Resource Cost** | 2 Medical Supplies |
| **Target** | Single unconscious character |
| **Effect** | Revive to 1 HP (conscious but vulnerable) |
| **Prerequisites** | Target must be at 0 HP |
| **Corruption Risk** | None (Coherent path) |

### 5.2 Mechanics

**Resuscitation Requirements:**

1. **Target Validation:** Target must be at 0 HP (unconscious)
2. **Range Check:** Target within 2 spaces
3. **AP Cost:** 4 AP required
4. **Supply Cost:** 2 Medical Supplies consumed
5. **No Prerequisites:** Works on any unconscious character (ally or friendly NPC)

**Resuscitation Effect:**

```
Before Resuscitate:
  Target: 0 HP (Unconscious)
  Status: Cannot act

After Resuscitate:
  Target: 1 HP (Conscious)
  Status: Can act next turn (if enough AP)
  Note: Vulnerable - only 1 HP, requires immediate healing
```

**Key Difference vs. Miracle Worker:**

| Aspect | Resuscitate | Miracle Worker |
|--------|-------------|---|
| HP After | 1 HP | Full HP |
| Conditions | Not cleared | All cleared |
| AP Cost | 4 | 5 |
| Supply Cost | 2 supplies | None |
| Cooldown | None | 1 long rest |
| Usage | Unlimited | Once per long rest |
| Strategy | Bring back fast | Full restoration |

### 5.3 Implementation Pseudocode

```csharp
public ResuscitateResult ExecuteResuscitate(
    Character caster,
    Character target,
    MedicalSuppliesResource supplies)
{
    // Validate inputs
    if (!IsInRange(caster, target, range: 2))
        throw new InvalidOperationException("Target out of range (max 2 spaces)");

    if (target.CurrentHp != 0)
        throw new InvalidOperationException("Target is not unconscious (must be at 0 HP)");

    if (!caster.CanPayAbilityCost(apCost: 4))
        throw new InvalidOperationException("Insufficient AP (requires 4)");

    if (supplies.GetTotalSupplyCount() < 2)
        throw new InvalidOperationException("Insufficient supplies (requires 2)");

    // Spend supplies (2 required)
    var newSupplies = supplies.SpendSupply(MedicalSupplyType.Bandage);
    newSupplies = newSupplies.SpendSupply(MedicalSupplyType.Salve);

    // Resuscitate target (bring to 1 HP)
    target.SetHp(1);
    target.ClearUnconsciousState();

    // Deduct AP
    caster.DeductAp(4);
    caster.SetMedicalSupplies(newSupplies);

    // Create result
    return new ResuscitateResult(
        targetId: target.Id,
        targetName: target.Name,
        hpBefore: 0,
        suppliesRemaining: newSupplies.GetTotalSupplyCount(),
        method: ResurrectionMethod.SkillBasedResuscitation,
        resurrectMessage: $"With steady hands and precise technique, you pull {target.Name} back from the edge.");
}
```

### 5.4 Strategic Considerations

**When to Use Resuscitate:**

```
Optimal Situations:
  • Ally falls mid-combat
  • Need to continue fighting (unlike long rest)
  • Party is not in immediate danger
  • Have 2+ Medical Supplies available
  • Can protect the vulnerable 1 HP target

Alternative to Resuscitate:
  • End combat, long rest, use Miracle Worker next battle
  • Flee and heal outside of combat
  • Use Miracle Worker if capstone is available
```

**Tactical Workflow:**

```
1. Ally reaches 0 HP → Unconscious
2. Bone-Setter identifies: Resuscitate vs. Miracle Worker decision
   └─ Many supplies left? → Use Resuscitate (unlimited uses)
   └─ Capstone available? → Save for Miracle Worker next day
3. Bone-Setter moves within 2 spaces
4. Bone-Setter uses Resuscitate (4 AP)
5. Ally returns to 1 HP (extremely vulnerable)
6. Party prioritizes healing the vulnerable ally
7. Combat continues with stronger party position
```

---

## 6. Preventive Care Ability Specification

### 6.1 Ability Overview

| Attribute | Value |
|-----------|-------|
| **Ability Name** | Preventive Care |
| **Tier** | 3 (Tier 3) |
| **Type** | Passive (Aura, Protection) |
| **AP Cost** | — (Always active) |
| **Range** | 5 space radius |
| **Resource Cost** | None |
| **Target** | All allies in radius |
| **Effect** | +1 to poison/disease saving throws |
| **Corruption Risk** | None (Coherent path) |

### 6.2 Mechanics

**Aura Effect:**

```
All allies within 5 spaces of the Bone-Setter receive:
  +1 bonus to poison saving throws
  +1 bonus to disease saving throws

This bonus applies to:
  • Poison resistance checks
  • Disease resistance checks
  • Antitoxin effectiveness
  • Plague resistance

This bonus does NOT apply to:
  • Other condition types (stun, prone, etc.)
  • Damage rolls
  • Attack rolls
  • Other non-poison/disease effects
```

**Aura Coverage Calculation:**

```
┌─ Evaluate each ally ────────────────────┐
│                                         │
│ For each character in party:            │
│   1. Calculate distance from Bone-Setter│
│   2. If distance ≤ 5 spaces:            │
│      ├─ Character gains +1 bonus        │
│      ├─ Bonus applies to all saves      │
│      └─ Include in aura coverage        │
│   3. If distance > 5 spaces:            │
│      ├─ Character does not benefit      │
│      └─ Out of aura radius              │
│                                         │
└─────────────────────────────────────────┘
```

**Aura Always Active:**

Preventive Care is a passive ability with no activation requirement. It automatically provides benefits whenever:

- Bone-Setter is in combat
- Any save throw vs. poison/disease occurs
- Any condition-resistance check occurs

### 6.3 Implementation Pseudocode

```csharp
/// <summary>
/// Passive ability granting +1 to poison/disease saves within aura.
/// Always active when Bone-Setter has this ability selected.
/// </summary>
public class PreventiveCarePassive : IPassiveAbility
{
    private const int AuraRadius = 5;
    private const int SavingThrowBonus = 1;

    public void OnSavingThrowAttempted(
        SavingThrowContext context,
        ref SavingThrowCalculation saveThrow)
    {
        // Only apply to poison/disease saves
        if (context.SaveType != SaveType.Poison && context.SaveType != SaveType.Disease)
            return;

        var caster = context.Defender;
        var boneSetterIds = GetAllBonesSettersInParty(caster.PartyMembers);

        foreach (var boneSetterId in boneSetterIds)
        {
            var boneSetter = GetCharacterById(boneSetterId);
            if (boneSetter == null || !boneSetter.HasAbility(BoneSetterAbilityId.PreventiveCare))
                continue;

            // Check if within aura radius
            if (IsWithinAuraRadius(caster, boneSetter, AuraRadius))
            {
                saveThrow.AddBonus(
                    bonusType: BonusType.PreventiveAura,
                    amount: SavingThrowBonus,
                    source: $"Preventive Care aura ({SaveThrowBonus}+ {context.SaveType} save)");
                return; // One aura per save attempt
            }
        }
    }

    private bool IsWithinAuraRadius(Character character, Character boneSetter, int radius) =>
        Math.Abs(character.Position.X - boneSetter.Position.X) <= radius &&
        Math.Abs(character.Position.Y - boneSetter.Position.Y) <= radius;
}
```

### 6.4 Interaction with Other Bonuses

**Preventive Care + Other Modifiers:**

```
Example: Fighter saves vs. poison

Base DC: 15
Fighter's base resistance: +2
Preventive Care bonus: +1
Other bonuses (items, buffs): +0
──────────────────────────
Final modifier: +3 to save roll

Roll needed: 12 + 3 = 15+ passes

With Preventive Care: Fighter has +1 additional help
```

---

## 7. Miracle Worker Capstone Specification

### 7.1 Ability Overview

| Attribute | Value |
|-----------|-------|
| **Ability Name** | Miracle Worker |
| **Tier** | Capstone (Ultimate) |
| **Type** | Active (Ultimate, Restoration) |
| **AP Cost** | 5 |
| **Range** | Self or single target (5 spaces) |
| **Resource Cost** | None |
| **Target** | Single character (usually self or most wounded) |
| **Effect** | Full HP restore + all conditions cleared |
| **Cooldown** | Once per long rest (cannot use twice per cycle) |
| **Corruption Risk** | None (Coherent path) |

### 7.2 Mechanics

**Miracle Worker Effect:**

```
Target Before Miracle Worker:
  HP: Any value (0 to full)
  Conditions: Multiple active
  Status: May be unconscious, poisoned, diseased, etc.

Activation:
  • Cost: 5 AP
  • No Medical Supplies required
  • Caster (or target) must be in range

Target After Miracle Worker:
  HP: Full (100%)
  Conditions: All cleared
  Status: Conscious, healthy, ready for action

Cooldown:
  • Duration: Until next long rest
  • Usage: Once per long rest cycle
  • Enforcement: Cannot use twice in same cycle
```

**Condition Clearing Scope:**

```
Miracle Worker clears ALL conditions including:
  ✓ Poison
  ✓ Disease
  ✓ Stun/Incapacitation
  ✓ Prone
  ✓ Blinded
  ✓ Deafened
  ✓ Petrified
  ✓ Cursed
  ✓ Any negative effect

Miracle Worker does NOT:
  ✗ Affect equipment cursed items (separate system)
  ✗ Remove beneficial conditions
  ✗ Restore lost resources (spells, abilities)
  ✗ Resurrect if target is dead (only unconscious)
```

### 7.3 Cooldown Management

**Cooldown Mechanics:**

```
Initial State (Fresh):
  ├─ Miracle Worker available
  ├─ Cooldown tracker: "Ready"
  └─ Button shows: AVAILABLE

After Activation:
  ├─ Miracle Worker used
  ├─ Cooldown tracker: Records usage
  ├─ Next available: After next long rest
  ├─ Duration: 1 full rest cycle
  └─ Button shows: ON COOLDOWN (Resets after rest)

After Long Rest:
  ├─ Time advances
  ├─ Long rest completes
  ├─ Cooldown expires
  ├─ Miracle Worker available again
  └─ Button shows: AVAILABLE
```

**Long Rest Integration:**

```
Party Long Rest Sequence:

1. Party decides to rest
2. Time advances (8 hours typical)
3. All resources reset:
   ├─ HP restored
   ├─ AP restored
   ├─ Medical Supplies NOT restored (consumable)
   └─ Capstone cooldowns RESET
4. Bone-Setter's Miracle Worker available again

Cycle Repeats Next Battle
```

### 7.4 Strategic Considerations

**When to Use Miracle Worker vs. Resuscitate:**

```
Miracle Worker Better If:
  • Target is in truly critical condition (multiple effects)
  • Party won't rest soon
  • Capstone is available
  • Want guaranteed full healing
  • Want all conditions cleared simultaneously

Resuscitate Better If:
  • Only need to bring back 1 HP (faster recovery option)
  • Capstone on cooldown
  • Party will rest soon (save capstone for next fight)
  • Have many Medical Supplies
  • Need to preserve capstone for upcoming harder battle
```

### 7.5 Implementation Pseudocode

```csharp
public async Task<MiracleWorkerResult> ExecuteMiracleWorker(
    Guid casterId,
    Guid targetId,
    CancellationToken cancellationToken = default)
{
    var caster = await GetCharacter(casterId, cancellationToken);
    var target = await GetCharacter(targetId, cancellationToken);

    // Validate prerequisites
    if (!caster.CanPayAbilityCost(apCost: 5))
        throw new InvalidOperationException("Insufficient AP (requires 5)");

    // Check cooldown
    var usageTracker = await GetCapstoneTracker(casterId, BoneSetterAbilityId.MiracleWorker);
    if (!usageTracker.IsAvailable)
        throw new InvalidOperationException(
            $"Miracle Worker on cooldown: {usageTracker.GetCooldownStatus()}");

    // Get all active conditions on target
    var activeConditions = target.GetActiveConditions();

    // Apply healing
    var hpBefore = target.CurrentHp;
    target.SetHp(target.MaxHp);

    // Clear all conditions
    foreach (var condition in activeConditions)
    {
        target.RemoveCondition(condition.Id);
    }

    // Deduct AP
    caster.DeductAp(5);

    // Update cooldown (available after next long rest)
    var nextAvailableAfterRest = DateTime.UtcNow.AddHours(8); // Assuming 8-hour rest
    var newTracker = usageTracker.RecordUsage(TimeSpan.FromHours(8));
    await UpdateCapstoneTracker(newTracker, cancellationToken);

    // Persist changes
    await UpdateCharacter(caster, cancellationToken);
    await UpdateCharacter(target, cancellationToken);

    // Create result
    var result = new MiracleWorkerResult(
        targetId: target.Id,
        targetName: target.Name,
        hpBefore: hpBefore,
        maxHp: target.MaxHp,
        clearedConditions: activeConditions.Select(c => c.Name),
        availableAt: nextAvailableAfterRest,
        miracleMessage: $"You channel every ounce of your healing power into {target.Name}, " +
                       $"reversing fate itself and restoring them to perfect health.");

    return result;
}
```

---

## 8. Cooldown & Resource Management

### 8.1 Cooldown State Persistence

```
Database Schema: CapstoneUsageTracking

CapstoneUsageRecords
├─ CharacterId (FK)
├─ CapstoneAbilityId
├─ LastUsedAt (DateTime nullable)
├─ NextAvailableAt (DateTime nullable)
├─ TimesUsedLifetime (int)
└─ CreatedAt (DateTime)

Queries:
  • GetCapstoneStatus(characterId, abilityId)
  • IsCapstoneAvailable(characterId, abilityId)
  • RecordCapstoneUsage(characterId, abilityId, newAvailableTime)
  • GetCapstoneHistorian(characterId, abilityId) - all-time stats
```

### 8.2 Long Rest Cooldown Reset

```
Party Long Rest Handler:

on_long_rest_completed():
  for each character in party:
    for each capstone ability they have:
      tracker = get_capstone_tracker(character, ability)
      if tracker.NextAvailableAt <= current_time:
        ✓ Capstone already available
      else:
        tracker.NextAvailableAt = null  // Reset
        save_tracker(tracker)

Result: All capstones reset after long rest, ready to use next day
```

---

## 9. User Stories & Scenarios

### 9.1 User Stories

**Story 1: Resuscitate Fallen Ally**

```
As a Bone-Setter in combat
I want to use Resuscitate on a fallen ally
So that I can bring them back into the fight immediately

Acceptance Criteria:
✓ Can target any unconscious ally within 2 spaces
✓ Costs 4 AP and 2 Medical Supplies
✓ Restores target to 1 HP
✓ Target becomes conscious and can act next turn
✓ No cooldown (unlimited uses)
✓ Result shows resurrection message
```

**Story 2: Benefit from Preventive Care Aura**

```
As an ally in a party with Bone-Setter
I want to benefit from Preventive Care aura
So that I have better chance of resisting poison and disease

Acceptance Criteria:
✓ Within 5 spaces of Bone-Setter
✓ Automatically receive +1 to poison saves
✓ Automatically receive +1 to disease saves
✓ Bonus applies to all related saving throws
✓ No activation needed (passive)
```

**Story 3: Use Miracle Worker Capstone**

```
As a Bone-Setter with Miracle Worker unlocked
I want to use my capstone ability
So that I can fully restore an ally and clear all conditions

Acceptance Criteria:
✓ Costs 5 AP
✓ No resource cost
✓ Heals target to full HP
✓ Clears all conditions
✓ Can be used once per long rest
✓ Shows cooldown after use
✓ Cooldown resets after long rest
```

### 9.2 Epic Campaign Scenarios

**Scenario A: Final Boss Fight - Resuscitate Chain**

```
Situation:
- Boss fight, multiple rounds
- Party has taken damage
- Fighter knocked unconscious
- Bone-Setter has 2 long rests' worth of supplies

Turn Sequence:
1. Fighter reaches 0 HP (unconscious)
2. Bone-Setter uses Resuscitate (4 AP, 2 supplies)
   Fighter: 0 → 1 HP (conscious but vulnerable)

3. Next round, Rogue heals Fighter (other resource)
   Fighter: 1 → 25 HP (recovering)

4. Turns pass, Fighter takes damage again
   Fighter: 25 → 0 HP (unconscious again)

5. Bone-Setter uses Resuscitate AGAIN (4 AP, 2 supplies)
   Fighter: 0 → 1 HP (conscious again)

6. Party defeats boss with Bone-Setter's repeated interventions

Key: Unlimited Resuscitates enable epic last-stand scenarios
```

**Scenario B: Climactic Victory - Miracle Worker Deploy**

```
Situation:
- Final dungeon, boss nearly defeated
- Party is battered
- Ranger unconscious (5+ conditions)
- Bone-Setter Miracle Worker available

Turn Sequence:
1. Ranger at 0 HP with:
   ├─ Poison
   ├─ Disease
   ├─ Blinded
   ├─ Prone
   └─ Weakened

2. Bone-Setter activates Miracle Worker (5 AP)

   Effect:
   ├─ Ranger: 0 → 100 HP (full restoration)
   ├─ Poison: CLEARED
   ├─ Disease: CLEARED
   ├─ Blinded: CLEARED
   ├─ Prone: CLEARED
   └─ Weakened: CLEARED

3. Ranger stands up ready for action
   ├─ Conscious and healthy
   ├─ No conditions
   ├─ Full AP available for action

4. Ranger delivers killing blow

Narrative: "Keeper of Life" title truly earned
Mechanical Impact: Game-changing capstone ability
```

**Scenario C: Strategy - Cooldown Resource**

```
Situation:
- Day 1: Major battle, Bone-Setter uses Miracle Worker on dying Ranger
- Party explores dungeon floor 1
- Party rests (8 hours) → Miracle Worker resets
- Day 2: Two encounters expected

Strategic Decision:
- Encounter 1: Use Resuscitate (unlimited)
  └─ Save Miracle Worker for harder Encounter 2

- Encounter 2: Reach critical point
  └─ Deploy Miracle Worker as trump card
  └─ Party survives and continues

Key: Cooldown enforces strategic planning
```

---

## 10. Application Service Layer

### 10.1 ResuscitateService

```csharp
/// <summary>
/// Application service managing Resuscitate ability execution.
/// Handles resurrection of unconscious characters.
/// </summary>
public class ResuscitateService : IApplicationService
{
    private readonly MedicalSuppliesService _suppliesService;
    private readonly ICharacterRepository _characterRepository;
    private readonly ILogger<ResuscitateService> _logger;

    public ResuscitateService(
        MedicalSuppliesService suppliesService,
        ICharacterRepository characterRepository,
        ILogger<ResuscitateService> logger)
    {
        _suppliesService = suppliesService;
        _characterRepository = characterRepository;
        _logger = logger;
    }

    public async Task<ResuscitateResult> ExecuteResuscitate(
        Guid casterId,
        Guid targetId,
        CancellationToken cancellationToken = default)
    {
        _logger.LogInformation(
            "Starting Resuscitate execution: caster={Caster}, target={Target}",
            casterId,
            targetId);

        var caster = await _characterRepository.GetById(casterId, cancellationToken);
        var target = await _characterRepository.GetById(targetId, cancellationToken);

        if (caster == null || target == null)
            throw new InvalidOperationException("Caster or target not found");

        // Validate prerequisites
        if (!caster.HasSpecialization(SpecializationId.BoneSetter))
            throw new InvalidOperationException("Character is not a Bone-Setter");

        if (!caster.CanPayAbilityCost(apCost: 4))
            throw new InvalidOperationException("Insufficient AP (requires 4)");

        if (!IsInRange(caster, target, range: 2))
            throw new InvalidOperationException("Target out of range (max 2 spaces)");

        if (target.CurrentHp != 0)
            throw new InvalidOperationException("Target is not unconscious");

        var supplies = caster.GetMedicalSupplies();
        if (supplies.GetTotalSupplyCount() < 2)
            throw new InvalidOperationException("Insufficient Medical Supplies (requires 2)");

        // Spend supplies
        var newSupplies = supplies.SpendSupply(MedicalSupplyType.Bandage);
        newSupplies = newSupplies.SpendSupply(MedicalSupplyType.Salve);

        // Resuscitate target
        target.SetHp(1);
        target.ClearUnconsciousState();

        // Update state
        caster.SetMedicalSupplies(newSupplies);
        caster.DeductAp(4);

        await _characterRepository.Update(caster, cancellationToken);
        await _characterRepository.Update(target, cancellationToken);

        var result = new ResuscitateResult(
            targetId: target.Id,
            targetName: target.Name,
            hpBefore: 0,
            suppliesRemaining: newSupplies.GetTotalSupplyCount(),
            method: ResurrectionMethod.SkillBasedResuscitation,
            resurrectMessage: $"{target.Name} gasps back to consciousness!");

        _logger.LogInformation("Resuscitate executed: {Result}", result.GetStatusMessage());
        return result;
    }

    private bool IsInRange(Character caster, Character target, int range) =>
        Math.Abs(caster.Position.X - target.Position.X) <= range &&
        Math.Abs(caster.Position.Y - target.Position.Y) <= range;
}
```

### 10.2 MiracleWorkerService

```csharp
/// <summary>
/// Application service managing Miracle Worker capstone execution.
/// Handles full restoration with cooldown tracking.
/// </summary>
public class MiracleWorkerService : IApplicationService
{
    private readonly ICharacterRepository _characterRepository;
    private readonly ICapstoneUsageRepository _capstoneRepository;
    private readonly ILogger<MiracleWorkerService> _logger;

    private const int ApCost = 5;
    private const int CooldownHours = 8; // Duration of long rest

    public MiracleWorkerService(
        ICharacterRepository characterRepository,
        ICapstoneUsageRepository capstoneRepository,
        ILogger<MiracleWorkerService> logger)
    {
        _characterRepository = characterRepository;
        _capstoneRepository = capstoneRepository;
        _logger = logger;
    }

    public async Task<MiracleWorkerResult> ExecuteMiracleWorker(
        Guid casterId,
        Guid targetId,
        CancellationToken cancellationToken = default)
    {
        _logger.LogInformation(
            "Starting Miracle Worker execution: caster={Caster}, target={Target}",
            casterId,
            targetId);

        var caster = await _characterRepository.GetById(casterId, cancellationToken);
        var target = await _characterRepository.GetById(targetId, cancellationToken);

        if (caster == null || target == null)
            throw new InvalidOperationException("Caster or target not found");

        // Validate prerequisites
        if (!caster.HasSpecialization(SpecializationId.BoneSetter))
            throw new InvalidOperationException("Character is not a Bone-Setter");

        if (!caster.CanPayAbilityCost(apCost: ApCost))
            throw new InvalidOperationException($"Insufficient AP (requires {ApCost})");

        // Check cooldown
        var usageTracker = await _capstoneRepository.GetTracker(
            casterId,
            BoneSetterAbilityId.MiracleWorker,
            cancellationToken);

        if (!usageTracker.IsAvailable)
            throw new InvalidOperationException(
                $"Miracle Worker on cooldown: {usageTracker.GetCooldownStatus()}");

        // Get target conditions before clearing
        var activeConditions = target.GetActiveConditions();
        var hpBefore = target.CurrentHp;

        // Apply miracle
        target.SetHp(target.MaxHp);
        foreach (var condition in activeConditions)
        {
            target.RemoveCondition(condition.Id);
        }

        // Update capstone cooldown
        var nextAvailable = DateTime.UtcNow.AddHours(CooldownHours);
        var newTracker = usageTracker.RecordUsage(TimeSpan.FromHours(CooldownHours));

        // Update state
        caster.DeductAp(ApCost);

        await _characterRepository.Update(caster, cancellationToken);
        await _characterRepository.Update(target, cancellationToken);
        await _capstoneRepository.UpdateTracker(newTracker, cancellationToken);

        var result = new MiracleWorkerResult(
            targetId: target.Id,
            targetName: target.Name,
            hpBefore: hpBefore,
            maxHp: target.MaxHp,
            clearedConditions: activeConditions.Select(c => c.Name),
            availableAt: nextAvailable,
            miracleMessage: "A miraculous intervention - fate itself is rewritten!");

        _logger.LogInformation("Miracle Worker executed: {Result}", result.GetStatusMessage());
        return result;
    }
}
```

---

## 11. Configuration Specifications

### 11.1 abilities.json Tier 3 & Capstone Entries

```json
{
  "abilities": [
    {
      "id": 606,
      "specialization": "bone-setter",
      "name": "Resuscitate",
      "abbreviation": "RES",
      "tier": 3,
      "type": "active",
      "complexity": "high",
      "version": "v0.20.6c",
      "apCost": 4,
      "range": {
        "type": "distance",
        "distance": 2,
        "unit": "spaces"
      },
      "targeting": {
        "targetType": "single_character",
        "allowAlly": true,
        "allowEnemy": false,
        "allowSelf": false,
        "requiresUnconsciousness": true
      },
      "resourceCost": {
        "type": "medical_supply",
        "amount": 2,
        "specificType": null
      },
      "effect": {
        "type": "resurrection",
        "method": "skill_based_resuscitation",
        "targetHp": 1,
        "cooldown": null,
        "unlimited": true
      },
      "corruptionRisk": "none",
      "description": "Bring an unconscious ally within 2 spaces back to consciousness, restoring them to 1 HP. Requires 2 Medical Supplies and 4 AP.",
      "flavorText": "You kneel beside your fallen companion and perform emergency resuscitation, pulling them back from death's threshold with skill and determination.",
      "combatNotes": "Unlimited uses (no cooldown). Target becomes conscious at 1 HP (extremely vulnerable). Used to quickly restore unconscious allies during combat."
    },
    {
      "id": 607,
      "specialization": "bone-setter",
      "name": "Preventive Care",
      "abbreviation": "PC",
      "tier": 3,
      "type": "passive",
      "complexity": "low",
      "version": "v0.20.6c",
      "apCost": 0,
      "range": {
        "type": "radius",
        "distance": 5,
        "unit": "spaces"
      },
      "targeting": {
        "targetType": "auto_all_allies",
        "allowAlly": true,
        "allowEnemy": false,
        "allowSelf": false
      },
      "resourceCost": null,
      "effect": {
        "type": "passive_aura",
        "affectedSaveTypes": [
          "poison",
          "disease"
        ],
        "bonusType": "flat",
        "bonusAmount": 1,
        "radius": 5,
        "description": "All allies within 5 spaces gain +1 to poison and disease saving throws"
      },
      "corruptionRisk": "none",
      "description": "Your expertise in medicine extends to your companions. All allies within 5 spaces gain +1 to saving throws against poison and disease.",
      "flavorText": "Your presence itself is protective - allies stand taller, more resilient against the world's poisons and plagues.",
      "combatNotes": "Always active aura (no activation). Bonus applies automatically to qualifying saves. Affects all allies, not just direct allies."
    },
    {
      "id": 608,
      "specialization": "bone-setter",
      "name": "Miracle Worker",
      "abbreviation": "MW",
      "tier": "capstone",
      "type": "active",
      "complexity": "ultimate",
      "version": "v0.20.6c",
      "apCost": 5,
      "range": {
        "type": "distance",
        "distance": 5,
        "unit": "spaces"
      },
      "targeting": {
        "targetType": "single_character_or_self",
        "allowAlly": true,
        "allowEnemy": false,
        "allowSelf": true
      },
      "resourceCost": null,
      "effect": {
        "type": "capstone_restoration",
        "healing": {
          "type": "full_hp",
          "formula": "target.MaxHp"
        },
        "conditionClear": {
          "type": "all_conditions",
          "scope": "all_negative_effects"
        },
        "cooldown": {
          "type": "long_rest",
          "duration": "until_next_long_rest",
          "usesPerCycle": 1
        }
      },
      "corruptionRisk": "none",
      "description": "Channel all your knowledge and power into a miraculous intervention. Restore target to full HP and clear all conditions. Can be used once per long rest.",
      "flavorText": "You reach the limits of your craft and step beyond - fate itself bends to your will, restoring your companion to perfect health.",
      "combatNotes": "Ultimate ability. No resource cost. Fully restores HP and clears all conditions. Cooldown resets after each long rest. Strategic trump card ability."
    }
  ]
}
```

---

## 12. Command Examples & Output

### 12.1 Resuscitate Execution

```
> ability resuscitate target:ranger

Executing: Resuscitate
  Target: Ranger (Unconscious)
  Range: 2 spaces ✓
  Medical Supplies: 6/10 ✓
  AP Cost: 4 ✓

Resuscitation Process:
  Ranger Status Before: 0 HP (Unconscious)
  Supplies Consumed: 2 (Bandage + Salve)
  HP Restored: 1 HP (Conscious)

Result:
  Ranger: 0 → 1 HP (RESURRECTED!)
  Medical Supplies: 6 → 4 (2 used)
  Status: Conscious but extremely vulnerable

Message: Ranger has been RESURRECTED! (0 → 1 HP, conscious)
Recommendation: Protect the vulnerable Ranger until healed further

Next Turn Strategy:
  • Party prioritizes protecting 1 HP Ranger
  • Use Field Dressing or other heal to stabilize
  • Ranger can act if enough AP generated
```

### 12.2 Preventive Care Aura Status

```
> ability status preventiveCare

Preventive Care Aura Status:
  Status: ACTIVE
  Radius: 5 spaces

Aura Coverage:
  ┌─ Bone-Setter (Center)
  │  ├─ Affected Ally: Fighter (adjacent)
  │  │  ├─ Distance: 1 space ✓
  │  │  ├─ Bonus: +1 poison saves
  │  │  └─ Bonus: +1 disease saves
  │  │
  │  ├─ Affected Ally: Rogue (diagonal)
  │  │  ├─ Distance: 2 spaces ✓
  │  │  ├─ Bonus: +1 poison saves
  │  │  └─ Bonus: +1 disease saves
  │  │
  │  └─ Unaffected: Ranger
  │     ├─ Distance: 7 spaces ✗
  │     ├─ Outside radius
  │     └─ No bonus

Affected Allies: 2/3
  • Fighter: In aura, +1 saves
  • Rogue: In aura, +1 saves
  • Ranger: Out of aura, no bonus

Example Save Check:
  Rogue vs. Poison (DC 12):
    Roll: 1d20 + 4 (base) + 1 (Preventive Care) = 14+ PASSES
    Bonus prevented failure!
```

### 12.3 Miracle Worker Execution

```
> ability miracleWorker target:fighter

Executing: Miracle Worker
  Target: Fighter
  AP Cost: 5 ✓
  Cooldown Status: AVAILABLE ✓

Fighter Status Before:
  HP: 15/100 (Severely Wounded)
  Conditions:
    • Poison (2 turns remaining)
    • Blinded
    • Weakened (-2 ATK)

Miracle Worker Activates:
  ═══════════════════════════
  MIRACLE WORKER
  ═══════════════════════════

  Full Restoration:
    HP: 15 → 100 (Full restoration)

  Conditions Cleared:
    ✓ Poison - REMOVED
    ✓ Blinded - REMOVED
    ✓ Weakened - REMOVED

Fighter Status After:
  HP: 100/100 (Perfect)
  Conditions: None (All cleared)
  Status: Fully healed and ready

Cooldown Status:
  Miracle Worker: ON COOLDOWN
  Duration: Until next long rest
  Next Available: After 8-hour rest

Message: MIRACLE WORKER: Fighter FULLY RESTORED!
         (15 → 100 HP, 3 conditions cleared)

Capability Locked:
  Miracle Worker available again: After party long rests
```

---

## 13. State Machine Diagrams

### 13.1 Resuscitate State Machine

```
          [IDLE]
            │
            │ Player targets
            │ unconscious ally
            ▼
  ┌─[VALIDATION]──────────┐
  │                        │
  │ Target at 0 HP?        │
  │ Range ≤ 2?             │
  │ AP ≥ 4?                │
  │ Supplies ≥ 2?          │
  │                        │
  └───┬──────┬─────────────┘
      │      │
PASS  │      │ FAIL
      │      │
      ▼      ▼
  [EXECUTE] [ERROR]
      │
      ├─[CONSUME_SUPPLIES]
      │  ├─ Spend supply 1
      │  └─ Spend supply 2
      │
      ├─[REVIVE]
      │  ├─ Set target HP to 1
      │  └─ Clear unconscious
      │
      ├─[UPDATE]
      │  ├─ AP deducted
      │  ├─ Supplies updated
      │  └─ Target awakened
      │
      ├─[CREATE_RESULT]
      │  ├─ Build result
      │  └─ Resurrection message
      │
      ├─[PERSIST]
      │  └─ Save to database
      │
      └─[SUCCESS]
         └─ Return to IDLE
```

### 13.2 Miracle Worker Cooldown State Machine

```
┌───────────────────────────────────────┐
│      Miracle Worker Cooldown Cycle    │
└───────────────────────────────────────┘

    [READY]
      │
      │ Player casts Miracle Worker
      │
      ▼
  [RESOLVING]
      │
      ├─ Validate AP and cooldown
      ├─ Restore target to full HP
      ├─ Clear all conditions
      ├─ Record usage timestamp
      ├─ Calculate next available time
      │  └─ Current + 8 hours (long rest)
      │
      ▼
  [COOLDOWN]
      │
      ├─ Ability locked
      ├─ UI shows "ON COOLDOWN"
      ├─ Cannot use again
      │  (even with multiple long rests)
      │
      ▼ [Time passes during rest phase]
      │
    [REST_COMPLETED]
      │
      ├─ Party completes long rest
      ├─ Timestamp advances to next cycle
      ├─ Cooldown check: Time >= NextAvailable?
      │  └─ YES → Proceed to AVAILABLE
      │
      ▼
  [AVAILABLE]
      │
      ├─ Miracle Worker ready
      ├─ UI shows "AVAILABLE"
      ├─ Can use again next combat
      │
      └─ Cycle repeats...
```

---

## 14. Logging Specifications

| Level | Event | Message Template |
|-------|-------|------------------|
| INFO | Resuscitate Start | "Starting Resuscitate: caster={}, target={}" |
| INFO | Resuscitate Success | "Resuscitate executed: {} → 1 HP (resurrected)" |
| INFO | Miracle Worker Start | "Starting Miracle Worker: caster={}, target={}" |
| INFO | Miracle Worker Success | "Miracle Worker executed: {} fully restored, {} conditions cleared" |
| INFO | Miracle Worker Cooldown Record | "Miracle Worker cooldown recorded: next available {}" |
| WARN | Cooldown Enforced | "Miracle Worker on cooldown, cannot use until {}" |
| DEBUG | Condition Clearing | "Clearing condition: {} from {}" |
| ERROR | Resuscitate Failed | "Resuscitate failed: {reason}" |
| ERROR | Miracle Worker Locked | "Miracle Worker locked by cooldown" |

---

## 15. Unit Testing Requirements

```csharp
namespace BoneSetterTests.Application
{
    public class ResuscitateServiceTests
    {
        [Fact]
        public async Task ExecuteResuscitate_WithUnconsciousTarget_RestoresToOneHP() { }

        [Fact]
        public async Task ExecuteResuscitate_ConsciousTarget_ThrowsInvalidOperationException() { }

        [Fact]
        public async Task ExecuteResuscitate_InsufficientSupplies_ThrowsInvalidOperationException() { }

        [Fact]
        public async Task ExecuteResuscitate_Spends2Supplies_UpdatesInventory() { }
    }

    public class MiracleWorkerServiceTests
    {
        [Fact]
        public async Task ExecuteMiracleWorker_WithAvailableCooldown_RestoresFullHP() { }

        [Fact]
        public async Task ExecuteMiracleWorker_OnCooldown_ThrowsInvalidOperationException() { }

        [Fact]
        public async Task ExecuteMiracleWorker_ClearsAllConditions_RemovesNegativeEffects() { }

        [Fact]
        public async Task ExecuteMiracleWorker_RecordsCooldown_LocksForNextRest() { }

        [Fact]
        public async Task MiracleWorkerCooldown_AfterLongRest_ResetsAvailability() { }

        [Fact]
        public async Task CapstoneUsageTracker_CalculatesCorrectCooldown_Duration() { }
    }
}
```

---

## 16. Deliverable Checklist

- [ ] ResuscitateResult value object
- [ ] PreventiveCareAura value object
- [ ] MiracleWorkerResult value object
- [ ] CapstoneUsageTracker value object
- [ ] ResurrectionMethod enum
- [ ] ResuscitateService
- [ ] MiracleWorkerService
- [ ] Resuscitate ability implementation
- [ ] Preventive Care ability implementation
- [ ] Miracle Worker ability implementation
- [ ] Cooldown persistence layer
- [ ] Long rest integration
- [ ] abilities.json updated (Tier 3 + Capstone)
- [ ] ~7 unit tests covering critical paths
- [ ] Logging specifications implemented

---

## 17. Acceptance Criteria

| Criteria | Status |
|----------|--------|
| Resuscitate costs 4 AP, 2 supplies | ✓ |
| Resuscitate requires target at 0 HP | ✓ |
| Resuscitate restores to 1 HP | ✓ |
| Resuscitate has no cooldown | ✓ |
| Preventive Care provides +1 to poison/disease saves | ✓ |
| Preventive Care affects all allies in 5-space radius | ✓ |
| Preventive Care is always active | ✓ |
| Miracle Worker costs 5 AP | ✓ |
| Miracle Worker fully restores HP | ✓ |
| Miracle Worker clears all conditions | ✓ |
| Miracle Worker cooldown is 1 long rest | ✓ |
| Cooldown resets after long rest | ✓ |
| Miracle Worker available once per rest cycle | ✓ |
| All abilities log correctly | ✓ |
| No Corruption risk for any Tier 3 ability | ✓ |
| Tier 3 integrates with Tier 1 & 2 | ✓ |

---

## 18. Dependencies & Prerequisites

- [ ] v0.20.6a (Bone-Setter Tier 1) - REQUIRED
- [ ] v0.20.6b (Bone-Setter Tier 2) - REQUIRED
- [ ] Character condition/status system
- [ ] Long rest game mechanics
- [ ] Cooldown persistence framework

---

## 19. Design Decisions & Rationale

**Resuscitate at 1 HP:** Allows immediate revival but forces party to follow up with healing - prevents "spam resuscitate" trivializing combat.

**Preventive Care +1:** Small, constant bonus feels like passive protection rather than game-changer. Encourages positioning strategy.

**Miracle Worker Capstone:** Full heal + condition clear makes it feel truly "miraculous" and worth the cooldown. 5 AP cost prevents casual use.

**One-Per-Rest Cooldown:** Enforces strategic planning - choose when to deploy capstone wisely.

---

**Document End - Total Lines:** ~1,550

---

**All 3 Design Specifications Complete**

v0.20.6a: Tier 1 Framework (~2,450 lines)
v0.20.6b: Tier 2 Advancement (~1,950 lines)
v0.20.6c: Tier 3 & Capstone (~1,550 lines)

**Total: ~5,950 lines of comprehensive design documentation**

**Status:** All three specifications ready for implementation
