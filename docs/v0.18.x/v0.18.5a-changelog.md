# Changelog v0.18.5a — Trauma Economy State Aggregation

## Summary

Implemented the unified `TraumaEconomyState` entity and `TraumaEconomySnapshot` value object, providing a single aggregation layer for all trauma economy components (Stress, Corruption, CPS, Trauma, and Specialization Resources).

## Added

### Domain Layer — Enums

- **`WarningLevel.cs`**: New enum categorizing overall trauma economy severity
    - `None` (0): All systems stable
    - `Warning` (1): Any system ≥60%
    - `Critical` (2): Any system ≥80%
    - `Terminal` (3): Any system at 100%

### Domain Layer — Entities

- **`TraumaEconomyState.cs`**: Aggregate entity for trauma economy components
    - Stores `CharacterId`, `StressState`, `CorruptionState`, `CpsState`, `Traumas`, and `SpecializationResource`
    - Computed properties for effective stats:
        - `EffectiveMaxHp`: BaseHP × (1 - StageOrdinal × 0.05)
        - `EffectiveMaxAp`: BaseAP × (1 - StageOrdinal × 0.05)
        - `EffectiveResolve`: BaseResolve - StageOrdinal (clamped ≥1)
    - Penalty aggregation:
        - `TotalDefensePenalty`: From stress threshold
        - `TotalSkillPenalty`: Stress disadvantage + CPS logic disadvantage
    - State detection:
        - `IsCriticalState`: Any system ≥80%
        - `IsTerminalState`: Any system at 100%
        - `HasMultipleCriticalSystems`: 2+ systems in critical
    - Warning system:
        - `GetWarningLevel()`: Calculates overall warning tier
        - `ActiveWarnings`: List of contextual warning messages
        - `ActiveTraumaIds`: Aggregated trauma definition IDs
    - Factory method `Create()` with validation

### Domain Layer — Value Objects

- **`TraumaEconomySnapshot.cs`**: Immutable point-in-time capture
    - Captures all trauma economy values for logging and comparison
    - Properties for stress, corruption, CPS, traumas, specialization resource
    - Computed properties: `WarningLevel`, `WasCritical`, `WasTerminal`
    - Factory method `Create(state, capturedAt?)` from live state
    - `Empty` static property for baseline comparisons
    - `IsValid()` for snapshot integrity verification

### Unit Tests

- **`TraumaEconomyStateTests.cs`**: 30 test cases
    - Factory method validation
    - Effective stat calculations (HP, AP, Resolve)
    - Penalty calculations (defense, skill)
    - Critical/terminal state detection
    - Warning system verification
- **`TraumaEconomySnapshotTests.cs`**: 12 test cases
    - Snapshot creation from state
    - Empty snapshot defaults
    - Validation logic
    - Derived property capture
    - Value equivalence

## Technical Notes

### Design Decisions

1. **Stage-Based Penalties**: Used `CorruptionStage` ordinal for HP/AP/Resolve calculations since percentage-based penalty properties don't exist yet in `CorruptionState`
2. **Trauma Effect Lookup**: Changed from `ActiveTraumaEffects` to `ActiveTraumaIds` since effects are on `TraumaDefinition`, not `CharacterTrauma`
3. **Skill Disadvantage**: Converted `StressState.HasSkillDisadvantage` (bool) to int (1/0) for penalty stacking

### Test Results

- Total v0.18.5a tests: 42
- All passing: ✅
- No regressions in existing tests

## Files Changed

| Path                                                                | Change |
| ------------------------------------------------------------------- | ------ |
| `src/Core/RuneAndRust.Domain/Enums/WarningLevel.cs`                 | Added  |
| `src/Core/RuneAndRust.Domain/Entities/TraumaEconomyState.cs`        | Added  |
| `src/Core/RuneAndRust.Domain/ValueObjects/TraumaEconomySnapshot.cs` | Added  |
| `tests/.../Entities/TraumaEconomyStateTests.cs`                     | Added  |
| `tests/.../ValueObjects/TraumaEconomySnapshotTests.cs`              | Added  |
