> **Archived** - This changelog has been consolidated. See the complete version at [v0.3.13](../v0.3.x/v0.3.13.md).

# Changelog: v0.3.13b - The Combat Simulator

**Release Date:** 2025-12-24
**Total Tests:** 40 new tests added (24 unit + 16 integration)

## Table of Contents

- [Summary](#summary)
- [New Files Created](#new-files-created)
- [Files Modified](#files-modified)
- [Code Implementation Details](#code-implementation-details)
- [Architecture & Data Flow](#architecture--data-flow)
- [Decision Trees](#decision-trees)
- [Logging Matrix](#logging-matrix)
- [Test Coverage](#test-coverage)
- [CLI Usage Guide](#cli-usage-guide)
- [Report Output Format](#report-output-format)
- [Design Decisions](#design-decisions)
- [Verification Results](#verification-results)
- [Directory Structure](#directory-structure)
- [Next Steps](#next-steps)
- [Credits](#credits)

---

## Summary

Version 0.3.13b introduces the **Combat Audit Tool**, a Monte Carlo simulation engine for validating combat balance. Developers can now run thousands of simulated battles instantly to measure win rates, TTK (Time-To-Kill), hit rates, and resource consumption before players encounter them.

**Layers Touched:**
- **Core Layer:** New `CombatStatistics` model, `ICombatAuditService` interface with supporting records
- **Engine Layer:** `CombatAuditService` implementation with headless combat loop, `SimulatedPlayerAgent` for AI-controlled player actions, synchronous enemy turn processing
- **Terminal Layer:** CLI argument handling (`--audit-combat`) with parameter parsing
- **Test Layer:** 24 unit tests for statistics model, 16 integration tests for audit service

**Patterns Introduced:**
- **Headless Combat Loop Pattern:** Run combat without TUI rendering or UX delays
- **Simulated Player Agent Pattern:** Heuristic AI that makes "reasonable" resource-aware attack decisions
- **Synchronous Turn Processing Pattern:** `ProcessEnemyTurnSync()` variant without 750ms UX delay
- **Combat Statistics Accumulator Pattern:** Track wins, hits, damage, rounds across thousands of matches
- **Variance Flagging Pattern:** Compare actual vs expected metrics, classify severity (OK/WARN/CRIT)

**Key Metrics:**
- 6 new files created
- 3 files modified
- 40 new tests (24 unit + 16 integration)
- 100% test pass rate for new tests
- Sequential execution for thread safety (no parallel races)

---

## New Files Created

### Core Layer

| File | Purpose |
|------|---------|
| `RuneAndRust.Core/Models/Analysis/CombatStatistics.cs` | Statistics accumulator model for Monte Carlo combat analysis. Tracks encounter results, hit/miss ratios, damage dealt/received, stamina consumption, and derived metrics (win rate, hit rate, averages). |
| `RuneAndRust.Core/Interfaces/ICombatAuditService.cs` | Service interface with configuration record, report record, variance flag record. Defines `CombatAuditConfiguration`, `CombatAuditReport`, `CombatVarianceFlag`, and `CombatMatchResult` records. |

### Engine Layer

| File | Purpose |
|------|---------|
| `RuneAndRust.Engine/Services/CombatAuditService.cs` | Monte Carlo simulation service. Creates fresh DI scope per match, orchestrates headless combat loop, calculates variance flags, generates markdown reports. |
| `RuneAndRust.Engine/Simulation/SimulatedPlayerAgent.cs` | Heuristic AI agent for simulated player decisions. Implements resource-aware attack selection (Heavy/Standard/Light based on stamina) with finisher logic for low-HP targets. |

### Test Layer

| File | Purpose |
|------|---------|
| `RuneAndRust.Tests/Engine/CombatStatisticsTests.cs` | 24 unit tests for CombatStatistics model covering encounter recording, attack tracking, and all derived metrics. |
| `RuneAndRust.Tests/Integration/CombatAuditIntegrationTests.cs` | 16 integration tests for CombatAuditService covering sanity checks, report generation, archetype comparisons, enemy template tests, variance flags, and edge cases. |

---

## Files Modified

| File | Change |
|------|--------|
| `RuneAndRust.Core/Interfaces/ICombatService.cs` | Added `ProcessEnemyTurnSync(Combatant enemy)` method signature for headless simulation without UX delays. |
| `RuneAndRust.Engine/Services/CombatService.cs` | Implemented `ProcessEnemyTurnSync()` method that mirrors async version but skips 750ms `Task.Delay`. |
| `RuneAndRust.Terminal/Program.cs` | Added DI registration for `ICombatAuditService`. Added CLI argument handling for `--audit-combat` flag with `--iterations`, `--archetype`, `--enemy`, and `--level` parameters. Added `ParseStringArg()` helper method. |
| `RuneAndRust.Tests/Infrastructure/TestGameHost.cs` | Added service registrations for `ICombatAuditService` and `IEnemyFactory` to enable combat audit integration tests. |

---

## Code Implementation Details

### CombatStatistics Model

**Location:** `RuneAndRust.Core/Models/Analysis/CombatStatistics.cs`

**Purpose:** Accumulates statistics from multiple combat encounters for Monte Carlo analysis.

**Aggregate Properties:**

| Property | Type | Description |
|----------|------|-------------|
| `TotalEncounters` | `int` | Number of combat matches simulated |
| `PlayerWins` | `int` | Encounters won by the player |
| `EnemyWins` | `int` | Encounters won by the enemy |
| `TotalRounds` | `int` | Total combat rounds across all encounters |
| `TotalPlayerTurns` | `int` | Total player turns taken |
| `TotalEnemyTurns` | `int` | Total enemy turns taken |

**Damage Tracking:**

| Property | Type | Description |
|----------|------|-------------|
| `TotalPlayerDamageDealt` | `long` | Cumulative damage dealt by player |
| `TotalPlayerDamageReceived` | `long` | Cumulative damage received by player |
| `TotalPlayerHits` | `int` | Successful player attack count |
| `TotalPlayerMisses` | `int` | Missed player attack count |
| `TotalEnemyDamageDealt` | `long` | Cumulative damage dealt by enemies |
| `TotalEnemyHits` | `int` | Successful enemy attack count |
| `TotalEnemyMisses` | `int` | Missed enemy attack count |

**Resource Tracking:**

| Property | Type | Description |
|----------|------|-------------|
| `TotalPlayerStaminaSpent` | `long` | Cumulative stamina consumed |
| `TotalPlayerHPRemaining` | `long` | Cumulative HP remaining on wins |

**Derived Metrics:**

| Property | Formula | Description |
|----------|---------|-------------|
| `WinRate` | `(PlayerWins / TotalEncounters) * 100` | Win percentage (0-100) |
| `AvgRoundsPerEncounter` | `TotalRounds / TotalEncounters` | TTK metric |
| `PlayerHitRate` | `TotalPlayerHits / (Hits + Misses) * 100` | Hit percentage |
| `EnemyHitRate` | `TotalEnemyHits / (Hits + Misses) * 100` | Enemy hit percentage |
| `AvgPlayerDamagePerHit` | `TotalPlayerDamageDealt / TotalPlayerHits` | Damage per hit |
| `AvgEnemyDamagePerHit` | `TotalEnemyDamageDealt / TotalEnemyHits` | Enemy damage per hit |
| `AvgStaminaPerEncounter` | `TotalPlayerStaminaSpent / TotalEncounters` | Resource drain metric |
| `AvgHPRemainingOnWin` | `TotalPlayerHPRemaining / PlayerWins` | Survivability metric |

**Recording Methods:**

```csharp
public void RecordEncounterResult(CombatMatchResult result)
{
    TotalEncounters++;
    TotalRounds += result.RoundsElapsed;
    TotalPlayerStaminaSpent += result.StaminaSpent;

    if (result.PlayerWon)
    {
        PlayerWins++;
        TotalPlayerHPRemaining += result.PlayerHPRemaining;
    }
    else
    {
        EnemyWins++;
    }
}

public void RecordPlayerAttack(bool hit, int damage)
{
    TotalPlayerTurns++;
    if (hit)
    {
        TotalPlayerHits++;
        TotalPlayerDamageDealt += damage;
    }
    else
    {
        TotalPlayerMisses++;
    }
}

public void RecordEnemyAttack(bool hit, int damage)
{
    TotalEnemyTurns++;
    if (hit)
    {
        TotalEnemyHits++;
        TotalEnemyDamageDealt += damage;
        TotalPlayerDamageReceived += damage;
    }
    else
    {
        TotalEnemyMisses++;
    }
}
```

---

### ICombatAuditService Interface

**Location:** `RuneAndRust.Core/Interfaces/ICombatAuditService.cs`

**Interface:**
```csharp
public interface ICombatAuditService
{
    Task<CombatAuditReport> RunAuditAsync(CombatAuditConfiguration config);
}
```

**Configuration Record:**
```csharp
public record CombatAuditConfiguration(
    int Iterations,              // Number of combat matches to simulate
    ArchetypeType PlayerArchetype, // Player archetype (Warrior, Skirmisher, etc.)
    string EnemyTemplateId,      // Enemy template ID (e.g., "und_draugr_01")
    int PlayerLevel = 1,         // Player level for stat scaling
    int? Seed = null)            // Optional RNG seed for determinism
{
    public static CombatAuditConfiguration Default =>
        new(1000, ArchetypeType.Warrior, "und_draugr_01");
}
```

**Report Record:**
```csharp
public record CombatAuditReport(
    CombatStatistics Statistics,           // Accumulated data
    string MarkdownReport,                 // Human-readable report
    IReadOnlyList<CombatVarianceFlag> Flags); // Variance analysis
```

**Variance Flag Record:**
```csharp
public record CombatVarianceFlag(
    string Metric,           // "Win Rate", "Avg Rounds", "Player Hit Rate", etc.
    double ActualValue,      // Observed value
    double ExpectedMin,      // Minimum expected bound
    double ExpectedMax,      // Maximum expected bound
    VarianceSeverity Severity) // Ok, Warning, Critical
{
    public bool IsWithinBounds => ActualValue >= ExpectedMin && ActualValue <= ExpectedMax;

    public double Deviation =>
        ActualValue < ExpectedMin
            ? ExpectedMin - ActualValue
            : ActualValue > ExpectedMax
                ? ActualValue - ExpectedMax
                : 0;
}
```

**Match Result Record:**
```csharp
public record CombatMatchResult(
    bool PlayerWon,          // True if player won
    int RoundsElapsed,       // Number of combat rounds
    int PlayerHPRemaining,   // Player HP at end
    int EnemyHPRemaining,    // Enemy HP at end
    int StaminaSpent);       // Total stamina consumed
```

---

### SimulatedPlayerAgent

**Location:** `RuneAndRust.Engine/Simulation/SimulatedPlayerAgent.cs`

**Purpose:** Heuristic AI that makes "reasonable" player decisions for combat simulation.

**Strategy:**
1. **Priority 1: Survival** - Not implemented in v0.3.13b (would require inventory access for potions)
2. **Priority 2: Finisher** - Use Heavy Attack if enemy HP <= 2x weapon die (likely kill)
3. **Priority 3: Resource-Aware Attack** - Select attack type based on current stamina

**Stamina Thresholds:**
| Stamina | Attack Type |
|---------|-------------|
| >= 40 | Heavy Attack |
| >= 20 | Standard Attack |
| < 20 | Light Attack |

**Implementation:**
```csharp
public CombatAction DecideAction(Combatant player, CombatState state)
{
    var target = state.TurnOrder.FirstOrDefault(c => !c.IsPlayer && c.CurrentHp > 0);

    if (target == null)
        return new CombatAction(ActionType.Pass, player.Id, null);

    // Priority 2: Finisher
    var estimatedMaxDamage = player.WeaponDamageDie * 2;
    if (target.CurrentHp <= estimatedMaxDamage && player.CurrentStamina >= HeavyAttackThreshold)
    {
        return new CombatAction(ActionType.Attack, player.Id, target.Id, AttackType.Heavy);
    }

    // Priority 3: Resource-Aware Attack Selection
    if (player.CurrentStamina >= HeavyAttackThreshold)
        return new CombatAction(ActionType.Attack, player.Id, target.Id, AttackType.Heavy);
    else if (player.CurrentStamina >= StandardAttackThreshold)
        return new CombatAction(ActionType.Attack, player.Id, target.Id, AttackType.Standard);
    else
        return new CombatAction(ActionType.Attack, player.Id, target.Id, AttackType.Light);
}
```

---

### CombatAuditService Implementation

**Location:** `RuneAndRust.Engine/Services/CombatAuditService.cs`

**Constructor:**
```csharp
public CombatAuditService(
    IServiceScopeFactory scopeFactory,
    ILogger<CombatAuditService> logger)
```

**Variance Thresholds:**
| Constant | Value | Description |
|----------|-------|-------------|
| `WarningThreshold` | 5.0% | Deviation triggers WARNING |
| `CriticalThreshold` | 15.0% | Deviation triggers CRITICAL |
| `MaxRoundsPerMatch` | 100 | Safety limit to prevent infinite loops |

**Expected Metric Bounds:**
| Metric | Min | Max | Rationale |
|--------|-----|-----|-----------|
| Win Rate | 70% | 90% | Standard enemies should be beatable but challenging |
| Avg Rounds | 3 | 8 | Combat should be quick but not trivial |
| Hit Rate | 65% | 85% | Attacks should mostly land but misses create variance |

**Simulation Loop:**
```csharp
public async Task<CombatAuditReport> RunAuditAsync(CombatAuditConfiguration config)
{
    var stats = new CombatStatistics();

    // SEQUENTIAL LOOP - Required for thread safety (shared GameState, non-thread-safe Random)
    for (int i = 0; i < config.Iterations; i++)
    {
        using var scope = _scopeFactory.CreateScope();
        var matchResult = await RunSingleMatchAsync(scope, config, stats);
        stats.RecordEncounterResult(matchResult);

        // Progress logging every 10%
        if (config.Iterations >= 100 && (i + 1) % (config.Iterations / 10) == 0)
            _logger.LogDebug("Progress: {Percent}%", (i + 1) * 100 / config.Iterations);
    }

    var flags = CalculateVarianceFlags(stats, config);
    var markdown = GenerateMarkdownReport(stats, config, flags);

    return new CombatAuditReport(stats, markdown, flags);
}
```

**Single Match Execution:**
```csharp
private async Task<CombatMatchResult> RunSingleMatchAsync(
    IServiceScope scope,
    CombatAuditConfiguration config,
    CombatStatistics stats)
{
    // Get services from fresh scope
    var combatService = scope.ServiceProvider.GetRequiredService<ICombatService>();
    var characterFactory = scope.ServiceProvider.GetRequiredService<CharacterFactory>();
    var enemyFactory = scope.ServiceProvider.GetRequiredService<IEnemyFactory>();
    var gameState = scope.ServiceProvider.GetRequiredService<GameState>();

    // Reset and initialize
    gameState.Reset();
    gameState.Phase = GamePhase.Exploration;
    var character = characterFactory.CreateSimple("SimHero", LineageType.Human, config.PlayerArchetype);
    gameState.CurrentCharacter = character;
    var enemy = await enemyFactory.CreateByIdAsync(config.EnemyTemplateId, config.PlayerLevel);

    // Start combat
    combatService.StartCombat(new List<Enemy> { enemy });
    var playerAgent = new SimulatedPlayerAgent();
    int rounds = 0;

    // Combat loop
    while (gameState.CombatState != null && rounds < MaxRoundsPerMatch)
    {
        var active = gameState.CombatState.ActiveCombatant;

        if (active.IsPlayer)
        {
            var action = playerAgent.DecideAction(active, gameState.CombatState);
            ExecuteSimulatedPlayerAction(combatService, active, action, stats, gameState.CombatState);
        }
        else
        {
            combatService.ProcessEnemyTurnSync(active); // No 750ms delay!
        }

        rounds++;
        // ... victory/defeat checks
    }

    return new CombatMatchResult(playerWon, rounds, playerHP, enemyHP, staminaSpent);
}
```

**Player Action Execution (Fixed in v0.3.13b):**
```csharp
private void ExecuteSimulatedPlayerAction(
    ICombatService combatService,
    Combatant player,
    CombatAction action,
    CombatStatistics stats,
    CombatState combatState)
{
    if (action.Type != ActionType.Attack || action.TargetId == null)
    {
        combatService.NextTurn();
        return;
    }

    // CRITICAL: Find target by ID to get actual name
    var target = combatState.TurnOrder.FirstOrDefault(c => c.Id == action.TargetId);
    if (target == null)
        target = combatState.TurnOrder.FirstOrDefault(c => !c.IsPlayer && c.CurrentHp > 0);

    if (target == null)
    {
        combatService.NextTurn();
        return;
    }

    // Execute attack using actual target name (not hardcoded "enemy")
    var result = combatService.ExecutePlayerAttack(target.Name, attackType);

    // Record statistics based on result message
    if (result.Contains("miss", StringComparison.OrdinalIgnoreCase) || ...)
        stats.RecordPlayerAttack(false, 0);
    else
        stats.RecordPlayerAttack(true, extractedDamage);

    // CRITICAL: Advance turn (ExecutePlayerAttack doesn't auto-advance)
    combatService.NextTurn();
}
```

---

### CLI Argument Handling

**Location:** `RuneAndRust.Terminal/Program.cs`

**Pattern:**
```csharp
if (args.Any(a => a.StartsWith("--audit-combat")))
{
    var iterations = ParseIntArg(args, "iterations", 1000);
    var archetype = ParseEnumArg(args, "archetype", ArchetypeType.Warrior);
    var enemy = ParseStringArg(args, "enemy", "und_draugr_01");
    var level = ParseIntArg(args, "level", 1);

    using (var scope = host.Services.CreateScope())
    {
        var auditService = scope.ServiceProvider.GetRequiredService<ICombatAuditService>();
        var config = new CombatAuditConfiguration(iterations, archetype, enemy, level);
        var report = auditService.RunAuditAsync(config).GetAwaiter().GetResult();

        // Write report to docs/audits/
        File.WriteAllText(outputPath, report.MarkdownReport);

        // Console summary
        AnsiConsole.MarkupLine($"[green]Win Rate: {report.Statistics.WinRate:F1}%[/]");
        AnsiConsole.MarkupLine($"[green]Avg Rounds: {report.Statistics.AvgRoundsPerEncounter:F1}[/]");
    }
}
```

**New Helper Method:**
```csharp
private static string ParseStringArg(string[] args, string name, string defaultValue)
{
    var prefix = $"--{name}=";
    var arg = args.FirstOrDefault(a => a.StartsWith(prefix, StringComparison.OrdinalIgnoreCase));
    return arg?.Substring(prefix.Length) ?? defaultValue;
}
```

---

## Architecture & Data Flow

### Simulation Pipeline

```
+------------------------------------------------------------------------------+
|                       COMBAT AUDIT SIMULATION PIPELINE                        |
+------------------------------------------------------------------------------+

 CLI Trigger                Configuration              Simulation Loop
 ----------                 -------------              ---------------

 dotnet run                 CombatAuditConfiguration   for i = 0 to N:
 --audit-combat      -->    {                    -->     scope = CreateScope()
 --iterations=1000          Iterations: 1000             match = RunSingleMatch()
 --archetype=Warrior        PlayerArchetype: Warrior     stats.Record(match)
 --enemy=und_draugr_01      EnemyTemplateId: und_draugr_01
                            PlayerLevel: 1
                            }

                                                              |
                                                              v

 Report Output              Variance Analysis          Statistics Accumulation
 -------------              -----------------          -----------------------

 docs/audits/              For each Metric:            CombatStatistics {
 combat_audit_               Actual = stats.Property     TotalEncounters: 1000
 20251224_120000.md  <--     Expected = [Min, Max]  <--   PlayerWins: 782
                             Severity = Classify()       TotalRounds: 4312
                                                         TotalPlayerHits: 3381
                                                       }
```

### Headless Combat Loop Data Flow

```
+---------------+      +------------------+      +-----------------+
|   GameState   |      |  CombatService   |      | AttackResolution|
|   (Reset)     |      |   (Headless)     |      |    Service      |
+-------+-------+      +--------+---------+      +--------+--------+
        |                       |                         |
        | 1. Reset()            |                         |
        | 2. Create Character   |                         |
        |<----------------------+                         |
        |                       |                         |
        | 3. StartCombat(enemy) |                         |
        |---------------------->|                         |
        |                       |                         |
        |  +--------------------+--------------------+    |
        |  |            COMBAT LOOP                  |    |
        |  |                                         |    |
        |  |  if (active.IsPlayer)                   |    |
        |  |    SimulatedPlayerAgent.DecideAction()  |    |
        |  |    ExecutePlayerAttack(target.Name)     |    |
        |  |         |                               |    |
        |  |         +----------------------------->|------>  ResolveMeleeAttack()
        |  |         |                               |    |
        |  |    NextTurn() // CRITICAL!              |    |
        |  |                                         |    |
        |  |  else // Enemy turn                     |    |
        |  |    ProcessEnemyTurnSync(active)         |    |
        |  |    // NO 750ms delay!                   |    |
        |  |                                         |    |
        |  +--------------------+--------------------+    |
        |                       |                         |
        | 4. EndCombat()        |                         |
        |<----------------------+                         |
        v                       v                         v
```

### Fresh Scope Per Match

```
  Main Thread (Sequential)
  ========================

  Iteration 0                    Iteration 1                    Iteration N
  -----------                    -----------                    -----------

  scope0 = CreateScope()         scope1 = CreateScope()         scopeN = CreateScope()
       |                              |                              |
       v                              v                              v
  +------------+                 +------------+                 +------------+
  | GameState  | (fresh)         | GameState  | (fresh)         | GameState  | (fresh)
  | DiceService| (fresh RNG)     | DiceService| (fresh RNG)     | DiceService| (fresh RNG)
  | CombatSvc  | (fresh)         | CombatSvc  | (fresh)         | CombatSvc  | (fresh)
  +------------+                 +------------+                 +------------+
       |                              |                              |
       v                              v                              v
  RunSingleMatch()               RunSingleMatch()               RunSingleMatch()
       |                              |                              |
       v                              v                              v
  matchResult0                   matchResult1                   matchResultN
       |                              |                              |
       +------------------------------+------------------------------+
                                      |
                                      v
                              stats.RecordAll()
```

---

## Decision Trees

### A. Win Determination Decision Tree

```
Input: Combat loop ended
                    |
                    v
        +------------------------+
        | CombatState == null?   |
        +------------------------+
                    |
          +---------+---------+
          | YES               | NO
          v                   v
    +-----------+     +----------------------+
    | Check     |     | Player HP > 0 AND    |
    | GamePhase |     | Enemy HP <= 0 ?      |
    +-----------+     +----------------------+
          |                     |
          v               +-----+-----+
    +------------+        | YES       | NO
    | Exploration|        v           v
    | = WIN      |   +--------+  +--------+
    +------------+   | WIN    |  | LOSE   |
                     +--------+  +--------+
```

### B. Player Action Execution Decision Tree

```
Input: CombatAction from SimulatedPlayerAgent
                    |
                    v
        +------------------------+
        | action.Type == Attack? |
        +------------------------+
                    |
          +---------+---------+
          | NO                | YES
          v                   v
    +-----------+     +----------------------+
    | NextTurn()|     | TargetId not null?   |
    | return    |     +----------------------+
    +-----------+            |
                    +---------+---------+
                    | NO                | YES
                    v                   v
              +-----------+     +-----------------------+
              | NextTurn()|     | Find target by ID     |
              | return    |     | from CombatState      |
              +-----------+     +-----------------------+
                                        |
                                        v
                                +----------------+
                                | target found?  |
                                +----------------+
                                        |
                                +---------+---------+
                                | NO                | YES
                                v                   v
                          +------------+     +------------------------+
                          | Find first |     | ExecutePlayerAttack    |
                          | alive enemy|     | (target.Name, type)    |
                          +------------+     +------------------------+
                                |                     |
                                v                     v
                          +------------+     +------------------------+
                          | Execute or |     | Parse result message   |
                          | NextTurn   |     | Record hit/miss/damage |
                          +------------+     | NextTurn()             |
                                             +------------------------+
```

### C. Simulated Player Agent Decision Tree

```
Input: Combatant player, CombatState state
                    |
                    v
        +----------------------------+
        | Find valid target          |
        | (alive, not player)        |
        +----------------------------+
                    |
          +---------+---------+
          | NOT FOUND         | FOUND
          v                   v
    +---------------+   +----------------------------+
    | Return PASS   |   | Target HP <= 2x WeaponDie? |
    +---------------+   +----------------------------+
                                    |
                          +---------+---------+
                          | YES               | NO
                          v                   v
                    +------------+     +-------------------+
                    | Stamina    |     | Stamina >= 40?    |
                    | >= 40?     |     +-------------------+
                    +------------+            |
                          |           +-------+-------+
                    +-----+-----+     | YES           | NO
                    | YES | NO  |     v               v
                    v     v     | +----------+  +------------+
              +--------+ Pass   | | HEAVY    |  | Stam >= 20?|
              | HEAVY  | to     | | ATTACK   |  +------------+
              | ATTACK | normal | +----------+        |
              +--------+ flow   |             +-------+-------+
                        |       |             | YES           | NO
                        +-------+             v               v
                                        +----------+    +----------+
                                        | STANDARD |    | LIGHT    |
                                        | ATTACK   |    | ATTACK   |
                                        +----------+    +----------+
```

### D. Variance Classification Decision Tree

```
Input: ActualValue, ExpectedMin, ExpectedMax
                    |
                    v
        +-----------------------------------+
        | ActualValue >= ExpectedMin AND    |
        | ActualValue <= ExpectedMax?       |
        +-----------------------------------+
                    |
          +---------+---------+
          | YES               | NO
          v                   v
    +----------+       +-------------------+
    |    OK    |       | deviation = Abs(  |
    +----------+       |   actual - bound) |
                       +-------------------+
                               |
                               v
                       +-------------------+
                       | deviation > 15%?  |
                       +-------------------+
                               |
                         +-----+-----+
                         | YES       | NO
                         v           v
                    +----------+ +------------------+
                    | CRITICAL | | deviation > 5%?  |
                    +----------+ +------------------+
                                        |
                                  +-----+-----+
                                  | YES       | NO
                                  v           v
                             +---------+  +--------+
                             | WARNING |  |   OK   |
                             +---------+  +--------+
```

---

## Logging Matrix

### CombatAuditService

| Event | Level | Template | Properties |
|-------|-------|----------|------------|
| Audit Started | Info | `"[CombatAudit] Starting audit: {Iterations} matches, {Archetype} vs {Enemy} (Level {Level})"` | Iterations, Archetype, Enemy, Level |
| Progress Update | Debug | `"[CombatAudit] Progress: {Completed}/{Total} ({Percent}%)"` | Completed, Total, Percent |
| Match Started | Trace | `"[Match] Starting: {Player} (HP:{PHP}, Stam:{PStam}) vs {Enemy} (HP:{EHP})"` | Player, PHP, PStam, Enemy, EHP |
| No Active Combatant | Warning | `"[Match] No active combatant, ending match"` | - |
| Victory | Trace | `"[Match] Victory! All enemies defeated."` | - |
| Defeat | Trace | `"[Match] Defeat! Player has fallen."` | - |
| Match Result | Trace | `"[Match] Result: {Winner}, Rounds: {Rounds}, HP Remaining: {HP}/{MaxHP}"` | Winner, Rounds, HP, MaxHP |
| Audit Complete | Info | `"[CombatAudit] Complete. Win Rate: {WinRate}%, Avg Rounds: {AvgRounds}, Flags: {FlagCount}"` | WinRate, AvgRounds, FlagCount |

### SimulatedPlayerAgent

| Event | Level | Template | Properties |
|-------|-------|----------|------------|
| No Target | Debug | `"[SimAgent] No valid target found, passing turn"` | - |
| Heavy Finisher | Debug | `"[SimAgent] Using Heavy Attack as finisher on {Target} (HP: {HP})"` | Target, HP |
| Heavy Attack | Debug | `"[SimAgent] Using Heavy Attack (Stamina: {Stamina})"` | Stamina |
| Standard Attack | Debug | `"[SimAgent] Using Standard Attack (Stamina: {Stamina})"` | Stamina |
| Light Attack | Debug | `"[SimAgent] Using Light Attack (Stamina: {Stamina})"` | Stamina |

### CLI (Program.cs)

| Event | Output | Message |
|-------|--------|---------|
| Audit Starting | Yellow | `"Running Combat Audit: {iterations:N0} matches, {archetype} vs {enemy}..."` |
| Win Rate | Green | `"Win Rate: {WinRate:F1}%"` |
| Avg Rounds | Green | `"Avg Rounds: {AvgRounds:F1}"` |
| Report Path | Grey | `"Report: {outputPath}"` |

---

## Test Coverage

### CombatStatisticsTests (24 tests)

**RecordEncounterResult Tests:**

| Test | Description |
|------|-------------|
| `RecordEncounterResult_WithPlayerWin_IncrementsPlayerWins` | Player win increments PlayerWins and HP remaining |
| `RecordEncounterResult_WithEnemyWin_IncrementsEnemyWins` | Enemy win increments EnemyWins, no HP tracked |
| `RecordEncounterResult_TracksRoundsAndStamina` | Rounds and stamina accumulate correctly |
| `RecordEncounterResult_AccumulatesMultipleResults` | Multiple encounters accumulate all metrics |

**RecordPlayerAttack Tests:**

| Test | Description |
|------|-------------|
| `RecordPlayerAttack_Hit_TracksDamageAndHits` | Hit increments TotalPlayerHits and damage |
| `RecordPlayerAttack_Miss_TracksOnlyMisses` | Miss increments TotalPlayerMisses only |
| `RecordPlayerAttack_MixedHitsAndMisses_TracksCorrectly` | Mixed attacks track correctly |

**RecordEnemyAttack Tests:**

| Test | Description |
|------|-------------|
| `RecordEnemyAttack_Hit_TracksDamageAndPlayerDamageReceived` | Enemy hit tracks damage dealt and received |
| `RecordEnemyAttack_Miss_TracksOnlyMisses` | Enemy miss only increments miss counter |

**Derived Metrics Tests:**

| Test | Description |
|------|-------------|
| `WinRate_CalculatesCorrectly` | Win rate formula verification (80% case) |
| `WinRate_ReturnsZeroWhenNoEncounters` | Division by zero handling |
| `AvgRoundsPerEncounter_CalculatesCorrectly` | Average rounds formula |
| `PlayerHitRate_CalculatesCorrectly` | Hit rate formula (70% case) |
| `PlayerHitRate_ReturnsZeroWhenNoAttacks` | Division by zero handling |
| `EnemyHitRate_CalculatesCorrectly` | Enemy hit rate formula (60% case) |
| `AvgPlayerDamagePerHit_CalculatesCorrectly` | Damage per hit formula |
| `AvgPlayerDamagePerHit_ReturnsZeroWhenNoHits` | Division by zero handling |
| `AvgEnemyDamagePerHit_CalculatesCorrectly` | Enemy damage per hit formula |
| `AvgStaminaPerEncounter_CalculatesCorrectly` | Stamina average formula |
| `AvgHPRemainingOnWin_CalculatesCorrectly` | HP remaining on win formula |
| `AvgHPRemainingOnWin_ReturnsZeroWhenNoWins` | Division by zero handling |
| `AllDerivedMetrics_ReturnZeroWhenEmpty` | All metrics return 0 when empty |

**CombatMatchResult Tests:**

| Test | Description |
|------|-------------|
| `CombatMatchResult_RecordEquality_WorksCorrectly` | Record equality verification |
| `CombatMatchResult_AllPropertiesAccessible` | All properties accessible |

### CombatAuditIntegrationTests (16 tests)

**Sanity Check Tests:**

| Test | Description |
|------|-------------|
| `Audit_SanityCheck_ProducesResults` | 10 iterations produce results |
| `Audit_WarriorVsMinion_HighWinRate` | Warrior vs Servitor: > 85% win rate |
| `Audit_WarriorVsStandard_CombatFunctional` | Combat produces rounds and attacks |

**Report Generation Tests:**

| Test | Description |
|------|-------------|
| `Audit_GeneratesValidMarkdownReport` | Report contains all required sections |
| `Audit_ReportIncludesMetricTables` | Tables have proper headers |

**Archetype Comparison Tests:**

| Test | Description |
|------|-------------|
| `Audit_DifferentArchetypes_ProduceDifferentResults` | Warrior vs Adept produce different stats |
| `Audit_AllArchetypes_ProduceValidReports` | All archetypes produce valid reports |

**Enemy Template Tests:**

| Test | Description |
|------|-------------|
| `Audit_AllBuiltInEnemies_ProduceValidReports` | All enemy templates work |
| `Audit_WithInvalidEnemy_UsesFallback` | Invalid enemy ID uses fallback |

**Variance Flag Tests:**

| Test | Description |
|------|-------------|
| `Audit_GeneratesVarianceFlags` | Flags generated for all metrics |
| `Audit_ClassifiesVarianceCorrectly` | Valid severity levels |
| `VarianceFlag_IsWithinBounds_WorksCorrectly` | IsWithinBounds and Deviation work |

**Edge Case Tests:**

| Test | Description |
|------|-------------|
| `Audit_WithZeroIterations_ReturnsEmptyReport` | 0 iterations handled gracefully |
| `Audit_WithHigherLevel_ScalesEnemy` | Higher level = harder fights |

**Configuration Tests:**

| Test | Description |
|------|-------------|
| `CombatAuditConfiguration_Default_HasReasonableValues` | Default config validation |
| `CombatAuditConfiguration_RecordEquality_Works` | Record equality verification |

---

## CLI Usage Guide

### Basic Usage

```bash
# Default: 1000 matches, Warrior vs Rusted Draugr, Level 1
dotnet run --project RuneAndRust.Terminal -- --audit-combat
```

### With Parameters

```bash
# Custom iterations and archetype
dotnet run --project RuneAndRust.Terminal -- --audit-combat --iterations=5000 --archetype=Skirmisher

# Full custom configuration
dotnet run --project RuneAndRust.Terminal -- --audit-combat --iterations=10000 --archetype=Adept --enemy=bst_vargr_01 --level=3
```

### Parameter Reference

| Parameter | Default | Values | Description |
|-----------|---------|--------|-------------|
| `--iterations` | 1000 | Any positive int | Number of combat simulations |
| `--archetype` | Warrior | Warrior, Skirmisher, Adept | Player archetype |
| `--enemy` | und_draugr_01 | Template ID | Enemy template |
| `--level` | 1 | 1-10 | Enemy scaling level |

### Available Enemy Templates

| Template ID | Name | Tier | Archetype |
|-------------|------|------|-----------|
| `und_draugr_01` | Rusted Draugr | Standard | DPS |
| `und_haug_01` | Haugbui Laborer | Standard | Tank |
| `mec_serv_01` | Utility Servitor | Minion | Swarm |
| `bst_vargr_01` | Ash-Vargr | Standard | GlassCannon |
| `hum_raider_01` | Rust-Clan Scav | Standard | Support |

### Output Location

Reports are written to: `docs/audits/combat_audit_YYYYMMDD_HHMMSS.md`

---

## Report Output Format

### Sample Report

```markdown
# Combat Audit Report

**Date:** 2025-12-24 12:00:00 | **Matches:** 1,000
**Player:** Warrior (Level 1) | **Enemy:** und_draugr_01

## Summary

| Metric | Value |
|--------|-------|
| **Win Rate** | 78.2% |
| **Average Rounds** | 4.8 |
| **Avg HP Remaining (on Win)** | 42 |
| **Player Hit Rate** | 76.3% |
| **Avg Damage per Hit** | 8.4 |
| **Avg Stamina per Encounter** | 45 |

## Detailed Statistics

### Player Performance

- **Total Attacks:** 4,312
- **Hits:** 3,289 (76.3%)
- **Misses:** 1,023 (23.7%)
- **Total Damage Dealt:** 27,628
- **Total Stamina Spent:** 45,000

### Enemy Performance

- **Total Attacks:** 2,891
- **Hits:** 1,735 (60.0%)
- **Misses:** 1,156 (40.0%)
- **Total Damage Dealt:** 15,618
- **Total Damage to Player:** 15,618

## Balance Assessment

| Metric | Actual | Expected Range | Status |
|--------|--------|----------------|--------|
| Win Rate | 78.2 | 70-90 | OK |
| Avg Rounds | 4.8 | 3-8 | OK |
| Player Hit Rate | 76.3 | 65-85 | OK |
| Enemy Hit Rate | 60.0 | 65-85 | WARN |

## Anomalies

### Warnings

- **Enemy Hit Rate**: 60.0 is below expected range (65-90)

---

*Generated by CombatAuditService v0.3.13b*
```

---

## Design Decisions

### Why Self-Contained Combat Loop (Not Modifying CombatService)?

**Problem:** The existing `CombatService.ProcessEnemyTurnAsync()` includes a 750ms `Task.Delay` for UX purposes.

**Analysis:**
- Modifying the core async method risks breaking production combat flow
- Adding conditional delays would complicate the service
- The TUI flow expects the delay for animation timing

**Decision:** Add a new `ProcessEnemyTurnSync()` method that contains identical logic but without the delay. This is a minimal, safe change that doesn't affect production behavior.

### Why Sequential Execution (Not Parallel)?

**Problem:** Parallel simulation would be faster but creates thread safety issues.

**Analysis:**
- `GameState` is a singleton shared across the entire application
- `DiceService` uses non-thread-safe `Random` internally
- `CombatService` modifies shared state during combat
- Creating fresh scopes doesn't isolate singletons

**Decision:** Use sequential `for` loop with fresh DI scope per match. 1,000 iterations completes in ~2 seconds, which is acceptable for a developer tool.

**Future Option:** Refactor services to use scoped `GameState` and `Random.Shared` if parallel execution becomes necessary.

### Why Target Lookup by ID (Not Name)?

**Problem:** Original implementation used hardcoded `"enemy"` as target name, causing 0% win rate.

**Analysis:**
- `CombatService.ExecutePlayerAttack()` finds target by name
- Enemies have unique names like "Rusted Draugr", not "enemy"
- `CombatAction` from `SimulatedPlayerAgent` provides target ID
- Need to translate ID to actual name

**Decision:** Look up target in `CombatState.TurnOrder` by ID, then use `target.Name` for the attack. Fall back to first alive enemy if ID lookup fails.

### Why Call NextTurn() After Player Attacks?

**Problem:** Combat loop was stalling because turns weren't advancing after player attacks.

**Analysis:**
- `CombatService.ExecutePlayerAttack()` returns a result message but doesn't advance turns
- `ProcessEnemyTurnSync()` does call `NextTurn()` internally
- Asymmetry caused combat to stall on player's turn

**Decision:** Always call `combatService.NextTurn()` after executing a simulated player action, even for non-attack actions (Pass).

### Why Parse Damage from Result Message?

**Problem:** Need to record per-attack damage for statistics, but `ExecutePlayerAttack()` returns a string message.

**Analysis:**
- Changing the return type would break existing callers
- Messages follow patterns like "deals X damage" or "X damage"
- Regex extraction is reliable for these patterns

**Decision:** Use regex `@"(\d+)\s*damage"` to extract damage from result messages. Record unknown damage (0) if pattern doesn't match.

### Why Variance Thresholds of 5% and 15%?

**Rationale:**
- **5% (Warning):** Noticeable deviation that may indicate balance issues
- **15% (Critical):** Significant deviation that requires immediate attention

These thresholds are calibrated for combat metrics where variance is expected. A 5% win rate deviation (e.g., 65% vs 70%) is worth investigating, while 15% (e.g., 55% vs 70%) indicates a serious balance problem.

---

## Verification Results

### Build Output

```
Build succeeded.
    0 Warning(s)
    0 Error(s)
```

### Test Results

```
dotnet test --filter "FullyQualifiedName~CombatStatistics|FullyQualifiedName~CombatAudit"

Passed!  - Failed: 0, Passed: 40, Skipped: 0, Total: 40, Duration: 2.8s
```

**Breakdown:**
- CombatStatisticsTests: 24 passed
- CombatAuditIntegrationTests: 16 passed

---

## Directory Structure

```
RuneAndRust.Core/
+-- Interfaces/
|   +-- ICombatAuditService.cs                    [NEW - v0.3.13b]
|   +-- ICombatService.cs                         [MODIFIED - v0.3.13b]
+-- Models/
    +-- Analysis/
        +-- CombatStatistics.cs                   [NEW - v0.3.13b]

RuneAndRust.Engine/
+-- Services/
|   +-- CombatAuditService.cs                     [NEW - v0.3.13b]
|   +-- CombatService.cs                          [MODIFIED - v0.3.13b]
+-- Simulation/
    +-- SimulatedPlayerAgent.cs                   [NEW - v0.3.13b]

RuneAndRust.Terminal/
+-- Program.cs                                    [MODIFIED - v0.3.13b]

RuneAndRust.Tests/
+-- Engine/
|   +-- CombatStatisticsTests.cs                  [NEW - v0.3.13b]
+-- Integration/
|   +-- CombatAuditIntegrationTests.cs            [NEW - v0.3.13b]
+-- Infrastructure/
    +-- TestGameHost.cs                           [MODIFIED - v0.3.13b]
```

---

## Next Steps

- **v0.3.13c:** Matrix Audit Mode - Run all archetype/enemy combinations in batch
- **Future:** Ability usage simulation (active abilities, special attacks)
- **Future:** Multi-enemy encounter simulation (party vs enemy group)
- **Future:** Historical comparison (diff against previous audit baseline)
- **Future:** CSV export for spreadsheet analysis
- **Future:** Integration with CI/CD for balance regression detection

---

## Credits

**Primary Developer:** The Architect (Claude)
**Test Coverage:** 100% for new tests (40/40 passing)
**Regression:** Zero regressions in existing tests
**Documentation:** Follows CHANGELOG_GENERATION_RULES.md Extended Template
