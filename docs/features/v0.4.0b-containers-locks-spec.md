# v0.4.0b Feature Specification: Containers & Locks

**Version:** 0.4.0b  
**Implemented:** 2026-01-12  
**Status:** Complete

---

## Table of Contents
1. [Overview](#1-overview)
2. [Container Inventory System](#2-container-inventory-system)
3. [Lock System](#3-lock-system)
4. [Key Items](#4-key-items)
5. [InteractiveObject Integration](#5-interactiveobject-integration)
6. [InteractionService Operations](#6-interactionservice-operations)
7. [User Stories](#7-user-stories)
8. [Use Cases](#8-use-cases)
9. [Error Conditions](#9-error-conditions)
10. [Limitations](#10-limitations)
11. [Configuration](#11-configuration)
12. [Logging](#12-logging)
13. [Testing Coverage](#13-testing-coverage)

---

## 1. Overview

### 1.1 Purpose
Enable interactive objects (chests, crates, barrels) to store items and optionally be secured with locks that require keys or lockpicking to open.

### 1.2 Feature Summary
- **Containers**: Objects that hold items with capacity limits
- **Locks**: Security mechanism requiring keys or lockpicking
- **Keys**: Items that unlock specific locks
- **Lockpicking**: Skill-based alternative to keys (simplified in v0.4.0b)

### 1.3 Dependencies
- v0.4.0a Interactive Object Core (InteractiveObject, ObjectState, InteractionType)
- Player.Inventory for item storage
- Item entity for key items

---

## 2. Container Inventory System

### 2.1 ContainerInventory Value Object

**Location:** `Domain/ValueObjects/ContainerInventory.cs`

#### Properties

| Property | Type | Description | Computed |
|----------|------|-------------|----------|
| `Items` | `IReadOnlyList<Item>` | Current items in container | No |
| `Capacity` | `int` | Maximum item count (1+) | No |
| `Count` | `int` | Current item count | Yes |
| `IsEmpty` | `bool` | True when Count == 0 | Yes |
| `IsFull` | `bool` | True when Count >= Capacity | Yes |
| `RemainingCapacity` | `int` | Max(0, Capacity - Count) | Yes |

#### Methods

| Method | Signature | Returns | Side Effects |
|--------|-----------|---------|--------------|
| `Create` | `Create(int capacity)` | `ContainerInventory` | None (factory) |
| `Empty` | `Empty(int capacity = 10)` | `ContainerInventory` | None (factory) |
| `TryAddItem` | `TryAddItem(Item item)` | `bool` | Adds item if space |
| `RemoveItem` | `RemoveItem(Item item)` | `bool` | Removes item |
| `GetItemByName` | `GetItemByName(string name)` | `Item?` | None |
| `GetItemByPartialName` | `GetItemByPartialName(string partial)` | `Item?` | None |
| `TakeAll` | `TakeAll()` | `IEnumerable<Item>` | Clears container |
| `Populate` | `Populate(IEnumerable<Item> items)` | `void` | Fills container |
| `GetContentsDescription` | `GetContentsDescription()` | `string` | None |

### 2.2 Expected Behaviors

| Scenario | Expected Behavior | Actual Behavior |
|----------|-------------------|-----------------|
| Create with capacity 10 | Container has 10 capacity | ✅ Matches |
| Add item to non-full container | Returns true, item added | ✅ Matches |
| Add item to full container | Returns false, item not added | ✅ Matches |
| Add null item | Returns false | ✅ Matches |
| Remove existing item | Returns true, item removed | ✅ Matches |
| Remove non-existing item | Returns false | ✅ Matches |
| GetItemByName case-insensitive | Matches regardless of case | ✅ Matches |
| GetItemByPartialName | First match with partial string | ✅ Matches |
| TakeAll | Returns all items, container empty | ✅ Matches |
| Populate beyond capacity | Stops at capacity | ✅ Matches |

### 2.3 Search Priority
- `GetItemByName` finds **exact match** (case-insensitive)
- `GetItemByPartialName` finds **first item containing** the search string
- Both use `FirstOrDefault` - returns first match, not closest match

---

## 3. Lock System

### 3.1 LockDefinition Value Object

**Location:** `Domain/ValueObjects/LockDefinition.cs`

#### Properties

| Property | Type | Default | Description |
|----------|------|---------|-------------|
| `LockId` | `string` | `""` | Unique identifier for this lock |
| `RequiredKeyId` | `string?` | `null` | Key ID that opens this lock |
| `IsLockpickable` | `bool` | `false` | Can be picked without key |
| `LockpickDC` | `int` | `0` | Difficulty class for picking |
| `KeyConsumedOnUse` | `bool` | `false` | Key removed after use |
| `CanRelock` | `bool` | `true` | Can be locked again |
| `IsPermanentlyUnlocked` | `bool` | `false` | Cannot be relocked ever |
| `HasLock` | `bool` | computed | `!string.IsNullOrEmpty(LockId)` |

#### Factory Methods

| Method | Parameters | Creates |
|--------|------------|---------|
| `None` | (none) | Empty lock (HasLock = false) |
| `KeyOnly` | lockId, keyId, consumeKey?, canRelock? | Key-only lock |
| `Pickable` | lockId, dc, keyId?, canRelock? | Pickable lock (optional key) |
| `KeyOrPick` | lockId, keyId, dc, canRelock? | Both options |

### 3.2 Key Matching Logic

```csharp
public bool KeyMatches(string keyId)
{
    if (string.IsNullOrEmpty(RequiredKeyId)) return false;
    return RequiredKeyId.Equals(keyId, StringComparison.OrdinalIgnoreCase);
}
```

**Behavior:**
- Case-insensitive comparison
- Returns false if lock has no required key
- Returns false if key ID doesn't match

### 3.3 Lock Type Matrix

| Lock Type | Has Key | Pickable | Use Case |
|-----------|---------|----------|----------|
| `None` | No | No | Unlocked objects |
| `KeyOnly` | Yes | No | Important locks (boss room) |
| `Pickable` | Optional | Yes | Common locks |
| `KeyOrPick` | Yes | Yes | Flexible locks |

---

## 4. Key Items

### 4.1 Item Key Properties

**Location:** `Domain/Entities/Item.cs`

| Property | Type | Description |
|----------|------|-------------|
| `KeyId` | `string?` | Lock ID this key opens |
| `IsKey` | `bool` | `Type == ItemType.Key` |
| `IsKeyConsumedOnUse` | `bool` | Removed from inventory after use |

### 4.2 Key Factory Methods

| Method | Creates |
|--------|---------|
| `CreateKey(name, desc, keyId, consumeOnUse?)` | Custom key |
| `CreateIronKey(keyId)` | "Iron Key" - standard key |
| `CreateOrnateKey(keyId)` | "Ornate Key" - decorative key |

### 4.3 Key Consumption Behavior
- When `IsKeyConsumedOnUse = true`, key is removed after successful unlock
- Key is NOT consumed on failed unlock attempts
- Key is NOT consumed when used on wrong lock

---

## 5. InteractiveObject Integration

### 5.1 Container Properties

| Property | Type | Description |
|----------|------|-------------|
| `ContainerInventory` | `ContainerInventory?` | Item storage (null if not container) |
| `IsContainer` | `bool` | `ContainerInventory != null` |

### 5.2 Lock Properties

| Property | Type | Description |
|----------|------|-------------|
| `Lock` | `LockDefinition` | Lock configuration (default: None) |
| `HasLock` | `bool` | `Lock.HasLock` |
| `IsLocked` | `bool` | `State == ObjectState.Locked` |

### 5.3 Container Methods

| Method | Effect |
|--------|--------|
| `SetupAsContainer(capacity)` | Creates ContainerInventory with capacity |

### 5.4 Lock Methods

| Method | Returns | Effect |
|--------|---------|--------|
| `SetLock(lockDef)` | void | Sets lock, changes state to Locked if Closed |
| `TryUnlockWithKey(keyId)` | bool | Unlocks if key matches and object locked |
| `Unlock()` | bool | Unlocks (for lockpicking), returns false if not locked |
| `TryLock()` | bool | Locks if closed, has lock, can relock |

### 5.5 State Transition Diagram

```
                  [SetLock]
                     ↓
    ┌─────────────────────────────────┐
    │                                 │
    ↓                                 │
┌────────┐   [Unlock/Key]   ┌────────┐│   [Lock]    ┌────────┐
│ Locked │ ───────────────→ │ Closed │├────────────→│ Locked │
└────────┘                  └────────┘│             └────────┘
    ↑                           │     │
    │                    [Open] │     │
    │                           ↓     │
    │                      ┌────────┐ │
    │                      │  Open  │ │
    │                      └────────┘ │
    │                           │     │
    │                   [Close] │     │
    │                           ↓     │
    └───────────────────────────┘─────┘
```

### 5.6 FromDefinition Behavior
When creating from definition:
1. Creates InteractiveObject with base properties
2. If `IsContainer && ContainerCapacity > 0`: calls `SetupAsContainer()`
3. If `Lock.HasValue && Lock.Value.HasLock`: calls `SetLock()` (sets state to Locked)

---

## 6. InteractionService Operations

### 6.1 Open (Updated)

**Behavior Change:** Now shows container contents when opening.

```csharp
// After successful open:
if (obj.IsContainer && obj.ContainerInventory != null)
{
    message += "\n\n" + obj.ContainerInventory.GetContentsDescription();
}
```

**Example Output:**
```
You open the Chest.

Inside you find:
  - Health Potion
  - Iron Key
```

### 6.2 UnlockWithKey

**Signature:** `UnlockResult UnlockWithKey(InteractiveObject obj, Player player)`

**Algorithm:**
1. Check object is locked → `NotLocked` if false
2. Check object has lock → `NotLocked` if false
3. Search player inventory for matching key:
   ```csharp
   player.Inventory.Items.FirstOrDefault(i => 
       i.IsKey && i.KeyId != null && obj.Lock.KeyMatches(i.KeyId))
   ```
4. No matching key → `NoKey`
5. Try unlock with key → `Failed` if mismatch
6. If key consumed: remove from inventory
7. Return `SuccessWithKey`

**Key Search Priority:** First match in inventory order

### 6.3 PickLock

**Signature:** `UnlockResult PickLock(InteractiveObject obj, Player player)`

**Current Implementation (Simplified):**
1. Check locked → `NotLocked`
2. Check has lock → `NotLocked`
3. Check pickable → `CannotPick`
4. **Always succeeds** (skill check deferred to future)
5. Return `SuccessWithLockpick`

**Future Integration:** Will use `SkillCheckService.PerformCheckWithDC()` with Finesse skill

### 6.4 Lock

**Signature:** `InteractionResult Lock(InteractiveObject obj)`

**Preconditions:**
- Not already locked
- Has a lock
- Lock allows relocking (`CanRelock = true`)
- Object is in Closed state

### 6.5 TakeFromContainer

**Signature:** `InteractionResult TakeFromContainer(InteractiveObject container, string itemName, Player player)`

**Preconditions:**
- Object is a container
- Container is in Open state
- Item exists in container (partial name match)
- Player inventory not full

**Item Search:** Uses `GetItemByPartialName()` - partial, case-insensitive

### 6.6 TakeAllFromContainer

**Signature:** `InteractionResult TakeAllFromContainer(InteractiveObject container, Player player)`

**Behavior:**
- Takes items until player inventory full
- Reports taken items and left behind items
- Message indicates if container now empty

### 6.7 PutInContainer

**Signature:** `InteractionResult PutInContainer(InteractiveObject container, string itemName, Player player)`

**Preconditions:**
- Object is a container
- Container is Open
- Item exists in player inventory (exact name match via `GetByName`)
- Container not full

**Item Search:** Uses `GetByName()` - exact, case-insensitive (from Inventory)

---

## 7. User Stories

### 7.1 Container Stories

| ID | As a... | I want to... | So that... |
|----|---------|--------------|------------|
| C1 | Player | Open a chest | I can see what's inside |
| C2 | Player | Take specific item from chest | I can collect loot |
| C3 | Player | Take all items from chest | I can quickly collect loot |
| C4 | Player | Put item in container | I can store items for later |
| C5 | Player | See "container full" message | I know I can't add more |

### 7.2 Lock Stories

| ID | As a... | I want to... | So that... |
|----|---------|--------------|------------|
| L1 | Player | Unlock with key in inventory | I can open locked objects |
| L2 | Player | Auto-detect matching key | I don't have to specify which key |
| L3 | Player | Pick a lock | I can open without key |
| L4 | Player | See "no key" message | I know to find a key |
| L5 | Player | Lock a chest | I can secure my items |
| L6 | Designer | Create key-only locks | I can force key collection |
| L7 | Designer | Create pickable locks | I can offer skill alternatives |
| L8 | Designer | Create consumable keys | I can create single-use puzzles |

---

## 8. Use Cases

### UC1: Open Locked Chest with Key

**Preconditions:**
- Player has "chest-key" in inventory
- Chest has lock with RequiredKeyId = "chest-key"
- Chest state is Locked

**Steps:**
1. Player: `unlock chest`
2. System: Searches inventory for matching key
3. System: Finds key, calls `TryUnlockWithKey("chest-key")`
4. System: State changes Locked → Closed
5. System: Returns "You use the Iron Key to unlock the Chest."
6. Player: `open chest`
7. System: State changes Closed → Open
8. System: Returns contents description

### UC2: Pick Lock on Door

**Preconditions:**
- Door has `IsLockpickable = true`, `LockpickDC = 12`
- Door state is Locked

**Steps:**
1. Player: `pick lock on door`
2. System: Validates lock is pickable
3. System: (Future: skill check vs DC 12)
4. System: Calls `Unlock()`, state → Closed
5. System: Returns "You carefully work the lock... clicks open."

### UC3: Store Item in Container

**Preconditions:**
- Chest is Open
- Player has "Gold Ring" in inventory
- Chest has remaining capacity

**Steps:**
1. Player: `put ring in chest`
2. System: Finds "Gold Ring" in player inventory
3. System: Removes from player, adds to chest
4. System: Returns "You put the Gold Ring in the Chest."

### UC4: Consumable Key

**Preconditions:**
- Player has key with `IsKeyConsumedOnUse = true`
- Lock matches key

**Steps:**
1. Player: `unlock door`
2. System: Finds matching key
3. System: Unlocks door
4. System: Removes key from inventory
5. System: Returns "You use the Skeleton Key to unlock the Door."
6. Key no longer in inventory

---

## 9. Error Conditions

### 9.1 Container Errors

| Error | Condition | Message |
|-------|-----------|---------|
| NotContainer | `IsContainer = false` | "The {name} is not a container." |
| NotOpen | Container not Open | "The {name} is not open." |
| ItemNotFound | Item not in container | "There is no '{item}' in the {name}." |
| InventoryFull | Player inventory at capacity | "Your inventory is full." |
| ContainerFull | Container at capacity | "The {name} is full." |
| NoItemInInventory | Item not in player inventory | "You don't have '{item}' in your inventory." |

### 9.2 Lock Errors

| Error | Condition | Message |
|-------|-----------|---------|
| NotLocked | State ≠ Locked | "The {name} is not locked." |
| NoKey | No matching key in inventory | "You don't have a key that fits this lock." |
| CannotPick | `IsLockpickable = false` | "This lock cannot be picked." |
| AlreadyLocked | State = Locked | "The {name} is already locked." |
| NoLock | `HasLock = false` | "The {name} doesn't have a lock." |
| CannotRelock | `CanRelock = false` | "This lock cannot be relocked." |
| MustClose | State ≠ Closed for locking | "You need to close the {name} before locking it." |

### 9.3 Validation Errors

| Error | Condition | Exception |
|-------|-----------|-----------|
| InvalidCapacity | capacity ≤ 0 | `ArgumentException` |
| NullObject | null passed to service | `ArgumentNullException` |
| EmptyItemName | empty string for item name | `ArgumentException` |

---

## 10. Limitations

### 10.1 Current Limitations

| Limitation | Impact | Future Resolution |
|------------|--------|-------------------|
| No skill check for lockpicking | Always succeeds if pickable | v0.4.0c: SkillCheckService integration |
| No partial match for Put | Must use exact item name | Future: Add `GetByPartialName` to Inventory |
| No nested containers | Can't put container in container | Not planned |
| Single key per lock | One-to-one relationship | Future: key sets |
| No lockpick item required | Picking works without tools | v0.4.0c: require lockpicks |
| First match for key search | Not closest match | By design |
| No container weight limit | Only count-based capacity | Future enhancement |

### 10.2 Known Edge Cases

| Edge Case | Current Behavior | Notes |
|-----------|------------------|-------|
| Multiple matching keys | First one in inventory used | By design |
| Container opened while locked | Open fails with "locked" message | Correct |
| Lock set on Open object | State doesn't change to Locked | Only Closed → Locked |
| TakeAll with full inventory | Takes until full, reports left behind | Correct |
| Empty container contents | "The container is empty." | Correct |

---

## 11. Configuration

### 11.1 InteractiveObjectDefinition Properties

```json
{
  "id": "locked-chest",
  "name": "Locked Chest",
  "description": "A sturdy wooden chest secured with an iron lock.",
  "objectType": "Chest",
  "defaultState": "Closed",
  "allowedInteractions": ["Open", "Close", "Examine", "Unlock", "Lock"],
  "isContainer": true,
  "containerCapacity": 10,
  "lock": {
    "lockId": "chest-lock",
    "requiredKeyId": "chest-key",
    "isLockpickable": true,
    "lockpickDC": 12,
    "keyConsumedOnUse": false,
    "canRelock": true
  }
}
```

### 11.2 Key Item Configuration

```json
{
  "id": "chest-key",
  "name": "Iron Key",
  "description": "A simple iron key. It must open something.",
  "type": "Key",
  "keyId": "chest-key",
  "isKeyConsumedOnUse": false
}
```

---

## 12. Logging

### 12.1 Log Levels

| Level | Used For |
|-------|----------|
| `LogInformation` | Successful operations |
| `LogDebug` | Attempt starts, intermediate states |

### 12.2 Log Messages

| Operation | Level | Template |
|-----------|-------|----------|
| Open container | Info | `"Opened {ObjectName}"` |
| Unlock with key | Info | `"Unlocked {ObjectName} with {KeyName}"` |
| Key consumed | Info | `"Key {KeyName} consumed after unlocking {ObjectName}"` |
| Lock object | Info | `"Locked {ObjectName}"` |
| Take item | Info | `"Took {ItemName} from {ContainerName}"` |
| Take all | Info | `"Took {Count} items from {ContainerName}"` |
| Put item | Info | `"Put {ItemName} in {ContainerName}"` |
| Pick lock success | Info | `"Successfully picked lock on {ObjectName}"` |
| Unlock attempt | Debug | `"Attempting to unlock {ObjectName} with key"` |
| No matching key | Debug | `"No matching key found for {ObjectName}"` |
| Lock not pickable | Debug | `"Lock on {ObjectName} cannot be picked"` |

---

## 13. Testing Coverage

### 13.1 ContainerInventory Tests (17 tests)

| Category | Tests |
|----------|-------|
| Create | Valid capacity, zero capacity, negative capacity, Empty factory |
| TryAddItem | Not full, full, null item |
| RemoveItem | Existing, non-existing |
| GetItemByName | Case-insensitive, not found |
| GetItemByPartialName | Partial match |
| TakeAll | Returns all, clears |
| State Properties | IsEmpty, IsFull, RemainingCapacity |
| GetContentsDescription | Empty, with items |

### 13.2 LockDefinition Tests (11 tests)

| Category | Tests |
|----------|-------|
| None | Has no lock |
| KeyOnly | Properties, consume key, no relock |
| Pickable | DC, optional key |
| KeyOrPick | Both options |
| KeyMatches | Matching, case-insensitive, wrong key, no required key |

### 13.3 InteractiveObject Lock Tests (12 tests)

| Category | Tests |
|----------|-------|
| SetLock | Sets definition, changes state |
| TryUnlockWithKey | Matching key, wrong key, not locked, no lock |
| Unlock | When locked, when not locked |
| TryLock | When closed, when not closed, cannot relock, already locked, no lock |
| Container | SetupAsContainer, IsContainer false |

---

## Appendix: Related Files

| File | Purpose |
|------|---------|
| `Domain/ValueObjects/ContainerInventory.cs` | Container storage |
| `Domain/ValueObjects/LockDefinition.cs` | Lock configuration |
| `Domain/ValueObjects/UnlockResult.cs` | Unlock operation result |
| `Domain/Enums/ItemType.cs` | ItemType.Key enum |
| `Domain/Entities/Item.cs` | Key item support |
| `Domain/Entities/InteractiveObject.cs` | Container/lock integration |
| `Domain/Definitions/InteractiveObjectDefinition.cs` | JSON configuration |
| `Application/Interfaces/IInteractionService.cs` | Service interface |
| `Application/Services/InteractionService.cs` | Service implementation |
