# v0.17.5d Design Specification: Creation Controller

**Version:** 0.17.5d
**Theme:** Creation Controller
**Author:** Claude
**Created:** 2026-01-28
**Status:** Draft
**Prerequisites:** v0.17.5a-c Complete (State, ViewModel, Name Validation)

---

## Table of Contents

1. [Overview](#1-overview)
2. [Dependencies](#2-dependencies)
3. [Architecture Diagrams](#3-architecture-diagrams)
4. [ICharacterCreationController Interface](#4-icharactercreationcontroller-interface)
5. [StepResult Value Object](#5-stepresult-value-object)
6. [CharacterCreationController Service](#6-charactercreationcontroller-service)
7. [Configuration](#7-configuration)
8. [User-Facing Changes](#8-user-facing-changes)
9. [Logging Specifications](#9-logging-specifications)
10. [Unit Testing Requirements](#10-unit-testing-requirements)
11. [Use Cases](#11-use-cases)
12. [Deliverable Checklist](#12-deliverable-checklist)
13. [Acceptance Criteria](#13-acceptance-criteria)
14. [Future Considerations](#14-future-considerations)
15. [Implementation Notes](#15-implementation-notes)
16. [Document Metadata](#16-document-metadata)

---

## 1. Overview

### 1.1 Purpose

This document provides a comprehensive design specification for v0.17.5d, the Creation Controller phase. This phase implements the central orchestrator for the character creation workflow.

Key components:

1. **ICharacterCreationController Interface**: Contract defining all step selection methods, navigation controls, and state retrieval.

2. **StepResult Value Object**: Immutable result containing success status, next step, validation errors, and updated ViewModel.

3. **CharacterCreationController Service**: Orchestrates step transitions, validates selections, and coordinates with providers and the character factory.

This controller is the bridge between TUI screens (v0.17.5f) and the domain logic.

### 1.2 Current vs. Target Implementation

| Aspect                 | Current Implementation | Target Implementation                           |
| ---------------------- | ---------------------- | ----------------------------------------------- |
| **Step Orchestration** | Not implemented        | `CharacterCreationController` service           |
| **Selection Handling** | Not implemented        | Step-specific selection methods                 |
| **Navigation Control** | Not implemented        | `GoBack()`, `Cancel()` with state preservation  |
| **Character Finalize** | Not implemented        | `ConfirmCharacterAsync()` with factory creation |

### 1.3 Scope

**In Scope:**

- Define `ICharacterCreationController` interface
- Define `StepResult` value object
- Define `CharacterCreationResult` value object
- Implement `CharacterCreationController` service
- Unit tests (~6 tests)

**Out of Scope:**

- Character factory implementation - v0.17.5e
- TUI screens - v0.17.5f
- Database persistence - v0.17.5g

### 1.4 Key Deliverables

| Type          | Count | Details                                              |
| ------------- | ----- | ---------------------------------------------------- |
| Interfaces    | 1     | `ICharacterCreationController`                       |
| Value Objects | 2     | `StepResult`, `CharacterCreationResult`              |
| Services      | 1     | `CharacterCreationController`                        |
| Unit Tests    | ~6    | Initialize, step transitions, navigation, validation |

---

## 2. Dependencies

### 2.1 Required from v0.17.5a (Creation Step Enum & State)

| Component                | Location                                          | Usage in v0.17.5d  |
| ------------------------ | ------------------------------------------------- | ------------------ |
| `CharacterCreationStep`  | `Domain/Enums/CharacterCreationStep.cs`           | Step navigation    |
| `CharacterCreationState` | `Domain/Entities/CharacterCreationState.cs`       | State management   |
| Extension methods        | `Domain/Enums/CharacterCreationStepExtensions.cs` | Navigation helpers |

### 2.2 Required from v0.17.5b (Creation ViewModel)

| Component                    | Location                                            | Usage in v0.17.5d      |
| ---------------------------- | --------------------------------------------------- | ---------------------- |
| `CharacterCreationViewModel` | `Domain/ValueObjects/CharacterCreationViewModel.cs` | Result ViewModel       |
| `IViewModelBuilder`          | `Application/Interfaces/IViewModelBuilder.cs`       | ViewModel construction |

### 2.3 Required from v0.17.5c (Name Validation)

| Component              | Location                                      | Usage in v0.17.5d |
| ---------------------- | --------------------------------------------- | ----------------- |
| `INameValidator`       | `Application/Interfaces/INameValidator.cs`    | Name validation   |
| `NameValidationResult` | `Domain/ValueObjects/NameValidationResult.cs` | Validation result |

### 2.4 Required from v0.17.0-v0.17.4 (Character Systems)

| Component                 | Location                                            | Usage in v0.17.5d         |
| ------------------------- | --------------------------------------------------- | ------------------------- |
| `ILineageProvider`        | `Application/Interfaces/ILineageProvider.cs`        | Lineage validation        |
| `IBackgroundProvider`     | `Application/Interfaces/IBackgroundProvider.cs`     | Background validation     |
| `IArchetypeProvider`      | `Application/Interfaces/IArchetypeProvider.cs`      | Archetype validation      |
| `ISpecializationProvider` | `Application/Interfaces/ISpecializationProvider.cs` | Specialization validation |

### 2.5 Provides to Future Versions

| Version  | Component                      | Usage                               |
| -------- | ------------------------------ | ----------------------------------- |
| v0.17.5e | `ICharacterCreationController` | Factory receives confirmed state    |
| v0.17.5f | `ICharacterCreationController` | TUI screens call controller         |
| v0.17.5g | `CharacterCreationResult`      | Database persists created character |

---

## 3. Architecture Diagrams

### 3.1 Controller Flow Overview

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                      CONTROLLER FLOW OVERVIEW                                │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  TUI Screen                                                                  │
│       │                                                                      │
│       ▼                                                                      │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │               ICharacterCreationController                           │   │
│  │                                                                      │   │
│  │  Initialize() ──────────────────────────────────────▶ Step 1        │   │
│  │  SelectLineageAsync(lineage, flexBonus) ────────────▶ Step 2        │   │
│  │  SelectBackgroundAsync(background) ─────────────────▶ Step 3        │   │
│  │  ConfirmAttributesAsync(attributes) ────────────────▶ Step 4        │   │
│  │  SelectArchetypeAsync(archetype) ───────────────────▶ Step 5        │   │
│  │  SelectSpecializationAsync(spec) ───────────────────▶ Step 6        │   │
│  │  ConfirmCharacterAsync(name) ───────────────────────▶ Complete      │   │
│  │                                                                      │   │
│  │  GoBack() ──────────────────────────────────────────▶ Previous      │   │
│  │  Cancel() ──────────────────────────────────────────▶ Exit          │   │
│  │  GetCurrentState() ─────────────────────────────────▶ (State, VM)   │   │
│  │                                                                      │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│              │                                                               │
│              ▼                                                               │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                         StepResult                                   │   │
│  │  • Success: bool                                                    │   │
│  │  • NextStep: CharacterCreationStep?                                 │   │
│  │  • ValidationErrors: IReadOnlyList<string>                          │   │
│  │  • UpdatedViewModel: CharacterCreationViewModel                     │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 3.2 Step Selection Flow

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                       STEP SELECTION FLOW                                    │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  SelectLineageAsync(Lineage.ClanBorn, CoreAttribute.Might)                  │
│         │                                                                    │
│         ▼                                                                    │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │  1. Validate Selection                                               │   │
│  │     • Is lineage valid?                                              │   │
│  │     • If Clan-Born, is flexibleBonus provided?                       │   │
│  │     • If Clan-Born, is flexibleBonus valid (not the +2 attribute)?   │   │
│  └───────────────────────────┬─────────────────────────────────────────┘   │
│                              │                                               │
│              ┌───────────────┴───────────────┐                              │
│              │                               │                               │
│         VALID ▼                         INVALID ▼                            │
│  ┌────────────────────┐           ┌────────────────────────────┐            │
│  │ 2. Update State    │           │ Return StepResult.Failure  │            │
│  │    • SelectedLineage│          │    • ValidationErrors      │            │
│  │    • FlexibleBonus  │           └────────────────────────────┘            │
│  └─────────┬──────────┘                                                      │
│            │                                                                 │
│            ▼                                                                 │
│  ┌────────────────────┐                                                     │
│  │ 3. Advance Step    │                                                     │
│  │    CurrentStep =   │                                                     │
│  │    Background      │                                                     │
│  └─────────┬──────────┘                                                     │
│            │                                                                 │
│            ▼                                                                 │
│  ┌────────────────────┐                                                     │
│  │ 4. Build ViewModel │                                                     │
│  │    via IViewModelBuilder                                                 │
│  └─────────┬──────────┘                                                     │
│            │                                                                 │
│            ▼                                                                 │
│  ┌────────────────────────────────────────────────┐                         │
│  │ 5. Return StepResult.Success                   │                         │
│  │    • NextStep = Background                     │                         │
│  │    • UpdatedViewModel = (rebuilt)              │                         │
│  └────────────────────────────────────────────────┘                         │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 3.3 Layer Architecture

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                          LAYER ARCHITECTURE                                  │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  ┌────────────────────────────────────────────────────────────────────┐     │
│  │                     APPLICATION LAYER                               │     │
│  │                                                                     │     │
│  │  ┌───────────────────────────────────────────────────────────────┐ │     │
│  │  │               ICharacterCreationController                     │ │     │
│  │  │                                                                │ │     │
│  │  │  CharacterCreationState Initialize()                          │ │     │
│  │  │  Task<StepResult> SelectLineageAsync(...)                     │ │     │
│  │  │  Task<StepResult> SelectBackgroundAsync(...)                  │ │     │
│  │  │  Task<StepResult> ConfirmAttributesAsync(...)                 │ │     │
│  │  │  Task<StepResult> SelectArchetypeAsync(...)                   │ │     │
│  │  │  Task<StepResult> SelectSpecializationAsync(...)              │ │     │
│  │  │  Task<CharacterCreationResult> ConfirmCharacterAsync(...)     │ │     │
│  │  │  StepResult GoBack()                                          │ │     │
│  │  │  void Cancel()                                                 │ │     │
│  │  │  (State, ViewModel) GetCurrentState()                         │ │     │
│  │  │                                                                │ │     │
│  │  └───────────────────────────────────────────────────────────────┘ │     │
│  │                              │                                      │     │
│  │                              ▼                                      │     │
│  │  ┌───────────────────────────────────────────────────────────────┐ │     │
│  │  │                CharacterCreationController                     │ │     │
│  │  │                                                                │ │     │
│  │  │  Dependencies:                                                 │ │     │
│  │  │  • ILineageProvider                                           │ │     │
│  │  │  • IBackgroundProvider                                        │ │     │
│  │  │  • IArchetypeProvider                                         │ │     │
│  │  │  • ISpecializationProvider                                    │ │     │
│  │  │  • IViewModelBuilder                                          │ │     │
│  │  │  • INameValidator                                             │ │     │
│  │  │  • ICharacterFactory (v0.17.5e)                               │ │     │
│  │  │  • ILogger<CharacterCreationController>                       │ │     │
│  │  │                                                                │ │     │
│  │  └───────────────────────────────────────────────────────────────┘ │     │
│  │                                                                     │     │
│  └────────────────────────────────────────────────────────────────────┘     │
│                                                                              │
│  ┌────────────────────────────────────────────────────────────────────┐     │
│  │                       DOMAIN LAYER                                  │     │
│  │                                                                     │     │
│  │  ┌──────────────────────────┐  ┌──────────────────────────┐       │     │
│  │  │ StepResult               │  │ CharacterCreationResult  │       │     │
│  │  │ (Value Object)           │  │ (Value Object)           │       │     │
│  │  │                          │  │                          │       │     │
│  │  │ • Success                │  │ • Success                │       │     │
│  │  │ • NextStep               │  │ • Character              │       │     │
│  │  │ • ValidationErrors       │  │ • Message                │       │     │
│  │  │ • UpdatedViewModel       │  │ • ValidationErrors       │       │     │
│  │  └──────────────────────────┘  └──────────────────────────┘       │     │
│  │                                                                     │     │
│  └────────────────────────────────────────────────────────────────────┘     │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 4. ICharacterCreationController Interface

### 4.1 Interface Definition

**File:** `src/Core/RuneAndRust.Application/Interfaces/ICharacterCreationController.cs`

```csharp
using RuneAndRust.Domain.Entities;
using RuneAndRust.Domain.Enums;
using RuneAndRust.Domain.ValueObjects;

namespace RuneAndRust.Application.Interfaces;

/// <summary>
/// Orchestrates the character creation workflow, managing state transitions,
/// validating selections, and coordinating with providers and the character factory.
/// </summary>
public interface ICharacterCreationController
{
    /// <summary>
    /// Initializes a new character creation session.
    /// Creates fresh state starting at Step 1 (Lineage).
    /// </summary>
    /// <returns>Initialized creation state at Lineage step.</returns>
    CharacterCreationState Initialize();

    /// <summary>
    /// Processes lineage selection (Step 1).
    /// </summary>
    /// <param name="lineage">The selected lineage.</param>
    /// <param name="flexibleBonus">
    /// Required for Clan-Born lineage. The attribute to receive +1 bonus.
    /// Must not be the attribute already receiving +2.
    /// </param>
    /// <returns>Result containing success status and updated ViewModel.</returns>
    Task<StepResult> SelectLineageAsync(Lineage lineage, CoreAttribute? flexibleBonus = null);

    /// <summary>
    /// Processes background selection (Step 2).
    /// </summary>
    /// <param name="background">The selected background.</param>
    /// <returns>Result containing success status and updated ViewModel.</returns>
    Task<StepResult> SelectBackgroundAsync(Background background);

    /// <summary>
    /// Processes attribute allocation confirmation (Step 3).
    /// </summary>
    /// <param name="attributes">The confirmed attribute allocation state.</param>
    /// <returns>Result containing success status and updated ViewModel.</returns>
    Task<StepResult> ConfirmAttributesAsync(AttributeAllocationState attributes);

    /// <summary>
    /// Processes archetype selection (Step 4 - PERMANENT CHOICE).
    /// </summary>
    /// <param name="archetype">The selected archetype.</param>
    /// <returns>Result containing success status and updated ViewModel.</returns>
    /// <remarks>
    /// This is a PERMANENT choice that cannot be changed after character creation.
    /// The controller should warn the user before confirming.
    /// </remarks>
    Task<StepResult> SelectArchetypeAsync(Archetype archetype);

    /// <summary>
    /// Processes specialization selection (Step 5).
    /// </summary>
    /// <param name="specialization">The selected specialization ID.</param>
    /// <returns>Result containing success status and updated ViewModel.</returns>
    Task<StepResult> SelectSpecializationAsync(SpecializationId specialization);

    /// <summary>
    /// Processes final character confirmation with name (Step 6).
    /// Validates name, creates character via factory, and prepares for persistence.
    /// </summary>
    /// <param name="name">The character name to validate and assign.</param>
    /// <returns>Result containing created character or validation errors.</returns>
    Task<CharacterCreationResult> ConfirmCharacterAsync(string name);

    /// <summary>
    /// Navigates back to the previous step, preserving current selections.
    /// </summary>
    /// <returns>Result with previous step and updated ViewModel.</returns>
    StepResult GoBack();

    /// <summary>
    /// Cancels character creation and clears all state.
    /// </summary>
    void Cancel();

    /// <summary>
    /// Gets the current state and corresponding ViewModel.
    /// </summary>
    /// <returns>Tuple of current state and ViewModel.</returns>
    (CharacterCreationState State, CharacterCreationViewModel ViewModel) GetCurrentState();

    /// <summary>
    /// Gets whether a creation session is currently active.
    /// </summary>
    bool IsSessionActive { get; }
}
```

---

## 5. StepResult Value Object

### 5.1 Value Object Definition

**File:** `src/Core/RuneAndRust.Domain/ValueObjects/StepResult.cs`

```csharp
using RuneAndRust.Domain.Enums;

namespace RuneAndRust.Domain.ValueObjects;

/// <summary>
/// Represents the result of a step selection or navigation action
/// in the character creation workflow.
/// </summary>
public readonly record struct StepResult
{
    /// <summary>
    /// Gets whether the action succeeded.
    /// </summary>
    public bool Success { get; init; }

    /// <summary>
    /// Gets the next step after a successful action.
    /// Null if action failed or if at final step.
    /// </summary>
    public CharacterCreationStep? NextStep { get; init; }

    /// <summary>
    /// Gets the current step (after action).
    /// </summary>
    public CharacterCreationStep CurrentStep { get; init; }

    /// <summary>
    /// Gets validation errors if the action failed.
    /// Empty if successful.
    /// </summary>
    public IReadOnlyList<string> ValidationErrors { get; init; }

    /// <summary>
    /// Gets the updated ViewModel reflecting the new state.
    /// </summary>
    public CharacterCreationViewModel UpdatedViewModel { get; init; }

    // ═══════════════════════════════════════════════════════════════════════
    // Factory Methods
    // ═══════════════════════════════════════════════════════════════════════

    /// <summary>
    /// Creates a successful step result.
    /// </summary>
    public static StepResult Succeeded(
        CharacterCreationStep currentStep,
        CharacterCreationStep? nextStep,
        CharacterCreationViewModel viewModel) => new()
    {
        Success = true,
        CurrentStep = currentStep,
        NextStep = nextStep,
        ValidationErrors = Array.Empty<string>(),
        UpdatedViewModel = viewModel
    };

    /// <summary>
    /// Creates a failed step result with validation errors.
    /// </summary>
    public static StepResult Failed(
        CharacterCreationStep currentStep,
        CharacterCreationViewModel viewModel,
        params string[] errors) => new()
    {
        Success = false,
        CurrentStep = currentStep,
        NextStep = null,
        ValidationErrors = errors,
        UpdatedViewModel = viewModel
    };

    /// <summary>
    /// Creates a failed step result from a list of errors.
    /// </summary>
    public static StepResult Failed(
        CharacterCreationStep currentStep,
        CharacterCreationViewModel viewModel,
        IReadOnlyList<string> errors) => new()
    {
        Success = false,
        CurrentStep = currentStep,
        NextStep = null,
        ValidationErrors = errors,
        UpdatedViewModel = viewModel
    };
}
```

### 5.2 CharacterCreationResult Value Object

**File:** `src/Core/RuneAndRust.Domain/ValueObjects/CharacterCreationResult.cs`

```csharp
using RuneAndRust.Domain.Entities;

namespace RuneAndRust.Domain.ValueObjects;

/// <summary>
/// Represents the final result of character creation.
/// Contains either the created character or validation errors.
/// </summary>
public readonly record struct CharacterCreationResult
{
    /// <summary>
    /// Gets whether character creation succeeded.
    /// </summary>
    public bool Success { get; init; }

    /// <summary>
    /// Gets the created character if successful.
    /// Null if creation failed.
    /// </summary>
    public Player? Character { get; init; }

    /// <summary>
    /// Gets the success or error message.
    /// </summary>
    public string Message { get; init; }

    /// <summary>
    /// Gets validation errors if creation failed.
    /// </summary>
    public IReadOnlyList<string> ValidationErrors { get; init; }

    // ═══════════════════════════════════════════════════════════════════════
    // Factory Methods
    // ═══════════════════════════════════════════════════════════════════════

    /// <summary>
    /// Creates a successful creation result.
    /// </summary>
    public static CharacterCreationResult Succeeded(Player character, string message) => new()
    {
        Success = true,
        Character = character,
        Message = message,
        ValidationErrors = Array.Empty<string>()
    };

    /// <summary>
    /// Creates a failed creation result.
    /// </summary>
    public static CharacterCreationResult Failed(string message, params string[] errors) => new()
    {
        Success = false,
        Character = null,
        Message = message,
        ValidationErrors = errors
    };
}
```

---

## 6. CharacterCreationController Service

### 6.1 Service Implementation

**File:** `src/Core/RuneAndRust.Application/Services/CharacterCreationController.cs`

```csharp
using Microsoft.Extensions.Logging;
using RuneAndRust.Application.Interfaces;
using RuneAndRust.Domain.Entities;
using RuneAndRust.Domain.Enums;
using RuneAndRust.Domain.ValueObjects;

namespace RuneAndRust.Application.Services;

/// <summary>
/// Orchestrates the character creation workflow.
/// </summary>
public class CharacterCreationController : ICharacterCreationController
{
    private readonly ILineageProvider _lineageProvider;
    private readonly IBackgroundProvider _backgroundProvider;
    private readonly IArchetypeProvider _archetypeProvider;
    private readonly ISpecializationProvider _specializationProvider;
    private readonly IViewModelBuilder _viewModelBuilder;
    private readonly INameValidator _nameValidator;
    private readonly ICharacterFactory? _characterFactory;
    private readonly ILogger<CharacterCreationController> _logger;

    private CharacterCreationState? _state;

    // ═══════════════════════════════════════════════════════════════════════
    // Error Messages
    // ═══════════════════════════════════════════════════════════════════════

    private const string ErrorNoActiveSession = "No active creation session.";
    private const string ErrorClanBornRequiresBonus =
        "Clan-Born lineage requires selecting a flexible attribute bonus.";
    private const string ErrorInvalidFlexibleBonus =
        "Flexible bonus cannot be the same as the primary +2 attribute.";
    private const string ErrorInvalidSpecialization =
        "Selected specialization is not available for the chosen archetype.";
    private const string ErrorIncompleteState =
        "Cannot confirm character: not all steps are complete.";

    public CharacterCreationController(
        ILineageProvider lineageProvider,
        IBackgroundProvider backgroundProvider,
        IArchetypeProvider archetypeProvider,
        ISpecializationProvider specializationProvider,
        IViewModelBuilder viewModelBuilder,
        INameValidator nameValidator,
        ILogger<CharacterCreationController> logger,
        ICharacterFactory? characterFactory = null)
    {
        _lineageProvider = lineageProvider;
        _backgroundProvider = backgroundProvider;
        _archetypeProvider = archetypeProvider;
        _specializationProvider = specializationProvider;
        _viewModelBuilder = viewModelBuilder;
        _nameValidator = nameValidator;
        _characterFactory = characterFactory;
        _logger = logger;
    }

    /// <inheritdoc />
    public bool IsSessionActive => _state != null;

    /// <inheritdoc />
    public CharacterCreationState Initialize()
    {
        _state = CharacterCreationState.Create();
        _logger.LogInformation(
            "Character creation session initialized. SessionId: {SessionId}",
            _state.SessionId);
        return _state;
    }

    /// <inheritdoc />
    public Task<StepResult> SelectLineageAsync(Lineage lineage, CoreAttribute? flexibleBonus = null)
    {
        if (_state == null)
            return Task.FromResult(CreateNoSessionResult());

        _logger.LogDebug(
            "Selecting lineage: {Lineage}, FlexibleBonus: {Bonus}",
            lineage, flexibleBonus);

        // Validate Clan-Born requires flexible bonus
        if (lineage == Lineage.ClanBorn)
        {
            if (!flexibleBonus.HasValue)
            {
                _logger.LogDebug("Validation failed: Clan-Born requires flexible bonus");
                return Task.FromResult(CreateFailureResult(ErrorClanBornRequiresBonus));
            }

            // Validate flexible bonus is not the primary +2 attribute
            var lineageDef = _lineageProvider.GetByLineage(lineage);
            if (lineageDef?.PrimaryAttribute == flexibleBonus.Value)
            {
                _logger.LogDebug("Validation failed: Flexible bonus same as primary");
                return Task.FromResult(CreateFailureResult(ErrorInvalidFlexibleBonus));
            }
        }

        // Update state
        _state.SelectedLineage = lineage;
        _state.FlexibleAttributeBonus = flexibleBonus;
        _state.CurrentStep = CharacterCreationStep.Background;
        _state.LastModifiedAt = DateTime.UtcNow;

        _logger.LogInformation(
            "Lineage selected: {Lineage}. Advancing to Background step.",
            lineage);

        return Task.FromResult(CreateSuccessResult(CharacterCreationStep.Background));
    }

    /// <inheritdoc />
    public Task<StepResult> SelectBackgroundAsync(Background background)
    {
        if (_state == null)
            return Task.FromResult(CreateNoSessionResult());

        _logger.LogDebug("Selecting background: {Background}", background);

        _state.SelectedBackground = background;
        _state.CurrentStep = CharacterCreationStep.Attributes;
        _state.LastModifiedAt = DateTime.UtcNow;

        _logger.LogInformation(
            "Background selected: {Background}. Advancing to Attributes step.",
            background);

        return Task.FromResult(CreateSuccessResult(CharacterCreationStep.Attributes));
    }

    /// <inheritdoc />
    public Task<StepResult> ConfirmAttributesAsync(AttributeAllocationState attributes)
    {
        if (_state == null)
            return Task.FromResult(CreateNoSessionResult());

        _logger.LogDebug("Confirming attributes allocation");

        if (!attributes.IsValid)
        {
            var errors = new List<string> { "Attribute allocation is invalid." };
            _logger.LogDebug("Validation failed: Invalid attribute allocation");
            return Task.FromResult(CreateFailureResult(errors));
        }

        _state.Attributes = attributes;
        _state.CurrentStep = CharacterCreationStep.Archetype;
        _state.LastModifiedAt = DateTime.UtcNow;

        _logger.LogInformation("Attributes confirmed. Advancing to Archetype step.");

        return Task.FromResult(CreateSuccessResult(CharacterCreationStep.Archetype));
    }

    /// <inheritdoc />
    public Task<StepResult> SelectArchetypeAsync(Archetype archetype)
    {
        if (_state == null)
            return Task.FromResult(CreateNoSessionResult());

        _logger.LogDebug("Selecting archetype: {Archetype}", archetype);

        _state.SelectedArchetype = archetype;
        // Clear specialization if archetype changes
        _state.SelectedSpecialization = null;
        _state.CurrentStep = CharacterCreationStep.Specialization;
        _state.LastModifiedAt = DateTime.UtcNow;

        _logger.LogInformation(
            "Archetype selected: {Archetype} (PERMANENT). Advancing to Specialization step.",
            archetype);

        return Task.FromResult(CreateSuccessResult(CharacterCreationStep.Specialization));
    }

    /// <inheritdoc />
    public Task<StepResult> SelectSpecializationAsync(SpecializationId specialization)
    {
        if (_state == null)
            return Task.FromResult(CreateNoSessionResult());

        _logger.LogDebug("Selecting specialization: {Specialization}", specialization);

        // Validate specialization is valid for archetype
        if (_state.SelectedArchetype.HasValue)
        {
            var validSpecs = _specializationProvider
                .GetByArchetype(_state.SelectedArchetype.Value);

            if (!validSpecs.Any(s => s.Id == specialization))
            {
                _logger.LogDebug(
                    "Validation failed: Specialization {Spec} not valid for archetype {Arch}",
                    specialization, _state.SelectedArchetype.Value);
                return Task.FromResult(CreateFailureResult(ErrorInvalidSpecialization));
            }
        }

        _state.SelectedSpecialization = specialization;
        _state.CurrentStep = CharacterCreationStep.Summary;
        _state.LastModifiedAt = DateTime.UtcNow;

        _logger.LogInformation(
            "Specialization selected: {Specialization}. Advancing to Summary step.",
            specialization);

        return Task.FromResult(CreateSuccessResult(CharacterCreationStep.Summary));
    }

    /// <inheritdoc />
    public async Task<CharacterCreationResult> ConfirmCharacterAsync(string name)
    {
        if (_state == null)
        {
            _logger.LogWarning("ConfirmCharacter called with no active session");
            return CharacterCreationResult.Failed(ErrorNoActiveSession);
        }

        _logger.LogDebug("Confirming character with name: '{Name}'", name);

        // Validate name
        var nameResult = _nameValidator.Validate(name);
        if (!nameResult.IsValid)
        {
            _logger.LogDebug("Name validation failed: {Error}", nameResult.ErrorMessage);
            return CharacterCreationResult.Failed(
                nameResult.ErrorMessage!,
                nameResult.ErrorMessage!);
        }

        _state.CharacterName = name;

        // Verify all steps complete
        if (!_state.IsComplete)
        {
            _logger.LogDebug("Creation state is not complete");
            return CharacterCreationResult.Failed(ErrorIncompleteState);
        }

        // Create character via factory (if available)
        if (_characterFactory == null)
        {
            _logger.LogWarning("Character factory not available - returning pending result");
            return CharacterCreationResult.Succeeded(
                null!,
                $"Character '{name}' ready for creation (factory pending)");
        }

        var character = await _characterFactory.CreateCharacterAsync(_state);

        _logger.LogInformation(
            "Character created: {Name} ({Lineage} {Archetype})",
            name, _state.SelectedLineage, _state.SelectedArchetype);

        // Clear state after successful creation
        _state = null;

        return CharacterCreationResult.Succeeded(
            character,
            $"{name} begins their saga.");
    }

    /// <inheritdoc />
    public StepResult GoBack()
    {
        if (_state == null)
            return CreateNoSessionResult();

        var previousStep = _state.CurrentStep.GetPreviousStep();
        if (previousStep == null)
        {
            _logger.LogDebug("Cannot go back from first step");
            return CreateFailureResult("Already at first step.");
        }

        _state.CurrentStep = previousStep.Value;
        _state.LastModifiedAt = DateTime.UtcNow;

        _logger.LogDebug("Navigated back to step: {Step}", previousStep.Value);

        return CreateSuccessResult(previousStep.Value);
    }

    /// <inheritdoc />
    public void Cancel()
    {
        if (_state != null)
        {
            _logger.LogInformation(
                "Character creation cancelled. SessionId: {SessionId}",
                _state.SessionId);
            _state = null;
        }
    }

    /// <inheritdoc />
    public (CharacterCreationState State, CharacterCreationViewModel ViewModel) GetCurrentState()
    {
        if (_state == null)
            throw new InvalidOperationException(ErrorNoActiveSession);

        var viewModel = _viewModelBuilder.Build(_state);
        return (_state, viewModel);
    }

    // ═══════════════════════════════════════════════════════════════════════
    // Private Helper Methods
    // ═══════════════════════════════════════════════════════════════════════

    private StepResult CreateSuccessResult(CharacterCreationStep currentStep)
    {
        var viewModel = _viewModelBuilder.Build(_state!);
        return StepResult.Succeeded(
            currentStep,
            currentStep.GetNextStep(),
            viewModel);
    }

    private StepResult CreateFailureResult(string error)
    {
        var viewModel = _state != null
            ? _viewModelBuilder.Build(_state)
            : CharacterCreationViewModel.Empty;

        return StepResult.Failed(_state?.CurrentStep ?? CharacterCreationStep.Lineage, viewModel, error);
    }

    private StepResult CreateFailureResult(IReadOnlyList<string> errors)
    {
        var viewModel = _state != null
            ? _viewModelBuilder.Build(_state)
            : CharacterCreationViewModel.Empty;

        return StepResult.Failed(_state?.CurrentStep ?? CharacterCreationStep.Lineage, viewModel, errors);
    }

    private StepResult CreateNoSessionResult()
    {
        _logger.LogWarning("Operation attempted with no active session");
        return StepResult.Failed(
            CharacterCreationStep.Lineage,
            CharacterCreationViewModel.Empty,
            ErrorNoActiveSession);
    }
}
```

---

## 7. Configuration

No additional configuration files are required for this version. The controller uses configuration from:

- `creation-workflow.json` (v0.17.5a) - Step definitions
- `nameValidation` section (v0.17.5c) - Name validation rules

---

## 8. User-Facing Changes

### 8.1 Workflow Impact

The controller enables the following user workflow:

1. **Start Creation**: `Initialize()` begins new session
2. **Step Navigation**: Each selection method advances to next step
3. **Back Navigation**: `GoBack()` returns to previous step with selections preserved
4. **Cancel**: `Cancel()` exits workflow and clears all selections
5. **Confirm**: `ConfirmCharacterAsync()` validates name and creates character

### 8.2 Error Feedback

Users receive specific error messages for:

- Missing required selections (e.g., Clan-Born flexible bonus)
- Invalid specialization for chosen archetype
- Name validation failures (from v0.17.5c)
- Incomplete state on confirmation

---

## 9. Logging Specifications

### 9.1 Log Levels

| Level       | Usage                                              |
| ----------- | -------------------------------------------------- |
| Debug       | Validation checks, step transitions, state changes |
| Information | Session init/cancel, successful selections         |
| Warning     | Operations with no active session                  |
| Error       | Unexpected failures                                |

### 9.2 Structured Logging Examples

```csharp
// Session lifecycle
_logger.LogInformation(
    "Character creation session initialized. SessionId: {SessionId}",
    _state.SessionId);

// Step selection
_logger.LogInformation(
    "Lineage selected: {Lineage}. Advancing to Background step.",
    lineage);

// Permanent choice
_logger.LogInformation(
    "Archetype selected: {Archetype} (PERMANENT). Advancing to Specialization step.",
    archetype);

// Character creation
_logger.LogInformation(
    "Character created: {Name} ({Lineage} {Archetype})",
    name, _state.SelectedLineage, _state.SelectedArchetype);
```

---

## 10. Unit Testing Requirements

### 10.1 Test Summary

| Test # | Test Name                                        | Description                           |
| ------ | ------------------------------------------------ | ------------------------------------- |
| 1      | `Initialize_CreatesNewSession`                   | Verify fresh state at Lineage step    |
| 2      | `SelectLineage_ClanBorn_RequiresFlexibleBonus`   | Clan-Born without bonus fails         |
| 3      | `SelectLineage_Valid_AdvancesToBackground`       | Valid selection advances to next step |
| 4      | `SelectSpecialization_InvalidForArchetype_Fails` | Wrong specialization rejected         |
| 5      | `GoBack_FromBackground_ReturnsToLineage`         | Navigation preserves selections       |
| 6      | `ConfirmCharacter_InvalidName_ReturnsError`      | Name validation integrated            |

### 10.2 Test Implementation

**File:** `tests/RuneAndRust.Application.UnitTests/Services/CharacterCreationControllerTests.cs`

```csharp
using FluentAssertions;
using Microsoft.Extensions.Logging;
using Moq;
using NUnit.Framework;
using RuneAndRust.Application.Interfaces;
using RuneAndRust.Application.Services;
using RuneAndRust.Domain.Enums;
using RuneAndRust.Domain.ValueObjects;

namespace RuneAndRust.Application.UnitTests.Services;

[TestFixture]
public class CharacterCreationControllerTests
{
    private Mock<ILineageProvider> _lineageProviderMock = null!;
    private Mock<IBackgroundProvider> _backgroundProviderMock = null!;
    private Mock<IArchetypeProvider> _archetypeProviderMock = null!;
    private Mock<ISpecializationProvider> _specializationProviderMock = null!;
    private Mock<IViewModelBuilder> _viewModelBuilderMock = null!;
    private Mock<INameValidator> _nameValidatorMock = null!;
    private Mock<ILogger<CharacterCreationController>> _loggerMock = null!;
    private CharacterCreationController _controller = null!;

    [SetUp]
    public void Setup()
    {
        _lineageProviderMock = new Mock<ILineageProvider>();
        _backgroundProviderMock = new Mock<IBackgroundProvider>();
        _archetypeProviderMock = new Mock<IArchetypeProvider>();
        _specializationProviderMock = new Mock<ISpecializationProvider>();
        _viewModelBuilderMock = new Mock<IViewModelBuilder>();
        _nameValidatorMock = new Mock<INameValidator>();
        _loggerMock = new Mock<ILogger<CharacterCreationController>>();

        _viewModelBuilderMock
            .Setup(x => x.Build(It.IsAny<CharacterCreationState>()))
            .Returns(CharacterCreationViewModel.Empty);

        _controller = new CharacterCreationController(
            _lineageProviderMock.Object,
            _backgroundProviderMock.Object,
            _archetypeProviderMock.Object,
            _specializationProviderMock.Object,
            _viewModelBuilderMock.Object,
            _nameValidatorMock.Object,
            _loggerMock.Object);
    }

    [Test]
    public void Initialize_CreatesNewSession_AtLineageStep()
    {
        // Act
        var state = _controller.Initialize();

        // Assert
        state.Should().NotBeNull();
        state.CurrentStep.Should().Be(CharacterCreationStep.Lineage);
        state.SessionId.Should().NotBeNullOrEmpty();
        _controller.IsSessionActive.Should().BeTrue();
    }

    [Test]
    public async Task SelectLineage_ClanBorn_WithoutFlexibleBonus_Fails()
    {
        // Arrange
        _controller.Initialize();

        // Act
        var result = await _controller.SelectLineageAsync(Lineage.ClanBorn);

        // Assert
        result.Success.Should().BeFalse();
        result.ValidationErrors.Should().Contain(e =>
            e.Contains("flexible attribute bonus"));
    }

    [Test]
    public async Task SelectLineage_Valid_AdvancesToBackground()
    {
        // Arrange
        _controller.Initialize();

        // Act
        var result = await _controller.SelectLineageAsync(Lineage.RuneMarked);

        // Assert
        result.Success.Should().BeTrue();
        result.NextStep.Should().Be(CharacterCreationStep.Background);
        result.CurrentStep.Should().Be(CharacterCreationStep.Background);
    }

    [Test]
    public void GoBack_FromBackground_ReturnsToLineage()
    {
        // Arrange
        _controller.Initialize();
        _controller.SelectLineageAsync(Lineage.RuneMarked).Wait();

        // Act
        var result = _controller.GoBack();

        // Assert
        result.Success.Should().BeTrue();
        result.CurrentStep.Should().Be(CharacterCreationStep.Lineage);
    }

    [Test]
    public void GoBack_FromLineage_Fails()
    {
        // Arrange
        _controller.Initialize();

        // Act
        var result = _controller.GoBack();

        // Assert
        result.Success.Should().BeFalse();
        result.ValidationErrors.Should().Contain("Already at first step.");
    }

    [Test]
    public async Task ConfirmCharacter_InvalidName_ReturnsError()
    {
        // Arrange
        _controller.Initialize();
        _nameValidatorMock
            .Setup(x => x.Validate(It.IsAny<string?>()))
            .Returns(NameValidationResult.Invalid("Name is required."));

        // Act
        var result = await _controller.ConfirmCharacterAsync("");

        // Assert
        result.Success.Should().BeFalse();
        result.ValidationErrors.Should().Contain("Name is required.");
    }
}
```

---

## 11. Use Cases

### 11.1 UC-01: Complete Character Creation

**Actor:** Player
**Precondition:** Game loaded
**Steps:**

1. Player initiates character creation
2. Controller calls `Initialize()`
3. Player selects lineage → `SelectLineageAsync()`
4. Player selects background → `SelectBackgroundAsync()`
5. Player allocates attributes → `ConfirmAttributesAsync()`
6. Player selects archetype → `SelectArchetypeAsync()`
7. Player selects specialization → `SelectSpecializationAsync()`
8. Player enters name → `ConfirmCharacterAsync()`
9. Character created and game begins

### 11.2 UC-02: Navigate Back to Change Selection

**Actor:** Player
**Precondition:** At Step 4 (Archetype)
**Steps:**

1. Player calls `GoBack()`
2. Controller returns to Step 3 with attributes preserved
3. Player can modify attributes or continue back

### 11.3 UC-03: Cancel Creation

**Actor:** Player
**Precondition:** Active creation session
**Steps:**

1. Player calls `Cancel()`
2. All state cleared
3. Player returned to main menu

---

## 12. Deliverable Checklist

### 12.1 Interfaces

- [ ] `ICharacterCreationController` - Application/Interfaces/

### 12.2 Value Objects

- [ ] `StepResult` - Domain/ValueObjects/
- [ ] `CharacterCreationResult` - Domain/ValueObjects/

### 12.3 Services

- [ ] `CharacterCreationController` - Application/Services/

### 12.4 Unit Tests

- [ ] `CharacterCreationControllerTests` (~6 tests)

### 12.5 Documentation

- [ ] XML documentation on all public members
- [ ] Structured logging throughout

---

## 13. Acceptance Criteria

### 13.1 Functional Requirements

- [ ] `Initialize()` creates fresh state at Lineage step
- [ ] Each step selection validates input before advancing
- [ ] Clan-Born requires flexible bonus selection
- [ ] Specialization must be valid for selected archetype
- [ ] `GoBack()` preserves previous selections
- [ ] `Cancel()` clears all state
- [ ] `ConfirmCharacterAsync()` validates name before creation

### 13.2 Non-Functional Requirements

- [ ] All methods include structured logging
- [ ] All public members have XML documentation
- [ ] All unit tests pass
- [ ] No breaking changes to existing functionality

---

## 14. Future Considerations

### 14.1 Deferred to v0.17.5e

- `ICharacterFactory` integration for actual character creation
- Character entity population from state

### 14.2 Deferred to v0.17.5f

- TUI screen integration
- Real-time ViewModel updates during input

### 14.3 Deferred to v0.17.5g

- Database persistence of created character
- Session recovery after interruption

---

## 15. Implementation Notes

### 15.1 Key Considerations

1. **Null Character Factory**: Controller accepts optional `ICharacterFactory` for incremental implementation
2. **State Preservation**: `GoBack()` never clears selections
3. **Archetype Lock**: Changing archetype clears specialization selection
4. **Thread Safety**: Single-session design; no concurrent access needed

### 15.2 Integration Points

- **v0.17.5b**: Uses `IViewModelBuilder` for all result ViewModels
- **v0.17.5c**: Uses `INameValidator` in `ConfirmCharacterAsync()`
- **v0.17.5e**: Will inject `ICharacterFactory` for character creation
- **v0.17.5f**: TUI screens will call controller methods

---

## 16. Document Metadata

| Field              | Value                        |
| ------------------ | ---------------------------- |
| Version            | 0.17.5d                      |
| Status             | Draft                        |
| Prerequisites      | v0.17.5a, v0.17.5b, v0.17.5c |
| Dependent Versions | v0.17.5e, v0.17.5f, v0.17.5g |
| Est. Complexity    | Medium                       |
| Est. Test Count    | ~6                           |
