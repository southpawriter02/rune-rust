> **Archived** - This changelog has been consolidated. See the complete version at [v0.3.6](../v0.3.x/v0.3.6.md).

# Changelog: v0.3.6a - The Battlefield (Grid & Rows)

**Release Date:** 2025-12-21
**Codename:** The Battlefield
**Status:** Complete

---

## Summary

Version 0.3.6a introduces a tactical row system for combat. Combatants are now positioned in Front or Back rows based on their archetype, transforming combat from a flat turn order list into a spatial tactical grid. Melee attackers can only target the opposing Front Row unless it's empty or they have the [Reach] weapon property.

---

## New Features

### 1. Row Position System

**Core Concept:** Combat now has spatial positioning with Front and Back rows for both player and enemy teams.

**Row Assignment by Archetype:**

| Player Archetype | Default Row | Rationale |
|------------------|-------------|-----------|
| Warrior | Front | Frontline combatant, melee-focused |
| Skirmisher | Front | Fast fighter, melee-focused |
| Adept | Back | Runic caster, needs protection |
| Mystic | Back | Primal caster, needs protection |

| Enemy Archetype | Default Row | Rationale |
|-----------------|-------------|-----------|
| Tank | Front | Protects allies, absorbs hits |
| DPS | Front | Balanced, reliable damage |
| GlassCannon | Front | High damage melee |
| Support | Back | Buffs/debuffs from safety |
| Swarm | Back | Group tactics, avoid direct hits |
| Caster | Back | Ranged attacks from distance |
| Boss | Back | Special encounters, protected |

### 2. Melee Targeting Validation

**Targeting Rules:**
- Front Row targets are **always valid** for melee attacks
- Back Row targets are **protected** unless:
  - Opposing Front Row is empty (all Front Row enemies dead)
  - Attacker has [Reach] weapon property
- Allies are always valid targets (for healing/buffs)

**Example Error Message:**
```
Blight-Priest is protected by the front line. Target a front row enemy first.
```

### 3. Tactical Combat Grid

The combat UI now displays a battlefield grid showing team formations:

```
╔═══════════════════════ BATTLEFIELD ═══════════════════════╗
║                                                            ║
║   ── ENEMY BACK ──                                         ║
║       Blight-Priest  Rust-Witch                            ║
║                                                            ║
║   ── ENEMY FRONT ──                                        ║
║      >Rusted Draugr!!  Haugbui Laborer                     ║
║                                                            ║
║   ────────────────────────────────────────────────────     ║
║                                                            ║
║   ── FRONT LINE ──                                         ║
║       Kael                                                 ║
║                                                            ║
║   ── BACK LINE ──                                          ║
║       (empty)                                              ║
╚════════════════════════════════════════════════════════════╝
```

**Grid Indicators:**
- `>` marker indicates the active combatant
- `!!` indicates wounded enemy (25-75% HP)
- `!!!` indicates critical enemy (<25% HP)
- `*` indicates targeted combatant

---

## New Files

| File | Layer | Purpose |
|------|-------|---------|
| `RuneAndRust.Core/Enums/RowPosition.cs` | Core | Front/Back row position enum |
| `RuneAndRust.Terminal/Rendering/CombatGridRenderer.cs` | Terminal | Tactical grid display renderer |
| `RuneAndRust.Tests/Engine/RowAssignmentTests.cs` | Tests | Row assignment and targeting tests |
| `RuneAndRust.Tests/Terminal/CombatGridRendererTests.cs` | Tests | Grid rendering tests |

---

## Modified Files

| File | Change |
|------|--------|
| `RuneAndRust.Core/Models/Combat/Combatant.cs` | Added `Row` and `IsTargeted` properties |
| `RuneAndRust.Core/ViewModels/CombatViewModel.cs` | Added row-grouped lists, `Row` to CombatantView |
| `RuneAndRust.Engine/Services/CombatService.cs` | Row assignment, targeting validation, ViewModel grouping |
| `RuneAndRust.Terminal/Services/CombatScreenRenderer.cs` | Integrated CombatGridRenderer |
| `RuneAndRust.Terminal/Program.cs` | Version updated to v0.3.6a |

---

## Implementation Details

### RowPosition Enum

```csharp
public enum RowPosition
{
    Front = 0,  // Melee combatants, can be targeted
    Back = 1    // Protected unless Front is empty
}
```

### Combatant Properties (v0.3.6a)

```csharp
#region Row System (v0.3.6a)

/// <summary>
/// The combatant's row position on the battlefield.
/// </summary>
public RowPosition Row { get; set; } = RowPosition.Front;

/// <summary>
/// Whether this combatant is currently being targeted.
/// </summary>
public bool IsTargeted { get; set; } = false;

#endregion
```

### Row Assignment Methods

```csharp
public static RowPosition GetDefaultPlayerRow(ArchetypeType archetype) => archetype switch
{
    ArchetypeType.Warrior => RowPosition.Front,
    ArchetypeType.Skirmisher => RowPosition.Front,
    ArchetypeType.Adept => RowPosition.Back,
    ArchetypeType.Mystic => RowPosition.Back,
    _ => RowPosition.Front
};

public static RowPosition GetDefaultEnemyRow(EnemyArchetype archetype) => archetype switch
{
    EnemyArchetype.Tank => RowPosition.Front,
    EnemyArchetype.DPS => RowPosition.Front,
    EnemyArchetype.GlassCannon => RowPosition.Front,
    EnemyArchetype.Support => RowPosition.Back,
    EnemyArchetype.Swarm => RowPosition.Back,
    EnemyArchetype.Caster => RowPosition.Back,
    EnemyArchetype.Boss => RowPosition.Back,
    _ => RowPosition.Front
};
```

### IsValidMeleeTarget Logic

```csharp
public bool IsValidMeleeTarget(Combatant attacker, Combatant target, bool hasReach = false)
{
    // Allies always valid (healing/buffs)
    if (attacker.IsPlayer == target.IsPlayer) return true;

    // Front Row always valid
    if (target.Row == RowPosition.Front) return true;

    // Back Row valid with Reach
    if (hasReach) return true;

    // Back Row valid if opposing Front Row is empty
    var opposingFrontEmpty = !state.TurnOrder.Any(c =>
        c.IsPlayer != attacker.IsPlayer &&
        c.Row == RowPosition.Front &&
        c.CurrentHp > 0);

    return opposingFrontEmpty;
}
```

---

## Test Coverage

**New Tests: 32**
- Row Assignment Tests: 21
- Combat Grid Renderer Tests: 11

**Test Categories:**

| Category | Tests |
|----------|-------|
| Player Row Assignment | 4 |
| Enemy Row Assignment | 7 |
| Melee Targeting Validation | 6 |
| Combat Integration | 4 |
| Grid Render Tests | 3 |
| Format Combatant Tests | 8 |

**Total Tests After v0.3.6a: 2078**

---

## Logging Matrix

| Context | Level | Template |
|---------|-------|----------|
| Player Row Assignment | Debug | `"Added player {Name} to combat with {AbilityCount} abilities, Row: {Row}"` |
| Enemy Row Assignment | Debug | `"Added enemy {Name} to combat, Row: {Row}"` |
| Targeting Blocked | Debug | `"{Target} is in Back Row and protected by Front Row"` |

---

## Breaking Changes

None. All changes are backwards compatible. Row defaults to `Front` if not explicitly set.

---

## Known Limitations

1. **No Row Swapping:** Combatants cannot currently change rows during combat (future v0.3.6c candidate)
2. **Reach Weapons:** The `hasReach` parameter is a placeholder; weapon properties not yet implemented
3. **Single Player:** Row system assumes single player character; party support may require expansion

---

## Architecture Notes

- `Row` is a combat-volatile property: not persisted to database, assigned fresh at combat start
- `CombatGridRenderer` is a stateless static class (no DI registration required)
- Turn Order table retained alongside grid for initiative reference
- ViewModel grouping performs row filtering in GetViewModel for UI simplicity

---

## Version History

| Version | Codename | Focus |
|---------|----------|-------|
| v0.3.5a | The Cartographer's Easel | ExplorationScreenRenderer foundation |
| v0.3.5b | The Cartographer | MinimapRenderer with Fog of War |
| v0.3.5c | The Surveyor | RoomRenderer with entity display |
| v0.3.5d | The Stabilizer | Bug fixes and polish |
| v0.3.6a | The Battlefield | Grid & Row system |

---

## Next Steps (v0.3.6b/c Candidates)

1. **Combat Action Bar** - Display available commands at the bottom of combat screen
2. **Enhanced Enemy AI** - AI considers row positions when selecting targets
3. **Row Swap Ability** - Allow tactical repositioning during combat
4. **Reach Weapons** - Implement weapon property for ignoring row protection
