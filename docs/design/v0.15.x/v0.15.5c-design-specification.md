# v0.15.5c Design Specification: Foraging System

**Version:** 0.15.5c
**Theme:** Foraging System
**Author:** Claude
**Created:** 2026-01-18
**Status:** Draft
**Prerequisites:** v0.15.5a Complete (Extended Tracking System), v0.15.5b Complete (Counter-Tracking System)

---

## Table of Contents

1. [Executive Summary](#1-executive-summary)
2. [Feature Overview](#2-feature-overview)
3. [Architecture Diagrams](#3-architecture-diagrams)
   - 3.1 [Foraging Flow Diagram](#31-foraging-flow-diagram)
   - 3.2 [Yield Calculation Flow](#32-yield-calculation-flow)
   - 3.3 [Service Interaction Diagram](#33-service-interaction-diagram)
   - 3.4 [Layer Architecture](#34-layer-architecture)
4. [SearchDuration Enum](#4-searchduration-enum)
5. [ForageTarget Enum](#5-foragetarget-enum)
6. [ForagingContext Value Object](#6-foragingcontext-value-object)
7. [ForagingResult Value Object](#7-foragingresult-value-object)
8. [ForagingService Implementation](#8-foragingservice-implementation)
9. [Yield Tables and Economy Balance](#9-yield-tables-and-economy-balance)
10. [Hidden Cache Discovery](#10-hidden-cache-discovery)
11. [Data Model Changes](#11-data-model-changes)
12. [Configuration Files](#12-configuration-files)
    - 12.1 [foraging-yields.json](#121-foraging-yieldsjson)
    - 12.2 [foraging-yields.schema.json](#122-foraging-yieldsschemajson)
    - 12.3 [Configuration Schema Summary](#123-configuration-schema-summary)
13. [Logging Specifications](#13-logging-specifications)
14. [Unit Testing Requirements](#14-unit-testing-requirements)
15. [Use Cases](#15-use-cases)
16. [Deliverable Checklist](#16-deliverable-checklist)
17. [Acceptance Criteria](#17-acceptance-criteria)
18. [Dependencies](#18-dependencies)
19. [Future Considerations](#19-future-considerations)
20. [Document Metadata](#20-document-metadata)

---

## 1. Executive Summary

### 1.1 Purpose

This document provides a comprehensive design specification for v0.15.5c, the Foraging System. This phase implements the resource gathering mechanics for the Wasteland Survival skill, enabling characters to scavenge the wasteland for salvage, supplies, and valuable components.

Foraging in Aethelgard represents the essential survival activity of scavenging resources from the post-collapse environment. The system balances time investment against potential rewards, with longer searches providing better odds but diminishing returns per hour. The hidden cache discovery mechanic adds an element of excitement when dice rolls show 10s.

The system supports biome-specific loot tables, equipment bonuses, and tracks previously searched areas to prevent infinite resource exploitation.

### 1.2 Key Deliverables

| Category | Items |
|----------|-------|
| **Enums** | `SearchDuration`, `ForageTarget` |
| **Value Objects** | `ForagingContext`, `ForagingResult` |
| **Services** | `IForagingService`, `ForagingService` |
| **Configuration** | `foraging-yields.json` |
| **Tests** | ~3 new unit tests |

### 1.3 Architectural Significance

This version establishes the **time-investment resource gathering pattern** that will be reused for other collection mechanics:

- **Duration-based bonuses**: Longer searches grant more dice
- **Success-scaled yields**: More successes yield better rewards
- **Special trigger mechanics**: Specific dice values trigger bonus effects (cache discovery on 10s)
- **Area exhaustion tracking**: Previously searched areas provide diminishing returns

---

## 2. Feature Overview

```
v0.15.5c Foraging System
├── Search Duration
│   ├── Quick (10 min, +0 dice)
│   ├── Thorough (1 hour, +2d10)
│   └── Complete (4 hours, +4d10)
├── Forage Targets
│   ├── CommonSalvage (DC 10, 2d10 scrap)
│   ├── UsefulSupplies (DC 14, 1d6 rations)
│   ├── ValuableComponents (DC 18, 1d4 components)
│   └── HiddenCache (DC 22, 1d100 Marks + items)
├── Foraging Context
│   ├── BiomeId (affects available loot)
│   ├── SearchDuration (time invested)
│   ├── EquipmentBonus (survival kit, etc.)
│   └── PreviousSearches (area exhaustion)
├── Foraging Result
│   ├── SuccessLevel (net successes)
│   ├── ScrapYield (amount of scrap)
│   ├── RationsYield (amount of rations)
│   ├── ComponentsYield (rare components)
│   ├── CacheFound (hidden cache discovered)
│   └── BiomeSpecificItems (special finds)
├── Yield Tables
│   ├── 2-3 successes: 2d10 scrap
│   ├── 4-5 successes: 3d10 scrap + 1d6 rations
│   ├── 6-7 successes: 4d10 scrap + 1d6 rations + 1 component
│   └── 8+ successes: 5d10 scrap + 2d6 rations + 1d4 components
└── Hidden Cache Discovery
    ├── Triggered by any rolled 10
    └── Contains: 1d100 Marks + random item
```

---

## 3. Architecture Diagrams

### 3.1 Foraging Flow Diagram

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                         FORAGING ATTEMPT FLOW                                │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  Player: "forage thorough"                                                  │
│           │                                                                  │
│           ▼                                                                  │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │                    1. SELECT SEARCH DURATION                        │    │
│  ├─────────────────────────────────────────────────────────────────────┤    │
│  │                                                                      │    │
│  │  SearchDuration Options:                                            │    │
│  │  ├── Quick    (10 min) - Base dice pool, no bonus                  │    │
│  │  ├── Thorough (1 hour) - +2d10 bonus dice                          │    │
│  │  └── Complete (4 hours) - +4d10 bonus dice                         │    │
│  │                                                                      │    │
│  │  Example: Thorough selected → +2d10 bonus                          │    │
│  │                                                                      │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
│           │                                                                  │
│           ▼                                                                  │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │                    2. BUILD FORAGING CONTEXT                        │    │
│  ├─────────────────────────────────────────────────────────────────────┤    │
│  │                                                                      │    │
│  │  ForagingContext:                                                   │    │
│  │  ├── BiomeId: "industrial-ruins"                                   │    │
│  │  ├── SearchDuration: Thorough                                      │    │
│  │  ├── EquipmentBonus: +1 (survival kit)                             │    │
│  │  └── PreviousSearches: 0 (fresh area)                              │    │
│  │                                                                      │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
│           │                                                                  │
│           ▼                                                                  │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │                    3. CALCULATE DICE POOL                           │    │
│  ├─────────────────────────────────────────────────────────────────────┤    │
│  │                                                                      │    │
│  │  Dice Pool Calculation:                                             │    │
│  │  ├── Base: WITS (3) + Skill Rank (2) = 5d10                        │    │
│  │  ├── Duration Bonus: +2d10 (Thorough)                              │    │
│  │  ├── Equipment Bonus: +1d10 (survival kit)                         │    │
│  │  ├── Previous Searches: -0d10 (fresh area)                         │    │
│  │  └── Total Pool: 8d10                                              │    │
│  │                                                                      │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
│           │                                                                  │
│           ▼                                                                  │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │                    4. PERFORM SKILL CHECK                           │    │
│  ├─────────────────────────────────────────────────────────────────────┤    │
│  │                                                                      │    │
│  │  Wasteland Survival Check:                                          │    │
│  │  ├── Roll 8d10: [8, 3, 10, 1, 6, 9, 4, 10]                         │    │
│  │  ├── Successes (8-10): 4                                           │    │
│  │  ├── Botches (1): 1                                                │    │
│  │  ├── Net Successes: 3                                              │    │
│  │  └── Rolled 10s: 2 (triggers cache check!)                         │    │
│  │                                                                      │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
│           │                                                                  │
│           ▼                                                                  │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │                    5. CALCULATE YIELDS                              │    │
│  ├─────────────────────────────────────────────────────────────────────┤    │
│  │                                                                      │    │
│  │  Yield Table Lookup (3 successes = Row 1):                          │    │
│  │  ├── Scrap: 2d10 → roll [7, 4] = 11 scrap                          │    │
│  │  ├── Rations: — (not available at this tier)                       │    │
│  │  └── Components: — (not available at this tier)                    │    │
│  │                                                                      │    │
│  │  Cache Discovery (rolled 10s present):                              │    │
│  │  ├── Cache Found: YES                                              │    │
│  │  ├── Marks: 1d100 → roll [67] = 67 Marks                           │    │
│  │  └── Bonus Item: "Corroded Medkit" (from biome table)              │    │
│  │                                                                      │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
│           │                                                                  │
│           ▼                                                                  │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │                    6. RETURN FORAGING RESULT                        │    │
│  ├─────────────────────────────────────────────────────────────────────┤    │
│  │                                                                      │    │
│  │  ForagingResult:                                                    │    │
│  │  ├── SuccessLevel: 3                                               │    │
│  │  ├── ScrapYield: 11                                                │    │
│  │  ├── RationsYield: 0                                               │    │
│  │  ├── ComponentsYield: 0                                            │    │
│  │  ├── CacheFound: true                                              │    │
│  │  ├── CacheMarks: 67                                                │    │
│  │  ├── CacheItem: "Corroded Medkit"                                  │    │
│  │  └── TimeSpent: 1 hour                                             │    │
│  │                                                                      │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 3.2 Yield Calculation Flow

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                         YIELD CALCULATION FLOW                               │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│                           Net Successes                                      │
│                                │                                             │
│           ┌────────────────────┼────────────────────┐                        │
│           │                    │                    │                        │
│           ▼                    ▼                    ▼                        │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐              │
│  │   0-1 Success   │  │   2-3 Success   │  │   4-5 Success   │              │
│  ├─────────────────┤  ├─────────────────┤  ├─────────────────┤              │
│  │ Nothing found   │  │ 2d10 scrap      │  │ 3d10 scrap      │              │
│  │                 │  │                 │  │ 1d6 rations     │              │
│  └─────────────────┘  └─────────────────┘  └─────────────────┘              │
│                                                                              │
│           ┌────────────────────┼────────────────────┐                        │
│           │                    │                    │                        │
│           ▼                    ▼                    ▼                        │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐              │
│  │   6-7 Success   │  │   8+ Success    │  │ Critical (≥5)   │              │
│  ├─────────────────┤  ├─────────────────┤  ├─────────────────┤              │
│  │ 4d10 scrap      │  │ 5d10 scrap      │  │ Maximum yields  │              │
│  │ 1d6 rations     │  │ 2d6 rations     │  │ + Bonus item    │              │
│  │ 1 component     │  │ 1d4 components  │  │ from biome      │              │
│  └─────────────────┘  └─────────────────┘  └─────────────────┘              │
│                                                                              │
│  ─────────────────────────────────────────────────────────────────────────  │
│                                                                              │
│                        CACHE DISCOVERY CHECK                                 │
│                                                                              │
│                    Any 10s in dice roll?                                     │
│                           │                                                  │
│              ┌────────────┴────────────┐                                     │
│              │                         │                                     │
│              ▼                         ▼                                     │
│     ┌─────────────────┐       ┌─────────────────┐                           │
│     │      YES        │       │       NO        │                           │
│     ├─────────────────┤       ├─────────────────┤                           │
│     │ Cache Found!    │       │ No cache        │                           │
│     │ + 1d100 Marks   │       │                 │                           │
│     │ + Random item   │       │                 │                           │
│     └─────────────────┘       └─────────────────┘                           │
│                                                                              │
│  ─────────────────────────────────────────────────────────────────────────  │
│                                                                              │
│                        ECONOMY BALANCE                                       │
│                                                                              │
│  ┌───────────────┬─────────────┬─────────────┬─────────────┐                │
│  │ Search Type   │ Avg Yield   │ Time Cost   │ Value/Hour  │                │
│  ├───────────────┼─────────────┼─────────────┼─────────────┤                │
│  │ Quick         │ ~8 scrap    │ 0.16 hr     │ ~48/hr      │                │
│  │ Thorough      │ ~15 scrap+  │ 1.0 hr      │ ~20/hr      │                │
│  │ Complete      │ ~25 scrap+  │ 4.0 hr      │ ~15/hr      │                │
│  └───────────────┴─────────────┴─────────────┴─────────────┘                │
│                                                                              │
│  Note: Quick searches are more efficient per hour but less likely           │
│  to find rations, components, or trigger cache discovery.                   │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 3.3 Service Interaction Diagram

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                      SERVICE INTERACTION DIAGRAM                             │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │                      COMMAND HANDLER                                 │   │
│   │                  (ForageCommandHandler)                             │   │
│   └─────────────────────────────────┬───────────────────────────────────┘   │
│                                     │                                        │
│                        validates & builds context                           │
│                                     │                                        │
│                                     ▼                                        │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │                      FORAGING SERVICE                                │   │
│   │                      (IForagingService)                             │   │
│   ├─────────────────────────────────────────────────────────────────────┤   │
│   │  + AttemptForaging(characterId, context)                            │   │
│   │  + CalculateYields(successes, biomeId)                              │   │
│   │  + CheckForCache(diceRolls)                                         │   │
│   │  + GetBiomeLootTable(biomeId)                                       │   │
│   │  + GetDurationBonus(duration)                                       │   │
│   └──────────┬──────────────────────────┬───────────────────────────────┘   │
│              │                          │                                    │
│    performs check               reads config                                │
│              │                          │                                    │
│              ▼                          ▼                                    │
│   ┌─────────────────────────┐  ┌─────────────────────────┐                  │
│   │   SKILL CHECK SERVICE   │  │   CONFIGURATION SVC     │                  │
│   │   (ISkillCheckService)  │  │ (IConfigurationService) │                  │
│   ├─────────────────────────┤  ├─────────────────────────┤                  │
│   │ + PerformCheck()        │  │ + GetYieldTable()       │                  │
│   │ + CalculateDicePool()   │  │ + GetBiomeLoot()        │                  │
│   │ + GetRolledValues()     │  │ + GetCacheItems()       │                  │
│   └──────────┬──────────────┘  └─────────────────────────┘                  │
│              │                                                               │
│       rolls dice                                                            │
│              │                                                               │
│              ▼                                                               │
│   ┌─────────────────────────┐                                               │
│   │     DICE SERVICE        │                                               │
│   │     (IDiceService)      │                                               │
│   ├─────────────────────────┤                                               │
│   │ + RollPool(count)       │                                               │
│   │ + CountSuccesses()      │                                               │
│   │ + GetRolledValues()     │  ◄── NEW: Returns actual dice values         │
│   └─────────────────────────┘                                               │
│                                                                              │
│   Data Flow:                                                                │
│   ─────────────────────────────────────────────────────────────────────    │
│   1. CommandHandler validates player location & creates ForagingContext    │
│   2. ForagingService.AttemptForaging() orchestrates the search             │
│   3. Duration bonus added to dice pool                                      │
│   4. SkillCheckService performs Wasteland Survival check                   │
│   5. DiceService returns both successes AND actual rolled values           │
│   6. ForagingService checks for 10s in rolled values (cache trigger)       │
│   7. Yield table lookup based on net successes                              │
│   8. If cache triggered, roll 1d100 Marks + random biome item              │
│   9. ForagingResult returned with all yields and cache info                │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 3.4 Layer Architecture

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           LAYER ARCHITECTURE                                 │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │                      DOMAIN LAYER                                    │    │
│  ├─────────────────────────────────────────────────────────────────────┤    │
│  │                                                                      │    │
│  │  Enums/                                                              │    │
│  │  ├── SearchDuration.cs                                              │    │
│  │  │   ├── Quick (10 minutes)                                         │    │
│  │  │   ├── Thorough (1 hour)                                          │    │
│  │  │   └── Complete (4 hours)                                         │    │
│  │  │                                                                   │    │
│  │  └── ForageTarget.cs                                                │    │
│  │      ├── CommonSalvage (DC 10)                                      │    │
│  │      ├── UsefulSupplies (DC 14)                                     │    │
│  │      ├── ValuableComponents (DC 18)                                 │    │
│  │      └── HiddenCache (DC 22)                                        │    │
│  │                                                                      │    │
│  │  ValueObjects/                                                       │    │
│  │  ├── ForagingContext.cs                                             │    │
│  │  │   ├── BiomeId: string                                            │    │
│  │  │   ├── SearchDuration: SearchDuration                             │    │
│  │  │   ├── EquipmentBonus: int                                        │    │
│  │  │   ├── PreviousSearches: int                                      │    │
│  │  │   └── ToSkillContext(): SkillContext                             │    │
│  │  │                                                                   │    │
│  │  └── ForagingResult.cs                                              │    │
│  │      ├── SuccessLevel: int                                          │    │
│  │      ├── ScrapYield: int                                            │    │
│  │      ├── RationsYield: int                                          │    │
│  │      ├── ComponentsYield: int                                       │    │
│  │      ├── CacheFound: bool                                           │    │
│  │      ├── CacheMarks: int                                            │    │
│  │      ├── CacheItem: string?                                         │    │
│  │      ├── BiomeSpecificItems: IReadOnlyList<string>                  │    │
│  │      └── TimeSpent: TimeSpan                                        │    │
│  │                                                                      │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
│                                     │                                        │
│                                     ▼                                        │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │                   APPLICATION LAYER                                  │    │
│  ├─────────────────────────────────────────────────────────────────────┤    │
│  │                                                                      │    │
│  │  Services/                                                           │    │
│  │  ├── IForagingService.cs                                            │    │
│  │  │   ├── AttemptForaging(characterId, context)                      │    │
│  │  │   ├── CalculateYields(successes, biomeId)                        │    │
│  │  │   ├── CheckForCache(diceRolls)                                   │    │
│  │  │   ├── GetBiomeLootTable(biomeId)                                 │    │
│  │  │   └── GetDurationBonus(duration)                                 │    │
│  │  │                                                                   │    │
│  │  └── ForagingService.cs                                             │    │
│  │      └── Implementation of IForagingService                         │    │
│  │                                                                      │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
│                                     │                                        │
│                                     ▼                                        │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │                  INFRASTRUCTURE LAYER                                │    │
│  ├─────────────────────────────────────────────────────────────────────┤    │
│  │                                                                      │    │
│  │  Configuration/                                                      │    │
│  │  ├── foraging-yields.json                                           │    │
│  │  └── schemas/foraging-yields.schema.json                            │    │
│  │                                                                      │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 4. SearchDuration Enum

**Purpose:** Defines how long a character spends searching an area, which affects the bonus dice added to their pool.

**File:** `src/Core/RuneAndRust.Domain/Enums/SearchDuration.cs`

```csharp
namespace RuneAndRust.Domain.Enums;

/// <summary>
/// Defines the duration of a foraging search, affecting bonus dice and time investment.
/// Longer searches provide more bonus dice but have diminishing returns per hour.
/// </summary>
/// <remarks>
/// Economy balance:
/// - Quick: ~48 value/hour (efficient but low chance for rare finds)
/// - Thorough: ~20 value/hour (balanced, good cache chance)
/// - Complete: ~15 value/hour (best for rare components, highest cache chance)
/// </remarks>
public enum SearchDuration
{
    /// <summary>
    /// A quick 10-minute search of the immediate area.
    /// No bonus dice, but time-efficient for common salvage.
    /// </summary>
    /// <remarks>
    /// Duration: 10 minutes
    /// Bonus Dice: +0
    /// Best for: Quick scrap gathering when time is critical
    /// </remarks>
    Quick = 0,

    /// <summary>
    /// A thorough 1-hour search of the surrounding area.
    /// Adds +2d10 to the dice pool.
    /// </summary>
    /// <remarks>
    /// Duration: 1 hour
    /// Bonus Dice: +2d10
    /// Best for: Balanced searching with decent cache chance
    /// </remarks>
    Thorough = 1,

    /// <summary>
    /// A complete 4-hour search of the entire accessible area.
    /// Adds +4d10 to the dice pool.
    /// </summary>
    /// <remarks>
    /// Duration: 4 hours
    /// Bonus Dice: +4d10
    /// Best for: Maximum yields when time is not a constraint
    /// </remarks>
    Complete = 2
}
```

### 4.1 Duration Summary Table

| Duration | Time | Bonus Dice | Avg Value/Hour | Cache Chance |
|----------|------|------------|----------------|--------------|
| `Quick` | 10 min | +0 | ~48/hr | Low |
| `Thorough` | 1 hr | +2d10 | ~20/hr | Medium |
| `Complete` | 4 hr | +4d10 | ~15/hr | High |

---

## 5. ForageTarget Enum

**Purpose:** Classifies what type of resources the character is searching for, determining the base DC and potential yields.

**File:** `src/Core/RuneAndRust.Domain/Enums/ForageTarget.cs`

```csharp
namespace RuneAndRust.Domain.Enums;

/// <summary>
/// Defines the target type for a foraging attempt, determining base DC and yield type.
/// Higher DCs yield more valuable resources but are harder to find.
/// </summary>
public enum ForageTarget
{
    /// <summary>
    /// Search for common salvage materials (scrap metal, wiring, debris).
    /// DC 10, yields 2d10 scrap on success.
    /// </summary>
    CommonSalvage = 0,

    /// <summary>
    /// Search for useful supplies (rations, water, basic medical).
    /// DC 14, yields 1d6 rations on success.
    /// </summary>
    UsefulSupplies = 1,

    /// <summary>
    /// Search for valuable components (tech parts, rare materials).
    /// DC 18, yields 1d4 components on success.
    /// </summary>
    ValuableComponents = 2,

    /// <summary>
    /// Search specifically for hidden caches left by other survivors.
    /// DC 22, yields 1d100 Marks + random items on success.
    /// </summary>
    /// <remarks>
    /// Note: Caches can also be discovered incidentally when any 10 is rolled
    /// during a foraging check, regardless of the ForageTarget.
    /// </remarks>
    HiddenCache = 3
}
```

### 5.1 Target Summary Table

| Target | Base DC | Primary Yield | Notes |
|--------|---------|---------------|-------|
| `CommonSalvage` | 10 | 2d10 scrap | Easy, always available |
| `UsefulSupplies` | 14 | 1d6 rations | Moderate difficulty |
| `ValuableComponents` | 18 | 1d4 components | Requires skill |
| `HiddenCache` | 22 | 1d100 Marks + item | Difficult, high reward |

---

## 6. ForagingContext Value Object

**Purpose:** Encapsulates all the information needed to perform a foraging attempt.

**File:** `src/Core/RuneAndRust.Domain/ValueObjects/ForagingContext.cs`

```csharp
namespace RuneAndRust.Domain.ValueObjects;

using RuneAndRust.Domain.Enums;

/// <summary>
/// Represents the context for a foraging attempt, including biome,
/// search duration, equipment bonuses, and area exhaustion state.
/// </summary>
/// <param name="CharacterId">The unique identifier of the foraging character.</param>
/// <param name="BiomeId">The biome/environment being searched.</param>
/// <param name="SearchDuration">How long the character will search.</param>
/// <param name="ForageTarget">What type of resources to prioritize.</param>
/// <param name="EquipmentBonus">Bonus dice from equipment (survival kit, etc.).</param>
/// <param name="PreviousSearches">Number of times this area has been searched recently.</param>
public readonly record struct ForagingContext(
    string CharacterId,
    string BiomeId,
    SearchDuration SearchDuration,
    ForageTarget ForageTarget,
    int EquipmentBonus = 0,
    int PreviousSearches = 0)
{
    /// <summary>
    /// Gets the time required for this search in minutes.
    /// </summary>
    public int TimeMinutes => SearchDuration switch
    {
        SearchDuration.Quick => 10,
        SearchDuration.Thorough => 60,
        SearchDuration.Complete => 240,
        _ => 10
    };

    /// <summary>
    /// Gets the time required for this search as a TimeSpan.
    /// </summary>
    public TimeSpan TimeSpan => TimeSpan.FromMinutes(TimeMinutes);

    /// <summary>
    /// Gets the bonus dice from the search duration.
    /// </summary>
    public int DurationBonusDice => SearchDuration switch
    {
        SearchDuration.Quick => 0,
        SearchDuration.Thorough => 2,
        SearchDuration.Complete => 4,
        _ => 0
    };

    /// <summary>
    /// Gets the penalty for searching a previously-searched area.
    /// Each previous search reduces the dice pool by 1, to a minimum of 0.
    /// </summary>
    public int ExhaustionPenalty => Math.Min(PreviousSearches, 3);

    /// <summary>
    /// Gets the base DC for the selected forage target.
    /// </summary>
    public int BaseDc => ForageTarget switch
    {
        ForageTarget.CommonSalvage => 10,
        ForageTarget.UsefulSupplies => 14,
        ForageTarget.ValuableComponents => 18,
        ForageTarget.HiddenCache => 22,
        _ => 10
    };

    /// <summary>
    /// Calculates the total bonus/penalty to the dice pool.
    /// </summary>
    public int TotalDiceModifier => DurationBonusDice + EquipmentBonus - ExhaustionPenalty;

    /// <summary>
    /// Converts this context to a SkillContext for the skill check system.
    /// </summary>
    /// <returns>A SkillContext configured for Wasteland Survival.</returns>
    public SkillContext ToSkillContext()
    {
        return new SkillContext(
            SkillId: "wasteland-survival",
            CharacterId: CharacterId,
            EnvironmentId: BiomeId,
            DcModifier: 0, // DC is determined by ForageTarget
            DicePoolModifier: TotalDiceModifier,
            ContextDescription: $"Foraging ({SearchDuration}) for {ForageTarget} in {BiomeId}"
        );
    }

    /// <summary>
    /// Creates a display string for the foraging context.
    /// </summary>
    public string ToDisplayString()
    {
        return $"{SearchDuration} search for {ForageTarget} | " +
               $"Biome: {BiomeId} | " +
               $"Bonus: {(TotalDiceModifier >= 0 ? "+" : "")}{TotalDiceModifier}d10 | " +
               $"Time: {TimeMinutes} min";
    }
}
```

---

## 7. ForagingResult Value Object

**Purpose:** Represents the outcome of a foraging attempt, including all yields and any cache discoveries.

**File:** `src/Core/RuneAndRust.Domain/ValueObjects/ForagingResult.cs`

```csharp
namespace RuneAndRust.Domain.ValueObjects;

using RuneAndRust.Domain.Enums;

/// <summary>
/// Represents the result of a foraging attempt, containing all yields,
/// cache discoveries, and metadata about the search.
/// </summary>
/// <param name="SuccessLevel">The net successes from the skill check.</param>
/// <param name="ScrapYield">Amount of scrap collected.</param>
/// <param name="RationsYield">Amount of rations found.</param>
/// <param name="ComponentsYield">Number of valuable components found.</param>
/// <param name="CacheFound">Whether a hidden cache was discovered.</param>
/// <param name="CacheMarks">Marks found in the cache (0 if no cache).</param>
/// <param name="CacheItem">Item found in the cache (null if no cache).</param>
/// <param name="BiomeSpecificItems">Special items unique to this biome.</param>
/// <param name="TimeSpent">Actual time spent foraging.</param>
/// <param name="RollDetails">Details about the dice roll for logging.</param>
public readonly record struct ForagingResult(
    int SuccessLevel,
    int ScrapYield,
    int RationsYield,
    int ComponentsYield,
    bool CacheFound,
    int CacheMarks,
    string? CacheItem,
    IReadOnlyList<string> BiomeSpecificItems,
    TimeSpan TimeSpent,
    string RollDetails)
{
    /// <summary>
    /// Gets whether any resources were found.
    /// </summary>
    public bool FoundAnything => ScrapYield > 0 || RationsYield > 0 ||
                                  ComponentsYield > 0 || CacheFound;

    /// <summary>
    /// Gets the success tier description.
    /// </summary>
    public string SuccessTier => SuccessLevel switch
    {
        <= 1 => "Nothing Found",
        <= 3 => "Meager Haul",
        <= 5 => "Decent Finds",
        <= 7 => "Good Haul",
        _ => "Excellent Haul"
    };

    /// <summary>
    /// Calculates an estimated total value of the foraging result.
    /// </summary>
    /// <remarks>
    /// Value estimates: Scrap = 1 each, Rations = 5 each, Components = 20 each
    /// </remarks>
    public int EstimatedValue => ScrapYield + (RationsYield * 5) +
                                  (ComponentsYield * 20) + CacheMarks;

    /// <summary>
    /// Creates a display string summarizing the foraging result.
    /// </summary>
    public string ToDisplayString()
    {
        var parts = new List<string>();

        if (ScrapYield > 0)
            parts.Add($"{ScrapYield} scrap");
        if (RationsYield > 0)
            parts.Add($"{RationsYield} rations");
        if (ComponentsYield > 0)
            parts.Add($"{ComponentsYield} component(s)");
        if (CacheFound)
            parts.Add($"CACHE: {CacheMarks} Marks" + (CacheItem != null ? $" + {CacheItem}" : ""));
        if (BiomeSpecificItems.Count > 0)
            parts.Add($"Special: {string.Join(", ", BiomeSpecificItems)}");

        if (parts.Count == 0)
            return $"Nothing found ({TimeSpent.TotalMinutes:F0} min)";

        return $"{SuccessTier}: {string.Join(", ", parts)} ({TimeSpent.TotalMinutes:F0} min)";
    }

    /// <summary>
    /// Creates a result for a failed foraging attempt.
    /// </summary>
    public static ForagingResult Empty(TimeSpan timeSpent, string rollDetails)
    {
        return new ForagingResult(
            SuccessLevel: 0,
            ScrapYield: 0,
            RationsYield: 0,
            ComponentsYield: 0,
            CacheFound: false,
            CacheMarks: 0,
            CacheItem: null,
            BiomeSpecificItems: Array.Empty<string>(),
            TimeSpent: timeSpent,
            RollDetails: rollDetails
        );
    }
}
```

---

## 8. ForagingService Implementation

**Purpose:** Provides the core logic for performing foraging attempts and calculating yields.

### 8.1 Interface Definition

**File:** `src/Core/RuneAndRust.Application/Services/IForagingService.cs`

```csharp
namespace RuneAndRust.Application.Services;

using RuneAndRust.Domain.Enums;
using RuneAndRust.Domain.ValueObjects;

/// <summary>
/// Service for handling foraging operations in the wasteland.
/// Manages resource gathering, yield calculations, and cache discovery.
/// </summary>
public interface IForagingService
{
    /// <summary>
    /// Attempts to forage for resources in the current area.
    /// </summary>
    /// <param name="characterId">The ID of the foraging character.</param>
    /// <param name="context">The foraging context.</param>
    /// <returns>The result of the foraging attempt.</returns>
    ForagingResult AttemptForaging(string characterId, ForagingContext context);

    /// <summary>
    /// Calculates yields based on the number of successes.
    /// </summary>
    /// <param name="successes">Net successes from the skill check.</param>
    /// <param name="biomeId">The biome being searched.</param>
    /// <returns>Tuple of (scrap, rations, components).</returns>
    (int Scrap, int Rations, int Components) CalculateYields(int successes, string biomeId);

    /// <summary>
    /// Checks if any dice rolled a 10, triggering cache discovery.
    /// </summary>
    /// <param name="diceRolls">The actual values rolled on each die.</param>
    /// <returns>True if any die shows a 10.</returns>
    bool CheckForCache(IEnumerable<int> diceRolls);

    /// <summary>
    /// Generates cache contents when a cache is discovered.
    /// </summary>
    /// <param name="biomeId">The biome where the cache was found.</param>
    /// <returns>Tuple of (marks, item name or null).</returns>
    (int Marks, string? Item) GenerateCacheContents(string biomeId);

    /// <summary>
    /// Gets the bonus dice for a given search duration.
    /// </summary>
    /// <param name="duration">The search duration.</param>
    /// <returns>Number of bonus dice.</returns>
    int GetDurationBonus(SearchDuration duration);

    /// <summary>
    /// Gets the available biome-specific items for a biome.
    /// </summary>
    /// <param name="biomeId">The biome identifier.</param>
    /// <returns>List of possible special items.</returns>
    IReadOnlyList<string> GetBiomeLootTable(string biomeId);
}
```

### 8.2 Service Implementation

**File:** `src/Core/RuneAndRust.Application/Services/ForagingService.cs`

```csharp
namespace RuneAndRust.Application.Services;

using Microsoft.Extensions.Logging;
using RuneAndRust.Domain.Enums;
using RuneAndRust.Domain.ValueObjects;

/// <summary>
/// Implementation of the foraging service that handles resource gathering.
/// </summary>
public class ForagingService : IForagingService
{
    private readonly ISkillCheckService _skillCheckService;
    private readonly IDiceService _diceService;
    private readonly ILogger<ForagingService> _logger;

    /// <summary>
    /// Yield table: successes → (scrap dice, ration dice, component count)
    /// </summary>
    private static readonly Dictionary<int, (int ScrapDice, int RationDice, int Components)> YieldTable = new()
    {
        { 0, (0, 0, 0) },
        { 1, (0, 0, 0) },
        { 2, (2, 0, 0) },  // 2d10 scrap
        { 3, (2, 0, 0) },  // 2d10 scrap
        { 4, (3, 1, 0) },  // 3d10 scrap, 1d6 rations
        { 5, (3, 1, 0) },  // 3d10 scrap, 1d6 rations
        { 6, (4, 1, 1) },  // 4d10 scrap, 1d6 rations, 1 component
        { 7, (4, 1, 1) },  // 4d10 scrap, 1d6 rations, 1 component
        { 8, (5, 2, -1) }, // 5d10 scrap, 2d6 rations, 1d4 components (-1 means roll d4)
    };

    /// <summary>
    /// Biome-specific loot tables.
    /// </summary>
    private static readonly Dictionary<string, List<string>> BiomeLootTables = new()
    {
        { "industrial-ruins", new() { "Corroded Medkit", "Rusty Toolkit", "Fuel Canister", "Wire Spool" } },
        { "residential-ruins", new() { "Canned Food", "Tattered Map", "Old Currency", "Faded Photograph" } },
        { "wasteland", new() { "Mutant Bone", "Glowing Crystal", "Petrified Wood", "Strange Ore" } },
        { "swamp", new() { "Medicinal Moss", "Poison Gland", "Bog Iron", "Reed Bundle" } },
        { "default", new() { "Mysterious Object", "Salvageable Scrap", "Strange Device" } }
    };

    public ForagingService(
        ISkillCheckService skillCheckService,
        IDiceService diceService,
        ILogger<ForagingService> logger)
    {
        _skillCheckService = skillCheckService ?? throw new ArgumentNullException(nameof(skillCheckService));
        _diceService = diceService ?? throw new ArgumentNullException(nameof(diceService));
        _logger = logger ?? throw new ArgumentNullException(nameof(logger));
    }

    /// <inheritdoc />
    public ForagingResult AttemptForaging(string characterId, ForagingContext context)
    {
        _logger.LogInformation(
            "Character {CharacterId} attempting {Duration} forage for {Target} in {Biome}",
            characterId,
            context.SearchDuration,
            context.ForageTarget,
            context.BiomeId);

        // Build skill context and perform check
        var skillContext = context.ToSkillContext();
        var checkResult = _skillCheckService.PerformCheckWithDc(skillContext, context.BaseDc);

        _logger.LogDebug(
            "Foraging check result: {NetSuccesses} net successes, rolls: {Rolls}",
            checkResult.NetSuccesses,
            string.Join(", ", checkResult.RolledValues));

        // Check for cache discovery (any 10 in the roll)
        var cacheFound = CheckForCache(checkResult.RolledValues);
        var (cacheMarks, cacheItem) = cacheFound
            ? GenerateCacheContents(context.BiomeId)
            : (0, null);

        if (cacheFound)
        {
            _logger.LogInformation(
                "Hidden cache discovered! {Marks} Marks, Item: {Item}",
                cacheMarks,
                cacheItem ?? "none");
        }

        // Calculate yields based on successes
        var (scrap, rations, components) = CalculateYields(checkResult.NetSuccesses, context.BiomeId);

        // Check for biome-specific items on critical success
        var biomeItems = new List<string>();
        if (checkResult.NetSuccesses >= 5) // Critical success
        {
            var lootTable = GetBiomeLootTable(context.BiomeId);
            if (lootTable.Count > 0)
            {
                var itemIndex = _diceService.Roll(1, lootTable.Count) - 1;
                biomeItems.Add(lootTable[itemIndex]);
                _logger.LogDebug("Critical success! Found biome item: {Item}", biomeItems[0]);
            }
        }

        var result = new ForagingResult(
            SuccessLevel: checkResult.NetSuccesses,
            ScrapYield: scrap,
            RationsYield: rations,
            ComponentsYield: components,
            CacheFound: cacheFound,
            CacheMarks: cacheMarks,
            CacheItem: cacheItem,
            BiomeSpecificItems: biomeItems,
            TimeSpent: context.TimeSpan,
            RollDetails: checkResult.RollDescription
        );

        _logger.LogInformation("Foraging complete: {Result}", result.ToDisplayString());

        return result;
    }

    /// <inheritdoc />
    public (int Scrap, int Rations, int Components) CalculateYields(int successes, string biomeId)
    {
        // Clamp successes to table range
        var tableKey = Math.Clamp(successes, 0, 8);
        var (scrapDice, rationDice, componentCount) = YieldTable[tableKey];

        // Roll for scrap (d10s)
        var scrap = scrapDice > 0 ? _diceService.RollSum(scrapDice, 10) : 0;

        // Roll for rations (d6s)
        var rations = rationDice > 0 ? _diceService.RollSum(rationDice, 6) : 0;

        // Roll or use fixed component count
        var components = componentCount switch
        {
            -1 => _diceService.Roll(1, 4), // Roll 1d4
            > 0 => componentCount,
            _ => 0
        };

        return (scrap, rations, components);
    }

    /// <inheritdoc />
    public bool CheckForCache(IEnumerable<int> diceRolls)
    {
        return diceRolls.Any(roll => roll == 10);
    }

    /// <inheritdoc />
    public (int Marks, string? Item) GenerateCacheContents(string biomeId)
    {
        // Roll 1d100 for Marks
        var marks = _diceService.Roll(1, 100);

        // 50% chance for a bonus item
        var hasItem = _diceService.Roll(1, 2) == 2;
        string? item = null;

        if (hasItem)
        {
            var lootTable = GetBiomeLootTable(biomeId);
            if (lootTable.Count > 0)
            {
                var itemIndex = _diceService.Roll(1, lootTable.Count) - 1;
                item = lootTable[itemIndex];
            }
        }

        return (marks, item);
    }

    /// <inheritdoc />
    public int GetDurationBonus(SearchDuration duration)
    {
        return duration switch
        {
            SearchDuration.Quick => 0,
            SearchDuration.Thorough => 2,
            SearchDuration.Complete => 4,
            _ => 0
        };
    }

    /// <inheritdoc />
    public IReadOnlyList<string> GetBiomeLootTable(string biomeId)
    {
        return BiomeLootTables.TryGetValue(biomeId.ToLowerInvariant(), out var table)
            ? table
            : BiomeLootTables["default"];
    }
}
```

---

## 9. Yield Tables and Economy Balance

### 9.1 Yield Table by Successes

| Successes | Scrap | Rations | Components | Expected Value |
|-----------|-------|---------|------------|----------------|
| 0-1 | — | — | — | 0 |
| 2-3 | 2d10 (avg 11) | — | — | ~11 |
| 4-5 | 3d10 (avg 16.5) | 1d6 (avg 3.5) | — | ~34 |
| 6-7 | 4d10 (avg 22) | 1d6 (avg 3.5) | 1 | ~60 |
| 8+ | 5d10 (avg 27.5) | 2d6 (avg 7) | 1d4 (avg 2.5) | ~113 |

### 9.2 Economy Balance Analysis

| Search Type | Time | Avg Successes | Avg Yield | Value/Hour |
|-------------|------|---------------|-----------|------------|
| Quick | 10 min | ~2 | ~8 scrap | ~48/hr |
| Thorough | 1 hr | ~3-4 | ~15 scrap, chance rations | ~20/hr |
| Complete | 4 hr | ~5-6 | ~25 scrap, rations, chance component | ~15/hr |

### 9.3 Design Rationale

- **Quick searches** are most time-efficient but only yield common salvage
- **Thorough searches** provide balanced yields with reasonable cache chances
- **Complete searches** have highest absolute yields but lowest efficiency per hour
- This creates meaningful player choice based on time pressure vs. resource needs

---

## 10. Hidden Cache Discovery

### 10.1 Trigger Mechanism

- Any die showing a **10** during the foraging roll triggers cache discovery
- This is independent of success/failure on the main check
- Multiple 10s do not grant multiple caches

### 10.2 Cache Contents

| Contents | Amount | Notes |
|----------|--------|-------|
| Marks | 1d100 | Currency, always present |
| Bonus Item | 50% chance | Drawn from biome loot table |

### 10.3 Probability Analysis

With a typical dice pool:
- 5 dice: ~41% chance of at least one 10
- 7 dice (Thorough): ~52% chance
- 9 dice (Complete): ~61% chance

---

## 11. Data Model Changes

### 11.1 New Enums

| Enum | Layer | Description |
|------|-------|-------------|
| `SearchDuration` | Domain | Time investment for foraging |
| `ForageTarget` | Domain | Resource type being sought |

### 11.2 New Value Objects

| Value Object | Layer | Description |
|--------------|-------|-------------|
| `ForagingContext` | Domain | Context for a foraging attempt |
| `ForagingResult` | Domain | Result of a foraging attempt |

### 11.3 New Services

| Service | Layer | Description |
|---------|-------|-------------|
| `IForagingService` | Application | Interface for foraging operations |
| `ForagingService` | Application | Implementation of foraging logic |

---

## 12. Configuration Files

### 12.1 foraging-yields.json

**File:** `config/foraging-yields.json`

```json
{
    "$schema": "./schemas/foraging-yields.schema.json",
    "yieldTable": [
        { "minSuccesses": 0, "maxSuccesses": 1, "scrapDice": 0, "rationDice": 0, "components": 0 },
        { "minSuccesses": 2, "maxSuccesses": 3, "scrapDice": 2, "rationDice": 0, "components": 0 },
        { "minSuccesses": 4, "maxSuccesses": 5, "scrapDice": 3, "rationDice": 1, "components": 0 },
        { "minSuccesses": 6, "maxSuccesses": 7, "scrapDice": 4, "rationDice": 1, "components": 1 },
        { "minSuccesses": 8, "maxSuccesses": 99, "scrapDice": 5, "rationDice": 2, "componentsRoll": "1d4" }
    ],
    "durationBonuses": {
        "Quick": 0,
        "Thorough": 2,
        "Complete": 4
    },
    "forageDcs": {
        "CommonSalvage": 10,
        "UsefulSupplies": 14,
        "ValuableComponents": 18,
        "HiddenCache": 22
    },
    "cacheTrigger": {
        "dieValue": 10,
        "marksRoll": "1d100",
        "itemChance": 0.5
    },
    "biomeLootTables": {
        "industrial-ruins": [
            { "id": "corroded-medkit", "name": "Corroded Medkit", "weight": 25 },
            { "id": "rusty-toolkit", "name": "Rusty Toolkit", "weight": 25 },
            { "id": "fuel-canister", "name": "Fuel Canister", "weight": 25 },
            { "id": "wire-spool", "name": "Wire Spool", "weight": 25 }
        ],
        "residential-ruins": [
            { "id": "canned-food", "name": "Canned Food", "weight": 30 },
            { "id": "tattered-map", "name": "Tattered Map", "weight": 20 },
            { "id": "old-currency", "name": "Old Currency", "weight": 25 },
            { "id": "faded-photograph", "name": "Faded Photograph", "weight": 25 }
        ],
        "wasteland": [
            { "id": "mutant-bone", "name": "Mutant Bone", "weight": 25 },
            { "id": "glowing-crystal", "name": "Glowing Crystal", "weight": 20 },
            { "id": "petrified-wood", "name": "Petrified Wood", "weight": 30 },
            { "id": "strange-ore", "name": "Strange Ore", "weight": 25 }
        ],
        "swamp": [
            { "id": "medicinal-moss", "name": "Medicinal Moss", "weight": 30 },
            { "id": "poison-gland", "name": "Poison Gland", "weight": 20 },
            { "id": "bog-iron", "name": "Bog Iron", "weight": 25 },
            { "id": "reed-bundle", "name": "Reed Bundle", "weight": 25 }
        ],
        "default": [
            { "id": "mysterious-object", "name": "Mysterious Object", "weight": 34 },
            { "id": "salvageable-scrap", "name": "Salvageable Scrap", "weight": 33 },
            { "id": "strange-device", "name": "Strange Device", "weight": 33 }
        ]
    },
    "economyBalance": {
        "scrapValuePerUnit": 1,
        "rationValuePerUnit": 5,
        "componentValuePerUnit": 20,
        "notes": "Values used for estimating total haul value"
    }
}
```

### 12.2 foraging-yields.schema.json

**File:** `config/schemas/foraging-yields.schema.json`

```json
{
    "$schema": "https://json-schema.org/draft/2020-12/schema",
    "$id": "https://runeandrust.game/schemas/foraging-yields.schema.json",
    "title": "Foraging Yields Configuration",
    "description": "Configuration schema for foraging yield tables and biome loot",
    "type": "object",
    "required": ["yieldTable", "durationBonuses", "forageDcs", "cacheTrigger", "biomeLootTables"],
    "properties": {
        "yieldTable": {
            "type": "array",
            "description": "Yield table indexed by success count",
            "items": {
                "type": "object",
                "required": ["minSuccesses", "maxSuccesses", "scrapDice", "rationDice"],
                "properties": {
                    "minSuccesses": {
                        "type": "integer",
                        "minimum": 0,
                        "description": "Minimum successes for this tier"
                    },
                    "maxSuccesses": {
                        "type": "integer",
                        "minimum": 0,
                        "description": "Maximum successes for this tier"
                    },
                    "scrapDice": {
                        "type": "integer",
                        "minimum": 0,
                        "description": "Number of d10s to roll for scrap"
                    },
                    "rationDice": {
                        "type": "integer",
                        "minimum": 0,
                        "description": "Number of d6s to roll for rations"
                    },
                    "components": {
                        "type": "integer",
                        "minimum": 0,
                        "description": "Fixed number of components"
                    },
                    "componentsRoll": {
                        "type": "string",
                        "pattern": "^\\d+d\\d+$",
                        "description": "Dice expression for component roll (e.g., '1d4')"
                    }
                }
            }
        },
        "durationBonuses": {
            "type": "object",
            "required": ["Quick", "Thorough", "Complete"],
            "properties": {
                "Quick": { "type": "integer" },
                "Thorough": { "type": "integer" },
                "Complete": { "type": "integer" }
            },
            "description": "Bonus dice by search duration"
        },
        "forageDcs": {
            "type": "object",
            "required": ["CommonSalvage", "UsefulSupplies", "ValuableComponents", "HiddenCache"],
            "properties": {
                "CommonSalvage": { "type": "integer", "minimum": 1, "maximum": 30 },
                "UsefulSupplies": { "type": "integer", "minimum": 1, "maximum": 30 },
                "ValuableComponents": { "type": "integer", "minimum": 1, "maximum": 30 },
                "HiddenCache": { "type": "integer", "minimum": 1, "maximum": 30 }
            },
            "description": "Base DCs by forage target"
        },
        "cacheTrigger": {
            "type": "object",
            "required": ["dieValue", "marksRoll", "itemChance"],
            "properties": {
                "dieValue": {
                    "type": "integer",
                    "minimum": 1,
                    "maximum": 10,
                    "description": "Die value that triggers cache discovery"
                },
                "marksRoll": {
                    "type": "string",
                    "pattern": "^\\d+d\\d+$",
                    "description": "Dice expression for cache Marks"
                },
                "itemChance": {
                    "type": "number",
                    "minimum": 0,
                    "maximum": 1,
                    "description": "Probability of bonus item in cache"
                }
            }
        },
        "biomeLootTables": {
            "type": "object",
            "description": "Loot tables by biome ID",
            "additionalProperties": {
                "type": "array",
                "items": {
                    "type": "object",
                    "required": ["id", "name", "weight"],
                    "properties": {
                        "id": { "type": "string" },
                        "name": { "type": "string" },
                        "weight": { "type": "integer", "minimum": 1 }
                    }
                }
            }
        },
        "economyBalance": {
            "type": "object",
            "properties": {
                "scrapValuePerUnit": { "type": "integer" },
                "rationValuePerUnit": { "type": "integer" },
                "componentValuePerUnit": { "type": "integer" },
                "notes": { "type": "string" }
            }
        }
    }
}
```

### 12.3 Configuration Schema Summary

| Config File | Schema File | Purpose |
|-------------|-------------|---------|
| `foraging-yields.json` | `foraging-yields.schema.json` | Yield tables, DCs, biome loot, cache mechanics |

---

## 13. Logging Specifications

### 13.1 Log Levels by Component

| Component | Level | Events |
|-----------|-------|--------|
| `ForagingService` | Information | Foraging attempts, results, cache discoveries |
| `ForagingService` | Debug | Yield calculations, dice rolls, biome lookups |
| `ForagingService` | Warning | Invalid biome IDs, configuration issues |
| `ForagingService` | Error | Service failures, null references |

### 13.2 Log Message Formats

```
// Information level
"Character {CharacterId} attempting {Duration} forage for {Target} in {Biome}"
"Hidden cache discovered! {Marks} Marks, Item: {Item}"
"Foraging complete: {Result}"

// Debug level
"Foraging check result: {NetSuccesses} net successes, rolls: {Rolls}"
"Critical success! Found biome item: {Item}"

// Warning level
"Unknown biome '{BiomeId}', using default loot table"
```

---

## 14. Unit Testing Requirements

### 14.1 Test Count by Feature

| Feature | Test Count |
|---------|------------|
| Search duration bonus calculation | ~1 |
| Yield table matches success level | ~1 |
| Cache discovery triggers on 10s | ~1 |
| **Total** | **~3** |

### 14.2 Test Specifications

**File:** `tests/RuneAndRust.Application.Tests/Services/ForagingServiceTests.cs`

```csharp
[TestFixture]
public class ForagingServiceTests
{
    [Test]
    public void GetDurationBonus_ReturnsCorrectBonusForEachDuration()
    {
        // Arrange
        var service = CreateService();

        // Act & Assert
        Assert.That(service.GetDurationBonus(SearchDuration.Quick), Is.EqualTo(0));
        Assert.That(service.GetDurationBonus(SearchDuration.Thorough), Is.EqualTo(2));
        Assert.That(service.GetDurationBonus(SearchDuration.Complete), Is.EqualTo(4));
    }

    [Test]
    [TestCase(0, 0, 0, 0)]  // No successes = nothing
    [TestCase(2, 11, 0, 0)] // 2 successes = 2d10 scrap (avg 11)
    [TestCase(4, 16, 3, 0)] // 4 successes = 3d10 scrap + 1d6 rations
    [TestCase(6, 22, 3, 1)] // 6 successes = 4d10 scrap + 1d6 rations + 1 component
    public void CalculateYields_MatchesSuccessLevel(
        int successes, int expectedMinScrap, int expectedMinRations, int expectedMinComponents)
    {
        // Arrange
        var mockDice = CreateMockDiceService(averageRolls: true);
        var service = CreateService(mockDice);

        // Act
        var (scrap, rations, components) = service.CalculateYields(successes, "default");

        // Assert - check that yields are in expected range
        Assert.That(scrap, Is.GreaterThanOrEqualTo(expectedMinScrap > 0 ? 2 : 0));
        Assert.That(rations, Is.GreaterThanOrEqualTo(expectedMinRations > 0 ? 1 : 0));
        Assert.That(components, Is.GreaterThanOrEqualTo(expectedMinComponents));
    }

    [Test]
    public void CheckForCache_ReturnsTrueWhenAnyDieIs10()
    {
        // Arrange
        var service = CreateService();
        var rollsWithTen = new[] { 3, 7, 10, 2, 5 };
        var rollsWithoutTen = new[] { 3, 7, 9, 2, 5 };

        // Act & Assert
        Assert.That(service.CheckForCache(rollsWithTen), Is.True);
        Assert.That(service.CheckForCache(rollsWithoutTen), Is.False);
    }

    [Test]
    public void AttemptForaging_WithRolled10_DiscoversCacheWithMarks()
    {
        // Arrange
        var mockSkillCheck = CreateMockSkillCheckService(
            netSuccesses: 3,
            rolledValues: new[] { 8, 10, 3, 5 }); // Contains a 10
        var mockDice = CreateMockDiceService();
        var service = CreateService(mockSkillCheck, mockDice);
        var context = new ForagingContext(
            CharacterId: "player-1",
            BiomeId: "wasteland",
            SearchDuration: SearchDuration.Thorough,
            ForageTarget: ForageTarget.CommonSalvage);

        // Act
        var result = service.AttemptForaging("player-1", context);

        // Assert
        Assert.That(result.CacheFound, Is.True);
        Assert.That(result.CacheMarks, Is.GreaterThan(0));
    }
}
```

---

## 15. Use Cases

### UC-001: Quick Scrap Search

**Actor:** Player Character
**Flow:** Select quick search → Roll Wasteland Survival vs DC 10 → Calculate scrap yield → Return result in 10 minutes

### UC-002: Thorough Search with Cache Discovery

**Actor:** Player Character
**Flow:** Select thorough search → Roll with +2d10 bonus → Any 10 triggers cache → Roll 1d100 Marks + bonus item chance → Return all yields after 1 hour

### UC-003: Complete Search in Specific Biome

**Actor:** Player Character
**Flow:** Select complete search in industrial-ruins → Roll with +4d10 bonus → Critical success (5+ net) grants biome-specific item → Return maximum yields after 4 hours

### UC-004: Searching Exhausted Area

**Actor:** Player Character
**Flow:** Search area third time → Apply -3 dice penalty → Lower expected yields → Consider moving to fresh area

---

## 16. Deliverable Checklist

### 16.1 Domain Layer

- [ ] `SearchDuration.cs` enum created in `Enums/`
- [ ] `ForageTarget.cs` enum created in `Enums/`
- [ ] `ForagingContext.cs` value object created in `ValueObjects/`
- [ ] `ForagingResult.cs` value object created in `ValueObjects/`

### 16.2 Application Layer

- [ ] `IForagingService.cs` interface created in `Services/`
- [ ] `ForagingService.cs` implementation created in `Services/`
- [ ] Service registered in dependency injection

### 16.3 Configuration

- [ ] `config/foraging-yields.json` created
- [ ] `config/schemas/foraging-yields.schema.json` created
- [ ] Configuration files validate against schemas

### 16.4 Testing

- [ ] `ForagingServiceTests.cs` created (~3 tests)
- [ ] All tests passing

### 16.5 Documentation

- [ ] XML documentation complete on all public members
- [ ] This design specification complete

---

## 17. Acceptance Criteria

### 17.1 Functional

- [ ] SearchDuration enum contains Quick, Thorough, Complete
- [ ] Duration bonuses apply correctly (+0, +2d10, +4d10)
- [ ] ForageTarget enum contains all 4 targets with correct DCs
- [ ] Yield table returns correct yields for each success tier
- [ ] Cache discovery triggers when any die shows 10
- [ ] Cache contains 1d100 Marks with 50% item chance
- [ ] Biome-specific items available on critical success
- [ ] Area exhaustion reduces dice pool on repeated searches

### 17.2 Quality

- [ ] Build succeeds with 0 errors/warnings
- [ ] All ~3 unit tests pass
- [ ] Configuration files validate against JSON schemas
- [ ] XML documentation complete on all public types
- [ ] Logging follows specification

---

## 18. Dependencies

### 18.1 Required from Previous Versions

| Version | Type | Usage |
|---------|------|-------|
| v0.15.0 | `IDiceService` | Dice rolling for yields |
| v0.15.0 | Success-counting mechanics | Net successes calculation |
| v0.15.1 | `ISkillCheckService` | Performing Wasteland Survival checks |
| v0.15.1 | `SkillContext` | Context for skill checks |

### 18.2 Provides to Future Versions

| Type | Usage in Future |
|------|-----------------|
| `IForagingService` | Resource gathering for crafting system |
| Biome loot tables | Shared with hazard detection, scout action |
| Area exhaustion pattern | Reusable for other area-based mechanics |

---

## 19. Future Considerations

### 19.1 Deferred to v0.15.5d-i

- **Navigation System** (v0.15.5d): Terrain-based navigation
- **Hazard Detection** (v0.15.5e): Environmental hazard discovery
- **Scavenger Sign Reading** (v0.15.5f): Faction marker interpretation
- **Scout Action** (v0.15.5g): Area reconnaissance
- **Specialization Integration** (v0.15.5h): Archetype-specific bonuses
- **Exploration Synergies** (v0.15.5i): Combined skill checks

### 19.2 Out of Scope

- **Crafting integration**: Using found components (future crafting version)
- **Area persistence**: Saving searched areas across sessions (future persistence version)
- **Party foraging**: Group foraging mechanics (future party version)

---

## 20. Document Metadata

---

*Document Version: 1.0*
*Last Updated: 2026-01-18*
*Author: Claude*

---

### Revision History

| Version | Date | Author | Changes |
|---------|------|--------|---------|
| 1.0 | 2026-01-18 | Claude | Initial design specification |

---

*This design specification provides the detailed blueprint for implementing v0.15.5c Foraging System. This establishes the time-investment resource gathering pattern that will be reused for other collection mechanics throughout the game.*
