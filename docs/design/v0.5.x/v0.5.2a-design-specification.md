# v0.5.2a Design Specification: Terrain Core

**Version:** 0.5.2a
**Phase Name:** Terrain Core
**Parent Version:** v0.5.2 (Terrain & Cover)
**Prerequisites:** v0.5.1c Complete (Line of Sight)
**Estimated Tests:** ~30 unit tests

---

## Table of Contents

1. [Executive Summary](#1-executive-summary)
2. [Feature Overview](#2-feature-overview)
3. [Architecture Diagrams](#3-architecture-diagrams)
4. [TerrainType Enum](#4-terraintype-enum)
5. [TerrainDefinition](#5-terraindefinition)
6. [GridCell Modifications](#6-gridcell-modifications)
7. [TerrainService](#7-terrainservice)
8. [MovementService Updates](#8-movementservice-updates)
9. [User-Facing Commands](#9-user-facing-commands)
10. [Data Model Changes](#10-data-model-changes)
11. [Configuration File Schemas](#11-configuration-file-schemas)
12. [Logging Specifications](#12-logging-specifications)
13. [Unit Testing Requirements](#13-unit-testing-requirements)
14. [Use Cases](#14-use-cases)
15. [Deliverable Checklist](#15-deliverable-checklist)
16. [Acceptance Criteria](#16-acceptance-criteria)
17. [Dependencies](#17-dependencies)
18. [Future Considerations](#18-future-considerations)

---

## 1. Executive Summary

### 1.1 Purpose

This specification establishes the terrain system that adds environmental depth to the combat grid. Grid cells now have terrain types that affect movement costs and can deal damage. Difficult terrain costs extra movement points, impassable terrain blocks movement entirely, and hazardous terrain deals damage when entered.

Key mechanics:
- **Terrain Types**: Normal, Difficult, Impassable, Hazardous
- **Movement Cost Modifiers**: Terrain multiplies base movement costs
- **Hazard Damage**: Some terrain deals damage on entry
- **Configurable Terrain**: JSON-defined terrain with custom properties

### 1.2 Key Deliverables

| Category | Items |
|----------|-------|
| **Domain Enums** | `TerrainType` |
| **Domain Definitions** | `TerrainDefinition` |
| **GridCell Updates** | `TerrainType`, `TerrainDefinitionId` properties |
| **Application Interfaces** | `ITerrainService` |
| **Application Services** | `TerrainService` |
| **Result Types** | `TerrainDamageResult` |
| **MovementService Updates** | Terrain cost integration |
| **Configuration** | `terrain.json` |
| **Tests** | ~30 unit tests |

### 1.3 Architectural Significance

This version establishes the **Environmental Terrain Pattern**:

- **Cell-Based Terrain**: Each grid cell has a terrain type affecting gameplay
- **Cost Multipliers**: Movement costs scale with terrain difficulty
- **Damage Integration**: Hazardous terrain interacts with combat health
- **Data-Driven**: All terrain properties configurable via JSON

---

## 2. Feature Overview

```
v0.5.2a Terrain Core
├── TerrainType Enum
│   ├── Normal (1x movement cost)
│   ├── Difficult (2x movement cost)
│   ├── Impassable (blocks movement)
│   └── Hazardous (deals damage on entry)
├── TerrainDefinition
│   ├── Id, Name, Type
│   ├── MovementCostMultiplier
│   ├── DamageOnEntry, DamageType
│   ├── BlocksLOS
│   └── DisplayChar, Description
├── GridCell Modifications
│   ├── TerrainType property
│   ├── TerrainDefinitionId property
│   ├── SetTerrain(), SetTerrainDefinition()
│   ├── GetMovementCostMultiplier()
│   └── Updated IsPassable, BlocksLOS
├── TerrainService
│   ├── GetMovementCost(position, direction)
│   ├── GetMovementCostMultiplier(position)
│   ├── IsPassable(position)
│   ├── DealsDamage(position)
│   ├── GetTerrainDamage(position)
│   ├── ApplyTerrainDamage(entityId, position)
│   ├── GetTerrainType(position)
│   ├── SetTerrain(position, type/id)
│   └── GetAllTerrainDefinitions()
└── MovementService Updates
    ├── Terrain cost integration
    ├── Passability check
    └── Hazard damage on entry
```

### 2.1 Scope Alignment

**In Scope:**
- `TerrainType` enum (Normal, Difficult, Impassable, Hazardous)
- `TerrainDefinition` for configurable terrain types
- `GridCell.TerrainType` property
- `ITerrainService` interface
- `TerrainService` for terrain calculations
- Difficult terrain movement cost (2x)
- Impassable terrain blocking movement
- Hazardous terrain damage on entry
- Terrain configuration in JSON
- Room terrain layout support
- Terrain-aware movement validation

**Out of Scope:**
- Cover system (v0.5.2b)
- Terrain display (v0.5.2c)
- Full combat integration (v0.5.2c)

---

## 3. Architecture Diagrams

### 3.1 Terrain Type Effects

```
┌─────────────────────────────────────────────────────────────────────┐
│                       TERRAIN TYPE EFFECTS                           │
└─────────────────────────────────────────────────────────────────────┘

    NORMAL TERRAIN                    DIFFICULT TERRAIN
    ┌─────────────────┐               ┌─────────────────┐
    │ Movement: 1x    │               │ Movement: 2x    │
    │ Passable: Yes   │               │ Passable: Yes   │
    │ Damage: None    │               │ Damage: None    │
    │ Examples:       │               │ Examples:       │
    │  • Stone floor  │               │  • Rubble       │
    │  • Grass        │               │  • Shallow water│
    │  • Tile         │               │  • Mud          │
    └─────────────────┘               └─────────────────┘

    IMPASSABLE TERRAIN                HAZARDOUS TERRAIN
    ┌─────────────────┐               ┌─────────────────┐
    │ Movement: N/A   │               │ Movement: 1x    │
    │ Passable: No    │               │ Passable: Yes   │
    │ Damage: None    │               │ Damage: On Entry│
    │ Examples:       │               │ Examples:       │
    │  • Wall         │               │  • Fire         │
    │  • Pit          │               │  • Acid pool    │
    │  • Chasm        │               │  • Spike trap   │
    └─────────────────┘               └─────────────────┘
```

### 3.2 Movement Cost Calculation

```
┌─────────────────────────────────────────────────────────────────────┐
│                    MOVEMENT COST CALCULATION                         │
└─────────────────────────────────────────────────────────────────────┘

    Base Cost (from v0.5.0b)
    ├── Cardinal (N, S, E, W): 2 points
    └── Diagonal (NE, NW, SE, SW): 3 points

    Terrain Multiplier
    ├── Normal: × 1.0
    ├── Difficult: × 2.0
    ├── Hazardous: × 1.0 (or custom)
    └── Impassable: N/A (blocked)

    Total Cost = BaseCost × TerrainMultiplier

    Examples:
    ┌────────────────────────────────────────────────────────────┐
    │ Move north into normal:    2 × 1.0 = 2 points             │
    │ Move north into difficult: 2 × 2.0 = 4 points             │
    │ Move NE into normal:       3 × 1.0 = 3 points             │
    │ Move NE into difficult:    3 × 2.0 = 6 points             │
    │ Move into impassable:      BLOCKED                        │
    └────────────────────────────────────────────────────────────┘
```

### 3.3 Hazard Damage Flow

```
┌─────────────────────────────────────────────────────────────────────┐
│                       HAZARD DAMAGE FLOW                             │
└─────────────────────────────────────────────────────────────────────┘

    Move Command
         │
         ▼
    ┌───────────────────┐
    │ Validate Movement │
    │ (terrain passable)│
    └────────┬──────────┘
             │Pass
             ▼
    ┌───────────────────┐
    │ Calculate Cost    │
    │ (with multiplier) │
    └────────┬──────────┘
             │Enough points
             ▼
    ┌───────────────────┐
    │ Execute Movement  │
    │ (update position) │
    └────────┬──────────┘
             │
             ▼
    ┌───────────────────┐
    │ Check Hazardous   │──No──▶ Complete (no damage)
    │ Terrain?          │
    └────────┬──────────┘
             │Yes
             ▼
    ┌───────────────────┐
    │ Roll Damage       │
    │ (DiceService)     │
    └────────┬──────────┘
             │
             ▼
    ┌───────────────────┐
    │ Apply Damage      │
    │ (to entity HP)    │
    └────────┬──────────┘
             │
             ▼
    ┌───────────────────┐
    │ Return Result     │
    │ (with damage msg) │
    └───────────────────┘
```

### 3.4 Layer Diagram

```
┌─────────────────────────────────────────────────────────────────────┐
│                        PRESENTATION LAYER                            │
├─────────────────────────────────────────────────────────────────────┤
│  MoveCommand (Updated)                                               │
│  └── Displays terrain info and hazard damage                        │
├─────────────────────────────────────────────────────────────────────┤
│  PositionCommand (Updated)                                           │
│  └── Shows nearby terrain types                                     │
└───────┬─────────────────────────────────────────────────────────────┘
        │
        ▼
┌─────────────────────────────────────────────────────────────────────┐
│                       APPLICATION LAYER                              │
├─────────────────────────────────────────────────────────────────────┤
│  ITerrainService / TerrainService                                    │
│  ├── GetMovementCost(position, direction): int                      │
│  ├── GetMovementCostMultiplier(position): float                     │
│  ├── IsPassable(position): bool                                     │
│  ├── DealsDamage(position): bool                                    │
│  ├── GetTerrainDamage(position): TerrainDamageResult?               │
│  ├── ApplyTerrainDamage(entityId, position): TerrainDamageResult    │
│  ├── GetTerrainType(position): TerrainType                          │
│  ├── GetTerrainDefinition(position): TerrainDefinition?             │
│  ├── SetTerrain(position, type): void                               │
│  └── GetAllTerrainDefinitions(): IEnumerable<TerrainDefinition>     │
├─────────────────────────────────────────────────────────────────────┤
│  MovementService (Extended from v0.5.0b)                             │
│  └── Move() now integrates terrain costs and hazard damage          │
├─────────────────────────────────────────────────────────────────────┤
│  MovementResult (Extended)                                           │
│  └── TerrainDamage: TerrainDamageResult?                            │
├─────────────────────────────────────────────────────────────────────┤
│  TerrainDamageResult                                                 │
│  ├── DamageDealt: bool                                              │
│  ├── Damage: int                                                    │
│  ├── DamageType: string                                             │
│  ├── TerrainName: string                                            │
│  └── Message: string                                                │
└───────┬─────────────────────────────────────────────────────────────┘
        │
        ▼
┌─────────────────────────────────────────────────────────────────────┐
│                         DOMAIN LAYER                                 │
├─────────────────────────────────────────────────────────────────────┤
│  ┌────────────────────┐  ┌──────────────────────────────────────┐  │
│  │    TerrainType     │  │        TerrainDefinition             │  │
│  │      (Enum)        │  │                                      │  │
│  ├────────────────────┤  ├──────────────────────────────────────┤  │
│  │ Normal     = 0     │  │ + Id: string                         │  │
│  │ Difficult  = 1     │  │ + Name: string                       │  │
│  │ Impassable = 2     │  │ + Type: TerrainType                  │  │
│  │ Hazardous  = 3     │  │ + MovementCostMultiplier: float      │  │
│  └────────────────────┘  │ + DamageOnEntry: string?             │  │
│                          │ + DamageType: string?                │  │
│                          │ + BlocksLOS: bool                    │  │
│                          │ + DisplayChar: char                  │  │
│                          │ + Description: string                │  │
│                          │ + IsPassable: bool                   │  │
│                          │ + DealsDamage: bool                  │  │
│                          └──────────────────────────────────────┘  │
│                                                                      │
│  ┌──────────────────────────────────────────────────────────────┐  │
│  │                GridCell (Extended from v0.5.1c)              │  │
│  ├──────────────────────────────────────────────────────────────┤  │
│  │ [v0.5.0a] Position, IsOccupied, OccupantId                   │  │
│  │ [v0.5.1c] BlocksLOS                                          │  │
│  │ [NEW] TerrainType: TerrainType (default: Normal)             │  │
│  │ [NEW] TerrainDefinitionId: string? (for custom terrain)      │  │
│  │ [NEW] SetTerrain(type): void                                 │  │
│  │ [NEW] SetTerrainDefinition(id): void                         │  │
│  │ [NEW] GetMovementCostMultiplier(): float                     │  │
│  │ [UPDATE] IsPassable considers TerrainType                    │  │
│  │ [UPDATE] EffectivelyBlocksLOS considers terrain              │  │
│  └──────────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────────┘
```

---

## 4. TerrainType Enum

### 4.1 Implementation

**File:** `src/Core/RuneAndRust.Domain/Enums/TerrainType.cs`

```csharp
namespace RuneAndRust.Domain.Enums;

/// <summary>
/// Types of terrain on grid cells.
/// </summary>
public enum TerrainType
{
    /// <summary>Normal terrain - standard movement cost.</summary>
    Normal = 0,

    /// <summary>Difficult terrain - costs double movement points.</summary>
    Difficult = 1,

    /// <summary>Impassable terrain - cannot be entered.</summary>
    Impassable = 2,

    /// <summary>Hazardous terrain - deals damage when entered.</summary>
    Hazardous = 3
}
```

### 4.2 Terrain Type Properties

| Type | Passable | Movement Multiplier | Damage | Examples |
|------|----------|---------------------|--------|----------|
| Normal | Yes | 1.0x | None | Floor, grass, tile |
| Difficult | Yes | 2.0x | None | Rubble, water, mud |
| Impassable | No | N/A | None | Wall, pit, chasm |
| Hazardous | Yes | 1.0x (configurable) | On entry | Fire, acid, spikes |

---

## 5. TerrainDefinition

### 5.1 Implementation

**File:** `src/Core/RuneAndRust.Domain/Definitions/TerrainDefinition.cs`

```csharp
namespace RuneAndRust.Domain.Definitions;

/// <summary>
/// Configuration for a type of terrain.
/// </summary>
public class TerrainDefinition
{
    public string Id { get; private set; } = string.Empty;
    public string Name { get; private set; } = string.Empty;
    public TerrainType Type { get; private set; } = TerrainType.Normal;
    public float MovementCostMultiplier { get; private set; } = 1.0f;
    public string? DamageOnEntry { get; private set; }
    public string? DamageType { get; private set; }
    public bool BlocksLOS { get; private set; }
    public char DisplayChar { get; private set; } = '.';
    public string Description { get; private set; } = string.Empty;

    private TerrainDefinition() { }

    public static TerrainDefinition Create(
        string id, string name, TerrainType type,
        float movementCostMultiplier = 1.0f,
        string? damageOnEntry = null, string? damageType = null,
        bool blocksLOS = false, char displayChar = '.',
        string description = "")
    {
        ArgumentException.ThrowIfNullOrWhiteSpace(id);
        return new TerrainDefinition
        {
            Id = id.ToLowerInvariant(),
            Name = name,
            Type = type,
            MovementCostMultiplier = movementCostMultiplier,
            DamageOnEntry = damageOnEntry,
            DamageType = damageType,
            BlocksLOS = blocksLOS,
            DisplayChar = displayChar,
            Description = description
        };
    }

    /// <summary>Gets whether this terrain is passable.</summary>
    public bool IsPassable => Type != TerrainType.Impassable;

    /// <summary>Gets whether this terrain deals damage.</summary>
    public bool DealsDamage => Type == TerrainType.Hazardous && !string.IsNullOrEmpty(DamageOnEntry);
}
```

---

## 6. GridCell Modifications

**File:** `src/Core/RuneAndRust.Domain/ValueObjects/GridCell.cs`

```csharp
// Add to GridCell:

#region Terrain Properties

/// <summary>Gets the terrain type of this cell.</summary>
public TerrainType TerrainType { get; private set; } = TerrainType.Normal;

/// <summary>Gets the terrain definition ID (for custom terrain).</summary>
public string? TerrainDefinitionId { get; private set; }

/// <summary>Sets the base terrain type.</summary>
public void SetTerrain(TerrainType type)
{
    TerrainType = type;
    TerrainDefinitionId = null;
}

/// <summary>Sets terrain by definition ID.</summary>
public void SetTerrainDefinition(string definitionId)
{
    TerrainDefinitionId = definitionId?.ToLowerInvariant();
}

/// <summary>Gets the movement cost multiplier for this terrain.</summary>
public float GetMovementCostMultiplier() => TerrainType switch
{
    TerrainType.Normal => 1.0f,
    TerrainType.Difficult => 2.0f,
    TerrainType.Hazardous => 1.0f,
    TerrainType.Impassable => float.MaxValue,
    _ => 1.0f
};

#endregion

// UPDATE: IsPassable
public bool IsPassable => !IsOccupied && TerrainType != TerrainType.Impassable && _isPassable;

// UPDATE: EffectivelyBlocksLOS (from v0.5.1c)
public bool EffectivelyBlocksLOS => BlocksLOS || !IsPassable || TerrainType == TerrainType.Impassable;
```

---

## 7. TerrainService

### 7.1 Interface

**File:** `src/Core/RuneAndRust.Application/Interfaces/ITerrainService.cs`

```csharp
namespace RuneAndRust.Application.Interfaces;

public interface ITerrainService
{
    int GetMovementCost(GridPosition position, MovementDirection direction);
    float GetMovementCostMultiplier(GridPosition position);
    bool IsPassable(GridPosition position);
    bool DealsDamage(GridPosition position);
    TerrainDamageResult? GetTerrainDamage(GridPosition position);
    TerrainDamageResult ApplyTerrainDamage(Guid entityId, GridPosition position);
    TerrainType GetTerrainType(GridPosition position);
    TerrainDefinition? GetTerrainDefinition(GridPosition position);
    void SetTerrain(GridPosition position, TerrainType type);
    void SetTerrain(GridPosition position, string terrainDefinitionId);
    IEnumerable<TerrainDefinition> GetAllTerrainDefinitions();
}

public readonly record struct TerrainDamageResult(
    bool DamageDealt, int Damage, string DamageType,
    string TerrainName, string Message);
```

### 7.2 Implementation

**File:** `src/Core/RuneAndRust.Application/Services/TerrainService.cs`

```csharp
namespace RuneAndRust.Application.Services;

public class TerrainService : ITerrainService
{
    private readonly ICombatGridService _gridService;
    private readonly IGameSessionService _sessionService;
    private readonly IDiceService _diceService;
    private readonly IGameConfigurationProvider _config;
    private readonly ILogger<TerrainService> _logger;

    private readonly Dictionary<string, TerrainDefinition> _definitions = new();

    public TerrainService(
        ICombatGridService gridService,
        IGameSessionService sessionService,
        IDiceService diceService,
        IGameConfigurationProvider config,
        ILogger<TerrainService> logger)
    {
        _gridService = gridService;
        _sessionService = sessionService;
        _diceService = diceService;
        _config = config;
        _logger = logger;
        LoadDefinitions();
    }

    private void LoadDefinitions()
    {
        foreach (var def in _config.GetTerrainDefinitions())
            _definitions[def.Id] = def;
    }

    public int GetMovementCost(GridPosition position, MovementDirection direction)
    {
        var baseCost = MovementCosts.GetCost(direction);
        var multiplier = GetMovementCostMultiplier(position);
        return (int)(baseCost * multiplier);
    }

    public float GetMovementCostMultiplier(GridPosition position)
    {
        var grid = _gridService.GetActiveGrid();
        var cell = grid?.GetCell(position);
        if (cell == null) return 1.0f;

        // Use definition if available
        if (cell.TerrainDefinitionId != null &&
            _definitions.TryGetValue(cell.TerrainDefinitionId, out var def))
            return def.MovementCostMultiplier;

        return cell.GetMovementCostMultiplier();
    }

    public bool IsPassable(GridPosition position)
    {
        var grid = _gridService.GetActiveGrid();
        var cell = grid?.GetCell(position);
        if (cell == null) return false;

        if (cell.TerrainDefinitionId != null &&
            _definitions.TryGetValue(cell.TerrainDefinitionId, out var def))
            return def.IsPassable;

        return cell.IsPassable;
    }

    public bool DealsDamage(GridPosition position)
    {
        var grid = _gridService.GetActiveGrid();
        var cell = grid?.GetCell(position);
        if (cell == null) return false;

        if (cell.TerrainDefinitionId != null &&
            _definitions.TryGetValue(cell.TerrainDefinitionId, out var def))
            return def.DealsDamage;

        return cell.TerrainType == TerrainType.Hazardous;
    }

    public TerrainDamageResult? GetTerrainDamage(GridPosition position)
    {
        var grid = _gridService.GetActiveGrid();
        var cell = grid?.GetCell(position);
        if (cell?.TerrainDefinitionId == null) return null;

        if (!_definitions.TryGetValue(cell.TerrainDefinitionId, out var def) || !def.DealsDamage)
            return null;

        var roll = _diceService.Roll(def.DamageOnEntry!);
        return new TerrainDamageResult(
            true, roll.Total, def.DamageType ?? "untyped",
            def.Name, $"You take {roll.Total} {def.DamageType ?? ""} damage from {def.Name}!");
    }

    public TerrainDamageResult ApplyTerrainDamage(Guid entityId, GridPosition position)
    {
        var damage = GetTerrainDamage(position);
        if (damage == null || !damage.Value.DamageDealt)
            return new TerrainDamageResult(false, 0, "", "", "");

        var player = _sessionService.GetCurrentPlayer();
        if (player?.Id == entityId)
        {
            player.TakeDamage(damage.Value.Damage);
            _logger.LogInformation("Player took {Damage} {Type} damage from {Terrain}",
                damage.Value.Damage, damage.Value.DamageType, damage.Value.TerrainName);
        }
        else
        {
            var monster = _sessionService.GetMonster(entityId);
            monster?.TakeDamage(damage.Value.Damage);
        }

        return damage.Value;
    }

    public TerrainType GetTerrainType(GridPosition position)
    {
        var grid = _gridService.GetActiveGrid();
        var cell = grid?.GetCell(position);
        if (cell == null) return TerrainType.Normal;

        if (cell.TerrainDefinitionId != null &&
            _definitions.TryGetValue(cell.TerrainDefinitionId, out var def))
            return def.Type;

        return cell.TerrainType;
    }

    public TerrainDefinition? GetTerrainDefinition(GridPosition position)
    {
        var grid = _gridService.GetActiveGrid();
        var cell = grid?.GetCell(position);
        if (cell?.TerrainDefinitionId == null) return null;

        return _definitions.TryGetValue(cell.TerrainDefinitionId, out var def) ? def : null;
    }

    public void SetTerrain(GridPosition position, TerrainType type)
    {
        var grid = _gridService.GetActiveGrid();
        var cell = grid?.GetCell(position);
        cell?.SetTerrain(type);
    }

    public void SetTerrain(GridPosition position, string terrainDefinitionId)
    {
        var grid = _gridService.GetActiveGrid();
        var cell = grid?.GetCell(position);
        cell?.SetTerrainDefinition(terrainDefinitionId);
    }

    public IEnumerable<TerrainDefinition> GetAllTerrainDefinitions() => _definitions.Values;
}
```

---

## 8. MovementService Updates

**File:** `src/Core/RuneAndRust.Application/Services/MovementService.cs`

```csharp
// Update MovementService to integrate terrain:

private readonly ITerrainService _terrainService;

public MovementResult Move(Guid entityId, MovementDirection direction)
{
    // ... existing grid and position validation ...

    var newPosition = currentPosition.Move(direction);

    // Check terrain passability
    if (!_terrainService.IsPassable(newPosition))
    {
        return new MovementResult
        {
            Success = false,
            FailureReason = MovementFailureReason.CellImpassable,
            Message = "That terrain is impassable."
        };
    }

    // Calculate movement cost with terrain multiplier
    var totalCost = _terrainService.GetMovementCost(newPosition, direction);

    if (GetRemainingMovement(entityId) < totalCost)
    {
        var terrain = _terrainService.GetTerrainDefinition(newPosition);
        var terrainMsg = terrain != null ? $" ({terrain.Name}: {terrain.MovementCostMultiplier}x)" : "";
        return new MovementResult
        {
            Success = false,
            FailureReason = MovementFailureReason.InsufficientMovementPoints,
            Message = $"Insufficient movement points. Need {totalCost}{terrainMsg}, have {GetRemainingMovement(entityId)}."
        };
    }

    // ... execute movement ...

    // Apply hazard damage if applicable
    TerrainDamageResult? hazardDamage = null;
    if (_terrainService.DealsDamage(newPosition))
    {
        hazardDamage = _terrainService.ApplyTerrainDamage(entityId, newPosition);
    }

    return new MovementResult
    {
        Success = true,
        OldPosition = currentPosition,
        NewPosition = newPosition,
        MovementPointsUsed = totalCost,
        MovementPointsRemaining = GetRemainingMovement(entityId),
        TerrainDamage = hazardDamage,
        Message = BuildMovementMessage(newPosition, hazardDamage)
    };
}

private string BuildMovementMessage(GridPosition pos, TerrainDamageResult? damage)
{
    var msg = $"Moved to {pos}.";
    if (damage?.DamageDealt == true)
        msg += $" {damage.Value.Message}";
    return msg;
}
```

### 8.1 Updated MovementResult

```csharp
public readonly record struct MovementResult
{
    // From v0.5.0b:
    public bool Success { get; init; }
    public GridPosition? OldPosition { get; init; }
    public GridPosition? NewPosition { get; init; }
    public int MovementPointsUsed { get; init; }
    public int MovementPointsRemaining { get; init; }
    public string Message { get; init; }
    public MovementFailureReason? FailureReason { get; init; }

    // NEW in v0.5.2a:
    public TerrainDamageResult? TerrainDamage { get; init; }
}
```

---

## 9. User-Facing Commands

### 9.1 Difficult Terrain Movement

```
> move north

You carefully traverse the rubble...

[Movement: D4 → D3]
[Terrain: Difficult (rubble) - 2x movement cost]
[Movement Points: 4 → 0 remaining]
```

### 9.2 Impassable Terrain

```
> move east

You can't move there - the pit is impassable!

[Cell E4: Pit (impassable terrain)]
```

### 9.3 Hazardous Terrain

```
> move north

You step into the flames!

[Movement: D4 → D3]
[Movement Points: 4 → 2 remaining]

[HAZARD DAMAGE]
The fire burns you for 4 damage!
[Fire terrain: 1d6 = 4 fire damage]
HP: 25/30 → 21/30
```

### 9.4 Position with Terrain Info

```
> position

Your Position: D4 (Normal terrain)
Movement Points: 3 / 4

Nearby Terrain:
  North (D3): Difficult (rubble) - 2x cost
  South (D5): Normal (stone floor)
  East (E4): Impassable (pit)
  West (C4): Hazardous (fire) - 1d6 fire damage
```

---

## 10. Data Model Changes

| Type | Layer | Description |
|------|-------|-------------|
| `TerrainType` | Domain/Enums | Normal, Difficult, Impassable, Hazardous |
| `TerrainDefinition` | Domain/Definitions | Configurable terrain |
| `GridCell` | Domain/ValueObjects | Add terrain properties |
| `ITerrainService` | Application/Interfaces | Terrain service interface |
| `TerrainService` | Application/Services | Terrain calculations |
| `TerrainDamageResult` | Application/DTOs | Hazard damage result |
| `MovementResult` | Application/DTOs | Add TerrainDamage field |

---

## 11. Configuration File Schemas

**File:** `config/terrain.json`

```json
{
  "$schema": "./schemas/terrain.schema.json",
  "terrainDefinitions": [
    {
      "id": "normal-floor",
      "name": "Stone Floor",
      "type": "Normal",
      "movementCostMultiplier": 1.0,
      "displayChar": ".",
      "description": "Normal stone floor"
    },
    {
      "id": "rubble",
      "name": "Rubble",
      "type": "Difficult",
      "movementCostMultiplier": 2.0,
      "displayChar": "~",
      "description": "Difficult terrain - 2x movement cost"
    },
    {
      "id": "shallow-water",
      "name": "Shallow Water",
      "type": "Difficult",
      "movementCostMultiplier": 2.0,
      "displayChar": "≈",
      "description": "Shallow water - 2x movement cost"
    },
    {
      "id": "pit",
      "name": "Pit",
      "type": "Impassable",
      "displayChar": "○",
      "description": "Deep pit - impassable"
    },
    {
      "id": "wall",
      "name": "Wall",
      "type": "Impassable",
      "blocksLOS": true,
      "displayChar": "#",
      "description": "Solid wall - impassable, blocks LOS"
    },
    {
      "id": "fire",
      "name": "Fire",
      "type": "Hazardous",
      "movementCostMultiplier": 1.0,
      "damageOnEntry": "1d6",
      "damageType": "Fire",
      "displayChar": "▲",
      "description": "Flames - 1d6 fire damage on entry"
    },
    {
      "id": "acid-pool",
      "name": "Acid Pool",
      "type": "Hazardous",
      "movementCostMultiplier": 1.5,
      "damageOnEntry": "1d4",
      "damageType": "Acid",
      "displayChar": "●",
      "description": "Acid pool - 1d4 acid damage on entry"
    },
    {
      "id": "spike-trap",
      "name": "Spike Trap",
      "type": "Hazardous",
      "damageOnEntry": "1d8",
      "damageType": "Piercing",
      "displayChar": "^",
      "description": "Spike trap - 1d8 piercing damage on entry"
    }
  ]
}
```

---

## 12. Logging Specifications

| Component | Level | Events |
|-----------|-------|--------|
| `TerrainService` | Debug | Movement cost calculations |
| `TerrainService` | Information | Hazard damage applied |
| `MovementService` | Debug | Terrain integration in moves |

---

## 13. Unit Testing Requirements

| Feature | Test Count |
|---------|------------|
| TerrainType Enum | ~2 |
| TerrainDefinition | ~4 |
| GridCell Terrain Properties | ~5 |
| TerrainService.GetMovementCost | ~5 |
| TerrainService.IsPassable | ~3 |
| TerrainService.DealsDamage | ~3 |
| TerrainService.ApplyTerrainDamage | ~4 |
| MovementService Terrain Integration | ~4 |
| **Total** | **~30** |

---

## 14. Use Cases

### UC-001: Move into Normal Terrain
**Flow:** Player → Move north → Normal terrain → Cost 2 → Success

### UC-002: Move into Difficult Terrain
**Flow:** Player → Move north → Difficult terrain → Cost 4 → Success (if enough points)

### UC-003: Move into Impassable Terrain
**Flow:** Player → Move east → Pit → Fail: Impassable

### UC-004: Move into Hazardous Terrain
**Flow:** Player → Move north → Fire → Cost 2 → Roll 1d6 → Apply damage → Success

### UC-005: Insufficient Points for Difficult
**Flow:** Player → Move NE (3 pts) → Difficult (×2 = 6 pts) → Only 4 pts → Fail

---

## 15. Deliverable Checklist

### Domain Layer
- [ ] `TerrainType` enum
- [ ] `TerrainDefinition` class
- [ ] GridCell terrain properties
- [ ] GridCell.SetTerrain(), SetTerrainDefinition()

### Application Layer
- [ ] `ITerrainService` interface
- [ ] `TerrainService` implementation
- [ ] `TerrainDamageResult` record
- [ ] MovementService terrain integration
- [ ] Updated MovementResult

### Configuration
- [ ] `terrain.json` with definitions
- [ ] `terrain.schema.json`

### Testing
- [ ] ~30 unit tests
- [ ] All tests passing

---

## 16. Acceptance Criteria

### Functional
- [ ] TerrainType enum has Normal, Difficult, Impassable, Hazardous
- [ ] TerrainDefinition stores all terrain properties
- [ ] GridCell.TerrainType stores cell terrain
- [ ] Normal terrain costs 1x movement
- [ ] Difficult terrain costs 2x movement
- [ ] Impassable terrain blocks movement
- [ ] Hazardous terrain deals damage on entry
- [ ] TerrainService calculates movement costs correctly
- [ ] MovementService integrates terrain costs
- [ ] Terrain damage uses DiceService for rolls
- [ ] Terrain configuration loads from JSON

### Quality
- [ ] Build succeeds with 0 errors/warnings
- [ ] ~30 unit tests pass
- [ ] XML documentation complete

---

## 17. Dependencies

### Required from v0.5.0b

| Type | Usage |
|------|-------|
| `MovementCosts` | Base movement costs |
| `MovementService` | Integration point |
| `MovementResult` | Extended with terrain damage |

### Required from v0.5.1c

| Type | Usage |
|------|-------|
| `GridCell.BlocksLOS` | Terrain affects LOS |

### Provides to v0.5.2b
- TerrainDefinition for cover interaction
- Terrain passability for cover placement

### Provides to v0.5.2c
- Terrain display characters
- Terrain for grid rendering

---

## 18. Future Considerations

### Deferred to v0.5.2b
- Cover system
- Cover-terrain interaction

### Deferred to v0.5.2c
- Terrain ASCII display
- Terrain legend in grid view

### Out of Scope for v0.5.2
- Terrain transformation (fire spreading)
- Environmental effects over time
- Terrain-based ability modifiers

---

*Document Version: 1.0*
*Last Updated: 2026-01-10*
*Author: AI Assistant*
