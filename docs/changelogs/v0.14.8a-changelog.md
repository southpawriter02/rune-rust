# v0.14.8a Changelog - Dice Types Schema

**Release Date:** 2026-01-21
**Version:** v0.14.8a
**Phase:** Configuration Consolidation (v0.14.x)
**Sub-Phase:** Dice Configuration (v0.14.8)

---

## Summary

Implemented the **Dice Types Schema** (`dice-types.schema.json`), which provides a comprehensive JSON schema for defining valid die types, dice expression patterns, and validation rules. This schema enables full customization of dice types used throughout the game system without code changes.

The schema validates die definitions including standard RPG dice (d4, d6, d8, d10, d12, d20, d100) and supports custom die types with arbitrary face counts. It also defines the dice expression pattern (`^\d+d\d+([+-]\d+)?$`) used by other configuration files such as skills.json, weapons.json, hazards.json, and terrain.json.

---

## Added

### Schema Files

| File | Description |
|------|-------------|
| `config/schemas/dice-types.schema.json` | JSON Schema for dice type validation |

### Configuration Files

| File | Description |
|------|-------------|
| `config/dice-types.json` | Die type definitions with 7 standard dice |

### Schema Definitions

| Definition | Type | Description |
|------------|------|-------------|
| `DieType` | object | Single die type definition with core properties, computed statistics, classification, and display metadata |
| `DiceExpression` | object | Parsed dice expression representing a dice roll notation |
| `DiceExpressionPattern` | object | Pattern definition for validating dice expressions |

### DieType Properties

| Property | Type | Required | Description |
|----------|------|----------|-------------|
| `id` | string | Yes | Die identifier (pattern: `^d\d+$`, e.g., "d6", "d20") |
| `name` | string | Yes | Human-readable display name |
| `faces` | integer | Yes | Number of faces on the die (minimum: 2) |
| `minValue` | integer | No | Minimum value on the die (default: 1) |
| `maxValue` | integer | No | Maximum value (computed: minValue + faces - 1) |
| `average` | number | No | Average roll value ((min + max) / 2) |
| `isStandard` | boolean | No | Whether this is a standard RPG die (default: true) |
| `sortOrder` | integer | No | Sort order for UI display (minimum: 0) |
| `color` | string | No | Hex color code (pattern: `^#[0-9A-Fa-f]{6}$`) |
| `iconId` | string | No | Icon identifier for UI rendering |
| `description` | string | No | Usage notes for this die type |

### Standard Die Types (7 total)

| ID | Name | Faces | Color | Use Case |
|----|------|-------|-------|----------|
| `d4` | Four-sided Die | 4 | #9C27B0 | Small weapons, minor healing |
| `d6` | Six-sided Die | 6 | #4CAF50 | Common damage, hazards |
| `d8` | Eight-sided Die | 8 | #2196F3 | Medium weapons |
| `d10` | Ten-sided Die | 10 | #FF9800 | Skill checks, large weapons |
| `d12` | Twelve-sided Die | 12 | #E91E63 | Heavy weapons |
| `d20` | Twenty-sided Die | 20 | #F44336 | Attack rolls, saves |
| `d100` | Percentile Die | 100 | #607D8B | Random tables, percentages |

### Dice Expression Pattern

| Property | Value | Description |
|----------|-------|-------------|
| `pattern` | `^\d+d\d+([+-]\d+)?$` | Standard dice notation regex |
| `captureGroups.count` | First `\d+` | Number of dice to roll |
| `captureGroups.faces` | Second `\d+` | Number of faces |
| `captureGroups.modifier` | `[+-]\d+` | Optional modifier |

### Valid Expression Examples

| Expression | Count | Die | Modifier | Range |
|------------|-------|-----|----------|-------|
| `1d6` | 1 | d6 | 0 | 1-6 |
| `2d6` | 2 | d6 | 0 | 2-12 |
| `1d8+2` | 1 | d8 | +2 | 3-10 |
| `3d6-1` | 3 | d6 | -1 | 2-17 |
| `1d20` | 1 | d20 | 0 | 1-20 |
| `1d10+5` | 1 | d10 | +5 | 6-15 |
| `1d100` | 1 | d100 | 0 | 1-100 |

---

## Unit Tests

### Test File

`tests/RuneAndRust.Infrastructure.IntegrationTests/Schemas/DiceTypesSchemaTests.cs`

### Test Summary

| Test ID | Test Name | Description |
|---------|-----------|-------------|
| DTS-001 | `DiceTypesSchema_ValidConfiguration_PassesValidation` | Validates complete configuration with all fields |
| DTS-002 | `DieTypeStructure_MinimalFields_PassesValidation` | Minimal die type with required fields |
| DTS-002 | `DieTypeStructure_WithOptionalFields_PassesValidation` | Die type with all optional fields |
| DTS-002 | `DieTypeStructure_MissingName_FailsValidation` | Missing required name field |
| DTS-002 | `DieTypeStructure_MissingId_FailsValidation` | Missing required id field |
| DTS-002 | `DieTypeStructure_MissingFaces_FailsValidation` | Missing required faces field |
| DTS-002 | `DieTypeStructure_UnknownField_FailsValidation` | Unknown field rejected |
| DTS-003 | `FacesValidation_MinimumValue_PassesValidation` | Faces = 2 (coin flip minimum) |
| DTS-003 | `FacesValidation_LargeValue_PassesValidation` | Faces = 100 |
| DTS-003 | `FacesValidation_BelowMinimum_FailsValidation` | Faces = 1 rejected |
| DTS-003 | `FacesValidation_Zero_FailsValidation` | Faces = 0 rejected |
| DTS-003 | `FacesValidation_Negative_FailsValidation` | Negative faces rejected |
| DTS-004 | `DieTypeIdPattern_ValidIds_PassValidation` | Parameterized: d4, d6, d8, d10, d12, d20, d100, d7, d30 |
| DTS-004 | `DieTypeIdPattern_Uppercase_FailsValidation` | D6 rejected |
| DTS-004 | `DieTypeIdPattern_WithHyphen_FailsValidation` | d-6 rejected |
| DTS-004 | `DieTypeIdPattern_WrongPrefix_FailsValidation` | dice6 rejected |
| DTS-004 | `DieTypeIdPattern_WrongOrder_FailsValidation` | 6d rejected |
| DTS-004 | `DieTypeIdPattern_NoNumber_FailsValidation` | d rejected |
| DTS-005 | `ExpressionPattern_Validation` | Parameterized: valid and invalid expressions |
| DTS-005 | `ExpressionPattern_DefinedInConfiguration_IncludesExamples` | Pattern in config |
| DTS-006 | `ColorHexPattern_ValidColors_PassValidation` | Parameterized: valid hex colors |
| DTS-006 | `ColorHexPattern_ThreeDigit_FailsValidation` | #fff rejected |
| DTS-006 | `ColorHexPattern_MissingHash_FailsValidation` | FF5722 rejected |
| DTS-006 | `ColorHexPattern_InvalidChars_FailsValidation` | #GGGGGG rejected |
| DTS-006 | `ColorHexPattern_NamedColor_FailsValidation` | red rejected |
| DTS-006 | `ColorHexPattern_Omitted_PassesValidation` | Optional, can be omitted |
| — | `DieTypes_EmptyArray_FailsValidation` | Empty array rejected (minItems: 1) |
| — | `DieTypes_MissingField_FailsValidation` | Missing required dieTypes |
| — | `SortOrder_Negative_FailsValidation` | Negative sortOrder rejected |
| — | `DiceTypesJson_Contains7StandardDice` | Verifies all standard dice |

**Total New Tests:** 55 (including parameterized test cases)

---

## Files Created

| File | Lines | Description |
|------|-------|-------------|
| `config/schemas/dice-types.schema.json` | ~170 | Dice types JSON Schema |
| `config/dice-types.json` | ~110 | Standard dice configuration |
| `tests/.../Schemas/DiceTypesSchemaTests.cs` | ~650 | Unit tests for dice schema |
| `docs/changelogs/v0.14.8a-changelog.md` | — | This changelog |

---

## Schema Structure

```
dice-types.schema.json
├── $schema: "http://json-schema.org/draft-07/schema#"
├── $id: "dice-types.schema.json"
├── title: "Dice Types Configuration Schema"
├── type: object
├── properties:
│   ├── $schema (string)
│   ├── version (string, optional)
│   ├── dieTypes → items → $ref: DieType
│   └── expressionPattern → $ref: DiceExpressionPattern
├── required: [dieTypes]
├── additionalProperties: false
└── definitions:
    ├── DieType
    │   ├── id (string, pattern: ^d\d+$)
    │   ├── name (string, minLength: 1)
    │   ├── faces (integer, minimum: 2)
    │   ├── minValue (integer, minimum: 0, default: 1)
    │   ├── maxValue (integer, minimum: 1)
    │   ├── average (number)
    │   ├── isStandard (boolean, default: true)
    │   ├── sortOrder (integer, minimum: 0, default: 0)
    │   ├── color (string, pattern: ^#[0-9A-Fa-f]{6}$)
    │   ├── iconId (string, minLength: 1)
    │   └── description (string)
    ├── DiceExpression
    │   ├── count (integer, minimum: 1, default: 1)
    │   ├── dieType (string, pattern: ^d\d+$)
    │   ├── modifier (integer, default: 0)
    │   └── raw (string, pattern: ^\d+d\d+([+-]\d+)?$)
    └── DiceExpressionPattern
        ├── pattern (string)
        ├── captureGroups (object)
        └── examples (array of string)
```

---

## Validation Rules Summary

| Rule | Validation |
|------|------------|
| Die Type ID pattern | `^d\d+$` (e.g., d4, d6, d20, d100) |
| Faces | Integer, minimum 2 (coin flip) |
| MinValue | Integer, minimum 0 |
| MaxValue | Integer, minimum 1 |
| SortOrder | Integer, minimum 0 |
| Color | Hex pattern `^#[0-9A-Fa-f]{6}$` |
| IconId | String, minLength 1 |
| Expression pattern | `^\d+d\d+([+-]\d+)?$` |
| dieTypes array | minItems: 1 |
| additionalProperties | false (strict validation) |

---

## Key Design Decisions

### 1. Die Type ID Pattern

**Decision:** Die type IDs follow the pattern `^d\d+$` (lowercase 'd' followed by digits).

**Rationale:** This matches the standard dice notation used in RPG systems. The pattern is simple, consistent, and extensible for custom dice (d7, d30, etc.).

### 2. Minimum Faces of 2

**Decision:** The minimum number of faces is 2 (coin flip).

**Rationale:** A die with fewer than 2 faces is mathematically invalid. The coin flip (d2) represents the minimum meaningful randomness.

### 3. Computed vs Explicit Properties

**Decision:** `minValue`, `maxValue`, and `average` are optional but explicitly specified in the configuration.

**Rationale:** While these can be computed from `faces` and `minValue`, explicit specification provides clarity and enables custom dice with non-standard value ranges.

### 4. Hex Color Pattern

**Decision:** Colors must be 6-digit hex codes with hash prefix (`^#[0-9A-Fa-f]{6}$`).

**Rationale:** 6-digit hex provides full color specification. 3-digit shorthand and named colors are excluded for consistency.

### 5. Expression Pattern Location

**Decision:** The dice expression pattern is defined in dice-types.json alongside die types.

**Rationale:** This centralizes all dice-related configuration. The pattern can be referenced by other schemas and configuration loaders.

---

## Dependencies

### Required From

| Version | Dependency | Usage |
|---------|------------|-------|
| v0.14.7 | Descriptor Configuration Schemas | Schema infrastructure patterns |

### Provides To

| Version | Consumer | Usage |
|---------|----------|-------|
| v0.14.8b | Dice Mechanics Schema | Die type references |
| Future | DiceService | Die type loading and expression parsing |
| Future | CombatService | Damage roll calculations |
| Future | SkillService | Skill check dice pools |

---

## Acceptance Criteria Status

| Criteria | Status |
|----------|--------|
| `dice-types.schema.json` created in `config/schemas/` | ✅ Complete |
| `dice-types.json` created with 7 standard die types | ✅ Complete |
| Die type ID pattern validated (`^d\d+$`) | ✅ Complete |
| Faces validated as integer >= 2 | ✅ Complete |
| minValue/maxValue/average fields supported | ✅ Complete |
| isStandard and sortOrder fields supported | ✅ Complete |
| Color validated as optional hex pattern | ✅ Complete |
| iconId and description fields supported | ✅ Complete |
| Expression pattern defined | ✅ Complete |
| Capture groups documented | ✅ Complete |
| Example expressions included | ✅ Complete |
| ~6 unit tests pass (55 tests implemented) | ✅ Complete |
| Schema follows JSON Schema Draft-07 | ✅ Complete |
| Build completes with 0 errors | ✅ Complete |

---

*Document Version: 1.0*
*Last Updated: 2026-01-21*
*Author: Claude (AI Assistant)*
