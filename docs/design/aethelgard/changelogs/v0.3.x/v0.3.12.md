# Changelog: v0.3.12 - The Test Gauntlet (E2E Testing Infrastructure)

**Versions:** v0.3.12a through v0.3.12c
**Release Dates:** 2025-12-23 (Part A), 2025-12-24 (Parts B & C)

---

## Table of Contents

- [Overview](#overview)
- [Key Metrics](#key-metrics)
- [Part A: The Explorer's Path](#part-a-the-explorers-path-e2e-infrastructure)
- [Part B: The Warrior's Trial](#part-b-the-warriors-trial-combat-journey-testing)
- [Part C: The Survivor's Cycle](#part-c-the-survivors-cycle-persistence-testing)
- [Combined Directory Structure](#combined-directory-structure)
- [Running Tests](#running-tests)
- [Design Decisions](#design-decisions)
- [Breaking Changes](#breaking-changes)
- [Migration Notes](#migration-notes)
- [Related Specifications](#related-specifications)
- [Documentation Additions](#documentation-additions)
- [Credits](#credits)

---

## Overview

The v0.3.12 release establishes the **E2E Integration Testing Infrastructure** for Rune & Rust, enabling automated journey testing through complete game sessions. This three-part release introduces:

1. **Part A (The Explorer's Path):** Core infrastructure including `ScriptedInputHandler` for queue-based command feeding, `TestGameHost` for isolated DI container creation, and deterministic RNG seeding via `DiceService`

2. **Part B (The Warrior's Trial):** Combat journey testing with `SetupCombatAsync()`, the "Training Dummy" pattern for configurable weak enemies, and comprehensive attack variant testing

3. **Part C (The Survivor's Cycle):** Persistence testing with named database sharing, `SaveGameAsync()`/`LoadGameAsync()` methods, and the "Survivor's Cycle" pattern for verifying state preservation across simulated application restarts

Together, these components provide a complete testing framework for exploration, combat, and persistence journeys with deterministic reproducibility.

---

## Key Metrics

| Metric | Value |
|--------|-------|
| **Parts Released** | 3 (A, B, C) |
| **New Test Files** | 3 integration test classes |
| **New Infrastructure Files** | 2 (ScriptedInputHandler, TestGameHost) |
| **Total E2E Tests** | 33 (9 + 12 + 12) |
| **Total Project Tests** | 2628 |
| **Test Pass Rate** | 100% |
| **Regressions** | 0 |
| **Files Modified** | 2 (DiceService.cs, TestGameHost.cs) |
| **DI Registrations in TestGameHost** | 40+ services |

---

## Part A: The Explorer's Path (E2E Infrastructure)

**Release Date:** 2025-12-23
**Tests Added:** 9

### Summary

Version 0.3.12a establishes the foundational E2E testing infrastructure:
- **ScriptedInputHandler:** Queue-based command feeding with automatic "quit" on exhaustion
- **TestGameHost:** Self-contained test host with isolated DI container, in-memory database, and seeded RNG
- **DiceService Seeding:** Constructor-injected seed for reproducible random number sequences

### New Files

| File | Purpose |
|------|---------|
| `RuneAndRust.Tests/Infrastructure/ScriptedInputHandler.cs` | Test implementation of `IInputHandler` that feeds commands from a `Queue<string>` |
| `RuneAndRust.Tests/Infrastructure/TestGameHost.cs` | Self-contained test host with isolated DI container and 40+ registered services |
| `RuneAndRust.Tests/Integration/ExplorationJourneyTests.cs` | 9 E2E tests simulating exploration journeys |

### Files Modified

| File | Change |
|------|--------|
| `RuneAndRust.Engine/Services/DiceService.cs` | Added constructor overload with optional `int? seed` for deterministic rolls |

### ScriptedInputHandler

**Key Properties:**

| Property | Type | Description |
|----------|------|-------------|
| `OutputBuffer` | `List<string>` | Captures all `DisplayMessage()` calls |
| `ErrorBuffer` | `List<string>` | Captures all `DisplayError()` calls |
| `PromptBuffer` | `List<string>` | Captures all prompts passed to `GetInput()` |
| `IsScriptExhausted` | `bool` | True when queue is empty |

**Behaviors:**
- Returns `"quit"` when script exhausted (graceful termination)
- Case-insensitive output matching via `OutputContains()`/`ErrorContains()`
- Logs all operations at appropriate levels (Trace/Debug/Info)

### TestGameHost Factory

```csharp
public static TestGameHost Create(int? seed, IEnumerable<string> script, string? databaseName = null)
```

**DI Registrations Include:**
- **Database:** `RuneAndRustDbContext` with `UseInMemoryDatabase()`
- **Repositories:** 12 scoped repository implementations
- **Core Singletons:** `GameState`, `IInputHandler`, `ILoggerFactory`
- **Engine Services:** 25+ services including `IDiceService` (conditionally seeded)

### Exploration Journey Tests (9)

| Test | Description |
|------|-------------|
| `Journey_NewGame_To_FirstRoom_DisplaysWelcome` | Verifies welcome message and help hint |
| `Journey_Look_Command_DisplaysRoomInfo` | Verifies look produces room description |
| `Journey_Navigation_MovesCharacter` | Verifies navigation commands process correctly |
| `Journey_InvalidCommand_ShowsError` | Verifies unknown commands produce feedback |
| `Journey_Help_Command_DisplaysOptions` | Verifies help command output |
| `Journey_ScriptExhaustion_ReturnsQuit` | Verifies graceful termination |
| `Journey_DeterministicSeed_ProducesSameResults` | Identical seeds = identical output |
| `Journey_DifferentSeeds_ProduceDifferentRoomIds` | Different seeds = different databases |
| `Journey_ExtendedExploration_CompletesSuccessfully` | Multi-command journey (7 commands) |

---

## Part B: The Warrior's Trial (Combat Journey Testing)

**Release Date:** 2025-12-24
**Tests Added:** 12

### Summary

Version 0.3.12b extends the infrastructure for combat journey testing:
- **SetupCombatAsync:** Layered initialization building on `SetupExplorationAsync()`
- **Training Dummy Pattern:** Configurable low-HP enemy for rapid test execution
- **Attack Variant Testing:** Standard, light, and heavy attack command verification

### Files Modified

| File | Change |
|------|--------|
| `RuneAndRust.Tests/Infrastructure/TestGameHost.cs` | Added `SetupCombatAsync()` and `GetCombatService()` |

### New Files

| File | Purpose |
|------|---------|
| `RuneAndRust.Tests/Integration/CombatJourneyTests.cs` | 12 E2E combat journey tests |

### SetupCombatAsync Method

```csharp
public async Task SetupCombatAsync(string characterName = "TestWarrior", int enemyHp = 15)
```

**Training Dummy Configuration:**

| Property | Value | Rationale |
|----------|-------|-----------|
| `Name` | `"Training Dummy"` | Clear test identifier |
| `MaxHp` | Configurable (default 15) | Enables rapid combat resolution |
| `WeaponDamageDie` | `4` (d4) | Low damage, won't kill player |
| `ArmorSoak` | `0` | No damage reduction for faster kills |

**Enemy Attributes:** Sturdiness 3, Might 3, Wits 1, Will 1, Finesse 2

### Combat Journey Tests (12)

| Test | Description |
|------|-------------|
| `Combat_Victory_DefeatsEnemy_ReturnsToExploration` | Defeat Training Dummy, verify phase transition |
| `Combat_Flee_EscapesCombat_ReturnsToExploration` | Flee ends combat gracefully |
| `Combat_AttackCommand_DamagesEnemy` | Single attack produces feedback |
| `Combat_DeterministicSeed_ProducesSameOutcome` | Same seed = byte-identical output |
| `Combat_EnemyTurn_ExecutesAfterPlayer` | Enemy AI executes after player pass |
| `Combat_Status_DisplaysCombatantInfo` | Status command produces output |
| `Combat_LightAttack_ExecutesWithReducedStamina` | Light attack variant (+1 hit, d4 damage) |
| `Combat_HeavyAttack_ExecutesWithIncreasedDamage` | Heavy attack variant (-1 hit, d8 damage) |
| `Combat_DifferentSeeds_ProduceDifferentOutcomes` | Different seeds = different RNG |
| `Combat_FullEncounter_CompletesSuccessfully` | Extended combat with mixed attacks |
| `Combat_Setup_SetsCorrectPhase` | Phase is Combat before RunAsync |
| `Combat_GetCombatService_ReturnsValidService` | Helper returns valid service |

---

## Part C: The Survivor's Cycle (Persistence Testing)

**Release Date:** 2025-12-24
**Tests Added:** 12

### Summary

Version 0.3.12c completes the infrastructure with persistence journey testing:
- **DatabaseName Property:** Enables multiple hosts to share the same in-memory database
- **SaveGameAsync/LoadGameAsync:** Convenience methods for state persistence
- **Survivor's Cycle Pattern:** Session A saves, disposes; Session B loads and verifies

### Files Modified

| File | Change |
|------|--------|
| `RuneAndRust.Tests/Infrastructure/TestGameHost.cs` | Added `DatabaseName` property, `GetSaveManager()`, `SaveGameAsync()`, `LoadGameAsync()` |

### New Files

| File | Purpose |
|------|---------|
| `RuneAndRust.Tests/Integration/PersistenceJourneyTests.cs` | 12 E2E persistence tests |

### Key Methods Added

**DatabaseName Property:**
```csharp
public string DatabaseName { get; }
```
Enables sharing the same in-memory database across multiple test hosts.

**SaveGameAsync:**
```csharp
public async Task<bool> SaveGameAsync(int slot)
```
Saves current GameState to specified slot via SaveManager.

**LoadGameAsync:**
```csharp
public async Task<bool> LoadGameAsync(int slot)
```
Loads state from slot and applies to host's GameState singleton.

### State Properties Preserved

| Property | Type | Description |
|----------|------|-------------|
| `CurrentCharacter` | `Character?` | Full character with inventory, stats |
| `CurrentRoomId` | `Guid?` | Player's current location |
| `Phase` | `GamePhase` | Current game phase |
| `TurnCount` | `int` | Turns elapsed |
| `VisitedRoomIds` | `HashSet<Guid>` | Fog of war tracking |
| `IsSessionActive` | `bool` | Session activity flag |

### Survivor's Cycle Pattern

```csharp
// --- SESSION A: The Life ---
using (var hostA = TestGameHost.Create(seed: 42, new[] { "quit" }, sharedDbName))
{
    await hostA.SetupExplorationAsync("TestCharacter");
    expectedRoomId = hostA.GameState.CurrentRoomId!.Value;
    await hostA.SaveGameAsync(saveSlot);
}
// hostA disposed - simulating app shutdown

// --- SESSION B: The Afterlife ---
using (var hostB = TestGameHost.Create(seed: 42, new[] { "quit" }, sharedDbName))
{
    await hostB.LoadGameAsync(saveSlot);
    hostB.GameState.CurrentRoomId.Should().Be(expectedRoomId);
}
```

### Persistence Journey Tests (12)

| Test | Description |
|------|-------------|
| `Journey_SaveLoad_PreservesLocation` | CurrentRoomId survives save/load |
| `Journey_SaveLoad_PreservesCharacter` | Name, MaxHP, Lineage, Archetype preserved |
| `Journey_SaveLoad_PreservesVisitedRooms` | Fog of war HashSet preserved |
| `Journey_SaveLoad_PreservesPhase` | GamePhase.Exploration preserved |
| `Journey_SaveLoad_PreservesTurnCount` | TurnCount value preserved |
| `Journey_SaveLoad_DifferentSlotsAreIsolated` | Slot 1 and Slot 2 contain different data |
| `Journey_SaveLoad_OverwritesExistingSlot` | Second save replaces first |
| `Journey_Load_NonExistentSlot_ReturnsFalse` | Empty slot returns false |
| `Journey_DatabaseName_IsExposedForReuse` | Property matches input |
| `Journey_SharedDatabase_PersistsAcrossHosts` | Different hosts share saves |
| `Journey_SaveLoad_PreservesInventoryCount` | Inventory items with quantities preserved |
| `Journey_SurvivorsCycle_CompleteStatePreservation` | Damage, inventory, turns, fog of war |

---

## Combined Directory Structure

```
RuneAndRust.Engine/
└── Services/
    └── DiceService.cs                         [MODIFIED - v0.3.12a]

RuneAndRust.Tests/
├── Infrastructure/
│   ├── ScriptedInputHandler.cs                [NEW - v0.3.12a]
│   └── TestGameHost.cs                        [NEW - v0.3.12a, MODIFIED - v0.3.12b/c]
└── Integration/
    ├── ExplorationJourneyTests.cs             [NEW - v0.3.12a]
    ├── CombatJourneyTests.cs                  [NEW - v0.3.12b]
    └── PersistenceJourneyTests.cs             [NEW - v0.3.12c]
```

---

## Running Tests

**Run all E2E journey tests (33 tests):**
```bash
dotnet test --filter "FullyQualifiedName~JourneyTests"
```

**Run exploration tests only (9 tests):**
```bash
dotnet test --filter "FullyQualifiedName~ExplorationJourneyTests"
```

**Run combat tests only (12 tests):**
```bash
dotnet test --filter "FullyQualifiedName~CombatJourneyTests"
```

**Run persistence tests only (12 tests):**
```bash
dotnet test --filter "FullyQualifiedName~PersistenceJourneyTests"
```

**Run with verbose output:**
```bash
dotnet test --filter "JourneyTests" --logger "console;verbosity=detailed"
```

**Run specific determinism tests:**
```bash
dotnet test --filter "DeterministicSeed"
```

---

## Design Decisions

### Why Queue-Based Input?
`Queue<string>` provides FIFO ordering matching natural command sequences. The `Dequeue()` operation is O(1). When exhausted, returning "quit" ensures graceful test termination without hanging.

### Why In-Memory Database per Test?
Each `TestGameHost.Create()` generates a unique database name using `Guid.NewGuid()`. This prevents cross-contamination between tests. Named sharing via `databaseName` parameter enables persistence testing across hosts.

### Why Constructor Chaining for DiceService?
The original constructor chains to the seeded constructor with `seed: null`, maintaining backward compatibility. Existing code works unchanged while tests get deterministic dice.

### Why Training Dummy Pattern?
Real enemies (60+ HP) make tests slow. A "Training Dummy" with configurable HP (default 15) enables victory in few attacks. Weak stats (d4 damage, 0 accuracy) prevent player death during tests.

### Why Named Database Sharing?
EF Core's in-memory provider supports named databases. This approach tests JSON serialization without requiring Docker/PostgreSQL, matching existing v0.3.12a/b patterns while enabling cross-host state verification.

### Why Apply State to Singleton GameState?
`SaveManager.LoadGameAsync()` returns a new `GameState` instance, but services reference the singleton. Copying properties preserves DI container integrity while enabling proper state restoration.

---

## Breaking Changes

None. All changes are additive infrastructure for testing only.

---

## Migration Notes

No migration required. Test infrastructure is isolated in the Tests project.

---

## Related Specifications

- **SPEC-DICE-001:** DiceService seeding impacts dice roll determinism
- **SPEC-SAVE-001:** SaveManager integration for persistence testing
- **SPEC-COMBAT-001:** Combat flow exercised by CombatJourneyTests

---

## Documentation Additions

This version introduces comprehensive test infrastructure documentation:

| Document | Content |
|----------|---------|
| `v0.3.12a.md` | ScriptedInputHandler, TestGameHost, seeded DiceService (445 lines) |
| `v0.3.12b.md` | SetupCombatAsync, Training Dummy pattern (388 lines) |
| `v0.3.12c.md` | Persistence methods, Survivor's Cycle pattern (573 lines) |
| **`v0.3.12.md`** | This consolidated changelog |

---

## Credits

**Primary Developer:** The Architect (Claude)
**Test Coverage:** 100% for all 33 E2E JourneyTests
**Regression:** Zero regressions throughout all three parts
**Documentation:** Follows CHANGELOG_GENERATION_RULES.md Extended Template
