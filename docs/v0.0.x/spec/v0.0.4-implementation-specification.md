# v0.0.4 Implementation Specification: Classes & Abilities

**Version:** 0.0.4
**Implementation Date:** 2026-01-06
**Design Specification:** [v0.0.4-scope-breakdown.md](../v0.0.4-scope-breakdown.md)
**Changelogs:** [v0.0.4a](../../changelogs/v0.0.4a-changelog.md), [v0.0.4b](../../changelogs/v0.0.4b-changelog.md), [v0.0.4c](../../changelogs/v0.0.4c-changelog.md), [v0.0.4d](../../changelogs/v0.0.4d-changelog.md)

---

## 1. Overview

### 1.1 Summary

v0.0.4 introduces the class and ability system, allowing players to select a class during character creation which determines their resource type, starting abilities, and stat modifiers. The system includes resource management with regeneration/decay mechanics and a complete ability framework with costs, cooldowns, and effects.

### 1.2 Key Features

- **3 Archetypes**: Warrior, Mystic, Rogue with distinct playstyles
- **9 Classes**: 3 per archetype with unique stat modifiers and abilities
- **5 Resource Types**: Mana, Rage, Faith, Stamina, Focus with different behaviors
- **15 Abilities**: Damage, healing, buff, and utility abilities
- **Turn-Based Processing**: Resource regeneration/decay and cooldown reduction

### 1.3 Deviations from Design

None significant; implementation matches design specification.

---

## 2. Architecture

### 2.1 Layer Interactions

```
┌─────────────────────────────────────────────────────────────┐
│                    Presentation Layer                        │
│  CharacterCreationView → ClassService → IGameRenderer        │
│  GameView → AbilityService → IGameRenderer                   │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                    Application Layer                         │
│  ClassService, AbilityService, ResourceService               │
│  GameSessionService (orchestration)                          │
│  IConfigurationProvider                                      │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                      Domain Layer                            │
│  ClassDefinition, AbilityDefinition, ResourceTypeDefinition  │
│  Player (resources, abilities), PlayerAbility                │
│  CombatService                                               │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                   Infrastructure Layer                       │
│  JsonConfigurationProvider                                   │
│  config/archetypes.json, classes.json, abilities.json, etc. │
└─────────────────────────────────────────────────────────────┘
```

### 2.2 Key Patterns

- **Definition Pattern**: Immutable configuration entities loaded from JSON (ADR-006)
- **Factory Pattern**: `Create()` methods with validation
- **Service Pattern**: Stateless services for business logic
- **DTO Pattern**: Transfer objects for presentation layer

### 2.3 Dependencies

- No new external dependencies
- Internal: Domain definitions depend on value objects

---

## 3. Data Model

### 3.1 Definitions

| Entity | Key Properties |
|--------|----------------|
| `ArchetypeDefinition` | Id, Name, Description, Color, ClassIds |
| `ClassDefinition` | Id, Name, ArchetypeId, StatModifiers, GrowthRates, PrimaryResourceId, StartingAbilityIds |
| `ResourceTypeDefinition` | Id, Name, Abbreviation, Color, MaxValue, RegenPerTurnCombat, RegenPerTurnNonCombat, StartsAtZero |
| `AbilityDefinition` | Id, Name, Description, ClassIds, Cost, Cooldown, Effects, TargetType |

### 3.2 Value Objects

| Value Object | Purpose |
|--------------|---------|
| `StatModifiers` | Health, Attack, Defense modifiers |
| `GrowthRates` | Per-level stat increases |
| `ClassRequirements` | Minimum attribute requirements |
| `AbilityCost` | ResourceTypeId, Amount |
| `AbilityEffect` | EffectType, Value, Duration, Scaling |
| `ResourcePool` | TypeId, Current, Maximum |
| `ResourceChange` | Before, After, ChangeType |

### 3.3 Player Extensions

| Property/Method | Description |
|-----------------|-------------|
| `Player.ArchetypeId` | Selected archetype ID |
| `Player.ClassId` | Selected class ID |
| `Player.Resources` | Dictionary of resource pools |
| `Player.Abilities` | Dictionary of player abilities |
| `Player.SetClass()` | Assign class and archetype |
| `Player.InitializeResource()` | Create resource pool |
| `Player.AddAbility()` | Add ability to player |

---

## 4. Services

### 4.1 ClassService

```csharp
GetArchetypes() → IReadOnlyList<ArchetypeDefinition>
GetClasses() → IReadOnlyList<ClassDefinition>
GetClassesForArchetype(archetypeId) → IReadOnlyList<ClassDefinition>
GetClass(classId) → ClassDefinition
AssignClass(player, classDefinition) → void
```

### 4.2 ResourceService

```csharp
InitializeResources(player, classDefinition) → void
ProcessTurnEnd(player, isInCombat) → IReadOnlyList<ResourceChange>
SpendResource(player, typeId, amount) → SpendResult
RestoreResource(player, typeId, amount) → void
GetResourceDisplay(player) → IReadOnlyList<ResourceDisplayDto>
```

### 4.3 AbilityService

```csharp
GetAbilityDefinition(abilityId) → AbilityDefinition
GetAbilitiesForClass(classId) → IReadOnlyList<AbilityDefinition>
CanUseAbility(player, abilityId) → (bool, string?)
UseAbility(player, abilityId, target?) → UseAbilityResult
InitializePlayerAbilities(player, classDefinition) → void
ProcessTurnEnd(player) → IReadOnlyList<CooldownChangeDto>
```

### 4.4 GameSessionService

```csharp
ProcessTurnEnd() → TurnEndResult
IsInCombat() → bool
```

---

## 5. Configuration

### 5.1 JSON Files

| File | Content |
|------|---------|
| `archetypes.json` | 3 archetypes (Warrior, Mystic, Rogue) |
| `classes.json` | 9 classes (3 per archetype) |
| `resource-types.json` | 5 resource types |
| `abilities.json` | 15 abilities |

### 5.2 Example Configuration

```json
{
  "classes": [
    {
      "id": "berserker",
      "name": "Berserker",
      "description": "A fierce warrior who channels rage into devastating attacks.",
      "archetypeId": "warrior",
      "statModifiers": { "health": 15, "attack": 5, "defense": 0 },
      "growthRates": { "health": 6, "attack": 2, "defense": 1 },
      "primaryResourceId": "rage",
      "startingAbilityIds": ["rage-strike", "battle-cry"]
    }
  ]
}
```

### 5.3 Resource Behaviors

| Resource | Start | Combat Regen | Non-Combat Regen |
|----------|-------|--------------|------------------|
| Mana | Full | +5/turn | +10/turn |
| Rage | Zero | +15/turn | -10/turn |
| Faith | Full | +3/turn | +5/turn |
| Stamina | Full | +8/turn | +15/turn |
| Focus | Full | +5/turn | +10/turn |

---

## 6. Commands & Rendering

### 6.1 Commands

| Command | Action |
|---------|--------|
| `use [ability]` | Activate ability |
| `abilities` | List player abilities |
| `class` | Show class information |

### 6.2 Display

- Archetype/class selection screens with descriptions
- Ability list with cooldown status
- Resource bar with regeneration indicators
- Turn-end summary with resource and cooldown changes

---

## 7. Use Cases

### 7.1 Primary Use Cases

- [UC-002: Select Class](../../use-cases/player/UC-002-select-class.md)
- [UC-006: Use Ability](../../use-cases/player/UC-006-use-ability.md)
- [UC-101: Process Turn End](../../use-cases/system/UC-101-process-turn-end.md)
- [UC-102: Regenerate Resources](../../use-cases/system/UC-102-regenerate-resources.md)
- [UC-103: Reduce Cooldowns](../../use-cases/system/UC-103-reduce-cooldowns.md)

### 7.2 Edge Cases

- Ability use with insufficient resources
- Ability on cooldown
- Resource at max during regeneration
- Rage decay to zero outside combat

---

## 8. Testing

### 8.1 Test Coverage

| Phase | Tests | Areas |
|-------|-------|-------|
| v0.0.4a | 40 | Class/Archetype definitions, ClassService |
| v0.0.4b | 30 | Resource types, ResourcePool, ResourceService |
| v0.0.4c | - | AbilityDefinition, AbilityService (included in total) |
| v0.0.4d | 16 | Turn processing, integration |
| **Total** | **198** | Domain: 123, Application: 67, Architecture: 8 |

### 8.2 Key Test Scenarios

- Class definition validation and factory methods
- Player class assignment and stat modification
- Resource pool spend/restore operations
- Ability cost validation and cooldown mechanics
- Turn-end processing for resources and cooldowns
- Combat integration with monster counterattack

---

## 9. Known Limitations

### 9.1 Current Limitations

- No multi-class support
- No ability learning/forgetting mid-game
- Status effects are placeholder (full implementation in v0.0.6)
- No attribute-based ability scaling

### 9.2 Future Improvements

- v0.0.5: Dice-based ability scaling
- v0.0.6: Full status effect integration
- v0.0.8: Level-based ability unlocks

---

## 10. Related Documentation

- **ADRs**: [ADR-002](../../architecture/ADR-002-json-configuration.md), [ADR-006](../../architecture/ADR-006-definition-pattern.md), [ADR-007](../../architecture/ADR-007-resource-system.md)
- **Use Cases**: UC-002, UC-006, UC-101, UC-102, UC-103
