# v0.1.5c Design Specification: Trap Placement System

**Version:** 0.1.5c
**Phase Name:** Trap Placement System
**Parent Version:** v0.1.5 (Procedural Puzzles & Secrets)
**Prerequisites:** v0.1.5b Complete (Secret Room Generation)
**Estimated Tests:** ~22 unit tests

---

## Table of Contents

1. [Executive Summary](#1-executive-summary)
2. [Feature Overview](#2-feature-overview)
3. [Architecture Diagrams](#3-architecture-diagrams)
4. [TrapTriggerType Enum](#4-traptriggertype-enum)
5. [TrapLocation Enum](#5-traplocation-enum)
6. [TrapDefinition Entity](#6-trapdefinition-entity)
7. [TrapPlacement Value Object](#7-trapplacement-value-object)
8. [TrapInstance Entity](#8-trapinstance-entity)
9. [TrapPlacementService](#9-trapplacementservice)
10. [TrapPlacementContext Record](#10-trapplacementcontext-record)
11. [Configuration File Schemas](#11-configuration-file-schemas)
12. [Logging Specifications](#12-logging-specifications)
13. [Unit Testing Requirements](#13-unit-testing-requirements)
14. [Use Cases](#14-use-cases)
15. [Deliverable Checklist](#15-deliverable-checklist)
16. [Acceptance Criteria](#16-acceptance-criteria)
17. [Dependencies](#17-dependencies)
18. [Future Considerations](#18-future-considerations)

---

## 1. Executive Summary

### 1.1 Purpose

Implement trap type definitions and placement logic for procedural trap generation during dungeon creation. This phase determines where traps are placed, what types are appropriate for the context, and assigns detection/disarm DCs. This is **generation-only**—the actual trap mechanics (triggering, disarming, damage application) are deferred to v0.4.0 (Interactive Environment & Puzzles).

### 1.2 Current State

| Area | Current State (v0.1.5b) | Target State (v0.1.5c) |
|------|-------------------------|------------------------|
| Trap types | Not defined | 4 trap types (Poison Dart, Pit, Fire Jet, Cave-in) |
| Trap definitions | None | JSON-configurable definitions with DC, damage, and biome filtering |
| Trap placement | N/A | Context-aware placement during dungeon generation |
| DC scaling | N/A | Depth-based detection/disarm DC scaling |
| Trap density | N/A | Room-type based density rules |
| Trigger types | None | 4 trigger types (Movement, ContainerOpen, PressurePlate, Interaction) |

### 1.3 Key Deliverables

| Category | Items |
|----------|-------|
| **Entities** | `TrapDefinition`, `TrapInstance` |
| **Value Objects** | `TrapPlacement` |
| **Enums** | `TrapTriggerType`, `TrapLocation` |
| **Records** | `TrapPlacementContext` |
| **Services** | `TrapPlacementService` (with `ITrapPlacementService` interface) |
| **Configuration** | `traps.json`, `traps.schema.json` |
| **Tests** | ~22 new unit tests |

### 1.4 Architectural Significance

This version establishes the **procedural trap placement pattern** that complements the puzzle and secret room systems:
- Definition-based trap configuration loaded from JSON
- Context-aware placement using biome, architectural style, and depth
- Weighted random selection for trap type determination
- DC scaling by dungeon depth (Detection/Disarm DC = Base DC + depth/2)
- Trap density scaling by room type
- Placement location generation based on trigger type
- Integration with SecretRoomTemplate.CanContainTraps from v0.1.5b
- Foundation for trap mechanics in v0.4.0

### 1.5 Scope Boundaries

| In Scope (v0.1.5c - Generation) | Out of Scope (Deferred to v0.4.0 - Interaction) |
|--------------------------------|------------------------------------------------|
| TrapDefinition configurations | `disarm` command |
| TrapInstance placement | Detection checks |
| Detection/Disarm DC assignment | Trigger mechanics |
| Trap density by room type | Damage application |
| Biome/style filtering | Status effect application |
| Placement location generation | Trap state persistence (triggered/disabled) |

---

## 2. Feature Overview

```
v0.1.5c Trap Placement System
├── TrapTriggerType Enum
│   ├── Movement (room area trigger)
│   ├── ContainerOpen (chest/container trigger)
│   ├── PressurePlate (specific tile trigger)
│   └── Interaction (object interaction trigger)
├── TrapLocation Enum
│   ├── Entrance (near room entrance)
│   ├── Floor (room floor area)
│   ├── Container (on chest/container)
│   ├── Door (on door mechanism)
│   └── Wall (wall-mounted)
├── TrapDefinition Entity
│   ├── Unique ID and display name
│   ├── Hidden description (before detection)
│   ├── Revealed description (after detection)
│   ├── Trigger description (when activated)
│   ├── Base detection DC
│   ├── Base disarm DC
│   ├── Damage expression (dice notation)
│   ├── Damage type ID
│   ├── Status effect IDs
│   ├── Depth range (min/max)
│   ├── Biome filtering (allowed biomes)
│   ├── Style filtering (architectural styles)
│   ├── Resettable flag
│   ├── Trigger type
│   └── Placement weight for selection
├── TrapPlacement Value Object
│   ├── Location type
│   ├── Associated object ID
│   └── Placement description
├── TrapInstance Entity
│   ├── Unique instance ID
│   ├── Room reference
│   ├── Definition reference
│   ├── Scaled detection DC
│   ├── Scaled disarm DC
│   └── Placement details
├── TrapPlacementService
│   ├── GenerateTraps(context) - creates trap instances
│   ├── ShouldPlaceTraps(context) - placement decision
│   ├── CalculateTrapCount(context) - density calculation
│   ├── SelectTrapDefinition(definitions) - weighted selection
│   └── GeneratePlacement(definition, context) - location generation
├── TrapPlacementContext Record
│   ├── Room ID
│   ├── Dungeon depth
│   ├── Biome ID and name
│   ├── Architectural style ID
│   ├── World seed
│   └── Room type
└── Configuration
    ├── traps.json (trap definitions)
    └── traps.schema.json (validation)
```

---

## 3. Architecture Diagrams

### 3.1 Layer Diagram

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           PRESENTATION LAYER                                 │
├─────────────────────────────────────────────────────────────────────────────┤
│  Room descriptions include trap presence hints (v0.4.0 adds detection)       │
│  ├── GameView displays hidden/revealed descriptions                         │
│  ├── Trap details shown after successful detection                          │
│  └── Trigger descriptions on trap activation                                │
└─────────────────────────────────────────────────────────────────────────────┘
                                      │
                                      ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                           APPLICATION LAYER                                  │
├─────────────────────────────────────────────────────────────────────────────┤
│  TrapPlacementService                                                        │
│  ├── GenerateTraps(context)        ├── CalculateTrapCount(context)          │
│  ├── ShouldPlaceTraps(context)     ├── SelectTrapDefinition(definitions)    │
│  └── GeneratePlacement(def, ctx)                                            │
│                                                                              │
│  Interfaces:                        Consumed By:                             │
│  └── ITrapPlacementService          ├── DungeonGeneratorService             │
│                                     ├── SecretRoomPlacementService          │
│                                     └── VaultGenerationService (v0.1.5d)    │
│                                                                              │
│  Records:                           Dependencies:                            │
│  └── TrapPlacementContext           ├── IConfigurationProvider              │
│                                     ├── ISeededRandomService                │
│                                     └── ILogger<TrapPlacementService>       │
└─────────────────────────────────────────────────────────────────────────────┘
                                      │
                                      ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                             DOMAIN LAYER                                     │
├─────────────────────────────────────────────────────────────────────────────┤
│  Definitions (IDefinition):     Value Objects:                               │
│  ┌─────────────────────────┐    ┌─────────────────────────┐                 │
│  │ TrapDefinition          │    │ TrapPlacement           │                 │
│  │ ├── Id: string          │    │ ├── Location: TrapLoc   │                 │
│  │ ├── Name: string        │    │ ├── ObjectId: string?   │                 │
│  │ ├── HiddenDescription   │    │ └── Description: string │                 │
│  │ ├── RevealedDescription │    └─────────────────────────┘                 │
│  │ ├── TriggerDescription  │                                                │
│  │ ├── BaseDetectionDC     │    Enums:                                      │
│  │ ├── BaseDisarmDC        │    ┌─────────────────────────┐                 │
│  │ ├── DamageExpression    │    │ TrapTriggerType         │                 │
│  │ ├── DamageTypeId        │    │ ├── Movement            │                 │
│  │ ├── StatusEffectIds     │    │ ├── ContainerOpen       │                 │
│  │ ├── MinDepth: int       │    │ ├── PressurePlate       │                 │
│  │ ├── MaxDepth: int       │    │ └── Interaction         │                 │
│  │ ├── AllowedBiomes       │    └─────────────────────────┘                 │
│  │ ├── AllowedStyles       │    ┌─────────────────────────┐                 │
│  │ ├── Resettable: bool    │    │ TrapLocation            │                 │
│  │ ├── TriggerType         │    │ ├── Entrance            │                 │
│  │ └── PlacementWeight     │    │ ├── Floor               │                 │
│  └─────────────────────────┘    │ ├── Container           │                 │
│                                 │ ├── Door                │                 │
│  Entities (IEntity):            │ └── Wall                │                 │
│  ┌─────────────────────────┐    └─────────────────────────┘                 │
│  │ TrapInstance            │                                                │
│  │ ├── Id: Guid            │                                                │
│  │ ├── RoomId: Guid        │                                                │
│  │ ├── DefinitionId: str   │                                                │
│  │ ├── DetectionDC: int    │                                                │
│  │ ├── DisarmDC: int       │                                                │
│  │ └── Placement           │                                                │
│  └─────────────────────────┘                                                │
└─────────────────────────────────────────────────────────────────────────────┘
                                      │
                                      ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                         INFRASTRUCTURE LAYER                                 │
├─────────────────────────────────────────────────────────────────────────────┤
│  JsonConfigurationProvider                                                   │
│  ├── GetTrapDefinitions(): IReadOnlyList<TrapDefinition>                    │
│  └── Loads and deserializes config/traps.json                               │
│                                                                              │
│  Configuration Files:                                                        │
│  ├── config/traps.json                                                      │
│  └── config/schemas/traps.schema.json                                       │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 3.2 Trap Generation Flow

```
┌───────────────────────────────────────────────────────────────┐
│ Dungeon generation creates room with RoomType.Trap            │
│ or Treasure/Corridor room with trap probability               │
└───────────────┬───────────────────────────────────────────────┘
                │
                ▼
┌───────────────────────────────────────────────────────────────┐
│ TrapPlacementService.ShouldPlaceTraps(context)                │
├───────────────────────────────────────────────────────────────┤
│ Checks room type:                                             │
│ ├── RoomType.Trap → always true                               │
│ ├── RoomType.Treasure → 70% chance                            │
│ ├── RoomType.Corridor → 20% chance                            │
│ ├── RoomType.Boss → 30% chance                                │
│ └── Others → 10% chance                                       │
└───────────────┬───────────────────────────────────────────────┘
                │ (if true)
                ▼
┌───────────────────────────────────────────────────────────────┐
│ TrapPlacementService.GenerateTraps(context)                   │
└───────────────┬───────────────────────────────────────────────┘
                │
                ▼
┌───────────────────────────────────────────────────────────────┐
│ Step 1: Filter definitions by context                         │
├───────────────────────────────────────────────────────────────┤
│ _configurationProvider.GetTrapDefinitions()                   │
│     .Where(d => d.IsValidFor(depth, biomeId, styleId))        │
│                                                               │
│ IsValidFor checks:                                            │
│ ├── depth >= MinDepth                                         │
│ ├── depth <= MaxDepth (if MaxDepth > 0)                       │
│ ├── BiomeId in AllowedBiomes (if list not empty)              │
│ └── StyleId in AllowedStyles (if list not empty)              │
└───────────────┬───────────────────────────────────────────────┘
                │
                ▼
┌───────────────────────────────────────────────────────────────┐
│ Step 2: Calculate trap count based on room type               │
├───────────────────────────────────────────────────────────────┤
│ CalculateTrapCount(context)                                   │
│ ├── RoomType.Trap: base 3                                     │
│ ├── RoomType.Treasure: base 2                                 │
│ ├── RoomType.Corridor: base 1                                 │
│ └── Others: base 1                                            │
│                                                               │
│ Final count = min(base + (depth / 5), 5)                      │
└───────────────┬───────────────────────────────────────────────┘
                │
                ▼
┌───────────────────────────────────────────────────────────────┐
│ Step 3: For each trap to place                                │
├───────────────────────────────────────────────────────────────┤
│ Loop trapCount times:                                         │
│ ├── SelectTrapDefinition(definitions) - weighted random       │
│ ├── GeneratePlacement(definition, context, index)             │
│ └── TrapInstance.Create(roomId, definition, depth, placement) │
└───────────────┬───────────────────────────────────────────────┘
                │
                ▼
┌───────────────────────────────────────────────────────────────┐
│ Step 4: Select trap definition (weighted random)              │
├───────────────────────────────────────────────────────────────┤
│ SelectTrapDefinition(definitions)                             │
│ ├── totalWeight = sum of all PlacementWeight                  │
│ ├── roll = random(0, totalWeight)                             │
│ └── Return first definition where cumulative > roll           │
└───────────────┬───────────────────────────────────────────────┘
                │
                ▼
┌───────────────────────────────────────────────────────────────┐
│ Step 5: Generate placement based on trigger type              │
├───────────────────────────────────────────────────────────────┤
│ GeneratePlacement(definition, context, index)                 │
│ ├── PressurePlate → TrapPlacement.OnFloor("Floor section N")  │
│ ├── ContainerOpen → TrapPlacement.OnContainer("chest-N")      │
│ ├── Movement → TrapPlacement.OnFloor("Center of room")        │
│ └── Interaction → TrapPlacement.OnFloor("Hidden location")    │
└───────────────┬───────────────────────────────────────────────┘
                │
                ▼
┌───────────────────────────────────────────────────────────────┐
│ Step 6: Create TrapInstance with scaled DCs                   │
├───────────────────────────────────────────────────────────────┤
│ TrapInstance.Create(                                          │
│     roomId: context.RoomId,                                   │
│     definition: selectedDefinition,                           │
│     depth: context.Depth,                                     │
│     placement: generatedPlacement                             │
│ )                                                             │
│                                                               │
│ DC Scaling:                                                   │
│ ├── DetectionDC = BaseDetectionDC + (depth / 2)               │
│ └── DisarmDC = BaseDisarmDC + (depth / 2)                     │
└───────────────┬───────────────────────────────────────────────┘
                │
                ▼
┌───────────────────────────────────────────────────────────────┐
│ Return TrapInstance[] to dungeon generator                    │
│ Instances stored with room for v0.4.0 interaction             │
└───────────────────────────────────────────────────────────────┘
```

### 3.3 Definition Filtering Flow

```
┌───────────────────────────────────────────────────────────────┐
│ Context: Depth=5, BiomeId="volcanic-caves", StyleId="ancient" │
└───────────────┬───────────────────────────────────────────────┘
                │
                ▼
┌───────────────────────────────────────────────────────────────┐
│ Definition Pool (from traps.json)                             │
├───────────────────────────────────────────────────────────────┤
│ ┌─────────────────────────────────────────────────────────┐   │
│ │ poison-dart                                             │   │
│ │ ├── MinDepth: 1, MaxDepth: 0 (no limit)                │   │
│ │ ├── AllowedBiomes: [] (all)                            │   │
│ │ ├── AllowedStyles: ["carved-halls", "ruined-structures"]│  │
│ │ └── PlacementWeight: 100                               │   │
│ │     → IsValidFor(5, "volcanic-caves", "ancient")       │   │
│ │     → Style mismatch: EXCLUDED                          │   │
│ └─────────────────────────────────────────────────────────┘   │
│ ┌─────────────────────────────────────────────────────────┐   │
│ │ pit-trap                                                │   │
│ │ ├── MinDepth: 1, MaxDepth: 0 (no limit)                │   │
│ │ ├── AllowedBiomes: [] (all)                            │   │
│ │ ├── AllowedStyles: ["carved-halls", "ancient-temple"]  │   │
│ │ └── PlacementWeight: 80                                │   │
│ │     → IsValidFor(5, "volcanic-caves", "ancient")       │   │
│ │     → Style mismatch: EXCLUDED                          │   │
│ └─────────────────────────────────────────────────────────┘   │
│ ┌─────────────────────────────────────────────────────────┐   │
│ │ fire-jet                                                │   │
│ │ ├── MinDepth: 3, MaxDepth: 0 (no limit)                │   │
│ │ ├── AllowedBiomes: ["volcanic-caves"]                  │   │
│ │ ├── AllowedStyles: ["ancient-temple"]                  │   │
│ │ └── PlacementWeight: 60                                │   │
│ │     → IsValidFor(5, "volcanic-caves", "ancient")       │   │
│ │     → Biome match, depth OK: INCLUDED                   │   │
│ └─────────────────────────────────────────────────────────┘   │
│ ┌─────────────────────────────────────────────────────────┐   │
│ │ cave-in                                                 │   │
│ │ ├── MinDepth: 2, MaxDepth: 0 (no limit)                │   │
│ │ ├── AllowedBiomes: ["natural-caves"]                   │   │
│ │ ├── AllowedStyles: ["natural-caves", "ruined"]         │   │
│ │ └── PlacementWeight: 50                                │   │
│ │     → IsValidFor(5, "volcanic-caves", "ancient")       │   │
│ │     → Biome mismatch: EXCLUDED                          │   │
│ └─────────────────────────────────────────────────────────┘   │
└───────────────┬───────────────────────────────────────────────┘
                │
                ▼
┌───────────────────────────────────────────────────────────────┐
│ Valid Definitions: [fire-jet]                                 │
│ Selection: fire-jet (only option, weight 60)                  │
└───────────────────────────────────────────────────────────────┘
```

---

## 4. TrapTriggerType Enum

### 4.1 Purpose

The `TrapTriggerType` enum categorizes how traps are activated. Each type determines the trap's placement location and interaction pattern (implemented in v0.4.0).

### 4.2 File Location

**File:** `src/Core/RuneAndRust.Domain/Enums/TrapTriggerType.cs`

### 4.3 Implementation

```csharp
namespace RuneAndRust.Domain.Enums;

/// <summary>
/// Types of trap triggers determining activation conditions.
/// </summary>
/// <remarks>
/// Each trigger type affects placement location and detection.
/// Actual triggering mechanics are implemented in v0.4.0.
/// </remarks>
public enum TrapTriggerType
{
    /// <summary>
    /// Triggers on movement within the room area.
    /// </summary>
    /// <remarks>
    /// Activates when a creature moves through the trapped area.
    /// Often covers a wide area of the room.
    /// </remarks>
    Movement = 0,

    /// <summary>
    /// Triggers when opening a container.
    /// </summary>
    /// <remarks>
    /// Activates when a chest, box, or similar container is opened.
    /// Placed directly on the container object.
    /// </remarks>
    ContainerOpen = 1,

    /// <summary>
    /// Triggers on a specific tile (pressure plate).
    /// </summary>
    /// <remarks>
    /// Activates when stepped on. More precise than Movement traps.
    /// Can potentially be jumped over or avoided.
    /// </remarks>
    PressurePlate = 2,

    /// <summary>
    /// Triggers when interacting with a specific object.
    /// </summary>
    /// <remarks>
    /// Activates on object interaction (lever, door, etc.).
    /// Requires specific player action to trigger.
    /// </remarks>
    Interaction = 3
}
```

### 4.4 Type Characteristics Summary

| Type | Trigger Condition | Avoidability | Typical Location |
|------|-------------------|--------------|------------------|
| Movement | Enter trapped area | Low | Room center/entrance |
| ContainerOpen | Open container | High (don't open) | On containers |
| PressurePlate | Step on tile | Medium (jump/avoid) | Floor sections |
| Interaction | Use object | High (don't interact) | Objects/mechanisms |

---

## 5. TrapLocation Enum

### 5.1 Purpose

The `TrapLocation` enum specifies where within a room a trap can be placed. This determines the placement description and affects detection difficulty.

### 5.2 File Location

**File:** `src/Core/RuneAndRust.Domain/Enums/TrapLocation.cs`

### 5.3 Implementation

```csharp
namespace RuneAndRust.Domain.Enums;

/// <summary>
/// Locations where traps can be placed within a room.
/// </summary>
/// <remarks>
/// Determines placement description and may affect detection modifiers.
/// </remarks>
public enum TrapLocation
{
    /// <summary>
    /// Placed near a room entrance.
    /// </summary>
    /// <remarks>
    /// Triggers when entering from a specific direction.
    /// Often combined with Movement or PressurePlate triggers.
    /// </remarks>
    Entrance = 0,

    /// <summary>
    /// Placed on the room floor.
    /// </summary>
    /// <remarks>
    /// General floor area trap. Most common placement.
    /// Used for pit traps, pressure plates, etc.
    /// </remarks>
    Floor = 1,

    /// <summary>
    /// Placed on a container object.
    /// </summary>
    /// <remarks>
    /// Triggers when container is opened or manipulated.
    /// Associated with a specific container ID.
    /// </remarks>
    Container = 2,

    /// <summary>
    /// Placed on a door mechanism.
    /// </summary>
    /// <remarks>
    /// Triggers when door is opened or lock is picked.
    /// Associated with a specific door/exit.
    /// </remarks>
    Door = 3,

    /// <summary>
    /// Wall-mounted trap.
    /// </summary>
    /// <remarks>
    /// Dart traps, blade traps, etc.
    /// Often activated by pressure plates or movement.
    /// </remarks>
    Wall = 4
}
```

### 5.4 Location Characteristics Summary

| Location | Associated Object | Detection Modifier | Common Triggers |
|----------|------------------|-------------------|-----------------|
| Entrance | Direction | +0 | Movement, PressurePlate |
| Floor | None | +0 | PressurePlate, Movement |
| Container | Container ID | -2 (harder) | ContainerOpen |
| Door | Exit Direction | -1 | Interaction |
| Wall | None | +0 | Movement, PressurePlate |

---

## 6. TrapDefinition Entity

### 6.1 Purpose

The `TrapDefinition` entity defines a trap type loaded from JSON configuration. It specifies the trap's characteristics, damage, DCs, and placement rules.

### 6.2 File Location

**File:** `src/Core/RuneAndRust.Domain/Definitions/TrapDefinition.cs`

### 6.3 Implementation

```csharp
namespace RuneAndRust.Domain.Definitions;

using RuneAndRust.Domain.Enums;

/// <summary>
/// Defines a trap type for dungeon placement.
/// </summary>
/// <remarks>
/// Trap definitions specify characteristics including trigger type, damage,
/// DCs, and placement rules. Loaded from traps.json.
/// Trap mechanics (triggering, damage) are implemented in v0.4.0.
/// </remarks>
public class TrapDefinition : IDefinition
{
    /// <summary>
    /// Gets the unique identifier (e.g., "poison-dart").
    /// </summary>
    public string Id { get; private set; } = string.Empty;

    /// <summary>
    /// Gets the display name.
    /// </summary>
    public string Name { get; private set; } = string.Empty;

    /// <summary>
    /// Gets the hidden description (before detection).
    /// </summary>
    /// <remarks>
    /// Shown to players who have not detected the trap.
    /// Should be subtle and not give away the trap's presence.
    /// </remarks>
    public string HiddenDescription { get; private set; } = string.Empty;

    /// <summary>
    /// Gets the revealed description (after detection).
    /// </summary>
    /// <remarks>
    /// Shown to players who have successfully detected the trap.
    /// Describes the trap clearly so players can decide how to proceed.
    /// </remarks>
    public string RevealedDescription { get; private set; } = string.Empty;

    /// <summary>
    /// Gets the trigger description (when activated).
    /// </summary>
    /// <remarks>
    /// Narrates what happens when the trap triggers.
    /// Used in v0.4.0 when trap is activated.
    /// </remarks>
    public string TriggerDescription { get; private set; } = string.Empty;

    /// <summary>
    /// Gets the base detection DC.
    /// </summary>
    /// <remarks>
    /// Scaled by depth: final DC = BaseDetectionDC + (depth / 2).
    /// Player must meet or exceed this DC to detect the trap.
    /// </remarks>
    public int BaseDetectionDC { get; private set; }

    /// <summary>
    /// Gets the base disarm DC.
    /// </summary>
    /// <remarks>
    /// Scaled by depth: final DC = BaseDisarmDC + (depth / 2).
    /// Player must meet or exceed this DC to disarm the trap.
    /// Typically higher than detection DC.
    /// </remarks>
    public int BaseDisarmDC { get; private set; }

    /// <summary>
    /// Gets the damage dice expression.
    /// </summary>
    /// <remarks>
    /// Standard dice notation (e.g., "2d6", "1d4+2").
    /// Used in v0.4.0 when trap triggers.
    /// </remarks>
    public string DamageExpression { get; private set; } = string.Empty;

    /// <summary>
    /// Gets the damage type ID.
    /// </summary>
    /// <remarks>
    /// References DamageType (e.g., "poison", "fire", "bludgeoning").
    /// Used for resistance/vulnerability calculations in v0.4.0.
    /// </remarks>
    public string DamageTypeId { get; private set; } = string.Empty;

    /// <summary>
    /// Gets status effects applied on trigger.
    /// </summary>
    /// <remarks>
    /// List of status effect IDs applied when trap triggers.
    /// Used in v0.4.0 (e.g., "poisoned-minor", "burning", "prone").
    /// </remarks>
    public IReadOnlyList<string> StatusEffectIds { get; private set; } = Array.Empty<string>();

    /// <summary>
    /// Gets the minimum dungeon depth for this trap.
    /// </summary>
    /// <remarks>
    /// Trap will not appear above this depth.
    /// Allows more dangerous traps to be restricted to deeper levels.
    /// </remarks>
    public int MinDepth { get; private set; }

    /// <summary>
    /// Gets the maximum dungeon depth (0 = no limit).
    /// </summary>
    /// <remarks>
    /// Trap will not appear below this depth.
    /// Value of 0 means no maximum limit.
    /// </remarks>
    public int MaxDepth { get; private set; }

    /// <summary>
    /// Gets biome IDs this trap can appear in (empty = all).
    /// </summary>
    /// <remarks>
    /// Empty list means the trap can appear in any biome.
    /// Non-empty list restricts placement to listed biomes.
    /// </remarks>
    public IReadOnlyList<string> AllowedBiomes { get; private set; } = Array.Empty<string>();

    /// <summary>
    /// Gets architectural styles this trap fits (empty = all).
    /// </summary>
    /// <remarks>
    /// Empty list means the trap fits any architectural style.
    /// Non-empty list restricts placement to listed styles.
    /// </remarks>
    public IReadOnlyList<string> AllowedStyles { get; private set; } = Array.Empty<string>();

    /// <summary>
    /// Gets whether this trap resets after triggering.
    /// </summary>
    /// <remarks>
    /// If true, trap can trigger multiple times.
    /// If false, trap is single-use.
    /// Used in v0.4.0 for trap state management.
    /// </remarks>
    public bool Resettable { get; private set; }

    /// <summary>
    /// Gets the trigger type.
    /// </summary>
    /// <remarks>
    /// Determines how the trap is activated and affects placement.
    /// </remarks>
    public TrapTriggerType TriggerType { get; private set; }

    /// <summary>
    /// Gets the placement weight for random selection.
    /// </summary>
    /// <remarks>
    /// Higher weights increase selection probability.
    /// Default is 100.
    /// </remarks>
    public int PlacementWeight { get; private set; }

    /// <summary>
    /// Private constructor for JSON deserialization.
    /// </summary>
    private TrapDefinition() { }

    /// <summary>
    /// Creates a trap definition from configuration.
    /// </summary>
    /// <param name="id">Unique identifier.</param>
    /// <param name="name">Display name.</param>
    /// <param name="baseDetectionDC">Base detection DC.</param>
    /// <param name="baseDisarmDC">Base disarm DC.</param>
    /// <param name="damageExpression">Damage dice expression.</param>
    /// <param name="damageTypeId">Damage type ID.</param>
    /// <returns>A new TrapDefinition instance.</returns>
    /// <exception cref="ArgumentException">If id or name is null/empty.</exception>
    public static TrapDefinition Create(
        string id,
        string name,
        int baseDetectionDC,
        int baseDisarmDC,
        string damageExpression,
        string damageTypeId)
    {
        ArgumentException.ThrowIfNullOrWhiteSpace(id);
        ArgumentException.ThrowIfNullOrWhiteSpace(name);

        return new TrapDefinition
        {
            Id = id,
            Name = name,
            BaseDetectionDC = baseDetectionDC,
            BaseDisarmDC = baseDisarmDC,
            DamageExpression = damageExpression,
            DamageTypeId = damageTypeId,
            PlacementWeight = 100
        };
    }

    /// <summary>
    /// Gets the scaled detection DC for the given depth.
    /// </summary>
    /// <param name="depth">The dungeon depth.</param>
    /// <returns>Detection DC scaled by depth.</returns>
    /// <remarks>
    /// Formula: BaseDetectionDC + (depth / 2)
    /// Deeper dungeons have harder-to-detect traps.
    /// </remarks>
    public int GetScaledDetectionDC(int depth) => BaseDetectionDC + (depth / 2);

    /// <summary>
    /// Gets the scaled disarm DC for the given depth.
    /// </summary>
    /// <param name="depth">The dungeon depth.</param>
    /// <returns>Disarm DC scaled by depth.</returns>
    /// <remarks>
    /// Formula: BaseDisarmDC + (depth / 2)
    /// Deeper dungeons have harder-to-disarm traps.
    /// </remarks>
    public int GetScaledDisarmDC(int depth) => BaseDisarmDC + (depth / 2);

    /// <summary>
    /// Checks if this trap is valid for the given context.
    /// </summary>
    /// <param name="depth">The dungeon depth.</param>
    /// <param name="biomeId">The biome ID (null if none).</param>
    /// <param name="styleId">The architectural style ID (null if none).</param>
    /// <returns>True if the trap can be placed in this context.</returns>
    public bool IsValidFor(int depth, string? biomeId, string? styleId)
    {
        // Check depth constraints
        if (depth < MinDepth) return false;
        if (MaxDepth > 0 && depth > MaxDepth) return false;

        // Check biome constraints (empty list = all allowed)
        if (AllowedBiomes.Count > 0 && biomeId != null && !AllowedBiomes.Contains(biomeId))
            return false;

        // Check style constraints (empty list = all allowed)
        if (AllowedStyles.Count > 0 && styleId != null && !AllowedStyles.Contains(styleId))
            return false;

        return true;
    }
}
```

### 6.4 Properties Summary

| Property | Type | Description | Default |
|----------|------|-------------|---------|
| `Id` | `string` | Unique identifier | Required |
| `Name` | `string` | Display name | Required |
| `HiddenDescription` | `string` | Description before detection | Empty |
| `RevealedDescription` | `string` | Description after detection | Empty |
| `TriggerDescription` | `string` | Trigger narration | Empty |
| `BaseDetectionDC` | `int` | Base detection DC | Required |
| `BaseDisarmDC` | `int` | Base disarm DC | Required |
| `DamageExpression` | `string` | Damage dice notation | Required |
| `DamageTypeId` | `string` | Damage type reference | Required |
| `StatusEffectIds` | `IReadOnlyList<string>` | Applied status effects | Empty |
| `MinDepth` | `int` | Minimum placement depth | 0 |
| `MaxDepth` | `int` | Maximum placement depth (0=no limit) | 0 |
| `AllowedBiomes` | `IReadOnlyList<string>` | Valid biomes (empty=all) | Empty |
| `AllowedStyles` | `IReadOnlyList<string>` | Valid styles (empty=all) | Empty |
| `Resettable` | `bool` | Can trigger multiple times | false |
| `TriggerType` | `TrapTriggerType` | Trigger mechanism | Required |
| `PlacementWeight` | `int` | Selection weight | 100 |

---

## 7. TrapPlacement Value Object

### 7.1 Purpose

The `TrapPlacement` value object describes where a trap is placed within a room. It includes the location type, associated object ID (if any), and a human-readable description.

### 7.2 File Location

**File:** `src/Core/RuneAndRust.Domain/ValueObjects/TrapPlacement.cs`

### 7.3 Implementation

```csharp
namespace RuneAndRust.Domain.ValueObjects;

using RuneAndRust.Domain.Enums;

/// <summary>
/// Describes where a trap is placed within a room.
/// </summary>
/// <remarks>
/// Immutable value object capturing trap placement details.
/// Used by TrapInstance to store placement information.
/// </remarks>
public readonly record struct TrapPlacement
{
    /// <summary>
    /// Gets the placement location type.
    /// </summary>
    /// <remarks>
    /// Determines general category of placement (floor, container, etc.).
    /// </remarks>
    public TrapLocation Location { get; init; }

    /// <summary>
    /// Gets the associated object ID (container, door, etc.).
    /// </summary>
    /// <remarks>
    /// For Container placement, this is the container ID.
    /// For Entrance placement, this is the direction string.
    /// For Door placement, this is the door/exit ID.
    /// Null for Floor and Wall placements.
    /// </remarks>
    public string? ObjectId { get; init; }

    /// <summary>
    /// Gets the placement description.
    /// </summary>
    /// <remarks>
    /// Human-readable description of the trap's location.
    /// Used in room descriptions and detection messages.
    /// </remarks>
    public string Description { get; init; }

    /// <summary>
    /// Creates an entrance trap placement.
    /// </summary>
    /// <param name="direction">The entrance direction.</param>
    /// <returns>A TrapPlacement at the specified entrance.</returns>
    /// <remarks>
    /// Places trap near a room entrance.
    /// Triggers when entering from the specified direction.
    /// </remarks>
    public static TrapPlacement AtEntrance(Direction direction) => new()
    {
        Location = TrapLocation.Entrance,
        ObjectId = direction.ToString(),
        Description = $"Near the {direction.ToString().ToLower()} entrance"
    };

    /// <summary>
    /// Creates a floor trap placement.
    /// </summary>
    /// <param name="description">Description of the floor location.</param>
    /// <returns>A TrapPlacement on the floor.</returns>
    /// <remarks>
    /// General floor placement for pressure plates, pit traps, etc.
    /// </remarks>
    public static TrapPlacement OnFloor(string description) => new()
    {
        Location = TrapLocation.Floor,
        ObjectId = null,
        Description = description
    };

    /// <summary>
    /// Creates a container trap placement.
    /// </summary>
    /// <param name="containerId">The container object ID.</param>
    /// <returns>A TrapPlacement on the specified container.</returns>
    /// <remarks>
    /// Triggers when the associated container is opened.
    /// </remarks>
    public static TrapPlacement OnContainer(string containerId) => new()
    {
        Location = TrapLocation.Container,
        ObjectId = containerId,
        Description = "On the container"
    };

    /// <summary>
    /// Creates a door trap placement.
    /// </summary>
    /// <param name="direction">The door/exit direction.</param>
    /// <returns>A TrapPlacement on the specified door.</returns>
    /// <remarks>
    /// Triggers when the door is opened or lock is picked.
    /// </remarks>
    public static TrapPlacement OnDoor(Direction direction) => new()
    {
        Location = TrapLocation.Door,
        ObjectId = direction.ToString(),
        Description = $"On the {direction.ToString().ToLower()} door"
    };

    /// <summary>
    /// Creates a wall trap placement.
    /// </summary>
    /// <param name="description">Description of the wall location.</param>
    /// <returns>A TrapPlacement on a wall.</returns>
    /// <remarks>
    /// For dart traps, blade traps, and other wall-mounted traps.
    /// </remarks>
    public static TrapPlacement OnWall(string description) => new()
    {
        Location = TrapLocation.Wall,
        ObjectId = null,
        Description = description
    };

    /// <summary>
    /// Gets whether this placement is associated with an object.
    /// </summary>
    public bool HasAssociatedObject => !string.IsNullOrEmpty(ObjectId);

    /// <summary>
    /// Gets a string representation of the placement.
    /// </summary>
    public override string ToString() =>
        HasAssociatedObject
            ? $"{Location} ({ObjectId}): {Description}"
            : $"{Location}: {Description}";
}
```

### 7.4 Properties Summary

| Property | Type | Description |
|----------|------|-------------|
| `Location` | `TrapLocation` | Placement location type |
| `ObjectId` | `string?` | Associated object ID (if any) |
| `Description` | `string` | Human-readable description |
| `HasAssociatedObject` | `bool` | True if ObjectId is set (computed) |

### 7.5 Factory Methods Summary

| Method | Parameters | Location | Description |
|--------|------------|----------|-------------|
| `AtEntrance` | `Direction direction` | Entrance | Near room entrance |
| `OnFloor` | `string description` | Floor | Floor area |
| `OnContainer` | `string containerId` | Container | On container |
| `OnDoor` | `Direction direction` | Door | On door mechanism |
| `OnWall` | `string description` | Wall | Wall-mounted |

---

## 8. TrapInstance Entity

### 8.1 Purpose

The `TrapInstance` entity represents a placed trap instance in a dungeon room. It contains the scaled DCs and placement information, ready for interaction in v0.4.0.

### 8.2 File Location

**File:** `src/Core/RuneAndRust.Domain/Entities/TrapInstance.cs`

### 8.3 Implementation

```csharp
namespace RuneAndRust.Domain.Entities;

using RuneAndRust.Domain.Definitions;
using RuneAndRust.Domain.ValueObjects;

/// <summary>
/// A placed trap instance in a dungeon room.
/// </summary>
/// <remarks>
/// Contains scaled DCs and placement information.
/// Detection/disarm state and trigger mechanics are managed in v0.4.0.
/// </remarks>
public class TrapInstance : IEntity
{
    /// <summary>
    /// Gets the unique identifier.
    /// </summary>
    public Guid Id { get; private set; }

    /// <summary>
    /// Gets the room containing this trap.
    /// </summary>
    public Guid RoomId { get; private set; }

    /// <summary>
    /// Gets the trap definition ID.
    /// </summary>
    /// <remarks>
    /// References the TrapDefinition used to create this instance.
    /// </remarks>
    public string DefinitionId { get; private set; } = string.Empty;

    /// <summary>
    /// Gets the detection DC for this instance.
    /// </summary>
    /// <remarks>
    /// Pre-calculated during placement: BaseDetectionDC + (depth / 2).
    /// Player must meet or exceed this DC to detect the trap.
    /// </remarks>
    public int DetectionDC { get; private set; }

    /// <summary>
    /// Gets the disarm DC for this instance.
    /// </summary>
    /// <remarks>
    /// Pre-calculated during placement: BaseDisarmDC + (depth / 2).
    /// Player must meet or exceed this DC to disarm the trap.
    /// </remarks>
    public int DisarmDC { get; private set; }

    /// <summary>
    /// Gets the placement details.
    /// </summary>
    /// <remarks>
    /// Describes where in the room the trap is located.
    /// </remarks>
    public TrapPlacement Placement { get; private set; }

    /// <summary>
    /// Private constructor for EF Core.
    /// </summary>
    private TrapInstance() { }

    /// <summary>
    /// Creates a trap instance from a definition.
    /// </summary>
    /// <param name="roomId">The room containing the trap.</param>
    /// <param name="definition">The trap definition.</param>
    /// <param name="depth">The dungeon depth for DC scaling.</param>
    /// <param name="placement">The placement details.</param>
    /// <returns>A new TrapInstance with scaled DCs.</returns>
    public static TrapInstance Create(
        Guid roomId,
        TrapDefinition definition,
        int depth,
        TrapPlacement placement)
    {
        ArgumentNullException.ThrowIfNull(definition);

        return new TrapInstance
        {
            Id = Guid.NewGuid(),
            RoomId = roomId,
            DefinitionId = definition.Id,
            DetectionDC = definition.GetScaledDetectionDC(depth),
            DisarmDC = definition.GetScaledDisarmDC(depth),
            Placement = placement
        };
    }

    /// <summary>
    /// Gets a string representation of the trap instance.
    /// </summary>
    public override string ToString() =>
        $"Trap[{DefinitionId}] in Room {RoomId} (Detection DC: {DetectionDC}, Disarm DC: {DisarmDC})";
}
```

### 8.4 Properties Summary

| Property | Type | Description | Default |
|----------|------|-------------|---------|
| `Id` | `Guid` | Unique identifier | Generated |
| `RoomId` | `Guid` | Containing room | Required |
| `DefinitionId` | `string` | Source definition ID | Required |
| `DetectionDC` | `int` | Scaled detection DC | Calculated |
| `DisarmDC` | `int` | Scaled disarm DC | Calculated |
| `Placement` | `TrapPlacement` | Placement details | Required |

---

## 9. TrapPlacementService

### 9.1 Purpose

The `TrapPlacementService` generates and places traps during dungeon generation. It handles definition selection, count calculation, and placement generation.

### 9.2 File Locations

**Interface:** `src/Core/RuneAndRust.Application/Interfaces/ITrapPlacementService.cs`
**Implementation:** `src/Core/RuneAndRust.Application/Services/TrapPlacementService.cs`

### 9.3 Interface

```csharp
namespace RuneAndRust.Application.Interfaces;

using RuneAndRust.Application.DTOs;
using RuneAndRust.Domain.Entities;

/// <summary>
/// Service for generating and placing traps during dungeon generation.
/// </summary>
/// <remarks>
/// Handles trap placement only. Trap mechanics (detection, disarm, trigger)
/// are implemented in v0.4.0.
/// </remarks>
public interface ITrapPlacementService
{
    /// <summary>
    /// Generates traps for the given room context.
    /// </summary>
    /// <param name="context">The placement context with room information.</param>
    /// <returns>Generated trap instances for the room.</returns>
    IEnumerable<TrapInstance> GenerateTraps(TrapPlacementContext context);

    /// <summary>
    /// Determines if a room should contain traps.
    /// </summary>
    /// <param name="context">The placement context with room information.</param>
    /// <returns>True if traps should be placed.</returns>
    bool ShouldPlaceTraps(TrapPlacementContext context);
}
```

### 9.4 Implementation

```csharp
namespace RuneAndRust.Application.Services;

using Microsoft.Extensions.Logging;
using RuneAndRust.Application.DTOs;
using RuneAndRust.Application.Interfaces;
using RuneAndRust.Domain.Definitions;
using RuneAndRust.Domain.Entities;
using RuneAndRust.Domain.Enums;
using RuneAndRust.Domain.ValueObjects;

/// <summary>
/// Places traps during dungeon generation.
/// </summary>
/// <remarks>
/// Does not handle trap mechanics (detection, disarm, trigger).
/// See v0.4.0 for interaction implementation.
/// </remarks>
public class TrapPlacementService : ITrapPlacementService
{
    private readonly IConfigurationProvider _configurationProvider;
    private readonly ISeededRandomService _randomService;
    private readonly ILogger<TrapPlacementService> _logger;

    /// <summary>
    /// Initializes a new instance of TrapPlacementService.
    /// </summary>
    /// <param name="configurationProvider">Configuration provider for trap definitions.</param>
    /// <param name="randomService">Seeded random service for reproducibility.</param>
    /// <param name="logger">Logger for diagnostic output.</param>
    public TrapPlacementService(
        IConfigurationProvider configurationProvider,
        ISeededRandomService randomService,
        ILogger<TrapPlacementService> logger)
    {
        _configurationProvider = configurationProvider ?? throw new ArgumentNullException(nameof(configurationProvider));
        _randomService = randomService ?? throw new ArgumentNullException(nameof(randomService));
        _logger = logger ?? throw new ArgumentNullException(nameof(logger));
    }

    /// <inheritdoc />
    public IEnumerable<TrapInstance> GenerateTraps(TrapPlacementContext context)
    {
        // Filter definitions by context
        var definitions = _configurationProvider.GetTrapDefinitions()
            .Where(d => d.IsValidFor(context.Depth, context.BiomeId, context.ArchitecturalStyleId))
            .ToList();

        if (definitions.Count == 0)
        {
            _logger.LogDebug(
                "No valid trap definitions for depth {Depth}, biome {Biome}, style {Style}",
                context.Depth, context.BiomeId, context.ArchitecturalStyleId);
            yield break;
        }

        var trapCount = CalculateTrapCount(context);

        _logger.LogDebug(
            "Generating {Count} traps for room {RoomId} at depth {Depth}",
            trapCount, context.RoomId, context.Depth);

        for (var i = 0; i < trapCount; i++)
        {
            var definition = SelectTrapDefinition(definitions);
            var placement = GeneratePlacement(definition, context, i);

            var trap = TrapInstance.Create(
                context.RoomId,
                definition,
                context.Depth,
                placement);

            _logger.LogInformation(
                "Placed {Trap} trap '{Definition}' in room {RoomId} (Detection DC: {DetectionDC}, Disarm DC: {DisarmDC})",
                definition.TriggerType, definition.Id, context.RoomId, trap.DetectionDC, trap.DisarmDC);

            yield return trap;
        }
    }

    /// <inheritdoc />
    public bool ShouldPlaceTraps(TrapPlacementContext context)
    {
        var result = context.RoomType switch
        {
            RoomType.Trap => true,
            RoomType.Treasure => _randomService.NextDouble() < 0.7,
            RoomType.Corridor => _randomService.NextDouble() < 0.2,
            RoomType.Boss => _randomService.NextDouble() < 0.3,
            _ => _randomService.NextDouble() < 0.1
        };

        _logger.LogDebug(
            "ShouldPlaceTraps for {RoomType} room {RoomId}: {Result}",
            context.RoomType, context.RoomId, result);

        return result;
    }

    /// <summary>
    /// Calculates the number of traps to place based on room type and depth.
    /// </summary>
    /// <param name="context">The placement context.</param>
    /// <returns>The number of traps to place (1-5).</returns>
    private int CalculateTrapCount(TrapPlacementContext context)
    {
        var baseDensity = context.RoomType switch
        {
            RoomType.Trap => 3,
            RoomType.Treasure => 2,
            RoomType.Corridor => 1,
            _ => 1
        };

        // Add depth modifier: +1 trap per 5 depth levels
        var depthModifier = context.Depth / 5;

        // Cap at 5 traps maximum
        var count = Math.Min(baseDensity + depthModifier, 5);

        _logger.LogDebug(
            "Calculated trap count: base {Base} + depth modifier {Modifier} = {Count}",
            baseDensity, depthModifier, count);

        return count;
    }

    /// <summary>
    /// Selects a trap definition using weighted random selection.
    /// </summary>
    /// <param name="definitions">Available trap definitions.</param>
    /// <returns>Selected trap definition.</returns>
    private TrapDefinition SelectTrapDefinition(IList<TrapDefinition> definitions)
    {
        var totalWeight = definitions.Sum(d => d.PlacementWeight);
        var roll = _randomService.Next(0, totalWeight);
        var cumulative = 0;

        foreach (var definition in definitions)
        {
            cumulative += definition.PlacementWeight;
            if (roll < cumulative)
            {
                _logger.LogDebug(
                    "Selected trap definition '{Definition}' (weight: {Weight}, roll: {Roll}/{Total})",
                    definition.Id, definition.PlacementWeight, roll, totalWeight);
                return definition;
            }
        }

        // Fallback to first definition
        _logger.LogWarning("Falling back to first trap definition due to weight calculation issue");
        return definitions[0];
    }

    /// <summary>
    /// Generates a placement based on the trap's trigger type.
    /// </summary>
    /// <param name="definition">The trap definition.</param>
    /// <param name="context">The placement context.</param>
    /// <param name="index">The trap index (for unique descriptions).</param>
    /// <returns>Generated placement details.</returns>
    private TrapPlacement GeneratePlacement(
        TrapDefinition definition,
        TrapPlacementContext context,
        int index)
    {
        var placement = definition.TriggerType switch
        {
            TrapTriggerType.PressurePlate => TrapPlacement.OnFloor($"Floor section {index + 1}"),
            TrapTriggerType.ContainerOpen => TrapPlacement.OnContainer($"chest-{index}"),
            TrapTriggerType.Movement => TrapPlacement.OnFloor("Center of room"),
            TrapTriggerType.Interaction => TrapPlacement.OnFloor("Hidden location"),
            _ => TrapPlacement.OnFloor("Hidden location")
        };

        _logger.LogDebug(
            "Generated placement for {TriggerType} trap: {Placement}",
            definition.TriggerType, placement);

        return placement;
    }
}
```

---

## 10. TrapPlacementContext Record

### 10.1 Purpose

The `TrapPlacementContext` record provides context information for trap placement decisions, including room details, biome, style, and world seed.

### 10.2 File Location

**File:** `src/Core/RuneAndRust.Application/DTOs/TrapPlacementContext.cs`

### 10.3 Implementation

```csharp
namespace RuneAndRust.Application.DTOs;

using RuneAndRust.Domain.Enums;

/// <summary>
/// Context for trap placement during dungeon generation.
/// </summary>
/// <remarks>
/// Provides all information needed to determine trap placement,
/// count, and type selection for a room.
/// </remarks>
public record TrapPlacementContext
{
    /// <summary>
    /// Gets the room ID for trap placement.
    /// </summary>
    public required Guid RoomId { get; init; }

    /// <summary>
    /// Gets the dungeon depth (Z coordinate).
    /// </summary>
    /// <remarks>
    /// Used for DC scaling and definition filtering.
    /// Deeper rooms have higher DCs.
    /// </remarks>
    public required int Depth { get; init; }

    /// <summary>
    /// Gets the biome ID (if any).
    /// </summary>
    /// <remarks>
    /// Used for definition filtering. Null if room has no biome.
    /// </remarks>
    public string? BiomeId { get; init; }

    /// <summary>
    /// Gets the biome display name.
    /// </summary>
    /// <remarks>
    /// Used for description placeholder replacement.
    /// </remarks>
    public string? BiomeName { get; init; }

    /// <summary>
    /// Gets the architectural style ID (if any).
    /// </summary>
    /// <remarks>
    /// Used for definition filtering. Null if room has no style.
    /// </remarks>
    public string? ArchitecturalStyleId { get; init; }

    /// <summary>
    /// Gets the world seed for reproducibility.
    /// </summary>
    /// <remarks>
    /// Ensures consistent trap placement across regenerations.
    /// </remarks>
    public required int WorldSeed { get; init; }

    /// <summary>
    /// Gets the room type.
    /// </summary>
    /// <remarks>
    /// Used to determine trap placement probability and density.
    /// Trap rooms always get traps with high density.
    /// </remarks>
    public RoomType? RoomType { get; init; }
}
```

### 10.4 Properties Summary

| Property | Type | Required | Description |
|----------|------|----------|-------------|
| `RoomId` | `Guid` | Yes | The room identifier |
| `Depth` | `int` | Yes | Dungeon depth for DC scaling |
| `BiomeId` | `string?` | No | Biome ID for filtering |
| `BiomeName` | `string?` | No | Biome name for descriptions |
| `ArchitecturalStyleId` | `string?` | No | Style ID for filtering |
| `WorldSeed` | `int` | Yes | Seed for reproducibility |
| `RoomType` | `RoomType?` | No | Room type for probability/density |

---

## 11. Configuration File Schemas

### 11.1 Trap Definitions Configuration

**File:** `config/traps.json`

```json
{
  "$schema": "schemas/traps.schema.json",
  "trapDefinitions": [
    {
      "id": "poison-dart",
      "name": "Poison Dart Trap",
      "hiddenDescription": "Small holes line the wall at various heights.",
      "revealedDescription": "A poison dart trap! Tiny holes in the wall conceal spring-loaded darts.",
      "triggerDescription": "Darts shoot from the walls!",
      "baseDetectionDC": 12,
      "baseDisarmDC": 14,
      "damageExpression": "1d4",
      "damageTypeId": "poison",
      "statusEffectIds": ["poisoned-minor"],
      "minDepth": 1,
      "maxDepth": 0,
      "allowedBiomes": [],
      "allowedStyles": ["carved-halls", "ruined-structures"],
      "resettable": true,
      "triggerType": "Movement",
      "placementWeight": 100
    },
    {
      "id": "pit-trap",
      "name": "Concealed Pit",
      "hiddenDescription": "The floor seems solid enough.",
      "revealedDescription": "A concealed pit trap! The floor here is a thin covering over a deep pit.",
      "triggerDescription": "The floor gives way beneath you!",
      "baseDetectionDC": 14,
      "baseDisarmDC": 16,
      "damageExpression": "2d6",
      "damageTypeId": "bludgeoning",
      "statusEffectIds": [],
      "minDepth": 1,
      "maxDepth": 0,
      "allowedBiomes": [],
      "allowedStyles": ["carved-halls", "ancient-temple"],
      "resettable": false,
      "triggerType": "PressurePlate",
      "placementWeight": 80
    },
    {
      "id": "fire-jet",
      "name": "Fire Jet",
      "hiddenDescription": "Strange pipes run along the walls.",
      "revealedDescription": "A fire jet trap! The pipes are connected to a hidden fuel reservoir.",
      "triggerDescription": "Flames blast from the walls!",
      "baseDetectionDC": 15,
      "baseDisarmDC": 17,
      "damageExpression": "3d6",
      "damageTypeId": "fire",
      "statusEffectIds": ["burning"],
      "minDepth": 3,
      "maxDepth": 0,
      "allowedBiomes": ["volcanic-caves"],
      "allowedStyles": ["ancient-temple"],
      "resettable": true,
      "triggerType": "Movement",
      "placementWeight": 60
    },
    {
      "id": "cave-in",
      "name": "Unstable Ceiling",
      "hiddenDescription": "Cracks spider across the ceiling.",
      "revealedDescription": "The ceiling is unstable! Heavy stones could fall with the slightest vibration.",
      "triggerDescription": "The ceiling collapses!",
      "baseDetectionDC": 10,
      "baseDisarmDC": 20,
      "damageExpression": "4d6",
      "damageTypeId": "bludgeoning",
      "statusEffectIds": ["prone"],
      "minDepth": 2,
      "maxDepth": 0,
      "allowedBiomes": ["natural-caves"],
      "allowedStyles": ["natural-caves", "ruined-structures"],
      "resettable": false,
      "triggerType": "Movement",
      "placementWeight": 50
    }
  ]
}
```

### 11.2 JSON Schema

**File:** `config/schemas/traps.schema.json`

```json
{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "traps.schema.json",
  "title": "Trap Definitions Configuration",
  "description": "Schema for trap definition configurations",
  "type": "object",
  "required": ["trapDefinitions"],
  "properties": {
    "$schema": {
      "type": "string"
    },
    "trapDefinitions": {
      "type": "array",
      "minItems": 1,
      "items": {
        "$ref": "#/$defs/trapDefinition"
      }
    }
  },
  "$defs": {
    "trapDefinition": {
      "type": "object",
      "required": [
        "id",
        "name",
        "baseDetectionDC",
        "baseDisarmDC",
        "damageExpression",
        "damageTypeId",
        "triggerType"
      ],
      "properties": {
        "id": {
          "type": "string",
          "minLength": 1,
          "pattern": "^[a-z][a-z0-9-]*$",
          "description": "Unique identifier using lowercase with hyphens"
        },
        "name": {
          "type": "string",
          "minLength": 1,
          "description": "Display name for the trap"
        },
        "hiddenDescription": {
          "type": "string",
          "default": "",
          "description": "Description shown before detection"
        },
        "revealedDescription": {
          "type": "string",
          "default": "",
          "description": "Description shown after detection"
        },
        "triggerDescription": {
          "type": "string",
          "default": "",
          "description": "Narration when trap triggers"
        },
        "baseDetectionDC": {
          "type": "integer",
          "minimum": 1,
          "maximum": 30,
          "description": "Base detection DC before depth scaling"
        },
        "baseDisarmDC": {
          "type": "integer",
          "minimum": 1,
          "maximum": 30,
          "description": "Base disarm DC before depth scaling"
        },
        "damageExpression": {
          "type": "string",
          "pattern": "^\\d+d\\d+(\\+\\d+)?$",
          "description": "Damage dice expression (e.g., 2d6, 1d4+2)"
        },
        "damageTypeId": {
          "type": "string",
          "minLength": 1,
          "description": "Reference to DamageType (e.g., poison, fire)"
        },
        "statusEffectIds": {
          "type": "array",
          "items": { "type": "string" },
          "default": [],
          "description": "Status effects applied on trigger"
        },
        "minDepth": {
          "type": "integer",
          "minimum": 0,
          "default": 0,
          "description": "Minimum dungeon depth for placement"
        },
        "maxDepth": {
          "type": "integer",
          "minimum": 0,
          "default": 0,
          "description": "Maximum dungeon depth (0 = no limit)"
        },
        "allowedBiomes": {
          "type": "array",
          "items": { "type": "string" },
          "default": [],
          "description": "Biome IDs where trap can appear (empty = all)"
        },
        "allowedStyles": {
          "type": "array",
          "items": { "type": "string" },
          "default": [],
          "description": "Architectural style IDs (empty = all)"
        },
        "resettable": {
          "type": "boolean",
          "default": false,
          "description": "Whether trap can trigger multiple times"
        },
        "triggerType": {
          "type": "string",
          "enum": ["Movement", "ContainerOpen", "PressurePlate", "Interaction"],
          "description": "Trap trigger mechanism"
        },
        "placementWeight": {
          "type": "integer",
          "minimum": 1,
          "default": 100,
          "description": "Selection weight for random placement"
        }
      }
    }
  }
}
```

---

## 12. Logging Specifications

### 12.1 Log Levels by Component

| Component | Level | Events |
|-----------|-------|--------|
| `TrapPlacementService` | Information | Trap placed |
| `TrapPlacementService` | Debug | Definition filtering, count calculation, selection, placement generation |
| `TrapPlacementService` | Warning | No valid definitions, fallback selection |
| `TrapDefinition` | Debug | Validation checks, DC scaling |

### 12.2 Log Message Examples

```csharp
// Information
_logger.LogInformation(
    "Placed {Trap} trap '{Definition}' in room {RoomId} (Detection DC: {DetectionDC}, Disarm DC: {DisarmDC})",
    definition.TriggerType, definition.Id, context.RoomId, trap.DetectionDC, trap.DisarmDC);

// Debug
_logger.LogDebug(
    "No valid trap definitions for depth {Depth}, biome {Biome}, style {Style}",
    context.Depth, context.BiomeId, context.ArchitecturalStyleId);

_logger.LogDebug(
    "Generating {Count} traps for room {RoomId} at depth {Depth}",
    trapCount, context.RoomId, context.Depth);

_logger.LogDebug(
    "Calculated trap count: base {Base} + depth modifier {Modifier} = {Count}",
    baseDensity, depthModifier, count);

_logger.LogDebug(
    "Selected trap definition '{Definition}' (weight: {Weight}, roll: {Roll}/{Total})",
    definition.Id, definition.PlacementWeight, roll, totalWeight);

_logger.LogDebug(
    "ShouldPlaceTraps for {RoomType} room {RoomId}: {Result}",
    context.RoomType, context.RoomId, result);

// Warning
_logger.LogWarning("Falling back to first trap definition due to weight calculation issue");
```

---

## 13. Unit Testing Requirements

### 13.1 Test Count by Feature

| Feature | Test Count |
|---------|------------|
| TrapTriggerType enum | ~2 |
| TrapLocation enum | ~2 |
| TrapDefinition entity | ~4 |
| TrapPlacement value object | ~4 |
| TrapInstance entity | ~3 |
| TrapPlacementService | ~5 |
| Configuration loading | ~2 |
| **Total** | **~22** |

### 13.2 Test Files

| File | Tests | Coverage |
|------|-------|----------|
| `TrapTriggerTypeTests.cs` | ~2 | Enum values, count |
| `TrapLocationTests.cs` | ~2 | Enum values, count |
| `TrapDefinitionTests.cs` | ~4 | Create, IsValidFor, GetScaledDetectionDC, GetScaledDisarmDC |
| `TrapPlacementTests.cs` | ~4 | AtEntrance, OnFloor, OnContainer, OnDoor |
| `TrapInstanceTests.cs` | ~3 | Create, DC scaling, properties |
| `TrapPlacementServiceTests.cs` | ~5 | GenerateTraps, ShouldPlaceTraps, CalculateTrapCount, SelectDefinition |
| `TrapConfigurationTests.cs` | ~2 | JSON loading, schema validation |

### 13.3 Test Categories

**TrapDefinition Tests:**
```csharp
[Test]
public void Create_WithValidParameters_CreatesTrapDefinition()

[Test]
public void Create_WithInvalidId_ThrowsArgumentException()

[Test]
public void IsValidFor_WhenDepthBelowMinimum_ReturnsFalse()

[Test]
public void IsValidFor_WhenBiomeMismatch_ReturnsFalse()

[Test]
public void GetScaledDetectionDC_ScalesWithDepth()

[Test]
public void GetScaledDisarmDC_ScalesWithDepth()
```

**TrapPlacement Tests:**
```csharp
[Test]
public void AtEntrance_SetsLocationAndDirection()

[Test]
public void OnFloor_SetsLocationAndDescription()

[Test]
public void OnContainer_SetsLocationAndContainerId()

[Test]
public void HasAssociatedObject_WhenObjectIdSet_ReturnsTrue()
```

**TrapPlacementService Tests:**
```csharp
[Test]
public void GenerateTraps_WithValidContext_ReturnsTrapInstances()

[Test]
public void GenerateTraps_WithNoValidDefinitions_ReturnsEmpty()

[Test]
public void ShouldPlaceTraps_ForTrapRoom_ReturnsTrue()

[Test]
public void ShouldPlaceTraps_ForTreasureRoom_Returns70Percent()

[Test]
public void CalculateTrapCount_ScalesWithDepth()
```

---

## 14. Use Cases

### UC-001: Generate Traps for Trap Room

**Actor:** DungeonGeneratorService
**Flow:** Room created with RoomType.Trap → DungeonGenerator creates TrapPlacementContext → Calls ITrapPlacementService.ShouldPlaceTraps (returns true) → Calls GenerateTraps → TrapInstance[] returned and stored with room

### UC-002: Generate Traps for Treasure Room

**Actor:** DungeonGeneratorService
**Flow:** Room created with RoomType.Treasure → DungeonGenerator creates context → ShouldPlaceTraps returns true (70% chance) → GenerateTraps creates 2+ traps → Traps guard treasure access

### UC-003: Filter Definitions by Biome

**Actor:** TrapPlacementService
**Flow:** Context has BiomeId="volcanic-caves" → GetTrapDefinitions() returns all definitions → IsValidFor filters to biome-compatible definitions → fire-jet included (explicitly allowed), cave-in excluded (wrong biome)

### UC-004: Scale DCs by Depth

**Actor:** TrapPlacementService
**Flow:** Definition has BaseDetectionDC=12, BaseDisarmDC=14, context.Depth=6 → GetScaledDetectionDC(6) = 12 + 3 = 15 → GetScaledDisarmDC(6) = 14 + 3 = 17 → TrapInstance created with scaled DCs

### UC-005: Calculate Trap Density

**Actor:** TrapPlacementService
**Flow:** Context has RoomType.Trap, Depth=10 → baseDensity=3 (trap room) → depthModifier=10/5=2 → count=min(3+2, 5)=5 → 5 traps generated

### UC-006: Generate Placement by Trigger Type

**Actor:** TrapPlacementService
**Flow:** Definition.TriggerType=PressurePlate → GeneratePlacement creates TrapPlacement.OnFloor("Floor section 1") → Placement stored with TrapInstance

---

## 15. Deliverable Checklist

### Domain Layer

- [ ] `TrapTriggerType.cs` created with 4 enum values
- [ ] `TrapLocation.cs` created with 5 enum values
- [ ] `TrapDefinition.cs` created with IDefinition
- [ ] `TrapPlacement.cs` created as value object
- [ ] `TrapInstance.cs` created with IEntity

### Application Layer

- [ ] `ITrapPlacementService.cs` created
- [ ] `TrapPlacementService.cs` created
- [ ] `TrapPlacementContext.cs` created as record

### Infrastructure Layer

- [ ] `IConfigurationProvider.cs` updated with GetTrapDefinitions()
- [ ] `JsonConfigurationProvider.cs` updated to load trap definitions

### Configuration Files

- [ ] `config/traps.json` created with 4 trap definitions
- [ ] `config/schemas/traps.schema.json` created

### Testing

- [ ] `TrapTriggerTypeTests.cs` created (~2 tests)
- [ ] `TrapLocationTests.cs` created (~2 tests)
- [ ] `TrapDefinitionTests.cs` created (~4 tests)
- [ ] `TrapPlacementTests.cs` created (~4 tests)
- [ ] `TrapInstanceTests.cs` created (~3 tests)
- [ ] `TrapPlacementServiceTests.cs` created (~5 tests)
- [ ] `TrapConfigurationTests.cs` created (~2 tests)
- [ ] All ~22 tests passing

### Documentation

- [ ] XML documentation on all public members
- [ ] Code follows .editorconfig conventions

---

## 16. Acceptance Criteria

### Functional

- [ ] TrapTriggerType enum contains 4 types (Movement, ContainerOpen, PressurePlate, Interaction)
- [ ] TrapLocation enum contains 5 types (Entrance, Floor, Container, Door, Wall)
- [ ] TrapDefinition loads from `traps.json` configuration
- [ ] TrapDefinition.IsValidFor correctly filters by depth, biome, and style
- [ ] TrapDefinition.GetScaledDetectionDC returns BaseDetectionDC + (depth/2)
- [ ] TrapDefinition.GetScaledDisarmDC returns BaseDisarmDC + (depth/2)
- [ ] TrapPlacement.AtEntrance creates entrance placement with direction
- [ ] TrapPlacement.OnFloor creates floor placement with description
- [ ] TrapPlacement.OnContainer creates container placement with ID
- [ ] TrapInstance.Create calculates scaled DCs
- [ ] TrapPlacementService.ShouldPlaceTraps returns true for RoomType.Trap
- [ ] TrapPlacementService.ShouldPlaceTraps returns true ~70% for RoomType.Treasure
- [ ] TrapPlacementService.ShouldPlaceTraps returns true ~20% for RoomType.Corridor
- [ ] TrapPlacementService.ShouldPlaceTraps returns true ~30% for RoomType.Boss
- [ ] TrapPlacementService.GenerateTraps returns empty when no valid definitions
- [ ] CalculateTrapCount returns base density + (depth / 5), capped at 5
- [ ] Trap density varies by room type (Trap=3, Treasure=2, Corridor=1)
- [ ] SelectTrapDefinition uses weighted random selection
- [ ] GeneratePlacement generates location based on trigger type

### Quality

- [ ] Build succeeds with 0 errors/warnings
- [ ] All ~22 unit tests pass
- [ ] Configuration files validate against schemas
- [ ] XML documentation complete on public members
- [ ] Code follows .editorconfig conventions
- [ ] No hardcoded trap data outside configuration

---

## 17. Dependencies

### 17.1 Prerequisites (v0.1.5b)

| Component | Purpose for v0.1.5c |
|-----------|---------------------|
| `Room` entity | Target for trap placement |
| `RoomType` enum | Determines placement probability and density |
| `Direction` enum | For entrance/door placement |
| `BiomeDefinition` | Biome ID for definition filtering |
| `ArchitecturalStyle` | Style ID for definition filtering |
| `IConfigurationProvider` | Pattern for loading trap definitions |
| `ISeededRandomService` | Reproducible random for selection |
| `SecretRoomTemplate.CanContainTraps` | Flag for secret room trap eligibility |

### 17.2 Provides to Future Phases

| Component | Used By |
|-----------|---------|
| `TrapDefinition` | v0.1.5d (VaultGenerationService trap guards), v0.4.0 (mechanics) |
| `TrapInstance` | v0.1.5d (vault trap integration), v0.4.0 (interaction) |
| `TrapPlacementService` | v0.1.5d (VaultGenerationService) |
| `TrapPlacementContext` | v0.1.5d (vault context) |
| `ITrapPlacementService` | v0.1.5d, v0.4.0 |

### 17.3 Dependency Diagram

```
v0.1.5b (Secret Room Generation)
    │
    ├── Room entity ─────────────────────────┐
    ├── RoomType enum ───────────────────────┤
    ├── Direction enum ──────────────────────┤
    ├── BiomeDefinition ─────────────────────┤
    ├── ArchitecturalStyle ──────────────────┤
    ├── IConfigurationProvider ──────────────┤
    ├── ISeededRandomService ────────────────┤
    └── SecretRoomTemplate.CanContainTraps ──┘
                                             │
                                             ▼
v0.1.5c (Trap Placement System)
    │
    ├── TrapTriggerType ──────────────────────────────────────────┐
    ├── TrapLocation ─────────────────────────────────────────────┤
    ├── TrapDefinition ───────────────────────────────────────────┤
    ├── TrapPlacement ────────────────────────────────────────────┤
    ├── TrapInstance ─────────────────────────────────────────────┤
    ├── TrapPlacementContext ─────────────────────────────────────┤
    └── ITrapPlacementService ────────────────────────────────────┘
                                                                  │
                                                                  ▼
                                          v0.1.5d (Treasure Vault Generation)
                                              │
                                              └── Uses TrapPlacementService for
                                                  vault trap assignment
                                                                  │
                                                                  ▼
                                          v0.4.0 (Interactive Environment & Puzzles)
                                              │
                                              └── Implements: disarm command,
                                                  detection checks, trigger mechanics,
                                                  damage application, status effects,
                                                  trap state persistence
```

---

## 18. Future Considerations

### 18.1 Deferred to v0.1.5d

- **TreasureRoomTemplate** — Vault designs with trap integration
- **GuardianAssignment** — Guardian configuration for vaults
- **VaultGenerationService** — Integration with TrapPlacementService for trapped vaults

### 18.2 Deferred to v0.4.0 (Interaction)

- **Disarm command** — Player-facing trap disarming
- **Detection checks** — Automatic/active trap detection
- **Trigger mechanics** — Trap activation on conditions
- **Damage application** — Applying trap damage to players
- **Status effect application** — Applying status effects on trigger
- **Trap state persistence** — Tracking triggered/disabled/reset state

### 18.3 Out of Scope (Future Versions)

- **Complex trap chains** — Traps that trigger other traps
- **Trap crafting** — Player-placed traps
- **Monster trap interaction** — Monsters triggering or avoiding traps
- **Environmental trap integration** — Traps that modify room environment
- **Trap components** — Salvageable parts from disarmed traps

---

*Document Version: 1.0*
*Last Updated: 2026-01-09*
*Author: Claude*
