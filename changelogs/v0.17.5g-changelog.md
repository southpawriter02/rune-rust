# Changelog: v0.17.5g - Database Persistence (Player Repository)

**Release Date:** 2026-01-31
**Phase:** Character Creation Workflow (7/7)
**Status:** Complete

---

## Overview

Implements the Database Persistence phase — the final phase of the character creation workflow (v0.17.5). Adds the `IPlayerRepository` interface, `SaveResult` value object, `InMemoryPlayerRepository` implementation, and integrates persistence into the `CharacterCreationController`'s `ConfirmCharacterAsync` method. After a character is created by the factory, it is now saved to the repository with name uniqueness enforcement.

The implementation uses an in-memory repository (`InMemoryPlayerRepository`) matching the established `InMemoryGameRepository` pattern, rather than the EF Core `PlayerRepository` described in the design specification. This decision aligns with the codebase's current infrastructure approach — `GameDbContext` does not have a Player DbSet, and the existing game repository uses in-memory storage. The `IPlayerRepository` interface is designed to support a future EF Core implementation without changes.

---

## Added

### Domain Layer — Value Objects

- **`SaveResult`** (`Domain/ValueObjects/SaveResult.cs`)
    - `readonly record struct` representing persistence operation outcomes
    - Properties: `Success` (bool), `EntityId` (Guid?), `ErrorMessage` (string?)
    - Factory methods: `Succeeded(Guid entityId)`, `Failed(string errorMessage)`
    - `ToString()` override for debugging: "Saved: {EntityId}" or "Failed: {ErrorMessage}"

### Application Layer — Interfaces

- **`IPlayerRepository`** (`Application/Interfaces/IPlayerRepository.cs`)
    - 6 async methods for the full Player persistence lifecycle:
        - `SaveAsync(Player, CancellationToken)` → `SaveResult` — save new character with name uniqueness
        - `GetByIdAsync(Guid, CancellationToken)` → `Player?` — retrieve by ID
        - `GetMostRecentAsync(CancellationToken)` → `Player?` — most recently saved/updated character
        - `ExistsWithNameAsync(string, CancellationToken)` → `bool` — case-insensitive name check
        - `UpdateAsync(Player, CancellationToken)` → `SaveResult` — update existing character
        - `GetAllAsync(CancellationToken)` → `IReadOnlyList<Player>` — all characters, most recent first
    - Comprehensive XML documentation with persistence flow, usage examples, and implementation notes

### Infrastructure Layer — Repositories

- **`InMemoryPlayerRepository`** (`Infrastructure/Repositories/InMemoryPlayerRepository.cs`)
    - Thread-safe implementation using `ConcurrentDictionary<Guid, Player>` for storage
    - Separate `ConcurrentDictionary<Guid, DateTime>` for creation/update timestamps
    - Case-insensitive name uniqueness via `StringComparison.OrdinalIgnoreCase`
    - Error message constants: `ErrorNameExists`, `ErrorPlayerNotFound`, `ErrorSaveFailed`
    - Optional logger with `NullLogger` fallback (matching `InMemoryGameRepository` pattern)
    - Exhaustive structured logging at Debug/Information/Warning/Error levels

### Unit Tests

- **`InMemoryPlayerRepositoryTests`** (`Services/InMemoryPlayerRepositoryTests.cs`) — 15 test methods
    - **SaveAsync (4 tests):** New player success, null guard, duplicate name, case-insensitive collision
    - **GetByIdAsync (2 tests):** Existing player retrieval, non-existent returns null
    - **GetMostRecentAsync (2 tests):** Empty store returns null, multiple players returns latest
    - **ExistsWithNameAsync (3 tests):** Exact match, case-insensitive, non-existent
    - **UpdateAsync (2 tests):** Existing player success, non-existent fails
    - **GetAllAsync (2 tests):** Empty store returns empty list, multiple players returns all

- **`CharacterCreationControllerPersistenceTests`** (`Services/CharacterCreationControllerPersistenceTests.cs`) — 4 test methods
    - `ConfirmCharacter_WithRepository_SavesPlayer` — verifies SaveAsync called after factory creation
    - `ConfirmCharacter_SaveFails_ReturnsError` — repository failure propagated to caller
    - `ConfirmCharacter_WithoutRepository_SkipsPersistence` — graceful degradation when no repository
    - `ConfirmCharacter_NameCollision_ReturnsError` — ExistsWithNameAsync blocks duplicate names

### Glossary

- **`config/glossary.json`** — Added 3 glossary entries (sortOrder 72-74)
    - `player-repository`: Repository interface for Player entity persistence
    - `save-result`: Value object for persistence operation outcomes
    - `in-memory-player-repository`: Thread-safe in-memory implementation of player persistence

---

## Changed

### Application Layer — Controller

- **`CharacterCreationController`** (`Application/Services/CharacterCreationController.cs`)
    - Added `IPlayerRepository?` as optional constructor parameter (after `ICharacterFactory?`)
    - Added `_playerRepository` private field
    - Added `ErrorPersistenceFailed` error message constant
    - Updated `ConfirmCharacterAsync` with 3 new operations:
        1. Name uniqueness check via `ExistsWithNameAsync` (before factory call)
        2. Character persistence via `SaveAsync` (after factory creation)
        3. Graceful degradation when repository is null (logs warning, skips persistence)
    - Updated constructor logging to include `{RepositoryAvailable}` status
    - Updated file header version to `0.17.5g`

### Application Layer — Interface

- **`ICharacterCreationController`** (`Application/Interfaces/ICharacterCreationController.cs`)
    - Updated `ConfirmCharacterAsync` XML documentation to document the persistence steps
    - Added `IPlayerRepository` to the class-level dependency list
    - Updated file header version to `0.17.5g`

### Infrastructure Layer — DI

- **`DependencyInjection`** (`Infrastructure/DependencyInjection.cs`)
    - Added `services.AddSingleton<IPlayerRepository, InMemoryPlayerRepository>()` registration

### Test Project

- **`RuneAndRust.Application.UnitTests.csproj`**
    - Added `ProjectReference` to `RuneAndRust.Infrastructure` for InMemoryPlayerRepository tests

### Documentation

- **`docs/design/v0.17.x/v0.17.5g-design-specification.md`** — Checked off deliverable and acceptance criteria items
- **`docs/design/v0.17.x/v0.17.5-scope-breakdown.md`** — Checked off persistence test items and acceptance criteria

---

## Design Decisions

### In-Memory Repository Instead of EF Core

The design specification describes an EF Core `PlayerRepository` with SQLite and `PlayerConfiguration`. The codebase currently:
- Uses `InMemoryGameRepository` for game sessions (the only active repository)
- Has `GameDbContext` that ignores the `Player` navigation property
- Has no Player DbSet, no Player EF Core configuration, no migrations
- Falls back to in-memory even when PostgreSQL is configured (`// TODO: Add EF Core-based repository`)

**Decision:** Implement `InMemoryPlayerRepository` matching `InMemoryGameRepository`. Full EF Core persistence is deferred per existing TODO comments. The `IPlayerRepository` interface supports future EF Core implementation without changes.

### Optional Repository Dependency

The controller accepts `IPlayerRepository?` as an optional constructor parameter (like `ICharacterFactory?`). When null, `ConfirmCharacterAsync` skips persistence and logs a warning. This maintains backward compatibility with existing tests that construct the controller without a repository.

### Timestamp Tracking

The design specification references `Player.SetCreatedAt()` and `Player.SetLastPlayedAt()` which do not exist on the Player entity. Rather than modifying the Player entity (large, out of scope), the repository tracks timestamps internally via a separate `ConcurrentDictionary<Guid, DateTime>`.

### Name Uniqueness Check Before Factory

The controller calls `ExistsWithNameAsync` before invoking the factory, providing early feedback on name availability. The repository's `SaveAsync` also checks uniqueness as a safety net for race conditions.

---

## Dependencies

### Prerequisites

| Type | Phase | Usage |
| --- | --- | --- |
| `CharacterCreationController` | v0.17.5d | Persistence integration target |
| `ICharacterFactory` | v0.17.5e | Creates Player before persistence |
| `Player` entity | v0.17.0 | Entity being persisted |
| `InMemoryGameRepository` | Existing | Pattern for in-memory implementation |

### Provides to Future Phases

| Type | Phase | Usage |
| --- | --- | --- |
| `IPlayerRepository` | Future | Character loading, selection screens |
| `SaveResult` | Future | Generic persistence result pattern |
| `InMemoryPlayerRepository` | Future | Replaceable with EF Core PlayerRepository |

---

## Logging Strategy

| Level | When |
|---|---|
| Debug | Repository initialized |
| Debug | Saving new player (name, id, current count) |
| Debug | GetByIdAsync called (player id) |
| Debug | Player found/not found by ID |
| Debug | GetMostRecentAsync called (player count) |
| Debug | Most recent player identified (name, id, timestamp) |
| Debug | ExistsWithNameAsync called (name) |
| Debug | Name existence result (name, exists) |
| Debug | Updating player (name, id) |
| Debug | GetAllAsync called (player count) |
| Debug | Returning player count |
| Debug | Checking name uniqueness (controller) |
| Debug | Name available (controller) |
| Debug | Persisting character (controller) |
| Information | Player saved successfully (name, id, total count) |
| Information | Player updated (name, id) |
| Information | Character persisted successfully (controller) |
| Warning | Name already exists (save collision) |
| Warning | ID already exists in store |
| Warning | Cannot update: player not found |
| Warning | Player repository not available (skip persistence) |
| Warning | Name uniqueness check failed (controller) |
| Error | Unexpected error during save |
| Error | Failed to persist character (controller) |

All logging uses structured format with `{Named}` parameters.

---

## Files Created

| Path | Description |
|------|-------------|
| `src/Core/RuneAndRust.Domain/ValueObjects/SaveResult.cs` | Persistence result value object |
| `src/Core/RuneAndRust.Application/Interfaces/IPlayerRepository.cs` | Player persistence interface (6 methods) |
| `src/Infrastructure/RuneAndRust.Infrastructure/Repositories/InMemoryPlayerRepository.cs` | In-memory player repository |
| `tests/RuneAndRust.Application.UnitTests/Services/InMemoryPlayerRepositoryTests.cs` | Repository unit tests (15 tests) |
| `tests/RuneAndRust.Application.UnitTests/Services/CharacterCreationControllerPersistenceTests.cs` | Controller persistence tests (4 tests) |
| `changelogs/v0.17.5g-changelog.md` | This changelog |

## Files Modified

| Path | Description |
|------|-------------|
| `src/Core/RuneAndRust.Application/Services/CharacterCreationController.cs` | Added IPlayerRepository dependency and persistence in ConfirmCharacterAsync |
| `src/Core/RuneAndRust.Application/Interfaces/ICharacterCreationController.cs` | Updated XML docs for persistence steps |
| `src/Infrastructure/RuneAndRust.Infrastructure/DependencyInjection.cs` | Registered InMemoryPlayerRepository as singleton |
| `tests/RuneAndRust.Application.UnitTests/RuneAndRust.Application.UnitTests.csproj` | Added Infrastructure project reference |
| `config/glossary.json` | Added 3 glossary entries (sortOrder 72-74) |
| `docs/design/v0.17.x/v0.17.5g-design-specification.md` | Checked off deliverable and acceptance criteria items |
| `docs/design/v0.17.x/v0.17.5-scope-breakdown.md` | Checked off persistence items |

---

## Notes

- Total unit tests for v0.17.5g: 19 test methods (15 repository + 4 controller persistence)
- This completes the v0.17.5 character creation workflow — all 7 phases (a through g) are implemented
- The design specification had 3 API discrepancies with the actual codebase (see Design Decisions)
- `PlayerConfiguration` (EF Core) deferred — no Player DbSet exists in `GameDbContext`
- All new files follow established codebase patterns: `═══════` section separators, file headers with Version tag, comprehensive XML documentation, exhaustive structured logging
