# v0.20.5b Changelog — Berserkr Tier 2 Abilities

## Version: 0.20.5b

## Date: 2026-02-15

## Focus: Berserkr Specialization — Tier 2 Abilities (Reckless Assault, Unstoppable, Intimidating Presence)

---

## Added

### Domain Layer — Enums

- **`MovementPenaltyType`** — 6 movement penalty categories: DifficultTerrain, Slow, Root, Water, Entangle, ForcedMovement

### Domain Layer — Value Objects

- **`RecklessAssaultState`** — Stance state tracking attack bonus (+4 base, +1/20 Rage), defense penalty (-2), turns active, and Corruption accrued. Factory method `Create(Guid)`, scaling via `GetCurrentAttackBonus(int)`, per-turn `Tick(int)`, and `GetDescription(int)` display.
- **`UnstoppableEffect`** — Duration-based effect (2 turns) granting immunity to all 6 `MovementPenaltyType` values. Factory method `Create(Guid)`, countdown via `Tick()`, penalty check via `IgnoresPenalty(MovementPenaltyType)`.
- **`IntimidationEffect`** — Per-target fear effect with save DC scaling (12 + Rage/20), failed save penalty (-2 Attack, 3 turns), successful save immunity (24 hours). Factory method `Create(Guid, Guid, string, int)`, static `CalculateSaveDc(int)`, save resolution via `ApplySaveResult(int)`.

### Application Layer — Interface Extensions

- **`IBerserkrAbilityService`** — Extended with 5 Tier 2 methods:
  - `ExecuteRecklessAssault(Player)` — Toggle stance entry/exit
  - `ExecuteUnstoppable(Player)` — Activate movement immunity
  - `ExecuteIntimidatingPresence(Player, List<targets>)` — AoE fear with per-target saves
  - `GetRecklessAssaultState(Player)` — Query active stance
  - `GetUnstoppableEffect(Player)` — Query active effect

### Application Layer — Service Extensions

- **`BerserkrAbilityService`** — Extended with Tier 2 implementations:
  - Reckless Assault: toggle stance (1 AP enter, free exit), attack bonus scaling, per-turn Corruption at 80+ Rage
  - Unstoppable: 1 AP + 15 Rage, 2-turn duration, cannot overlap, +1 Corruption at 80+ Rage
  - Intimidating Presence: 2 AP + 10 Rage, save DC 12+Rage/20, mindless/fear-immune filtering, +1 Corruption per Coherent target
  - `GetAbilityReadiness` extended with Tier 2 ability readiness checks
  - 5 new constants: RecklessAssaultApCost, UnstoppableApCost, UnstoppableRageCost, IntimidatingPresenceApCost, IntimidatingPresenceRageCost

### Entity Extensions

- **`Player.cs`** — Berserkr Tier 2 section added:
  - `RecklessAssaultState?` — Active stance state
  - `UnstoppableEffect?` — Active movement effect
  - `IsInRecklessAssault` — Computed property for stance check
  - `HasUnstoppableActive` — Computed property for effect check

### Configuration

- Updated `config/abilities.json` with 3 Tier 2 Berserkr abilities:
  - `reckless-assault`: Stance, 1 AP, +4 Attack/-2 Defense, scales with Rage, +1 Corruption/turn at 80+
  - `unstoppable`: Active, 1 AP + 15 Rage, 2 turns, ignores 6 movement penalty types, +1 Corruption at 80+
  - `intimidating-presence`: Active, 2 AP + 10 Rage, 4-space radius, Will save DC 12+Rage/20, -2 Attack for 3 turns on fail, 24h immunity on save, +1 Corruption per Coherent target

### Unit Tests

- **`RecklessAssaultStateTests`** — 11 tests: factory, attack bonus scaling, defense penalty, corruption generation thresholds, tick/corruption accumulation, isActive lifecycle, description with/without corruption risk
- **`UnstoppableEffectTests`** — 6 tests: factory, all 6 movement penalties ignored, penalty count, tick countdown, no-below-zero, description format
- **`IntimidationEffectTests`** — 12 tests: factory, save DC scaling across all Rage levels, failed save penalty, successful save immunity, exact DC match, tick countdown, tick floor, description (pending/failed/saved), immunity duration
- **`BerserkrAbilityServiceTests`** (extended) — 12 Tier 2 tests: Reckless Assault (enter/exit/insufficient AP/high Rage corruption), Unstoppable (grants immunity/insufficient Rage/already active), Intimidating Presence (affects enemies/skips mindless/insufficient Rage/Coherent corruption), readiness, Tier 2 lock

## Changed

- **`RuneAndRust.Application.csproj`** — Added `InternalsVisibleTo` for `RuneAndRust.Application.UnitTests` to support `internal virtual` dice method overrides in test subclass
- **`BerserkrAbilityService`** — Updated class XML docs to include Tier 2 ability descriptions

## Design Decisions

- **Stance toggle pattern**: Reckless Assault uses a toggle pattern — calling `ExecuteRecklessAssault` when already in the stance exits it as a free action (no AP cost). Entering costs 1 AP. This follows the design spec's intent that stances are persistent until manually exited or combat ends.
- **Corruption before spend**: Corruption risk evaluation occurs BEFORE resource spending for all Tier 2 abilities, consistent with the v0.20.5a design principle. This ensures the player always sees the risk assessment before committing.
- **IntimidationEffect per-target**: Each target gets its own `IntimidationEffect` instance rather than a shared effect, enabling independent save tracking, duration countdown, and immunity management per target.
- **Save DC scaling**: DC scales as `12 + currentRage / 20` (integer division), producing DCs from 12 (Calm) to 17 (Berserk/100 Rage). This is implemented as a static method on `IntimidationEffect.CalculateSaveDc(int)` for reuse.
- **Unstoppable non-overlap**: `ExecuteUnstoppable` returns null if the effect is already active, preventing stacking. The player must wait for the effect to expire before reactivating.
- **Player entity properties**: Tier 2 state (`RecklessAssaultState?`, `UnstoppableEffect?`) uses public setters to allow the service layer to manage stance/effect lifecycle directly, matching the mutable pattern established by `RageResource` in v0.20.5a.

## Test Results

```
Berserkr tests: 88
     Passed: 88
     Failed: 0

Breakdown:
  RageResourceTests:           23 domain tests
  RecklessAssaultStateTests:   11 domain tests
  UnstoppableEffectTests:       6 domain tests
  IntimidationEffectTests:     12 domain tests
  BerserkrCorruptionServiceTests: 9 application tests
  BerserkrAbilityServiceTests:  27 application tests (15 Tier 1 + 12 Tier 2)
```
