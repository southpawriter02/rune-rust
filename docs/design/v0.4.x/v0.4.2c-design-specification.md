# v0.4.2c Design Specification: Riddles & Advanced

**Version:** 0.4.2c
**Phase Name:** Riddles & Advanced
**Parent Version:** v0.4.2 (Puzzles & Riddles)
**Prerequisites:** v0.4.2b Complete (Puzzle Types)
**Estimated Tests:** ~25 unit tests

---

## Table of Contents

1. [Executive Summary](#1-executive-summary)
2. [Feature Overview](#2-feature-overview)
3. [Architecture Diagrams](#3-architecture-diagrams)
4. [RiddleDefinition](#4-riddledefinition)
5. [PuzzleHint](#5-puzzlehint)
6. [RiddleNpc Entity](#6-riddlenpc-entity)
7. [MultiPartPuzzle](#7-multipartpuzzle)
8. [Room Modifications](#8-room-modifications)
9. [PuzzleService Updates](#9-puzzleservice-updates)
10. [User-Facing Commands](#10-user-facing-commands)
11. [Data Model Changes](#11-data-model-changes)
12. [Configuration File Schemas](#12-configuration-file-schemas)
13. [Logging Specifications](#13-logging-specifications)
14. [Unit Testing Requirements](#14-unit-testing-requirements)
15. [Use Cases](#15-use-cases)
16. [Deliverable Checklist](#16-deliverable-checklist)
17. [Acceptance Criteria](#17-acceptance-criteria)
18. [Dependencies](#18-dependencies)
19. [Future Considerations](#19-future-considerations)

---

## 1. Executive Summary

### 1.1 Purpose

This specification completes the v0.4.2 Puzzles & Riddles feature set by implementing riddle NPCs, the hint system, multi-part puzzles spanning multiple rooms, and puzzle rewards. These advanced mechanics build on the core puzzle infrastructure (v0.4.2a) and type-specific puzzles (v0.4.2b) to create rich, varied non-combat challenges.

Key features include:
- **Riddle NPCs**: Characters that pose questions and block passage until correctly answered
- **Hint System**: Optional hints revealed through dice checks or freely, aiding stuck players
- **Multi-Part Puzzles**: Complex puzzles with components distributed across multiple rooms
- **Puzzle Rewards**: Items, currency, and access granted upon puzzle completion

### 1.2 Key Deliverables

| Category | Items |
|----------|-------|
| **Domain Definitions** | `RiddleDefinition` |
| **Domain Entities** | `RiddleNpc` |
| **Domain Enums** | `RiddleConsequence` |
| **Value Objects** | `PuzzleHint`, `MultiPartPuzzle` |
| **Result Types** | `PuzzleHintResult`, `PuzzleRewardResult`, `RiddleAnswerResult` |
| **Commands** | `answer`, `hint`, `talk` (riddle NPC interaction) |
| **Service Updates** | `PuzzleService`, `LootService` integration |
| **Room Updates** | `RiddleNpcs` collection |
| **Configuration** | `riddles.json` |
| **Tests** | ~25 unit tests |

### 1.3 Architectural Significance

This version establishes the **Riddle NPC Pattern** and **Multi-Part Puzzle Pattern**:

- **Passage Blocking**: NPCs can block specific directions until riddles are solved
- **Consequence System**: Failed riddle attempts trigger configurable consequences
- **Hint Revelation**: Sequential hint unlocking with optional dice check costs
- **Cross-Room State**: Multi-part puzzles track component completion across rooms
- **Reward Integration**: Puzzle completion triggers loot drops and room effects

---

## 2. Feature Overview

```
v0.4.2c Riddles & Advanced
├── RiddleDefinition
│   ├── Question text
│   ├── Accepted answers (case-insensitive)
│   ├── Hints collection
│   ├── Difficulty rating
│   ├── Category/theme
│   └── Correct/wrong messages
├── PuzzleHint Value Object
│   ├── Hint text
│   ├── Reveal order
│   ├── Reveal DC (0 = free)
│   └── Reveal attribute
├── RiddleNpc Entity
│   ├── Name and description
│   ├── Current riddle reference
│   ├── Solved state tracking
│   ├── Wrong answer counting
│   ├── Failure consequences
│   ├── Passage blocking
│   └── Reward reference
├── RiddleConsequence Enum
│   ├── BecomeHostile
│   ├── Disappear
│   ├── ApplyPenalty
│   └── Reset
├── MultiPartPuzzle Value Object
│   ├── Master puzzle ID
│   ├── Component puzzle IDs
│   ├── Order requirements
│   ├── Component rooms
│   └── Solved tracking
├── Room Modifications
│   ├── RiddleNpcs collection
│   └── Direction blocking
├── Commands
│   ├── talk <npc>
│   ├── answer <response>
│   └── hint [puzzle]
└── Service Updates
    ├── Riddle validation
    ├── Hint management
    ├── Multi-part tracking
    └── Reward distribution
```

---

## 3. Architecture Diagrams

### 3.1 Riddle NPC Flow

```
┌─────────────────────────────────────────────────────────────────────┐
│                         RIDDLE NPC FLOW                             │
└─────────────────────────────────────────────────────────────────────┘

    Player              RiddleNpc              PuzzleService           LootService
       │                    │                       │                      │
       │  talk <npc>        │                       │                      │
       ├───────────────────▶│                       │                      │
       │                    │                       │                      │
       │  ◀── greeting + riddle question ──────────│                      │
       │                    │                       │                      │
       │  answer <response> │                       │                      │
       ├───────────────────▶│                       │                      │
       │                    │  ValidateAnswer()     │                      │
       │                    ├──────────────────────▶│                      │
       │                    │                       │                      │
       │                    │  ◀── RiddleAnswerResult                     │
       │                    │                       │                      │
       ├─────── [CORRECT] ──┤                       │                      │
       │                    │  MarkSolved()         │                      │
       │                    ├───────────────────────│                      │
       │                    │                       │  ProcessReward()     │
       │                    ├───────────────────────┼─────────────────────▶│
       │                    │                       │                      │
       │  ◀── correct message + reward ────────────┼──────────────────────│
       │                    │                       │                      │
       ├─────── [WRONG] ────┤                       │                      │
       │                    │  RecordWrongAnswer()  │                      │
       │                    ├───────────────────────│                      │
       │                    │                       │                      │
       │  ◀── wrong message + remaining attempts ──│                      │
       │                    │                       │                      │
       ├── [MAX WRONG] ─────┤                       │                      │
       │                    │  ApplyConsequence()   │                      │
       │                    ├───────────────────────│                      │
       │                    │                       │                      │
       │  ◀── consequence applied ─────────────────│                      │
       │                    │                       │                      │
       ▼                    ▼                       ▼                      ▼
```

### 3.2 Hint System Flow

```
┌─────────────────────────────────────────────────────────────────────┐
│                          HINT SYSTEM FLOW                           │
└─────────────────────────────────────────────────────────────────────┘

    Player              Puzzle                PuzzleService           DiceService
       │                   │                       │                      │
       │  hint             │                       │                      │
       ├──────────────────▶│                       │                      │
       │                   │  GetNextHint()        │                      │
       │                   ├──────────────────────▶│                      │
       │                   │                       │                      │
       │                   │  ◀── PuzzleHint       │                      │
       │                   │                       │                      │
       ├─── [FREE HINT] ───┤                       │                      │
       │                   │                       │                      │
       │  ◀── hint text revealed ─────────────────│                      │
       │                   │                       │                      │
       ├── [DC REQUIRED] ──┤                       │                      │
       │                   │                       │  Roll(attribute, DC) │
       │                   │                       ├─────────────────────▶│
       │                   │                       │                      │
       │                   │                       │  ◀── RollResult      │
       │                   │                       │                      │
       │  ◀── [SUCCESS] hint revealed ────────────│                      │
       │                   │                       │                      │
       │  ◀── [FAILURE] no insight ───────────────│                      │
       │                   │                       │                      │
       ├─ [NO MORE HINTS] ─┤                       │                      │
       │                   │                       │                      │
       │  ◀── "all hints revealed" ───────────────│                      │
       │                   │                       │                      │
       ▼                   ▼                       ▼                      ▼
```

### 3.3 Multi-Part Puzzle Flow

```
┌─────────────────────────────────────────────────────────────────────┐
│                      MULTI-PART PUZZLE FLOW                         │
└─────────────────────────────────────────────────────────────────────┘

  Room A              Room B              Room C           PuzzleService
    │                   │                   │                   │
    │  solve component1 │                   │                   │
    ├───────────────────┼───────────────────┼──────────────────▶│
    │                   │                   │                   │
    │  ◀── component 1 solved (1/3) ────────────────────────────│
    │                   │                   │                   │
    │                   │  solve component2 │                   │
    │                   ├───────────────────┼──────────────────▶│
    │                   │                   │                   │
    │                   │  ◀── component 2 solved (2/3) ────────│
    │                   │                   │                   │
    │                   │                   │  solve component3 │
    │                   │                   ├──────────────────▶│
    │                   │                   │                   │
    │                   │                   │  IsComplete()     │
    │                   │                   │  ◀── true         │
    │                   │                   │                   │
    ◀════════ MULTI-PART PUZZLE COMPLETE ══════════════════════│
    │                   │                   │                   │
    │                   │                   │  ApplyRewards()   │
    │                   │                   ├──────────────────▶│
    │                   │                   │                   │
    │  ◀── master puzzle effects triggered ─────────────────────│
    │                   │                   │                   │
    ▼                   ▼                   ▼                   ▼
```

### 3.4 Layer Diagram

```
┌─────────────────────────────────────────────────────────────────────┐
│                        PRESENTATION LAYER                           │
├─────────────────────────────────────────────────────────────────────┤
│  TalkCommand   │   AnswerCommand   │   HintCommand                  │
│  "talk <npc>"  │   "answer <resp>" │   "hint [puzzle]"              │
└───────┬────────┴────────┬──────────┴────────┬───────────────────────┘
        │                 │                   │
        ▼                 ▼                   ▼
┌─────────────────────────────────────────────────────────────────────┐
│                       APPLICATION LAYER                             │
├─────────────────────────────────────────────────────────────────────┤
│  IPuzzleService                                                     │
│  ├── ValidateRiddleAnswer(npc, answer): RiddleAnswerResult          │
│  ├── GetNextHint(puzzle): PuzzleHintResult                          │
│  ├── RecordMultiPartComponent(component): PuzzleStepResult          │
│  └── ApplyPuzzleReward(puzzle): PuzzleRewardResult                  │
│                                                                     │
│  PuzzleService                                                      │
│  ├── Riddle validation logic                                        │
│  ├── Hint revelation management                                     │
│  ├── Multi-part completion tracking                                 │
│  └── Reward distribution                                            │
├─────────────────────────────────────────────────────────────────────┤
│  RiddleAnswerResult   │   PuzzleHintResult   │   PuzzleRewardResult │
└───────┬───────────────┴──────────┬───────────┴──────────┬───────────┘
        │                          │                      │
        ▼                          ▼                      ▼
┌─────────────────────────────────────────────────────────────────────┐
│                         DOMAIN LAYER                                │
├─────────────────────────────────────────────────────────────────────┤
│  RiddleNpc (Entity)                                                 │
│  ├── Id: Guid                                                       │
│  ├── Name: string                                                   │
│  ├── CurrentRiddleId: string                                        │
│  ├── RiddleSolved: bool                                             │
│  ├── WrongAnswerCount: int                                          │
│  ├── BlocksPassage: bool                                            │
│  ├── RecordWrongAnswer(): bool                                      │
│  ├── MarkSolved(): void                                             │
│  └── IsPassageBlocked(Direction): bool                              │
├─────────────────────────────────────────────────────────────────────┤
│  RiddleDefinition                                                   │
│  ├── Id: string                                                     │
│  ├── Question: string                                               │
│  ├── AcceptedAnswers: IReadOnlyList<string>                         │
│  ├── Hints: IReadOnlyList<PuzzleHint>                               │
│  └── ValidateAnswer(string): bool                                   │
├─────────────────────────────────────────────────────────────────────┤
│  PuzzleHint (Value Object)         │  MultiPartPuzzle (Value Object)│
│  ├── Text: string                  │  ├── MasterPuzzleId: string    │
│  ├── Order: int                    │  ├── ComponentPuzzleIds: List  │
│  ├── RevealDC: int                 │  ├── RequiresOrder: bool       │
│  └── RevealAttribute: string?      │  ├── SolvedCount: int          │
│                                    │  └── IsComplete: bool          │
├─────────────────────────────────────────────────────────────────────┤
│  RiddleConsequence (Enum)                                           │
│  ├── BecomeHostile                                                  │
│  ├── Disappear                                                      │
│  ├── ApplyPenalty                                                   │
│  └── Reset                                                          │
└─────────────────────────────────────────────────────────────────────┘
```

---

## 4. RiddleDefinition

### 4.1 Purpose

`RiddleDefinition` provides configuration for riddles, including the question text, acceptable answers (case-insensitive), optional hints, and feedback messages. This is a definition class loaded from JSON configuration.

### 4.2 Implementation

**File:** `src/Core/RuneAndRust.Domain/Definitions/RiddleDefinition.cs`

```csharp
namespace RuneAndRust.Domain.Definitions;

/// <summary>
/// Configuration for a riddle with question and acceptable answers.
/// </summary>
public class RiddleDefinition
{
    /// <summary>
    /// Gets the unique identifier for this riddle.
    /// </summary>
    public string Id { get; private set; } = string.Empty;

    /// <summary>
    /// Gets the riddle question text.
    /// </summary>
    public string Question { get; private set; } = string.Empty;

    /// <summary>
    /// Gets the accepted answers (case-insensitive).
    /// </summary>
    public IReadOnlyList<string> AcceptedAnswers { get; private set; } = Array.Empty<string>();

    /// <summary>
    /// Gets optional hints for this riddle.
    /// </summary>
    public IReadOnlyList<PuzzleHint> Hints { get; private set; } = Array.Empty<PuzzleHint>();

    /// <summary>
    /// Gets the difficulty rating (1-5).
    /// </summary>
    public int Difficulty { get; private set; } = 1;

    /// <summary>
    /// Gets the category/theme of this riddle.
    /// </summary>
    public string? Category { get; private set; }

    /// <summary>
    /// Gets the message shown on correct answer.
    /// </summary>
    public string CorrectMessage { get; private set; } = "Correct!";

    /// <summary>
    /// Gets the message shown on wrong answer.
    /// </summary>
    public string WrongMessage { get; private set; } = "That is not correct.";

    private RiddleDefinition() { }

    /// <summary>
    /// Creates a riddle definition.
    /// </summary>
    /// <param name="id">Unique identifier.</param>
    /// <param name="question">The riddle question text.</param>
    /// <param name="acceptedAnswers">Valid answers (case-insensitive).</param>
    /// <param name="hints">Optional hints.</param>
    /// <param name="difficulty">Difficulty rating (1-5).</param>
    /// <param name="category">Category/theme.</param>
    /// <param name="correctMessage">Message on correct answer.</param>
    /// <param name="wrongMessage">Message on wrong answer.</param>
    /// <returns>A new RiddleDefinition instance.</returns>
    public static RiddleDefinition Create(
        string id,
        string question,
        IEnumerable<string> acceptedAnswers,
        IEnumerable<PuzzleHint>? hints = null,
        int difficulty = 1,
        string? category = null,
        string? correctMessage = null,
        string? wrongMessage = null)
    {
        ArgumentException.ThrowIfNullOrWhiteSpace(id);
        ArgumentException.ThrowIfNullOrWhiteSpace(question);

        return new RiddleDefinition
        {
            Id = id,
            Question = question,
            AcceptedAnswers = acceptedAnswers.ToList(),
            Hints = hints?.ToList() ?? Array.Empty<PuzzleHint>(),
            Difficulty = Math.Clamp(difficulty, 1, 5),
            Category = category,
            CorrectMessage = correctMessage ?? "Correct!",
            WrongMessage = wrongMessage ?? "That is not correct."
        };
    }

    /// <summary>
    /// Validates if an answer is correct.
    /// </summary>
    /// <param name="answer">The answer to validate.</param>
    /// <returns>True if the answer is accepted.</returns>
    public bool ValidateAnswer(string answer)
    {
        return AcceptedAnswers.Any(a =>
            a.Equals(answer.Trim(), StringComparison.OrdinalIgnoreCase));
    }
}
```

### 4.3 Properties Reference

| Property | Type | Description |
|----------|------|-------------|
| `Id` | `string` | Unique identifier for this riddle |
| `Question` | `string` | The riddle question text displayed to players |
| `AcceptedAnswers` | `IReadOnlyList<string>` | Valid answers (matched case-insensitively) |
| `Hints` | `IReadOnlyList<PuzzleHint>` | Optional hints for this riddle |
| `Difficulty` | `int` | Difficulty rating (1-5) |
| `Category` | `string?` | Category/theme (e.g., "classic", "nature") |
| `CorrectMessage` | `string` | Message shown when answered correctly |
| `WrongMessage` | `string` | Message shown when answered incorrectly |

---

## 5. PuzzleHint

### 5.1 Purpose

`PuzzleHint` represents a hint that can be revealed for puzzles or riddles. Hints have an order (revealed sequentially), and optionally require a dice check to reveal.

### 5.2 Implementation

**File:** `src/Core/RuneAndRust.Domain/ValueObjects/PuzzleHint.cs`

```csharp
namespace RuneAndRust.Domain.ValueObjects;

/// <summary>
/// A hint that can be revealed for a puzzle.
/// </summary>
public class PuzzleHint
{
    /// <summary>
    /// Gets the hint text.
    /// </summary>
    public string Text { get; private set; } = string.Empty;

    /// <summary>
    /// Gets the order in which this hint is revealed (1 = first).
    /// </summary>
    public int Order { get; private set; }

    /// <summary>
    /// Gets the DC for a dice check to reveal this hint (0 = free).
    /// </summary>
    public int RevealDC { get; private set; }

    /// <summary>
    /// Gets the attribute used for the reveal check.
    /// </summary>
    public string? RevealAttribute { get; private set; }

    /// <summary>
    /// Gets whether revealing this hint has a cost.
    /// </summary>
    public bool HasCost => RevealDC > 0;

    private PuzzleHint() { }

    /// <summary>
    /// Creates a free hint (no dice check required).
    /// </summary>
    /// <param name="text">The hint text.</param>
    /// <param name="order">The reveal order (1 = first).</param>
    /// <returns>A free PuzzleHint instance.</returns>
    public static PuzzleHint Free(string text, int order) => new()
    {
        Text = text,
        Order = order,
        RevealDC = 0
    };

    /// <summary>
    /// Creates a hint requiring a dice check to reveal.
    /// </summary>
    /// <param name="text">The hint text.</param>
    /// <param name="order">The reveal order (1 = first).</param>
    /// <param name="dc">The difficulty class for the check.</param>
    /// <param name="attribute">The attribute used for the check.</param>
    /// <returns>A PuzzleHint with a reveal check.</returns>
    public static PuzzleHint WithCheck(string text, int order, int dc, string attribute) => new()
    {
        Text = text,
        Order = order,
        RevealDC = dc,
        RevealAttribute = attribute
    };
}
```

### 5.3 Properties Reference

| Property | Type | Description |
|----------|------|-------------|
| `Text` | `string` | The hint text shown to the player |
| `Order` | `int` | Reveal order (1 = first, 2 = second, etc.) |
| `RevealDC` | `int` | DC for dice check (0 = free reveal) |
| `RevealAttribute` | `string?` | Attribute for check (e.g., "Intelligence") |
| `HasCost` | `bool` | Whether a dice check is required |

### 5.4 Usage Examples

```csharp
// Free hint - always revealed on request
var freeHint = PuzzleHint.Free("The first digit is even.", order: 1);

// Hint requiring Intelligence check
var costlyHint = PuzzleHint.WithCheck(
    text: "Think about something on a desk.",
    order: 1,
    dc: 12,
    attribute: "Intelligence"
);
```

---

## 6. RiddleNpc Entity

### 6.1 Purpose

`RiddleNpc` represents an NPC that poses riddles to players. These NPCs can block passage until their riddle is solved, track wrong answer attempts, and trigger consequences when the player fails too many times.

### 6.2 Implementation

**File:** `src/Core/RuneAndRust.Domain/Entities/RiddleNpc.cs`

```csharp
namespace RuneAndRust.Domain.Entities;

/// <summary>
/// An NPC that poses riddles to players.
/// </summary>
public class RiddleNpc : IEntity
{
    /// <summary>
    /// Gets the unique identifier for this NPC.
    /// </summary>
    public Guid Id { get; private set; }

    /// <summary>
    /// Gets the display name of this NPC.
    /// </summary>
    public string Name { get; private set; } = string.Empty;

    /// <summary>
    /// Gets the description of this NPC.
    /// </summary>
    public string Description { get; private set; } = string.Empty;

    /// <summary>
    /// Gets the current riddle definition ID.
    /// </summary>
    public string CurrentRiddleId { get; private set; } = string.Empty;

    /// <summary>
    /// Gets whether the current riddle has been solved.
    /// </summary>
    public bool RiddleSolved { get; private set; }

    /// <summary>
    /// Gets the number of wrong answers given.
    /// </summary>
    public int WrongAnswerCount { get; private set; }

    /// <summary>
    /// Gets the maximum wrong answers before consequences (-1 = unlimited).
    /// </summary>
    public int MaxWrongAnswers { get; private set; } = -1;

    /// <summary>
    /// Gets the reward given for solving the riddle.
    /// </summary>
    public string? RewardId { get; private set; }

    /// <summary>
    /// Gets the consequence for too many wrong answers.
    /// </summary>
    public RiddleConsequence? FailureConsequence { get; private set; }

    /// <summary>
    /// Gets the greeting message when first speaking.
    /// </summary>
    public string GreetingMessage { get; private set; } = string.Empty;

    /// <summary>
    /// Gets the message when riddle is already solved.
    /// </summary>
    public string SolvedMessage { get; private set; } = string.Empty;

    /// <summary>
    /// Gets whether this NPC blocks passage until riddle is solved.
    /// </summary>
    public bool BlocksPassage { get; private set; }

    /// <summary>
    /// Gets the direction blocked (if blocking passage).
    /// </summary>
    public Direction? BlockedDirection { get; private set; }

    private RiddleNpc() { }

    /// <summary>
    /// Creates a riddle NPC.
    /// </summary>
    /// <param name="name">Display name of the NPC.</param>
    /// <param name="description">Description of the NPC.</param>
    /// <param name="riddleId">ID of the riddle this NPC poses.</param>
    /// <param name="greetingMessage">Message when first spoken to.</param>
    /// <param name="solvedMessage">Message when riddle already solved.</param>
    /// <param name="maxWrongAnswers">Max wrong attempts (-1 = unlimited).</param>
    /// <param name="rewardId">Loot table ID for reward.</param>
    /// <param name="failureConsequence">What happens on max failures.</param>
    /// <param name="blocksPassage">Whether NPC blocks a direction.</param>
    /// <param name="blockedDirection">Which direction is blocked.</param>
    /// <returns>A new RiddleNpc instance.</returns>
    public static RiddleNpc Create(
        string name,
        string description,
        string riddleId,
        string greetingMessage,
        string solvedMessage,
        int maxWrongAnswers = -1,
        string? rewardId = null,
        RiddleConsequence? failureConsequence = null,
        bool blocksPassage = false,
        Direction? blockedDirection = null)
    {
        return new RiddleNpc
        {
            Id = Guid.NewGuid(),
            Name = name,
            Description = description,
            CurrentRiddleId = riddleId,
            GreetingMessage = greetingMessage,
            SolvedMessage = solvedMessage,
            MaxWrongAnswers = maxWrongAnswers,
            RewardId = rewardId,
            FailureConsequence = failureConsequence,
            BlocksPassage = blocksPassage,
            BlockedDirection = blockedDirection
        };
    }

    /// <summary>
    /// Records a wrong answer attempt.
    /// </summary>
    /// <returns>True if max wrong answers reached.</returns>
    public bool RecordWrongAnswer()
    {
        WrongAnswerCount++;
        return MaxWrongAnswers > 0 && WrongAnswerCount >= MaxWrongAnswers;
    }

    /// <summary>
    /// Marks the riddle as solved.
    /// </summary>
    public void MarkSolved()
    {
        RiddleSolved = true;
    }

    /// <summary>
    /// Checks if passage in a direction is currently blocked.
    /// </summary>
    /// <param name="direction">The direction to check.</param>
    /// <returns>True if the NPC blocks this direction and riddle is unsolved.</returns>
    public bool IsPassageBlocked(Direction direction)
    {
        return BlocksPassage && !RiddleSolved && BlockedDirection == direction;
    }

    /// <summary>
    /// Gets the remaining attempts before failure (-1 if unlimited).
    /// </summary>
    /// <returns>Remaining attempts or -1.</returns>
    public int GetRemainingAttempts()
    {
        if (MaxWrongAnswers <= 0) return -1;
        return Math.Max(0, MaxWrongAnswers - WrongAnswerCount);
    }

    /// <summary>
    /// Resets the NPC state (for Reset consequence).
    /// </summary>
    public void Reset()
    {
        WrongAnswerCount = 0;
        RiddleSolved = false;
    }
}
```

### 6.3 RiddleConsequence Enum

**File:** `src/Core/RuneAndRust.Domain/Enums/RiddleConsequence.cs`

```csharp
namespace RuneAndRust.Domain.Enums;

/// <summary>
/// Consequence for failing a riddle NPC encounter.
/// </summary>
public enum RiddleConsequence
{
    /// <summary>
    /// NPC becomes hostile and attacks the player.
    /// </summary>
    BecomeHostile,

    /// <summary>
    /// NPC disappears from the room.
    /// </summary>
    Disappear,

    /// <summary>
    /// NPC applies a penalty to the player.
    /// </summary>
    ApplyPenalty,

    /// <summary>
    /// Riddle resets (can try again later).
    /// </summary>
    Reset
}
```

### 6.4 Properties Reference

| Property | Type | Description |
|----------|------|-------------|
| `Id` | `Guid` | Unique identifier |
| `Name` | `string` | Display name |
| `Description` | `string` | NPC description |
| `CurrentRiddleId` | `string` | Reference to riddle definition |
| `RiddleSolved` | `bool` | Whether riddle is solved |
| `WrongAnswerCount` | `int` | Number of wrong attempts |
| `MaxWrongAnswers` | `int` | Max attempts before consequence (-1 = unlimited) |
| `RewardId` | `string?` | Loot table ID for reward |
| `FailureConsequence` | `RiddleConsequence?` | What happens on failure |
| `GreetingMessage` | `string` | First interaction message |
| `SolvedMessage` | `string` | Message when already solved |
| `BlocksPassage` | `bool` | Whether NPC blocks movement |
| `BlockedDirection` | `Direction?` | Which direction is blocked |

---

## 7. MultiPartPuzzle

### 7.1 Purpose

`MultiPartPuzzle` tracks puzzles that span multiple rooms or objects. Players must solve component puzzles (possibly in a specific order) to complete the master puzzle and receive rewards.

### 7.2 Implementation

**File:** `src/Core/RuneAndRust.Domain/ValueObjects/MultiPartPuzzle.cs`

```csharp
namespace RuneAndRust.Domain.ValueObjects;

/// <summary>
/// Configuration for a puzzle spanning multiple rooms or objects.
/// </summary>
public class MultiPartPuzzle
{
    /// <summary>
    /// Gets the master puzzle ID.
    /// </summary>
    public string MasterPuzzleId { get; private set; } = string.Empty;

    /// <summary>
    /// Gets the IDs of component puzzles that must be solved.
    /// </summary>
    public IReadOnlyList<string> ComponentPuzzleIds { get; private set; } = Array.Empty<string>();

    /// <summary>
    /// Gets whether components must be solved in order.
    /// </summary>
    public bool RequiresOrder { get; private set; }

    /// <summary>
    /// Gets the required order (if applicable).
    /// </summary>
    public IReadOnlyList<string> RequiredOrder { get; private set; } = Array.Empty<string>();

    /// <summary>
    /// Gets room IDs where components are located.
    /// </summary>
    public IReadOnlyDictionary<string, Guid> ComponentRooms { get; private set; }
        = new Dictionary<string, Guid>();

    /// <summary>
    /// Gets the number of components solved.
    /// </summary>
    public int SolvedCount { get; private set; }

    /// <summary>
    /// Gets IDs of solved components.
    /// </summary>
    private readonly List<string> _solvedComponents = [];
    public IReadOnlyList<string> SolvedComponents => _solvedComponents;

    private MultiPartPuzzle() { }

    /// <summary>
    /// Creates a multi-part puzzle configuration.
    /// </summary>
    /// <param name="masterPuzzleId">The master puzzle ID.</param>
    /// <param name="componentIds">IDs of component puzzles.</param>
    /// <param name="requiresOrder">Whether order matters.</param>
    /// <param name="requiredOrder">The required order (if applicable).</param>
    /// <param name="componentRooms">Room locations for components.</param>
    /// <returns>A new MultiPartPuzzle instance.</returns>
    public static MultiPartPuzzle Create(
        string masterPuzzleId,
        IEnumerable<string> componentIds,
        bool requiresOrder = false,
        IEnumerable<string>? requiredOrder = null,
        IDictionary<string, Guid>? componentRooms = null)
    {
        return new MultiPartPuzzle
        {
            MasterPuzzleId = masterPuzzleId,
            ComponentPuzzleIds = componentIds.ToList(),
            RequiresOrder = requiresOrder,
            RequiredOrder = requiredOrder?.ToList() ?? Array.Empty<string>(),
            ComponentRooms = componentRooms?.ToDictionary(kvp => kvp.Key, kvp => kvp.Value)
                ?? new Dictionary<string, Guid>()
        };
    }

    /// <summary>
    /// Records a component as solved.
    /// </summary>
    /// <param name="componentId">The component puzzle ID.</param>
    /// <returns>True if successfully recorded, false if invalid or out of order.</returns>
    public bool RecordComponentSolved(string componentId)
    {
        if (!ComponentPuzzleIds.Contains(componentId))
            return false;

        if (_solvedComponents.Contains(componentId))
            return false;

        if (RequiresOrder)
        {
            var expectedNext = RequiredOrder[SolvedCount];
            if (componentId != expectedNext)
                return false;
        }

        _solvedComponents.Add(componentId);
        SolvedCount++;
        return true;
    }

    /// <summary>
    /// Checks if the multi-part puzzle is complete.
    /// </summary>
    public bool IsComplete => SolvedCount == ComponentPuzzleIds.Count;

    /// <summary>
    /// Gets the next expected component (if ordered).
    /// </summary>
    /// <returns>The next expected component ID, or null.</returns>
    public string? GetNextExpectedComponent()
    {
        if (!RequiresOrder || IsComplete)
            return null;

        return RequiredOrder[SolvedCount];
    }

    /// <summary>
    /// Gets remaining unsolved components.
    /// </summary>
    /// <returns>IDs of unsolved component puzzles.</returns>
    public IEnumerable<string> GetRemainingComponents()
    {
        return ComponentPuzzleIds.Except(_solvedComponents);
    }

    /// <summary>
    /// Gets the room ID for a component.
    /// </summary>
    /// <param name="componentId">The component puzzle ID.</param>
    /// <returns>The room GUID, or null if not mapped.</returns>
    public Guid? GetComponentRoom(string componentId)
    {
        return ComponentRooms.TryGetValue(componentId, out var roomId) ? roomId : null;
    }
}
```

### 7.3 Properties Reference

| Property | Type | Description |
|----------|------|-------------|
| `MasterPuzzleId` | `string` | ID of the master puzzle |
| `ComponentPuzzleIds` | `IReadOnlyList<string>` | IDs of component puzzles |
| `RequiresOrder` | `bool` | Whether solve order matters |
| `RequiredOrder` | `IReadOnlyList<string>` | Required solve order |
| `ComponentRooms` | `IReadOnlyDictionary<string, Guid>` | Component → Room mapping |
| `SolvedCount` | `int` | Number solved so far |
| `SolvedComponents` | `IReadOnlyList<string>` | IDs of solved components |
| `IsComplete` | `bool` | Whether all components solved |

---

## 8. Room Modifications

### 8.1 Purpose

The `Room` entity is extended with a `RiddleNpcs` collection to track riddle NPCs present in the room, along with methods to check if passage is blocked by unsolved riddle NPCs.

### 8.2 Implementation Updates

**File:** `src/Core/RuneAndRust.Domain/Entities/Room.cs`

```csharp
// Add to Room class

/// <summary>
/// Riddle NPCs in this room.
/// </summary>
private readonly List<RiddleNpc> _riddleNpcs = [];

/// <summary>
/// Gets riddle NPCs in this room.
/// </summary>
public IReadOnlyList<RiddleNpc> RiddleNpcs => _riddleNpcs.AsReadOnly();

/// <summary>
/// Gets whether this room has any riddle NPCs.
/// </summary>
public bool HasRiddleNpcs => _riddleNpcs.Count > 0;

/// <summary>
/// Adds a riddle NPC to this room.
/// </summary>
/// <param name="npc">The riddle NPC to add.</param>
public void AddRiddleNpc(RiddleNpc npc)
{
    ArgumentNullException.ThrowIfNull(npc);
    if (!_riddleNpcs.Any(n => n.Id == npc.Id))
    {
        _riddleNpcs.Add(npc);
    }
}

/// <summary>
/// Removes a riddle NPC from this room.
/// </summary>
/// <param name="npc">The riddle NPC to remove.</param>
/// <returns>True if removed, false if not found.</returns>
public bool RemoveRiddleNpc(RiddleNpc npc)
{
    ArgumentNullException.ThrowIfNull(npc);
    return _riddleNpcs.Remove(npc);
}

/// <summary>
/// Gets a riddle NPC by keyword (name match).
/// </summary>
/// <param name="keyword">The keyword to search for.</param>
/// <returns>The matching RiddleNpc, or null.</returns>
public RiddleNpc? GetRiddleNpcByKeyword(string keyword)
{
    if (string.IsNullOrWhiteSpace(keyword))
        return null;

    return _riddleNpcs.FirstOrDefault(n =>
        n.Name.Contains(keyword, StringComparison.OrdinalIgnoreCase));
}

/// <summary>
/// Checks if any riddle NPC blocks passage in a direction.
/// </summary>
/// <param name="direction">The direction to check.</param>
/// <returns>True if blocked by an unsolved riddle NPC.</returns>
public bool IsDirectionBlockedByNpc(Direction direction)
{
    return _riddleNpcs.Any(n => n.IsPassageBlocked(direction));
}

/// <summary>
/// Gets the NPC blocking a specific direction.
/// </summary>
/// <param name="direction">The direction to check.</param>
/// <returns>The blocking RiddleNpc, or null.</returns>
public RiddleNpc? GetBlockingNpc(Direction direction)
{
    return _riddleNpcs.FirstOrDefault(n => n.IsPassageBlocked(direction));
}
```

### 8.3 Room Modification Summary

```
MODIFY: Room
├── ADD: _riddleNpcs: List<RiddleNpc>
├── ADD: RiddleNpcs: IReadOnlyList<RiddleNpc>
├── ADD: HasRiddleNpcs: bool
├── ADD: AddRiddleNpc(RiddleNpc): void
├── ADD: RemoveRiddleNpc(RiddleNpc): bool
├── ADD: GetRiddleNpcByKeyword(string): RiddleNpc?
├── ADD: IsDirectionBlockedByNpc(Direction): bool
└── ADD: GetBlockingNpc(Direction): RiddleNpc?
```

---

## 9. PuzzleService Updates

### 9.1 Purpose

`PuzzleService` is extended with methods for riddle answer validation, hint management, multi-part puzzle tracking, and reward distribution.

### 9.2 New Result Types

**File:** `src/Core/RuneAndRust.Application/DTOs/RiddleAnswerResult.cs`

```csharp
namespace RuneAndRust.Application.DTOs;

/// <summary>
/// Result of answering a riddle.
/// </summary>
public readonly record struct RiddleAnswerResult
{
    /// <summary>
    /// Gets the riddle NPC that was answered.
    /// </summary>
    public RiddleNpc Npc { get; init; }

    /// <summary>
    /// Gets whether the answer was correct.
    /// </summary>
    public bool Correct { get; init; }

    /// <summary>
    /// Gets the response message.
    /// </summary>
    public string Message { get; init; }

    /// <summary>
    /// Gets the remaining attempts (-1 if unlimited).
    /// </summary>
    public int RemainingAttempts { get; init; }

    /// <summary>
    /// Gets whether max failures was reached.
    /// </summary>
    public bool MaxFailuresReached { get; init; }

    /// <summary>
    /// Gets the consequence applied (if max failures).
    /// </summary>
    public RiddleConsequence? ConsequenceApplied { get; init; }

    /// <summary>
    /// Gets the reward granted (if correct).
    /// </summary>
    public LootDrop? Reward { get; init; }
}
```

**File:** `src/Core/RuneAndRust.Application/DTOs/PuzzleHintResult.cs`

```csharp
namespace RuneAndRust.Application.DTOs;

/// <summary>
/// Result of requesting a puzzle hint.
/// </summary>
public readonly record struct PuzzleHintResult
{
    /// <summary>
    /// Gets the puzzle the hint is for.
    /// </summary>
    public Puzzle Puzzle { get; init; }

    /// <summary>
    /// Gets whether the hint was successfully revealed.
    /// </summary>
    public bool Success { get; init; }

    /// <summary>
    /// Gets the revealed hint (if successful).
    /// </summary>
    public PuzzleHint? Hint { get; init; }

    /// <summary>
    /// Gets the dice roll result (if check required).
    /// </summary>
    public int? RollResult { get; init; }

    /// <summary>
    /// Gets the DC that was required (if check required).
    /// </summary>
    public int? DC { get; init; }

    /// <summary>
    /// Gets whether there are no more hints available.
    /// </summary>
    public bool NoMoreHints { get; init; }

    /// <summary>
    /// Gets the result message.
    /// </summary>
    public string Message { get; init; }
}
```

**File:** `src/Core/RuneAndRust.Application/DTOs/PuzzleRewardResult.cs`

```csharp
namespace RuneAndRust.Application.DTOs;

/// <summary>
/// Result of applying puzzle rewards.
/// </summary>
public readonly record struct PuzzleRewardResult
{
    /// <summary>
    /// Gets the puzzle that was completed.
    /// </summary>
    public Puzzle Puzzle { get; init; }

    /// <summary>
    /// Gets the loot drop (if any).
    /// </summary>
    public LootDrop? Loot { get; init; }

    /// <summary>
    /// Gets descriptions of effects applied.
    /// </summary>
    public IReadOnlyList<string> EffectsApplied { get; init; }

    /// <summary>
    /// Gets the result message.
    /// </summary>
    public string Message { get; init; }
}
```

### 9.3 Interface Updates

**File:** `src/Core/RuneAndRust.Application/Interfaces/IPuzzleService.cs`

```csharp
// Add to IPuzzleService interface

/// <summary>
/// Validates a riddle answer.
/// </summary>
/// <param name="npc">The riddle NPC.</param>
/// <param name="answer">The player's answer.</param>
/// <param name="player">The player attempting.</param>
/// <returns>The riddle answer result.</returns>
RiddleAnswerResult ValidateRiddleAnswer(RiddleNpc npc, string answer, Player player);

/// <summary>
/// Gets the next available hint for a puzzle.
/// </summary>
/// <param name="puzzle">The puzzle.</param>
/// <param name="player">The player requesting.</param>
/// <returns>The hint result.</returns>
PuzzleHintResult GetNextHint(Puzzle puzzle, Player player);

/// <summary>
/// Records a multi-part puzzle component as solved.
/// </summary>
/// <param name="multiPartPuzzle">The multi-part puzzle.</param>
/// <param name="componentId">The component puzzle ID.</param>
/// <returns>The step result including completion status.</returns>
PuzzleStepResult RecordMultiPartComponent(MultiPartPuzzle multiPartPuzzle, string componentId);

/// <summary>
/// Applies rewards for completing a puzzle.
/// </summary>
/// <param name="puzzle">The completed puzzle.</param>
/// <param name="player">The player receiving rewards.</param>
/// <param name="room">The room for effects.</param>
/// <returns>The reward result.</returns>
PuzzleRewardResult ApplyPuzzleReward(Puzzle puzzle, Player player, Room room);
```

### 9.4 Service Implementation Overview

**File:** `src/Infrastructure/RuneAndRust.Infrastructure/Services/PuzzleService.cs`

```csharp
// Add to PuzzleService class

/// <inheritdoc />
public RiddleAnswerResult ValidateRiddleAnswer(RiddleNpc npc, string answer, Player player)
{
    ArgumentNullException.ThrowIfNull(npc);
    ArgumentNullException.ThrowIfNull(player);

    if (npc.RiddleSolved)
    {
        return new RiddleAnswerResult
        {
            Npc = npc,
            Correct = false,
            Message = npc.SolvedMessage,
            RemainingAttempts = 0
        };
    }

    var riddle = _riddleRepository.GetById(npc.CurrentRiddleId);
    if (riddle == null)
    {
        _logger.LogError("Riddle {RiddleId} not found for NPC {NpcName}",
            npc.CurrentRiddleId, npc.Name);
        return new RiddleAnswerResult
        {
            Npc = npc,
            Correct = false,
            Message = "The riddle could not be found.",
            RemainingAttempts = npc.GetRemainingAttempts()
        };
    }

    if (riddle.ValidateAnswer(answer))
    {
        _logger.LogInformation("Player {PlayerId} correctly answered riddle for {NpcName}",
            player.Id, npc.Name);

        npc.MarkSolved();

        LootDrop? reward = null;
        if (npc.RewardId != null)
        {
            reward = _lootService.GenerateLoot(npc.RewardId, player);
        }

        return new RiddleAnswerResult
        {
            Npc = npc,
            Correct = true,
            Message = riddle.CorrectMessage,
            RemainingAttempts = 0,
            Reward = reward
        };
    }
    else
    {
        var maxReached = npc.RecordWrongAnswer();

        _logger.LogDebug("Player {PlayerId} gave wrong answer to {NpcName}. Attempts: {Count}/{Max}",
            player.Id, npc.Name, npc.WrongAnswerCount, npc.MaxWrongAnswers);

        if (maxReached && npc.FailureConsequence.HasValue)
        {
            ApplyRiddleConsequence(npc, player);
        }

        return new RiddleAnswerResult
        {
            Npc = npc,
            Correct = false,
            Message = riddle.WrongMessage,
            RemainingAttempts = npc.GetRemainingAttempts(),
            MaxFailuresReached = maxReached,
            ConsequenceApplied = maxReached ? npc.FailureConsequence : null
        };
    }
}

private void ApplyRiddleConsequence(RiddleNpc npc, Player player)
{
    switch (npc.FailureConsequence)
    {
        case RiddleConsequence.BecomeHostile:
            _logger.LogInformation("{NpcName} becomes hostile to player {PlayerId}",
                npc.Name, player.Id);
            // Combat system integration
            break;

        case RiddleConsequence.Disappear:
            _logger.LogInformation("{NpcName} disappears", npc.Name);
            // NPC removed from room
            break;

        case RiddleConsequence.ApplyPenalty:
            _logger.LogInformation("{NpcName} applies penalty to player {PlayerId}",
                npc.Name, player.Id);
            // Apply negative effect
            break;

        case RiddleConsequence.Reset:
            _logger.LogInformation("{NpcName} riddle resets", npc.Name);
            npc.Reset();
            break;
    }
}

/// <inheritdoc />
public PuzzleHintResult GetNextHint(Puzzle puzzle, Player player)
{
    ArgumentNullException.ThrowIfNull(puzzle);
    ArgumentNullException.ThrowIfNull(player);

    var revealedCount = puzzle.RevealedHintCount;
    var allHints = puzzle.Definition?.Hints ?? Array.Empty<PuzzleHint>();
    var orderedHints = allHints.OrderBy(h => h.Order).ToList();

    if (revealedCount >= orderedHints.Count)
    {
        return new PuzzleHintResult
        {
            Puzzle = puzzle,
            Success = false,
            NoMoreHints = true,
            Message = "You've already revealed all available hints for this puzzle."
        };
    }

    var nextHint = orderedHints[revealedCount];

    if (nextHint.HasCost)
    {
        var rollResult = _diceService.RollAttributeCheck(
            player,
            nextHint.RevealAttribute!,
            nextHint.RevealDC);

        if (!rollResult.Success)
        {
            _logger.LogDebug("Player {PlayerId} failed hint check for puzzle {PuzzleId}. Roll: {Roll}, DC: {DC}",
                player.Id, puzzle.Id, rollResult.Total, nextHint.RevealDC);

            return new PuzzleHintResult
            {
                Puzzle = puzzle,
                Success = false,
                RollResult = rollResult.Total,
                DC = nextHint.RevealDC,
                Message = "You fail to gain any insight."
            };
        }

        _logger.LogDebug("Player {PlayerId} passed hint check for puzzle {PuzzleId}. Roll: {Roll}, DC: {DC}",
            player.Id, puzzle.Id, rollResult.Total, nextHint.RevealDC);
    }

    puzzle.RevealHint();

    _logger.LogInformation("Hint revealed for puzzle {PuzzleId}. Hint #{HintNum}",
        puzzle.Id, revealedCount + 1);

    return new PuzzleHintResult
    {
        Puzzle = puzzle,
        Success = true,
        Hint = nextHint,
        RollResult = nextHint.HasCost ? null : null,
        DC = nextHint.HasCost ? nextHint.RevealDC : null,
        Message = nextHint.HasCost ? "[HINT REVEALED]" : "[HINT REVEALED - FREE]"
    };
}

/// <inheritdoc />
public PuzzleStepResult RecordMultiPartComponent(MultiPartPuzzle multiPartPuzzle, string componentId)
{
    ArgumentNullException.ThrowIfNull(multiPartPuzzle);
    ArgumentException.ThrowIfNullOrWhiteSpace(componentId);

    var success = multiPartPuzzle.RecordComponentSolved(componentId);

    if (!success)
    {
        if (multiPartPuzzle.RequiresOrder)
        {
            var expected = multiPartPuzzle.GetNextExpectedComponent();
            return new PuzzleStepResult
            {
                Success = false,
                Message = $"Components must be solved in order. Expected: {expected}"
            };
        }

        return new PuzzleStepResult
        {
            Success = false,
            Message = "This component is not part of the puzzle or already solved."
        };
    }

    _logger.LogInformation("Multi-part puzzle {MasterPuzzleId}: component {ComponentId} solved. Progress: {Solved}/{Total}",
        multiPartPuzzle.MasterPuzzleId, componentId,
        multiPartPuzzle.SolvedCount, multiPartPuzzle.ComponentPuzzleIds.Count);

    return new PuzzleStepResult
    {
        Success = true,
        IsComplete = multiPartPuzzle.IsComplete,
        Progress = multiPartPuzzle.SolvedCount,
        TotalSteps = multiPartPuzzle.ComponentPuzzleIds.Count,
        Message = multiPartPuzzle.IsComplete
            ? "[MULTI-PART PUZZLE COMPLETE]"
            : $"Component solved! Progress: {multiPartPuzzle.SolvedCount}/{multiPartPuzzle.ComponentPuzzleIds.Count}"
    };
}

/// <inheritdoc />
public PuzzleRewardResult ApplyPuzzleReward(Puzzle puzzle, Player player, Room room)
{
    ArgumentNullException.ThrowIfNull(puzzle);
    ArgumentNullException.ThrowIfNull(player);
    ArgumentNullException.ThrowIfNull(room);

    var effects = new List<string>();
    LootDrop? loot = null;

    // Generate loot reward
    if (!string.IsNullOrEmpty(puzzle.RewardLootTableId))
    {
        loot = _lootService.GenerateLoot(puzzle.RewardLootTableId, player);
        _logger.LogInformation("Puzzle {PuzzleId} granted loot to player {PlayerId}",
            puzzle.Id, player.Id);
    }

    // Apply completion effects
    foreach (var effect in puzzle.CompletionEffects)
    {
        ApplyCompletionEffect(effect, room);
        effects.Add(effect.Description);
    }

    return new PuzzleRewardResult
    {
        Puzzle = puzzle,
        Loot = loot,
        EffectsApplied = effects,
        Message = BuildRewardMessage(loot, effects)
    };
}

private void ApplyCompletionEffect(PuzzleCompletionEffect effect, Room room)
{
    switch (effect.Type)
    {
        case CompletionEffectType.OpenDoor:
            // Unlock specified door
            break;
        case CompletionEffectType.DisableTrap:
            // Disable specified trap
            break;
        case CompletionEffectType.RevealSecret:
            // Reveal hidden object/passage
            break;
        case CompletionEffectType.SpawnItem:
            // Create item in room
            break;
    }

    _logger.LogInformation("Applied puzzle completion effect: {EffectType}", effect.Type);
}

private static string BuildRewardMessage(LootDrop? loot, List<string> effects)
{
    var parts = new List<string>();

    if (loot?.Items.Count > 0)
    {
        parts.Add($"You receive: {string.Join(", ", loot.Items.Select(i => $"{i.Name} x{i.Quantity}"))}");
    }

    if (loot?.Currency > 0)
    {
        parts.Add($"You receive: {loot.Currency} gold");
    }

    parts.AddRange(effects);

    return string.Join("\n", parts);
}
```

---

## 10. User-Facing Commands

### 10.1 Talk Command

**Purpose:** Initiate conversation with a riddle NPC.

**Syntax:** `talk <npc>`

**Output Example:**

```
> talk sphinx

The ancient Sphinx regards you with knowing eyes.

"Traveler, I guard the passage to the eastern chambers.
Answer my riddle correctly, and you may pass.
Fail three times, and face my wrath."

The Sphinx poses its riddle:

"I have cities, but no houses.
 I have mountains, but no trees.
 I have water, but no fish.
 What am I?"
```

### 10.2 Answer Command

**Purpose:** Answer a riddle posed by an NPC.

**Syntax:** `answer <response>`

**Output Examples:**

**Wrong Answer:**
```
> answer ocean

The Sphinx shakes its head slowly.

"That is not correct, traveler. You have 2 attempts remaining."
```

**Correct Answer:**
```
> answer map

The Sphinx nods approvingly.

"Correct! You may pass, clever one."

[RIDDLE SOLVED]
The Sphinx steps aside, clearing the eastern passage.

You receive: Ancient Coin x3
```

**Max Failures:**
```
> answer river

The Sphinx's eyes flash with anger.

"That is not correct, traveler."

[RIDDLE FAILED]
The Sphinx rises, claws extended!

The Sphinx becomes hostile!
```

### 10.3 Hint Command

**Purpose:** Request a hint for the current or specified puzzle.

**Syntax:** `hint` or `hint <puzzle>`

**Output Examples:**

**Failed Check:**
```
> hint

You study the Vault Lock puzzle carefully...

[Rolling Intelligence: DC 12]
Roll: 2d6 + 2 = [4, 5] + 2 = 11

You fail to gain any insight.
```

**Successful Check:**
```
> hint

You study the Vault Lock puzzle carefully...

[Rolling Intelligence: DC 12]
Roll: 2d6 + 2 = [6, 3] + 2 = 11

[HINT REVEALED]
"The first digit is even."
```

**Free Hint:**
```
> hint

[HINT REVEALED - FREE]
"The digits are all different."
```

**No More Hints:**
```
> hint

You've already revealed all available hints for this puzzle.
```

### 10.4 Multi-Part Puzzle Examination

**Output Example:**

```
> examine crystal fragments

Crystal Resonance Puzzle
========================
Three crystal fragments scattered across the dungeon
must be activated in the correct order to unlock
the treasure vault.

Type: Multi-Part Sequence
Status: In Progress
Progress: ██████░░ 2/3 fragments activated

Activated: Blue Crystal (Library), Red Crystal (Chapel)
Remaining: Green Crystal (location unknown)
```

### 10.5 Multi-Part Puzzle Completion

**Output Example:**

```
> activate green crystal

The Green Crystal hums with energy!

[MULTI-PART PUZZLE COMPLETE]
All three crystals resonate in harmony!
A distant rumble echoes through the dungeon...

The Treasure Vault is now accessible!
```

### 10.6 Movement Blocked by NPC

**Output Example:**

```
> go east

The Ancient Sphinx blocks your path.

"Answer my riddle before you may pass, traveler."

Use 'talk sphinx' to hear the riddle.
```

---

## 11. Data Model Changes

### 11.1 Summary Table

| Type | Category | Layer | Description |
|------|----------|-------|-------------|
| `RiddleDefinition` | Definition | Domain | Riddle configuration |
| `RiddleNpc` | Entity | Domain | NPC that poses riddles |
| `RiddleConsequence` | Enum | Domain | Failure consequences |
| `PuzzleHint` | Value Object | Domain | Hint configuration |
| `MultiPartPuzzle` | Value Object | Domain | Cross-room puzzle tracking |
| `RiddleAnswerResult` | DTO | Application | Riddle answer result |
| `PuzzleHintResult` | DTO | Application | Hint request result |
| `PuzzleRewardResult` | DTO | Application | Reward distribution result |

### 11.2 Entity Details

#### RiddleNpc

**File:** `src/Core/RuneAndRust.Domain/Entities/RiddleNpc.cs`

| Property | Type | Description |
|----------|------|-------------|
| `Id` | `Guid` | Unique identifier |
| `Name` | `string` | Display name |
| `Description` | `string` | NPC description |
| `CurrentRiddleId` | `string` | Reference to riddle definition |
| `RiddleSolved` | `bool` | Whether riddle is solved |
| `WrongAnswerCount` | `int` | Wrong answer count |
| `MaxWrongAnswers` | `int` | Max attempts (-1 = unlimited) |
| `RewardId` | `string?` | Loot table reference |
| `FailureConsequence` | `RiddleConsequence?` | Consequence on max failures |
| `GreetingMessage` | `string` | First interaction message |
| `SolvedMessage` | `string` | Already-solved message |
| `BlocksPassage` | `bool` | Blocks movement |
| `BlockedDirection` | `Direction?` | Which direction blocked |

### 11.3 Enum Details

#### RiddleConsequence

**File:** `src/Core/RuneAndRust.Domain/Enums/RiddleConsequence.cs`

| Value | Description |
|-------|-------------|
| `BecomeHostile` | NPC attacks the player |
| `Disappear` | NPC disappears from room |
| `ApplyPenalty` | NPC applies negative effect |
| `Reset` | Riddle resets (can retry later) |

### 11.4 Value Object Details

#### PuzzleHint

**File:** `src/Core/RuneAndRust.Domain/ValueObjects/PuzzleHint.cs`

| Property | Type | Description |
|----------|------|-------------|
| `Text` | `string` | Hint text |
| `Order` | `int` | Reveal order |
| `RevealDC` | `int` | DC for check (0 = free) |
| `RevealAttribute` | `string?` | Attribute for check |

#### MultiPartPuzzle

**File:** `src/Core/RuneAndRust.Domain/ValueObjects/MultiPartPuzzle.cs`

| Property | Type | Description |
|----------|------|-------------|
| `MasterPuzzleId` | `string` | Master puzzle ID |
| `ComponentPuzzleIds` | `IReadOnlyList<string>` | Component IDs |
| `RequiresOrder` | `bool` | Order matters |
| `RequiredOrder` | `IReadOnlyList<string>` | Required order |
| `ComponentRooms` | `IReadOnlyDictionary<string, Guid>` | Room mapping |
| `SolvedCount` | `int` | Solved count |
| `SolvedComponents` | `IReadOnlyList<string>` | Solved IDs |

---

## 12. Configuration File Schemas

### 12.1 Riddles Configuration

**File:** `config/riddles.json`

```json
{
  "$schema": "../schemas/riddles.schema.json",
  "riddles": [
    {
      "id": "sphinx-riddle-map",
      "question": "I have cities, but no houses. I have mountains, but no trees. I have water, but no fish. What am I?",
      "acceptedAnswers": ["map", "a map"],
      "difficulty": 2,
      "category": "classic",
      "hints": [
        {
          "text": "Think about something you might find on a desk.",
          "order": 1,
          "revealDC": 10,
          "revealAttribute": "Intelligence"
        },
        {
          "text": "It represents something larger than itself.",
          "order": 2,
          "revealDC": 0
        }
      ],
      "correctMessage": "Correct! You may pass, clever one.",
      "wrongMessage": "That is not correct, traveler."
    },
    {
      "id": "riddle-shadow",
      "question": "The more you take, the more you leave behind. What am I?",
      "acceptedAnswers": ["footsteps", "footprints", "steps"],
      "difficulty": 1,
      "category": "classic",
      "hints": [
        {
          "text": "Think about walking.",
          "order": 1,
          "revealDC": 8,
          "revealAttribute": "Intelligence"
        }
      ],
      "correctMessage": "Indeed! Footsteps mark your path.",
      "wrongMessage": "That is not the answer I seek."
    },
    {
      "id": "riddle-time",
      "question": "What can you catch but not throw?",
      "acceptedAnswers": ["cold", "a cold", "disease", "illness"],
      "difficulty": 3,
      "category": "wordplay",
      "hints": [
        {
          "text": "It's not a physical object.",
          "order": 1,
          "revealDC": 12,
          "revealAttribute": "Intelligence"
        },
        {
          "text": "You might need to rest when you have it.",
          "order": 2,
          "revealDC": 0
        }
      ],
      "correctMessage": "Clever! You caught the meaning.",
      "wrongMessage": "Try again, thinker."
    }
  ],
  "riddleNpcs": [
    {
      "id": "sphinx-guardian",
      "name": "Ancient Sphinx",
      "description": "A stone sphinx with eyes that seem to follow your every move.",
      "riddleId": "sphinx-riddle-map",
      "greetingMessage": "Traveler, I guard the passage to the eastern chambers. Answer my riddle correctly, and you may pass.",
      "solvedMessage": "You have proven your wisdom. The path is open to you.",
      "maxWrongAnswers": 3,
      "failureConsequence": "BecomeHostile",
      "blocksPassage": true,
      "blockedDirection": "East",
      "rewardId": "sphinx-reward"
    },
    {
      "id": "old-hermit",
      "name": "Old Hermit",
      "description": "A weathered old man who speaks in riddles.",
      "riddleId": "riddle-shadow",
      "greetingMessage": "Ah, a visitor! I have a puzzle for you, young one.",
      "solvedMessage": "Ha! Sharp mind you have.",
      "maxWrongAnswers": -1,
      "failureConsequence": null,
      "blocksPassage": false,
      "blockedDirection": null,
      "rewardId": "hermit-wisdom"
    }
  ],
  "multiPartPuzzles": [
    {
      "id": "crystal-resonance",
      "name": "Crystal Resonance Puzzle",
      "description": "Three crystal fragments scattered across the dungeon must be activated in the correct order.",
      "masterPuzzleId": "crystal-master",
      "componentPuzzleIds": ["crystal-blue", "crystal-red", "crystal-green"],
      "requiresOrder": true,
      "requiredOrder": ["crystal-blue", "crystal-red", "crystal-green"],
      "componentRooms": {
        "crystal-blue": "room-library",
        "crystal-red": "room-chapel",
        "crystal-green": "room-garden"
      },
      "rewardLootTableId": "crystal-treasure",
      "completionEffects": [
        {
          "type": "OpenDoor",
          "targetId": "vault-door",
          "description": "The Treasure Vault is now accessible!"
        }
      ]
    },
    {
      "id": "elemental-seals",
      "name": "Elemental Seals",
      "description": "Four elemental seals must be activated to open the portal.",
      "masterPuzzleId": "elemental-master",
      "componentPuzzleIds": ["seal-fire", "seal-water", "seal-earth", "seal-air"],
      "requiresOrder": false,
      "requiredOrder": [],
      "componentRooms": {
        "seal-fire": "room-forge",
        "seal-water": "room-fountain",
        "seal-earth": "room-cave",
        "seal-air": "room-tower"
      },
      "rewardLootTableId": "elemental-treasure",
      "completionEffects": [
        {
          "type": "RevealSecret",
          "targetId": "portal-entrance",
          "description": "The portal shimmers into existence!"
        }
      ]
    }
  ]
}
```

### 12.2 JSON Schema

**File:** `config/schemas/riddles.schema.json`

```json
{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "riddles.schema.json",
  "title": "Riddles Configuration",
  "description": "Configuration for riddles, riddle NPCs, and multi-part puzzles",
  "type": "object",
  "properties": {
    "$schema": {
      "type": "string"
    },
    "riddles": {
      "type": "array",
      "description": "Riddle definitions",
      "items": {
        "$ref": "#/definitions/riddle"
      }
    },
    "riddleNpcs": {
      "type": "array",
      "description": "Riddle NPC configurations",
      "items": {
        "$ref": "#/definitions/riddleNpc"
      }
    },
    "multiPartPuzzles": {
      "type": "array",
      "description": "Multi-part puzzle configurations",
      "items": {
        "$ref": "#/definitions/multiPartPuzzle"
      }
    }
  },
  "required": ["riddles"],
  "definitions": {
    "riddle": {
      "type": "object",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique riddle identifier"
        },
        "question": {
          "type": "string",
          "description": "The riddle question text"
        },
        "acceptedAnswers": {
          "type": "array",
          "description": "Valid answers (case-insensitive)",
          "items": { "type": "string" },
          "minItems": 1
        },
        "difficulty": {
          "type": "integer",
          "description": "Difficulty rating (1-5)",
          "minimum": 1,
          "maximum": 5
        },
        "category": {
          "type": "string",
          "description": "Category/theme"
        },
        "hints": {
          "type": "array",
          "description": "Optional hints",
          "items": { "$ref": "#/definitions/puzzleHint" }
        },
        "correctMessage": {
          "type": "string",
          "description": "Message on correct answer"
        },
        "wrongMessage": {
          "type": "string",
          "description": "Message on wrong answer"
        }
      },
      "required": ["id", "question", "acceptedAnswers"]
    },
    "puzzleHint": {
      "type": "object",
      "properties": {
        "text": {
          "type": "string",
          "description": "The hint text"
        },
        "order": {
          "type": "integer",
          "description": "Reveal order (1 = first)",
          "minimum": 1
        },
        "revealDC": {
          "type": "integer",
          "description": "DC for check (0 = free)",
          "minimum": 0
        },
        "revealAttribute": {
          "type": "string",
          "description": "Attribute for check"
        }
      },
      "required": ["text", "order"]
    },
    "riddleNpc": {
      "type": "object",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique NPC identifier"
        },
        "name": {
          "type": "string",
          "description": "Display name"
        },
        "description": {
          "type": "string",
          "description": "NPC description"
        },
        "riddleId": {
          "type": "string",
          "description": "Reference to riddle definition"
        },
        "greetingMessage": {
          "type": "string",
          "description": "First interaction message"
        },
        "solvedMessage": {
          "type": "string",
          "description": "Already-solved message"
        },
        "maxWrongAnswers": {
          "type": "integer",
          "description": "Max attempts (-1 = unlimited)"
        },
        "failureConsequence": {
          "type": "string",
          "description": "Consequence on max failures",
          "enum": ["BecomeHostile", "Disappear", "ApplyPenalty", "Reset"]
        },
        "blocksPassage": {
          "type": "boolean",
          "description": "Whether NPC blocks movement"
        },
        "blockedDirection": {
          "type": "string",
          "description": "Direction blocked",
          "enum": ["North", "South", "East", "West", "Up", "Down", "Northeast", "Northwest", "Southeast", "Southwest"]
        },
        "rewardId": {
          "type": "string",
          "description": "Loot table ID for reward"
        }
      },
      "required": ["id", "name", "description", "riddleId", "greetingMessage", "solvedMessage"]
    },
    "multiPartPuzzle": {
      "type": "object",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique puzzle identifier"
        },
        "name": {
          "type": "string",
          "description": "Display name"
        },
        "description": {
          "type": "string",
          "description": "Puzzle description"
        },
        "masterPuzzleId": {
          "type": "string",
          "description": "Master puzzle ID"
        },
        "componentPuzzleIds": {
          "type": "array",
          "description": "Component puzzle IDs",
          "items": { "type": "string" },
          "minItems": 2
        },
        "requiresOrder": {
          "type": "boolean",
          "description": "Whether order matters"
        },
        "requiredOrder": {
          "type": "array",
          "description": "Required solve order",
          "items": { "type": "string" }
        },
        "componentRooms": {
          "type": "object",
          "description": "Component to room mapping",
          "additionalProperties": { "type": "string" }
        },
        "rewardLootTableId": {
          "type": "string",
          "description": "Loot table for completion"
        },
        "completionEffects": {
          "type": "array",
          "description": "Effects on completion",
          "items": { "$ref": "#/definitions/completionEffect" }
        }
      },
      "required": ["id", "name", "masterPuzzleId", "componentPuzzleIds"]
    },
    "completionEffect": {
      "type": "object",
      "properties": {
        "type": {
          "type": "string",
          "description": "Effect type",
          "enum": ["OpenDoor", "DisableTrap", "RevealSecret", "SpawnItem"]
        },
        "targetId": {
          "type": "string",
          "description": "Target object ID"
        },
        "description": {
          "type": "string",
          "description": "Effect description"
        }
      },
      "required": ["type", "targetId"]
    }
  }
}
```

---

## 13. Logging Specifications

### 13.1 Log Levels by Component

| Component | Level | Events |
|-----------|-------|--------|
| `PuzzleService` | Information | Riddle solved, hint revealed, multi-part complete |
| `PuzzleService` | Debug | Wrong answers, failed hint checks, component progress |
| `PuzzleService` | Warning | Missing riddle definition, invalid component |
| `PuzzleService` | Error | Riddle not found, reward processing failed |
| `RiddleNpc` | Debug | State changes, wrong answer recording |
| `MultiPartPuzzle` | Debug | Component solved, order validation |

### 13.2 Log Message Examples

```csharp
// Information level
_logger.LogInformation("Player {PlayerId} correctly answered riddle for {NpcName}",
    player.Id, npc.Name);

_logger.LogInformation("Hint revealed for puzzle {PuzzleId}. Hint #{HintNum}",
    puzzle.Id, revealedCount + 1);

_logger.LogInformation("Multi-part puzzle {MasterPuzzleId}: component {ComponentId} solved. Progress: {Solved}/{Total}",
    multiPartPuzzle.MasterPuzzleId, componentId,
    multiPartPuzzle.SolvedCount, multiPartPuzzle.ComponentPuzzleIds.Count);

_logger.LogInformation("{NpcName} becomes hostile to player {PlayerId}",
    npc.Name, player.Id);

// Debug level
_logger.LogDebug("Player {PlayerId} gave wrong answer to {NpcName}. Attempts: {Count}/{Max}",
    player.Id, npc.Name, npc.WrongAnswerCount, npc.MaxWrongAnswers);

_logger.LogDebug("Player {PlayerId} failed hint check for puzzle {PuzzleId}. Roll: {Roll}, DC: {DC}",
    player.Id, puzzle.Id, rollResult.Total, nextHint.RevealDC);

// Error level
_logger.LogError("Riddle {RiddleId} not found for NPC {NpcName}",
    npc.CurrentRiddleId, npc.Name);
```

---

## 14. Unit Testing Requirements

### 14.1 Test Count by Feature

| Feature | Test Count |
|---------|------------|
| RiddleDefinition | ~4 |
| PuzzleHint | ~3 |
| RiddleNpc | ~5 |
| MultiPartPuzzle | ~5 |
| Room modifications | ~3 |
| PuzzleService riddle methods | ~3 |
| PuzzleService hint methods | ~2 |
| **Total** | **~25** |

### 14.2 Test Categories

#### RiddleDefinition Tests

- `Create_WithValidParameters_CreatesRiddle`
- `ValidateAnswer_CorrectAnswer_ReturnsTrue`
- `ValidateAnswer_CaseInsensitive_ReturnsTrue`
- `ValidateAnswer_WrongAnswer_ReturnsFalse`

#### PuzzleHint Tests

- `Free_CreatesHintWithZeroDC`
- `WithCheck_CreatesHintWithDCAndAttribute`
- `HasCost_ReturnsTrueWhenDCGreaterThanZero`

#### RiddleNpc Tests

- `Create_WithValidParameters_CreatesNpc`
- `RecordWrongAnswer_IncrementsCount`
- `RecordWrongAnswer_ReturnsTrue_WhenMaxReached`
- `MarkSolved_SetsRiddleSolvedTrue`
- `IsPassageBlocked_ReturnsTrue_WhenBlockingAndUnsolved`

#### MultiPartPuzzle Tests

- `Create_WithValidParameters_CreatesPuzzle`
- `RecordComponentSolved_ValidComponent_ReturnsTrue`
- `RecordComponentSolved_WrongOrder_ReturnsFalse`
- `IsComplete_AllSolved_ReturnsTrue`
- `GetRemainingComponents_ReturnsUnsolvedIds`

#### Room Modification Tests

- `AddRiddleNpc_AddsToCollection`
- `GetRiddleNpcByKeyword_MatchingName_ReturnsNpc`
- `IsDirectionBlockedByNpc_BlockingNpc_ReturnsTrue`

#### PuzzleService Tests

- `ValidateRiddleAnswer_CorrectAnswer_ReturnsTrueAndMarksSOlved`
- `ValidateRiddleAnswer_WrongAnswer_IncrementsCount`
- `ValidateRiddleAnswer_MaxFailures_AppliesConsequence`
- `GetNextHint_FreeHint_ReturnsImmediately`
- `GetNextHint_DCHint_RequiresDiceCheck`

---

## 15. Use Cases

### UC-001: Talk to Riddle NPC

**Actor:** Player
**Flow:** Player enters room → Notices NPC → Executes `talk <npc>` → NPC delivers greeting → NPC poses riddle → Player sees riddle text

### UC-002: Answer Riddle Correctly

**Actor:** Player
**Flow:** Player has active riddle → Executes `answer <response>` → System validates answer → Answer correct → NPC marks solved → System grants reward → Passage unblocked (if applicable)

### UC-003: Answer Riddle Incorrectly

**Actor:** Player
**Flow:** Player has active riddle → Executes `answer <response>` → System validates answer → Answer incorrect → Wrong count incremented → Player sees remaining attempts

### UC-004: Trigger Riddle Consequence

**Actor:** System
**Flow:** Player gives max wrong answers → System checks consequence → Applies consequence (hostile/disappear/penalty/reset) → Player sees result

### UC-005: Request Free Hint

**Actor:** Player
**Flow:** Player has active puzzle → Executes `hint` → Next hint has DC 0 → Hint revealed immediately → Revealed count incremented

### UC-006: Request Checked Hint

**Actor:** Player
**Flow:** Player has active puzzle → Executes `hint` → Next hint has DC > 0 → System rolls attribute check → Success: hint revealed → Failure: no insight gained

### UC-007: Solve Multi-Part Component

**Actor:** Player
**Flow:** Player in room with component → Solves component puzzle → System records component → Progress updated → If ordered: validates sequence

### UC-008: Complete Multi-Part Puzzle

**Actor:** System
**Flow:** Player solves final component → System checks IsComplete → All complete → Apply completion effects → Grant master puzzle reward → Player sees effects

### UC-009: Movement Blocked by NPC

**Actor:** Player
**Flow:** Player executes `go <direction>` → System checks room NPCs → NPC blocks direction → NPC riddle unsolved → Movement denied → Player sees block message

---

## 16. Deliverable Checklist

### Domain Layer

- [ ] `RiddleDefinition` class (`Definitions/RiddleDefinition.cs`)
- [ ] `RiddleNpc` entity (`Entities/RiddleNpc.cs`)
- [ ] `RiddleConsequence` enum (`Enums/RiddleConsequence.cs`)
- [ ] `PuzzleHint` value object (`ValueObjects/PuzzleHint.cs`)
- [ ] `MultiPartPuzzle` value object (`ValueObjects/MultiPartPuzzle.cs`)
- [ ] Room modifications for RiddleNpcs collection

### Application Layer

- [ ] `RiddleAnswerResult` DTO (`DTOs/RiddleAnswerResult.cs`)
- [ ] `PuzzleHintResult` DTO (`DTOs/PuzzleHintResult.cs`)
- [ ] `PuzzleRewardResult` DTO (`DTOs/PuzzleRewardResult.cs`)
- [ ] `IPuzzleService` interface updates

### Infrastructure Layer

- [ ] `PuzzleService` implementation updates

### Presentation Layer

- [ ] `TalkCommand` implementation
- [ ] `AnswerCommand` implementation
- [ ] `HintCommand` implementation
- [ ] Movement integration (NPC blocking)

### Configuration Files

- [ ] `config/riddles.json` created
- [ ] `config/schemas/riddles.schema.json` created
- [ ] `config/puzzles.json` updated with hint support

### Testing

- [ ] ~25 unit tests implemented
- [ ] All tests passing

---

## 17. Acceptance Criteria

### Functional

- [ ] RiddleDefinition stores question and valid answers
- [ ] RiddleNpc can pose riddles to players
- [ ] `answer` command validates riddle responses (case-insensitive)
- [ ] Wrong answer limits trigger consequences
- [ ] Passage-blocking NPCs prevent movement until solved
- [ ] PuzzleHint reveals hints in order
- [ ] Hint dice checks use appropriate attribute
- [ ] `hint` command requests puzzle hints
- [ ] MultiPartPuzzle tracks components across rooms
- [ ] Ordered multi-part puzzles validate sequence
- [ ] Puzzle rewards grant items/currency on solve
- [ ] Puzzle completion can trigger room effects

### Quality

- [ ] Build succeeds with 0 errors/warnings
- [ ] All ~25 unit tests pass
- [ ] Configuration files validate against schemas
- [ ] XML documentation complete on all public types
- [ ] Follows established patterns from v0.4.2a/b

---

## 18. Dependencies

### 18.1 Prerequisites

| Version | Dependency | Description |
|---------|------------|-------------|
| v0.4.2a | Puzzle entity | Core puzzle infrastructure |
| v0.4.2a | PuzzleState | State machine |
| v0.4.2a | PuzzleService | Base service methods |
| v0.4.2b | Puzzle types | Type-specific mechanics |
| v0.4.1c | LootService | Reward generation |
| v0.4.0 | InteractiveObject | Puzzle object integration |

### 18.2 What v0.4.2c Provides

| Feature | Consumer |
|---------|----------|
| `RiddleNpc` | NPC interactions, future dialogue |
| `PuzzleHint` | All puzzle types |
| `MultiPartPuzzle` | Cross-room puzzle tracking |
| Passage blocking | Movement system integration |
| Reward integration | Loot distribution |

### 18.3 Dependency Diagram

```
v0.4.2a (Puzzle Core)
    │
    ├── Puzzle entity
    ├── PuzzleState enum
    ├── PuzzleAttempt
    └── PuzzleService (base)
            │
            ▼
v0.4.2b (Puzzle Types)
    │
    ├── SequencePuzzle
    ├── CombinationPuzzle
    ├── PatternPuzzle
    └── Type-specific validation
            │
            ▼
v0.4.2c (Riddles & Advanced) ◀── THIS VERSION
    │
    ├── RiddleDefinition
    ├── RiddleNpc
    ├── PuzzleHint
    ├── MultiPartPuzzle
    └── Reward integration
            │
            ▼
v0.4.3 (Light & Environment)
    │
    └── Light puzzles, perception
```

---

## 19. Future Considerations

### Deferred to Future Versions

- **Complex NPC dialogue trees**: Full conversation systems beyond riddles
- **Puzzle generation/randomization**: Procedurally generated puzzles
- **Time-limited puzzles**: Puzzles with countdown timers
- **Riddle categories**: Themed riddle collections per dungeon area
- **Hint economy**: Hint tokens or costs beyond dice checks
- **Multi-NPC riddle chains**: NPCs that reference each other's riddles

### Integration Points for v0.4.3+

- Light puzzles using darkness/light mechanics
- Environmental puzzle elements
- Perception affecting puzzle detection
- Weather-affected outdoor puzzles

---

*Document Version: 1.0*
*Last Updated: 2026-01-10*
*Author: Claude*
