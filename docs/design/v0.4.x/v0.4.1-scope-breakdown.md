# v0.4.1 Traps & Environmental Hazards - Scope Breakdown

**Version:** 0.4.1
**Theme:** Traps & Environmental Hazards
**Prerequisites:** v0.4.0 Complete (Interactive Objects Foundation)
**Total Estimated Tests:** ~85 new tests

---

## Executive Summary

The Traps & Environmental Hazards version introduces danger and risk to dungeon exploration through hidden traps and persistent hazard zones. Players must use perception to detect traps, skill checks to disarm them, and saving throws to mitigate damage when triggered. This system builds on the InteractiveObject foundation from v0.4.0 and integrates with the existing status effect and damage systems.

Key focus areas:
- **Trap Entity**: Hidden dangers with trigger conditions and effects
- **Trap Detection & Disarm**: Perception checks to spot, skill checks to disable
- **Trigger Types**: Step, touch, proximity, tripwire, and open-container triggers
- **Hazard Zones**: Persistent area effects like poison gas, fire, and ice
- **Saving Throws**: Dice-based mitigation for trap and hazard damage

The work is divided into **three sub-phases**:

| Phase | Name | Focus | Est. Tests |
|-------|------|-------|------------|
| v0.4.1a | Trap Core | Trap entity, states, detection, disarm mechanics | ~35 |
| v0.4.1b | Trap Types & Triggers | Trigger types, trap varieties, trapped containers | ~25 |
| v0.4.1c | Environmental Hazards | Hazard zones, saving throws, ongoing effects | ~25 |

---

## Existing Infrastructure

### Already Implemented (from v0.4.0)

| Feature | Location | Notes |
|---------|----------|-------|
| InteractiveObject entity | `Domain/Entities/InteractiveObject.cs` | Base for trap triggers |
| ObjectState enum | `Domain/Enums/ObjectState.cs` | Hidden, Active, Broken |
| ObjectEffect value object | `Domain/ValueObjects/ObjectEffect.cs` | Effect triggering |
| DestructibleProperties | `Domain/ValueObjects/DestructibleProperties.cs` | Breakable traps |
| InteractionService | `Application/Services/InteractionService.cs` | Interaction handling |
| Room.Interactables | `Domain/Entities/Room.cs` | Object collections |
| ContainerInventory | `Domain/ValueObjects/ContainerInventory.cs` | Trapped containers |

### Already Implemented (from prior versions)

| Feature | Location | Notes |
|---------|----------|-------|
| DiceService | `Application/Services/DiceService.cs` | Detection/disarm rolls |
| SkillCheckService | `Application/Services/SkillCheckService.cs` | Skill-based checks |
| StatusEffectService | `Application/Services/StatusEffectService.cs` | Apply trap effects |
| StatusEffectDefinition | `Domain/Definitions/StatusEffectDefinition.cs` | Poison, burn, etc. |
| DamageCalculationService | `Application/Services/DamageCalculationService.cs` | Trap damage |
| DamageTypeDefinition | `Domain/Definitions/DamageTypeDefinition.cs` | Damage types |
| DamageInstance | `Domain/ValueObjects/DamageInstance.cs` | Damage application |
| Player.TakeDamage | `Domain/Entities/Player.cs` | Damage handling |

### Needs Implementation (v0.4.1)

| Feature | Phase | Notes |
|---------|-------|-------|
| Trap entity | v0.4.1a | Hidden dangers |
| TrapState enum | v0.4.1a | Hidden, Detected, Triggered, etc. |
| TrapDefinition | v0.4.1a | Configuration |
| TrapService | v0.4.1a | Detection, disarm, trigger logic |
| Room.Traps | v0.4.1a | Trap collection |
| TriggerType enum | v0.4.1b | Step, Touch, Open, etc. |
| TrapEffect value object | v0.4.1b | Damage, status, alerts |
| Trapped containers | v0.4.1b | Container + trap binding |
| HazardZone entity | v0.4.1c | Persistent area effects |
| HazardDefinition | v0.4.1c | Hazard configuration |
| SavingThrow | v0.4.1c | Mitigation dice checks |

---

## Feature Analysis & Categorization

### Core Trap Features

| Feature | Complexity | Dependencies | Assigned Phase |
|---------|------------|--------------|----------------|
| Trap entity | High | InteractiveObject | **v0.4.1a** |
| TrapState enum | Low | None | **v0.4.1a** |
| TrapDefinition | Medium | Configuration | **v0.4.1a** |
| Trap detection (Perception) | Medium | DiceService | **v0.4.1a** |
| Trap disarm | Medium | SkillCheckService | **v0.4.1a** |
| Room.Traps collection | Medium | Room | **v0.4.1a** |
| TrapService | High | All core types | **v0.4.1a** |
| Search command integration | Medium | InteractionService | **v0.4.1a** |

### Trigger & Trap Type Features

| Feature | Complexity | Dependencies | Assigned Phase |
|---------|------------|--------------|----------------|
| TriggerType enum | Low | None | **v0.4.1b** |
| TrapEffect value object | Medium | StatusEffect, Damage | **v0.4.1b** |
| Pressure plates (Step) | Medium | Trap, Movement | **v0.4.1b** |
| Tripwires | Medium | Trap, Movement | **v0.4.1b** |
| Dart traps | Medium | Trap, Damage | **v0.4.1b** |
| Pit traps | High | Trap, Fall damage | **v0.4.1b** |
| Trapped containers | Medium | Container, Trap | **v0.4.1b** |

### Environmental Hazard Features

| Feature | Complexity | Dependencies | Assigned Phase |
|---------|------------|--------------|----------------|
| HazardZone entity | High | Room | **v0.4.1c** |
| HazardDefinition | Medium | Configuration | **v0.4.1c** |
| Poison gas zones | Medium | HazardZone, StatusEffect | **v0.4.1c** |
| Fire zones | Medium | HazardZone, Damage | **v0.4.1c** |
| Ice/cold zones | Medium | HazardZone, StatusEffect | **v0.4.1c** |
| Spike floors | Medium | HazardZone, Damage | **v0.4.1c** |
| Saving throws | Medium | DiceService | **v0.4.1c** |
| Room.HazardZones | Medium | Room | **v0.4.1c** |

---

## Phase Definitions

---

## v0.4.1a: Trap Core

[v0.4.1a Design Specification](v0.4.1a-design-specification.md)

### Overview

Establish the foundational `Trap` entity with state management, detection mechanics using Perception checks, and disarm mechanics using skill checks. This phase creates the core trap system that specific trap types will extend.

### Scope

**In Scope:**
- `Trap` entity with state tracking
- `TrapState` enum (Hidden, Detected, Triggered, Disarmed, Broken)
- `TrapDefinition` for JSON configuration
- Trap detection via Perception/search dice check
- Trap disarm via skill check (configurable DC)
- `TrapService` for detection, disarm, and trigger logic
- `Room.Traps` collection
- `search` command integration for trap detection
- `disarm` command for detected traps
- Passive detection (automatic check on room entry)
- Detection difficulty ratings

**Out of Scope:**
- Specific trigger types (v0.4.1b)
- Trap effect application (v0.4.1b)
- Trapped containers (v0.4.1b)
- Environmental hazards (v0.4.1c)
- Saving throws (v0.4.1c)

### Key Deliverables

| Type | Count | Details |
|------|-------|---------|
| Domain Entities | 1 | `Trap` |
| Domain Enums | 1 | `TrapState` |
| Domain Definitions | 1 | `TrapDefinition` |
| Application Services | 1 | `TrapService` |
| Application Interfaces | 1 | `ITrapService` |
| Commands | 1 | `disarm` |
| Room Updates | 1 | Add Traps collection |
| Configuration | 1 | `traps.json` |
| Unit Tests | ~35 | Entity, service, detection tests |

### Trap Entity

```csharp
namespace RuneAndRust.Domain.Entities;

/// <summary>
/// Represents a hidden danger that can be triggered by player actions.
/// </summary>
public class Trap : IEntity
{
    /// <summary>
    /// Gets the unique identifier for this trap.
    /// </summary>
    public Guid Id { get; private set; }

    /// <summary>
    /// Gets the definition ID from configuration.
    /// </summary>
    public string DefinitionId { get; private set; } = string.Empty;

    /// <summary>
    /// Gets the display name of this trap (shown when detected).
    /// </summary>
    public string Name { get; private set; } = string.Empty;

    /// <summary>
    /// Gets the description shown when examining a detected trap.
    /// </summary>
    public string Description { get; private set; } = string.Empty;

    /// <summary>
    /// Gets the current state of this trap.
    /// </summary>
    public TrapState State { get; private set; } = TrapState.Hidden;

    /// <summary>
    /// Gets the Perception DC to detect this trap.
    /// </summary>
    public int DetectionDC { get; private set; }

    /// <summary>
    /// Gets the skill check DC to disarm this trap.
    /// </summary>
    public int DisarmDC { get; private set; }

    /// <summary>
    /// Gets whether this trap can be disarmed.
    /// </summary>
    public bool CanBeDisarmed { get; private set; } = true;

    /// <summary>
    /// Gets whether this trap resets after triggering.
    /// </summary>
    public bool Resets { get; private set; }

    /// <summary>
    /// Gets the turns until reset (0 = immediate, -1 = never).
    /// </summary>
    public int ResetDelay { get; private set; }

    /// <summary>
    /// Gets turns remaining until reset.
    /// </summary>
    public int? TurnsUntilReset { get; private set; }

    /// <summary>
    /// Gets whether this trap is currently active (can trigger).
    /// </summary>
    public bool IsActive => State == TrapState.Hidden || State == TrapState.Detected;

    /// <summary>
    /// Gets whether this trap has been detected.
    /// </summary>
    public bool IsDetected => State == TrapState.Detected;

    /// <summary>
    /// Gets whether this trap is still hidden.
    /// </summary>
    public bool IsHidden => State == TrapState.Hidden;

    /// <summary>
    /// Gets whether this trap has been triggered.
    /// </summary>
    public bool IsTriggered => State == TrapState.Triggered;

    /// <summary>
    /// Gets whether this trap has been safely disarmed.
    /// </summary>
    public bool IsDisarmed => State == TrapState.Disarmed;

    /// <summary>
    /// Gets the associated interactive object ID (for trapped containers/doors).
    /// </summary>
    public Guid? AttachedObjectId { get; private set; }

    /// <summary>
    /// Gets whether this trap is attached to an interactive object.
    /// </summary>
    public bool IsAttachedToObject => AttachedObjectId.HasValue;

    private Trap() { }

    /// <summary>
    /// Creates a new trap.
    /// </summary>
    public static Trap Create(
        string definitionId,
        string name,
        string description,
        int detectionDC,
        int disarmDC,
        bool canBeDisarmed = true,
        bool resets = false,
        int resetDelay = 0,
        Guid? attachedObjectId = null)
    {
        ArgumentException.ThrowIfNullOrWhiteSpace(definitionId);
        ArgumentException.ThrowIfNullOrWhiteSpace(name);

        return new Trap
        {
            Id = Guid.NewGuid(),
            DefinitionId = definitionId,
            Name = name,
            Description = description,
            DetectionDC = detectionDC,
            DisarmDC = disarmDC,
            CanBeDisarmed = canBeDisarmed,
            Resets = resets,
            ResetDelay = resetDelay,
            AttachedObjectId = attachedObjectId
        };
    }

    /// <summary>
    /// Attempts to detect this trap with a Perception check.
    /// </summary>
    public bool TryDetect(int perceptionRoll)
    {
        if (State != TrapState.Hidden)
            return State == TrapState.Detected;

        if (perceptionRoll >= DetectionDC)
        {
            State = TrapState.Detected;
            return true;
        }

        return false;
    }

    /// <summary>
    /// Attempts to disarm this trap with a skill check.
    /// </summary>
    public DisarmResult TryDisarm(int skillRoll)
    {
        if (!CanBeDisarmed)
            return DisarmResult.CannotDisarm;

        if (State == TrapState.Disarmed)
            return DisarmResult.AlreadyDisarmed;

        if (State == TrapState.Triggered || State == TrapState.Broken)
            return DisarmResult.TrapInactive;

        if (State == TrapState.Hidden)
            return DisarmResult.NotDetected;

        if (skillRoll >= DisarmDC)
        {
            State = TrapState.Disarmed;
            return DisarmResult.Success;
        }

        // Critical failure (roll 5+ below DC) triggers the trap
        if (skillRoll <= DisarmDC - 5)
        {
            return DisarmResult.CriticalFailure;
        }

        return DisarmResult.Failure;
    }

    /// <summary>
    /// Triggers this trap.
    /// </summary>
    public bool Trigger()
    {
        if (!IsActive)
            return false;

        State = TrapState.Triggered;

        if (Resets && ResetDelay >= 0)
        {
            TurnsUntilReset = ResetDelay;
        }

        return true;
    }

    /// <summary>
    /// Processes turn tick for resetting traps.
    /// </summary>
    public bool TickReset()
    {
        if (!Resets || State != TrapState.Triggered || !TurnsUntilReset.HasValue)
            return false;

        TurnsUntilReset--;

        if (TurnsUntilReset <= 0)
        {
            State = TrapState.Hidden;
            TurnsUntilReset = null;
            return true;
        }

        return false;
    }

    /// <summary>
    /// Breaks/destroys this trap.
    /// </summary>
    public void Break()
    {
        State = TrapState.Broken;
    }
}

/// <summary>
/// Result of attempting to disarm a trap.
/// </summary>
public enum DisarmResult
{
    /// <summary>Trap successfully disarmed.</summary>
    Success,

    /// <summary>Disarm attempt failed but trap didn't trigger.</summary>
    Failure,

    /// <summary>Critical failure - trap triggered during disarm.</summary>
    CriticalFailure,

    /// <summary>Trap cannot be disarmed.</summary>
    CannotDisarm,

    /// <summary>Trap was already disarmed.</summary>
    AlreadyDisarmed,

    /// <summary>Trap is not active (triggered or broken).</summary>
    TrapInactive,

    /// <summary>Trap must be detected before disarming.</summary>
    NotDetected
}
```

### TrapState Enum

```csharp
namespace RuneAndRust.Domain.Enums;

/// <summary>
/// Represents the current state of a trap.
/// </summary>
public enum TrapState
{
    /// <summary>Trap is hidden and has not been detected.</summary>
    Hidden,

    /// <summary>Trap has been detected but not triggered or disarmed.</summary>
    Detected,

    /// <summary>Trap has been triggered and its effects applied.</summary>
    Triggered,

    /// <summary>Trap has been safely disarmed.</summary>
    Disarmed,

    /// <summary>Trap has been destroyed/broken.</summary>
    Broken
}
```

### TrapService Interface

```csharp
namespace RuneAndRust.Application.Interfaces;

/// <summary>
/// Service for managing trap detection, disarming, and triggering.
/// </summary>
public interface ITrapService
{
    /// <summary>
    /// Performs passive detection check when entering a room.
    /// </summary>
    IEnumerable<TrapDetectionResult> CheckPassiveDetection(Player player, Room room);

    /// <summary>
    /// Performs active search for traps in the room.
    /// </summary>
    IEnumerable<TrapDetectionResult> SearchForTraps(Player player, Room room);

    /// <summary>
    /// Attempts to disarm a detected trap.
    /// </summary>
    TrapDisarmResult AttemptDisarm(Player player, Trap trap);

    /// <summary>
    /// Checks if player movement triggers any traps.
    /// </summary>
    IEnumerable<TrapTriggerResult> CheckMovementTriggers(Player player, Room room);

    /// <summary>
    /// Checks if an interaction triggers any traps.
    /// </summary>
    TrapTriggerResult? CheckInteractionTrigger(Player player, InteractiveObject obj);

    /// <summary>
    /// Gets all detected traps in a room.
    /// </summary>
    IEnumerable<Trap> GetDetectedTraps(Room room);

    /// <summary>
    /// Gets all traps (for DM/debug view).
    /// </summary>
    IEnumerable<Trap> GetAllTraps(Room room);

    /// <summary>
    /// Processes trap resets at end of turn.
    /// </summary>
    IEnumerable<Trap> ProcessTrapResets(Room room);
}

/// <summary>
/// Result of a trap detection attempt.
/// </summary>
public readonly record struct TrapDetectionResult
{
    public Trap Trap { get; init; }
    public bool Detected { get; init; }
    public int RollResult { get; init; }
    public int DC { get; init; }
    public string? Message { get; init; }
}

/// <summary>
/// Result of a trap disarm attempt.
/// </summary>
public readonly record struct TrapDisarmResult
{
    public Trap Trap { get; init; }
    public DisarmResult Result { get; init; }
    public int RollResult { get; init; }
    public int DC { get; init; }
    public bool TrapTriggered { get; init; }
    public string? Message { get; init; }
}
```

### Room Modifications

```
MODIFY: Room
├── ADD: _traps: List<Trap>
├── ADD: Traps: IReadOnlyList<Trap>
├── ADD: HasTraps: bool
├── ADD: HasActiveTraps: bool
├── ADD: AddTrap(Trap): void
├── ADD: RemoveTrap(Trap): bool
├── ADD: GetDetectedTraps(): IEnumerable<Trap>
└── ADD: GetTrapByKeyword(string): Trap?
```

### User-Facing Changes

**Commands:**
```
> search                    # Actively search room for traps
> search traps              # Specifically search for traps
> disarm <trap>             # Attempt to disarm a detected trap
> examine <trap>            # Get details on a detected trap
```

**Passive Detection (Room Entry):**
```
You enter the Dusty Corridor. The air is thick with
undisturbed dust, and ancient cobwebs cling to the walls.

[Passive Perception check...]
You notice subtle disturbances in the dust ahead -
something is not right about the floor tiles.

You detect: Pressure Plate Trap
```

**Active Search:**
```
> search

You carefully examine the room...
[Rolling Perception: DC 14]
Roll: 2d6 + 3 = [5, 4] + 3 = 12

You don't find anything suspicious.

---

> search

You carefully examine the room...
[Rolling Perception: DC 14]
Roll: 2d6 + 3 = [6, 5] + 3 = 14

You spot thin wires stretched across the passageway!

You detect: Tripwire Trap
```

**Disarm Attempt:**
```
> disarm tripwire

You carefully attempt to disarm the Tripwire Trap...
[Rolling Disable Device: DC 12]
Roll: 2d6 + 4 = [4, 6] + 4 = 14

Success! You carefully cut the tripwire, rendering
the trap harmless.

---

> disarm pressure plate

You carefully attempt to disarm the Pressure Plate Trap...
[Rolling Disable Device: DC 15]
Roll: 2d6 + 4 = [1, 2] + 4 = 7

Critical Failure! Your tools slip and activate the mechanism!

[TRAP TRIGGERED]
```

### Configuration Example

```json
{
  "$schema": "../schemas/traps.schema.json",
  "traps": [
    {
      "id": "pressure-plate-basic",
      "name": "Pressure Plate Trap",
      "description": "A concealed pressure plate connected to a hidden mechanism.",
      "detectionDC": 12,
      "disarmDC": 14,
      "canBeDisarmed": true,
      "resets": true,
      "resetDelay": 3
    },
    {
      "id": "tripwire-dart",
      "name": "Tripwire Trap",
      "description": "Thin wires stretched at ankle height, connected to a dart launcher.",
      "detectionDC": 14,
      "disarmDC": 12,
      "canBeDisarmed": true,
      "resets": false
    },
    {
      "id": "magical-ward",
      "name": "Arcane Ward",
      "description": "Glowing runes pulse with dangerous energy. This trap cannot be disarmed by mundane means.",
      "detectionDC": 10,
      "disarmDC": 20,
      "canBeDisarmed": false,
      "resets": true,
      "resetDelay": 1
    }
  ]
}
```

### Acceptance Criteria

- [ ] Trap entity stores state and detection/disarm DCs
- [ ] TrapState enum covers all necessary states
- [ ] Passive detection occurs on room entry
- [ ] Active search uses Perception check vs DC
- [ ] `disarm` command performs skill check vs DC
- [ ] Critical failure on disarm triggers the trap
- [ ] Traps can be configured as non-disarmable
- [ ] Resetting traps return to Hidden after delay
- [ ] Room.Traps collection works correctly
- [ ] Detected traps appear in room descriptions
- [ ] ~35 unit tests pass

---

## v0.4.1b: Trap Types & Triggers

[v0.4.1b Design Specification](v0.4.1b-design-specification.md)

### Overview

Implement various trigger types and trap varieties, including pressure plates, tripwires, dart traps, pit traps, and trapped containers. Each trap type has unique trigger conditions and effects.

### Scope

**In Scope:**
- `TriggerType` enum (Step, Touch, Open, Proximity, Tripwire)
- `TrapEffect` value object for damage and status effects
- Pressure plates (Step trigger on movement)
- Tripwires (Tripwire trigger on crossing)
- Dart traps (ranged damage)
- Pit traps (fall damage, potential separation)
- Trapped containers (Open trigger)
- Trap-container binding
- Effect application on trigger
- Trap damage integration with DamageCalculationService
- Status effect application from traps

**Out of Scope:**
- Environmental hazards (v0.4.1c)
- Saving throws for mitigation (v0.4.1c)
- Hazard zones (v0.4.1c)

### Key Deliverables

| Type | Count | Details |
|------|-------|---------|
| Enums | 1 | `TriggerType` |
| Value Objects | 1 | `TrapEffect` |
| Trap Updates | 1 | Add trigger type and effects |
| Container Updates | 1 | Trap attachment support |
| Service Updates | 1 | TrapService trigger handling |
| Configuration | 1 | Update `traps.json` |
| Unit Tests | ~25 | Trigger, effect, trap type tests |

### TriggerType Enum

```csharp
namespace RuneAndRust.Domain.Enums;

/// <summary>
/// Types of conditions that trigger a trap.
/// </summary>
public enum TriggerType
{
    /// <summary>Triggered by stepping on/walking over.</summary>
    Step,

    /// <summary>Triggered by touching/interacting with.</summary>
    Touch,

    /// <summary>Triggered by opening a container or door.</summary>
    Open,

    /// <summary>Triggered by proximity (entering range).</summary>
    Proximity,

    /// <summary>Triggered by crossing a tripwire line.</summary>
    Tripwire,

    /// <summary>Triggered by closing a container or door.</summary>
    Close,

    /// <summary>Triggered by taking an item.</summary>
    Take,

    /// <summary>Triggered manually (lever, button).</summary>
    Manual
}
```

### TrapEffect Value Object

```csharp
namespace RuneAndRust.Domain.ValueObjects;

/// <summary>
/// Defines the effects applied when a trap is triggered.
/// </summary>
public class TrapEffect
{
    /// <summary>
    /// Gets the damage dealt by this trap (null if no damage).
    /// </summary>
    public TrapDamage? Damage { get; private set; }

    /// <summary>
    /// Gets status effects applied by this trap.
    /// </summary>
    public IReadOnlyList<string> StatusEffectIds { get; private set; } = Array.Empty<string>();

    /// <summary>
    /// Gets the alert radius (0 = no alert, monsters alerted within radius).
    /// </summary>
    public int AlertRadius { get; private set; }

    /// <summary>
    /// Gets the message displayed when trap triggers.
    /// </summary>
    public string TriggerMessage { get; private set; } = string.Empty;

    /// <summary>
    /// Gets whether the trap teleports/moves the target.
    /// </summary>
    public bool CausesDisplacement { get; private set; }

    /// <summary>
    /// Gets the displacement target room ID (for pit traps).
    /// </summary>
    public string? DisplacementTargetId { get; private set; }

    /// <summary>
    /// Gets object effects triggered by this trap.
    /// </summary>
    public IReadOnlyList<ObjectEffect> ObjectEffects { get; private set; } = Array.Empty<ObjectEffect>();

    private TrapEffect() { }

    /// <summary>
    /// Creates a damage-only trap effect.
    /// </summary>
    public static TrapEffect DamageOnly(TrapDamage damage, string message) => new()
    {
        Damage = damage,
        TriggerMessage = message
    };

    /// <summary>
    /// Creates a status effect trap.
    /// </summary>
    public static TrapEffect StatusOnly(IEnumerable<string> effectIds, string message) => new()
    {
        StatusEffectIds = effectIds.ToList(),
        TriggerMessage = message
    };

    /// <summary>
    /// Creates a pit trap effect with fall damage and displacement.
    /// </summary>
    public static TrapEffect PitTrap(TrapDamage fallDamage, string targetRoomId, string message) => new()
    {
        Damage = fallDamage,
        CausesDisplacement = true,
        DisplacementTargetId = targetRoomId,
        TriggerMessage = message
    };

    /// <summary>
    /// Creates an alert trap (no damage, alerts monsters).
    /// </summary>
    public static TrapEffect AlertTrap(int radius, string message) => new()
    {
        AlertRadius = radius,
        TriggerMessage = message
    };

    /// <summary>
    /// Creates a combined damage and status effect trap.
    /// </summary>
    public static TrapEffect Combined(
        TrapDamage? damage,
        IEnumerable<string>? statusEffects,
        int alertRadius,
        string message) => new()
    {
        Damage = damage,
        StatusEffectIds = statusEffects?.ToList() ?? Array.Empty<string>(),
        AlertRadius = alertRadius,
        TriggerMessage = message
    };
}

/// <summary>
/// Damage specification for a trap.
/// </summary>
public readonly record struct TrapDamage
{
    /// <summary>
    /// Gets the dice notation for damage (e.g., "2d6").
    /// </summary>
    public string DiceNotation { get; init; }

    /// <summary>
    /// Gets the damage type ID.
    /// </summary>
    public string DamageTypeId { get; init; }

    /// <summary>
    /// Gets flat bonus damage.
    /// </summary>
    public int BonusDamage { get; init; }

    /// <summary>
    /// Creates a simple damage spec.
    /// </summary>
    public static TrapDamage Create(string dice, string damageType, int bonus = 0) => new()
    {
        DiceNotation = dice,
        DamageTypeId = damageType,
        BonusDamage = bonus
    };
}
```

### Trap Entity Updates

```
MODIFY: Trap
├── ADD: TriggerType: TriggerType
├── ADD: Effect: TrapEffect
├── ADD: TriggerRange: int (for Proximity triggers)
├── ADD: TriggerDirection: Direction? (for directional tripwires)
└── ADD: GetTriggerDescription(): string
```

### InteractiveObject Updates (Trapped Containers)

```
MODIFY: InteractiveObject
├── ADD: AttachedTrapId: Guid?
├── ADD: HasTrap: bool
└── ADD: GetAttachedTrap(ITrapService): Trap?
```

### User-Facing Changes

**Pressure Plate Trigger:**
```
> north

As you step forward, you hear a click beneath your foot...

[TRAP TRIGGERED: Pressure Plate Trap]
Darts shoot from hidden holes in the walls!

[Damage: 2d6 piercing = 8]
You take 8 piercing damage!
```

**Tripwire Trigger:**
```
> east

Your foot catches on something...

[TRAP TRIGGERED: Tripwire Trap]
A blade swings down from the ceiling!

[Damage: 2d8 slashing = 11]
You take 11 slashing damage!
You are bleeding! (3 turns)
```

**Pit Trap:**
```
> north

The floor gives way beneath you!

[TRAP TRIGGERED: Pit Trap]
You fall into a pit below!

[Damage: 1d6 falling = 4]
You take 4 falling damage!

You find yourself in: The Lower Passage
```

**Trapped Container:**
```
> open chest

As you lift the lid, you hear a soft hiss...

[TRAP TRIGGERED: Poison Needle Trap]
A needle jabs into your finger!

[Damage: 1d4 piercing = 2]
You take 2 piercing damage!
You are poisoned! (5 turns)

The chest is now open.
Inside you find:
  - Gold Ring
  - 15 gold
```

### Configuration Example

```json
{
  "traps": [
    {
      "id": "dart-trap-wall",
      "name": "Wall Dart Trap",
      "description": "Pressure-activated darts fire from the walls.",
      "triggerType": "Step",
      "detectionDC": 12,
      "disarmDC": 14,
      "effect": {
        "damage": {
          "dice": "2d6",
          "type": "piercing",
          "bonus": 0
        },
        "triggerMessage": "Darts shoot from hidden holes in the walls!"
      },
      "resets": true,
      "resetDelay": 2
    },
    {
      "id": "pit-trap-deep",
      "name": "Hidden Pit Trap",
      "description": "A deep pit concealed by a false floor.",
      "triggerType": "Step",
      "detectionDC": 14,
      "disarmDC": 16,
      "effect": {
        "damage": {
          "dice": "2d6",
          "type": "bludgeoning"
        },
        "causesDisplacement": true,
        "displacementTargetId": "room-pit-bottom",
        "triggerMessage": "The floor gives way beneath you!"
      },
      "resets": false
    },
    {
      "id": "poison-needle-chest",
      "name": "Poison Needle Trap",
      "description": "A needle coated in venom hidden in the lock.",
      "triggerType": "Open",
      "detectionDC": 15,
      "disarmDC": 13,
      "effect": {
        "damage": {
          "dice": "1d4",
          "type": "piercing"
        },
        "statusEffects": ["poisoned-weak"],
        "triggerMessage": "A needle jabs into your finger!"
      },
      "resets": false
    },
    {
      "id": "alarm-tripwire",
      "name": "Alarm Wire",
      "description": "A thin wire connected to a bell mechanism.",
      "triggerType": "Tripwire",
      "triggerDirection": "East",
      "detectionDC": 10,
      "disarmDC": 8,
      "effect": {
        "alertRadius": 3,
        "triggerMessage": "A loud bell rings throughout the dungeon!"
      },
      "resets": false
    }
  ]
}
```

### Acceptance Criteria

- [ ] TriggerType enum covers all trigger types
- [ ] Step triggers activate on movement through tile
- [ ] Tripwire triggers activate on crossing direction
- [ ] Open triggers activate when container opened
- [ ] Proximity triggers activate when within range
- [ ] TrapEffect applies damage via DamageCalculationService
- [ ] TrapEffect applies status effects via StatusEffectService
- [ ] Pit traps move player to target room
- [ ] Alert traps notify monsters within radius
- [ ] Trapped containers check trap before opening
- [ ] Detected traps on containers show warning
- [ ] ~25 unit tests pass

---

## v0.4.1c: Environmental Hazards

[v0.4.1c Design Specification](v0.4.1c-design-specification.md)

### Overview

Implement persistent environmental hazards that affect players who remain in or pass through dangerous zones. Hazards deal ongoing damage or apply status effects, and players can use saving throws to reduce or avoid damage.

### Scope

**In Scope:**
- `HazardZone` entity for area effects
- `HazardDefinition` for configuration
- `Room.HazardZones` collection
- Poison gas zones (damage over time, status effect)
- Fire zones (fire damage each turn)
- Ice/cold zones (cold damage, slow effect)
- Spike floors (damage on movement)
- Saving throws (dice check to halve/negate damage)
- Hazard visibility in room descriptions
- Turn-based hazard processing
- Hazard duration (permanent vs temporary)

**Out of Scope:**
- Light-based hazards (v0.4.3)
- Weather effects (v0.4.3)
- Spreading hazards (future)

### Key Deliverables

| Type | Count | Details |
|------|-------|---------|
| Domain Entities | 1 | `HazardZone` |
| Domain Definitions | 1 | `HazardDefinition` |
| Value Objects | 1 | `SavingThrow` |
| Room Updates | 1 | Add HazardZones collection |
| Service Updates | 2 | TrapService, TurnProcessingService |
| Configuration | 1 | `hazards.json` |
| Unit Tests | ~25 | Hazard, saving throw tests |

### HazardZone Entity

```csharp
namespace RuneAndRust.Domain.Entities;

/// <summary>
/// Represents a persistent environmental hazard in a room.
/// </summary>
public class HazardZone : IEntity
{
    /// <summary>
    /// Gets the unique identifier for this hazard zone.
    /// </summary>
    public Guid Id { get; private set; }

    /// <summary>
    /// Gets the definition ID from configuration.
    /// </summary>
    public string DefinitionId { get; private set; } = string.Empty;

    /// <summary>
    /// Gets the display name of this hazard.
    /// </summary>
    public string Name { get; private set; } = string.Empty;

    /// <summary>
    /// Gets the description shown to players.
    /// </summary>
    public string Description { get; private set; } = string.Empty;

    /// <summary>
    /// Gets whether this hazard is currently active.
    /// </summary>
    public bool IsActive { get; private set; } = true;

    /// <summary>
    /// Gets the damage dealt each turn (null if no damage).
    /// </summary>
    public TrapDamage? DamagePerTurn { get; private set; }

    /// <summary>
    /// Gets the damage dealt on entry (null if no entry damage).
    /// </summary>
    public TrapDamage? EntryDamage { get; private set; }

    /// <summary>
    /// Gets status effects applied each turn.
    /// </summary>
    public IReadOnlyList<string> StatusEffectIds { get; private set; } = Array.Empty<string>();

    /// <summary>
    /// Gets the saving throw to reduce damage/effects.
    /// </summary>
    public SavingThrow? Save { get; private set; }

    /// <summary>
    /// Gets whether a successful save negates all damage (vs half).
    /// </summary>
    public bool SaveNegates { get; private set; }

    /// <summary>
    /// Gets whether this hazard affects the entire room.
    /// </summary>
    public bool AffectsWholeRoom { get; private set; } = true;

    /// <summary>
    /// Gets the remaining duration in turns (-1 = permanent).
    /// </summary>
    public int Duration { get; private set; } = -1;

    /// <summary>
    /// Gets whether this hazard is permanent.
    /// </summary>
    public bool IsPermanent => Duration < 0;

    /// <summary>
    /// Gets whether damage is dealt on entry (vs each turn).
    /// </summary>
    public bool DamageOnEntry { get; private set; }

    /// <summary>
    /// Gets whether damage is dealt each turn while in zone.
    /// </summary>
    public bool DamagePerRound { get; private set; } = true;

    private HazardZone() { }

    /// <summary>
    /// Creates a new hazard zone.
    /// </summary>
    public static HazardZone Create(
        string definitionId,
        string name,
        string description,
        TrapDamage? damagePerTurn = null,
        TrapDamage? entryDamage = null,
        IEnumerable<string>? statusEffects = null,
        SavingThrow? save = null,
        bool saveNegates = false,
        int duration = -1)
    {
        return new HazardZone
        {
            Id = Guid.NewGuid(),
            DefinitionId = definitionId,
            Name = name,
            Description = description,
            DamagePerTurn = damagePerTurn,
            EntryDamage = entryDamage,
            StatusEffectIds = statusEffects?.ToList() ?? Array.Empty<string>(),
            Save = save,
            SaveNegates = saveNegates,
            Duration = duration,
            DamageOnEntry = entryDamage.HasValue,
            DamagePerRound = damagePerTurn.HasValue
        };
    }

    /// <summary>
    /// Processes a turn tick, reducing duration.
    /// </summary>
    /// <returns>True if hazard expired.</returns>
    public bool Tick()
    {
        if (IsPermanent) return false;

        Duration--;
        if (Duration <= 0)
        {
            IsActive = false;
            return true;
        }

        return false;
    }

    /// <summary>
    /// Deactivates this hazard zone.
    /// </summary>
    public void Deactivate()
    {
        IsActive = false;
    }

    /// <summary>
    /// Reactivates this hazard zone with new duration.
    /// </summary>
    public void Reactivate(int? newDuration = null)
    {
        IsActive = true;
        if (newDuration.HasValue)
            Duration = newDuration.Value;
    }
}
```

### SavingThrow Value Object

```csharp
namespace RuneAndRust.Domain.ValueObjects;

/// <summary>
/// Defines a saving throw to avoid or reduce an effect.
/// </summary>
public readonly record struct SavingThrow
{
    /// <summary>
    /// Gets the attribute used for the save (e.g., "Fortitude", "Finesse").
    /// </summary>
    public string Attribute { get; init; }

    /// <summary>
    /// Gets the DC to beat for success.
    /// </summary>
    public int DC { get; init; }

    /// <summary>
    /// Creates a saving throw.
    /// </summary>
    public static SavingThrow Create(string attribute, int dc) => new()
    {
        Attribute = attribute,
        DC = dc
    };

    /// <summary>
    /// Creates a Fortitude save.
    /// </summary>
    public static SavingThrow Fortitude(int dc) => Create("Fortitude", dc);

    /// <summary>
    /// Creates a Finesse save (reflexes).
    /// </summary>
    public static SavingThrow Finesse(int dc) => Create("Finesse", dc);

    /// <summary>
    /// Creates a Will save.
    /// </summary>
    public static SavingThrow Will(int dc) => Create("Will", dc);

    /// <summary>
    /// Creates a Wits save (awareness).
    /// </summary>
    public static SavingThrow Wits(int dc) => Create("Wits", dc);
}
```

### Room Modifications

```
MODIFY: Room
├── ADD: _hazardZones: List<HazardZone>
├── ADD: HazardZones: IReadOnlyList<HazardZone>
├── ADD: HasHazards: bool
├── ADD: HasActiveHazards: bool
├── ADD: AddHazardZone(HazardZone): void
├── ADD: RemoveHazardZone(HazardZone): bool
└── ADD: GetActiveHazards(): IEnumerable<HazardZone>
```

### HazardProcessingResult

```csharp
namespace RuneAndRust.Application.DTOs;

/// <summary>
/// Result of processing hazard effects on a player.
/// </summary>
public readonly record struct HazardProcessingResult
{
    public HazardZone Hazard { get; init; }
    public bool SaveAttempted { get; init; }
    public int? SaveRoll { get; init; }
    public int? SaveDC { get; init; }
    public bool SaveSucceeded { get; init; }
    public int DamageTaken { get; init; }
    public int DamageReduced { get; init; }
    public IReadOnlyList<string> StatusEffectsApplied { get; init; }
    public string Message { get; init; }
}
```

### User-Facing Changes

**Room with Hazard:**
```
You enter the Toxic Chamber. A sickly green mist
fills the room, making it difficult to breathe.

[ENVIRONMENTAL HAZARD: Poison Gas]
The poisonous fumes burn your lungs!

[Saving Throw: Fortitude DC 12]
Roll: 2d6 + 2 = [3, 4] + 2 = 9

Save Failed!
[Damage: 1d6 poison = 4]
You take 4 poison damage!
You are poisoned! (2 turns)
```

**Hazard with Successful Save:**
```
=== END OF TURN ===

[ENVIRONMENTAL HAZARD: Poison Gas]
The poisonous fumes continue to assault you.

[Saving Throw: Fortitude DC 12]
Roll: 2d6 + 2 = [5, 6] + 2 = 13

Save Succeeded!
You resist the worst of the poison's effects.
[Damage: 1d6 / 2 = 2]
You take 2 poison damage.
```

**Fire Zone:**
```
You step into the Burning Hall. Flames lick across
the floor from cracks in the stone.

[ENVIRONMENTAL HAZARD: Floor Flames]
The fire burns at your feet!

[Saving Throw: Finesse DC 11]
Roll: 2d6 + 3 = [2, 2] + 3 = 7

Save Failed!
[Damage: 2d6 fire = 9]
You take 9 fire damage!
You are burning! (2 turns)
```

**Ice Zone:**
```
You enter the Frozen Passage. Bitter cold seeps
into your bones as frost covers every surface.

[ENVIRONMENTAL HAZARD: Freezing Cold]
The intense cold saps your strength.

[Saving Throw: Fortitude DC 10]
Roll: 2d6 + 2 = [4, 5] + 2 = 11

Save Succeeded!
You steel yourself against the cold.
You are chilled. (Movement reduced)
```

**Spike Floor:**
```
> north

You move carefully across the spike-covered floor.

[ENVIRONMENTAL HAZARD: Spike Floor]
Sharp spikes jab at your feet!

[Saving Throw: Finesse DC 13]
Roll: 2d6 + 3 = [1, 3] + 3 = 7

Save Failed!
[Damage: 1d8 piercing = 6]
You take 6 piercing damage!
```

### Configuration Example

```json
{
  "$schema": "../schemas/hazards.schema.json",
  "hazards": [
    {
      "id": "poison-gas-cloud",
      "name": "Poison Gas",
      "description": "A sickly green mist fills the area, toxic to breathe.",
      "damagePerTurn": {
        "dice": "1d6",
        "type": "poison"
      },
      "statusEffects": ["poisoned-weak"],
      "save": {
        "attribute": "Fortitude",
        "dc": 12
      },
      "saveNegates": false,
      "affectsWholeRoom": true,
      "duration": -1
    },
    {
      "id": "floor-flames",
      "name": "Floor Flames",
      "description": "Flames lick across the floor from cracks in the stone.",
      "damagePerTurn": {
        "dice": "2d6",
        "type": "fire"
      },
      "statusEffects": ["burning"],
      "save": {
        "attribute": "Finesse",
        "dc": 11
      },
      "saveNegates": false,
      "affectsWholeRoom": true,
      "duration": -1
    },
    {
      "id": "freezing-cold",
      "name": "Freezing Cold",
      "description": "Bitter cold seeps into your bones.",
      "damagePerTurn": {
        "dice": "1d4",
        "type": "cold"
      },
      "statusEffects": ["chilled"],
      "save": {
        "attribute": "Fortitude",
        "dc": 10
      },
      "saveNegates": true,
      "affectsWholeRoom": true,
      "duration": -1
    },
    {
      "id": "spike-floor",
      "name": "Spike Floor",
      "description": "Sharp metal spikes protrude from the floor.",
      "entryDamage": {
        "dice": "1d8",
        "type": "piercing"
      },
      "damageOnEntry": true,
      "damagePerRound": false,
      "save": {
        "attribute": "Finesse",
        "dc": 13
      },
      "saveNegates": true,
      "affectsWholeRoom": true,
      "duration": -1
    },
    {
      "id": "temporary-flame-burst",
      "name": "Flame Burst",
      "description": "A burst of fire fills the room temporarily.",
      "damagePerTurn": {
        "dice": "3d6",
        "type": "fire"
      },
      "save": {
        "attribute": "Finesse",
        "dc": 14
      },
      "saveNegates": false,
      "duration": 3,
      "affectsWholeRoom": true
    }
  ]
}
```

### Acceptance Criteria

- [ ] HazardZone entity tracks active hazards in rooms
- [ ] Room.HazardZones collection works correctly
- [ ] Poison gas deals damage and applies poisoned
- [ ] Fire zones deal fire damage and apply burning
- [ ] Ice zones deal cold damage and apply chilled/slowed
- [ ] Spike floors deal damage on movement only
- [ ] Saving throws roll dice + attribute bonus vs DC
- [ ] Successful saves halve damage (or negate if configured)
- [ ] Save failure applies full damage and status effects
- [ ] Temporary hazards expire after duration
- [ ] Hazards appear in room descriptions
- [ ] Turn processing applies ongoing hazard effects
- [ ] ~25 unit tests pass

---

## Dependencies & Prerequisites

```
v0.4.0 (Interactive Objects) - REQUIRED
    │
    ├── InteractiveObject entity ────────┐
    ├── ObjectState enum ────────────────┤
    ├── ObjectEffect value object ───────┤
    ├── DestructibleProperties ──────────┤
    ├── InteractionService ──────────────┤
    └── Room.Interactables ──────────────┘
                                         │
                                         ▼
v0.4.1 (Traps & Hazards)
    │
    ├── v0.4.1a: Trap Core ──────────────────────────────┐
    │       Dependencies: Room, DiceService,             │
    │                     SkillCheckService              │
    │       Provides: Trap, TrapState, TrapService       │
    │                                                    │
    ├── v0.4.1b: Trap Types & Triggers ──────────────────┤
    │       Dependencies: v0.4.1a, StatusEffectService,  │
    │                     DamageCalculationService       │
    │       Provides: TriggerType, TrapEffect            │
    │                                                    │
    └── v0.4.1c: Environmental Hazards ──────────────────┘
            Dependencies: v0.4.1a, v0.4.1b
            Provides: HazardZone, SavingThrow
```

---

## Estimated Effort Summary

| Phase | New Files | Modified Files | Est. Tests | Complexity |
|-------|-----------|----------------|------------|------------|
| v0.4.1a | ~6 | ~4 | ~35 | High |
| v0.4.1b | ~4 | ~5 | ~25 | Medium |
| v0.4.1c | ~5 | ~4 | ~25 | Medium |
| **Total** | **~15** | **~13** | **~85** | |

---

## Risk Assessment

| Risk | Impact | Probability | Mitigation |
|------|--------|-------------|------------|
| Trap detection too easy/hard | Medium | Medium | Configurable DCs, playtesting |
| Trap damage balance | Medium | Medium | Use existing damage scaling |
| Save system complexity | Medium | Low | Simple DC-based checks |
| Pit trap room transitions | High | Low | Validate target rooms exist |
| Hazard + trap stacking | Medium | Medium | Clear processing order |
| Performance with many hazards | Low | Low | Process only active hazards |

---

## Design Decisions (Confirmed)

### Trap Architecture

| Decision | Value | Notes |
|----------|-------|-------|
| **Trap Storage** | Room.Traps collection | Per-room trap lists |
| **Detection Model** | DC-based Perception check | Passive + active search |
| **Disarm Model** | DC-based skill check | Critical fail triggers trap |
| **Reset Behavior** | Configurable per trap | Delay in turns |

### Trigger System

| Decision | Value | Notes |
|----------|-------|-------|
| **Trigger Types** | Enum-based | Step, Touch, Open, etc. |
| **Movement Triggers** | Check on room entry/movement | Before movement completes |
| **Container Triggers** | Check on open action | Before container opens |

### Hazard System

| Decision | Value | Notes |
|----------|-------|-------|
| **Hazard Scope** | Room-wide by default | Position-based future |
| **Save Mechanics** | Attribute + dice vs DC | Uses existing attributes |
| **Duration** | Turn-based countdown | -1 = permanent |
| **Damage Timing** | Entry and/or per-turn | Configurable |

---

## Integration Points

### From v0.4.0
- InteractiveObject for trapped containers
- ObjectEffect for trap-triggered effects
- DestructibleProperties for breakable traps
- Room.Interactables for object binding

### To v0.4.2 (Puzzles)
- Traps can guard puzzle rooms
- Puzzle completion can disable traps
- Trap triggers can be puzzle elements

### To v0.4.3 (Light & Skills)
- Darkness affects trap detection
- Perception skill improves detection
- Stealth can bypass some trigger types

---

## Next Steps

1. **Review & Approve** - Confirm scope breakdown
2. **v0.4.1a Design Spec** - Create detailed design specification
3. **Implement v0.4.1a** - Build trap core system
4. **v0.4.1b Design Spec** - Trap types and triggers
5. **Implement v0.4.1b** - Build trap varieties
6. **Implement v0.4.1c** - Build environmental hazards

---

*This scope breakdown provides a structured approach to implementing v0.4.1 Traps & Environmental Hazards. Each sub-phase builds on the previous, creating a comprehensive danger system that adds tension and risk to dungeon exploration.*
