> **Archived** - This plan has been consolidated. See the complete version at [v0.3.23](../v0.3.x/v0.3.23.md).

Here is the comprehensive implementation plan for v0.3.23a: The Abstraction (Input Mapping).
This sub-version decouples the game engine from physical hardware. By translating raw key presses into semantic GameAction events via the InputConfigurationService (v0.3.9c), we enable remapping, macro support, and automated testing without hacking the Console object.

v0.3.23a: The Abstraction
Goal: Implement the InputService and InputEvent hierarchy to translate hardware signals (ConsoleKey) into domain intent (GameAction).
1. Architecture & Data Flow
	•	The Translation Layer: The InputService acts as a middleware between the Terminal layer (Spectre.Console/System.Console) and the Engine.
	•	Event Hierarchy: Input is normalized into an InputEvent record, which can carry a high-level GameAction (e.g., MoveNorth) or a low-level RawKeyEvent (for text entry).
Data Flow: The Input Pipeline
	1	Hardware: User presses 'W'.
	2	Provider: TerminalInputProvider captures ConsoleKeyInfo (blocking or non-blocking).
	3	Lookup: InputService queries IInputConfigurationService.GetCommandForKey('W') [Source 3572].
	◦	Result: Returns string "north".
	4	Translation: InputService maps string "north" -> GameAction.MoveNorth (Enum).
	5	Packet: InputService wraps this in an ActionEvent.
	6	Consumption: GameLoop receives the event and routes it to CommandParser.

2. Logic Decision Trees
A. Input Resolution Logic Input: ConsoleKeyInfo
	1	System Check: Is Key a global hotkey (e.g., ~ for Console, F12 for Screenshot)?
	◦	Yes: Return SystemEvent(GlobalAction).
	2	Binding Check: Does InputConfigurationService have a binding for this Key?
	◦	Yes:
	▪	Retrieve Command String (e.g., "inventory").
	▪	Enum.Parse -> GameAction.Inventory.
	▪	Return ActionEvent(GameAction.Inventory).
	◦	No:
	▪	Return RawKeyEvent(KeyInfo) (Used for typing names/seeds).
B. Mode Switching (Future Proofing) Input: InputContext (TextEntry vs Gameplay)
	1	TextEntry Mode: Ignore Bindings. Always return RawKeyEvent (allows typing "W" without moving North).
	2	Gameplay Mode: Prioritize Bindings. Return ActionEvent.

3. Code Implementation
A. Event Models File: RuneAndRust.Core/Models/Input/InputEvent.cs
namespace RuneAndRust.Core.Models.Input;

public abstract record InputEvent;

// High-level intent (e.g., Player wants to move North)
public record ActionEvent(GameAction Action) : InputEvent;

// Low-level hardware (e.g., Player typed letter 'A')
public record RawKeyEvent(ConsoleKeyInfo Key) : InputEvent;

// System interrupts (e.g., Debug Console, Quit)
public record SystemEvent(SystemAction Action) : InputEvent;

public enum SystemAction { ToggleDebug, ForceQuit, Screenshot }
B. Input Service Implementation File: RuneAndRust.Engine/Services/InputService.cs
public class InputService : IInputService
{
    private readonly IInputConfigurationService _config;
    private readonly ILogger _logger;

    public InputService(IInputConfigurationService config, ILogger logger)
    {
        _config = config;
        _logger = logger;
    }

    public InputEvent ReadNext()
    {
        // 1. Read Physical Input (Blocking for now, Async in v0.3.23b)
        var keyInfo = Console.ReadKey(intercept: true);

        // 2. Global Interrupts
        if (keyInfo.Key == ConsoleKey.OemTilde)
            return new SystemEvent(SystemAction.ToggleDebug);

        // 3. Check Bindings (v0.3.9c integration)
        var command = _config.GetCommandForKey(keyInfo.Key);

        if (!string.IsNullOrEmpty(command))
        {
            // Map string command to Enum (Case insensitive)
            if (Enum.TryParse<GameAction>(command, true, out var action))
            {
                _logger.LogTrace("Mapped key {Key} to action {Action}", keyInfo.Key, action);
                return new ActionEvent(action);
            }
        }

        // 4. Fallback to Raw
        return new RawKeyEvent(keyInfo);
    }
}

4. Deliverable Checklist (v0.3.23a)
	•	Core:
	◦	[ ] Define InputEvent, ActionEvent, RawKeyEvent, SystemEvent records.
	◦	[ ] Define IInputService interface.
	◦	[ ] Verify GameAction enum (v0.3.9c) covers all necessary commands [Source 3565].
	•	Engine:
	◦	[ ] Implement InputService with IInputConfigurationService dependency.
	◦	[ ] Update CommandParser to accept GameAction directly (overload or refactor).
	•	Terminal:
	◦	[ ] Update Program.cs to register IInputService.
	◦	[ ] Refactor TerminalInputHandler to delegate to IInputService.

5. Logging Requirements
Reference: logging.md
System
Event
Level
Message Template
Properties
Input
Map Success
Trace
"[Input] Mapped {Key} -> {Action}"
Key, Action
Input
Map Fail
Trace
"[Input] Raw Key: {Key}"
Key
Input
System
Debug
"[Input] System Interrupt: {Action}"
Action

6. Testing Strategy
Unit Tests (InputServiceTests.cs):
	•	Mapping_Success:
	◦	Mock IInputConfigurationService to return "attack" for ConsoleKey.A.
	◦	Simulate 'A' press.
	◦	Assert result is ActionEvent(GameAction.Attack).
	•	Mapping_Failure:
	◦	Mock config to return null for ConsoleKey.Z.
	◦	Simulate 'Z' press.
	◦	Assert result is RawKeyEvent.
	•	System_Interrupt:
	◦	Simulate ~ press.
	◦	Assert result is SystemEvent.
Integration Tests:
	•	Rebind_Flow:
	◦	Change binding of 'W' to "inventory" via InputConfigurationService.
	◦	Press 'W'.
	◦	Verify InputService returns Inventory action, not MoveNorth.

7. Draft Changelog (v0.3.23a)
# Changelog: v0.3.23a - The Abstraction

**Release Date:** 2026-03-XX

## Summary
"The Abstraction" layer decouples the game engine from the physical keyboard. By translating raw key presses into semantic "Game Actions," the engine now supports flexible input methods and prepares the architecture for event-driven processing.

## Changes
- **Input Events:** Introduced `InputEvent` system. The engine now consumes semantic actions (e.g., `MoveNorth`) rather than raw keys (e.g., 'W').
- **Integration:** Wired `InputService` to the Key Rebinding system (v0.3.9c). Changing a binding in the options menu now immediately affects gameplay input.
- **System Interrupts:** Added dedicated handling for global hotkeys (like the Debug Console) separate from gameplay commands.
Would you like to proceed to v0.3.23b: The Loop (Event-Driven Architecture)?
