# Changelog: v0.3.20c - The Pathfinder
**Release Date:** 2025-12-26

---

## Summary

v0.3.20c introduces auto-walk functionality for rapid traversal of previously explored areas. This feature implements true step-by-step movement rather than teleportation—time passes, resources are consumed, and the player watches their character move through the map with visual feedback. The implementation uses Breadth-First Search (BFS) for optimal pathfinding through the room graph, respects fog-of-war constraints by only considering visited rooms, and validates path safety before execution.

The architecture separates pathfinding logic (IRoomPathfinderService) from travel execution (IAutoTravelService), adhering to the Single Responsibility Principle. The system supports keyword-based destinations ("home", "anchor", "surface") and partial room name matching, validates preconditions (exhaustion, encumbrance, combat state), checks path safety (lethal rooms, dormant hazards), and allows interruption by combat events (ambushes). This touches the Core Layer (interfaces, result records), Engine Layer (service implementations), and Test Layer (27 tests across two test classes).

---

## New Files Created

### Core Layer

| File | Purpose |
|------|---------|
| `RuneAndRust.Core/Interfaces/IRoomPathfinderService.cs` | Defines BFS pathfinding contract with fog-of-war constraints; includes `RoomPathResult` record with factory methods |
| `RuneAndRust.Core/Interfaces/IAutoTravelService.cs` | Defines auto-travel execution contract with precondition/safety validation; includes `TravelInterruptReason` enum and `AutoTravelResult` record |

### Engine Layer

| File | Purpose |
|------|---------|
| `RuneAndRust.Engine/Services/RoomPathfinderService.cs` | Implements BFS algorithm on Room.Exits graph with visited-room constraint; provides nearest feature search and room name matching |
| `RuneAndRust.Engine/Services/AutoTravelService.cs` | Orchestrates travel execution with validation, interruption handling, and visual feedback; resolves keyword targets |

### Test Layer

| File | Purpose |
|------|---------|
| `RuneAndRust.Tests/Engine/RoomPathfinderServiceTests.cs` | Validates BFS pathfinding, fog-of-war enforcement, and feature/name searches (12 tests) |
| `RuneAndRust.Tests/Engine/AutoTravelServiceTests.cs` | Validates preconditions, path safety, execution flow, and target resolution (15 tests) |

---

## Files Modified

| File | Change |
|------|--------|
| `RuneAndRust.Engine/Services/CommandParser.cs` | Added `IAutoTravelService?` field and constructor parameter; added `RequiresTravel` and `TravelTarget` properties to `ParseResult`; added travel/goto command detection in `HandleExplorationAsync()`; added `HandleTravelCommandAsync()` method; added Fast Travel help section |
| `RuneAndRust.Terminal/Program.cs` | Registered `IRoomPathfinderService` and `IAutoTravelService` with Scoped lifetime |
| `RuneAndRust.Engine/Services/AutoTravelService.cs` | Added `using Character = RuneAndRust.Core.Entities.Character;` alias to resolve ambiguity with `RuneAndRust.Core.Models.Character` |

---

## Code Implementation Details

### Enums

#### TravelInterruptReason (IAutoTravelService.cs)

```csharp
public enum TravelInterruptReason
{
    None = 0,              // No interruption occurred
    UserCancelled = 1,     // User pressed ESC to cancel travel
    HazardEncountered = 2, // A hazard was encountered along the path
    CombatTriggered = 3,   // Combat was triggered (ambush or enemy encounter)
    ResourceDepleted = 4   // Character ran out of critical resources
}
```

### Records

#### RoomPathResult (IRoomPathfinderService.cs)

**Properties:**
- `bool Success` - Whether a valid path was found
- `List<Guid>? RoomPath` - Room IDs in traversal order (excluding start, including destination)
- `List<Direction>? Directions` - Movement directions for each step in the path
- `string? FailureReason` - Reason for failure if Success is false

**Factory Methods:**
- `static RoomPathResult Succeeded(List<Guid> roomPath, List<Direction> directions)` - Creates successful path result
- `static RoomPathResult Failed(string reason)` - Creates failed path result
- `static RoomPathResult AlreadyAtDestination()` - Creates result for when already at destination (empty path)

#### AutoTravelResult (IAutoTravelService.cs)

**Properties:**
- `bool Success` - Whether travel completed to destination
- `int RoomsTraveled` - Number of rooms traversed before stopping
- `int TurnsElapsed` - Number of game turns consumed during travel
- `Room? FinalRoom` - The room where travel ended (may not be destination if interrupted)
- `string Message` - User-facing message describing the travel outcome
- `TravelInterruptReason? InterruptReason` - Reason for interruption if travel did not complete

**Factory Methods:**
- `static AutoTravelResult Succeeded(int roomsTraveled, int turnsElapsed, Room finalRoom)` - Creates successful travel result with auto-generated message
- `static AutoTravelResult Interrupted(int roomsTraveled, int turnsElapsed, Room? finalRoom, TravelInterruptReason reason, string message)` - Creates interrupted travel result
- `static AutoTravelResult Failed(string message)` - Creates failed travel result (could not start)

### Services

#### IRoomPathfinderService (Interface)

**Method Signatures:**
```csharp
Task<RoomPathResult> FindPathAsync(Guid startRoomId, Guid destinationRoomId, HashSet<Guid> visitedRoomIds)
Task<Room?> FindNearestFeatureAsync(Guid startRoomId, RoomFeature feature, HashSet<Guid> visitedRoomIds)
Task<IEnumerable<Room>> FindRoomsByNameAsync(string namePart, HashSet<Guid> visitedRoomIds)
```

**Behaviors:**
- Uses BFS algorithm for shortest-path calculation (all edges have equal weight)
- Enforces fog-of-war constraint by only traversing rooms in `visitedRoomIds`
- Returns failure if start or destination not in visited set
- Returns empty path if already at destination
- For nearest feature search: Returns start room immediately if it has the feature
- For room name search: Case-insensitive partial matching, orders results by name length (prefers shorter matches)

#### RoomPathfinderService (Implementation)

**Dependencies:**
- `ILogger<RoomPathfinderService>` - Logging
- `IRoomRepository` - Batch fetching of visited rooms

**Key Constants/Thresholds:** None

**Algorithm Details:**
- BFS Queue: Stores room IDs to visit
- CameFrom Dictionary: Tracks `(Guid PreviousRoomId, Direction DirectionTaken)` for path reconstruction
- Graph Traversal: Uses `Room.Exits` dictionary to discover neighbors
- Path Reconstruction: Walks backward from destination to start, then reverses to get start-to-end order

#### IAutoTravelService (Interface)

**Method Signatures:**
```csharp
Task<string?> ValidateTravelPreconditionsAsync(Character character)
Task<string?> ValidatePathSafetyAsync(IEnumerable<Guid> path)
Task<AutoTravelResult> ExecuteTravelAsync(IEnumerable<Direction> directions, CancellationToken cancellationToken = default)
Task<AutoTravelResult> TravelToAsync(string target, CancellationToken cancellationToken = default)
```

**Behaviors:**
- Precondition validation blocks if character has `StatusEffectType.Exhausted`
- Precondition validation blocks if encumbrance is `BurdenState.Overburdened`
- Precondition validation blocks if `GameState.Phase != GamePhase.Exploration`
- Path safety validation blocks if any room has `DangerLevel.Lethal`
- Path safety validation blocks if any room has dormant movement hazards (`TriggerType.Movement` + `HazardState.Dormant`)
- Path safety validation ignores cooldown hazards (allows safe passage)
- Travel execution calls `INavigationService.MoveAsync()` for each direction (leverages existing turn advancement logic)
- Travel execution checks `CancellationToken` before each step (ESC key support)
- Travel execution checks `GamePhase.Combat` after each move (ambush interruption)
- Travel execution parses move result strings for failure indicators ("cannot go", "Error")

#### AutoTravelService (Implementation)

**Dependencies:**
- `ILogger<AutoTravelService>` - Logging
- `GameState` - Turn count, current character, current room, visited rooms, combat phase
- `IRoomPathfinderService` - Pathfinding
- `INavigationService` - Movement execution
- `IInventoryService` - Encumbrance calculation
- `IRoomRepository` - Room data fetching
- `IHazardService` - Hazard querying
- `IInputHandler` - Message display

**Key Constants/Thresholds:**
- `TravelStepDelayMs = 75` - Delay between travel steps in milliseconds for visual feedback

**Target Resolution Logic:**
- `"home"` or `"anchor"` → `FindNearestFeatureAsync(RoomFeature.RunicAnchor)`
- `"surface"` → Custom BFS to find nearest room with `PositionZ == 0`
- Otherwise → `FindRoomsByNameAsync()` with case-insensitive partial matching
- If multiple matches: Uses first result (shortest name match)
- If no matches: Returns null (destination not found)

**Surface Finding Algorithm:**
- Checks if starting room is at Z=0 (immediate return)
- BFS from start room, checking `PositionZ == 0` for each discovered room
- Returns first room found at surface level
- Respects fog-of-war constraint (only visited rooms)

#### CommandParser.HandleTravelCommandAsync (Implementation)

**Method Signature:**
```csharp
private async Task<ParseResult> HandleTravelCommandAsync(string target, GameState state)
```

**Behaviors:**
- Validates `IAutoTravelService` is not null
- Calls `TravelToAsync(target)` with no cancellation token (ESC support deferred to future version)
- Displays result message with color coding: green for success, yellow for interruption, red for failure
- Returns `ParseResult { RequiresLook = true }` if any rooms were traveled (triggers room description display)
- Returns `ParseResult.None` if travel failed before starting

**Command Detection:**
```csharp
if (command.StartsWith("travel ") || command.StartsWith("goto "))
{
    var target = ExtractTarget(command, new[] { "travel ", "goto " });
    if (!string.IsNullOrWhiteSpace(target))
    {
        return await HandleTravelCommandAsync(target, state);
    }
    else
    {
        _inputHandler.DisplayError("Travel where? Specify a destination...");
        return ParseResult.None;
    }
}
```

---

## Logging Matrix

### RoomPathfinderService

| Event | Level | Template |
|-------|-------|----------|
| Pathfinding started | Debug | `[Path] Finding path from {Start} to {Destination}` |
| Already at destination | Debug | `[Path] Already at destination` |
| Destination not visited | Debug | `[Path] Destination {Id} not in visited rooms` |
| Start not visited | Debug | `[Path] Start {Id} not in visited rooms` |
| Rooms loaded for BFS | Debug | `[Path] Loaded {Count} visited rooms for pathfinding` |
| Path found | Debug | `[Path] Route from {Start} to {End}: {Count} steps` |
| No path found | Debug | `[Path] No route from {Start} to {End}` |
| Feature search started | Debug | `[Path] Finding nearest {Feature} from {Start}` |
| Start room not visited (feature) | Debug | `[Path] Start room not in visited set` |
| Start room has feature | Debug | `[Path] Start room has {Feature}` |
| Nearest feature found | Debug | `[Path] Found nearest {Feature} at {Room}` |
| No feature found | Debug | `[Path] No room with {Feature} found in explored areas` |
| Name search started | Debug | `[Path] Searching for rooms matching '{Name}'` |
| Name search complete | Debug | `[Path] Found {Count} rooms matching '{Name}'` |

### AutoTravelService

| Event | Level | Template |
|-------|-------|----------|
| Precondition validation | Debug | `[Travel] Validating preconditions for {Character}` |
| Precondition blocked | Debug | `[Travel] Blocked: Character is exhausted/overburdened` |
| Precondition blocked (combat) | Debug | `[Travel] Blocked: Not in exploration phase` |
| Path safety validation | Debug | `[Travel] Validating safety of {Count} room path` |
| Path blocked (lethal) | Debug | `[Travel] Path blocked: {Room} is lethal` |
| Path blocked (hazard) | Debug | `[Travel] Path blocked: Hazard {Hazard} in {Room}` |
| Journey started | Information | `[Travel] Beginning journey of {Count} steps` |
| Step executed | Trace | `[Travel] Step {N}/{Total}: {Direction}` |
| Interrupted (user) | Warning | `[Travel] Interrupted at {Room}. Reason: UserCancelled` |
| Interrupted (combat) | Warning | `[Travel] Interrupted at {Room}. Reason: CombatTriggered` |
| Journey completed | Information | `[Travel] Arrived at {Destination} after {Turns} turns` |
| Target resolution | Debug | `[Travel] Resolving target: '{Target}'` |
| Home keyword | Debug | `[Travel] Resolving 'home' keyword to nearest RunicAnchor` |
| Surface keyword | Debug | `[Travel] Resolving 'surface' keyword to nearest Z=0 room` |
| No rooms match name | Debug | `[Travel] No rooms found matching '{Target}'` |
| Multiple matches | Debug | `[Travel] Multiple matches for '{Target}', using first: {Room}` |
| Journey to destination | Information | `[Travel] Beginning journey to {Destination}` |

### CommandParser

| Event | Level | Template |
|-------|-------|----------|
| Travel command received | Debug | `[Travel] Travel command received with target: '{Target}'` |
| Service unavailable | Warning | `Travel command attempted but IAutoTravelService is null.` |

---

## Test Coverage

**Summary:**
```
Total: 27 | Passed: 27 | Failed: 0 | Duration: 1446ms
```

### RoomPathfinderServiceTests (12 tests)

| Test Name | Description |
|-----------|-------------|
| `FindPath_ReturnsEmpty_WhenAlreadyAtDestination` | Returns success with empty path when start equals destination |
| `FindPath_ReturnsPath_WhenDirectlyConnected` | Returns single-step path for adjacent rooms |
| `FindPath_FindsShortestPath_ThroughMultipleRooms` | Returns 2-step path (A→B→D) through connected graph |
| `FindPath_RespectsVisitedConstraint` | Returns failure when intermediate room (B) is not in visited set despite physical connection |
| `FindPath_ReturnsFail_WhenDestinationNotVisited` | Returns failure with "not been explored" message when destination not in visited set |
| `FindPath_ReturnsFail_WhenNoPathExists` | Returns failure with "No path through explored areas" when rooms are disconnected |
| `FindNearestFeature_ReturnsClosest` | Returns room D (1 step) over room C (2 steps) when both have target feature |
| `FindNearestFeature_ReturnsNull_WhenNoneExist` | Returns null when no visited rooms have target feature |
| `FindNearestFeature_ReturnsStartRoom_WhenItHasFeature` | Returns start room immediately without traversal when it has the feature |
| `FindRoomsByName_CaseInsensitive` | Matches "ENTRY" to "Entry Hall" regardless of case |
| `FindRoomsByName_PartialMatch` | Returns both "Entry Hall" and "Grand Entry" for search term "Entry" |
| `FindRoomsByName_ReturnsEmpty_WhenNoMatch` | Returns empty collection when search term matches no room names |

### AutoTravelServiceTests (15 tests)

| Test Name | Description |
|-----------|-------------|
| `ValidatePreconditions_BlocksExhausted` | Returns error "exhausted" when character has Exhausted status effect |
| `ValidatePreconditions_BlocksOverburdened` | Returns error "overburdened" when InventoryService reports Overburdened burden state |
| `ValidatePreconditions_AllowsHealthy` | Returns null (no error) when character is healthy and lightly burdened |
| `ValidatePreconditions_BlocksDuringCombat` | Returns error "combat" when GameState.Phase is Combat |
| `ValidatePathSafety_BlocksLethalRooms` | Returns error "dangerous" when path contains room with DangerLevel.Lethal |
| `ValidatePathSafety_BlocksMovementHazards` | Returns error "Hazard" and hazard name when path contains dormant movement hazard |
| `ValidatePathSafety_AllowsSafeRooms` | Returns null (no error) when path contains only safe rooms with no hazards |
| `ValidatePathSafety_IgnoresCooldownHazards` | Returns null when path contains movement hazard in Cooldown state (not dormant) |
| `ExecuteTravel_CompletesFullPath` | Successfully executes 2 directions, returns RoomsTraveled=2 and final room |
| `ExecuteTravel_StopsOnCancellation` | Returns interrupted result with UserCancelled reason when CancellationToken is pre-cancelled |
| `ExecuteTravel_StopsOnCombatPhaseChange` | Returns interrupted result with CombatTriggered reason when GameState.Phase changes to Combat mid-journey |
| `ExecuteTravel_ReturnsAlreadyThere_WhenEmptyPath` | Returns failure with "already" message when directions list is empty |
| `TravelTo_ResolvesHomeKeyword` | Calls FindNearestFeatureAsync for RunicAnchor when target is "home" |
| `TravelTo_ResolvesRoomName` | Calls FindRoomsByNameAsync and completes travel to matching room |
| `TravelTo_ReportsNoPath` | Returns failure with "No path" when pathfinder returns failed result |

---

## DI Registration

**File:** `RuneAndRust.Terminal/Program.cs`

```csharp
// Register Fast Travel Services (v0.3.20c - The Pathfinder)
services.AddScoped<IRoomPathfinderService, RoomPathfinderService>();
services.AddScoped<IAutoTravelService, AutoTravelService>();
```

**Lifetime:** Scoped (new instance per request scope; suitable for turn-based operations)

---

## Verification Results

### Build Output

```
Build succeeded.
    1 Warning(s)
    0 Error(s)
Time Elapsed 00:00:01.90
```

### Test Output (RoomPathfinderServiceTests)

```
Test Run Successful.
Total tests: 12
     Passed: 12
 Total time: 0.5306 Seconds
```

**Individual Results:**
- Passed: FindPath_ReturnsFail_WhenNoPathExists [45 ms]
- Passed: FindNearestFeature_ReturnsNull_WhenNoneExist [1 ms]
- Passed: FindNearestFeature_ReturnsClosest [1 ms]
- Passed: FindRoomsByName_ReturnsEmpty_WhenNoMatch [1 ms]
- Passed: FindRoomsByName_PartialMatch [< 1 ms]
- Passed: FindPath_RespectsVisitedConstraint [< 1 ms]
- Passed: FindNearestFeature_ReturnsStartRoom_WhenItHasFeature [< 1 ms]
- Passed: FindRoomsByName_CaseInsensitive [1 ms]
- Passed: FindPath_FindsShortestPath_ThroughMultipleRooms [2 ms]
- Passed: FindPath_ReturnsFail_WhenDestinationNotVisited [< 1 ms]
- Passed: FindPath_ReturnsPath_WhenDirectlyConnected [1 ms]
- Passed: FindPath_ReturnsEmpty_WhenAlreadyAtDestination [1 ms]

### Test Output (AutoTravelServiceTests)

```
Test Run Successful.
Total tests: 15
     Passed: 15
 Total time: 0.9156 Seconds
```

**Individual Results:**
- Passed: ValidatePathSafety_BlocksLethalRooms [45 ms]
- Passed: ValidatePreconditions_BlocksOverburdened [3 ms]
- Passed: ValidatePreconditions_BlocksExhausted [1 ms]
- Passed: TravelTo_ReportsNoPath [4 ms]
- Passed: ExecuteTravel_CompletesFullPath [158 ms]
- Passed: ValidatePreconditions_AllowsHealthy [< 1 ms]
- Passed: ValidatePathSafety_AllowsSafeRooms [< 1 ms]
- Passed: TravelTo_ResolvesHomeKeyword [80 ms]
- Passed: ValidatePathSafety_BlocksMovementHazards [1 ms]
- Passed: TravelTo_ResolvesRoomName [77 ms]
- Passed: ExecuteTravel_StopsOnCancellation [1 ms]
- Passed: ValidatePathSafety_IgnoresCooldownHazards [< 1 ms]
- Passed: ExecuteTravel_ReturnsAlreadyThere_WhenEmptyPath [< 1 ms]
- Passed: ValidatePreconditions_BlocksDuringCombat [< 1 ms]
- Passed: ExecuteTravel_StopsOnCombatPhaseChange [77 ms]

---

## Directory Structure After Release

```
RuneAndRust/
├── RuneAndRust.Core/
│   ├── Interfaces/
│   │   ├── IAutoTravelService.cs         [NEW]
│   │   └── IRoomPathfinderService.cs     [NEW]
│
├── RuneAndRust.Engine/
│   └── Services/
│       ├── AutoTravelService.cs          [NEW]
│       ├── CommandParser.cs              [MODIFIED]
│       └── RoomPathfinderService.cs      [NEW]
│
├── RuneAndRust.Terminal/
│   └── Program.cs                        [MODIFIED]
│
└── RuneAndRust.Tests/
    └── Engine/
        ├── AutoTravelServiceTests.cs     [NEW]
        └── RoomPathfinderServiceTests.cs [NEW]
```

---

## Running Tests

**Run all auto-travel tests:**
```bash
dotnet test --filter "FullyQualifiedName~RoomPathfinderServiceTests"
dotnet test --filter "FullyQualifiedName~AutoTravelServiceTests"
```

**Run specific test:**
```bash
dotnet test --filter "FullyQualifiedName~AutoTravelServiceTests.ExecuteTravel_CompletesFullPath"
```

**Run all v0.3.20c tests:**
```bash
dotnet test --filter "FullyQualifiedName~RoomPathfinder | FullyQualifiedName~AutoTravel"
```

---

## Command Reference

### Travel Commands (v0.3.20c)

| Command | Behavior |
|---------|----------|
| `travel <name>` | Auto-walk to a visited room matching the name (case-insensitive partial match) |
| `travel home` | Auto-walk to the nearest room with RoomFeature.RunicAnchor |
| `travel anchor` | Same as `travel home` |
| `travel surface` | Auto-walk to the nearest room at Z=0 (surface level) |
| `goto <name>` | Alias for `travel <name>` |

### Example Usage

```
> travel grand hall
[green]Traveling to Grand Hall...[/]
[grey]...passing through Rusted Corridor...[/]
[grey]...passing through Eastern Junction...[/]
[green]Arrived at Grand Hall after 2 rooms (2 turns).[/]

> travel home
[green]Traveling to Runic Sanctuary...[/]
[grey]...passing through Central Hub...[/]
[green]Arrived at Runic Sanctuary after 1 rooms (1 turns).[/]

> travel surface
[red]Path blocked: Steam Vent Chamber is too dangerous.[/]

> travel deep forge
[yellow]Travel interrupted by combat! You are in Lower Passage.[/]
```

### Blocking Conditions

**Precondition Failures (prevent travel start):**
- Character has `StatusEffectType.Exhausted`
- Character is `BurdenState.Overburdened`
- `GamePhase` is not `Exploration` (e.g., already in combat)

**Path Safety Failures (prevent travel start):**
- Any room in path has `DangerLevel.Lethal`
- Any room in path has dormant movement hazard (`TriggerType.Movement` + `HazardState.Dormant`)

**Interruption Conditions (stop travel mid-journey):**
- `CancellationToken` is triggered (ESC key—deferred to future version)
- `GamePhase` changes to `Combat` (ambush during travel)
- Movement fails (blocked exit, unexpected error from NavigationService)

---

## Next Steps

Planned for v0.3.20d or later:

- **ESC Key Cancellation:** Implement `CancellationTokenSource` tied to `Console.KeyAvailable` polling for user-initiated travel cancellation
- **Travel Animation:** Enhanced visual feedback with room-by-room rendering or ASCII animation
- **Travel Time Estimation:** Pre-calculate and display estimated travel time before starting journey
- **Path Visualization:** Show planned route on map before executing travel
- **Travel Log:** Record travel events in journal for historical tracking
- **Auto-Travel Preferences:** User settings for step delay, confirmation prompts, hazard tolerance
- **Waypoint System:** Allow saving custom waypoint locations beyond features
- **Route Caching:** Cache frequently-used paths to reduce BFS computation overhead
- **Dijkstra/A* Support:** Implement weighted pathfinding when room traversal costs become non-uniform (e.g., difficult terrain, hazards with resource costs)
