# v0.16.5c Changelog — Unique Item Registry

**Version:** 0.16.5c  
**Date:** 2026-01-29  
**Phase:** Unique Items & Myth-Forged System

---

## Summary

Implements the Unique Item Registry system for tracking Myth-Forged item drops per run. Provides duplicate prevention through efficient O(1) lookup, chronological drop history tracking, and run lifecycle management with reset capability.

---

## Added

### Domain Layer - Value Object

- **`DropRecord`** value object — Immutable record of a unique item drop event:
    - `ItemId` — Unique item's configuration ID (normalized to lowercase)
    - `DroppedAt` — UTC timestamp of the drop
    - `SourceType` — `DropSourceType` enum value indicating drop origin
    - `SourceId` — Specific source identifier (e.g., boss ID, container ID)
    - `Create()` factory method with validation and ID normalization
    - `ToString()` for debugging output
    - Full XML documentation with examples

---

### Domain Layer - Entity

- **`UniqueItemRegistry`** entity — Tracks unique item drops per run:
    - Identity: `Id` (Guid), `RunId` (Guid), `CreatedAt` (DateTime)
    - Collections: `DropHistory` (IReadOnlyList<DropRecord>), internal `HashSet<string>` for O(1) lookup
    - `Create(runId)` — Factory method for new registry
    - `HasDropped(itemId)` — Case-insensitive O(1) duplicate check
    - `RegisterDrop(itemId, sourceType, sourceId)` — Records drop, throws on duplicate
    - `GetDroppedCount()` — Count of unique drops
    - `GetDroppedItemIds()` — Read-only set of dropped IDs
    - `IsCurrentRun(runId)` — Run ID validation
    - `Reset(newRunId)` — Clears state for new run
    - `GetDropsBySourceType(sourceType)` — Filters drop history by source
    - `GetLastDrop()` — Returns most recent drop record or null
    - Full XML documentation with examples

---

### Application Layer - Interface

- **`IUniqueItemRegistry`** interface — Application-layer registry operations:
    - `CurrentRunId` property
    - `HasDropped(itemId)` — Existence check
    - `RegisterDrop(itemId, sourceType, sourceId)` — Record and return DropRecord
    - `GetAvailableUniques(sourceType, sourceId, classId?)` — Filter available items
    - `GetDropHistory()` — Full history access
    - `GetDroppedCount()` — Drop count
    - `Reset(newRunId)` — Run lifecycle hook
    - Full XML documentation with usage examples

---

### Unit Tests

- **`DropRecordTests`** — 12 tests:
    - `Create_WithValidData_CreatesRecord`
    - `Create_NormalizesIds`
    - `Create_WithNullItemId_ThrowsArgumentException`
    - `Create_WithEmptyItemId_ThrowsArgumentException`
    - `Create_WithNullSourceId_ThrowsArgumentException`
    - `Create_WithWhitespaceSourceId_ThrowsArgumentException`
    - `Create_WithCustomTimestamp_UsesProvidedTime`
    - `ToString_ReturnsFormattedString`
    - `Equality_WithSameValues_AreEqual`
    - `Equality_WithDifferentValues_AreNotEqual`
    - `Create_WithDifferentSourceTypes_CapturesCorrectly` (parameterized, 5 cases)

- **`UniqueItemRegistryTests`** — 24 tests:
    - `Create_WithRunId_InitializesCorrectly`
    - `HasDropped_WithUnregisteredItem_ReturnsFalse`
    - `HasDropped_WithRegisteredItem_ReturnsTrue`
    - `HasDropped_IsCaseInsensitive`
    - `HasDropped_WithNullItemId_ThrowsArgumentException`
    - `RegisterDrop_AddsToHistoryAndSet`
    - `RegisterDrop_NormalizesItemId`
    - `RegisterDrop_WithAlreadyDroppedItem_ThrowsInvalidOperationException`
    - `RegisterDrop_WithDifferentCasing_ThrowsInvalidOperationException`
    - `RegisterDrop_WithNullItemId_ThrowsArgumentException`
    - `RegisterDrop_WithNullSourceId_ThrowsArgumentException`
    - `RegisterDrop_MultipleDifferentItems_AllTracked`
    - `Reset_ClearsAllStateAndSetsNewRunId`
    - `Reset_AllowsReregistrationOfPreviouslyDroppedItems`
    - `IsCurrentRun_WithMatchingRunId_ReturnsTrue`
    - `IsCurrentRun_WithDifferentRunId_ReturnsFalse`
    - `GetDropsBySourceType_FiltersCorrectly`
    - `GetLastDrop_WithNoDrops_ReturnsNull`
    - `GetLastDrop_WithDrops_ReturnsMostRecent`
    - `GetDroppedItemIds_ReturnsReadOnlySet`
    - `DropHistory_MaintainsChronologicalOrder`

---

## Design Decisions

| Decision                                   | Rationale                                               |
| ------------------------------------------ | ------------------------------------------------------- |
| `readonly record struct` for DropRecord    | Immutability and built-in equality for value semantics  |
| `HashSet<string>` with OrdinalIgnoreCase   | O(1) duplicate detection with case-insensitive matching |
| IDs normalized to lowercase                | Ensures consistent matching across config and runtime   |
| `InvalidOperationException` for duplicates | Clear indication of business rule violation             |
| Nullable `GetLastDrop()` return            | Safe handling when no drops exist yet                   |
| Separate interface from entity             | Clean separation of domain and application concerns     |

---

## Dependencies

| Dependency | Description           | Status      |
| ---------- | --------------------- | ----------- |
| v0.16.5a   | `DropSourceType` enum | ✅ Complete |
| v0.16.5a   | `UniqueItem` entity   | ✅ Complete |
| Existing   | `IEntity` interface   | ✅ Complete |

---

## Provides To

| Consumer | Description                     |
| -------- | ------------------------------- |
| v0.16.5d | Loot generation integration     |
| v0.16.5e | Unique item visual presentation |
| v0.16.5f | Set bonus system                |

---

## File Summary

| File                         | Type         | Lines |
| ---------------------------- | ------------ | ----- |
| `DropRecord.cs`              | Value Object | ~160  |
| `UniqueItemRegistry.cs`      | Entity       | ~310  |
| `IUniqueItemRegistry.cs`     | Interface    | ~195  |
| `DropRecordTests.cs`         | Unit Tests   | ~165  |
| `UniqueItemRegistryTests.cs` | Unit Tests   | ~295  |

---

## Verification

- **Build:** 0 errors, 0 warnings
- **Unit Tests:** 36/36 passed (12 + 24)
- **Test Coverage:** All factory methods, validation, duplicate prevention, and lifecycle methods
