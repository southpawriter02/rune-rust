# Changelog: v0.18.0d - StressService Implementation

**Release Date:** 2026-01-31
**Phase:** Psychic Stress System (4/6)
**Status:** Complete

---

## Overview

Implements the `StressService` class — the core implementation of the `IStressService` interface that manages all Psychic Stress operations including application, WILL-based resistance checks, rest-based recovery, and post-Trauma Check reset. This is the fourth phase of v0.18.0 (Psychic Stress System), bringing the stress system to life with executable business logic.

The service implements 9 methods across three categories: 4 query methods for reading stress state and derived penalties, 4 command methods for applying stress (with optional resistance), recovering stress (via rest or named sources), and resetting stress after Trauma Check resolution, and 1 internal method for performing WILL-based resistance checks independently.

A supporting `SetPsychicStress(int)` method was added to the `Player` entity to provide a clean mutation point for stress updates, matching the pattern established by `SetTraumaBaseline()`.

---

## Added

### Application Layer — Services

- **`StressService`** (`Application/Services/StressService.cs`)
    - Implements `IStressService` (v0.18.0c) with all 9 methods
    - **Dependencies:** `IPlayerRepository`, `IDiceService`, `ILogger<StressService>`
    - **Constants:**
        - `TraumaPassResetValue = 75` — stress after passing Trauma Check
        - `TraumaFailResetValue = 50` — stress after failing Trauma Check
        - `ShortRestMultiplier = 2` — Short Rest: WILL × 2
        - `LongRestMultiplier = 5` — Long Rest: WILL × 5
        - `MilestoneRecovery = 25` — Milestone: fixed 25
    - **Query Methods** (read-only, no side effects):
        - `GetStressState(Guid)` → `StressState` snapshot from player's PsychicStress
        - `GetDefensePenalty(Guid)` → `floor(stress / 20)` (0-5 range)
        - `HasSkillDisadvantage(Guid)` → `true` when stress >= 80
        - `RequiresTraumaCheck(Guid)` → `true` when stress >= 100
    - **Command Methods** (modify player stress, persist to repository):
        - `ApplyStress(Guid, int, StressSource, int resistDc)` → optional WILL resistance → clamp → persist → return `StressApplicationResult`
        - `RecoverStress(Guid, RestType)` → formula-based recovery → clamp → persist → return `StressRecoveryResult`
        - `RecoverStress(Guid, int, string)` → direct recovery from named source → clamp → persist → return `StressRecoveryResult`
        - `ResetAfterTraumaCheck(Guid, bool)` → set to 75 (passed) or 50 (failed) → persist
    - **Internal Methods:**
        - `PerformResistanceCheck(Guid, int, int)` → roll WILL d10 pool → NetSuccesses → `StressCheckResult`
    - **Private Helpers:**
        - `GetPlayer(Guid)` → `IPlayerRepository.GetByIdAsync` with `CharacterNotFoundException` on null
        - `CalculateRecoveryAmount(RestType, int)` → switch expression with all 4 rest formulas
        - `UpdatePlayerStress(Player, int)` → `SetPsychicStress` + `UpdateAsync`
    - Comprehensive structured logging at every operation: Debug for queries and resistance details, Information for stress changes and threshold crossings, Warning for trauma triggers and missing characters
    - Box comment header (═══ style), file-scoped namespace, comprehensive XML documentation on class and all methods

### Domain Layer — Entity Methods

- **`Player.SetPsychicStress(int)`** (`Domain/Entities/Player.cs`)
    - Public method to set PsychicStress value with clamping to [0, 100]
    - XML documentation with `<summary>`, `<param>`, `<remarks>`, `<example>`, `<seealso>`
    - Added after `SetTraumaBaseline()` method in the Lineage System section

### Unit Tests

- **`StressServiceTests`** (`Services/StressServiceTests.cs`) — 85 test methods
    - **Constructor** (3 tests): Null argument validation for all 3 dependencies
    - **GetStressState** (4 tests): Correct state return, CharacterNotFoundException, zero stress (Calm), max stress (Trauma)
    - **GetDefensePenalty** (11 tests): Parameterized boundary cases for all 6 thresholds (0, 19, 20, 39, 40, 59, 60, 79, 80, 99, 100)
    - **HasSkillDisadvantage** (7 tests): Parameterized for all threshold boundaries including 80+ true cases
    - **RequiresTraumaCheck** (4 tests): Parameterized (0, 50, 99 → false; 100 → true)
    - **ApplyStress — No Resistance** (12 tests): Full stress application, clamping to 100, zero amount, negative throws, threshold crossing detection, no-crossing within range, trauma trigger at 100, no trigger at 99, repository persistence, player entity update, all 6 StressSource values
    - **ApplyStress — With Resistance** (8 tests): Full reduction table (0/1/2/3/4/5 successes), WILL dice pool verification, no dice roll when resistDc=0
    - **RecoverStress — RestType** (9 tests): Short (WILL×2), Long (WILL×5), Sanctuary (full reset), Milestone (fixed 25), Milestone ignores WILL, clamp to 0, threshold drop detection, no threshold drop within range, repository persistence
    - **RecoverStress — Named Source** (6 tests): Direct reduction, clamp to 0, negative amount throws, null/empty/whitespace source throws
    - **ResetAfterTraumaCheck** (4 tests): Passed→75, Failed→50, repository persistence, CharacterNotFoundException
    - **PerformResistanceCheck** (7 tests): Parameterized reduction table (6 cases), FinalStress calculation, negative base stress throws, negative DC throws, zero base stress, truncation verification (15 * 50% = 7)
    - **Integration Scenarios** (2 tests): Apply-then-recover multi-step, stress-100-then-trauma-reset multi-step

### Glossary

- **`config/glossary.json`** — Added 1 glossary entry (sortOrder 83)
    - `stress-service-impl`: Application service implementing IStressService with WILL-based resistance, formula recovery, and trauma reset

---

## Changed

### Documentation

- **`docs/design/v0.18.x/v0.18.0-scope-breakdown.md`** — Checked off v0.18.0d acceptance criteria
- **`docs/design/v0.18.x/v0.18.0d-design-specification.md`** — Checked off deliverable and acceptance criteria items

---

## Design Decisions

### IPlayerRepository Instead of ICharacterRepository

The design specification references `ICharacterRepository` with synchronous `GetById()` and `Update()` methods, but this interface does not exist in the codebase. The actual repository is `IPlayerRepository` (v0.17.5g) with async methods (`GetByIdAsync`, `UpdateAsync`). Since `IStressService` (v0.18.0c) defines synchronous method signatures, the service uses sync-over-async wrapping (`.GetAwaiter().GetResult()`) which is safe with the current `InMemoryPlayerRepository` that completes synchronously via `Task.FromResult`. A `TODO: v0.19.x` comment marks this for future async migration.

### Player Entity Instead of Character Entity

The design specification references a `Character` entity, but the codebase uses `Player` as the domain entity for game characters. All references were adapted accordingly: `_characterRepository` → `_playerRepository`, `Character` → `Player`, `GetCharacter` → `GetPlayer`.

### SetPsychicStress Added to Player

The design specification's `UpdateCharacterStress` helper calls `character.SetPsychicStress(newStress)`, but this method did not exist on the `Player` entity. The `PsychicStress` property had `private set` with no public mutator beyond `SetTraumaBaseline()`. A new `SetPsychicStress(int)` method was added with clamping to [0, 100], matching the defensive behavior of `StressState.Create()`.

### IDiceService.Roll Instead of RollAttributeCheck

The design specification references `_diceService.RollAttributeCheck(will, dc)` which does not exist in `IDiceService`. The implementation uses `_diceService.Roll(DicePool.D10(will))` to roll a pool of WILL d10 dice, then reads `.NetSuccesses` from the `DiceRollResult`. This uses the existing success-counting mechanics (8+ = success, 1 = botch, net = max(0, successes - botches)). The DC parameter from the interface is used to roll dice but the actual DC comparison happens in `StressCheckResult.Create()` through the reduction table.

### Test Count Expansion

The design specification estimated ~8 tests. The implementation includes 85 test methods across 10 test categories, consistent with v0.18.0a's pattern (66 tests vs ~4 estimated) and v0.18.0b's pattern (84 tests vs ~3 estimated). The expanded coverage includes boundary conditions for all 6 threshold tiers, all 4 rest type formulas, all 6 stress source values, negative/null argument validation, threshold crossing/non-crossing edge cases, repository persistence verification, and multi-step integration scenarios.

---

## Dependencies

### Prerequisites

| Type | Phase | Usage |
| --- | --- | --- |
| `StressState` | v0.18.0a | Return from `GetStressState`, MinStress/MaxStress constants for clamping |
| `StressThreshold` | v0.18.0a | Referenced in threshold comparison and logging |
| `StressSource` | v0.18.0a | Parameter categorization for `ApplyStress` |
| `RestType` | v0.18.0a | Recovery type selection for `RecoverStress` |
| `StressCheckResult` | v0.18.0b | Return type for `PerformResistanceCheck` |
| `StressApplicationResult` | v0.18.0b | Return type for `ApplyStress` |
| `StressRecoveryResult` | v0.18.0b | Return type for `RecoverStress` |
| `IStressService` | v0.18.0c | Interface implemented by `StressService` |
| `CharacterNotFoundException` | v0.18.0c | Thrown when player not found in repository |
| `IPlayerRepository` | v0.17.5g | Player entity persistence and retrieval |
| `IDiceService` | v0.6.x | WILL-based resistance dice rolls |

### Provides to Future Phases

| Type | Phase | Usage |
| --- | --- | --- |
| `StressService` | v0.18.0e | Configuration loading integration |
| `StressService` | v0.18.0f | Database persistence integration |
| `StressService` | DI Container | Registered as `IStressService` implementation |
| `StressService` | CombatService | Stress application during combat encounters |
| `StressService` | RestService | Stress recovery during rest events |
| `StressService` | TraumaService | Trauma check reset after resolution |
| `Player.SetPsychicStress` | Future | Direct stress mutation for all stress-modifying systems |

---

## Logging Strategy

Comprehensive structured logging implemented across all methods:

| Event | Level | Template |
| --- | --- | --- |
| Service Initialized | Debug | `"StressService initialized with IPlayerRepository, IDiceService"` |
| Stress Queried | Debug | `"Stress state queried for {CharacterId}: {CurrentStress}/{MaxStress} [{Threshold}]"` |
| Defense Penalty Queried | Debug | `"Defense penalty queried for {CharacterId}: -{DefensePenalty} (stress: {CurrentStress})"` |
| Skill Disadvantage Queried | Debug | `"Skill disadvantage queried for {CharacterId}: {HasDisadvantage} (stress: {CurrentStress})"` |
| Trauma Check Queried | Debug | `"Trauma check requirement queried for {CharacterId}: {RequiresCheck} (stress: {CurrentStress})"` |
| Resistance Roll | Debug | `"WILL resistance roll for {CharacterId}: {Will}d10 → {Successes} net successes"` |
| Resistance Check | Debug | `"Resistance check for {CharacterId}: {Successes} successes, {ReductionPercent:P0} reduction"` |
| Stress Applied | Information | `"Stress applied to {CharacterId}: +{StressGained} [{Source}] ({PreviousStress} → {NewStress})"` |
| Threshold Crossed | Information | `"Stress threshold crossed for {CharacterId}: {PreviousThreshold} → {NewThreshold}"` |
| Trauma Triggered | Warning | `"TRAUMA CHECK TRIGGERED for {CharacterId}: Stress at {NewStress}"` |
| Stress Recovered | Information | `"Stress recovered for {CharacterId}: -{AmountRecovered} [{RecoverySource}]"` |
| Threshold Improved | Information | `"Stress threshold improved for {CharacterId}: {PreviousThreshold} → {NewThreshold}"` |
| Trauma Reset | Information | `"Stress reset after Trauma Check for {CharacterId}: {Result} → {NewStress}"` |
| Character Not Found | Warning | `"Character not found: {CharacterId}"` |

---

## Files Created

| Path | Description |
|------|-------------|
| `src/Core/RuneAndRust.Application/Services/StressService.cs` | StressService implementation (9 methods) |
| `tests/RuneAndRust.Application.UnitTests/Services/StressServiceTests.cs` | StressService tests (85 tests) |
| `changelogs/v0.18.0d-changelog.md` | This changelog |

## Files Modified

| Path | Description |
|------|-------------|
| `src/Core/RuneAndRust.Domain/Entities/Player.cs` | Added `SetPsychicStress(int)` method |
| `config/glossary.json` | Added 1 glossary entry (sortOrder 83) |
| `docs/design/v0.18.x/v0.18.0-scope-breakdown.md` | Checked off v0.18.0d acceptance criteria |
| `docs/design/v0.18.x/v0.18.0d-design-specification.md` | Checked off deliverable and acceptance criteria |

---

## Notes

- Total unit tests for v0.18.0d: 85 test methods in 1 test file (far exceeding the ~8 estimate)
- All 85 new tests pass; all 3845 existing tests unaffected (0 regressions); total: 3930 passing
- Build succeeds with 0 errors, 0 warnings
- All new files follow established codebase patterns: `═══════` box comment headers and section separators, file-scoped namespaces, comprehensive XML documentation
- Uses sync-over-async wrapping for `IPlayerRepository` calls (safe with `InMemoryPlayerRepository`)
- Uses `DicePool.D10(will)` + `NetSuccesses` instead of nonexistent `RollAttributeCheck`
- The `Player.SetPsychicStress()` method clamps to [0, 100] defensively
- Pre-existing glossary schema validation failure at term #88 remains (unrelated to v0.18.0d changes)
