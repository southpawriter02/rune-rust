# v0.11.2a Changelog: Crafting Stations

**Version:** 0.11.2a
**Phase:** Crafting Stations (Station Definitions & Room Integration)
**Date:** 2026-01-19
**Status:** ✅ Complete

---

## Summary

Implements the Crafting Stations system establishing the **Definition-Instance pattern** for crafting stations. Stations are room features where players can craft items using recipes. Each station type supports specific recipe categories and links to a crafting skill for dice check modifiers.

This version provides the foundational station infrastructure that will be used by the Crafting Service (v0.11.2b) and Quality System (v0.11.2c).

---

## Added

### Domain Layer - Enums

| Enum | Description |
|------|-------------|
| `RoomFeatureType.CraftingStation` | Identifies crafting station room features |

#### RoomFeatureType.CraftingStation

Added to the existing `RoomFeatureType` enum for room feature classification. Used to filter and identify crafting stations within room feature collections.

### Domain Layer - Definitions

| Entity | Description |
|--------|-------------|
| `CraftingStationDefinition` | Immutable template for crafting station types |

#### CraftingStationDefinition Properties

| Property | Type | Description |
|----------|------|-------------|
| `Id` | `Guid` | Unique entity identifier |
| `StationId` | `string` | Station type identifier (kebab-case, lowercase) |
| `Name` | `string` | Display name shown in UI |
| `Description` | `string` | Examination text |
| `SupportedCategories` | `IReadOnlyList<RecipeCategory>` | Recipe categories this station crafts |
| `CraftingSkillId` | `string` | Skill used for crafting checks |
| `IconPath` | `string?` | Optional UI icon path |

#### CraftingStationDefinition Methods

| Method | Returns | Description |
|--------|---------|-------------|
| `Create(...)` | `CraftingStationDefinition` | Factory method with validation |
| `SupportsCategory(category)` | `bool` | Check if category is supported |
| `CanCraftRecipe(recipe)` | `bool` | Check if recipe can be crafted here |
| `GetCategoriesDisplay()` | `string` | Formatted category list for display |
| `CreateInstance()` | `CraftingStation` | Create station instance from definition |
| `CreateInstance(customDescription)` | `CraftingStation` | Create instance with custom description |

### Domain Layer - Entities

| Entity | Description |
|--------|-------------|
| `CraftingStation` | Room feature instance for crafting |

#### CraftingStation Properties

| Property | Type | Description |
|----------|------|-------------|
| `Id` | `Guid` | Unique instance identifier |
| `DefinitionId` | `string` | Reference to station definition |
| `Name` | `string` | Display name |
| `Description` | `string` | Examination text |
| `FeatureType` | `RoomFeatureType` | Always `CraftingStation` |
| `IsInteractable` | `bool` | Always `true` |
| `InteractionVerb` | `string` | Always `"use"` |
| `IsAvailable` | `bool` | Whether station can be used |
| `LastUsedAt` | `DateTime?` | Last usage timestamp |

#### CraftingStation Methods

| Method | Returns | Description |
|--------|---------|-------------|
| `Create(definition)` | `CraftingStation` | Factory from definition |
| `Create(definition, customDescription)` | `CraftingStation` | Factory with custom description |
| `SetInUse()` | `void` | Mark station as unavailable |
| `SetAvailable()` | `void` | Restore availability |
| `GetStatusDescription()` | `string` | Current status text |
| `GetInteractionPrompt()` | `string` | Interaction hint text |
| `GetStatusIndicator()` | `string` | Short status indicator |

### Application Layer - Interfaces

| Interface | Description |
|-----------|-------------|
| `ICraftingStationProvider` | Provider for station definitions |

#### ICraftingStationProvider Methods

| Method | Returns | Description |
|--------|---------|-------------|
| `GetStation(stationId)` | `CraftingStationDefinition?` | Get station by ID (case-insensitive) |
| `GetAllStations()` | `IReadOnlyList<CraftingStationDefinition>` | Get all stations |
| `GetStationsForCategory(category)` | `IReadOnlyList<CraftingStationDefinition>` | Stations supporting category |
| `GetStationsBySkill(skillId)` | `IReadOnlyList<CraftingStationDefinition>` | Stations using skill |
| `GetCraftingSkill(stationId)` | `string?` | Get skill ID for station |
| `Exists(stationId)` | `bool` | Check if station exists |
| `GetStationCount()` | `int` | Total station count |

### Infrastructure Layer - Configuration

| Class | Description |
|-------|-------------|
| `CraftingStationSettings` | Configuration container for JSON binding |
| `CraftingStationConfig` | DTO for individual station configuration |

#### CraftingStationSettings Properties

| Property | Type | Description |
|----------|------|-------------|
| `Stations` | `List<CraftingStationConfig>` | Station configurations |

#### CraftingStationConfig Properties

| Property | Type | Description |
|----------|------|-------------|
| `Id` | `string` | Station identifier |
| `Name` | `string` | Display name |
| `Description` | `string` | Examination text |
| `SupportedCategories` | `List<string>` | Recipe category names |
| `CraftingSkill` | `string` | Skill identifier |
| `Icon` | `string?` | Optional icon path |

### Infrastructure Layer - Provider

| Provider | Description |
|----------|-------------|
| `CraftingStationProvider` | Loads station definitions from JSON configuration |

#### CraftingStationProvider Features

- Case-insensitive station ID lookups (StringComparer.OrdinalIgnoreCase)
- Thread-safe lazy loading with double-checked locking
- Multi-index for efficient filtering (by category, by skill)
- Comprehensive validation on load with logging
- Graceful handling of invalid configurations

### Infrastructure Layer - DI Registration

| Registration | Lifetime | Description |
|--------------|----------|-------------|
| `CraftingStationSettings` | Configuration | Bound from "CraftingStations" section |
| `ICraftingStationProvider` | Singleton | Station definition provider |

### Configuration Files

| File | Description |
|------|-------------|
| `config/crafting-stations.json` | Station type definitions |
| `config/schemas/crafting-stations.schema.json` | JSON Schema for validation |

#### Default Crafting Station Types

| Station | Categories | Skill | Description |
|---------|------------|-------|-------------|
| anvil | Weapon, Tool, Material | smithing | Iron anvil for forging |
| workbench | Armor, Accessory | leatherworking | Wooden workbench for crafting |
| alchemy-table | Potion, Consumable | alchemy | Table for brewing potions |
| enchanting-altar | Accessory, Weapon, Armor | enchanting | Stone altar for enchanting |
| cooking-fire | Consumable | cooking | Fire pit for cooking food |

---

## Unit Tests

### CraftingStationDefinitionTests (~26 tests)

- Factory method creation with valid parameters
- Parameter validation (null, empty, whitespace)
- Station ID normalization to lowercase
- Skill ID normalization to lowercase
- Empty categories throws ArgumentOutOfRangeException
- SupportsCategory returns correct values
- CanCraftRecipe validates category support
- GetCategoriesDisplay formatting
- CreateInstance factory methods
- Icon path handling (optional)
- ToString formatting

### CraftingStationTests (~30 tests)

- Create from definition sets all properties
- Custom description factory method
- Null definition throws ArgumentNullException
- Invalid custom description validation
- Unique ID generation
- SetInUse sets availability false
- SetInUse updates LastUsedAt
- SetAvailable restores availability
- SetAvailable preserves LastUsedAt
- GetStatusDescription available/unavailable
- GetInteractionPrompt available/unavailable
- GetStatusIndicator formatting
- ToString with status indicator
- FeatureType is always CraftingStation
- IsInteractable is always true
- InteractionVerb is always "use"

### CraftingStationProviderTests (~15+ tests)

- GetStation with valid ID returns station
- GetStation with invalid ID returns null
- GetStation case-insensitive lookup
- GetAllStations returns all definitions
- GetStationsForCategory filters correctly
- GetStationsForCategory returns empty for unsupported
- GetStationsBySkill filters correctly
- GetStationsBySkill case-insensitive
- GetCraftingSkill returns correct skill
- GetCraftingSkill returns null for invalid station
- Exists returns true for valid station
- Exists returns false for invalid station
- GetStationCount returns correct count
- Empty configuration handling
- Duplicate station handling (warning logged)
- Invalid configuration validation

---

## Files Created

| Path | Description |
|------|-------------|
| `src/Core/RuneAndRust.Domain/Definitions/CraftingStationDefinition.cs` | Station definition entity |
| `src/Core/RuneAndRust.Domain/Entities/CraftingStation.cs` | Station room feature entity |
| `src/Core/RuneAndRust.Application/Interfaces/ICraftingStationProvider.cs` | Provider interface |
| `src/Infrastructure/RuneAndRust.Infrastructure/Configuration/CraftingStationSettings.cs` | Settings classes |
| `src/Infrastructure/RuneAndRust.Infrastructure/Providers/CraftingStationProvider.cs` | Provider implementation |
| `config/crafting-stations.json` | Station configurations |
| `config/schemas/crafting-stations.schema.json` | JSON Schema |
| `tests/RuneAndRust.Domain.UnitTests/Definitions/CraftingStationDefinitionTests.cs` | Definition tests |
| `tests/RuneAndRust.Domain.UnitTests/Entities/CraftingStationTests.cs` | Entity tests |
| `tests/RuneAndRust.Application.UnitTests/Providers/CraftingStationProviderTests.cs` | Provider tests |

## Files Modified

| Path | Description |
|------|-------------|
| `src/Core/RuneAndRust.Domain/Enums/DungeonGenerationEnums.cs` | Added `CraftingStation` to RoomFeatureType |
| `src/Infrastructure/RuneAndRust.Infrastructure/DependencyInjection.cs` | Added provider registration |

---

## API Examples

### Creating Station Definitions

```csharp
// Create a crafting station definition
var definition = CraftingStationDefinition.Create(
    stationId: "anvil",
    name: "Anvil",
    description: "A sturdy iron anvil for smithing metal items.",
    supportedCategories: new[] { RecipeCategory.Weapon, RecipeCategory.Tool, RecipeCategory.Material },
    craftingSkillId: "smithing",
    iconPath: "icons/stations/anvil.png");

Console.WriteLine($"Created: {definition.Name} ({definition.StationId})");
Console.WriteLine($"Categories: {definition.GetCategoriesDisplay()}");
// Output: Created: Anvil (anvil)
// Output: Categories: Weapon, Tool, Material
```

### Creating Station Instances

```csharp
// Create a station instance from definition
var station = definition.CreateInstance();
Console.WriteLine($"{station.Name} - {station.GetStatusIndicator()}");
// Output: Anvil - [Available]

// Create with custom description
var customStation = definition.CreateInstance(
    "An ancient anvil, scarred by centuries of legendary smithing.");
Console.WriteLine(customStation.Description);
// Output: An ancient anvil, scarred by centuries of legendary smithing.
```

### Managing Station State

```csharp
// Check availability
if (station.IsAvailable)
{
    Console.WriteLine(station.GetInteractionPrompt());
    // Output: Type 'craft <recipe>' to craft at this Anvil.

    // Mark as in use during crafting
    station.SetInUse();
    Console.WriteLine(station.GetStatusDescription());
    // Output: The station is currently in use.
}

// Restore availability after crafting
station.SetAvailable();
Console.WriteLine(station.ToString());
// Output: Anvil [Available]
```

### Using the Provider

```csharp
// Get a specific station
var anvil = stationProvider.GetStation("anvil");
if (anvil is not null)
{
    Console.WriteLine($"Found: {anvil.Name}, Skill: {anvil.CraftingSkillId}");
    // Output: Found: Anvil, Skill: smithing
}

// Get all stations for a category
var weaponStations = stationProvider.GetStationsForCategory(RecipeCategory.Weapon);
Console.WriteLine($"Weapon stations: {string.Join(", ", weaponStations.Select(s => s.Name))}");
// Output: Weapon stations: Anvil, Enchanting Altar

// Get stations by skill
var smithingStations = stationProvider.GetStationsBySkill("smithing");
foreach (var station in smithingStations)
{
    Console.WriteLine($"- {station.Name}: {station.GetCategoriesDisplay()}");
}

// Check if station exists (case-insensitive)
if (stationProvider.Exists("ANVIL"))
{
    Console.WriteLine("Anvil is available!");
}

// Get total station count
Console.WriteLine($"Total stations: {stationProvider.GetStationCount()}");
// Output: Total stations: 5
```

### Checking Recipe Compatibility

```csharp
// Get recipe and check if station supports it
var recipe = recipeProvider.GetRecipe("iron-sword");
if (recipe is not null && anvil.CanCraftRecipe(recipe))
{
    Console.WriteLine($"'{recipe.Name}' can be crafted at the {anvil.Name}");
}

// Check category support directly
if (anvil.SupportsCategory(RecipeCategory.Weapon))
{
    Console.WriteLine($"{anvil.Name} supports weapon crafting");
}
```

---

## Definition-Instance Pattern

```
┌─────────────────────────────────────────────────────────────────────┐
│                  CRAFTING STATION ARCHITECTURE                       │
└─────────────────────────────────────────────────────────────────────┘

     Configuration                        Domain Layer
     ─────────────                        ────────────

   crafting-stations.json        ┌─────────────────────────────┐
   ┌─────────────────┐           │  CraftingStationDefinition  │
   │ {                │           │        (Immutable)          │
   │   "id": "anvil", │  ─────▶   ├─────────────────────────────┤
   │   "name": ...,   │           │ + StationId: string         │
   │   "categories":..│           │ + Name: string              │
   │ }                │           │ + SupportedCategories       │
   └─────────────────┘           │ + CraftingSkillId: string   │
                                  └──────────────┬──────────────┘
                                                 │
                                                 │ CreateInstance()
                                                 ▼
                                  ┌─────────────────────────────┐
                                  │      CraftingStation        │
                                  │    (Stateful Instance)      │
                                  ├─────────────────────────────┤
                                  │ + DefinitionId: string      │
                                  │ + IsAvailable: bool         │
                                  │ + LastUsedAt: DateTime?     │
                                  └─────────────────────────────┘
```

---

## v0.11.x Progress

| Version | Feature | Status |
|---------|---------|--------|
| v0.11.0a | Resource Definitions | ✅ Complete |
| v0.11.0b | Harvestable Features | ✅ Complete |
| v0.11.0c | Gathering Service | ✅ Complete |
| v0.11.1a | Recipe Definitions | ✅ Complete |
| v0.11.1b | Recipe Book | ✅ Complete |
| v0.11.1c | Recipe Discovery | ✅ Complete |
| v0.11.2a | Crafting Stations | ✅ Complete |
| v0.11.2b | Crafting Service | Pending |
| v0.11.2c | Quality System | Pending |

---

## Dependencies

### Required From Prior Versions

| Version | Dependency | Usage |
|---------|------------|-------|
| v0.11.1a | RecipeDefinition | Recipe category validation |
| v0.11.1a | RecipeCategory | Station category support |
| v0.0.x | IEntity | Entity interface |
| v0.0.x | RoomFeatureType | Feature type enum |

### Provides To Future Versions

| Version | Feature | Usage |
|---------|---------|-------|
| v0.11.2b | CraftingStation | Station presence check in rooms |
| v0.11.2b | CraftingStationDefinition | Skill lookup for crafting checks |
| v0.11.2b | ICraftingStationProvider | Station queries during crafting |

---

## Key Design Decisions

1. **Definition-Instance Pattern** - Immutable definitions create stateful instances
2. **Factory Methods** - Private constructors with static Create() methods
3. **Case-Insensitive Lookups** - Station IDs normalized to lowercase
4. **IOptions Pattern** - Configuration binding via Microsoft.Extensions.Options
5. **Thread-Safe Loading** - Lazy initialization with double-checked locking
6. **Multi-Index Provider** - Efficient lookups by category and skill
7. **Category-Based Filtering** - Stations support specific recipe categories
8. **Skill Linkage** - Each station links to a crafting skill for dice checks

---

## Logging Strategy

| Level | Component | When |
|-------|-----------|------|
| Information | CraftingStationProvider | Configuration loaded with station count |
| Debug | CraftingStationProvider | Station lookup operations |
| Debug | CraftingStationProvider | Category/skill index building |
| Warning | CraftingStationProvider | Invalid station configuration skipped |
| Warning | CraftingStationProvider | Duplicate station ID encountered |
| Warning | CraftingStationProvider | Unknown recipe category in config |

---

## Configuration Schema

```json
{
  "$schema": "./schemas/crafting-stations.schema.json",
  "stations": [
    {
      "id": "anvil",
      "name": "Anvil",
      "description": "A sturdy iron anvil for smithing metal items.",
      "supportedCategories": ["Weapon", "Tool", "Material"],
      "craftingSkill": "smithing",
      "icon": "icons/stations/anvil.png"
    }
  ]
}
```

### Schema Validation Rules

- `id`: Required, 2-64 chars, kebab-case pattern `^[a-z][a-z0-9-]*$`
- `name`: Required, 1-100 chars
- `description`: Required, 10-500 chars
- `supportedCategories`: Required, at least 1 item, valid category names
- `craftingSkill`: Required, 2-64 chars, kebab-case pattern
- `icon`: Optional, max 256 chars

---

## Notes

- Station definitions are loaded once at startup and cached
- Station IDs are case-insensitive for all lookups
- Each station must support at least one recipe category
- Station availability state is per-instance, not shared
- LastUsedAt is updated when SetInUse() is called
- FeatureType is always CraftingStation for filtering
- InteractionVerb is always "use" for command integration
- Custom descriptions allow room-specific flavor text
- Provider returns empty lists (not null) for no-match queries
