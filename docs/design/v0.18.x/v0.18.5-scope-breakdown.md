# v0.18.5 Resource Integration - Scope Breakdown

**Version:** 0.18.5
**Theme:** Trauma Economy Integration
**Prerequisites:** v0.18.0-4 Complete (All Trauma Economy Components)
**Total Estimated Tests:** ~20 new tests

---

## Executive Summary

v0.18.5 implements the **Trauma Economy Integration** — the coordination layer that manages interactions between all trauma economy components (Stress, Corruption, CPS, Trauma, and Specialization Resources). This version creates the unified `TraumaEconomyState` and `ITraumaEconomyService` that orchestrates cross-system effects.

The work is divided into **5 sub-phases**:

| Phase    | Name                           | Focus                          | Est. Tests |
| -------- | ------------------------------ | ------------------------------ | ---------- |
| v0.18.5a | TraumaEconomyState             | Unified state aggregation      | ~4         |
| v0.18.5b | Damage Integration             | Unified TakeDamage handling    | ~5         |
| v0.18.5c | Rest Integration               | Unified rest mechanics         | ~4         |
| v0.18.5d | Turn-Based Integration         | Per-turn effects orchestration | ~4         |
| v0.18.5e | ITraumaEconomyService & Config | Unified service, JSON config   | ~3         |

---

## Feature Analysis & Categorization

### From trauma-economy.md - Unified State

| Feature                   | Complexity | Dependencies       | Assigned Phase |
| ------------------------- | ---------- | ------------------ | -------------- |
| TraumaEconomyState Entity | High       | All v0.18.0-4      | **v0.18.5a**   |
| TraumaEconomySnapshot VO  | Medium     | TraumaEconomyState | **v0.18.5a**   |

### From trauma-economy.md - Integration Points

| Feature                    | Complexity | Dependencies            | Assigned Phase |
| -------------------------- | ---------- | ----------------------- | -------------- |
| DamageIntegrationResult VO | Medium     | All damage sources      | **v0.18.5b**   |
| UnifiedDamageHandler       | High       | DamageIntegrationResult | **v0.18.5b**   |
| RestIntegrationResult VO   | Medium     | All rest mechanics      | **v0.18.5c**   |
| UnifiedRestHandler         | High       | RestIntegrationResult   | **v0.18.5c**   |
| TurnIntegrationResult VO   | Medium     | All per-turn effects    | **v0.18.5d**   |
| UnifiedTurnHandler         | High       | TurnIntegrationResult   | **v0.18.5d**   |

### From trauma-economy.md - Service Layer

| Feature               | Complexity | Dependencies          | Assigned Phase |
| --------------------- | ---------- | --------------------- | -------------- |
| ITraumaEconomyService | High       | All VOs               | **v0.18.5e**   |
| TraumaEconomyService  | Very High  | ITraumaEconomyService | **v0.18.5e**   |
| trauma-economy.json   | Medium     | None                  | **v0.18.5e**   |

---

## Phase Definitions

---

## v0.18.5a: TraumaEconomyState

[v0.18.5a Design Specification](v0.18.5a-design-specification.md)

### Overview

Creates the unified state object that aggregates all trauma economy components into a single queryable entity, enabling cross-system effect calculations.

### Scope

**In Scope:**

- `TraumaEconomyState` entity (aggregates all states)
- `TraumaEconomySnapshot` value object (point-in-time capture)
- Computed cross-system properties

**Out of Scope:**

- Integration handlers (v0.18.5b-d)
- Service implementation (v0.18.5e)

### Key Deliverables

| Type                 | Count | Details               |
| -------------------- | ----- | --------------------- |
| Domain Entities      | 1     | TraumaEconomyState    |
| Domain Value Objects | 1     | TraumaEconomySnapshot |
| Unit Tests           | ~4    |                       |

### Data Model Changes

```
NEW: TraumaEconomyState (Entity)
├── CharacterId: Guid
├── StressState: StressState
├── CorruptionState: CorruptionState
├── CpsState: CpsState
├── Traumas: IReadOnlyList<CharacterTrauma>
├── SpecializationResource: object? (RageState | MomentumState | CoherenceState)
├── SpecializationType: string? (e.g., "rage", "momentum", "coherence")
│
│ // Computed Cross-System Properties
├── EffectiveMaxHp: int (base - corruption penalty)
├── EffectiveMaxAp: int (base - corruption penalty)
├── EffectiveResolve: int (base - corruption dice penalty)
├── TotalDefensePenalty: int (from stress thresholds)
├── TotalSkillPenalty: int (from stress + CPS)
├── IsCriticalState: bool (any system at 80+)
├── IsTerminalState: bool (any system at 100)
├── ActiveWarnings: IReadOnlyList<string>
└── ActiveTraumaEffects: IReadOnlyList<TraumaEffect>

NEW: TraumaEconomySnapshot (Value Object)
├── CharacterId: Guid
├── CapturedAt: DateTime
├── Stress: int
├── StressThreshold: StressThreshold
├── Corruption: int
├── CorruptionThreshold: CorruptionThreshold
├── CpsStage: CpsStage
├── TraumaCount: int
├── TraumaIds: IReadOnlyList<string>
├── SpecializationType: string?
├── SpecializationValue: int?
├── SpecializationThreshold: string?
└── IsValid(): bool
```

### Cross-System Calculations

| Calculation           | Formula                                   | Source Systems |
| --------------------- | ----------------------------------------- | -------------- |
| Effective Max HP      | BaseHP × (1 - CorruptionPenalty%)         | Corruption     |
| Effective Max AP      | BaseAP × (1 - CorruptionPenalty%)         | Corruption     |
| Effective Resolve     | BaseResolve - CorruptionDicePenalty       | Corruption     |
| Total Defense Penalty | StressDefensePenalty                      | Stress         |
| Total Skill Penalty   | StressSkillPenalty + CpsLogicDisadvantage | Stress + CPS   |
| Is Critical           | Any(Stress, Corruption) >= 80             | All            |
| Is Terminal           | Any(Stress, Corruption) >= 100            | All            |

### Acceptance Criteria

- [ ] TraumaEconomyState aggregates all component states
- [ ] EffectiveMaxHp correctly applies corruption penalty
- [ ] TotalDefensePenalty combines stress thresholds
- [ ] IsCriticalState triggers at 80+ for any system
- [ ] IsTerminalState triggers at 100 for any system
- [ ] TraumaEconomySnapshot captures point-in-time state
- [ ] ~4 unit tests pass

---

## v0.18.5b: Damage Integration

[v0.18.5b Design Specification](v0.18.5b-design-specification.md)

### Overview

Implements the unified damage handler that coordinates damage effects across all trauma economy systems.

### Scope

**In Scope:**

- `DamageIntegrationResult` record
- `UnifiedDamageHandler` service
- Damage → Stress relationship
- Damage → Rage generation (Berserker)
- Damage → Momentum preservation/decay (Storm Blade)

**Out of Scope:**

- Rest mechanics (v0.18.5c)
- Turn-based effects (v0.18.5d)

### Key Deliverables

| Type                 | Count | Details                 |
| -------------------- | ----- | ----------------------- |
| Domain Value Objects | 1     | DamageIntegrationResult |
| Application Services | 1     | UnifiedDamageHandler    |
| Unit Tests           | ~5    |                         |

### Data Model Changes

```
NEW: DamageIntegrationResult (Record)
├── DamageDealt: int
├── DamageAfterSoak: int
├── SoakApplied: int
├── StressGained: int
├── StressSource: StressSource?
├── CorruptionGained: int?
├── CorruptionSource: CorruptionSource?
├── RageGained: int? (Berserker)
├── MomentumLost: int? (Storm Blade, if critical hit)
├── CoherenceLost: int? (Arcanist, if interrupted)
├── TraumaCheckTriggered: bool (if near-death)
├── ThresholdsCrossed: IReadOnlyList<string>
└── TransitionMessages: IReadOnlyList<string>
```

### Damage Integration Flow

```
             ┌──────────────────────────────────────┐
             │           Incoming Damage            │
             └─────────────────┬────────────────────┘
                               │
                               ▼
             ┌──────────────────────────────────────┐
             │         Calculate Soak               │
             │   (Base + Rage Bonus if Berserker)   │
             └─────────────────┬────────────────────┘
                               │
                               ▼
             ┌──────────────────────────────────────┐
             │         Apply Final Damage           │
             └─────────────────┬────────────────────┘
                               │
          ┌────────────────────┼────────────────────┐
          │                    │                    │
          ▼                    ▼                    ▼
   ┌─────────────┐     ┌─────────────┐     ┌─────────────┐
   │ Stress Gain │     │ Rage Gain   │     │ Momentum    │
   │ (if any)    │     │ (Berserker) │     │ Decay (crit)│
   └──────┬──────┘     └─────────────┘     └─────────────┘
          │
          ▼
   ┌─────────────┐
   │ CPS Update  │
   └──────┬──────┘
          │
          ▼
   ┌─────────────────────────────────────────────────┐
   │ Check for Trauma Trigger (near-death, ally death)│
   └──────────────────────────────────────────────────┘
```

### Damage → Stress Relationship

| Condition             | Stress Gain              |
| --------------------- | ------------------------ |
| Took any damage       | floor(damage / 10)       |
| Critical hit received | +5 bonus stress          |
| Reduced to <25% HP    | +10 stress               |
| Ally dropped to 0 HP  | +15 stress for witnesses |

### Acceptance Criteria

- [ ] Damage correctly triggers stress gain
- [ ] Berserker gains rage from damage taken
- [ ] Storm Blade loses momentum on critical hits
- [ ] Near-death triggers trauma check
- [ ] Ally death triggers stress for party
- [ ] SoakApplied includes rage bonus
- [ ] ~5 unit tests pass

---

## v0.18.5c: Rest Integration

[v0.18.5c Design Specification](v0.18.5c-design-specification.md)

### Overview

Implements the unified rest handler that coordinates recovery across all trauma economy systems.

### Scope

**In Scope:**

- `RestIntegrationResult` record
- `UnifiedRestHandler` service
- Short Rest effects
- Long Rest effects
- Sanctuary Rest effects
- Rage party stress reduction

**Out of Scope:**

- Damage integration (v0.18.5b)
- Turn-based effects (v0.18.5d)

### Key Deliverables

| Type                 | Count | Details               |
| -------------------- | ----- | --------------------- |
| Domain Value Objects | 1     | RestIntegrationResult |
| Application Services | 1     | UnifiedRestHandler    |
| Unit Tests           | ~4    |                       |

### Data Model Changes

```
NEW: RestIntegrationResult (Record)
├── RestType: RestType (Short, Long, Sanctuary)
├── StressRecovered: int
├── StressRecoveryFormula: string
├── CorruptionRecovered: int (usually 0)
├── CpsStageChanged: bool
├── NewCpsStage: CpsStage?
├── TraumaChecksPerformed: int
├── TraumasAcquired: IReadOnlyList<string>?
├── RagePartyBonus: int? (if FrenzyBeyondReason Berserker present)
├── CoherenceRestored: int? (Arcanist meditation)
├── MomentumReset: bool (always resets on rest)
└── RecoveryMessages: IReadOnlyList<string>
```

### Rest Type Effects

| Rest Type  | Stress Recovery     | Special Effects              |
| ---------- | ------------------- | ---------------------------- |
| Short Rest | 5d4 + WILL modifier | Rage resets, Momentum clears |
| Long Rest  | 100% recovery to 0  | CPS Stage can improve        |
| Sanctuary  | 100% + bonus        | Additional CPS recovery      |

### Additional Rest Effects

| System     | Short Rest      | Long Rest                |
| ---------- | --------------- | ------------------------ |
| Stress     | 5d4 + WILL      | Full recovery            |
| Corruption | None            | None                     |
| CPS        | No stage change | May improve one stage    |
| Trauma     | Trigger checks  | Trigger checks           |
| Rage       | Reset to 0      | Reset to 0               |
| Momentum   | Reset to 0      | Reset to 0               |
| Coherence  | +20 if meditate | Restore to 50 (Balanced) |

### Party Rage Bonus

If party contains Berserker in FrenzyBeyondReason:

- All other party members gain -10 stress on next rest
- Berserker's rage inspires/terrifies party into relative calm

```csharp
if (partyHasBerserkerInFrenzy)
{
    foreach (var member in party.Exclude(berserker))
    {
        member.ApplyBonusStressRecovery(10);
    }
}
```

### Acceptance Criteria

- [ ] Short rest uses 5d4 + WILL formula
- [ ] Long rest fully recovers stress
- [ ] CPS stage can improve on long rest
- [ ] Rage/Momentum reset on any rest
- [ ] Coherence restores to 50 on long rest
- [ ] Berserker party bonus applies correctly
- [ ] ~4 unit tests pass

---

## v0.18.5d: Turn-Based Integration

[v0.18.5d Design Specification](v0.18.5d-design-specification.md)

### Overview

Implements the unified turn handler that coordinates per-turn effects across all trauma economy systems.

### Scope

**In Scope:**

- `TurnIntegrationResult` record
- `UnifiedTurnHandler` service
- Combat turn start/end effects
- Resource decay (Rage without combat, Momentum idle)
- Apotheosis stress cost

**Out of Scope:**

- Damage integration (v0.18.5b)
- Rest integration (v0.18.5c)

### Key Deliverables

| Type                 | Count | Details               |
| -------------------- | ----- | --------------------- |
| Domain Value Objects | 1     | TurnIntegrationResult |
| Application Services | 1     | UnifiedTurnHandler    |
| Unit Tests           | ~4    |                       |

### Data Model Changes

```
NEW: TurnIntegrationResult (Record)
├── TurnNumber: int
├── IsInCombat: bool
├── StressChanges: int (net change)
├── RageDecay: int? (Berserker out of combat)
├── MomentumDecay: int? (Storm Blade idle)
├── ApotheosisStressCost: int? (Arcanist in Apotheosis)
├── ApotheosisEnded: bool
├── CpsEffectsApplied: IReadOnlyList<string>?
├── EnvironmentalStress: int?
├── TraumaTriggersChecked: IReadOnlyList<string>
└── TurnMessages: IReadOnlyList<string>
```

### Turn Start Effects

| System     | Combat Start       | Non-Combat Start |
| ---------- | ------------------ | ---------------- |
| Stress     | No change          | No change        |
| Rage       | No decay           | -10 per turn     |
| Momentum   | Check idle decay   | -15 per turn     |
| Coherence  | Check cascade risk | Can meditate     |
| Apotheosis | -10 stress         | -10 stress       |

### Turn End Effects

| System      | Combat End           | Non-Combat End     |
| ----------- | -------------------- | ------------------ |
| Stress      | Threshold check      | Threshold check    |
| CPS         | Effect application   | Effect application |
| Panic Table | Roll if Ruin-Madness | Roll if triggered  |
| Trauma      | Check triggers       | Check triggers     |

### Apotheosis Turn Cost

```csharp
// Every turn while in Apotheosis
if (coherenceState.InApotheosis)
{
    var stressResult = stressService.AddStress(characterId, 10, StressSource.ApotheosisStrain);

    // Auto-exit if stress reaches 100
    if (stressResult.NewStress >= 100)
    {
        coherenceService.ForceExitApotheosis(characterId, "Stress overflow");
    }
}
```

### Acceptance Criteria

- [ ] Rage decays 10/turn outside combat
- [ ] Momentum decays 15/turn when idle
- [ ] Apotheosis costs 10 stress per turn
- [ ] Apotheosis auto-exits at 100 stress
- [ ] Panic Table rolls at Ruin-Madness
- [ ] Environmental stress accumulates
- [ ] ~4 unit tests pass

---

## v0.18.5e: ITraumaEconomyService & Config

[v0.18.5e Design Specification](v0.18.5e-design-specification.md)

### Overview

Defines the unified service contract and configuration for the trauma economy orchestration layer.

### Scope

**In Scope:**

- `ITraumaEconomyService` interface
- `TraumaEconomyService` implementation
- `config/trauma-economy.json` configuration file
- DI registration for all trauma economy services

**Out of Scope:**

- Additional integration points (future versions)

### Key Deliverables

| Type                   | Count | Details               |
| ---------------------- | ----- | --------------------- |
| Application Interfaces | 1     | ITraumaEconomyService |
| Application Services   | 1     | TraumaEconomyService  |
| Configuration Files    | 1     | trauma-economy.json   |
| Unit Tests             | ~3    |                       |

### Interface Definition

```csharp
public interface ITraumaEconomyService
{
    // State Access
    TraumaEconomyState GetState(Guid characterId);
    TraumaEconomySnapshot CreateSnapshot(Guid characterId);

    // Unified Operations
    DamageIntegrationResult ProcessDamage(Guid characterId, int damage, DamageContext context);
    RestIntegrationResult ProcessRest(Guid characterId, RestType restType, PartyContext? partyContext);
    TurnIntegrationResult ProcessTurnStart(Guid characterId, bool isInCombat);
    TurnIntegrationResult ProcessTurnEnd(Guid characterId, bool isInCombat);

    // Query Methods
    int GetEffectiveMaxHp(Guid characterId);
    int GetEffectiveMaxAp(Guid characterId);
    int GetTotalDefensePenalty(Guid characterId);
    int GetTotalSkillPenalty(Guid characterId);
    bool IsInCriticalState(Guid characterId);
    bool IsInTerminalState(Guid characterId);
    IReadOnlyList<string> GetActiveWarnings(Guid characterId);
}
```

### trauma-economy.json Structure

```json
{
    "version": "1.0",
    "integration": {
        "damageToStress": {
            "enabled": true,
            "formula": "floor(damage / 10)",
            "criticalBonus": 5,
            "nearDeathBonus": 10,
            "nearDeathThreshold": 0.25,
            "allyDownStress": 15
        },
        "restRecovery": {
            "shortRest": {
                "stressFormula": "5d4 + will",
                "rageReset": true,
                "momentumReset": true,
                "coherenceGain": 0
            },
            "longRest": {
                "stressRecovery": "full",
                "rageReset": true,
                "momentumReset": true,
                "coherenceReset": 50,
                "cpsCanImprove": true
            },
            "sanctuary": {
                "stressRecovery": "full",
                "cpsImprovementBonus": 1
            }
        },
        "turnEffects": {
            "rageDecayOutOfCombat": 10,
            "momentumDecayIdle": 15,
            "apotheosisStressCost": 10,
            "apotheosisForceExitAt": 100
        },
        "thresholds": {
            "criticalWarning": 80,
            "terminalTrigger": 100
        }
    },
    "warningMessages": {
        "stressHigh": "Your mind strains under the weight of reality.",
        "corruptionHigh": "The Blight's touch grows stronger.",
        "cpsDangerous": "Reality's edges begin to blur.",
        "multipleSystemsCritical": "Your body and mind approach their limits."
    }
}
```

### Service Dependencies

```csharp
public class TraumaEconomyService : ITraumaEconomyService
{
    private readonly IStressService _stressService;
    private readonly ICorruptionService _corruptionService;
    private readonly ICpsService _cpsService;
    private readonly ITraumaService _traumaService;
    private readonly IRageService? _rageService;
    private readonly IMomentumService? _momentumService;
    private readonly ICoherenceService? _coherenceService;
    private readonly ISpecializationProvider _specializationProvider;
    private readonly IDiceService _diceService;
    private readonly ILogger<TraumaEconomyService> _logger;

    // Constructor with DI...
}
```

### Acceptance Criteria

- [ ] ITraumaEconomyService defines all orchestration methods
- [ ] TraumaEconomyService coordinates all sub-services
- [ ] GetState returns fully populated TraumaEconomyState
- [ ] ProcessDamage delegates to all relevant handlers
- [ ] ProcessRest handles all recovery mechanics
- [ ] ProcessTurnStart/End handles all per-turn effects
- [ ] Configuration loads correctly
- [ ] ~3 unit tests pass

---

## Dependencies & Prerequisites

```
v0.18.0 (Psychic Stress) ───┐
                            │
v0.18.1 (Runic Blight) ─────┼── ALL REQUIRED
                            │
v0.18.2 (CPS) ──────────────┤
                            │
v0.18.3 (Trauma) ───────────┤
                            │
v0.18.4 (Specialization) ───┘
                    │
                    ▼
v0.18.5 (Resource Integration)
    │
    ├── v0.18.5a: TraumaEconomyState ────────────────┐
    │       Dependencies: All v0.18.0-4               │
    │                                                 │
    ├── v0.18.5b: Damage Integration ────────────────┤
    │       Dependencies: v0.18.5a                   │
    │                                                 │
    ├── v0.18.5c: Rest Integration ──────────────────┤
    │       Dependencies: v0.18.5a                   │
    │                                                 │
    ├── v0.18.5d: Turn-Based Integration ────────────┤
    │       Dependencies: v0.18.5a                   │
    │                                                 │
    └── v0.18.5e: ITraumaEconomyService & Config ────┘
            Dependencies: v0.18.5a-d
```

---

## Estimated Effort Summary

| Phase     | New Files | Modified Files | Est. Tests | Complexity |
| --------- | --------- | -------------- | ---------- | ---------- |
| v0.18.5a  | 2         | 0              | ~4         | High       |
| v0.18.5b  | 2         | 0              | ~5         | High       |
| v0.18.5c  | 2         | 0              | ~4         | High       |
| v0.18.5d  | 2         | 0              | ~4         | High       |
| v0.18.5e  | 3         | 1              | ~3         | Very High  |
| **Total** | **11**    | **1**          | **~20**    |            |

---

## Risk Assessment

| Risk                               | Impact | Probability | Mitigation                      |
| ---------------------------------- | ------ | ----------- | ------------------------------- |
| Cross-system interaction bugs      | High   | Medium      | Comprehensive integration tests |
| Performance with multiple services | Medium | Low         | Lazy loading, caching           |
| Configuration complexity           | Low    | Medium      | Clear schema validation         |
| Race conditions in turn processing | Medium | Low         | Single-threaded turn execution  |

---

## Design Decisions (Confirmed)

### Integration Philosophy

| Decision                 | Value           | Notes                          |
| ------------------------ | --------------- | ------------------------------ |
| **Orchestration Model**  | Unified service | Single entry point for all ops |
| **State Aggregation**    | Composed entity | TraumaEconomyState holds all   |
| **Cross-System Effects** | Calculated      | Not stored, computed on demand |

### Processing Order

| Decision         | Value                         | Notes                 |
| ---------------- | ----------------------------- | --------------------- |
| **Damage Order** | Soak → Stress → Spec Resource | Consistent processing |
| **Rest Order**   | Spec Reset → Stress → CPS     | Resources reset first |
| **Turn Order**   | Start → Actions → End         | Clear lifecycle       |

### Party Integration

| Decision              | Value              | Notes                        |
| --------------------- | ------------------ | ---------------------------- |
| **Rage Party Bonus**  | -10 stress on rest | FrenzyBeyondReason benefit   |
| **Ally Death Stress** | +15 stress         | Witnessing party member fall |

---

## Out of Scope

| Feature                        | Deferred To | Reason              |
| ------------------------------ | ----------- | ------------------- |
| Multi-party coordination       | v0.23.x     | Party system        |
| Trauma economy UI dashboard    | v0.19.x     | UI version          |
| Save/Load trauma economy state | v0.22.x     | Persistence version |
| Network sync for multiplayer   | v0.25.x     | Multiplayer system  |

---

## Next Steps

1. **Review & Approve** - Confirm scope breakdown with stakeholders
2. **v0.18.5a Design Spec** - Create detailed design specification for TraumaEconomyState
3. **Implement v0.18.5a** - Build unified state aggregation
4. **Repeat for v0.18.5b through v0.18.5e**
5. **Integration Testing** - Comprehensive cross-system testing

---

_This scope breakdown provides a structured approach to implementing v0.18.5 Resource Integration. This version ties together all previous trauma economy components into a cohesive system._

---

## Changelog

| Version | Date       | Changes                        |
| ------- | ---------- | ------------------------------ |
| 1.0     | 2026-01-17 | Initial scope breakdown        |
| 1.1     | 2026-01-27 | Restructured to match template |
