> **Archived** - This changelog has been consolidated. See the complete version at [v0.3.6](../v0.3.x/v0.3.6.md).

# Changelog: v0.3.6b - The Timeline (Initiative & Log)

**Release Date:** 2025-12-22

---

## Summary

Version 0.3.6b replaces the vertical turn order table with a horizontal initiative timeline and introduces rich-text combat log formatting with damage type coloring. This release enhances combat visibility by showing projected turns across the current round and next round preview in an 8-slot horizontal window, while the new `CombatLogFormatter` service centralizes all combat event formatting with Spectre.Console markup, providing visual distinction for 8 damage types and critical hits.

This release touches the **Core Layer** (ViewModels, Models), **Engine Layer** (Services), **Terminal Layer** (Rendering), and **Test Layer** with comprehensive test coverage. Key patterns introduced include static utility classes for stateless formatting operations and record types for immutable timeline projections.

---

## New Files Created

### Core Layer

| File | Purpose |
|------|---------|
| `RuneAndRust.Core/ViewModels/TimelineEntryView.cs` | Immutable record representing a single entry in the initiative timeline with combatant ID, name, player status, active marker, initiative value, round number, and health indicator |

### Engine Layer

| File | Purpose |
|------|---------|
| `RuneAndRust.Engine/Services/CombatLogFormatter.cs` | Static formatter class providing rich Spectre.Console markup for combat events including hit/miss messages, status effects, deaths, and combat flow with damage type coloring |

### Terminal Layer

| File | Purpose |
|------|---------|
| `RuneAndRust.Terminal/Rendering/TimelineRenderer.cs` | Static renderer class generating horizontal initiative timeline panels with round markers, combatant names, health indicators, and initiative values in a grid layout |

### Test Layer

| File | Purpose |
|------|---------|
| `RuneAndRust.Tests/Engine/TimelineProjectionTests.cs` | 10 unit tests validating timeline projection generation, window sizing, round transitions, dead combatant filtering, and health indicator mapping |
| `RuneAndRust.Tests/Engine/CombatLogFormatterTests.cs` | 23 unit tests validating damage type color mapping, message formatting, markup escaping, and critical hit display |
| `RuneAndRust.Tests/Terminal/TimelineRendererTests.cs` | 15 unit tests validating panel rendering, entry formatting, health status icons, name truncation, and markup escaping |

---

## Files Modified

| File | Change |
|------|--------|
| `RuneAndRust.Core/Models/Combat/AttackResult.cs` | Added `DamageType` property with default value `DamageType.Physical` to track damage type for combat log coloring |
| `RuneAndRust.Core/ViewModels/CombatViewModel.cs` | Added `TimelineProjection` property of type `List<TimelineEntryView>?` to transport timeline data to UI layer |
| `RuneAndRust.Engine/Services/CombatService.cs` | Added `GetTimelineProjection(int windowSize = 8)` method and `MapToTimelineEntry()` helper to generate timeline projections with current round remaining turns plus next round preview |
| `RuneAndRust.Terminal/Services/CombatScreenRenderer.cs` | Replaced `RenderTurnOrder()` call with `TimelineRenderer.Render()` to display horizontal timeline instead of vertical turn order table |
| `RuneAndRust.Terminal/Program.cs` | Updated version string from v0.3.6a to v0.3.6b |

---

## Code Implementation Details

### TimelineEntryView (Core/ViewModels)

**Record Definition:**
```csharp
public record TimelineEntryView(
    Guid CombatantId,
    string Name,
    bool IsPlayer,
    bool IsActive,
    int Initiative,
    int RoundNumber,
    string HealthIndicator
);
```

**Properties:**
- `CombatantId` - Unique identifier for combatant lookup
- `Name` - Display name for timeline rendering
- `IsPlayer` - Determines color coding (cyan for players, red for enemies)
- `IsActive` - Marks the currently acting combatant with `►` indicator
- `Initiative` - Numerical value displayed below combatant name
- `RoundNumber` - Used to show round transition markers (R1, R2, etc.)
- `HealthIndicator` - One of "healthy", "wounded", "critical", or "dead" for status icons

**Immutability:** Record type ensures timeline snapshots cannot be mutated after creation.

---

### CombatLogFormatter (Engine/Services)

**Class Signature:**
```csharp
public static class CombatLogFormatter
```

**Stateless Design:** Static class with no DI registration required. All methods are pure functions.

**Key Methods:**

**Damage Type Color Mapping:**
```csharp
public static string GetDamageColor(DamageType type)
```
- Returns Spectre.Console color names for damage visualization
- Switch expression with exhaustive pattern matching
- Default case returns "white" for unknown types

**Color Mappings:**
| Damage Type | Color | Spectre Name |
|-------------|-------|--------------|
| Physical | White | `"white"` |
| Fire | Orange | `"orange1"` |
| Ice | Cyan | `"cyan1"` |
| Lightning | Yellow | `"yellow"` |
| Poison | Green | `"green"` |
| Acid | Lime | `"lime"` |
| Psychic | Magenta | `"magenta"` |
| Blight | Maroon | `"maroon"` |

**Attack Message Formatting:**
```csharp
public static string FormatHitMessage(
    string attackerName,
    string targetName,
    int damage,
    DamageType damageType,
    bool isCritical = false)
```

**Behaviors:**
- Prepends `[bold yellow]CRITICAL![/]` prefix for critical hits
- Omits damage type label for Physical damage (reduces noise)
- Includes damage type name for elemental damage ("15 Fire", "12 Ice")
- Escapes special characters in combatant names using `EscapeMarkup()` helper
- Attacker names colored cyan, target names colored red

**Miss Message:**
```csharp
public static string FormatMissMessage(string attackerName, string targetName)
```
- Returns grey "misses!" text to de-emphasize failed attacks

**Glancing Blow:**
```csharp
public static string FormatGlancingMessage(
    string attackerName,
    string targetName,
    int damage,
    DamageType damageType)
```
- Uses grey "glances" text to differentiate from solid hits
- Includes reduced damage with appropriate coloring

**Status Effects:**
```csharp
public static string FormatStatusApplied(string targetName, string effectName)
public static string FormatStatusExpired(string targetName, string effectName)
```
- Applied effects use yellow highlighting
- Expired effects use grey to show diminishing importance

**Death Messages:**
```csharp
public static string FormatDeathMessage(string targetName, bool isPlayer)
```
- Player deaths: `[bold red]...has fallen![/]` for dramatic emphasis
- Enemy deaths: `[red]...is [grey]defeated![/]` with subdued styling

**Combat Flow:**
```csharp
public static string FormatRoundStart(int roundNumber)
public static string FormatTurnStart(string combatantName, bool isPlayer)
public static string FormatVictory()
public static string FormatDefeat()
```
- Round starts display separator with bold white styling
- Turn starts use player/enemy color coding (cyan/red)
- Victory shows bold green, defeat shows bold red

**Ability System:**
```csharp
public static string FormatAbilityUse(string casterName, string abilityName)
public static string FormatHealMessage(string targetName, int amount)
```
- Abilities highlighted in yellow
- Healing values displayed in green

**Markup Escaping:**
```csharp
private static string EscapeMarkup(string text)
```
- Replaces `[` with `[[` and `]` with `]]`
- Prevents combatant names containing brackets from breaking Spectre.Console rendering

---

### TimelineRenderer (Terminal/Rendering)

**Class Signature:**
```csharp
public static class TimelineRenderer
```

**Constants:**
```csharp
public const int DefaultWindowSize = 8;
```
- Default 8-slot window shows current round remaining + next round preview

**Main Render Method:**
```csharp
public static Panel Render(List<TimelineEntryView>? projection, int currentRound)
```

**Behaviors:**
- Returns empty panel with "No timeline data" if projection is null or empty
- Creates `Grid` with dynamic column count based on entries (up to 8)
- Each column width set to 10 characters with `NoWrap()` to prevent wrapping
- Grid contains 3 rows:
  1. **Round Markers** - Display "R1", "R2" only when round changes
  2. **Combatant Names** - Active marker, name, health icon
  3. **Initiative Values** - Grey initiative numbers for reference
- Returns panel with yellow "INITIATIVE TIMELINE" header and rounded border

**Round Marker Logic:**
```csharp
private static string[] BuildRoundMarkers(List<TimelineEntryView> entries)
```
- Tracks last round number to detect transitions
- Only displays round marker on first entry of each new round
- Empty string for subsequent entries in same round
- Prevents visual clutter while maintaining round awareness

**Entry Formatting:**
```csharp
public static string FormatTimelineEntry(TimelineEntryView entry)
```

**Behaviors:**
- Color coding: `cyan` for players, `red` for enemies
- Active marker: `[bold yellow]►[/]` for active combatant, space for others
- Health icons:
  - `critical` → `[red]![/]` (exclamation mark)
  - `wounded` → `[yellow]~[/]` (tilde)
  - `dead` → `[grey]✗[/]` (cross mark)
  - `healthy` → No icon
- Name truncation to 8 characters maximum
- Appends `…` (ellipsis) for truncated names
- Total entry width: 1 marker + 8 name chars + 1 health icon = 10 characters

**Name Truncation:**
```csharp
private static string TruncateName(string name, int maxLength)
```
- Substring to `maxLength - 1` if exceeding limit
- Appends Unicode ellipsis character `…`
- Ensures consistent column alignment

**Markup Safety:**
- Uses `Markup.Escape()` to prevent injection attacks from combatant names

---

### CombatService Timeline Methods (Engine/Services)

**Timeline Projection:**
```csharp
public List<TimelineEntryView> GetTimelineProjection(int windowSize = 8)
```

**Algorithm:**
1. Return empty list if `CombatState` is null
2. Collect remaining combatants from current round (skip dead, skip past turns via `TurnIndex`)
3. Add entries until window size reached or current round exhausted
4. If window not full, backfill from next round's full turn order (alive only)
5. Map each combatant to `TimelineEntryView` with appropriate round number
6. Log trace message with projection count

**Entry Mapping:**
```csharp
private static TimelineEntryView MapToTimelineEntry(Combatant c, int roundNumber, Combatant? active)
```

**Health Indicator Logic:**
- `CurrentHp <= 0` → `"dead"`
- `CurrentHp <= MaxHp / 4` → `"critical"` (25% threshold)
- `CurrentHp <= MaxHp / 2` → `"wounded"` (50% threshold)
- Otherwise → `"healthy"`

**Active Detection:**
- `IsActive = (c.Id == active?.Id)` for current round entries
- Next round entries always have `IsActive = false`

**Integration Point:**
```csharp
TimelineProjection: GetTimelineProjection()
```
- Called in `GetCombatViewModel()` to populate view model
- Automatically updates every render cycle to reflect combat state changes

---

### AttackResult DamageType Addition (Core/Models)

**Modified Record:**
```csharp
public record AttackResult(
    AttackOutcome Outcome,
    int NetSuccesses,
    int RawDamage,
    int FinalDamage,
    bool IsHit,
    DamageType DamageType = DamageType.Physical  // Added v0.3.6b
);
```

**Default Value Justification:**
- `DamageType.Physical` is default for backward compatibility
- Existing attack resolution code continues to work without modification
- Elemental damage systems can override explicitly when implemented

---

## Logging Matrix

### CombatService (Timeline System)

| Event | Level | Template |
|-------|-------|----------|
| Timeline projection built | Trace | `"Built timeline projection with {Count} entries"` |

### CombatScreenRenderer

| Event | Level | Template |
|-------|-------|----------|
| Screen rendered | Trace | `"Rendered combat screen"` |

**Note:** `CombatLogFormatter` and `TimelineRenderer` are stateless static classes with no logging. They are pure formatting utilities.

---

## Test Coverage

**Total Tests Added:** 48
**Total Project Tests:** 2,129
**Passed:** 2,129
**Failed:** 0
**Duration:** ~1 second

---

### TimelineProjectionTests (10 tests)

| Test Name | Description |
|-----------|-------------|
| `GetTimelineProjection_NoCombatState_ReturnsEmptyList` | Returns empty list when combat state is null |
| `GetTimelineProjection_CurrentRoundOnly_ReturnsRemainingCombatants` | Returns remaining combatants from current round when within window size |
| `GetTimelineProjection_FillsFromNextRound_WhenNeeded` | Backfills from next round when current round has fewer entries than window size |
| `GetTimelineProjection_ExcludesDeadCombatants` | Filters out combatants with CurrentHp <= 0 from projection |
| `GetTimelineProjection_MarksActiveCorrectly` | Sets IsActive=true only for the current active combatant |
| `GetTimelineProjection_RespectsWindowSize` | Limits projection to specified window size parameter |
| `GetTimelineProjection_NextRoundEntries_NotMarkedActive` | Ensures next round entries have IsActive=false |
| `GetTimelineProjection_CriticalHealth_ReturnsCorrectIndicator` | Returns "critical" health indicator when HP <= 25% |
| `GetTimelineProjection_WoundedHealth_ReturnsCorrectIndicator` | Returns "wounded" health indicator when HP between 25-50% |
| `GetTimelineProjection_HealthyHealth_ReturnsCorrectIndicator` | Returns "healthy" health indicator when HP > 50% |

**Test Setup:**
- Uses Moq to mock 12 service dependencies
- Creates test characters with `CreateTestCharacter()` helper
- Creates test enemies with `CreateTestEnemy()` helper
- Manipulates `TurnIndex` to simulate mid-round scenarios
- Modifies `CurrentHp` to test health thresholds

---

### CombatLogFormatterTests (23 tests)

| Test Name | Description |
|-----------|-------------|
| `GetDamageColor_Physical_ReturnsWhite` | Returns "white" for Physical damage type |
| `GetDamageColor_Fire_ReturnsOrange` | Returns "orange1" for Fire damage type |
| `GetDamageColor_Ice_ReturnsCyan` | Returns "cyan1" for Ice damage type |
| `GetDamageColor_Lightning_ReturnsYellow` | Returns "yellow" for Lightning damage type |
| `GetDamageColor_Poison_ReturnsGreen` | Returns "green" for Poison damage type |
| `GetDamageColor_Acid_ReturnsLime` | Returns "lime" for Acid damage type |
| `GetDamageColor_Psychic_ReturnsMagenta` | Returns "magenta" for Psychic damage type |
| `GetDamageColor_Blight_ReturnsMaroon` | Returns "maroon" for Blight damage type |
| `FormatHitMessage_Physical_NoTypeLabel` | Omits damage type label for Physical damage to reduce noise |
| `FormatHitMessage_Fire_IncludesTypeLabel` | Includes "Fire" label for elemental damage |
| `FormatHitMessage_Critical_AddsCriticalPrefix` | Adds "[bold yellow]CRITICAL![/]" prefix for critical hits |
| `FormatHitMessage_IncludesAttackerName` | Includes attacker name with cyan coloring |
| `FormatHitMessage_IncludesTargetName` | Includes target name with red coloring |
| `FormatHitMessage_EscapesBracketsInNames` | Escapes [ and ] characters to prevent markup injection |
| `FormatMissMessage_IncludesNames` | Includes both attacker and target names with appropriate colors |
| `FormatMissMessage_HasGreyMissIndicator` | Uses grey "misses!" text for de-emphasis |
| `FormatDeathMessage_Player_UsesBoldRed` | Uses bold red "has fallen!" for player deaths |
| `FormatDeathMessage_Enemy_UsesGreyDefeated` | Uses grey "defeated!" for enemy deaths |
| `FormatStatusApplied_IncludesTargetAndEffect` | Includes target name and effect name with yellow highlighting |
| `FormatAbilityUse_IncludesCasterAndAbility` | Includes caster name and ability name with yellow highlighting |
| `FormatHealMessage_ShowsGreenHealing` | Shows healing amount in green with HP label |
| `FormatRoundStart_IncludesRoundNumber` | Includes round number with bold white separator styling |
| `FormatTurnStart_Player_UsesCyan` | Uses cyan for player turn announcements |
| `FormatTurnStart_Enemy_UsesRed` | Uses red for enemy turn announcements |
| `FormatVictory_ShowsBoldGreen` | Uses bold green for victory message |
| `FormatDefeat_ShowsBoldRed` | Uses bold red for defeat message |

**Test Characteristics:**
- No mocking required (static utility class)
- Direct assertion on returned markup strings
- Uses FluentAssertions `Contain()` for markup pattern validation
- Verifies proper escaping with bracket characters `[` and `]`

---

### TimelineRendererTests (15 tests)

| Test Name | Description |
|-----------|-------------|
| `Render_NullProjection_ReturnsPanel` | Returns valid panel when projection is null |
| `Render_EmptyProjection_ReturnsPanel` | Returns valid panel when projection is empty list |
| `Render_WithEntries_ReturnsPanel` | Returns valid panel when projection contains entries |
| `Render_RespectsWindowSize` | Handles projections larger than window size without errors |
| `FormatTimelineEntry_Player_UsesCyan` | Uses cyan color for player combatants |
| `FormatTimelineEntry_Enemy_UsesRed` | Uses red color for enemy combatants |
| `FormatTimelineEntry_Active_ShowsMarker` | Shows "[bold yellow]►[/]" marker for active combatant |
| `FormatTimelineEntry_Inactive_NoMarker` | Shows space character for inactive combatants |
| `FormatTimelineEntry_CriticalHealth_ShowsExclamation` | Shows "[red]![/]" for critical health status |
| `FormatTimelineEntry_WoundedHealth_ShowsTilde` | Shows "[yellow]~[/]" for wounded health status |
| `FormatTimelineEntry_DeadHealth_ShowsCross` | Shows "[grey]✗[/]" for dead health status |
| `FormatTimelineEntry_HealthyHealth_NoIndicator` | Shows no health icon for healthy combatants |
| `FormatTimelineEntry_LongName_Truncates` | Truncates names exceeding 8 characters with ellipsis |
| `FormatTimelineEntry_ShortName_NoTruncation` | Preserves names 8 characters or shorter |
| `FormatTimelineEntry_NameWithBrackets_EscapesMarkup` | Uses `Markup.Escape()` to convert [ to [[ and ] to ]] |

**Test Helpers:**
- `CreateTestProjection()` generates sample timeline entries
- `CreateTestEntry()` creates individual entries with default values
- Direct string assertions on returned markup

---

## DI Registration

**No Changes Required**

Both `CombatLogFormatter` and `TimelineRenderer` are static utility classes and do not require DI registration. They are invoked directly via static method calls:

```csharp
// CombatLogFormatter usage example
var message = CombatLogFormatter.FormatHitMessage(attacker, target, damage, damageType, isCrit);

// TimelineRenderer usage example
var panel = TimelineRenderer.Render(vm.TimelineProjection, vm.RoundNumber);
```

---

## Verification Results

**Build Output:**
```
Build succeeded.
    0 Warning(s)
    0 Error(s)

Time Elapsed 00:00:00.75
```

**Test Output:**
```
Starting test execution, please wait...
A total of 1 test files matched the specified pattern.

Passed!  - Failed:     0, Passed:  2129, Skipped:     0, Total:  2129, Duration: 1 s - RuneAndRust.Tests.dll (net9.0)
```

---

## Directory Structure After Release

```
RuneAndRust/
├── RuneAndRust.Core/
│   ├── Enums/
│   │   ├── DamageType.cs
│   │   └── RowPosition.cs
│   ├── Models/
│   │   └── Combat/
│   │       └── AttackResult.cs [MODIFIED]
│   └── ViewModels/
│       ├── CombatViewModel.cs [MODIFIED]
│       └── TimelineEntryView.cs [NEW]
├── RuneAndRust.Engine/
│   └── Services/
│       ├── CombatLogFormatter.cs [NEW]
│       └── CombatService.cs [MODIFIED]
├── RuneAndRust.Terminal/
│   ├── Rendering/
│   │   ├── CombatGridRenderer.cs
│   │   └── TimelineRenderer.cs [NEW]
│   ├── Services/
│   │   └── CombatScreenRenderer.cs [MODIFIED]
│   └── Program.cs [MODIFIED]
└── RuneAndRust.Tests/
    ├── Engine/
    │   ├── CombatLogFormatterTests.cs [NEW]
    │   └── TimelineProjectionTests.cs [NEW]
    └── Terminal/
        └── TimelineRendererTests.cs [NEW]
```

---

## Running Tests

**Run All Timeline/Formatter Tests:**
```bash
dotnet test --filter "FullyQualifiedName~TimelineProjectionTests"
dotnet test --filter "FullyQualifiedName~CombatLogFormatterTests"
dotnet test --filter "FullyQualifiedName~TimelineRendererTests"
```

**Run Full Test Suite:**
```bash
dotnet test
```

**Run Specific Test:**
```bash
dotnet test --filter "FullyQualifiedName~GetTimelineProjection_FillsFromNextRound_WhenNeeded"
```

---

## Next Steps

Planned work for **v0.3.6c**:

- **Damage Type Integration:** Wire `DamageType` property through attack resolution for elemental weapon damage
- **Elemental Resistance System:** Implement resistance/vulnerability multipliers based on enemy weaknesses
- **Combat Log Persistence:** Store combat log history to file for post-battle review
- **Timeline Customization:** Add configuration for window size and health threshold display
- **Status Effect Icons:** Integrate status effect symbols into timeline health indicators
- **Multi-Round Projection:** Extend timeline to show 2-3 rounds ahead for long-term planning
- **Combat Log Filtering:** Allow players to toggle damage type visibility
- **Timeline Animation:** Smooth scrolling transitions when active combatant changes

---

**End of Changelog v0.3.6b**
