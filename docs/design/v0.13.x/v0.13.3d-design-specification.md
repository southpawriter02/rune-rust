# v0.13.3d Design Specification: Gathering Display

**Version:** 0.13.3d
**Parent:** v0.13.3 (Crafting UI)
**Prerequisites:** v0.13.3c Complete (Recipe Browser & Details), v0.11.x Complete (Crafting & Resources Services)
**Status:** Design Complete
**Estimated Unit Tests:** ~5

---

## Table of Contents

1. [Executive Summary](#1-executive-summary)
2. [Feature Overview](#2-feature-overview)
3. [Architecture Diagrams](#3-architecture-diagrams)
4. [Harvestable Indicators Component](#4-harvestable-indicators-component)
   - 4.1 [HarvestableIndicators Class](#41-harvestableindicators-class)
   - 4.2 [Node Icon Display](#42-node-icon-display)
   - 4.3 [Gather Prompt Display](#43-gather-prompt-display)
5. [Gathering Display Component](#5-gathering-display-component)
   - 5.1 [GatheringDisplay Class](#51-gatheringdisplay-class)
   - 5.2 [Dice Check Visualization](#52-dice-check-visualization)
   - 5.3 [Yield Display](#53-yield-display)
6. [Dice Check Renderer](#6-dice-check-renderer)
   - 6.1 [DiceCheckRenderer Class](#61-dicecheckrenderer-class)
   - 6.2 [Roll Formatting](#62-roll-formatting)
   - 6.3 [Result Formatting](#63-result-formatting)
7. [Gather Command](#7-gather-command)
8. [Data Model Changes](#8-data-model-changes)
9. [Configuration File Schemas](#9-configuration-file-schemas)
10. [RoomView Integration](#10-roomview-integration)
11. [Logging Specifications](#11-logging-specifications)
12. [Unit Testing Requirements](#12-unit-testing-requirements)
13. [Use Cases](#13-use-cases)
14. [Deliverable Checklist](#14-deliverable-checklist)
15. [Acceptance Criteria](#15-acceptance-criteria)
16. [Dependencies](#16-dependencies)
17. [Future Considerations](#17-future-considerations)

---

## 1. Executive Summary

This version implements the gathering display showing harvestable resource indicators in rooms, gathering dice check visualization, and yield display for gathered resources. Players see harvestable nodes in room descriptions with resource type icons, difficulty class (DC), and gathering prompts. When gathering, players see the dice roll breakdown, skill modifiers, success/failure result, and the resources yielded on success.

### Key Deliverables

| Category | Items |
|----------|-------|
| **UI Components** | `HarvestableIndicators`, `GatheringDisplay` |
| **Renderers** | `DiceCheckRenderer` |
| **Commands** | `GatherCommand` |
| **DTOs** | `HarvestableNodeDisplayDto`, `GatheringCheckDisplayDto`, `GatheringResultDto`, `GatheredResourceDto` |
| **View Updates** | `RoomView` integration |
| **Configuration** | `gathering-display.json` |
| **Tests** | ~5 unit tests |

### Architectural Significance

This version establishes the **Gathering Display Pattern** for resource collection UI:
- Harvestable indicators show in room view with type icons and DC
- Dice check display shows roll breakdown with modifiers
- Success/failure uses consistent `[x]`/`[ ]` indicator pattern
- Yield display shows gathered resources with quantities
- The pattern reuses ResourceStackRenderer from v0.13.3a for consistent resource display
- The pattern completes the v0.13.3 Crafting UI subsystem

---

## 2. Feature Overview

```
v0.13.3d Features
├── HarvestableIndicators (UI Component)
│   ├── RenderHarvestables(IEnumerable<HarvestableNode>)
│   ├── GetNodeIcon(ResourceType)
│   ├── ShowGatherPrompt(HarvestableNode)
│   └── HighlightSelected(HarvestableNode)
│
├── GatheringDisplay (UI Component)
│   ├── ShowDiceCheck(DiceRoll, int)
│   ├── ShowResult(bool, int)
│   ├── ShowYield(IEnumerable<GatheredResource>)
│   └── AnimateGathering()
│
├── DiceCheckRenderer (Renderer)
│   ├── FormatRoll(DiceRoll)
│   ├── FormatModifiers(IEnumerable<int>)
│   ├── FormatDC(int)
│   └── FormatResult(bool)
│
├── Node Indicators
│   ├── [H] Herb nodes (green)
│   ├── [O] Ore nodes (gray/brown)
│   ├── [L] Leather sources (brown)
│   ├── [G] Gem deposits (cyan)
│   └── [M] Misc harvestables (white)
│
├── Dice Check Display
│   ├── Skill name and DC
│   ├── Roll breakdown: [##] + # = ##
│   └── Success/Failure indicator
│
├── GatherCommand
│   ├── Target selection
│   ├── Skill check execution
│   └── Result display
│
└── RoomView Integration
    ├── Harvestable detection
    ├── Indicator rendering
    └── Gather action handling
```

### Scope Verification

| Feature | Source | Included |
|---------|--------|----------|
| Harvestable indicators in room view | v0.13.3-scope-breakdown.md | Yes |
| Gathering dice check display with roll visualization | v0.13.3-scope-breakdown.md | Yes |
| Yield display showing gathered resources | v0.13.3-scope-breakdown.md | Yes |
| Gathering action prompt | v0.13.3-scope-breakdown.md | Yes |
| Resource inventory panel | v0.13.3-scope-breakdown.md | No (v0.13.3a) |
| Crafting station interface | v0.13.3-scope-breakdown.md | No (v0.13.3b) |
| Recipe browser | v0.13.3-scope-breakdown.md | No (v0.13.3c) |

---

## 3. Architecture Diagrams

### 3.1 Layer Diagram

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                          PRESENTATION LAYER                                  │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  ┌─────────────────────────┐      ┌─────────────────────────┐               │
│  │       RoomView          │      │  HarvestableIndicators  │               │
│  │      (existing)         │◄────▶│  (NEW)                  │               │
│  ├─────────────────────────┤      ├─────────────────────────┤               │
│  │ - RenderRoom()          │      │ - RenderHarvestables()  │               │
│  │ - HandleInteraction()   │      │ - GetNodeIcon()         │               │
│  │ - ShowHarvestables()    │      │ - ShowGatherPrompt()    │               │
│  └─────────────────────────┘      │ - HighlightSelected()   │               │
│                                    └───────────┬─────────────┘               │
│                                                │                             │
│  ┌─────────────────────────┐                   │                             │
│  │   GatheringDisplay      │◄──────────────────┤                             │
│  │   (NEW)                 │                   │                             │
│  ├─────────────────────────┤                   │                             │
│  │ - ShowDiceCheck()       │                   │                             │
│  │ - ShowResult()          │                   │                             │
│  │ - ShowYield()           │                   │                             │
│  │ - AnimateGathering()    │                   │                             │
│  └─────────────────────────┘                   │                             │
│                                                │                             │
│  ┌─────────────────────────┐      ┌────────────┴────────────┐               │
│  │ ResourceStackRenderer   │      │   DiceCheckRenderer     │               │
│  │ (v0.13.3a)              │      │   (NEW)                 │               │
│  ├─────────────────────────┤      ├─────────────────────────┤               │
│  │ - FormatStack()         │      │ - FormatRoll()          │               │
│  │ - GetTypeIcon()         │      │ - FormatModifiers()     │               │
│  │ - FormatQuantity()      │      │ - FormatDC()            │               │
│  └─────────────────────────┘      │ - FormatResult()        │               │
│                                    └─────────────────────────┘               │
│                                                                              │
│  ┌─────────────────────────────────────────────────────────────────────────┐ │
│  │                        GatherCommand (NEW)                               │ │
│  ├─────────────────────────────────────────────────────────────────────────┤ │
│  │ - Execute()             - SelectTarget()                                │ │
│  │ - PerformGather()       - HandleResult()                                │ │
│  └─────────────────────────────────────────────────────────────────────────┘ │
│                                                                              │
└──────────────────────────────────────────────────────────────────────────────┘
                                        │
                                        ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                          APPLICATION LAYER                                   │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │                    IGatheringService (existing v0.11.x)             │    │
│  ├─────────────────────────────────────────────────────────────────────┤    │
│  │ + GetHarvestablesInRoom(roomId) : IReadOnlyList<HarvestableNode>    │    │
│  │ + GetHarvestable(nodeId) : HarvestableNode?                         │    │
│  │ + CanGather(player, nodeId) : bool                                  │    │
│  │ + Gather(player, nodeId) : GatheringResult                          │    │
│  │ + GetGatheringSkill(player, nodeType) : int                         │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
│                                                                              │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │                    IDiceService (existing)                          │    │
│  ├─────────────────────────────────────────────────────────────────────┤    │
│  │ + Roll(diceExpression) : DiceRoll                                   │    │
│  │ + RollWithModifier(dice, modifier) : DiceRoll                       │    │
│  │ + RollCheck(dice, modifier, dc) : CheckResult                       │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
│                                                                              │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │                    IResourceService (existing v0.11.x)              │    │
│  ├─────────────────────────────────────────────────────────────────────┤    │
│  │ + AddResources(player, resourceId, quantity) : void                 │    │
│  │ + GetPlayerResources(player) : IReadOnlyList<ResourcePoolDto>       │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
│                                                                              │
└──────────────────────────────────────────────────────────────────────────────┘
                                        │
                                        ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                            DOMAIN LAYER                                      │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  ┌─────────────────────────┐      ┌─────────────────────────┐               │
│  │    HarvestableNode      │      │    GatheringResult      │               │
│  │   (existing v0.11.x)    │      │   (existing v0.11.x)    │               │
│  ├─────────────────────────┤      ├─────────────────────────┤               │
│  │ + Id: string            │      │ + Success: bool         │               │
│  │ + Name: string          │      │ + Roll: DiceRoll        │               │
│  │ + ResourceTypeId: string│      │ + DC: int               │               │
│  │ + ResourceType: enum    │      │ + Yield: list           │               │
│  │ + Quantity: int         │      │ + Message: string?      │               │
│  │ + DifficultyClass: int  │      └─────────────────────────┘               │
│  │ + RequiredSkill: string │                                                 │
│  │ + RespawnTime: TimeSpan │      ┌─────────────────────────┐               │
│  │ + IsAvailable: bool     │      │      DiceRoll           │               │
│  └─────────────────────────┘      │   (existing)            │               │
│                                    ├─────────────────────────┤               │
│  ┌─────────────────────────┐      │ + RawRoll: int          │               │
│  │   GatheredResource      │      │ + Modifier: int         │               │
│  │  (existing v0.11.x)     │      │ + Total: int            │               │
│  ├─────────────────────────┤      │ + DiceExpression: string│               │
│  │ + ResourceId: string    │      └─────────────────────────┘               │
│  │ + Quantity: int         │                                                 │
│  └─────────────────────────┘                                                 │
│                                                                              │
└──────────────────────────────────────────────────────────────────────────────┘
```

### 3.2 Harvestable Indicators Flow

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                    HARVESTABLE INDICATORS FLOW                               │
└─────────────────────────────────────────────────────────────────────────────┘

    Player Enters Room with Harvestable Resources
           │
           ▼
┌─────────────────────────┐
│       RoomView          │
│     RenderRoom()        │
└───────────┬─────────────┘
            │
            │ 1. Check for harvestable nodes in room
            ▼
┌─────────────────────────┐
│   IGatheringService     │
│  GetHarvestablesInRoom()│
└───────────┬─────────────┘
            │
            │ 2. Returns List<HarvestableNode>
            ▼
┌─────────────────────────────────────────────────────────────┐
│    HarvestableIndicators                                     │
│                                                              │
│  ┌───────────────────┐  ┌───────────────────┐               │
│  │ FilterAvailable() │  │ GroupByType()     │               │
│  └─────────┬─────────┘  └─────────┬─────────┘               │
│            │                      │                          │
│            │ 3. Filter to available nodes only              │
│            ▼                      ▼                          │
│  ┌───────────────────┐  ┌───────────────────┐               │
│  │RenderHarvestables()│ │RenderGatherPrompt()│              │
│  └─────────┬─────────┘  └─────────┬─────────┘               │
│            │                      │                          │
│            │ 4. Display node indicators                     │
└────────────┼──────────────────────┼─────────────────────────┘
             │                      │
             │ 5. For each node
             ▼                      ▼
┌─────────────────────────────────────────────────────────────┐
│ Node Display                                                 │
│                                                              │
│ ┌─────────────────────────────────────────────────────────┐ │
│ │  [H] Healing Herbs (x3)     DC 10  [G]ather             │ │
│ │  [M] Cave Mushrooms (x2)    DC 12  [G]ather             │ │
│ └─────────────────────────────────────────────────────────┘ │
│                                                              │
│ Components:                                                  │
│ - GetNodeIcon(type)  → [H], [O], [L], [G], [M]             │
│ - Node name + quantity                                      │
│ - FormatDC(dc)       → "DC ##"                             │
│ - ShowGatherPrompt() → "[G]ather"                          │
└───────────┬─────────────────────────────────────────────────┘
            │
            │ 6. Output to terminal
            ▼
┌─────────────────────────┐
│   ITerminalService      │
│   WriteAt(x, y, text)   │
│   WriteColoredAt(...)   │
└─────────────────────────┘
```

### 3.3 Gathering Action Flow

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                    GATHERING ACTION FLOW                                     │
└─────────────────────────────────────────────────────────────────────────────┘

    Player Executes "gather" or "gather <target>" Command
           │
           ▼
┌─────────────────────────┐
│     GatherCommand       │
│       Execute()         │
└───────────┬─────────────┘
            │
            │ 1. Parse target (if specified) or prompt selection
            ▼
┌─────────────────────────────────────────────────────────────┐
│  Target Selection                                            │
│                                                              │
│  ├─── No target specified ──► Show available nodes list    │
│  │                           Allow player to select         │
│  │                                                           │
│  └─── Target specified ──► Match against node names         │
│                            Validate node exists & available  │
└───────────┬─────────────────────────────────────────────────┘
            │
            │ 2. Validate gathering is possible
            ▼
┌─────────────────────────┐
│   IGatheringService     │
│   CanGather(player,     │
│     nodeId)             │
└───────────┬─────────────┘
            │
            ├─── false ───► Display "Cannot gather" message
            │
            │ true
            ▼
┌─────────────────────────────────────────────────────────────┐
│  GatheringDisplay                                            │
│                                                              │
│  ShowDiceCheck(roll, dc)                                    │
│                                                              │
│  ┌─────────────────────────────────────────────────────────┐│
│  │ GATHERING: Healing Herbs                                ││
│  │ ─────────────────────────                               ││
│  │ Skill Check: Herbalism (DC 10)                          ││
│  └─────────────────────────────────────────────────────────┘│
└───────────┬─────────────────────────────────────────────────┘
            │
            │ 3. Perform gathering skill check
            ▼
┌─────────────────────────┐
│   IGatheringService     │
│   Gather(player,        │
│     nodeId)             │
└───────────┬─────────────┘
            │
            │ 4. Returns GatheringResult with roll data
            ▼
┌─────────────────────────────────────────────────────────────┐
│  DiceCheckRenderer                                           │
│                                                              │
│  FormatRoll(result.Roll)                                    │
│                                                              │
│  ┌─────────────────────────────────────────────────────────┐│
│  │ Rolling: 1d20 + 3 (Herbalism)                           ││
│  │ Result: [14] + 3 = 17                                   ││
│  └─────────────────────────────────────────────────────────┘│
└───────────┬─────────────────────────────────────────────────┘
            │
            │ 5. Show result
            ▼
┌─────────────────────────────────────────────────────────────┐
│  GatheringDisplay                                            │
│                                                              │
│  ShowResult(success, total)                                 │
│                                                              │
│  ├─── success = true ──────────────────────────────────────┐│
│  │ ┌─────────────────────────────────────────────────────┐ ││
│  │ │ [x] SUCCESS!                                        │ ││
│  │ │                                                     │ ││
│  │ │ Yield: [H] Healing Herb x2                          │ ││
│  │ └─────────────────────────────────────────────────────┘ ││
│  │                                                          ││
│  └─── success = false ─────────────────────────────────────┤│
│    ┌─────────────────────────────────────────────────────┐ ││
│    │ [ ] FAILED                                          │ ││
│    │                                                     │ ││
│    │ No resources gathered.                              │ ││
│    └─────────────────────────────────────────────────────┘ ││
└───────────┬─────────────────────────────────────────────────┘
            │
            │ 6. On success, add resources to player inventory
            ▼
┌─────────────────────────┐
│   IResourceService      │
│   AddResources(player,  │
│     resourceId, qty)    │
└─────────────────────────┘
```

### 3.4 Dice Check Display Flow

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                    DICE CHECK DISPLAY FLOW                                   │
└─────────────────────────────────────────────────────────────────────────────┘

    Gathering Service Returns DiceRoll and DC
           │
           ▼
┌─────────────────────────────────────────────────────────────┐
│  DiceCheckRenderer                                           │
│                                                              │
│  ┌───────────────────┐                                      │
│  │ FormatDC(dc)      │  → "Skill Check: Herbalism (DC 10)" │
│  └───────────────────┘                                      │
│                                                              │
│  ┌───────────────────┐                                      │
│  │ FormatRoll(roll)  │  → "Rolling: 1d20 + 3 (Herbalism)"  │
│  └───────────────────┘                                      │
│                                                              │
│  ┌───────────────────────────────────────────┐              │
│  │ FormatModifiers(modifiers)                │              │
│  │                                           │              │
│  │ Input: [14, 3]                           │              │
│  │ Output: "[14] + 3 = 17"                  │              │
│  │                                           │              │
│  │ Breakdown:                               │              │
│  │ - Raw roll in brackets: [14]             │              │
│  │ - Positive mods with +: + 3              │              │
│  │ - Negative mods with -: - 2              │              │
│  │ - Total after =: = 17                    │              │
│  └───────────────────────────────────────────┘              │
│                                                              │
│  ┌───────────────────────────────────────────┐              │
│  │ FormatResult(success)                     │              │
│  │                                           │              │
│  │ success = true  → "[x] SUCCESS!"         │              │
│  │ success = false → "[ ] FAILED"           │              │
│  └───────────────────────────────────────────┘              │
└───────────┬─────────────────────────────────────────────────┘
            │
            │ Complete Display
            ▼
┌─────────────────────────────────────────────────────────────┐
│  GATHERING: Healing Herbs                                    │
│  ─────────────────────────                                   │
│  Skill Check: Herbalism (DC 10)                             │
│                                                              │
│  Rolling: 1d20 + 3 (Herbalism)                              │
│  Result: [14] + 3 = 17  [x] SUCCESS!                        │
│                                                              │
│  Yield: [H] Healing Herb x2                                 │
└─────────────────────────────────────────────────────────────┘
```

---

## 4. Harvestable Indicators Component

### 4.1 HarvestableIndicators Class

**Purpose:** Displays harvestable resource indicators in the room view.

**File:** `src/Presentation/RuneAndRust.Presentation.Tui/UI/HarvestableIndicators.cs`

```csharp
using RuneAndRust.Application.Interfaces;
using RuneAndRust.Presentation.Tui.DTOs;
using RuneAndRust.Presentation.Tui.Renderers;
using RuneAndRust.Presentation.Tui.Services;
using RuneAndRust.Presentation.Tui.Configuration;

namespace RuneAndRust.Presentation.Tui.UI;

/// <summary>
/// Displays harvestable resource indicators in the room view.
/// </summary>
/// <remarks>
/// Shows available harvestable nodes with resource type icons, quantities,
/// difficulty class, and gather action prompts.
/// </remarks>
public class HarvestableIndicators
{
    private readonly ResourceStackRenderer _stackRenderer;
    private readonly ITerminalService _terminalService;
    private readonly GatheringDisplayConfig _config;
    private readonly ILogger<HarvestableIndicators> _logger;

    private IReadOnlyList<HarvestableNodeDisplayDto> _harvestables = Array.Empty<HarvestableNodeDisplayDto>();
    private int _selectedIndex;
    private (int X, int Y) _indicatorPosition;

    /// <summary>
    /// Gets whether indicators are currently visible.
    /// </summary>
    public bool IsVisible { get; private set; }

    /// <summary>
    /// Gets the currently selected node index.
    /// </summary>
    public int SelectedIndex => _selectedIndex;

    /// <summary>
    /// Gets the count of harvestable nodes.
    /// </summary>
    public int NodeCount => _harvestables.Count;

    /// <summary>
    /// Creates a new instance of the HarvestableIndicators component.
    /// </summary>
    /// <param name="stackRenderer">The resource stack renderer from v0.13.3a.</param>
    /// <param name="terminalService">The terminal output service.</param>
    /// <param name="config">Configuration for gathering display settings.</param>
    /// <param name="logger">Logger for diagnostic output.</param>
    public HarvestableIndicators(
        ResourceStackRenderer stackRenderer,
        ITerminalService terminalService,
        GatheringDisplayConfig config,
        ILogger<HarvestableIndicators> logger)
    {
        _stackRenderer = stackRenderer ?? throw new ArgumentNullException(nameof(stackRenderer));
        _terminalService = terminalService ?? throw new ArgumentNullException(nameof(terminalService));
        _config = config ?? throw new ArgumentNullException(nameof(config));
        _logger = logger ?? throw new ArgumentNullException(nameof(logger));
    }

    /// <summary>
    /// Sets the indicator display position.
    /// </summary>
    /// <param name="x">The X coordinate.</param>
    /// <param name="y">The Y coordinate.</param>
    public void SetPosition(int x, int y)
    {
        _indicatorPosition = (x, y);
    }

    /// <summary>
    /// Renders the harvestable indicators.
    /// </summary>
    /// <param name="harvestables">The harvestable nodes to display.</param>
    public void RenderHarvestables(IEnumerable<HarvestableNodeDisplayDto> harvestables)
    {
        _harvestables = harvestables
            .Where(h => h.IsAvailable)
            .ToList();

        if (_harvestables.Count == 0)
        {
            IsVisible = false;
            return;
        }

        IsVisible = true;

        // Clear indicator area
        ClearIndicators();

        // Render header
        RenderHeader();

        // Render node entries
        RenderNodeEntries();

        _logger.LogDebug(
            "Rendered {Count} harvestable indicators",
            _harvestables.Count);
    }

    /// <summary>
    /// Gets the icon for a resource type.
    /// </summary>
    /// <param name="resourceType">The resource type.</param>
    /// <returns>The type icon string.</returns>
    public string GetNodeIcon(ResourceCategory resourceType)
    {
        return _stackRenderer.GetTypeIcon(resourceType);
    }

    /// <summary>
    /// Shows the gather prompt for a node.
    /// </summary>
    /// <param name="node">The harvestable node.</param>
    public void ShowGatherPrompt(HarvestableNodeDisplayDto node)
    {
        var promptY = _indicatorPosition.Y + _config.IndicatorHeight - 2;
        var promptText = $"Press [G] to gather {node.Name}";

        _terminalService.WriteColoredAt(
            _indicatorPosition.X + 2,
            promptY,
            promptText,
            _config.PromptColor);

        _logger.LogDebug("Showed gather prompt for node: {NodeName}", node.Name);
    }

    /// <summary>
    /// Highlights the selected node.
    /// </summary>
    /// <param name="index">The node index to highlight.</param>
    public void HighlightSelected(int index)
    {
        if (index < 0 || index >= _harvestables.Count)
        {
            return;
        }

        _selectedIndex = index;
        RenderNodeEntries();

        _logger.LogDebug("Highlighted node at index {Index}", index);
    }

    /// <summary>
    /// Gets the currently selected node.
    /// </summary>
    /// <returns>The selected node, or null if none.</returns>
    public HarvestableNodeDisplayDto? GetSelectedNode()
    {
        if (_harvestables.Count == 0 || _selectedIndex < 0 || _selectedIndex >= _harvestables.Count)
        {
            return null;
        }

        return _harvestables[_selectedIndex];
    }

    /// <summary>
    /// Selects the next harvestable node.
    /// </summary>
    public void SelectNext()
    {
        if (_harvestables.Count == 0) return;

        _selectedIndex = (_selectedIndex + 1) % _harvestables.Count;
        RenderNodeEntries();
    }

    /// <summary>
    /// Selects the previous harvestable node.
    /// </summary>
    public void SelectPrevious()
    {
        if (_harvestables.Count == 0) return;

        _selectedIndex = (_selectedIndex - 1 + _harvestables.Count) % _harvestables.Count;
        RenderNodeEntries();
    }

    /// <summary>
    /// Hides the indicators.
    /// </summary>
    public void Hide()
    {
        if (!IsVisible) return;

        ClearIndicators();
        IsVisible = false;
        _harvestables = Array.Empty<HarvestableNodeDisplayDto>();
        _selectedIndex = 0;

        _logger.LogDebug("Harvestable indicators hidden");
    }

    #region Private Methods

    private void ClearIndicators()
    {
        var blankLine = new string(' ', _config.IndicatorWidth);
        for (var y = 0; y < _config.IndicatorHeight; y++)
        {
            _terminalService.WriteAt(_indicatorPosition.X, _indicatorPosition.Y + y, blankLine);
        }
    }

    private void RenderHeader()
    {
        var headerY = _indicatorPosition.Y;

        // Section label
        _terminalService.WriteAt(_indicatorPosition.X + 2, headerY, "Harvestable Resources:");

        // Box top border
        var boxY = headerY + 1;
        var boxWidth = _config.IndicatorWidth - 4;
        var topBorder = $"┌{new string('─', boxWidth - 2)}┐";
        _terminalService.WriteAt(_indicatorPosition.X + 2, boxY, topBorder);
    }

    private void RenderNodeEntries()
    {
        var entryY = _indicatorPosition.Y + 2;
        var boxWidth = _config.IndicatorWidth - 4;

        for (var i = 0; i < _harvestables.Count && i < _config.MaxVisibleNodes; i++)
        {
            var node = _harvestables[i];
            var isSelected = i == _selectedIndex;

            RenderNodeEntry(node, entryY + i, boxWidth, isSelected);
        }

        // Box bottom border
        var bottomY = entryY + Math.Min(_harvestables.Count, _config.MaxVisibleNodes);
        var bottomBorder = $"└{new string('─', boxWidth - 2)}┘";
        _terminalService.WriteAt(_indicatorPosition.X + 2, bottomY, bottomBorder);
    }

    private void RenderNodeEntry(HarvestableNodeDisplayDto node, int y, int width, bool isSelected)
    {
        // Entry format: │  [H] Healing Herbs (x3)     DC 10  [G]ather  │
        var icon = GetNodeIcon(node.ResourceType);
        var iconColor = _stackRenderer.GetTypeColor(node.ResourceType);
        var nameWithQty = $"{node.Name} (x{node.Quantity})";
        var dcText = $"DC {node.DifficultyClass}";
        var gatherText = "[G]ather";

        // Build entry line
        var x = _indicatorPosition.X + 2;

        // Left border
        _terminalService.WriteAt(x, y, "│  ");

        // Selection indicator
        if (isSelected)
        {
            _terminalService.WriteColoredAt(x + 3, y, "►", _config.SelectionColor);
        }

        // Icon with type color
        _terminalService.WriteColoredAt(x + 5, y, icon, iconColor);

        // Name and quantity
        var nameX = x + 9;
        var nameColor = isSelected ? _config.SelectionColor : ConsoleColor.White;
        _terminalService.WriteColoredAt(nameX, y, nameWithQty, nameColor);

        // DC (right-aligned section)
        var dcX = x + width - 20;
        _terminalService.WriteColoredAt(dcX, y, dcText, _config.DifficultyColor);

        // Gather prompt
        var gatherX = x + width - 10;
        _terminalService.WriteColoredAt(gatherX, y, gatherText, _config.PromptColor);

        // Right border
        var rightBorderX = x + width - 1;
        _terminalService.WriteAt(rightBorderX, y, "│");
    }

    #endregion
}
```

### 4.2 Node Icon Display

**Purpose:** Provide visual identification for harvestable resource types.

**Icon Mapping (reuses ResourceCategory from v0.13.3a):**

| Resource Type | Icon | Color | Examples |
|---------------|------|-------|----------|
| Herb | `[H]` | Green | Healing Herbs, Mana Bloom, Fire Blossom |
| Ore | `[O]` | DarkYellow | Iron Ore, Silver Ore, Gold Ore |
| Leather | `[L]` | DarkYellow | Leather, Thick Hide |
| Gem | `[G]` | Cyan | Ruby, Sapphire, Emerald |
| Misc | `[M]` | White | Cave Mushrooms, Enchanting Dust |

**Icon Display Example:**
```
│  [H] Healing Herbs (x3)     DC 10  [G]ather  │
│  [M] Cave Mushrooms (x2)    DC 12  [G]ather  │
```

### 4.3 Gather Prompt Display

**Purpose:** Show the action prompt for gathering.

**Prompt Format:**
- Action key: `[G]`
- Prompt text: `[G]ather`
- Color: Configurable prompt color

**Prompt Display:**
```
│  [H] Healing Herbs (x3)     DC 10  [G]ather  │
                                     └── Gather prompt
```

---

## 5. Gathering Display Component

### 5.1 GatheringDisplay Class

**Purpose:** Displays the gathering action with dice check and yield results.

**File:** `src/Presentation/RuneAndRust.Presentation.Tui/UI/GatheringDisplay.cs`

```csharp
using RuneAndRust.Application.Interfaces;
using RuneAndRust.Presentation.Tui.DTOs;
using RuneAndRust.Presentation.Tui.Renderers;
using RuneAndRust.Presentation.Tui.Services;
using RuneAndRust.Presentation.Tui.Configuration;

namespace RuneAndRust.Presentation.Tui.UI;

/// <summary>
/// Displays the gathering action with dice check and yield results.
/// </summary>
/// <remarks>
/// Shows the dice roll breakdown, skill modifiers, success/failure result,
/// and gathered resources on success.
/// </remarks>
public class GatheringDisplay
{
    private readonly DiceCheckRenderer _diceRenderer;
    private readonly ResourceStackRenderer _stackRenderer;
    private readonly ITerminalService _terminalService;
    private readonly GatheringDisplayConfig _config;
    private readonly ILogger<GatheringDisplay> _logger;

    private (int X, int Y) _displayPosition;
    private bool _isVisible;

    /// <summary>
    /// Gets whether the display is currently visible.
    /// </summary>
    public bool IsVisible => _isVisible;

    /// <summary>
    /// Creates a new instance of the GatheringDisplay component.
    /// </summary>
    /// <param name="diceRenderer">The dice check renderer.</param>
    /// <param name="stackRenderer">The resource stack renderer.</param>
    /// <param name="terminalService">The terminal output service.</param>
    /// <param name="config">Configuration for gathering display settings.</param>
    /// <param name="logger">Logger for diagnostic output.</param>
    public GatheringDisplay(
        DiceCheckRenderer diceRenderer,
        ResourceStackRenderer stackRenderer,
        ITerminalService terminalService,
        GatheringDisplayConfig config,
        ILogger<GatheringDisplay> logger)
    {
        _diceRenderer = diceRenderer ?? throw new ArgumentNullException(nameof(diceRenderer));
        _stackRenderer = stackRenderer ?? throw new ArgumentNullException(nameof(stackRenderer));
        _terminalService = terminalService ?? throw new ArgumentNullException(nameof(terminalService));
        _config = config ?? throw new ArgumentNullException(nameof(config));
        _logger = logger ?? throw new ArgumentNullException(nameof(logger));
    }

    /// <summary>
    /// Sets the display position.
    /// </summary>
    /// <param name="x">The X coordinate.</param>
    /// <param name="y">The Y coordinate.</param>
    public void SetPosition(int x, int y)
    {
        _displayPosition = (x, y);
    }

    /// <summary>
    /// Shows the dice check for a gathering action.
    /// </summary>
    /// <param name="check">The gathering check data.</param>
    public void ShowDiceCheck(GatheringCheckDisplayDto check)
    {
        _isVisible = true;

        // Clear display area
        ClearDisplay();

        var y = _displayPosition.Y;

        // Header
        var header = $"GATHERING: {check.NodeName}";
        _terminalService.WriteColoredAt(_displayPosition.X, y, header, _config.HeaderColor);
        _terminalService.WriteAt(_displayPosition.X, y + 1, new string('─', header.Length));

        // Skill check line
        var skillCheckLine = _diceRenderer.FormatDC(check.SkillName, check.DifficultyClass);
        _terminalService.WriteAt(_displayPosition.X, y + 2, skillCheckLine);

        // Rolling line (shows what dice are being rolled)
        var rollingLine = $"Rolling: 1d20 + {check.SkillModifier} ({check.SkillName})";
        _terminalService.WriteAt(_displayPosition.X, y + 4, rollingLine);

        _logger.LogDebug(
            "Showed dice check for {NodeName}, DC {DC}",
            check.NodeName,
            check.DifficultyClass);
    }

    /// <summary>
    /// Shows the result of the dice check.
    /// </summary>
    /// <param name="result">The gathering result data.</param>
    public void ShowResult(GatheringResultDto result)
    {
        var y = _displayPosition.Y + 5;

        // Result line with roll breakdown
        var rollBreakdown = _diceRenderer.FormatRoll(result.RawRoll, result.Modifier, result.Total);
        var resultIndicator = _diceRenderer.FormatResult(result.Success);

        var resultLine = $"Result: {rollBreakdown}  {resultIndicator}";
        _terminalService.WriteAt(_displayPosition.X, y, resultLine);

        // Color the result indicator
        var indicatorX = _displayPosition.X + 8 + rollBreakdown.Length + 2;
        var indicatorColor = result.Success ? _config.SuccessColor : _config.FailureColor;
        _terminalService.WriteColoredAt(indicatorX, y, resultIndicator, indicatorColor);

        _logger.LogInformation(
            "Gathering result: {Success}, Roll {Total} vs DC {DC}",
            result.Success ? "SUCCESS" : "FAILED",
            result.Total,
            result.DifficultyClass);
    }

    /// <summary>
    /// Shows the yield from successful gathering.
    /// </summary>
    /// <param name="yield">The gathered resources.</param>
    public void ShowYield(IEnumerable<GatheredResourceDto> yield)
    {
        var y = _displayPosition.Y + 7;
        var yieldList = yield.ToList();

        if (yieldList.Count == 0)
        {
            _terminalService.WriteColoredAt(
                _displayPosition.X,
                y,
                "No resources gathered.",
                _config.FailureColor);
            return;
        }

        // Yield header
        _terminalService.WriteAt(_displayPosition.X, y, "Yield: ");

        // Render each gathered resource
        var yieldX = _displayPosition.X + 7;
        foreach (var resource in yieldList)
        {
            var icon = _stackRenderer.GetTypeIcon(resource.ResourceType);
            var iconColor = _stackRenderer.GetTypeColor(resource.ResourceType);
            var yieldText = $"{resource.ResourceName} x{resource.Quantity}";

            _terminalService.WriteColoredAt(yieldX, y, icon, iconColor);
            _terminalService.WriteAt(yieldX + 4, y, yieldText);

            y++;
        }

        _logger.LogDebug("Showed yield with {Count} resource types", yieldList.Count);
    }

    /// <summary>
    /// Animates the gathering process (optional visual feedback).
    /// </summary>
    public void AnimateGathering()
    {
        // Simple text-based animation
        var y = _displayPosition.Y + 4;
        var frames = new[] { "Gathering.", "Gathering..", "Gathering..." };

        foreach (var frame in frames)
        {
            _terminalService.WriteAt(_displayPosition.X, y, frame + "   ");
            Thread.Sleep(_config.AnimationDelayMs);
        }

        // Clear animation line
        _terminalService.WriteAt(_displayPosition.X, y, new string(' ', 20));
    }

    /// <summary>
    /// Hides the gathering display.
    /// </summary>
    public void Hide()
    {
        if (!_isVisible) return;

        ClearDisplay();
        _isVisible = false;

        _logger.LogDebug("Gathering display hidden");
    }

    #region Private Methods

    private void ClearDisplay()
    {
        var blankLine = new string(' ', _config.DisplayWidth);
        for (var y = 0; y < _config.DisplayHeight; y++)
        {
            _terminalService.WriteAt(_displayPosition.X, _displayPosition.Y + y, blankLine);
        }
    }

    #endregion
}
```

### 5.2 Dice Check Visualization

**Purpose:** Show the dice roll with breakdown.

**Dice Check Display Format:**
```
GATHERING: Healing Herbs
─────────────────────────
Skill Check: Herbalism (DC 10)

Rolling: 1d20 + 3 (Herbalism)
Result: [14] + 3 = 17  [x] SUCCESS!
```

**Display Elements:**
- Header with node name
- Skill name and DC
- Dice expression with modifier
- Roll breakdown: `[raw] + modifier = total`
- Success/failure indicator

### 5.3 Yield Display

**Purpose:** Show gathered resources on success.

**Yield Display Format:**
```
Yield: [H] Healing Herb x2
```

**Yield Elements:**
- "Yield:" label
- Resource type icon with color
- Resource name
- Quantity gathered

**Failure Display:**
```
No resources gathered.
```

---

## 6. Dice Check Renderer

### 6.1 DiceCheckRenderer Class

**Purpose:** Formats dice rolls and check results for display.

**File:** `src/Presentation/RuneAndRust.Presentation.Tui/Renderers/DiceCheckRenderer.cs`

```csharp
using RuneAndRust.Presentation.Tui.Configuration;

namespace RuneAndRust.Presentation.Tui.Renderers;

/// <summary>
/// Renders dice check displays with roll breakdowns and results.
/// </summary>
/// <remarks>
/// Provides consistent formatting for dice rolls including raw values,
/// modifiers, totals, and success/failure indicators.
/// </remarks>
public class DiceCheckRenderer
{
    private readonly GatheringDisplayConfig _config;

    /// <summary>
    /// Creates a new instance of the DiceCheckRenderer.
    /// </summary>
    /// <param name="config">Configuration for display settings.</param>
    public DiceCheckRenderer(GatheringDisplayConfig config)
    {
        _config = config ?? throw new ArgumentNullException(nameof(config));
    }

    /// <summary>
    /// Formats a dice roll with breakdown.
    /// </summary>
    /// <param name="rawRoll">The raw dice roll value.</param>
    /// <param name="modifier">The skill modifier.</param>
    /// <param name="total">The total result.</param>
    /// <returns>The formatted roll string.</returns>
    public string FormatRoll(int rawRoll, int modifier, int total)
    {
        // Format: [14] + 3 = 17
        var modifierSign = modifier >= 0 ? "+" : "-";
        var modifierValue = Math.Abs(modifier);

        return $"[{rawRoll}] {modifierSign} {modifierValue} = {total}";
    }

    /// <summary>
    /// Formats modifiers for display.
    /// </summary>
    /// <param name="modifiers">The list of modifiers.</param>
    /// <returns>The formatted modifiers string.</returns>
    public string FormatModifiers(IEnumerable<int> modifiers)
    {
        var modifierList = modifiers.ToList();
        if (modifierList.Count == 0)
        {
            return string.Empty;
        }

        var parts = new List<string>();
        foreach (var mod in modifierList)
        {
            var sign = mod >= 0 ? "+" : "-";
            parts.Add($"{sign} {Math.Abs(mod)}");
        }

        return string.Join(" ", parts);
    }

    /// <summary>
    /// Formats the difficulty class display.
    /// </summary>
    /// <param name="skillName">The name of the skill being checked.</param>
    /// <param name="dc">The difficulty class.</param>
    /// <returns>The formatted DC string.</returns>
    public string FormatDC(string skillName, int dc)
    {
        return $"Skill Check: {skillName} (DC {dc})";
    }

    /// <summary>
    /// Formats the result indicator.
    /// </summary>
    /// <param name="success">Whether the check succeeded.</param>
    /// <returns>The formatted result string.</returns>
    public string FormatResult(bool success)
    {
        return success ? "[x] SUCCESS!" : "[ ] FAILED";
    }

    /// <summary>
    /// Formats a complete dice check display.
    /// </summary>
    /// <param name="skillName">The skill name.</param>
    /// <param name="dc">The difficulty class.</param>
    /// <param name="rawRoll">The raw dice roll.</param>
    /// <param name="modifier">The skill modifier.</param>
    /// <param name="total">The total result.</param>
    /// <param name="success">Whether the check succeeded.</param>
    /// <returns>Multi-line formatted check display.</returns>
    public string FormatCompleteCheck(
        string skillName,
        int dc,
        int rawRoll,
        int modifier,
        int total,
        bool success)
    {
        var lines = new[]
        {
            FormatDC(skillName, dc),
            "",
            $"Rolling: 1d20 + {modifier} ({skillName})",
            $"Result: {FormatRoll(rawRoll, modifier, total)}  {FormatResult(success)}"
        };

        return string.Join(Environment.NewLine, lines);
    }
}
```

### 6.2 Roll Formatting

**Purpose:** Format dice roll breakdowns consistently.

**Roll Format:**
```
[14] + 3 = 17
```

**Format Components:**
- Raw roll in brackets: `[14]`
- Modifier with sign: `+ 3` or `- 2`
- Total after equals: `= 17`

**Examples:**
```
[14] + 3 = 17   (positive modifier)
[8] - 2 = 6    (negative modifier)
[20] + 0 = 20  (no modifier)
```

### 6.3 Result Formatting

**Purpose:** Format success/failure indicators consistently.

**Result Format:**

| Result | Indicator | Color |
|--------|-----------|-------|
| Success | `[x] SUCCESS!` | Green |
| Failure | `[ ] FAILED` | Red |

**Full Result Line:**
```
Result: [14] + 3 = 17  [x] SUCCESS!
Result: [6] + 3 = 9  [ ] FAILED
```

---

## 7. Gather Command

**Purpose:** Command for gathering resources from harvestable nodes.

**File:** `src/Presentation/RuneAndRust.Presentation.Tui/Commands/GatherCommand.cs`

```csharp
using RuneAndRust.Application.Interfaces;
using RuneAndRust.Presentation.Tui.UI;
using RuneAndRust.Presentation.Tui.DTOs;

namespace RuneAndRust.Presentation.Tui.Commands;

/// <summary>
/// Command to gather resources from harvestable nodes.
/// </summary>
/// <remarks>
/// Executes gathering skill check and displays results.
/// Usage: gather [target]
/// </remarks>
public class GatherCommand : ICommand
{
    private readonly IGatheringService _gatheringService;
    private readonly HarvestableIndicators _harvestableIndicators;
    private readonly GatheringDisplay _gatheringDisplay;
    private readonly ILogger<GatherCommand> _logger;

    /// <summary>
    /// Gets the command name.
    /// </summary>
    public string Name => "gather";

    /// <summary>
    /// Gets the command aliases.
    /// </summary>
    public string[] Aliases => new[] { "g", "harvest" };

    /// <summary>
    /// Gets the command description.
    /// </summary>
    public string Description => "Gather resources from a harvestable node";

    /// <summary>
    /// Gets the command usage.
    /// </summary>
    public string Usage => "gather [target]";

    /// <summary>
    /// Creates a new instance of the GatherCommand.
    /// </summary>
    /// <param name="gatheringService">The gathering service.</param>
    /// <param name="harvestableIndicators">The harvestable indicators component.</param>
    /// <param name="gatheringDisplay">The gathering display component.</param>
    /// <param name="logger">Logger for diagnostic output.</param>
    public GatherCommand(
        IGatheringService gatheringService,
        HarvestableIndicators harvestableIndicators,
        GatheringDisplay gatheringDisplay,
        ILogger<GatherCommand> logger)
    {
        _gatheringService = gatheringService ?? throw new ArgumentNullException(nameof(gatheringService));
        _harvestableIndicators = harvestableIndicators ?? throw new ArgumentNullException(nameof(harvestableIndicators));
        _gatheringDisplay = gatheringDisplay ?? throw new ArgumentNullException(nameof(gatheringDisplay));
        _logger = logger ?? throw new ArgumentNullException(nameof(logger));
    }

    /// <summary>
    /// Executes the gather command.
    /// </summary>
    /// <param name="args">Command arguments.</param>
    /// <param name="context">Command execution context.</param>
    /// <returns>Command result.</returns>
    public CommandResult Execute(string[] args, CommandContext context)
    {
        var player = context.Player;
        var room = context.CurrentRoom;

        if (player == null || room == null)
        {
            return CommandResult.Failure("Cannot gather here.");
        }

        // Get harvestable nodes in current room
        var harvestables = _gatheringService.GetHarvestablesInRoom(room.Id);
        if (!harvestables.Any())
        {
            return CommandResult.Failure("There is nothing to gather here.");
        }

        // Determine target node
        HarvestableNodeDisplayDto? targetNode;

        if (args.Length > 0)
        {
            // Target specified - find matching node
            var targetName = string.Join(" ", args).ToLowerInvariant();
            targetNode = FindNodeByName(harvestables, targetName);

            if (targetNode == null)
            {
                return CommandResult.Failure($"Cannot find '{targetName}' to gather.");
            }
        }
        else
        {
            // No target - use selected node from indicators
            targetNode = _harvestableIndicators.GetSelectedNode();

            if (targetNode == null)
            {
                // Default to first available node
                targetNode = harvestables.FirstOrDefault(h => h.IsAvailable);
            }

            if (targetNode == null)
            {
                return CommandResult.Failure("No harvestable resources available.");
            }
        }

        // Check if gathering is possible
        if (!_gatheringService.CanGather(player, targetNode.NodeId))
        {
            return CommandResult.Failure($"You cannot gather {targetNode.Name} right now.");
        }

        // Get skill modifier
        var skillModifier = _gatheringService.GetGatheringSkill(player, targetNode.RequiredSkill);

        // Show dice check
        var checkDisplay = new GatheringCheckDisplayDto(
            NodeId: targetNode.NodeId,
            NodeName: targetNode.Name,
            SkillName: targetNode.RequiredSkill,
            DifficultyClass: targetNode.DifficultyClass,
            SkillModifier: skillModifier);

        _gatheringDisplay.ShowDiceCheck(checkDisplay);

        // Optional: Animate gathering
        _gatheringDisplay.AnimateGathering();

        // Perform gathering
        var result = _gatheringService.Gather(player, targetNode.NodeId);

        // Show result
        var resultDto = new GatheringResultDto(
            Success: result.Success,
            RawRoll: result.Roll.RawRoll,
            Modifier: result.Roll.Modifier,
            Total: result.Roll.Total,
            DifficultyClass: targetNode.DifficultyClass);

        _gatheringDisplay.ShowResult(resultDto);

        // Show yield on success
        if (result.Success && result.Yield.Any())
        {
            var yieldDtos = result.Yield.Select(y => new GatheredResourceDto(
                ResourceId: y.ResourceId,
                ResourceName: y.ResourceName,
                ResourceType: MapToResourceCategory(y.ResourceTypeId),
                Quantity: y.Quantity));

            _gatheringDisplay.ShowYield(yieldDtos);
        }
        else if (!result.Success)
        {
            _gatheringDisplay.ShowYield(Enumerable.Empty<GatheredResourceDto>());
        }

        _logger.LogInformation(
            "Player gathered {NodeName}: {Result}",
            targetNode.Name,
            result.Success ? "SUCCESS" : "FAILED");

        return CommandResult.Success();
    }

    private HarvestableNodeDisplayDto? FindNodeByName(
        IEnumerable<HarvestableNodeDisplayDto> nodes,
        string targetName)
    {
        return nodes.FirstOrDefault(n =>
            n.Name.ToLowerInvariant().Contains(targetName) ||
            n.NodeId.ToLowerInvariant() == targetName);
    }

    private static ResourceCategory MapToResourceCategory(string resourceTypeId)
    {
        return resourceTypeId?.ToLowerInvariant() switch
        {
            "ore" => ResourceCategory.Ore,
            "herb" => ResourceCategory.Herb,
            "leather" => ResourceCategory.Leather,
            "gem" => ResourceCategory.Gem,
            _ => ResourceCategory.Misc
        };
    }
}
```

**Command Usage:**
- `gather` - Gather from selected/first available node
- `gather herbs` - Gather from node matching "herbs"
- `gather mushrooms` - Gather from node matching "mushrooms"
- `g` or `harvest` - Aliases for gather

---

## 8. Data Model Changes

### 8.1 New DTOs

**File:** `src/Presentation/RuneAndRust.Presentation.Tui/DTOs/GatheringDisplayDtos.cs`

```csharp
namespace RuneAndRust.Presentation.Tui.DTOs;

/// <summary>
/// Data transfer object for harvestable node display.
/// </summary>
/// <param name="NodeId">The unique node identifier.</param>
/// <param name="Name">The display name of the node.</param>
/// <param name="ResourceTypeId">The resource type identifier.</param>
/// <param name="ResourceType">The resource category for display.</param>
/// <param name="Quantity">The available quantity.</param>
/// <param name="DifficultyClass">The gathering DC.</param>
/// <param name="RequiredSkill">The skill required for gathering.</param>
/// <param name="IsAvailable">Whether the node can be gathered.</param>
public record HarvestableNodeDisplayDto(
    string NodeId,
    string Name,
    string ResourceTypeId,
    ResourceCategory ResourceType,
    int Quantity,
    int DifficultyClass,
    string RequiredSkill,
    bool IsAvailable);

/// <summary>
/// Data transfer object for gathering check display.
/// </summary>
/// <param name="NodeId">The target node identifier.</param>
/// <param name="NodeName">The node name for display.</param>
/// <param name="SkillName">The skill being checked.</param>
/// <param name="DifficultyClass">The gathering DC.</param>
/// <param name="SkillModifier">The player's skill modifier.</param>
public record GatheringCheckDisplayDto(
    string NodeId,
    string NodeName,
    string SkillName,
    int DifficultyClass,
    int SkillModifier);

/// <summary>
/// Data transfer object for gathering result display.
/// </summary>
/// <param name="Success">Whether the gathering succeeded.</param>
/// <param name="RawRoll">The raw dice roll value.</param>
/// <param name="Modifier">The skill modifier applied.</param>
/// <param name="Total">The total check result.</param>
/// <param name="DifficultyClass">The DC that was checked against.</param>
public record GatheringResultDto(
    bool Success,
    int RawRoll,
    int Modifier,
    int Total,
    int DifficultyClass);

/// <summary>
/// Data transfer object for gathered resource display.
/// </summary>
/// <param name="ResourceId">The resource identifier.</param>
/// <param name="ResourceName">The display name of the resource.</param>
/// <param name="ResourceType">The resource category.</param>
/// <param name="Quantity">The quantity gathered.</param>
public record GatheredResourceDto(
    string ResourceId,
    string ResourceName,
    ResourceCategory ResourceType,
    int Quantity);
```

---

## 9. Configuration File Schemas

### 9.1 gathering-display.json

**File:** `config/gathering-display.json`

```json
{
  "$schema": "./schemas/gathering-display.schema.json",
  "indicatorWidth": 60,
  "indicatorHeight": 10,
  "displayWidth": 50,
  "displayHeight": 12,
  "maxVisibleNodes": 5,
  "animationDelayMs": 300,
  "selectionColor": "Cyan",
  "difficultyColor": "Yellow",
  "promptColor": "Green",
  "headerColor": "White",
  "successColor": "Green",
  "failureColor": "Red"
}
```

### 9.2 gathering-display.schema.json

**File:** `config/schemas/gathering-display.schema.json`

```json
{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "gathering-display.schema.json",
  "title": "Gathering Display Configuration",
  "description": "Configuration for gathering display components",
  "type": "object",
  "properties": {
    "indicatorWidth": {
      "type": "integer",
      "description": "Width of the harvestable indicators section",
      "minimum": 40,
      "maximum": 100,
      "default": 60
    },
    "indicatorHeight": {
      "type": "integer",
      "description": "Height of the harvestable indicators section",
      "minimum": 5,
      "maximum": 20,
      "default": 10
    },
    "displayWidth": {
      "type": "integer",
      "description": "Width of the gathering display",
      "minimum": 40,
      "maximum": 80,
      "default": 50
    },
    "displayHeight": {
      "type": "integer",
      "description": "Height of the gathering display",
      "minimum": 8,
      "maximum": 20,
      "default": 12
    },
    "maxVisibleNodes": {
      "type": "integer",
      "description": "Maximum harvestable nodes visible at once",
      "minimum": 3,
      "maximum": 10,
      "default": 5
    },
    "animationDelayMs": {
      "type": "integer",
      "description": "Delay between animation frames in milliseconds",
      "minimum": 100,
      "maximum": 1000,
      "default": 300
    },
    "selectionColor": {
      "$ref": "#/$defs/consoleColor",
      "default": "Cyan"
    },
    "difficultyColor": {
      "$ref": "#/$defs/consoleColor",
      "default": "Yellow"
    },
    "promptColor": {
      "$ref": "#/$defs/consoleColor",
      "default": "Green"
    },
    "headerColor": {
      "$ref": "#/$defs/consoleColor",
      "default": "White"
    },
    "successColor": {
      "$ref": "#/$defs/consoleColor",
      "default": "Green"
    },
    "failureColor": {
      "$ref": "#/$defs/consoleColor",
      "default": "Red"
    }
  },
  "$defs": {
    "consoleColor": {
      "type": "string",
      "enum": [
        "Black", "DarkBlue", "DarkGreen", "DarkCyan",
        "DarkRed", "DarkMagenta", "DarkYellow", "Gray",
        "DarkGray", "Blue", "Green", "Cyan",
        "Red", "Magenta", "Yellow", "White"
      ]
    }
  },
  "additionalProperties": false
}
```

### 9.3 Configuration Class

**File:** `src/Presentation/RuneAndRust.Presentation.Tui/Configuration/GatheringDisplayConfig.cs`

```csharp
namespace RuneAndRust.Presentation.Tui.Configuration;

/// <summary>
/// Configuration for gathering display components.
/// </summary>
public class GatheringDisplayConfig
{
    /// <summary>Width of the harvestable indicators section.</summary>
    public int IndicatorWidth { get; set; } = 60;

    /// <summary>Height of the harvestable indicators section.</summary>
    public int IndicatorHeight { get; set; } = 10;

    /// <summary>Width of the gathering display.</summary>
    public int DisplayWidth { get; set; } = 50;

    /// <summary>Height of the gathering display.</summary>
    public int DisplayHeight { get; set; } = 12;

    /// <summary>Maximum harvestable nodes visible at once.</summary>
    public int MaxVisibleNodes { get; set; } = 5;

    /// <summary>Delay between animation frames in milliseconds.</summary>
    public int AnimationDelayMs { get; set; } = 300;

    /// <summary>Color for selected nodes.</summary>
    public ConsoleColor SelectionColor { get; set; } = ConsoleColor.Cyan;

    /// <summary>Color for difficulty class display.</summary>
    public ConsoleColor DifficultyColor { get; set; } = ConsoleColor.Yellow;

    /// <summary>Color for gather prompts.</summary>
    public ConsoleColor PromptColor { get; set; } = ConsoleColor.Green;

    /// <summary>Color for headers.</summary>
    public ConsoleColor HeaderColor { get; set; } = ConsoleColor.White;

    /// <summary>Color for success indicators.</summary>
    public ConsoleColor SuccessColor { get; set; } = ConsoleColor.Green;

    /// <summary>Color for failure indicators.</summary>
    public ConsoleColor FailureColor { get; set; } = ConsoleColor.Red;
}
```

---

## 10. RoomView Integration

### 10.1 Integration Points

**File:** `src/Presentation/RuneAndRust.Presentation.Tui/Views/RoomView.cs` (modifications)

```csharp
// Add to RoomView class

private readonly HarvestableIndicators _harvestableIndicators;
private readonly GatheringDisplay _gatheringDisplay;
private readonly IGatheringService _gatheringService;

/// <summary>
/// Shows harvestable resources in the room.
/// </summary>
private void ShowHarvestables()
{
    var room = _gameState.CurrentRoom;
    if (room == null)
    {
        return;
    }

    // Get harvestable nodes in room
    var nodes = _gatheringService.GetHarvestablesInRoom(room.Id);

    if (!nodes.Any())
    {
        _harvestableIndicators.Hide();
        return;
    }

    // Convert to display DTOs
    var displayDtos = nodes.Select(n => new HarvestableNodeDisplayDto(
        NodeId: n.Id,
        Name: n.Name,
        ResourceTypeId: n.ResourceTypeId,
        ResourceType: MapToResourceCategory(n.ResourceType),
        Quantity: n.Quantity,
        DifficultyClass: n.DifficultyClass,
        RequiredSkill: n.RequiredSkill,
        IsAvailable: n.IsAvailable
    )).ToList();

    // Render indicators
    _harvestableIndicators.SetPosition(_config.HarvestableX, _config.HarvestableY);
    _harvestableIndicators.RenderHarvestables(displayDtos);

    _logger.LogDebug("Showed {Count} harvestable nodes in room", displayDtos.Count);
}

/// <summary>
/// Handles gather action from room view.
/// </summary>
/// <param name="key">The pressed key.</param>
/// <returns>True if the input was handled.</returns>
private bool HandleGatherInput(ConsoleKey key)
{
    if (key != ConsoleKey.G)
    {
        return false;
    }

    if (!_harvestableIndicators.IsVisible)
    {
        return false;
    }

    var selectedNode = _harvestableIndicators.GetSelectedNode();
    if (selectedNode == null)
    {
        return false;
    }

    // Execute gather command
    var command = new GatherCommand(
        _gatheringService,
        _harvestableIndicators,
        _gatheringDisplay,
        _logger);

    var context = new CommandContext(
        Player: _gameState.CurrentPlayer,
        CurrentRoom: _gameState.CurrentRoom);

    command.Execute(new[] { selectedNode.NodeId }, context);

    return true;
}

/// <summary>
/// Maps a resource type string to ResourceCategory enum.
/// </summary>
private static ResourceCategory MapToResourceCategory(string resourceType)
{
    return resourceType?.ToLowerInvariant() switch
    {
        "ore" => ResourceCategory.Ore,
        "herb" => ResourceCategory.Herb,
        "leather" => ResourceCategory.Leather,
        "gem" => ResourceCategory.Gem,
        _ => ResourceCategory.Misc
    };
}
```

### 10.2 Key Handling

**Room View Keys for Gathering:**
- `↑`/`↓` or `W`/`S` - Navigate between harvestable nodes
- `G` - Gather from selected node
- `Esc` - Deselect/return to room navigation

---

## 11. Logging Specifications

### 11.1 Log Levels by Component

| Component | Level | Events |
|-----------|-------|--------|
| `HarvestableIndicators` | Information | Indicators shown |
| `HarvestableIndicators` | Debug | Node rendering, selection changes |
| `HarvestableIndicators` | Warning | No harvestables available |
| `GatheringDisplay` | Information | Gathering result |
| `GatheringDisplay` | Debug | Dice check shown, yield displayed |
| `DiceCheckRenderer` | Debug | Roll formatting |
| `GatherCommand` | Information | Gather executed |
| `GatherCommand` | Debug | Target selection |
| `GatherCommand` | Warning | Invalid target, cannot gather |
| `RoomView` | Debug | Harvestables shown |

### 11.2 Log Message Examples

```
[INF] HarvestableIndicators: Rendered 3 harvestable indicators
[DBG] HarvestableIndicators: Highlighted node at index 1
[DBG] HarvestableIndicators: Showed gather prompt for node: Healing Herbs
[WRN] HarvestableIndicators: No harvestables available in room
[DBG] GatheringDisplay: Showed dice check for Healing Herbs, DC 10
[INF] GatheringDisplay: Gathering result: SUCCESS, Roll 17 vs DC 10
[DBG] GatheringDisplay: Showed yield with 1 resource types
[INF] GatherCommand: Player gathered Healing Herbs: SUCCESS
[DBG] GatherCommand: Target selection: herbs -> Healing Herbs
[WRN] GatherCommand: Cannot find 'mushrooms' to gather
[DBG] RoomView: Showed 2 harvestable nodes in room
```

---

## 12. Unit Testing Requirements

### 12.1 Test Count by Feature

| Feature | Test Count |
|---------|------------|
| DiceCheckRenderer | ~2 |
| HarvestableIndicators | ~2 |
| GatherCommand | ~1 |
| **Total** | **~5** |

### 12.2 Test Specifications

**File:** `tests/RuneAndRust.Presentation.Tui.Tests/Renderers/DiceCheckRendererTests.cs`

```csharp
[TestFixture]
public class DiceCheckRendererTests
{
    private GatheringDisplayConfig _config;
    private DiceCheckRenderer _renderer;

    [SetUp]
    public void Setup()
    {
        _config = new GatheringDisplayConfig();
        _renderer = new DiceCheckRenderer(_config);
    }

    [Test]
    [TestCase(14, 3, 17, "[14] + 3 = 17")]
    [TestCase(8, -2, 6, "[8] - 2 = 6")]
    [TestCase(20, 0, 20, "[20] + 0 = 20")]
    [TestCase(1, 5, 6, "[1] + 5 = 6")]
    public void FormatRoll_WithValues_ReturnsCorrectFormat(
        int rawRoll, int modifier, int total, string expected)
    {
        // Act
        var result = _renderer.FormatRoll(rawRoll, modifier, total);

        // Assert
        Assert.That(result, Is.EqualTo(expected));
    }

    [Test]
    [TestCase(true, "[x] SUCCESS!")]
    [TestCase(false, "[ ] FAILED")]
    public void FormatResult_WithSuccess_ReturnsCorrectIndicator(
        bool success, string expected)
    {
        // Act
        var result = _renderer.FormatResult(success);

        // Assert
        Assert.That(result, Is.EqualTo(expected));
    }
}
```

**File:** `tests/RuneAndRust.Presentation.Tui.Tests/UI/HarvestableIndicatorsTests.cs`

```csharp
[TestFixture]
public class HarvestableIndicatorsTests
{
    private Mock<ResourceStackRenderer> _mockStackRenderer;
    private Mock<ITerminalService> _mockTerminal;
    private Mock<ILogger<HarvestableIndicators>> _mockLogger;
    private GatheringDisplayConfig _config;
    private HarvestableIndicators _indicators;

    [SetUp]
    public void Setup()
    {
        _config = new GatheringDisplayConfig();
        var resourceConfig = new ResourcePanelConfig();
        _mockStackRenderer = new Mock<ResourceStackRenderer>(resourceConfig);
        _mockTerminal = new Mock<ITerminalService>();
        _mockLogger = new Mock<ILogger<HarvestableIndicators>>();

        _mockStackRenderer.Setup(r => r.GetTypeIcon(It.IsAny<ResourceCategory>()))
            .Returns("[X]");
        _mockStackRenderer.Setup(r => r.GetTypeColor(It.IsAny<ResourceCategory>()))
            .Returns(ConsoleColor.White);

        _indicators = new HarvestableIndicators(
            _mockStackRenderer.Object,
            _mockTerminal.Object,
            _config,
            _mockLogger.Object);
    }

    [Test]
    public void RenderHarvestables_WithNodes_SetsIsVisibleTrue()
    {
        // Arrange
        var nodes = new List<HarvestableNodeDisplayDto>
        {
            CreateNodeDto("herbs", "Healing Herbs", ResourceCategory.Herb, true)
        };

        _indicators.SetPosition(0, 0);

        // Act
        _indicators.RenderHarvestables(nodes);

        // Assert
        Assert.That(_indicators.IsVisible, Is.True);
    }

    [Test]
    public void RenderHarvestables_WithNoAvailableNodes_SetsIsVisibleFalse()
    {
        // Arrange
        var nodes = new List<HarvestableNodeDisplayDto>
        {
            CreateNodeDto("herbs", "Healing Herbs", ResourceCategory.Herb, false)
        };

        _indicators.SetPosition(0, 0);

        // Act
        _indicators.RenderHarvestables(nodes);

        // Assert
        Assert.That(_indicators.IsVisible, Is.False);
    }

    #region Test Helpers

    private static HarvestableNodeDisplayDto CreateNodeDto(
        string id, string name, ResourceCategory type, bool available)
    {
        return new HarvestableNodeDisplayDto(
            NodeId: id,
            Name: name,
            ResourceTypeId: type.ToString().ToLower(),
            ResourceType: type,
            Quantity: 3,
            DifficultyClass: 10,
            RequiredSkill: "Herbalism",
            IsAvailable: available);
    }

    #endregion
}
```

**File:** `tests/RuneAndRust.Presentation.Tui.Tests/Commands/GatherCommandTests.cs`

```csharp
[TestFixture]
public class GatherCommandTests
{
    private Mock<IGatheringService> _mockGatheringService;
    private Mock<HarvestableIndicators> _mockIndicators;
    private Mock<GatheringDisplay> _mockDisplay;
    private Mock<ILogger<GatherCommand>> _mockLogger;
    private GatherCommand _command;

    [SetUp]
    public void Setup()
    {
        _mockGatheringService = new Mock<IGatheringService>();
        _mockIndicators = new Mock<HarvestableIndicators>();
        _mockDisplay = new Mock<GatheringDisplay>();
        _mockLogger = new Mock<ILogger<GatherCommand>>();

        _command = new GatherCommand(
            _mockGatheringService.Object,
            _mockIndicators.Object,
            _mockDisplay.Object,
            _mockLogger.Object);
    }

    [Test]
    public void Execute_WithNoHarvestables_ReturnsFailure()
    {
        // Arrange
        var context = CreateContext();
        _mockGatheringService.Setup(s => s.GetHarvestablesInRoom(It.IsAny<string>()))
            .Returns(new List<HarvestableNode>());

        // Act
        var result = _command.Execute(Array.Empty<string>(), context);

        // Assert
        Assert.That(result.IsSuccess, Is.False);
        Assert.That(result.Message, Does.Contain("nothing to gather"));
    }

    #region Test Helpers

    private static CommandContext CreateContext()
    {
        return new CommandContext(
            Player: CreateTestPlayer(),
            CurrentRoom: CreateTestRoom());
    }

    private static Player CreateTestPlayer()
    {
        // Return mock player
        return Player.Create("test-player", "Test Player");
    }

    private static Room CreateTestRoom()
    {
        // Return mock room
        return Room.Create("test-room", "Test Room", "A test room.");
    }

    #endregion
}
```

---

## 13. Use Cases

### UC-001: View Harvestables in Room

**Actor:** Player
**Flow:** Enter room → See harvestable resources section → View nodes with type icons, quantities, and DC → Understand gathering options

### UC-002: Gather Specific Resource

**Actor:** Player
**Flow:** Enter room with harvestables → Type "gather herbs" → See dice check display → See roll result → Receive resources on success

### UC-003: Navigate and Gather Selected Node

**Actor:** Player
**Flow:** View harvestable indicators → Press ↓ to select node → Press [G] to gather → See dice check and result → Receive yield on success

### UC-004: Failed Gathering Attempt

**Actor:** Player
**Flow:** Attempt to gather → Roll fails DC → See "[ ] FAILED" indicator → See "No resources gathered" message → Node may still be available

### UC-005: View Gathering Skill Check

**Actor:** Player
**Flow:** Initiate gather → See skill name and DC → See dice roll breakdown → See modifiers applied → Understand check mechanics

---

## 14. Deliverable Checklist

### UI Components
- [ ] `HarvestableIndicators` class implemented
- [ ] `RenderHarvestables()` method renders nodes
- [ ] `GetNodeIcon()` returns correct icons
- [ ] `ShowGatherPrompt()` displays prompt
- [ ] `HighlightSelected()` highlights node
- [ ] Navigation methods (`SelectNext()`, `SelectPrevious()`)
- [ ] `GatheringDisplay` class implemented
- [ ] `ShowDiceCheck()` displays skill check
- [ ] `ShowResult()` displays roll result
- [ ] `ShowYield()` displays gathered resources
- [ ] `AnimateGathering()` shows gathering animation

### Renderers
- [ ] `DiceCheckRenderer` class implemented
- [ ] `FormatRoll()` formats roll breakdown
- [ ] `FormatModifiers()` formats modifier list
- [ ] `FormatDC()` formats difficulty display
- [ ] `FormatResult()` formats success/failure

### Commands
- [ ] `GatherCommand` class implemented
- [ ] Target selection logic
- [ ] Skill check execution
- [ ] Result handling

### DTOs
- [ ] `HarvestableNodeDisplayDto` record created
- [ ] `GatheringCheckDisplayDto` record created
- [ ] `GatheringResultDto` record created
- [ ] `GatheredResourceDto` record created

### Configuration
- [ ] `GatheringDisplayConfig` class created
- [ ] `config/gathering-display.json` created
- [ ] `config/schemas/gathering-display.schema.json` created

### View Integration
- [ ] `RoomView` updated with `ShowHarvestables()`
- [ ] Harvestable indicators integration
- [ ] Gather key handling ([G])
- [ ] Node navigation handling

### Testing
- [ ] ~5 unit tests implemented
- [ ] All tests passing

---

## 15. Acceptance Criteria

### Functional
- [ ] Harvestable indicators show in rooms with harvestable resources
- [ ] Harvestable nodes display resource type icon correctly
- [ ] DC (difficulty class) displays for each node
- [ ] Gathering dice check displays roll breakdown
- [ ] Roll modifiers display correctly
- [ ] Success/failure result shows with `[x]`/`[ ]` indicator
- [ ] Yield display shows gathered resources on success
- [ ] "No resources gathered" shows on failure
- [ ] Gather command works with and without target specification
- [ ] Node navigation with arrow keys works

### Quality
- [ ] Build succeeds with 0 errors/warnings
- [ ] All ~5 unit tests pass
- [ ] Configuration file validates against schema
- [ ] XML documentation complete on all public members
- [ ] No hardcoded values (all configurable)

---

## 16. Dependencies

### Required from v0.11.x

| Type | Location | Usage in v0.13.3d |
|------|----------|-------------------|
| `IGatheringService` | `Application/Interfaces/` | Get harvestables, perform gathering |
| `IDiceService` | `Application/Interfaces/` | Dice roll operations |
| `IResourceService` | `Application/Interfaces/` | Add gathered resources |
| `HarvestableNode` | `Domain/Entities/` | Harvestable node data |
| `GatheringResult` | `Domain/ValueObjects/` | Gathering outcome |
| `DiceRoll` | `Domain/ValueObjects/` | Roll data |

### Required from v0.13.3a

| Type | Location | Usage in v0.13.3d |
|------|----------|-------------------|
| `ResourceCategory` enum | `Presentation.Tui/DTOs/` | Resource type categorization |
| `ResourceStackRenderer` | `Presentation.Tui/Renderers/` | Type icons and colors |

### Required from Existing Infrastructure

| Type | Location | Usage in v0.13.3d |
|------|----------|-------------------|
| `ITerminalService` | `Presentation.Tui/Services/` | Terminal output |
| `RoomView` | `Presentation.Tui/Views/` | Integration point |
| `Player` | `Domain/Entities/` | Player data |
| `Room` | `Domain/Entities/` | Room data |

### Completes v0.13.3

| Part | Status |
|------|--------|
| v0.13.3a Resource Inventory Panel | Complete |
| v0.13.3b Crafting Station Interface | Complete |
| v0.13.3c Recipe Browser & Details | Complete |
| v0.13.3d Gathering Display | **This version** |

---

## 17. Future Considerations

### Out of Scope

- **Gathering Skill Progression**: Experience gain from gathering
- **Critical Gather Success**: Bonus yield on natural 20
- **Rare Resource Discovery**: Random rare drops
- **Tool Requirements**: Specific tools for gathering types
- **Gathering Speed Modifiers**: Faster gathering with skills
- **Node Respawn Timer Display**: Show when nodes will respawn
- **Multi-node Gathering**: Gather from multiple nodes at once
- **Gathering Recipes**: Combine gathered resources immediately

### Potential Enhancements (Future Versions)

- **Gathering Mini-game**: Interactive gathering mechanics
- **Resource Quality Tiers**: Quality affects crafting outcomes
- **Gathering Buffs**: Temporary bonuses from consumables
- **Node Tracking**: Mark nodes on map
- **Gathering Log**: History of gathered resources
- **Seasonal Resources**: Time-limited harvestables

### v0.13.3 Complete

With v0.13.3d complete, the full v0.13.3 Crafting UI subsystem provides:
- Resource inventory display (v0.13.3a)
- Crafting station interaction (v0.13.3b)
- Recipe browsing and discovery (v0.13.3c)
- Gathering visualization (v0.13.3d)

All components integrate with existing services from v0.11.x and use consistent UI patterns for resource display, indicators, and progress feedback.

---

*Document Version: 1.0*
*Last Updated: 2026-01-16*
*Author: Claude (AI Assistant)*
