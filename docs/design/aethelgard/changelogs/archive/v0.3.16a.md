> **Archived** - This changelog has been consolidated. See the complete version at [v0.3.16](../v0.3.x/v0.3.16.md).

# Changelog: v0.3.16a - The Safety Net (Global Exception Handler)

**Release Date:** 2025-12-25
**Total Tests:** 10 new tests added (CrashServiceTests)
**Test Results:** 2725 passing (excluding PostgreSQL integration tests requiring database)
**New CrashService Tests:** 10/10 passing

## Table of Contents

- [Summary](#summary)
- [Architecture & Data Flow](#architecture--data-flow)
- [New Files Created](#new-files-created)
- [Files Modified](#files-modified)
- [Code Implementation Details](#code-implementation-details)
  - [ICrashService Interface](#icrashservice-interface)
  - [CrashReport Record](#crashreport-record)
  - [CrashService Implementation](#crashservice-implementation)
  - [CrashScreenRenderer](#crashscreenrenderer)
  - [Program.cs Exception Handler](#programcs-exception-handler)
- [Crash Report Format](#crash-report-format)
- [Decision Trees](#decision-trees)
- [Logging Matrix](#logging-matrix)
- [Test Coverage](#test-coverage)
- [Manual QA Checklist](#manual-qa-checklist)
- [Design Decisions](#design-decisions)
- [Directory Structure](#directory-structure)
- [Related Specifications](#related-specifications)
- [Next Steps](#next-steps)
- [Credits](#credits)

---

## Summary

Version 0.3.16a implements **The Safety Net** - a global exception handler that intercepts unhandled exceptions, writes detailed crash logs to `logs/crashes/`, and displays a user-friendly "Red Screen of Death" using Spectre.Console. This is Part A of the v0.3.16 "The Sentinel" stability and recovery update.

**Patterns Introduced:**
- **Global Exception Handler Pattern:** Top-level catch block with exception filter
- **Manual Service Instantiation Pattern:** CrashService bypasses DI when container may be unavailable
- **Static Renderer Pattern:** CrashScreenRenderer is static since it has no dependencies
- **Fallback Logger Pattern:** Uses NullLogger when Serilog infrastructure unavailable
- **Graceful Shutdown Pattern:** OperationCanceledException excluded to allow Ctrl+C

**Layers Touched:**
- **Core Layer:** `ICrashService` interface, `CrashReport` DTO record
- **Engine Layer:** `CrashService` implementation with file I/O and formatting
- **Terminal Layer:** `CrashScreenRenderer` static class, `Program.cs` catch block
- **Test Layer:** 10 unit tests in `CrashServiceTests.cs`

**Key Metrics:**
- 5 new files created
- 1 file modified (Program.cs)
- 10 new unit tests
- 0 regressions
- 100% test pass rate for CrashService tests

---

## Architecture & Data Flow

```
┌─────────────────────────────────────────────────────────────────────────┐
│                          Program.Main()                                  │
│                                                                          │
│  try {                                                                   │
│      // Normal application flow                                          │
│      host.Build();                                                       │
│      game.StartAsync();                                                  │
│  }                                                                       │
│  catch (Exception ex) when (ex is not OperationCanceledException) {     │
│      │                                                                   │
│      ▼                                                                   │
│  ┌───────────────────────────────────────────────────────────────────┐  │
│  │  CRASH RECOVERY SEQUENCE                                          │  │
│  │                                                                   │  │
│  │  1. Instantiate CrashService (manual, no DI)                     │  │
│  │     └─> new CrashService(NullLogger<CrashService>.Instance)      │  │
│  │                                                                   │  │
│  │  2. Log crash to file                                            │  │
│  │     └─> CrashService.LogCrash(ex)                                │  │
│  │         ├─> Directory.CreateDirectory("logs/crashes")            │  │
│  │         ├─> Build CrashReport DTO                                │  │
│  │         ├─> FormatReport() → human-readable text                 │  │
│  │         └─> File.WriteAllText() → crash_YYYYMMDD_HHmmss.txt      │  │
│  │                                                                   │  │
│  │  3. Render crash screen                                          │  │
│  │     └─> CrashScreenRenderer.Render(ex, logPath)                  │  │
│  │         ├─> AnsiConsole.Clear()                                  │  │
│  │         ├─> Build Spectre.Console Panel (red border)             │  │
│  │         ├─> Display exception details                            │  │
│  │         ├─> Show crash log path                                  │  │
│  │         ├─> Show GitHub issues link                              │  │
│  │         └─> Console.ReadLine() → wait for ENTER                  │  │
│  │                                                                   │  │
│  │  4. Log to Serilog (if available)                                │  │
│  │     └─> Log.Fatal(ex, "System Crash")                            │  │
│  └───────────────────────────────────────────────────────────────────┘  │
│  }                                                                       │
│  finally {                                                               │
│      Log.CloseAndFlush();                                               │
│  }                                                                       │
└─────────────────────────────────────────────────────────────────────────┘
```

---

## New Files Created

| File | Purpose | Lines |
|------|---------|-------|
| `RuneAndRust.Core/Interfaces/ICrashService.cs` | Interface for crash handling service | 26 |
| `RuneAndRust.Core/Models/CrashReport.cs` | DTO record for crash diagnostic data | 51 |
| `RuneAndRust.Engine/Services/CrashService.cs` | Crash logging and report generation | 122 |
| `RuneAndRust.Terminal/Rendering/CrashScreenRenderer.cs` | Spectre.Console "Red Screen of Death" UI | 85 |
| `RuneAndRust.Tests/Engine/CrashServiceTests.cs` | Unit tests for CrashService | 227 |

---

## Files Modified

| File | Change | Lines Affected |
|------|--------|----------------|
| `RuneAndRust.Terminal/Program.cs` | Enhanced catch block with crash recovery sequence | 428-450 |

---

## Code Implementation Details

### ICrashService Interface

**File:** `RuneAndRust.Core/Interfaces/ICrashService.cs`

```csharp
namespace RuneAndRust.Core.Interfaces;

/// <summary>
/// Service for handling critical application failures (v0.3.16a).
/// Provides crash logging and report generation when unhandled exceptions occur.
/// </summary>
/// <remarks>See: SPEC-CRASH-001 for Crash Handling System design.</remarks>
public interface ICrashService
{
    /// <summary>
    /// Logs a crash to the crash log directory.
    /// Creates a timestamped crash report file with exception details,
    /// stack trace, and system information.
    /// </summary>
    /// <param name="ex">The exception that caused the crash.</param>
    /// <returns>The path to the generated crash log file.</returns>
    string LogCrash(Exception ex);

    /// <summary>
    /// Generates the file path for a crash report based on timestamp.
    /// </summary>
    /// <param name="timestamp">The time of the crash.</param>
    /// <returns>The full path for the crash log file.</returns>
    string GenerateReportPath(DateTime timestamp);
}
```

**Design Notes:**
- Interface allows for future mock implementations in tests
- `GenerateReportPath` exposed for testability (path format validation)
- Returns path to enable UI to display location to user

---

### CrashReport Record

**File:** `RuneAndRust.Core/Models/CrashReport.cs`

```csharp
namespace RuneAndRust.Core.Models;

/// <summary>
/// Data Transfer Object for crash report data (v0.3.16a).
/// Captures diagnostic information when a critical exception occurs.
/// Used by CrashService to generate human-readable crash log files.
/// </summary>
public record CrashReport
{
    /// <summary>Timestamp when the crash occurred.</summary>
    public DateTime Timestamp { get; init; }

    /// <summary>The fully qualified type name of the exception.</summary>
    public string ExceptionType { get; init; } = string.Empty;

    /// <summary>The exception message describing what went wrong.</summary>
    public string Message { get; init; } = string.Empty;

    /// <summary>The full stack trace showing the call hierarchy at crash.</summary>
    public string StackTrace { get; init; } = string.Empty;

    /// <summary>Inner exception details as formatted string, if any.</summary>
    public string? InnerException { get; init; }

    /// <summary>Application version at time of crash (e.g., "v0.3.16a").</summary>
    public string GameVersion { get; init; } = string.Empty;

    /// <summary>Operating system description from Environment.OSVersion.</summary>
    public string OperatingSystem { get; init; } = string.Empty;

    /// <summary>.NET runtime version from Environment.Version.</summary>
    public string RuntimeVersion { get; init; } = string.Empty;
}
```

**Design Notes:**
- Uses C# 9 record with `init` properties for immutability
- Default empty strings prevent null reference issues in formatting
- Inner exception is nullable (not all exceptions have inner exceptions)

---

### CrashService Implementation

**File:** `RuneAndRust.Engine/Services/CrashService.cs`

```csharp
public class CrashService : ICrashService
{
    private readonly ILogger<CrashService> _logger;
    private const string CrashDirectory = "logs/crashes";
    private const string GameVersion = "v0.3.16a";

    public CrashService(ILogger<CrashService> logger) => _logger = logger;

    public string GenerateReportPath(DateTime timestamp)
        => Path.Combine(CrashDirectory, $"crash_{timestamp:yyyyMMdd_HHmmss}.txt");

    public string LogCrash(Exception ex)
    {
        _logger.LogTrace("[CRASH] LogCrash invoked for {ExType}", ex.GetType().Name);

        // Ensure crash directory exists
        Directory.CreateDirectory(CrashDirectory);

        // Build crash report DTO
        var report = new CrashReport
        {
            Timestamp = DateTime.Now,
            ExceptionType = ex.GetType().FullName ?? ex.GetType().Name,
            Message = ex.Message,
            StackTrace = ex.StackTrace ?? "No stack trace available.",
            InnerException = ex.InnerException?.ToString(),
            GameVersion = GameVersion,
            OperatingSystem = Environment.OSVersion.ToString(),
            RuntimeVersion = Environment.Version.ToString()
        };

        // Generate file path and write report
        var path = GenerateReportPath(report.Timestamp);
        var content = FormatReport(report);
        File.WriteAllText(path, content);

        _logger.LogInformation("[CRASH] Crash report written to {Path}", path);
        return path;
    }

    private static string FormatReport(CrashReport report)
    {
        var sb = new StringBuilder();

        // Header
        sb.AppendLine("═══════════════════════════════════════════════════════════════════════════════");
        sb.AppendLine("                         RUNE & RUST CRASH REPORT");
        sb.AppendLine("═══════════════════════════════════════════════════════════════════════════════");
        sb.AppendLine();

        // System Information
        sb.AppendLine($"Timestamp:      {report.Timestamp:yyyy-MM-dd HH:mm:ss}");
        sb.AppendLine($"Game Version:   {report.GameVersion}");
        sb.AppendLine($"OS:             {report.OperatingSystem}");
        sb.AppendLine($".NET Runtime:   {report.RuntimeVersion}");
        sb.AppendLine();

        // Exception Details
        sb.AppendLine("───────────────────────────────────────────────────────────────────────────────");
        sb.AppendLine("EXCEPTION DETAILS");
        sb.AppendLine("───────────────────────────────────────────────────────────────────────────────");
        sb.AppendLine();
        sb.AppendLine($"Type:    {report.ExceptionType}");
        sb.AppendLine($"Message: {report.Message}");
        sb.AppendLine();

        // Stack Trace
        sb.AppendLine("STACK TRACE:");
        sb.AppendLine("─────────────");
        sb.AppendLine(report.StackTrace);

        // Inner Exception (if present)
        if (!string.IsNullOrEmpty(report.InnerException))
        {
            sb.AppendLine();
            sb.AppendLine("───────────────────────────────────────────────────────────────────────────────");
            sb.AppendLine("INNER EXCEPTION");
            sb.AppendLine("───────────────────────────────────────────────────────────────────────────────");
            sb.AppendLine();
            sb.AppendLine(report.InnerException);
        }

        // Footer
        sb.AppendLine();
        sb.AppendLine("═══════════════════════════════════════════════════════════════════════════════");
        sb.AppendLine("Please report this issue at:");
        sb.AppendLine("https://github.com/southpawriter02/rune-rust/issues");
        sb.AppendLine("═══════════════════════════════════════════════════════════════════════════════");

        return sb.ToString();
    }
}
```

**Design Notes:**
- Uses StringBuilder for efficient string concatenation
- Directory.CreateDirectory is idempotent (safe to call multiple times)
- Timestamp format `yyyyMMdd_HHmmss` ensures unique filenames and chronological sorting
- GitHub issues URL included in footer for user convenience

---

### CrashScreenRenderer

**File:** `RuneAndRust.Terminal/Rendering/CrashScreenRenderer.cs`

```csharp
using Spectre.Console;
using Spectre.Console.Rendering;

namespace RuneAndRust.Terminal.Rendering;

/// <summary>
/// Renders the "Red Screen of Death" when a critical error occurs (v0.3.16a).
/// Uses Spectre.Console for styled terminal output.
/// Part of "The Safety Net" crash recovery system.
/// </summary>
/// <remarks>
/// This is a static class because it must function when the DI container
/// may not be available (e.g., if the host failed to build).
/// </remarks>
public static class CrashScreenRenderer
{
    public static void Render(Exception ex, string? logPath = null)
    {
        AnsiConsole.Clear();

        // Build the panel content
        var rows = new List<IRenderable>
        {
            new Markup("[bold white]A critical error has occurred.[/]"),
            new Text(""),
            new Markup($"[bold red]{Markup.Escape(ex.GetType().Name)}[/]"),
            new Markup($"[italic grey]{Markup.Escape(TruncateMessage(ex.Message))}[/]"),
            new Text("")
        };

        // Add crash log path or fallback message
        if (!string.IsNullOrEmpty(logPath))
        {
            rows.Add(new Markup($"[grey]Crash report saved to:[/]"));
            rows.Add(new Markup($"[dim]{Markup.Escape(logPath)}[/]"));
        }
        else
        {
            rows.Add(new Markup("[yellow]Unable to save crash report.[/]"));
        }

        rows.Add(new Text(""));
        rows.Add(new Markup("[dim]Please report this issue at:[/]"));
        rows.Add(new Markup("[blue link]https://github.com/southpawriter02/rune-rust/issues[/]"));

        // Create the error panel
        var panel = new Panel(new Rows(rows))
        {
            Header = new PanelHeader(" [bold white on red] SYSTEM FAILURE [/] ", Justify.Center),
            Border = BoxBorder.Double,
            BorderStyle = new Style(Color.Red),
            Padding = new Padding(2, 1)
        };

        AnsiConsole.Write(panel);
        AnsiConsole.WriteLine();
        AnsiConsole.MarkupLine("[grey]Press [bold]ENTER[/] to exit...[/]");

        // Wait for user acknowledgement
        Console.ReadLine();
    }

    private static string TruncateMessage(string message, int maxLength = 200)
    {
        if (string.IsNullOrEmpty(message))
            return "(No message provided)";

        if (message.Length <= maxLength)
            return message;

        return message[..(maxLength - 3)] + "...";
    }
}
```

**Design Notes:**
- Static class since no dependencies needed
- Uses `Markup.Escape()` to prevent formatting injection from exception messages
- Truncates long messages to prevent display issues
- Double-border box with red styling for visual impact
- Console.ReadLine() ensures user sees the screen before exit

---

### Program.cs Exception Handler

**File:** `RuneAndRust.Terminal/Program.cs` (lines 428-450)

```csharp
catch (Exception ex) when (ex is not OperationCanceledException)
{
    // v0.3.16a: The Safety Net - Global Exception Handler
    // 1. Attempt to log crash details to file
    string? logPath = null;
    try
    {
        // Manually instantiate CrashService since DI container may not be available
        var crashService = new CrashService(
            Microsoft.Extensions.Logging.Abstractions.NullLogger<CrashService>.Instance);
        logPath = crashService.LogCrash(ex);
    }
    catch
    {
        // Swallow - don't crash the crash handler
    }

    // 2. Render user-friendly crash screen
    CrashScreenRenderer.Render(ex, logPath);

    // 3. Log to Serilog if still available
    Log.Fatal(ex, "System Crash");
}
finally
{
    Log.CloseAndFlush();
}
```

**Design Notes:**
- Exception filter `when (ex is not OperationCanceledException)` allows graceful Ctrl+C
- Manual instantiation bypasses DI which may not be available
- NullLogger from Microsoft.Extensions.Logging.Abstractions used as fallback
- Inner try/catch prevents crash handler from crashing
- Serilog Log.Fatal() still called for logging infrastructure if available

---

## Crash Report Format

Example crash report file (`logs/crashes/crash_20251225_143045.txt`):

```
═══════════════════════════════════════════════════════════════════════════════
                         RUNE & RUST CRASH REPORT
═══════════════════════════════════════════════════════════════════════════════

Timestamp:      2025-12-25 14:30:45
Game Version:   v0.3.16a
OS:             Unix 15.3.0
.NET Runtime:   9.0.10

───────────────────────────────────────────────────────────────────────────────
EXCEPTION DETAILS
───────────────────────────────────────────────────────────────────────────────

Type:    System.NullReferenceException
Message: Object reference not set to an instance of an object.

STACK TRACE:
─────────────
   at RuneAndRust.Engine.Services.GameService.ProcessTurnAsync() in /src/GameService.cs:line 142
   at RuneAndRust.Engine.Services.GameService.StartAsync() in /src/GameService.cs:line 98
   at Program.Main(String[] args) in /src/Program.cs:line 426

═══════════════════════════════════════════════════════════════════════════════
Please report this issue at:
https://github.com/southpawriter02/rune-rust/issues
═══════════════════════════════════════════════════════════════════════════════
```

---

## Decision Trees

### Exception Handler Logic

```
Exception Thrown
       │
       ▼
┌──────────────────────────┐
│ Is OperationCanceled-    │
│ Exception?               │
└──────────────────────────┘
       │
   ┌───┴───┐
   │ YES   │ NO
   ▼       ▼
┌─────┐  ┌────────────────────┐
│PASS │  │ Enter Crash Handler│
│(Ctrl│  │                    │
│+C)  │  └────────────────────┘
└─────┘           │
                  ▼
         ┌───────────────────┐
         │ Try: Instantiate  │
         │ CrashService      │
         └───────────────────┘
                  │
              ┌───┴───┐
          SUCCESS  FAIL
              │       │
              ▼       ▼
         ┌────────┐ ┌────────┐
         │LogCrash│ │logPath │
         │ → path │ │= null  │
         └────────┘ └────────┘
              │       │
              └───┬───┘
                  │
                  ▼
         ┌───────────────────┐
         │ CrashScreenRenderer│
         │ .Render(ex, path) │
         └───────────────────┘
                  │
                  ▼
         ┌───────────────────┐
         │ Log.Fatal(ex,     │
         │ "System Crash")   │
         └───────────────────┘
                  │
                  ▼
         ┌───────────────────┐
         │ finally:          │
         │ Log.CloseAndFlush │
         └───────────────────┘
```

---

## Logging Matrix

| Component | Event | Level | Message Template | Properties |
|-----------|-------|-------|------------------|------------|
| CrashService | Invoked | Trace | "[CRASH] LogCrash invoked for {ExType}" | ExType |
| CrashService | Written | Information | "[CRASH] Crash report written to {Path}" | Path |
| Program | Crash | Fatal | "System Crash" | (exception) |

---

## Test Coverage

### CrashServiceTests (10 tests)

| Test Name | Purpose | Status |
|-----------|---------|--------|
| `GenerateReportPath_CreatesValidFilename` | Verifies filename format `crash_YYYYMMDD_HHmmss.txt` | ✅ Pass |
| `GenerateReportPath_PadsZeros_ForSingleDigitValues` | Verifies zero-padding for dates like `01/05 09:03:07` | ✅ Pass |
| `LogCrash_CreatesDirectory_IfMissing` | Verifies `logs/crashes/` created if not exists | ✅ Pass |
| `LogCrash_WritesFile_WithExceptionDetails` | Verifies file contains exception type and message | ✅ Pass |
| `LogCrash_IncludesSystemInfo` | Verifies version, OS, and runtime in report | ✅ Pass |
| `LogCrash_HandlesNestedExceptions` | Verifies inner exception included in report | ✅ Pass |
| `LogCrash_ReturnsValidPath` | Verifies returned path is in correct directory | ✅ Pass |
| `LogCrash_IncludesStackTrace` | Verifies stack trace included when exception thrown | ✅ Pass |
| `LogCrash_IncludesReportingUrl` | Verifies GitHub issues URL in footer | ✅ Pass |
| `LogCrash_HandlesNullStackTrace` | Verifies "No stack trace available." fallback | ✅ Pass |

**Test Execution:**
```bash
dotnet test --filter "FullyQualifiedName~CrashService"

Test Run Successful.
Total tests: 10
     Passed: 10
 Total time: 0.48 Seconds
```

---

## Manual QA Checklist

- [ ] Sabotage Test: Add `throw new Exception("Test crash");` after host build
- [ ] Verify crash screen appears with red border
- [ ] Verify exception type and message displayed
- [ ] Verify crash log file created in `logs/crashes/`
- [ ] Verify crash log contains system information
- [ ] Verify GitHub issues link displayed
- [ ] Verify ENTER key dismisses screen
- [ ] Verify Ctrl+C still exits gracefully (no crash screen)
- [ ] Remove sabotage code after testing

---

## Design Decisions

### 1. CrashService Instantiated Manually

**Decision:** Create CrashService with `new` instead of DI

**Rationale:** The DI container may not be available during a crash:
- Host building could have failed
- Container may be in an inconsistent state
- Startup exceptions occur before container is built

**Fallback:** NullLogger used when full logging infrastructure unavailable

### 2. OperationCanceledException Excluded

**Decision:** Use exception filter `when (ex is not OperationCanceledException)`

**Rationale:** Allow graceful Ctrl+C shutdown:
- Users expect Ctrl+C to exit cleanly
- CancellationToken propagates as OperationCanceledException
- No crash screen needed for intentional cancellation

### 3. CrashScreenRenderer is Static

**Decision:** Make CrashScreenRenderer a static class

**Rationale:** No dependencies needed:
- Uses only Spectre.Console (static API)
- Console I/O is inherently static
- Simpler invocation from catch block

### 4. Crash Logs in Separate Directory

**Decision:** Use `logs/crashes/` separate from `logs/`

**Rationale:** Easy identification:
- Crash logs distinct from normal application logs
- Simple to collect for bug reports
- Prevents crash logs from being rotated with daily logs

### 5. Human-Readable Report Format

**Decision:** Use ASCII art box-drawing characters

**Rationale:** Maximum compatibility:
- Works in all terminals
- Copy-pasteable to GitHub issues
- Readable without special tools

---

## Directory Structure

```
RuneAndRust/
├── RuneAndRust.Core/
│   ├── Interfaces/
│   │   └── ICrashService.cs          # NEW: Crash handling interface
│   └── Models/
│       └── CrashReport.cs            # NEW: Crash data DTO record
│
├── RuneAndRust.Engine/
│   └── Services/
│       └── CrashService.cs           # NEW: Crash logging implementation
│
├── RuneAndRust.Terminal/
│   ├── Program.cs                    # MODIFIED: Enhanced catch block
│   └── Rendering/
│       └── CrashScreenRenderer.cs    # NEW: Spectre.Console crash UI
│
├── RuneAndRust.Tests/
│   └── Engine/
│       └── CrashServiceTests.cs      # NEW: 10 unit tests
│
└── logs/
    └── crashes/                       # NEW: Crash report output directory
        └── crash_20251225_143045.txt  # Example crash report
```

---

## Related Specifications

| Specification | Status | Description |
|---------------|--------|-------------|
| SPEC-CRASH-001 | To Be Created | Crash Handling System design specification |

---

## Next Steps

**v0.3.16b "The Black Box"** (Emergency Save):
- Implement emergency autosave trigger before crash screen
- Save game state to `data/emergency_save.json`
- Add recovery prompt on next startup
- Integrate with existing SaveGameService

---

## Credits

- **Implementation:** Claude Code (The Architect)
- **Framework:** Spectre.Console for terminal UI
- **Testing:** xUnit + FluentAssertions + NSubstitute
- **Version:** v0.3.16a "The Safety Net"

---

## Verification Results

```
Build: Succeeded (0 errors, 0 warnings)
Tests: 10/10 CrashService tests passing
Total: 2725 tests passing (excluding PostgreSQL integration tests)
Regressions: 0
```
