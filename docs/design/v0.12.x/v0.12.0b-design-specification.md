# v0.12.0b Design Specification: Dice Roll History

**Version:** 0.12.0b
**Parent:** v0.12.0 (Statistics System)
**Prerequisites:** v0.12.0a Complete (Core Statistics)
**Status:** Design Complete

---

## Table of Contents

1. [Executive Summary](#1-executive-summary)
2. [Feature Overview](#2-feature-overview)
3. [Architecture Diagrams](#3-architecture-diagrams)
4. [DiceRollRecord Record](#4-dicerollrecord-record)
5. [DiceRollHistory Entity](#5-dicerollhistory-entity)
6. [LuckRating Enum](#6-luckrating-enum)
7. [DiceStatistics Record](#7-dicestatistics-record)
8. [IDiceHistoryService Interface](#8-idicehistoryservice-interface)
9. [DiceHistoryService Implementation](#9-dicehistoryservice-implementation)
10. [DiceService Integration](#10-diceservice-integration)
11. [Logging Specifications](#11-logging-specifications)
12. [Unit Testing Requirements](#12-unit-testing-requirements)
13. [Use Cases](#13-use-cases)
14. [Deliverable Checklist](#14-deliverable-checklist)
15. [Acceptance Criteria](#15-acceptance-criteria)
16. [Dependencies](#16-dependencies)
17. [Future Considerations](#17-future-considerations)

---

## 1. Executive Summary

### Overview

Version 0.12.0b implements dice roll history tracking for the Statistics System. This includes the `DiceRollHistory` entity that tracks all dice rolls, natural 20/1 counts, average calculations, and streak detection. The luck rating calculation provides a fun meta-game element showing players whether they've been "blessed" or "cursed" by the dice gods. Roll history persists with character saves and integrates with the existing DiceService.

### Key Deliverables

| Category | Items |
|----------|-------|
| **Domain Entities** | DiceRollHistory |
| **Domain Records** | DiceRollRecord |
| **Application Enums** | LuckRating |
| **Application Records** | DiceStatistics |
| **Interfaces** | IDiceHistoryService |
| **Services** | DiceHistoryService |
| **Service Updates** | DiceService integration |
| **Tests** | ~11 new unit tests |

### Architectural Significance

This version establishes the **Roll Recording Pattern** for tracking dice outcomes:
- Automatic roll recording via DiceService integration
- Streak detection based on above/below average threshold
- Luck rating calculation from deviation from expected average
- Recent rolls buffer for display in statistics view
- Natural 20/1 tracking for critical hit/miss statistics

---

## 2. Feature Overview

```
v0.12.0b Dice Roll History Features
â”œâ”€â”€ DiceRollRecord Record
â”‚   â”œâ”€â”€ DiceExpression (e.g., "1d20", "2d6+3")
â”‚   â”œâ”€â”€ Result (final total)
â”‚   â”œâ”€â”€ IndividualRolls (each die result)
â”‚   â”œâ”€â”€ WasCritical flag
â”‚   â”œâ”€â”€ Context (attack, skill check, etc.)
â”‚   â””â”€â”€ RolledAt timestamp
â”œâ”€â”€ DiceRollHistory Entity
â”‚   â”œâ”€â”€ Roll Counts
â”‚   â”‚   â”œâ”€â”€ TotalRolls
â”‚   â”‚   â”œâ”€â”€ TotalNaturalTwenties
â”‚   â”‚   â”œâ”€â”€ TotalNaturalOnes
â”‚   â”‚   â”œâ”€â”€ D20RollCount
â”‚   â”‚   â””â”€â”€ D20RollSum
â”‚   â”œâ”€â”€ Streak Tracking
â”‚   â”‚   â”œâ”€â”€ CurrentStreak (+ lucky, - unlucky)
â”‚   â”‚   â”œâ”€â”€ LongestLuckyStreak
â”‚   â”‚   â”œâ”€â”€ LongestUnluckyStreak
â”‚   â”‚   â””â”€â”€ LongestNat20Streak
â”‚   â”œâ”€â”€ Recent Rolls Buffer (last 20)
â”‚   â””â”€â”€ Calculated Methods
â”‚       â”œâ”€â”€ GetAverageD20Roll()
â”‚       â”œâ”€â”€ GetNat20Rate()
â”‚       â”œâ”€â”€ GetNat1Rate()
â”‚       â””â”€â”€ GetLuckPercentage()
â”œâ”€â”€ LuckRating Enum
â”‚   â”œâ”€â”€ Cursed (< -10%)
â”‚   â”œâ”€â”€ Unlucky (-10% to -5%)
â”‚   â”œâ”€â”€ Average (-5% to +5%)
â”‚   â”œâ”€â”€ Lucky (+5% to +10%)
â”‚   â””â”€â”€ Blessed (> +10%)
â”œâ”€â”€ IDiceHistoryService Interface
â”‚   â”œâ”€â”€ RecordRoll method
â”‚   â”œâ”€â”€ GetHistory method
â”‚   â”œâ”€â”€ GetLuckRating method
â”‚   â”œâ”€â”€ GetCurrentStreak method
â”‚   â”œâ”€â”€ GetRecentRolls method
â”‚   â””â”€â”€ GetStatistics method
â”œâ”€â”€ DiceHistoryService Implementation
â”‚   â”œâ”€â”€ Roll recording logic
â”‚   â”œâ”€â”€ Streak calculation
â”‚   â”œâ”€â”€ Luck rating determination
â”‚   â””â”€â”€ Statistics aggregation
â””â”€â”€ DiceService Integration
    â””â”€â”€ Automatic roll recording
```

---

## 3. Architecture Diagrams

### 3.1 Dice History Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    DICE HISTORY ARCHITECTURE                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

                        PRESENTATION LAYER
                        â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

                  (Statistics View - v0.12.0c)
                           â”‚
                           â”‚ queries
                           â–¼

                        APPLICATION LAYER
                        â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

     DiceService                          DiceHistoryService
     â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                          â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
     â”‚      DiceService      â”‚           â”‚   IDiceHistoryService     â”‚
     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤           â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
     â”‚ + Roll(expression)    â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚ + RecordRoll(player, rec) â”‚
     â”‚ + RollD20()           â”‚  records  â”‚ + GetHistory(player)      â”‚
     â”‚ + RollWithAdvantage() â”‚           â”‚ + GetLuckRating(player)   â”‚
     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚ + GetCurrentStreak(player)â”‚
                                         â”‚ + GetRecentRolls(player)  â”‚
                                         â”‚ + GetStatistics(player)   â”‚
                                         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                                         â”‚
                                         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                         â”‚   DiceHistoryService      â”‚
                                         â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
                                         â”‚ Dependencies:             â”‚
                                         â”‚ - ILogger                 â”‚
                                         â”‚                           â”‚
                                         â”‚ Methods:                  â”‚
                                         â”‚ + RecordRoll()            â”‚
                                         â”‚ + CalculateLuckRating()   â”‚
                                         â”‚ + GetOrCreateHistory()    â”‚
                                         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                                         â”‚ updates
                                                         â–¼

                          DOMAIN LAYER
                          â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚                      DiceRollHistory                             â”‚
    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
    â”‚ Roll Counts:                  â”‚ Streak Tracking:                 â”‚
    â”‚ - TotalRolls                  â”‚ - CurrentStreak                  â”‚
    â”‚ - TotalNaturalTwenties        â”‚ - LongestLuckyStreak             â”‚
    â”‚ - TotalNaturalOnes            â”‚ - LongestUnluckyStreak           â”‚
    â”‚ - D20RollCount                â”‚ - LongestNat20Streak             â”‚
    â”‚ - D20RollSum                  â”‚                                  â”‚
    â”‚                               â”‚ Recent Rolls:                    â”‚
    â”‚                               â”‚ - Queue<DiceRollRecord> (max 20) â”‚
    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
    â”‚ + RecordRoll(record)          â”‚ + GetAverageD20Roll()            â”‚
    â”‚ + UpdateStreak(aboveAverage)  â”‚ + GetNat20Rate()                 â”‚
    â”‚                               â”‚ + GetNat1Rate()                  â”‚
    â”‚                               â”‚ + GetLuckPercentage()            â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚     DiceRollRecord        â”‚   â”‚          LuckRating               â”‚
    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
    â”‚ + DiceExpression          â”‚   â”‚ Cursed     (< -10%)               â”‚
    â”‚ + Result                  â”‚   â”‚ Unlucky    (-10% to -5%)          â”‚
    â”‚ + IndividualRolls[]       â”‚   â”‚ Average    (-5% to +5%)           â”‚
    â”‚ + WasCritical             â”‚   â”‚ Lucky      (+5% to +10%)          â”‚
    â”‚ + Context                 â”‚   â”‚ Blessed    (> +10%)               â”‚
    â”‚ + RolledAt                â”‚   â”‚                                   â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3.2 Roll Recording Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      ROLL RECORDING FLOW                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

    Game Action: Attack Roll
           â”‚
           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    STEP 1: DICE SERVICE                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  DiceService.Roll("1d20")                                           â”‚
â”‚  - Generates random result: 18                                       â”‚
â”‚  - Creates DiceRollRecord with context                               â”‚
â”‚  - Calls DiceHistoryService.RecordRoll()                            â”‚
â”‚  - Returns result to caller                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    STEP 2: DICE HISTORY SERVICE                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  DiceHistoryService.RecordRoll(player, record)                       â”‚
â”‚  - Gets or creates DiceRollHistory for player                        â”‚
â”‚  - Passes record to DiceRollHistory.RecordRoll()                     â”‚
â”‚  - Logs roll details at Debug level                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    STEP 3: DICE ROLL HISTORY                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  DiceRollHistory.RecordRoll(record)                                  â”‚
â”‚                                                                      â”‚
â”‚  1. Increment TotalRolls                                             â”‚
â”‚                                                                      â”‚
â”‚  2. If 1d20 roll:                                                    â”‚
â”‚     - D20RollCount++                                                 â”‚
â”‚     - D20RollSum += result                                           â”‚
â”‚     - Check for natural 20 â†’ TotalNaturalTwenties++                 â”‚
â”‚     - Check for natural 1 â†’ TotalNaturalOnes++                      â”‚
â”‚     - UpdateStreak(result >= 11)                                     â”‚
â”‚                                                                      â”‚
â”‚  3. Add to recent rolls queue (max 20)                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    STEP 4: STREAK UPDATE                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  UpdateStreak(wasAboveAverage: true)    // Roll was 18, >= 11       â”‚
â”‚                                                                      â”‚
â”‚  CurrentStreak was +2 (two above-average rolls)                      â”‚
â”‚  â†’ CurrentStreak = +3                                                â”‚
â”‚  â†’ LongestLuckyStreak = Max(7, 3) = 7 (unchanged)                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3.3 Streak Detection Algorithm

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      STREAK DETECTION ALGORITHM                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

    THRESHOLD: d20 average = 10.5, so:
    - Roll >= 11: Above average (lucky)
    - Roll <  11: Below average (unlucky)


    EXAMPLE SEQUENCE
    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    Roll Sequence: 18, 14, 12, 3, 20, 8, 15, 11, 19, 7

    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ Roll â”‚  18 â”‚  14 â”‚  12 â”‚   3 â”‚  20 â”‚   8 â”‚  15 â”‚  11 â”‚  19 â”‚  7â”‚
    â”œâ”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”¤
    â”‚ >=11 â”‚  âœ“  â”‚  âœ“  â”‚  âœ“  â”‚     â”‚  âœ“  â”‚     â”‚  âœ“  â”‚  âœ“  â”‚  âœ“  â”‚   â”‚
    â”‚ <11  â”‚     â”‚     â”‚     â”‚  âœ“  â”‚     â”‚  âœ“  â”‚     â”‚     â”‚     â”‚ âœ“ â”‚
    â”œâ”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”¤
    â”‚Streakâ”‚  +1 â”‚  +2 â”‚  +3 â”‚  -1 â”‚  +1 â”‚  -1 â”‚  +1 â”‚  +2 â”‚  +3 â”‚ -1â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


    STREAK UPDATE LOGIC
    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ wasAboveAverage = (roll >= 11)                                   â”‚
    â”‚                                                                  â”‚
    â”‚ if (wasAboveAverage)                                             â”‚
    â”‚ {                                                                â”‚
    â”‚     // Continue or start lucky streak                            â”‚
    â”‚     CurrentStreak = CurrentStreak >= 0                           â”‚
    â”‚         ? CurrentStreak + 1   // Continue streak                 â”‚
    â”‚         : 1;                  // Reset, start new                â”‚
    â”‚                                                                  â”‚
    â”‚     // Update record                                             â”‚
    â”‚     LongestLuckyStreak = Max(LongestLuckyStreak, CurrentStreak); â”‚
    â”‚ }                                                                â”‚
    â”‚ else                                                             â”‚
    â”‚ {                                                                â”‚
    â”‚     // Continue or start unlucky streak                          â”‚
    â”‚     CurrentStreak = CurrentStreak <= 0                           â”‚
    â”‚         ? CurrentStreak - 1   // Continue streak                 â”‚
    â”‚         : -1;                 // Reset, start new                â”‚
    â”‚                                                                  â”‚
    â”‚     // Update record (use absolute value)                        â”‚
    â”‚     LongestUnluckyStreak = Max(LongestUnluckyStreak,             â”‚
    â”‚                                Math.Abs(CurrentStreak));         â”‚
    â”‚ }                                                                â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3.4 Luck Rating Calculation

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    LUCK RATING CALCULATION                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

    FORMULA
    â”€â”€â”€â”€â”€â”€â”€

    Luck % = ((ActualAverage - ExpectedAverage) / ExpectedAverage) Ã— 100

    Where:
    - ActualAverage = D20RollSum / D20RollCount
    - ExpectedAverage = 10.5 (for d20)


    EXAMPLE
    â”€â”€â”€â”€â”€â”€â”€

    Player has rolled 523 d20s with a sum of 5858

    ActualAverage = 5858 / 523 = 11.2
    Luck % = ((11.2 - 10.5) / 10.5) Ã— 100
           = (0.7 / 10.5) Ã— 100
           = 6.67%

    â†’ Lucky (+5% to +10% range)


    THRESHOLDS
    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ Luck Rating â”‚ Range              â”‚ Display                     â”‚
    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
    â”‚ Cursed      â”‚ < -10%             â”‚ ğŸ˜¢ CURSED                   â”‚
    â”‚ Unlucky     â”‚ -10% to -5%        â”‚ ğŸ˜Ÿ Unlucky                  â”‚
    â”‚ Average     â”‚ -5% to +5%         â”‚ ğŸ˜ Average                  â”‚
    â”‚ Lucky       â”‚ +5% to +10%        â”‚ ğŸ€ Lucky                    â”‚
    â”‚ Blessed     â”‚ > +10%             â”‚ ğŸŒŸ BLESSED                  â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


    DETERMINATION LOGIC
    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ luckPercentage = GetLuckPercentage();                           â”‚
    â”‚                                                                  â”‚
    â”‚ return luckPercentage switch                                     â”‚
    â”‚ {                                                                â”‚
    â”‚     < -10.0 => LuckRating.Cursed,                               â”‚
    â”‚     < -5.0  => LuckRating.Unlucky,                              â”‚
    â”‚     <= 5.0  => LuckRating.Average,                              â”‚
    â”‚     <= 10.0 => LuckRating.Lucky,                                â”‚
    â”‚     _       => LuckRating.Blessed                                â”‚
    â”‚ };                                                               â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3.5 Clean Architecture Layer Diagram

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      CLEAN ARCHITECTURE LAYERS                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚                      PRESENTATION LAYER                          â”‚
    â”‚                                                                  â”‚
    â”‚  (Statistics View - v0.12.0c)                                    â”‚
    â”‚  - Renders dice statistics to player                             â”‚
    â”‚  - Displays luck rating with emoji                               â”‚
    â”‚  - Shows recent rolls and streaks                                â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚
                                    â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚                      APPLICATION LAYER                           â”‚
    â”‚                                                                  â”‚
    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
    â”‚  â”‚  IDiceHistoryService    â”‚  â”‚      DiceStatistics         â”‚   â”‚
    â”‚  â”‚  â€¢ RecordRoll()         â”‚  â”‚      (record)               â”‚   â”‚
    â”‚  â”‚  â€¢ GetHistory()         â”‚  â”‚  - TotalRolls               â”‚   â”‚
    â”‚  â”‚  â€¢ GetLuckRating()      â”‚  â”‚  - TotalNat20s              â”‚   â”‚
    â”‚  â”‚  â€¢ GetCurrentStreak()   â”‚  â”‚  - TotalNat1s               â”‚   â”‚
    â”‚  â”‚  â€¢ GetRecentRolls()     â”‚  â”‚  - AverageD20               â”‚   â”‚
    â”‚  â”‚  â€¢ GetStatistics()      â”‚  â”‚  - LuckPercentage           â”‚   â”‚
    â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  - Rating                   â”‚   â”‚
    â”‚                               â”‚  - CurrentStreak            â”‚   â”‚
    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  - LongestLuckyStreak       â”‚   â”‚
    â”‚  â”‚   DiceHistoryService    â”‚  â”‚  - LongestUnluckyStreak     â”‚   â”‚
    â”‚  â”‚   (implementation)      â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
    â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                    â”‚
    â”‚                               â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
    â”‚                               â”‚       LuckRating            â”‚   â”‚
    â”‚                               â”‚       (enum)                â”‚   â”‚
    â”‚                               â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚
                                    â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚                        DOMAIN LAYER                              â”‚
    â”‚                                                                  â”‚
    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
    â”‚  â”‚    DiceRollHistory      â”‚  â”‚     DiceRollRecord          â”‚   â”‚
    â”‚  â”‚    (entity)             â”‚  â”‚     (record)                â”‚   â”‚
    â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚
                                    â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚                    INFRASTRUCTURE LAYER                          â”‚
    â”‚                                                                  â”‚
    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
    â”‚  â”‚                  DiceService Updates                     â”‚    â”‚
    â”‚  â”‚  - Roll recording integration                            â”‚    â”‚
    â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 4. DiceRollRecord Record

### 4.1 Record Definition

**File:** `src/Core/RuneAndRust.Domain/Records/DiceRollRecord.cs`

```csharp
namespace RuneAndRust.Domain.Records;

/// <summary>
/// Records a single dice roll with all relevant details.
/// </summary>
/// <remarks>
/// <para>This immutable record captures:</para>
/// <list type="bullet">
///   <item><description>The dice expression rolled (e.g., "1d20", "2d6+3")</description></item>
///   <item><description>The final result after modifiers</description></item>
///   <item><description>Individual die results for natural 20/1 detection</description></item>
///   <item><description>Whether the roll included a critical (natural 20 or 1)</description></item>
///   <item><description>The context in which the roll was made</description></item>
///   <item><description>When the roll occurred</description></item>
/// </list>
/// </remarks>
/// <param name="DiceExpression">The dice notation rolled (e.g., "1d20", "2d6+3").</param>
/// <param name="Result">The final result including any modifiers.</param>
/// <param name="IndividualRolls">The result of each individual die rolled.</param>
/// <param name="WasCritical">Whether any die showed a natural 20 or 1.</param>
/// <param name="Context">The context of the roll (e.g., "attack", "skill check", "damage").</param>
/// <param name="RolledAt">The timestamp when the roll occurred.</param>
public record DiceRollRecord(
    string DiceExpression,
    int Result,
    int[] IndividualRolls,
    bool WasCritical,
    string Context,
    DateTime RolledAt)
{
    /// <summary>
    /// Creates a new DiceRollRecord with automatic critical detection and timestamp.
    /// </summary>
    /// <param name="expression">The dice notation rolled.</param>
    /// <param name="result">The final result including modifiers.</param>
    /// <param name="rolls">The individual die results.</param>
    /// <param name="context">The context of the roll.</param>
    /// <returns>A new DiceRollRecord instance.</returns>
    public static DiceRollRecord Create(
        string expression,
        int result,
        int[] rolls,
        string context)
    {
        ArgumentNullException.ThrowIfNull(expression);
        ArgumentNullException.ThrowIfNull(rolls);
        ArgumentNullException.ThrowIfNull(context);

        var wasCritical = rolls.Any(r => r == 20 || r == 1);
        return new DiceRollRecord(
            expression,
            result,
            rolls,
            wasCritical,
            context,
            DateTime.UtcNow);
    }

    /// <summary>
    /// Gets whether this roll included a natural 20.
    /// </summary>
    public bool HasNatural20 => IndividualRolls.Any(r => r == 20);

    /// <summary>
    /// Gets whether this roll included a natural 1.
    /// </summary>
    public bool HasNatural1 => IndividualRolls.Any(r => r == 1);
}
```

---

## 5. DiceRollHistory Entity

### 5.1 Entity Definition

**File:** `src/Core/RuneAndRust.Domain/Entities/DiceRollHistory.cs`

```csharp
namespace RuneAndRust.Domain.Entities;

using RuneAndRust.Domain.Interfaces;
using RuneAndRust.Domain.Records;

/// <summary>
/// Tracks dice roll history and statistics for a player.
/// </summary>
/// <remarks>
/// <para>This entity maintains:</para>
/// <list type="bullet">
///   <item><description>Total roll counts and sums for average calculation</description></item>
///   <item><description>Natural 20 and natural 1 counts</description></item>
///   <item><description>Current and longest streak records</description></item>
///   <item><description>A buffer of recent rolls for display</description></item>
/// </list>
/// <para>Streak tracking uses a threshold of 11+ for "above average" on d20 rolls,
/// based on the expected average of 10.5.</para>
/// </remarks>
public class DiceRollHistory : IEntity
{
    /// <summary>
    /// The maximum number of recent rolls to retain in the buffer.
    /// </summary>
    public const int MaxRecentRolls = 20;

    /// <summary>
    /// The expected average for a d20 roll.
    /// </summary>
    public const double D20ExpectedAverage = 10.5;

    /// <summary>
    /// The threshold for considering a d20 roll "above average" for streak tracking.
    /// Rolls >= 11 are considered above average.
    /// </summary>
    public const int AboveAverageThreshold = 11;

    /// <summary>
    /// Gets the unique identifier for this history record.
    /// </summary>
    public Guid Id { get; private set; }

    /// <summary>
    /// Gets the player ID this history belongs to.
    /// </summary>
    public Guid PlayerId { get; private set; }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // ROLL COUNTS
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    /// <summary>
    /// Gets the total number of dice rolls recorded (all dice types).
    /// </summary>
    public int TotalRolls { get; private set; }

    /// <summary>
    /// Gets the total number of natural 20s rolled on d20s.
    /// </summary>
    public int TotalNaturalTwenties { get; private set; }

    /// <summary>
    /// Gets the total number of natural 1s rolled on d20s.
    /// </summary>
    public int TotalNaturalOnes { get; private set; }

    /// <summary>
    /// Gets the number of d20 rolls (for average calculation).
    /// </summary>
    public int D20RollCount { get; private set; }

    /// <summary>
    /// Gets the sum of all d20 roll results (for average calculation).
    /// </summary>
    public long D20RollSum { get; private set; }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // STREAK TRACKING
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    /// <summary>
    /// Gets the current streak count.
    /// Positive values indicate lucky streaks (consecutive above-average rolls).
    /// Negative values indicate unlucky streaks (consecutive below-average rolls).
    /// </summary>
    public int CurrentStreak { get; private set; }

    /// <summary>
    /// Gets the longest lucky streak recorded.
    /// </summary>
    public int LongestLuckyStreak { get; private set; }

    /// <summary>
    /// Gets the longest unlucky streak recorded.
    /// </summary>
    public int LongestUnluckyStreak { get; private set; }

    /// <summary>
    /// Gets the longest consecutive natural 20 streak.
    /// </summary>
    public int LongestNat20Streak { get; private set; }

    /// <summary>
    /// Gets the current consecutive natural 20 count (for streak tracking).
    /// </summary>
    private int _currentNat20Streak;

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // RECENT ROLLS
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    /// <summary>
    /// The queue of recent rolls, limited to MaxRecentRolls entries.
    /// </summary>
    private readonly Queue<DiceRollRecord> _recentRolls = new();

    /// <summary>
    /// Gets the recent rolls as a read-only list.
    /// </summary>
    public IReadOnlyList<DiceRollRecord> RecentRolls => _recentRolls.ToList();

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // CONSTRUCTORS
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    /// <summary>
    /// Private constructor for EF Core and factory method.
    /// </summary>
    private DiceRollHistory() { }

    /// <summary>
    /// Creates a new DiceRollHistory for a player.
    /// </summary>
    /// <param name="playerId">The ID of the player this history belongs to.</param>
    /// <returns>A new DiceRollHistory instance.</returns>
    public static DiceRollHistory Create(Guid playerId)
    {
        return new DiceRollHistory
        {
            Id = Guid.NewGuid(),
            PlayerId = playerId
        };
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // METHODS
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    /// <summary>
    /// Records a dice roll to the history.
    /// </summary>
    /// <param name="roll">The roll record to add.</param>
    public void RecordRoll(DiceRollRecord roll)
    {
        ArgumentNullException.ThrowIfNull(roll);

        TotalRolls++;

        // Track d20 rolls specifically for averages and streaks
        if (IsD20Roll(roll.DiceExpression))
        {
            D20RollCount++;
            D20RollSum += roll.Result;

            // Natural 20/1 tracking
            if (roll.HasNatural20)
            {
                TotalNaturalTwenties++;
                _currentNat20Streak++;
                LongestNat20Streak = Math.Max(LongestNat20Streak, _currentNat20Streak);
            }
            else
            {
                _currentNat20Streak = 0;
            }

            if (roll.HasNatural1)
            {
                TotalNaturalOnes++;
            }

            // Streak tracking (based on above/below average)
            UpdateStreak(roll.Result >= AboveAverageThreshold);
        }

        // Maintain recent rolls buffer
        _recentRolls.Enqueue(roll);
        while (_recentRolls.Count > MaxRecentRolls)
        {
            _recentRolls.Dequeue();
        }
    }

    /// <summary>
    /// Updates the current streak based on whether the roll was above average.
    /// </summary>
    /// <param name="wasAboveAverage">True if the roll was >= 11.</param>
    private void UpdateStreak(bool wasAboveAverage)
    {
        if (wasAboveAverage)
        {
            // Continue or start lucky streak
            CurrentStreak = CurrentStreak >= 0 ? CurrentStreak + 1 : 1;
            LongestLuckyStreak = Math.Max(LongestLuckyStreak, CurrentStreak);
        }
        else
        {
            // Continue or start unlucky streak
            CurrentStreak = CurrentStreak <= 0 ? CurrentStreak - 1 : -1;
            LongestUnluckyStreak = Math.Max(LongestUnluckyStreak, Math.Abs(CurrentStreak));
        }
    }

    /// <summary>
    /// Determines if a dice expression is a d20 roll.
    /// </summary>
    /// <param name="expression">The dice expression to check.</param>
    /// <returns>True if the expression is a d20 roll.</returns>
    private static bool IsD20Roll(string expression)
    {
        // Match expressions like "1d20", "1d20+5", "d20", etc.
        return expression.StartsWith("1d20", StringComparison.OrdinalIgnoreCase) ||
               expression.StartsWith("d20", StringComparison.OrdinalIgnoreCase);
    }

    /// <summary>
    /// Gets the average d20 roll result.
    /// </summary>
    /// <returns>The average, or the expected average if no rolls recorded.</returns>
    public double GetAverageD20Roll()
    {
        return D20RollCount > 0
            ? (double)D20RollSum / D20RollCount
            : D20ExpectedAverage;
    }

    /// <summary>
    /// Gets the natural 20 rate as a decimal (0.0 to 1.0).
    /// </summary>
    /// <returns>The rate, or expected rate (0.05) if no rolls recorded.</returns>
    public double GetNat20Rate()
    {
        return D20RollCount > 0
            ? (double)TotalNaturalTwenties / D20RollCount
            : 0.05;
    }

    /// <summary>
    /// Gets the natural 1 rate as a decimal (0.0 to 1.0).
    /// </summary>
    /// <returns>The rate, or expected rate (0.05) if no rolls recorded.</returns>
    public double GetNat1Rate()
    {
        return D20RollCount > 0
            ? (double)TotalNaturalOnes / D20RollCount
            : 0.05;
    }

    /// <summary>
    /// Gets the luck percentage, showing deviation from expected average.
    /// </summary>
    /// <returns>
    /// The percentage above or below expected average.
    /// Positive values indicate "lucky", negative values indicate "unlucky".
    /// </returns>
    public double GetLuckPercentage()
    {
        var average = GetAverageD20Roll();
        return ((average - D20ExpectedAverage) / D20ExpectedAverage) * 100;
    }
}
```

---

## 6. LuckRating Enum

### 6.1 Enum Definition

**File:** `src/Core/RuneAndRust.Application/Models/LuckRating.cs`

```csharp
namespace RuneAndRust.Application.Models;

/// <summary>
/// Represents the player's overall luck rating based on dice roll history.
/// </summary>
/// <remarks>
/// <para>Luck rating is calculated from the deviation of the player's actual
/// d20 average from the expected average of 10.5:</para>
/// <list type="bullet">
///   <item><description>Cursed: More than 10% below average</description></item>
///   <item><description>Unlucky: 5-10% below average</description></item>
///   <item><description>Average: Within 5% of expected</description></item>
///   <item><description>Lucky: 5-10% above average</description></item>
///   <item><description>Blessed: More than 10% above average</description></item>
/// </list>
/// </remarks>
public enum LuckRating
{
    /// <summary>
    /// Very unlucky: actual average is more than 10% below expected.
    /// Display: ğŸ˜¢ CURSED
    /// </summary>
    Cursed,

    /// <summary>
    /// Unlucky: actual average is 5-10% below expected.
    /// Display: ğŸ˜Ÿ Unlucky
    /// </summary>
    Unlucky,

    /// <summary>
    /// Average: actual average is within 5% of expected.
    /// Display: ğŸ˜ Average
    /// </summary>
    Average,

    /// <summary>
    /// Lucky: actual average is 5-10% above expected.
    /// Display: ğŸ€ Lucky
    /// </summary>
    Lucky,

    /// <summary>
    /// Very lucky: actual average is more than 10% above expected.
    /// Display: ğŸŒŸ BLESSED
    /// </summary>
    Blessed
}
```

---

## 7. DiceStatistics Record

### 7.1 Record Definition

**File:** `src/Core/RuneAndRust.Application/Models/DiceStatistics.cs`

```csharp
namespace RuneAndRust.Application.Models;

/// <summary>
/// Aggregated dice roll statistics for display in the statistics view.
/// </summary>
/// <remarks>
/// <para>This record provides a snapshot of all dice-related statistics:</para>
/// <list type="bullet">
///   <item><description>Total roll counts and natural 20/1 counts</description></item>
///   <item><description>Actual vs expected averages and rates</description></item>
///   <item><description>Luck percentage and rating</description></item>
///   <item><description>Current and longest streak information</description></item>
/// </list>
/// </remarks>
/// <param name="TotalRolls">Total number of d20 rolls recorded.</param>
/// <param name="TotalNat20s">Total natural 20s rolled.</param>
/// <param name="TotalNat1s">Total natural 1s rolled.</param>
/// <param name="AverageD20">Actual average d20 result.</param>
/// <param name="ExpectedD20">Expected d20 average (10.5).</param>
/// <param name="Nat20Rate">Actual natural 20 rate (0.0 to 1.0).</param>
/// <param name="ExpectedNat20Rate">Expected natural 20 rate (0.05).</param>
/// <param name="Nat1Rate">Actual natural 1 rate (0.0 to 1.0).</param>
/// <param name="ExpectedNat1Rate">Expected natural 1 rate (0.05).</param>
/// <param name="LuckPercentage">Deviation from expected average as percentage.</param>
/// <param name="Rating">Overall luck rating.</param>
/// <param name="CurrentStreak">Current lucky (+) or unlucky (-) streak.</param>
/// <param name="LongestLuckyStreak">Longest recorded lucky streak.</param>
/// <param name="LongestUnluckyStreak">Longest recorded unlucky streak.</param>
public record DiceStatistics(
    int TotalRolls,
    int TotalNat20s,
    int TotalNat1s,
    double AverageD20,
    double ExpectedD20,
    double Nat20Rate,
    double ExpectedNat20Rate,
    double Nat1Rate,
    double ExpectedNat1Rate,
    double LuckPercentage,
    LuckRating Rating,
    int CurrentStreak,
    int LongestLuckyStreak,
    int LongestUnluckyStreak);
```

---

## 8. IDiceHistoryService Interface

### 8.1 Interface Definition

**File:** `src/Core/RuneAndRust.Application/Interfaces/IDiceHistoryService.cs`

```csharp
namespace RuneAndRust.Application.Interfaces;

using RuneAndRust.Application.Models;
using RuneAndRust.Domain.Entities;
using RuneAndRust.Domain.Records;

/// <summary>
/// Service for tracking and querying dice roll history.
/// </summary>
/// <remarks>
/// <para>This service provides methods for:</para>
/// <list type="bullet">
///   <item><description>Recording dice rolls (called by DiceService)</description></item>
///   <item><description>Retrieving roll history for a player</description></item>
///   <item><description>Getting luck rating and streak information</description></item>
///   <item><description>Retrieving recent rolls for display</description></item>
///   <item><description>Getting aggregated dice statistics</description></item>
/// </list>
/// </remarks>
public interface IDiceHistoryService
{
    /// <summary>
    /// Records a dice roll to the player's history.
    /// </summary>
    /// <param name="player">The player who made the roll.</param>
    /// <param name="roll">The roll record to add.</param>
    void RecordRoll(Player player, DiceRollRecord roll);

    /// <summary>
    /// Gets the player's dice roll history entity.
    /// </summary>
    /// <param name="player">The player whose history to retrieve.</param>
    /// <returns>The DiceRollHistory entity.</returns>
    DiceRollHistory GetHistory(Player player);

    /// <summary>
    /// Gets the player's current luck rating.
    /// </summary>
    /// <param name="player">The player whose rating to retrieve.</param>
    /// <returns>The calculated luck rating.</returns>
    LuckRating GetLuckRating(Player player);

    /// <summary>
    /// Gets the player's current streak count.
    /// </summary>
    /// <param name="player">The player whose streak to retrieve.</param>
    /// <returns>
    /// The current streak: positive for lucky streaks, negative for unlucky streaks.
    /// </returns>
    int GetCurrentStreak(Player player);

    /// <summary>
    /// Gets the player's recent rolls.
    /// </summary>
    /// <param name="player">The player whose rolls to retrieve.</param>
    /// <param name="count">Maximum number of rolls to return (default 10).</param>
    /// <returns>The most recent rolls, up to the specified count.</returns>
    IReadOnlyList<DiceRollRecord> GetRecentRolls(Player player, int count = 10);

    /// <summary>
    /// Gets aggregated dice statistics for the player.
    /// </summary>
    /// <param name="player">The player whose statistics to retrieve.</param>
    /// <returns>Aggregated dice statistics including all calculated values.</returns>
    DiceStatistics GetStatistics(Player player);
}
```

---

## 9. DiceHistoryService Implementation

### 9.1 Service Implementation

**File:** `src/Core/RuneAndRust.Application/Services/DiceHistoryService.cs`

```csharp
namespace RuneAndRust.Application.Services;

using Microsoft.Extensions.Logging;
using RuneAndRust.Application.Interfaces;
using RuneAndRust.Application.Models;
using RuneAndRust.Domain.Entities;
using RuneAndRust.Domain.Records;

/// <summary>
/// Service for tracking and querying dice roll history.
/// </summary>
/// <remarks>
/// <para>This service:</para>
/// <list type="bullet">
///   <item><description>Records rolls to the player's DiceRollHistory</description></item>
///   <item><description>Calculates luck ratings from roll averages</description></item>
///   <item><description>Provides streak and statistics information</description></item>
/// </list>
/// </remarks>
public class DiceHistoryService : IDiceHistoryService
{
    private readonly ILogger<DiceHistoryService> _logger;

    /// <summary>
    /// Initializes a new instance of the <see cref="DiceHistoryService"/> class.
    /// </summary>
    /// <param name="logger">Logger instance for diagnostics.</param>
    public DiceHistoryService(ILogger<DiceHistoryService> logger)
    {
        _logger = logger ?? throw new ArgumentNullException(nameof(logger));
    }

    /// <inheritdoc />
    public void RecordRoll(Player player, DiceRollRecord roll)
    {
        ArgumentNullException.ThrowIfNull(player);
        ArgumentNullException.ThrowIfNull(roll);

        var history = GetOrCreateHistory(player);

        _logger.LogDebug(
            "Recording roll: {Expression} = {Result} for player {PlayerId} (context: {Context})",
            roll.DiceExpression,
            roll.Result,
            player.Id,
            roll.Context);

        history.RecordRoll(roll);

        // Log significant events
        if (roll.HasNatural20)
        {
            _logger.LogDebug(
                "Natural 20 rolled by player {PlayerId}! Total nat20s: {Count}",
                player.Id,
                history.TotalNaturalTwenties);
        }
        else if (roll.HasNatural1)
        {
            _logger.LogDebug(
                "Natural 1 rolled by player {PlayerId}. Total nat1s: {Count}",
                player.Id,
                history.TotalNaturalOnes);
        }
    }

    /// <inheritdoc />
    public DiceRollHistory GetHistory(Player player)
    {
        ArgumentNullException.ThrowIfNull(player);
        return GetOrCreateHistory(player);
    }

    /// <inheritdoc />
    public LuckRating GetLuckRating(Player player)
    {
        ArgumentNullException.ThrowIfNull(player);

        var history = GetOrCreateHistory(player);
        var luckPercentage = history.GetLuckPercentage();

        return CalculateLuckRating(luckPercentage);
    }

    /// <inheritdoc />
    public int GetCurrentStreak(Player player)
    {
        ArgumentNullException.ThrowIfNull(player);

        var history = GetOrCreateHistory(player);
        return history.CurrentStreak;
    }

    /// <inheritdoc />
    public IReadOnlyList<DiceRollRecord> GetRecentRolls(Player player, int count = 10)
    {
        ArgumentNullException.ThrowIfNull(player);
        ArgumentOutOfRangeException.ThrowIfNegativeOrZero(count);

        var history = GetOrCreateHistory(player);
        return history.RecentRolls
            .TakeLast(count)
            .ToList();
    }

    /// <inheritdoc />
    public DiceStatistics GetStatistics(Player player)
    {
        ArgumentNullException.ThrowIfNull(player);

        var history = GetOrCreateHistory(player);
        var luckPercentage = history.GetLuckPercentage();

        return new DiceStatistics(
            TotalRolls: history.D20RollCount,
            TotalNat20s: history.TotalNaturalTwenties,
            TotalNat1s: history.TotalNaturalOnes,
            AverageD20: history.GetAverageD20Roll(),
            ExpectedD20: DiceRollHistory.D20ExpectedAverage,
            Nat20Rate: history.GetNat20Rate(),
            ExpectedNat20Rate: 0.05,
            Nat1Rate: history.GetNat1Rate(),
            ExpectedNat1Rate: 0.05,
            LuckPercentage: luckPercentage,
            Rating: CalculateLuckRating(luckPercentage),
            CurrentStreak: history.CurrentStreak,
            LongestLuckyStreak: history.LongestLuckyStreak,
            LongestUnluckyStreak: history.LongestUnluckyStreak);
    }

    /// <summary>
    /// Gets or creates the dice roll history for a player.
    /// </summary>
    /// <param name="player">The player.</param>
    /// <returns>The player's dice roll history.</returns>
    private static DiceRollHistory GetOrCreateHistory(Player player)
    {
        if (player.DiceHistory is null)
        {
            player.InitializeDiceHistory(DiceRollHistory.Create(player.Id));
        }

        return player.DiceHistory!;
    }

    /// <summary>
    /// Calculates the luck rating from a luck percentage.
    /// </summary>
    /// <param name="luckPercentage">The luck percentage.</param>
    /// <returns>The corresponding luck rating.</returns>
    private static LuckRating CalculateLuckRating(double luckPercentage)
    {
        return luckPercentage switch
        {
            < -10.0 => LuckRating.Cursed,
            < -5.0 => LuckRating.Unlucky,
            <= 5.0 => LuckRating.Average,
            <= 10.0 => LuckRating.Lucky,
            _ => LuckRating.Blessed
        };
    }
}
```

---

## 10. DiceService Integration

### 10.1 DiceService Updates

**File:** `src/Core/RuneAndRust.Application/Services/DiceService.cs` (modifications)

```csharp
namespace RuneAndRust.Application.Services;

using Microsoft.Extensions.Logging;
using RuneAndRust.Application.Interfaces;
using RuneAndRust.Domain.Entities;
using RuneAndRust.Domain.Records;

/// <summary>
/// Service for rolling dice with history tracking integration.
/// </summary>
/// <remarks>
/// <para>Updates for v0.12.0b:</para>
/// <list type="bullet">
///   <item><description>Added IDiceHistoryService dependency</description></item>
///   <item><description>Roll methods now record to history when player provided</description></item>
///   <item><description>Context parameter added to specify roll purpose</description></item>
/// </list>
/// </remarks>
public class DiceService : IDiceService
{
    private readonly ILogger<DiceService> _logger;
    private readonly IDiceHistoryService? _historyService;
    private readonly Random _random;

    /// <summary>
    /// Initializes a new instance of the <see cref="DiceService"/> class.
    /// </summary>
    /// <param name="logger">Logger instance for diagnostics.</param>
    /// <param name="historyService">Optional dice history service for recording rolls.</param>
    public DiceService(
        ILogger<DiceService> logger,
        IDiceHistoryService? historyService = null)
    {
        _logger = logger ?? throw new ArgumentNullException(nameof(logger));
        _historyService = historyService;
        _random = new Random();
    }

    /// <summary>
    /// Rolls dice based on the expression and optionally records to history.
    /// </summary>
    /// <param name="expression">Dice expression (e.g., "1d20", "2d6+3").</param>
    /// <param name="player">Optional player to record the roll for.</param>
    /// <param name="context">The context of the roll (e.g., "attack", "skill check").</param>
    /// <returns>The roll result.</returns>
    public DiceRollResult Roll(string expression, Player? player = null, string context = "general")
    {
        var (diceCount, diceSides, modifier) = ParseExpression(expression);

        var rolls = new int[diceCount];
        for (var i = 0; i < diceCount; i++)
        {
            rolls[i] = _random.Next(1, diceSides + 1);
        }

        var total = rolls.Sum() + modifier;

        _logger.LogDebug(
            "Rolled {Expression}: [{Rolls}] + {Modifier} = {Total}",
            expression,
            string.Join(", ", rolls),
            modifier,
            total);

        // Record to history if player provided and history service available
        if (player is not null && _historyService is not null)
        {
            var record = DiceRollRecord.Create(expression, total, rolls, context);
            _historyService.RecordRoll(player, record);
        }

        return new DiceRollResult(total, rolls, modifier);
    }

    /// <summary>
    /// Rolls a d20 and optionally records to history.
    /// </summary>
    /// <param name="player">Optional player to record the roll for.</param>
    /// <param name="context">The context of the roll.</param>
    /// <returns>The d20 result (1-20).</returns>
    public int RollD20(Player? player = null, string context = "d20")
    {
        var result = Roll("1d20", player, context);
        return result.Total;
    }

    /// <summary>
    /// Rolls with advantage (2d20, take higher) and records to history.
    /// </summary>
    /// <param name="player">Optional player to record the roll for.</param>
    /// <param name="context">The context of the roll.</param>
    /// <returns>The higher of two d20 results.</returns>
    public int RollWithAdvantage(Player? player = null, string context = "advantage")
    {
        var roll1 = _random.Next(1, 21);
        var roll2 = _random.Next(1, 21);
        var result = Math.Max(roll1, roll2);

        _logger.LogDebug(
            "Rolled with advantage: [{Roll1}, {Roll2}] = {Result}",
            roll1,
            roll2,
            result);

        // Record the taken roll to history
        if (player is not null && _historyService is not null)
        {
            var record = DiceRollRecord.Create("1d20", result, new[] { result }, context);
            _historyService.RecordRoll(player, record);
        }

        return result;
    }

    /// <summary>
    /// Rolls with disadvantage (2d20, take lower) and records to history.
    /// </summary>
    /// <param name="player">Optional player to record the roll for.</param>
    /// <param name="context">The context of the roll.</param>
    /// <returns>The lower of two d20 results.</returns>
    public int RollWithDisadvantage(Player? player = null, string context = "disadvantage")
    {
        var roll1 = _random.Next(1, 21);
        var roll2 = _random.Next(1, 21);
        var result = Math.Min(roll1, roll2);

        _logger.LogDebug(
            "Rolled with disadvantage: [{Roll1}, {Roll2}] = {Result}",
            roll1,
            roll2,
            result);

        // Record the taken roll to history
        if (player is not null && _historyService is not null)
        {
            var record = DiceRollRecord.Create("1d20", result, new[] { result }, context);
            _historyService.RecordRoll(player, record);
        }

        return result;
    }

    /// <summary>
    /// Parses a dice expression into components.
    /// </summary>
    private static (int count, int sides, int modifier) ParseExpression(string expression)
    {
        // Implementation details...
        // Parse "1d20", "2d6+3", "d20", etc.
        var normalized = expression.ToLowerInvariant().Trim();

        var modifier = 0;
        var plusIndex = normalized.IndexOf('+');
        var minusIndex = normalized.IndexOf('-');

        if (plusIndex > 0)
        {
            modifier = int.Parse(normalized[(plusIndex + 1)..]);
            normalized = normalized[..plusIndex];
        }
        else if (minusIndex > 0)
        {
            modifier = -int.Parse(normalized[(minusIndex + 1)..]);
            normalized = normalized[..minusIndex];
        }

        var dIndex = normalized.IndexOf('d');
        var count = dIndex == 0 ? 1 : int.Parse(normalized[..dIndex]);
        var sides = int.Parse(normalized[(dIndex + 1)..]);

        return (count, sides, modifier);
    }
}

/// <summary>
/// Result of a dice roll operation.
/// </summary>
/// <param name="Total">The total result including modifier.</param>
/// <param name="IndividualRolls">The result of each die.</param>
/// <param name="Modifier">The modifier applied to the roll.</param>
public record DiceRollResult(int Total, int[] IndividualRolls, int Modifier);
```

---

## 11. Logging Specifications

### 11.1 Log Levels by Component

| Component | Level | Events |
|-----------|-------|--------|
| `DiceHistoryService` | Debug | Roll recording, natural 20/1 events |
| `DiceService` | Debug | Roll results, advantage/disadvantage |

### 11.2 Log Message Examples

```csharp
// DiceHistoryService - Debug
_logger.LogDebug(
    "Recording roll: {Expression} = {Result} for player {PlayerId} (context: {Context})",
    roll.DiceExpression, roll.Result, player.Id, roll.Context);

_logger.LogDebug(
    "Natural 20 rolled by player {PlayerId}! Total nat20s: {Count}",
    player.Id, history.TotalNaturalTwenties);

_logger.LogDebug(
    "Natural 1 rolled by player {PlayerId}. Total nat1s: {Count}",
    player.Id, history.TotalNaturalOnes);

// DiceService - Debug
_logger.LogDebug(
    "Rolled {Expression}: [{Rolls}] + {Modifier} = {Total}",
    expression, string.Join(", ", rolls), modifier, total);

_logger.LogDebug(
    "Rolled with advantage: [{Roll1}, {Roll2}] = {Result}",
    roll1, roll2, result);

_logger.LogDebug(
    "Rolled with disadvantage: [{Roll1}, {Roll2}] = {Result}",
    roll1, roll2, result);
```

---

## 12. Unit Testing Requirements

### 12.1 Test Count by Feature

| Feature | Test Count |
|---------|------------|
| DiceRollRecord | 2 |
| DiceRollHistory Entity | 4 |
| DiceHistoryService | 3 |
| LuckRating Calculation | 2 |
| **Total** | **~11** |

### 12.2 Test Specifications

**File:** `tests/RuneAndRust.Tests/Domain/DiceRollRecordTests.cs`

```csharp
[TestFixture]
public class DiceRollRecordTests
{
    [Test]
    public void Create_WithNatural20_SetsWasCriticalTrue();

    [Test]
    public void Create_WithNatural1_SetsWasCriticalTrue();
}
```

**File:** `tests/RuneAndRust.Tests/Domain/DiceRollHistoryTests.cs`

```csharp
[TestFixture]
public class DiceRollHistoryTests
{
    [Test]
    public void RecordRoll_D20Roll_UpdatesCountsAndSum();

    [Test]
    public void RecordRoll_Natural20_IncrementsNat20Count();

    [Test]
    public void RecordRoll_AboveAverage_IncrementsLuckyStreak();

    [Test]
    public void RecordRoll_BelowAverage_IncrementsUnluckyStreak();
}
```

**File:** `tests/RuneAndRust.Tests/Application/DiceHistoryServiceTests.cs`

```csharp
[TestFixture]
public class DiceHistoryServiceTests
{
    [Test]
    public void RecordRoll_AddsToHistory();

    [Test]
    public void GetStatistics_CalculatesCorrectValues();

    [Test]
    public void GetRecentRolls_ReturnsUpToRequestedCount();
}
```

**File:** `tests/RuneAndRust.Tests/Application/LuckRatingTests.cs`

```csharp
[TestFixture]
public class LuckRatingTests
{
    [Test]
    [TestCase(-15.0, LuckRating.Cursed)]
    [TestCase(-7.0, LuckRating.Unlucky)]
    [TestCase(0.0, LuckRating.Average)]
    [TestCase(7.0, LuckRating.Lucky)]
    [TestCase(15.0, LuckRating.Blessed)]
    public void CalculateLuckRating_ReturnsCorrectRating(double percentage, LuckRating expected);

    [Test]
    public void GetLuckPercentage_CalculatesCorrectly();
}
```

---

## 13. Use Cases

### UC-001: Record Dice Roll

**Actor:** System (DiceService)
**Flow:** DiceService.Roll() called â†’ Generate random result â†’ Create DiceRollRecord â†’ Call DiceHistoryService.RecordRoll() â†’ DiceRollHistory.RecordRoll() â†’ TotalRolls incremented â†’ Streak updated

### UC-002: Get Luck Rating

**Actor:** System (StatisticsView)
**Flow:** Stats command issued â†’ GetLuckRating() called â†’ Get average d20 roll â†’ Calculate luck percentage â†’ Determine rating tier â†’ Return LuckRating

### UC-003: Track Lucky Streak

**Actor:** System (DiceRollHistory)
**Flow:** d20 roll recorded â†’ Check if >= 11 â†’ If lucky: increment CurrentStreak â†’ Update LongestLuckyStreak if new record

### UC-004: Track Unlucky Streak

**Actor:** System (DiceRollHistory)
**Flow:** d20 roll recorded â†’ Check if < 11 â†’ If unlucky: decrement CurrentStreak â†’ Update LongestUnluckyStreak if new record

### UC-005: Get Dice Statistics

**Actor:** System (StatisticsView)
**Flow:** GetStatistics() called â†’ Retrieve DiceRollHistory â†’ Calculate all rates and averages â†’ Determine luck rating â†’ Create DiceStatistics record â†’ Return to caller

---

## 14. Deliverable Checklist

### Domain Layer
- [ ] `DiceRollRecord` record created
- [ ] `DiceRollHistory` entity created

### Application Layer
- [ ] `LuckRating` enum created
- [ ] `DiceStatistics` record created
- [ ] `IDiceHistoryService` interface created
- [ ] `DiceHistoryService` implementation created

### Infrastructure Layer
- [ ] `DiceService` updated with history integration
- [ ] `Player` entity updated with DiceHistory property

### Testing
- [ ] ~11 unit tests implemented
- [ ] All tests passing

---

## 15. Acceptance Criteria

### Functional
- [ ] DiceRollHistory tracks all d20 rolls
- [ ] DiceRollHistory tracks total rolls of all types
- [ ] Natural 20 count increments when natural 20 rolled
- [ ] Natural 1 count increments when natural 1 rolled
- [ ] Average d20 roll calculation is correct
- [ ] Streak detection correctly identifies above-average rolls (>= 11)
- [ ] Current streak increments for consecutive lucky rolls
- [ ] Current streak decrements for consecutive unlucky rolls
- [ ] Longest lucky streak updates when current exceeds it
- [ ] Longest unlucky streak updates when current exceeds it
- [ ] Recent rolls buffer maintains maximum of 20 rolls
- [ ] Luck percentage calculation is correct
- [ ] LuckRating thresholds work correctly (Cursed/Unlucky/Average/Lucky/Blessed)
- [ ] DiceService integration records rolls to history
- [ ] GetRecentRolls returns correct number of rolls
- [ ] GetStatistics returns all calculated values

### Quality
- [ ] Build succeeds with 0 errors
- [ ] Build succeeds with 0 warnings
- [ ] All ~11 unit tests pass
- [ ] XML documentation complete on all public members

---

## 16. Dependencies

### Required from v0.12.0a

| Type | Location | Usage in this phase |
|------|----------|---------------------|
| `Player` | Domain/Entities | DiceHistory owner |
| `PlayerStatistics` | Domain/Entities | Reference pattern |
| `StatisticCategory.Dice` | Domain/Enums | Category identifier |

### Required from Prior Versions

| Type | Location | Usage in this phase |
|------|----------|---------------------|
| `DiceService` | Application/Services | History integration |
| `IEntity` | Domain/Interfaces | Entity base |

### Provides to v0.12.0c

| Type | Usage |
|------|-------|
| `DiceRollHistory` | Displayed in statistics view |
| `IDiceHistoryService` | Queried by StatisticsView |
| `DiceStatistics` | Displayed in dice stats tab |
| `LuckRating` | Displayed with emoji |

---

## 17. Future Considerations

### Deferred to v0.12.0c
- **Statistics View**: Rendering dice statistics to player
- **Recent Rolls Display**: Showing roll buffer with highlights

### Out of Scope
- **Roll Prediction**: Predicting future rolls (not possible/desired)
- **Roll Manipulation**: Any ability to influence random rolls
- **Multi-Player Comparisons**: Comparing luck between players
- **Roll History Export**: Exporting roll data to external formats

---

*Document Version: 1.0*
*Last Updated: 2026-01-16*
*Author: Claude*
