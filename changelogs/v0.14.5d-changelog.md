# v0.14.5d Changelog - Vendor Schema

## Summary

Introduced the comprehensive **Vendor Schema** (`vendors.schema.json`) which validates vendor NPC definitions including inventory listings, price modifiers, restock rules, operating hours, and specialty categories. This schema enables full customization of merchant NPCs without code changes, supporting modding scenarios such as wandering traders, specialty shops, black market dealers, or faction-exclusive vendors. The schema includes 5 example vendors covering major specialties. This is the final schema in the v0.14.5 Economy Configuration Schemas series.

## Added

### Schema File
- **[config/schemas/vendors.schema.json](file:///Volumes/GitHub/github/southpawriter02/rune-rust/config/schemas/vendors.schema.json)** - Comprehensive JSON Schema Draft-07

### Schema Definitions (5 Total)

| Definition | Description | Required Fields |
|------------|-------------|-----------------|
| `VendorDefinition` | Core vendor with inventory and pricing | id, name, description, specialty, inventory, priceModifiers |
| `InventoryItem` | Item in vendor's stock | itemId, stockQuantity |
| `PriceModifiers` | Price calculation configuration | (none - all have defaults) |
| `RestockRule` | Inventory restocking behavior | type |
| `OperatingHours` | Vendor availability schedule | startHour, endHour |

### Specialty Enumeration (10 values)

| Specialty | Description | Suggested Buy Multiplier |
|-----------|-------------|--------------------------|
| `General` | Mixed goods merchant | 1.0× |
| `Blacksmith` | Weapons and tools | 1.0× |
| `Armorer` | Protective gear | 1.0× |
| `Alchemist` | Magical consumables | 1.1× |
| `Enchanter` | Magical items | 1.2× |
| `Jeweler` | Precious accessories | 1.2× |
| `Tailor` | Cloth and leather goods | 0.9× |
| `Innkeeper` | Food and lodging | 0.8× |
| `Provisioner` | Travel supplies | 0.9× |
| `Exotic` | Rare and unique items | 1.5× |

### Restock Type Enumeration (5 values)

| Type | Trigger | Use Case |
|------|---------|----------|
| `Timer` | After X turns | Regular merchants |
| `OnRest` | Player rests | Innkeepers, camp provisioners |
| `OnLevelUp` | Player levels up | Progression-tied inventory |
| `Manual` | Game events | Story-driven changes |
| `Never` | Never restocks | Unique item vendors |

### Item Type Enumeration (3 values)

| Type | Description |
|------|-------------|
| `Item` | General items (default) |
| `Weapon` | Weapon items |
| `Armor` | Armor items |

### Day Enumeration (7 values)

- Monday, Tuesday, Wednesday, Thursday, Friday, Saturday, Sunday

### Configuration File
- **[config/vendors.json](file:///Volumes/GitHub/github/southpawriter02/rune-rust/config/vendors.json)** - 5 example vendors

### Example Vendors Included

| Vendor | Specialty | Features Demonstrated |
|--------|----------|----------------------|
| `blacksmith-ironforge` (Gromm Ironhand) | Blacksmith | Timer restock, operating hours, level-gated items, rare items |
| `alchemist-master` (Elara Moonwhisper) | Alchemist | OnRest restock, multiple currencies, reputation faction |
| `innkeeper-golden-griffin` (Barlow Hearthstone) | Innkeeper | No restock rule, dialogue reference, low markup |
| `exotic-trader-wandering` (Zephyr) | Exotic | Never restock, overnight hours, price overrides |
| `general-store-village` (Martha Goodweather) | General | Timer restock, multiple currencies, weekend closed |

### Unit Tests
- **[VendorsSchemaTests.cs](file:///Volumes/GitHub/github/southpawriter02/rune-rust/tests/RuneAndRust.Infrastructure.IntegrationTests/Schemas/VendorsSchemaTests.cs)** - 11 tests
  - `Schema_IsValidJsonSchemaDraft07` - Schema structure validation (5 definitions)
  - `VendorsJson_ValidatesAgainstSchema` - Backwards compatibility (5 vendors)
  - `Specialty_InvalidEnum_FailsValidation` - Specialty enum (10 values)
  - `RestockRuleType_InvalidEnum_FailsValidation` - Restock type enum (5 values)
  - `MaxDiscount_ExceedsMaximum_FailsValidation` - maxDiscount 0-0.9
  - `VendorId_InvalidPattern_FailsValidation` - Kebab-case pattern
  - `RequiredFields_Missing_FailsValidation` - Required fields check
  - `OperatingHours_StartHourOutOfRange_FailsValidation` - startHour 0-23
  - `ClosedDays_InvalidDayName_FailsValidation` - Day enum (7 values)
  - `StockQuantity_LessThanMinusOne_FailsValidation` - stockQuantity >= -1
  - `BaseBuyMultiplier_LessThanMinimum_FailsValidation` - baseBuyMultiplier >= 0.1
  - `ItemType_InvalidEnum_FailsValidation` - itemType enum (3 values)

## Files Changed

| File | Change Type |
|------|-------------|
| `config/schemas/vendors.schema.json` | Added |
| `config/vendors.json` | Added |
| `tests/.../Schemas/VendorsSchemaTests.cs` | Added |
| `changelogs/v0.14.5d-changelog.md` | Added |

## Test Results

```
Test summary: total: 11, failed: 0, succeeded: 11, skipped: 0
Build succeeded with 0 errors
```

## Vendor Definition Structure

```
┌─────────────────────────────────────────────────────────────────┐
│  VENDOR DEFINITION                                              │
├─────────────────────────────────────────────────────────────────┤
│  id: "blacksmith-ironforge"                                     │
│  name: "Gromm Ironhand"                                         │
│  title: "Master Blacksmith"                                     │
│  description: "A gruff but fair dwarf..."                       │
│  specialty: "Blacksmith"                                        │
│                                                                 │
│  ┌───────────────────────────────────────────────────────────┐  │
│  │  INVENTORY (required, array)                               │  │
│  │  ┌─────────────────────────────────────────────────────┐  │  │
│  │  │ { itemId: "weapon-iron-sword", stockQuantity: 5 }   │  │  │
│  │  │ { itemId: "weapon-steel-sword", stockQuantity: 2,   │  │  │
│  │  │   requiredLevel: 5, isRare: false }                 │  │  │
│  │  │ { itemId: "tool-hammer", stockQuantity: -1 }        │  │  │
│  │  └─────────────────────────────────────────────────────┘  │  │
│  └───────────────────────────────────────────────────────────┘  │
│                                                                 │
│  ┌───────────────────────────────────────────────────────────┐  │
│  │  PRICE MODIFIERS (required, object)                        │  │
│  │  ┌─────────────────────────────────────────────────────┐  │  │
│  │  │ baseBuyMultiplier: 1.0                               │  │  │
│  │  │ baseSellMultiplier: 0.5                              │  │  │
│  │  │ charismaEffect: 0.01                                 │  │  │
│  │  │ persuasionEffect: 0.02                               │  │  │
│  │  │ reputationEffect: 0.05                               │  │  │
│  │  │ maxDiscount: 0.3                                     │  │  │
│  │  └─────────────────────────────────────────────────────┘  │  │
│  └───────────────────────────────────────────────────────────┘  │
│                                                                 │
│  ┌───────────────────────────────────────────────────────────┐  │
│  │  RESTOCK RULE (optional)                                   │  │
│  │  ┌─────────────────────────────────────────────────────┐  │  │
│  │  │ type: "Timer"                                        │  │  │
│  │  │ timerTurns: 50                                       │  │  │
│  │  │ restockPercentage: 1.0                               │  │  │
│  │  │ restockRareItems: false                              │  │  │
│  │  └─────────────────────────────────────────────────────┘  │  │
│  └───────────────────────────────────────────────────────────┘  │
│                                                                 │
│  ┌───────────────────────────────────────────────────────────┐  │
│  │  OPERATING HOURS (optional)                                │  │
│  │  ┌─────────────────────────────────────────────────────┐  │  │
│  │  │ startHour: 8                                         │  │  │
│  │  │ endHour: 18                                          │  │  │
│  │  │ closedDays: ["Sunday"]                               │  │  │
│  │  └─────────────────────────────────────────────────────┘  │  │
│  └───────────────────────────────────────────────────────────┘  │
│                                                                 │
│  acceptedCurrencies: ["gold"]                                   │
│  locationId: "town-ironforge-square"                            │
│  sortOrder: 0                                                   │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

## Price Calculation System

```
┌─────────────────────────────────────────────────────────────────┐
│  PRICE CALCULATION FLOW                                         │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  BUYING FROM VENDOR:                                            │
│  ═══════════════════                                            │
│                                                                 │
│  Item Base Price                                                │
│        │                                                        │
│        ▼                                                        │
│  × baseBuyMultiplier (vendor markup)                            │
│        │                                                        │
│        ▼                                                        │
│  × buyPriceMultiplier (item-specific override)                  │
│        │                                                        │
│        ▼                                                        │
│  Calculate Discount:                                            │
│    charismaDiscount = CHA × charismaEffect                      │
│    persuasionDiscount = SKL × persuasionEffect                  │
│    repDiscount = REP × reputationEffect                         │
│    totalDiscount = MIN(sum, maxDiscount)                        │
│        │                                                        │
│        ▼                                                        │
│  × (1 - totalDiscount)                                          │
│        │                                                        │
│        ▼                                                        │
│  FINAL BUY PRICE                                                │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

## v0.14.5 Economy Configuration Schemas - Complete

This version completes the v0.14.5 Economy Configuration Schemas series:

| Version | Schema | Purpose | Tests |
|---------|--------|---------|-------|
| v0.14.5a | `currency.schema.json` | Currency definitions, exchange rates | 9 ✓ |
| v0.14.5b | `resources.schema.json` | Resource types, regeneration | 11 ✓ |
| v0.14.5c | `recipes.schema.json` | Crafting recipes, materials | 12 ✓ |
| v0.14.5d | `vendors.schema.json` | Vendor NPCs, inventory | 11 ✓ |
| **Total** | **4 schemas** | | **43 tests** |

## Modding Scenarios Enabled

After this implementation, modders can:
- Define vendor NPCs with custom specialties
- Configure item inventories with stock quantities
- Set up price modifiers with player stat effects
- Configure restock rules (timer, on rest, on level up, manual, never)
- Define operating hours and closed days
- Support multiple currencies per vendor
- Link vendors to factions, dialogues, and locations

---

*Final entry in v0.14.5 Economy Configuration Schemas series. See also: v0.14.5a (Currency Schema), v0.14.5b (Resource Schema), v0.14.5c (Recipe Schema).*
