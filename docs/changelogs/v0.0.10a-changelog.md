# v0.0.10a Changelog - Logging Infrastructure

**Date:** 2026-01-08

## Summary

Implements standardized logging infrastructure for Rune and Rust. This phase creates reusable logging utilities, test support for log verification, and enhances configuration for comprehensive observability. This is the first sub-phase of v0.0.10 (Documentation & Polish).

## Added

### Application Layer - Logging Utilities (New)

- `LogTemplates` static class:
  - Service lifecycle templates: ServiceInitialized, ServiceInitializedWithCount
  - Player action templates: PlayerAction, PlayerActionWithTarget, PlayerActionResult
  - Combat templates: CombatInitiated, CombatDamage, CombatResult
  - State change templates: StateChanged, ResourceChanged
  - Configuration templates: ConfigurationLoaded, ConfigurationNotFound, ConfigurationParseError
  - Error templates: OperationFailed, EntityNotFound, ValidationFailed
  - Repository templates: RepositorySave, RepositoryLoad, RepositoryDelete, RepositoryNotFound

- `PerformanceScope` class:
  - IDisposable for timing operations
  - Logs elapsed time on dispose
  - Warning when threshold exceeded
  - Configurable log level and threshold

- `LoggerExtensions` static class:
  - `LogPlayerAction()` - Log player actions with optional target/result
  - `LogCombat()` - Log combat events with full context
  - `LogStateChange<T>()` - Log before/after state changes
  - `BeginPerformanceScope()` - Create performance timing scope
  - `LogConfigurationLoaded()` - Log configuration loading
  - `LogEntityNotFound()` - Log entity not found scenarios

### Application Layer - Interfaces (New)

- `IOperationScope` interface:
  - Properties: OperationId, SessionId
  - Method: BeginOperation(string operationName)

### Application Layer - Services (New)

- `OperationScope` class:
  - Implements `IOperationScope`
  - Generates 8-character hex operation IDs
  - Tracks session ID for correlation
  - Creates log scopes with ILogger.BeginScope

### Test Utilities Project (New)

- `RuneAndRust.TestUtilities` project:
  - Class library for test utilities
  - Reference to Microsoft.Extensions.Logging.Abstractions

- `TestLogger<T>` class:
  - Implements ILogger<T>
  - ConcurrentQueue<LogEntry> for capturing entries
  - Methods: GetEntries(LogLevel), ContainsMessage(string), ContainsMessage(LogLevel, string), GetCount(LogLevel), Clear()

- `TestLoggerFactory` class:
  - Implements ILoggerFactory
  - Caches loggers by type
  - Method: GetTestLogger<T>()

- `LogEntry` record:
  - Properties: Level, Message, Exception, Timestamp

## Modified

### Infrastructure Layer - DI

- `DependencyInjection` class:
  - Registered `IOperationScope` -> `OperationScope` (Scoped lifetime)

### Configuration

- `appsettings.json`:
  - Added Console WriteTo sink with output template
  - Added layer-specific MinimumLevel overrides:
    - RuneAndRust.Domain: Information
    - RuneAndRust.Application: Debug
    - RuneAndRust.Infrastructure: Information
    - RuneAndRust.Presentation: Information
  - Added Enrich array: FromLogContext, WithMachineName, WithThreadId
  - Added fileSizeLimitBytes (10MB) and retainedFileCountLimit (7) to File sink
  - Enhanced outputTemplate with SourceContext

### Test Project

- `RuneAndRust.Application.UnitTests.csproj`:
  - Added reference to RuneAndRust.TestUtilities project

## Test Results

```
Domain Tests:      578 passed
Application Tests: 174 passed (+26 new logging tests)
Architecture Tests:  8 passed
Total:             760 passed
```

## New Unit Tests

| Test File | Count |
|-----------|-------|
| `LoggingInfrastructureTests.cs` | 7 |
| `PerformanceScopeTests.cs` | 6 |
| `OperationScopeTests.cs` | 6 |
| `LoggerExtensionsTests.cs` | 7 |
| **Total New** | 26 |

## Files Summary

### New Files (11)
| File | Purpose |
|------|---------|
| `Application/Logging/LogTemplates.cs` | Standardized log message templates |
| `Application/Logging/PerformanceScope.cs` | Operation timing utility |
| `Application/Logging/LoggerExtensions.cs` | Logging extension methods |
| `Application/Interfaces/IOperationScope.cs` | Operation correlation interface |
| `Application/Services/OperationScope.cs` | Operation scope implementation |
| `TestUtilities/RuneAndRust.TestUtilities.csproj` | Test utilities project |
| `TestUtilities/Logging/TestLogger.cs` | Test logger for verification |
| `TestUtilities/Logging/TestLoggerFactory.cs` | Test logger factory |
| `Application.UnitTests/Logging/LoggingInfrastructureTests.cs` | TestLogger tests |
| `Application.UnitTests/Logging/PerformanceScopeTests.cs` | PerformanceScope tests |
| `Application.UnitTests/Logging/OperationScopeTests.cs` | OperationScope tests |
| `Application.UnitTests/Logging/LoggerExtensionsTests.cs` | Extension method tests |

### Modified Files (3)
| File | Changes |
|------|---------|
| `DependencyInjection.cs` | +IOperationScope registration |
| `appsettings.json` | +Console sink, layer overrides, enrichers |
| `Application.UnitTests.csproj` | +TestUtilities reference |

## Usage Examples

### Using LogTemplates
```csharp
_logger.LogInformation(LogTemplates.ServiceInitializedWithCount,
    nameof(ClassService), classCount, "classes");
```

### Using PerformanceScope
```csharp
using var perf = new PerformanceScope(_logger, "LoadConfiguration", warningThresholdMs: 500);
// ... operation
// Logs: "Operation LoadConfiguration completed in 123ms"
```

### Using LoggerExtensions
```csharp
_logger.LogPlayerAction(player, "attacked", "Goblin");
_logger.LogCombat(player, monster, damageDealt, damageReceived, false, false);
_logger.LogStateChange("Player", player.Id, "Health", 100, 85);
```

### Using OperationScope
```csharp
using var scope = operationScope.BeginOperation("ProcessCombat");
// All logs within this scope include OperationId
_logger.LogInformation("Processing attack...");
```

### Using TestLogger in Unit Tests
```csharp
var logger = new TestLogger<MyService>();
var service = new MyService(logger);

service.DoSomething();

logger.ContainsMessage(LogLevel.Information, "expected message").Should().BeTrue();
logger.GetCount(LogLevel.Warning).Should().Be(0);
```

## Configuration Example

```json
{
  "Serilog": {
    "MinimumLevel": {
      "Default": "Information",
      "Override": {
        "RuneAndRust.Application": "Debug"
      }
    },
    "WriteTo": [
      { "Name": "Console" },
      { "Name": "File", "Args": { "path": "logs/runeandrust-.log" } }
    ],
    "Enrich": [ "FromLogContext", "WithMachineName", "WithThreadId" ]
  }
}
```

## v0.0.10a Complete

This completes the Logging Infrastructure phase:
- Standardized log message templates
- Performance timing utility with threshold warnings
- Operation correlation for request tracking
- Test utilities for log verification
- Enhanced Serilog configuration with layer-specific levels
- Console and file sinks configured
- 26 new unit tests

Ready for v0.0.10b: Unit Test Coverage.
