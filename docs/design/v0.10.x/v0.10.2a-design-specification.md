# v0.10.2a Design Specification: Tree Definitions

**Version:** 0.10.2a
**Parent:** v0.10.2 (Ability Trees)
**Prerequisites:** v0.10.1c Complete (Combat Actions - Environmental Combat)
**Status:** Design Complete
**Estimated Unit Tests:** ~18

---

## 1. Overview

### Purpose

Define the ability tree structure with trees per class, branches for specialization, and nodes for individual talents. Trees are loaded from JSON configuration and provide the template for player progression. Each class has a dedicated ability tree with multiple branches (e.g., Berserker, Guardian, Champion for Warrior) containing nodes organized by tiers.

### Key Deliverables

| Category | Items |
|----------|-------|
| **Domain Entities** | `AbilityTreeDefinition`, `AbilityTreeBranch`, `AbilityTreeNode` |
| **Value Objects** | `NodePosition`, `StatPrerequisite` |
| **Interfaces** | `IAbilityTreeProvider` |
| **Infrastructure** | `AbilityTreeProvider` |
| **Configuration** | `ability-trees.json` |
| **Tests** | ~18 unit tests |

---

## 2. Feature Overview

```
v0.10.2a Features
├── AbilityTreeDefinition Entity
│   ├── TreeId, ClassId
│   ├── Name, Description
│   ├── PointsPerLevel
│   ├── Branches collection
│   ├── GetAllNodes()
│   ├── FindNode()
│   └── GetTotalPointsRequired()
│
├── AbilityTreeBranch Entity
│   ├── BranchId, Name, Description
│   ├── Nodes collection
│   ├── GetNodesAtTier()
│   └── GetMaxTier()
│
├── AbilityTreeNode Entity
│   ├── NodeId, AbilityId
│   ├── Tier, PointCost, MaxRank
│   ├── PrerequisiteNodeIds
│   ├── StatPrerequisites
│   └── Position (X, Y)
│
├── IAbilityTreeProvider Interface
│   ├── GetTreeForClass(classId)
│   ├── GetTree(treeId)
│   ├── GetAllTrees()
│   ├── FindNode(nodeId)
│   └── GetTreeContainingNode(nodeId)
│
├── AbilityTreeProvider Implementation
│   ├── Load from ability-trees.json
│   └── Index for fast lookup
│
└── Configuration (ability-trees.json)
    ├── Warrior tree with 3 branches
    └── 9+ nodes across tiers
```

---

## 3. Architecture

```
┌─────────────────────────────────────────────────────────────────────────┐
│                    ABILITY TREE ARCHITECTURE                            │
└─────────────────────────────────────────────────────────────────────────┘

     Configuration                        Domain
     ─────────────                        ──────

   ability-trees.json           ┌─────────────────────────────┐
   ┌─────────────────┐          │   AbilityTreeDefinition     │
   │ {                │          ├─────────────────────────────┤
   │   "treeId": ..., │  ─────▶  │ + TreeId: string            │
   │   "classId": ...,│          │ + ClassId: string           │
   │   "branches": [  │          │ + Name: string              │
   │     { ... }      │          │ + PointsPerLevel: int       │
   │   ]              │          │ + Branches: List<Branch>    │
   │ }                │          └──────────────┬──────────────┘
   └─────────────────┘                          │
                                                │ contains
                                                ▼
                                 ┌─────────────────────────────┐
                                 │     AbilityTreeBranch       │
                                 ├─────────────────────────────┤
                                 │ + BranchId: string          │
                                 │ + Name: string              │
                                 │ + Description: string       │
                                 │ + Nodes: List<TreeNode>     │
                                 └──────────────┬──────────────┘
                                                │ contains
                                                ▼
                                 ┌─────────────────────────────┐
                                 │      AbilityTreeNode        │
                                 ├─────────────────────────────┤
                                 │ + NodeId: string            │
                                 │ + AbilityId: string         │
                                 │ + Tier: int                 │
                                 │ + PointCost: int            │
                                 │ + MaxRank: int              │
                                 │ + PrerequisiteNodeIds: list │
                                 │ + StatPrerequisites: list   │
                                 │ + Position: (X, Y)          │
                                 └─────────────────────────────┘


                    WARRIOR ABILITY TREE VISUALIZATION
                    ──────────────────────────────────

                            ┌───────────────┐
                            │   WARRIOR     │
                            │    (Base)     │
                            └───────┬───────┘
                                    │
                    ┌───────────────┼───────────────┐
                    │               │               │
                    ▼               ▼               ▼
            ┌───────────┐   ┌───────────┐   ┌───────────┐
            │BERSERKER  │   │ GUARDIAN  │   │ CHAMPION  │
            │ (Branch)  │   │ (Branch)  │   │ (Branch)  │
            └─────┬─────┘   └─────┬─────┘   └─────┬─────┘
                  │               │               │
            ┌─────┴─────┐   ┌─────┴─────┐   ┌─────┴─────┐
            │           │   │           │   │           │
            ▼           ▼   ▼           ▼   ▼           ▼
        ┌───────┐ ┌───────┐ ┌───────┐ ┌───────┐ ┌───────┐ ┌───────┐
        │Frenzy │ │Blood- │ │Shield │ │Taunt  │ │Rallying│ │Battle │
        │ (T1)  │ │lust   │ │Wall   │ │ (T1)  │ │Cry(T1)│ │Master │
        └───┬───┘ │ (T1)  │ │ (T1)  │ └───┬───┘ └───┬───┘ │ (T1)  │
            │     └───────┘ └───┬───┘     │         │     └───────┘
            │                   │         │         │
            ▼                   ▼         ▼         ▼
        ┌───────┐         ┌───────┐ ┌───────┐ ┌───────┐
        │Rage   │         │Iron   │ │Aura of│ │Inspire│
        │ (T2)  │         │Skin   │ │Defense│ │ (T2)  │
        └───────┘         │ (T2)  │ │ (T2)  │ └───────┘
                          └───────┘ └───────┘
            
        T1 = Tier 1 (1 point)   T2 = Tier 2 (2 points, requires T1)
```

---

## 4. AbilityTreeDefinition Entity

**File:** `src/Core/RuneAndRust.Domain/Definitions/AbilityTreeDefinition.cs`

```csharp
namespace RuneAndRust.Domain.Definitions;

/// <summary>
/// Defines an ability tree for a class.
/// </summary>
public class AbilityTreeDefinition : IEntity
{
    public Guid Id { get; private set; }

    /// <summary>Unique identifier for the tree.</summary>
    public string TreeId { get; private set; } = null!;

    /// <summary>The class this tree belongs to.</summary>
    public string ClassId { get; private set; } = null!;

    /// <summary>Display name.</summary>
    public string Name { get; private set; } = null!;

    /// <summary>Description of the tree.</summary>
    public string Description { get; private set; } = null!;

    /// <summary>Talent points awarded per level.</summary>
    public int PointsPerLevel { get; private set; } = 1;

    /// <summary>The branches in this tree.</summary>
    public IReadOnlyList<AbilityTreeBranch> Branches { get; private set; } = [];

    /// <summary>Icon path.</summary>
    public string? IconPath { get; private set; }

    // EF Core constructor
    private AbilityTreeDefinition() { }

    public static AbilityTreeDefinition Create(
        string treeId,
        string classId,
        string name,
        string description,
        int pointsPerLevel = 1,
        string? iconPath = null)
    {
        ArgumentException.ThrowIfNullOrWhiteSpace(treeId);
        ArgumentException.ThrowIfNullOrWhiteSpace(classId);
        ArgumentException.ThrowIfNullOrWhiteSpace(name);

        return new AbilityTreeDefinition
        {
            Id = Guid.NewGuid(),
            TreeId = treeId.ToLowerInvariant(),
            ClassId = classId.ToLowerInvariant(),
            Name = name,
            Description = description,
            PointsPerLevel = pointsPerLevel,
            IconPath = iconPath
        };
    }

    /// <summary>Sets the branches for this tree.</summary>
    public void SetBranches(IReadOnlyList<AbilityTreeBranch> branches)
    {
        Branches = branches ?? [];
    }

    /// <summary>Gets all nodes across all branches.</summary>
    public IEnumerable<AbilityTreeNode> GetAllNodes()
    {
        return Branches.SelectMany(b => b.Nodes);
    }

    /// <summary>Finds a node by ID.</summary>
    public AbilityTreeNode? FindNode(string nodeId)
    {
        return GetAllNodes().FirstOrDefault(n =>
            n.NodeId.Equals(nodeId, StringComparison.OrdinalIgnoreCase));
    }

    /// <summary>Gets the total points needed to fully unlock the tree.</summary>
    public int GetTotalPointsRequired()
    {
        return GetAllNodes().Sum(n => n.PointCost * n.MaxRank);
    }

    /// <summary>Gets nodes at a specific tier across all branches.</summary>
    public IEnumerable<AbilityTreeNode> GetNodesAtTier(int tier)
    {
        return GetAllNodes().Where(n => n.Tier == tier);
    }

    /// <summary>Gets the maximum tier in this tree.</summary>
    public int GetMaxTier()
    {
        var nodes = GetAllNodes().ToList();
        return nodes.Any() ? nodes.Max(n => n.Tier) : 0;
    }

    public override string ToString() => $"{Name} ({TreeId}) for {ClassId}";
}
```

---

## 5. AbilityTreeBranch Entity

**File:** `src/Core/RuneAndRust.Domain/Definitions/AbilityTreeBranch.cs`

```csharp
namespace RuneAndRust.Domain.Definitions;

/// <summary>
/// A branch within an ability tree representing a specialization path.
/// </summary>
public class AbilityTreeBranch
{
    /// <summary>Unique identifier for the branch.</summary>
    public string BranchId { get; set; } = null!;

    /// <summary>Display name.</summary>
    public string Name { get; set; } = null!;

    /// <summary>Description of this specialization.</summary>
    public string Description { get; set; } = null!;

    /// <summary>The nodes in this branch.</summary>
    public IReadOnlyList<AbilityTreeNode> Nodes { get; set; } = [];

    /// <summary>Icon path.</summary>
    public string? IconPath { get; set; }

    /// <summary>Gets nodes at a specific tier.</summary>
    public IEnumerable<AbilityTreeNode> GetNodesAtTier(int tier)
    {
        return Nodes.Where(n => n.Tier == tier);
    }

    /// <summary>Gets the maximum tier in this branch.</summary>
    public int GetMaxTier()
    {
        return Nodes.Any() ? Nodes.Max(n => n.Tier) : 0;
    }

    /// <summary>Gets the total node count.</summary>
    public int GetNodeCount() => Nodes.Count;

    /// <summary>Gets the total points required to max this branch.</summary>
    public int GetTotalPointsRequired()
    {
        return Nodes.Sum(n => n.PointCost * n.MaxRank);
    }

    public override string ToString() => $"{Name} ({BranchId})";
}
```

---

## 6. AbilityTreeNode Entity

**File:** `src/Core/RuneAndRust.Domain/Definitions/AbilityTreeNode.cs`

```csharp
namespace RuneAndRust.Domain.Definitions;

/// <summary>
/// A single node (talent) in an ability tree.
/// </summary>
public class AbilityTreeNode
{
    /// <summary>Unique identifier for the node.</summary>
    public string NodeId { get; set; } = null!;

    /// <summary>The ability this node grants.</summary>
    public string AbilityId { get; set; } = null!;

    /// <summary>Display name.</summary>
    public string Name { get; set; } = null!;

    /// <summary>Description of the talent.</summary>
    public string Description { get; set; } = null!;

    /// <summary>Tier level (1 = base, 2 = advanced, etc.).</summary>
    public int Tier { get; set; }

    /// <summary>Point cost per rank.</summary>
    public int PointCost { get; set; } = 1;

    /// <summary>Maximum ranks for this talent (1 for single-rank).</summary>
    public int MaxRank { get; set; } = 1;

    /// <summary>Node IDs that must be unlocked before this node.</summary>
    public IReadOnlyList<string> PrerequisiteNodeIds { get; set; } = [];

    /// <summary>Stat requirements for this node.</summary>
    public IReadOnlyList<StatPrerequisite> StatPrerequisites { get; set; } = [];

    /// <summary>Position for UI layout.</summary>
    public NodePosition Position { get; set; } = new(0, 0);

    /// <summary>Icon path.</summary>
    public string? IconPath { get; set; }

    /// <summary>Whether this node has any prerequisites.</summary>
    public bool HasPrerequisites => PrerequisiteNodeIds.Any() || StatPrerequisites.Any();

    /// <summary>Whether this node has multiple ranks.</summary>
    public bool IsMultiRank => MaxRank > 1;

    /// <summary>Gets the total points to max this node.</summary>
    public int GetTotalPointsToMax() => PointCost * MaxRank;

    public override string ToString() => $"{Name} ({NodeId}) T{Tier}";
}
```

---

## 7. Value Objects

**File:** `src/Core/RuneAndRust.Domain/ValueObjects/NodePosition.cs`

```csharp
namespace RuneAndRust.Domain.ValueObjects;

/// <summary>
/// Position coordinates for UI layout of tree nodes.
/// </summary>
public readonly record struct NodePosition(int X, int Y)
{
    public override string ToString() => $"({X}, {Y})";
}
```

**File:** `src/Core/RuneAndRust.Domain/ValueObjects/StatPrerequisite.cs`

```csharp
namespace RuneAndRust.Domain.ValueObjects;

/// <summary>
/// A stat requirement for unlocking a node.
/// </summary>
public readonly record struct StatPrerequisite(string StatId, int MinValue)
{
    public override string ToString() => $"{StatId} >= {MinValue}";
}
```

---

## 8. IAbilityTreeProvider Interface

**File:** `src/Core/RuneAndRust.Application/Interfaces/IAbilityTreeProvider.cs`

```csharp
namespace RuneAndRust.Application.Interfaces;

/// <summary>
/// Provides ability tree definitions.
/// </summary>
public interface IAbilityTreeProvider
{
    /// <summary>Gets the ability tree for a class.</summary>
    /// <param name="classId">The class identifier.</param>
    /// <returns>The tree for that class, or null if none.</returns>
    AbilityTreeDefinition? GetTreeForClass(string classId);

    /// <summary>Gets a tree by its ID.</summary>
    /// <param name="treeId">The tree identifier.</param>
    /// <returns>The tree definition, or null if not found.</returns>
    AbilityTreeDefinition? GetTree(string treeId);

    /// <summary>Gets all available trees.</summary>
    IReadOnlyList<AbilityTreeDefinition> GetAllTrees();

    /// <summary>Finds a node across all trees.</summary>
    /// <param name="nodeId">The node identifier.</param>
    /// <returns>The node, or null if not found.</returns>
    AbilityTreeNode? FindNode(string nodeId);

    /// <summary>Gets the tree containing a specific node.</summary>
    /// <param name="nodeId">The node identifier.</param>
    /// <returns>The containing tree, or null if not found.</returns>
    AbilityTreeDefinition? GetTreeContainingNode(string nodeId);

    /// <summary>Gets the branch containing a specific node.</summary>
    /// <param name="nodeId">The node identifier.</param>
    /// <returns>The containing branch, or null if not found.</returns>
    AbilityTreeBranch? GetBranchContainingNode(string nodeId);

    /// <summary>Gets all available class IDs that have trees.</summary>
    IReadOnlyList<string> GetClassesWithTrees();
}
```

---

## 9. AbilityTreeProvider Implementation

**File:** `src/Core/RuneAndRust.Infrastructure/Providers/AbilityTreeProvider.cs`

```csharp
namespace RuneAndRust.Infrastructure.Providers;

public class AbilityTreeProvider : IAbilityTreeProvider
{
    private readonly Dictionary<string, AbilityTreeDefinition> _treesByTreeId;
    private readonly Dictionary<string, AbilityTreeDefinition> _treesByClassId;
    private readonly Dictionary<string, AbilityTreeNode> _nodesById;
    private readonly Dictionary<string, AbilityTreeBranch> _branchesByNodeId;
    private readonly ILogger<AbilityTreeProvider> _logger;

    public AbilityTreeProvider(
        IConfigurationProvider configProvider,
        ILogger<AbilityTreeProvider> logger)
    {
        _logger = logger;
        _treesByTreeId = new Dictionary<string, AbilityTreeDefinition>(StringComparer.OrdinalIgnoreCase);
        _treesByClassId = new Dictionary<string, AbilityTreeDefinition>(StringComparer.OrdinalIgnoreCase);
        _nodesById = new Dictionary<string, AbilityTreeNode>(StringComparer.OrdinalIgnoreCase);
        _branchesByNodeId = new Dictionary<string, AbilityTreeBranch>(StringComparer.OrdinalIgnoreCase);

        LoadTrees(configProvider);
    }

    private void LoadTrees(IConfigurationProvider configProvider)
    {
        var config = configProvider.GetSection<AbilityTreesConfig>("ability-trees.json");

        foreach (var treeData in config.AbilityTrees)
        {
            var tree = AbilityTreeDefinition.Create(
                treeData.TreeId,
                treeData.ClassId,
                treeData.Name,
                treeData.Description,
                treeData.PointsPerLevel,
                treeData.Icon
            );

            var branches = new List<AbilityTreeBranch>();

            foreach (var branchData in treeData.Branches)
            {
                var nodes = new List<AbilityTreeNode>();

                foreach (var nodeData in branchData.Nodes)
                {
                    var node = new AbilityTreeNode
                    {
                        NodeId = nodeData.NodeId.ToLowerInvariant(),
                        AbilityId = nodeData.AbilityId.ToLowerInvariant(),
                        Name = nodeData.Name,
                        Description = nodeData.Description,
                        Tier = nodeData.Tier,
                        PointCost = nodeData.PointCost,
                        MaxRank = nodeData.MaxRank,
                        PrerequisiteNodeIds = nodeData.Prerequisites?
                            .Select(p => p.ToLowerInvariant()).ToList() ?? [],
                        StatPrerequisites = nodeData.StatPrerequisites?
                            .Select(sp => new StatPrerequisite(sp.Stat, sp.MinValue)).ToList() ?? [],
                        Position = new NodePosition(nodeData.Position.X, nodeData.Position.Y),
                        IconPath = nodeData.Icon
                    };

                    nodes.Add(node);
                    _nodesById[node.NodeId] = node;
                }

                var branch = new AbilityTreeBranch
                {
                    BranchId = branchData.BranchId.ToLowerInvariant(),
                    Name = branchData.Name,
                    Description = branchData.Description,
                    Nodes = nodes,
                    IconPath = branchData.Icon
                };

                branches.Add(branch);

                // Index nodes by branch
                foreach (var node in nodes)
                {
                    _branchesByNodeId[node.NodeId] = branch;
                }
            }

            tree.SetBranches(branches);

            _treesByTreeId[tree.TreeId] = tree;
            _treesByClassId[tree.ClassId] = tree;

            _logger.LogInformation("Loaded ability tree: {TreeName} for {ClassId} ({NodeCount} nodes)",
                tree.Name, tree.ClassId, tree.GetAllNodes().Count());
        }

        _logger.LogInformation("Loaded {Count} ability trees with {Total} total nodes",
            _treesByTreeId.Count, _nodesById.Count);
    }

    public AbilityTreeDefinition? GetTreeForClass(string classId)
    {
        return _treesByClassId.GetValueOrDefault(classId.ToLowerInvariant());
    }

    public AbilityTreeDefinition? GetTree(string treeId)
    {
        return _treesByTreeId.GetValueOrDefault(treeId.ToLowerInvariant());
    }

    public IReadOnlyList<AbilityTreeDefinition> GetAllTrees()
    {
        return _treesByTreeId.Values.ToList();
    }

    public AbilityTreeNode? FindNode(string nodeId)
    {
        return _nodesById.GetValueOrDefault(nodeId.ToLowerInvariant());
    }

    public AbilityTreeDefinition? GetTreeContainingNode(string nodeId)
    {
        var node = FindNode(nodeId);
        if (node is null) return null;

        return _treesByTreeId.Values.FirstOrDefault(t =>
            t.GetAllNodes().Any(n => n.NodeId.Equals(nodeId, StringComparison.OrdinalIgnoreCase)));
    }

    public AbilityTreeBranch? GetBranchContainingNode(string nodeId)
    {
        return _branchesByNodeId.GetValueOrDefault(nodeId.ToLowerInvariant());
    }

    public IReadOnlyList<string> GetClassesWithTrees()
    {
        return _treesByClassId.Keys.ToList();
    }
}
```

---

## 10. Configuration File

**File:** `config/ability-trees.json`

```json
{
  "$schema": "./schemas/ability-trees.schema.json",
  "abilityTrees": [
    {
      "treeId": "warrior-tree",
      "classId": "warrior",
      "name": "Warrior Talents",
      "description": "Master of arms and battlefield tactics",
      "pointsPerLevel": 1,
      "icon": "icons/trees/warrior.png",
      "branches": [
        {
          "branchId": "berserker",
          "name": "Berserker",
          "description": "Fury and raw destructive power",
          "icon": "icons/branches/berserker.png",
          "nodes": [
            {
              "nodeId": "frenzy",
              "abilityId": "frenzy",
              "name": "Frenzy",
              "description": "Enter a battle rage, increasing attack speed by 10% per rank",
              "tier": 1,
              "pointCost": 1,
              "maxRank": 3,
              "prerequisites": [],
              "statPrerequisites": [],
              "position": { "x": 0, "y": 1 },
              "icon": "icons/abilities/frenzy.png"
            },
            {
              "nodeId": "bloodlust",
              "abilityId": "bloodlust",
              "name": "Bloodlust",
              "description": "Heal for 10% of damage dealt when killing enemies",
              "tier": 1,
              "pointCost": 1,
              "maxRank": 1,
              "prerequisites": [],
              "statPrerequisites": [],
              "position": { "x": 1, "y": 1 },
              "icon": "icons/abilities/bloodlust.png"
            },
            {
              "nodeId": "rage",
              "abilityId": "rage",
              "name": "Rage",
              "description": "Massive damage boost (+50%) when below 25% health",
              "tier": 2,
              "pointCost": 2,
              "maxRank": 1,
              "prerequisites": ["frenzy"],
              "statPrerequisites": [{ "stat": "strength", "minValue": 14 }],
              "position": { "x": 0, "y": 2 },
              "icon": "icons/abilities/rage.png"
            }
          ]
        },
        {
          "branchId": "guardian",
          "name": "Guardian",
          "description": "Protection, resilience, and damage mitigation",
          "icon": "icons/branches/guardian.png",
          "nodes": [
            {
              "nodeId": "shield-wall",
              "abilityId": "shield-wall",
              "name": "Shield Wall",
              "description": "Increase block chance by 10% per rank",
              "tier": 1,
              "pointCost": 1,
              "maxRank": 3,
              "prerequisites": [],
              "statPrerequisites": [],
              "position": { "x": 0, "y": 1 },
              "icon": "icons/abilities/shield-wall.png"
            },
            {
              "nodeId": "taunt",
              "abilityId": "taunt",
              "name": "Taunt",
              "description": "Force enemies to attack you for 2 turns",
              "tier": 1,
              "pointCost": 1,
              "maxRank": 1,
              "prerequisites": [],
              "statPrerequisites": [],
              "position": { "x": 1, "y": 1 },
              "icon": "icons/abilities/taunt.png"
            },
            {
              "nodeId": "iron-skin",
              "abilityId": "iron-skin",
              "name": "Iron Skin",
              "description": "Reduce all damage taken by 15%",
              "tier": 2,
              "pointCost": 2,
              "maxRank": 1,
              "prerequisites": ["shield-wall"],
              "statPrerequisites": [],
              "position": { "x": 0, "y": 2 },
              "icon": "icons/abilities/iron-skin.png"
            },
            {
              "nodeId": "aura-of-defense",
              "abilityId": "aura-of-defense",
              "name": "Aura of Defense",
              "description": "Allies within 2 cells take 10% less damage",
              "tier": 2,
              "pointCost": 2,
              "maxRank": 1,
              "prerequisites": ["taunt"],
              "statPrerequisites": [],
              "position": { "x": 1, "y": 2 },
              "icon": "icons/abilities/aura-of-defense.png"
            }
          ]
        },
        {
          "branchId": "champion",
          "name": "Champion",
          "description": "Leadership, inspiration, and battlefield command",
          "icon": "icons/branches/champion.png",
          "nodes": [
            {
              "nodeId": "rallying-cry",
              "abilityId": "rallying-cry",
              "name": "Rallying Cry",
              "description": "Boost ally attack by 2 per rank for 3 turns",
              "tier": 1,
              "pointCost": 1,
              "maxRank": 3,
              "prerequisites": [],
              "statPrerequisites": [],
              "position": { "x": 0, "y": 1 },
              "icon": "icons/abilities/rallying-cry.png"
            },
            {
              "nodeId": "battle-master",
              "abilityId": "battle-master",
              "name": "Battle Master",
              "description": "Gain tactical maneuver options in combat",
              "tier": 1,
              "pointCost": 1,
              "maxRank": 1,
              "prerequisites": [],
              "statPrerequisites": [],
              "position": { "x": 1, "y": 1 },
              "icon": "icons/abilities/battle-master.png"
            },
            {
              "nodeId": "inspire",
              "abilityId": "inspire",
              "name": "Inspire",
              "description": "Grant an ally an extra action this turn",
              "tier": 2,
              "pointCost": 2,
              "maxRank": 1,
              "prerequisites": ["rallying-cry"],
              "statPrerequisites": [{ "stat": "charisma", "minValue": 12 }],
              "position": { "x": 0, "y": 2 },
              "icon": "icons/abilities/inspire.png"
            }
          ]
        }
      ]
    }
  ]
}
```

---

## 11. Tree Structure Visualization

```
TREE HIERARCHY:
═══════════════════════════════════════════════════════════════════════

  AbilityTreeDefinition ("warrior-tree")
  ├── ClassId: "warrior"
  ├── PointsPerLevel: 1
  │
  └── Branches[]
      │
      ├── AbilityTreeBranch ("berserker")
      │   ├── Nodes[]
      │   │   ├── AbilityTreeNode ("frenzy")    T1, 1pt, rank 1-3
      │   │   ├── AbilityTreeNode ("bloodlust") T1, 1pt, rank 1
      │   │   └── AbilityTreeNode ("rage")      T2, 2pt, rank 1, req: frenzy
      │   │
      │   └── GetMaxTier() → 2
      │
      ├── AbilityTreeBranch ("guardian")
      │   ├── Nodes[]
      │   │   ├── AbilityTreeNode ("shield-wall")    T1, 1pt, rank 1-3
      │   │   ├── AbilityTreeNode ("taunt")          T1, 1pt, rank 1
      │   │   ├── AbilityTreeNode ("iron-skin")      T2, 2pt, rank 1
      │   │   └── AbilityTreeNode ("aura-of-defense") T2, 2pt, rank 1
      │   │
      │   └── GetMaxTier() → 2
      │
      └── AbilityTreeBranch ("champion")
          ├── Nodes[]
          │   ├── AbilityTreeNode ("rallying-cry")  T1, 1pt, rank 1-3
          │   ├── AbilityTreeNode ("battle-master") T1, 1pt, rank 1
          │   └── AbilityTreeNode ("inspire")       T2, 2pt, rank 1
          │
          └── GetMaxTier() → 2


NODE DETAIL:
═══════════════════════════════════════════════════════════════════════

  ┌─────────────────────────────────────────────────────────────────┐
  │                          "rage" Node                            │
  ├─────────────────────────────────────────────────────────────────┤
  │ NodeId:          rage                                           │
  │ AbilityId:       rage                                           │
  │ Tier:            2                                              │
  │ PointCost:       2 (per rank)                                   │
  │ MaxRank:         1                                              │
  │ Prerequisites:   ["frenzy"]                                     │
  │ StatPrereqs:     [strength >= 14]                               │
  │ Position:        (0, 2)                                         │
  └─────────────────────────────────────────────────────────────────┘
```

---

## 12. Unit Testing Requirements (~18 tests)

| Feature | Tests |
|---------|-------|
| AbilityTreeDefinition.Create valid | 1 |
| GetAllNodes returns all nodes | 1 |
| FindNode returns correct node | 1 |
| FindNode returns null for unknown | 1 |
| GetTotalPointsRequired calculates correctly | 1 |
| GetNodesAtTier filters correctly | 1 |
| GetMaxTier returns highest tier | 1 |
| AbilityTreeBranch.GetNodesAtTier works | 1 |
| AbilityTreeBranch.GetMaxTier works | 1 |
| AbilityTreeNode.HasPrerequisites returns true | 1 |
| AbilityTreeNode.HasPrerequisites returns false | 1 |
| AbilityTreeNode.IsMultiRank detects MaxRank > 1 | 1 |
| AbilityTreeProvider loads from config | 1 |
| GetTreeForClass returns correct tree | 1 |
| GetTreeForClass returns null for unknown | 1 |
| FindNode finds node across trees | 1 |
| GetTreeContainingNode returns correct tree | 1 |
| GetBranchContainingNode returns correct branch | 1 |

---

## 13. Acceptance Criteria

- [ ] AbilityTreeDefinition loads from JSON
- [ ] Trees are mapped to classes by ClassId
- [ ] Branches group related talents by specialization
- [ ] Nodes define individual talents with all properties
- [ ] Tiers organize node hierarchy (1, 2, 3...)
- [ ] PointCost defined per node (1, 2, etc.)
- [ ] MaxRank supports multi-rank abilities (1-3)
- [ ] PrerequisiteNodeIds lists required nodes
- [ ] StatPrerequisites define stat requirements
- [ ] Position coordinates provided for UI layout
- [ ] GetAllNodes returns all tree nodes
- [ ] FindNode locates specific nodes by ID
- [ ] GetTreeForClass returns tree for class
- [ ] GetTreeContainingNode finds parent tree
- [ ] GetBranchContainingNode finds parent branch
- [ ] Provider indexes for fast lookup
- [ ] ~18 unit tests pass

---

## 14. Dependencies

| From | Required |
|------|----------|
| Domain | `IEntity`, `ClassDefinition` |
| Application | `IConfigurationProvider` |
| Prior versions | Ability system, class system |

---

*Document Version: 1.0 | Last Updated: 2026-01-10*
