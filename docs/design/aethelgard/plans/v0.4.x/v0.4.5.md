# v0.4.5: Spells & Chants (The Mystic)

> **Status:** Planned
> **Milestone:** v0.4.x - The Saga & The Weaver
> **Theme:** The ability to weave Galdr (spells) from Aetheric energy, with multi-turn Chanting and concentration mechanics.
> **Predecessor:** v0.4.3 Magic Core (AetherService, Spell Entity)

---

## Table of Contents

1. [Overview](#overview)
2. [Design Philosophy](#design-philosophy)
3. [Sub-Version Breakdown](#sub-version-breakdown)
4. [v0.4.5a: The Catalyst](#v045a-the-catalyst-magic-core--casting)
5. [v0.4.5b: The Chant](#v045b-the-chant-multi-turn-actions)
6. [v0.4.5c: The Grim](#v045c-the-grim-spell-implementation)
7. [v0.4.5d: The Weaver](#v045d-the-weaver-tui--feedback)
8. [Architecture Diagrams](#architecture-diagrams)
9. [Logging Requirements](#logging-requirements)
10. [Testing Strategy](#testing-strategy)
11. [Domain 4 Compliance](#domain-4-compliance)
12. [Dependency Map](#dependency-map)
13. [Changelog Template](#changelog-template)

---

## Overview

v0.4.5 implements the **Mystic** archetype's core mechanics: the ability to cast spells using Aetheric energy. It introduces the `cast` command, the `Aether` resource management (with Flux risk), and the concept of multi-turn **Chants** which require concentration and can be interrupted.

### What This Version Adds

| Feature | Description |
|---------|-------------|
| **Aether Resource** | A derived stat pool for spellcasting, analogous to Stamina |
| **Flux Risk** | Environmental magic volatility that increases with spell usage |
| **Instant Spells** | Quick-cast Galdr that resolve immediately |
| **Chanted Spells** | Multi-turn spells requiring concentration |
| **Concentration System** | State tracking for ongoing spells; can be broken |
| **5 Starter Spells** | Initial Mystic spell repertoire |
| **TUI Feedback** | Aether bars, chant overlays, school-colored logs |

### Dependency Note

This plan assumes `v0.4.3 Magic Core` (AetherService, Spell Entity, FluxState) is completed. If pending, the prerequisite infrastructure must be implemented as part of v0.4.5a.

---

## Design Philosophy

### 1. Risk-Reward Casting

Magic is not free. Each spell:
- Consumes **Aether Points (AP)** from the caster's personal reserve
- Adds **Flux** to the environment, increasing Backlash probability
- May require **Concentration** (for Chants), creating vulnerability

### 2. Tactical Depth Through Chanting

Powerful spells require multiple turns to cast, creating:
- **Commitment decisions**: Starting a Chant locks you into a vulnerable state
- **Counterplay opportunities**: Enemies can attempt to interrupt Chants
- **Resource management**: Breaking concentration may waste AP

### 3. Domain 4 Voice Compliance

All spell descriptions, casting messages, and feedback use the archaeologist-observer perspective:
- ❌ "You cast Fireball dealing 25 damage"
- ✅ "The Galdr unravels from your fingers—flame blooms where the rot-beast stood"

---

## Sub-Version Breakdown

| Sub-Version | Codename | Focus | Estimated Tests |
|-------------|----------|-------|-----------------|
| **v0.4.5a** | The Catalyst | Aether pool, Spell entity, basic `cast` command | ~32 |
| **v0.4.5b** | The Chant | Concentration state, multi-turn resolution, interruption | ~38 |
| **v0.4.5c** | The Grim | 5 starter spells with effects and seeding | ~28 |
| **v0.4.5d** | The Weaver | TUI integration, Aether bar, chant overlay | ~18 |

**Total Estimated Tests: ~116**

---

## v0.4.5a: The Catalyst (Magic Core & Casting)

> **Goal:** Establish the fundamental data structures for Magic (`Spell`, `School`, `Aether`) and implement the `MagicService` to handle the `cast` command resolution.

### Scope

- **AetherPool** model: Character's magical resource (Current/Max AP)
- **CastTime** model: Instant vs Chant classification
- **CastResult** model: Outcome of cast attempts
- **IMagicService** interface: Contract for spell execution
- **MagicService** implementation: Casting validation and execution
- **Cast command**: `cast [spell_name] [target]` in CommandParser

### Architecture & Data Flow

```
┌─────────────────────────────────────────────────────────────────────────┐
│                           CAST COMMAND FLOW                              │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                          │
│  ┌──────────────┐     ┌───────────────┐     ┌────────────────────────┐ │
│  │ CommandParser │────▶│ MagicService  │────▶│ SpellRepository        │ │
│  │ "cast light"  │     │ Cast()        │     │ GetByName("light")     │ │
│  └──────────────┘     └───────┬───────┘     └────────────────────────┘ │
│                               │                                          │
│                               ▼                                          │
│                       ┌───────────────┐                                  │
│                       │  VALIDATION   │                                  │
│                       │ ├─ Knows spell?│                                 │
│                       │ ├─ Has AP?     │                                 │
│                       │ └─ Valid target?│                                │
│                       └───────┬───────┘                                  │
│                               │                                          │
│              ┌────────────────┼────────────────┐                         │
│              │                │                │                         │
│              ▼                ▼                ▼                         │
│      ┌──────────────┐ ┌──────────────┐ ┌──────────────┐                 │
│      │ INSUFFICIENT │ │   INSTANT    │ │    CHANT     │                 │
│      │    AETHER    │ │  EXECUTION   │ │   START      │                 │
│      │ Return Fail  │ │ Apply Effect │ │ Set Conc.    │                 │
│      └──────────────┘ └──────────────┘ └──────────────┘                 │
│                               │                │                         │
│                               ▼                ▼                         │
│                       ┌───────────────┐ ┌──────────────┐                │
│                       │ AetherService │ │  Return      │                │
│                       │ AddFlux()     │ │ ChantStarted │                │
│                       └───────────────┘ └──────────────┘                │
│                                                                          │
└─────────────────────────────────────────────────────────────────────────┘
```

### Key Components

| Component | Layer | File Path | Description |
|-----------|-------|-----------|-------------|
| `AetherPool` | Core | `Core/Models/Magic/AetherPool.cs` | Current/Max AP tracking |
| `CastTime` | Core | `Core/Enums/CastTime.cs` | Instant vs Chant(n) |
| `CastResult` | Core | `Core/Models/Magic/CastResult.cs` | Cast outcome with reason |
| `IMagicService` | Core | `Core/Interfaces/IMagicService.cs` | Service contract |
| `MagicService` | Engine | `Engine/Services/MagicService.cs` | Cast execution logic |

### Decision Tree: Cast Command Validation

```
┌─────────────────────────────────────────────────────────────────────────┐
│                        CAST COMMAND DECISION TREE                        │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                          │
│  INPUT: "cast <spell> [on <target>]"                                    │
│                                                                          │
│  1. PARSE SPELL NAME                                                     │
│     │                                                                    │
│     ├─▶ Empty/null? ─────────▶ FAIL: "Cast what? Speak a Galdr's name." │
│     │                                                                    │
│     └─▶ Continue to Lookup                                              │
│                                                                          │
│  2. SPELL LOOKUP (fuzzy match)                                          │
│     │                                                                    │
│     ├─▶ Not found? ──────────▶ FAIL: "You do not know the Galdr for     │
│     │                                '<spell>'."                         │
│     │                                                                    │
│     ├─▶ Multiple matches? ───▶ PROMPT: "Which Galdr? [list options]"    │
│     │                                                                    │
│     └─▶ Single match found ──▶ Continue to Resource Check               │
│                                                                          │
│  3. RESOURCE CHECK                                                       │
│     │                                                                    │
│     ├─▶ AP < Cost? ──────────▶ FAIL: "Your spark is too dim.            │
│     │                                (Need {Cost}, have {Current})"      │
│     │                                                                    │
│     └─▶ AP >= Cost ──────────▶ Continue to Target Validation            │
│                                                                          │
│  4. TARGET VALIDATION                                                    │
│     │                                                                    │
│     ├─▶ Self-targeted spell                                              │
│     │   └─▶ Target provided? ▶ WARN: "This Galdr turns inward."         │
│     │       └─▶ Apply to self                                            │
│     │                                                                    │
│     ├─▶ Single target required                                           │
│     │   ├─▶ No target? ──────▶ If in combat: auto-target enemy          │
│     │   │                     ▶ If not: FAIL: "Upon whom?"               │
│     │   └─▶ Target valid? ───▶ Continue to Execution                    │
│     │                                                                    │
│     └─▶ Area/All targets ────▶ Collect all valid targets                │
│                                                                          │
│  5. CONCENTRATION CHECK                                                  │
│     │                                                                    │
│     ├─▶ Already chanting? ───▶ FAIL: "You are already weaving a Galdr.  │
│     │                                You must finish or break it first." │
│     │                                                                    │
│     └─▶ Not chanting ────────▶ Continue to Execution                    │
│                                                                          │
│  6. EXECUTION                                                            │
│     │                                                                    │
│     ├─▶ Instant spell ───────▶ Deduct AP → Apply Effect → Add Flux     │
│     │                                                                    │
│     └─▶ Chant spell ─────────▶ Deduct AP → Set Concentration State      │
│                                     → Return ChantStarted                │
│                                                                          │
└─────────────────────────────────────────────────────────────────────────┘
```

### Code Implementation

#### A. AetherPool Model

**File:** `RuneAndRust.Core/Models/Magic/AetherPool.cs`

```csharp
namespace RuneAndRust.Core.Models.Magic;

/// <summary>
/// Represents a character's Aether (magical energy) resource pool.
/// Used for spellcasting. Regenerates slowly over time or via rest.
/// </summary>
public class AetherPool
{
    /// <summary>
    /// The current available Aether Points.
    /// </summary>
    public int Current { get; private set; }

    /// <summary>
    /// The maximum Aether Points capacity.
    /// </summary>
    public int Max { get; private set; }

    /// <summary>
    /// Percentage of Aether remaining (0.0 to 1.0).
    /// </summary>
    public float Percentage => Max > 0 ? (float)Current / Max : 0f;

    /// <summary>
    /// Whether the pool has any Aether available.
    /// </summary>
    public bool HasAether => Current > 0;

    /// <summary>
    /// Creates a new AetherPool with specified capacity.
    /// </summary>
    /// <param name="max">Maximum AP capacity.</param>
    /// <param name="startFull">If true, starts at max; otherwise starts empty.</param>
    public AetherPool(int max, bool startFull = true)
    {
        Max = Math.Max(1, max);
        Current = startFull ? Max : 0;
    }

    /// <summary>
    /// Attempts to spend Aether Points.
    /// </summary>
    /// <param name="amount">Amount to spend.</param>
    /// <returns>True if successful; false if insufficient AP.</returns>
    public bool TrySpend(int amount)
    {
        if (amount <= 0) return true;
        if (Current < amount) return false;

        Current -= amount;
        return true;
    }

    /// <summary>
    /// Restores Aether Points, clamped to maximum.
    /// </summary>
    /// <param name="amount">Amount to restore.</param>
    /// <returns>Actual amount restored.</returns>
    public int Restore(int amount)
    {
        if (amount <= 0) return 0;

        var previousCurrent = Current;
        Current = Math.Min(Current + amount, Max);
        return Current - previousCurrent;
    }

    /// <summary>
    /// Sets maximum AP, adjusting current if necessary.
    /// </summary>
    /// <param name="newMax">New maximum capacity.</param>
    public void SetMax(int newMax)
    {
        Max = Math.Max(1, newMax);
        Current = Math.Min(Current, Max);
    }

    /// <summary>
    /// Fully restores Aether to maximum.
    /// </summary>
    public void RefillToMax() => Current = Max;
}
```

#### B. CastResult Model

**File:** `RuneAndRust.Core/Models/Magic/CastResult.cs`

```csharp
namespace RuneAndRust.Core.Models.Magic;

/// <summary>
/// Result of a spell casting attempt.
/// </summary>
public record CastResult
{
    /// <summary>
    /// Whether the cast was successful.
    /// </summary>
    public bool Success { get; init; }

    /// <summary>
    /// The outcome type for this cast.
    /// </summary>
    public CastOutcome Outcome { get; init; }

    /// <summary>
    /// Human-readable message describing the result.
    /// </summary>
    public string Message { get; init; } = string.Empty;

    /// <summary>
    /// The spell that was cast (if successful or started).
    /// </summary>
    public Spell? Spell { get; init; }

    /// <summary>
    /// Amount of Aether spent.
    /// </summary>
    public int AetherSpent { get; init; }

    /// <summary>
    /// Amount of Flux generated.
    /// </summary>
    public int FluxGenerated { get; init; }

    /// <summary>
    /// Damage dealt (for damage spells).
    /// </summary>
    public int DamageDealt { get; init; }

    /// <summary>
    /// Healing done (for healing spells).
    /// </summary>
    public int HealingDone { get; init; }

    // Factory methods for common outcomes
    public static CastResult InsufficientAether(Spell spell, int current, int required) => new()
    {
        Success = false,
        Outcome = CastOutcome.InsufficientAether,
        Spell = spell,
        Message = $"Your spark is too dim. (Need {required}, have {current})"
    };

    public static CastResult SpellNotKnown(string spellName) => new()
    {
        Success = false,
        Outcome = CastOutcome.SpellNotKnown,
        Message = $"You do not know the Galdr for '{spellName}'."
    };

    public static CastResult InvalidTarget(Spell spell) => new()
    {
        Success = false,
        Outcome = CastOutcome.InvalidTarget,
        Spell = spell,
        Message = "The Galdr finds no purchase—there is no valid target."
    };

    public static CastResult AlreadyChanting(Spell currentChant) => new()
    {
        Success = false,
        Outcome = CastOutcome.AlreadyChanting,
        Spell = currentChant,
        Message = "You are already weaving a Galdr. You must finish or break it first."
    };

    public static CastResult ChantStarted(Spell spell, int turnsRemaining, int aetherSpent) => new()
    {
        Success = true,
        Outcome = CastOutcome.ChantStarted,
        Spell = spell,
        AetherSpent = aetherSpent,
        Message = $"You begin to weave the {spell.Name}... ({turnsRemaining} turns remaining)"
    };

    public static CastResult InstantSuccess(Spell spell, int aetherSpent, int fluxGenerated) => new()
    {
        Success = true,
        Outcome = CastOutcome.Success,
        Spell = spell,
        AetherSpent = aetherSpent,
        FluxGenerated = fluxGenerated,
        Message = $"The {spell.Name} unfolds from your will."
    };
}

/// <summary>
/// Possible outcomes of a spell casting attempt.
/// </summary>
public enum CastOutcome
{
    /// <summary>Spell cast successfully.</summary>
    Success,

    /// <summary>A Chant spell was started but not yet resolved.</summary>
    ChantStarted,

    /// <summary>Caster doesn't know the requested spell.</summary>
    SpellNotKnown,

    /// <summary>Not enough Aether Points.</summary>
    InsufficientAether,

    /// <summary>No valid target for targeted spell.</summary>
    InvalidTarget,

    /// <summary>Already concentrating on another spell.</summary>
    AlreadyChanting,

    /// <summary>Spell fizzled due to Backlash.</summary>
    Backlash,

    /// <summary>Concentration was broken.</summary>
    Interrupted
}
```

#### C. MagicService Implementation

**File:** `RuneAndRust.Engine/Services/MagicService.cs`

```csharp
using Microsoft.Extensions.Logging;
using RuneAndRust.Core.Entities;
using RuneAndRust.Core.Enums;
using RuneAndRust.Core.Interfaces;
using RuneAndRust.Core.Models.Magic;

namespace RuneAndRust.Engine.Services;

/// <summary>
/// Orchestrates spell casting, Aether management, and magic effect resolution.
/// </summary>
/// <remarks>
/// The MagicService is the central coordinator for all magical operations.
/// It validates cast attempts, deducts resources, manages Flux, and delegates
/// effect execution to the EffectScriptExecutor.
/// </remarks>
public class MagicService : IMagicService
{
    private readonly ILogger<MagicService> _logger;
    private readonly ISpellRepository _spellRepository;
    private readonly IAetherService _aetherService;
    private readonly IEffectScriptExecutor _effectExecutor;

    /// <summary>
    /// Initializes a new instance of the <see cref="MagicService"/> class.
    /// </summary>
    public MagicService(
        ILogger<MagicService> logger,
        ISpellRepository spellRepository,
        IAetherService aetherService,
        IEffectScriptExecutor effectExecutor)
    {
        _logger = logger;
        _spellRepository = spellRepository;
        _aetherService = aetherService;
        _effectExecutor = effectExecutor;

        _logger.LogDebug("MagicService initialized");
    }

    /// <inheritdoc/>
    public CastResult Cast(Character caster, string spellName, Entity? target = null)
    {
        _logger.LogInformation(
            "Cast attempt: {Caster} attempts to cast '{SpellName}' on {Target}",
            caster.Name, spellName, target?.Name ?? "self/no target");

        // Step 1: Resolve spell by name
        var spell = ResolveSpell(spellName);
        if (spell == null)
        {
            _logger.LogWarning("Spell lookup failed: '{SpellName}' not found", spellName);
            return CastResult.SpellNotKnown(spellName);
        }

        _logger.LogDebug(
            "Spell resolved: {SpellName} (Cost: {Cost} AP, School: {School}, CastTime: {CastTime})",
            spell.Name, spell.ApCost, spell.School, spell.CastTime);

        // Step 2: Check if already chanting
        if (caster.Concentration?.IsActive == true)
        {
            _logger.LogWarning(
                "{Caster} attempted to cast while already chanting {CurrentChant}",
                caster.Name, caster.Concentration.Spell.Name);
            return CastResult.AlreadyChanting(caster.Concentration.Spell);
        }

        // Step 3: Validate Aether
        if (!HasSufficientAether(caster, spell))
        {
            _logger.LogWarning(
                "Insufficient Aether: {Caster} has {Current}/{Max} AP, spell requires {Cost}",
                caster.Name, caster.Aether.Current, caster.Aether.Max, spell.ApCost);
            return CastResult.InsufficientAether(spell, caster.Aether.Current, spell.ApCost);
        }

        // Step 4: Validate target
        var resolvedTarget = ResolveTarget(spell, caster, target);
        if (spell.TargetType != SpellTargetType.Self && resolvedTarget == null)
        {
            _logger.LogWarning(
                "Invalid target for {SpellName}: requires {TargetType}, got null",
                spell.Name, spell.TargetType);
            return CastResult.InvalidTarget(spell);
        }

        // Step 5: Deduct Aether
        caster.Aether.TrySpend(spell.ApCost);
        _logger.LogDebug(
            "Aether spent: {Caster} spent {Cost} AP. Remaining: {Current}/{Max}",
            caster.Name, spell.ApCost, caster.Aether.Current, caster.Aether.Max);

        // Step 6: Execute based on CastTime
        if (spell.CastTime == CastTime.Instant)
        {
            return ExecuteInstantSpell(caster, spell, resolvedTarget);
        }
        else
        {
            return StartChant(caster, spell, resolvedTarget);
        }
    }

    /// <inheritdoc/>
    public CastResult ResolveChant(Character caster)
    {
        if (caster.Concentration?.IsActive != true)
        {
            _logger.LogWarning("{Caster} has no active chant to resolve", caster.Name);
            return new CastResult
            {
                Success = false,
                Outcome = CastOutcome.Interrupted,
                Message = "There is no weaving to complete."
            };
        }

        var concentration = caster.Concentration;
        var spell = concentration.Spell;
        var target = concentration.Target;

        _logger.LogInformation(
            "Resolving completed chant: {Caster} completes {SpellName}",
            caster.Name, spell.Name);

        // Clear concentration before executing
        caster.Concentration = null;

        // Execute the spell effect
        return ExecuteSpellEffect(caster, spell, target);
    }

    /// <inheritdoc/>
    public bool BreakConcentration(Character caster, string reason)
    {
        if (caster.Concentration?.IsActive != true)
        {
            _logger.LogDebug("{Caster} has no concentration to break", caster.Name);
            return false;
        }

        var spell = caster.Concentration.Spell;
        caster.Concentration = null;

        _logger.LogWarning(
            "Concentration broken: {Caster}'s {SpellName} was interrupted by {Reason}",
            caster.Name, spell.Name, reason);

        return true;
    }

    #region Private Methods

    private Spell? ResolveSpell(string spellName)
    {
        _logger.LogTrace("Resolving spell name: '{SpellName}'", spellName);

        // Try exact match first
        var spell = _spellRepository.GetByName(spellName);
        if (spell != null) return spell;

        // Try fuzzy match
        return _spellRepository.GetByNameFuzzy(spellName);
    }

    private bool HasSufficientAether(Character caster, Spell spell)
    {
        return caster.Aether.Current >= spell.ApCost;
    }

    private Entity? ResolveTarget(Spell spell, Character caster, Entity? providedTarget)
    {
        return spell.TargetType switch
        {
            SpellTargetType.Self => caster,
            SpellTargetType.SingleEnemy => providedTarget,
            SpellTargetType.SingleAlly => providedTarget ?? caster,
            _ => providedTarget
        };
    }

    private CastResult ExecuteInstantSpell(Character caster, Spell spell, Entity? target)
    {
        _logger.LogDebug(
            "Executing instant spell: {SpellName} from {Caster}",
            spell.Name, caster.Name);

        // Add Flux to environment
        _aetherService.ModifyFlux(spell.FluxCost, $"Cast:{spell.Name}");

        // Execute the effect
        return ExecuteSpellEffect(caster, spell, target);
    }

    private CastResult StartChant(Character caster, Spell spell, Entity? target)
    {
        var turns = spell.ChargeTurns;

        _logger.LogInformation(
            "Chant started: {Caster} begins {SpellName} ({Turns} turns)",
            caster.Name, spell.Name, turns);

        caster.Concentration = new ConcentrationState
        {
            Spell = spell,
            Target = target,
            TurnsRemaining = turns,
            IsActive = true
        };

        return CastResult.ChantStarted(spell, turns, spell.ApCost);
    }

    private CastResult ExecuteSpellEffect(Character caster, Spell spell, Entity? target)
    {
        _logger.LogDebug(
            "Executing spell effect: {EffectScript} on {Target}",
            spell.EffectScript, target?.Name ?? "none");

        var effectResult = _effectExecutor.Execute(spell.EffectScript, caster, target);

        _logger.LogInformation(
            "Spell complete: {Caster} cast {SpellName}. Effect: {EffectResult}",
            caster.Name, spell.Name, effectResult);

        return new CastResult
        {
            Success = true,
            Outcome = CastOutcome.Success,
            Spell = spell,
            AetherSpent = spell.ApCost,
            FluxGenerated = spell.FluxCost,
            DamageDealt = effectResult.DamageDealt,
            HealingDone = effectResult.HealingDone,
            Message = $"The {spell.Name} unfolds from your will."
        };
    }

    #endregion
}
```

### Deliverable Checklist (v0.4.5a)

#### Core Layer

- [ ] `AetherPool.cs` - Aether resource model with Current/Max/TrySpend/Restore
- [ ] `CastTime.cs` - Enum: Instant, Chant
- [ ] `CastResult.cs` - Cast outcome model with factory methods
- [ ] `CastOutcome.cs` - Enum for result types
- [ ] `IMagicService.cs` - Service interface with Cast/ResolveChant/BreakConcentration
- [ ] Add `Aether` property to `Character.cs` entity
- [ ] Add `Concentration` property to `Character.cs` entity

#### Engine Layer

- [ ] `MagicService.cs` - Full implementation with logging
- [ ] Update `CommandParser.cs` to recognize `cast` command
- [ ] Wire `MagicService` to DI container in `Program.cs`
- [ ] Hook `MagicService` into `GameService` command dispatch

#### Tests (32 tests)

| Category | Count | Test Cases |
|----------|-------|------------|
| AetherPool | 8 | TrySpend success/fail, Restore clamping, SetMax, Percentage |
| Cast Validation | 10 | Spell lookup, AP check, target validation, concentration block |
| Instant Execution | 6 | Successful cast, Flux generation, effect application |
| Chant Start | 5 | Concentration state, turns tracking, AP deduction |
| Edge Cases | 3 | Null inputs, empty spell name, unknown spell |

---

## v0.4.5b: The Chant (Multi-Turn Actions)

> **Goal:** Implement the concept of "Chanting" — actions that span multiple turns requiring concentration, with interruption mechanics.

### Scope

- **ConcentrationState** model: Tracks active Chant (spell, target, turns remaining)
- **Concentration Check**: Constitution save when taking damage while chanting
- **Turn integration**: Process Chant advancement at turn start
- **Interruption**: Movement, actions, and damage can break concentration
- **`break` command**: Voluntarily cancel an active Chant

### Architecture: Concentration Flow

```
┌─────────────────────────────────────────────────────────────────────────┐
│                       CHANT LIFECYCLE FLOW                               │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                          │
│  ┌──────────────┐                                                        │
│  │ CHANT START  │  (from MagicService.StartChant)                       │
│  │ Turns = N    │                                                        │
│  └──────┬───────┘                                                        │
│         │                                                                │
│         ▼                                                                │
│  ┌──────────────────────────────────────────────────────────────────┐   │
│  │                      TURN START CHECK                             │   │
│  │                                                                   │   │
│  │   Is Character Chanting?                                          │   │
│  │   ├─▶ NO  ─────────────▶ Normal turn processing                  │   │
│  │   │                                                               │   │
│  │   └─▶ YES                                                         │   │
│  │       │                                                           │   │
│  │       ▼                                                           │   │
│  │   Decrement TurnsRemaining                                        │   │
│  │   Log: "You continue to weave the Galdr..."                       │   │
│  │       │                                                           │   │
│  │       ├─▶ TurnsRemaining > 0                                      │   │
│  │       │   └─▶ Await input (limited options: wait, break)         │   │
│  │       │                                                           │   │
│  │       └─▶ TurnsRemaining == 0                                     │   │
│  │           └─▶ RESOLVE CHANT                                       │   │
│  │               ├─▶ Execute Spell Effect                            │   │
│  │               ├─▶ Add Flux                                        │   │
│  │               ├─▶ Clear Concentration                             │   │
│  │               └─▶ Log: "The Galdr is complete!"                   │   │
│  │                                                                   │   │
│  └───────────────────────────────────────────────────────────────────┘   │
│                                                                          │
│  ┌──────────────────────────────────────────────────────────────────┐   │
│  │                    INTERRUPTION EVENTS                            │   │
│  │                                                                   │   │
│  │   ┌─────────────┐    ┌─────────────┐    ┌─────────────┐          │   │
│  │   │  DAMAGE     │    │  MOVEMENT   │    │  BREAK CMD  │          │   │
│  │   │  TAKEN      │    │  COMMAND    │    │  (voluntary)│          │   │
│  │   └──────┬──────┘    └──────┬──────┘    └──────┬──────┘          │   │
│  │          │                  │                  │                  │   │
│  │          ▼                  ▼                  ▼                  │   │
│  │   ┌─────────────┐    ┌─────────────┐    ┌─────────────┐          │   │
│  │   │ CONC. CHECK │    │ AUTO-BREAK  │    │ AUTO-BREAK  │          │   │
│  │   │ DC=10 or    │    │ Warn first  │    │ Immediate   │          │   │
│  │   │ DMG/2       │    │ then break  │    │             │          │   │
│  │   └──────┬──────┘    └─────────────┘    └─────────────┘          │   │
│  │          │                                                        │   │
│  │          ├─▶ PASS: "You maintain focus through the pain."        │   │
│  │          │                                                        │   │
│  │          └─▶ FAIL: "Your weaving unravels!" + possible Backlash  │   │
│  │                                                                   │   │
│  └───────────────────────────────────────────────────────────────────┘   │
│                                                                          │
└─────────────────────────────────────────────────────────────────────────┘
```

### Decision Tree: Concentration Check

```
┌─────────────────────────────────────────────────────────────────────────┐
│                    CONCENTRATION CHECK DECISION TREE                     │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                          │
│  TRIGGER: DamageTakenEvent while Character.Concentration.IsActive       │
│                                                                          │
│  1. CALCULATE DC                                                         │
│     │                                                                    │
│     ├─▶ Base DC = 10                                                    │
│     ├─▶ Alternative DC = Damage / 2 (rounded down)                      │
│     └─▶ Use whichever is HIGHER                                         │
│                                                                          │
│  2. ROLL CONSTITUTION SAVE                                               │
│     │                                                                    │
│     ├─▶ Pool = Character.Constitution                                   │
│     ├─▶ Add bonuses from Concentration-boosting effects                 │
│     └─▶ Roll dice pool                                                  │
│                                                                          │
│  3. COMPARE RESULT                                                       │
│     │                                                                    │
│     ├─▶ Successes >= DC/5 (rounded up)                                  │
│     │   │                                                                │
│     │   └─▶ PASS                                                        │
│     │       ├─▶ Log: "You maintain focus through the pain."            │
│     │       └─▶ Chant continues                                         │
│     │                                                                    │
│     └─▶ Successes < Required                                            │
│         │                                                                │
│         └─▶ FAIL                                                        │
│             ├─▶ Log: "Your weaving unravels!"                           │
│             ├─▶ Clear Concentration                                      │
│             ├─▶ AP is NOT refunded                                      │
│             └─▶ Optional: Trigger Backlash if Flux is high              │
│                                                                          │
└─────────────────────────────────────────────────────────────────────────┘
```

### Code Implementation

#### A. ConcentrationState Model

**File:** `RuneAndRust.Core/Models/Magic/ConcentrationState.cs`

```csharp
namespace RuneAndRust.Core.Models.Magic;

/// <summary>
/// Tracks the state of an ongoing Chant (multi-turn spell).
/// </summary>
public class ConcentrationState
{
    /// <summary>
    /// The spell being chanted.
    /// </summary>
    public required Spell Spell { get; init; }

    /// <summary>
    /// The target of the spell (may be null for self-targeted spells).
    /// </summary>
    public Entity? Target { get; init; }

    /// <summary>
    /// Number of turns remaining before the spell completes.
    /// </summary>
    public int TurnsRemaining { get; set; }

    /// <summary>
    /// Whether the concentration is currently active.
    /// </summary>
    public bool IsActive { get; set; }

    /// <summary>
    /// Whether the chant has completed (TurnsRemaining reached 0).
    /// </summary>
    public bool IsComplete => TurnsRemaining <= 0 && IsActive;

    /// <summary>
    /// Advances the chant by one turn.
    /// </summary>
    /// <returns>True if the chant is now complete.</returns>
    public bool Advance()
    {
        if (!IsActive) return false;

        TurnsRemaining = Math.Max(0, TurnsRemaining - 1);
        return IsComplete;
    }

    /// <summary>
    /// Breaks the concentration, ending the chant prematurely.
    /// </summary>
    public void Break()
    {
        IsActive = false;
    }
}
```

#### B. ConcentrationCheckResult Model

**File:** `RuneAndRust.Core/Models/Magic/ConcentrationCheckResult.cs`

```csharp
namespace RuneAndRust.Core.Models.Magic;

/// <summary>
/// Result of a concentration check when taking damage while chanting.
/// </summary>
public record ConcentrationCheckResult
{
    /// <summary>
    /// Whether concentration was maintained.
    /// </summary>
    public bool Maintained { get; init; }

    /// <summary>
    /// The difficulty class of the check.
    /// </summary>
    public int DifficultyClass { get; init; }

    /// <summary>
    /// Number of successes rolled.
    /// </summary>
    public int SuccessesRolled { get; init; }

    /// <summary>
    /// Number of successes required.
    /// </summary>
    public int SuccessesRequired { get; init; }

    /// <summary>
    /// Damage that triggered the check.
    /// </summary>
    public int DamageTaken { get; init; }

    /// <summary>
    /// The spell that was being concentrated on.
    /// </summary>
    public Spell Spell { get; init; } = null!;

    /// <summary>
    /// Narrative message describing the outcome.
    /// </summary>
    public string Message { get; init; } = string.Empty;
}
```

#### C. Turn Manager Integration

**File:** `RuneAndRust.Engine/Services/TurnManager.cs` (additions)

```csharp
/// <summary>
/// Processes the start of a character's turn, including chant advancement.
/// </summary>
public TurnStartResult ProcessTurnStart(Character character)
{
    _logger.LogDebug("Processing turn start for {Character}", character.Name);

    var result = new TurnStartResult { Character = character };

    // Check for active concentration
    if (character.Concentration?.IsActive == true)
    {
        result = ProcessChantAdvancement(character, result);
    }

    return result;
}

private TurnStartResult ProcessChantAdvancement(Character character, TurnStartResult result)
{
    var concentration = character.Concentration!;
    var spell = concentration.Spell;

    _logger.LogInformation(
        "Chant advancement: {Character} continues {SpellName} ({TurnsRemaining} turns remaining)",
        character.Name, spell.Name, concentration.TurnsRemaining);

    // Advance the chant
    var isComplete = concentration.Advance();

    if (isComplete)
    {
        _logger.LogInformation(
            "Chant complete: {Character} finishes {SpellName}",
            character.Name, spell.Name);

        // Resolve the chant through MagicService
        var castResult = _magicService.ResolveChant(character);

        result.ChantCompleted = true;
        result.ChantResult = castResult;
        result.Messages.Add($"The {spell.Name} is complete!");
    }
    else
    {
        result.IsChanting = true;
        result.ChantTurnsRemaining = concentration.TurnsRemaining;
        result.Messages.Add($"You continue to weave the {spell.Name}... ({concentration.TurnsRemaining} turns remaining)");
    }

    return result;
}

/// <summary>
/// Performs a concentration check when the character takes damage.
/// </summary>
public ConcentrationCheckResult CheckConcentration(Character character, int damageTaken)
{
    if (character.Concentration?.IsActive != true)
    {
        _logger.LogTrace("{Character} is not concentrating, no check needed", character.Name);
        return new ConcentrationCheckResult { Maintained = true };
    }

    var spell = character.Concentration.Spell;

    // Calculate DC: higher of 10 or damage/2
    int dc = Math.Max(10, damageTaken / 2);
    int successesRequired = (dc + 4) / 5; // Roughly DC/5 rounded up

    _logger.LogDebug(
        "Concentration check: {Character} took {Damage} damage while chanting {Spell}. DC: {DC}",
        character.Name, damageTaken, spell.Name, dc);

    // Roll Constitution save
    var rollResult = _diceService.Roll(character.Constitution, $"Concentration:{spell.Name}");

    bool maintained = rollResult.Successes >= successesRequired;

    _logger.LogInformation(
        "Concentration check result: {Character} rolled {Successes} successes (needed {Required}). {Outcome}",
        character.Name, rollResult.Successes, successesRequired,
        maintained ? "MAINTAINED" : "BROKEN");

    if (!maintained)
    {
        _magicService.BreakConcentration(character, $"damage ({damageTaken})");
    }

    return new ConcentrationCheckResult
    {
        Maintained = maintained,
        DifficultyClass = dc,
        SuccessesRolled = rollResult.Successes,
        SuccessesRequired = successesRequired,
        DamageTaken = damageTaken,
        Spell = spell,
        Message = maintained
            ? "You maintain focus through the pain."
            : "Your weaving unravels!"
    };
}
```

### Deliverable Checklist (v0.4.5b)

#### Core Layer

- [ ] `ConcentrationState.cs` - Model with Spell, Target, TurnsRemaining, IsActive
- [ ] `ConcentrationCheckResult.cs` - Result model for concentration saves
- [ ] Add `Concentration` property to `Character.cs`

#### Engine Layer

- [ ] Update `TurnManager.cs` with `ProcessChantAdvancement()`
- [ ] Add `CheckConcentration()` method to handle damage interruption
- [ ] Update `CombatService.cs` to call `CheckConcentration()` on damage
- [ ] Implement `break` command in `CommandParser.cs`
- [ ] Add command restrictions while chanting (only `wait`, `break` allowed)

#### Tests (38 tests)

| Category | Count | Test Cases |
|----------|-------|------------|
| ConcentrationState | 6 | Advance, Break, IsComplete, edge cases |
| Chant Advancement | 8 | Turn processing, completion, message generation |
| Concentration Check | 12 | DC calculation, dice rolling, pass/fail outcomes |
| Interruption | 7 | Damage break, movement break, voluntary break |
| Command Restrictions | 5 | Allowed/disallowed commands while chanting |

---

## v0.4.5c: The Grim (Spell Implementation)

> **Goal:** Populate the game with the first set of "Mystic" spells, ensuring they work with the Effect system.

### Scope

- **5 starter spells** covering different schools and cast times
- **Effect script integration** with EffectScriptExecutor
- **Spell seeding** via database migration
- **Domain 4 compliant descriptions**

### Spell Catalog (Tier 1)

| # | Spell Name | School | AP Cost | Flux | Cast Time | Target | Effect |
|---|------------|--------|---------|------|-----------|--------|--------|
| 1 | **Wyrd-Light** | Vision | 2 | 3 | Instant | Self | Applies `Illuminated` status (removes Dark penalty for 10 turns) |
| 2 | **Rot-Bolt** | Entropy | 5 | 8 | Instant | SingleEnemy | Ranged attack: 1d8 Necrotic damage |
| 3 | **Mend-Flesh** | Mending | 8 | 5 | Chant(1) | SingleAlly | Heals 1d8 + Wisdom HP |
| 4 | **Rust-Cloud** | Entropy | 10 | 12 | Chant(2) | AllEnemies | Applies `Corroded` status (Armor -2 for 5 turns) |
| 5 | **Spirit-Ward** | Vision | 5 | 4 | Instant | Self | Applies `Warded` status (+2 Armor vs Spectral for 10 turns) |

### Spell Detail Specifications

#### Spell 1: Wyrd-Light

```
┌─────────────────────────────────────────────────────────────────────────┐
│                           WYRD-LIGHT                                     │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                          │
│  CLASSIFICATION                                                          │
│  ├─ School: Vision                                                       │
│  ├─ Tier: 1 (Novice)                                                    │
│  ├─ Cast Time: Instant                                                   │
│  └─ Target: Self                                                         │
│                                                                          │
│  RESOURCE COST                                                           │
│  ├─ Aether Points: 2                                                     │
│  └─ Flux Generated: 3                                                    │
│                                                                          │
│  EFFECT                                                                  │
│  ├─ Script: "STATUS:Illuminated:10"                                     │
│  ├─ Duration: 10 turns                                                   │
│  └─ Benefit: Negates darkness penalties, reveals hidden objects         │
│                                                                          │
│  DOMAIN 4 DESCRIPTION                                                    │
│  "A cold gleam blooms at your fingertips—not fire, but something        │
│   older. The shadows retreat, hissing. For a time, the dark cannot      │
│   swallow what the Wyrd-Light touches."                                 │
│                                                                          │
│  TELEGRAPH MESSAGE                                                       │
│  (N/A - Instant spell)                                                  │
│                                                                          │
└─────────────────────────────────────────────────────────────────────────┘
```

#### Spell 2: Rot-Bolt

```
┌─────────────────────────────────────────────────────────────────────────┐
│                            ROT-BOLT                                      │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                          │
│  CLASSIFICATION                                                          │
│  ├─ School: Entropy                                                      │
│  ├─ Tier: 1 (Novice)                                                    │
│  ├─ Cast Time: Instant                                                   │
│  └─ Target: SingleEnemy                                                  │
│                                                                          │
│  RESOURCE COST                                                           │
│  ├─ Aether Points: 5                                                     │
│  └─ Flux Generated: 8                                                    │
│                                                                          │
│  EFFECT                                                                  │
│  ├─ Script: "DAMAGE:Necrotic:1d8"                                       │
│  ├─ Range: Medium (2 zones)                                              │
│  └─ Damage Type: Necrotic (bypasses physical armor)                     │
│                                                                          │
│  DOMAIN 4 DESCRIPTION                                                    │
│  "You reach into the space between moments and pull. Something dark     │
│   and hungry answers—a shard of entropy that screams toward the         │
│   target, leaving a trail of withered air."                             │
│                                                                          │
│  ON HIT MESSAGE                                                          │
│  "The Rot-Bolt strikes true. Flesh blackens and crumbles at its         │
│   touch—{Damage} points of purest decay."                               │
│                                                                          │
│  ON MISS MESSAGE                                                         │
│  "The Rot-Bolt hisses past, spending itself against uncaring stone."    │
│                                                                          │
└─────────────────────────────────────────────────────────────────────────┘
```

#### Spell 3: Mend-Flesh

```
┌─────────────────────────────────────────────────────────────────────────┐
│                           MEND-FLESH                                     │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                          │
│  CLASSIFICATION                                                          │
│  ├─ School: Mending                                                      │
│  ├─ Tier: 1 (Novice)                                                    │
│  ├─ Cast Time: Chant(1) — requires 1 turn of concentration              │
│  └─ Target: SingleAlly (includes self)                                  │
│                                                                          │
│  RESOURCE COST                                                           │
│  ├─ Aether Points: 8                                                     │
│  └─ Flux Generated: 5                                                    │
│                                                                          │
│  EFFECT                                                                  │
│  ├─ Script: "HEAL:1d8+WIS"                                              │
│  ├─ Healing: 1d8 + Wisdom modifier                                      │
│  └─ Note: Requires concentration; can be interrupted                    │
│                                                                          │
│  DOMAIN 4 DESCRIPTION                                                    │
│  "You speak the words that make flesh remember what it was before       │
│   the wound. Slowly—painfully—the body recalls its unbroken shape."     │
│                                                                          │
│  CHANT MESSAGE (while casting)                                          │
│  "You weave the threads of Mending, coaxing torn tissue to knit..."     │
│                                                                          │
│  COMPLETION MESSAGE                                                      │
│  "The Mend-Flesh takes hold. Wounds close with wet, sucking sounds.     │
│   {Healing} points of damage undone."                                   │
│                                                                          │
│  INTERRUPTED MESSAGE                                                     │
│  "The threads of Mending scatter—the flesh forgets."                    │
│                                                                          │
└─────────────────────────────────────────────────────────────────────────┘
```

#### Spell 4: Rust-Cloud

```
┌─────────────────────────────────────────────────────────────────────────┐
│                           RUST-CLOUD                                     │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                          │
│  CLASSIFICATION                                                          │
│  ├─ School: Entropy                                                      │
│  ├─ Tier: 1 (Novice)                                                    │
│  ├─ Cast Time: Chant(2) — requires 2 turns of concentration             │
│  └─ Target: AllEnemies (area effect)                                    │
│                                                                          │
│  RESOURCE COST                                                           │
│  ├─ Aether Points: 10                                                    │
│  └─ Flux Generated: 12                                                   │
│                                                                          │
│  EFFECT                                                                  │
│  ├─ Script: "STATUS:Corroded:5|ARMOR:-2"                                │
│  ├─ Duration: 5 turns                                                    │
│  ├─ Effect: All enemies gain `Corroded` status                          │
│  └─ Penalty: Armor reduced by 2 while Corroded                          │
│                                                                          │
│  DOMAIN 4 DESCRIPTION                                                    │
│  "You call to the entropy that sleeps in all metal, all order.          │
│   A rust-red mist bleeds from your fingers, hungry for structure."      │
│                                                                          │
│  CHANT MESSAGE (Turn 1)                                                 │
│  "Crimson vapor begins to curl from your palms..."                      │
│                                                                          │
│  CHANT MESSAGE (Turn 2)                                                 │
│  "The Rust-Cloud thickens, straining against your will..."              │
│                                                                          │
│  COMPLETION MESSAGE                                                      │
│  "The Rust-Cloud billows forth! Metal screams as oxidation              │
│   consumes it. All foes are Corroded."                                  │
│                                                                          │
└─────────────────────────────────────────────────────────────────────────┘
```

#### Spell 5: Spirit-Ward

```
┌─────────────────────────────────────────────────────────────────────────┐
│                           SPIRIT-WARD                                    │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                          │
│  CLASSIFICATION                                                          │
│  ├─ School: Vision                                                       │
│  ├─ Tier: 1 (Novice)                                                    │
│  ├─ Cast Time: Instant                                                   │
│  └─ Target: Self                                                         │
│                                                                          │
│  RESOURCE COST                                                           │
│  ├─ Aether Points: 5                                                     │
│  └─ Flux Generated: 4                                                    │
│                                                                          │
│  EFFECT                                                                  │
│  ├─ Script: "STATUS:Warded:10|ARMOR_VS:Spectral:+2"                     │
│  ├─ Duration: 10 turns                                                   │
│  └─ Benefit: +2 Armor specifically against Spectral damage types        │
│                                                                          │
│  DOMAIN 4 DESCRIPTION                                                    │
│  "You trace a pattern in the air—the old signs that the dead            │
│   remember. For a time, the spirits will find it harder to              │
│   touch you."                                                            │
│                                                                          │
│  CAST MESSAGE                                                            │
│  "A faint shimmer settles over your skin—the Spirit-Ward takes hold.    │
│   Ghostly fingers will find less purchase here."                        │
│                                                                          │
└─────────────────────────────────────────────────────────────────────────┘
```

### Database Seeding

**File:** `RuneAndRust.Persistence/Seeders/SpellSeeder.cs`

```csharp
using Microsoft.Extensions.Logging;
using RuneAndRust.Core.Entities;
using RuneAndRust.Core.Enums;

namespace RuneAndRust.Persistence.Seeders;

/// <summary>
/// Seeds the database with initial spell definitions.
/// </summary>
public class SpellSeeder
{
    private readonly ILogger<SpellSeeder> _logger;
    private readonly ISpellRepository _repository;

    public SpellSeeder(ILogger<SpellSeeder> logger, ISpellRepository repository)
    {
        _logger = logger;
        _repository = repository;
    }

    public async Task SeedAsync()
    {
        _logger.LogInformation("Beginning spell seeding...");

        var spells = GetTier1Spells();

        foreach (var spell in spells)
        {
            var existing = await _repository.GetByNameAsync(spell.Name);
            if (existing != null)
            {
                _logger.LogDebug("Spell {SpellName} already exists, skipping", spell.Name);
                continue;
            }

            await _repository.AddAsync(spell);
            _logger.LogInformation("Seeded spell: {SpellName} ({School})", spell.Name, spell.School);
        }

        _logger.LogInformation("Spell seeding complete. {Count} spells processed.", spells.Count);
    }

    private List<Spell> GetTier1Spells()
    {
        return new List<Spell>
        {
            new Spell
            {
                Id = Guid.Parse("11111111-1111-1111-1111-111111111111"),
                Name = "Wyrd-Light",
                Description = "A cold gleam blooms at your fingertips—not fire, but something older. The shadows retreat, hissing.",
                School = SpellSchool.Vision,
                TargetType = SpellTargetType.Self,
                Range = SpellRange.Self,
                ApCost = 2,
                FluxCost = 3,
                EffectScript = "STATUS:Illuminated:10",
                CastTime = CastTime.Instant,
                ChargeTurns = 0,
                RequiresConcentration = false
            },
            new Spell
            {
                Id = Guid.Parse("22222222-2222-2222-2222-222222222222"),
                Name = "Rot-Bolt",
                Description = "A shard of entropy that screams toward the target, leaving a trail of withered air.",
                School = SpellSchool.Entropy,
                TargetType = SpellTargetType.SingleEnemy,
                Range = SpellRange.Medium,
                ApCost = 5,
                FluxCost = 8,
                EffectScript = "DAMAGE:Necrotic:1d8",
                CastTime = CastTime.Instant,
                ChargeTurns = 0,
                RequiresConcentration = false
            },
            new Spell
            {
                Id = Guid.Parse("33333333-3333-3333-3333-333333333333"),
                Name = "Mend-Flesh",
                Description = "You speak the words that make flesh remember what it was before the wound.",
                School = SpellSchool.Mending,
                TargetType = SpellTargetType.SingleAlly,
                Range = SpellRange.Close,
                ApCost = 8,
                FluxCost = 5,
                EffectScript = "HEAL:1d8+WIS",
                CastTime = CastTime.Chant,
                ChargeTurns = 1,
                RequiresConcentration = true,
                TelegraphMessage = "You weave the threads of Mending, coaxing torn tissue to knit..."
            },
            new Spell
            {
                Id = Guid.Parse("44444444-4444-4444-4444-444444444444"),
                Name = "Rust-Cloud",
                Description = "A rust-red mist bleeds from your fingers, hungry for structure.",
                School = SpellSchool.Entropy,
                TargetType = SpellTargetType.AllEnemies,
                Range = SpellRange.Close,
                ApCost = 10,
                FluxCost = 12,
                EffectScript = "STATUS:Corroded:5|ARMOR:-2",
                CastTime = CastTime.Chant,
                ChargeTurns = 2,
                RequiresConcentration = true,
                TelegraphMessage = "Crimson vapor begins to curl from your palms..."
            },
            new Spell
            {
                Id = Guid.Parse("55555555-5555-5555-5555-555555555555"),
                Name = "Spirit-Ward",
                Description = "The old signs that the dead remember. Ghostly fingers will find less purchase here.",
                School = SpellSchool.Vision,
                TargetType = SpellTargetType.Self,
                Range = SpellRange.Self,
                ApCost = 5,
                FluxCost = 4,
                EffectScript = "STATUS:Warded:10|ARMOR_VS:Spectral:+2",
                CastTime = CastTime.Instant,
                ChargeTurns = 0,
                RequiresConcentration = false
            }
        };
    }
}
```

### Deliverable Checklist (v0.4.5c)

#### Data Layer

- [ ] `SpellSeeder.cs` - Seeder class with 5 Tier 1 spells
- [ ] `V045__SeedTier1Spells.sql` - Database migration for spell data
- [ ] Verify EffectScript syntax compatibility with `EffectScriptExecutor`

#### Core Layer

- [ ] Add `Illuminated` status effect definition
- [ ] Add `Corroded` status effect definition
- [ ] Add `Warded` status effect definition
- [ ] Ensure `HEAL` effect script supports attribute modifiers (WIS)

#### Engine Layer

- [ ] Update `EffectScriptExecutor` to handle `STATUS:*` scripts
- [ ] Update `EffectScriptExecutor` to handle `ARMOR_VS:*:*` conditional armor
- [ ] Verify `DAMAGE:*:*` and `HEAL:*` scripts work correctly

#### Tests (28 tests)

| Category | Count | Test Cases |
|----------|-------|------------|
| Spell Seeding | 5 | Each spell seeds correctly |
| Effect Execution | 10 | Each effect script produces correct outcome |
| Status Application | 8 | Illuminated, Corroded, Warded apply/expire correctly |
| Integration | 5 | Full cast → effect → log flow for each spell |

---

## v0.4.5d: The Weaver (TUI & Feedback)

> **Goal:** Provide visual cues for magic use in the Terminal UI, including Aether bars, school-colored logs, and chant progress indicators.

### Scope

- **Aether bar** in combat HUD (alongside Health/Stamina)
- **Flux indicator** showing environmental magic volatility
- **School-colored log messages** for different magic types
- **Chant overlay** showing progress during multi-turn spells
- **Spell list command** to view known spells

### UI Layout: Combat HUD with Magic

```
┌─────────────────────────────────────────────────────────────────────────┐
│                         COMBAT HUD (Updated)                             │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                          │
│  ┌────────────────────────────────────────────────────────────────────┐ │
│  │                        STATUS PANEL                                 │ │
│  │                                                                     │ │
│  │   HEALTH  ████████████████████░░░░░  42/50                         │ │
│  │   STAMINA ██████████████░░░░░░░░░░░  28/50                         │ │
│  │   AETHER  ████████░░░░░░░░░░░░░░░░░  16/40   ← NEW                 │ │
│  │                                                                     │ │
│  │   FLUX    ▓▓▓▓▓░░░░░░░░░░░░░░░░░░░░  23/100  [ELEVATED]  ← NEW    │ │
│  │                                                                     │ │
│  └────────────────────────────────────────────────────────────────────┘ │
│                                                                          │
│  ┌────────────────────────────────────────────────────────────────────┐ │
│  │                        CHANT OVERLAY                   ← NEW       │ │
│  │                                                                     │ │
│  │   ╔════════════════════════════════════════════════════════════╗   │ │
│  │   ║  WEAVING GALDR: Rust-Cloud                                 ║   │ │
│  │   ║  [████████████████████░░░░░░░░░░]  1/2 turns               ║   │ │
│  │   ║                                                            ║   │ │
│  │   ║  "Crimson vapor begins to curl from your palms..."        ║   │ │
│  │   ╚════════════════════════════════════════════════════════════╝   │ │
│  │                                                                     │ │
│  └────────────────────────────────────────────────────────────────────┘ │
│                                                                          │
│  ┌────────────────────────────────────────────────────────────────────┐ │
│  │                        COMBAT LOG                                   │ │
│  │                                                                     │ │
│  │   [Turn 3]                                                          │ │
│  │   The rot-beast lunges with corroded claws... MISS.                │ │
│  │   ▸ You cast Rot-Bolt!                          ← MediumPurple     │ │
│  │   ▸ The Rot-Bolt strikes true. 7 damage.        ← Green (Entropy)  │ │
│  │   ▸ Aether: 21 → 16 (-5)                        ← Cyan             │ │
│  │   ▸ Flux rises to 31. [ELEVATED]                ← Yellow           │ │
│  │                                                                     │ │
│  └────────────────────────────────────────────────────────────────────┘ │
│                                                                          │
└─────────────────────────────────────────────────────────────────────────┘
```

### Color Scheme by Magic School

| School | Primary Color | Accent Color | Use Case |
|--------|---------------|--------------|----------|
| **Entropy** | `Green` | `DarkGreen` | Decay, corrosion, necrotic spells |
| **Mending** | `Gold` | `Yellow` | Healing, restoration spells |
| **Vision** | `Cyan` | `Blue` | Light, warding, divination spells |
| **Universal** | `MediumPurple` | `DarkMagenta` | Generic magic messages |

### Flux Threshold Colors

| Threshold | Range | Color | Label |
|-----------|-------|-------|-------|
| Safe | 0-24 | `DarkGray` | — |
| Elevated | 25-49 | `Yellow` | [ELEVATED] |
| Critical | 50-74 | `Orange` | [CRITICAL] |
| Overload | 75-100 | `Red` | [OVERLOAD] |

### Code Implementation

#### A. Aether Bar Renderer

**File:** `RuneAndRust.Terminal/Renderers/AetherBarRenderer.cs`

```csharp
using Spectre.Console;
using RuneAndRust.Core.Models.Magic;

namespace RuneAndRust.Terminal.Renderers;

/// <summary>
/// Renders the Aether resource bar in the combat HUD.
/// </summary>
public static class AetherBarRenderer
{
    private static readonly Color AetherFillColor = new Color(138, 43, 226); // BlueViolet
    private static readonly Color AetherEmptyColor = new Color(60, 20, 90);   // Dark purple

    /// <summary>
    /// Renders the Aether bar to the console.
    /// </summary>
    public static void Render(AetherPool aether, int barWidth = 25)
    {
        var percentage = aether.Percentage;
        var filledWidth = (int)(barWidth * percentage);
        var emptyWidth = barWidth - filledWidth;

        var filledBar = new string('█', filledWidth);
        var emptyBar = new string('░', emptyWidth);

        var table = new Table()
            .Border(TableBorder.None)
            .HideHeaders()
            .AddColumn(new TableColumn("Label").Width(8))
            .AddColumn(new TableColumn("Bar").Width(barWidth + 2))
            .AddColumn(new TableColumn("Values").Width(10));

        table.AddRow(
            new Markup("[mediumpurple1]AETHER[/]"),
            new Markup($"[blueviolet]{filledBar}[/][grey]{emptyBar}[/]"),
            new Markup($"[white]{aether.Current}/{aether.Max}[/]")
        );

        AnsiConsole.Write(table);
    }
}
```

#### B. Flux Indicator Renderer

**File:** `RuneAndRust.Terminal/Renderers/FluxIndicatorRenderer.cs`

```csharp
using Spectre.Console;
using RuneAndRust.Core.Enums;
using RuneAndRust.Core.Models.Magic;

namespace RuneAndRust.Terminal.Renderers;

/// <summary>
/// Renders the environmental Flux indicator.
/// </summary>
public static class FluxIndicatorRenderer
{
    /// <summary>
    /// Renders the Flux bar with threshold coloring.
    /// </summary>
    public static void Render(FluxState flux, int barWidth = 25)
    {
        var percentage = flux.CurrentValue / 100f;
        var filledWidth = (int)(barWidth * percentage);
        var emptyWidth = barWidth - filledWidth;

        var (fillColor, label) = GetThresholdStyle(flux.Threshold);

        var filledBar = new string('▓', filledWidth);
        var emptyBar = new string('░', emptyWidth);

        var labelMarkup = string.IsNullOrEmpty(label)
            ? ""
            : $" [{fillColor}][{label}][/]";

        AnsiConsole.MarkupLine(
            $"   [grey]FLUX[/]    [{fillColor}]{filledBar}[/][grey]{emptyBar}[/]  " +
            $"[white]{flux.CurrentValue}/100[/]{labelMarkup}");
    }

    private static (string color, string label) GetThresholdStyle(FluxThreshold threshold)
    {
        return threshold switch
        {
            FluxThreshold.Safe => ("grey", ""),
            FluxThreshold.Elevated => ("yellow", "ELEVATED"),
            FluxThreshold.Critical => ("orange1", "CRITICAL"),
            FluxThreshold.Overload => ("red", "OVERLOAD"),
            _ => ("grey", "")
        };
    }
}
```

#### C. Chant Overlay Renderer

**File:** `RuneAndRust.Terminal/Renderers/ChantOverlayRenderer.cs`

```csharp
using Spectre.Console;
using RuneAndRust.Core.Models.Magic;

namespace RuneAndRust.Terminal.Renderers;

/// <summary>
/// Renders the chant progress overlay during multi-turn spells.
/// </summary>
public static class ChantOverlayRenderer
{
    /// <summary>
    /// Renders the chant overlay if a chant is active.
    /// </summary>
    public static void Render(ConcentrationState? concentration)
    {
        if (concentration?.IsActive != true) return;

        var spell = concentration.Spell;
        var totalTurns = spell.ChargeTurns;
        var turnsComplete = totalTurns - concentration.TurnsRemaining;
        var percentage = (float)turnsComplete / totalTurns;

        var panel = new Panel(BuildChantContent(spell, concentration, percentage))
        {
            Header = new PanelHeader($"[bold mediumpurple1] WEAVING GALDR: {spell.Name} [/]"),
            Border = BoxBorder.Double,
            BorderStyle = new Style(Color.MediumPurple1)
        };

        AnsiConsole.Write(panel);
    }

    private static string BuildChantContent(
        Spell spell,
        ConcentrationState concentration,
        float percentage)
    {
        const int barWidth = 30;
        var filledWidth = (int)(barWidth * percentage);
        var emptyWidth = barWidth - filledWidth;

        var progressBar = $"[mediumpurple1]{new string('█', filledWidth)}[/]" +
                          $"[grey]{new string('░', emptyWidth)}[/]";

        var turnsText = $"{spell.ChargeTurns - concentration.TurnsRemaining}/{spell.ChargeTurns} turns";

        var telegraphMessage = !string.IsNullOrEmpty(spell.TelegraphMessage)
            ? $"\n\n[italic grey]\"{spell.TelegraphMessage}\"[/]"
            : "";

        return $"[{progressBar}]  {turnsText}{telegraphMessage}";
    }
}
```

#### D. Magic Log Formatter

**File:** `RuneAndRust.Engine/Services/MagicLogFormatter.cs`

```csharp
using Spectre.Console;
using RuneAndRust.Core.Enums;
using RuneAndRust.Core.Models.Magic;

namespace RuneAndRust.Engine.Services;

/// <summary>
/// Formats magic-related log messages with appropriate colors.
/// </summary>
public static class MagicLogFormatter
{
    /// <summary>
    /// Formats a spell cast message with school-appropriate coloring.
    /// </summary>
    public static string FormatCastMessage(Spell spell, string message)
    {
        var color = GetSchoolColor(spell.School);
        return $"[{color}]▸ {message}[/]";
    }

    /// <summary>
    /// Formats an Aether change notification.
    /// </summary>
    public static string FormatAetherChange(int oldValue, int newValue, int spent)
    {
        return $"[cyan]▸ Aether: {oldValue} → {newValue} (-{spent})[/]";
    }

    /// <summary>
    /// Formats a Flux change notification.
    /// </summary>
    public static string FormatFluxChange(int newValue, FluxThreshold threshold)
    {
        var thresholdLabel = threshold != FluxThreshold.Safe
            ? $" [{threshold.ToString().ToUpper()}]"
            : "";
        var color = GetThresholdColor(threshold);
        return $"[{color}]▸ Flux rises to {newValue}.{thresholdLabel}[/]";
    }

    private static string GetSchoolColor(SpellSchool school)
    {
        return school switch
        {
            SpellSchool.Entropy => "green",
            SpellSchool.Mending => "gold1",
            SpellSchool.Vision => "cyan",
            _ => "mediumpurple1"
        };
    }

    private static string GetThresholdColor(FluxThreshold threshold)
    {
        return threshold switch
        {
            FluxThreshold.Safe => "grey",
            FluxThreshold.Elevated => "yellow",
            FluxThreshold.Critical => "orange1",
            FluxThreshold.Overload => "red",
            _ => "grey"
        };
    }
}
```

### Deliverable Checklist (v0.4.5d)

#### Terminal Layer

- [ ] `AetherBarRenderer.cs` - Renders Aether resource bar
- [ ] `FluxIndicatorRenderer.cs` - Renders Flux with threshold colors
- [ ] `ChantOverlayRenderer.cs` - Renders chant progress during multi-turn spells
- [ ] Update `CombatScreenRenderer.cs` to include magic UI elements
- [ ] Update `StatusPanelRenderer.cs` to include Aether bar

#### Engine Layer

- [ ] `MagicLogFormatter.cs` - School-colored log message formatting
- [ ] Update `CombatLogFormatter.cs` to use magic formatting for spell events

#### Assets/Config

- [ ] Define color constants in `ThemeService.cs` for magic schools
- [ ] Add Flux threshold color definitions
- [ ] Create `spells` command to list known spells

#### Tests (18 tests)

| Category | Count | Test Cases |
|----------|-------|------------|
| Bar Rendering | 6 | Aether bar at various percentages, empty, full |
| Flux Indicator | 4 | Each threshold renders with correct color/label |
| Chant Overlay | 4 | Active chant, progress calculation, telegraph display |
| Color Formatting | 4 | Each school color, threshold colors |

---

## Architecture Diagrams

### System Component Diagram

```
┌─────────────────────────────────────────────────────────────────────────┐
│                     v0.4.5 MAGIC SYSTEM ARCHITECTURE                     │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                          │
│  ┌──────────────────────────────────────────────────────────────────┐   │
│  │                         CORE LAYER                                │   │
│  │                                                                   │   │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────────────────┐  │   │
│  │  │ AetherPool  │  │    Spell    │  │  ConcentrationState     │  │   │
│  │  │ (Resource)  │  │  (Entity)   │  │  (Multi-turn tracking)  │  │   │
│  │  └─────────────┘  └─────────────┘  └─────────────────────────┘  │   │
│  │                                                                   │   │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────────────────┐  │   │
│  │  │ CastResult  │  │  FluxState  │  │  IMagicService          │  │   │
│  │  │ (Outcome)   │  │  (Env.)     │  │  (Contract)             │  │   │
│  │  └─────────────┘  └─────────────┘  └─────────────────────────┘  │   │
│  │                                                                   │   │
│  └──────────────────────────────────────────────────────────────────┘   │
│                                   │                                      │
│                                   ▼                                      │
│  ┌──────────────────────────────────────────────────────────────────┐   │
│  │                        ENGINE LAYER                               │   │
│  │                                                                   │   │
│  │  ┌─────────────────────────────────────────────────────────────┐ │   │
│  │  │                      MagicService                            │ │   │
│  │  │  ├─ Cast(caster, spell, target)                             │ │   │
│  │  │  ├─ ResolveChant(caster)                                    │ │   │
│  │  │  └─ BreakConcentration(caster, reason)                      │ │   │
│  │  └─────────────────────────────────────────────────────────────┘ │   │
│  │                           │                                       │   │
│  │         ┌─────────────────┼─────────────────┐                    │   │
│  │         ▼                 ▼                 ▼                    │   │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────────────────┐  │   │
│  │  │AetherService│  │SpellRepo    │  │EffectScriptExecutor     │  │   │
│  │  │(Flux mgmt)  │  │(Data access)│  │(Effect resolution)      │  │   │
│  │  └─────────────┘  └─────────────┘  └─────────────────────────┘  │   │
│  │                                                                   │   │
│  │  ┌─────────────────────────────────────────────────────────────┐ │   │
│  │  │                      TurnManager                             │ │   │
│  │  │  ├─ ProcessTurnStart() → ChantAdvancement                   │ │   │
│  │  │  └─ CheckConcentration() → DamageInterruption               │ │   │
│  │  └─────────────────────────────────────────────────────────────┘ │   │
│  │                                                                   │   │
│  └──────────────────────────────────────────────────────────────────┘   │
│                                   │                                      │
│                                   ▼                                      │
│  ┌──────────────────────────────────────────────────────────────────┐   │
│  │                       TERMINAL LAYER                              │   │
│  │                                                                   │   │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────────────────┐  │   │
│  │  │AetherBar    │  │FluxIndicator│  │ChantOverlay             │  │   │
│  │  │Renderer     │  │Renderer     │  │Renderer                 │  │   │
│  │  └─────────────┘  └─────────────┘  └─────────────────────────┘  │   │
│  │                                                                   │   │
│  │  ┌─────────────────────────────────────────────────────────────┐ │   │
│  │  │                   CombatScreenRenderer                       │ │   │
│  │  │  (Integrates all magic UI components)                       │ │   │
│  │  └─────────────────────────────────────────────────────────────┘ │   │
│  │                                                                   │   │
│  └──────────────────────────────────────────────────────────────────┘   │
│                                                                          │
└─────────────────────────────────────────────────────────────────────────┘
```

### Sequence Diagram: Complete Chant Flow

```
┌─────────────────────────────────────────────────────────────────────────┐
│                    CHANT SPELL SEQUENCE DIAGRAM                          │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                          │
│  Player      CommandParser    MagicService    TurnManager    Renderer   │
│    │              │               │               │              │       │
│    │ cast mend    │               │               │              │       │
│    │─────────────▶│               │               │              │       │
│    │              │ Cast(mend)    │               │              │       │
│    │              │──────────────▶│               │              │       │
│    │              │               │ Validate      │              │       │
│    │              │               │ Deduct AP     │              │       │
│    │              │               │ Set Conc.     │              │       │
│    │              │ ChantStarted  │               │              │       │
│    │              │◀──────────────│               │              │       │
│    │ "You begin   │               │               │              │       │
│    │  weaving..." │               │               │ Render       │       │
│    │◀─────────────│───────────────│───────────────│─────────────▶│       │
│    │              │               │               │  ChantOverlay│       │
│    │              │               │               │              │       │
│    ├──────────────────────── TURN ENDS ─────────────────────────┤       │
│    │              │               │               │              │       │
│    │              │               │ TurnStart()   │              │       │
│    │              │               │◀──────────────│              │       │
│    │              │               │ Advance()     │              │       │
│    │              │               │ TurnsRem=0    │              │       │
│    │              │               │ ResolveChant()│              │       │
│    │              │               │──────────────▶│              │       │
│    │              │               │ Execute Effect│              │       │
│    │              │               │ Add Flux      │              │       │
│    │              │               │ Clear Conc.   │              │       │
│    │              │               │               │              │       │
│    │ "The Galdr   │               │               │ Update HUD   │       │
│    │  is complete!"              │               │─────────────▶│       │
│    │◀─────────────│───────────────│───────────────│              │       │
│    │              │               │               │              │       │
│                                                                          │
└─────────────────────────────────────────────────────────────────────────┘
```

---

## Logging Requirements

### Logging Matrix

| System | Event | Level | Message Template | Properties |
|--------|-------|-------|------------------|------------|
| Magic | CastAttempt | Info | "{Caster} attempts to cast '{SpellName}' on {Target}" | Caster, SpellName, Target |
| Magic | CastSuccess | Info | "{Caster} casts {SpellName} (Cost: {Cost} AP, Flux: +{Flux})" | Caster, SpellName, Cost, Flux |
| Magic | CastFail | Warning | "Cast failed: {Reason}. {Caster} tried {SpellName}" | Reason, Caster, SpellName |
| Magic | ChantStart | Info | "{Caster} begins chanting {SpellName} ({Turns} turns)" | Caster, SpellName, Turns |
| Magic | ChantAdvance | Debug | "{Caster} continues {SpellName} ({TurnsRemaining} remaining)" | Caster, SpellName, TurnsRemaining |
| Magic | ChantComplete | Info | "{Caster} completes {SpellName}" | Caster, SpellName |
| Magic | ChantBreak | Warning | "{Caster}'s chant of {SpellName} was broken by {Reason}" | Caster, SpellName, Reason |
| Magic | ConcentrationCheck | Debug | "Concentration check: DC {DC}, rolled {Successes}/{Required}" | DC, Successes, Required |
| Magic | AetherChange | Debug | "{Character} Aether: {Old} → {New} ({Delta})" | Character, Old, New, Delta |
| Magic | FluxChange | Debug | "Flux: {Old} → {New} ({Delta}). Threshold: {Threshold}" | Old, New, Delta, Threshold |
| Magic | SpellResolved | Trace | "Spell effect executed: {EffectScript} on {Target}" | EffectScript, Target |

### Logging Code Example

```csharp
// In MagicService.Cast()
_logger.LogInformation(
    "Cast attempt: {Caster} attempts to cast '{SpellName}' on {Target}",
    caster.Name, spellName, target?.Name ?? "self/no target");

// On success
_logger.LogInformation(
    "{Caster} casts {SpellName} (Cost: {Cost} AP, Flux: +{Flux})",
    caster.Name, spell.Name, spell.ApCost, spell.FluxCost);

// On failure
_logger.LogWarning(
    "Cast failed: {Reason}. {Caster} tried {SpellName}",
    "Insufficient Aether", caster.Name, spell.Name);

// Chant events
_logger.LogInformation(
    "{Caster} begins chanting {SpellName} ({Turns} turns)",
    caster.Name, spell.Name, spell.ChargeTurns);

_logger.LogWarning(
    "{Caster}'s chant of {SpellName} was broken by {Reason}",
    caster.Name, spell.Name, "damage (15)");
```

---

## Testing Strategy

### Unit Test Organization

```
RuneAndRust.Tests/
├── Core/
│   └── Models/
│       └── Magic/
│           ├── AetherPoolTests.cs        (8 tests)
│           ├── CastResultTests.cs        (6 tests)
│           └── ConcentrationStateTests.cs (6 tests)
├── Engine/
│   └── Services/
│       ├── MagicServiceTests.cs          (28 tests)
│       ├── TurnManager_ChantTests.cs     (18 tests)
│       └── ConcentrationCheckTests.cs    (12 tests)
└── Integration/
    └── Magic/
        ├── SpellCastingTests.cs          (15 tests)
        ├── ChantFlowTests.cs             (12 tests)
        └── SpellEffectTests.cs           (11 tests)
```

### Test Case Examples

#### MagicServiceTests.cs

```csharp
public class MagicServiceTests
{
    private readonly Mock<ILogger<MagicService>> _loggerMock;
    private readonly Mock<ISpellRepository> _spellRepoMock;
    private readonly Mock<IAetherService> _aetherServiceMock;
    private readonly Mock<IEffectScriptExecutor> _effectExecutorMock;
    private readonly MagicService _sut;

    public MagicServiceTests()
    {
        _loggerMock = new Mock<ILogger<MagicService>>();
        _spellRepoMock = new Mock<ISpellRepository>();
        _aetherServiceMock = new Mock<IAetherService>();
        _effectExecutorMock = new Mock<IEffectScriptExecutor>();

        _sut = new MagicService(
            _loggerMock.Object,
            _spellRepoMock.Object,
            _aetherServiceMock.Object,
            _effectExecutorMock.Object);
    }

    [Fact]
    public void Cast_WithSufficientAether_ReturnsSuccess()
    {
        // Arrange
        var caster = CreateCharacterWithAether(20);
        var spell = CreateInstantSpell(apCost: 5);
        _spellRepoMock.Setup(r => r.GetByName("test")).Returns(spell);

        // Act
        var result = _sut.Cast(caster, "test");

        // Assert
        result.Success.Should().BeTrue();
        result.Outcome.Should().Be(CastOutcome.Success);
        caster.Aether.Current.Should().Be(15); // 20 - 5
    }

    [Fact]
    public void Cast_WithInsufficientAether_ReturnsFailure()
    {
        // Arrange
        var caster = CreateCharacterWithAether(3);
        var spell = CreateInstantSpell(apCost: 5);
        _spellRepoMock.Setup(r => r.GetByName("test")).Returns(spell);

        // Act
        var result = _sut.Cast(caster, "test");

        // Assert
        result.Success.Should().BeFalse();
        result.Outcome.Should().Be(CastOutcome.InsufficientAether);
        caster.Aether.Current.Should().Be(3); // Unchanged
    }

    [Fact]
    public void Cast_ChantSpell_SetsConcentrationState()
    {
        // Arrange
        var caster = CreateCharacterWithAether(20);
        var spell = CreateChantSpell(apCost: 8, chargeTurns: 2);
        _spellRepoMock.Setup(r => r.GetByName("heal")).Returns(spell);

        // Act
        var result = _sut.Cast(caster, "heal");

        // Assert
        result.Success.Should().BeTrue();
        result.Outcome.Should().Be(CastOutcome.ChantStarted);
        caster.Concentration.Should().NotBeNull();
        caster.Concentration!.Spell.Should().Be(spell);
        caster.Concentration.TurnsRemaining.Should().Be(2);
    }

    [Fact]
    public void Cast_WhileAlreadyChanting_ReturnsFailure()
    {
        // Arrange
        var caster = CreateCharacterWithAether(20);
        caster.Concentration = new ConcentrationState
        {
            Spell = CreateChantSpell(),
            TurnsRemaining = 1,
            IsActive = true
        };
        var newSpell = CreateInstantSpell();
        _spellRepoMock.Setup(r => r.GetByName("test")).Returns(newSpell);

        // Act
        var result = _sut.Cast(caster, "test");

        // Assert
        result.Success.Should().BeFalse();
        result.Outcome.Should().Be(CastOutcome.AlreadyChanting);
    }
}
```

### Integration Test: Complete Mage Duel

```csharp
[Fact]
public async Task MageDuel_CompleteFlow_WorksCorrectly()
{
    // Arrange
    var player = CreateMysticCharacter(aether: 30, health: 50);
    var enemy = CreateEnemy(health: 40);
    var combatState = CreateCombatState(player, enemy);

    // Act & Assert - Turn 1: Player casts Rot-Bolt
    var castResult = _magicService.Cast(player, "rot-bolt", enemy);
    castResult.Success.Should().BeTrue();
    player.Aether.Current.Should().Be(25); // 30 - 5
    enemy.Health.Should().BeLessThan(40);  // Took damage

    // Turn 2: Enemy attacks player
    var attackResult = _combatService.Attack(enemy, player);
    var initialHealth = player.Health;

    // Turn 3: Player starts Mend-Flesh (Chant)
    var chantResult = _magicService.Cast(player, "mend-flesh", player);
    chantResult.Outcome.Should().Be(CastOutcome.ChantStarted);
    player.Concentration.Should().NotBeNull();

    // Turn 4: Player continues chanting (turn advances)
    var turnResult = _turnManager.ProcessTurnStart(player);
    turnResult.ChantCompleted.Should().BeTrue();
    player.Health.Should().BeGreaterThan(initialHealth); // Healed
    player.Concentration.Should().BeNull(); // Cleared
}
```

---

## Domain 4 Compliance

### Voice Guidelines for Magic Content

All spell descriptions, casting messages, and magical effects must follow Domain 4 voice constraints:

| Guideline | ❌ Forbidden | ✅ Compliant |
|-----------|-------------|--------------|
| Precision measurements | "Deals 25 damage" | "Flesh withers at its touch" |
| Technical terminology | "Cast time: 2 turns" | "The Galdr requires time to weave" |
| Game-mechanical language | "Applies -2 Armor debuff" | "Metal screams as oxidation takes hold" |
| Modern concepts | "Targeting system" | "The Galdr finds its mark" |

### Example Transformations

**Spell Description:**
- ❌ "Fires a bolt of necrotic energy dealing 1d8 damage with a range of 30 feet"
- ✅ "You reach into the space between moments and pull. Something dark and hungry answers—a shard of entropy that screams toward the target, leaving a trail of withered air."

**Healing Message:**
- ❌ "Heals 12 HP to target"
- ✅ "The threads of Mending take hold. Wounds close with wet, sucking sounds. Flesh remembers its unbroken shape."

**Failure Message:**
- ❌ "Spell failed: insufficient mana (5/10)"
- ✅ "Your spark is too dim. The Galdr flickers and dies on your tongue."

---

## Dependency Map

```
┌─────────────────────────────────────────────────────────────────────────┐
│                     v0.4.5 DEPENDENCY CHAIN                              │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                          │
│                        ┌───────────────────┐                            │
│                        │   v0.4.3 (Prereq) │                            │
│                        │  Magic Core       │                            │
│                        │  ├─ AetherService │                            │
│                        │  ├─ FluxState     │                            │
│                        │  └─ Spell Entity  │                            │
│                        └─────────┬─────────┘                            │
│                                  │                                       │
│                                  ▼                                       │
│  ┌───────────────────────────────────────────────────────────────────┐  │
│  │                         v0.4.5a: The Catalyst                      │  │
│  │  ├─ AetherPool (on Character)                                      │  │
│  │  ├─ CastResult model                                               │  │
│  │  ├─ MagicService                                                   │  │
│  │  └─ cast command                                                   │  │
│  └───────────────────────────────┬───────────────────────────────────┘  │
│                                  │                                       │
│                                  ▼                                       │
│  ┌───────────────────────────────────────────────────────────────────┐  │
│  │                         v0.4.5b: The Chant                         │  │
│  │  ├─ ConcentrationState                                             │  │
│  │  ├─ TurnManager chant integration                                  │  │
│  │  ├─ Concentration checks                                           │  │
│  │  └─ break command                                                  │  │
│  │                                                                     │  │
│  │  DEPENDS ON: v0.4.5a (MagicService, AetherPool)                   │  │
│  └───────────────────────────────┬───────────────────────────────────┘  │
│                                  │                                       │
│                                  ▼                                       │
│  ┌───────────────────────────────────────────────────────────────────┐  │
│  │                         v0.4.5c: The Grim                          │  │
│  │  ├─ 5 Tier 1 spells                                                │  │
│  │  ├─ SpellSeeder                                                    │  │
│  │  ├─ Effect script handlers                                         │  │
│  │  └─ Status effect definitions                                      │  │
│  │                                                                     │  │
│  │  DEPENDS ON: v0.4.5a (MagicService), v0.4.5b (Chant mechanics)    │  │
│  └───────────────────────────────┬───────────────────────────────────┘  │
│                                  │                                       │
│                                  ▼                                       │
│  ┌───────────────────────────────────────────────────────────────────┐  │
│  │                         v0.4.5d: The Weaver                        │  │
│  │  ├─ Aether bar renderer                                            │  │
│  │  ├─ Flux indicator                                                 │  │
│  │  ├─ Chant overlay                                                  │  │
│  │  └─ Magic log formatting                                           │  │
│  │                                                                     │  │
│  │  DEPENDS ON: v0.4.5a-c (All models and services)                  │  │
│  └───────────────────────────────────────────────────────────────────┘  │
│                                                                          │
└─────────────────────────────────────────────────────────────────────────┘
```

---

## Changelog Template

```markdown
# Changelog: v0.4.5 - Spells & Chants (The Mystic)

**Release Date:** TBD

## Summary

"The Mystic" update introduces the Aetheric Arts. Players can now channel the
background radiation of the Glitch into powerful Galdr (Spells). This update
brings resource management (Aether), environmental risk (Flux), tactical
multi-turn casting (Chanting), and a new dimension to combat.

## New Features

### Magic System
- **Aether Resource**: Characters now have an Aether pool for spellcasting
- **Flux Integration**: Spellcasting increases environmental Flux, risking Backlash
- **Spell Schools**: Entropy (destruction), Mending (healing), Vision (utility)

### Spellcasting
- **`cast` Command**: New command to weave Galdr (`cast <spell> [on <target>]`)
- **Instant Spells**: Quick-cast magic that resolves immediately
- **Chanted Spells**: Multi-turn spells requiring concentration

### Concentration System
- **Multi-Turn Casting**: Powerful spells take multiple turns to complete
- **Interruption**: Taking damage triggers a Constitution save to maintain focus
- **`break` Command**: Voluntarily cancel an ongoing Chant

### New Spells (Tier 1)
| Spell | School | Type | Effect |
|-------|--------|------|--------|
| Wyrd-Light | Vision | Instant | Illumination, removes dark penalties |
| Rot-Bolt | Entropy | Instant | Ranged necrotic damage |
| Mend-Flesh | Mending | Chant(1) | Healing over one turn |
| Rust-Cloud | Entropy | Chant(2) | Area debuff, corrodes armor |
| Spirit-Ward | Vision | Instant | Protection vs spectral damage |

### UI Enhancements
- **Aether Bar**: New resource bar in combat HUD
- **Flux Indicator**: Environmental magic volatility display with thresholds
- **Chant Overlay**: Visual progress indicator during multi-turn spells
- **School Colors**: Color-coded log messages for different magic types

## Technical Changes

### New Files
- `Core/Models/Magic/AetherPool.cs`
- `Core/Models/Magic/CastResult.cs`
- `Core/Models/Magic/ConcentrationState.cs`
- `Engine/Services/MagicService.cs`
- `Terminal/Renderers/AetherBarRenderer.cs`
- `Terminal/Renderers/FluxIndicatorRenderer.cs`
- `Terminal/Renderers/ChantOverlayRenderer.cs`
- `Persistence/Seeders/SpellSeeder.cs`

### Modified Files
- `Core/Entities/Character.cs` - Added Aether, Concentration properties
- `Engine/Services/TurnManager.cs` - Chant processing integration
- `Engine/Services/CombatService.cs` - Concentration check on damage
- `Engine/Services/CommandParser.cs` - Added `cast`, `break` commands
- `Terminal/Services/CombatScreenRenderer.cs` - Magic UI integration

### Database Migrations
- `V045__SeedTier1Spells.sql` - Initial spell definitions

## Testing

- **Unit Tests Added**: 116 new tests
- **Code Coverage**: 85%+ for new magic-related code
- **Integration Tests**: Complete spell casting and chant flows validated

## Known Issues

- None identified at release

## Coming Next

- v0.4.6: Additional spell tiers and advanced Backlash mechanics

---

🤖 Generated with [Claude Code](https://claude.ai/code)

Co-Authored-By: Claude Opus 4.5 <noreply@anthropic.com>
```

---

## Appendix: Quick Reference

### Command Summary

| Command | Syntax | Description |
|---------|--------|-------------|
| `cast` | `cast <spell> [on <target>]` | Cast a known spell |
| `break` | `break` | Cancel an active Chant |
| `spells` | `spells` | List known spells |

### Status Effect Summary

| Effect | Duration | Benefit/Penalty |
|--------|----------|-----------------|
| `Illuminated` | 10 turns | Negates darkness penalties |
| `Corroded` | 5 turns | Armor -2 |
| `Warded` | 10 turns | +2 Armor vs Spectral |

### Resource Costs (Tier 1)

| Spell | AP Cost | Flux Cost |
|-------|---------|-----------|
| Wyrd-Light | 2 | 3 |
| Rot-Bolt | 5 | 8 |
| Mend-Flesh | 8 | 5 |
| Rust-Cloud | 10 | 12 |
| Spirit-Ward | 5 | 4 |
