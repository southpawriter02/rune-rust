# v0.14.6b Design Specification: Music Theme Schema

**Version:** 0.14.6b
**Parent:** v0.14.6 (Audio Configuration Schemas)
**Prerequisites:** v0.14.6a Complete (Sound Effect Schema)
**Status:** Design Complete

---

## Table of Contents

1. [Executive Summary](#1-executive-summary)
2. [Feature Overview](#2-feature-overview)
3. [Architecture Diagrams](#3-architecture-diagrams)
4. [Music Theme Schema Root Definition](#4-music-theme-schema-root-definition)
   - 4.1 [Root Configuration Properties](#41-root-configuration-properties)
   - 4.2 [Themes Array Structure](#42-themes-array-structure)
5. [Theme Definition Configuration](#5-theme-definition-configuration)
   - 5.1 [ThemeDefinition Schema](#51-themedefinition-schema)
   - 5.2 [Theme Category Enum](#52-theme-category-enum)
   - 5.3 [Track Configuration](#53-track-configuration)
   - 5.4 [Playback Settings](#54-playback-settings)
6. [Intensity Layer Configuration](#6-intensity-layer-configuration)
   - 6.1 [IntensityLayer Schema](#61-intensitylayer-schema)
   - 6.2 [Intensity Range Mapping](#62-intensity-range-mapping)
   - 6.3 [Layer Blending Behavior](#63-layer-blending-behavior)
7. [Loop Points Configuration](#7-loop-points-configuration)
   - 7.1 [LoopPoints Schema](#71-looppoints-schema)
   - 7.2 [Sample-Based vs Time-Based](#72-sample-based-vs-time-based)
   - 7.3 [Loop Behavior](#73-loop-behavior)
8. [Stinger Configuration](#8-stinger-configuration)
   - 8.1 [Stinger Schema](#81-stinger-schema)
   - 8.2 [Ducking Configuration](#82-ducking-configuration)
   - 8.3 [Resume Behavior](#83-resume-behavior)
9. [Transitions Configuration](#9-transitions-configuration)
   - 9.1 [Transitions Schema](#91-transitions-schema)
   - 9.2 [Transition Types](#92-transition-types)
   - 9.3 [Context-Specific Transitions](#93-context-specific-transitions)
10. [Validation Rules](#10-validation-rules)
    - 10.1 [Theme Validation](#101-theme-validation)
    - 10.2 [Range Validation](#102-range-validation)
    - 10.3 [Required Fields](#103-required-fields)
    - 10.4 [Cross-Reference Validation](#104-cross-reference-validation)
11. [Configuration Schema](#11-configuration-schema)
12. [Configuration File Updates](#12-configuration-file-updates)
13. [Data Model Changes](#13-data-model-changes)
14. [Logging Specifications](#14-logging-specifications)
15. [Unit Testing Requirements](#15-unit-testing-requirements)
16. [Use Cases](#16-use-cases)
17. [Deliverable Checklist](#17-deliverable-checklist)
18. [Acceptance Criteria](#18-acceptance-criteria)
19. [Dependencies](#19-dependencies)
20. [Future Considerations](#20-future-considerations)

---

## 1. Executive Summary

Version 0.14.6b introduces the **Music Theme Schema** (`music-themes.schema.json`), which validates music theme definitions including theme categories, transition rules, intensity layers, stingers, and loop points for seamless audio playback. This schema enables full customization of game music without code changes, supporting modding scenarios such as custom soundtracks, themed music packs, regional variations, or accessibility-focused audio profiles.

The Music Theme Schema validates the existing `music-themes.json` configuration file which currently defines 5 themes (MainMenu, Exploration, Combat, BossCombat, SafeArea), 4 stingers (victory, defeat, level-up, quest-complete), and transition settings. The schema establishes patterns for dynamic music systems including intensity-based layering and seamless loop points.

### Key Deliverables

| Category | Items |
|----------|-------|
| **Schema Files** | `music-themes.schema.json` |
| **Schema Definitions** | `ThemeDefinition`, `Stinger`, `Transitions`, `IntensityLayer`, `LoopPoints` |
| **Configuration Files** | Update `music-themes.json` to reference new schema |
| **Tests** | ~6 new unit tests |

### Architectural Significance

This version provides:
- **8 theme categories** - MainMenu, Exploration, Combat, BossCombat, SafeArea, Puzzle, Cinematic, Credits
- **3 transition types** - Crossfade, Immediate, FadeOutFadeIn
- **Intensity layers** - Dynamic music scaling based on game state (0-1 range)
- **Loop points** - Seamless looping via sample positions or time offsets
- **Stinger system** - One-shot audio cues with music ducking
- **Intro/outro tracks** - Optional tracks for theme entry/exit

### Relationship to Other Schemas

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                    v0.14.6 AUDIO CONFIGURATION SCHEMAS                       │
└─────────────────────────────────────────────────────────────────────────────┘

  ┌─────────────────────────────────────────────────────────────────────────┐
  │  v0.14.6a: sound-effects.schema.json                                    │
  │  v0.14.6b: music-themes.schema.json ◀── THIS VERSION                    │
  └─────────────────────────────────────────────────────────────────────────┘

  Cross-references:
  • music-themes.json → tracks[] references audio file paths
  • music-themes.json → stingers reference audio file paths
  • zones.json → musicTheme references theme names (future)
  • bosses.json → musicTheme references theme names (future)

  Shared definitions:
  • ID pattern: ^[a-z][a-z0-9-]*$ (lowercase kebab-case)
  • Schema location: config/schemas/
  • Volume range: 0-1 normalized
```

---

## 2. Feature Overview

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                      MUSIC THEME SCHEMA FEATURE TREE                         │
└─────────────────────────────────────────────────────────────────────────────┘

music-themes.schema.json
├── Root Configuration
│   ├── $schema reference
│   ├── version (optional)
│   ├── themes array
│   ├── stingers array (optional)
│   └── transitions object
│
├── ThemeDefinition
│   ├── Core Properties
│   │   ├── theme (enum: 8 categories)
│   │   ├── tracks[] (audio file paths)
│   │   ├── volume (0-1)
│   │   ├── loop (boolean)
│   │   └── shuffle (boolean)
│   │
│   ├── Optional Tracks
│   │   ├── introTrack (plays once before main)
│   │   └── outroTrack (plays on theme exit)
│   │
│   ├── Advanced Properties
│   │   ├── intensityLayers[] → IntensityLayer
│   │   ├── loopPoints → LoopPoints
│   │   └── tags[] (optional)
│   │
│   └── Theme Categories
│       ├── MainMenu
│       ├── Exploration
│       ├── Combat
│       ├── BossCombat
│       ├── SafeArea
│       ├── Puzzle
│       ├── Cinematic
│       └── Credits
│
├── IntensityLayer
│   ├── track (file path)
│   ├── minIntensity (0-1)
│   ├── maxIntensity (0-1)
│   ├── fadeTime (seconds)
│   └── volumeMultiplier (0-1)
│
├── LoopPoints
│   ├── loopStartSamples (integer)
│   ├── loopEndSamples (integer)
│   ├── loopStartSeconds (number)
│   └── loopEndSeconds (number)
│
├── Stinger
│   ├── name (kebab-case pattern)
│   ├── track (file path)
│   ├── volume (0-1)
│   ├── duckMusic (boolean)
│   ├── duckAmount (0-1)
│   └── resumeDelay (seconds)
│
└── Transitions
    ├── defaultCrossfade (seconds)
    ├── combatCrossfade (seconds)
    ├── bossCrossfade (seconds)
    ├── stingerFadeOut (seconds)
    ├── stingerResumeDelay (seconds)
    └── transitionType (enum)
```

---

## 3. Architecture Diagrams

### 3.1 Music Theme Structure

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                        MUSIC THEME STRUCTURE                                 │
└─────────────────────────────────────────────────────────────────────────────┘

                              music-themes.json
                    ┌──────────────────────────────────┐
                    │  $schema: reference              │
                    │  version: "1.0.0" (optional)     │
                    │  themes: [ ... ]                 │
                    │  stingers: [ ... ] (optional)    │
                    │  transitions: { ... }            │
                    └──────────┬───────────────────────┘
                               │
       ┌───────────────────────┼───────────────────────┐
       │                       │                       │
       ▼                       ▼                       ▼
┌──────────────────┐  ┌──────────────────┐  ┌──────────────────┐
│     themes[]     │  │   stingers[]     │  │   transitions    │
│──────────────────│  │──────────────────│  │──────────────────│
│ ThemeDefinition  │  │ Stinger          │  │ defaultCrossfade │
│ ThemeDefinition  │  │ Stinger          │  │ combatCrossfade  │
│ ThemeDefinition  │  │ Stinger          │  │ bossCrossfade    │
│ ...              │  │ ...              │  │ stingerFadeOut   │
└────────┬─────────┘  └──────────────────┘  │ stingerResume... │
         │                                   │ transitionType   │
         ▼                                   └──────────────────┘
┌─────────────────────────────────────────────────────────────────┐
│                        ThemeDefinition                           │
│─────────────────────────────────────────────────────────────────│
│  theme: "Combat"                    (enum: 8 categories)        │
│  tracks: ["audio/music/combat.ogg", ...]                        │
│  introTrack: "audio/music/combat_intro.ogg" (optional)          │
│  outroTrack: "audio/music/combat_outro.ogg" (optional)          │
│  volume: 0.8                        (0-1 range)                 │
│  loop: true                         (default: true)             │
│  shuffle: false                     (default: false)            │
│  intensityLayers: [ ... ]           (optional)                  │
│  loopPoints: { ... }                (optional)                  │
│  tags: ["battle", "intense"]        (optional)                  │
└──────────┬──────────────────────────────────────────────────────┘
           │
     ┌─────┴─────┐
     │           │
     ▼           ▼
┌───────────────────────┐    ┌───────────────────────┐
│   IntensityLayer      │    │     LoopPoints        │
│───────────────────────│    │───────────────────────│
│ track: "bass.ogg"     │    │ loopStartSamples: int │
│ minIntensity: 0.0     │    │ loopEndSamples: int   │
│ maxIntensity: 0.5     │    │ loopStartSeconds: num │
│ fadeTime: 1.0         │    │ loopEndSeconds: num   │
│ volumeMultiplier: 1.0 │    └───────────────────────┘
└───────────────────────┘
```

### 3.2 Theme Transition Flow

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                         THEME TRANSITION FLOW                                │
└─────────────────────────────────────────────────────────────────────────────┘

                    Game State Change (e.g., Enter Combat)
                              │
                              ▼
                  ┌───────────────────────┐
                  │ Current Theme Playing │
                  │ (e.g., Exploration)   │
                  └───────────┬───────────┘
                              │
                              ▼
                  ┌───────────────────────┐
                  │ Determine Transition  │
                  │ Type for Target Theme │
                  └───────────┬───────────┘
                              │
          ┌───────────────────┼───────────────────┐
          │                   │                   │
          ▼                   ▼                   ▼
  ┌───────────────┐   ┌───────────────┐   ┌───────────────┐
  │  Crossfade    │   │  Immediate    │   │ FadeOutFadeIn │
  │───────────────│   │───────────────│   │───────────────│
  │ Fade out old  │   │ Cut directly  │   │ Fade to       │
  │ while fading  │   │ to new track  │   │ silence, then │
  │ in new track  │   │ (instant)     │   │ fade in new   │
  └───────┬───────┘   └───────┬───────┘   └───────┬───────┘
          │                   │                   │
          └───────────────────┼───────────────────┘
                              │
                              ▼
                  ┌───────────────────────┐
                  │ Play intro track      │
                  │ (if defined)          │
                  └───────────┬───────────┘
                              │
                              ▼
                  ┌───────────────────────┐
                  │ Play main track(s)    │
                  │ (loop if enabled)     │
                  └───────────────────────┘


CROSSFADE TIMING:
═════════════════

  Old Track    ████████████▒▒▒▒▒▒░░░░░░
  New Track                ░░░░░░▒▒▒▒▒▒████████████
                           |←─ crossfade ─→|
                           duration (seconds)


IMMEDIATE:
══════════

  Old Track    ████████████|
  New Track                |████████████
                           instant cut


FADE OUT FADE IN:
════════════════

  Old Track    ████████████▒▒▒▒░░░░
  Silence                          ░░░░
  New Track                            ░░░░▒▒▒▒████████████
                           |← fade →|gap|← fade →|
```

### 3.3 Intensity Layer System

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                         INTENSITY LAYER SYSTEM                               │
└─────────────────────────────────────────────────────────────────────────────┘

  Game Intensity Value: 0.0 ────────────────────────────────────────── 1.0
                        │                                               │
                        ▼                                               ▼
                      Low                                             High
                    (Calm)                                          (Crisis)


  Example Combat Theme with Intensity Layers:
  ═══════════════════════════════════════════

  Intensity:   0.0    0.2    0.4    0.6    0.8    1.0
               │      │      │      │      │      │
               ▼      ▼      ▼      ▼      ▼      ▼
  ┌────────────────────────────────────────────────────────────┐
  │ Base Layer (ambient drone)                                 │ 0.0-1.0
  │ ████████████████████████████████████████████████████████   │
  └────────────────────────────────────────────────────────────┘
  ┌────────────────────────────────────────────────────────────┐
  │ Percussion Layer                                           │ 0.2-0.8
  │       ░░░░████████████████████████████████░░░░             │
  └────────────────────────────────────────────────────────────┘
  ┌────────────────────────────────────────────────────────────┐
  │ Strings Layer                                              │ 0.4-1.0
  │             ░░░░░░████████████████████████████████         │
  └────────────────────────────────────────────────────────────┘
  ┌────────────────────────────────────────────────────────────┐
  │ Brass Layer (intense)                                      │ 0.7-1.0
  │                               ░░░░░░████████████████       │
  └────────────────────────────────────────────────────────────┘


  Layer Configuration:
  ────────────────────
  {
    "track": "audio/music/combat_percussion.ogg",
    "minIntensity": 0.2,      ← Layer starts fading in at 0.2
    "maxIntensity": 0.8,      ← Layer at full volume at 0.8
    "fadeTime": 1.0,          ← Seconds to fade in/out
    "volumeMultiplier": 1.0   ← Maximum volume for this layer
  }


  Layer Volume Calculation:
  ─────────────────────────

  intensity = 0.5 (current game state)
  minIntensity = 0.2
  maxIntensity = 0.8

  If intensity < minIntensity: volume = 0
  If intensity > maxIntensity: volume = volumeMultiplier
  Else: volume = (intensity - min) / (max - min) × volumeMultiplier

  Example: (0.5 - 0.2) / (0.8 - 0.2) = 0.3 / 0.6 = 0.5
  Layer plays at 50% of its volumeMultiplier
```

### 3.4 Stinger Playback

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                          STINGER PLAYBACK                                    │
└─────────────────────────────────────────────────────────────────────────────┘

                    Trigger Event (e.g., "Victory")
                              │
                              ▼
                  ┌───────────────────────┐
                  │ Look up stinger by    │
                  │ name: "victory"       │
                  └───────────┬───────────┘
                              │
                              ▼
                  ┌───────────────────────┐
                  │ duckMusic enabled?    │
                  └───────────┬───────────┘
                              │
              ┌───────────────┴───────────────┐
              │ Yes                           │ No
              ▼                               ▼
  ┌─────────────────────────┐     ┌─────────────────────────┐
  │ Reduce music volume to  │     │ Keep music at current   │
  │ duckAmount (e.g., 0.3)  │     │ volume level            │
  └───────────┬─────────────┘     └───────────┬─────────────┘
              │                               │
              └───────────────┬───────────────┘
                              │
                              ▼
                  ┌───────────────────────┐
                  │ Play stinger track    │
                  │ at configured volume  │
                  └───────────┬───────────┘
                              │
                              ▼
                  ┌───────────────────────┐
                  │ Wait for stinger to   │
                  │ complete playback     │
                  └───────────┬───────────┘
                              │
                              ▼
                  ┌───────────────────────┐
                  │ Wait resumeDelay      │
                  │ (e.g., 0.5 seconds)   │
                  └───────────┬───────────┘
                              │
                              ▼
                  ┌───────────────────────┐
                  │ Restore music to      │
                  │ original volume       │
                  └───────────────────────┘


STINGER TIMING DIAGRAM:
═══════════════════════

  Music Volume    ████████▓▓▓▓░░░░░░░░░░░░░░░░░░░░░░▓▓▓▓████████
                          |←duck→|      stinger    |←restore→|
                                                   |resume|
                                                   |delay |

  Stinger         ░░░░░░░░░░░░░████████████████████░░░░░░░░░░░░░
                              |← stinger plays →|
```

### 3.5 Schema Layer Diagram

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           SCHEMA LAYER DIAGRAM                               │
└─────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────┐
│                              PRESENTATION                                    │
│                                                                              │
│  Music system plays themes based on game state                               │
│  • Menu music in title screen                                                │
│  • Exploration music in dungeons                                             │
│  • Combat music during battles                                               │
│  • Stingers for special events                                               │
└─────────────────────────────────────────────────────────────────────────────┘
                                     │
                                     ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                              APPLICATION                                     │
│                                                                              │
│  MusicThemeService loads and provides music theme data                       │
│  • GetAllThemes() → IEnumerable<ThemeDefinition>                             │
│  • GetTheme(category) → ThemeDefinition?                                     │
│  • GetStinger(name) → Stinger?                                               │
│  • GetTransitions() → Transitions                                            │
│  • PlayTheme(category) → void                                                │
│  • PlayStinger(name) → void                                                  │
│  • SetIntensity(value) → void                                                │
└─────────────────────────────────────────────────────────────────────────────┘
                                     │
                                     ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                             DOMAIN LAYER                                     │
│                                                                              │
│  Music theme definitions loaded from JSON                                    │
│  • ThemeDefinition (theme, tracks, volume, loop, shuffle, etc.)              │
│  • IntensityLayer (track, minIntensity, maxIntensity, fadeTime)              │
│  • LoopPoints (loopStartSamples, loopEndSamples, seconds variants)           │
│  • Stinger (name, track, volume, duckMusic, duckAmount, resumeDelay)         │
│  • Transitions (crossfade durations, transition type)                        │
└─────────────────────────────────────────────────────────────────────────────┘
                                     │
                                     ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                           INFRASTRUCTURE                                     │
│                                                                              │
│  MusicThemeProvider loads from JSON with schema validation                   │
│  • LoadMusicThemes() → reads config/music-themes.json                        │
│  • Validates against config/schemas/music-themes.schema.json                 │
│  • Caches loaded definitions for performance                                 │
│  • Logs warnings for invalid entries                                         │
└─────────────────────────────────────────────────────────────────────────────┘
                                     │
                                     ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                            CONFIGURATION                                     │
│                                                                              │
│  config/schemas/music-themes.schema.json                                     │
│  config/music-themes.json                                                    │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 4. Music Theme Schema Root Definition

### 4.1 Root Configuration Properties

The root schema defines the top-level structure of the `music-themes.json` configuration file.

| Property | Type | Required | Default | Description |
|----------|------|----------|---------|-------------|
| `$schema` | string | No | - | Reference to the JSON schema for validation |
| `version` | string | No | - | Configuration file version for compatibility |
| `themes` | array | **Yes** | - | Array of `ThemeDefinition` objects |
| `stingers` | array | No | `[]` | Array of `Stinger` objects for one-shot cues |
| `transitions` | object | **Yes** | - | `Transitions` object for crossfade settings |

### 4.2 Themes Array Structure

The `themes` property is an array of `ThemeDefinition` objects. Each theme must have a unique `theme` category value.

```
themes: [
  ThemeDefinition { theme: "MainMenu", ... },
  ThemeDefinition { theme: "Exploration", ... },
  ThemeDefinition { theme: "Combat", ... },
  ThemeDefinition { theme: "BossCombat", ... },
  ThemeDefinition { theme: "SafeArea", ... },
  ThemeDefinition { theme: "Puzzle", ... },
  ThemeDefinition { theme: "Cinematic", ... },
  ThemeDefinition { theme: "Credits", ... }
]
```

---

## 5. Theme Definition Configuration

### 5.1 ThemeDefinition Schema

Each theme definition configures music playback for a specific game context.

| Property | Type | Required | Default | Range | Description |
|----------|------|----------|---------|-------|-------------|
| `theme` | string | **Yes** | - | enum | Theme category (see 5.2) |
| `tracks` | array | **Yes** | - | minItems: 1 | Array of audio file paths |
| `introTrack` | string | No | - | - | Track to play once before main loop |
| `outroTrack` | string | No | - | - | Track to play on theme exit |
| `volume` | number | No | 1.0 | 0-1 | Base volume level |
| `loop` | boolean | No | `true` | - | Loop main tracks |
| `shuffle` | boolean | No | `false` | - | Randomize track order |
| `intensityLayers` | array | No | `[]` | - | Array of `IntensityLayer` objects |
| `loopPoints` | object | No | - | - | `LoopPoints` for seamless looping |
| `tags` | array | No | `[]` | - | Optional tags for filtering |

### 5.2 Theme Category Enum

The `theme` property must be one of the following 8 categories:

| Theme | Use Case | Typical Characteristics |
|-------|----------|-------------------------|
| `MainMenu` | Title/menu screens | Calm, looping, no intensity layers |
| `Exploration` | Dungeon/world navigation | Ambient, multiple tracks, shuffle enabled |
| `Combat` | Standard encounters | Intense, quick transition in |
| `BossCombat` | Boss battles | Epic, multi-phase support, intensity layers |
| `SafeArea` | Towns, rest areas | Relaxing, peaceful |
| `Puzzle` | Puzzle rooms | Thoughtful, non-intrusive |
| `Cinematic` | Cutscenes | Often non-looping, timed to visuals |
| `Credits` | End credits | Full playthrough, typically non-looping |

### 5.3 Track Configuration

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                          TRACK CONFIGURATION                                 │
└─────────────────────────────────────────────────────────────────────────────┘

  Single Track:
  ─────────────
  "tracks": ["audio/music/menu_theme.ogg"]
  → Loops the same track continuously (if loop=true)

  Multiple Tracks (shuffle: false):
  ─────────────────────────────────
  "tracks": [
    "audio/music/dungeon_01.ogg",
    "audio/music/dungeon_02.ogg",
    "audio/music/dungeon_03.ogg"
  ]
  → Plays tracks in order: 1 → 2 → 3 → 1 → 2 → 3 → ...

  Multiple Tracks (shuffle: true):
  ────────────────────────────────
  "tracks": [
    "audio/music/exploration_01.ogg",
    "audio/music/exploration_02.ogg",
    "audio/music/exploration_03.ogg"
  ]
  → Plays tracks in random order: 2 → 1 → 3 → 1 → 2 → ...

  With Intro Track:
  ─────────────────
  "introTrack": "audio/music/combat_intro.ogg",
  "tracks": ["audio/music/combat_main.ogg"]
  → Plays intro once, then loops main track

  With Outro Track:
  ─────────────────
  "outroTrack": "audio/music/combat_outro.ogg"
  → Plays outro when transitioning away from this theme
```

### 5.4 Playback Settings

| Setting | Default | Description |
|---------|---------|-------------|
| `volume` | 1.0 | Master volume for this theme (0=silent, 1=full) |
| `loop` | `true` | When true, tracks repeat after playing |
| `shuffle` | `false` | When true, track order is randomized |

---

## 6. Intensity Layer Configuration

### 6.1 IntensityLayer Schema

Intensity layers allow dynamic music scaling based on game state.

| Property | Type | Required | Default | Range | Description |
|----------|------|----------|---------|-------|-------------|
| `track` | string | **Yes** | - | - | Audio file path for this layer |
| `minIntensity` | number | **Yes** | - | 0-1 | Intensity level where layer starts fading in |
| `maxIntensity` | number | **Yes** | - | 0-1 | Intensity level where layer is at full volume |
| `fadeTime` | number | No | 0 | ≥0 | Seconds to fade in/out |
| `volumeMultiplier` | number | No | 1.0 | 0-1 | Maximum volume for this layer |

### 6.2 Intensity Range Mapping

| Intensity Level | Example Layers | Description |
|-----------------|----------------|-------------|
| 0.0-0.3 (Low) | Base ambient layer only | Calm, peaceful |
| 0.3-0.6 (Medium) | Add percussion layer | Increasing tension |
| 0.6-0.8 (High) | Add brass/strings layer | Heightened action |
| 0.8-1.0 (Critical) | Full orchestra, all layers | Maximum intensity |

### 6.3 Layer Blending Behavior

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                        LAYER BLENDING BEHAVIOR                               │
└─────────────────────────────────────────────────────────────────────────────┘

VOLUME CALCULATION FOR LAYER:
═════════════════════════════

  Given:
    intensity = current game intensity (0-1)
    minIntensity = layer's minimum threshold
    maxIntensity = layer's maximum threshold
    volumeMultiplier = layer's max volume

  If intensity < minIntensity:
    layerVolume = 0 (layer is silent)

  Else if intensity >= maxIntensity:
    layerVolume = volumeMultiplier (layer at full)

  Else:
    t = (intensity - minIntensity) / (maxIntensity - minIntensity)
    layerVolume = t × volumeMultiplier


EXAMPLE:
════════

  Layer: Percussion
  minIntensity: 0.2
  maxIntensity: 0.8
  volumeMultiplier: 1.0

  intensity = 0.2 → t = 0.0 → volume = 0.0
  intensity = 0.5 → t = 0.5 → volume = 0.5
  intensity = 0.8 → t = 1.0 → volume = 1.0
  intensity = 0.9 → volume = 1.0 (clamped)


FADE TIME APPLICATION:
═════════════════════

  When intensity changes, layer volume changes over fadeTime:

  Old volume: 0.0
  New volume: 1.0
  fadeTime: 2.0 seconds

  t=0.0s: volume = 0.0
  t=0.5s: volume = 0.25
  t=1.0s: volume = 0.5
  t=1.5s: volume = 0.75
  t=2.0s: volume = 1.0
```

---

## 7. Loop Points Configuration

### 7.1 LoopPoints Schema

Loop points enable seamless looping by specifying exact positions within the audio file.

| Property | Type | Required | Default | Description |
|----------|------|----------|---------|-------------|
| `loopStartSamples` | integer | No | - | Sample position where loop starts |
| `loopEndSamples` | integer | No | - | Sample position where loop ends |
| `loopStartSeconds` | number | No | - | Time position where loop starts (seconds) |
| `loopEndSeconds` | number | No | - | Time position where loop ends (seconds) |

### 7.2 Sample-Based vs Time-Based

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                       LOOP POINTS: SAMPLE VS TIME                            │
└─────────────────────────────────────────────────────────────────────────────┘

SAMPLE-BASED (Precise):
═══════════════════════

  "loopPoints": {
    "loopStartSamples": 441000,    ← Sample 441,000 (at 44.1kHz = 10 seconds)
    "loopEndSamples": 2205000      ← Sample 2,205,000 (at 44.1kHz = 50 seconds)
  }

  Benefits:
  • Sample-accurate looping (no audio artifacts)
  • Precise control for music editors
  • Works with any sample rate if values are correct

  Use when:
  • Music editor provides exact sample positions
  • Need perfect loop timing


TIME-BASED (Convenient):
════════════════════════

  "loopPoints": {
    "loopStartSeconds": 10.0,     ← Loop starts at 10 seconds
    "loopEndSeconds": 50.0        ← Loop ends at 50 seconds
  }

  Benefits:
  • Easier to configure without audio tools
  • Human-readable values
  • Good enough for most use cases

  Use when:
  • Don't have exact sample positions
  • Loop points don't need sample accuracy


PRECEDENCE:
═══════════

  If both sample and time values are provided:
  → Sample values take precedence (more precise)

  If only time values provided:
  → Convert to samples at runtime based on file's sample rate
```

### 7.3 Loop Behavior

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           LOOP BEHAVIOR                                      │
└─────────────────────────────────────────────────────────────────────────────┘

WITHOUT LOOP POINTS (Standard Looping):
═══════════════════════════════════════

  Audio: |█████████████████████████████████████|
         ^start                               ^end
         │                                     │
         └──────── Loops back to start ────────┘

  Problem: Intro section plays every loop


WITH LOOP POINTS (Seamless Looping):
════════════════════════════════════

  Audio: |███████|████████████████████████████|██████|
         ^start  ^loopStart                   ^loopEnd ^end
         │       │                             │
         │       └──────── Loop section ───────┘
         │
         Intro plays once, then skips to loopStart

  Example:
    Track: "boss_theme.ogg" (2:30 total)
    loopStartSeconds: 0:15 (after intro)
    loopEndSeconds: 2:15 (before outro)

    First play: 0:00 → 0:15 → ... → 2:15 → (loops to 0:15)
    Subsequent: 0:15 → ... → 2:15 → (loops to 0:15)
```

---

## 8. Stinger Configuration

### 8.1 Stinger Schema

Stingers are short audio cues that play over the current music.

| Property | Type | Required | Default | Range | Description |
|----------|------|----------|---------|-------|-------------|
| `name` | string | **Yes** | - | pattern | Unique identifier (kebab-case) |
| `track` | string | **Yes** | - | - | Audio file path |
| `volume` | number | No | 1.0 | 0-1 | Playback volume |
| `duckMusic` | boolean | No | `true` | - | Lower music volume during playback |
| `duckAmount` | number | No | 0.3 | 0-1 | Volume level for ducked music |
| `resumeDelay` | number | No | 0.5 | ≥0 | Seconds to wait after stinger before restoring music |

### 8.2 Ducking Configuration

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                        DUCKING CONFIGURATION                                 │
└─────────────────────────────────────────────────────────────────────────────┘

  duckMusic: true
  duckAmount: 0.3
  ═════════════════

  Music volume during stinger: 30% of normal (ducked)
  This allows the stinger to be clearly heard over the music


  duckMusic: false
  ════════════════

  Music continues at normal volume
  Stinger overlays without affecting music volume
  Use for subtle audio cues that blend with music


  duckAmount values:
  ══════════════════

  0.0 = Music completely silent during stinger
  0.3 = Music at 30% volume (default, good balance)
  0.5 = Music at 50% volume (stinger shares attention)
  1.0 = Music at full volume (same as duckMusic: false)
```

### 8.3 Resume Behavior

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                          RESUME BEHAVIOR                                     │
└─────────────────────────────────────────────────────────────────────────────┘

  resumeDelay: 0.5 (seconds)
  ═══════════════════════════

  Timeline:
  ─────────────────────────────────────────────────────────────────────
  Time:    0.0s   0.5s   1.0s   1.5s   2.0s   2.5s   3.0s   3.5s
  ─────────────────────────────────────────────────────────────────────
  Music:   ████▒▒░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░▒▒████
           |←duck                     end→|delay|←restore
  ─────────────────────────────────────────────────────────────────────
  Stinger:      ░░░░██████████████████████████░░░░
                    |← stinger plays →|
  ─────────────────────────────────────────────────────────────────────


  resumeDelay: 0.0 (no delay)
  ═══════════════════════════

  Music immediately restores when stinger ends
  Can feel abrupt for longer stingers


  resumeDelay: 1.0 or more
  ═══════════════════════════

  Extended pause after stinger
  Good for dramatic moments (victory fanfare, boss defeat)
```

---

## 9. Transitions Configuration

### 9.1 Transitions Schema

The `Transitions` object configures how music changes between themes.

| Property | Type | Required | Default | Range | Description |
|----------|------|----------|---------|-------|-------------|
| `defaultCrossfade` | number | No | 2.0 | ≥0 | Default crossfade duration (seconds) |
| `combatCrossfade` | number | No | 0.5 | ≥0 | Crossfade for entering combat |
| `bossCrossfade` | number | No | 1.0 | ≥0 | Crossfade for boss encounters |
| `stingerFadeOut` | number | No | 1.0 | ≥0 | Music fade when stinger plays |
| `stingerResumeDelay` | number | No | 0.5 | ≥0 | Delay before music resumes after stinger |
| `transitionType` | string | No | `"Crossfade"` | enum | Default transition type |

### 9.2 Transition Types

| Type | Behavior | Use Case |
|------|----------|----------|
| `Crossfade` | Fade out old while fading in new simultaneously | Smooth theme changes |
| `Immediate` | Cut directly to new track (instant) | Urgent transitions (combat start) |
| `FadeOutFadeIn` | Fade to silence, pause, then fade in new | Dramatic scene changes |

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                         TRANSITION TYPE COMPARISON                           │
└─────────────────────────────────────────────────────────────────────────────┘

CROSSFADE (defaultCrossfade: 2.0):
══════════════════════════════════

  Old:  ████████████████████▓▓▓▓▒▒▒▒░░░░
  New:              ░░░░▒▒▒▒▓▓▓▓████████████████████
                    |←── 2 seconds ──→|

  Total transition time: 2 seconds
  Audio: Both tracks overlap during crossfade


IMMEDIATE (combatCrossfade: 0):
═══════════════════════════════

  Old:  ████████████████████|
  New:                      |████████████████████

  Total transition time: 0 seconds (instant)
  Audio: Abrupt cut, can be jarring but urgent


FADE OUT FADE IN (custom implementation):
════════════════════════════════════════

  Old:  ████████████████████▓▓▓▓▒▒▒▒░░░░
  Gap:                                   ░░░░░░░░░░░░
  New:                                               ░░░░▒▒▒▒▓▓▓▓████████

  Total transition time: fadeOut + gap + fadeIn
  Audio: Silence between tracks, dramatic effect
```

### 9.3 Context-Specific Transitions

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                     CONTEXT-SPECIFIC TRANSITIONS                             │
└─────────────────────────────────────────────────────────────────────────────┘

  Transition Matrix:
  ══════════════════

  From         → To Combat    → To Boss     → To Safe     → Default
  ─────────────────────────────────────────────────────────────────────
  Exploration  │ 0.5s rapid   │ 1.0s epic   │ 2.0s smooth │ 2.0s
  Combat       │ (same)       │ 1.0s epic   │ 2.0s smooth │ 2.0s
  Safe Area    │ 0.5s rapid   │ 1.0s epic   │ (same)      │ 2.0s
  Menu         │ 0.5s rapid   │ 1.0s epic   │ 2.0s smooth │ 2.0s


  Configuration Usage:
  ════════════════════

  {
    "transitions": {
      "defaultCrossfade": 2.0,      ← Used for most transitions
      "combatCrossfade": 0.5,       ← Used when entering Combat
      "bossCrossfade": 1.0,         ← Used when entering BossCombat
      "stingerFadeOut": 1.0,        ← Music duck speed for stingers
      "stingerResumeDelay": 0.5,    ← Delay after stinger ends
      "transitionType": "Crossfade" ← Default method
    }
  }
```

---

## 10. Validation Rules

### 10.1 Theme Validation

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                          THEME VALIDATION                                    │
└─────────────────────────────────────────────────────────────────────────────┘

  Theme Category Enum:
  ════════════════════

  Valid values:
  • "MainMenu"
  • "Exploration"
  • "Combat"
  • "BossCombat"
  • "SafeArea"
  • "Puzzle"
  • "Cinematic"
  • "Credits"

  ✓ Valid: { "theme": "Combat", ... }
  ✗ Invalid: { "theme": "Battle", ... } (not in enum)
  ✗ Invalid: { "theme": "combat", ... } (case-sensitive)


  Track Array Validation:
  ═══════════════════════

  ✓ Valid: { "tracks": ["music.ogg"] } (minItems: 1)
  ✗ Invalid: { "tracks": [] } (empty array)


  Unique Theme Constraint:
  ════════════════════════

  Each theme category should appear at most once in the themes array.
  This is a runtime validation, not enforced by JSON Schema.
```

### 10.2 Range Validation

| Field | Minimum | Maximum | Notes |
|-------|---------|---------|-------|
| `volume` | 0 | 1 | All volume fields |
| `minIntensity` | 0 | 1 | Should be ≤ maxIntensity |
| `maxIntensity` | 0 | 1 | Should be ≥ minIntensity |
| `fadeTime` | 0 | - | Seconds (no upper limit) |
| `volumeMultiplier` | 0 | 1 | Layer max volume |
| `duckAmount` | 0 | 1 | Ducked music level |
| `resumeDelay` | 0 | - | Seconds (no upper limit) |
| `*Crossfade` | 0 | - | All crossfade durations |
| `loopStartSamples` | 0 | - | Non-negative integer |
| `loopEndSamples` | 0 | - | Non-negative integer |
| `loopStartSeconds` | 0 | - | Non-negative number |
| `loopEndSeconds` | 0 | - | Non-negative number |

### 10.3 Required Fields

| Level | Required Fields |
|-------|-----------------|
| Root | `themes`, `transitions` |
| ThemeDefinition | `theme`, `tracks` |
| IntensityLayer | `track`, `minIntensity`, `maxIntensity` |
| LoopPoints | (none - all optional) |
| Stinger | `name`, `track` |
| Transitions | (none - all have defaults) |

### 10.4 Cross-Reference Validation

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                      CROSS-REFERENCE VALIDATION                              │
└─────────────────────────────────────────────────────────────────────────────┘

  File Path Validation (Runtime):
  ═══════════════════════════════

  Schema validates:
  ✓ tracks is a non-empty array of strings
  ✓ introTrack/outroTrack are strings if present
  ✓ intensity layer track is a string

  Runtime validates:
  • File exists at specified path
  • File is a supported audio format
  • File can be loaded and played


  Stinger Name Pattern:
  ═════════════════════

  Pattern: ^[a-z][a-z0-9-]*$

  ✓ Valid: "victory", "level-up", "quest-complete"
  ✗ Invalid: "Victory", "level_up", "123-stinger"


  Loop Point Consistency (Runtime):
  ═════════════════════════════════

  If loopPoints specified:
  • loopEndSamples should be > loopStartSamples
  • loopEndSeconds should be > loopStartSeconds
  • Loop points should be within file duration
```

---

## 11. Configuration Schema

### Complete `music-themes.schema.json`

```json
{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "https://rune-game.com/schemas/music-themes.schema.json",
  "title": "Music Theme Configuration",
  "description": "Schema for music theme definitions including categories, transitions, intensity layers, stingers, and loop points",
  "type": "object",
  "properties": {
    "$schema": {
      "type": "string",
      "description": "Reference to this schema for validation"
    },
    "version": {
      "type": "string",
      "description": "Configuration file version for compatibility tracking"
    },
    "themes": {
      "type": "array",
      "description": "Array of music theme definitions",
      "items": {
        "$ref": "#/definitions/ThemeDefinition"
      },
      "minItems": 1
    },
    "stingers": {
      "type": "array",
      "description": "Array of stinger (one-shot audio cue) definitions",
      "items": {
        "$ref": "#/definitions/Stinger"
      },
      "default": []
    },
    "transitions": {
      "$ref": "#/definitions/Transitions",
      "description": "Global transition settings for theme changes"
    }
  },
  "required": ["themes", "transitions"],
  "additionalProperties": false,
  "definitions": {
    "ThemeDefinition": {
      "type": "object",
      "description": "A music theme configuration for a specific game context",
      "properties": {
        "theme": {
          "type": "string",
          "description": "Theme category identifier",
          "enum": ["MainMenu", "Exploration", "Combat", "BossCombat", "SafeArea", "Puzzle", "Cinematic", "Credits"]
        },
        "tracks": {
          "type": "array",
          "description": "Array of audio file paths for this theme",
          "items": {
            "type": "string",
            "minLength": 1
          },
          "minItems": 1
        },
        "introTrack": {
          "type": "string",
          "description": "Optional track to play once before main loop",
          "minLength": 1
        },
        "outroTrack": {
          "type": "string",
          "description": "Optional track to play when transitioning away",
          "minLength": 1
        },
        "volume": {
          "type": "number",
          "description": "Base volume level (0 = silent, 1 = full)",
          "minimum": 0,
          "maximum": 1,
          "default": 1.0
        },
        "loop": {
          "type": "boolean",
          "description": "Loop main tracks after playing",
          "default": true
        },
        "shuffle": {
          "type": "boolean",
          "description": "Randomize track order when multiple tracks exist",
          "default": false
        },
        "intensityLayers": {
          "type": "array",
          "description": "Optional intensity-based music layers",
          "items": {
            "$ref": "#/definitions/IntensityLayer"
          },
          "default": []
        },
        "loopPoints": {
          "$ref": "#/definitions/LoopPoints",
          "description": "Optional custom loop points for seamless looping"
        },
        "tags": {
          "type": "array",
          "description": "Optional tags for filtering and organization",
          "items": {
            "type": "string",
            "minLength": 1
          },
          "uniqueItems": true
        }
      },
      "required": ["theme", "tracks"],
      "additionalProperties": false
    },
    "IntensityLayer": {
      "type": "object",
      "description": "A music layer that fades in/out based on game intensity",
      "properties": {
        "track": {
          "type": "string",
          "description": "Audio file path for this layer",
          "minLength": 1
        },
        "minIntensity": {
          "type": "number",
          "description": "Intensity level where layer starts fading in (0-1)",
          "minimum": 0,
          "maximum": 1
        },
        "maxIntensity": {
          "type": "number",
          "description": "Intensity level where layer is at full volume (0-1)",
          "minimum": 0,
          "maximum": 1
        },
        "fadeTime": {
          "type": "number",
          "description": "Seconds to fade in/out when intensity changes",
          "minimum": 0,
          "default": 0
        },
        "volumeMultiplier": {
          "type": "number",
          "description": "Maximum volume for this layer (0-1)",
          "minimum": 0,
          "maximum": 1,
          "default": 1.0
        }
      },
      "required": ["track", "minIntensity", "maxIntensity"],
      "additionalProperties": false
    },
    "LoopPoints": {
      "type": "object",
      "description": "Custom loop points for seamless audio looping",
      "properties": {
        "loopStartSamples": {
          "type": "integer",
          "description": "Sample position where loop starts",
          "minimum": 0
        },
        "loopEndSamples": {
          "type": "integer",
          "description": "Sample position where loop ends",
          "minimum": 0
        },
        "loopStartSeconds": {
          "type": "number",
          "description": "Time position where loop starts (seconds)",
          "minimum": 0
        },
        "loopEndSeconds": {
          "type": "number",
          "description": "Time position where loop ends (seconds)",
          "minimum": 0
        }
      },
      "additionalProperties": false
    },
    "Stinger": {
      "type": "object",
      "description": "A one-shot audio cue that plays over the current music",
      "properties": {
        "name": {
          "type": "string",
          "description": "Unique identifier for this stinger (kebab-case)",
          "pattern": "^[a-z][a-z0-9-]*$"
        },
        "track": {
          "type": "string",
          "description": "Audio file path for the stinger",
          "minLength": 1
        },
        "volume": {
          "type": "number",
          "description": "Playback volume (0 = silent, 1 = full)",
          "minimum": 0,
          "maximum": 1,
          "default": 1.0
        },
        "duckMusic": {
          "type": "boolean",
          "description": "Lower music volume while stinger plays",
          "default": true
        },
        "duckAmount": {
          "type": "number",
          "description": "Volume level for ducked music (0 = silent, 1 = full)",
          "minimum": 0,
          "maximum": 1,
          "default": 0.3
        },
        "resumeDelay": {
          "type": "number",
          "description": "Seconds to wait after stinger before restoring music volume",
          "minimum": 0,
          "default": 0.5
        }
      },
      "required": ["name", "track"],
      "additionalProperties": false
    },
    "Transitions": {
      "type": "object",
      "description": "Global settings for music theme transitions",
      "properties": {
        "defaultCrossfade": {
          "type": "number",
          "description": "Default crossfade duration in seconds",
          "minimum": 0,
          "default": 2.0
        },
        "combatCrossfade": {
          "type": "number",
          "description": "Crossfade duration when entering combat",
          "minimum": 0,
          "default": 0.5
        },
        "bossCrossfade": {
          "type": "number",
          "description": "Crossfade duration for boss encounters",
          "minimum": 0,
          "default": 1.0
        },
        "stingerFadeOut": {
          "type": "number",
          "description": "Duration to fade music when stinger plays",
          "minimum": 0,
          "default": 1.0
        },
        "stingerResumeDelay": {
          "type": "number",
          "description": "Delay before music resumes after stinger",
          "minimum": 0,
          "default": 0.5
        },
        "transitionType": {
          "type": "string",
          "description": "Default transition method",
          "enum": ["Crossfade", "Immediate", "FadeOutFadeIn"],
          "default": "Crossfade"
        }
      },
      "additionalProperties": false
    }
  }
}
```

---

## 12. Configuration File Updates

### Updated `music-themes.json` with Enhanced Features

The existing configuration already references the schema. The schema validates the current structure and enables the following optional enhancements:

```json
{
  "$schema": "./schemas/music-themes.schema.json",
  "version": "1.0.0",
  "themes": [
    {
      "theme": "MainMenu",
      "tracks": [
        "audio/music/menu_theme.ogg"
      ],
      "volume": 0.7,
      "loop": true,
      "shuffle": false,
      "tags": ["menu", "ambient"]
    },
    {
      "theme": "Exploration",
      "tracks": [
        "audio/music/dungeon_ambient_01.ogg",
        "audio/music/dungeon_ambient_02.ogg",
        "audio/music/dungeon_ambient_03.ogg"
      ],
      "volume": 0.6,
      "loop": true,
      "shuffle": true,
      "tags": ["dungeon", "ambient", "exploration"]
    },
    {
      "theme": "Combat",
      "tracks": [
        "audio/music/combat_intense.ogg"
      ],
      "introTrack": "audio/music/combat_intro.ogg",
      "volume": 0.8,
      "loop": true,
      "shuffle": false,
      "intensityLayers": [
        {
          "track": "audio/music/combat_percussion.ogg",
          "minIntensity": 0.3,
          "maxIntensity": 0.7,
          "fadeTime": 1.0,
          "volumeMultiplier": 0.8
        },
        {
          "track": "audio/music/combat_brass.ogg",
          "minIntensity": 0.6,
          "maxIntensity": 1.0,
          "fadeTime": 1.5,
          "volumeMultiplier": 1.0
        }
      ],
      "loopPoints": {
        "loopStartSeconds": 4.0,
        "loopEndSeconds": 64.0
      },
      "tags": ["combat", "intense", "battle"]
    },
    {
      "theme": "BossCombat",
      "tracks": [
        "audio/music/boss_epic.ogg",
        "audio/music/boss_epic_phase2.ogg"
      ],
      "introTrack": "audio/music/boss_intro.ogg",
      "volume": 0.9,
      "loop": true,
      "shuffle": false,
      "intensityLayers": [
        {
          "track": "audio/music/boss_layer_drums.ogg",
          "minIntensity": 0.0,
          "maxIntensity": 0.4,
          "fadeTime": 0.5,
          "volumeMultiplier": 1.0
        },
        {
          "track": "audio/music/boss_layer_strings.ogg",
          "minIntensity": 0.3,
          "maxIntensity": 0.7,
          "fadeTime": 1.0,
          "volumeMultiplier": 0.9
        },
        {
          "track": "audio/music/boss_layer_choir.ogg",
          "minIntensity": 0.6,
          "maxIntensity": 1.0,
          "fadeTime": 2.0,
          "volumeMultiplier": 1.0
        }
      ],
      "tags": ["boss", "epic", "climax"]
    },
    {
      "theme": "SafeArea",
      "tracks": [
        "audio/music/town_peaceful.ogg",
        "audio/music/tavern_music.ogg"
      ],
      "volume": 0.5,
      "loop": true,
      "shuffle": true,
      "tags": ["town", "safe", "peaceful"]
    },
    {
      "theme": "Puzzle",
      "tracks": [
        "audio/music/puzzle_contemplative.ogg"
      ],
      "volume": 0.4,
      "loop": true,
      "shuffle": false,
      "tags": ["puzzle", "thinking", "ambient"]
    },
    {
      "theme": "Cinematic",
      "tracks": [
        "audio/music/cinematic_story.ogg"
      ],
      "volume": 0.8,
      "loop": false,
      "shuffle": false,
      "tags": ["cutscene", "story"]
    },
    {
      "theme": "Credits",
      "tracks": [
        "audio/music/credits_theme.ogg"
      ],
      "volume": 0.7,
      "loop": false,
      "shuffle": false,
      "tags": ["credits", "ending"]
    }
  ],
  "stingers": [
    {
      "name": "victory",
      "track": "audio/music/victory_fanfare.ogg",
      "volume": 1.0,
      "duckMusic": true,
      "duckAmount": 0.2,
      "resumeDelay": 1.0
    },
    {
      "name": "defeat",
      "track": "audio/music/defeat_somber.ogg",
      "volume": 0.8,
      "duckMusic": true,
      "duckAmount": 0.1,
      "resumeDelay": 2.0
    },
    {
      "name": "level-up",
      "track": "audio/music/levelup_jingle.ogg",
      "volume": 1.0,
      "duckMusic": true,
      "duckAmount": 0.3,
      "resumeDelay": 0.5
    },
    {
      "name": "quest-complete",
      "track": "audio/music/quest_complete.ogg",
      "volume": 0.9,
      "duckMusic": true,
      "duckAmount": 0.3,
      "resumeDelay": 0.5
    },
    {
      "name": "discovery",
      "track": "audio/music/discovery_chime.ogg",
      "volume": 0.7,
      "duckMusic": false,
      "duckAmount": 1.0,
      "resumeDelay": 0
    }
  ],
  "transitions": {
    "defaultCrossfade": 2.0,
    "combatCrossfade": 0.5,
    "bossCrossfade": 1.0,
    "stingerFadeOut": 1.0,
    "stingerResumeDelay": 0.5,
    "transitionType": "Crossfade"
  }
}
```

---

## 13. Data Model Changes

### Domain Layer Additions

This version introduces no new domain entities—only JSON Schema validation. Future runtime implementation would include:

| Component | Type | Purpose |
|-----------|------|---------|
| `ThemeDefinition` | Value Object | Complete theme configuration |
| `IntensityLayer` | Value Object | Dynamic layer configuration |
| `LoopPoints` | Value Object | Seamless loop positions |
| `Stinger` | Value Object | One-shot audio cue |
| `Transitions` | Value Object | Global transition settings |

### No Cross-Reference Changes

The music theme schema is self-contained. Theme categories are referenced by name from other configurations (zones, bosses) but those references are not validated by this schema.

---

## 14. Logging Specifications

### Schema Validation Logging

| Event | Level | Message Format |
|-------|-------|----------------|
| Schema loaded | INFO | `Music themes schema loaded from {path}` |
| Validation success | DEBUG | `Music themes configuration validated ({themeCount} themes, {stingerCount} stingers)` |
| Validation failure | ERROR | `Music themes configuration validation failed: {errors}` |
| Missing required | WARN | `Music theme {theme}: missing required field {field}` |
| Invalid enum | ERROR | `Music theme: invalid category '{value}', must be one of: MainMenu, Exploration, Combat, BossCombat, SafeArea, Puzzle, Cinematic, Credits` |
| Invalid range | WARN | `Music theme {theme}: {field} value {value} outside valid range` |
| Empty tracks | ERROR | `Music theme {theme}: tracks array must have at least 1 item` |

### Runtime Logging (Future)

| Event | Level | Message Format |
|-------|-------|----------------|
| Theme loaded | DEBUG | `Loaded music theme {theme} with {trackCount} tracks` |
| Theme playing | INFO | `Playing music theme: {theme}` |
| Transition started | DEBUG | `Transitioning from {oldTheme} to {newTheme} via {transitionType}` |
| Stinger playing | DEBUG | `Playing stinger: {name}, ducking music to {duckAmount}` |
| Intensity changed | DEBUG | `Music intensity changed to {value}, {layerCount} layers active` |
| Layer fading | DEBUG | `Intensity layer {track} fading to {volume} over {fadeTime}s` |
| Loop point reached | DEBUG | `Loop point reached, jumping from {loopEnd} to {loopStart}` |
| File not found | WARN | `Music file not found: {filePath}` |

---

## 15. Unit Testing Requirements

### Test Summary

| Test ID | Test Name | Description |
|---------|-----------|-------------|
| MUS-001 | ValidMusicThemeConfiguration | Validates a complete configuration with all fields |
| MUS-002 | ThemeCategoryValidation | Validates theme enum with 8 valid categories |
| MUS-003 | IntensityLayerValidation | Validates intensity layer ranges and required fields |
| MUS-004 | LoopPointsValidation | Validates loop points (samples and seconds) |
| MUS-005 | StingerValidation | Validates stinger structure and name pattern |
| MUS-006 | TransitionsValidation | Validates transition settings with defaults |

### Test Specifications

#### MUS-001: ValidMusicThemeConfiguration

```
Test: Valid complete music theme configuration passes schema validation
Given: A music-themes.json with all required and optional fields populated correctly
When: Schema validation is performed
Then: Validation passes with no errors
And: All themes, stingers, and transitions are accessible
```

#### MUS-002: ThemeCategoryValidation

```
Test: Theme category enum validates correctly with 8 categories
Given: Music theme definitions with various theme values
When: Schema validation is performed with themes:
  - { "theme": "MainMenu", "tracks": [...] } → passes
  - { "theme": "Exploration", "tracks": [...] } → passes
  - { "theme": "Combat", "tracks": [...] } → passes
  - { "theme": "BossCombat", "tracks": [...] } → passes
  - { "theme": "SafeArea", "tracks": [...] } → passes
  - { "theme": "Puzzle", "tracks": [...] } → passes
  - { "theme": "Cinematic", "tracks": [...] } → passes
  - { "theme": "Credits", "tracks": [...] } → passes
  - { "theme": "Battle", "tracks": [...] } → fails (not in enum)
  - { "theme": "combat", "tracks": [...] } → fails (case-sensitive)
Then: Valid categories pass, invalid values fail
```

#### MUS-003: IntensityLayerValidation

```
Test: Intensity layer structure validates correctly
Given: Themes with intensity layers
When: Schema validation is performed:
  - { "track": "layer.ogg", "minIntensity": 0.0, "maxIntensity": 1.0 } → passes (minimal)
  - { "track": "layer.ogg", "minIntensity": 0.2, "maxIntensity": 0.8, "fadeTime": 1.0, "volumeMultiplier": 0.9 } → passes
  - { "minIntensity": 0.0, "maxIntensity": 1.0 } → fails (missing track)
  - { "track": "layer.ogg", "maxIntensity": 1.0 } → fails (missing minIntensity)
  - { "track": "layer.ogg", "minIntensity": 0.0 } → fails (missing maxIntensity)
  - { "track": "layer.ogg", "minIntensity": -0.1, "maxIntensity": 1.0 } → fails (min below range)
  - { "track": "layer.ogg", "minIntensity": 0.0, "maxIntensity": 1.5 } → fails (max above range)
Then: Required fields enforced, ranges validated
```

#### MUS-004: LoopPointsValidation

```
Test: Loop points validate correctly (samples and seconds)
Given: Themes with loop points configurations
When: Schema validation is performed:
  - { "loopStartSamples": 44100, "loopEndSamples": 441000 } → passes (samples)
  - { "loopStartSeconds": 1.0, "loopEndSeconds": 10.0 } → passes (seconds)
  - { "loopStartSamples": 44100, "loopStartSeconds": 1.0 } → passes (mixed)
  - { } → passes (empty object, all optional)
  - { "loopStartSamples": -1 } → fails (negative samples)
  - { "loopStartSeconds": -1.0 } → fails (negative seconds)
  - { "loopStartSamples": "44100" } → fails (wrong type)
Then: Valid loop points pass, invalid values fail
```

#### MUS-005: StingerValidation

```
Test: Stinger structure validates correctly with name pattern
Given: Stinger definitions with various configurations
When: Schema validation is performed:
  - { "name": "victory", "track": "fanfare.ogg" } → passes (minimal)
  - { "name": "level-up", "track": "jingle.ogg", "volume": 0.9, "duckMusic": true, "duckAmount": 0.3, "resumeDelay": 0.5 } → passes (complete)
  - { "name": "quest-complete", "track": "complete.ogg" } → passes (kebab-case)
  - { "track": "fanfare.ogg" } → fails (missing name)
  - { "name": "victory" } → fails (missing track)
  - { "name": "Victory", "track": "fanfare.ogg" } → fails (uppercase)
  - { "name": "level_up", "track": "jingle.ogg" } → fails (underscore)
  - { "name": "123-stinger", "track": "sound.ogg" } → fails (starts with number)
Then: Required fields enforced, name pattern validated
```

#### MUS-006: TransitionsValidation

```
Test: Transition settings validate correctly with defaults
Given: Transition configurations with various values
When: Schema validation is performed:
  - { "defaultCrossfade": 2.0 } → passes
  - { "combatCrossfade": 0.5, "bossCrossfade": 1.0 } → passes
  - { "transitionType": "Crossfade" } → passes
  - { "transitionType": "Immediate" } → passes
  - { "transitionType": "FadeOutFadeIn" } → passes
  - { } → passes (all have defaults)
  - { "defaultCrossfade": -1.0 } → fails (negative duration)
  - { "transitionType": "Blend" } → fails (not in enum)
  - { "unknownSetting": true } → fails (additional property)
Then: Valid settings pass, invalid values and unknown fields fail
```

---

## 16. Use Cases

### UC-001: Load Music Theme Configuration

```
┌─────────────────────────────────────────────────────────────────────────────┐
│ UC-001: Load Music Theme Configuration                                       │
├─────────────────────────────────────────────────────────────────────────────┤
│ Actors: Game System                                                          │
│ Trigger: Game startup or configuration reload                                │
│ Preconditions: music-themes.json exists in config directory                  │
├─────────────────────────────────────────────────────────────────────────────┤
│ Flow:                                                                        │
│ 1. System loads music-themes.schema.json                                     │
│ 2. System loads music-themes.json                                            │
│ 3. System validates music-themes.json against schema                         │
│ 4. System parses themes, stingers, and transitions into memory               │
│ 5. System logs successful load with theme/stinger counts                     │
├─────────────────────────────────────────────────────────────────────────────┤
│ Postconditions: Music theme definitions available for playback               │
│ Exceptions: Invalid JSON → log error, use empty configuration                │
└─────────────────────────────────────────────────────────────────────────────┘
```

### UC-002: Play Music Theme

```
┌─────────────────────────────────────────────────────────────────────────────┐
│ UC-002: Play Music Theme                                                     │
├─────────────────────────────────────────────────────────────────────────────┤
│ Actors: Game System                                                          │
│ Trigger: Game state change (enter area, start combat, etc.)                  │
│ Preconditions: Music theme configuration loaded                              │
├─────────────────────────────────────────────────────────────────────────────┤
│ Flow:                                                                        │
│ 1. System determines target theme category from game state                   │
│ 2. System looks up theme definition by category                              │
│ 3. System selects appropriate transition duration                            │
│   - Combat → combatCrossfade                                                 │
│   - BossCombat → bossCrossfade                                               │
│   - Other → defaultCrossfade                                                 │
│ 4. System initiates transition from current theme                            │
│ 5. If introTrack defined, play intro first                                   │
│ 6. Play main track(s) with shuffle if enabled                                │
│ 7. If loop enabled, repeat from step 6 (or loopStart if defined)             │
├─────────────────────────────────────────────────────────────────────────────┤
│ Postconditions: New theme playing at configured volume                       │
│ Exceptions: Theme not found → log warning, continue current theme            │
└─────────────────────────────────────────────────────────────────────────────┘
```

### UC-003: Play Stinger

```
┌─────────────────────────────────────────────────────────────────────────────┐
│ UC-003: Play Stinger                                                         │
├─────────────────────────────────────────────────────────────────────────────┤
│ Actors: Game System                                                          │
│ Trigger: Game event (victory, level-up, quest complete, etc.)                │
│ Preconditions: Stinger configuration loaded                                  │
├─────────────────────────────────────────────────────────────────────────────┤
│ Flow:                                                                        │
│ 1. System receives stinger name                                              │
│ 2. System looks up stinger by name                                           │
│ 3. If duckMusic is true:                                                     │
│   a. Fade music to duckAmount over stingerFadeOut duration                   │
│ 4. Play stinger track at configured volume                                   │
│ 5. Wait for stinger to complete                                              │
│ 6. Wait resumeDelay seconds                                                  │
│ 7. If duckMusic was true, restore music to original volume                   │
├─────────────────────────────────────────────────────────────────────────────┤
│ Postconditions: Stinger plays, music resumes normally                        │
│ Exceptions: Stinger not found → log warning, no action                       │
└─────────────────────────────────────────────────────────────────────────────┘
```

### UC-004: Update Music Intensity

```
┌─────────────────────────────────────────────────────────────────────────────┐
│ UC-004: Update Music Intensity                                               │
├─────────────────────────────────────────────────────────────────────────────┤
│ Actors: Game System                                                          │
│ Trigger: Game state change affecting intensity (combat escalation, etc.)     │
│ Preconditions: Theme with intensity layers is playing                        │
├─────────────────────────────────────────────────────────────────────────────┤
│ Flow:                                                                        │
│ 1. System receives new intensity value (0-1)                                 │
│ 2. For each intensity layer in current theme:                                │
│   a. Calculate target volume based on intensity                              │
│     - If intensity < minIntensity: volume = 0                                │
│     - If intensity >= maxIntensity: volume = volumeMultiplier                │
│     - Else: volume = interpolated value                                      │
│   b. If fadeTime > 0, smoothly transition to target volume                   │
│   c. If fadeTime = 0, immediately set target volume                          │
│ 3. System logs intensity change                                              │
├─────────────────────────────────────────────────────────────────────────────┤
│ Postconditions: Intensity layers at appropriate volumes                      │
│ Exceptions: No intensity layers → no action                                  │
└─────────────────────────────────────────────────────────────────────────────┘
```

### UC-005: Handle Seamless Loop

```
┌─────────────────────────────────────────────────────────────────────────────┐
│ UC-005: Handle Seamless Loop                                                 │
├─────────────────────────────────────────────────────────────────────────────┤
│ Actors: Audio System                                                         │
│ Trigger: Playback reaches loop end point                                     │
│ Preconditions: Theme with loopPoints is playing                              │
├─────────────────────────────────────────────────────────────────────────────┤
│ Flow:                                                                        │
│ 1. Audio system detects playback position approaching loopEnd                │
│ 2. If loopEndSamples defined, use sample-accurate detection                  │
│ 3. Else if loopEndSeconds defined, use time-based detection                  │
│ 4. At loop end point, jump playback to loop start point                      │
│   - If loopStartSamples defined, jump to exact sample                        │
│   - Else if loopStartSeconds defined, jump to time position                  │
│ 5. Continue playback seamlessly                                              │
├─────────────────────────────────────────────────────────────────────────────┤
│ Postconditions: Music loops seamlessly without intro section                 │
│ Exceptions: Invalid loop points → fall back to standard looping              │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 17. Deliverable Checklist

### Configuration Files

| Status | File | Description |
|--------|------|-------------|
| ☐ | `config/schemas/music-themes.schema.json` | Complete JSON Schema for music theme validation |
| ☐ | `config/music-themes.json` | Update with schema reference (already has reference) |

### Unit Tests

| Status | Test | Description |
|--------|------|-------------|
| ☐ | MUS-001 | Valid complete music theme configuration |
| ☐ | MUS-002 | Theme category enum validation |
| ☐ | MUS-003 | Intensity layer validation |
| ☐ | MUS-004 | Loop points validation |
| ☐ | MUS-005 | Stinger validation |
| ☐ | MUS-006 | Transitions validation |

### Documentation

| Status | Document | Description |
|--------|----------|-------------|
| ☑ | Design Specification | This document |
| ☐ | Schema Documentation | Inline in schema file |

---

## 18. Acceptance Criteria

### Functional Criteria

- [ ] `music-themes.schema.json` created in `config/schemas/`
- [ ] Schema validates existing `music-themes.json` without errors
- [ ] Theme enum validated (8 categories)
- [ ] Tracks array validated (minItems: 1)
- [ ] Intro/outro tracks validated as optional strings
- [ ] Volume validated (0-1 range)
- [ ] Loop and shuffle flags validated
- [ ] Stingers validated with name pattern
- [ ] Transitions validated with durations
- [ ] Intensity layers validated with min/max
- [ ] Loop points validated (samples or seconds)
- [ ] ~6 unit tests pass

### Quality Criteria

- [ ] Schema follows JSON Schema Draft-07 specification
- [ ] All properties include descriptive comments
- [ ] Default values documented for optional fields
- [ ] Range constraints clearly specified
- [ ] Existing music-themes.json validates without modification

### Integration Criteria

- [ ] Schema follows patterns from v0.14.6a sound effects schema
- [ ] File path references use consistent format
- [ ] Stinger name uses kebab-case pattern

---

## 19. Dependencies

### Required From

| Version | Dependency | Usage |
|---------|------------|-------|
| v0.14.6a | Sound Effect Schema | Audio schema patterns |
| Existing | `config/music-themes.json` | Configuration to validate |

### Provides To

| Version | Consumer | Usage |
|---------|----------|-------|
| Future | MusicThemeService | Music theme data loading |
| Future | AudioSystem | Music playback configuration |
| Future | zones.json | Music theme references |
| Future | bosses.json | Boss music theme references |

---

## 20. Future Considerations

### Deferred to Later Versions

| Feature | Rationale |
|---------|-----------|
| Audio file existence validation | Runtime concern, not schema |
| Audio format validation | External tooling concern |
| Adaptive music system | Advanced audio feature |
| Per-biome music variants | Zone system integration |
| Dynamic tempo adjustment | Runtime audio processing |

### Potential Enhancements

| Enhancement | Description |
|-------------|-------------|
| Music bus routing | Categorize music into mix buses |
| Beat synchronization | Transition on musical beats |
| Playlist support | Complex track ordering rules |
| Conditional layers | Layers triggered by game events |
| Ducking priority | Multiple stingers compete for ducking |
| Theme inheritance | Base theme with overrides |
| Cross-theme transitions | Specific transition for A→B |

---

## Appendix A: Schema Validation Examples

### Valid Theme (Minimal)

```json
{
  "theme": "MainMenu",
  "tracks": ["audio/music/menu.ogg"]
}
```

### Valid Theme (Complete)

```json
{
  "theme": "Combat",
  "tracks": [
    "audio/music/combat_main.ogg"
  ],
  "introTrack": "audio/music/combat_intro.ogg",
  "outroTrack": "audio/music/combat_outro.ogg",
  "volume": 0.8,
  "loop": true,
  "shuffle": false,
  "intensityLayers": [
    {
      "track": "audio/music/combat_percussion.ogg",
      "minIntensity": 0.3,
      "maxIntensity": 0.7,
      "fadeTime": 1.0,
      "volumeMultiplier": 0.9
    }
  ],
  "loopPoints": {
    "loopStartSeconds": 4.0,
    "loopEndSeconds": 60.0
  },
  "tags": ["combat", "intense"]
}
```

### Valid Stinger

```json
{
  "name": "victory",
  "track": "audio/music/victory_fanfare.ogg",
  "volume": 1.0,
  "duckMusic": true,
  "duckAmount": 0.2,
  "resumeDelay": 1.0
}
```

### Invalid Examples

```json
// Invalid: Theme not in enum
{
  "theme": "Battle",
  "tracks": ["music.ogg"]
}
// Error: 'theme' must be one of: MainMenu, Exploration, Combat, BossCombat, SafeArea, Puzzle, Cinematic, Credits

// Invalid: Empty tracks array
{
  "theme": "Combat",
  "tracks": []
}
// Error: 'tracks' must have at least 1 item

// Invalid: Stinger name uppercase
{
  "name": "Victory",
  "track": "fanfare.ogg"
}
// Error: 'name' must match pattern ^[a-z][a-z0-9-]*$

// Invalid: Intensity outside range
{
  "track": "layer.ogg",
  "minIntensity": -0.5,
  "maxIntensity": 1.0
}
// Error: 'minIntensity' must be >= 0

// Invalid: Transition type not in enum
{
  "transitionType": "Blend"
}
// Error: 'transitionType' must be one of: Crossfade, Immediate, FadeOutFadeIn

// Invalid: Unknown property
{
  "theme": "MainMenu",
  "tracks": ["menu.ogg"],
  "reverb": 0.5
}
// Error: Additional properties not allowed: 'reverb'
```

---

*End of v0.14.6b Design Specification*
