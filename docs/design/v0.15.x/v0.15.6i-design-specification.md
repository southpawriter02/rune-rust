# v0.15.6i Design Specification: Room Entry Integration

**Version:** 0.15.6i
**Parent:** v0.15.6 (Advanced Perception System)
**Prerequisites:** v0.15.6h Complete (Specialization Integration)
**Status:** Design Complete

---

## Table of Contents

1. [Overview](#1-overview)
2. [Scope](#2-scope)
3. [Data Model](#3-data-model)
4. [Services](#4-services)
5. [Command Changes](#5-command-changes)
6. [Rendering Changes](#6-rendering-changes)
7. [Configuration](#7-configuration)
8. [Integration with Existing Systems](#8-integration-with-existing-systems)
9. [Acceptance Criteria](#9-acceptance-criteria)
10. [Test Specifications](#10-test-specifications)
11. [Dependencies](#11-dependencies)
12. [Implementation Notes](#12-implementation-notes)
13. [Design Decisions](#13-design-decisions)
14. [Future Considerations](#14-future-considerations)
15. [Appendix A: Room Entry Flow Examples](#appendix-a-room-entry-flow-examples)
16. [Appendix B: Gated Description Examples](#appendix-b-gated-description-examples)

---

## 1. Overview

### 1.1 Purpose

This phase integrates all Advanced Perception System components into the room entry flow. When a character enters a room, the system automatically calculates their passive perception (including specialization bonuses), checks against all hidden elements in the room, reveals elements at or below the character's passive DC, generates ambient flora/fauna observations, and composes a complete room description that incorporates all discoveries. This provides a seamless, immersive experience where perceptive characters naturally notice more of their surroundings.

### 1.2 Key Changes

| Area | Current State (v0.15.6h) | Target State (v0.15.6i) |
|------|--------------------------|------------------------|
| Room Entry | Shows static room description | Dynamically composes description based on perception |
| Hidden Elements | Require explicit search command | Revealed automatically if passive >= DC |
| Flora/Fauna | Not integrated | Ambient observations based on biome and perception |
| Gated Descriptions | Not implemented | Description fragments appear based on perception thresholds |
| Specialization Bonuses | Applied only on explicit actions | Applied automatically on room entry |

### 1.3 Design Principles

1. **Seamless Integration**: Perception checks happen automatically without player intervention
2. **Progressive Revelation**: Higher perception reveals more details naturally
3. **Consistent Experience**: Same perception mechanics apply whether active or passive
4. **Immersive Narrative**: Discoveries are woven into the room description, not listed as separate items
5. **Performance Aware**: Calculations are optimized for frequent room transitions

---

## 2. Scope

### 2.1 In Scope

From the scope breakdown (lines 555-595):

**RoomEntryPerceptionFlow:**
1. Calculate passive perception
2. Check all hidden elements in room
3. Reveal elements at or below passive DC
4. Generate ambient flora/fauna observations
5. Compose room description with discoveries
6. Display to player

**PerceptionGatedDescription Value Object:**
- RoomId: string
- BaseDescription: string (always shown)
- GatedElements: List<GatedElement>
  - ElementId: string
  - RequiredDc: int
  - DescriptionFragment: string
  - IsRevealed: bool

- IRoomEntryPerceptionService interface
- RoomDescriptionComposer service
- GatedElement value object
- Integration with IPassivePerceptionService (v0.15.6a)
- Integration with IFloraFaunaService (v0.15.6d)
- Integration with ISpecializationPerceptionService (v0.15.6h)
- Configuration file: room-perception.json

### 2.2 Out of Scope (Future Phases)

- Active search during room entry (handled by v0.15.6f)
- Examination of discovered objects (handled by v0.15.6b)
- Investigation of discovered elements (handled by v0.15.6g)
- Dynamic room state changes (future version)
- Multiplayer room entry coordination (future version)

---

## 3. Data Model

### 3.1 PerceptionGatedDescription Value Object

```csharp
/// <summary>
/// Represents a room description with perception-gated content.
/// Contains a base description always shown plus fragments revealed
/// based on the viewer's passive perception value.
/// </summary>
/// <remarks>
/// <para>
/// Room descriptions are composed dynamically based on character perception.
/// The base description provides the fundamental room information, while
/// gated elements add detail for perceptive characters.
/// </para>
/// </remarks>
public sealed record PerceptionGatedDescription
{
    /// <summary>
    /// Unique identifier of the room this description belongs to.
    /// </summary>
    public required string RoomId { get; init; }

    /// <summary>
    /// The base description that is always shown regardless of perception.
    /// This provides the fundamental room atmosphere and layout.
    /// </summary>
    public required string BaseDescription { get; init; }

    /// <summary>
    /// Perception-gated description elements that may or may not be revealed
    /// based on the viewer's passive perception value.
    /// </summary>
    public required IReadOnlyList<GatedElement> GatedElements { get; init; }

    /// <summary>
    /// Creates a new PerceptionGatedDescription with the specified elements.
    /// </summary>
    /// <param name="roomId">The room identifier.</param>
    /// <param name="baseDescription">The always-shown description.</param>
    /// <param name="gatedElements">Perception-gated elements.</param>
    public static PerceptionGatedDescription Create(
        string roomId,
        string baseDescription,
        IReadOnlyList<GatedElement> gatedElements)
    {
        return new PerceptionGatedDescription
        {
            RoomId = roomId,
            BaseDescription = baseDescription,
            GatedElements = gatedElements
        };
    }

    /// <summary>
    /// Evaluates which gated elements are revealed for the given perception value.
    /// </summary>
    /// <param name="passivePerception">The viewer's effective passive perception.</param>
    /// <returns>A new instance with IsRevealed flags updated.</returns>
    public PerceptionGatedDescription EvaluateForPerception(int passivePerception)
    {
        var evaluatedElements = GatedElements
            .Select(e => e with { IsRevealed = passivePerception >= e.RequiredDc })
            .ToList();

        return this with { GatedElements = evaluatedElements };
    }
}
```

### 3.2 GatedElement Value Object

```csharp
/// <summary>
/// Represents a single perception-gated description element within a room.
/// The element is revealed only if the viewer's passive perception meets
/// or exceeds the required DC.
/// </summary>
/// <remarks>
/// <para>
/// Gated elements allow rooms to have layered descriptions where more
/// perceptive characters notice additional details. Elements can represent
/// environmental details, hidden features, or atmospheric observations.
/// </para>
/// </remarks>
public sealed record GatedElement
{
    /// <summary>
    /// Unique identifier for this gated element.
    /// </summary>
    public required string ElementId { get; init; }

    /// <summary>
    /// The minimum passive perception required to reveal this element.
    /// </summary>
    public required int RequiredDc { get; init; }

    /// <summary>
    /// The description fragment shown when this element is revealed.
    /// Should be written to flow naturally within a larger description.
    /// </summary>
    public required string DescriptionFragment { get; init; }

    /// <summary>
    /// Whether this element has been revealed based on the current
    /// viewer's perception. Updated during description evaluation.
    /// </summary>
    public bool IsRevealed { get; init; }

    /// <summary>
    /// Optional category for organizing elements (e.g., "environmental",
    /// "hidden", "atmospheric", "flora", "fauna").
    /// </summary>
    public string? Category { get; init; }

    /// <summary>
    /// Optional priority for ordering elements within the description.
    /// Lower values appear earlier in the composed description.
    /// </summary>
    public int Priority { get; init; } = 100;

    /// <summary>
    /// Optional reference to a hidden element that this description reveals.
    /// When set, revealing this element also marks the hidden element as known.
    /// </summary>
    public string? LinkedHiddenElementId { get; init; }

    /// <summary>
    /// Optional specialization that receives bonus perception for this element.
    /// </summary>
    public string? BonusSpecialization { get; init; }

    /// <summary>
    /// Bonus to the effective DC reduction for characters with the bonus specialization.
    /// </summary>
    public int SpecializationBonus { get; init; }
}
```

### 3.3 RoomEntryContext Value Object

```csharp
/// <summary>
/// Contains all context information for processing a room entry event.
/// Passed through the room entry perception flow to provide necessary data.
/// </summary>
public sealed record RoomEntryContext
{
    /// <summary>
    /// The character entering the room.
    /// </summary>
    public required string CharacterId { get; init; }

    /// <summary>
    /// The room being entered.
    /// </summary>
    public required string RoomId { get; init; }

    /// <summary>
    /// The character's calculated passive perception (including all modifiers).
    /// </summary>
    public required PassivePerception PassivePerception { get; init; }

    /// <summary>
    /// Hidden elements present in the room.
    /// </summary>
    public required IReadOnlyList<HiddenElement> HiddenElements { get; init; }

    /// <summary>
    /// The room's perception-gated description data.
    /// </summary>
    public required PerceptionGatedDescription GatedDescription { get; init; }

    /// <summary>
    /// The room's biome for flora/fauna generation.
    /// </summary>
    public required string Biome { get; init; }

    /// <summary>
    /// Whether this is the first time the character has entered this room.
    /// </summary>
    public bool IsFirstVisit { get; init; }

    /// <summary>
    /// The character's current position within the room (for proximity checks).
    /// </summary>
    public RoomPosition? EntryPosition { get; init; }
}
```

### 3.4 RoomEntryPerceptionResult Value Object

```csharp
/// <summary>
/// Contains the complete result of processing room entry perception,
/// including the composed description and all discoveries made.
/// </summary>
public sealed record RoomEntryPerceptionResult
{
    /// <summary>
    /// The room that was entered.
    /// </summary>
    public required string RoomId { get; init; }

    /// <summary>
    /// The character who entered.
    /// </summary>
    public required string CharacterId { get; init; }

    /// <summary>
    /// The fully composed room description including all revealed elements.
    /// </summary>
    public required string ComposedDescription { get; init; }

    /// <summary>
    /// Hidden elements that were revealed by passive perception.
    /// </summary>
    public required IReadOnlyList<RevealedElement> RevealedElements { get; init; }

    /// <summary>
    /// Hidden elements that were auto-detected by specialization abilities.
    /// </summary>
    public required IReadOnlyList<AutoDetectedElement> AutoDetectedElements { get; init; }

    /// <summary>
    /// Flora/fauna observations generated for this entry.
    /// </summary>
    public required IReadOnlyList<FloraFaunaObservation> Observations { get; init; }

    /// <summary>
    /// Gated description elements that were revealed.
    /// </summary>
    public required IReadOnlyList<GatedElement> RevealedGatedElements { get; init; }

    /// <summary>
    /// Specialization abilities that activated during room entry.
    /// </summary>
    public required IReadOnlyList<AbilityActivation> ActivatedAbilities { get; init; }

    /// <summary>
    /// The effective passive perception used for this check.
    /// </summary>
    public required int EffectivePassivePerception { get; init; }

    /// <summary>
    /// Whether any new discoveries were made on this entry.
    /// </summary>
    public bool HasNewDiscoveries =>
        RevealedElements.Any() ||
        AutoDetectedElements.Any() ||
        RevealedGatedElements.Any(e => e.IsRevealed);
}
```

### 3.5 RevealedElement Value Object

```csharp
/// <summary>
/// Represents a hidden element that was revealed by passive perception on room entry.
/// </summary>
public sealed record RevealedElement
{
    /// <summary>
    /// The hidden element that was revealed.
    /// </summary>
    public required HiddenElement Element { get; init; }

    /// <summary>
    /// The perception value that revealed this element.
    /// </summary>
    public required int PerceptionUsed { get; init; }

    /// <summary>
    /// How much the perception exceeded the DC.
    /// </summary>
    public int ExcessPerception => PerceptionUsed - Element.DiscoveryDc;

    /// <summary>
    /// The description text to display for this revelation.
    /// </summary>
    public required string RevealedDescription { get; init; }
}
```

### 3.6 AutoDetectedElement Value Object

```csharp
/// <summary>
/// Represents a hidden element that was automatically detected by a
/// specialization ability (e.g., Ruin-Stalker's Sixth Sense).
/// </summary>
public sealed record AutoDetectedElement
{
    /// <summary>
    /// The hidden element that was auto-detected.
    /// </summary>
    public required HiddenElement Element { get; init; }

    /// <summary>
    /// The ability that triggered the auto-detection.
    /// </summary>
    public required PerceptionAbility DetectingAbility { get; init; }

    /// <summary>
    /// Distance in feet from the character to the element.
    /// </summary>
    public required int DistanceFeet { get; init; }

    /// <summary>
    /// The description text to display for this auto-detection.
    /// </summary>
    public required string AutoDetectDescription { get; init; }
}
```

---

## 4. Services

### 4.1 IRoomEntryPerceptionService Interface

```csharp
/// <summary>
/// Processes perception checks and description composition on room entry.
/// Integrates passive perception, hidden element detection, flora/fauna
/// observation, and gated descriptions into a unified room entry experience.
/// </summary>
/// <remarks>
/// <para>
/// This service orchestrates the complete room entry perception flow,
/// combining data from multiple perception subsystems to generate a
/// cohesive, perception-appropriate room description.
/// </para>
/// </remarks>
public interface IRoomEntryPerceptionService
{
    /// <summary>
    /// Processes room entry for a character, performing all perception checks
    /// and composing the final room description.
    /// </summary>
    /// <param name="characterId">The character entering the room.</param>
    /// <param name="roomId">The room being entered.</param>
    /// <param name="entryPosition">Optional entry position for proximity checks.</param>
    /// <returns>The complete perception result including composed description.</returns>
    Task<RoomEntryPerceptionResult> ProcessRoomEntryAsync(
        string characterId,
        string roomId,
        RoomPosition? entryPosition = null);

    /// <summary>
    /// Gets the perception-gated description for a room without processing
    /// a full room entry (useful for look command).
    /// </summary>
    /// <param name="characterId">The viewing character.</param>
    /// <param name="roomId">The room to describe.</param>
    /// <returns>The evaluated gated description.</returns>
    Task<PerceptionGatedDescription> GetRoomDescriptionAsync(
        string characterId,
        string roomId);

    /// <summary>
    /// Recalculates revealed elements for a room when character perception changes.
    /// Used when status effects or abilities modify passive perception.
    /// </summary>
    /// <param name="characterId">The character to recalculate for.</param>
    /// <param name="roomId">The room to recalculate.</param>
    /// <returns>Any newly revealed elements.</returns>
    Task<IReadOnlyList<RevealedElement>> RecalculateRoomPerceptionAsync(
        string characterId,
        string roomId);
}
```

### 4.2 IRoomDescriptionComposer Interface

```csharp
/// <summary>
/// Composes room descriptions by combining base descriptions, gated elements,
/// revealed hidden elements, flora/fauna observations, and specialization insights.
/// </summary>
public interface IRoomDescriptionComposer
{
    /// <summary>
    /// Composes a complete room description from all available perception data.
    /// </summary>
    /// <param name="context">The room entry context.</param>
    /// <param name="revealedElements">Elements revealed by passive perception.</param>
    /// <param name="autoDetectedElements">Elements auto-detected by abilities.</param>
    /// <param name="observations">Flora/fauna observations.</param>
    /// <param name="activatedAbilities">Specialization abilities that activated.</param>
    /// <returns>The fully composed description text.</returns>
    string ComposeDescription(
        RoomEntryContext context,
        IReadOnlyList<RevealedElement> revealedElements,
        IReadOnlyList<AutoDetectedElement> autoDetectedElements,
        IReadOnlyList<FloraFaunaObservation> observations,
        IReadOnlyList<AbilityActivation> activatedAbilities);

    /// <summary>
    /// Composes a brief description for subsequent room visits.
    /// </summary>
    /// <param name="roomId">The room identifier.</param>
    /// <param name="knownElements">Elements the character has already discovered.</param>
    /// <returns>A brief description noting previously discovered elements.</returns>
    string ComposeRevisitDescription(
        string roomId,
        IReadOnlyList<string> knownElements);
}
```

### 4.3 RoomEntryPerceptionService Implementation

```csharp
/// <summary>
/// Implementation of the room entry perception service.
/// </summary>
public sealed class RoomEntryPerceptionService : IRoomEntryPerceptionService
{
    private readonly IPassivePerceptionService _passivePerceptionService;
    private readonly ISpecializationPerceptionService _specializationService;
    private readonly IFloraFaunaService _floraFaunaService;
    private readonly IRoomDescriptionComposer _descriptionComposer;
    private readonly IRoomRepository _roomRepository;
    private readonly IHiddenElementRepository _hiddenElementRepository;
    private readonly ICharacterKnowledgeService _knowledgeService;

    public async Task<RoomEntryPerceptionResult> ProcessRoomEntryAsync(
        string characterId,
        string roomId,
        RoomPosition? entryPosition = null)
    {
        // Step 1: Calculate passive perception
        var passivePerception = _passivePerceptionService
            .CalculatePassivePerception(characterId);

        // Step 2: Load room data
        var room = await _roomRepository.GetRoomAsync(roomId);
        var hiddenElements = await _hiddenElementRepository
            .GetElementsForRoomAsync(roomId);
        var gatedDescription = await _roomRepository
            .GetGatedDescriptionAsync(roomId);

        // Step 3: Build context
        var context = new RoomEntryContext
        {
            CharacterId = characterId,
            RoomId = roomId,
            PassivePerception = passivePerception,
            HiddenElements = hiddenElements,
            GatedDescription = gatedDescription,
            Biome = room.Biome,
            IsFirstVisit = !await _knowledgeService.HasVisitedRoomAsync(characterId, roomId),
            EntryPosition = entryPosition ?? room.DefaultEntryPosition
        };

        // Step 4: Check hidden elements against passive perception
        var revealedElements = CheckHiddenElements(context);

        // Step 5: Check for auto-detection from specialization abilities
        var autoDetectedElements = CheckAutoDetection(context);

        // Step 6: Generate flora/fauna observations
        var observations = await GenerateObservations(context);

        // Step 7: Evaluate gated description elements
        var evaluatedDescription = gatedDescription
            .EvaluateForPerception(passivePerception.EffectiveValue);

        // Step 8: Collect activated abilities
        var activatedAbilities = CollectActivatedAbilities(
            characterId, revealedElements, autoDetectedElements);

        // Step 9: Compose final description
        var composedDescription = _descriptionComposer.ComposeDescription(
            context with { GatedDescription = evaluatedDescription },
            revealedElements,
            autoDetectedElements,
            observations,
            activatedAbilities);

        // Step 10: Record discoveries
        await RecordDiscoveries(characterId, roomId, revealedElements, autoDetectedElements);

        return new RoomEntryPerceptionResult
        {
            RoomId = roomId,
            CharacterId = characterId,
            ComposedDescription = composedDescription,
            RevealedElements = revealedElements,
            AutoDetectedElements = autoDetectedElements,
            Observations = observations,
            RevealedGatedElements = evaluatedDescription.GatedElements
                .Where(e => e.IsRevealed)
                .ToList(),
            ActivatedAbilities = activatedAbilities,
            EffectivePassivePerception = passivePerception.EffectiveValue
        };
    }

    private IReadOnlyList<RevealedElement> CheckHiddenElements(RoomEntryContext context)
    {
        var revealed = new List<RevealedElement>();
        var effectivePerception = context.PassivePerception.EffectiveValue;

        foreach (var element in context.HiddenElements)
        {
            // Get element-specific perception bonus (e.g., Trap Sense)
            var elementBonus = _specializationService.GetPassivePerceptionBonus(
                context.CharacterId,
                new[] { element.ElementType });

            var effectiveVsElement = effectivePerception + elementBonus;

            if (effectiveVsElement >= element.DiscoveryDc)
            {
                revealed.Add(new RevealedElement
                {
                    Element = element,
                    PerceptionUsed = effectiveVsElement,
                    RevealedDescription = GenerateRevealDescription(element, effectiveVsElement)
                });
            }
        }

        return revealed;
    }

    private IReadOnlyList<AutoDetectedElement> CheckAutoDetection(RoomEntryContext context)
    {
        var autoDetected = new List<AutoDetectedElement>();

        foreach (var element in context.HiddenElements)
        {
            var distance = CalculateDistance(
                context.EntryPosition,
                element.Position);

            if (_specializationService.CheckAutoDetection(
                context.CharacterId,
                element.ElementType,
                distance))
            {
                var ability = GetAutoDetectAbility(context.CharacterId, element.ElementType);

                autoDetected.Add(new AutoDetectedElement
                {
                    Element = element,
                    DetectingAbility = ability,
                    DistanceFeet = distance,
                    AutoDetectDescription = GenerateAutoDetectDescription(element, ability, distance)
                });
            }
        }

        return autoDetected;
    }

    private async Task<IReadOnlyList<FloraFaunaObservation>> GenerateObservations(
        RoomEntryContext context)
    {
        return await _floraFaunaService.GenerateRoomObservationsAsync(
            context.CharacterId,
            context.RoomId,
            context.Biome,
            context.PassivePerception.EffectiveValue);
    }

    private string GenerateRevealDescription(HiddenElement element, int perception)
    {
        var descriptor = _perceptionDescriptors.GetDescriptor(
            element.ElementType,
            perception - element.DiscoveryDc);

        return descriptor.Format(element);
    }

    private int CalculateDistance(RoomPosition? from, ElementPosition to)
    {
        if (from == null)
            return int.MaxValue;

        // Simple Manhattan distance in feet
        return Math.Abs(from.X - to.X) + Math.Abs(from.Y - to.Y);
    }
}
```

### 4.4 RoomDescriptionComposer Implementation

```csharp
/// <summary>
/// Composes room descriptions by intelligently combining multiple data sources
/// into a flowing, natural narrative.
/// </summary>
public sealed class RoomDescriptionComposer : IRoomDescriptionComposer
{
    public string ComposeDescription(
        RoomEntryContext context,
        IReadOnlyList<RevealedElement> revealedElements,
        IReadOnlyList<AutoDetectedElement> autoDetectedElements,
        IReadOnlyList<FloraFaunaObservation> observations,
        IReadOnlyList<AbilityActivation> activatedAbilities)
    {
        var builder = new StringBuilder();

        // Base description always comes first
        builder.AppendLine(context.GatedDescription.BaseDescription);

        // Add revealed gated elements in priority order
        var revealedGated = context.GatedDescription.GatedElements
            .Where(e => e.IsRevealed)
            .OrderBy(e => e.Priority)
            .ToList();

        foreach (var gatedElement in revealedGated)
        {
            builder.AppendLine();
            builder.AppendLine(gatedElement.DescriptionFragment);
        }

        // Add flora/fauna observations
        if (observations.Any())
        {
            builder.AppendLine();
            foreach (var observation in observations)
            {
                builder.AppendLine(observation.DescriptionText);
            }
        }

        // Add auto-detected elements with ability callout
        if (autoDetectedElements.Any())
        {
            builder.AppendLine();
            foreach (var autoDetected in autoDetectedElements)
            {
                builder.AppendLine($"[{autoDetected.DetectingAbility.AbilityName} activated]");
                builder.AppendLine(autoDetected.AutoDetectDescription);
            }
        }

        // Add passively revealed hidden elements
        if (revealedElements.Any())
        {
            builder.AppendLine();
            foreach (var revealed in revealedElements)
            {
                builder.AppendLine(revealed.RevealedDescription);
            }
        }

        return builder.ToString().TrimEnd();
    }

    public string ComposeRevisitDescription(
        string roomId,
        IReadOnlyList<string> knownElements)
    {
        // On revisit, provide a brief description referencing known elements
        var room = _roomRepository.GetRoom(roomId);
        var brief = room.BriefDescription ?? room.BaseDescription;

        if (knownElements.Any())
        {
            var known = string.Join(", ", knownElements.Take(3));
            return $"{brief}\n\nYou recall the {known} from your previous visit.";
        }

        return brief;
    }
}
```

### 4.5 Room Entry Flow Diagram

```
┌─────────────────────────────────────────────────────────────────────┐
│                    ROOM ENTRY PERCEPTION FLOW                        │
└─────────────────────────────────────────────────────────────────────┘

    Character Enters Room
           │
           ▼
┌─────────────────────────────────────────────────────────────────────┐
│                   STEP 1: CALCULATE PASSIVE PERCEPTION               │
├─────────────────────────────────────────────────────────────────────┤
│  • Base: WITS ÷ 2 (round up)                                        │
│  • Add status effect modifiers ([Alert] +2, [Fatigued] -2)          │
│  • Add specialization bonuses (Veiðimaðr [Keen Senses] +1)          │
│  • Result: EffectivePassivePerception                               │
└─────────────────────────────────────────────────────────────────────┘
           │
           ▼
┌─────────────────────────────────────────────────────────────────────┐
│                   STEP 2: CHECK HIDDEN ELEMENTS                      │
├─────────────────────────────────────────────────────────────────────┤
│  For each hidden element in room:                                   │
│  • Get element type (Trap, Secret, Clue, etc.)                      │
│  • Add element-specific bonuses (Ruin-Stalker [Trap Sense] +2)      │
│  • Compare effective perception vs element DC                       │
│  • If perception >= DC: Add to revealed list                        │
└─────────────────────────────────────────────────────────────────────┘
           │
           ▼
┌─────────────────────────────────────────────────────────────────────┐
│                   STEP 3: CHECK AUTO-DETECTION                       │
├─────────────────────────────────────────────────────────────────────┤
│  For each hidden element in room:                                   │
│  • Calculate distance from entry position                           │
│  • Check specialization auto-detect abilities                       │
│  • Ruin-Stalker [Sixth Sense]: Auto-detect traps within 10 feet     │
│  • If auto-detect triggers: Add to auto-detected list               │
└─────────────────────────────────────────────────────────────────────┘
           │
           ▼
┌─────────────────────────────────────────────────────────────────────┐
│                   STEP 4: GENERATE FLORA/FAUNA OBSERVATIONS          │
├─────────────────────────────────────────────────────────────────────┤
│  • Get room biome                                                   │
│  • Query IFloraFaunaService for observations                        │
│  • Filter based on perception threshold                             │
│  • Add ambient creature/plant descriptions                          │
└─────────────────────────────────────────────────────────────────────┘
           │
           ▼
┌─────────────────────────────────────────────────────────────────────┐
│                   STEP 5: EVALUATE GATED DESCRIPTIONS                │
├─────────────────────────────────────────────────────────────────────┤
│  For each gated element in room description:                        │
│  • Compare effective perception vs required DC                      │
│  • If perception >= DC: Mark as revealed                            │
│  • Apply specialization bonuses for element categories              │
└─────────────────────────────────────────────────────────────────────┘
           │
           ▼
┌─────────────────────────────────────────────────────────────────────┐
│                   STEP 6: COMPOSE DESCRIPTION                        │
├─────────────────────────────────────────────────────────────────────┤
│  • Start with base description (always shown)                       │
│  • Add revealed gated elements (in priority order)                  │
│  • Add flora/fauna observations                                     │
│  • Add auto-detected elements with ability callouts                 │
│  • Add passively revealed hidden elements                           │
└─────────────────────────────────────────────────────────────────────┘
           │
           ▼
┌─────────────────────────────────────────────────────────────────────┐
│                   STEP 7: DISPLAY TO PLAYER                          │
├─────────────────────────────────────────────────────────────────────┤
│  • Render composed description                                      │
│  • Show ability activation notifications                            │
│  • Record discoveries in character knowledge                        │
│  • Mark room as visited                                             │
└─────────────────────────────────────────────────────────────────────┘
```

---

## 5. Command Changes

### 5.1 No New Commands

This phase does not introduce new commands. It modifies the behavior of existing room entry and look commands:

- **Room Entry (movement commands)**: Now triggers full perception flow
- **Look Command**: Uses perception-gated descriptions

### 5.2 Modified Movement Command Handling

```csharp
// In MoveCommandHandler:

public async Task<CommandResult> HandleMoveAsync(MoveCommand command)
{
    // Validate movement
    var targetRoom = ValidateMovement(command);
    if (targetRoom == null)
        return CommandResult.Failed("You cannot go that way.");

    // Move the character
    await _characterService.MoveToRoomAsync(command.CharacterId, targetRoom.RoomId);

    // Process room entry perception (NEW)
    var perceptionResult = await _roomEntryPerceptionService.ProcessRoomEntryAsync(
        command.CharacterId,
        targetRoom.RoomId,
        GetEntryPosition(command.Direction));

    // Render the result
    await _renderer.RenderRoomEntryAsync(perceptionResult);

    return CommandResult.Succeeded();
}
```

### 5.3 Modified Look Command Handling

```csharp
// In LookCommandHandler:

public async Task<CommandResult> HandleLookAsync(LookCommand command)
{
    var characterId = _gameState.CurrentCharacterId;
    var roomId = _gameState.CurrentRoomId;

    // Get perception-gated description (uses same logic as room entry)
    var description = await _roomEntryPerceptionService.GetRoomDescriptionAsync(
        characterId,
        roomId);

    // Re-compose with current perception
    var passivePerception = _passivePerceptionService
        .CalculatePassivePerception(characterId);

    var evaluated = description.EvaluateForPerception(passivePerception.EffectiveValue);

    await _renderer.RenderRoomDescriptionAsync(evaluated, passivePerception);

    return CommandResult.Succeeded();
}
```

---

## 6. Rendering Changes

### 6.1 IRoomEntryRenderer Interface

```csharp
/// <summary>
/// Renders room entry results including perception-based discoveries.
/// </summary>
public interface IRoomEntryRenderer
{
    /// <summary>
    /// Renders the complete room entry result.
    /// </summary>
    /// <param name="result">The room entry perception result.</param>
    Task RenderRoomEntryAsync(RoomEntryPerceptionResult result);

    /// <summary>
    /// Renders a room description for the look command.
    /// </summary>
    /// <param name="description">The evaluated gated description.</param>
    /// <param name="perception">The passive perception used.</param>
    Task RenderRoomDescriptionAsync(
        PerceptionGatedDescription description,
        PassivePerception perception);
}
```

### 6.2 Display Format Examples

**Standard Room Entry:**
```
═══════════════════════════════════════════════════════════════════════
                         Collapsed Tunnel
═══════════════════════════════════════════════════════════════════════

A dimly lit corridor stretches before you. The ceiling has partially
caved in, leaving rubble scattered across the floor. Faint air currents
suggest passages ahead.

Dust patterns on the floor suggest recent passage.

A concealed pressure plate lies beneath the dust near the doorway.

Exits: north, south (blocked)
```

**Room Entry with Ability Activation:**
```
═══════════════════════════════════════════════════════════════════════
                         Collapsed Tunnel
═══════════════════════════════════════════════════════════════════════

Passive Perception: 4 (base 3 + 1 [Keen Senses])

A dimly lit corridor stretches before you. The ceiling has partially
caved in, leaving rubble scattered across the floor.

Dust patterns on the floor suggest recent passage.

[Ruin-Stalker: Sixth Sense activated]
Your honed instincts alert you to danger!

[Trap Auto-Detected: Pressure Plate (8 feet ahead)]
A concealed pressure plate lies beneath the rubble, positioned to
trigger when stepped upon.

Exits: north, south (blocked)
```

**Room Entry with Flora/Fauna:**
```
═══════════════════════════════════════════════════════════════════════
                         Fungal Cavern
═══════════════════════════════════════════════════════════════════════

A vast cavern opens before you, its walls thick with bioluminescent
fungi casting an eerie blue-green glow across the space.

Clusters of glowing cap mushrooms pulse softly with inner light.

A cave spider retreats into a crack as you enter, its many eyes
glinting briefly in the fungal glow.

Small beetles scuttle among the fungal growths, tending to the
mycelium with surprising industry.

Exits: east, west, down
```

---

## 7. Configuration

### 7.1 Room Perception Configuration File

**File:** `data/config/room-perception.json`

```json
{
  "defaultGatedElements": {
    "dustPatterns": {
      "elementId": "generic-dust-patterns",
      "requiredDc": 12,
      "descriptionFragment": "Dust patterns on the floor suggest recent passage.",
      "category": "environmental",
      "priority": 50
    },
    "airCurrents": {
      "elementId": "generic-air-currents",
      "requiredDc": 8,
      "descriptionFragment": "Faint air currents hint at nearby passages.",
      "category": "environmental",
      "priority": 60
    },
    "soundEchoes": {
      "elementId": "generic-sound-echoes",
      "requiredDc": 14,
      "descriptionFragment": "Distant echoes suggest the presence of other creatures.",
      "category": "atmospheric",
      "priority": 70
    }
  },
  "specializationBonuses": {
    "ruin-stalker": {
      "trapElements": 2,
      "hiddenPassages": 1
    },
    "veidmadr": {
      "creatureTraces": 2,
      "tracking": 2
    },
    "thul": {
      "historicalDetails": 2,
      "inscriptions": 2
    },
    "jotun-reader": {
      "technologyElements": 2,
      "powerSources": 1
    }
  },
  "revealDescriptors": {
    "trap": {
      "minimal": "You notice something unusual about the floor here.",
      "partial": "A concealed mechanism lies hidden beneath the surface.",
      "full": "A {trapType} is carefully concealed here, triggered by {triggerMechanism}."
    },
    "secret": {
      "minimal": "Something about this area doesn't look quite right.",
      "partial": "A section of the wall appears slightly different from its surroundings.",
      "full": "A secret {secretType} is hidden here, cleverly disguised as {disguise}."
    },
    "clue": {
      "minimal": "There's something here worth investigating.",
      "partial": "Evidence of past events can be found here.",
      "full": "You notice {clueDescription}."
    }
  },
  "dcThresholds": {
    "minimal": 0,
    "partial": 3,
    "full": 6
  },
  "displaySettings": {
    "showPerceptionValue": true,
    "showAbilityActivations": true,
    "abilityActivationFormat": "[{specialization}: {abilityName} activated]",
    "autoDetectFormat": "[{elementType} Auto-Detected: {elementName} ({distance} feet away)]"
  }
}
```

### 7.2 Room Data Configuration

**File:** `data/rooms/collapsed-tunnel.json` (example)

```json
{
  "roomId": "collapsed-tunnel-1",
  "name": "Collapsed Tunnel",
  "biome": "Underground",
  "baseDescription": "A dimly lit corridor stretches before you. The ceiling has partially caved in, leaving rubble scattered across the floor.",
  "briefDescription": "The collapsed tunnel continues in poor condition.",
  "gatedElements": [
    {
      "elementId": "dust-patterns-1",
      "requiredDc": 12,
      "descriptionFragment": "Dust patterns on the floor suggest recent passage.",
      "category": "environmental",
      "priority": 50
    },
    {
      "elementId": "pressure-plate-hint",
      "requiredDc": 16,
      "descriptionFragment": "A concealed pressure plate lies beneath the dust near the doorway.",
      "category": "hidden",
      "priority": 30,
      "linkedHiddenElementId": "trap-pressure-plate-1"
    }
  ],
  "hiddenElements": [
    {
      "elementId": "trap-pressure-plate-1",
      "elementType": "Trap",
      "discoveryDc": 14,
      "position": { "x": 5, "y": 2 }
    }
  ],
  "defaultEntryPosition": { "x": 0, "y": 5 }
}
```

---

## 8. Integration with Existing Systems

### 8.1 Passive Perception Integration (v0.15.6a)

The room entry flow uses the IPassivePerceptionService to calculate the character's perception:

```csharp
// In RoomEntryPerceptionService.ProcessRoomEntryAsync():

// Step 1: Calculate passive perception (includes all modifiers)
var passivePerception = _passivePerceptionService.CalculatePassivePerception(characterId);

// passivePerception.EffectiveValue includes:
// - Base: WITS ÷ 2 (round up)
// - Status effects: [Alert] +2, [Fatigued] -2
// - Specialization: [Keen Senses] +1
```

### 8.2 Specialization Integration (v0.15.6h)

Specialization abilities affect room entry in multiple ways:

```csharp
// Element-specific perception bonuses
var trapBonus = _specializationService.GetPassivePerceptionBonus(
    characterId,
    new[] { "Trap" });

// Auto-detection abilities
if (_specializationService.CheckAutoDetection(characterId, element.ElementType, distance))
{
    // Ruin-Stalker's Sixth Sense auto-detects traps within 10 feet
}
```

### 8.3 Flora/Fauna Integration (v0.15.6d)

The room entry flow generates flora/fauna observations based on the room's biome:

```csharp
// In RoomEntryPerceptionService.GenerateObservations():

var observations = await _floraFaunaService.GenerateRoomObservationsAsync(
    characterId,
    roomId,
    context.Biome,
    context.PassivePerception.EffectiveValue);
```

### 8.4 Hidden Element Integration (v0.15.6a)

Hidden elements are checked against passive perception on room entry:

```csharp
// In RoomEntryPerceptionService.CheckHiddenElements():

foreach (var element in context.HiddenElements)
{
    var effectivePerception = context.PassivePerception.EffectiveValue;

    // Add element-specific bonuses
    var elementBonus = _specializationService.GetPassivePerceptionBonus(
        context.CharacterId,
        new[] { element.ElementType });

    if (effectivePerception + elementBonus >= element.DiscoveryDc)
    {
        // Element is revealed
    }
}
```

---

## 9. Acceptance Criteria

### 9.1 Room Entry Flow

| ID | Criterion | Priority |
|----|-----------|----------|
| AC-1 | Room entry triggers passive perception check automatically | Must |
| AC-2 | Passive perception includes all modifiers (status, specialization) | Must |
| AC-3 | Hidden elements at or below passive DC are revealed | Must |
| AC-4 | Gated description elements appear based on passive value | Must |

### 9.2 Specialization Integration

| ID | Criterion | Priority |
|----|-----------|----------|
| AC-5 | Element-specific bonuses apply (Trap Sense +2 vs traps) | Must |
| AC-6 | Auto-detection abilities trigger when conditions met | Must |
| AC-7 | Ability activation is displayed in room description | Should |

### 9.3 Description Composition

| ID | Criterion | Priority |
|----|-----------|----------|
| AC-8 | Base description always appears first | Must |
| AC-9 | Revealed gated elements appear in priority order | Must |
| AC-10 | Flora/fauna observations integrate naturally | Should |
| AC-11 | Auto-detected elements show ability callout | Should |

### 9.4 General

| ID | Criterion | Priority |
|----|-----------|----------|
| AC-12 | ~2 unit tests pass | Must |
| AC-13 | Build completes with 0 errors | Must |
| AC-14 | Build completes with 0 warnings | Must |

---

## 10. Test Specifications

### 10.1 Unit Tests (~2+ tests)

#### Test Suite: RoomEntryPerceptionServiceTests

```csharp
[TestClass]
public class RoomEntryPerceptionServiceTests
{
    /// <summary>
    /// Verifies that room entry triggers a passive perception check.
    /// </summary>
    /// <remarks>
    /// Given: Character with WITS 4 (passive perception 2) entering a room
    /// When: ProcessRoomEntryAsync is called
    /// Then: Passive perception is calculated and used for element checks
    /// </remarks>
    [TestMethod]
    public async Task ProcessRoomEntryAsync_TriggersPassivePerceptionCheck()
    {
        // Arrange
        var characterId = "char-1";
        var roomId = "room-1";

        _passivePerceptionServiceMock
            .Setup(p => p.CalculatePassivePerception(characterId))
            .Returns(new PassivePerception
            {
                CharacterId = characterId,
                WitsAttribute = 4,
                PassiveValue = 2,
                EffectiveValue = 2,
                ModifierBreakdown = Array.Empty<PerceptionModifier>()
            });

        _roomRepositoryMock
            .Setup(r => r.GetRoomAsync(roomId))
            .ReturnsAsync(new Room { RoomId = roomId, Biome = "Underground" });

        _roomRepositoryMock
            .Setup(r => r.GetGatedDescriptionAsync(roomId))
            .ReturnsAsync(new PerceptionGatedDescription
            {
                RoomId = roomId,
                BaseDescription = "A dark room.",
                GatedElements = Array.Empty<GatedElement>()
            });

        // Act
        var result = await _service.ProcessRoomEntryAsync(characterId, roomId);

        // Assert
        Assert.AreEqual(2, result.EffectivePassivePerception);
        _passivePerceptionServiceMock.Verify(
            p => p.CalculatePassivePerception(characterId),
            Times.Once);
    }

    /// <summary>
    /// Verifies that gated descriptions appear based on passive value.
    /// </summary>
    /// <remarks>
    /// Given: Room with gated element at DC 12 and character with passive 14
    /// When: ProcessRoomEntryAsync is called
    /// Then: The gated element is included in the composed description
    /// </remarks>
    [TestMethod]
    public async Task ProcessRoomEntryAsync_GatedDescriptionsAppearBasedOnPassive()
    {
        // Arrange
        var characterId = "char-perceptive";
        var roomId = "room-gated";

        _passivePerceptionServiceMock
            .Setup(p => p.CalculatePassivePerception(characterId))
            .Returns(new PassivePerception
            {
                CharacterId = characterId,
                WitsAttribute = 6,
                PassiveValue = 3,
                EffectiveValue = 14, // With bonuses
                ModifierBreakdown = new[]
                {
                    new PerceptionModifier { Source = "Alert", Value = 2 }
                }
            });

        var gatedDescription = new PerceptionGatedDescription
        {
            RoomId = roomId,
            BaseDescription = "A corridor stretches before you.",
            GatedElements = new[]
            {
                new GatedElement
                {
                    ElementId = "dust-1",
                    RequiredDc = 12,
                    DescriptionFragment = "Dust patterns suggest recent passage.",
                    Category = "environmental",
                    Priority = 50
                },
                new GatedElement
                {
                    ElementId = "hidden-1",
                    RequiredDc = 18,
                    DescriptionFragment = "A hidden door is concealed here.",
                    Category = "hidden",
                    Priority = 30
                }
            }
        };

        _roomRepositoryMock
            .Setup(r => r.GetGatedDescriptionAsync(roomId))
            .ReturnsAsync(gatedDescription);

        // Act
        var result = await _service.ProcessRoomEntryAsync(characterId, roomId);

        // Assert
        Assert.AreEqual(1, result.RevealedGatedElements.Count);
        Assert.AreEqual("dust-1", result.RevealedGatedElements[0].ElementId);
        Assert.IsTrue(result.ComposedDescription.Contains("Dust patterns suggest recent passage."));
        Assert.IsFalse(result.ComposedDescription.Contains("hidden door"));
    }

    /// <summary>
    /// Verifies that specialization bonuses apply to element-specific checks.
    /// </summary>
    [TestMethod]
    public async Task ProcessRoomEntryAsync_AppliesSpecializationBonusesToElements()
    {
        // Arrange
        var characterId = "char-ruinstalker";
        var roomId = "room-trapped";

        _passivePerceptionServiceMock
            .Setup(p => p.CalculatePassivePerception(characterId))
            .Returns(new PassivePerception
            {
                EffectiveValue = 4
            });

        _specializationServiceMock
            .Setup(s => s.GetPassivePerceptionBonus(characterId, It.Is<string[]>(t => t.Contains("Trap"))))
            .Returns(2); // Trap Sense +2

        var hiddenElements = new[]
        {
            new HiddenElement
            {
                ElementId = "trap-1",
                ElementType = "Trap",
                DiscoveryDc = 6 // Effective DC for character is 4 + 2 = 6
            }
        };

        _hiddenElementRepositoryMock
            .Setup(h => h.GetElementsForRoomAsync(roomId))
            .ReturnsAsync(hiddenElements);

        // Act
        var result = await _service.ProcessRoomEntryAsync(characterId, roomId);

        // Assert
        Assert.AreEqual(1, result.RevealedElements.Count);
        Assert.AreEqual("trap-1", result.RevealedElements[0].Element.ElementId);
    }
}
```

### 10.2 Test Coverage Requirements

| Area | Minimum Coverage | Priority |
|------|------------------|----------|
| RoomEntryPerceptionService | 95% | Critical |
| RoomDescriptionComposer | 90% | High |
| Gated element evaluation | 100% | Critical |
| Specialization bonus application | 95% | High |

---

## 11. Dependencies

### 11.1 Upstream Dependencies

| Dependency | Source | Usage |
|------------|--------|-------|
| IPassivePerceptionService | v0.15.6a | Calculate passive perception on room entry |
| PassivePerception | v0.15.6a | Perception value and modifier breakdown |
| HiddenElement | v0.15.6a | Hidden elements to check against perception |
| IFloraFaunaService | v0.15.6d | Generate flora/fauna observations |
| FloraFaunaObservation | v0.15.6d | Observation data for room entry |
| ISpecializationPerceptionService | v0.15.6h | Get specialization bonuses and auto-detection |
| PerceptionAbility | v0.15.6h | Ability data for auto-detection callouts |
| AbilityActivation | v0.15.6h | Track activated abilities |

### 11.2 External Dependencies

| Dependency | Version | Purpose |
|------------|---------|---------|
| IRoomRepository | Core | Room data access |
| IHiddenElementRepository | Core | Hidden element data access |
| ICharacterKnowledgeService | Core | Track visited rooms and discoveries |
| ICharacterService | Core | Character position and movement |

### 11.3 Downstream Dependencies

This is the final phase of v0.15.6. It provides to future versions:

| Provides To | Interface/Component | Purpose |
|-------------|---------------------|---------|
| v0.16.x+ | IRoomEntryPerceptionService | Room perception integration point |
| v0.16.x+ | RoomEntryPerceptionResult | Extensible result for future features |

### 11.4 Dependency Diagram

```
┌─────────────────────────────────────────────────────────────────────┐
│                v0.15.6i Room Entry Integration                       │
├─────────────────────────────────────────────────────────────────────┤
│  IRoomEntryPerceptionService   PerceptionGatedDescription           │
│  GatedElement   RoomEntryContext   RoomEntryPerceptionResult        │
│  IRoomDescriptionComposer                                           │
└───────────────────────────────┬─────────────────────────────────────┘
                                │
        ┌───────────────────────┼───────────────────────┐
        │                       │                       │
        ▼                       ▼                       ▼
┌───────────────────┐  ┌───────────────────┐  ┌───────────────────┐
│ v0.15.6a Passive  │  │ v0.15.6d Flora/   │  │ v0.15.6h Special- │
│ Perception        │  │ Fauna             │  │ ization           │
│ ─────────────     │  │ ─────────────     │  │ ─────────────     │
│ PassivePerception │  │ FloraFaunaService │  │ Specialization    │
│ HiddenElement     │  │ Observations      │  │ bonuses &         │
│ Calculations      │  │                   │  │ auto-detection    │
└───────────────────┘  └───────────────────┘  └───────────────────┘
        │                       │                       │
        └───────────────────────┼───────────────────────┘
                                │
                                ▼
        ┌───────────────────────────────────────────────┐
        │              Core Services                     │
        │  IRoomRepository   ICharacterService           │
        │  IHiddenElementRepository                      │
        └───────────────────────────────────────────────┘
```

---

## 12. Implementation Notes

### 12.1 Architecture Layers

```
┌─────────────────────────────────────────────────────────────────────┐
│                    Presentation Layer                                │
├─────────────────────────────────────────────────────────────────────┤
│  IRoomEntryRenderer                                                 │
│  - Renders room entry results                                       │
│  - Displays ability activations                                     │
│  - Formats composed descriptions                                    │
└─────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────┐
│                    Application Layer                                 │
├─────────────────────────────────────────────────────────────────────┤
│  IRoomEntryPerceptionService                                        │
│  - Orchestrates room entry flow                                     │
│  - Coordinates perception checks                                    │
│  - Manages discovery recording                                      │
│                                                                     │
│  IRoomDescriptionComposer                                           │
│  - Composes descriptions from multiple sources                      │
│  - Handles priority ordering                                        │
└─────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────┐
│                      Domain Layer                                    │
├─────────────────────────────────────────────────────────────────────┤
│  PerceptionGatedDescription   GatedElement                          │
│  RoomEntryContext             RoomEntryPerceptionResult             │
│  RevealedElement              AutoDetectedElement                   │
└─────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────┐
│                   Infrastructure Layer                               │
├─────────────────────────────────────────────────────────────────────┤
│  RoomPerceptionConfigurationLoader                                  │
│  RoomRepository (extended for gated descriptions)                   │
└─────────────────────────────────────────────────────────────────────┘
```

### 12.2 Implementation Order

1. **Domain Models** (~Day 1)
   - PerceptionGatedDescription value object
   - GatedElement value object
   - RoomEntryContext value object
   - RoomEntryPerceptionResult value object
   - RevealedElement, AutoDetectedElement value objects

2. **Configuration** (~Day 1)
   - room-perception.json
   - Room data schema updates for gated descriptions
   - Configuration loader

3. **Service Layer** (~Day 2)
   - IRoomEntryPerceptionService interface
   - RoomEntryPerceptionService implementation
   - IRoomDescriptionComposer interface
   - RoomDescriptionComposer implementation

4. **Integration** (~Day 2)
   - Hook into movement command handlers
   - Hook into look command handler
   - Integration with existing perception services

5. **Rendering** (~Day 3)
   - IRoomEntryRenderer interface
   - Room entry display formatting
   - Ability activation display

6. **Testing** (~Day 3)
   - RoomEntryPerceptionServiceTests
   - Description composition tests
   - Integration tests

---

## 13. Design Decisions

### 13.1 Automatic vs Manual Perception

**Decision:** Room entry perception is automatic (no player action required).

**Rationale:**
- Reduces command overhead for common actions
- Creates immersive experience where perceptive characters naturally notice more
- Consistent with tabletop RPG conventions (passive perception)
- Players can still use explicit search/examine for deeper investigation

### 13.2 Gated Descriptions as Fragments

**Decision:** Gated descriptions are stored as fragments that integrate into the base description.

**Rationale:**
- Allows natural-sounding composed descriptions
- Supports priority ordering for coherent narrative flow
- Enables element-specific specialization bonuses
- Avoids repetitive "You notice..." phrasing

### 13.3 Single Pass vs Incremental Revelation

**Decision:** Room entry performs a single perception check that reveals all qualifying elements.

**Rationale:**
- More efficient than checking each element separately
- Provides complete picture on entry
- Matches player expectations from tabletop
- Subsequent visits can use cached knowledge

### 13.4 Composition Order

**Decision:** Description composition follows strict order: base → gated → flora/fauna → auto-detected → revealed hidden.

**Rationale:**
- Base description establishes setting
- Gated elements add environmental detail
- Flora/fauna adds ambiance
- Auto-detected elements highlight specialization value
- Hidden elements are natural discoveries

---

## 14. Future Considerations

### 14.1 Completed v0.15.6 System

With v0.15.6i complete, the Advanced Perception System provides:

- Passive perception calculation (v0.15.6a)
- Three-layer examination (v0.15.6b)
- Puzzle hints and perception (v0.15.6c)
- Flora/fauna observation (v0.15.6d)
- Status effect modifiers (v0.15.6e)
- Active search enhancement (v0.15.6f)
- Investigation command (v0.15.6g)
- Specialization abilities (v0.15.6h)
- Room entry integration (v0.15.6i)

### 14.2 Post-v0.15.6 Potential Features

- **Dynamic Room Changes:** Perception re-checks when room state changes
- **Party Perception:** Highest perception in party reveals for all
- **Perception Memory:** Remember what was noticed on previous visits
- **Time-Based Changes:** Different observations at different times of day
- **Environmental Conditions:** Weather/lighting affect perception
- **Perception Events:** Trigger events when certain elements discovered

---

## Appendix A: Room Entry Flow Examples

### A.1 Standard Room Entry (Low Perception)

```
> north

Moving north...

═══════════════════════════════════════════════════════════════════════
                         Collapsed Tunnel
═══════════════════════════════════════════════════════════════════════

Passive Perception: 2

A dimly lit corridor stretches before you. The ceiling has partially
caved in, leaving rubble scattered across the floor.

Exits: north, south
```

### A.2 Room Entry with Moderate Perception

```
> north

Moving north...

═══════════════════════════════════════════════════════════════════════
                         Collapsed Tunnel
═══════════════════════════════════════════════════════════════════════

Passive Perception: 5

A dimly lit corridor stretches before you. The ceiling has partially
caved in, leaving rubble scattered across the floor.

Faint air currents hint at passages beyond the visible rubble.

Exits: north, south
```

### A.3 Room Entry with High Perception

```
> north

Moving north...

═══════════════════════════════════════════════════════════════════════
                         Collapsed Tunnel
═══════════════════════════════════════════════════════════════════════

Passive Perception: 7

A dimly lit corridor stretches before you. The ceiling has partially
caved in, leaving rubble scattered across the floor.

Faint air currents hint at passages beyond the visible rubble.

Dust patterns on the floor suggest recent passage.

Exits: north, south
```

### A.4 Room Entry with Specialization Abilities

```
> north

Moving north...

═══════════════════════════════════════════════════════════════════════
                         Collapsed Tunnel
═══════════════════════════════════════════════════════════════════════

Passive Perception: 5 (base 4 + 1 [Keen Senses])
vs Traps: 7 (+ 2 [Trap Sense])

A dimly lit corridor stretches before you. The ceiling has partially
caved in, leaving rubble scattered across the floor.

Faint air currents hint at passages beyond the visible rubble.

[Ruin-Stalker: Sixth Sense activated]
Your honed instincts immediately alert you to danger!

[Trap Auto-Detected: Pressure Plate (8 feet ahead)]
A concealed pressure plate lies beneath the rubble near the passage
ahead. Your experience with ruins makes such hazards obvious to you.

Exits: north, south
```

---

## Appendix B: Gated Description Examples

### B.1 Environmental Gating

```
Base (always):
  "A dimly lit corridor stretches before you."

DC 8 (if passive >= 8):
  "Faint air currents hint at passages beyond."

DC 12 (if passive >= 12):
  "Dust patterns on the floor suggest recent passage."

DC 16 (if passive >= 16):
  "A concealed pressure plate lies beneath the dust near the doorway."
```

### B.2 Atmospheric Gating

```
Base (always):
  "An abandoned chamber, its walls covered in strange markings."

DC 6 (if passive >= 6):
  "The markings appear to be some form of writing, though faded with age."

DC 10 (if passive >= 10):
  "Several of the symbols repeat in patterns that suggest warnings."

DC 14 (if passive >= 14):
  "One symbol in particular—a stylized eye—appears freshly carved, unlike the ancient marks around it."

DC 18 (if passive >= 18):
  "The fresh carving is positioned to be visible from a specific angle near the entrance, as if meant to be seen by those who know to look."
```

### B.3 Technology Gating (Jötun-Reader Bonus)

```
Base (always):
  "A control room filled with dormant machinery."

DC 8 (if passive >= 8):
  "Several consoles line the walls, their surfaces dark and silent."

DC 12 (if passive >= 12, or DC 10 for Jötun-Reader):
  "One console still shows a faint power indicator, suggesting residual energy."

DC 16 (if passive >= 16, or DC 14 for Jötun-Reader):
  "The active console appears to be a secondary diagnostic terminal—likely still functional if powered properly."
```

### B.4 Creature Traces Gating (Veiðimaðr Bonus)

```
Base (always):
  "A natural cavern with a sandy floor."

DC 8 (if passive >= 8):
  "Small bones are scattered near the far wall."

DC 12 (if passive >= 12, or DC 10 for Veiðimaðr):
  "The bones show gnaw marks from a medium-sized predator."

DC 16 (if passive >= 16, or DC 14 for Veiðimaðr):
  "Fresh tracks in the sand lead to a shadowed alcove—something denned here recently, and may return."
```

---

*This design specification provides the detailed blueprint for implementing v0.15.6i Room Entry Integration, completing the v0.15.6 Advanced Perception System. See the scope breakdown for integration context with other v0.15.6 sub-phases.*
