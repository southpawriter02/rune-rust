# Version 0.3.2: Rest & Recovery

**Status:** Complete
**Milestone:** Milestone 4 - Core Systems Layer
**Theme:** Resource Management & Recovery Systems

## Table of Contents
- [Overview](#overview)
- [Phase A: The Campfire (Core Logic)](#phase-a-the-campfire-core-logic)
- [Phase B: The Watch (Ambush System)](#phase-b-the-watch-ambush-system)
- [Phase C: The Dawn (Integration)](#phase-c-the-dawn-integration)
- [Changelog (v0.3.2)](#changelog-v032)

## Overview

This milestone implements the Resting System, a critical pacing mechanic that forces players to balance resource consumption against the risk of ambush. It distinguishes between the safety of Runic Anchors and the danger of the wild.

The Rest & Recovery system is implemented across three phases:

- **Phase A (v0.3.2a): The Campfire** - Resource consumption, recovery formulas, and state changes
- **Phase B (v0.3.2b): The Watch** - Risk calculation, Camp Craft skills, and ambush generation
- **Phase C (v0.3.2c): The Dawn** - UI feedback, Sanctuary features, and command integration

---

## Phase A: The Campfire (Core Logic)

**Goal:** Implement the RestService to handle resource deduction (Rations/Water), apply recovery formulas, and manage the "Exhausted" state when supplies are missing.

### Architecture & Data Flow

The RestService acts as a transaction coordinator between the InventoryService (consumables), StatCalculationService (max values), and TraumaService (stress).

**Workflow: The Rest Transaction**

1. **Input:** System calls `RestService.PerformRest(Character, RestType)`.
2. **Resource Validation:** Service checks Inventory for item_ration (1) and item_water (1).
   - If Wilderness: Deduct items. If missing, flag IsExhausted.
   - If Sanctuary: No supplies required (or auto-supplied by settlement).
3. **Calculation:**
   - Calculate Max HP/Stamina (ensure baseline is current).
   - Calculate Recovery Amount based on RestType, Attribute.Sturdiness, and Attribute.Will.
4. **Application:**
   - Update CurrentHP, CurrentStamina, PsychicStress.
   - If IsExhausted, apply [Exhausted] Status Effect (halves regen, prevents running).
5. **Time:** Advance World Time by 8 hours (480 minutes).
6. **Output:** Return RestResult (deltas for UI display).

### Logic Decision Trees

#### A. Resource Logic
**Input:** Character, RestType

1. **Is RestType == Sanctuary?**
   - Yes: Supplies Not Needed. Proceed to Recovery (Full).
2. **Is RestType == Wilderness?**
   - Check: Does Inventory contain 1 Ration AND 1 Water?
     - Yes: Remove 1 Ration, 1 Water. Supplies Used. Proceed to Recovery (Standard).
     - No: Supplies Missing. Proceed to Recovery (Partial) AND Apply [Exhausted].

#### B. Recovery Logic (Standard)
**Input:** Character, Attributes

1. **HP Recovery:**
   - Base = 10 + (Sturdiness × 2)
   - NewHP = Math.Min(MaxHP, CurrentHP + Base)
   - Note: Wilderness rest does not fully heal severe wounds.
2. **Stamina Recovery:**
   - NewStamina = MaxStamina (Rest always restores full fatigue).
3. **Stress Recovery:**
   - Reduction = Will × 5
   - NewStress = Math.Max(0, CurrentStress - Reduction)
4. **Corruption:**
   - No Change. (Corruption requires specific rituals/items).

#### C. Recovery Logic (Sanctuary)
**Input:** Character

1. **HP:** CurrentHP = MaxHP (Full Heal).
2. **Stamina:** CurrentStamina = MaxStamina (Full Refresh).
3. **Stress:** CurrentStress = 0 (Safe Haven).
4. **Corruption:** No Change.

### Testing Requirements

**Unit Tests (RestServiceTests.cs)**
- Resource_Deduction
- Missing_Resources
- Sanctuary_FullHeal
- Wilderness_StressMath

**Integration Tests**
- Status_Cleanse

### Deliverable Checklist (Phase A)

- **Core:**
  - [ ] Define RestType Enum.
  - [ ] Define RestResult Record.
  - [ ] Add Exhausted to StatusEffectType Enum (if not present).
- **Engine:**
  - [ ] Create IRestService interface.
  - [ ] Implement RestService.
  - [ ] Inject IInventoryService, IStatusEffectService, ITraumaService.
  - [ ] Implement supply deduction logic.
  - [ ] Implement recovery formulas (Sanctuary vs Wilderness).
- **Data:**
  - [ ] Ensure "Ration" and "Water" items exist in ItemRepository (or Seeder).

---

## Phase B: The Watch (Ambush System)

**Goal:** Implement the logic for calculating rest safety based on Biome and Skill, determining ambush outcomes, and seamlessly transitioning from a "Rest" attempt into a "Combat" state if triggered.

### Architecture & Data Flow

The RestService now acts as a gateway. Before executing the recovery logic (v0.3.2a), it must clear a safety check.

**Workflow: The Watch Cycle**

1. **Input:** Player initiates `camp` (Wilderness Rest).
2. **Risk Calculation:**
   - Retrieve Room.DangerLevel and Room.BiomeType.
   - Calculate Base Ambush Chance (e.g., 10% to 50%).
3. **Mitigation (Camp Craft):**
   - Roll WITS + Wasteland Survival skill.
   - Reduce Base Chance by 5% × NetSuccesses.
4. **Determination:**
   - Roll d100 against Final Chance.
5. **Branching Outcome:**
   - **Safe:** Proceed to PerformRestAsync (v0.3.2a logic).
   - **Ambush:**
     - Cancel Rest (Resources consumed, no recovery).
     - Call EncounterGenerationService.GenerateAmbush().
     - Initialize Combat with Surprise Round (Enemies act first or Player [Stunned] turn 1).
6. **Feedback:** Return AmbushResult to UI.

### Logic Decision Trees

#### A. Ambush Probability Logic
**Input:** DangerLevel, WITS, Skill Rank

1. **Determine Base Risk:**
   - Safe: 0% (Always safe).
   - Unstable: 15%.
   - Hostile: 30%.
   - Lethal: 50%.
2. **Determine Mitigation:**
   - Pool = WITS + WastelandSurvivalRank.
   - Roll = DiceService.Roll(Pool).
   - Reduction = Successes × 5.
3. **Calculate Final Chance:**
   - Chance = Max(5, BaseRisk - Reduction). (Minimum 5% risk in Hostile/Lethal zones, regardless of skill).
   - Exception: Safe zones remain 0%.

### Testing Requirements

**Unit Tests (RestServiceTests.cs)**
- Safety_Calculation
- Safe_Zone_Immunity
- Ambush_Trigger
- Safe_Result

**Integration Tests**
- Workflow_Interruption

### Deliverable Checklist (Phase B)

- **Core:**
  - [ ] Define AmbushResult record.
  - [ ] Update EncounterContext to include bool IsAmbush.
- **Engine:**
  - [ ] Implement RestService.CheckForAmbushAsync.
  - [ ] Inject IEncounterGenerationService into RestService.
  - [ ] Update EncounterGenerationService to handle IsAmbush flag.
- **Data:**
  - [ ] Ensure WastelandSurvival skill is defined in SkillRegistry.

---

## Phase C: The Dawn (Integration)

**Goal:** Wire the `rest` and `camp` commands, implement the UI feedback loops, including the "Rest Summary" screen.

### Architecture & Data Flow

**Workflow: Command Pipeline**

1. **Input:** Player types `camp` (Wilderness) or `rest` (Sanctuary).
2. **Parser Validation:**
   - If `rest`: Is Room.Features tagged with RunicAnchor?
   - If `camp`: Is Room.DangerLevel > Safe?
3. **Execution (Service Layer):**
   - **Wilderness:** Call RestService.CalculateAmbushAsync.
     - If Ambush: Transition to GamePhase.Combat.
     - If Safe: Call RestService.PerformRestAsync (Consume supplies → Calc Gains).
   - **Sanctuary:** Call RestService.PerformRestAsync (Full restore).
4. **Feedback (UI Layer):**
   - If Ambush: Show "Wake up!" alert.
   - If Rest: Pass RestResult to RestScreenRenderer.
5. **State Update:**
   - Advance World Time (+8 hours).
   - Trigger auto-save.

### Testing Requirements

**Unit Tests (CommandParserTests.cs)**
- Rest_WithoutAnchor_Fails
- Rest_WithAnchor_Succeeds
- Camp_Ambush_TriggersCombat

**Integration Tests**
- Full Cycle

### Deliverable Checklist (Phase C)

- **Core:**
  - [ ] Add RoomFeature enum.
  - [ ] Update Room entity with List<RoomFeature>.
  - [ ] Define IRestScreenRenderer interface.
- **Engine:**
  - [ ] Update CommandParser to handle `rest` and `camp`.
  - [ ] Integrate RestService ambush checks into parser logic.
- **Terminal:**
  - [ ] Implement RestScreenRenderer.
  - [ ] Register renderer in DI.
- **Data:**
  - [ ] Update RoomRepository (or seeder) to include sample rooms with Runic Anchors.

---

## Changelog (v0.3.2)

**Release Date:** 2025-XX-XX

### Summary
The "Rest & Recovery" milestone is complete. Players can now manage their long-term survival through a bifurcated resting system. Use `camp` in the wild to patch wounds (at the cost of supplies and safety), or find a `rest` spot at a Runic Anchor for complete recovery.

### Features
- **Wilderness Camping:**
  - Command: `camp`.
  - Costs: 1 Ration, 1 Water.
  - Effect: Restores ~75% HP. Reduces Stress based on WILL.
  - **Risk:** In dangerous biomes, camping triggers a **Camp Craft** check. Failure leads to an **Ambush** encounter.
  - **Exhaustion:** Resting without supplies applies the [Exhausted] debuff.
- **Sanctuary Resting:**
  - Command: `rest` (Requires Room with [Runic Anchor]).
  - Costs: None.
  - Effect: 100% HP/Stamina restore. Clears all Stress. Unlocks Leveling.
- **UI:** New Rest Summary screen detailing resources lost and stats gained.

### Technical
- Implemented `RestService` for resource/stat logic.
- Implemented `AmbushService` for risk calculation.
- Added `RoomFeature` system to the Room Engine.
