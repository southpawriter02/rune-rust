# v0.3.4: The Gateway (Menu & Creation)

> **Status:** Planned
> **Milestone:** Milestone 4.5 - Interface Polish
> **Theme:** Immersive startup experience with animated title screen and character creation wizard

## Table of Contents
- [Overview](#overview)
- [Phase A: The Facade (Visuals & Menu)](#phase-a-the-facade-visuals--menu)
- [Phase B: The Forge (Creation Wizard)](#phase-b-the-forge-creation-wizard)
- [Phase C: The Prologue (Narrative)](#phase-c-the-prologue-narrative)
- [Testing Strategy](#testing-strategy)
- [Changelog (v0.3.4)](#changelog-v034)

## Overview

This milestone replaces the debug-style startup with an immersive, "glitched" terminal interface using Spectre.Console. It establishes the tone of Aethelgard immediately upon launch.

The Gateway is implemented across three phases:

- **Phase A (v0.3.4a): The Facade** - ASCII art engine, glitch effects, and main menu navigation
- **Phase B (v0.3.4b): The Forge** - Split-screen character creator with live stat previews
- **Phase C (v0.3.4c): The Prologue** - Typewriter intro system and seamless game loop transition

---

## Phase A: The Facade (Visuals & Menu)

**Goal:** Implement TitleScreenService to render an animated ASCII title with dynamic corruption effects ("The Glitch") and an interactive main menu that routes to Game Creation, Load, or Quit.

### 1. Architecture & Data Flow

**Workflow: The Startup Sequence**

1. **Program Start:** `Program.cs` resolves `ITitleScreenService`.
2. **Asset Load:** Service loads FIGlet fonts (`runic.flf`) and logo assets.
3. **Animation Loop (Async):**
   - Render "Rune & Rust" in Gold (Pre-Glitch).
   - Tick (100ms): Roll for "Glitch Event".
   - On Glitch: Randomly replace characters with Elder Futhark runes; shift color to Red/Purple; apply "noise" characters.
   - On Input: If player presses any key, break loop immediately.
4. **Menu Render:** Clear animation. Display `SelectionPrompt` (New Game, Load, Options, Quit).
5. **Routing:** Return selected `MainMenuOption` to the GameService to trigger the next phase.

### 2. Logic Decision Trees

#### A. Glitch Animation Logic

**Input:** Current Frame, Chaos Threshold (e.g., 5%)

1. **Check Input:** Is `KeyAvailable`?
   - Yes: Stop Animation. Proceed to Menu.
2. **Roll Chaos:** `Random.NextDouble() < Threshold`?
   - No: Render "Stable" Frame (Gold text, standard font).
   - Yes: Render "Corrupted" Frame:
     - Color: `Color.DarkRed` or `Color.Purple`.
     - Text Mutation: Replace 1-3 characters with Runes (ᚠ, ᚢ, ᚦ, ᚨ, ᚱ).
     - Overlay: Add "Zalgo" marks or static chars (#, %, &) to borders.
3. **Wait:** `Task.Delay(50ms)`. Repeat.

#### B. Menu Interaction Logic

**Input:** User Selection

1. **New Game:** → Return `MenuResult.NewGame` (Triggers Wizard v0.3.4b).
2. **Load Game:** → Query `ISaveGameRepository`.
   - If Saves Exist: Return `MenuResult.LoadGame`.
   - If Empty: Show "No Archives Found" toast. Re-render Menu.
3. **Options:** → Return `MenuResult.Options` (Triggers Settings UI).
4. **Quit:** → Return `MenuResult.Quit` (Triggers App Shutdown).

### 3. Code Implementation

**File:** `RuneAndRust.Terminal/Services/TitleScreenService.cs`

```csharp
using Spectre.Console;
using RuneAndRust.Core.Enums;

public class TitleScreenService : ITitleScreenService
{
    private readonly IAnsiConsole _console;
    private readonly FigletFont _font;
    private const string TitleText = "RUNE & RUST";

    public TitleScreenService(IAnsiConsole console)
    {
        _console = console;
        _font = FigletFont.Load("Assets/Fonts/runic.flf");
    }

    public async Task<MainMenuOption> ShowTitleAndMenuAsync()
    {
        _console.Clear();
        await RunGlitchLoop();
        return ShowMenu();
    }

    private async Task RunGlitchLoop()
    {
        var layout = new Layout("Title").Ratio(1);
        var random = new Random();

        await _console.Live(layout)
            .StartAsync(async ctx =>
            {
                while (!Console.KeyAvailable)
                {
                    bool isGlitched = random.NextDouble() < 0.15;
                    var style = isGlitched ? new Style(Color.Red1, decoration: Decoration.Bold) : new Style(Color.Gold1);
                    var text = isGlitched ? CorruptText(TitleText) : TitleText;

                    layout.Update(
                        new Panel(
                            new FigletText(_font, text).Centered().Style(style)
                        ).Border(BoxBorder.None).Expand()
                    );

                    ctx.Refresh();
                    await Task.Delay(isGlitched ? 50 : 200);
                }
            });

        Console.ReadKey(true);
    }

    private string CorruptText(string input)
    {
        return input.Replace('R', 'ᚱ').Replace('U', 'ᚢ').Replace('N', 'ᚾ').Replace('E', 'ᛖ');
    }

    private MainMenuOption ShowMenu()
    {
        return _console.Prompt(
            new SelectionPrompt<MainMenuOption>()
                .Title("[grey]Select an option:[/]")
                .AddChoices(Enum.GetValues<MainMenuOption>())
                .HighlightStyle(new Style(Color.Cyan1))
        );
    }
}
```

**File:** `RuneAndRust.Core/Enums/MainMenuOption.cs`

```csharp
public enum MainMenuOption
{
    NewGame,
    LoadGame,
    Options,
    Quit
}
```

### 4. Logging Requirements

| Event | Level | Message Template | Properties |
|-------|-------|------------------|------------|
| App Start | Info | "Application started. Version {Version}." | Version |
| Title Skipped | Debug | "User skipped title animation." | - |
| Menu Selection | Info | "Main Menu selection: {Option}." | Option |
| Load Check | Debug | "Checking save slots for Load Game menu. Found {Count}." | Count |

### 5. Testing Requirements

**Unit Tests (TitleScreenTests.cs)**

- **Menu_Rendering:**
  - Mock `IAnsiConsole` and input stream.
  - Expect Prompt to be called.
  - Verify enum values are populated in choices.
- **Glitch_Text_Generation:**
  - Call `CorruptText("TEST")`.
  - Assert output contains specific unicode runes (e.g., contains 'ᛖ').
  - Assert output length matches input length (visual stability).

**Integration Tests**

- **Flow_NewGame:**
  - Start App → Select "New Game".
  - Verify GameService transitions to CreationWizard.
- **Flow_Quit:**
  - Start App → Select "Quit".
  - Verify Application Exit code 0.

### 6. Deliverable Checklist (Phase A)

- **Assets:**
  - [ ] Acquire `runic.flf` (Figlet font) and place in `RuneAndRust.Terminal/Assets`.
  - [ ] Configure `.csproj` to copy assets to Output Directory.
- **Core:**
  - [ ] Define `MainMenuOption` enum.
  - [ ] Define `ITitleScreenService` interface.
- **Terminal:**
  - [ ] Implement `TitleScreenService` with Spectre.Console.
  - [ ] Implement `CorruptText` logic using Domain 3 runes (Ansuz, Raido, etc.).
  - [ ] Wire `Program.cs` to call `ShowTitleAndMenuAsync` before the main loop.
- **Refactor:**
  - [ ] Update `GameService` to accept `MainMenuOption` result and route accordingly.

---

## Phase B: The Forge (Creation Wizard)

**Goal:** Implement a multi-pane TUI using `Spectre.Console.Live` that updates a "Preview Panel" dynamically as the user navigates selection menus for Lineage, Background, and Archetype.

### 1. Architecture & Data Flow

**The Live Loop Pattern:** To achieve "Live Preview" (updating the right panel while selecting in the left), we cannot use standard blocking prompts (`AnsiConsole.Prompt`). We must implement a Custom Input Loop that manages the selection index and screen refreshes manually.

**Workflow: The Creation Pipeline**

1. **Initialization:** `CreationWizard` initializes a `WizardContext` (holds partial selections).
2. **Step 1: Name:** Simple text input (blocking).
3. **Step 2: Lineage:**
   - Render Layout (Left: Menu, Right: Stat Preview).
   - Loop: Read Key → Update Index → Recalculate Preview Stats → Refresh Layout.
   - On Confirm: Update Context, move to Step 3.
4. **Step 3: Background:** Similar loop. Updates Context.
5. **Step 4: Archetype:** Similar loop. Preview shows cumulative stats (Lineage + Archetype).
6. **Finalization:** Call `CharacterFactory` with `WizardContext`.

### 2. Logic Decision Trees

#### A. Navigation Logic (Input Loop)

**Input:** `ConsoleKeyInfo`

1. **Up Arrow:** Decrement `SelectionIndex` (Loop to max if < 0). Trigger `UpdatePreview()`.
2. **Down Arrow:** Increment `SelectionIndex` (Loop to 0 if > max). Trigger `UpdatePreview()`.
3. **Enter:**
   - Save `Options[SelectionIndex]` to `WizardContext`.
   - Break Loop (Proceed to next step).
4. **Backspace/Escape:**
   - Clear current selection.
   - Return to Previous Step.
   - If at Step 1: Return to Main Menu.

#### B. Preview Calculation Logic

**Input:** `WizardContext`, `CurrentHighlight`

1. **Base Stats:** Start with defaults (5s).
2. **Apply Lineage:**
   - If `Context.Lineage` is set, apply its modifiers.
   - Else if `CurrentStep == Lineage`, apply modifiers of `CurrentHighlight`.
3. **Apply Archetype:**
   - If `CurrentStep == Archetype`, apply modifiers of `CurrentHighlight`.
4. **Derive:** Calculate HP, Stamina, AP using `StatCalculationService`.
5. **Render:** Draw bar charts relative to min/max values.

### 3. Code Implementation

**File:** `RuneAndRust.Core/Models/WizardContext.cs`

```csharp
public class WizardContext
{
    public string Name { get; set; } = string.Empty;
    public LineageType? Lineage { get; set; }
    public BackgroundType? Background { get; set; }
    public ArchetypeType? Archetype { get; set; }

    public bool IsStepComplete(int stepIndex) => stepIndex switch
    {
        0 => !string.IsNullOrWhiteSpace(Name),
        1 => Lineage.HasValue,
        2 => Background.HasValue,
        3 => Archetype.HasValue,
        _ => false
    };
}
```

**File:** `RuneAndRust.Engine/Services/WizardService.cs`

```csharp
public Dictionary<Attribute, int> GetPreviewStats(WizardContext ctx, ArchetypeType? previewArch = null, LineageType? previewLin = null)
{
    var stats = new Dictionary<Attribute, int>();
    foreach(var attr in Enum.GetValues<Attribute>()) stats[attr] = 5;

    if (ctx.Lineage.HasValue) ApplyBonuses(stats, _statService.GetLineageBonuses(ctx.Lineage.Value));

    if (previewLin.HasValue) ApplyBonuses(stats, _statService.GetLineageBonuses(previewLin.Value));
    if (previewArch.HasValue) ApplyBonuses(stats, _statService.GetArchetypeBonuses(previewArch.Value));

    return stats;
}
```

**File:** `RuneAndRust.Terminal/UI/CreationWizard.cs`

```csharp
public async Task<Character?> RunAsync()
{
    var context = new WizardContext();

    context.Name = AnsiConsole.Ask<string>("Enter your [green]Name[/]:");

    var layout = new Layout("Root")
        .SplitColumns(
            new Layout("Menu").Ratio(1),
            new Layout("Preview").Ratio(2));

    await RunSelectionStep<LineageType>(layout, "Select Lineage",
        (highlighted) => UpdatePreview(layout, context, lineage: highlighted),
        (confirmed) => context.Lineage = confirmed);

    await RunSelectionStep<ArchetypeType>(layout, "Select Archetype",
        (highlighted) => UpdatePreview(layout, context, archetype: highlighted),
        (confirmed) => context.Archetype = confirmed);

    return _factory.Create(context.Name, context.Lineage!.Value, context.Archetype!.Value);
}

private void UpdatePreview(Layout layout, WizardContext ctx, LineageType? lineage = null, ArchetypeType? archetype = null)
{
    var stats = _wizardService.GetPreviewStats(ctx, archetype, lineage);

    var grid = new Grid().AddColumn().AddColumn();
    foreach(var kvp in stats)
    {
        grid.AddRow(
            kvp.Key.ToString(),
            new BarChart().AddItem("Val", kvp.Value, Color.Green).WithMaxValue(10)
        );
    }

    layout["Preview"].Update(new Panel(grid).Header("Live Stats"));
}
```

### 4. Logging Requirements

| Event | Level | Message Template | Properties |
|-------|-------|------------------|------------|
| Wizard Start | Info | "Starting creation wizard." | - |
| Step Complete | Debug | "Wizard Step {Step} confirmed: {Selection}." | Step, Selection |
| Back Track | Debug | "User navigated back from Step {Step}." | Step |
| Preview Update | Trace | "Preview updated. Hovering: {Option}" | Option |

### 5. Testing Requirements

**Unit Tests (WizardServiceTests.cs)**

- **Preview_Accumulation:**
  - Context has Human (+1 all). Previewing Warrior (+2 Sturdy).
  - Assert Sturdiness = 5 (base) + 1 (Human) + 2 (Warrior) = 8.
- **Clamping:**
  - Ensure preview stats do not visually exceed UI bounds (1-10) in logic, or handle overflow gracefully.

**UI Tests (Manual/Interactive)**

- **Live_Update:**
  - Highlight "Warrior" → Verify MIGHT bar increases.
  - Highlight "Mystic" → Verify WILL bar increases.
- **Persistence:**
  - Select "Human". Move to Archetype.
  - Verify stats still show Human +1 bonus.
- **Navigation:**
  - Press Backspace at Archetype.
  - Verify return to Lineage selection.

### 6. Deliverable Checklist (Phase B)

- **Core:**
  - [ ] Define `WizardContext` class.
- **Engine:**
  - [ ] Implement `IWizardService` for stat preview calculations.
- **Terminal:**
  - [ ] Implement `CreationWizard` class.
  - [ ] Implement generic `RunSelectionStep<T>` method with custom input loop.
  - [ ] Implement `StatPreviewRenderer` using Spectre BarChart.
- **Integration:**
  - [ ] Hook New Game in Main Menu to `CreationWizard.RunAsync()`.

---

## Phase C: The Prologue (Narrative)

**Goal:** Implement the `NarrativeService` and `TypewriterRenderer` to deliver immersive, skippable introductory text sequences, transitioning seamlessly into the Exploration Phase.

### 1. Architecture & Data Flow

**Workflow: The Prologue Sequence**

1. **Trigger:** `CharacterCreationController` returns a valid `Character` object.
2. **Selection:** `GameService` passes the character to `NarrativeService`.
3. **Template Retrieval:**
   - Service looks up the `IntroTemplate` matching `Character.Background`.
   - Service formats the text (injecting `{Name}`, `{Archetype}`).
4. **Rendering Loop:**
   - `TypewriterRenderer` prints text character-by-character.
   - Input Check: Checks for Esc or Space every tick.
   - If Input: Jumps to end of text immediately.
5. **Handoff:** `GameService` sets `GameState.Phase = Exploration` and executes the first Look command.

### 2. Logic Decision Trees

#### A. Narrative Selection Logic

**Input:** Character Entity

1. **Identify Background:** Switch on `Character.Background`.
   - Scavenger: Load "The Rust-Born" template.
   - Exile: Load "The Cast-Out" template.
   - Scholar: Load "The Truth-Seeker" template.
   - (Default): Load "The Survivor" template.
2. **Formatting:** Replace tokens.
   - `{Name}` → "Kaelen"
   - `{Class}` → "Jötun-Reader"
3. **Output:** Return formatted string list.

#### B. Typewriter Render Logic

**Input:** Text String, Speed (ms)

1. **Loop:** For each char in Text:
   - Render: Write char to buffer.
   - Delay: `Task.Delay(Speed)`. Punctuation (., ?, !) triggers double delay.
   - Interrupt: Is `KeyAvailable`?
     - Yes: Consume Key. Write remaining string immediately. Break Loop.
2. **Finalize:** Print newline. Wait for "Press Key to Begin".

### 3. Code Implementation

**File:** `RuneAndRust.Core/Interfaces/INarrativeService.cs`

```csharp
public interface INarrativeService
{
    string GetPrologueText(Character character);
}
```

**File:** `RuneAndRust.Core/Interfaces/ITypewriterRenderer.cs`

```csharp
public interface ITypewriterRenderer
{
    Task PlaySequenceAsync(string text, int delayMs = 30);
}
```

**File:** `RuneAndRust.Engine/Services/NarrativeService.cs`

```csharp
public class NarrativeService : INarrativeService
{
    public string GetPrologueText(Character character)
    {
        return character.Background switch
        {
            BackgroundType.Scavenger =>
                $"The rust has always been your horizon, {character.Name}. You were born in the shadow of the Great Looms, scavenging the bones of dead gods. But the scrap is thinning, and the whispers in the dark grow louder. You seek the {character.Archetype} path not for glory, but to survive the silence.",

            BackgroundType.Scholar =>
                $"You have read the forbidden slates, {character.Name}. You know the world is not a tragedy, but a broken machine. While others pray to the Iron Hearts, you seek the logic that broke them. As a {character.Archetype}, you carry the burden of understanding.",

            _ => $"You awake to the smell of ozone and old dust. The world is broken, {character.Name}, and it will not fix itself."
        };
    }
}
```

**File:** `RuneAndRust.Terminal/Rendering/TypewriterRenderer.cs`

```csharp
public class TypewriterRenderer : ITypewriterRenderer
{
    public async Task PlaySequenceAsync(string text, int delayMs = 30)
    {
        AnsiConsole.Write(new Rule("[olive]PROLOGUE[/]").LeftJustified());
        Console.WriteLine();

        foreach (char c in text)
        {
            if (Console.KeyAvailable)
            {
                Console.ReadKey(true);
                var remaining = text.Substring(text.IndexOf(c));
                AnsiConsole.Markup($"[grey]{remaining}[/]");
                break;
            }

            AnsiConsole.Markup($"[grey]{c}[/]");

            var currentDelay = c is '.' or '!' or '?' ? delayMs * 10 : delayMs;
            await Task.Delay(currentDelay);
        }

        Console.WriteLine();
        Console.WriteLine();
        AnsiConsole.MarkupLine("[blink]Press any key to enter the ruins...[/]");
        Console.ReadKey(true);
        AnsiConsole.Clear();
    }
}
```

### 4. Logging Requirements

| Event | Level | Message Template | Properties |
|-------|-------|------------------|------------|
| Prologue Start | Info | "[Narrative] Starting prologue for background {Background}." | Background |
| Prologue Skip | Debug | "[Narrative] User skipped prologue sequence." | - |
| Prologue End | Info | "[Narrative] Prologue complete. Transitioning to Exploration." | - |

### 5. Testing Requirements

**Unit Tests (NarrativeServiceTests.cs)**

- **Template_Selection:**
  - Given `Background.Scavenger`.
  - Assert output contains "shadow of the Great Looms".
- **Token_Replacement:**
  - Given Name "Thorolf", Archetype "Warrior".
  - Assert output contains "Thorolf" and "Warrior".

**Manual QA (Interactive)**

- **Skip_Function:**
  - Start Prologue. Press Space immediately.
  - Verify text completes instantly without crashing.
- **Pacing:**
  - Verify text pauses appropriately at periods/commas.
- **Transition:**
  - Verify pressing key at end clears screen and loads the first Room description.

### 6. Deliverable Checklist (Phase C)

- **Core:**
  - [ ] Define `INarrativeService` and `ITypewriterRenderer`.
  - [ ] Add `BackgroundType` enum to Character if missing.
- **Engine:**
  - [ ] Implement `NarrativeService` with templates for all 6 backgrounds.
  - [ ] Ensure flavor text adheres to Domain 4 (Technology) constraints.
- **Terminal:**
  - [ ] Implement `TypewriterRenderer` with AnsiConsole.
  - [ ] Update `Program.cs` or `GameService` to call `PlaySequenceAsync` after creation wizard.
- **Assets:**
  - [ ] Write 6 unique intro paragraphs (Scavenger, Noble, Exile, Scholar, Soldier, Cultist).

---

## Testing Strategy

### Unit Tests

- **TitleScreenTests.cs:** Menu rendering and glitch text generation
- **WizardServiceTests.cs:** Preview calculation and stat accumulation
- **NarrativeServiceTests.cs:** Template selection and token replacement

### Integration Tests

- **FullFlow_CreationToGame:** Menu Start → Wizard Complete → Prologue → Game Loop Active

---

## Changelog (v0.3.4)

**Release Date:** 2025-XX-XX

### Summary

The "Gateway" update replaces the basic CLI prompts with a rich, immersive Terminal UI. Players now begin their journey with an animated title screen, a responsive character creation wizard with live stat previews, and atmospheric narrative introductions.

### Features

- **Visual Title Screen:**
  - Animated ASCII art logo with dynamic "glitch" effects representing the Runic Blight.
- **Interactive Character Creator:**
  - **Split-Screen UI:** View descriptions and stat impacts *before* confirming choices.
  - **Live Preview:** See exactly how "Iron-Blooded" + "Warrior" affects your starting HP and MIGHT.
  - **Navigable:** Use Arrow Keys to browse, Backspace to return to previous steps.
- **Narrative Intros:**
  - Unique typewriter-style prologues for each Background, setting the tone for the Age of Echoes.
- **Narrative Engine:**
  - Implemented `TypewriterRenderer` for atmospheric text delivery.
  - Added skippable sequences for replayability.

### Technical

- Implemented `Spectre.Console.Live` for real-time UI updates during creation.
- Added `NarrativeService` for handling flavor text injection.
- Refactored `GameService` startup sequence to support async narrative flows.
