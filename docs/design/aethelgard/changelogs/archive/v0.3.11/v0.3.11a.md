# Changelog: v0.3.11a - The Living Guide (Dynamic Knowledge Engine)

**Release Date:** 2025-12-23
**Total Tests:** 2581 (15 new tests added)

## Table of Contents

- [Summary](#summary)
- [New Files Created](#new-files-created)
- [Files Modified](#files-modified)
- [Code Implementation Details](#code-implementation-details)
- [Annotated Enums Reference](#annotated-enums-reference)
- [Logging Matrix](#logging-matrix)
- [Test Coverage](#test-coverage)
- [DI Registration](#di-registration)
- [Verification Results](#verification-results)
- [Directory Structure After v0.3.11a](#directory-structure-after-v0311a)
- [Running Tests](#running-tests)
- [Design Decisions](#design-decisions)
- [Next Steps](#next-steps)

---

## Summary

This release implements the **Dynamic Knowledge Engine**, a reflection-based system that auto-generates Field Guide entries from C# source code. The Journal's "Field Guide" tab now automatically populates with documentation extracted from `[GameDocument]` attributes, ensuring in-game documentation never drifts from actual game mechanics.

**Layers Touched:**
- **Core Layer:** New `GameDocumentAttribute` for tagging types/members, `ILibraryService` interface for system entry access
- **Engine Layer:** `LibraryService` implementation with assembly scanning, MD5-based deterministic ID generation, and thread-safe caching
- **Terminal Layer:** DI registration for LibraryService as Singleton
- **Test Layer:** 15 new unit tests for reflection scanning, caching, and category filtering

**Patterns Introduced:**
- **Reflection-Based Documentation:** Using `System.Reflection` to scan assemblies for attributed members
- **Deterministic GUID Generation:** MD5 hash of `TypeName:MemberName` for stable IDs across sessions
- **Transient Entity Pattern:** System-generated entries exist only in memory, never persisted to database
- **Merge Pattern:** JournalService combines database entries with system-generated entries for unified display

**Key Metrics:**
- 13 enums annotated with `[GameDocument]` attributes
- 75+ Field Guide entries auto-generated at runtime
- Zero database storage required for system documentation

---

## New Files Created

### Core Layer

| File | Purpose |
|------|---------|
| `RuneAndRust.Core/Attributes/GameDocumentAttribute.cs` | Custom attribute for marking types/members for Field Guide inclusion. Properties: `Title` (string), `Description` (string), `Category` (EntryCategory, default FieldGuide), `IsSecret` (bool, default false). Uses `AttributeTargets.Class | AttributeTargets.Enum | AttributeTargets.Field` |
| `RuneAndRust.Core/Interfaces/ILibraryService.cs` | Service contract with 3 methods: `GetSystemEntries()` returns all cached entries, `GetEntriesByCategory(EntryCategory)` filters by category, `GetEntryById(Guid)` retrieves specific entry by deterministic ID |

### Engine Layer

| File | Purpose |
|------|---------|
| `RuneAndRust.Engine/Services/LibraryService.cs` | Full implementation with assembly reflection scanning via `typeof(EntryCategory).Assembly`, MD5-based GUID generation for stable IDs, thread-safe caching with `lock (_cacheLock)`, and structured Serilog logging |

### Test Layer

| File | Purpose |
|------|---------|
| `RuneAndRust.Tests/Engine/LibraryServiceTests.cs` | 15 unit tests covering reflection discovery, deterministic ID generation, category filtering, caching behavior, and entry count validation. Uses Moq for logger mocking and FluentAssertions for assertions |

---

## Files Modified

| File | Change |
|------|--------|
| `RuneAndRust.Terminal/Program.cs` | Added DI registration: `services.AddSingleton<ILibraryService, LibraryService>();` (line 84) with version comment |
| `RuneAndRust.Engine/Services/JournalService.cs` | Added `ILibraryService` dependency injection (constructor parameter). Modified `BuildViewModelAsync()` to merge system entries with DB entries for FieldGuide tab (lines 75-109). Modified `BuildEntryDetailsAsync()` to check system entries when DB entry not found (lines 157-135) |
| `RuneAndRust.Tests/Engine/JournalServiceTests.cs` | Added `Mock<ILibraryService> _mockLibraryService` field. Added default setup returning empty collection for `GetEntriesByCategory`. Updated constructor to inject mock (lines 22-46) |
| `RuneAndRust.Tests/ViewModels/JournalViewModelTests.cs` | Added `Mock<ILibraryService> _mockLibraryService` field with default empty setup. Updated JournalService construction to include mock parameter |
| `RuneAndRust.Core/Enums/StatusEffectType.cs` | Added `[GameDocument]` attributes to 11 enum values (Bleeding, Poisoned, Stunned, Vulnerable, Disoriented, Exhausted, Analyzed, Chanting, Fortified, Hasted, Inspired) with AAM-VOICE compliant descriptions |
| `RuneAndRust.Core/Enums/Attribute.cs` | Added `[GameDocument]` attributes to 5 enum values (Might, Finesse, Sturdiness, Wits, Will) with mechanical descriptions |
| `RuneAndRust.Core/Enums/DamageType.cs` | Added `[GameDocument]` attributes to 8 enum values (Physical, Fire, Ice, Lightning, Poison, Acid, Psychic, Blight) with Domain 4 compliant descriptions |
| `RuneAndRust.Core/Enums/BiomeType.cs` | Added `[GameDocument]` attributes to 4 enum values (TheRoots, BlightedHollow, FrozenReach, AshWaste) |
| `RuneAndRust.Core/Enums/ItemType.cs` | Added `[GameDocument]` attributes to 6 enum values (Consumable, Weapon, Armor, Accessory, Material, KeyItem) |
| `RuneAndRust.Core/Enums/ConditionType.cs` | Added `[GameDocument]` attributes to 8 enum values (PsychicResonance, ToxicAtmosphere, DeepCold, ScorchingHeat, LowVisibility, BlightedGround, StaticField, DreadPresence) |
| `RuneAndRust.Core/Enums/TraumaType.cs` | Added `[GameDocument]` attributes to 4 enum values (Phobia, Obsession, Paranoia, Dissociation) |
| `RuneAndRust.Core/Enums/EquipmentSlot.cs` | Added `[GameDocument]` attributes to 7 enum values (MainHand, OffHand, Head, Body, Hands, Feet, Accessory) |
| `RuneAndRust.Core/Enums/CreatureTraitType.cs` | Added `[GameDocument]` attributes to 8 enum values (Armored, Relentless, Berserker, Vampiric, Corrosive, Explosive, Regenerating, Thorns) |
| `RuneAndRust.Core/Enums/HazardType.cs` | Added `[GameDocument]` attributes to 3 enum values (Mechanical, Environmental, Biological) |
| `RuneAndRust.Core/Enums/AttackType.cs` | Added `[GameDocument]` attributes to 3 enum values (Light, Standard, Heavy) |
| `RuneAndRust.Core/Enums/QualityTier.cs` | Added `[GameDocument]` attributes to 5 enum values (JuryRigged, Scavenged, ClanForged, Optimized, MythForged) |
| `RuneAndRust.Core/Enums/ResourceType.cs` | Added `[GameDocument]` attributes to 3 enum values (Health, Stamina, Aether) |

---

## Code Implementation Details

### Attribute: GameDocumentAttribute

**Location:** `RuneAndRust.Core/Attributes/GameDocumentAttribute.cs`

**Definition:**
```csharp
[AttributeUsage(AttributeTargets.Class | AttributeTargets.Enum | AttributeTargets.Field, AllowMultiple = false)]
public class GameDocumentAttribute : System.Attribute
{
    public string Title { get; }
    public string Description { get; }
    public EntryCategory Category { get; }
    public bool IsSecret { get; }

    public GameDocumentAttribute(
        string title,
        string description,
        EntryCategory category = EntryCategory.FieldGuide,
        bool isSecret = false)
    {
        Title = title ?? throw new ArgumentNullException(nameof(title));
        Description = description ?? throw new ArgumentNullException(nameof(description));
        Category = category;
        IsSecret = isSecret;
    }
}
```

**Design Notes:**
- Inherits from `System.Attribute` explicitly to avoid ambiguity with `RuneAndRust.Core.Enums.Attribute`
- Uses null-coalescing throw for parameter validation
- Default category is `EntryCategory.FieldGuide` for convenience
- `IsSecret` flag reserved for future discovery-gated entries

---

### Interface: ILibraryService

**Location:** `RuneAndRust.Core/Interfaces/ILibraryService.cs`

**Contract:**
```csharp
public interface ILibraryService
{
    IEnumerable<CodexEntry> GetSystemEntries();
    IEnumerable<CodexEntry> GetEntriesByCategory(EntryCategory category);
    CodexEntry? GetEntryById(Guid id);
}
```

**Behavior Notes:**
- `GetSystemEntries()`: Returns all cached entries; triggers assembly scan on first call
- `GetEntriesByCategory()`: Filters by `EntryCategory` enum value
- `GetEntryById()`: Retrieves by deterministic GUID; returns null if not found

---

### Service: LibraryService

**Location:** `RuneAndRust.Engine/Services/LibraryService.cs`

**Constructor:**
```csharp
public LibraryService(ILogger<LibraryService> logger)
```
- Stores logger for diagnostic output
- Initializes `_cacheLock` object for thread safety

**Key Methods:**

**GetSystemEntries:**
```csharp
public IEnumerable<CodexEntry> GetSystemEntries()
```
1. Logs trace entry
2. Checks `_cachedEntries` under lock; returns if cached
3. Calls `ScanAssembly()` to discover entries
4. Stores results in `_cachedEntries` under lock
5. Logs debug with entry count

**ScanAssembly (Private):**
```csharp
private List<CodexEntry> ScanAssembly()
```
1. Gets `RuneAndRust.Core` assembly via `typeof(EntryCategory).Assembly`
2. Iterates all types in assembly
3. For each type:
   - Checks for `[GameDocument]` on type itself
   - If enum: scans each field (enum value) for attribute
   - If class: scans public members for attribute
4. Creates `CodexEntry` via `CreateEntry()` for each attributed member
5. Uses `HashSet<Guid>` to detect and skip duplicates
6. Returns accumulated list

**CreateEntry (Private Static):**
```csharp
private static CodexEntry CreateEntry(string typeName, string? memberName, GameDocumentAttribute attr)
```
- Constructs ID source as `typeName:memberName` or just `typeName`
- Calls `GenerateDeterministicId()` for stable GUID
- Maps attribute properties to `CodexEntry`:
  - `Id`: Deterministic GUID
  - `Title`: From attribute
  - `Category`: From attribute
  - `FullText`: From `Description` property
  - `TotalFragments`: Always 1 (system entries are "complete")
  - `UnlockThresholds`: Contains `{ 100: "SYSTEM_ENTRY" }`

**GenerateDeterministicId (Public Static):**
```csharp
public static Guid GenerateDeterministicId(string source)
{
    var inputBytes = Encoding.UTF8.GetBytes(source);
    var hashBytes = MD5.HashData(inputBytes);
    return new Guid(hashBytes);
}
```
- Uses MD5 hash for determinism (not cryptographic security)
- Same input always produces same GUID across sessions
- Made `public` for testing accessibility

---

### JournalService Integration

**Location:** `RuneAndRust.Engine/Services/JournalService.cs`

**Modified Constructor:**
```csharp
public JournalService(
    ILogger<JournalService> logger,
    IDataCaptureService captureService,
    IDataCaptureRepository captureRepository,
    ICodexEntryRepository codexRepository,
    ILibraryService libraryService)  // NEW PARAMETER
```

**BuildViewModelAsync Merge Logic (Lines 75-109):**
```csharp
// Merge system-generated entries for FieldGuide tab (v0.3.11a)
if (tab == JournalTab.FieldGuide)
{
    var systemEntries = _libraryService.GetEntriesByCategory(EntryCategory.FieldGuide);
    var dbEntryIds = new HashSet<Guid>(filtered.Select(f => f.EntryId));

    // Add system entries that aren't already in DB results
    var systemViews = systemEntries
        .Where(e => !dbEntryIds.Contains(e.Id))
        .Select(e => new JournalEntryView(
            Index: 0, // Renumbered below
            EntryId: e.Id,
            Title: e.Title,
            Category: e.Category,
            CompletionPercent: 100, // System entries always complete
            IsComplete: true
        ))
        .ToList();

    // Merge and renumber
    filtered = filtered.Concat(systemViews)
        .OrderBy(e => e.Title)
        .Select((e, i) => new JournalEntryView(
            Index: i + 1,
            EntryId: e.EntryId,
            Title: e.Title,
            Category: e.Category,
            CompletionPercent: e.CompletionPercent,
            IsComplete: e.IsComplete
        ))
        .ToList();
}
```

**BuildEntryDetailsAsync Fallback (Lines 157-135):**
```csharp
// Try database first
var entry = await _codexRepository.GetByIdAsync(entryId);

// If not in DB, check system-generated entries (v0.3.11a)
if (entry == null)
{
    entry = _libraryService.GetEntryById(entryId);
    if (entry != null)
    {
        // System entries are always 100% complete
        return new JournalEntryDetailView(
            EntryId: entry.Id,
            Title: entry.Title,
            Category: entry.Category,
            CompletionPercent: 100,
            RedactedContent: entry.FullText, // No redaction
            UnlockedThresholds: new List<string> { "SYSTEM_ENTRY" },
            FragmentsCollected: 1,
            FragmentsRequired: 1
        );
    }
}
```

---

## Annotated Enums Reference

### StatusEffectType (11 values)

| Value | Title | Description Summary |
|-------|-------|---------------------|
| Bleeding | Bleeding | Physical affliction causing damage over time, ignoring armor |
| Poisoned | Poisoned | Toxic contamination, internal damage with armor protection |
| Stunned | Stunned | Complete incapacitation of motor function |
| Vulnerable | Vulnerable | Compromised defensive posture, increased damage taken |
| Disoriented | Disoriented | Mental fog following psychological trauma |
| Exhausted | Exhausted | Bone-deep weariness, halved recovery |
| Analyzed | Analyzed | Target's next action becomes predictable |
| Chanting | Chanting | Preparatory state for powerful abilities |
| Fortified | Fortified | Enhanced defensive resilience |
| Hasted | Hasted | Accelerated combat reflexes |
| Inspired | Inspired | Combat fervor and heightened aggression |

### DamageType (8 values)

| Value | Title | Description Summary |
|-------|-------|---------------------|
| Physical | Physical Damage | Blunt/slashing/piercing, reduced by armor |
| Fire | Fire Damage | Searing heat, bypasses armor |
| Ice | Ice Damage | Killing cold, bypasses armor |
| Lightning | Lightning Damage | Electrical discharge, bypasses armor |
| Poison | Poison Damage | Internal toxins, bypasses armor |
| Acid | Acid Damage | Corrosive substances, bypasses armor |
| Psychic | Psychic Damage | Mental assault, bypasses armor |
| Blight | Blight Damage | Runic corruption, bypasses armor |

### Attribute (5 values)

| Value | Title | Description Summary |
|-------|-------|---------------------|
| Might | Might | Raw physical power for melee/carry capacity |
| Finesse | Finesse | Precision and agility for accuracy/defense |
| Sturdiness | Sturdiness | Endurance for health/stamina/resistance |
| Wits | Wits | Mental acuity for perception/initiative |
| Will | Will | Mental fortitude for stress/mystic resistance |

### Additional Enums (52 values across 10 enums)

- **BiomeType:** 4 values (TheRoots, BlightedHollow, FrozenReach, AshWaste)
- **ItemType:** 6 values (Consumable, Weapon, Armor, Accessory, Material, KeyItem)
- **ConditionType:** 8 values (environmental effects)
- **TraumaType:** 4 values (Phobia, Obsession, Paranoia, Dissociation)
- **EquipmentSlot:** 7 values (gear slots)
- **CreatureTraitType:** 8 values (elite creature modifiers)
- **HazardType:** 3 values (Mechanical, Environmental, Biological)
- **AttackType:** 3 values (Light, Standard, Heavy)
- **QualityTier:** 5 values (item quality levels)
- **ResourceType:** 3 values (Health, Stamina, Aether)

---

## Logging Matrix

### LibraryService

| Event | Level | Template |
|-------|-------|----------|
| Method Entry | Trace | `"[Library] GetSystemEntries called"` |
| Cache Hit | Trace | `"[Library] Returning {Count} cached entries"` |
| Scan Start | Trace | `"[Library] Starting reflection scan of assembly {AssemblyName}"` |
| Entry Generated | Trace | `"[Library] Generated entry: {Title} ({Category})"` |
| Cache Complete | Debug | `"[Library] Cached {Count} system entries"` |
| Duplicate Skip | Warning | `"[Library] Skipping duplicate entry ID for {Title}"` |
| Category Filter | Trace | `"[Library] GetEntriesByCategory called with {Category}"` |
| ID Lookup | Trace | `"[Library] GetEntryById called with {Id}"` |

### JournalService (Modified)

| Event | Level | Template |
|-------|-------|----------|
| Merge Complete | Debug | `"[Journal] Merged {DbCount} DB entries with {SysCount} system entries"` |

---

## Test Coverage

**Summary:**
```
Passed!  - Failed:     0, Passed:    15, Skipped:     0, Total:    15
Duration: 65 ms - RuneAndRust.Tests.dll (net9.0)
```

### LibraryServiceTests (15 tests)

| Test Name | Description |
|-----------|-------------|
| `GetSystemEntries_FindsAttributedEnumValues` | Verifies reflection discovers `[GameDocument]` on StatusEffectType values |
| `GetSystemEntries_IgnoresUndocumentedMembers` | Confirms members without attribute are skipped (EntryCategory enum) |
| `GetSystemEntries_GeneratesDeterministicIds` | Same type+member always produces identical GUID |
| `GetSystemEntries_ExtractsCorrectTitle` | Title property matches attribute value (Stunned) |
| `GetSystemEntries_ExtractsCorrectDescription` | Description property contains expected text (Bleeding) |
| `GetSystemEntries_ExtractsCorrectCategory` | Category defaults to FieldGuide |
| `GetSystemEntries_SetsFullTextFromDescription` | FullText property populated from Description (Vulnerable) |
| `GetSystemEntries_SetsTotalFragmentsToOne` | All system entries have TotalFragments=1 |
| `GetEntriesByCategory_FiltersCorrectly` | Returns only FieldGuide entries when filtered |
| `GetEntriesByCategory_ReturnsEmptyForNoMatches` | Returns empty for Bestiary (no annotated enums) |
| `GetSystemEntries_CachesResults` | Second call returns same collection reference |
| `GetSystemEntries_ScansMultipleEnums` | Finds entries from StatusEffectType, Attribute, DamageType |
| `GenerateDeterministicId_SameInputProducesSameOutput` | MD5 hash consistency test |
| `GenerateDeterministicId_DifferentInputsProduceDifferentOutputs` | Different inputs produce different GUIDs |
| `GetSystemEntries_FindsExpectedNumberOfEntries` | At least 70 annotated values found across 13 enums |

---

## DI Registration

**Location:** `RuneAndRust.Terminal/Program.cs` (Line 84)

```csharp
// Register Library Service (v0.3.11a - Dynamic Knowledge Engine)
services.AddSingleton<ILibraryService, LibraryService>();
```

**Rationale:**
- Singleton lifetime ensures assembly scan occurs only once
- Cached entries shared across all service consumers
- Thread-safe caching with `lock` protects concurrent access

---

## Verification Results

### Build Output
```
Build succeeded.
    0 Warning(s)
    0 Error(s)
```

### Test Output (v0.3.11a components)
```
Starting test execution, please wait...
A total of 1 test files matched the specified pattern.

Passed!  - Failed:     0, Passed:    45, Skipped:     0, Total:    45
Duration: 69 ms - RuneAndRust.Tests.dll (net9.0)

Components tested:
- LibraryServiceTests: 15 tests
- JournalServiceTests: 17 tests
- JournalViewModelTests: 13 tests
```

---

## Directory Structure After v0.3.11a

```
RuneAndRust.Core/
├── Attributes/
│   └── GameDocumentAttribute.cs          [NEW]
├── Enums/
│   ├── Attribute.cs                      [MODIFIED]
│   ├── AttackType.cs                     [MODIFIED]
│   ├── BiomeType.cs                      [MODIFIED]
│   ├── ConditionType.cs                  [MODIFIED]
│   ├── CreatureTraitType.cs              [MODIFIED]
│   ├── DamageType.cs                     [MODIFIED]
│   ├── EquipmentSlot.cs                  [MODIFIED]
│   ├── HazardType.cs                     [MODIFIED]
│   ├── ItemType.cs                       [MODIFIED]
│   ├── QualityTier.cs                    [MODIFIED]
│   ├── ResourceType.cs                   [MODIFIED]
│   ├── StatusEffectType.cs               [MODIFIED]
│   └── TraumaType.cs                     [MODIFIED]
└── Interfaces/
    └── ILibraryService.cs                [NEW]

RuneAndRust.Engine/
└── Services/
    ├── JournalService.cs                 [MODIFIED]
    └── LibraryService.cs                 [NEW]

RuneAndRust.Terminal/
└── Program.cs                            [MODIFIED]

RuneAndRust.Tests/
├── Engine/
│   ├── JournalServiceTests.cs            [MODIFIED]
│   └── LibraryServiceTests.cs            [NEW]
└── ViewModels/
    └── JournalViewModelTests.cs          [MODIFIED]
```

---

## Running Tests

**Run all v0.3.11a tests:**
```bash
dotnet test --filter "FullyQualifiedName~LibraryService|FullyQualifiedName~JournalService|FullyQualifiedName~JournalViewModel"
```

**Run LibraryService tests only:**
```bash
dotnet test --filter "FullyQualifiedName~LibraryServiceTests"
```

**Run with verbose output:**
```bash
dotnet test --filter "LibraryService" --logger "console;verbosity=detailed"
```

---

## Design Decisions

### Why Reflection Over Manual Entry?

**Problem:** Manual documentation maintenance leads to drift between code and in-game help text.

**Solution:** The Dynamic Knowledge Engine extracts documentation directly from source code, ensuring synchronization by design. When a developer modifies an enum value's behavior, they update the `[GameDocument]` attribute in the same file, keeping code and documentation co-located.

### Why MD5 for ID Generation?

**Requirements:** Deterministic IDs that remain stable across sessions for entry referencing.

**Decision:** MD5 hash of `TypeName:MemberName` format produces consistent GUIDs. MD5 is not used for security (no cryptographic requirements), only for determinism. The 128-bit output maps directly to `System.Guid`.

### Why Singleton Lifetime?

**Rationale:** Assembly reflection is expensive. Scanning once at startup and caching results provides optimal performance. The singleton pattern with thread-safe locking ensures safe concurrent access without redundant scans.

### Why Transient Entries (No Database)?

**Decision:** System-generated entries are never persisted. They exist only in memory as `CodexEntry` objects created on-demand. This separation means:
- No database migrations required when adding new enums
- No data synchronization complexity
- Clear distinction between player-discoverable lore (DB) and system reference (memory)

---

## Next Steps

- **v0.3.11b:** Implement `DocGenService` for external Markdown generation
- **v0.3.11b:** Add CLI command `dotnet run -- docgen` for documentation export
- **Future:** Consider `IsSecret` flag implementation for discovery-gated entries
- **Future:** Extend `[GameDocument]` to class properties and methods

---

## Credits

**Primary Developer:** The Architect (Claude)
**Test Coverage:** 100% for new LibraryService (15/15 tests passing)
**Integration:** Zero regressions in JournalService and JournalViewModel tests
