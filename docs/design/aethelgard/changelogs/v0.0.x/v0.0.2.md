# Changelog: v0.0.2 - The Domain & Logic

**Release Date:** 2025-12-18

## Table of Contents

- [Summary](#summary)
- [New Files Created](#new-files-created)
- [Files Modified](#files-modified)
- [Code Implementation Details](#code-implementation-details)
- [Logging Matrix](#logging-matrix)
- [Test Coverage](#test-coverage)
- [DI Registration](#di-registration)
- [Verification Results](#verification-results)
- [Directory Structure After v0.0.2](#directory-structure-after-v002)
- [Running Tests](#running-tests)
- [Next Steps](#next-steps)

---

## Summary

Implemented the core Domain layer entities and Engine services for Rune & Rust. This release establishes the five core character attributes, dice rolling mechanics, and stat calculation services with comprehensive logging for traceability and extensive unit test coverage.

---

## New Files Created

### Core Layer

| File | Purpose |
|------|---------|
| `RuneAndRust.Core/Enums/Attribute.cs` | Defines the five core character attributes |
| `RuneAndRust.Core/Models/Character.cs` | Character entity with attribute dictionary |
| `RuneAndRust.Core/Interfaces/IDiceService.cs` | Contract for dice rolling with DiceResult record |
| `RuneAndRust.Core/Interfaces/IStatCalculationService.cs` | Contract for stat calculations |

### Engine Layer

| File | Purpose |
|------|---------|
| `RuneAndRust.Engine/Services/DiceService.cs` | d10 dice pool implementation with detailed logging |
| `RuneAndRust.Engine/Services/StatCalculationService.cs` | Modifier and clamping operations with logging |

### Test Layer

| File | Test Count | Purpose |
|------|------------|---------|
| `RuneAndRust.Tests/Core/AttributeTests.cs` | 12 | Validates Attribute enum structure |
| `RuneAndRust.Tests/Core/CharacterTests.cs` | 10 | Validates Character entity behavior |
| `RuneAndRust.Tests/Engine/DiceServiceTests.cs` | 28 | Comprehensive dice service tests |
| `RuneAndRust.Tests/Engine/StatCalculationServiceTests.cs` | 34 | Comprehensive stat calculation tests |

---

## Files Modified

| File | Change |
|------|--------|
| `RuneAndRust.Terminal/Program.cs` | Added DI registration for `IDiceService` and `IStatCalculationService` |

---

## Code Implementation Details

### Attribute Enum

Defines the five core attributes for Rune & Rust characters:

```csharp
public enum Attribute
{
    Sturdiness = 0,  // Physical resilience, health, and endurance
    Might = 1,       // Raw physical power and strength
    Wits = 2,        // Mental acuity, perception, and intelligence
    Will = 3,        // Mental fortitude and determination
    Finesse = 4      // Agility, dexterity, and precision
}
```

### Character Entity

Basic character model with:
- `Guid Id` - Unique identifier (generated on construction)
- `string Name` - Character name
- `Dictionary<Attribute, int> Attributes` - All five attributes initialized to default value of 5
- `GetAttribute(Attribute)` - Retrieve specific attribute value
- `SetAttribute(Attribute, int)` - Update specific attribute value

### DiceService

Implements a d10 dice pool system:
- **Success threshold:** 8+ on d10
- **Botch:** Roll of 1
- **Fumble:** Zero successes with at least one botch
- Uses `Random.Shared` for thread-safe random generation
- Invalid pool sizes (0 or negative) are clamped to minimum of 1

### StatCalculationService

Provides basic stat operations:
- `ApplyModifier(baseValue, modifier)` - Returns `baseValue + modifier`
- `ClampAttribute(value, min, max)` - Clamps value to range [min, max], defaults to [1, 10]

---

## Logging Matrix

### DiceService Log Events

| Event | Level | Template |
|-------|-------|----------|
| Method entry | Trace | `"Rolling {PoolSize}d10 for {Context}"` |
| Individual roll | Trace | `"Die {DieNumber}: rolled {Value}"` |
| Success counted | Trace | `"Die {DieNumber}: {Value} is a SUCCESS (8+)"` |
| Botch counted | Trace | `"Die {DieNumber}: {Value} is a BOTCH (1)"` |
| Roll result summary | Debug | `"Roll complete: {Successes} successes, {Botches} botches from {PoolSize}d10 [{Rolls}] ({Context})"` |
| Fumble detected | Warning | `"FUMBLE! Zero successes with {Botches} botch(es) on {PoolSize}d10 ({Context})"` |
| Invalid pool size (0) | Warning | `"Invalid dice pool {RequestedSize} for {Context}. Clamping to minimum of 1."` |
| Negative pool size | Error | `"Negative dice pool {RequestedSize} requested for {Context}. This indicates a logic error."` |

### StatCalculationService Log Events

| Event | Level | Template |
|-------|-------|----------|
| ApplyModifier entry | Trace | `"Applying modifier {Modifier} to base value {BaseValue}"` |
| ApplyModifier result | Debug | `"Modifier applied: {BaseValue} + {Modifier} = {Result}"` |
| ClampAttribute entry | Trace | `"Clamping value {Value} to range [{Min}, {Max}]"` |
| Value below minimum | Warning | `"Value {Value} below minimum {Min}, clamped to {Min}"` |
| Value above maximum | Warning | `"Value {Value} above maximum {Max}, clamped to {Max}"` |
| Value unchanged | Trace | `"Value {Value} within range [{Min}, {Max}], no clamping needed"` |

---

## Test Coverage

### Test Summary

```
Total tests: 86
Passed: 86
Failed: 0
Duration: 76 ms
```

### Complete Test Inventory

#### AttributeTests (12 tests)

| Test Name | Description |
|-----------|-------------|
| `Attribute_ShouldHaveExactlyFiveValues` | Validates enum has exactly 5 values |
| `Attribute_ShouldContain_Sturdiness` | Verifies Sturdiness attribute exists |
| `Attribute_ShouldContain_Might` | Verifies Might attribute exists |
| `Attribute_ShouldContain_Wits` | Verifies Wits attribute exists |
| `Attribute_ShouldContain_Will` | Verifies Will attribute exists |
| `Attribute_ShouldContain_Finesse` | Verifies Finesse attribute exists |
| `Attribute_EnumValues_ShouldBeSequential` | Validates enum values 0-4 |
| `Attribute_ToString_ReturnsExpectedName(Sturdiness)` | ToString returns "Sturdiness" |
| `Attribute_ToString_ReturnsExpectedName(Might)` | ToString returns "Might" |
| `Attribute_ToString_ReturnsExpectedName(Wits)` | ToString returns "Wits" |
| `Attribute_ToString_ReturnsExpectedName(Will)` | ToString returns "Will" |
| `Attribute_ToString_ReturnsExpectedName(Finesse)` | ToString returns "Finesse" |

#### CharacterTests (10 tests)

| Test Name | Description |
|-----------|-------------|
| `Character_NewCharacter_HasUniqueId` | Each character gets a unique Guid |
| `Character_Name_CanBeSet` | Name property is writable |
| `Character_Name_IsSetByConstructor` | Constructor sets Name correctly |
| `Character_Attributes_InitializedWithDefaults` | All 5 attributes start at 5 |
| `Character_GetAttribute_ReturnsCorrectValue` | GetAttribute returns set value |
| `Character_SetAttribute_UpdatesValue` | SetAttribute modifies value |
| `Character_AllAttributes_CanBeAccessed` | All attributes readable |
| `Character_AllAttributes_CanBeModified` | All attributes writable |
| `Character_Attributes_ContainsAllFiveAttributes` | Dictionary has all 5 keys |
| `Character_Id_IsImmutable` | Id doesn't change between accesses |

#### DiceServiceTests (28 tests) - NEW in v0.0.2

**Pool Size Tests:**
| Test Name | Description |
|-----------|-------------|
| `Roll_WithZeroPoolSize_ShouldLogWarningAndRollOne` | Zero clamps to 1, logs warning |
| `Roll_WithNegativePoolSize_ShouldLogErrorAndRollOne` | Negative clamps to 1, logs error |
| `Roll_WithPoolSizeOne_ReturnsExactlyOneRoll` | Pool of 1 returns 1 roll |
| `Roll_WithPoolSizeFive_ReturnsExactlyFiveRolls` | Pool of 5 returns 5 rolls |
| `Roll_WithPoolSizeTen_ReturnsExactlyTenRolls` | Pool of 10 returns 10 rolls |
| `Roll_WithLargePoolSize_HandlesCorrectly` | Pool of 100 works correctly |

**Roll Value Tests:**
| Test Name | Description |
|-----------|-------------|
| `Roll_AllValues_ShouldBeBetweenOneAndTen` | All rolls in range [1, 10] |
| `Roll_ShouldNeverReturnZero` | No roll is ever 0 |
| `Roll_ShouldNeverReturnEleven` | No roll is ever 11 |

**Success/Botch Calculation Tests:**
| Test Name | Description |
|-----------|-------------|
| `Roll_SuccessCount_ShouldMatchRollsEightOrHigher` | Successes = count of 8+ |
| `Roll_WithKnownRolls_SuccessesCalculatedCorrectly` | Verifies success logic |
| `Roll_BotchCount_ShouldMatchRollsOfOne` | Botches = count of 1s |
| `Roll_WithKnownRolls_BotchesCalculatedCorrectly` | Verifies botch logic |
| `Roll_SuccessesAndBotchesRelationship_IsIndependent` | Successes and botches independent |

**Fumble Tests:**
| Test Name | Description |
|-----------|-------------|
| `Roll_ZeroSuccessesWithBotches_LogsWarning` | Fumble condition logs warning |

**Context Tests:**
| Test Name | Description |
|-----------|-------------|
| `Roll_WithContext_IncludesContextInLogs` | Custom context in logs |
| `Roll_WithoutContext_UsesDefaultContext` | Default "Unspecified" context |

**DiceResult Record Tests:**
| Test Name | Description |
|-----------|-------------|
| `DiceResult_Rolls_ShouldNotBeDirectlyModifiable` | Rolls is IReadOnlyList |
| `DiceResult_Properties_ShouldBeInitOnly` | Record properties are init-only |
| `DiceResult_Equality_SameValues_AreEquivalent` | Equivalent records match |
| `DiceResult_Equality_SameRollsReference_AreEqual` | Same reference = equal |
| `DiceResult_Equality_DifferentSuccesses_AreNotEqual` | Different successes != equal |
| `DiceResult_Equality_DifferentBotches_AreNotEqual` | Different botches != equal |

**Logger Verification Tests:**
| Test Name | Description |
|-----------|-------------|
| `Roll_ShouldLogAtTraceLevel_ForMethodEntry` | Trace on method entry |
| `Roll_ShouldLogAtDebugLevel_ForResultSummary` | Debug for result summary |
| `Roll_ShouldLogAtWarningLevel_ForInvalidPoolSize` | Warning for invalid pool |
| `Constructor_WithValidLogger_ShouldNotThrow` | Constructor accepts logger |

**Distribution Tests:**
| Test Name | Description |
|-----------|-------------|
| `Roll_Distribution_ShouldBeReasonablyRandom` | Distribution is roughly uniform |

#### StatCalculationServiceTests (34 tests) - NEW in v0.0.2

**ApplyModifier Tests:**
| Test Name | Description |
|-----------|-------------|
| `ApplyModifier_PositiveModifier_AddsToBase` | 5 + 3 = 8 |
| `ApplyModifier_NegativeModifier_SubtractsFromBase` | 5 + (-2) = 3 |
| `ApplyModifier_ZeroModifier_ReturnsBase` | 7 + 0 = 7 |
| `ApplyModifier_LargePositiveModifier_HandlesCorrectly` | 5 + 100 = 105 |
| `ApplyModifier_LargeNegativeModifier_HandlesCorrectly` | 5 + (-100) = -95 |
| `ApplyModifier_ResultsInNegative_ReturnsNegativeValue` | 3 + (-5) = -2 |
| `ApplyModifier_ZeroBase_AppliesModifierCorrectly` | 0 + 5 = 5 |
| `ApplyModifier_NegativeBase_AppliesModifierCorrectly` | -3 + 5 = 2 |

**ClampAttribute Tests:**
| Test Name | Description |
|-----------|-------------|
| `ClampAttribute_ValueBelowMin_ReturnsMin` | 0 → 1 |
| `ClampAttribute_ValueAboveMax_ReturnsMax` | 15 → 10 |
| `ClampAttribute_ValueAtMin_ReturnsMin` | 1 → 1 |
| `ClampAttribute_ValueAtMax_ReturnsMax` | 10 → 10 |
| `ClampAttribute_ValueInRange_ReturnsUnchanged` | 5 → 5 |
| `ClampAttribute_DefaultRange_IsOneToTen` | Default [1, 10] |
| `ClampAttribute_CustomMin_UsesCustomMin` | Custom min works |
| `ClampAttribute_CustomMax_UsesCustomMax` | Custom max works |
| `ClampAttribute_CustomRange_ClampsCorrectly` | Custom range [5, 20] |
| `ClampAttribute_NegativeValue_ClampsToMin` | -5 → 1 |
| `ClampAttribute_AllValidValues_ReturnUnchanged(1)` | 1 unchanged |
| `ClampAttribute_AllValidValues_ReturnUnchanged(2)` | 2 unchanged |
| `ClampAttribute_AllValidValues_ReturnUnchanged(5)` | 5 unchanged |
| `ClampAttribute_AllValidValues_ReturnUnchanged(9)` | 9 unchanged |
| `ClampAttribute_AllValidValues_ReturnUnchanged(10)` | 10 unchanged |

**Logger Verification Tests:**
| Test Name | Description |
|-----------|-------------|
| `ApplyModifier_ShouldLogAtTraceLevel_OnEntry` | Trace on entry |
| `ApplyModifier_ShouldLogAtDebugLevel_OnResult` | Debug on result |
| `ApplyModifier_ShouldLogModifierValue` | Logs modifier value |
| `ApplyModifier_ShouldLogBaseValue` | Logs base value |
| `ClampAttribute_BelowMin_ShouldLogWarning` | Warning when clamped low |
| `ClampAttribute_AboveMax_ShouldLogWarning` | Warning when clamped high |
| `ClampAttribute_InRange_ShouldNotLogWarning` | No warning in range |
| `ClampAttribute_ShouldLogRange` | Logs min and max |

**Edge Case & Constructor Tests:**
| Test Name | Description |
|-----------|-------------|
| `Constructor_WithValidLogger_ShouldNotThrow` | Constructor accepts logger |
| `ApplyModifier_IntMaxValue_HandlesOverflow` | Int overflow wraps |
| `ClampAttribute_MinEqualsMax_ReturnsMinMax` | Min=Max works |

#### GameServiceTests (2 tests from v0.0.1)

| Test Name | Description |
|-----------|-------------|
| `Start_ShouldLogInitializationMessage` | Start logs initialization |
| `Constructor_WithValidLogger_ShouldNotThrow` | Constructor accepts logger |

---

## DI Registration

Services registered in `Program.cs`:

```csharp
services.AddSingleton<IGameService, GameService>();
services.AddSingleton<IDiceService, DiceService>();
services.AddSingleton<IStatCalculationService, StatCalculationService>();
```

---

## Verification Results

### Build
```
Build succeeded.
    0 Warning(s)
    0 Error(s)
```

### Tests
```
Passed!  - Failed: 0, Passed: 86, Skipped: 0, Total: 86
```

---

## Directory Structure After v0.0.2

```
rune-rust/
├── RuneAndRust.sln
├── RuneAndRust.Core/
│   ├── RuneAndRust.Core.csproj
│   ├── Enums/
│   │   └── Attribute.cs           [NEW]
│   ├── Interfaces/
│   │   ├── IGameService.cs
│   │   ├── IDiceService.cs        [NEW]
│   │   └── IStatCalculationService.cs [NEW]
│   └── Models/
│       └── Character.cs           [NEW]
├── RuneAndRust.Engine/
│   ├── RuneAndRust.Engine.csproj
│   └── Services/
│       ├── GameService.cs
│       ├── DiceService.cs         [NEW]
│       └── StatCalculationService.cs [NEW]
├── RuneAndRust.Persistence/
│   └── RuneAndRust.Persistence.csproj
├── RuneAndRust.Terminal/
│   ├── RuneAndRust.Terminal.csproj
│   └── Program.cs                 [MODIFIED]
├── RuneAndRust.Tests/
│   ├── RuneAndRust.Tests.csproj
│   ├── Core/
│   │   ├── PlaceholderTests.cs
│   │   ├── AttributeTests.cs      [NEW]
│   │   └── CharacterTests.cs      [NEW]
│   ├── Engine/
│   │   ├── GameServiceTests.cs
│   │   ├── DiceServiceTests.cs    [NEW]
│   │   └── StatCalculationServiceTests.cs [NEW]
│   └── Persistence/
│       └── PlaceholderTests.cs
├── logs/
└── docs/
    └── changelogs/
        ├── v0.0.1.md
        └── v0.0.2.md              [NEW]
```

---

## Running Tests

```bash
# Run all tests
dotnet test

# Run with verbose output
dotnet test --verbosity normal

# Run specific test class
dotnet test --filter "FullyQualifiedName~DiceServiceTests"

# Run specific test category
dotnet test --filter "FullyQualifiedName~Core"
```

---

## Next Steps

**v0.0.3: The Game Loop**
- Implement basic game loop in GameService
- Add turn-based combat structure
- Create CombatService for combat resolution
- Integrate DiceService with combat mechanics
- Add Character actions (attack, defend, etc.)
