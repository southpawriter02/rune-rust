You are absolutely correct. My previous sign-off was premature; Milestone 4.9 extends through v0.3.24. Let's get back on track with v0.3.16.
Here is the comprehensive implementation plan for v0.3.16: The Sentinel (Stability & Recovery).
This milestone implements robust error handling and crash recovery systems. Instead of the application simply closing or dumping a stack trace to the console when a critical error occurs, "The Sentinel" catches the exception, logs detailed diagnostics, and attempts to save the player's progress in a "Panic Save."
To manage the distinct logic of error trapping versus state recovery, this version is split into two sub-versions:
	•	v0.3.16a: The Safety Net (Global Exception Handler) – Infrastructure for catching unhandled exceptions and rendering a user-friendly crash screen.
	•	v0.3.16b: The Black Box (Emergency Save) – Logic to attempt a synchronous serialization of game state during a crash.

v0.3.16a: The Safety Net (Global Exception Handler)
Goal: Wrap the application execution in a global exception handler that intercepts crashes, writes a detailed crash.log, and displays a "Red Screen of Death" using Spectre.Console so the user knows what happened.
1. Architecture & Data Flow
	•	Layer: Terminal (Program.cs) & Engine (CrashService).
	•	Process:
	1	Program.Main enters a try/catch block wrapping the Host execution.
	2	On Exception: Execution flow jumps to CrashHandler.
	3	Logging: CrashHandler writes timestamped stack trace, GamePhase, and OS info to logs/crashes/.
	4	UI: CrashScreenRenderer clears the terminal and draws a red error panel with the error message and "Press any key to exit".
2. Logic Decision Trees
A. Exception Routing Logic Input: Unhandled Exception
	1	Is it a TaskCanceledException? (Ctrl+C)
	◦	Yes: Graceful shutdown. No crash screen.
	2	Is it a Critical Game Exception?
	◦	Yes:
	1	Capture Exception Data (Message, StackTrace).
	2	Capture Context (Current Phase, Room ID).
	3	Call CrashService.LogCrash().
	4	Call CrashScreenRenderer.Render().
	5	Environment.Exit(1).
3. Deliverable Checklist
	•	Core:
	◦	[ ] Define ICrashService interface.
	◦	[ ] Define CrashReport model (DTO for log files).
	•	Engine:
	◦	[ ] Implement CrashService to write .txt or .json crash logs.
	•	Terminal:
	◦	[ ] Implement CrashScreenRenderer (Spectre.Console layout).
	◦	[ ] Wrap host.Run() in Program.cs.
4. Code Implementation
File: RuneAndRust.Terminal/Program.cs
try
{
    // ... Existing startup logic ...
    await host.RunAsync();
}
catch (Exception ex)
{
    // Resolving services manually since Host might be failing
    var logger = Log.Logger;
    logger.Fatal(ex, "Critical application failure");

    var renderer = new CrashScreenRenderer();
    renderer.Render(ex); // Draw Red Screen
}
finally
{
    Log.CloseAndFlush();
}

v0.3.16b: The Black Box (Emergency Save)
Goal: Implement the "Panic Save" protocol. When a crash occurs, the system attempts one final, high-priority serialization of the GameState to data/saves/emergency.json to prevent progress loss.
1. Architecture & Data Flow
	•	Constraint: This must happen synchronously or with extreme caution, as the application state is unstable.
	•	Process:
	1	Inside the catch block (from v0.3.16a), check if GameState is not null.
	2	Snapshot: Clone critical data (Player, Inventory, Location).
	3	Serialize: Dump to JSON.
	4	Write: Save to specific "Recovery" slot or file.
2. Logic Decision Trees
A. Panic Save Logic Input: GameState
	1	Integrity Check: Is CurrentCharacter null?
	◦	Yes: Abort save (nothing to save).
	2	Serialization: Try JsonSerializer.Serialize(state).
	◦	Success: Write to disk.
	◦	Fail (Exception during serialization): Log "Emergency Save Failed" to crash log. Do not crash the crash handler.
	3	Feedback: Add "Emergency Backup Saved" to the Crash Screen UI.
3. Deliverable Checklist
	•	Engine:
	◦	[ ] Implement EmergencySaveService.
	◦	[ ] Update SaveManager to support specific file paths (not just slots).
	•	Terminal:
	◦	[ ] Update Program.cs exception block to invoke EmergencySaveService.
	◦	[ ] Update CrashScreenRenderer to show backup status.
4. Code Implementation
File: RuneAndRust.Engine/Services/EmergencySaveService.cs
public void AttemptEmergencySave(GameState state)
{
    try
    {
        if (state.CurrentCharacter == null) return;

        var backup = new SaveGame {
            SerializedState = JsonSerializer.Serialize(state),
            // ... metadata
        };

        File.WriteAllText("data/saves/emergency.json",
            JsonSerializer.Serialize(backup));
    }
    catch (Exception saveEx)
    {
        // Swallow exception here to ensure the Crash Screen still shows
        // Log to internal emergency log
    }
}

5. Logging Requirements
System
Event
Level
Message Template
Properties
Crash
Caught
Fatal
"CRITICAL FAILURE: {Message}. Stack: {Trace}"
Message, Trace
Recovery
Attempt
Info
"Attempting emergency save for {Character}."
Character
Recovery
Success
Info
"Emergency save written to {Path}."
Path
Recovery
Fail
Error
"Emergency save failed: {Error}"
Error

6. Testing Strategy
	•	Manual QA (The "Self-Destruct" Test):
	◦	Add a temporary debug command /crash that throws new Exception("Test Crash").
	◦	Verify: Application does not close instantly. Red screen appears. logs/crashes/ contains a file.
	•	Integration Test (Persistence):
	◦	Trigger /crash with valid character state.
	◦	Restart game.
	◦	Verify: Load Game menu shows "Emergency Backup" or specific slot.

7. Draft Changelog (v0.3.16)
# v0.3.16 Changelog: The Sentinel
**Release Date:** 2026-03-01

## Summary
This release implements "The Sentinel," a global stability framework. The application now gracefully handles critical errors by displaying a diagnostic screen instead of silently closing. Additionally, a "Black Box" recorder attempts to save player progress to an emergency file in the event of a crash.

## New Features
*   **Crash Screen:** A user-friendly error screen (Red Screen of Death) that displays the error message and log location.
*   **Emergency Save:** On crash, the game attempts to serialize the current character state to `emergency.json`.
*   **Crash Logging:** Detailed stack traces are now written to `logs/crashes/` with timestamps.

## Technical Changes
*   Wrapped `Program.Main` in a global exception handler.
*   Implemented `CrashService` and `EmergencySaveService`.
Would you like to proceed to the detailed breakdown of v0.3.16a?
