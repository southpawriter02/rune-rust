# v0.11.2b Changelog: Crafting Service

**Version:** 0.11.2b
**Phase:** Crafting Service (Core Crafting Mechanics)
**Date:** 2026-01-19
**Status:** ✅ Complete

---

## Summary

Implements the Crafting Service - the core system that handles the complete crafting process. This includes validating prerequisites (recipe knowledge, station availability, resource requirements), executing d20 dice checks against recipe difficulty, consuming resources on success, and applying graduated partial resource loss on failure.

The crafting system uses a d20 + skill modifier vs DC mechanic where:
- Success consumes all resources and creates an item with quality based on roll margin
- Failure applies graduated resource loss (25% for close failure, 50% for bad failure)
- Natural 20 always produces Legendary quality items

This version connects crafting stations (v0.11.2a) with recipes (v0.11.1) to enable the complete crafting workflow.

---

## Added

### Domain Layer - Enums

| Enum | Description |
|------|-------------|
| `CraftedItemQuality` | Quality tiers for crafted items |

#### CraftedItemQuality Values

| Value | Description |
|-------|-------------|
| `Standard` | Base quality (default) |
| `Fine` | High quality (margin >= 5) |
| `Masterwork` | Exceptional quality (margin >= 10) |
| `Legendary` | Legendary quality (natural 20) |

### Domain Layer - Events

| Event | Description |
|-------|-------------|
| `CraftingEvent` | Base event for all crafting-related activities |
| `CraftAttemptedEvent` | Published when a player attempts to craft an item |
| `ItemCraftedEvent` | Published when a player successfully crafts an item |

#### CraftAttemptedEvent Properties

| Property | Type | Description |
|----------|------|-------------|
| `RecipeId` | `string?` | Recipe being crafted |
| `StationId` | `string?` | Crafting station used |
| `Roll` | `int` | Raw d20 roll value (1-20) |
| `Modifier` | `int` | Skill modifier applied |
| `Total` | `int` | Total roll result (Roll + Modifier) |
| `DifficultyClass` | `int` | Recipe difficulty class |
| `WasSuccessful` | `bool` | Whether Total >= DC |
| `Margin` | `int` | Total - DifficultyClass |
| `IsNatural20` | `bool` | True if Roll == 20 |

#### ItemCraftedEvent Properties

| Property | Type | Description |
|----------|------|-------------|
| `RecipeId` | `string?` | Recipe used |
| `StationId` | `string?` | Crafting station used |
| `ItemId` | `Guid` | Created item identifier |
| `ItemName` | `string` | Display name of item |
| `Quality` | `CraftedItemQuality` | Quality tier achieved |
| `IsExceptionalQuality` | `bool` | True for Masterwork or Legendary |

### Application Layer - DTOs

| DTO | Description |
|-----|-------------|
| `CraftResult` | Result of a crafting attempt |
| `MissingResource` | Resource the player is missing for crafting |
| `ResourceLoss` | Resource loss from a failed crafting attempt |

#### CraftResult Properties

| Property | Type | Description |
|----------|------|-------------|
| `IsSuccess` | `bool` | Whether crafting succeeded |
| `Roll` | `int` | The d20 roll value (1-20, 0 if validation failure) |
| `Modifier` | `int` | Skill modifier applied |
| `Total` | `int` | Roll + Modifier |
| `DifficultyClass` | `int` | Recipe DC |
| `CraftedItem` | `Item?` | Created item (null on failure) |
| `Quality` | `CraftedItemQuality?` | Item quality (null on failure) |
| `ResourcesLost` | `IReadOnlyList<ResourceLoss>?` | Resources lost (null on success) |
| `FailureReason` | `string?` | Failure message (null on success) |

#### CraftResult Computed Properties

| Property | Type | Description |
|----------|------|-------------|
| `WasDiceRollFailure` | `bool` | True when dice check failed (not validation) |
| `Margin` | `int` | Total - DifficultyClass |
| `IsCloseFailure` | `bool` | Dice failure with margin >= -5 |
| `IsBadFailure` | `bool` | Dice failure with margin < -5 |
| `TotalResourcesLost` | `int` | Sum of all resources lost |
| `IsNatural20` | `bool` | True if Roll == 20 |

#### CraftResult Factory Methods

| Method | Description |
|--------|-------------|
| `Success(roll, modifier, total, dc, item, quality)` | Successful crafting |
| `Failed(roll, modifier, total, dc, losses)` | Dice check failed |
| `ValidationFailed(reason)` | Prerequisites not met |

#### CraftResult Display Methods

| Method | Returns | Description |
|--------|---------|-------------|
| `GetRollDisplay()` | `string` | Format: "d20(15) +4 = 19 vs DC 12" |
| `GetResourceLossDisplay()` | `string` | Multi-line list of resources lost |

#### MissingResource Properties

| Property | Type | Description |
|----------|------|-------------|
| `ResourceId` | `string` | Resource identifier |
| `Name` | `string` | Display name |
| `Needed` | `int` | Total quantity required |
| `Have` | `int` | Quantity player has |
| `Shortage` | `int` | Needed - Have (computed) |

#### ResourceLoss Properties

| Property | Type | Description |
|----------|------|-------------|
| `ResourceId` | `string` | Resource identifier |
| `Name` | `string` | Display name |
| `Amount` | `int` | Quantity lost |

### Application Layer - Interfaces

| Interface | Description |
|-----------|-------------|
| `ICraftingService` | Core service for validating and executing crafting |

#### ICraftingService Methods

| Method | Returns | Description |
|--------|---------|-------------|
| `CanCraft(player, recipeId, room)` | `CraftValidation` | Validate crafting prerequisites |
| `Craft(player, recipeId, room)` | `CraftResult` | Execute crafting attempt |
| `GetCraftableRecipesHere(player, room)` | `IReadOnlyList<RecipeDefinition>` | Recipes available at current station |
| `GetReadyToCraftRecipes(player, room)` | `IReadOnlyList<RecipeDefinition>` | Recipes player can craft now |
| `GetCurrentStation(room)` | `CraftingStation?` | Get station in room |
| `GetCraftingModifier(player, stationId)` | `int` | Player's skill modifier |
| `CalculateFailureLoss(recipe, rollMargin)` | `IReadOnlyList<ResourceLoss>` | Calculate partial resource loss |

### Application Layer - Services

| Service | Description |
|---------|-------------|
| `CraftingService` | Implementation of ICraftingService |

#### CraftingService Dependencies

| Dependency | Purpose |
|------------|---------|
| `IRecipeProvider` | Recipe definitions lookup |
| `IRecipeService` | Recipe knowledge validation |
| `ICraftingStationProvider` | Station definitions |
| `IResourceProvider` | Resource definitions |
| `IDiceService` | D20 dice rolling |
| `IGameEventLogger` | Event publishing |
| `ILogger<CraftingService>` | Diagnostic logging |

#### CraftingService Constants

| Constant | Value | Description |
|----------|-------|-------------|
| `CloseFailureLossPercent` | 0.25f | 25% resource loss on close failure |
| `BadFailureLossPercent` | 0.50f | 50% resource loss on bad failure |
| `BadFailureThreshold` | -5 | Margin below this is bad failure |

---

## Modified

### Application Layer - CraftValidation

| Change | Description |
|--------|-------------|
| `Station` property | Added `CraftingStationDefinition?` property |
| `Success(recipe, station)` overload | Factory method including station |
| `Success(recipe)` overload | Backwards-compatible factory (station = null) |

### Infrastructure Layer - DependencyInjection

| Registration | Lifetime | Description |
|--------------|----------|-------------|
| `ICraftingService` | Scoped | Crafting service implementation |

---

## Quality Determination

Quality is determined by the roll margin (Total - DC):

| Condition | Quality |
|-----------|---------|
| Natural 20 (Roll == 20) | Legendary |
| Margin >= 10 | Masterwork |
| Margin >= 5 | Fine |
| Otherwise | Standard |

---

## Failure Loss Calculation

Resource loss on failed crafting attempts:

| Failure Type | Margin | Loss % | Minimum |
|--------------|--------|--------|---------|
| Close Failure | >= -5 | 25% | 1 per resource |
| Bad Failure | < -5 | 50% | 1 per resource |

Example: Recipe requires 8 iron ore
- Close failure: Lose 2 ore (25% of 8)
- Bad failure: Lose 4 ore (50% of 8)

---

## Unit Tests

### CanCraft Tests (~7 tests)

- CanCraft_RecipeNotFound_ReturnsFailed
- CanCraft_RecipeNotKnown_ReturnsFailed
- CanCraft_NoStation_ReturnsFailed
- CanCraft_WrongStationType_ReturnsFailed
- CanCraft_InsufficientResources_ReturnsFailed
- CanCraft_AllValid_ReturnsSuccess
- CanCraft_NullPlayer_ThrowsArgumentNullException

### Craft Tests (~6 tests)

- Craft_RollSucceeds_ReturnsSuccessWithItem
- Craft_RollFails_CloseFailure_Returns25PercentLoss
- Craft_RollFails_BadFailure_Returns50PercentLoss
- Craft_Natural20_ReturnsLegendaryQuality
- Craft_HighMargin_ReturnsMasterworkQuality
- Craft_MediumMargin_ReturnsFineQuality

### Event Tests (~2 tests)

- Craft_PublishesCraftAttemptedEvent
- Craft_Success_PublishesItemCraftedEvent

### Display Tests (~2 tests)

- CraftResult_GetRollDisplay_FormatsCorrectly
- CraftResult_GetResourceLossDisplay_FormatsCorrectly

### Modifier Tests (~2 tests)

- GetCraftingModifier_ReturnsSkillBasedModifier
- GetCraftingModifier_UntrainedSkill_ReturnsZero

---

## Files Created

| Path | Description |
|------|-------------|
| `src/Core/RuneAndRust.Domain/Enums/CraftingEnums.cs` | CraftedItemQuality enum |
| `src/Core/RuneAndRust.Domain/Events/CraftingEvents.cs` | Crafting domain events |
| `src/Core/RuneAndRust.Application/DTOs/CraftResult.cs` | Craft result record |
| `src/Core/RuneAndRust.Application/DTOs/CraftingRecords.cs` | MissingResource, ResourceLoss records |
| `src/Core/RuneAndRust.Application/Interfaces/ICraftingService.cs` | Service interface |
| `src/Core/RuneAndRust.Application/Services/CraftingService.cs` | Service implementation |
| `tests/.../Services/CraftingServiceTests.cs` | Unit tests |

## Files Modified

| Path | Description |
|------|-------------|
| `src/Core/RuneAndRust.Application/DTOs/CraftValidation.cs` | Added Station property and overloads |
| `src/Infrastructure/RuneAndRust.Infrastructure/DependencyInjection.cs` | Registered ICraftingService |

---

## API Examples

### Validating a Craft Attempt

```csharp
// Check if player can craft at current location
var validation = craftingService.CanCraft(player, "iron-sword", currentRoom);

if (!validation.IsValid)
{
    Console.WriteLine(validation.FailureReason);
    // "You don't have the required resources."

    if (validation.MissingIngredients?.Count > 0)
    {
        foreach (var missing in validation.MissingIngredients)
        {
            Console.WriteLine($"  - {missing.Name}: need {missing.QuantityNeeded}");
        }
    }
}
```

### Executing a Craft Attempt

```csharp
var result = craftingService.Craft(player, "iron-sword", currentRoom);

if (result.IsSuccess)
{
    Console.WriteLine($"Success! Crafted {result.CraftedItem!.Name}");
    Console.WriteLine($"Quality: {result.Quality}");
    Console.WriteLine(result.GetRollDisplay());
    // "d20(15) +4 = 19 vs DC 12"
}
else if (result.WasDiceRollFailure)
{
    Console.WriteLine("Crafting failed!");
    Console.WriteLine(result.GetRollDisplay());
    Console.WriteLine($"Lost {result.TotalResourcesLost} resources:");
    Console.WriteLine(result.GetResourceLossDisplay());
    // "  - Iron Ore x2"
    // "  - Leather x1"
}
else
{
    // Validation failure
    Console.WriteLine(result.FailureReason);
}
```

### Getting Available Recipes

```csharp
// Get all recipes available at current station
var available = craftingService.GetCraftableRecipesHere(player, currentRoom);
Console.WriteLine($"Recipes available at {station.Name}:");
foreach (var recipe in available)
{
    Console.WriteLine($"  - {recipe.Name} (DC {recipe.DifficultyClass})");
}

// Get recipes player has resources for
var ready = craftingService.GetReadyToCraftRecipes(player, currentRoom);
Console.WriteLine($"Ready to craft: {ready.Count}");
```

### Checking Crafting Skill

```csharp
var station = craftingService.GetCurrentStation(currentRoom);
if (station != null)
{
    var modifier = craftingService.GetCraftingModifier(player, station.StationId);
    Console.WriteLine($"Your {station.RequiredSkillId} modifier: +{modifier}");
}
```

---

## Crafting Flow

```
Craft(player, recipeId, room)
    │
    ├─ CanCraft validation
    │   ├─ Check room has crafting station
    │   ├─ Validate recipe exists
    │   ├─ Check player knows recipe
    │   ├─ Verify station type matches recipe
    │   └─ Check player has all resources
    │       └─ If any fail, return ValidationFailed result
    │
    ├─ Get player's skill modifier
    │   └─ SkillProficiency → modifier (0-5)
    │
    ├─ Roll d20 + modifier vs DC
    │   └─ Publish CraftAttemptedEvent
    │
    ├─ If roll >= DC: SUCCESS
    │   ├─ Consume all resources
    │   ├─ Determine quality (Natural20/Margin)
    │   ├─ Create item with quality
    │   ├─ Add item to inventory
    │   ├─ Publish ItemCraftedEvent
    │   └─ Return Success result
    │
    └─ If roll < DC: FAILURE
        ├─ Calculate loss percentage (25% or 50%)
        ├─ Apply partial resource loss
        └─ Return Failed result with losses
```

---

## v0.11.x Progress

| Version | Feature | Status |
|---------|---------|--------|
| v0.11.0a | Resource Definitions | ✅ Complete |
| v0.11.0b | Harvestable Features | ✅ Complete |
| v0.11.0c | Gathering Service | ✅ Complete |
| v0.11.1a | Recipe Definitions | ✅ Complete |
| v0.11.1b | Recipe Book | ✅ Complete |
| v0.11.1c | Recipe Discovery | ✅ Complete |
| v0.11.2a | Crafting Stations | ✅ Complete |
| v0.11.2b | Crafting Service | ✅ Complete |
| v0.11.2c | Crafting Commands | Pending |

---

## Dependencies

### Required From Prior Versions

| Version | Dependency | Usage |
|---------|------------|-------|
| v0.11.2a | CraftingStation | Room station lookup |
| v0.11.2a | CraftingStationDefinition | Station metadata |
| v0.11.2a | ICraftingStationProvider | Station definitions |
| v0.11.1b | RecipeBook | Recipe knowledge |
| v0.11.1b | IRecipeService | Recipe validation |
| v0.11.1a | RecipeDefinition | Recipe data |
| v0.11.1a | IRecipeProvider | Recipe lookup |
| v0.11.0a | ResourcePool | Resource spending/loss |
| v0.11.0a | IResourceProvider | Resource definitions |
| v0.0.x | IDiceService | D20 rolling |
| v0.0.x | IGameEventLogger | Event publishing |

### Provides To Future Versions

| Version | Feature | Usage |
|---------|---------|-------|
| v0.11.2c | ICraftingService | Command integration |
| v0.11.2c | CraftResult | Command result handling |
| v0.11.2c | CraftAttemptedEvent | UI feedback |
| v0.11.2c | ItemCraftedEvent | Achievement tracking |

---

## Key Design Decisions

1. **Room Parameter Pattern** - Methods accept `Room room` instead of using `player.CurrentRoom` for flexibility and testability
2. **Graduated Failure** - Two tiers of resource loss (25%/50%) based on failure margin
3. **Quality from Roll** - Item quality determined by roll margin, with Natural 20 always Legendary
4. **Minimum Loss** - At least 1 of each resource lost on failure (prevents zero-loss edge cases)
5. **Validation-First** - `CanCraft` validates all prerequisites before `Craft` attempts dice roll
6. **Event-Driven** - Events published for both attempts and successes for UI/analytics
7. **Backwards Compatibility** - CraftValidation.Success overload without station for existing code
8. **Resource Spending** - Uses ResourcePool.Spend() for success, ResourcePool.Lose() for failure

---

## Logging Strategy

| Level | Component | When |
|-------|-----------|------|
| Information | CraftingService | Successful craft with item details |
| Information | CraftingService | Craft attempt failed with roll details |
| Debug | CraftingService | Validation steps, resource checks |
| Debug | CraftingService | Modifier calculation |
| Warning | CraftingService | Recipe not found |
| Warning | CraftingService | Station type mismatch |
| Error | CraftingService | Unexpected errors during crafting |

---

## Notes

- CraftCommand is deferred to v0.11.2c when command infrastructure is implemented
- Crafting modifier based on SkillProficiency enum (Untrained=0 through Master=5)
- Natural 20 bypasses normal quality calculation, always yields Legendary
- Close failure (margin -1 to -5) is more forgiving than bad failure (margin -6 or worse)
- Resources are consumed before item creation on success
- Resources are lost (not spent) on failure - distinction for potential future tracking
- Station type validation uses CraftingStationType enum matching
- Quality prefixes item name (e.g., "Fine Iron Sword", "Legendary Steel Blade")
