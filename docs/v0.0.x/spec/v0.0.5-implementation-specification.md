# v0.0.5 Implementation Specification: Dice Pool System

**Version:** 0.0.5
**Implementation Date:** 2026-01-07
**Design Specification:** [v0.0.5-scope-breakdown.md](../v0.0.5-scope-breakdown.md)
**Changelogs:** [v0.0.5a](../../changelogs/v0.0.5a-changelog.md), [v0.0.5b](../../changelogs/v0.0.5b-changelog.md), [v0.0.5c](../../changelogs/v0.0.5c-changelog.md), [v0.0.5d](../../changelogs/v0.0.5d-changelog.md)

---

## 1. Overview

### 1.1 Summary

v0.0.5 implements a comprehensive dice pool system supporting standard notation (e.g., "3d6+5"), exploding dice, advantage/disadvantage mechanics, and skill checks with difficulty classes. The system integrates with combat and provides rich console output with flavor text.

### 1.2 Key Features

- **DicePool Value Object**: Immutable dice configuration with notation parsing
- **DiceService**: Roll execution with seeded random support
- **Skill Check System**: Skills, difficulty classes, critical success/failure
- **Advantage/Disadvantage**: Roll twice, take best/worst
- **Combat Integration**: Dice-based damage and attack rolls
- **Descriptor System**: Context-aware flavor text for results

### 1.3 Deviations from Design

None significant; implementation matches design specification.

---

## 2. Architecture

### 2.1 Layer Interactions

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Presentation Layer                        â”‚
â”‚  GameView â†’ "roll", "check" commands                        â”‚
â”‚  SpectreGameRenderer â†’ RenderDiceRollAsync, RenderSkillCheck â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Application Layer                         â”‚
â”‚  DiceService, SkillCheckService, DiceDescriptorService      â”‚
â”‚  ConsoleInputHandler â†’ ParseRollCommand, ParseSkillCheck    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      Domain Layer                            â”‚
â”‚  DicePool, DiceRollResult, DiceType                         â”‚
â”‚  SkillDefinition, SkillCheckResult, DifficultyClass         â”‚
â”‚  CombatService (dice integration)                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   Infrastructure Layer                       â”‚
â”‚  JsonConfigurationProvider â†’ dice-descriptors.json          â”‚
â”‚                            â†’ skills.json                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.2 Key Patterns

- **Value Object Pattern**: DicePool is immutable with factory methods
- **Parser Pattern**: DicePool.Parse() for notation strings
- **Service Pattern**: Stateless DiceService and SkillCheckService
- **Descriptor Pattern**: Context-aware text selection

### 2.3 Dependencies

- No new external dependencies
- Internal: DiceService used by CombatService, SkillCheckService

---

## 3. Data Model

### 3.1 Value Objects

| Value Object | Key Properties |
|--------------|----------------|
| `DicePool` | Count, DiceType, Modifier, Exploding, MaxExplosions |
| `DiceRollResult` | DicePool, Rolls, ExplosionRolls, Total, HasAdvantage, HasDisadvantage |
| `SkillCheckResult` | Skill, Roll, Modifier, Total, DC, Success, IsCritical |

### 3.2 Enums

| Enum | Values |
|------|--------|
| `DiceType` | D4 (4), D6 (6), D8 (8), D10 (10) |
| `DifficultyClass` | Trivial (5), Easy (8), Medium (10), Hard (15), VeryHard (18), Extreme (20) |

### 3.3 DicePool Properties

```csharp
public readonly record struct DicePool
{
    public int Count { get; init; }           // Number of dice
    public DiceType DiceType { get; init; }   // Type of dice
    public int Modifier { get; init; }        // Flat modifier
    public bool Exploding { get; init; }      // Explode on max
    public int MaxExplosions { get; init; }   // Explosion cap

    public int Faces => (int)DiceType;
    public int MinimumResult => Count + Modifier;
    public int MaximumResult => Count * Faces + Modifier;
    public float AverageResult => Count * ((Faces + 1) / 2f) + Modifier;
}
```

---

## 4. Services

### 4.1 DiceService

```csharp
Roll(dicePool) â†’ DiceRollResult
Roll(dicePool, advantage: true) â†’ DiceRollResult  // Roll 2, take highest
Roll(dicePool, disadvantage: true) â†’ DiceRollResult  // Roll 2, take lowest
RollWithSeededRandom(dicePool, seed) â†’ DiceRollResult  // For testing
```

### 4.2 SkillCheckService

```csharp
PerformCheck(player, skillId, dc) â†’ SkillCheckResult
PerformCheck(player, skillId, difficultyClass) â†’ SkillCheckResult
GetPassiveScore(player, skillId) â†’ int  // 10 + modifier
GetSkillModifier(player, skillId) â†’ int
```

### 4.3 DiceDescriptorService

```csharp
GetDescriptor(category) â†’ string
GetCriticalDescriptor(success: bool) â†’ string
GetCombatDescriptor(result) â†’ string
```

---

## 5. Configuration

### 5.1 JSON Files

| File | Content |
|------|---------|
| `skills.json` | Skill definitions with base attributes |
| `dice-descriptors.json` | 12 categories, 60+ flavor phrases |

### 5.2 Dice Notation

| Notation | Meaning |
|----------|---------|
| `d6` | Roll one d6 |
| `2d6` | Roll two d6, sum results |
| `3d8+5` | Roll 3d8, add 5 to total |
| `1d10-2` | Roll 1d10, subtract 2 |
| `1d6!` | Exploding d6 (reroll on max) |
| `4d4!+2` | 4 exploding d4 plus 2 |

### 5.3 Descriptor Categories

| Category | Example Use |
|----------|-------------|
| `dice.natural_max` | "Perfect roll!" |
| `dice.natural_one` | "A fumble!" |
| `skill.critical_success` | "Exceptional success!" |
| `skill.critical_failure` | "Catastrophic failure!" |
| `combat.critical_hit` | "A devastating blow!" |
| `combat.critical_miss` | "The attack goes wide!" |

---

## 6. Commands & Rendering

### 6.1 Commands

| Command | Example | Action |
|---------|---------|--------|
| `roll` | `roll 3d6+5` | Direct dice roll |
| `roll adv` | `roll 1d10 advantage` | Roll with advantage |
| `check` | `check perception` | Skill check |
| `check dc` | `check stealth hard` | Skill check with DC |

### 6.2 Display

```
â•­â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•®
â”‚           ðŸŽ² DICE ROLL ðŸŽ²           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Rolling: 2d6+3                     â”‚
â”‚  Results: [4] [6]                   â”‚
â”‚  Sum: 10                            â”‚
â”‚  Modifier: +3                       â”‚
â”‚  Total: 13                          â”‚
â•°â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•¯
```

---

## 7. Use Cases

### 7.1 Primary Use Cases

- [UC-011: Roll Dice](../../use-cases/player/UC-011-roll-dice.md)
- [UC-012: Skill Check](../../use-cases/player/UC-012-skill-check.md)

### 7.2 Edge Cases

- Exploding dice reaching max explosions (10)
- Critical success/failure detection
- Advantage with both dice equal
- Parsing invalid notation

---

## 8. Testing

### 8.1 Test Coverage

| Phase | Tests | Areas |
|-------|-------|-------|
| v0.0.5a | ~30 | DicePool, DiceService, DiceRollResult |
| v0.0.5b | ~25 | Skills, SkillCheckService, DC |
| v0.0.5c | ~15 | Combat integration |
| v0.0.5d | 18 | Commands, descriptors, rendering |
| **Total** | **284** | +86 from v0.0.4 |

### 8.2 Key Test Scenarios

- DicePool.Parse() with various notations
- Exploding dice chains
- Advantage/disadvantage selection
- Skill modifier calculation
- Critical success/failure thresholds
- Seeded random for deterministic tests

---

## 9. Known Limitations

### 9.1 Current Limitations

- Limited to d4, d6, d8, d10 (no d12, d20, d100)
- No compound dice expressions (2d6+1d4)
- No target number systems
- Skills not integrated with all actions yet

### 9.2 Future Improvements

- v0.0.6: Initiative rolls using dice system
- Additional dice types if needed
- Opposed skill checks

---

## 10. Related Documentation

- **ADRs**: [ADR-002](../../architecture/ADR-002-json-configuration.md) (JSON configuration)
- **Use Cases**: UC-011, UC-012
- **v0.0.4 Dependency**: Ability effects can use dice for damage
