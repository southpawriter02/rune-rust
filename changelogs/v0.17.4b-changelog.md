# Changelog: v0.17.4b - Specialization & Special Resource Definitions

**Release Date:** 2026-01-30
**Phase:** Specialization System (2/5)
**Status:** Complete

---

## Overview

Implements the `SpecialResourceDefinition` value object and `SpecializationDefinition` entity, defining the display metadata, path type classification, parent archetype linkage, unlock cost, and optional special resource for each of the 17 specializations. The specializations configuration (`specializations.json`) is enhanced with a `definitions` array containing all 17 entries, and the JSON schema is updated to validate the new structure.

This phase builds on v0.17.4a (enums and extensions) to establish the data model for specialization identity and unique resource mechanics.

**Special Resource Distribution:**

| Specialization | Resource            | Range  | StartsAt | Regen/Turn | Decay/Turn |
| -------------- | ------------------- | ------ | -------- | ---------- | ---------- |
| Berserkr       | Rage                | 0–100  | 0        | 0          | 5          |
| Skjaldmaer     | Block Charges       | 0–3    | 3        | 1          | 0          |
| Iron-Bane      | Righteous Fervor    | 0–50   | 0        | 0          | 0          |
| Seiðkona       | Aether Resonance    | 0–10   | 0        | 0          | 1          |
| Echo-Caller    | Echoes              | 0–5    | 0        | 0          | 0          |

The remaining 12 specializations use `SpecialResourceDefinition.None`.

---

## Added

### Domain Layer

#### Value Objects

- **`SpecialResourceDefinition`** (`ValueObjects/SpecialResourceDefinition.cs`)
    - `public readonly record struct` with `init` properties (NOT primary constructor — per design spec Section 4.1)
    - Properties: `ResourceId`, `DisplayName`, `MinValue`, `MaxValue`, `StartsAt`, `RegenPerTurn`, `DecayPerTurn`, `Description`
    - Static `None` property for specializations without unique resources (12 of 17)
    - Computed `HasResource` property: `!string.IsNullOrEmpty(ResourceId)`
    - Factory method `Create()` with comprehensive validation:
        - `ArgumentException.ThrowIfNullOrWhiteSpace` for `resourceId` and `displayName`
        - `ArgumentOutOfRangeException.ThrowIfGreaterThan(minValue, maxValue)` for range validation
        - `ArgumentOutOfRangeException.ThrowIfLessThan(startsAt, minValue)` and `ThrowIfGreaterThan(startsAt, maxValue)` for starting value bounds
        - `ArgumentOutOfRangeException.ThrowIfNegative` for `regenPerTurn` and `decayPerTurn`
    - Normalizes `ResourceId` to lowercase via `ToLowerInvariant()`
    - Optional `ILogger<SpecialResourceDefinition>?` parameter for diagnostic output
    - Logging: `LogDebug` before/after validation, `LogInformation` on successful creation
    - `ToString()` override: `"{DisplayName} ({MinValue}-{MaxValue})"` or `"None"`
    - Sections: PRIVATE FIELDS, PROPERTIES, COMPUTED PROPERTIES, STATIC PROPERTIES, FACTORY METHODS, DEBUGGING
    - Comprehensive XML documentation on all members with `<summary>`, `<value>`, `<remarks>`, `<example>`, `<seealso>`

#### Entities

- **`SpecializationDefinition`** (`Entities/SpecializationDefinition.cs`)
    - `public class SpecializationDefinition : IEntity`
    - Properties (private set): `Id` (Guid), `SpecializationId`, `DisplayName`, `Tagline`, `Description`, `SelectionText`, `ParentArchetype`, `PathType`, `UnlockCost`, `SpecialResource`
    - Computed properties: `HasSpecialResource` (delegates to `SpecialResource.HasResource`), `IsHeretical` (`PathType == Heretical`)
    - Private constructor for EF Core materialization with `null!` string initializers
    - Factory method `Create()` with comprehensive validation:
        - `ArgumentException.ThrowIfNullOrWhiteSpace` for `displayName`, `tagline`, `description`, `selectionText`
        - `ArgumentOutOfRangeException.ThrowIfNegative(unlockCost)`
        - Cross-validation: `specializationId.GetPathType()` must match `pathType` parameter
        - Cross-validation: `specializationId.GetParentArchetype()` must match `parentArchetype` parameter
        - Trims all string inputs via `.Trim()`
        - Assigns `Guid.NewGuid()` to `Id`
        - Defaults `specialResource ?? SpecialResourceDefinition.None`
    - Optional `ILogger<SpecializationDefinition>?` parameter for diagnostic output
    - Logging: `LogDebug` pre-validation, `LogDebug` post-validation, `LogWarning` on mismatch, `LogInformation` on creation
    - Helper methods:
        - `GetCorruptionWarning()` → delegates to `PathType.GetCreationWarning()`
        - `GetSelectionDisplay()` → formatted multi-line display: `"{DisplayName}\n\"{Tagline}\"\n\n{SelectionText}"`
    - `ToString()` override: `"{DisplayName} ({ParentArchetype}, {PathType})"`
    - Sections: PRIVATE FIELDS, PROPERTIES, CONSTRUCTORS, FACTORY METHODS, HELPER METHODS, DEBUGGING
    - Comprehensive XML documentation with cross-references to v0.17.4a types

### Configuration Files

- **`config/specializations.json`** — Added `definitions` array with 17 entries
    - Each entry contains: `specializationId`, `displayName`, `tagline`, `description`, `selectionText`, `parentArchetype`, `pathType`, `unlockCost`, `specialResource`
    - 8 entries from design specification Section 6.1 (Berserkr, IronBane, Skjaldmaer, SkarHorde, AtgeirWielder, GorgeMaw, Seidkona, EchoCaller)
    - 9 entries authored with lore-consistent content (Veidimadr, MyrkGengr, Strandhogg, HlekkrMaster, BoneSetter, JotunReader, Skald, ScrapTinker, Einbui)
    - 5 entries include `specialResource` objects; 12 entries have `specialResource: null`
    - All entries have `unlockCost: 0` (first spec is free; 3 PP cost applies at runtime for additional specs)
    - `pathTypes` array preserved unchanged from v0.17.4a

- **`config/schemas/specializations.schema.json`** — Enhanced with definition and resource schemas
    - Added `"definitions"` to top-level `required` array
    - Added `"definitions"` property: array with `minItems: 17, maxItems: 17`, items ref to `#/definitions/definitionEntry`
    - Added `definitionEntry` to schema definitions with 9 required properties: `specializationId`, `displayName`, `tagline`, `description`, `selectionText`, `parentArchetype`, `pathType`, `unlockCost`, `specialResource`
    - Added `specialResourceEntry` to schema definitions with 8 required properties: `resourceId`, `displayName`, `minValue`, `maxValue`, `startsAt`, `regenPerTurn`, `decayPerTurn`, `description`
    - `specialResource` uses `oneOf` with `$ref` to `specialResourceEntry` or `null` type
    - `parentArchetype` constrained to enum: `["Warrior", "Skirmisher", "Mystic", "Adept"]`
    - `additionalProperties: false` on all object definitions
    - Updated schema description to reference both v0.17.4a and v0.17.4b

### Unit Tests

- **`SpecialResourceDefinitionTests`** (`ValueObjects/SpecialResourceDefinitionTests.cs`) — 14 test methods
    - **Factory Method Tests (2 methods):**
        - `Create_WithValidParameters_CreatesResource`: Block Charges resource with full property verification
        - `Create_NormalizesResourceIdToLowerCase`: "RAGE" → "rage"
    - **Static Property Tests (2 methods):**
        - `None_HasResourceReturnsFalse`: HasResource is false, ResourceId is empty
        - `None_HasZeroValues`: All numeric properties are 0
    - **Validation Tests (7 methods):**
        - `Create_WithNullResourceId_ThrowsArgumentException`
        - `Create_WithNullDisplayName_ThrowsArgumentException`
        - `Create_WithInvalidRange_ThrowsArgumentOutOfRangeException` (min > max)
        - `Create_WithStartsBelowMin_ThrowsArgumentOutOfRangeException`
        - `Create_WithStartsAboveMax_ThrowsArgumentOutOfRangeException`
        - `Create_WithNegativeRegen_ThrowsArgumentOutOfRangeException`
        - `Create_WithNegativeDecay_ThrowsArgumentOutOfRangeException`
    - **Computed Property Tests (1 method):**
        - `HasResource_WithValidResource_ReturnsTrue`
    - **Display Tests (2 methods):**
        - `ToString_WithResource_ReturnsFormattedString`: "Rage (0-100)"
        - `ToString_WithNone_ReturnsNoneString`: "None"

- **`SpecializationDefinitionTests`** (`Entities/SpecializationDefinitionTests.cs`) — 19 test methods
    - **Factory Method Tests (4 methods):**
        - `Create_WithValidParameters_CreatesDefinition`: Berserkr with Rage, full property verification
        - `Create_WithoutSpecialResource_DefaultsToNone`: Skald, HasSpecialResource is false
        - `Create_GeneratesUniqueId`: Two creates produce different GUIDs
        - `Create_TrimsWhitespaceFromStrings`: Padded strings trimmed
    - **Validation Tests (7 methods):**
        - `Create_WithNullDisplayName_ThrowsArgumentException`
        - `Create_WithWhitespaceTagline_ThrowsArgumentException`
        - `Create_WithNullDescription_ThrowsArgumentException`
        - `Create_WithNullSelectionText_ThrowsArgumentException`
        - `Create_WithNegativeUnlockCost_ThrowsArgumentOutOfRangeException`
        - `Create_WithMismatchedPathType_ThrowsArgumentException`: Berserkr with Coherent
        - `Create_WithMismatchedArchetype_ThrowsArgumentException`: Berserkr with Mystic
    - **Computed Property Tests (4 methods):**
        - `HasSpecialResource_WithResource_ReturnsTrue`: Berserkr with Rage
        - `HasSpecialResource_WithoutResource_ReturnsFalse`: Skald
        - `IsHeretical_ForHereticalSpec_ReturnsTrue`: Berserkr
        - `IsHeretical_ForCoherentSpec_ReturnsFalse`: Skjaldmaer
    - **Helper Method Tests (3 methods):**
        - `GetCorruptionWarning_ForHeretical_ReturnsWarningText`: Contains "Corruption"
        - `GetCorruptionWarning_ForCoherent_ReturnsNull`: Skjaldmaer returns null
        - `GetSelectionDisplay_ReturnsFormattedMultilineString`: Multi-line format verification
    - **Display Tests (1 method):**
        - `ToString_ReturnsFormattedString`: "Berserkr (Warrior, Heretical)"
    - **Test Helpers (3 methods):**
        - `CreateValidBerserkrDefinition()`: Heretical Warrior with Rage
        - `CreateValidSkaldDefinition()`: Coherent Adept without resource
        - `CreateValidSkjaldmaerDefinition()`: Coherent Warrior with Block Charges

### Glossary

- **`config/glossary.json`** — Added 2 glossary entries
    - `special-resource-definition`: Value object defining unique specialization resources with range, regen, and decay (sortOrder: 40)
    - `specialization-definition`: Entity defining specialization display metadata, path type, and special resource (sortOrder: 41)

---

## Changed

### Documentation

- **`docs/design/v0.17.x/v0.17.4-scope-breakdown.md`** — Checked off v0.17.4b unit test items
    - `[x] SpecializationDefinition loads from configuration`
    - `[x] Special resources initialize correctly`
    - `[x] Parent archetype correctly linked`

- **`docs/design/v0.17.x/v0.17.x-overview.md`** — Checked off v0.17.4 deliverable
    - `[x] SpecializationDefinition entity`

---

## Design Decisions

### Value Object: readonly record struct with init Properties

`SpecialResourceDefinition` uses `readonly record struct` with `init` properties per design specification Section 4.1. This differs from the `ArchetypeResourceBonuses` pattern (primary constructor params) but matches the explicit specification requirement. The `init` pattern provides the same immutability guarantees while allowing property-by-property initialization in the factory method.

### Entity: public class (not sealed)

`SpecializationDefinition` uses `public class` per the design specification rather than `sealed class` as used by `ArchetypeDefinition`. The specification was treated as authoritative since specialization definitions may need inheritance in future phases (e.g., for specialized subclasses).

### Cross-Validation in Factory Method

The `Create()` factory method validates that the provided `pathType` and `parentArchetype` match the values inherent to the `SpecializationId` enum (via extension methods from v0.17.4a). This prevents configuration mismatches where, for example, Berserkr could be incorrectly loaded as Coherent. The validation uses `ThrowIfNullOrWhiteSpace` for strings and throws `ArgumentException` with descriptive messages for mismatches.

### Logger Inclusion Despite Design Spec Omission

The design specification does not include `ILogger<T>?` parameters on the factory methods. However, the user explicitly requested "exhaustive logging" and the established codebase pattern (ArchetypeDefinition, ArchetypeResourceBonuses) includes logging. Both `Create()` methods include optional logger parameters with Debug-level pre/post-validation messages and Information-level creation confirmations.

### Nine Authored Definition Entries

The design specification provides complete text for 8 of 17 definition entries (Section 6.1). The remaining 9 entries (Veidimadr, MyrkGengr, Strandhogg, HlekkrMaster, BoneSetter, JotunReader, Skald, ScrapTinker, Einbui) were authored with lore-consistent content derived from the `SpecializationId.cs` XML documentation and the v0.17.4-scope-breakdown.md descriptions.

### Comprehensive Test Coverage

The design specification estimates ~3 tests for v0.17.4b. 33 test methods were implemented (14 + 19) for comprehensive coverage matching the established codebase test density from v0.17.3a/v0.17.3b/v0.17.4a. Test coverage includes factory creation, validation, cross-validation, computed properties, helper methods, and display formatting.

---

## Dependencies

### Prerequisites

| Type                              | Phase    | Usage                                           |
| --------------------------------- | -------- | ----------------------------------------------- |
| `SpecializationId`                | v0.17.4a | Primary enum identifier for definitions          |
| `SpecializationPathType`          | v0.17.4a | Path type classification on definitions          |
| `SpecializationIdExtensions`      | v0.17.4a | Cross-validation in factory method               |
| `SpecializationPathTypeExtensions`| v0.17.4a | Corruption warning generation                    |
| `Archetype`                       | v0.17.3a | Parent archetype property on definitions         |
| `IEntity`                         | Domain   | Interface for entity identification              |

### Provides to Future Phases

| Type                           | Phase    | Usage                                           |
| ------------------------------ | -------- | ----------------------------------------------- |
| `SpecializationDefinition`     | v0.17.4c | Links ability tiers to specialization            |
| `SpecializationDefinition`     | v0.17.4d | Provider loads and caches definitions            |
| `SpecialResourceDefinition`    | v0.17.4d | Provider maps resources to specializations       |
| `SpecializationDefinition`     | v0.17.4e | Application service uses for selection workflow  |
| `SpecialResourceDefinition`    | v0.17.4e | Application service initializes combat resources |

---

## Logging Strategy

| Level       | When                                                                 |
|-------------|----------------------------------------------------------------------|
| Debug       | Pre-validation parameter logging in factory methods                  |
| Debug       | Post-validation confirmation with validated parameter values         |
| Warning     | Path type or parent archetype mismatch detected (before exception)   |
| Information | Successful creation with all assigned property values                |

Both `SpecialResourceDefinition.Create()` and `SpecializationDefinition.Create()` accept an optional `ILogger<T>?` parameter. Logging follows the established pattern from `ArchetypeDefinition` and `ArchetypeResourceBonuses`.

---

## Files Created

| Path | Description |
|------|-------------|
| `src/Core/RuneAndRust.Domain/ValueObjects/SpecialResourceDefinition.cs` | Special resource value object with factory validation |
| `src/Core/RuneAndRust.Domain/Entities/SpecializationDefinition.cs` | Specialization definition entity with cross-validation |
| `tests/RuneAndRust.Domain.UnitTests/ValueObjects/SpecialResourceDefinitionTests.cs` | 14 test methods for special resource value object |
| `tests/RuneAndRust.Domain.UnitTests/Entities/SpecializationDefinitionTests.cs` | 19 test methods for specialization definition entity |
| `changelogs/v0.17.4b-changelog.md` | This changelog |

## Files Modified

| Path | Description |
|------|-------------|
| `config/specializations.json` | Added 17-entry `definitions` array with display metadata and special resources |
| `config/schemas/specializations.schema.json` | Added `definitionEntry` and `specialResourceEntry` schema definitions |
| `config/glossary.json` | Added 2 glossary entries (sortOrder 40-41) |
| `docs/design/v0.17.x/v0.17.4-scope-breakdown.md` | Checked off v0.17.4b deliverables |
| `docs/design/v0.17.x/v0.17.x-overview.md` | Updated v0.17.4 deliverable checkboxes |

---

## Notes

- Total unit tests for v0.17.4b: 33 test methods (14 SpecialResourceDefinition + 19 SpecializationDefinition)
- Total test suite after v0.17.4b: 3,624 tests (all passing, 0 regressions)
- Build: 0 errors, 0 warnings
- The design specification estimated ~3 tests; 33 methods were implemented for comprehensive coverage
- 5 of 17 specializations have special resources; 12 use `SpecialResourceDefinition.None`
- All 17 definitions have `unlockCost: 0` in configuration (the 3 PP cost for additional specializations is applied at runtime during character progression, not in the definition)
- Cross-validation ensures configuration cannot define a specialization with the wrong path type or parent archetype
- `SpecialResourceDefinition` normalizes `ResourceId` to lowercase for consistent key comparison
- `SpecializationDefinition` trims all string properties to prevent whitespace inconsistencies
- Display names preserve Old Norse diacritics (ð, ö, ú) from v0.17.4a
