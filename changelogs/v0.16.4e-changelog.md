# v0.16.4e Changelog — Container State Persistence

**Version:** 0.16.4e  
**Date:** 2026-01-29  
**Phase:** Container Loot Generation

---

## Summary

Implements the Container State Persistence repository interface for persisting container loot table states within a game run. This enables containers to remember their looted state, preventing exploitation through repeated looting.

---

## Added

### Application Layer

- **`IContainerStateRepository`** interface — Contract for container state persistence:
    - Methods:
        - `GetContainerAsync(containerId)` — Retrieves a container by ID
        - `GetContainersByRoomAsync(roomId)` — Retrieves all containers in a room
        - `SaveContainerAsync(container)` — Saves/updates a container (upsert)
        - `SaveContainersAsync(containers)` — Batch save for efficiency
        - `DeleteContainerAsync(containerId)` — Removes a container
        - `ResetAllContainersAsync()` — Clears all states for new run
        - `ExistsAsync(containerId)` — Checks container existence
        - `GetCountAsync()` — Returns total container count
        - `GetLootedContainersAsync()` — Returns only looted containers
    - Full XML documentation with examples and remarks
    - CancellationToken support for all async operations

### Unit Tests

- **`InMemoryContainerStateRepository`** test fake:
    - Dictionary-based storage for containers
    - Room index for efficient room-based queries
    - Complete interface implementation

- **`ContainerStateRepositoryTests`** abstract contract tests — 13 tests covering:
    - `SaveAndRetrieve_Container_PersistsState`
    - `GetContainerAsync_NonExistent_ReturnsNull`
    - `SaveContainerAsync_ExistingContainer_Updates`
    - `ResetAllContainers_ClearsAllState`
    - `ResetAllContainers_EmptyRepository_ReturnsZero`
    - `GetContainersByRoom_ReturnsOnlyRoomContainers`
    - `GetContainersByRoom_NoContainers_ReturnsEmptyList`
    - `DeleteContainerAsync_ExistingContainer_ReturnsTrueAndRemoves`
    - `DeleteContainerAsync_NonExistent_ReturnsFalse`
    - `ExistsAsync_ExistingContainer_ReturnsTrue`
    - `GetCountAsync_ReturnsCorrectCount`
    - `GetLootedContainersAsync_ReturnsOnlyLootedContainers`
    - `GetLootedContainersAsync_NoLootedContainers_ReturnsEmpty`

- **`InMemoryContainerStateRepositoryTests`** — Concrete test class

---

## Design Decisions

| Decision                | Rationale                                                   |
| ----------------------- | ----------------------------------------------------------- |
| Async methods           | Supports async I/O for future database implementations      |
| CancellationToken       | Allows operation cancellation in long-running operations    |
| Room-based queries      | Efficient container lookup when entering rooms              |
| Batch save operation    | Reduces overhead when initializing multiple room containers |
| Reset returns count     | Provides feedback on cleanup scope for logging/analytics    |
| Nullable return for Get | Clearly indicates missing containers without exceptions     |
| Abstract test class     | Enables same tests to run against different implementations |

---

## Dependencies

| Dependency | Description                      | Status      |
| ---------- | -------------------------------- | ----------- |
| v0.16.4b   | `ContainerLootTable` entity      | ✅ Complete |
| v0.16.4b   | `ContainerLootState` enum        | ✅ Complete |
| v0.16.4b   | `ContainerContents` value object | ✅ Complete |

---

## Provides To

| Consumer | Description                                         |
| -------- | --------------------------------------------------- |
| v0.16.4f | Room integration persists container discovery/loot  |
| Future   | Save/load system can persist containers to files    |
| Future   | Database implementation for larger game persistence |

---

## File Summary

| File                                  | Type       | Lines |
| ------------------------------------- | ---------- | ----- |
| `IContainerStateRepository.cs`        | Interface  | ~210  |
| `InMemoryContainerStateRepository.cs` | Test Fake  | ~155  |
| `ContainerStateRepositoryTests.cs`    | Unit Tests | ~300  |

---

## Verification

- **Build:** 0 errors, 0 warnings
- **Unit Tests:** 13/13 passed
- **Test Coverage:** All interface methods tested via contract tests
