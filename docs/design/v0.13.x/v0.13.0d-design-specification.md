# v0.13.0d Design Specification: Defense & Stance Display

**Version:** 0.13.0d
**Parent:** v0.13.0 (Combat UI)
**Prerequisites:** v0.12.1c Complete (Achievements & Leaderboards), v0.10.3x Complete (Defense Actions & Combat Stance)
**Status:** Design Complete
**Estimated Unit Tests:** ~6

---

## Table of Contents

1. [Executive Summary](#1-executive-summary)
2. [Feature Overview](#2-feature-overview)
3. [Architecture Diagrams](#3-architecture-diagrams)
4. [Defense Action Prompts Component](#4-defense-action-prompts-component)
   - 4.1 [DefenseActionPrompts Class](#41-defenseactionprompts-class)
   - 4.2 [Action Key Rendering](#42-action-key-rendering)
   - 4.3 [Incoming Attack Display](#43-incoming-attack-display)
5. [Defense Renderer](#5-defense-renderer)
   - 5.1 [DefenseRenderer Class](#51-defenserenderer-class)
   - 5.2 [Timing Bar Formatting](#52-timing-bar-formatting)
   - 5.3 [Result Color Mapping](#53-result-color-mapping)
6. [Reaction Window Display](#6-reaction-window-display)
   - 6.1 [Progress Bar Rendering](#61-progress-bar-rendering)
   - 6.2 [Urgency Indicators](#62-urgency-indicators)
7. [Defense Result Feedback](#7-defense-result-feedback)
   - 7.1 [Success Display](#71-success-display)
   - 7.2 [Failure Display](#72-failure-display)
   - 7.3 [Damage Reduction Summary](#73-damage-reduction-summary)
8. [Stance Indicator Component](#8-stance-indicator-component)
   - 8.1 [StanceIndicator Class](#81-stanceindicator-class)
   - 8.2 [Active Stance Display](#82-active-stance-display)
   - 8.3 [Modifier Summary Rendering](#83-modifier-summary-rendering)
9. [Stance Renderer](#9-stance-renderer)
   - 9.1 [StanceRenderer Class](#91-stancerenderer-class)
   - 9.2 [Stance Icon Mapping](#92-stance-icon-mapping)
   - 9.3 [Modifier Formatting](#93-modifier-formatting)
10. [Stance Switch Feedback](#10-stance-switch-feedback)
    - 10.1 [Transition Animation](#101-transition-animation)
    - 10.2 [Before/After Comparison](#102-beforeafter-comparison)
11. [Data Model Changes](#11-data-model-changes)
12. [Configuration File Schemas](#12-configuration-file-schemas)
13. [CombatView Integration](#13-combatview-integration)
14. [Logging Specifications](#14-logging-specifications)
15. [Unit Testing Requirements](#15-unit-testing-requirements)
16. [Use Cases](#16-use-cases)
17. [Deliverable Checklist](#17-deliverable-checklist)
18. [Acceptance Criteria](#18-acceptance-criteria)
19. [Dependencies](#19-dependencies)
20. [Future Considerations](#20-future-considerations)

---

## 1. Executive Summary

This version implements the visual presentation layer for defense actions and combat stances in combat. The defense action and combat stance logic was implemented in v0.10.3x; this version adds the UI components to display defense prompts with reaction timing, defense results, active stances, and stance switch feedback during combat. Players will see available defensive actions when attacked, timing windows for reactions, success/failure feedback, and their current combat stance with active modifiers.

### Key Deliverables

| Category | Items |
|----------|-------|
| **UI Components** | `DefenseActionPrompts`, `StanceIndicator` |
| **Renderers** | `DefenseRenderer`, `StanceRenderer` |
| **DTOs** | `DefensePromptDto`, `DefenseResultDto`, `StanceDisplayDto`, `StanceSwitchDto` |
| **View Updates** | `CombatView` integration |
| **Configuration** | `defense-display.json`, `stance-display.json` |
| **Tests** | ~6 unit tests |

### Architectural Significance

This version completes the **Combat UI Component Pattern** established in v0.13.0a by implementing the final two UI component pairs:
- Defense prompts with real-time timing feedback
- Stance indicators with modifier summaries
- Event-driven updates for defense and stance changes
- Configuration-driven visual appearance

---

## 2. Feature Overview

```
v0.13.0d Features
├── DefenseActionPrompts (UI Component)
│   ├── ShowPrompts(actions)
│   ├── RenderTimingWindow(elapsed, total)
│   ├── ShowResult(result)
│   └── HidePrompts()
│
├── DefenseRenderer (Renderer)
│   ├── GetActionKey(action)
│   ├── FormatTimingBar(percent)
│   ├── GetResultColor(result)
│   ├── FormatDamageReduction(original, reduced)
│   └── GetActionDescription(action)
│
├── StanceIndicator (UI Component)
│   ├── RenderStance(stance)
│   ├── ShowModifiers(modifiers)
│   ├── AnimateSwitch(from, to)
│   └── Clear()
│
├── StanceRenderer (Renderer)
│   ├── GetStanceIcon(stance)
│   ├── FormatModifier(modifier)
│   ├── GetStanceColor(stance)
│   └── FormatSwitchComparison(from, to)
│
├── Reaction Window Display
│   ├── Progress Bar Rendering
│   ├── Urgency Color Changes
│   └── Timeout Handling
│
├── Defense Result Feedback
│   ├── Success Notification
│   ├── Failure Notification
│   └── Damage Summary
│
├── Stance Switch Feedback
│   ├── Transition Display
│   └── Before/After Comparison
│
└── CombatView Integration
    ├── Defense Panel Placement
    ├── Stance Header Display
    └── Event-Driven Updates
```

### Scope Verification

| Feature | Source | Included |
|---------|--------|----------|
| Block/Dodge/Parry Prompts | v0.13.0-scope-breakdown.md | Yes |
| Reaction Window | v0.13.0-scope-breakdown.md | Yes |
| Defense Result Feedback | v0.13.0-scope-breakdown.md | Yes |
| Active Stance Indicator | v0.13.0-scope-breakdown.md | Yes |
| Stance Modifier Summary | v0.13.0-scope-breakdown.md | Yes |
| Stance Switch Animation | v0.13.0-scope-breakdown.md | Yes |
| Status Effect Display | v0.13.0-scope-breakdown.md | No (v0.13.0a) |
| AoE Zone Overlay | v0.13.0-scope-breakdown.md | No (v0.13.0b) |
| Combo Chain Indicator | v0.13.0-scope-breakdown.md | No (v0.13.0c) |

---

## 3. Architecture Diagrams

### 3.1 Layer Diagram

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                          PRESENTATION LAYER                                  │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  ┌─────────────────────────┐      ┌─────────────────────────┐               │
│  │     CombatView          │      │  DefenseActionPrompts   │               │
│  │     (existing)          │◄────▶│  (NEW)                  │               │
│  ├─────────────────────────┤      ├─────────────────────────┤               │
│  │ - RenderCombatState()   │      │ - ShowPrompts()         │               │
│  │ - OnIncomingAttack()    │      │ - RenderTimingWindow()  │               │
│  │ - IntegrateComponents() │      │ - ShowResult()          │               │
│  └─────────────────────────┘      │ - HidePrompts()         │               │
│           │                        └───────────┬─────────────┘               │
│           │                                    │                             │
│           │  ┌─────────────────────────┐       │                             │
│           │  │    DefenseRenderer      │◄──────┘                             │
│           │  │    (NEW)                │                                     │
│           │  ├─────────────────────────┤                                     │
│           │  │ - GetActionKey()        │                                     │
│           │  │ - FormatTimingBar()     │                                     │
│           │  │ - GetResultColor()      │                                     │
│           │  └─────────────────────────┘                                     │
│           │                                                                  │
│           │  ┌─────────────────────────┐      ┌─────────────────────────┐   │
│           └─▶│    StanceIndicator      │      │    StanceRenderer       │   │
│              │    (NEW)                │─────▶│    (NEW)                │   │
│              ├─────────────────────────┤      ├─────────────────────────┤   │
│              │ - RenderStance()        │      │ - GetStanceIcon()       │   │
│              │ - ShowModifiers()       │      │ - FormatModifier()      │   │
│              │ - AnimateSwitch()       │      │ - GetStanceColor()      │   │
│              └─────────────────────────┘      └─────────────────────────┘   │
│                                                                              │
└──────────────────────────────────────────────────────────────────────────────┘
                                        │
                                        ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                          APPLICATION LAYER                                   │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │                 IDefenseActionService (existing v0.10.3)            │    │
│  ├─────────────────────────────────────────────────────────────────────┤    │
│  │ + GetAvailableActions(combatant) : IReadOnlyList<DefenseAction>    │    │
│  │ + GetReactionWindow(combatant) : ReactionWindow                     │    │
│  │ + ExecuteDefense(combatant, actionId, attack) : DefenseResult       │    │
│  │ + CanDefend(combatant) : bool                                       │    │
│  │ + GetDefaultAction(combatant) : DefenseAction?                      │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
│                                                                              │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │                 ICombatStanceService (existing v0.10.3)             │    │
│  ├─────────────────────────────────────────────────────────────────────┤    │
│  │ + GetActiveStance(combatant) : CombatStance?                        │    │
│  │ + GetAvailableStances(combatant) : IReadOnlyList<CombatStance>      │    │
│  │ + SwitchStance(combatant, stanceId) : StanceSwitchResult            │    │
│  │ + GetStanceModifiers(combatant) : IReadOnlyList<StatModifier>       │    │
│  │ + HasActiveStance(combatant) : bool                                 │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
│                                                                              │
└──────────────────────────────────────────────────────────────────────────────┘
                                        │
                                        ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                            DOMAIN LAYER                                      │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  ┌─────────────────────────┐      ┌─────────────────────────┐               │
│  │    DefenseAction        │      │    DefenseResult        │               │
│  │    (existing v0.10.3)   │      │    (existing v0.10.3)   │               │
│  ├─────────────────────────┤      ├─────────────────────────┤               │
│  │ + ActionId: string      │      │ + Success: bool         │               │
│  │ + Name: string          │      │ + ActionUsed: string    │               │
│  │ + Description: string   │      │ + OriginalDamage: int   │               │
│  │ + ActionType: DefenseType│     │ + ReducedDamage: int    │               │
│  │ + DamageReduction: float│      │ + Message: string       │               │
│  │ + SuccessChance: float  │      │ + BonusEffects: List<>  │               │
│  │ + StaminaCost: int      │      └─────────────────────────┘               │
│  │ + CooldownTurns: int    │                                                 │
│  │ + RequiresShield: bool  │                                                 │
│  └─────────────────────────┘                                                 │
│                                                                              │
│  ┌─────────────────────────┐      ┌─────────────────────────┐               │
│  │    CombatStance         │      │    StatModifier         │               │
│  │    (existing v0.10.3)   │      │    (existing v0.10.3)   │               │
│  ├─────────────────────────┤      ├─────────────────────────┤               │
│  │ + StanceId: string      │      │ + StatType: StatType    │               │
│  │ + Name: string          │      │ + ModifierType: ModType │               │
│  │ + Description: string   │      │ + Value: int            │               │
│  │ + Category: StanceCat.  │      │ + IsPositive: bool      │               │
│  │ + Modifiers: List<>     │      │ + ToDisplayString()     │               │
│  │ + IconPath: string?     │      └─────────────────────────┘               │
│  │ + SwitchCost: int       │                                                 │
│  └─────────────────────────┘                                                 │
│                                                                              │
│  ┌─────────────────────────┐      ┌─────────────────────────┐               │
│  │    DefenseType          │      │    StanceCategory       │               │
│  │    (existing v0.10.3)   │      │    (existing v0.10.3)   │               │
│  ├─────────────────────────┤      ├─────────────────────────┤               │
│  │ - Block                 │      │ - Aggressive            │               │
│  │ - Dodge                 │      │ - Defensive             │               │
│  │ - Parry                 │      │ - Balanced              │               │
│  │ - Counter               │      │ - Tactical              │               │
│  └─────────────────────────┘      │ - Special               │               │
│                                    └─────────────────────────┘               │
│                                                                              │
│  ┌─────────────────────────┐                                                 │
│  │    ReactionWindow       │                                                 │
│  │    (existing v0.10.3)   │                                                 │
│  ├─────────────────────────┤                                                 │
│  │ + TotalDuration: TimeSpan│                                                │
│  │ + ElapsedTime: TimeSpan  │                                                │
│  │ + RemainingTime: TimeSpan│                                                │
│  │ + ProgressPercent: float │                                                │
│  │ + IsExpired: bool        │                                                │
│  └─────────────────────────┘                                                 │
│                                                                              │
└──────────────────────────────────────────────────────────────────────────────┘
```

### 3.2 Defense Action Data Flow

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                    DEFENSE ACTION DISPLAY DATA FLOW                          │
└─────────────────────────────────────────────────────────────────────────────┘

    Incoming Attack Event
           │
           ▼
┌─────────────────────────┐
│      CombatView         │
│  OnIncomingAttack()     │
└───────────┬─────────────┘
            │
            │ 1. Get available defense actions
            ▼
┌─────────────────────────┐
│  IDefenseActionService  │
│  GetAvailableActions()  │
│  GetReactionWindow()    │
└───────────┬─────────────┘
            │
            │ 2. Returns List<DefenseAction>, ReactionWindow
            ▼
┌─────────────────────────┐
│  DefenseActionPrompts   │
│                         │
│  ┌───────────────────┐  │
│  │ MapToPromptDto()  │  │ 3. Transform to DTOs
│  └─────────┬─────────┘  │
│            │            │
│            ▼            │
│  ┌───────────────────┐  │
│  │ ShowPrompts()     │  │ 4. Display action options
│  └─────────┬─────────┘  │
│            │            │
│            ▼            │
│  ┌───────────────────┐  │
│  │ RenderTimingWindow│  │ 5. Start timing bar
│  └─────────┬─────────┘  │    (updates each frame)
└────────────┼────────────┘
             │
             │ 6. Call renderer for display
             ▼
┌─────────────────────────┐
│    DefenseRenderer      │
├─────────────────────────┤
│ - GetActionKey()        │ 7. Map action → key ([B], [D], [P])
│ - FormatTimingBar()     │ 8. Format progress bar
│ - GetActionDescription()│ 9. Format action description
└───────────┬─────────────┘
            │
            │ 10. Formatted display output
            ▼
┌─────────────────────────┐
│    ITerminalService     │
│    Write() output       │
└─────────────────────────┘


        Player Defense Selection / Window Expires
               │
               ▼
┌─────────────────────────────────────────────────────────────────┐
│                    DEFENSE RESULT FLOW                           │
└─────────────────────────────────────────────────────────────────┘
               │
               │ Player presses defense key OR window expires
               ▼
┌─────────────────────────┐
│  IDefenseActionService  │
│  ExecuteDefense()       │
└───────────┬─────────────┘
            │
            │ 1. Returns DefenseResult
            ▼
┌─────────────────────────┐
│  DefenseActionPrompts   │
│  ShowResult()           │
└───────────┬─────────────┘
            │
            │ 2. Display result notification
            ▼
┌─────────────────────────┐
│    DefenseRenderer      │
│ - GetResultColor()      │
│ - FormatDamageReduction()│
└───────────┬─────────────┘
            │
            │ 3. Formatted result output
            ▼
┌─────────────────────────┐
│    ITerminalService     │
│    Write() output       │
└─────────────────────────┘
```

### 3.3 Stance Display Data Flow

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                    STANCE DISPLAY DATA FLOW                                  │
└─────────────────────────────────────────────────────────────────────────────┘

    Combat Turn Start / Stance Changed
           │
           ▼
┌─────────────────────────┐
│      CombatView         │
│  RefreshStanceDisplay() │
└───────────┬─────────────┘
            │
            │ 1. Get active stance and modifiers
            ▼
┌─────────────────────────┐
│  ICombatStanceService   │
│  GetActiveStance()      │
│  GetStanceModifiers()   │
└───────────┬─────────────┘
            │
            │ 2. Returns CombatStance, List<StatModifier>
            ▼
┌─────────────────────────┐
│    StanceIndicator      │
│                         │
│  ┌───────────────────┐  │
│  │ MapToDisplayDto() │  │ 3. Transform to DTO
│  └─────────┬─────────┘  │
│            │            │
│            ▼            │
│  ┌───────────────────┐  │
│  │ RenderStance()    │  │ 4. Display stance header
│  └─────────┬─────────┘  │
│            │            │
│            ▼            │
│  ┌───────────────────┐  │
│  │ ShowModifiers()   │  │ 5. Display modifier list
│  └─────────┬─────────┘  │
└────────────┼────────────┘
             │
             │ 6. Call renderer for formatting
             ▼
┌─────────────────────────┐
│     StanceRenderer      │
├─────────────────────────┤
│ - GetStanceIcon()       │ 7. Map stance → icon
│ - GetStanceColor()      │ 8. Map category → color
│ - FormatModifier()      │ 9. Format "+/-# Stat"
└───────────┬─────────────┘
            │
            │ 10. Formatted display output
            ▼
┌─────────────────────────┐
│    ITerminalService     │
│    Write() output       │
└─────────────────────────┘


        Player Switches Stance
               │
               ▼
┌─────────────────────────────────────────────────────────────────┐
│                    STANCE SWITCH FLOW                            │
└─────────────────────────────────────────────────────────────────┘
               │
               │ Player requests stance change
               ▼
┌─────────────────────────┐
│  ICombatStanceService   │
│  SwitchStance()         │
└───────────┬─────────────┘
            │
            │ 1. Returns StanceSwitchResult
            ▼
┌─────────────────────────┐
│    StanceIndicator      │
│  AnimateSwitch()        │
└───────────┬─────────────┘
            │
            │ 2. Display transition comparison
            ▼
┌─────────────────────────┐
│     StanceRenderer      │
│ - FormatSwitchComparison()│
└───────────┬─────────────┘
            │
            │ 3. Formatted comparison output
            ▼
┌─────────────────────────┐
│    ITerminalService     │
│    Write() output       │
└─────────────────────────┘
```

### 3.4 Component Interaction Diagram

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                    DEFENSE & STANCE UI COMPONENT LAYOUT                      │
└─────────────────────────────────────────────────────────────────────────────┘

┌───────────────────────────────────────────────────────────────────────────┐
│                              COMBAT VIEW                                   │
├───────────────────────────────────────────────────────────────────────────┤
│  ┌─────────────────────────────────────────────────────────────────────┐  │
│  │ [Aggressive Stance]  +2 Attack  -1 Defense  +10% Critical           │  │
│  └─────────────────────────────────────────────────────────────────────┘  │
│                           STANCE HEADER                                    │
├───────────────────────┬─────────────────────────┬───────────────────────┤
│                       │                         │                       │
│    COMBAT GRID        │    ACTION PANEL         │    STATUS PANEL       │
│                       │                         │                       │
│    [Grid display]     │                         │    [Combatant stats]  │
│                       │                         │                       │
│                       │                         │    [Status effects]   │
│                       │                         │                       │
│                       │                         │    [Equipment]        │
│                       │                         │                       │
└───────────────────────┴─────────────────────────┴───────────────────────┘
│                                                                           │
│  ┌─────────────────────────────────────────────────────────────────────┐  │
│  │ INCOMING ATTACK: Goblin Slash (12 damage)                          │  │
│  │                                                                     │  │
│  │ DEFENSE OPTIONS: [B]lock  [D]odge  [P]arry                         │  │
│  │ ────────────────────────────────────────────                       │  │
│  │ Reaction Window: [========..] 0.8s remaining                       │  │
│  └─────────────────────────────────────────────────────────────────────┘  │
│                           DEFENSE PROMPT (shown during attacks)            │
└───────────────────────────────────────────────────────────────────────────┘
```

---

## 4. Defense Action Prompts Component

### 4.1 DefenseActionPrompts Class

**Purpose:** Renders defense action options when the player is attacked, shows the reaction timing window, and displays defense results.

**File:** `src/Presentation/RuneAndRust.Presentation.Tui/UI/DefenseActionPrompts.cs`

```csharp
using RuneAndRust.Application.DTOs;
using RuneAndRust.Application.Interfaces;
using RuneAndRust.Domain.Entities;
using RuneAndRust.Presentation.Tui.Services;
using Microsoft.Extensions.Logging;

namespace RuneAndRust.Presentation.Tui.UI;

/// <summary>
/// UI component for displaying defense action options, reaction timing window,
/// and defense result feedback during incoming attacks.
/// </summary>
/// <remarks>
/// Follows the Combat UI Component Pattern established in v0.13.0a.
/// Receives data from IDefenseActionService via DTOs and delegates rendering to DefenseRenderer.
/// </remarks>
public class DefenseActionPrompts
{
    private readonly IDefenseActionService _defenseService;
    private readonly DefenseRenderer _renderer;
    private readonly ITerminalService _terminal;
    private readonly ILogger<DefenseActionPrompts> _logger;

    private IReadOnlyList<DefensePromptDto> _currentPrompts = [];
    private ReactionWindowDto? _currentWindow;
    private bool _isVisible;

    /// <summary>
    /// Creates a new DefenseActionPrompts instance.
    /// </summary>
    /// <param name="defenseService">Service for retrieving defense actions.</param>
    /// <param name="renderer">Renderer for defense display elements.</param>
    /// <param name="terminal">Terminal service for output.</param>
    /// <param name="logger">Logger for diagnostics.</param>
    public DefenseActionPrompts(
        IDefenseActionService defenseService,
        DefenseRenderer renderer,
        ITerminalService terminal,
        ILogger<DefenseActionPrompts> logger)
    {
        _defenseService = defenseService;
        _renderer = renderer;
        _terminal = terminal;
        _logger = logger;
    }

    /// <summary>
    /// Gets whether the defense prompts are currently visible.
    /// </summary>
    public bool IsVisible => _isVisible;

    /// <summary>
    /// Shows defense action prompts for an incoming attack.
    /// </summary>
    /// <param name="combatant">The defending combatant.</param>
    /// <param name="incomingAttack">Information about the incoming attack.</param>
    public void ShowPrompts(ICombatant combatant, IncomingAttackDto incomingAttack)
    {
        var actions = _defenseService.GetAvailableActions(combatant);
        var window = _defenseService.GetReactionWindow(combatant);

        _currentPrompts = actions
            .Select(a => MapToPromptDto(a))
            .ToList();

        _currentWindow = new ReactionWindowDto(
            TotalDuration: window.TotalDuration,
            RemainingTime: window.RemainingTime,
            ProgressPercent: window.ProgressPercent);

        _isVisible = true;

        RenderIncomingAttack(incomingAttack);
        RenderActionOptions();
        RenderTimingWindow();

        _logger.LogDebug(
            "Displayed {ActionCount} defense options for combatant {CombatantId}",
            _currentPrompts.Count,
            combatant.Id);
    }

    /// <summary>
    /// Updates the reaction timing window display.
    /// </summary>
    /// <param name="elapsed">Time elapsed since attack started.</param>
    /// <param name="total">Total reaction window duration.</param>
    public void RenderTimingWindow(TimeSpan elapsed, TimeSpan total)
    {
        if (!_isVisible || _currentWindow is null)
        {
            return;
        }

        var remaining = total - elapsed;
        var percent = remaining.TotalMilliseconds / total.TotalMilliseconds;

        _currentWindow = _currentWindow with
        {
            RemainingTime = remaining,
            ProgressPercent = (float)percent
        };

        RenderTimingWindow();
    }

    /// <summary>
    /// Shows the defense result after player action or window expiration.
    /// </summary>
    /// <param name="result">The defense result to display.</param>
    public void ShowResult(DefenseResult result)
    {
        var resultDto = MapToResultDto(result);
        RenderResult(resultDto);

        _logger.LogInformation(
            "Defense {Result}: {Action} - Damage {Original} -> {Reduced}",
            result.Success ? "SUCCESS" : "FAILED",
            result.ActionUsed,
            result.OriginalDamage,
            result.ReducedDamage);
    }

    /// <summary>
    /// Hides the defense prompts display.
    /// </summary>
    public void HidePrompts()
    {
        _isVisible = false;
        _currentPrompts = [];
        _currentWindow = null;
    }

    private DefensePromptDto MapToPromptDto(DefenseAction action)
    {
        return new DefensePromptDto(
            ActionId: action.ActionId,
            ActionName: action.Name,
            ActionKey: _renderer.GetActionKey(action),
            Description: action.Description,
            DamageReduction: action.DamageReduction,
            SuccessChance: action.SuccessChance,
            StaminaCost: action.StaminaCost,
            IsAvailable: true,
            RequiresShield: action.RequiresShield);
    }

    private DefenseResultDto MapToResultDto(DefenseResult result)
    {
        return new DefenseResultDto(
            Success: result.Success,
            ActionUsed: result.ActionUsed,
            OriginalDamage: result.OriginalDamage,
            ReducedDamage: result.ReducedDamage,
            DamageReduced: result.OriginalDamage - result.ReducedDamage,
            Message: result.Message,
            BonusEffects: result.BonusEffects?.ToList() ?? []);
    }

    private void RenderIncomingAttack(IncomingAttackDto attack)
    {
        var header = _renderer.FormatIncomingAttack(attack);
        _terminal.WriteLine("");
        _terminal.WriteLineWithColor(header, _renderer.GetAttackHeaderColor());
    }

    private void RenderActionOptions()
    {
        _terminal.WriteLine("");
        var optionsLine = string.Join("  ",
            _currentPrompts.Select(p => $"[{p.ActionKey}]{p.ActionName.ToLower()}"));

        _terminal.Write("DEFENSE OPTIONS: ");
        _terminal.WriteLine(optionsLine);
        _terminal.WriteLine(new string('─', 44));
    }

    private void RenderTimingWindow()
    {
        if (_currentWindow is null)
        {
            return;
        }

        var bar = _renderer.FormatTimingBar(_currentWindow.ProgressPercent);
        var remaining = _currentWindow.RemainingTime.TotalSeconds;
        var color = _renderer.GetTimingBarColor(_currentWindow.ProgressPercent);

        _terminal.Write("Reaction Window: ");
        _terminal.WriteWithColor(bar, color);
        _terminal.WriteLine($" {remaining:F1}s remaining");
    }

    private void RenderResult(DefenseResultDto result)
    {
        _terminal.WriteLine("");

        var resultMessage = result.Success
            ? $"{result.ActionUsed.ToUpper()} SUCCESS!"
            : $"{result.ActionUsed.ToUpper()} FAILED!";

        var color = _renderer.GetResultColor(result.Success);
        _terminal.WriteLineWithColor(resultMessage, color);

        // Show damage reduction
        var reductionLine = _renderer.FormatDamageReduction(
            result.OriginalDamage,
            result.ReducedDamage);
        _terminal.WriteLine($"  {reductionLine}");

        // Show any bonus effects
        foreach (var effect in result.BonusEffects)
        {
            _terminal.WriteLine($"  {effect}");
        }
    }
}
```

### 4.2 Action Key Rendering

**Purpose:** Maps defense actions to keyboard shortcuts.

#### Key Mapping

| Defense Type | Key | Display |
|--------------|-----|---------|
| Block | B | `[B]lock` |
| Dodge | D | `[D]odge` |
| Parry | P | `[P]arry` |
| Counter | C | `[C]ounter` |

```csharp
// In DefenseRenderer:
public char GetActionKey(DefenseAction action)
{
    return action.ActionType switch
    {
        DefenseType.Block => 'B',
        DefenseType.Dodge => 'D',
        DefenseType.Parry => 'P',
        DefenseType.Counter => 'C',
        _ => action.Name[0]
    };
}
```

### 4.3 Incoming Attack Display

**Purpose:** Shows information about the attack the player must defend against.

#### Display Format

```
INCOMING ATTACK: Goblin Slash (12 damage)
```

---

## 5. Defense Renderer

### 5.1 DefenseRenderer Class

**Purpose:** Handles all formatting and color mapping for defense display elements.

**File:** `src/Presentation/RuneAndRust.Presentation.Tui/Rendering/DefenseRenderer.cs`

```csharp
using RuneAndRust.Application.DTOs;
using RuneAndRust.Domain.Entities;
using RuneAndRust.Presentation.Tui.Configuration;
using Microsoft.Extensions.Options;

namespace RuneAndRust.Presentation.Tui.Rendering;

/// <summary>
/// Renderer for defense action display elements including timing bars,
/// action keys, and result formatting.
/// </summary>
/// <remarks>
/// Follows the Combat UI Component Pattern established in v0.13.0a.
/// All visual configuration is driven by defense-display.json.
/// </remarks>
public class DefenseRenderer
{
    private readonly DefenseDisplayConfiguration _config;

    /// <summary>
    /// Creates a new DefenseRenderer with the specified configuration.
    /// </summary>
    /// <param name="config">Configuration options for defense display.</param>
    public DefenseRenderer(IOptions<DefenseDisplayConfiguration> config)
    {
        _config = config.Value;
    }

    /// <summary>
    /// Gets the keyboard key for a defense action.
    /// </summary>
    /// <param name="action">The defense action.</param>
    /// <returns>The key character for this action.</returns>
    public char GetActionKey(DefenseAction action)
    {
        return action.ActionType switch
        {
            DefenseType.Block => _config.ActionKeys.Block,
            DefenseType.Dodge => _config.ActionKeys.Dodge,
            DefenseType.Parry => _config.ActionKeys.Parry,
            DefenseType.Counter => _config.ActionKeys.Counter,
            _ => char.ToUpper(action.Name[0])
        };
    }

    /// <summary>
    /// Formats the reaction timing bar.
    /// </summary>
    /// <param name="progressPercent">Progress as percentage (0.0-1.0).</param>
    /// <returns>Formatted timing bar string.</returns>
    public string FormatTimingBar(float progressPercent)
    {
        var totalWidth = _config.TimingBarWidth;
        var filledWidth = (int)(totalWidth * progressPercent);
        var emptyWidth = totalWidth - filledWidth;

        var filled = new string(_config.Symbols.TimingBarFilled, filledWidth);
        var empty = new string(_config.Symbols.TimingBarEmpty, emptyWidth);

        return $"[{filled}{empty}]";
    }

    /// <summary>
    /// Gets the color for the timing bar based on remaining time.
    /// </summary>
    /// <param name="progressPercent">Progress as percentage (0.0-1.0).</param>
    /// <returns>Console color for the timing bar.</returns>
    public ConsoleColor GetTimingBarColor(float progressPercent)
    {
        return progressPercent switch
        {
            <= 0.25f => _config.Colors.TimingCritical,
            <= 0.50f => _config.Colors.TimingWarning,
            _ => _config.Colors.TimingNormal
        };
    }

    /// <summary>
    /// Gets the color for defense result display.
    /// </summary>
    /// <param name="success">Whether the defense succeeded.</param>
    /// <returns>Console color for the result.</returns>
    public ConsoleColor GetResultColor(bool success)
    {
        return success
            ? _config.Colors.DefenseSuccess
            : _config.Colors.DefenseFailure;
    }

    /// <summary>
    /// Formats the damage reduction display.
    /// </summary>
    /// <param name="originalDamage">Original incoming damage.</param>
    /// <param name="reducedDamage">Damage after reduction.</param>
    /// <returns>Formatted damage reduction string.</returns>
    public string FormatDamageReduction(int originalDamage, int reducedDamage)
    {
        var reduction = originalDamage - reducedDamage;
        return $"Damage reduced: {originalDamage} → {reducedDamage} (-{reduction})";
    }

    /// <summary>
    /// Formats the incoming attack header.
    /// </summary>
    /// <param name="attack">The incoming attack information.</param>
    /// <returns>Formatted attack header string.</returns>
    public string FormatIncomingAttack(IncomingAttackDto attack)
    {
        return $"INCOMING ATTACK: {attack.AttackerName} {attack.AttackName} ({attack.Damage} damage)";
    }

    /// <summary>
    /// Gets the color for the incoming attack header.
    /// </summary>
    /// <returns>Console color for attack header.</returns>
    public ConsoleColor GetAttackHeaderColor()
    {
        return _config.Colors.IncomingAttack;
    }

    /// <summary>
    /// Gets the description for a defense action.
    /// </summary>
    /// <param name="action">The defense action.</param>
    /// <returns>Formatted action description.</returns>
    public string GetActionDescription(DefenseAction action)
    {
        var reductionPercent = (int)(action.DamageReduction * 100);
        var successPercent = (int)(action.SuccessChance * 100);
        return $"{action.Name}: {reductionPercent}% reduction, {successPercent}% success";
    }
}
```

### 5.2 Timing Bar Formatting

#### Format Pattern

```
[========..] 0.8s remaining
```

| Progress | Display | Color |
|----------|---------|-------|
| 75-100% | `[========..]` | Green |
| 50-74% | `[======....]` | Yellow |
| 25-49% | `[====......]` | Yellow |
| 0-24% | `[==........]` | Red |

### 5.3 Result Color Mapping

| Result | Color | Display |
|--------|-------|---------|
| Success | Green | `BLOCK SUCCESS!` |
| Failure | Red | `BLOCK FAILED!` |

---

## 6. Reaction Window Display

### 6.1 Progress Bar Rendering

**Purpose:** Shows the remaining time to select a defense action.

#### Display Format

```
Reaction Window: [========..] 0.8s remaining
```

#### Progress Bar Configuration

| Setting | Default | Description |
|---------|---------|-------------|
| Width | 10 | Number of characters in bar |
| Filled Char | `=` | Character for elapsed time |
| Empty Char | `.` | Character for remaining time |

### 6.2 Urgency Indicators

**Purpose:** Changes the timing bar color as time runs out.

| Time Remaining | Color | Meaning |
|----------------|-------|---------|
| >50% | Green | Plenty of time |
| 25-50% | Yellow | Time running low |
| <25% | Red | Act now! |

---

## 7. Defense Result Feedback

### 7.1 Success Display

**Purpose:** Shows positive feedback when defense succeeds.

#### Display Format

```
BLOCK SUCCESS!
  Damage reduced: 12 → 4 (-8)
  Shield durability: -1
```

### 7.2 Failure Display

**Purpose:** Shows feedback when defense fails.

#### Display Format

```
DODGE FAILED!
  Damage reduced: 12 → 12 (-0)
  You take full damage!
```

### 7.3 Damage Reduction Summary

**Purpose:** Shows the damage mitigation calculation.

```csharp
// Format: "Damage reduced: {original} → {reduced} (-{reduction})"
public string FormatDamageReduction(int originalDamage, int reducedDamage)
{
    var reduction = originalDamage - reducedDamage;
    return $"Damage reduced: {originalDamage} → {reducedDamage} (-{reduction})";
}
```

---

## 8. Stance Indicator Component

### 8.1 StanceIndicator Class

**Purpose:** Renders the current combat stance and its active modifiers.

**File:** `src/Presentation/RuneAndRust.Presentation.Tui/UI/StanceIndicator.cs`

```csharp
using RuneAndRust.Application.DTOs;
using RuneAndRust.Application.Interfaces;
using RuneAndRust.Domain.Entities;
using RuneAndRust.Presentation.Tui.Services;
using Microsoft.Extensions.Logging;

namespace RuneAndRust.Presentation.Tui.UI;

/// <summary>
/// UI component for displaying the active combat stance, modifier summary,
/// and stance switch transition feedback.
/// </summary>
/// <remarks>
/// Follows the Combat UI Component Pattern established in v0.13.0a.
/// Receives data from ICombatStanceService via DTOs and delegates rendering to StanceRenderer.
/// </remarks>
public class StanceIndicator
{
    private readonly ICombatStanceService _stanceService;
    private readonly StanceRenderer _renderer;
    private readonly ITerminalService _terminal;
    private readonly ILogger<StanceIndicator> _logger;

    private StanceDisplayDto? _currentStance;

    /// <summary>
    /// Creates a new StanceIndicator instance.
    /// </summary>
    /// <param name="stanceService">Service for retrieving stance information.</param>
    /// <param name="renderer">Renderer for stance display elements.</param>
    /// <param name="terminal">Terminal service for output.</param>
    /// <param name="logger">Logger for diagnostics.</param>
    public StanceIndicator(
        ICombatStanceService stanceService,
        StanceRenderer renderer,
        ITerminalService terminal,
        ILogger<StanceIndicator> logger)
    {
        _stanceService = stanceService;
        _renderer = renderer;
        _terminal = terminal;
        _logger = logger;
    }

    /// <summary>
    /// Renders the current stance for a combatant.
    /// </summary>
    /// <param name="combatant">The combatant to display stance for.</param>
    public void RenderStance(ICombatant combatant)
    {
        var stance = _stanceService.GetActiveStance(combatant);
        if (stance is null)
        {
            _currentStance = null;
            return;
        }

        var modifiers = _stanceService.GetStanceModifiers(combatant);
        _currentStance = MapToDisplayDto(stance, modifiers);

        RenderStanceHeader();
        RenderModifiers();

        _logger.LogDebug(
            "Rendered stance '{StanceName}' for combatant {CombatantId}",
            stance.Name,
            combatant.Id);
    }

    /// <summary>
    /// Shows the modifier summary for the current stance.
    /// </summary>
    /// <param name="modifiers">The stat modifiers to display.</param>
    public void ShowModifiers(IReadOnlyList<StatModifier> modifiers)
    {
        if (_currentStance is null)
        {
            return;
        }

        var modifierDtos = modifiers
            .Select(m => MapModifierToDto(m))
            .ToList();

        _currentStance = _currentStance with { Modifiers = modifierDtos };
        RenderModifiers();
    }

    /// <summary>
    /// Displays the stance switch transition with before/after comparison.
    /// </summary>
    /// <param name="fromStance">The previous stance.</param>
    /// <param name="toStance">The new stance.</param>
    public void AnimateSwitch(CombatStance fromStance, CombatStance toStance)
    {
        var switchDto = new StanceSwitchDto(
            FromStanceName: fromStance.Name,
            ToStanceName: toStance.Name,
            FromModifiers: fromStance.Modifiers.Select(m => MapModifierToDto(m)).ToList(),
            ToModifiers: toStance.Modifiers.Select(m => MapModifierToDto(m)).ToList());

        RenderSwitchTransition(switchDto);

        _logger.LogInformation(
            "Stance switched from '{From}' to '{To}'",
            fromStance.Name,
            toStance.Name);
    }

    /// <summary>
    /// Clears the stance display.
    /// </summary>
    public void Clear()
    {
        _currentStance = null;
    }

    private StanceDisplayDto MapToDisplayDto(CombatStance stance, IReadOnlyList<StatModifier> modifiers)
    {
        return new StanceDisplayDto(
            StanceId: stance.StanceId,
            StanceName: stance.Name,
            Category: stance.Category.ToString(),
            Icon: _renderer.GetStanceIcon(stance),
            Color: _renderer.GetStanceColor(stance.Category),
            Modifiers: modifiers.Select(m => MapModifierToDto(m)).ToList(),
            Description: stance.Description);
    }

    private ModifierDisplayDto MapModifierToDto(StatModifier modifier)
    {
        return new ModifierDisplayDto(
            StatName: modifier.StatType.ToString(),
            Value: modifier.Value,
            IsPositive: modifier.IsPositive,
            DisplayString: _renderer.FormatModifier(modifier));
    }

    private void RenderStanceHeader()
    {
        if (_currentStance is null)
        {
            return;
        }

        var icon = _currentStance.Icon;
        var name = _currentStance.StanceName;
        var color = _currentStance.Color;

        _terminal.WriteWithColor($"[{icon} {name}]", color);
    }

    private void RenderModifiers()
    {
        if (_currentStance is null)
        {
            return;
        }

        var modifierStrings = _currentStance.Modifiers
            .Select(m => m.DisplayString);

        var modifierLine = string.Join("  ", modifierStrings);
        _terminal.Write("  ");
        _terminal.WriteLine(modifierLine);
    }

    private void RenderSwitchTransition(StanceSwitchDto switchDto)
    {
        _terminal.WriteLine("");
        _terminal.WriteLine($"Stance changed: {switchDto.FromStanceName} → {switchDto.ToStanceName}");

        // Build comparison for each modifier
        var comparison = _renderer.FormatSwitchComparison(switchDto);
        foreach (var line in comparison)
        {
            _terminal.WriteLine($"  {line}");
        }
    }
}
```

### 8.2 Active Stance Display

**Purpose:** Shows the currently active combat stance in the header.

#### Display Format

```
[Aggressive Stance]  +2 Attack  -1 Defense  +10% Critical
```

### 8.3 Modifier Summary Rendering

**Purpose:** Displays all active stat modifiers from the stance.

#### Modifier Format

| Modifier Type | Format | Example |
|---------------|--------|---------|
| Positive | `+{value} {stat}` | `+2 Attack` |
| Negative | `-{value} {stat}` | `-1 Defense` |
| Percentage | `+{value}% {stat}` | `+10% Critical` |

---

## 9. Stance Renderer

### 9.1 StanceRenderer Class

**Purpose:** Handles all formatting and color mapping for stance display elements.

**File:** `src/Presentation/RuneAndRust.Presentation.Tui/Rendering/StanceRenderer.cs`

```csharp
using RuneAndRust.Application.DTOs;
using RuneAndRust.Domain.Entities;
using RuneAndRust.Domain.Enums;
using RuneAndRust.Presentation.Tui.Configuration;
using Microsoft.Extensions.Options;

namespace RuneAndRust.Presentation.Tui.Rendering;

/// <summary>
/// Renderer for combat stance display elements including icons,
/// modifiers, and switch comparisons.
/// </summary>
/// <remarks>
/// Follows the Combat UI Component Pattern established in v0.13.0a.
/// All visual configuration is driven by stance-display.json.
/// </remarks>
public class StanceRenderer
{
    private readonly StanceDisplayConfiguration _config;

    /// <summary>
    /// Creates a new StanceRenderer with the specified configuration.
    /// </summary>
    /// <param name="config">Configuration options for stance display.</param>
    public StanceRenderer(IOptions<StanceDisplayConfiguration> config)
    {
        _config = config.Value;
    }

    /// <summary>
    /// Gets the icon for a combat stance.
    /// </summary>
    /// <param name="stance">The combat stance.</param>
    /// <returns>Icon string for the stance.</returns>
    public string GetStanceIcon(CombatStance stance)
    {
        return stance.Category switch
        {
            StanceCategory.Aggressive => _config.Icons.Aggressive,
            StanceCategory.Defensive => _config.Icons.Defensive,
            StanceCategory.Balanced => _config.Icons.Balanced,
            StanceCategory.Tactical => _config.Icons.Tactical,
            StanceCategory.Special => _config.Icons.Special,
            _ => _config.Icons.Default
        };
    }

    /// <summary>
    /// Gets the color for a stance category.
    /// </summary>
    /// <param name="category">The stance category.</param>
    /// <returns>Console color for the stance.</returns>
    public ConsoleColor GetStanceColor(StanceCategory category)
    {
        return category switch
        {
            StanceCategory.Aggressive => _config.Colors.Aggressive,
            StanceCategory.Defensive => _config.Colors.Defensive,
            StanceCategory.Balanced => _config.Colors.Balanced,
            StanceCategory.Tactical => _config.Colors.Tactical,
            StanceCategory.Special => _config.Colors.Special,
            _ => ConsoleColor.White
        };
    }

    /// <summary>
    /// Formats a stat modifier for display.
    /// </summary>
    /// <param name="modifier">The stat modifier.</param>
    /// <returns>Formatted modifier string.</returns>
    public string FormatModifier(StatModifier modifier)
    {
        var sign = modifier.IsPositive ? "+" : "-";
        var value = Math.Abs(modifier.Value);
        var stat = modifier.StatType.ToString();

        // Check if percentage-based modifier
        if (IsPercentageModifier(modifier.StatType))
        {
            return $"{sign}{value}% {stat}";
        }

        return $"{sign}{value} {stat}";
    }

    /// <summary>
    /// Gets the color for a modifier based on whether it's positive.
    /// </summary>
    /// <param name="isPositive">Whether the modifier is positive.</param>
    /// <returns>Console color for the modifier.</returns>
    public ConsoleColor GetModifierColor(bool isPositive)
    {
        return isPositive
            ? _config.Colors.PositiveModifier
            : _config.Colors.NegativeModifier;
    }

    /// <summary>
    /// Formats the stance switch comparison display.
    /// </summary>
    /// <param name="switchDto">The stance switch information.</param>
    /// <returns>List of comparison lines.</returns>
    public IReadOnlyList<string> FormatSwitchComparison(StanceSwitchDto switchDto)
    {
        var lines = new List<string>();

        // Build a map of "to" modifiers for lookup
        var toModifierMap = switchDto.ToModifiers
            .ToDictionary(m => m.StatName, m => m);

        // Compare each "from" modifier
        foreach (var fromMod in switchDto.FromModifiers)
        {
            if (toModifierMap.TryGetValue(fromMod.StatName, out var toMod))
            {
                // Modifier exists in both stances
                var changeIndicator = GetChangeIndicator(fromMod.Value, toMod.Value);
                lines.Add($"{toMod.DisplayString} {changeIndicator}");
                toModifierMap.Remove(fromMod.StatName);
            }
            else
            {
                // Modifier removed in new stance
                lines.Add($"{fromMod.DisplayString} (removed)");
            }
        }

        // Add new modifiers not in previous stance
        foreach (var newMod in toModifierMap.Values)
        {
            lines.Add($"{newMod.DisplayString} (new)");
        }

        return lines;
    }

    private string GetChangeIndicator(int fromValue, int toValue)
    {
        if (toValue > fromValue)
        {
            return $"(was {FormatValue(fromValue)})";
        }
        else if (toValue < fromValue)
        {
            return $"(was {FormatValue(fromValue)})";
        }
        return "(unchanged)";
    }

    private string FormatValue(int value)
    {
        return value >= 0 ? $"+{value}" : value.ToString();
    }

    private bool IsPercentageModifier(StatType statType)
    {
        return statType switch
        {
            StatType.CriticalChance => true,
            StatType.BlockChance => true,
            StatType.DodgeChance => true,
            StatType.ParryChance => true,
            _ => false
        };
    }
}
```

### 9.2 Stance Icon Mapping

| Category | Icon | Unicode Fallback |
|----------|------|------------------|
| Aggressive | `⚔` | `[A]` |
| Defensive | `🛡` | `[D]` |
| Balanced | `⚖` | `[B]` |
| Tactical | `🎯` | `[T]` |
| Special | `✦` | `[S]` |

### 9.3 Modifier Formatting

| Stat Type | Format | Example |
|-----------|--------|---------|
| Attack | `+/-# Attack` | `+2 Attack` |
| Defense | `+/-# Defense` | `-1 Defense` |
| CriticalChance | `+/-#% Critical` | `+10% Critical` |
| BlockChance | `+/-#% Block` | `+20% Block` |

---

## 10. Stance Switch Feedback

### 10.1 Transition Animation

**Purpose:** Shows visual feedback when the player changes stance.

#### Display Format

```
Stance changed: Aggressive → Defensive
```

### 10.2 Before/After Comparison

**Purpose:** Shows how modifiers changed between stances.

#### Display Format

```
Stance changed: Aggressive → Defensive
  -2 Attack (was +2)
  +3 Defense (was -1)
  +20% Block Chance (new)
```

#### Comparison Indicators

| Change Type | Indicator |
|-------------|-----------|
| Value changed | `(was {old})` |
| Removed | `(removed)` |
| New | `(new)` |
| Unchanged | `(unchanged)` |

---

## 11. Data Model Changes

### 11.1 New DTOs

#### DefensePromptDto

**File:** `src/Presentation/RuneAndRust.Presentation.Tui/DTOs/DefensePromptDto.cs`

```csharp
/// <summary>
/// Data transfer object for defense action prompt display.
/// </summary>
/// <param name="ActionId">Unique identifier of the defense action.</param>
/// <param name="ActionName">Display name of the action.</param>
/// <param name="ActionKey">Keyboard key for this action.</param>
/// <param name="Description">Description of the action.</param>
/// <param name="DamageReduction">Damage reduction percentage (0.0-1.0).</param>
/// <param name="SuccessChance">Success chance percentage (0.0-1.0).</param>
/// <param name="StaminaCost">Stamina cost to use this action.</param>
/// <param name="IsAvailable">Whether the action is currently available.</param>
/// <param name="RequiresShield">Whether the action requires a shield.</param>
public record DefensePromptDto(
    string ActionId,
    string ActionName,
    char ActionKey,
    string Description,
    float DamageReduction,
    float SuccessChance,
    int StaminaCost,
    bool IsAvailable,
    bool RequiresShield);
```

#### DefenseResultDto

**File:** `src/Presentation/RuneAndRust.Presentation.Tui/DTOs/DefenseResultDto.cs`

```csharp
/// <summary>
/// Data transfer object for defense result display.
/// </summary>
/// <param name="Success">Whether the defense succeeded.</param>
/// <param name="ActionUsed">Name of the defense action used.</param>
/// <param name="OriginalDamage">Original incoming damage.</param>
/// <param name="ReducedDamage">Damage after reduction.</param>
/// <param name="DamageReduced">Amount of damage reduced.</param>
/// <param name="Message">Result message.</param>
/// <param name="BonusEffects">Any bonus effects applied.</param>
public record DefenseResultDto(
    bool Success,
    string ActionUsed,
    int OriginalDamage,
    int ReducedDamage,
    int DamageReduced,
    string Message,
    IReadOnlyList<string> BonusEffects);
```

#### IncomingAttackDto

**File:** `src/Presentation/RuneAndRust.Presentation.Tui/DTOs/IncomingAttackDto.cs`

```csharp
/// <summary>
/// Data transfer object for incoming attack information.
/// </summary>
/// <param name="AttackerId">ID of the attacker.</param>
/// <param name="AttackerName">Name of the attacker.</param>
/// <param name="AttackName">Name of the attack.</param>
/// <param name="Damage">Expected damage amount.</param>
/// <param name="DamageType">Type of damage.</param>
public record IncomingAttackDto(
    Guid AttackerId,
    string AttackerName,
    string AttackName,
    int Damage,
    string DamageType);
```

#### ReactionWindowDto

**File:** `src/Presentation/RuneAndRust.Presentation.Tui/DTOs/ReactionWindowDto.cs`

```csharp
/// <summary>
/// Data transfer object for reaction window timing.
/// </summary>
/// <param name="TotalDuration">Total duration of the reaction window.</param>
/// <param name="RemainingTime">Time remaining in the window.</param>
/// <param name="ProgressPercent">Progress as percentage (0.0-1.0).</param>
public record ReactionWindowDto(
    TimeSpan TotalDuration,
    TimeSpan RemainingTime,
    float ProgressPercent);
```

#### StanceDisplayDto

**File:** `src/Presentation/RuneAndRust.Presentation.Tui/DTOs/StanceDisplayDto.cs`

```csharp
/// <summary>
/// Data transfer object for stance display.
/// </summary>
/// <param name="StanceId">Unique identifier of the stance.</param>
/// <param name="StanceName">Display name of the stance.</param>
/// <param name="Category">Category of the stance.</param>
/// <param name="Icon">Icon for the stance.</param>
/// <param name="Color">Display color for the stance.</param>
/// <param name="Modifiers">Active stat modifiers.</param>
/// <param name="Description">Description of the stance.</param>
public record StanceDisplayDto(
    string StanceId,
    string StanceName,
    string Category,
    string Icon,
    ConsoleColor Color,
    IReadOnlyList<ModifierDisplayDto> Modifiers,
    string Description);
```

#### ModifierDisplayDto

**File:** `src/Presentation/RuneAndRust.Presentation.Tui/DTOs/ModifierDisplayDto.cs`

```csharp
/// <summary>
/// Data transfer object for stat modifier display.
/// </summary>
/// <param name="StatName">Name of the affected stat.</param>
/// <param name="Value">Modifier value.</param>
/// <param name="IsPositive">Whether the modifier is positive.</param>
/// <param name="DisplayString">Formatted display string.</param>
public record ModifierDisplayDto(
    string StatName,
    int Value,
    bool IsPositive,
    string DisplayString);
```

#### StanceSwitchDto

**File:** `src/Presentation/RuneAndRust.Presentation.Tui/DTOs/StanceSwitchDto.cs`

```csharp
/// <summary>
/// Data transfer object for stance switch display.
/// </summary>
/// <param name="FromStanceName">Name of the previous stance.</param>
/// <param name="ToStanceName">Name of the new stance.</param>
/// <param name="FromModifiers">Modifiers from previous stance.</param>
/// <param name="ToModifiers">Modifiers from new stance.</param>
public record StanceSwitchDto(
    string FromStanceName,
    string ToStanceName,
    IReadOnlyList<ModifierDisplayDto> FromModifiers,
    IReadOnlyList<ModifierDisplayDto> ToModifiers);
```

### 11.2 Summary Table

| Type | Layer | Purpose |
|------|-------|---------|
| `DefensePromptDto` | Presentation | Defense action option display |
| `DefenseResultDto` | Presentation | Defense result feedback |
| `IncomingAttackDto` | Presentation | Incoming attack information |
| `ReactionWindowDto` | Presentation | Timing window state |
| `StanceDisplayDto` | Presentation | Active stance display |
| `ModifierDisplayDto` | Presentation | Stat modifier display |
| `StanceSwitchDto` | Presentation | Stance transition display |

---

## 12. Configuration File Schemas

### 12.1 defense-display.json

**File:** `config/defense-display.json`

```json
{
  "$schema": "./schemas/defense-display.schema.json",
  "actionKeys": {
    "block": "B",
    "dodge": "D",
    "parry": "P",
    "counter": "C"
  },
  "symbols": {
    "timingBarFilled": "=",
    "timingBarEmpty": ".",
    "separator": "─"
  },
  "colors": {
    "incomingAttack": "Red",
    "timingNormal": "Green",
    "timingWarning": "Yellow",
    "timingCritical": "Red",
    "defenseSuccess": "Green",
    "defenseFailure": "Red",
    "actionAvailable": "White",
    "actionUnavailable": "DarkGray"
  },
  "display": {
    "timingBarWidth": 10,
    "showSuccessChance": true,
    "showStaminaCost": true,
    "showDamageReduction": true
  },
  "messages": {
    "incomingAttackHeader": "INCOMING ATTACK:",
    "defenseOptionsHeader": "DEFENSE OPTIONS:",
    "reactionWindowLabel": "Reaction Window:",
    "successSuffix": "SUCCESS!",
    "failureSuffix": "FAILED!",
    "damageReducedLabel": "Damage reduced:"
  }
}
```

### 12.2 stance-display.json

**File:** `config/stance-display.json`

```json
{
  "$schema": "./schemas/stance-display.schema.json",
  "icons": {
    "aggressive": "⚔",
    "defensive": "🛡",
    "balanced": "⚖",
    "tactical": "🎯",
    "special": "✦",
    "default": "◆",
    "aggressiveAscii": "[A]",
    "defensiveAscii": "[D]",
    "balancedAscii": "[B]",
    "tacticalAscii": "[T]",
    "specialAscii": "[S]",
    "defaultAscii": "[?]"
  },
  "colors": {
    "aggressive": "Red",
    "defensive": "Blue",
    "balanced": "Yellow",
    "tactical": "Cyan",
    "special": "Magenta",
    "positiveModifier": "Green",
    "negativeModifier": "Red",
    "neutralModifier": "Gray"
  },
  "display": {
    "showDescription": false,
    "showAllModifiers": true,
    "compactMode": true,
    "animateSwitchDuration": 500
  },
  "messages": {
    "stanceChangedPrefix": "Stance changed:",
    "modifierWasPrefix": "(was",
    "modifierNewLabel": "(new)",
    "modifierRemovedLabel": "(removed)",
    "modifierUnchangedLabel": "(unchanged)"
  }
}
```

### 12.3 Configuration Classes

**File:** `src/Presentation/RuneAndRust.Presentation.Tui/Configuration/DefenseDisplayConfiguration.cs`

```csharp
namespace RuneAndRust.Presentation.Tui.Configuration;

/// <summary>
/// Configuration options for defense display rendering.
/// </summary>
public class DefenseDisplayConfiguration
{
    public ActionKeyConfiguration ActionKeys { get; set; } = new();
    public SymbolConfiguration Symbols { get; set; } = new();
    public DefenseColorConfiguration Colors { get; set; } = new();
    public DefenseDisplaySettings Display { get; set; } = new();
    public DefenseMessageConfiguration Messages { get; set; } = new();

    public int TimingBarWidth => Display.TimingBarWidth;
}

public class ActionKeyConfiguration
{
    public char Block { get; set; } = 'B';
    public char Dodge { get; set; } = 'D';
    public char Parry { get; set; } = 'P';
    public char Counter { get; set; } = 'C';
}

public class SymbolConfiguration
{
    public char TimingBarFilled { get; set; } = '=';
    public char TimingBarEmpty { get; set; } = '.';
    public char Separator { get; set; } = '─';
}

public class DefenseColorConfiguration
{
    public ConsoleColor IncomingAttack { get; set; } = ConsoleColor.Red;
    public ConsoleColor TimingNormal { get; set; } = ConsoleColor.Green;
    public ConsoleColor TimingWarning { get; set; } = ConsoleColor.Yellow;
    public ConsoleColor TimingCritical { get; set; } = ConsoleColor.Red;
    public ConsoleColor DefenseSuccess { get; set; } = ConsoleColor.Green;
    public ConsoleColor DefenseFailure { get; set; } = ConsoleColor.Red;
    public ConsoleColor ActionAvailable { get; set; } = ConsoleColor.White;
    public ConsoleColor ActionUnavailable { get; set; } = ConsoleColor.DarkGray;
}

public class DefenseDisplaySettings
{
    public int TimingBarWidth { get; set; } = 10;
    public bool ShowSuccessChance { get; set; } = true;
    public bool ShowStaminaCost { get; set; } = true;
    public bool ShowDamageReduction { get; set; } = true;
}

public class DefenseMessageConfiguration
{
    public string IncomingAttackHeader { get; set; } = "INCOMING ATTACK:";
    public string DefenseOptionsHeader { get; set; } = "DEFENSE OPTIONS:";
    public string ReactionWindowLabel { get; set; } = "Reaction Window:";
    public string SuccessSuffix { get; set; } = "SUCCESS!";
    public string FailureSuffix { get; set; } = "FAILED!";
    public string DamageReducedLabel { get; set; } = "Damage reduced:";
}
```

**File:** `src/Presentation/RuneAndRust.Presentation.Tui/Configuration/StanceDisplayConfiguration.cs`

```csharp
namespace RuneAndRust.Presentation.Tui.Configuration;

/// <summary>
/// Configuration options for stance display rendering.
/// </summary>
public class StanceDisplayConfiguration
{
    public StanceIconConfiguration Icons { get; set; } = new();
    public StanceColorConfiguration Colors { get; set; } = new();
    public StanceDisplaySettings Display { get; set; } = new();
    public StanceMessageConfiguration Messages { get; set; } = new();
}

public class StanceIconConfiguration
{
    public string Aggressive { get; set; } = "⚔";
    public string Defensive { get; set; } = "🛡";
    public string Balanced { get; set; } = "⚖";
    public string Tactical { get; set; } = "🎯";
    public string Special { get; set; } = "✦";
    public string Default { get; set; } = "◆";
    public string AggressiveAscii { get; set; } = "[A]";
    public string DefensiveAscii { get; set; } = "[D]";
    public string BalancedAscii { get; set; } = "[B]";
    public string TacticalAscii { get; set; } = "[T]";
    public string SpecialAscii { get; set; } = "[S]";
    public string DefaultAscii { get; set; } = "[?]";
}

public class StanceColorConfiguration
{
    public ConsoleColor Aggressive { get; set; } = ConsoleColor.Red;
    public ConsoleColor Defensive { get; set; } = ConsoleColor.Blue;
    public ConsoleColor Balanced { get; set; } = ConsoleColor.Yellow;
    public ConsoleColor Tactical { get; set; } = ConsoleColor.Cyan;
    public ConsoleColor Special { get; set; } = ConsoleColor.Magenta;
    public ConsoleColor PositiveModifier { get; set; } = ConsoleColor.Green;
    public ConsoleColor NegativeModifier { get; set; } = ConsoleColor.Red;
    public ConsoleColor NeutralModifier { get; set; } = ConsoleColor.Gray;
}

public class StanceDisplaySettings
{
    public bool ShowDescription { get; set; } = false;
    public bool ShowAllModifiers { get; set; } = true;
    public bool CompactMode { get; set; } = true;
    public int AnimateSwitchDuration { get; set; } = 500;
}

public class StanceMessageConfiguration
{
    public string StanceChangedPrefix { get; set; } = "Stance changed:";
    public string ModifierWasPrefix { get; set; } = "(was";
    public string ModifierNewLabel { get; set; } = "(new)";
    public string ModifierRemovedLabel { get; set; } = "(removed)";
    public string ModifierUnchangedLabel { get; set; } = "(unchanged)";
}
```

---

## 13. CombatView Integration

### 13.1 Integration Points

**File:** `src/Presentation/RuneAndRust.Presentation.Tui/Views/CombatView.cs` (modifications)

```csharp
// Add to CombatView class:

private readonly DefenseActionPrompts _defensePrompts;
private readonly StanceIndicator _stanceIndicator;

/// <summary>
/// Integrates defense action prompts into combat view.
/// </summary>
public void IntegrateDefensePrompts(DefenseActionPrompts prompts)
{
    _defensePrompts = prompts;
}

/// <summary>
/// Integrates stance indicator into combat view.
/// </summary>
public void IntegrateStanceIndicator(StanceIndicator indicator)
{
    _stanceIndicator = indicator;
}

/// <summary>
/// Handles an incoming attack by showing defense prompts.
/// </summary>
/// <param name="combatant">The defending combatant.</param>
/// <param name="attack">The incoming attack information.</param>
public void OnIncomingAttack(ICombatant combatant, IncomingAttackDto attack)
{
    if (_defenseService.CanDefend(combatant))
    {
        _defensePrompts.ShowPrompts(combatant, attack);
        StartReactionTimer(combatant);
    }
}

/// <summary>
/// Updates the reaction timing display.
/// </summary>
private void UpdateReactionTimer(TimeSpan elapsed, TimeSpan total)
{
    _defensePrompts.RenderTimingWindow(elapsed, total);
}

/// <summary>
/// Handles defense action selection.
/// </summary>
/// <param name="combatant">The defending combatant.</param>
/// <param name="actionKey">The key pressed.</param>
public void OnDefenseKeyPressed(ICombatant combatant, char actionKey)
{
    var action = GetActionForKey(actionKey);
    if (action is null)
    {
        return;
    }

    var result = _defenseService.ExecuteDefense(combatant, action.ActionId, _currentAttack);
    _defensePrompts.ShowResult(result);
    _defensePrompts.HidePrompts();
}

/// <summary>
/// Handles reaction window expiration.
/// </summary>
private void OnReactionWindowExpired(ICombatant combatant)
{
    var defaultAction = _defenseService.GetDefaultAction(combatant);
    var result = _defenseService.ExecuteDefense(
        combatant,
        defaultAction?.ActionId ?? "none",
        _currentAttack);

    _defensePrompts.ShowResult(result);
    _defensePrompts.HidePrompts();
}

/// <summary>
/// Refreshes the stance display at turn start.
/// </summary>
/// <param name="combatant">The current combatant.</param>
public void RefreshStanceDisplay(ICombatant combatant)
{
    if (_stanceService.HasActiveStance(combatant))
    {
        _stanceIndicator.RenderStance(combatant);
    }
    else
    {
        _stanceIndicator.Clear();
    }
}

/// <summary>
/// Handles stance switch command.
/// </summary>
/// <param name="combatant">The combatant switching stance.</param>
/// <param name="newStanceId">The ID of the new stance.</param>
public void OnStanceSwitch(ICombatant combatant, string newStanceId)
{
    var currentStance = _stanceService.GetActiveStance(combatant);
    var result = _stanceService.SwitchStance(combatant, newStanceId);

    if (result.Success && currentStance is not null)
    {
        var newStance = _stanceService.GetActiveStance(combatant);
        if (newStance is not null)
        {
            _stanceIndicator.AnimateSwitch(currentStance, newStance);
        }
    }

    RefreshStanceDisplay(combatant);
}
```

### 13.2 Layout Positions

| Component | Position | Display |
|-----------|----------|---------|
| Stance Header | Top bar | `[Aggressive Stance] +2 Attack -1 Defense` |
| Defense Prompts | Bottom panel | Shows during incoming attacks |
| Timing Bar | Within defense prompts | Progress indicator |

### 13.3 Event Subscriptions

```csharp
// In CombatView initialization:

// Subscribe to defense events
_eventBus.Subscribe<IncomingAttackEvent>(OnIncomingAttackEvent);
_eventBus.Subscribe<DefenseExecutedEvent>(OnDefenseExecutedEvent);

// Subscribe to stance events
_eventBus.Subscribe<StanceChangedEvent>(OnStanceChangedEvent);

private void OnIncomingAttackEvent(IncomingAttackEvent evt)
{
    if (evt.DefenderId == _currentCombatant?.Id)
    {
        var attackDto = new IncomingAttackDto(
            evt.AttackerId,
            evt.AttackerName,
            evt.AttackName,
            evt.Damage,
            evt.DamageType);

        OnIncomingAttack(_currentCombatant, attackDto);
    }
}

private void OnDefenseExecutedEvent(DefenseExecutedEvent evt)
{
    if (evt.DefenderId == _currentCombatant?.Id)
    {
        _defensePrompts.ShowResult(evt.Result);
        _defensePrompts.HidePrompts();
    }
}

private void OnStanceChangedEvent(StanceChangedEvent evt)
{
    if (evt.CombatantId == _currentCombatant?.Id)
    {
        RefreshStanceDisplay(_currentCombatant);
    }
}
```

---

## 14. Logging Specifications

### 14.1 Log Levels by Component

| Component | Level | Events |
|-----------|-------|--------|
| `DefenseActionPrompts` | Information | Defense success/failure |
| `DefenseActionPrompts` | Debug | Prompts displayed, timing updates |
| `DefenseRenderer` | Debug | Format operations |
| `StanceIndicator` | Information | Stance switch |
| `StanceIndicator` | Debug | Stance rendered, modifiers displayed |
| `StanceRenderer` | Debug | Format operations |
| `CombatView` | Debug | Defense/stance integration |

### 14.2 Log Message Examples

```csharp
// DefenseActionPrompts
_logger.LogDebug(
    "Displayed {ActionCount} defense options for combatant {CombatantId}",
    _currentPrompts.Count, combatant.Id);

_logger.LogInformation(
    "Defense {Result}: {Action} - Damage {Original} -> {Reduced}",
    result.Success ? "SUCCESS" : "FAILED",
    result.ActionUsed,
    result.OriginalDamage,
    result.ReducedDamage);

// StanceIndicator
_logger.LogDebug(
    "Rendered stance '{StanceName}' for combatant {CombatantId}",
    stance.Name, combatant.Id);

_logger.LogInformation(
    "Stance switched from '{From}' to '{To}'",
    fromStance.Name, toStance.Name);
```

---

## 15. Unit Testing Requirements

### 15.1 Test Count by Feature

| Feature | Test Count |
|---------|------------|
| DefenseActionPrompts | ~2 |
| DefenseRenderer | ~2 |
| StanceIndicator | ~1 |
| StanceRenderer | ~1 |
| **Total** | **~6** |

### 15.2 Test Specifications

#### DefenseActionPromptsTests.cs

**File:** `tests/RuneAndRust.Presentation.Tui.Tests/UI/DefenseActionPromptsTests.cs`

```csharp
[TestFixture]
public class DefenseActionPromptsTests
{
    [Test]
    public void ShowPrompts_WithAvailableActions_DisplaysAllOptions();

    [Test]
    public void RenderTimingWindow_WithElapsedTime_UpdatesProgressBar();

    [Test]
    public void ShowResult_WithSuccess_DisplaysSuccessMessage();

    [Test]
    public void ShowResult_WithFailure_DisplaysFailureMessage();

    [Test]
    public void HidePrompts_ClearsDisplayState();
}
```

#### DefenseRendererTests.cs

**File:** `tests/RuneAndRust.Presentation.Tui.Tests/Rendering/DefenseRendererTests.cs`

```csharp
[TestFixture]
public class DefenseRendererTests
{
    [Test]
    public void GetActionKey_BlockAction_ReturnsB();

    [Test]
    public void GetActionKey_DodgeAction_ReturnsD();

    [Test]
    public void FormatTimingBar_FullProgress_ReturnsAllFilled();

    [Test]
    public void FormatTimingBar_HalfProgress_ReturnsHalfFilled();

    [Test]
    public void GetTimingBarColor_LowProgress_ReturnsRed();

    [Test]
    public void GetResultColor_Success_ReturnsGreen();

    [Test]
    public void FormatDamageReduction_ValidValues_ReturnsFormattedString();
}
```

#### StanceIndicatorTests.cs

**File:** `tests/RuneAndRust.Presentation.Tui.Tests/UI/StanceIndicatorTests.cs`

```csharp
[TestFixture]
public class StanceIndicatorTests
{
    [Test]
    public void RenderStance_WithActiveStance_DisplaysStanceHeader();

    [Test]
    public void ShowModifiers_WithModifiers_DisplaysAllModifiers();

    [Test]
    public void AnimateSwitch_WithDifferentStances_DisplaysComparison();

    [Test]
    public void Clear_RemovesStanceDisplay();
}
```

#### StanceRendererTests.cs

**File:** `tests/RuneAndRust.Presentation.Tui.Tests/Rendering/StanceRendererTests.cs`

```csharp
[TestFixture]
public class StanceRendererTests
{
    [Test]
    public void GetStanceIcon_AggressiveCategory_ReturnsSwordIcon();

    [Test]
    public void GetStanceColor_DefensiveCategory_ReturnsBlue();

    [Test]
    public void FormatModifier_PositiveValue_ReturnsPositiveFormat();

    [Test]
    public void FormatModifier_NegativeValue_ReturnsNegativeFormat();

    [Test]
    public void FormatSwitchComparison_WithChanges_ReturnsComparisonLines();
}
```

---

## 16. Use Cases

### UC-001: View Defense Options on Incoming Attack

**Actor:** Player
**Flow:** Enemy attacks → IncomingAttackEvent raised → CombatView shows defense prompts → Player sees available actions with timing bar

### UC-002: Execute Defense Action

**Actor:** Player
**Flow:** Defense prompts visible → Player presses defense key → IDefenseActionService.ExecuteDefense() → Result displayed → Prompts hidden

### UC-003: Reaction Window Expires

**Actor:** System
**Flow:** Defense prompts visible → Timer reaches zero → Default action executed → Result displayed → Prompts hidden

### UC-004: View Active Stance

**Actor:** Player
**Flow:** Combat turn starts → CombatView refreshes stance display → Player sees stance header with modifiers

### UC-005: Switch Combat Stance

**Actor:** Player
**Flow:** Player requests stance change → ICombatStanceService.SwitchStance() → Transition animation shown → New stance displayed

### UC-006: View Stance Switch Comparison

**Actor:** Player
**Flow:** Stance switch successful → AnimateSwitch() called → Before/after modifier comparison displayed

---

## 17. Deliverable Checklist

### Defense Action Prompts

- [ ] `DefenseActionPrompts.cs` created
- [ ] `ShowPrompts()` method implemented
- [ ] `RenderTimingWindow()` method implemented
- [ ] `ShowResult()` method implemented
- [ ] `HidePrompts()` method implemented

### Defense Renderer

- [ ] `DefenseRenderer.cs` created
- [ ] `GetActionKey()` method implemented
- [ ] `FormatTimingBar()` method implemented
- [ ] `GetTimingBarColor()` method implemented
- [ ] `GetResultColor()` method implemented
- [ ] `FormatDamageReduction()` method implemented
- [ ] `FormatIncomingAttack()` method implemented

### Stance Indicator

- [ ] `StanceIndicator.cs` created
- [ ] `RenderStance()` method implemented
- [ ] `ShowModifiers()` method implemented
- [ ] `AnimateSwitch()` method implemented
- [ ] `Clear()` method implemented

### Stance Renderer

- [ ] `StanceRenderer.cs` created
- [ ] `GetStanceIcon()` method implemented
- [ ] `GetStanceColor()` method implemented
- [ ] `FormatModifier()` method implemented
- [ ] `GetModifierColor()` method implemented
- [ ] `FormatSwitchComparison()` method implemented

### DTOs

- [ ] `DefensePromptDto.cs` created
- [ ] `DefenseResultDto.cs` created
- [ ] `IncomingAttackDto.cs` created
- [ ] `ReactionWindowDto.cs` created
- [ ] `StanceDisplayDto.cs` created
- [ ] `ModifierDisplayDto.cs` created
- [ ] `StanceSwitchDto.cs` created

### Configuration

- [ ] `config/defense-display.json` created
- [ ] `config/schemas/defense-display.schema.json` created
- [ ] `config/stance-display.json` created
- [ ] `config/schemas/stance-display.schema.json` created
- [ ] `DefenseDisplayConfiguration.cs` created
- [ ] `StanceDisplayConfiguration.cs` created

### CombatView Integration

- [ ] `IntegrateDefensePrompts()` method added
- [ ] `IntegrateStanceIndicator()` method added
- [ ] `OnIncomingAttack()` method added
- [ ] `RefreshStanceDisplay()` method added
- [ ] `OnStanceSwitch()` method added
- [ ] Event subscriptions implemented

### Testing

- [ ] `DefenseActionPromptsTests.cs` created
- [ ] `DefenseRendererTests.cs` created
- [ ] `StanceIndicatorTests.cs` created
- [ ] `StanceRendererTests.cs` created
- [ ] All ~6 unit tests passing

---

## 18. Acceptance Criteria

### Functional - Defense Actions

- [ ] Defense action prompts show available actions on incoming attack
- [ ] Action keys match first letter of defense type ([B]lock, [D]odge, [P]arry)
- [ ] Reaction window timing indicator updates in real-time
- [ ] Timing bar color changes based on remaining time
- [ ] Defense result feedback shows success/failure message
- [ ] Damage reduction displays original and reduced values

### Functional - Combat Stance

- [ ] Active stance indicator shows current stance in header
- [ ] Stance icon matches stance category
- [ ] Stance modifier summary shows all stat changes
- [ ] Positive modifiers display with + prefix
- [ ] Negative modifiers display with - prefix
- [ ] Stance switch feedback shows before/after comparison
- [ ] New/removed modifiers indicated in comparison

### Quality

- [ ] Build succeeds with 0 errors
- [ ] Build succeeds with 0 warnings
- [ ] All ~6 unit tests pass
- [ ] Configuration validates against JSON schemas
- [ ] XML documentation complete on all public members

---

## 19. Dependencies

### 19.1 Required from Previous Versions

| Type | Location | Usage |
|------|----------|-------|
| `IDefenseActionService` | `Application/Interfaces/IDefenseActionService.cs` | Retrieve defense actions, execute defense |
| `DefenseAction` | `Domain/Entities/DefenseAction.cs` | Defense action definitions |
| `DefenseResult` | `Domain/Entities/DefenseResult.cs` | Defense execution result |
| `DefenseType` | `Domain/Enums/DefenseType.cs` | Defense action type enum |
| `ReactionWindow` | `Domain/ValueObjects/ReactionWindow.cs` | Timing window data |
| `ICombatStanceService` | `Application/Interfaces/ICombatStanceService.cs` | Retrieve and switch stances |
| `CombatStance` | `Domain/Entities/CombatStance.cs` | Stance definitions |
| `StatModifier` | `Domain/ValueObjects/StatModifier.cs` | Modifier data |
| `StanceCategory` | `Domain/Enums/StanceCategory.cs` | Stance category enum |
| `CombatView` | `Presentation.Tui/Views/CombatView.cs` | Integration point |
| `ITerminalService` | `Presentation.Tui/Services/ITerminalService.cs` | Terminal output |

### 19.2 Provides to Future Versions

| Type | Usage |
|------|-------|
| `DefenseActionPrompts` | Complete defense UI component for v0.14.x+ |
| `StanceIndicator` | Complete stance UI component for v0.14.x+ |
| Combat UI Component Pattern | Fully established pattern for future UI work |

---

## 20. Future Considerations

### Deferred to Future Versions

- **Stance Cooldowns**: Visual indicator for stance switch cooldown (v0.14.x consideration)
- **Defense Combo Display**: Showing defense combos/chains (not in v0.13.0 scope)
- **Animated Health Changes**: Smooth health bar animation on damage (TUI limitation)
- **Sound Effects Integration**: Audio feedback for defense/stance actions (v0.14.x consideration)

### Out of Scope

- **Defense AI Hints**: Suggestions for optimal defense selection (AI enhancement)
- **Stance Loadouts**: Saving/loading stance configurations (settings feature)
- **Custom Keybindings**: Player-defined defense keys (settings feature)

---

*Document Version: 1.0*
*Last Updated: 2026-01-16*
*Author: Claude*
