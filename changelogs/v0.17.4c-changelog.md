# Changelog: v0.17.4c - Specialization Ability Tiers

**Release Date:** 2026-01-30
**Phase:** Specialization System (3/5)
**Status:** Complete

---

## Overview

Implements the `SpecializationAbility` and `SpecializationAbilityTier` value objects, enhances the existing `SpecializationDefinition` entity with ability tier support, and populates the Berserkr specialization with a complete three-tier ability tree (9 abilities). The specializations configuration and JSON schema are updated to support the new ability tier structure.

This phase builds on v0.17.4b (definitions and special resources) to establish the per-specialization ability progression system. Each specialization has three tiers of abilities unlocked via Progression Points (PP), with escalating costs and rank requirements.

**Berserkr Ability Tiers:**

| Tier | Display Name            | PP Cost | Required Rank | Abilities |
| ---- | ----------------------- | ------- | ------------- | --------- |
| 1    | Primal Fury             | 0       | 1             | 3 (2A/1P) |
| 2    | Unleashed Beast         | 2       | 2             | 3 (2A/1P) |
| 3    | Avatar of Destruction   | 3       | 3             | 3 (1A/2P) |

**Total:** 9 abilities (5 active, 4 passive). Total PP to fully unlock: 5 PP.

---

## Added

### Domain Layer

#### Value Objects

- **`SpecializationAbility`** (`ValueObjects/SpecializationAbility.cs`)
    - `public readonly record struct` with `init` properties
    - Properties: `AbilityId`, `DisplayName`, `Description`, `IsPassive`, `ResourceCost`, `ResourceType`, `Cooldown`, `CorruptionRisk`
    - Computed properties: `HasResourceCost`, `HasCooldown`, `RisksCorruption`, `IsActive`, `TypeDisplay`
    - Factory method `Create()` with comprehensive validation:
        - `ArgumentException.ThrowIfNullOrWhiteSpace` for `abilityId`, `displayName`, `description`
        - `ArgumentOutOfRangeException.ThrowIfNegative` for `resourceCost`, `cooldown`, `corruptionRisk`
        - Passive abilities cannot have non-zero cooldown
    - Convenience factories: `CreateActive()` (sets `isPassive: false`), `CreatePassive()` (sets resource/cooldown to 0)
    - Normalizes `AbilityId` and `ResourceType` to lowercase via `ToLowerInvariant()`
    - Trims `DisplayName` and `Description`
    - Optional `ILogger<SpecializationAbility>?` parameter
    - Logging: `LogDebug` before/after validation, `LogInformation` on successful creation, `LogWarning` on validation failure
    - Helper methods: `GetShortDisplay()` → `"{Name} [ACTIVE/PASSIVE]"`, `GetDetailDisplay()` → multi-line
    - `ToString()` override: `"{Name} [{type}{cost}{cd}]"`
    - Sections: PRIVATE FIELDS, PROPERTIES, COMPUTED PROPERTIES, FACTORY METHODS, HELPER METHODS, DEBUGGING

- **`SpecializationAbilityTier`** (`ValueObjects/SpecializationAbilityTier.cs`)
    - `public readonly record struct` with `init` properties
    - Properties: `Tier`, `DisplayName`, `UnlockCost`, `RequiresPreviousTier`, `RequiredRank`, `Abilities` (`IReadOnlyList<SpecializationAbility>`)
    - Computed properties: `AbilityCount`, `PassiveCount`, `ActiveCount`
    - Factory method `Create()` with comprehensive validation:
        - Tier range 1-3
        - Non-negative `unlockCost`, minimum `requiredRank` of 1
        - Non-empty abilities collection with unique ability IDs
        - Tier 1 cannot require previous tier; Tier 2+ must require previous tier
    - Convenience factories: `CreateTier1()` (0 PP, Rank 1), `CreateTier2()` (2 PP, Rank 2), `CreateTier3()` (3 PP, Rank 3)
    - `CanUnlock(currentRank, previousTierUnlocked, availablePp)` → `(bool CanUnlock, string? Reason)` tuple
        - Checks previous tier → rank → PP in priority order
    - Optional `ILogger<SpecializationAbilityTier>?` parameter
    - Logging: `LogDebug` for validation steps and unlock checks, `LogInformation` on creation, `LogWarning` on validation failure
    - Helper methods: `GetShortDisplay()`, `GetDetailDisplay()`
    - `ToString()` override: `"Tier {N}: {Name} ({Count} abilities, {Cost} PP)"`
    - Sections: PRIVATE FIELDS, PROPERTIES, COMPUTED PROPERTIES, FACTORY METHODS, HELPER METHODS, DEBUGGING

### Unit Tests

- **`SpecializationAbilityTests`** (`ValueObjects/SpecializationAbilityTests.cs`) — 28 test methods
    - **Factory Method Tests (5):** Valid active, valid passive, CreateActive, CreateActive with cooldown, CreatePassive with corruption risk
    - **Validation Tests (8):** Null/empty/whitespace abilityId, null displayName, null description, negative resourceCost/cooldown/corruptionRisk, passive with cooldown
    - **Normalization Tests (4):** AbilityId to lowercase, ResourceType to lowercase, trim DisplayName, trim Description
    - **Computed Property Tests (9):** HasResourceCost (true/false/no-type), HasCooldown (true/false), RisksCorruption (true/false), IsActive (active/passive), TypeDisplay (active/passive)
    - **Display Tests (5):** GetShortDisplay active/passive, ToString active with cost+cooldown/cost only/passive, GetDetailDisplay with all properties/passive
    - **Edge Cases (2):** Zero cost with type, active with default params

- **`SpecializationAbilityTierTests`** (`ValueObjects/SpecializationAbilityTierTests.cs`) — 31 test methods
    - **Factory Method Tests (3):** Valid Tier 1/2/3 with full property verification
    - **Convenience Factory Tests (3):** CreateTier1/2/3 with standard parameter verification
    - **Validation Tests (11):** Tier below/above range, null/empty displayName, negative unlockCost, zero requiredRank, null/empty abilities, duplicate ability IDs, Tier 1 with requiresPrevious, Tier 2/3 without requiresPrevious
    - **Computed Property Tests (4):** AbilityCount, PassiveCount, ActiveCount, single ability count
    - **CanUnlock Tests (7):** Tier 1 all met, Tier 2 all met, Tier 2 exact PP, without previous tier, insufficient rank, insufficient PP, Tier 3 without Tier 2, priority order check
    - **Display Tests (4):** ToString Tier 1/2, GetShortDisplay, GetDetailDisplay with abilities
    - **Normalization Tests (1):** DisplayName trimming

### Glossary

- **`config/glossary.json`** — Added 2 glossary entries
    - `specialization-ability`: Value object representing an individual ability with cost, cooldown, and Corruption risk (sortOrder: 42)
    - `specialization-ability-tier`: Value object representing a tier of abilities with unlock cost, rank requirements, and contained abilities (sortOrder: 43)

---

## Changed

### Domain Layer

#### Entities

- **`SpecializationDefinition`** (`Entities/SpecializationDefinition.cs`) — Enhanced with ability tier support
    - Version updated from 0.17.4b → 0.17.4c
    - Added `AbilityTiers` property (`IReadOnlyList<SpecializationAbilityTier>`)
    - Added computed properties: `HasAbilityTiers`, `TotalAbilityCount`, `AllAbilities`
    - Updated private constructor: initializes `AbilityTiers = Array.Empty<SpecializationAbilityTier>()`
    - Updated `Create()` factory signature: added `IEnumerable<SpecializationAbilityTier>? abilityTiers = null` parameter
    - Added cross-tier validation: unique tier numbers, no duplicate ability IDs across tiers
    - Added helper methods: `GetTier(int)`, `GetAbility(string)`, `GetAbilityTier(string)`
    - Enhanced logging to include ability tier counts
    - Updated XML documentation with `<seealso>` references to ability tier types

### Configuration Files

- **`config/specializations.json`** — Added `abilityTiers` to all 17 definition entries
    - Berserkr: Full 3-tier ability tree (9 abilities per design spec Section 7.1)
    - Remaining 16 specializations: Empty `abilityTiers: []` (to be populated in future phases)

- **`config/schemas/specializations.schema.json`** — Enhanced with ability tier and ability schemas
    - Added `abilityTierEntry` definition: 6 required properties (`tier`, `displayName`, `unlockCost`, `requiresPreviousTier`, `requiredRank`, `abilities`)
    - Added `abilityEntry` definition: 8 required properties (`abilityId`, `displayName`, `description`, `isPassive`, `resourceCost`, `resourceType`, `cooldown`, `corruptionRisk`)
    - Added `abilityTiers` property to `definitionEntry` (required, array of `abilityTierEntry`, maxItems: 3)
    - Updated schema description to reference v0.17.4c

### Documentation

- **`docs/design/v0.17.x/v0.17.4-scope-breakdown.md`** — Checked off v0.17.4c unit test items
    - `[x] Tier 1 has 0 PP cost`
    - `[x] Tier 2 requires Tier 1 and costs 2 PP`
    - `[x] Tier 3 requires Tier 2 and costs 3 PP`
    - `[x] Abilities correctly associated with tiers`

- **`docs/design/v0.17.x/v0.17.x-overview.md`** — Checked off v0.17.4 deliverable
    - `[x] SpecializationAbilityTier value object`

---

## Design Decisions

### Tier PP Costs: Design Spec vs Scope Breakdown

The v0.17.4c design specification defines Tier 2 = 2 PP and Tier 3 = 3 PP as total tier costs. The scope breakdown says "1 PP per ability" for Tier 2 and "2 PP per ability" for Tier 3. The design specification takes precedence as the more detailed and recent document. The `CreateTier2()` factory uses 2 PP and `CreateTier3()` uses 3 PP.

### Value Objects: readonly record struct with init Properties

Both `SpecializationAbility` and `SpecializationAbilityTier` follow the `readonly record struct` with `init` properties pattern established by `SpecialResourceDefinition` (v0.17.4b). This provides value semantics, structural equality, and immutability while allowing property-by-property initialization in factory methods.

### Logger Inclusion Per Codebase Convention

The design specification omits `ILogger<T>?` parameters from factory methods. Both value objects include optional logger parameters per the established codebase convention (v0.17.4a/v0.17.4b) and the user's "exhaustive logging" requirement.

### abilityTiers as Required in Schema

The `abilityTiers` property is required on `definitionEntry` in the schema (not optional), with empty arrays allowed for specializations without configured ability data. This ensures all 17 entries have the property for consistency, while only Berserkr contains actual ability data in this phase.

### CanUnlock Check Priority Order

The `CanUnlock` method checks requirements in priority order: (1) previous tier prerequisite, (2) rank requirement, (3) PP availability. This provides the most actionable error message — a player should unlock the previous tier before worrying about rank or PP.

### GetTier Returns Nullable

`GetTier(int)` returns `SpecializationAbilityTier?` (nullable value type) rather than the default struct when a tier is not found. This prevents callers from accidentally using a default-constructed tier (Tier = 0, empty abilities).

---

## Dependencies

### Prerequisites

| Type                              | Phase    | Usage                                           |
| --------------------------------- | -------- | ----------------------------------------------- |
| `SpecializationDefinition`        | v0.17.4b | Enhanced entity receives ability tiers           |
| `SpecialResourceDefinition`       | v0.17.4b | Referenced by ability resource types             |
| `SpecializationId`                | v0.17.4a | Referenced via definition entity                 |
| `SpecializationPathType`          | v0.17.4a | Path type determines Corruption risk on abilities|
| `SpecializationIdExtensions`      | v0.17.4a | Cross-validation in definition factory           |
| `Archetype`                       | v0.17.3a | Parent archetype on definitions                  |
| `IEntity`                         | Domain   | Interface for entity identification              |

### Provides to Future Phases

| Type                           | Phase    | Usage                                           |
| ------------------------------ | -------- | ----------------------------------------------- |
| `SpecializationAbilityTier`    | v0.17.4d | Provider loads ability tiers from config         |
| `SpecializationAbility`        | v0.17.4d | Provider maps abilities to tiers                 |
| `SpecializationDefinition`     | v0.17.4e | Application service uses ability tiers           |

---

## Logging Strategy

| Level       | When                                                                 |
|-------------|----------------------------------------------------------------------|
| Debug       | Pre-validation parameter logging in factory methods                  |
| Debug       | Post-validation confirmation with validated values                   |
| Debug       | Individual ability logging within tier creation                      |
| Debug       | CanUnlock check steps and results                                    |
| Warning     | Validation failures (before exception throw)                         |
| Information | Successful creation with all assigned property values                |

All factory methods accept optional `ILogger<T>?` parameters following the established codebase convention.

---

## Files Created

| Path | Description |
|------|-------------|
| `src/Core/RuneAndRust.Domain/ValueObjects/SpecializationAbility.cs` | Ability value object with factory validation |
| `src/Core/RuneAndRust.Domain/ValueObjects/SpecializationAbilityTier.cs` | Ability tier value object with factory validation and CanUnlock |
| `tests/RuneAndRust.Domain.UnitTests/ValueObjects/SpecializationAbilityTests.cs` | 28 test methods for ability value object |
| `tests/RuneAndRust.Domain.UnitTests/ValueObjects/SpecializationAbilityTierTests.cs` | 31 test methods for ability tier value object |
| `changelogs/v0.17.4c-changelog.md` | This changelog |

## Files Modified

| Path | Description |
|------|-------------|
| `src/Core/RuneAndRust.Domain/Entities/SpecializationDefinition.cs` | Added AbilityTiers property, computed properties, helper methods, cross-tier validation |
| `config/specializations.json` | Added `abilityTiers` to all 17 definitions (Berserkr with full data, others empty) |
| `config/schemas/specializations.schema.json` | Added `abilityTierEntry` and `abilityEntry` definitions, updated `definitionEntry` |
| `config/glossary.json` | Added 2 glossary entries (sortOrder 42-43) |
| `docs/design/v0.17.x/v0.17.4-scope-breakdown.md` | Checked off v0.17.4c test deliverables |
| `docs/design/v0.17.x/v0.17.x-overview.md` | Checked off SpecializationAbilityTier deliverable |

---

## Notes

- Total unit tests for v0.17.4c: 59 test methods (28 SpecializationAbility + 31 SpecializationAbilityTier)
- Only Berserkr has populated ability tiers in this phase; remaining 16 specializations have empty arrays
- Berserkr abilities: 9 total (5 active, 4 passive) across 3 tiers
- Total PP to fully unlock Berserkr: 5 PP (0 + 2 + 3)
- Ability IDs use kebab-case and are normalized to lowercase for consistent lookups
- Cross-tier ability ID uniqueness is validated at the SpecializationDefinition level
- The CanUnlock method provides runtime unlock eligibility checking with descriptive failure reasons
- SpecializationDefinition.Create() maintains backward compatibility — abilityTiers parameter is optional with null default
- Existing SpecializationDefinition tests from v0.17.4b are not affected (no breaking changes to existing Create() signature)
