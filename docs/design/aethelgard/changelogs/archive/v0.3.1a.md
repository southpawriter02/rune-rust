> **Archived** - This changelog has been consolidated. See the complete version at [v0.3.1](../v0.3.x/v0.3.1.md).

# v0.3.1a Changelog: The Blueprint (Core Crafting Engine)

**Release Date:** December 20, 2025
**Total Tests:** 1672 (17 new tests added)

---

## Summary

Version 0.3.1a introduces the **Core Crafting Engine** - the foundational system for player-driven item creation using WITS-based skill checks. This release establishes the Recipe registry pattern, CraftingService with 4-tier outcome determination, and 12 starter recipes across 4 crafting trades.

Key architectural additions:
- **CraftingTrade Enum**: Four specialization categories (Bodging, Alchemy, Runeforging, Field Medicine)
- **CraftingOutcome Enum**: Four-tier result classification (Failure, Success, Masterwork, Catastrophe)
- **Recipe Entity**: Definition model with ingredients, DC, and output configuration
- **RecipeRegistry**: Static registry pattern with 12 seed recipes (3 per trade)
- **CraftingService**: WITS-based crafting with quality tier scaling
- **Extended Command Parser**: New verbs (craft, make)

---

## New Features

### WITS-Based Crafting System
- **Dice Pool**: Character's WITS attribute determines number of d10s rolled
- **Success Threshold**: Rolls of 8+ count as successes; rolls of 1 count as botches
- **Net Successes**: Total successes minus botches compared to recipe DC
- **Ingredient Consumption**: Materials consumed before roll (regardless of outcome)

### Four-Tier Outcome System
- **Catastrophe (Net < 0)**: More botches than successes - materials destroyed
- **Failure (0 <= Net < DC)**: Roll insufficient - no output produced
- **Success (Net >= DC)**: Standard success - ClanForged quality output
- **Masterwork (Net >= DC + 5)**: Exceptional roll - MythForged quality output

### Four Crafting Trades
| Trade | Focus | Example Items |
|-------|-------|---------------|
| Bodging | Mechanical repairs, improvised tools | Torch, Lockpick, Rope |
| Alchemy | Potions, salves, chemical compounds | Stimulant, Antitoxin, Firebomb |
| Runeforging | Aetheric inscriptions, enchantments | Glow Stone, Ward Token, Battery |
| Field Medicine | Bandages, stimulants, medical kits | Bandage, Splint, Medkit |

### Recipe Registry (12 Starter Recipes)
Static registry pattern for non-persisted recipe data, initialized via static constructor.

---

## Files Created

### Core Layer

| File | Purpose |
|------|---------|
| `RuneAndRust.Core/Enums/CraftingTrade.cs` | Four crafting specializations: Bodging, Alchemy, Runeforging, FieldMedicine |
| `RuneAndRust.Core/Enums/CraftingOutcome.cs` | Four outcome types: Failure, Success, Masterwork, Catastrophe |
| `RuneAndRust.Core/Entities/Recipe.cs` | Recipe definition with DC, ingredients, and output configuration |
| `RuneAndRust.Core/Models/Crafting/CraftingResult.cs` | Record containing dice results, outcome, and produced item details |
| `RuneAndRust.Core/Interfaces/ICraftingService.cs` | Contract for crafting operations (6 methods) |
| `RuneAndRust.Core/Data/RecipeRegistry.cs` | Static registry with 12 seed recipes and lookup methods |

### Engine Layer

| File | Purpose |
|------|---------|
| `RuneAndRust.Engine/Services/CraftingService.cs` | WITS-based crafting logic with ingredient validation and quality scaling |

### Test Layer

| File | Purpose |
|------|---------|
| `RuneAndRust.Tests/Engine/CraftingServiceTests.cs` | Crafting mechanics validation (17 tests) |

---

## Files Modified

| File | Change |
|------|--------|
| `RuneAndRust.Engine/Services/CommandParser.cs` | Extended `ParseResult` with crafting flags; added craft/make/create commands |
| `RuneAndRust.Terminal/Program.cs` | Registered IItemRepository, IInventoryService, ICraftingService in DI; updated version to v0.3.1a |

---

## Code Implementation Details

### CraftingTrade Enum
```csharp
public enum CraftingTrade
{
    Bodging = 0,       // Mechanical repairs, improvised tools
    Alchemy = 1,       // Potions, salves, chemical compounds
    Runeforging = 2,   // Aetheric inscriptions, enchantments
    FieldMedicine = 3  // Bandages, stimulants, medical kits
}
```

### CraftingOutcome Enum
```csharp
public enum CraftingOutcome
{
    Failure = 0,      // Net successes < DC (no output, ingredients lost)
    Success = 1,      // Net successes >= DC (ClanForged quality)
    Masterwork = 2,   // Net successes >= DC + 5 (MythForged quality)
    Catastrophe = 3   // Net successes < 0 (materials destroyed)
}
```

### Recipe Entity
```csharp
public class Recipe
{
    public string RecipeId { get; set; }       // e.g., "RCP_ALC_STIM"
    public string Name { get; set; }            // Display name
    public string Description { get; set; }     // Narrative description
    public CraftingTrade Trade { get; set; }    // Trade category
    public int BaseDc { get; set; }             // Difficulty class
    public Dictionary<string, int> Ingredients { get; set; }  // ItemId -> Quantity
    public string OutputItemId { get; set; }    // Output item ID
    public int OutputQuantity { get; set; }     // Output count
    public List<string> RequiredKeywords { get; set; }  // Optional prerequisites
}
```

### CraftingResult Record
```csharp
public record CraftingResult(
    bool IsSuccess,
    CraftingOutcome Outcome,
    string RecipeId,
    string RecipeName,
    int DiceRolled,
    int Successes,
    int Botches,
    int NetSuccesses,
    int DifficultyClass,
    string? OutputItemId,
    int OutputQuantity,
    QualityTier? OutputQuality,
    string Message,
    IReadOnlyList<int> Rolls
);
```

### ICraftingService Interface
```csharp
public interface ICraftingService
{
    Task<CraftingResult> CraftItemAsync(Character crafter, string recipeId);
    bool HasIngredients(Character crafter, Recipe recipe);
    IReadOnlyList<Recipe> GetAvailableRecipes(Character crafter);
    IReadOnlyList<Recipe> GetRecipesByTrade(CraftingTrade trade);
    Recipe? GetRecipe(string recipeId);
    IReadOnlyList<Recipe> GetAllRecipes();
}
```

### RecipeRegistry Static Class
```csharp
public static class RecipeRegistry
{
    private static readonly Dictionary<string, Recipe> _recipes;
    public static IReadOnlyDictionary<string, Recipe> Recipes => _recipes;

    static RecipeRegistry() => InitializeRecipes();

    public static Recipe? GetById(string recipeId);
    public static IReadOnlyList<Recipe> GetByTrade(CraftingTrade trade);
    public static IReadOnlyList<Recipe> GetAll();

    private static void InitializeRecipes();  // Seeds 12 recipes
}
```

### CraftingService Outcome Thresholds
```csharp
private const int MasterworkThreshold = 5;  // DC + 5 for masterwork

private static CraftingOutcome DetermineOutcome(int netSuccesses, int dc)
{
    if (netSuccesses < 0)
        return CraftingOutcome.Catastrophe;
    if (netSuccesses >= dc + MasterworkThreshold)
        return CraftingOutcome.Masterwork;
    if (netSuccesses >= dc)
        return CraftingOutcome.Success;
    return CraftingOutcome.Failure;
}
```

### Quality Tier Mapping
```csharp
// Masterwork crafting produces MythForged quality
var masterworkItem = CloneItemWithQuality(outputItem, QualityTier.MythForged);

// Standard success produces ClanForged quality
var craftedItem = CloneItemWithQuality(outputItem, QualityTier.ClanForged);
```

### ParseResult Extensions
```csharp
public class ParseResult
{
    // Existing properties...

    // New crafting properties
    public bool RequiresCraft { get; set; }
    public string? CraftTarget { get; set; }
}
```

---

## Seed Recipe Data (12 Recipes)

### Bodging Recipes (3)
| Recipe ID | Name | DC | Ingredients | Output |
|-----------|------|-----|-------------|--------|
| RCP_BOD_TORCH | Improvised Torch | 2 | scrap_wood x1, oily_rag x1 | torch |
| RCP_BOD_LOCKPICK | Bent Lockpick | 3 | scrap_metal x2 | lockpick |
| RCP_BOD_ROPE | Knotted Rope | 2 | fiber_bundle x3 | rope |

### Alchemy Recipes (3)
| Recipe ID | Name | DC | Ingredients | Output |
|-----------|------|-----|-------------|--------|
| RCP_ALC_STIM | Basic Stimulant | 3 | blight_moss x1, clean_water x1 | stimulant |
| RCP_ALC_ANTITOX | Crude Antitoxin | 4 | blight_moss x2, charcoal x1 | antitoxin |
| RCP_ALC_FIREBOMB | Alchemist Fire | 5 | oily_rag x2, sulfur x1, glass_vial x1 | firebomb |

### Runeforging Recipes (3)
| Recipe ID | Name | DC | Ingredients | Output |
|-----------|------|-----|-------------|--------|
| RCP_RUN_GLOW | Glow Stone | 2 | quartz_shard x1, aether_dust x1 | glowstone |
| RCP_RUN_WARD | Minor Ward Token | 4 | iron_shard x1, aether_dust x2 | wardtoken |
| RCP_RUN_CHARGE | Runic Battery | 5 | copper_wire x2, aether_dust x3 | battery |

### Field Medicine Recipes (3)
| Recipe ID | Name | DC | Ingredients | Output |
|-----------|------|-----|-------------|--------|
| RCP_MED_BANDAGE | Field Bandage | 2 | clean_cloth x2 | bandage |
| RCP_MED_SPLINT | Emergency Splint | 3 | scrap_wood x1, clean_cloth x1 | splint |
| RCP_MED_KIT | Medkit | 4 | clean_cloth x3, blight_moss x1, clean_water x1 | medkit |

---

## Commands Reference (Updated)

### Exploration Phase Commands
| Command | Aliases | Action |
|---------|---------|--------|
| `craft <recipe>` | `make <recipe>`, `create <recipe>` | Attempt to craft using WITS roll |

---

## Logging Matrix (v0.3.1a)

### CraftingService Logs
| Event | Level | Template |
|-------|-------|----------|
| Craft Start | Information | `"Crafting attempt: {RecipeId} by {CharacterName}"` |
| Recipe Lookup | Debug | `"Recipe lookup: {RecipeId} found={Found}"` |
| Ingredient Check | Debug | `"Ingredient check: {ItemId} required={Required} has={Available}"` |
| Ingredient Consumed | Debug | `"Consumed: {Quantity}x {ItemId}"` |
| Consume Failed | Warning | `"Failed to consume ingredient {ItemId}: {Message}"` |
| Dice Roll | Debug | `"Craft roll: {Wits}d10 = {Successes}S/{Botches}B, Net={Net}, DC={DC}"` |
| Craft Success | Information | `"Craft SUCCESS: {RecipeName} -> {Quantity}x {ItemId} (ClanForged)"` |
| Craft Masterwork | Information | `"Craft MASTERWORK: {RecipeName} -> {Quantity}x {ItemId}"` |
| Craft Failure | Information | `"Craft FAILURE: {RecipeName} (Net {Net} < DC {DC})"` |
| Craft Catastrophe | Warning | `"Craft CATASTROPHE: {RecipeName} - materials lost!"` |

### CommandParser Logs
| Event | Level | Template |
|-------|-------|----------|
| Craft Command | Debug | `"Craft command for target: {Target}"` |

---

## Complete Test Inventory

### Engine/CraftingServiceTests.cs (17 tests)

#### Ingredient Validation Tests (3 tests)
| Test Name | Description |
|-----------|-------------|
| `CraftItem_WithUnknownRecipe_ReturnsFailure` | Unknown recipe returns failure |
| `CraftItem_WithInsufficientIngredients_ReturnsFailure` | Missing ingredients blocks crafting |
| `CraftItem_WithValidIngredients_ConsumesIngredients` | Verifies ingredient consumption |

#### Outcome Determination Tests (6 tests)
| Test Name | Description |
|-----------|-------------|
| `CraftItem_RollMeetsDc_ReturnsSuccess` | Net == DC returns Success |
| `CraftItem_RollExceedsDcBy5_ReturnsMasterwork` | Net >= DC + 5 returns Masterwork |
| `CraftItem_RollBelowDc_ReturnsFailure` | Net < DC returns Failure |
| `CraftItem_NetNegativeSuccesses_ReturnsCatastrophe` | Net < 0 returns Catastrophe |
| `CraftItem_RollExactlyAtMasterworkThreshold_ReturnsMasterwork` | Edge case for masterwork threshold |

#### HasIngredients Tests (4 tests)
| Test Name | Description |
|-----------|-------------|
| `HasIngredients_WithExactQuantity_ReturnsTrue` | Exact match passes |
| `HasIngredients_WithExcessQuantity_ReturnsTrue` | Excess quantity passes |
| `HasIngredients_WithMissingItem_ReturnsFalse` | Missing item fails |
| `HasIngredients_WithInsufficientQuantity_ReturnsFalse` | Insufficient quantity fails |

#### Recipe Query Tests (5 tests)
| Test Name | Description |
|-----------|-------------|
| `GetAvailableRecipes_FiltersToAffordable` | Only craftable recipes returned |
| `GetRecipesByTrade_ReturnsCorrectTrade` | Trade filtering works |
| `GetRecipe_WithValidId_ReturnsRecipe` | Valid ID returns recipe |
| `GetRecipe_WithInvalidId_ReturnsNull` | Invalid ID returns null |
| `GetAllRecipes_Returns12Recipes` | All 12 recipes returned |

---

## DI Registration

Added to `Program.cs`:
```csharp
// Register Repositories
services.AddScoped<IItemRepository, ItemRepository>();

// Register Inventory Services
services.AddScoped<IInventoryService, InventoryService>();

// Register Crafting Services (v0.3.1a)
services.AddScoped<ICraftingService, CraftingService>();
```

---

## Build Verification

```
Build succeeded.
    0 Error(s)

Test run:
  Passed: 1672
  Failed: 0
  Skipped: 0
```

---

## Directory Structure After v0.3.1a

```
RuneAndRust/
├── RuneAndRust.Core/
│   ├── Data/
│   │   └── RecipeRegistry.cs                [NEW]
│   ├── Entities/
│   │   ├── Character.cs
│   │   ├── Recipe.cs                        [NEW]
│   │   └── ... (existing entities)
│   ├── Enums/
│   │   ├── CraftingOutcome.cs               [NEW]
│   │   ├── CraftingTrade.cs                 [NEW]
│   │   └── ... (existing enums)
│   ├── Interfaces/
│   │   ├── ICraftingService.cs              [NEW]
│   │   └── ... (existing interfaces)
│   └── Models/
│       └── Crafting/
│           └── CraftingResult.cs            [NEW]
├── RuneAndRust.Engine/
│   └── Services/
│       ├── CommandParser.cs                 [MODIFIED]
│       ├── CraftingService.cs               [NEW]
│       └── ... (existing services)
├── RuneAndRust.Terminal/
│   └── Program.cs                           [MODIFIED]
├── RuneAndRust.Tests/
│   └── Engine/
│       ├── CraftingServiceTests.cs          [NEW]
│       └── ... (existing tests)
└── docs/
    └── changelogs/
        └── v0.3.1a.md                       [NEW]
```

---

## Dependencies

### Service Dependencies
| Service | Depends On |
|---------|------------|
| CraftingService | IDiceService, IInventoryService, IItemRepository, ILogger |

### Existing Infrastructure Used
| Component | Usage |
|-----------|-------|
| IDiceService | WITS pool rolling (d10 with 8+ success, 1 botch) |
| IInventoryService | Ingredient consumption, output item addition |
| IItemRepository | Item lookup for creating output items |
| QualityTier | Output quality (ClanForged for success, MythForged for masterwork) |

---

## Test Summary by Category

| Category | Test Count |
|----------|------------|
| CraftItemAsync - Ingredient Validation | 3 |
| CraftItemAsync - Outcome Determination | 6 |
| HasIngredients | 4 |
| Recipe Queries | 5 |
| **v0.3.1a New Tests** | **17** |
| **Total** | **1672** |

---

## Running Tests

```bash
# Run all tests
dotnet test RuneAndRust.Tests

# Run only v0.3.1a new tests
dotnet test RuneAndRust.Tests --filter "FullyQualifiedName~CraftingService"

# Run crafting outcome tests specifically
dotnet test RuneAndRust.Tests --filter "FullyQualifiedName~CraftingService&FullyQualifiedName~Outcome"
```

---

## Migration Notes

- **No database migrations required**: Recipes use static registry pattern (not persisted)
- **RecipeRegistry auto-initializes**: Static constructor seeds all 12 recipes
- **ICraftingService registered as Scoped**: Inherits scope from IInventoryService dependency

---

## Next Steps (v0.3.1b: Crafting UI)

Potential features for the next sub-release:
- CraftingScreenRenderer for dedicated crafting interface
- Recipe list display with ingredient availability indicators
- Crafting progress and result feedback
- Integration with exploration phase flow
