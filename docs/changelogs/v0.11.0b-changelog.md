# v0.11.0b Changelog: Harvestable Features

**Version:** 0.11.0b
**Phase:** Harvestable Features (Room Environmental Objects)
**Date:** 2026-01-19
**Status:** Complete

---

## Summary

Implements harvestable room features that yield resources when gathered by players. Features are environmental objects placed in rooms that connect the resource system to gameplay through gathering mechanics with difficulty checks, tool requirements, and replenishment timers.

---

## Added

### Domain Layer - Definitions

| Entity | Description |
|--------|-------------|
| `HarvestableFeatureDefinition` | Data-driven template for harvestable features loaded from JSON |

#### HarvestableFeatureDefinition Properties

| Property | Type | Description |
|----------|------|-------------|
| `Id` | `Guid` | Unique identifier (IEntity requirement) |
| `FeatureId` | `string` | Lowercase string identifier for lookups |
| `Name` | `string` | Display name shown in room descriptions |
| `Description` | `string` | Detailed description when examining |
| `ResourceId` | `string` | ID of resource yielded when gathered |
| `MinQuantity` | `int` | Minimum yield on successful gather |
| `MaxQuantity` | `int` | Maximum yield on successful gather |
| `DifficultyClass` | `int` | DC for gathering check (d20 + modifier >= DC) |
| `RequiredToolId` | `string?` | Optional tool ID required to gather |
| `ReplenishTurns` | `int` | Turns until replenishment (0 = never) |
| `IconPath` | `string?` | Optional icon path |

#### HarvestableFeatureDefinition Methods

| Method | Description |
|--------|-------------|
| `Create(...)` | Factory method with validation |
| `WithIcon(path)` | Fluent builder for icon |
| `GetYieldRangeDisplay()` | Returns "min-max" or single value display |
| `GetRequirementsSummary()` | Returns formatted requirements string |

#### HarvestableFeatureDefinition Computed Properties

| Property | Description |
|----------|-------------|
| `RequiresTool` | True if RequiredToolId is set |
| `Replenishes` | True if ReplenishTurns > 0 |

### Domain Layer - Entities

| Entity | Description |
|--------|-------------|
| `HarvestableFeature` | Runtime instance of a harvestable feature placed in a room |

#### HarvestableFeature Properties

| Property | Type | Description |
|----------|------|-------------|
| `Id` | `Guid` | Unique instance identifier |
| `DefinitionId` | `string` | Reference to the feature definition |
| `Name` | `string` | Display name (from definition) |
| `Description` | `string` | Description text (from definition) |
| `RemainingQuantity` | `int` | Current yield remaining |
| `InitialQuantity` | `int` | Original yield for replenishment |
| `ReplenishAtTurn` | `int?` | Turn number when feature replenishes |
| `IsInteractable` | `bool` | Always true for harvestable features |
| `InteractionVerb` | `string` | Always "gather" for harvesting |

#### HarvestableFeature Computed Properties

| Property | Description |
|----------|-------------|
| `IsDepleted` | True if RemainingQuantity == 0 |
| `IsAwaitingReplenishment` | True if ReplenishAtTurn is set |
| `CanHarvest` | True if not depleted and not awaiting replenishment |

#### HarvestableFeature Methods

| Method | Description |
|--------|-------------|
| `Create(definition, quantity)` | Factory method from definition |
| `CreateWithRandomQuantity(definition, random?)` | Factory with random yield in range |
| `Harvest(amount)` | Reduce remaining quantity |
| `SetReplenishTimer(currentTurn, replenishTurns)` | Set future replenishment turn |
| `ShouldReplenish(currentTurn)` | Check if ready to replenish |
| `Replenish(quantity?)` | Restore to initial or specified quantity |
| `GetStatusDisplay()` | Returns human-readable status string |

### Application Layer - Interfaces

| Interface | Description |
|-----------|-------------|
| `IHarvestableFeatureProvider` | Service interface for feature definitions |

#### IHarvestableFeatureProvider Methods

| Method | Description |
|--------|-------------|
| `GetFeature(id)` | Get definition by ID (case-insensitive) |
| `GetAllFeatures()` | Get all definitions |
| `GetFeaturesByResource(resourceId)` | Filter by yielded resource |
| `GetFeaturesByTool(toolId)` | Filter by required tool |
| `GetFeaturesByDifficulty(minDC, maxDC)` | Filter by DC range |
| `Exists(id)` | Check existence |
| `GetFeatureIds()` | Get all IDs |
| `CreateFeatureInstance(id, random?)` | Create runtime instance |
| `Count` | Total feature count |

### Infrastructure Layer - Providers

| Provider | Description |
|----------|-------------|
| `JsonHarvestableFeatureProvider` | Loads features from JSON configuration |

#### Provider Features

- Case-insensitive dictionary lookups
- Resource ID validation against IResourceProvider during loading
- Exhaustive logging at Debug/Information/Warning/Error levels
- Internal DTOs for JSON deserialization

### Domain Layer - Room Integration

Added to `Room.cs`:

| Member | Type | Description |
|--------|------|-------------|
| `_harvestableFeatures` | `List<HarvestableFeature>` | Private field for feature instances |
| `HarvestableFeatures` | `IReadOnlyList<HarvestableFeature>` | Read-only access to features |
| `HasHarvestableFeatures` | `bool` | True if any features exist |
| `HasAvailableHarvestableFeatures` | `bool` | True if any features can be harvested |

#### Room Methods Added

| Method | Description |
|--------|-------------|
| `AddHarvestableFeature(feature)` | Add a feature to the room |
| `RemoveHarvestableFeature(feature)` | Remove a feature from the room |
| `GetHarvestableFeatures()` | Get all features |
| `GetAvailableHarvestableFeatures()` | Get features that can be harvested |
| `GetHarvestableFeatureByDefinitionId(id)` | Find feature by definition ID |
| `GetHarvestableFeatureByKeyword(keyword)` | Find feature by name keyword |
| `ProcessFeatureReplenishment(currentTurn)` | Replenish ready features |

### Configuration Files

| File | Description |
|------|-------------|
| `config/schemas/harvestable-features.schema.json` | JSON Schema for validation |
| `config/harvestable-features.json` | 8 harvestable feature definitions |

---

## Feature Definitions

### Ore Features

| ID | Name | Resource | DC | Yield | Tool | Replenish |
|----|------|----------|----|----- -|------|-----------|
| iron-ore-vein | Iron Ore Vein | iron-ore | 12 | 1-5 | None | Never |
| copper-ore-vein | Copper Ore Vein | copper-ore | 10 | 2-6 | None | Never |
| gold-ore-vein | Gold Ore Vein | gold-ore | 15 | 1-3 | Pickaxe | Never |

### Herb Features

| ID | Name | Resource | DC | Yield | Tool | Replenish |
|----|------|----------|----|----- -|------|-----------|
| herb-patch | Herb Patch | healing-herb | 10 | 2-6 | None | 100 turns |
| mana-leaf-cluster | Mana Leaf Cluster | mana-leaf | 13 | 1-4 | None | 150 turns |

### Other Features

| ID | Name | Resource | DC | Yield | Tool | Replenish |
|----|------|----------|----|----- -|------|-----------|
| leather-source | Fallen Creature | leather | 11 | 1-3 | Skinning Knife | Never |
| gem-cluster | Gem Cluster | ruby | 16 | 1-2 | Pickaxe | Never |
| fallen-tree | Fallen Tree | oak-wood | 10 | 3-8 | Axe | Never |

---

## Difficulty Class Guide

| DC | Difficulty | Description |
|----|------------|-------------|
| 10 | Easy | Copper, herbs, wood |
| 11-12 | Medium | Iron, leather |
| 13-15 | Hard | Gold, mana leaves |
| 16+ | Very Hard | Gems |

---

## Unit Tests

### HarvestableFeatureDefinitionTests (~30 tests)

- Factory method validation
- Parameter validation (null, empty, negative values)
- Optional parameter handling (tool, replenish turns)
- Computed properties (RequiresTool, Replenishes)
- Display methods (GetYieldRangeDisplay, GetRequirementsSummary)
- Fluent builder methods

### HarvestableFeatureTests (~40 tests)

- Factory methods (Create, CreateWithRandomQuantity)
- Harvest mechanics (reduce quantity, depletion)
- Replenishment timer (set, check, execute)
- Computed properties (IsDepleted, IsAwaitingReplenishment, CanHarvest)
- Display methods (GetStatusDisplay, ToString)
- Edge cases (zero quantity, negative amounts)

### JsonHarvestableFeatureProviderTests (~35 tests)

- Constructor loading from configuration
- GetFeature by ID (existing, non-existing, case-insensitive)
- GetAllFeatures returns all loaded
- GetFeaturesByResource filtering
- GetFeaturesByTool filtering
- GetFeaturesByDifficulty range filtering
- CreateFeatureInstance with random quantity
- Exists checks
- GetFeatureIds enumeration
- Tool requirement loading
- Replenishment loading
- Icon path loading

---

## Files Created

| Path | Description |
|------|-------------|
| `src/Core/RuneAndRust.Domain/Definitions/HarvestableFeatureDefinition.cs` | Feature definition entity |
| `src/Core/RuneAndRust.Domain/Entities/HarvestableFeature.cs` | Feature runtime instance |
| `src/Core/RuneAndRust.Application/Interfaces/IHarvestableFeatureProvider.cs` | Provider interface |
| `src/Infrastructure/RuneAndRust.Infrastructure/Providers/JsonHarvestableFeatureProvider.cs` | JSON provider |
| `config/schemas/harvestable-features.schema.json` | JSON Schema |
| `config/harvestable-features.json` | Feature definitions |
| `tests/.../Definitions/HarvestableFeatureDefinitionTests.cs` | Definition tests |
| `tests/.../Entities/HarvestableFeatureTests.cs` | Entity tests |
| `tests/.../Providers/JsonHarvestableFeatureProviderTests.cs` | Provider tests |

## Files Modified

| Path | Description |
|------|-------------|
| `src/Core/RuneAndRust.Domain/Entities/Room.cs` | Added harvestable feature integration |

---

## API Examples

### Loading Features

```csharp
// Provider requires IResourceProvider for validation
var featureProvider = new JsonHarvestableFeatureProvider(
    "config/harvestable-features.json",
    resourceProvider,
    logger);

// Get specific feature definition
var oreVein = featureProvider.GetFeature("iron-ore-vein");
Console.WriteLine($"{oreVein.Name}: DC {oreVein.DifficultyClass}, Yield {oreVein.GetYieldRangeDisplay()}");
// Output: Iron Ore Vein: DC 12, Yield 1-5
```

### Creating Feature Instances

```csharp
// Create instance with random quantity
var feature = featureProvider.CreateFeatureInstance("iron-ore-vein");
room.AddHarvestableFeature(feature);
Console.WriteLine($"Spawned {feature.Name} with {feature.RemainingQuantity} resources");
```

### Harvesting Resources

```csharp
// Get available features in room
var available = room.GetAvailableHarvestableFeatures();
var feature = available.First();

// Harvest from feature
feature.Harvest(3);
Console.WriteLine($"Remaining: {feature.RemainingQuantity}");

if (feature.IsDepleted)
{
    // Set replenishment timer if feature replenishes
    var definition = featureProvider.GetFeature(feature.DefinitionId);
    if (definition.Replenishes)
    {
        feature.SetReplenishTimer(currentTurn, definition.ReplenishTurns);
    }
}
```

### Processing Replenishment

```csharp
// Each turn, check for replenishment
room.ProcessFeatureReplenishment(currentTurn);

// Or manually check individual features
foreach (var feature in room.HarvestableFeatures)
{
    if (feature.ShouldReplenish(currentTurn))
    {
        feature.Replenish();
        Console.WriteLine($"{feature.Name} has regrown!");
    }
}
```

### Filtering Features

```csharp
// Get all features requiring a pickaxe
var pickaxeFeatures = featureProvider.GetFeaturesByTool("pickaxe");

// Get easy features for beginner areas
var easyFeatures = featureProvider.GetFeaturesByDifficulty(10, 12);

// Get all iron ore sources
var ironSources = featureProvider.GetFeaturesByResource("iron-ore");
```

---

## v0.11.0 Progress

| Version | Feature | Status |
|---------|---------|--------|
| v0.11.0a | Resource Definitions | Complete |
| v0.11.0b | Harvestable Features | Complete |
| v0.11.0c | Recipe Definitions | Pending |
| v0.11.0d | Crafting Service | Pending |

---

## Dependencies

- Builds on v0.11.0a (Resource Definitions)
- `IResourceProvider` required for resource ID validation during loading
- Follows `JsonResourceProvider` pattern for JSON loading
- `HarvestableFeatureDefinition` and `HarvestableFeature` implement `IEntity` interface
- Uses existing logging patterns (Debug/Info/Warning/Error)

---

## Notes

- Feature IDs use kebab-case (lowercase with hyphens)
- Resource IDs must match valid resources in `IResourceProvider`
- Provider uses case-insensitive dictionary lookups
- Replenishing features regrow after specified turns when depleted
- Tool requirements are optional (null means no tool needed)
- Features with ReplenishTurns = 0 are one-time harvests
- Room integration follows existing entity list patterns (monsters, items, etc.)
