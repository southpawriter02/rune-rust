# v0.4.0b Changelog - Containers & Locks

**Release Date:** 2026-01-12
**Focus:** Container inventories, key items, lock system, lockpicking

## Summary

This release implements container inventories for chests, crates, and barrels, and adds a complete lock and key system. Containers can now hold items with capacity limits, and locked objects can be opened with keys or lockpicked.

## New Features

### ContainerInventory Value Object
- Item storage with configurable capacity limits
- `TryAddItem()`, `RemoveItem()` methods
- `GetItemByName()`, `GetItemByPartialName()` search
- `TakeAll()` to empty container
- `Populate()` for initialization
- `GetContentsDescription()` for display

### LockDefinition Value Object
- `LockId`, `RequiredKeyId` identifiers
- `IsLockpickable`, `LockpickDC` for lockpicking
- `KeyConsumedOnUse`, `CanRelock` options
- Factory methods: `None`, `KeyOnly()`, `Pickable()`, `KeyOrPick()`
- `KeyMatches()` for key validation

### UnlockResult Value Object
- Track unlock success/failure
- `UnlockMethod` enum: None, Key, Lockpick
- Factory methods: `SuccessWithKey()`, `SuccessWithLockpick()`, `Failed()`

### ItemType.Key
- New enum value for key items
- `Item.KeyId` - lock ID this key opens
- `Item.IsKey` - computed property
- `Item.IsKeyConsumedOnUse` - single-use keys
- Factory methods: `CreateKey()`, `CreateIronKey()`, `CreateOrnateKey()`

### InteractiveObject Container/Lock Support
- `ContainerInventory` property for containers
- `IsContainer` computed property
- `Lock` property with `HasLock`, `IsLocked`
- `SetupAsContainer()`, `SetLock()` methods
- `TryUnlockWithKey()`, `Unlock()`, `TryLock()` methods

### InteractionService Updates
- `UnlockWithKey()` - auto-detects matching key in inventory
- `PickLock()` - unlocks if lockpickable
- `Lock()` - relocks if allowed
- `TakeFromContainer()`, `TakeAllFromContainer()`, `PutInContainer()`
- `GetContainerContents()` for display
- `Open()` updated to show container contents

## Files Created

### Domain Value Objects
- `src/Core/RuneAndRust.Domain/ValueObjects/ContainerInventory.cs`
- `src/Core/RuneAndRust.Domain/ValueObjects/LockDefinition.cs`
- `src/Core/RuneAndRust.Domain/ValueObjects/UnlockResult.cs`

### Unit Tests
- `tests/RuneAndRust.Domain.UnitTests/ValueObjects/ContainerInventoryTests.cs`
- `tests/RuneAndRust.Domain.UnitTests/ValueObjects/LockDefinitionTests.cs`
- `tests/RuneAndRust.Domain.UnitTests/Entities/InteractiveObjectLockTests.cs`

## Files Modified

### Domain Enums
- `src/Core/RuneAndRust.Domain/Enums/ItemType.cs` - +Key value

### Domain Entities
- `src/Core/RuneAndRust.Domain/Entities/Item.cs` - +KeyId, IsKey, factory methods
- `src/Core/RuneAndRust.Domain/Entities/InteractiveObject.cs` - +Container/lock properties/methods
- `src/Core/RuneAndRust.Domain/Definitions/InteractiveObjectDefinition.cs` - +Container/lock config

### Application Layer
- `src/Core/RuneAndRust.Application/Interfaces/IInteractionService.cs` - +7 methods
- `src/Core/RuneAndRust.Application/Services/InteractionService.cs` - +7 implementations

## Test Results

- **~40 new tests** added
- **All 1376 tests pass** (914 Domain + 454 Application + 8 Architecture)
- **0 errors, 0 warnings**

## Breaking Changes

None. All changes are additive and backwards compatible.

## Dependencies

- Requires v0.4.0a (Interactive Object Core) complete
- No new package dependencies

## Usage Example

```csharp
// Create a locked chest with container
var chest = InteractiveObject.Create(
    "locked-chest", "Locked Chest", "A sturdy chest.",
    InteractiveObjectType.Chest, ObjectState.Closed);
chest.SetupAsContainer(10);
chest.SetLock(LockDefinition.KeyOrPick("chest-lock", "chest-key", dc: 12));

// Add items to container
chest.ContainerInventory!.TryAddItem(Item.CreateHealthPotion());
chest.ContainerInventory.TryAddItem(Item.CreateIronKey("door-key"));

// Unlock with key
var key = Item.CreateIronKey("chest-key");
player.Inventory.TryAdd(key);
var unlockResult = interactionService.UnlockWithKey(chest, player);

// Open and see contents
var openResult = interactionService.Open(chest);
// Output: "You open the Locked Chest.
//         Inside you find:
//           - Health Potion
//           - Iron Key"

// Take item from container
interactionService.TakeFromContainer(chest, "potion", player);
```

## v0.4.0 Milestone Progress

| Sub-Version | Focus | Status |
|-------------|-------|--------|
| v0.4.0a | Interactive Object Core | âœ… Complete |
| v0.4.0b | Containers & Locks | âœ… Complete |
| v0.4.0c | Activation & Destruction | ðŸ”² Pending |

## Next Steps

- **v0.4.0c**: Lever/button activation, linked effects, destructible objects
