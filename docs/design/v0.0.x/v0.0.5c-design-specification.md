## Phase 5c: Combat Integration

[Implementation Plan](v0.0.5c-implementation-plan.md)

### Overview
Refactor combat to use dice-based attack and damage rolls instead of static calculations.

### Files to Modify

#### 1. Update CombatService

**File:** `src/Core/RuneAndRust.Domain/Services/CombatService.cs` (MODIFY)

Key changes:
- Add `DiceService` dependency
- Replace `CalculateDamage()` with dice-based calculation
- Add `AttackRoll()` method for hit determination
- Add `DamageRoll()` method for damage calculation
- Add support for critical hits/misses

```csharp
// New attack flow
public CombatRoundResult ResolveCombatRound(Player player, Monster monster, DiceService diceService)
{
    // 1. Player attack roll (1d20 + Finesse vs Monster Defense)
    var attackRoll = diceService.Roll(DicePool.D20());
    var attackTotal = attackRoll.Total + player.Attributes.Finesse;

    var isHit = attackTotal >= monster.Stats.Defense || attackRoll.IsNaturalMax;
    var isCriticalHit = attackRoll.IsNaturalMax;
    var isCriticalMiss = attackRoll.IsNaturalOne;

    int playerDamage = 0;
    DiceRollResult? damageRoll = null;

    if (isHit && !isCriticalMiss)
    {
        // 2. Damage roll (weapon dice + Might)
        var damagePool = GetPlayerDamagePool(player); // Default: 1d6
        if (isCriticalHit)
        {
            // Critical hit: double dice
            damagePool = damagePool with { Count = damagePool.Count * 2 };
        }

        damageRoll = diceService.Roll(damagePool);
        playerDamage = damageRoll.Value.Total + player.Attributes.Might;
        playerDamage = Math.Max(1, playerDamage - monster.Stats.Defense / 2); // Armor reduces damage

        monster.TakeDamage(playerDamage);
    }

    // 3. Monster counterattack (if alive)
    // Similar flow...

    return new CombatRoundResult(
        AttackRoll: attackRoll,
        AttackTotal: attackTotal,
        IsHit: isHit,
        IsCriticalHit: isCriticalHit,
        IsCriticalMiss: isCriticalMiss,
        DamageRoll: damageRoll,
        DamageDealt: playerDamage,
        MonsterCounterAttack: monsterAttackResult,
        MonsterDefeated: monster.IsDefeated,
        PlayerDefeated: player.IsDead);
}
```

#### 2. New Combat Result Types

**File:** `src/Core/RuneAndRust.Domain/ValueObjects/CombatResults.cs` (NEW)

```csharp
/// <summary>
/// Detailed result of a combat round with dice breakdown.
/// </summary>
public record CombatRoundResult(
    DiceRollResult AttackRoll,
    int AttackTotal,
    bool IsHit,
    bool IsCriticalHit,
    bool IsCriticalMiss,
    DiceRollResult? DamageRoll,
    int DamageDealt,
    MonsterCounterAttackResult? MonsterCounterAttack,
    bool MonsterDefeated,
    bool PlayerDefeated);

/// <summary>
/// Result of a monster's counterattack.
/// </summary>
public record MonsterCounterAttackResult(
    DiceRollResult AttackRoll,
    int AttackTotal,
    bool IsHit,
    DiceRollResult? DamageRoll,
    int DamageDealt);
```

### Phase 5c Tests (~15 tests)

**File:** `tests/RuneAndRust.Domain.UnitTests/Services/CombatServiceDiceTests.cs`
- Attack roll succeeds when total >= defense
- Attack roll fails when total < defense
- Critical hit on natural 20 doubles damage dice
- Critical miss on natural 1 always misses
- Damage roll uses weapon dice pool
- Monster counterattack uses dice
- Combat round returns full dice breakdown

### Phase 5c Deliverables Checklist

- [ ] `CombatResults.cs` - New result types with dice breakdown
- [ ] Update `CombatService` to use `DiceService`
- [ ] Add attack roll logic with criticals
- [ ] Add damage roll logic with modifiers
- [ ] Update `GameSessionService.TryAttack()` to pass DiceService
- [ ] Update combat DTOs for dice display
- [ ] 15 new tests
- [ ] All existing tests still pass (may need updates)

---

## Testing Strategy

### Test Categories

| Category | Location | Count | Coverage |
|----------|----------|-------|----------|
| Domain Value Objects | Domain.UnitTests/ValueObjects/ | ~20 | DicePool, DiceRollResult, SkillCheckResult |
| Domain Definitions | Domain.UnitTests/Definitions/ | ~8 | SkillDefinition, DifficultyClassDefinition |
| Application Services | Application.UnitTests/Services/ | ~25 | DiceService, SkillCheckService |
| Integration | Application.UnitTests/Integration/ | ~9 | Command handling, rendering |

### Test Patterns

```csharp
// Pattern 1: Deterministic Testing with Seeded Random
[Test]
public void Roll_WithSeededRandom_ProducesExpectedResult()
{
    var seededRandom = new Random(42); // Fixed seed
    var service = new DiceService(_mockLogger.Object, seededRandom);

    var result = service.Roll(DicePool.D20());

    result.Rolls[0].Should().Be(/* expected value for seed 42 */);
}

// Pattern 2: Statistical Testing
[Test]
public void Roll_ManyTimes_ProducesUniformDistribution()
{
    var results = Enumerable.Range(0, 10000)
        .Select(_ => _service.Roll(DicePool.D6()))
        .GroupBy(r => r.Total)
        .ToDictionary(g => g.Key, g => g.Count());

    // Each face should appear roughly 1666 times (10000/6)
    foreach (var count in results.Values)
    {
        count.Should().BeInRange(1400, 1900);
    }
}

// Pattern 3: Boundary Testing
[Test]
public void Roll_NeverExceedsMaximum()
{
    var pool = new DicePool(3, DiceType.D6, 5);
    var results = Enumerable.Range(0, 1000).Select(_ => _service.Roll(pool));

    results.Should().AllSatisfy(r => r.Total.Should().BeLessThanOrEqualTo(23));
}
```

### Mock Configurations

```csharp
// IGameConfigurationProvider mock for skills
_mockConfig.Setup(c => c.GetSkillById("perception"))
    .Returns(SkillDefinition.Create(
        "perception", "Perception", "Notice things",
        "wits", null, "1d20"));

_mockConfig.Setup(c => c.GetDifficultyClassById("moderate"))
    .Returns(DifficultyClassDefinition.Create(
        "moderate", "Moderate", "Requires effort", 12));
```

---

## Logging Strategy

### Log Levels by Operation

| Operation | Level | Example |
|-----------|-------|---------|
| Service initialization | Information | "DiceService initialized" |
| Roll request | Debug | "Rolling 3d6+5 with Advantage" |
| Individual die | Debug | "Die 1: rolled 4 on d6" |
| Explosion | Debug | "Die exploded! Roll 6 on d6" |
| Roll complete | Information | "Roll 3d6+5: [4,2,6]+5=17" |
| Skill check request | Debug | "Skill check: perception vs DC 15" |
| Skill check complete | Information | "Skill check: 18 vs DC 15 = Success" |
| Critical result | Information | "Critical success on perception!" |
| Parse error | Warning | "Invalid dice notation: xyz" |

### Structured Logging Format

```csharp
_logger.LogInformation(
    "Dice roll complete: Pool={Pool} Rolls={@Rolls} Explosions={@Explosions} Total={Total}",
    pool.ToString(),
    rolls,
    explosions,
    total);

_logger.LogInformation(
    "Skill check: Skill={Skill} Roll={Roll} Bonus={Bonus} Total={Total} DC={DC} Result={Result}",
    skillId,
    rollResult.Total,
    attributeBonus,
    totalResult,
    difficultyClass,
    successLevel);
```

---

## Acceptance Criteria

### Phase 5a: Core Dice Engine
- [ ] Can roll any standard dice type (d4, d6, d8, d10, d12, d20, d100)
- [ ] Dice notation parsing works (e.g., "3d6+5", "1d20-2", "2d8!")
- [ ] Exploding dice trigger on maximum value
- [ ] Advantage rolls twice and takes higher
- [ ] Disadvantage rolls twice and takes lower
- [ ] Roll results include individual die values
- [ ] 18 new tests pass

### Phase 5b: Skill Check System
- [ ] 10 skills defined in configuration
- [ ] 8 difficulty classes defined
- [ ] Skill checks use player attributes
- [ ] Critical success on natural max
- [ ] Critical failure on natural 1
- [ ] Skill check results include full breakdown
- [ ] 20 new tests pass

### Phase 5c: Combat Integration
- [ ] Attack rolls determine hit/miss
- [ ] Critical hits double damage dice
- [ ] Critical misses always miss
- [ ] Damage rolls include weapon dice
- [ ] Monster counterattacks use dice
- [ ] Combat results show full dice breakdown
- [ ] 15 new tests pass

### Phase 5d: Configuration & Polish
- [ ] `roll <notation>` command works
- [ ] `check <skill>` command works
- [ ] Dice rolls display with formatting
- [ ] Descriptors appear for critical rolls
- [ ] Combat round displays dice breakdown
- [ ] 9 new tests pass
- [ ] All 260 tests pass
- [ ] Build: 0 errors, 0 warnings

---

## Risk Assessment

| Risk | Impact | Probability | Mitigation |
|------|--------|-------------|------------|
| Combat balance disruption | High | Medium | Keep variance similar to current system initially |
| Infinite explosion loops | Medium | Low | MaxExplosions cap (default 10) |
| Random test flakiness | Medium | Medium | Use seeded Random for deterministic tests |
| Performance with many dice | Low | Low | Dice pools limited by game design |
| Breaking existing tests | High | Medium | Phase-by-phase integration with regression testing |

---

## Summary

### Files to Create (New)

| Phase | File | Purpose |
|-------|------|---------|
| 5c | `CombatResults.cs` | Combat result records |

### Files to Modify

| Phase | File | Changes |
|-------|------|---------|
| 5c | `CombatService.cs` | Use dice for combat |
| 5c | `GameSessionService.cs` | Pass DiceService to combat |

### Test Files to Create

| Phase | File | Count |
|-------|------|-------|
| 5c | `CombatServiceDiceTests.cs` | 15 |
