# v0.18.2b Design Specification: Panic & Result Objects

**Version:** 0.18.2b
**Parent:** v0.18.2 (Cognitive Paradox Syndrome)
**Prerequisites:** v0.18.2a Complete (CPS Enums & State)
**Status:** Design Complete
**Estimated Unit Tests:** ~2

---

## Table of Contents

1. [Executive Summary](#1-executive-summary)
2. [Feature Overview](#2-feature-overview)
3. [Architecture Diagrams](#3-architecture-diagrams)
4. [User Stories](#4-user-stories)
5. [PanicResult Record](#5-panicresult-record)
6. [CpsStageChangeResult Record](#6-cpsstagechangeresult-record)
7. [CpsUiEffects Record](#7-cpsuieffects-record)
8. [CpsRecoveryProtocol Record](#8-cpsrecoveryprotocol-record)
9. [Logging Specifications](#9-logging-specifications)
10. [Unit Testing Requirements](#10-unit-testing-requirements)
11. [Deliverable Checklist](#11-deliverable-checklist)
12. [Acceptance Criteria](#12-acceptance-criteria)
13. [Dependencies](#13-dependencies)
14. [Future Considerations](#14-future-considerations)

---

## 1. Executive Summary

This design specification defines the **result value objects** for the CPS system — the data structures that communicate outcomes of CPS operations to the rest of the system.

v0.18.2b establishes four result/effect records:

- `PanicResult` — Outcome of Panic Table rolls
- `CpsStageChangeResult` — Detection of CPS stage transitions
- `CpsUiEffects` — Visual distortion parameters by stage
- `CpsRecoveryProtocol` — Recovery steps for each CPS stage

### Key Deliverables

| Category          | Items                                                              |
| ----------------- | ------------------------------------------------------------------ |
| **Value Objects** | `PanicResult`, `CpsStageChangeResult`, `CpsUiEffects`, `CpsRecoveryProtocol` |
| **Tests**         | ~2 unit tests                                                      |

### Architectural Significance

These value objects establish the **Result Object Pattern** used throughout the trauma economy — immutable records that encapsulate operation outcomes with all relevant context for logging, UI updates, and state transitions.

---

## 2. Feature Overview

```
v0.18.2b Features
└── CPS Result Objects (Domain Layer)
    │
    ├── PanicResult (Record)
    │   ├── DieRoll: int (1-10)
    │   ├── Effect: PanicEffect
    │   ├── EffectName: string
    │   ├── Description: string
    │   ├── DurationTurns: int?
    │   ├── SelfDamage: int?
    │   ├── StatusEffects: IReadOnlyList<string>
    │   ├── ForcesAction: bool
    │   └── ForcedActionType: string?
    │
    ├── CpsStageChangeResult (Record)
    │   ├── PreviousStage: CpsStage
    │   ├── NewStage: CpsStage
    │   ├── StageChanged: bool (computed)
    │   ├── StageWorsened: bool (computed)
    │   ├── StageImproved: bool (computed)
    │   ├── EnteredRuinMadness: bool (computed)
    │   └── EnteredHollowShell: bool (computed)
    │
    ├── CpsUiEffects (Record)
    │   ├── Stage: CpsStage
    │   ├── DistortionIntensity: float (0.0-1.0)
    │   ├── PeripheralStatic: bool
    │   ├── TextGlitching: bool
    │   ├── LeetSpeakLevel: int (0-4)
    │   ├── SystemWarnings: bool
    │   ├── ColorTint: string
    │   └── ScreenLag: bool
    │
    └── CpsRecoveryProtocol (Record)
        ├── Stage: CpsStage
        ├── IsRecoverable: bool
        ├── ProtocolName: string
        ├── Steps: IReadOnlyList<string>
        ├── RecoveryTime: string
        └── Urgency: string
```

---

## 3. Architecture Diagrams

### 3.1 Domain Layer Structure

```
┌─────────────────────────────────────────────────────────────────────────┐
│                          DOMAIN LAYER                                    │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                          │
│  ┌─────────────────────────────────────────────────────────────────┐    │
│  │                    RESULT VALUE OBJECTS                          │    │
│  ├─────────────────────────────┬───────────────────────────────────┤    │
│  │        PanicResult          │      CpsStageChangeResult         │    │
│  ├─────────────────────────────┼───────────────────────────────────┤    │
│  │ + DieRoll: int              │ + PreviousStage: CpsStage         │    │
│  │ + Effect: PanicEffect       │ + NewStage: CpsStage              │    │
│  │ + EffectName: string        │ + StageChanged: bool              │    │
│  │ + Description: string       │ + StageWorsened: bool             │    │
│  │ + DurationTurns: int?       │ + StageImproved: bool             │    │
│  │ + SelfDamage: int?          │ + EnteredRuinMadness: bool        │    │
│  │ + StatusEffects: List       │ + EnteredHollowShell: bool        │    │
│  │ + ForcesAction: bool        │                                   │    │
│  │ + ForcedActionType: string? │                                   │    │
│  └─────────────────────────────┴───────────────────────────────────┘    │
│                                                                          │
│  ┌─────────────────────────────┬───────────────────────────────────┐    │
│  │       CpsUiEffects          │      CpsRecoveryProtocol          │    │
│  ├─────────────────────────────┼───────────────────────────────────┤    │
│  │ + Stage: CpsStage           │ + Stage: CpsStage                 │    │
│  │ + DistortionIntensity: float│ + IsRecoverable: bool             │    │
│  │ + PeripheralStatic: bool    │ + ProtocolName: string            │    │
│  │ + TextGlitching: bool       │ + Steps: List<string>             │    │
│  │ + LeetSpeakLevel: int       │ + RecoveryTime: string            │    │
│  │ + SystemWarnings: bool      │ + Urgency: string                 │    │
│  │ + ColorTint: string         │                                   │    │
│  │ + ScreenLag: bool           │                                   │    │
│  └─────────────────────────────┴───────────────────────────────────┘    │
│                                                                          │
└─────────────────────────────────────────────────────────────────────────┘
```

### 3.2 Panic Table Flow

```
┌────────────────────────────────────────────────────────────────────────┐
│                      PANIC TABLE RESOLUTION FLOW                         │
└────────────────────────────────────────────────────────────────────────┘

     ┌─────────────────────────┐
     │  Character in           │
     │  RuinMadness Stage      │
     └───────────┬─────────────┘
                 │
                 ▼
     ┌─────────────────────────┐
     │  Stress Event Occurs    │
     │  (Combat, Horror, etc.) │
     └───────────┬─────────────┘
                 │
                 ▼
     ┌─────────────────────────┐
     │    Roll d10 on          │
     │    Panic Table          │
     └───────────┬─────────────┘
                 │
                 ▼
     ┌─────────────────────────┐
     │  Create PanicResult     │
     │  with all effect data   │
     └───────────┬─────────────┘
                 │
     ┌───────────┴───────────────────────────────────┐
     │                                               │
     ▼                                               ▼
┌─────────────┐                           ┌─────────────────┐
│ Apply Status│                           │ Force Action    │
│ Effects     │                           │ (if applicable) │
│ (Stunned,   │                           │ (Flee, Attack,  │
│  Prone)     │                           │  Random)        │
└─────────────┘                           └─────────────────┘
```

### 3.3 Stage Change Detection Flow

```
┌────────────────────────────────────────────────────────────────────────┐
│                    STAGE CHANGE DETECTION FLOW                          │
└────────────────────────────────────────────────────────────────────────┘

     ┌─────────────────────────┐
     │   Stress Change Event   │
     │   (oldStress, newStress)│
     └───────────┬─────────────┘
                 │
                 ▼
     ┌─────────────────────────┐
     │  Calculate Stages       │
     │  Old → CpsStage         │
     │  New → CpsStage         │
     └───────────┬─────────────┘
                 │
                 ▼
     ┌─────────────────────────┐
     │  Create StageChange     │
     │  Result                 │
     └───────────┬─────────────┘
                 │
     ┌───────────┼───────────────────────────────────┐
     │           │                                   │
     ▼           ▼                                   ▼
┌─────────┐ ┌─────────────┐                 ┌───────────────┐
│Worsened │ │ Improved    │                 │ Critical      │
│ → Warn  │ │ → Celebrate │                 │ Transitions   │
│         │ │             │                 │ → Special     │
│         │ │             │                 │   Handling    │
└─────────┘ └─────────────┘                 └───────────────┘
                                                    │
                                    ┌───────────────┴───────────────┐
                                    │                               │
                                    ▼                               ▼
                           ┌───────────────┐               ┌───────────────┐
                           │ Entered       │               │ Entered       │
                           │ RuinMadness   │               │ HollowShell   │
                           │ → Enable      │               │ → Survival    │
                           │   Panic Table │               │   Check       │
                           └───────────────┘               └───────────────┘
```

---

## 4. User Stories

### US-18.2b-1: Track Panic Table Outcome

**As a** combat system developer
**I want to** receive complete panic effect data after a roll
**So that** I can apply all mechanical effects correctly

**Acceptance Criteria:**

- PanicResult contains die roll, effect enum, and description
- Duration and damage values included when applicable
- Status effects list populated for relevant effects
- Forced action type specified for Flee/Violence/Dissociation

### US-18.2b-2: Detect Critical Stage Transitions

**As a** game state manager
**I want to** detect when RuinMadness or HollowShell is entered
**So that** special handling can be triggered

**Acceptance Criteria:**

- EnteredRuinMadness true only on transition from lower stage
- EnteredHollowShell true only on transition from lower stage
- Both false when already at that stage

### US-18.2b-3: Configure UI Distortion

**As a** UI renderer
**I want to** receive distortion parameters for each CPS stage
**So that** visual effects can be applied consistently

**Acceptance Criteria:**

- Distortion intensity scales from 0.0 to 1.0
- Text glitching enabled at GlimmerMadness and higher
- LeetSpeak level increases with stage severity

### US-18.2b-4: Display Recovery Instructions

**As a** player information system
**I want to** retrieve recovery protocols for current CPS stage
**So that** players understand how to recover

**Acceptance Criteria:**

- Each recoverable stage has defined protocol
- Steps provided as actionable list
- Recovery time estimate included
- Urgency level indicates priority

---

## 5. PanicResult Record

### 5.1 Purpose

Encapsulates the complete outcome of a Panic Table roll, providing all data needed to apply mechanical effects and display results.

### 5.2 Definition

**File:** `src/Core/RuneAndRust.Domain/ValueObjects/PanicResult.cs`

```csharp
namespace RuneAndRust.Domain.ValueObjects;

using RuneAndRust.Domain.Enums;

/// <summary>
/// Represents the complete result of a Panic Table roll.
/// </summary>
/// <remarks>
/// <para>
/// The Panic Table is triggered when a character in RuinMadness stage
/// experiences a stress-inducing event. This record contains all data
/// needed to apply the mechanical effects and display the outcome.
/// </para>
/// <para>
/// Panic Table (d10):
/// <list type="bullet">
/// <item>1: Frozen — Cannot act for 1 round</item>
/// <item>2: Scream — Alerts enemies</item>
/// <item>3: Flee — Must flee combat</item>
/// <item>4: Fetal — Prone + disadvantage</item>
/// <item>5: Blackout — Unconscious 1d4 rounds</item>
/// <item>6: Denial — Cannot perceive threat</item>
/// <item>7: Violence — Attack nearest creature</item>
/// <item>8: Catatonia — Stunned until hit</item>
/// <item>9: Dissociation — Random action</item>
/// <item>10: None — Lucky break</item>
/// </list>
/// </para>
/// </remarks>
/// <param name="DieRoll">The d10 roll result (1-10).</param>
/// <param name="Effect">The panic effect triggered.</param>
/// <param name="EffectName">Display name of the effect.</param>
/// <param name="Description">Narrative description of the effect.</param>
/// <param name="DurationTurns">Duration in turns, if applicable.</param>
/// <param name="SelfDamage">Self-damage dealt, if applicable.</param>
/// <param name="StatusEffects">Status effects to apply.</param>
/// <param name="ForcesAction">Whether this effect forces a specific action.</param>
/// <param name="ForcedActionType">Type of forced action, if applicable.</param>
public readonly record struct PanicResult(
    int DieRoll,
    PanicEffect Effect,
    string EffectName,
    string Description,
    int? DurationTurns,
    int? SelfDamage,
    IReadOnlyList<string> StatusEffects,
    bool ForcesAction,
    string? ForcedActionType)
{
    /// <summary>
    /// Gets whether this is a "lucky break" result with no effect.
    /// </summary>
    public bool IsLuckyBreak => Effect == PanicEffect.None;

    /// <summary>
    /// Gets whether this effect causes the character to lose their turn.
    /// </summary>
    public bool LosesTurn => Effect is PanicEffect.Frozen or PanicEffect.Blackout or PanicEffect.Catatonia;

    /// <summary>
    /// Gets whether this effect affects nearby allies.
    /// </summary>
    public bool AffectsAllies => Effect is PanicEffect.Scream or PanicEffect.Violence;

    /// <summary>
    /// Creates a "lucky break" result for a roll of 10.
    /// </summary>
    public static PanicResult LuckyBreak() => new(
        DieRoll: 10,
        Effect: PanicEffect.None,
        EffectName: "Lucky Break",
        Description: "Your mind holds together... for now.",
        DurationTurns: null,
        SelfDamage: null,
        StatusEffects: Array.Empty<string>(),
        ForcesAction: false,
        ForcedActionType: null);

    /// <summary>
    /// Creates a Frozen result for a roll of 1.
    /// </summary>
    public static PanicResult Frozen() => new(
        DieRoll: 1,
        Effect: PanicEffect.Frozen,
        EffectName: "Logic Lock",
        Description: "Your mind freezes, unable to process the paradox.",
        DurationTurns: 1,
        SelfDamage: null,
        StatusEffects: new[] { "Stunned" },
        ForcesAction: false,
        ForcedActionType: null);

    /// <summary>
    /// Creates a Flee result for a roll of 3.
    /// </summary>
    public static PanicResult Flee() => new(
        DieRoll: 3,
        Effect: PanicEffect.Flee,
        EffectName: "Evacuation Protocol",
        Description: "Your survival instincts override all else. RUN.",
        DurationTurns: null,
        SelfDamage: null,
        StatusEffects: Array.Empty<string>(),
        ForcesAction: true,
        ForcedActionType: "FleeFromSource");

    /// <summary>
    /// Creates a Violence result for a roll of 7.
    /// </summary>
    public static PanicResult Violence() => new(
        DieRoll: 7,
        Effect: PanicEffect.Violence,
        EffectName: "Paradox Fury",
        Description: "Rage fills the void where reason should be. ATTACK.",
        DurationTurns: 1,
        SelfDamage: null,
        StatusEffects: Array.Empty<string>(),
        ForcesAction: true,
        ForcedActionType: "AttackNearest");

    /// <summary>
    /// Creates a Catatonia result for a roll of 8.
    /// </summary>
    public static PanicResult Catatonia(int durationRoll) => new(
        DieRoll: 8,
        Effect: PanicEffect.Catatonia,
        EffectName: "System Crash",
        Description: "Your mind shuts down completely.",
        DurationTurns: durationRoll,
        SelfDamage: null,
        StatusEffects: new[] { "Prone", "Stunned" },
        ForcesAction: false,
        ForcedActionType: null);

    /// <inheritdoc/>
    public override string ToString() =>
        IsLuckyBreak
            ? $"Panic[d10={DieRoll}]: LUCKY BREAK - No effect"
            : $"Panic[d10={DieRoll}]: {EffectName} - {Description}";
}
```

---

## 6. CpsStageChangeResult Record

### 6.1 Purpose

Detects and categorizes changes in CPS stage, enabling proper event handling for critical transitions.

### 6.2 Definition

**File:** `src/Core/RuneAndRust.Domain/ValueObjects/CpsStageChangeResult.cs`

```csharp
namespace RuneAndRust.Domain.ValueObjects;

using RuneAndRust.Domain.Enums;

/// <summary>
/// Represents the result of checking for CPS stage changes.
/// </summary>
/// <remarks>
/// <para>
/// This record is used to detect when a character's CPS stage changes
/// due to stress fluctuations. It provides computed properties to identify
/// critical transitions that require special handling.
/// </para>
/// <para>
/// Critical Transitions:
/// <list type="bullet">
/// <item>EnteredRuinMadness — Enables Panic Table rolls</item>
/// <item>EnteredHollowShell — Requires survival check</item>
/// </list>
/// </para>
/// </remarks>
/// <param name="PreviousStage">The CPS stage before the change.</param>
/// <param name="NewStage">The CPS stage after the change.</param>
public readonly record struct CpsStageChangeResult(
    CpsStage PreviousStage,
    CpsStage NewStage)
{
    /// <summary>
    /// Gets whether the CPS stage changed at all.
    /// </summary>
    public bool StageChanged => PreviousStage != NewStage;

    /// <summary>
    /// Gets whether the CPS stage worsened (increased severity).
    /// </summary>
    public bool StageWorsened => NewStage > PreviousStage;

    /// <summary>
    /// Gets whether the CPS stage improved (decreased severity).
    /// </summary>
    public bool StageImproved => NewStage < PreviousStage;

    /// <summary>
    /// Gets whether the character just entered RuinMadness stage.
    /// </summary>
    /// <remarks>
    /// True only when transitioning FROM a lower stage TO RuinMadness.
    /// This triggers enabling of Panic Table rolls.
    /// </remarks>
    public bool EnteredRuinMadness =>
        NewStage == CpsStage.RuinMadness && PreviousStage < CpsStage.RuinMadness;

    /// <summary>
    /// Gets whether the character just entered HollowShell stage.
    /// </summary>
    /// <remarks>
    /// True only when transitioning FROM a lower stage TO HollowShell.
    /// This triggers the survival check requirement.
    /// </remarks>
    public bool EnteredHollowShell =>
        NewStage == CpsStage.HollowShell && PreviousStage < CpsStage.HollowShell;

    /// <summary>
    /// Gets whether this represents a critical transition requiring special handling.
    /// </summary>
    public bool IsCriticalTransition => EnteredRuinMadness || EnteredHollowShell;

    /// <summary>
    /// Gets whether the character left RuinMadness (recovered from panic zone).
    /// </summary>
    public bool LeftRuinMadness =>
        PreviousStage == CpsStage.RuinMadness && NewStage < CpsStage.RuinMadness;

    /// <summary>
    /// Creates a result representing no change.
    /// </summary>
    /// <param name="currentStage">The current (unchanged) stage.</param>
    public static CpsStageChangeResult NoChange(CpsStage currentStage) =>
        new(currentStage, currentStage);

    /// <summary>
    /// Creates a result from two stress values.
    /// </summary>
    /// <param name="previousStress">The previous stress value.</param>
    /// <param name="newStress">The new stress value.</param>
    public static CpsStageChangeResult FromStressChange(int previousStress, int newStress)
    {
        var previousStage = CpsState.DetermineStage(previousStress);
        var newStage = CpsState.DetermineStage(newStress);
        return new CpsStageChangeResult(previousStage, newStage);
    }

    /// <inheritdoc/>
    public override string ToString()
    {
        if (!StageChanged)
            return $"CPS Stage: {NewStage} (unchanged)";

        var direction = StageWorsened ? "WORSENED" : "IMPROVED";
        var critical = IsCriticalTransition ? " [CRITICAL!]" : "";
        return $"CPS Stage {direction}: {PreviousStage} → {NewStage}{critical}";
    }
}
```

---

## 7. CpsUiEffects Record

### 7.1 Purpose

Defines the visual distortion parameters for each CPS stage, enabling consistent UI rendering across the application.

### 7.2 Definition

**File:** `src/Core/RuneAndRust.Domain/ValueObjects/CpsUiEffects.cs`

```csharp
namespace RuneAndRust.Domain.ValueObjects;

using RuneAndRust.Domain.Enums;

/// <summary>
/// Represents the UI distortion effects for a CPS stage.
/// </summary>
/// <remarks>
/// <para>
/// As CPS severity increases, the game's UI becomes increasingly distorted
/// to reflect the character's deteriorating perception of reality.
/// This record defines all visual effect parameters.
/// </para>
/// <para>
/// Effect Progression:
/// <list type="bullet">
/// <item>None: Clean UI, no distortion</item>
/// <item>WeightOfKnowing: Subtle peripheral static</item>
/// <item>GlimmerMadness: Text glitching, moderate distortion</item>
/// <item>RuinMadness: Heavy distortion, leetspeak corruption</item>
/// <item>HollowShell: Maximum distortion or blackout</item>
/// </list>
/// </para>
/// </remarks>
/// <param name="Stage">The CPS stage these effects apply to.</param>
/// <param name="DistortionIntensity">Overall distortion intensity (0.0-1.0).</param>
/// <param name="PeripheralStatic">Whether screen edges show static noise.</param>
/// <param name="TextGlitching">Whether text randomly glitches/scrambles.</param>
/// <param name="LeetSpeakLevel">Level of text-to-leetspeak corruption (0-4).</param>
/// <param name="SystemWarnings">Whether to show system warning overlays.</param>
/// <param name="ColorTint">Hex color tint to apply to screen.</param>
/// <param name="ScreenLag">Whether to apply input/visual lag effects.</param>
public readonly record struct CpsUiEffects(
    CpsStage Stage,
    float DistortionIntensity,
    bool PeripheralStatic,
    bool TextGlitching,
    int LeetSpeakLevel,
    bool SystemWarnings,
    string ColorTint,
    bool ScreenLag)
{
    /// <summary>
    /// Gets whether any visual distortion effects are active.
    /// </summary>
    public bool HasDistortion => DistortionIntensity > 0.0f;

    /// <summary>
    /// Gets whether text corruption effects are active.
    /// </summary>
    public bool HasTextCorruption => TextGlitching || LeetSpeakLevel > 0;

    /// <summary>
    /// Creates UI effects for the None stage (clean UI).
    /// </summary>
    public static CpsUiEffects ForNone() => new(
        Stage: CpsStage.None,
        DistortionIntensity: 0.0f,
        PeripheralStatic: false,
        TextGlitching: false,
        LeetSpeakLevel: 0,
        SystemWarnings: false,
        ColorTint: "#FFFFFF",
        ScreenLag: false);

    /// <summary>
    /// Creates UI effects for the WeightOfKnowing stage.
    /// </summary>
    public static CpsUiEffects ForWeightOfKnowing() => new(
        Stage: CpsStage.WeightOfKnowing,
        DistortionIntensity: 0.1f,
        PeripheralStatic: true,
        TextGlitching: false,
        LeetSpeakLevel: 0,
        SystemWarnings: false,
        ColorTint: "#E8E8E8",
        ScreenLag: false);

    /// <summary>
    /// Creates UI effects for the GlimmerMadness stage.
    /// </summary>
    public static CpsUiEffects ForGlimmerMadness() => new(
        Stage: CpsStage.GlimmerMadness,
        DistortionIntensity: 0.4f,
        PeripheralStatic: true,
        TextGlitching: true,
        LeetSpeakLevel: 2,
        SystemWarnings: false,
        ColorTint: "#FFE0B0",
        ScreenLag: false);

    /// <summary>
    /// Creates UI effects for the RuinMadness stage.
    /// </summary>
    public static CpsUiEffects ForRuinMadness() => new(
        Stage: CpsStage.RuinMadness,
        DistortionIntensity: 0.7f,
        PeripheralStatic: true,
        TextGlitching: true,
        LeetSpeakLevel: 4,
        SystemWarnings: true,
        ColorTint: "#FF8080",
        ScreenLag: true);

    /// <summary>
    /// Creates UI effects for the HollowShell stage.
    /// </summary>
    public static CpsUiEffects ForHollowShell() => new(
        Stage: CpsStage.HollowShell,
        DistortionIntensity: 1.0f,
        PeripheralStatic: false, // Screen goes dark
        TextGlitching: false,
        LeetSpeakLevel: 0,
        SystemWarnings: true,
        ColorTint: "#000000",
        ScreenLag: true);

    /// <summary>
    /// Creates UI effects for a given CPS stage.
    /// </summary>
    /// <param name="stage">The CPS stage.</param>
    public static CpsUiEffects ForStage(CpsStage stage) => stage switch
    {
        CpsStage.None => ForNone(),
        CpsStage.WeightOfKnowing => ForWeightOfKnowing(),
        CpsStage.GlimmerMadness => ForGlimmerMadness(),
        CpsStage.RuinMadness => ForRuinMadness(),
        CpsStage.HollowShell => ForHollowShell(),
        _ => ForNone()
    };

    /// <inheritdoc/>
    public override string ToString() =>
        $"CpsUiEffects[{Stage}]: Distortion={DistortionIntensity:P0}, " +
        $"Glitch={TextGlitching}, Leet={LeetSpeakLevel}";
}
```

---

## 8. CpsRecoveryProtocol Record

### 8.1 Purpose

Defines the recovery procedures for each CPS stage, providing both narrative context and actionable steps for players.

### 8.2 Definition

**File:** `src/Core/RuneAndRust.Domain/ValueObjects/CpsRecoveryProtocol.cs`

```csharp
namespace RuneAndRust.Domain.ValueObjects;

using RuneAndRust.Domain.Enums;

/// <summary>
/// Represents the recovery protocol for a CPS stage.
/// </summary>
/// <remarks>
/// <para>
/// Each CPS stage (except HollowShell) has a defined recovery protocol
/// that players can follow to reduce their character's stress and
/// potentially recover to a lower stage.
/// </para>
/// <para>
/// Recovery Urgency Levels:
/// <list type="bullet">
/// <item>None: No immediate action needed</item>
/// <item>Low: Recovery recommended when convenient</item>
/// <item>Moderate: Recovery should be prioritized</item>
/// <item>Critical: Immediate recovery required</item>
/// <item>Terminal: Recovery may be impossible</item>
/// </list>
/// </para>
/// </remarks>
/// <param name="Stage">The CPS stage this protocol applies to.</param>
/// <param name="IsRecoverable">Whether recovery is possible from this stage.</param>
/// <param name="ProtocolName">Name of the recovery protocol.</param>
/// <param name="Steps">Ordered list of recovery steps.</param>
/// <param name="RecoveryTime">Estimated time for full recovery.</param>
/// <param name="Urgency">Urgency level for seeking recovery.</param>
public readonly record struct CpsRecoveryProtocol(
    CpsStage Stage,
    bool IsRecoverable,
    string ProtocolName,
    IReadOnlyList<string> Steps,
    string RecoveryTime,
    string Urgency)
{
    /// <summary>
    /// Gets whether this is a terminal state with no recovery.
    /// </summary>
    public bool IsTerminal => !IsRecoverable;

    /// <summary>
    /// Gets the number of recovery steps.
    /// </summary>
    public int StepCount => Steps.Count;

    /// <summary>
    /// Creates recovery protocol for the None stage.
    /// </summary>
    public static CpsRecoveryProtocol ForNone() => new(
        Stage: CpsStage.None,
        IsRecoverable: true,
        ProtocolName: "Standard Mental Health",
        Steps: new[] { "No recovery needed — mind is clear" },
        RecoveryTime: "N/A",
        Urgency: "None");

    /// <summary>
    /// Creates recovery protocol for the WeightOfKnowing stage.
    /// </summary>
    public static CpsRecoveryProtocol ForWeightOfKnowing() => new(
        Stage: CpsStage.WeightOfKnowing,
        IsRecoverable: true,
        ProtocolName: "Cognitive Hygiene",
        Steps: new[]
        {
            "Find a safe location away from anomalies",
            "Rest in silence and darkness for at least 4 hours",
            "Avoid exposure to paradox sources",
            "Engage in grounding activities (routine tasks)",
            "Reduce stress through normal rest mechanics"
        },
        RecoveryTime: "12-24 hours",
        Urgency: "Low");

    /// <summary>
    /// Creates recovery protocol for the GlimmerMadness stage.
    /// </summary>
    public static CpsRecoveryProtocol ForGlimmerMadness() => new(
        Stage: CpsStage.GlimmerMadness,
        IsRecoverable: true,
        ProtocolName: "Silent Room Protocol",
        Steps: new[]
        {
            "Immediately cease all paradox exposure",
            "Isolate in a dark, quiet room",
            "Remove all written materials (The Writhing Text symptom)",
            "Do not attempt complex reasoning or logic puzzles",
            "Have an ally monitor for deterioration",
            "Long Rest required — Short Rest insufficient",
            "Sanctuary Rest recommended if available"
        },
        RecoveryTime: "48+ hours",
        Urgency: "Critical");

    /// <summary>
    /// Creates recovery protocol for the RuinMadness stage.
    /// </summary>
    public static CpsRecoveryProtocol ForRuinMadness() => new(
        Stage: CpsStage.RuinMadness,
        IsRecoverable: false,
        ProtocolName: "Terminal Protocol",
        Steps: new[]
        {
            "WARNING: Recovery from Ruin-Madness is not possible",
            "The mind has crossed a threshold from which there is no return",
            "Focus on managing symptoms and preventing HollowShell",
            "Sanctuary Rest may reduce to GlimmerMadness (GM discretion)",
            "Character may need to be retired if condition persists"
        },
        RecoveryTime: "N/A",
        Urgency: "Terminal");

    /// <summary>
    /// Creates recovery protocol for the HollowShell stage.
    /// </summary>
    public static CpsRecoveryProtocol ForHollowShell() => new(
        Stage: CpsStage.HollowShell,
        IsRecoverable: false,
        ProtocolName: "None — Character Lost",
        Steps: new[]
        {
            "The character's mind has been erased",
            "No recovery is possible",
            "Character becomes unplayable NPC",
            "Begin new character creation if desired"
        },
        RecoveryTime: "N/A",
        Urgency: "Terminal");

    /// <summary>
    /// Creates recovery protocol for a given CPS stage.
    /// </summary>
    /// <param name="stage">The CPS stage.</param>
    public static CpsRecoveryProtocol ForStage(CpsStage stage) => stage switch
    {
        CpsStage.None => ForNone(),
        CpsStage.WeightOfKnowing => ForWeightOfKnowing(),
        CpsStage.GlimmerMadness => ForGlimmerMadness(),
        CpsStage.RuinMadness => ForRuinMadness(),
        CpsStage.HollowShell => ForHollowShell(),
        _ => ForNone()
    };

    /// <inheritdoc/>
    public override string ToString() =>
        $"CpsRecovery[{Stage}]: {ProtocolName} — Urgency={Urgency}, Recoverable={IsRecoverable}";
}
```

---

## 9. Logging Specifications

### 9.1 Domain Layer Logging

> **Note:** Value objects do not log directly.
> All logging occurs in Application Layer services (v0.18.2d).

### 9.2 Expected Log Events (Future Implementation)

| Event | Level | Template |
|-------|-------|----------|
| Panic Result Created | Information | `"Panic roll d10={DieRoll}: {EffectName} for {CharacterId}"` |
| Stage Change Detected | Information | `"CPS stage change: {CharacterId} {PreviousStage} → {NewStage}"` |
| Critical Transition | Warning | `"Critical CPS transition: {CharacterId} entered {Stage}"` |
| Terminal State | Error | `"HOLLOW SHELL: {CharacterId} — character lost"` |

---

## 10. Unit Testing Requirements

### 10.1 Test File Locations

**Files:**
- `tests/RuneAndRust.Domain.UnitTests/ValueObjects/CpsStageChangeResultTests.cs`
- `tests/RuneAndRust.Domain.UnitTests/ValueObjects/CpsUiEffectsTests.cs`

### 10.2 Required Tests

| Test Name | Description |
|-----------|-------------|
| `CpsStageChangeResult_DetectsRuinMadnessEntry_WhenTransitioningFromLower` | Verify EnteredRuinMadness flag |
| `CpsStageChangeResult_DetectsHollowShellEntry_WhenTransitioningFromLower` | Verify EnteredHollowShell flag |
| `CpsUiEffects_DistortionScales_WithStage` | Verify distortion intensity increases |
| `CpsRecoveryProtocol_ReturnsNonRecoverable_ForRuinMadnessAndAbove` | Verify recovery flags |

### 10.3 Example Tests

```csharp
[TestFixture]
public class CpsStageChangeResultTests
{
    [Test]
    public void EnteredRuinMadness_True_WhenTransitioningFromGlimmerMadness()
    {
        // Arrange & Act
        var result = new CpsStageChangeResult(
            CpsStage.GlimmerMadness,
            CpsStage.RuinMadness);

        // Assert
        result.EnteredRuinMadness.Should().BeTrue();
        result.EnteredHollowShell.Should().BeFalse();
        result.IsCriticalTransition.Should().BeTrue();
    }

    [Test]
    public void EnteredRuinMadness_False_WhenAlreadyInRuinMadness()
    {
        // Arrange & Act
        var result = new CpsStageChangeResult(
            CpsStage.RuinMadness,
            CpsStage.RuinMadness);

        // Assert
        result.EnteredRuinMadness.Should().BeFalse();
        result.StageChanged.Should().BeFalse();
    }

    [Test]
    public void EnteredHollowShell_True_WhenTransitioningFromRuinMadness()
    {
        // Arrange & Act
        var result = new CpsStageChangeResult(
            CpsStage.RuinMadness,
            CpsStage.HollowShell);

        // Assert
        result.EnteredHollowShell.Should().BeTrue();
        result.IsCriticalTransition.Should().BeTrue();
    }

    [Test]
    public void FromStressChange_CalculatesCorrectStages()
    {
        // Arrange & Act
        var result = CpsStageChangeResult.FromStressChange(
            previousStress: 55,
            newStress: 65);

        // Assert
        result.PreviousStage.Should().Be(CpsStage.GlimmerMadness);
        result.NewStage.Should().Be(CpsStage.RuinMadness);
        result.StageWorsened.Should().BeTrue();
    }
}

[TestFixture]
public class CpsUiEffectsTests
{
    [TestCase(CpsStage.None, 0.0f)]
    [TestCase(CpsStage.WeightOfKnowing, 0.1f)]
    [TestCase(CpsStage.GlimmerMadness, 0.4f)]
    [TestCase(CpsStage.RuinMadness, 0.7f)]
    [TestCase(CpsStage.HollowShell, 1.0f)]
    public void ForStage_DistortionIntensityScales_WithSeverity(
        CpsStage stage, float expectedIntensity)
    {
        // Arrange & Act
        var effects = CpsUiEffects.ForStage(stage);

        // Assert
        effects.DistortionIntensity.Should().Be(expectedIntensity);
    }

    [Test]
    public void TextGlitching_EnabledAt_GlimmerMadnessAndAbove()
    {
        // Assert
        CpsUiEffects.ForNone().TextGlitching.Should().BeFalse();
        CpsUiEffects.ForWeightOfKnowing().TextGlitching.Should().BeFalse();
        CpsUiEffects.ForGlimmerMadness().TextGlitching.Should().BeTrue();
        CpsUiEffects.ForRuinMadness().TextGlitching.Should().BeTrue();
    }
}
```

---

## 11. Deliverable Checklist

### 11.1 Domain Layer

- [ ] `src/Core/RuneAndRust.Domain/ValueObjects/PanicResult.cs`
- [ ] `src/Core/RuneAndRust.Domain/ValueObjects/CpsStageChangeResult.cs`
- [ ] `src/Core/RuneAndRust.Domain/ValueObjects/CpsUiEffects.cs`
- [ ] `src/Core/RuneAndRust.Domain/ValueObjects/CpsRecoveryProtocol.cs`

### 11.2 Tests

- [ ] `tests/RuneAndRust.Domain.UnitTests/ValueObjects/CpsStageChangeResultTests.cs`
- [ ] `tests/RuneAndRust.Domain.UnitTests/ValueObjects/CpsUiEffectsTests.cs`

### 11.3 Documentation

- [ ] Update `docs/design/v0.18.x/v0.18.2-scope-breakdown.md` (mark v0.18.2b complete)
- [ ] Create `docs/changelogs/v0.18.2b-changelog.md`

---

## 12. Acceptance Criteria

### 12.1 Build Verification

- [ ] Solution builds without errors
- [ ] Solution builds without warnings in new code

### 12.2 Test Verification

- [ ] All new unit tests pass
- [ ] All existing unit tests continue to pass

### 12.3 Functional Verification

- [ ] `PanicResult` contains all mechanical effect data
- [ ] `PanicResult` factory methods create valid results
- [ ] `CpsStageChangeResult.EnteredRuinMadness` detects correct transitions
- [ ] `CpsStageChangeResult.EnteredHollowShell` detects correct transitions
- [ ] `CpsUiEffects` distortion scales correctly with stage
- [ ] `CpsRecoveryProtocol` returns non-recoverable for Stage 3+

---

## 13. Dependencies

### 13.1 Required Prerequisites

| Dependency | Version | Status | Notes |
|------------|---------|--------|-------|
| CpsStage Enum | v0.18.2a | Required | Stage enumeration |
| PanicEffect Enum | v0.18.2a | Required | Panic effect enumeration |
| CpsState Value Object | v0.18.2a | Required | Stage determination logic |

### 13.2 Provides to Later Phases

| Item | Consumer | Purpose |
|------|----------|---------|
| `PanicResult` | v0.18.2d (CpsService) | Return value for Panic Table rolls |
| `CpsStageChangeResult` | v0.18.2d (CpsService) | Return value for stage change detection |
| `CpsUiEffects` | v0.18.2d (CpsService) | UI rendering configuration |
| `CpsRecoveryProtocol` | v0.18.2d (CpsService) | Player guidance retrieval |

---

## 14. Future Considerations

### 14.1 v0.18.2c (ICpsService Interface)

- Service contract will use these result types
- Method signatures defined for all CPS operations

### 14.2 v0.18.2d (CpsService Implementation)

- Configuration-driven Panic Table
- Integration with IDiceService for rolls
- Logging implementation for all operations

### 14.3 v0.19.x (UI Version)

- Actual shader implementations for visual distortions
- Text corruption rendering system
- Audio distortion effects

---

*Document Version: 1.0*
*Last Updated: 2026-01-28*
*Author: Claude (AI Assistant)*
