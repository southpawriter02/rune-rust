# v0.14.2d Design Specification: Loot Table Schema

**Version:** 0.14.2d
**Parent:** v0.14.2 (Equipment Configuration Schemas)
**Prerequisites:** v0.14.2a, v0.14.2b, v0.14.2c Complete (Weapon, Armor, Item Schemas)
**Status:** Design Complete

---

## Table of Contents

1. [Executive Summary](#1-executive-summary)
2. [Feature Overview](#2-feature-overview)
3. [Architecture Diagrams](#3-architecture-diagrams)
4. [Loot Table Schema Definition](#4-loot-table-schema-definition)
   - 4.1 [Root Configuration Properties](#41-root-configuration-properties)
   - 4.2 [LootTableDefinition Definition](#42-loottabledefinition-definition)
   - 4.3 [LootEntry Definition](#43-lootentry-definition)
   - 4.4 [QuantityRange Definition](#44-quantityrange-definition)
   - 4.5 [CurrencyDrop Definition](#45-currencydrop-definition)
   - 4.6 [DropCondition Definition](#46-dropcondition-definition)
5. [Loot Table Structure](#5-loot-table-structure)
   - 5.1 [Guaranteed Drops](#51-guaranteed-drops)
   - 5.2 [Random Pools](#52-random-pools)
   - 5.3 [Pool Drop Count](#53-pool-drop-count)
   - 5.4 [Currency Drops](#54-currency-drops)
6. [Drop Condition Configuration](#6-drop-condition-configuration)
   - 6.1 [Level Range Conditions](#61-level-range-conditions)
   - 6.2 [Difficulty Conditions](#62-difficulty-conditions)
   - 6.3 [Class Filter Conditions](#63-class-filter-conditions)
   - 6.4 [Quest Flag Conditions](#64-quest-flag-conditions)
7. [Weighted Random Selection](#7-weighted-random-selection)
   - 7.1 [Weight System](#71-weight-system)
   - 7.2 [Drop Chance vs Weight](#72-drop-chance-vs-weight)
8. [Item Reference System](#8-item-reference-system)
   - 8.1 [Item Types](#81-item-types)
   - 8.2 [ID References](#82-id-references)
9. [Validation Rules](#9-validation-rules)
   - 9.1 [Enum Validation](#91-enum-validation)
   - 9.2 [Range Validation](#92-range-validation)
   - 9.3 [Required Fields](#93-required-fields)
   - 9.4 [Pattern Validation](#94-pattern-validation)
   - 9.5 [Quantity Range Validation](#95-quantity-range-validation)
10. [Configuration Schema](#10-configuration-schema)
11. [Configuration File Updates](#11-configuration-file-updates)
12. [Data Model Changes](#12-data-model-changes)
13. [Logging Specifications](#13-logging-specifications)
14. [Unit Testing Requirements](#14-unit-testing-requirements)
15. [Use Cases](#15-use-cases)
16. [Deliverable Checklist](#16-deliverable-checklist)
17. [Acceptance Criteria](#17-acceptance-criteria)
18. [Dependencies](#18-dependencies)
19. [Future Considerations](#19-future-considerations)

---

## 1. Executive Summary

Version 0.14.2d introduces the **Loot Table Schema** (`loot-tables.schema.json`), which validates loot table definitions including drop chance percentages, quantity ranges, conditional drops, guaranteed drops, weighted random pools, and currency drops. Loot tables define what items monsters drop, chests contain, or quests reward.

The Loot Table Schema provides a comprehensive framework for configuring loot distribution including guaranteed drops (items that always drop), random pools (weighted selection from a pool of items), currency drops (gold/currency amounts), and conditional requirements (level, difficulty, class, quest flags).

### Key Deliverables

| Category | Items |
|----------|-------|
| **Schema Files** | `loot-tables.schema.json` |
| **Schema Definitions** | `LootTableDefinition`, `LootEntry`, `QuantityRange`, `DropCondition`, `CurrencyDrop` |
| **Configuration Files** | Create `loot-tables.json` with example tables |
| **Tests** | ~5 new unit tests |

### Architectural Significance

This version provides:
- **Loot table structure** - ID, name, description, entries organized by type
- **Guaranteed drops** - Items that always drop from a source
- **Random pool selection** - Weighted random selection from item pools
- **Drop chance validation** - Percentage validation (0.0 to 1.0)
- **Quantity ranges** - Min/max validation for item quantities
- **Conditional drops** - Level, difficulty, class, and quest flag requirements
- **Currency drops** - Gold/currency amounts with chance and range
- **Item references** - References to weapons, armor, and items by ID

### Relationship to Other Schemas

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                    v0.14.2 EQUIPMENT CONFIGURATION SCHEMAS                   │
└─────────────────────────────────────────────────────────────────────────────┘

  ┌─────────────────────────────────────────────────────────────────────────┐
  │  v0.14.2a: weapons.schema.json                                          │
  │  v0.14.2b: armor.schema.json                                            │
  │  v0.14.2c: items.schema.json                                            │
  │  v0.14.2d: loot-tables.schema.json ◀── THIS VERSION                     │
  └─────────────────────────────────────────────────────────────────────────┘

  Cross-references:
  • weapons.json → itemId references weapon IDs (itemType: "Weapon")
  • armor.json → itemId references armor IDs (itemType: "Armor")
  • items.json → itemId references item IDs (itemType: "Item")
  • monsters.json (future) → lootTableId references loot table IDs
  • chests.json (future) → lootTableId references loot table IDs

  Shared definitions:
  • ID pattern: ^[a-z][a-z0-9_-]*$ (allows hyphens for readability)
  • Drop chance: 0.0 to 1.0 (percentage as decimal)
  • Quantity range: min/max both >= 1
  • Schema location: config/schemas/
  • Difficulty enum aligned with game systems
```

---

## 2. Feature Overview

```
v0.14.2d Loot Table Schema Features
├── loot-tables.schema.json
│   ├── Root Configuration Properties
│   │   ├── $schema (string, optional)
│   │   ├── version (string, optional)
│   │   └── lootTables (array of LootTableDefinition, required)
│   └── Definitions
│       ├── LootTableDefinition
│       │   ├── id (string, hyphen pattern, required)
│       │   ├── name (string, minLength: 1, required)
│       │   ├── description (string, optional)
│       │   ├── guaranteedDrops (array of LootEntry, optional)
│       │   ├── randomPool (array of LootEntry, optional)
│       │   ├── poolDropCount (QuantityRange, optional)
│       │   ├── currencyDrop (CurrencyDrop, optional)
│       │   └── conditions (DropCondition, optional)
│       ├── LootEntry
│       │   ├── itemId (string, required)
│       │   ├── itemType (enum: Item, Weapon, Armor, optional)
│       │   ├── dropChance (number, 0-1, default: 1.0)
│       │   ├── quantity (QuantityRange, optional)
│       │   ├── conditions (DropCondition, optional)
│       │   └── weight (integer, minimum: 1, optional)
│       ├── QuantityRange
│       │   ├── min (integer, minimum: 1, default: 1)
│       │   └── max (integer, minimum: 1, default: 1)
│       ├── CurrencyDrop
│       │   ├── dropChance (number, 0-1, default: 1.0)
│       │   ├── amount (QuantityRange, required)
│       │   └── currencyType (string, default: "gold")
│       └── DropCondition
│           ├── minLevel (integer, minimum: 1, optional)
│           ├── maxLevel (integer, minimum: 1, optional)
│           ├── difficulty (enum: Easy, Normal, Hard, Nightmare, optional)
│           ├── classIds (array of string, optional)
│           └── requiredFlags (array of string, optional)
├── Validation Rules
│   ├── Loot Table ID Pattern Validation (hyphen)
│   ├── Drop Chance Range Validation (0.0-1.0)
│   ├── Quantity Range Validation (min <= max, both >= 1)
│   ├── Item Type Enum Validation
│   ├── Difficulty Enum Validation
│   ├── Weight Minimum Validation (>= 1)
│   └── Currency Type Validation
└── Configuration Updates
    └── loot-tables.json created with example tables
```

---

## 3. Architecture Diagrams

### 3.1 Schema Validation Flow

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                         SCHEMA VALIDATION FLOW                               │
└─────────────────────────────────────────────────────────────────────────────┘

    User edits loot-tables.json
           │
           ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                          IDE/EDITOR                                          │
├─────────────────────────────────────────────────────────────────────────────┤
│  1. Reads $schema property from config file                                  │
│  2. Loads loot-tables.schema.json from config/schemas/                       │
│  3. Validates content against schema                                         │
└─────────────────────────────────────────────────────────────────────────────┘
           │
           ├─── Valid ───▶ Green checkmark, autocomplete works
           │
           └─── Invalid ─▶ Error underlines with messages:
                           • "dropChance must be between 0 and 1"
                           • "quantity.min must be >= 1"
                           • "id must match pattern ^[a-z][a-z0-9_-]*$"
                           • "itemType must be one of: Item, Weapon, Armor"
```

### 3.2 Loot Table Schema Structure Diagram

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                       loot-tables.schema.json                                │
├─────────────────────────────────────────────────────────────────────────────┤
│  $schema: "http://json-schema.org/draft-07/schema#"                         │
│  title: "Loot Table Configuration"                                           │
│  type: object                                                                │
├─────────────────────────────────────────────────────────────────────────────┤
│  properties:                                                                 │
│  ┌─────────────────────────┬─────────────────────────────────────────────┐  │
│  │ $schema                 │ type: string (optional)                     │  │
│  ├─────────────────────────┼─────────────────────────────────────────────┤  │
│  │ version                 │ type: string (optional)                     │  │
│  ├─────────────────────────┼─────────────────────────────────────────────┤  │
│  │ lootTables              │ type: array, items: $ref LootTableDefinition│  │
│  └─────────────────────────┴─────────────────────────────────────────────┘  │
├─────────────────────────────────────────────────────────────────────────────┤
│  definitions:                                                                │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │ LootTableDefinition                                                  │    │
│  │ ┌───────────────────────┬───────────────────────────────────────┐   │    │
│  │ │ id                    │ string, pattern: ^[a-z][a-z0-9_-]*$   │   │    │
│  │ │ name                  │ string, minLength: 1                   │   │    │
│  │ │ description           │ string (optional)                      │   │    │
│  │ │ guaranteedDrops       │ array of $ref LootEntry (optional)     │   │    │
│  │ │ randomPool            │ array of $ref LootEntry (optional)     │   │    │
│  │ │ poolDropCount         │ $ref QuantityRange (optional)          │   │    │
│  │ │ currencyDrop          │ $ref CurrencyDrop (optional)           │   │    │
│  │ │ conditions            │ $ref DropCondition (optional)          │   │    │
│  │ └───────────────────────┴───────────────────────────────────────┘   │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │ LootEntry                                                            │    │
│  │ ┌───────────────────────┬───────────────────────────────────────┐   │    │
│  │ │ itemId                │ string (required)                      │   │    │
│  │ │ itemType              │ enum: Item, Weapon, Armor (optional)   │   │    │
│  │ │ dropChance            │ number, 0-1, default: 1.0              │   │    │
│  │ │ quantity              │ $ref QuantityRange (optional)          │   │    │
│  │ │ conditions            │ $ref DropCondition (optional)          │   │    │
│  │ │ weight                │ integer, minimum: 1 (optional)         │   │    │
│  │ └───────────────────────┴───────────────────────────────────────┘   │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │ QuantityRange                                                        │    │
│  │ ┌───────────────────────┬───────────────────────────────────────┐   │    │
│  │ │ min                   │ integer, minimum: 1, default: 1       │   │    │
│  │ │ max                   │ integer, minimum: 1, default: 1       │   │    │
│  │ └───────────────────────┴───────────────────────────────────────┘   │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │ CurrencyDrop                                                         │    │
│  │ ┌───────────────────────┬───────────────────────────────────────┐   │    │
│  │ │ dropChance            │ number, 0-1, default: 1.0              │   │    │
│  │ │ amount                │ $ref QuantityRange (required)          │   │    │
│  │ │ currencyType          │ string, default: "gold"                │   │    │
│  │ └───────────────────────┴───────────────────────────────────────┘   │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │ DropCondition                                                        │    │
│  │ ┌───────────────────────┬───────────────────────────────────────┐   │    │
│  │ │ minLevel              │ integer, minimum: 1 (optional)        │   │    │
│  │ │ maxLevel              │ integer, minimum: 1 (optional)        │   │    │
│  │ │ difficulty            │ enum: Easy, Normal, Hard, Nightmare   │   │    │
│  │ │ classIds              │ array of string (optional)            │   │    │
│  │ │ requiredFlags         │ array of string (optional)            │   │    │
│  │ └───────────────────────┴───────────────────────────────────────┘   │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 3.3 Loot Table Structure Diagram

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                          LOOT TABLE STRUCTURE                                │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │                      LOOT TABLE DEFINITION                           │    │
│  │                                                                      │    │
│  │  id: "boss_dragon"                                                   │    │
│  │  name: "Dragon Boss Loot"                                            │    │
│  │  description: "Loot from the ancient dragon boss"                    │    │
│  │                                                                      │    │
│  │  ┌───────────────────────────────────────────────────────────────┐  │    │
│  │  │  GUARANTEED DROPS (always drop)                                │  │    │
│  │  │  ┌──────────────────────────────────────────────────────────┐ │  │    │
│  │  │  │ Entry 1: dragon_scale (Item), quantity: 2-5, chance: 1.0 │ │  │    │
│  │  │  │ Entry 2: dragon_heart (Item), quantity: 1, chance: 1.0   │ │  │    │
│  │  │  └──────────────────────────────────────────────────────────┘ │  │    │
│  │  └───────────────────────────────────────────────────────────────┘  │    │
│  │                                                                      │    │
│  │  ┌───────────────────────────────────────────────────────────────┐  │    │
│  │  │  RANDOM POOL (weighted selection)                              │  │    │
│  │  │  ┌──────────────────────────────────────────────────────────┐ │  │    │
│  │  │  │ Entry 1: dragonbane_sword (Weapon), weight: 10           │ │  │    │
│  │  │  │ Entry 2: dragon_mail (Armor), weight: 10                 │ │  │    │
│  │  │  │ Entry 3: dragon_claw (Weapon), weight: 20                │ │  │    │
│  │  │  │ Entry 4: fire_resistance_ring (Item), weight: 30         │ │  │    │
│  │  │  │ Entry 5: greater_health_potion (Item), weight: 30        │ │  │    │
│  │  │  └──────────────────────────────────────────────────────────┘ │  │    │
│  │  │  poolDropCount: { min: 2, max: 4 }                             │  │    │
│  │  └───────────────────────────────────────────────────────────────┘  │    │
│  │                                                                      │    │
│  │  ┌───────────────────────────────────────────────────────────────┐  │    │
│  │  │  CURRENCY DROP                                                 │  │    │
│  │  │  ┌──────────────────────────────────────────────────────────┐ │  │    │
│  │  │  │ dropChance: 1.0                                          │ │  │    │
│  │  │  │ amount: { min: 500, max: 2000 }                          │ │  │    │
│  │  │  │ currencyType: "gold"                                     │ │  │    │
│  │  │  └──────────────────────────────────────────────────────────┘ │  │    │
│  │  └───────────────────────────────────────────────────────────────┘  │    │
│  │                                                                      │    │
│  │  ┌───────────────────────────────────────────────────────────────┐  │    │
│  │  │  CONDITIONS (table-level)                                      │  │    │
│  │  │  ┌──────────────────────────────────────────────────────────┐ │  │    │
│  │  │  │ minLevel: 15                                             │ │  │    │
│  │  │  └──────────────────────────────────────────────────────────┘ │  │    │
│  │  └───────────────────────────────────────────────────────────────┘  │    │
│  │                                                                      │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 3.4 Loot Resolution Flow Diagram

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                        LOOT RESOLUTION FLOW                                  │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  STEP 1: CHECK TABLE-LEVEL CONDITIONS                                        │
│  ┌──────────────────────────────────────────────────────────────────────┐   │
│  │  Loot Source (Monster/Chest/Quest)                                   │   │
│  │           │                                                           │   │
│  │           ▼                                                           │   │
│  │  ┌─────────────────────────────────────────────────────────────────┐│   │
│  │  │  Check table.conditions                                         ││   │
│  │  │  • Player level >= minLevel?                                    ││   │
│  │  │  • Player level <= maxLevel?                                    ││   │
│  │  │  • Current difficulty matches?                                  ││   │
│  │  │  • Player class in classIds?                                    ││   │
│  │  │  • Required quest flags set?                                    ││   │
│  │  └─────────────────────────────────────────────────────────────────┘│   │
│  │           │                                                           │   │
│  │           ├─── Conditions not met ───▶ No loot from this table       │   │
│  │           │                                                           │   │
│  │           ▼                                                           │   │
│  │  Conditions met: proceed to drops                                    │   │
│  └──────────────────────────────────────────────────────────────────────┘   │
│                                                                              │
│  STEP 2: PROCESS GUARANTEED DROPS                                            │
│  ┌──────────────────────────────────────────────────────────────────────┐   │
│  │  For each entry in guaranteedDrops:                                  │   │
│  │           │                                                           │   │
│  │           ▼                                                           │   │
│  │  ┌─────────────────────────────────────────────────────────────────┐│   │
│  │  │  Check entry.conditions (if present)                            ││   │
│  │  │  Check entry.dropChance (roll 0.0-1.0)                         ││   │
│  │  └─────────────────────────────────────────────────────────────────┘│   │
│  │           │                                                           │   │
│  │           ├─── Conditions not met OR roll > dropChance ───▶ Skip    │   │
│  │           │                                                           │   │
│  │           ▼                                                           │   │
│  │  ┌─────────────────────────────────────────────────────────────────┐│   │
│  │  │  Roll quantity between entry.quantity.min and max               ││   │
│  │  │  Add item(s) to loot results                                    ││   │
│  │  └─────────────────────────────────────────────────────────────────┘│   │
│  └──────────────────────────────────────────────────────────────────────┘   │
│                                                                              │
│  STEP 3: PROCESS RANDOM POOL                                                 │
│  ┌──────────────────────────────────────────────────────────────────────┐   │
│  │  Roll dropCount between poolDropCount.min and max                    │   │
│  │           │                                                           │   │
│  │           ▼                                                           │   │
│  │  For i = 1 to dropCount:                                             │   │
│  │  ┌─────────────────────────────────────────────────────────────────┐│   │
│  │  │  Filter pool by entry.conditions                                ││   │
│  │  │  Calculate total weight of eligible entries                     ││   │
│  │  │  Roll random 1 to totalWeight                                   ││   │
│  │  │  Select entry based on cumulative weight                        ││   │
│  │  │  Roll quantity between entry.quantity.min and max               ││   │
│  │  │  Add item(s) to loot results                                    ││   │
│  │  └─────────────────────────────────────────────────────────────────┘│   │
│  └──────────────────────────────────────────────────────────────────────┘   │
│                                                                              │
│  STEP 4: PROCESS CURRENCY DROP                                               │
│  ┌──────────────────────────────────────────────────────────────────────┐   │
│  │  If currencyDrop present:                                            │   │
│  │  ┌─────────────────────────────────────────────────────────────────┐│   │
│  │  │  Roll 0.0-1.0 against currencyDrop.dropChance                   ││   │
│  │  │  If roll <= dropChance:                                         ││   │
│  │  │    Roll amount between currencyDrop.amount.min and max          ││   │
│  │  │    Add currency to loot results                                 ││   │
│  │  └─────────────────────────────────────────────────────────────────┘│   │
│  └──────────────────────────────────────────────────────────────────────┘   │
│                                                                              │
│  STEP 5: RETURN LOOT RESULTS                                                 │
│  ┌──────────────────────────────────────────────────────────────────────┐   │
│  │  Loot Results:                                                       │   │
│  │  • List of items with quantities                                     │   │
│  │  • Currency amount(s)                                                │   │
│  └──────────────────────────────────────────────────────────────────────┘   │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 3.5 Weighted Selection Diagram

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                        WEIGHTED SELECTION SYSTEM                             │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  EXAMPLE RANDOM POOL                                                         │
│                                                                              │
│  ┌────────────────────────┬─────────┬─────────────┬──────────────────┐      │
│  │ Item                   │ Weight  │ Cumulative  │ Roll Range       │      │
│  ├────────────────────────┼─────────┼─────────────┼──────────────────┤      │
│  │ dragonbane_sword       │ 10      │ 10          │ 1-10   (10%)     │      │
│  │ dragon_mail            │ 10      │ 20          │ 11-20  (10%)     │      │
│  │ dragon_claw            │ 20      │ 40          │ 21-40  (20%)     │      │
│  │ fire_resistance_ring   │ 30      │ 70          │ 41-70  (30%)     │      │
│  │ greater_health_potion  │ 30      │ 100         │ 71-100 (30%)     │      │
│  └────────────────────────┴─────────┴─────────────┴──────────────────┘      │
│                                                                              │
│  Total Weight: 100                                                           │
│                                                                              │
│  VISUAL REPRESENTATION                                                       │
│                                                                              │
│  ┌──────────────────────────────────────────────────────────────────────┐   │
│  │ 0    10    20    30    40    50    60    70    80    90   100        │   │
│  │ |─────|─────|──────────|───────────────|───────────────────|        │   │
│  │ │sword│mail │  claw    │    ring       │     potion        │        │   │
│  │ │ 10% │ 10% │   20%    │     30%       │       30%         │        │   │
│  └──────────────────────────────────────────────────────────────────────┘   │
│                                                                              │
│  SELECTION ALGORITHM                                                         │
│                                                                              │
│  1. Calculate totalWeight = sum of all entry weights                        │
│  2. Roll random integer R from 1 to totalWeight                             │
│  3. Iterate entries, accumulating weight                                    │
│  4. Select entry where cumulative weight >= R                               │
│                                                                              │
│  Example: Roll = 35                                                          │
│  • dragonbane_sword: cumulative = 10, 10 < 35, continue                     │
│  • dragon_mail: cumulative = 20, 20 < 35, continue                          │
│  • dragon_claw: cumulative = 40, 40 >= 35, SELECT dragon_claw               │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 3.6 File Layer Diagram

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                            CONFIG LAYER                                      │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  config/                                                                     │
│  ├── loot-tables.json ◀──────────────────────────┐                          │
│  │   {                                            │ references               │
│  │     "$schema": "./schemas/loot-tables.schema.json",                       │
│  │     "lootTables": [                            │                          │
│  │       {                                        │                          │
│  │         "id": "goblin_common",                 │                          │
│  │         "name": "Common Goblin Loot",          │                          │
│  │         "guaranteedDrops": [...],              │                          │
│  │         "randomPool": [...],                   │                          │
│  │         "poolDropCount": { "min": 1, "max": 2 },                         │
│  │         "currencyDrop": {                      │                          │
│  │           "dropChance": 0.8,                   │                          │
│  │           "amount": { "min": 5, "max": 15 }    │                          │
│  │         }                                      │                          │
│  │       },                                       │                          │
│  │       ...                                      │                          │
│  │     ]                                          │                          │
│  │   }                                            │                          │
│  │                                                │                          │
│  ├── weapons.json (itemType: "Weapon")            │                          │
│  ├── armor.json (itemType: "Armor")               │                          │
│  ├── items.json (itemType: "Item")                │                          │
│  │                                                │                          │
│  └── schemas/                                     │                          │
│      └── loot-tables.schema.json ─────────────────┘                          │
│          {                                                                   │
│            "$schema": "http://json-schema.org/draft-07/schema#",            │
│            "definitions": {                                                  │
│              "LootTableDefinition": {...},                                   │
│              "LootEntry": {...},                                             │
│              "QuantityRange": {...},                                         │
│              "CurrencyDrop": {...},                                          │
│              "DropCondition": {...}                                          │
│            }                                                                 │
│          }                                                                   │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 4. Loot Table Schema Definition

### 4.1 Root Configuration Properties

**File:** `config/schemas/loot-tables.schema.json`

The loot table schema follows JSON Schema Draft-07 specification, providing comprehensive validation for loot table configuration files.

```json
{
    "$schema": "http://json-schema.org/draft-07/schema#",
    "title": "Loot Table Configuration",
    "description": "Schema for loot table definitions. Defines what items monsters drop, chests contain, or quests reward.",
    "type": "object",
    "properties": {
        "$schema": {
            "type": "string",
            "description": "Reference to the JSON schema file for validation"
        },
        "version": {
            "type": "string",
            "description": "Optional version identifier for the configuration file",
            "pattern": "^[0-9]+\\.[0-9]+\\.[0-9]+$"
        },
        "lootTables": {
            "type": "array",
            "description": "List of loot table definitions",
            "items": {
                "$ref": "#/definitions/LootTableDefinition"
            },
            "minItems": 1
        }
    },
    "required": ["lootTables"],
    "additionalProperties": false,
    "definitions": {
        "LootTableDefinition": { ... },
        "LootEntry": { ... },
        "QuantityRange": { ... },
        "CurrencyDrop": { ... },
        "DropCondition": { ... }
    }
}
```

### 4.2 LootTableDefinition Definition

The `LootTableDefinition` object defines a complete loot table with guaranteed drops, random pools, and conditions.

```json
"LootTableDefinition": {
    "type": "object",
    "description": "A loot table defining items that can drop from a source",
    "properties": {
        "id": {
            "type": "string",
            "description": "Unique identifier for the loot table (lowercase with underscores/hyphens)",
            "pattern": "^[a-z][a-z0-9_-]*$",
            "minLength": 1,
            "maxLength": 50
        },
        "name": {
            "type": "string",
            "description": "Display name for the loot table",
            "minLength": 1,
            "maxLength": 100
        },
        "description": {
            "type": "string",
            "description": "Optional description of what this loot table is for"
        },
        "guaranteedDrops": {
            "type": "array",
            "description": "Items that always drop (subject to individual dropChance)",
            "items": {
                "$ref": "#/definitions/LootEntry"
            }
        },
        "randomPool": {
            "type": "array",
            "description": "Pool of items for weighted random selection",
            "items": {
                "$ref": "#/definitions/LootEntry"
            }
        },
        "poolDropCount": {
            "$ref": "#/definitions/QuantityRange",
            "description": "How many items to select from the random pool"
        },
        "currencyDrop": {
            "$ref": "#/definitions/CurrencyDrop",
            "description": "Currency (gold) dropped from this table"
        },
        "conditions": {
            "$ref": "#/definitions/DropCondition",
            "description": "Conditions that must be met for this table to apply"
        }
    },
    "required": ["id", "name"],
    "additionalProperties": false
}
```

### 4.3 LootEntry Definition

The `LootEntry` object defines a single item entry in a loot table.

```json
"LootEntry": {
    "type": "object",
    "description": "A single item entry in a loot table",
    "properties": {
        "itemId": {
            "type": "string",
            "description": "Reference to the item ID in weapons.json, armor.json, or items.json",
            "minLength": 1
        },
        "itemType": {
            "type": "string",
            "description": "The type of item being referenced",
            "enum": ["Item", "Weapon", "Armor"]
        },
        "dropChance": {
            "type": "number",
            "description": "Probability of this item dropping (0.0 to 1.0)",
            "minimum": 0,
            "maximum": 1,
            "default": 1.0
        },
        "quantity": {
            "$ref": "#/definitions/QuantityRange",
            "description": "Number of items to drop"
        },
        "conditions": {
            "$ref": "#/definitions/DropCondition",
            "description": "Conditions specific to this entry"
        },
        "weight": {
            "type": "integer",
            "description": "Weight for weighted random selection (higher = more likely)",
            "minimum": 1,
            "default": 1
        }
    },
    "required": ["itemId"],
    "additionalProperties": false
}
```

### 4.4 QuantityRange Definition

The `QuantityRange` object defines a minimum and maximum quantity for drops.

```json
"QuantityRange": {
    "type": "object",
    "description": "A range of possible quantities",
    "properties": {
        "min": {
            "type": "integer",
            "description": "Minimum quantity (inclusive)",
            "minimum": 1,
            "default": 1
        },
        "max": {
            "type": "integer",
            "description": "Maximum quantity (inclusive)",
            "minimum": 1,
            "default": 1
        }
    },
    "additionalProperties": false
}
```

### 4.5 CurrencyDrop Definition

The `CurrencyDrop` object defines currency (gold) drops.

```json
"CurrencyDrop": {
    "type": "object",
    "description": "Currency dropped from a loot table",
    "properties": {
        "dropChance": {
            "type": "number",
            "description": "Probability of currency dropping (0.0 to 1.0)",
            "minimum": 0,
            "maximum": 1,
            "default": 1.0
        },
        "amount": {
            "$ref": "#/definitions/QuantityRange",
            "description": "Range of currency amount to drop"
        },
        "currencyType": {
            "type": "string",
            "description": "Type of currency (default: gold)",
            "default": "gold"
        }
    },
    "required": ["amount"],
    "additionalProperties": false
}
```

### 4.6 DropCondition Definition

The `DropCondition` object defines conditions that must be met for drops.

```json
"DropCondition": {
    "type": "object",
    "description": "Conditions for loot to drop",
    "properties": {
        "minLevel": {
            "type": "integer",
            "description": "Minimum player level required",
            "minimum": 1
        },
        "maxLevel": {
            "type": "integer",
            "description": "Maximum player level allowed",
            "minimum": 1
        },
        "difficulty": {
            "type": "string",
            "description": "Required difficulty setting",
            "enum": ["Easy", "Normal", "Hard", "Nightmare"]
        },
        "classIds": {
            "type": "array",
            "description": "Class IDs that can receive this drop",
            "items": {
                "type": "string",
                "pattern": "^[a-z][a-z0-9_-]*$"
            }
        },
        "requiredFlags": {
            "type": "array",
            "description": "Quest flags that must be set",
            "items": {
                "type": "string"
            }
        }
    },
    "additionalProperties": false
}
```

---

## 5. Loot Table Structure

### 5.1 Guaranteed Drops

Guaranteed drops are items that always drop from the loot table (subject to individual drop chances and conditions).

**Characteristics:**
- Each entry is evaluated independently
- `dropChance` can still reduce probability (default 1.0 = always)
- Each entry can have its own conditions
- Processed before random pool

**Example:**
```json
{
    "guaranteedDrops": [
        {
            "itemId": "dragon_scale",
            "itemType": "Item",
            "dropChance": 1.0,
            "quantity": { "min": 2, "max": 5 }
        },
        {
            "itemId": "dragon_heart",
            "itemType": "Item",
            "dropChance": 0.5,
            "quantity": { "min": 1, "max": 1 }
        }
    ]
}
```

### 5.2 Random Pools

Random pools provide weighted selection from a list of items. The `weight` property determines relative probability.

**Characteristics:**
- Items are selected via weighted random
- `poolDropCount` determines how many selections
- Higher weight = higher chance of selection
- Same item can be selected multiple times (unless pool depletes)

**Example:**
```json
{
    "randomPool": [
        {
            "itemId": "health_potion",
            "itemType": "Item",
            "weight": 50,
            "quantity": { "min": 1, "max": 3 }
        },
        {
            "itemId": "iron_sword",
            "itemType": "Weapon",
            "weight": 20
        },
        {
            "itemId": "leather_armor",
            "itemType": "Armor",
            "weight": 20
        },
        {
            "itemId": "rare_gem",
            "itemType": "Item",
            "weight": 10
        }
    ]
}
```

### 5.3 Pool Drop Count

`poolDropCount` determines how many items are selected from the random pool.

**Example:**
```json
{
    "poolDropCount": {
        "min": 1,
        "max": 3
    }
}
```

This means 1 to 3 items will be selected from the random pool per loot event.

### 5.4 Currency Drops

Currency drops provide gold (or other currency types) separately from item drops.

**Example:**
```json
{
    "currencyDrop": {
        "dropChance": 0.8,
        "amount": {
            "min": 10,
            "max": 50
        },
        "currencyType": "gold"
    }
}
```

This gives an 80% chance to drop 10-50 gold.

---

## 6. Drop Condition Configuration

### 6.1 Level Range Conditions

Level conditions filter drops based on player level.

| Property | Description | Example |
|----------|-------------|---------|
| `minLevel` | Minimum player level required | `5` |
| `maxLevel` | Maximum player level allowed | `10` |

**Example:**
```json
{
    "conditions": {
        "minLevel": 5,
        "maxLevel": 10
    }
}
```

This drops only for players level 5-10.

### 6.2 Difficulty Conditions

Difficulty conditions filter based on game difficulty setting.

| Difficulty | Description |
|------------|-------------|
| `Easy` | Easiest difficulty |
| `Normal` | Standard difficulty |
| `Hard` | Challenging difficulty |
| `Nightmare` | Hardest difficulty |

**Example:**
```json
{
    "conditions": {
        "difficulty": "Hard"
    }
}
```

This drops only on Hard difficulty.

### 6.3 Class Filter Conditions

Class conditions limit drops to specific character classes.

**Example:**
```json
{
    "conditions": {
        "classIds": ["shadow-walker", "spell-weaver"]
    }
}
```

This drops only for Shadow-Walker or Spell-Weaver classes.

### 6.4 Quest Flag Conditions

Quest flag conditions require certain quest progress.

**Example:**
```json
{
    "conditions": {
        "requiredFlags": ["dragon_slain", "temple_unlocked"]
    }
}
```

This drops only if both quest flags are set.

---

## 7. Weighted Random Selection

### 7.1 Weight System

The weight system determines relative probability in random pools.

| Weight Value | Relative Chance |
|--------------|-----------------|
| 1 | Minimum (rare) |
| 10 | Low |
| 25 | Medium-low |
| 50 | Medium |
| 75 | Medium-high |
| 100 | High (common) |

**Calculation:**
- Probability = weight / totalWeight
- Example: weight 10 in pool with totalWeight 100 = 10% chance

### 7.2 Drop Chance vs Weight

| Property | Used In | Purpose |
|----------|---------|---------|
| `dropChance` | Guaranteed drops | Absolute probability (0-1) |
| `weight` | Random pool | Relative probability (integer) |

**dropChance Example (Guaranteed):**
```json
{
    "itemId": "rare_drop",
    "dropChance": 0.1
}
```
10% chance to drop.

**weight Example (Random Pool):**
```json
{
    "itemId": "common_item",
    "weight": 50
}
```
Probability depends on other weights in pool.

---

## 8. Item Reference System

### 8.1 Item Types

The `itemType` property indicates which configuration file contains the item.

| Item Type | Configuration File | Description |
|-----------|-------------------|-------------|
| `Item` | `items.json` | General items (consumables, materials, etc.) |
| `Weapon` | `weapons.json` | Weapons |
| `Armor` | `armor.json` | Armor pieces |

### 8.2 ID References

Item IDs must match IDs in the respective configuration files.

**Example References:**

```json
{
    "guaranteedDrops": [
        {
            "itemId": "health_potion",
            "itemType": "Item"
        },
        {
            "itemId": "iron_sword",
            "itemType": "Weapon"
        },
        {
            "itemId": "leather_helm",
            "itemType": "Armor"
        }
    ]
}
```

**ID Pattern:** `^[a-z][a-z0-9_-]*$`
- Starts with lowercase letter
- Contains lowercase letters, numbers, underscores, hyphens
- Examples: `health_potion`, `iron-sword`, `dragon_scale`

---

## 9. Validation Rules

### 9.1 Enum Validation

| Property | Valid Values | Validation Error |
|----------|--------------|------------------|
| `itemType` | `Item`, `Weapon`, `Armor` | "itemType must be one of: Item, Weapon, Armor" |
| `difficulty` | `Easy`, `Normal`, `Hard`, `Nightmare` | "difficulty must be one of: Easy, Normal, ..." |

### 9.2 Range Validation

| Property | Range | Validation Error |
|----------|-------|------------------|
| `dropChance` | 0.0-1.0 | "dropChance must be between 0 and 1" |
| `weight` | >= 1 | "weight must be >= 1" |
| `quantity.min` | >= 1 | "quantity.min must be >= 1" |
| `quantity.max` | >= 1 | "quantity.max must be >= 1" |
| `minLevel` | >= 1 | "minLevel must be >= 1" |
| `maxLevel` | >= 1 | "maxLevel must be >= 1" |
| `currencyDrop.amount.min` | >= 1 | "amount.min must be >= 1" |
| `currencyDrop.amount.max` | >= 1 | "amount.max must be >= 1" |

### 9.3 Required Fields

#### LootTableDefinition Required Fields

| Field | Requirement | Error on Missing |
|-------|-------------|------------------|
| `id` | Must be present and match pattern | "missing required property 'id'" |
| `name` | Must be present and non-empty | "missing required property 'name'" |

#### LootEntry Required Fields

| Field | Requirement | Error on Missing |
|-------|-------------|------------------|
| `itemId` | Must be present | "missing required property 'itemId'" |

#### CurrencyDrop Required Fields

| Field | Requirement | Error on Missing |
|-------|-------------|------------------|
| `amount` | Must be present with min/max | "missing required property 'amount'" |

### 9.4 Pattern Validation

| Property | Pattern | Validation Error |
|----------|---------|------------------|
| `id` | `^[a-z][a-z0-9_-]*$` | "id must match pattern ^[a-z][a-z0-9_-]*$" |
| `version` | `^[0-9]+\.[0-9]+\.[0-9]+$` | "version must match pattern (e.g., '1.0.0')" |
| `classIds` elements | `^[a-z][a-z0-9_-]*$` | "classId must match pattern" |

### 9.5 Quantity Range Validation

Quantity ranges should have min <= max (semantic validation).

| Validation | Error Message |
|------------|---------------|
| `min > max` | "quantity.min should not exceed quantity.max" |

Note: This is a semantic validation that may require custom validation logic beyond JSON Schema.

---

## 10. Configuration Schema

### Complete Loot Tables Schema File

**File:** `config/schemas/loot-tables.schema.json`

```json
{
    "$schema": "http://json-schema.org/draft-07/schema#",
    "title": "Loot Table Configuration",
    "description": "Schema for loot table definitions. Defines what items monsters drop, chests contain, or quests reward.",
    "type": "object",
    "properties": {
        "$schema": {
            "type": "string",
            "description": "Reference to the JSON schema file for validation"
        },
        "version": {
            "type": "string",
            "description": "Optional version identifier for the configuration file",
            "pattern": "^[0-9]+\\.[0-9]+\\.[0-9]+$"
        },
        "lootTables": {
            "type": "array",
            "description": "List of loot table definitions",
            "items": {
                "$ref": "#/definitions/LootTableDefinition"
            },
            "minItems": 1
        }
    },
    "required": ["lootTables"],
    "additionalProperties": false,
    "definitions": {
        "LootTableDefinition": {
            "type": "object",
            "description": "A loot table defining items that can drop from a source",
            "properties": {
                "id": {
                    "type": "string",
                    "description": "Unique identifier for the loot table (lowercase with underscores/hyphens)",
                    "pattern": "^[a-z][a-z0-9_-]*$",
                    "minLength": 1,
                    "maxLength": 50
                },
                "name": {
                    "type": "string",
                    "description": "Display name for the loot table",
                    "minLength": 1,
                    "maxLength": 100
                },
                "description": {
                    "type": "string",
                    "description": "Optional description of what this loot table is for"
                },
                "guaranteedDrops": {
                    "type": "array",
                    "description": "Items that always drop (subject to individual dropChance)",
                    "items": {
                        "$ref": "#/definitions/LootEntry"
                    }
                },
                "randomPool": {
                    "type": "array",
                    "description": "Pool of items for weighted random selection",
                    "items": {
                        "$ref": "#/definitions/LootEntry"
                    }
                },
                "poolDropCount": {
                    "$ref": "#/definitions/QuantityRange",
                    "description": "How many items to select from the random pool"
                },
                "currencyDrop": {
                    "$ref": "#/definitions/CurrencyDrop",
                    "description": "Currency (gold) dropped from this table"
                },
                "conditions": {
                    "$ref": "#/definitions/DropCondition",
                    "description": "Conditions that must be met for this table to apply"
                }
            },
            "required": ["id", "name"],
            "additionalProperties": false
        },
        "LootEntry": {
            "type": "object",
            "description": "A single item entry in a loot table",
            "properties": {
                "itemId": {
                    "type": "string",
                    "description": "Reference to the item ID in weapons.json, armor.json, or items.json",
                    "minLength": 1
                },
                "itemType": {
                    "type": "string",
                    "description": "The type of item being referenced",
                    "enum": ["Item", "Weapon", "Armor"]
                },
                "dropChance": {
                    "type": "number",
                    "description": "Probability of this item dropping (0.0 to 1.0)",
                    "minimum": 0,
                    "maximum": 1,
                    "default": 1.0
                },
                "quantity": {
                    "$ref": "#/definitions/QuantityRange",
                    "description": "Number of items to drop"
                },
                "conditions": {
                    "$ref": "#/definitions/DropCondition",
                    "description": "Conditions specific to this entry"
                },
                "weight": {
                    "type": "integer",
                    "description": "Weight for weighted random selection (higher = more likely)",
                    "minimum": 1,
                    "default": 1
                }
            },
            "required": ["itemId"],
            "additionalProperties": false
        },
        "QuantityRange": {
            "type": "object",
            "description": "A range of possible quantities",
            "properties": {
                "min": {
                    "type": "integer",
                    "description": "Minimum quantity (inclusive)",
                    "minimum": 1,
                    "default": 1
                },
                "max": {
                    "type": "integer",
                    "description": "Maximum quantity (inclusive)",
                    "minimum": 1,
                    "default": 1
                }
            },
            "additionalProperties": false
        },
        "CurrencyDrop": {
            "type": "object",
            "description": "Currency dropped from a loot table",
            "properties": {
                "dropChance": {
                    "type": "number",
                    "description": "Probability of currency dropping (0.0 to 1.0)",
                    "minimum": 0,
                    "maximum": 1,
                    "default": 1.0
                },
                "amount": {
                    "$ref": "#/definitions/QuantityRange",
                    "description": "Range of currency amount to drop"
                },
                "currencyType": {
                    "type": "string",
                    "description": "Type of currency (default: gold)",
                    "default": "gold"
                }
            },
            "required": ["amount"],
            "additionalProperties": false
        },
        "DropCondition": {
            "type": "object",
            "description": "Conditions for loot to drop",
            "properties": {
                "minLevel": {
                    "type": "integer",
                    "description": "Minimum player level required",
                    "minimum": 1
                },
                "maxLevel": {
                    "type": "integer",
                    "description": "Maximum player level allowed",
                    "minimum": 1
                },
                "difficulty": {
                    "type": "string",
                    "description": "Required difficulty setting",
                    "enum": ["Easy", "Normal", "Hard", "Nightmare"]
                },
                "classIds": {
                    "type": "array",
                    "description": "Class IDs that can receive this drop",
                    "items": {
                        "type": "string",
                        "pattern": "^[a-z][a-z0-9_-]*$"
                    }
                },
                "requiredFlags": {
                    "type": "array",
                    "description": "Quest flags that must be set",
                    "items": {
                        "type": "string"
                    }
                }
            },
            "additionalProperties": false
        }
    }
}
```

---

## 11. Configuration File Updates

### New loot-tables.json

Create a new `loot-tables.json` configuration file with example loot tables covering various use cases.

**File:** `config/loot-tables.json`

```json
{
    "$schema": "./schemas/loot-tables.schema.json",
    "lootTables": [
        {
            "id": "goblin_common",
            "name": "Common Goblin Loot",
            "description": "Basic loot dropped by common goblins",
            "randomPool": [
                {
                    "itemId": "health_potion",
                    "itemType": "Item",
                    "weight": 40,
                    "quantity": { "min": 1, "max": 2 }
                },
                {
                    "itemId": "iron_ore",
                    "itemType": "Item",
                    "weight": 30,
                    "quantity": { "min": 1, "max": 3 }
                },
                {
                    "itemId": "rusty_dagger",
                    "itemType": "Weapon",
                    "weight": 20
                },
                {
                    "itemId": "leather_scraps",
                    "itemType": "Item",
                    "weight": 10,
                    "quantity": { "min": 1, "max": 2 }
                }
            ],
            "poolDropCount": {
                "min": 1,
                "max": 2
            },
            "currencyDrop": {
                "dropChance": 0.8,
                "amount": { "min": 5, "max": 15 },
                "currencyType": "gold"
            }
        },
        {
            "id": "goblin_shaman",
            "name": "Goblin Shaman Loot",
            "description": "Loot from goblin shamans with magical items",
            "guaranteedDrops": [
                {
                    "itemId": "shaman_staff",
                    "itemType": "Weapon",
                    "dropChance": 0.3
                }
            ],
            "randomPool": [
                {
                    "itemId": "mana_potion",
                    "itemType": "Item",
                    "weight": 35,
                    "quantity": { "min": 1, "max": 2 }
                },
                {
                    "itemId": "magic_dust",
                    "itemType": "Item",
                    "weight": 25,
                    "quantity": { "min": 1, "max": 3 }
                },
                {
                    "itemId": "scroll_of_fireball",
                    "itemType": "Item",
                    "weight": 20
                },
                {
                    "itemId": "enchanted_robe",
                    "itemType": "Armor",
                    "weight": 15
                },
                {
                    "itemId": "rare_gem",
                    "itemType": "Item",
                    "weight": 5
                }
            ],
            "poolDropCount": {
                "min": 1,
                "max": 3
            },
            "currencyDrop": {
                "dropChance": 0.9,
                "amount": { "min": 15, "max": 40 },
                "currencyType": "gold"
            }
        },
        {
            "id": "treasure_chest_small",
            "name": "Small Treasure Chest",
            "description": "Contents of small treasure chests",
            "guaranteedDrops": [
                {
                    "itemId": "gold_coins",
                    "itemType": "Item",
                    "quantity": { "min": 1, "max": 1 }
                }
            ],
            "randomPool": [
                {
                    "itemId": "health_potion",
                    "itemType": "Item",
                    "weight": 30,
                    "quantity": { "min": 1, "max": 2 }
                },
                {
                    "itemId": "mana_potion",
                    "itemType": "Item",
                    "weight": 25
                },
                {
                    "itemId": "antidote",
                    "itemType": "Item",
                    "weight": 20
                },
                {
                    "itemId": "torch",
                    "itemType": "Item",
                    "weight": 15,
                    "quantity": { "min": 2, "max": 5 }
                },
                {
                    "itemId": "lockpick",
                    "itemType": "Item",
                    "weight": 10,
                    "quantity": { "min": 1, "max": 3 }
                }
            ],
            "poolDropCount": {
                "min": 2,
                "max": 4
            },
            "currencyDrop": {
                "dropChance": 1.0,
                "amount": { "min": 25, "max": 75 },
                "currencyType": "gold"
            }
        },
        {
            "id": "boss_dragon",
            "name": "Dragon Boss Loot",
            "description": "Legendary loot from the ancient dragon boss",
            "guaranteedDrops": [
                {
                    "itemId": "dragon_scale",
                    "itemType": "Item",
                    "quantity": { "min": 3, "max": 7 }
                },
                {
                    "itemId": "dragon_heart",
                    "itemType": "Item",
                    "dropChance": 0.5
                }
            ],
            "randomPool": [
                {
                    "itemId": "dragonbane_sword",
                    "itemType": "Weapon",
                    "weight": 10
                },
                {
                    "itemId": "dragon_mail",
                    "itemType": "Armor",
                    "weight": 10
                },
                {
                    "itemId": "dragon_claw_dagger",
                    "itemType": "Weapon",
                    "weight": 15
                },
                {
                    "itemId": "fire_resistance_ring",
                    "itemType": "Item",
                    "weight": 20
                },
                {
                    "itemId": "greater_health_potion",
                    "itemType": "Item",
                    "weight": 25,
                    "quantity": { "min": 2, "max": 4 }
                },
                {
                    "itemId": "panacea",
                    "itemType": "Item",
                    "weight": 20
                }
            ],
            "poolDropCount": {
                "min": 3,
                "max": 5
            },
            "currencyDrop": {
                "dropChance": 1.0,
                "amount": { "min": 500, "max": 2000 },
                "currencyType": "gold"
            },
            "conditions": {
                "minLevel": 15
            }
        },
        {
            "id": "quest_reward_tier1",
            "name": "Tier 1 Quest Reward",
            "description": "Fixed rewards for completing tier 1 quests",
            "guaranteedDrops": [
                {
                    "itemId": "health_potion",
                    "itemType": "Item",
                    "quantity": { "min": 3, "max": 3 }
                },
                {
                    "itemId": "mana_potion",
                    "itemType": "Item",
                    "quantity": { "min": 2, "max": 2 }
                }
            ],
            "currencyDrop": {
                "dropChance": 1.0,
                "amount": { "min": 100, "max": 100 },
                "currencyType": "gold"
            }
        },
        {
            "id": "nightmare_bonus",
            "name": "Nightmare Difficulty Bonus",
            "description": "Extra loot only available on Nightmare difficulty",
            "randomPool": [
                {
                    "itemId": "epic_weapon_token",
                    "itemType": "Item",
                    "weight": 30
                },
                {
                    "itemId": "epic_armor_token",
                    "itemType": "Item",
                    "weight": 30
                },
                {
                    "itemId": "legendary_essence",
                    "itemType": "Item",
                    "weight": 20
                },
                {
                    "itemId": "ancient_rune",
                    "itemType": "Item",
                    "weight": 20
                }
            ],
            "poolDropCount": {
                "min": 1,
                "max": 2
            },
            "conditions": {
                "difficulty": "Nightmare"
            }
        },
        {
            "id": "class_specific_shadow_walker",
            "name": "Shadow-Walker Class Drops",
            "description": "Bonus drops only for Shadow-Walker class",
            "randomPool": [
                {
                    "itemId": "shadow_blade",
                    "itemType": "Weapon",
                    "weight": 25
                },
                {
                    "itemId": "cloak_of_shadows",
                    "itemType": "Armor",
                    "weight": 25
                },
                {
                    "itemId": "smoke_bomb",
                    "itemType": "Item",
                    "weight": 30,
                    "quantity": { "min": 2, "max": 5 }
                },
                {
                    "itemId": "poison_vial",
                    "itemType": "Item",
                    "weight": 20,
                    "quantity": { "min": 1, "max": 3 }
                }
            ],
            "poolDropCount": {
                "min": 1,
                "max": 1
            },
            "conditions": {
                "classIds": ["shadow-walker"]
            }
        },
        {
            "id": "post_dragon_quest_bonus",
            "name": "Post-Dragon Quest Bonus",
            "description": "Bonus loot available after slaying the dragon",
            "guaranteedDrops": [
                {
                    "itemId": "dragon_slayer_medal",
                    "itemType": "Item"
                }
            ],
            "randomPool": [
                {
                    "itemId": "dragon_tooth_necklace",
                    "itemType": "Item",
                    "weight": 40
                },
                {
                    "itemId": "flame_enchant_scroll",
                    "itemType": "Item",
                    "weight": 30
                },
                {
                    "itemId": "dragon_rider_boots",
                    "itemType": "Armor",
                    "weight": 30
                }
            ],
            "poolDropCount": {
                "min": 1,
                "max": 2
            },
            "conditions": {
                "requiredFlags": ["dragon_slain"]
            }
        }
    ]
}
```

---

## 12. Data Model Changes

### No Domain Changes Required

This phase creates only a JSON Schema file and configuration file. No changes to domain entities, services, or application layer are required.

| Layer | Changes |
|-------|---------|
| Domain | None |
| Application | None |
| Infrastructure | None |
| Configuration | One schema file added, one config file created |

### Schema as Documentation

The schema serves as:
- **Validation contract** for loot table configuration
- **IDE documentation** via description fields
- **Modding reference** for custom loot systems
- **Design specification** for loot mechanics

---

## 13. Logging Specifications

### No Runtime Logging Required

Schema validation occurs at design-time in IDE/editors, not at runtime. No logging infrastructure changes are needed for this phase.

| Component | Level | Events |
|-----------|-------|--------|
| N/A | N/A | Schema validation is IDE-based |

---

## 14. Unit Testing Requirements

### Test Count by Feature

| Feature | Test Count |
|---------|------------|
| Schema Valid Structure | ~1 |
| Drop Chance Range Validation | ~1 |
| Quantity Range Validation | ~1 |
| Item Type Enum Validation | ~1 |
| Configuration File Validation | ~1 |
| **Total** | **~5** |

### Test Descriptions

#### LootTablesSchemaTests.cs

```csharp
[TestFixture]
public class LootTablesSchemaTests
{
    /// <summary>
    /// Verifies the schema file is valid JSON Schema Draft-07.
    /// </summary>
    [Test]
    public void Schema_IsValidJsonSchemaDraft07();

    /// <summary>
    /// Verifies the loot-tables.json validates against the schema without errors.
    /// </summary>
    [Test]
    public void LootTablesJson_ValidatesAgainstSchema();

    /// <summary>
    /// Verifies dropChance must be between 0 and 1.
    /// </summary>
    [Test]
    public void DropChance_OutOfRange_FailsValidation();

    /// <summary>
    /// Verifies quantity.min and quantity.max must be >= 1.
    /// </summary>
    [Test]
    public void QuantityRange_InvalidValues_FailsValidation();

    /// <summary>
    /// Verifies itemType must be a valid enum value.
    /// </summary>
    [Test]
    public void ItemType_InvalidEnumValue_FailsValidation();
}
```

### Test Implementation Notes

Tests should use a JSON Schema validation library (e.g., `NJsonSchema` for C#) to:
1. Load the schema file
2. Validate test JSON documents
3. Assert expected validation results

---

## 15. Use Cases

### UC-001: Load Loot Table Configuration

**Actor:** Game System
**Flow:** System starts -> Loads `loot-tables.json` -> Schema validates content -> Loot tables available for loot distribution system

### UC-002: Edit Loot Tables in IDE

**Actor:** Developer/Modder
**Flow:** Opens `loot-tables.json` in VS Code -> IDE loads schema -> Autocomplete suggests properties -> Validation errors shown inline

### UC-003: Add New Monster Loot Table

**Actor:** Modder
**Flow:** Adds new loot table to `lootTables` array -> Sets id, name -> Adds guaranteedDrops and/or randomPool -> Sets poolDropCount -> Adds currencyDrop -> IDE validates structure

### UC-004: Add Conditional Drop

**Actor:** Modder
**Flow:** Adds entry to randomPool -> Sets itemId and weight -> Adds conditions with minLevel and difficulty -> IDE validates structure

### UC-005: Invalid Drop Chance

**Actor:** Modder
**Flow:** Sets dropChance to 1.5 (over limit) -> IDE shows error "dropChance must be <= 1" -> Modder corrects to 0.5

### UC-006: Create Quest Reward Table

**Actor:** Modder
**Flow:** Adds new loot table -> Sets guaranteedDrops with fixed quantities -> Adds currencyDrop with fixed amount -> IDE validates structure

---

## 16. Deliverable Checklist

### Schema Files
- [ ] `config/schemas/loot-tables.schema.json` created
- [ ] Schema follows JSON Schema Draft-07 format
- [ ] Schema includes all defined properties
- [ ] Schema includes definitions section (LootTableDefinition, LootEntry, QuantityRange, CurrencyDrop, DropCondition)

### Validation Rules
- [ ] Loot table ID pattern validation: `^[a-z][a-z0-9_-]*$`
- [ ] Drop chance range validation (0.0 to 1.0)
- [ ] Quantity range validation (min >= 1, max >= 1)
- [ ] Weight minimum validation (>= 1)
- [ ] Item type enum validation: Item, Weapon, Armor
- [ ] Difficulty enum validation: Easy, Normal, Hard, Nightmare
- [ ] Currency amount validation (min >= 1, max >= 1)
- [ ] Required fields enforced
- [ ] Optional fields have defaults

### Configuration Files
- [ ] `loot-tables.json` created with example loot tables
- [ ] Loot tables cover various use cases (monster, chest, boss, quest, conditional)
- [ ] loot-tables.json validates against schema

### Testing
- [ ] ~5 unit tests implemented
- [ ] All tests passing
- [ ] Tests cover happy path and error cases

### Documentation
- [ ] Schema properties have descriptions
- [ ] This design specification complete

---

## 17. Acceptance Criteria

### Functional
- [ ] `loot-tables.schema.json` created in `config/schemas/` directory
- [ ] Schema validates with sample loot tables
- [ ] Drop chance validated (0.0 to 1.0)
- [ ] Quantity range validated (min/max both >= 1)
- [ ] Guaranteed drops array validated
- [ ] Random pool with weights validated
- [ ] Pool drop count validated
- [ ] Currency drop structure validated
- [ ] Drop conditions validated at table and entry level
- [ ] Item type enum validated (Item, Weapon, Armor)
- [ ] Difficulty enum validated (Easy, Normal, Hard, Nightmare)
- [ ] VS Code provides autocomplete when schema linked

### Quality
- [ ] Build succeeds with 0 errors
- [ ] Build succeeds with 0 warnings
- [ ] ~5 unit tests pass
- [ ] Schema file is valid JSON
- [ ] All schema properties have descriptions

---

## 18. Dependencies

### Required from Prior Versions

| Type | Location | Usage in this phase |
|------|----------|---------------------|
| `weapons.schema.json` | `config/schemas/weapons.schema.json` (v0.14.2a) | itemType "Weapon" references |
| `armor.schema.json` | `config/schemas/armor.schema.json` (v0.14.2b) | itemType "Armor" references |
| `items.schema.json` | `config/schemas/items.schema.json` (v0.14.2c) | itemType "Item" references |
| ID patterns | Prior schemas | Consistent ID patterns |
| Difficulty enum | Game systems | Shared enumeration |

### Provides to Future Versions

| Type | Usage |
|------|-------|
| `loot-tables.schema.json` | Validates loot table configuration |
| LootTableDefinition pattern | Used by monsters.json for loot assignment |
| DropCondition definition | Reference for conditional mechanics |
| QuantityRange definition | Reusable range pattern |
| Loot table IDs | Referenced by monsters.json (v0.14.3) |

### Implementation Order Note

**v0.14.2d should be implemented last in the v0.14.2 series** as it references weapon, armor, and item IDs from v0.14.2a, v0.14.2b, and v0.14.2c.

---

## 19. Future Considerations

### Deferred to Future Versions

- **Cross-reference validation**: Validating itemId references exist in respective config files
- **Loot table inheritance**: Tables that extend or modify other tables
- **Loot modifiers**: Luck-based modifications to drop rates
- **Seasonal/event loot**: Time-limited loot table variations
- **Loot table nesting**: Tables that include other tables

### Out of Scope

- **Runtime loot distribution**: Application-level loot resolution (handled by loot service)
- **Monster loot assignment**: Assigning tables to monsters (v0.14.3)
- **Chest/container definitions**: What containers use which tables (v0.14.4)
- **Dynamic loot scaling**: Level-based loot modification (future version)
- **Loot preview UI**: Displaying potential loot to players (presentation concern)
- **Balance tuning**: Specific drop rates and quantities (design decisions)

### Potential Future Enhancements

If the loot system expands, consider adding to the schema:

**Loot Table Inheritance:**
```json
"extends": {
    "type": "string",
    "description": "ID of parent loot table to inherit from",
    "pattern": "^[a-z][a-z0-9_-]*$"
}
```

**Luck Modifier:**
```json
"luckModifier": {
    "type": "object",
    "properties": {
        "affectsDropChance": { "type": "boolean", "default": true },
        "affectsQuantity": { "type": "boolean", "default": false },
        "affectsRarity": { "type": "boolean", "default": false }
    }
}
```

**Time-Limited Availability:**
```json
"availability": {
    "type": "object",
    "properties": {
        "startDate": { "type": "string", "format": "date-time" },
        "endDate": { "type": "string", "format": "date-time" },
        "eventId": { "type": "string" }
    }
}
```

**Nested Tables:**
```json
"nestedTables": {
    "type": "array",
    "description": "Other loot tables to also roll when this table is used",
    "items": {
        "type": "object",
        "properties": {
            "tableId": { "type": "string" },
            "chance": { "type": "number", "minimum": 0, "maximum": 1 }
        }
    }
}
```

**Rarity Tiers for Entries:**
```json
"rarity": {
    "type": "string",
    "description": "Rarity tier of this entry for sorting/display",
    "enum": ["Common", "Uncommon", "Rare", "Epic", "Legendary"]
}
```

---

*Document Version: 1.0*
*Last Updated: 2026-01-17*
*Author: Claude*
