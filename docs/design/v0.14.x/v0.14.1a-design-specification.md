# v0.14.1a Design Specification: Ability Schema Expansion

**Version:** 0.14.1a
**Parent:** v0.14.1 (Combat Configuration Schemas)
**Prerequisites:** v0.14.0 Complete (Character Configuration Schemas)
**Status:** Design Complete

---

## Table of Contents

1. [Executive Summary](#1-executive-summary)
2. [Feature Overview](#2-feature-overview)
3. [Architecture Diagrams](#3-architecture-diagrams)
4. [Combo Chain System](#4-combo-chain-system)
   - 4.1 [Combo Chain Definition](#41-combo-chain-definition)
   - 4.2 [Combo Window Mechanics](#42-combo-window-mechanics)
   - 4.3 [Combo Bonus Damage](#43-combo-bonus-damage)
5. [Prerequisites System](#5-prerequisites-system)
   - 5.1 [Prerequisites Definition](#51-prerequisites-definition)
   - 5.2 [Requirement Types](#52-requirement-types)
6. [Area of Effect Parameters](#6-area-of-effect-parameters)
   - 6.1 [AoE Shape Definitions](#61-aoe-shape-definitions)
   - 6.2 [Target Type Expansion](#62-target-type-expansion)
7. [Charge-Based Abilities](#7-charge-based-abilities)
   - 7.1 [Charge Configuration](#71-charge-configuration)
   - 7.2 [Charge Regeneration](#72-charge-regeneration)
8. [Validation Rules](#8-validation-rules)
   - 8.1 [Conditional Validation](#81-conditional-validation)
   - 8.2 [ID Reference Validation](#82-id-reference-validation)
   - 8.3 [Range Validation](#83-range-validation)
9. [Configuration Schema](#9-configuration-schema)
10. [Configuration File Updates](#10-configuration-file-updates)
11. [Data Model Changes](#11-data-model-changes)
12. [Logging Specifications](#12-logging-specifications)
13. [Unit Testing Requirements](#13-unit-testing-requirements)
14. [Use Cases](#14-use-cases)
15. [Deliverable Checklist](#15-deliverable-checklist)
16. [Acceptance Criteria](#16-acceptance-criteria)
17. [Dependencies](#17-dependencies)
18. [Future Considerations](#18-future-considerations)

---

## 1. Executive Summary

Version 0.14.1a expands the existing **abilities.schema.json** to support advanced ability mechanics: combo chains, prerequisites, area-of-effect parameters, and charge-based abilities. This expansion enables complex ability configurations without code changes, supporting game designs with combo systems, ability unlock trees, spatial abilities, and resource-managed abilities with multiple charges.

The expansion maintains full backwards compatibility with existing abilities.json configurations by making all new fields optional with sensible defaults.

### Key Deliverables

| Category | Items |
|----------|-------|
| **Schema Expansions** | ComboChain, Prerequisites, AoEParameters, ChargeConfig definitions |
| **Target Type Additions** | Cone, Line target types added to enum |
| **Configuration Updates** | Existing abilities.json remains valid (no changes required) |
| **Tests** | ~6 new unit tests |

### Architectural Significance

This version establishes **advanced ability patterns** that enable:
- **Combo chain system** - Abilities that chain together with bonuses
- **Prerequisite trees** - Unlock requirements for abilities
- **Spatial targeting** - Cone and line-based abilities with configurable parameters
- **Charge management** - Abilities with multiple uses before cooldown

### Relationship to Other Schemas

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                     v0.14.1 COMBAT CONFIGURATION SCHEMAS                     │
└─────────────────────────────────────────────────────────────────────────────┘

  ┌─────────────────────────────────────────────────────────────────────────┐
  │  v0.14.1a: abilities.schema.json EXPANSION ◀── THIS VERSION             │
  │  v0.14.1b: status-effects.schema.json                                    │
  │  v0.14.1c: damage-types.schema.json                                      │
  │  v0.14.1d: combat.schema.json                                            │
  └─────────────────────────────────────────────────────────────────────────┘

  Abilities Schema References:
  • Status effects (v0.14.1b) - effects[].statusEffect field
  • Damage types (v0.14.1c) - effects[].damageType field (future)
  • Classes (v0.14.0b) - classIds field
  • Archetypes (v0.14.0d) - prerequisites.requiredArchetypeId field
```

---

## 2. Feature Overview

```
v0.14.1a Ability Schema Expansion Features
├── abilities.schema.json EXPANSION
│   ├── Existing Properties (unchanged)
│   │   ├── id, name, description
│   │   ├── classIds, costResource, costAmount
│   │   ├── cooldown, unlockLevel, tags
│   │   ├── targetType (MODIFIED: add Cone, Line)
│   │   └── effects (unchanged)
│   └── New Properties
│       ├── comboChain (optional)
│       │   ├── nextAbilityId (string, kebab-case)
│       │   ├── comboWindowTurns (integer, min: 1, default: 1)
│       │   └── comboBonusDamage (number, percentage)
│       ├── prerequisites (optional)
│       │   ├── requiredLevel (integer, min: 1)
│       │   ├── requiredClassIds (array of string)
│       │   ├── requiredAbilityIds (array of string)
│       │   └── requiredArchetypeId (string)
│       ├── aoeParameters (optional, required for Area/Cone/Line)
│       │   ├── radius (integer, min: 1)
│       │   ├── shape (enum: Circle, Square, Cone, Line)
│       │   ├── coneAngle (integer, 15-180, for Cone)
│       │   ├── lineLength (integer, min: 1, for Line)
│       │   └── includeOrigin (boolean, default: false)
│       └── charges (optional)
│           ├── maxCharges (integer, min: 1)
│           ├── chargeRegenTurns (integer, min: 1)
│           └── startingCharges (integer, default: maxCharges)
├── Target Type Enum Expansion
│   ├── Existing: Self, SingleEnemy, AllEnemies, SingleAlly, AllAllies, Area, None
│   └── New: Cone, Line
└── Backwards Compatibility
    └── All new fields optional with defaults
```

---

## 3. Architecture Diagrams

### 3.1 Schema Expansion Overview

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                    ABILITIES SCHEMA EXPANSION OVERVIEW                       │
└─────────────────────────────────────────────────────────────────────────────┘

  ┌────────────────────────────────────────────────────────────────────────┐
  │                    EXISTING abilities.schema.json                       │
  ├────────────────────────────────────────────────────────────────────────┤
  │  properties:                                                            │
  │  ├── id, name, description, classIds                                   │
  │  ├── costResource, costAmount, cooldown                                │
  │  ├── targetType (enum)                                                 │
  │  ├── unlockLevel, tags                                                 │
  │  └── effects (array)                                                   │
  │                                                                         │
  │  definitions:                                                           │
  │  └── effect (type, value, duration, chance, etc.)                      │
  └────────────────────────────────────────────────────────────────────────┘
                                    │
                                    │ EXPAND
                                    ▼
  ┌────────────────────────────────────────────────────────────────────────┐
  │                    EXPANDED abilities.schema.json                       │
  ├────────────────────────────────────────────────────────────────────────┤
  │  properties:                                                            │
  │  ├── [all existing properties]                                         │
  │  ├── targetType (enum + Cone, Line)  ◀── MODIFIED                      │
  │  ├── comboChain (ComboChain)         ◀── NEW                           │
  │  ├── prerequisites (Prerequisites)   ◀── NEW                           │
  │  ├── aoeParameters (AoEParameters)   ◀── NEW                           │
  │  └── charges (ChargeConfig)          ◀── NEW                           │
  │                                                                         │
  │  definitions:                                                           │
  │  ├── effect (unchanged)                                                │
  │  ├── ComboChain (NEW)                                                  │
  │  ├── Prerequisites (NEW)                                               │
  │  ├── AoEParameters (NEW)                                               │
  │  └── ChargeConfig (NEW)                                                │
  └────────────────────────────────────────────────────────────────────────┘
```

### 3.2 Combo Chain Flow Diagram

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                          COMBO CHAIN FLOW                                    │
└─────────────────────────────────────────────────────────────────────────────┘

  Turn 1: Player uses "slash"
           │
           ▼
  ┌─────────────────────────────────────────────────────────────────────────┐
  │  Ability: "slash"                                                        │
  │  comboChain: {                                                           │
  │    nextAbilityId: "double-slash",                                        │
  │    comboWindowTurns: 1,                                                  │
  │    comboBonusDamage: 0.25                                                │
  │  }                                                                       │
  └─────────────────────────────────────────────────────────────────────────┘
           │
           │ System marks "double-slash" as available
           │ Combo window: 1 turn
           ▼
  Turn 2: Player has two options
           │
           ├─── Uses "double-slash" ──▶ Combo continues!
           │    └── Bonus: +25% damage
           │    └── Next combo ability becomes available
           │
           └─── Uses different ability OR no action ──▶ Combo breaks
                └── Combo chain resets
                └── "slash" must be used again to start combo

  ┌─────────────────────────────────────────────────────────────────────────┐
  │  COMBO CHAIN EXAMPLE                                                     │
  ├─────────────────────────────────────────────────────────────────────────┤
  │                                                                          │
  │  "slash" ──(+25%)──▶ "double-slash" ──(+50%)──▶ "triple-slash"          │
  │     │                     │                          │                   │
  │     │                     │                          │                   │
  │  1 turn window        1 turn window               End of chain           │
  │                                                                          │
  └─────────────────────────────────────────────────────────────────────────┘
```

### 3.3 Prerequisites Validation Diagram

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                      PREREQUISITES VALIDATION                                │
└─────────────────────────────────────────────────────────────────────────────┘

  Character attempts to use ability with prerequisites
           │
           ▼
  ┌─────────────────────────────────────────────────────────────────────────┐
  │  Check prerequisites:                                                    │
  │  {                                                                       │
  │    requiredLevel: 5,                                                     │
  │    requiredClassIds: ["shieldmaiden", "warrior"],                        │
  │    requiredAbilityIds: ["basic-attack"],                                 │
  │    requiredArchetypeId: "warrior"                                        │
  │  }                                                                       │
  └─────────────────────────────────────────────────────────────────────────┘
           │
           ├─── requiredLevel ──▶ Character.Level >= 5?
           │    └── Yes: Continue │ No: FAIL
           │
           ├─── requiredClassIds ──▶ Character.ClassId in list?
           │    └── Yes: Continue │ No: FAIL
           │
           ├─── requiredAbilityIds ──▶ Character has all abilities?
           │    └── Yes: Continue │ No: FAIL
           │
           └─── requiredArchetypeId ──▶ Character.ArchetypeId matches?
                └── Yes: SUCCESS │ No: FAIL

  Note: All present prerequisites must pass (AND logic)
        Missing/null prerequisites are ignored (optional)
```

### 3.4 AoE Shape Diagrams

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                          AOE SHAPE DEFINITIONS                               │
└─────────────────────────────────────────────────────────────────────────────┘

  CIRCLE (radius: 2)                    SQUARE (radius: 2)
  ┌───────────────────┐                 ┌───────────────────┐
  │     . . X . .     │                 │   X X X X X       │
  │   . X X X X X .   │                 │   X X X X X       │
  │   X X X O X X X   │                 │   X X O X X       │
  │   . X X X X X .   │                 │   X X X X X       │
  │     . . X . .     │                 │   X X X X X       │
  └───────────────────┘                 └───────────────────┘
       O = Origin                            O = Origin
       X = Affected                          X = Affected

  CONE (coneAngle: 90, radius: 3)       LINE (lineLength: 4)
  ┌───────────────────┐                 ┌───────────────────┐
  │         X X X     │                 │                   │
  │       X X X X     │                 │   O X X X X       │
  │   O X X X X X     │                 │                   │
  │       X X X X     │                 │                   │
  │         X X X     │                 │                   │
  └───────────────────┘                 └───────────────────┘
       O = Origin (Caster)                  O = Origin (Caster)
       X = Affected tiles                   X = Affected tiles

  includeOrigin: true                   includeOrigin: false
  ┌───────────────────┐                 ┌───────────────────┐
  │   . X X X .       │                 │   . X X X .       │
  │   X X O X X       │  ◀── Origin     │   X X . X X       │  ◀── Origin
  │   . X X X .       │      included   │   . X X X .       │      excluded
  └───────────────────┘                 └───────────────────┘
```

### 3.5 Charge System Diagram

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                          CHARGE SYSTEM FLOW                                  │
└─────────────────────────────────────────────────────────────────────────────┘

  Ability: "blink" (Teleport)
  charges: {
    maxCharges: 3,
    chargeRegenTurns: 2,
    startingCharges: 3
  }

  ┌─────────────────────────────────────────────────────────────────────────┐
  │  CHARGE STATE TIMELINE                                                   │
  ├─────────────────────────────────────────────────────────────────────────┤
  │                                                                          │
  │  Start:     [■ ■ ■] 3/3 charges                                         │
  │                │                                                         │
  │  Turn 1:    Use blink                                                    │
  │             [■ ■ □] 2/3 charges                                         │
  │                │                                                         │
  │  Turn 2:    Use blink                                                    │
  │             [■ □ □] 1/3 charges                                         │
  │                │                                                         │
  │  Turn 3:    End turn (no use)                                            │
  │             [■ □ □] 1/3 charges (regen in 1 turn)                       │
  │                │                                                         │
  │  Turn 4:    End turn (no use)                                            │
  │             [■ ■ □] 2/3 charges (+1 regenerated)                        │
  │                │                                                         │
  │  Turn 5:    Use blink                                                    │
  │             [■ □ □] 1/3 charges                                         │
  │                │                                                         │
  │  Turn 6:    End turn                                                     │
  │             [■ □ □] 1/3 (regen in 1 turn for second charge)             │
  │                │                                                         │
  │  Turn 7:    End turn                                                     │
  │             [■ ■ □] 2/3 (+1 regenerated)                                │
  │                                                                          │
  └─────────────────────────────────────────────────────────────────────────┘

  ■ = Available charge
  □ = Used charge (regenerating)
```

### 3.6 File Layer Diagram

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                            CONFIG LAYER                                      │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  config/                                                                     │
│  ├── abilities.json ◀──────────────────────────────┐                        │
│  │   {                                              │ references             │
│  │     "$schema": "abilities.schema.json",          │                        │
│  │     "abilities": [                               │                        │
│  │       {                                          │                        │
│  │         "id": "slash",                           │                        │
│  │         "comboChain": {...},    ◀── NEW         │                        │
│  │         "prerequisites": {...}, ◀── NEW         │                        │
│  │         "aoeParameters": {...}, ◀── NEW         │                        │
│  │         "charges": {...}        ◀── NEW         │                        │
│  │       }                                          │                        │
│  │     ]                                            │                        │
│  │   }                                              │                        │
│  │                                                  │                        │
│  └── abilities.schema.json ─────────────────────────┘                        │
│      {                                                                       │
│        "$schema": "http://json-schema.org/draft-07/schema#",                │
│        "definitions": {                                                      │
│          "ComboChain": {...},     ◀── NEW                                   │
│          "Prerequisites": {...},  ◀── NEW                                   │
│          "AoEParameters": {...},  ◀── NEW                                   │
│          "ChargeConfig": {...}    ◀── NEW                                   │
│        }                                                                     │
│      }                                                                       │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 4. Combo Chain System

### 4.1 Combo Chain Definition

The `ComboChain` definition enables abilities to chain together, with each ability in the chain potentially granting bonuses when used in sequence.

```json
"ComboChain": {
    "type": "object",
    "description": "Configuration for chaining this ability into another",
    "properties": {
        "nextAbilityId": {
            "type": "string",
            "description": "ID of the ability that can follow this one in the combo chain",
            "pattern": "^[a-z][a-z0-9-]*$"
        },
        "comboWindowTurns": {
            "type": "integer",
            "description": "Number of turns the player has to use the next ability",
            "minimum": 1,
            "default": 1
        },
        "comboBonusDamage": {
            "type": "number",
            "description": "Percentage bonus damage when combo continues (0.25 = +25%)",
            "minimum": 0,
            "maximum": 2.0,
            "default": 0
        }
    },
    "additionalProperties": false
}
```

### 4.2 Combo Window Mechanics

| Property | Description | Example |
|----------|-------------|---------|
| `nextAbilityId` | The next ability in the combo chain | `"double-slash"` |
| `comboWindowTurns` | Turns available to continue combo | `1` (must use next turn) |
| `comboBonusDamage` | Damage multiplier for combo continuation | `0.25` (+25% damage) |

**Combo Window Rules:**
- Window starts when the ability is successfully used
- If `comboWindowTurns` expires without using `nextAbilityId`, combo breaks
- Using any other ability breaks the combo
- Combo bonuses apply only when continuing the chain

### 4.3 Combo Bonus Damage

The `comboBonusDamage` field is a percentage multiplier applied to the **next** ability in the chain:

| Value | Meaning | Effect on 100 damage |
|-------|---------|---------------------|
| `0` | No bonus | 100 damage |
| `0.25` | +25% bonus | 125 damage |
| `0.5` | +50% bonus | 150 damage |
| `1.0` | +100% bonus | 200 damage |

**Example Combo Chain:**

```json
{
    "id": "slash",
    "name": "Slash",
    "comboChain": {
        "nextAbilityId": "double-slash",
        "comboWindowTurns": 1,
        "comboBonusDamage": 0.25
    }
},
{
    "id": "double-slash",
    "name": "Double Slash",
    "comboChain": {
        "nextAbilityId": "triple-slash",
        "comboWindowTurns": 1,
        "comboBonusDamage": 0.5
    }
},
{
    "id": "triple-slash",
    "name": "Triple Slash"
    // No comboChain - end of combo
}
```

---

## 5. Prerequisites System

### 5.1 Prerequisites Definition

The `Prerequisites` definition allows abilities to have unlock requirements beyond the basic `unlockLevel` field.

```json
"Prerequisites": {
    "type": "object",
    "description": "Requirements that must be met to unlock or use this ability",
    "properties": {
        "requiredLevel": {
            "type": "integer",
            "description": "Minimum character level required",
            "minimum": 1
        },
        "requiredClassIds": {
            "type": "array",
            "description": "List of class IDs that can use this ability (OR logic)",
            "items": {
                "type": "string",
                "pattern": "^[a-z][a-z0-9-]*$"
            },
            "minItems": 1
        },
        "requiredAbilityIds": {
            "type": "array",
            "description": "Abilities that must be learned first (AND logic)",
            "items": {
                "type": "string",
                "pattern": "^[a-z][a-z0-9-]*$"
            },
            "minItems": 1
        },
        "requiredArchetypeId": {
            "type": "string",
            "description": "Archetype that must match the character's class archetype",
            "pattern": "^[a-z][a-z0-9-]*$"
        }
    },
    "additionalProperties": false
}
```

### 5.2 Requirement Types

| Requirement | Logic | Description |
|-------------|-------|-------------|
| `requiredLevel` | Single value | Character level must be >= value |
| `requiredClassIds` | OR | Character class must be in list |
| `requiredAbilityIds` | AND | Character must have ALL listed abilities |
| `requiredArchetypeId` | Single value | Character's class archetype must match |

**Note on classIds vs prerequisites.requiredClassIds:**
- `classIds` (root level): Defines which classes have access to the ability
- `prerequisites.requiredClassIds`: Additional restriction within those classes

**Example Prerequisites:**

```json
{
    "id": "whirlwind",
    "name": "Whirlwind",
    "classIds": ["shieldmaiden", "berserker"],
    "unlockLevel": 1,
    "prerequisites": {
        "requiredLevel": 10,
        "requiredAbilityIds": ["slash", "cleave"],
        "requiredArchetypeId": "warrior"
    }
}
```

This ability:
- Available to shieldmaiden and berserker classes
- Requires character level 10 (beyond the base unlockLevel)
- Requires "slash" AND "cleave" abilities learned
- Requires warrior archetype

---

## 6. Area of Effect Parameters

### 6.1 AoE Shape Definitions

The `AoEParameters` definition specifies the shape and size of area-of-effect abilities.

```json
"AoEParameters": {
    "type": "object",
    "description": "Parameters for area-of-effect abilities",
    "properties": {
        "radius": {
            "type": "integer",
            "description": "Radius of the effect in grid tiles",
            "minimum": 1,
            "maximum": 10
        },
        "shape": {
            "type": "string",
            "description": "Shape of the area of effect",
            "enum": ["Circle", "Square", "Cone", "Line"]
        },
        "coneAngle": {
            "type": "integer",
            "description": "Angle of the cone in degrees (for Cone shape)",
            "minimum": 15,
            "maximum": 180
        },
        "lineLength": {
            "type": "integer",
            "description": "Length of the line in tiles (for Line shape)",
            "minimum": 1,
            "maximum": 20
        },
        "includeOrigin": {
            "type": "boolean",
            "description": "Whether the caster's tile is included in the effect",
            "default": false
        }
    },
    "required": ["shape"],
    "additionalProperties": false
}
```

**Shape Requirements:**

| Shape | Required Fields | Optional Fields |
|-------|-----------------|-----------------|
| `Circle` | shape, radius | includeOrigin |
| `Square` | shape, radius | includeOrigin |
| `Cone` | shape, radius, coneAngle | includeOrigin |
| `Line` | shape, lineLength | includeOrigin |

### 6.2 Target Type Expansion

The `targetType` enum is expanded to include `Cone` and `Line`:

**Current targetType values:**
- `Self` - Caster only
- `SingleEnemy` - One enemy target
- `SingleAlly` - One ally target
- `AllEnemies` - All enemies
- `AllAllies` - All allies
- `Area` - Grid area (requires aoeParameters)
- `None` - No target (passive/summon)

**New targetType values:**
- `Cone` - Cone from caster (requires aoeParameters with coneAngle)
- `Line` - Line from caster (requires aoeParameters with lineLength)

**Updated enum:**
```json
"targetType": {
    "type": "string",
    "enum": [
        "Self",
        "SingleEnemy",
        "SingleAlly",
        "AllEnemies",
        "AllAllies",
        "Area",
        "Cone",
        "Line",
        "None"
    ],
    "description": "Valid target type for this ability"
}
```

**Example AoE Abilities:**

```json
{
    "id": "fireball",
    "name": "Fireball",
    "targetType": "Area",
    "aoeParameters": {
        "shape": "Circle",
        "radius": 2,
        "includeOrigin": false
    }
},
{
    "id": "dragon-breath",
    "name": "Dragon Breath",
    "targetType": "Cone",
    "aoeParameters": {
        "shape": "Cone",
        "radius": 4,
        "coneAngle": 60,
        "includeOrigin": false
    }
},
{
    "id": "lightning-bolt",
    "name": "Lightning Bolt",
    "targetType": "Line",
    "aoeParameters": {
        "shape": "Line",
        "lineLength": 6,
        "includeOrigin": false
    }
}
```

---

## 7. Charge-Based Abilities

### 7.1 Charge Configuration

The `ChargeConfig` definition enables abilities with multiple charges before cooldown.

```json
"ChargeConfig": {
    "type": "object",
    "description": "Configuration for charge-based abilities",
    "properties": {
        "maxCharges": {
            "type": "integer",
            "description": "Maximum number of charges this ability can hold",
            "minimum": 1,
            "maximum": 10
        },
        "chargeRegenTurns": {
            "type": "integer",
            "description": "Number of turns to regenerate one charge",
            "minimum": 1
        },
        "startingCharges": {
            "type": "integer",
            "description": "Charges available at combat start (defaults to maxCharges)",
            "minimum": 0
        }
    },
    "required": ["maxCharges", "chargeRegenTurns"],
    "additionalProperties": false
}
```

### 7.2 Charge Regeneration

| Property | Description | Validation |
|----------|-------------|------------|
| `maxCharges` | Maximum charges held | 1-10 |
| `chargeRegenTurns` | Turns per charge regenerated | ≥1 |
| `startingCharges` | Initial charges in combat | 0 to maxCharges |

**Charge vs Cooldown:**
- Abilities with `charges` ignore the `cooldown` field
- Each charge regenerates independently
- When all charges are used, ability is unavailable until one regenerates

**Example Charge Ability:**

```json
{
    "id": "blink",
    "name": "Blink",
    "description": "Instantly teleport a short distance.",
    "targetType": "None",
    "cooldown": 0,
    "charges": {
        "maxCharges": 3,
        "chargeRegenTurns": 2,
        "startingCharges": 3
    }
}
```

---

## 8. Validation Rules

### 8.1 Conditional Validation

The schema uses conditional validation to ensure AoE parameters are appropriate for the target type.

**Validation Rules:**

| Condition | Requirement |
|-----------|-------------|
| `targetType: "Area"` | `aoeParameters` required with `shape: Circle` or `shape: Square` |
| `targetType: "Cone"` | `aoeParameters` required with `shape: Cone` and `coneAngle` |
| `targetType: "Line"` | `aoeParameters` required with `shape: Line` and `lineLength` |
| `shape: "Cone"` | `coneAngle` required (15-180) |
| `shape: "Line"` | `lineLength` required (1-20) |
| `charges.startingCharges` | Must be ≤ `charges.maxCharges` |

**Schema Conditional Example:**

```json
"allOf": [
    {
        "if": {
            "properties": { "targetType": { "const": "Cone" } }
        },
        "then": {
            "required": ["aoeParameters"],
            "properties": {
                "aoeParameters": {
                    "required": ["shape", "radius", "coneAngle"],
                    "properties": {
                        "shape": { "const": "Cone" }
                    }
                }
            }
        }
    },
    {
        "if": {
            "properties": { "targetType": { "const": "Line" } }
        },
        "then": {
            "required": ["aoeParameters"],
            "properties": {
                "aoeParameters": {
                    "required": ["shape", "lineLength"],
                    "properties": {
                        "shape": { "const": "Line" }
                    }
                }
            }
        }
    }
]
```

### 8.2 ID Reference Validation

All ID reference fields use kebab-case pattern validation:

| Field | Pattern | Valid Examples | Invalid Examples |
|-------|---------|----------------|------------------|
| `comboChain.nextAbilityId` | `^[a-z][a-z0-9-]*$` | `double-slash`, `fireball` | `DoubleSlash`, `fireball_2` |
| `prerequisites.requiredClassIds[]` | `^[a-z][a-z0-9-]*$` | `shieldmaiden` | `ShieldMaiden` |
| `prerequisites.requiredAbilityIds[]` | `^[a-z][a-z0-9-]*$` | `basic-attack` | `BasicAttack` |
| `prerequisites.requiredArchetypeId` | `^[a-z][a-z0-9-]*$` | `warrior` | `Warrior` |

### 8.3 Range Validation

| Field | Minimum | Maximum | Default |
|-------|---------|---------|---------|
| `comboChain.comboWindowTurns` | 1 | - | 1 |
| `comboChain.comboBonusDamage` | 0 | 2.0 | 0 |
| `prerequisites.requiredLevel` | 1 | - | - |
| `aoeParameters.radius` | 1 | 10 | - |
| `aoeParameters.coneAngle` | 15 | 180 | - |
| `aoeParameters.lineLength` | 1 | 20 | - |
| `charges.maxCharges` | 1 | 10 | - |
| `charges.chargeRegenTurns` | 1 | - | - |
| `charges.startingCharges` | 0 | maxCharges | maxCharges |

---

## 9. Configuration Schema

### Complete Expanded abilities.schema.json

**File:** `config/abilities.schema.json`

```json
{
    "$schema": "http://json-schema.org/draft-07/schema#",
    "title": "Abilities Configuration",
    "description": "Schema for ability definitions in Rune & Rust. Supports combo chains, prerequisites, AoE parameters, and charge-based abilities.",
    "type": "object",
    "required": ["abilities"],
    "properties": {
        "$schema": {
            "type": "string",
            "description": "Reference to the JSON schema file for validation"
        },
        "abilities": {
            "type": "array",
            "description": "List of ability definitions",
            "items": {
                "$ref": "#/definitions/Ability"
            },
            "minItems": 1
        }
    },
    "additionalProperties": false,
    "definitions": {
        "Ability": {
            "type": "object",
            "description": "A single ability definition",
            "required": ["id", "name", "description", "classIds", "targetType"],
            "properties": {
                "id": {
                    "type": "string",
                    "pattern": "^[a-z][a-z0-9-]*$",
                    "description": "Unique identifier for the ability (lowercase, kebab-case)",
                    "minLength": 1,
                    "maxLength": 50
                },
                "name": {
                    "type": "string",
                    "minLength": 1,
                    "maxLength": 100,
                    "description": "Display name shown to players"
                },
                "description": {
                    "type": "string",
                    "minLength": 1,
                    "maxLength": 500,
                    "description": "Full description of the ability"
                },
                "classIds": {
                    "type": "array",
                    "items": {
                        "type": "string",
                        "pattern": "^[a-z][a-z0-9-]*$"
                    },
                    "minItems": 1,
                    "description": "Classes that can use this ability"
                },
                "costResource": {
                    "type": "string",
                    "description": "Resource type for the cost (e.g., mana, rage, energy, focus, faith)"
                },
                "costAmount": {
                    "type": "integer",
                    "minimum": 0,
                    "default": 0,
                    "description": "Amount of resource required"
                },
                "cooldown": {
                    "type": "integer",
                    "minimum": 0,
                    "default": 0,
                    "description": "Turns between uses (0 = no cooldown). Ignored if charges is defined."
                },
                "targetType": {
                    "type": "string",
                    "enum": [
                        "Self",
                        "SingleEnemy",
                        "SingleAlly",
                        "AllEnemies",
                        "AllAllies",
                        "Area",
                        "Cone",
                        "Line",
                        "None"
                    ],
                    "description": "Valid target type for this ability"
                },
                "unlockLevel": {
                    "type": "integer",
                    "minimum": 1,
                    "default": 1,
                    "description": "Level required to unlock this ability"
                },
                "tags": {
                    "type": "array",
                    "items": {
                        "type": "string",
                        "minLength": 1
                    },
                    "uniqueItems": true,
                    "description": "Tags for categorization and filtering"
                },
                "effects": {
                    "type": "array",
                    "items": {
                        "$ref": "#/definitions/Effect"
                    },
                    "description": "Effects applied when the ability is used"
                },
                "comboChain": {
                    "$ref": "#/definitions/ComboChain",
                    "description": "Configuration for chaining this ability into another"
                },
                "prerequisites": {
                    "$ref": "#/definitions/Prerequisites",
                    "description": "Requirements that must be met to unlock or use this ability"
                },
                "aoeParameters": {
                    "$ref": "#/definitions/AoEParameters",
                    "description": "Parameters for area-of-effect abilities"
                },
                "charges": {
                    "$ref": "#/definitions/ChargeConfig",
                    "description": "Configuration for charge-based abilities"
                }
            },
            "additionalProperties": false,
            "allOf": [
                {
                    "if": {
                        "properties": { "targetType": { "const": "Area" } }
                    },
                    "then": {
                        "required": ["aoeParameters"]
                    }
                },
                {
                    "if": {
                        "properties": { "targetType": { "const": "Cone" } }
                    },
                    "then": {
                        "required": ["aoeParameters"],
                        "properties": {
                            "aoeParameters": {
                                "properties": {
                                    "shape": { "const": "Cone" }
                                },
                                "required": ["coneAngle"]
                            }
                        }
                    }
                },
                {
                    "if": {
                        "properties": { "targetType": { "const": "Line" } }
                    },
                    "then": {
                        "required": ["aoeParameters"],
                        "properties": {
                            "aoeParameters": {
                                "properties": {
                                    "shape": { "const": "Line" }
                                },
                                "required": ["lineLength"]
                            }
                        }
                    }
                }
            ]
        },
        "Effect": {
            "type": "object",
            "description": "An effect applied by an ability",
            "required": ["type"],
            "properties": {
                "type": {
                    "type": "string",
                    "enum": [
                        "Damage",
                        "Heal",
                        "Buff",
                        "Debuff",
                        "DamageOverTime",
                        "HealOverTime",
                        "Shield",
                        "ResourceGain",
                        "CooldownReset",
                        "Taunt",
                        "Stun",
                        "Summon",
                        "Teleport"
                    ],
                    "description": "The type of effect"
                },
                "value": {
                    "type": "integer",
                    "default": 0,
                    "description": "Base value for the effect (damage, heal amount, etc.)"
                },
                "duration": {
                    "type": "integer",
                    "minimum": 0,
                    "default": 0,
                    "description": "Duration in turns (0 = instant)"
                },
                "statusEffect": {
                    "type": "string",
                    "description": "Status effect to apply (e.g., poison, stun, slow)"
                },
                "chance": {
                    "type": "number",
                    "minimum": 0,
                    "maximum": 1,
                    "default": 1.0,
                    "description": "Success chance (0.0 to 1.0)"
                },
                "scalingStat": {
                    "type": "string",
                    "enum": ["attack", "defense", "might", "fortitude", "will", "wits", "finesse"],
                    "description": "Stat that scales the effect value"
                },
                "scalingMultiplier": {
                    "type": "number",
                    "default": 0,
                    "description": "Multiplier for stat scaling"
                },
                "description": {
                    "type": "string",
                    "description": "Override description for the effect"
                }
            },
            "additionalProperties": false
        },
        "ComboChain": {
            "type": "object",
            "description": "Configuration for chaining this ability into another",
            "properties": {
                "nextAbilityId": {
                    "type": "string",
                    "description": "ID of the ability that can follow this one in the combo chain",
                    "pattern": "^[a-z][a-z0-9-]*$"
                },
                "comboWindowTurns": {
                    "type": "integer",
                    "description": "Number of turns the player has to use the next ability",
                    "minimum": 1,
                    "default": 1
                },
                "comboBonusDamage": {
                    "type": "number",
                    "description": "Percentage bonus damage when combo continues (0.25 = +25%)",
                    "minimum": 0,
                    "maximum": 2.0,
                    "default": 0
                }
            },
            "additionalProperties": false
        },
        "Prerequisites": {
            "type": "object",
            "description": "Requirements that must be met to unlock or use this ability",
            "properties": {
                "requiredLevel": {
                    "type": "integer",
                    "description": "Minimum character level required",
                    "minimum": 1
                },
                "requiredClassIds": {
                    "type": "array",
                    "description": "List of class IDs that can use this ability (OR logic)",
                    "items": {
                        "type": "string",
                        "pattern": "^[a-z][a-z0-9-]*$"
                    },
                    "minItems": 1
                },
                "requiredAbilityIds": {
                    "type": "array",
                    "description": "Abilities that must be learned first (AND logic)",
                    "items": {
                        "type": "string",
                        "pattern": "^[a-z][a-z0-9-]*$"
                    },
                    "minItems": 1
                },
                "requiredArchetypeId": {
                    "type": "string",
                    "description": "Archetype that must match the character's class archetype",
                    "pattern": "^[a-z][a-z0-9-]*$"
                }
            },
            "additionalProperties": false
        },
        "AoEParameters": {
            "type": "object",
            "description": "Parameters for area-of-effect abilities",
            "properties": {
                "radius": {
                    "type": "integer",
                    "description": "Radius of the effect in grid tiles",
                    "minimum": 1,
                    "maximum": 10
                },
                "shape": {
                    "type": "string",
                    "description": "Shape of the area of effect",
                    "enum": ["Circle", "Square", "Cone", "Line"]
                },
                "coneAngle": {
                    "type": "integer",
                    "description": "Angle of the cone in degrees (for Cone shape)",
                    "minimum": 15,
                    "maximum": 180
                },
                "lineLength": {
                    "type": "integer",
                    "description": "Length of the line in tiles (for Line shape)",
                    "minimum": 1,
                    "maximum": 20
                },
                "includeOrigin": {
                    "type": "boolean",
                    "description": "Whether the caster's tile is included in the effect",
                    "default": false
                }
            },
            "required": ["shape"],
            "additionalProperties": false
        },
        "ChargeConfig": {
            "type": "object",
            "description": "Configuration for charge-based abilities",
            "properties": {
                "maxCharges": {
                    "type": "integer",
                    "description": "Maximum number of charges this ability can hold",
                    "minimum": 1,
                    "maximum": 10
                },
                "chargeRegenTurns": {
                    "type": "integer",
                    "description": "Number of turns to regenerate one charge",
                    "minimum": 1
                },
                "startingCharges": {
                    "type": "integer",
                    "description": "Charges available at combat start (defaults to maxCharges)",
                    "minimum": 0
                }
            },
            "required": ["maxCharges", "chargeRegenTurns"],
            "additionalProperties": false
        }
    }
}
```

---

## 10. Configuration File Updates

### Existing abilities.json Compatibility

The existing `abilities.json` requires **no changes** and will validate successfully against the expanded schema. All new fields are optional.

**Current $schema reference:**
```json
{
    "$schema": "abilities.schema.json",
    "abilities": [...]
}
```

**Validation Confirmation:**

All 15 existing abilities validate successfully:
- Shield Bash, Taunt, Fortify (Shieldmaiden)
- Backstab, Shadowstep, Poison Blade (Shadow-Walker)
- Flame Bolt, Frost Nova, Arcane Shield (Galdr-Caster)
- Healing Word, Smite, Sanctuary (Blood-Priest)
- Deploy Turret, Repair Kit, Smoke Bomb (Scrap-Tinker)

### Example Enhanced Abilities (Reference Only)

These examples demonstrate the new schema capabilities but are **not** added to abilities.json in this version:

```json
{
    "id": "slash",
    "name": "Slash",
    "description": "A basic sword slash that can chain into more powerful attacks.",
    "classIds": ["shieldmaiden"],
    "costResource": "rage",
    "costAmount": 10,
    "cooldown": 0,
    "targetType": "SingleEnemy",
    "unlockLevel": 1,
    "tags": ["damage", "melee", "combo-starter"],
    "effects": [
        {
            "type": "Damage",
            "value": 12,
            "scalingStat": "attack",
            "scalingMultiplier": 0.4
        }
    ],
    "comboChain": {
        "nextAbilityId": "double-slash",
        "comboWindowTurns": 1,
        "comboBonusDamage": 0.25
    }
}
```

```json
{
    "id": "blink",
    "name": "Blink",
    "description": "Instantly teleport a short distance. Has 3 charges.",
    "classIds": ["galdr-caster"],
    "costResource": "mana",
    "costAmount": 15,
    "targetType": "None",
    "unlockLevel": 5,
    "tags": ["utility", "movement", "teleport"],
    "effects": [
        {
            "type": "Teleport",
            "value": 3
        }
    ],
    "charges": {
        "maxCharges": 3,
        "chargeRegenTurns": 2,
        "startingCharges": 3
    }
}
```

---

## 11. Data Model Changes

### No Domain Changes Required

This phase creates only JSON Schema expansions for validation. No changes to domain entities, services, or application layer are required.

| Layer | Changes |
|-------|---------|
| Domain | None |
| Application | None |
| Infrastructure | None |
| Configuration | One schema file modified |

### Schema as Documentation

The expanded schema serves as:
- **Validation contract** for ability configurations
- **IDE documentation** via description fields
- **Modding reference** for creating combo chains, prerequisites, AoE abilities, and charge abilities
- **Forward compatibility** for future ability system enhancements

---

## 12. Logging Specifications

### No Runtime Logging Required

Schema validation occurs at design-time in IDE/editors, not at runtime. No logging infrastructure changes are needed for this phase.

| Component | Level | Events |
|-----------|-------|--------|
| N/A | N/A | Schema validation is IDE-based |

---

## 13. Unit Testing Requirements

### Test Count by Feature

| Feature | Test Count |
|---------|------------|
| Schema Valid Structure | ~1 |
| Existing Abilities Validation | ~1 |
| Combo Chain Validation | ~1 |
| Prerequisites Validation | ~1 |
| AoE Parameters Conditional Validation | ~1 |
| Charge Config Validation | ~1 |
| **Total** | **~6** |

### Test Descriptions

#### AbilitySchemaExpansionTests.cs

```csharp
[TestFixture]
public class AbilitySchemaExpansionTests
{
    /// <summary>
    /// Verifies the expanded schema file is valid JSON Schema Draft-07.
    /// </summary>
    [Test]
    public void Schema_IsValidJsonSchemaDraft07();

    /// <summary>
    /// Verifies the existing abilities.json validates against the expanded schema without errors.
    /// </summary>
    [Test]
    public void ExistingAbilitiesJson_ValidatesAgainstExpandedSchema();

    /// <summary>
    /// Verifies combo chain configuration validates correctly.
    /// </summary>
    [Test]
    public void ComboChain_ValidConfiguration_PassesValidation();

    /// <summary>
    /// Verifies prerequisites configuration validates correctly.
    /// </summary>
    [Test]
    public void Prerequisites_ValidConfiguration_PassesValidation();

    /// <summary>
    /// Verifies aoeParameters is required when targetType is Area, Cone, or Line.
    /// </summary>
    [Test]
    public void AoEParameters_RequiredForSpatialTargetTypes_FailsWithoutParameters();

    /// <summary>
    /// Verifies charge configuration validates correctly with startingCharges <= maxCharges.
    /// </summary>
    [Test]
    public void ChargeConfig_ValidConfiguration_PassesValidation();
}
```

### Test Implementation Notes

Tests should use a JSON Schema validation library (e.g., `NJsonSchema` for C#) to:
1. Load the expanded schema file
2. Validate test JSON documents
3. Assert expected validation results

---

## 14. Use Cases

### UC-001: Load Abilities Configuration

**Actor:** Game System
**Flow:** System starts → Loads `abilities.json` → Schema validates content → Abilities available for combat

### UC-002: Edit Ability in IDE

**Actor:** Developer/Modder
**Flow:** Opens `abilities.json` in VS Code → IDE loads expanded schema → Autocomplete suggests new properties (comboChain, prerequisites, etc.) → Validation errors shown inline

### UC-003: Create Combo Chain Ability

**Actor:** Modder
**Flow:** Adds new ability with comboChain field → IDE validates nextAbilityId format → Modder creates linked abilities forming a combo chain

### UC-004: Add Prerequisites to Ability

**Actor:** Modder
**Flow:** Adds prerequisites object to existing ability → IDE validates level range, ID patterns → Character must meet requirements to unlock ability

### UC-005: Create Cone Attack

**Actor:** Modder
**Flow:** Sets targetType to "Cone" → IDE requires aoeParameters → Modder adds shape, radius, coneAngle → Ability creates cone-shaped effect

### UC-006: Create Charge-Based Ability

**Actor:** Modder
**Flow:** Adds charges object to ability → IDE validates maxCharges and chargeRegenTurns → Ability has multiple uses before regeneration period

---

## 15. Deliverable Checklist

### Schema Expansion
- [ ] `abilities.schema.json` expanded with new definitions
- [ ] Schema follows JSON Schema Draft-07 format
- [ ] All new definitions included (ComboChain, Prerequisites, AoEParameters, ChargeConfig)
- [ ] Target type enum expanded with Cone, Line
- [ ] Conditional validation for AoE target types

### New Definitions
- [ ] `ComboChain` definition with nextAbilityId, comboWindowTurns, comboBonusDamage
- [ ] `Prerequisites` definition with requiredLevel, requiredClassIds, requiredAbilityIds, requiredArchetypeId
- [ ] `AoEParameters` definition with radius, shape, coneAngle, lineLength, includeOrigin
- [ ] `ChargeConfig` definition with maxCharges, chargeRegenTurns, startingCharges

### Validation Rules
- [ ] ID pattern validation: `^[a-z][a-z0-9-]*$`
- [ ] Combo window minimum: 1
- [ ] Combo bonus damage range: 0 to 2.0
- [ ] AoE radius range: 1 to 10
- [ ] Cone angle range: 15 to 180
- [ ] Line length range: 1 to 20
- [ ] Max charges range: 1 to 10
- [ ] Required fields enforced
- [ ] Optional fields have defaults

### Backwards Compatibility
- [ ] Existing `abilities.json` validates without errors
- [ ] All new properties are optional
- [ ] No breaking changes to existing ability structure

### Testing
- [ ] ~6 unit tests implemented
- [ ] All tests passing
- [ ] Tests cover happy path and error cases

### Documentation
- [ ] Schema properties have descriptions
- [ ] This design specification complete

---

## 16. Acceptance Criteria

### Functional
- [ ] `abilities.schema.json` expanded in `config/` directory
- [ ] Existing `abilities.json` validates against expanded schema without errors
- [ ] Combo chain fields validated (nextAbilityId format, window minimum 1)
- [ ] Prerequisites support level, class, ability, and archetype requirements
- [ ] AoE parameters required when targetType is Area, Cone, or Line
- [ ] Cone abilities require coneAngle (15-180)
- [ ] Line abilities require lineLength (1-20)
- [ ] Charge configuration validates maxCharges and chargeRegenTurns
- [ ] startingCharges must be ≤ maxCharges (when specified)
- [ ] VS Code provides autocomplete for new fields

### Quality
- [ ] Build succeeds with 0 errors
- [ ] Build succeeds with 0 warnings
- [ ] ~6 unit tests pass
- [ ] Schema file is valid JSON
- [ ] All schema properties have descriptions

---

## 17. Dependencies

### Required from Prior Versions

| Type | Location | Usage in this phase |
|------|----------|---------------------|
| `abilities.json` | `config/abilities.json` | Validated by expanded schema |
| `abilities.schema.json` | `config/abilities.schema.json` | Base schema to expand |
| Archetype IDs | `config/archetypes.json` | Referenced in prerequisites.requiredArchetypeId |
| Class IDs | `config/classes.json` | Referenced in prerequisites.requiredClassIds |

### Provides to Future Versions

| Type | Usage |
|------|-------|
| Expanded ability schema | Foundation for runtime combo/charge systems |
| Prerequisites pattern | Reusable for other unlock requirements |
| AoE parameter pattern | Reusable for other spatial mechanics |

### Implementation Order Note

**v0.14.1a has no internal dependencies on other v0.14.1 parts.** It can be implemented in parallel with v0.14.1b, v0.14.1c, and v0.14.1d.

---

## 18. Future Considerations

### Deferred to Future Versions

- **Combo damage type override**: Allowing combos to change damage types
- **Conditional combos**: Combos that branch based on conditions
- **AoE friendly fire**: Configuration for whether AoE affects allies
- **Charge sharing**: Multiple abilities sharing a charge pool
- **Cross-reference validation**: Verifying nextAbilityId exists in abilities.json

### Out of Scope

- **Runtime combo tracking**: Domain/application layer implementation
- **Runtime charge regeneration**: Combat system implementation
- **AoE tile calculation**: Grid service implementation
- **Prerequisite enforcement**: Character service implementation
- **Status effect schema**: v0.14.1b
- **Damage type schema**: v0.14.1c
- **Combat rules schema**: v0.14.1d

### Potential Future Enhancements

If the ability system expands, consider adding:
- `comboChain.requiredStatus` - Status effect required to continue combo
- `aoeParameters.piercing` - Whether the effect passes through obstacles
- `charges.regenOnKill` - Regenerate charge on enemy kill
- `prerequisites.requiredItemId` - Item required to use ability

---

*Document Version: 1.0*
*Last Updated: 2026-01-17*
*Author: Claude*
