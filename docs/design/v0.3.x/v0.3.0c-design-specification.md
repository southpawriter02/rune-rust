# v0.3.0c Design Specification: Progress Tracking & Integration

## Overview

**Version:** 0.3.0c
**Parent:** v0.3.0 (Quest Foundation)
**Prerequisites:** v0.3.0b Complete (Quest Journal & Commands)
**Status:** Design Complete
**Estimated Unit Tests:** ~25

---

## Table of Contents

1. [Executive Summary](#1-executive-summary)
2. [Feature Overview](#2-feature-overview)
3. [Architecture Diagrams](#3-architecture-diagrams)
4. [User Stories](#4-user-stories)
5. [Data Models](#5-data-models)
6. [Service Specifications](#6-service-specifications)
7. [Event Integration Specifications](#7-event-integration-specifications)
8. [Dialogue Integration Specifications](#8-dialogue-integration-specifications)
9. [Rendering Specifications](#9-rendering-specifications)
10. [User-Facing Changes](#10-user-facing-changes)
11. [Logging Requirements](#11-logging-requirements)
12. [Unit Test Specifications](#12-unit-test-specifications)
13. [Use Cases](#13-use-cases)
14. [Acceptance Criteria](#14-acceptance-criteria)
15. [Deliverable Checklist](#15-deliverable-checklist)
16. [Dependencies](#16-dependencies)
17. [Future Considerations](#17-future-considerations)

---

## 1. Executive Summary

This phase implements the event-driven progress tracking system that automatically updates quest objectives when players defeat monsters, collect items, explore rooms, or talk to NPCs. It also integrates quest acceptance with the existing dialogue system through the `StartQuest` dialogue outcome type. Players receive real-time notifications as they make progress toward quest objectives.

### Key Deliverables

| Category | Items |
|----------|-------|
| **Services** | QuestProgressService (IQuestProgressService) |
| **Value Objects** | QuestProgressResult, ObjectiveProgressUpdate |
| **Event Handlers** | Kill, Collect, Explore, Talk objective tracking |
| **Dialogue Updates** | StartQuest outcome type, TurnInQuest outcome |
| **Notifications** | Progress updates, Objective completion, Quest completion |
| **Tests** | ~25 new unit tests |

### Architectural Significance

This version establishes the **event-driven quest progress pattern** that connects game systems to quest tracking:
- QuestProgressService as the central event processor for all quest updates
- Automatic objective progress from game events (combat, inventory, movement, dialogue)
- Integration with dialogue system for quest acceptance and turn-in
- Real-time player notifications for quest progress

---

## 2. Feature Overview

```
v0.3.0c Features
├── QuestProgressService
│   ├── ProcessMonsterDefeated(playerId, monsterId, monsterType)
│   ├── ProcessItemCollected(playerId, itemId)
│   ├── ProcessRoomEntered(playerId, roomId)
│   ├── ProcessNpcTalked(playerId, npcId)
│   ├── ProcessItemDelivered(playerId, npcId, itemId)
│   └── UpdateObjective(playerId, questId, objectiveId, progress)
├── Progress Tracking
│   ├── Kill objective tracking (monster defeats)
│   ├── Collect objective tracking (item pickups)
│   ├── Explore objective tracking (room entries)
│   ├── Talk objective tracking (dialogue completion)
│   └── Deliver objective tracking (item delivery)
├── Dialogue Integration
│   ├── StartQuest dialogue outcome
│   ├── TurnInQuest dialogue outcome
│   └── Quest-conditional dialogue options
├── Progress Notifications
│   ├── Objective progress updates
│   ├── Objective completion alerts
│   ├── Quest ready-to-turn-in alerts
│   └── Quest completion notifications
└── Event Integration
    ├── CombatService integration
    ├── InventoryService integration
    ├── MovementService integration
    └── DialogueService integration
```

---

## 3. Architecture Diagrams

### 3.1 Layer Diagram

```
┌─────────────────────────────────────────────────────────────────────────┐
│                         PRESENTATION LAYER                              │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  NOTIFICATIONS                                                          │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │                  Quest Progress Notifications                    │   │
│  ├─────────────────────────────────────────────────────────────────┤   │
│  │  [QUEST] The Goblin Menace: Defeat goblins (4/5)                │   │
│  │  [QUEST] The Goblin Menace: Defeat goblins (5/5) - COMPLETE!    │   │
│  │  [QUEST] The Goblin Menace is ready to turn in!                 │   │
│  │  [QUEST COMPLETE] The Goblin Menace!                            │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
│  DIALOGUE UPDATES                                                       │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │  [1] Tell me about the goblin problem.                          │   │
│  │  [2] I'll handle it. [Accept Quest: The Goblin Menace]          │   │
│  │  [3] Not interested right now.                                  │   │
│  │  ─────────────────────────────────────────────────────────────  │   │
│  │  [1] [Turn In Quest: The Goblin Menace]                         │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                         APPLICATION LAYER                               │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │                   IQuestProgressService                          │   │
│  ├─────────────────────────────────────────────────────────────────┤   │
│  │ + ProcessMonsterDefeated(playerId, monsterId, type)             │   │
│  │     : QuestProgressResult                                        │   │
│  │ + ProcessItemCollected(playerId, itemId) : QuestProgressResult  │   │
│  │ + ProcessRoomEntered(playerId, roomId) : QuestProgressResult    │   │
│  │ + ProcessNpcTalked(playerId, npcId) : QuestProgressResult       │   │
│  │ + ProcessItemDelivered(playerId, npcId, itemId)                 │   │
│  │     : QuestProgressResult                                        │   │
│  │ + UpdateObjective(playerId, questId, objectiveId, progress)     │   │
│  │     : QuestProgressResult                                        │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
│  VALUE OBJECTS                                                          │
│  ┌──────────────────────────┐  ┌──────────────────────────┐            │
│  │   QuestProgressResult    │  │ ObjectiveProgressUpdate  │            │
│  ├──────────────────────────┤  ├──────────────────────────┤            │
│  │ + HasProgress: bool      │  │ + Quest: Quest           │            │
│  │ + UpdatedObjectives      │  │ + Objective: Objective   │            │
│  │ + CompletableQuests      │  │ + PreviousCount: int     │            │
│  │ + CompletedQuests        │  │ + NewCount: int          │            │
│  └──────────────────────────┘  │ + JustCompleted: bool    │            │
│                                └──────────────────────────┘            │
│                                                                         │
│  EXISTING SERVICES (updated)                                            │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │ IQuestService (from v0.3.0b)                                     │   │
│  │ + CreateQuest, AcceptQuest, CompleteQuest, etc.                 │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
│  DIALOGUE UPDATES                                                       │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │ DialogueOutcome (updated)                                        │   │
│  ├─────────────────────────────────────────────────────────────────┤   │
│  │ + OutcomeType.StartQuest // NEW                                  │   │
│  │ + OutcomeType.TurnInQuest // NEW                                 │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                           DOMAIN LAYER                                  │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  FROM v0.3.0a/b:                                                        │
│  ┌────────────────────────┐  ┌────────────────────────┐                │
│  │         Quest          │  │    QuestObjective      │                │
│  │         Player         │  │    QuestDefinition     │                │
│  │       QuestStatus      │  │    ObjectiveType       │                │
│  │     ObjectiveTarget    │  │    IQuestService       │                │
│  └────────────────────────┘  └────────────────────────┘                │
│                                                                         │
│  UPDATED:                                                               │
│  ┌────────────────────────┐                                            │
│  │      OutcomeType       │                                            │
│  ├────────────────────────┤                                            │
│  │ + StartQuest  // NEW   │                                            │
│  │ + TurnInQuest // NEW   │                                            │
│  └────────────────────────┘                                            │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

### 3.2 Event Integration Flow

```
┌─────────────────────────────────────────────────────────────────────────┐
│                     EVENT-DRIVEN PROGRESS TRACKING                      │
└─────────────────────────────────────────────────────────────────────────┘

    Game Event                    Quest Progress Service                Player
        │                                   │                              │
        │                                   │                              │
    ┌───┴───────────────────────────────────┴──────────────────────────────┤
    │                                                                       │
    │   KILL OBJECTIVE FLOW                                                │
    │   ═══════════════════                                                │
    │                                                                       │
    │   Monster Defeated                                                    │
    │        │                                                              │
    │        ▼                                                              │
    │   CombatService.OnMonsterDefeated()                                   │
    │        │                                                              │
    │        ▼                                                              │
    │   QuestProgressService.ProcessMonsterDefeated(                        │
    │       playerId, monsterId, monsterType)                               │
    │        │                                                              │
    │        ├──► Find active Kill objectives matching target               │
    │        │                                                              │
    │        ├──► IncrementProgress() on matching objectives                │
    │        │                                                              │
    │        ├──► Check if objectives just completed                        │
    │        │                                                              │
    │        ├──► Check if quests now completable                          │
    │        │                                                              │
    │        ▼                                                              │
    │   Return QuestProgressResult                                          │
    │        │                                                              │
    │        ▼                                                              │
    │   Render Progress Notifications ─────────────────────────────► Player │
    │                                                                       │
    └───────────────────────────────────────────────────────────────────────┘

    ┌───────────────────────────────────────────────────────────────────────┐
    │                                                                       │
    │   COLLECT OBJECTIVE FLOW                                              │
    │   ══════════════════════                                              │
    │                                                                       │
    │   Item Picked Up                                                      │
    │        │                                                              │
    │        ▼                                                              │
    │   InventoryService.AddItem()                                          │
    │        │                                                              │
    │        ▼                                                              │
    │   QuestProgressService.ProcessItemCollected(playerId, itemId)         │
    │        │                                                              │
    │        ├──► Find active Collect objectives matching item              │
    │        │                                                              │
    │        ├──► IncrementProgress() on matching objectives                │
    │        │                                                              │
    │        ▼                                                              │
    │   Return QuestProgressResult ────────────────────────────────► Player │
    │                                                                       │
    └───────────────────────────────────────────────────────────────────────┘

    ┌───────────────────────────────────────────────────────────────────────┐
    │                                                                       │
    │   EXPLORE OBJECTIVE FLOW                                              │
    │   ══════════════════════                                              │
    │                                                                       │
    │   Room Entered                                                        │
    │        │                                                              │
    │        ▼                                                              │
    │   MovementService.MoveToRoom()                                        │
    │        │                                                              │
    │        ▼                                                              │
    │   QuestProgressService.ProcessRoomEntered(playerId, roomId)           │
    │        │                                                              │
    │        ├──► Find active Explore objectives matching room              │
    │        │                                                              │
    │        ├──► IncrementProgress() on matching objectives                │
    │        │                                                              │
    │        ▼                                                              │
    │   Return QuestProgressResult ────────────────────────────────► Player │
    │                                                                       │
    └───────────────────────────────────────────────────────────────────────┘

    ┌───────────────────────────────────────────────────────────────────────┐
    │                                                                       │
    │   TALK OBJECTIVE FLOW                                                 │
    │   ═══════════════════                                                 │
    │                                                                       │
    │   Dialogue Completed                                                  │
    │        │                                                              │
    │        ▼                                                              │
    │   DialogueService.CompleteDialogue()                                  │
    │        │                                                              │
    │        ▼                                                              │
    │   QuestProgressService.ProcessNpcTalked(playerId, npcId)              │
    │        │                                                              │
    │        ├──► Find active Talk objectives matching NPC                  │
    │        │                                                              │
    │        ├──► IncrementProgress() on matching objectives                │
    │        │                                                              │
    │        ▼                                                              │
    │   Return QuestProgressResult ────────────────────────────────► Player │
    │                                                                       │
    └───────────────────────────────────────────────────────────────────────┘
```

### 3.3 Dialogue Quest Integration Flow

```
┌─────────────────────────────────────────────────────────────────────────┐
│                    DIALOGUE QUEST INTEGRATION                           │
└─────────────────────────────────────────────────────────────────────────┘

    Player                     DialogueService                 QuestService
       │                             │                              │
       │    talk guard               │                              │
       ├────────────────────────────►│                              │
       │                             │                              │
       │                    Load DialogueNode                       │
       │                             │                              │
       │    Display Options          │                              │
       │◄────────────────────────────┤                              │
       │                             │                              │
       │    [2] Accept Quest         │                              │
       ├────────────────────────────►│                              │
       │                             │                              │
       │                    Check Outcome Type                      │
       │                    = StartQuest                            │
       │                             │                              │
       │                             │  CreateQuest(defId)          │
       │                             ├─────────────────────────────►│
       │                             │                              │
       │                             │  Quest created               │
       │                             │◄─────────────────────────────┤
       │                             │                              │
       │                             │  AcceptQuest(quest)          │
       │                             ├─────────────────────────────►│
       │                             │                              │
       │                             │  Quest accepted              │
       │                             │◄─────────────────────────────┤
       │                             │                              │
       │    "Quest Accepted"         │                              │
       │◄────────────────────────────┤                              │
       │                             │                              │
       │    === NEW QUEST ===        │                              │
       │    The Goblin Menace        │                              │
       │    Defeat goblins (0/5)     │                              │
       │◄────────────────────────────┤                              │
       │                             │                              │

   ─────────────────────────────────────────────────────────────────────
                        QUEST TURN-IN FLOW
   ─────────────────────────────────────────────────────────────────────

       │    talk guard               │                              │
       ├────────────────────────────►│                              │
       │                             │                              │
       │                    Check completable quests                │
       │                    for this NPC                            │
       │                             │  GetCompletableQuests()      │
       │                             ├─────────────────────────────►│
       │                             │◄─────────────────────────────┤
       │                             │                              │
       │    Display Options          │                              │
       │    [1] Turn In Quest        │                              │
       │◄────────────────────────────┤                              │
       │                             │                              │
       │    [1] Turn in              │                              │
       ├────────────────────────────►│                              │
       │                             │                              │
       │                    Check Outcome Type                      │
       │                    = TurnInQuest                           │
       │                             │                              │
       │                             │  CompleteQuest(questId)      │
       │                             ├─────────────────────────────►│
       │                             │                              │
       │                             │  Quest completed             │
       │                             │◄─────────────────────────────┤
       │                             │                              │
       │    "Quest Completed!"       │                              │
       │◄────────────────────────────┤                              │
       │                             │                              │
```

---

## 4. User Stories

### US-3.0c-1: Automatic Kill Objective Progress
**As a** player
**I want to** see quest progress update when I defeat monsters
**So that** I don't have to manually track my kills

**Acceptance Criteria:**
- Defeating a monster matching a Kill objective increments progress
- Notification shows current progress (e.g., "Defeat goblins (4/5)")
- Completing the objective shows completion notification
- Works for both specific targets and "any of type" targets

### US-3.0c-2: Automatic Collect Objective Progress
**As a** player
**I want to** see quest progress update when I pick up items
**So that** I know when I have the required quest items

**Acceptance Criteria:**
- Picking up an item matching a Collect objective increments progress
- Notification shows updated progress
- Works for specific item IDs

### US-3.0c-3: Automatic Explore Objective Progress
**As a** player
**I want to** see quest progress update when I enter rooms
**So that** exploration quests track automatically

**Acceptance Criteria:**
- Entering a room matching an Explore objective marks it complete
- Notification shows the objective as complete
- Works for specific room IDs

### US-3.0c-4: Automatic Talk Objective Progress
**As a** player
**I want to** see quest progress update when I talk to NPCs
**So that** dialogue-based objectives track automatically

**Acceptance Criteria:**
- Completing dialogue with an NPC matching a Talk objective increments progress
- Notification shows updated progress

### US-3.0c-5: Quest Acceptance via Dialogue
**As a** player
**I want to** accept quests through NPC dialogue
**So that** quest acceptance feels natural and immersive

**Acceptance Criteria:**
- Dialogue options can offer quests
- Selecting "Accept Quest" option creates and accepts the quest
- New quest notification is displayed
- Quest appears in journal immediately

### US-3.0c-6: Quest Turn-In via Dialogue
**As a** player
**I want to** turn in completed quests through NPC dialogue
**So that** quest completion feels natural and immersive

**Acceptance Criteria:**
- NPCs with completable quests show turn-in dialogue option
- Selecting turn-in completes the quest
- Quest completion notification is displayed
- Quest moves to completed list

### US-3.0c-7: Quest Ready Notification
**As a** player
**I want to** be notified when a quest is ready to turn in
**So that** I know to return to the quest giver

**Acceptance Criteria:**
- When all objectives are complete, notification shows quest is ready
- Notification includes NPC name to return to

---

## 5. Data Models

### 5.1 QuestProgressResult Value Object

```csharp
namespace RuneAndRust.Application.ValueObjects;

/// <summary>
/// Result of processing a quest progress event.
/// </summary>
/// <remarks>
/// Contains all information about what changed as a result of a game event,
/// allowing the presentation layer to display appropriate notifications.
/// </remarks>
public readonly record struct QuestProgressResult
{
    /// <summary>
    /// Gets whether any progress was made.
    /// </summary>
    public bool HasProgress { get; init; }

    /// <summary>
    /// Gets the objectives that were updated.
    /// </summary>
    public IReadOnlyList<ObjectiveProgressUpdate> UpdatedObjectives { get; init; }

    /// <summary>
    /// Gets the quests that are now completable (ready to turn in).
    /// </summary>
    public IReadOnlyList<Quest> CompletableQuests { get; init; }

    /// <summary>
    /// Gets the quests that were auto-completed (if any).
    /// </summary>
    /// <remarks>
    /// Some quests may auto-complete when all objectives are done
    /// if they don't require turn-in.
    /// </remarks>
    public IReadOnlyList<Quest> CompletedQuests { get; init; }

    /// <summary>
    /// Creates an empty result with no progress.
    /// </summary>
    public static QuestProgressResult None => new()
    {
        HasProgress = false,
        UpdatedObjectives = Array.Empty<ObjectiveProgressUpdate>(),
        CompletableQuests = Array.Empty<Quest>(),
        CompletedQuests = Array.Empty<Quest>()
    };

    /// <summary>
    /// Creates a result with updated objectives.
    /// </summary>
    /// <param name="updates">The objective updates.</param>
    /// <param name="completableQuests">Quests now ready to turn in.</param>
    /// <param name="completedQuests">Quests that were auto-completed.</param>
    /// <returns>A new QuestProgressResult.</returns>
    public static QuestProgressResult WithUpdates(
        IEnumerable<ObjectiveProgressUpdate> updates,
        IEnumerable<Quest>? completableQuests = null,
        IEnumerable<Quest>? completedQuests = null)
    {
        var updateList = updates.ToList();

        return new QuestProgressResult
        {
            HasProgress = updateList.Count > 0,
            UpdatedObjectives = updateList,
            CompletableQuests = completableQuests?.ToList() ?? Array.Empty<Quest>(),
            CompletedQuests = completedQuests?.ToList() ?? Array.Empty<Quest>()
        };
    }

    /// <summary>
    /// Gets whether any objectives were just completed.
    /// </summary>
    public bool HasCompletedObjectives =>
        UpdatedObjectives.Any(u => u.JustCompleted);

    /// <summary>
    /// Gets whether any quests became completable.
    /// </summary>
    public bool HasNewlyCompletableQuests => CompletableQuests.Count > 0;

    /// <summary>
    /// Gets whether any quests were completed.
    /// </summary>
    public bool HasCompletedQuests => CompletedQuests.Count > 0;
}
```

### 5.2 ObjectiveProgressUpdate Value Object

```csharp
namespace RuneAndRust.Application.ValueObjects;

/// <summary>
/// Details of a single objective progress update.
/// </summary>
/// <param name="Quest">The quest containing the objective.</param>
/// <param name="Objective">The objective that was updated.</param>
/// <param name="PreviousCount">The count before the update.</param>
/// <param name="NewCount">The count after the update.</param>
/// <param name="JustCompleted">Whether this update completed the objective.</param>
public readonly record struct ObjectiveProgressUpdate(
    Quest Quest,
    QuestObjective Objective,
    int PreviousCount,
    int NewCount,
    bool JustCompleted)
{
    /// <summary>
    /// Gets the amount of progress made.
    /// </summary>
    public int ProgressMade => NewCount - PreviousCount;

    /// <summary>
    /// Gets a notification message for this update.
    /// </summary>
    /// <returns>A formatted notification string.</returns>
    public string ToNotificationString()
    {
        if (JustCompleted)
        {
            return $"[QUEST] {Quest.Name}: {Objective.Description} " +
                   $"({NewCount}/{Objective.RequiredCount}) - COMPLETE!";
        }

        return $"[QUEST] {Quest.Name}: {Objective.Description} " +
               $"({NewCount}/{Objective.RequiredCount})";
    }

    /// <summary>
    /// Creates an ObjectiveProgressUpdate from before/after state.
    /// </summary>
    /// <param name="quest">The quest.</param>
    /// <param name="objective">The objective.</param>
    /// <param name="previousCount">Count before update.</param>
    /// <returns>A new ObjectiveProgressUpdate.</returns>
    public static ObjectiveProgressUpdate Create(
        Quest quest,
        QuestObjective objective,
        int previousCount)
    {
        return new ObjectiveProgressUpdate(
            quest,
            objective,
            previousCount,
            objective.CurrentCount,
            !objective.IsComplete && previousCount < objective.RequiredCount &&
            objective.CurrentCount >= objective.RequiredCount);
    }
}
```

### 5.3 OutcomeType Enum Updates

```csharp
namespace RuneAndRust.Domain.Enums;

/// <summary>
/// Types of outcomes that can result from dialogue choices.
/// </summary>
public enum OutcomeType
{
    // Existing values...

    /// <summary>
    /// Gives an item to the player.
    /// </summary>
    GiveItem,

    /// <summary>
    /// Opens a shop interface.
    /// </summary>
    OpenShop,

    /// <summary>
    /// Starts a quest for the player.
    /// </summary>
    /// <remarks>
    /// The TargetId should contain the quest definition ID.
    /// The quest is created and automatically accepted.
    /// </remarks>
    StartQuest,

    /// <summary>
    /// Turns in a completed quest.
    /// </summary>
    /// <remarks>
    /// The TargetId should contain the quest ID to complete.
    /// Only works if the quest is ready to turn in.
    /// </remarks>
    TurnInQuest,

    // ... other existing values
}
```

### 5.4 QuestAcceptedNotification DTO

```csharp
namespace RuneAndRust.Application.DTOs;

/// <summary>
/// Notification data for when a quest is accepted.
/// </summary>
/// <param name="Quest">The accepted quest.</param>
/// <param name="Objectives">The quest objectives to display.</param>
public record QuestAcceptedNotificationDto(
    Quest Quest,
    IReadOnlyList<ObjectiveSummaryDto> Objectives)
{
    /// <summary>
    /// Creates a notification DTO from a quest.
    /// </summary>
    public static QuestAcceptedNotificationDto FromQuest(Quest quest)
    {
        var objectives = quest.Objectives
            .Where(o => !o.IsHidden)
            .OrderBy(o => o.Order)
            .Select(ObjectiveSummaryDto.FromObjective)
            .ToList();

        return new QuestAcceptedNotificationDto(quest, objectives);
    }
}
```

### 5.5 QuestCompletedNotification DTO

```csharp
namespace RuneAndRust.Application.DTOs;

/// <summary>
/// Notification data for when a quest is completed.
/// </summary>
/// <param name="Quest">The completed quest.</param>
public record QuestCompletedNotificationDto(Quest Quest)
{
    /// <summary>
    /// Creates a notification DTO from a quest.
    /// </summary>
    public static QuestCompletedNotificationDto FromQuest(Quest quest)
    {
        return new QuestCompletedNotificationDto(quest);
    }
}
```

---

## 6. Service Specifications

### 6.1 IQuestProgressService Interface

```csharp
namespace RuneAndRust.Application.Interfaces;

/// <summary>
/// Service for tracking quest progress from game events.
/// </summary>
/// <remarks>
/// This service is called by other game systems (combat, inventory, movement, dialogue)
/// when events occur that might advance quest objectives. It finds matching objectives
/// and updates their progress, returning information about what changed.
/// </remarks>
public interface IQuestProgressService
{
    /// <summary>
    /// Processes a monster defeat for quest progress.
    /// </summary>
    /// <param name="player">The player who defeated the monster.</param>
    /// <param name="monsterId">The defeated monster's definition ID.</param>
    /// <param name="monsterType">The monster's type for "any of type" matching.</param>
    /// <returns>Result containing any progress updates.</returns>
    QuestProgressResult ProcessMonsterDefeated(
        Player player,
        string monsterId,
        string? monsterType);

    /// <summary>
    /// Processes an item pickup for quest progress.
    /// </summary>
    /// <param name="player">The player who collected the item.</param>
    /// <param name="itemId">The collected item's definition ID.</param>
    /// <returns>Result containing any progress updates.</returns>
    QuestProgressResult ProcessItemCollected(
        Player player,
        string itemId);

    /// <summary>
    /// Processes room entry for quest progress.
    /// </summary>
    /// <param name="player">The player who entered the room.</param>
    /// <param name="roomId">The entered room's ID.</param>
    /// <returns>Result containing any progress updates.</returns>
    QuestProgressResult ProcessRoomEntered(
        Player player,
        string roomId);

    /// <summary>
    /// Processes NPC dialogue completion for quest progress.
    /// </summary>
    /// <param name="player">The player who talked to the NPC.</param>
    /// <param name="npcId">The NPC's definition ID.</param>
    /// <returns>Result containing any progress updates.</returns>
    QuestProgressResult ProcessNpcTalked(
        Player player,
        string npcId);

    /// <summary>
    /// Processes item delivery to NPC for quest progress.
    /// </summary>
    /// <param name="player">The player delivering the item.</param>
    /// <param name="npcId">The NPC receiving the item.</param>
    /// <param name="itemId">The item being delivered.</param>
    /// <returns>Result containing any progress updates.</returns>
    QuestProgressResult ProcessItemDelivered(
        Player player,
        string npcId,
        string itemId);

    /// <summary>
    /// Manually updates objective progress.
    /// </summary>
    /// <param name="player">The player owning the quest.</param>
    /// <param name="questId">The quest ID.</param>
    /// <param name="objectiveId">The objective ID.</param>
    /// <param name="progress">The progress amount to add.</param>
    /// <returns>Result containing any progress updates.</returns>
    QuestProgressResult UpdateObjective(
        Player player,
        Guid questId,
        Guid objectiveId,
        int progress = 1);
}
```

### 6.2 QuestProgressService Implementation

```csharp
namespace RuneAndRust.Application.Services;

/// <summary>
/// Service implementation for tracking quest progress from game events.
/// </summary>
public class QuestProgressService : IQuestProgressService
{
    private readonly IQuestService _questService;
    private readonly ILogger<QuestProgressService> _logger;

    /// <summary>
    /// Initializes a new instance of the QuestProgressService.
    /// </summary>
    public QuestProgressService(
        IQuestService questService,
        ILogger<QuestProgressService> logger)
    {
        _questService = questService ?? throw new ArgumentNullException(nameof(questService));
        _logger = logger ?? throw new ArgumentNullException(nameof(logger));
    }

    /// <inheritdoc />
    public QuestProgressResult ProcessMonsterDefeated(
        Player player,
        string monsterId,
        string? monsterType)
    {
        ArgumentNullException.ThrowIfNull(player);
        ArgumentException.ThrowIfNullOrWhiteSpace(monsterId);

        _logger.LogDebug(
            "Processing monster defeat for player {PlayerId}: {MonsterId} (type: {MonsterType})",
            player.Id, monsterId, monsterType ?? "unknown");

        return ProcessObjectiveProgress(
            player,
            ObjectiveType.Kill,
            monsterId,
            monsterType);
    }

    /// <inheritdoc />
    public QuestProgressResult ProcessItemCollected(
        Player player,
        string itemId)
    {
        ArgumentNullException.ThrowIfNull(player);
        ArgumentException.ThrowIfNullOrWhiteSpace(itemId);

        _logger.LogDebug(
            "Processing item collection for player {PlayerId}: {ItemId}",
            player.Id, itemId);

        return ProcessObjectiveProgress(
            player,
            ObjectiveType.Collect,
            itemId,
            null);
    }

    /// <inheritdoc />
    public QuestProgressResult ProcessRoomEntered(
        Player player,
        string roomId)
    {
        ArgumentNullException.ThrowIfNull(player);
        ArgumentException.ThrowIfNullOrWhiteSpace(roomId);

        _logger.LogDebug(
            "Processing room entry for player {PlayerId}: {RoomId}",
            player.Id, roomId);

        return ProcessObjectiveProgress(
            player,
            ObjectiveType.Explore,
            roomId,
            null);
    }

    /// <inheritdoc />
    public QuestProgressResult ProcessNpcTalked(
        Player player,
        string npcId)
    {
        ArgumentNullException.ThrowIfNull(player);
        ArgumentException.ThrowIfNullOrWhiteSpace(npcId);

        _logger.LogDebug(
            "Processing NPC dialogue for player {PlayerId}: {NpcId}",
            player.Id, npcId);

        return ProcessObjectiveProgress(
            player,
            ObjectiveType.Talk,
            npcId,
            null);
    }

    /// <inheritdoc />
    public QuestProgressResult ProcessItemDelivered(
        Player player,
        string npcId,
        string itemId)
    {
        ArgumentNullException.ThrowIfNull(player);
        ArgumentException.ThrowIfNullOrWhiteSpace(npcId);
        ArgumentException.ThrowIfNullOrWhiteSpace(itemId);

        _logger.LogDebug(
            "Processing item delivery for player {PlayerId}: {ItemId} to {NpcId}",
            player.Id, itemId, npcId);

        // For Deliver objectives, we need to match both NPC and item
        var updates = new List<ObjectiveProgressUpdate>();
        var newlyCompletable = new List<Quest>();

        foreach (var quest in _questService.GetActiveQuests(player))
        {
            foreach (var objective in quest.Objectives
                .Where(o => o.Type == ObjectiveType.Deliver && !o.IsComplete))
            {
                // Deliver objectives should have NPC as target and item as secondary
                // For now, match on NPC ID (item check would require extended target)
                if (objective.Target.Matches(npcId, null))
                {
                    var previousCount = objective.CurrentCount;
                    if (objective.IncrementProgress())
                    {
                        var update = ObjectiveProgressUpdate.Create(quest, objective, previousCount);
                        updates.Add(update);

                        LogObjectiveProgress(quest, objective, previousCount);

                        if (quest.CanTurnIn() && !newlyCompletable.Contains(quest))
                        {
                            newlyCompletable.Add(quest);
                            _logger.LogInformation(
                                "Quest '{QuestName}' is now ready to turn in",
                                quest.Name);
                        }
                    }
                }
            }
        }

        return QuestProgressResult.WithUpdates(updates, newlyCompletable);
    }

    /// <inheritdoc />
    public QuestProgressResult UpdateObjective(
        Player player,
        Guid questId,
        Guid objectiveId,
        int progress = 1)
    {
        ArgumentNullException.ThrowIfNull(player);
        ArgumentOutOfRangeException.ThrowIfNegativeOrZero(progress);

        var quest = _questService.GetQuest(player, questId);
        if (quest == null)
        {
            _logger.LogWarning(
                "Quest {QuestId} not found for player {PlayerId}",
                questId, player.Id);
            return QuestProgressResult.None;
        }

        var objective = quest.GetObjective(objectiveId);
        if (objective == null)
        {
            _logger.LogWarning(
                "Objective {ObjectiveId} not found in quest {QuestId}",
                objectiveId, questId);
            return QuestProgressResult.None;
        }

        if (objective.IsComplete)
        {
            return QuestProgressResult.None;
        }

        var previousCount = objective.CurrentCount;
        objective.IncrementProgress(progress);

        var update = ObjectiveProgressUpdate.Create(quest, objective, previousCount);
        var completable = quest.CanTurnIn() ? new[] { quest } : Array.Empty<Quest>();

        LogObjectiveProgress(quest, objective, previousCount);

        return QuestProgressResult.WithUpdates(new[] { update }, completable);
    }

    /// <summary>
    /// Processes objective progress for a specific type and target.
    /// </summary>
    private QuestProgressResult ProcessObjectiveProgress(
        Player player,
        ObjectiveType type,
        string targetId,
        string? targetType)
    {
        var updates = new List<ObjectiveProgressUpdate>();
        var newlyCompletable = new List<Quest>();

        foreach (var quest in _questService.GetActiveQuests(player))
        {
            foreach (var objective in quest.Objectives
                .Where(o => o.Type == type && !o.IsComplete))
            {
                if (objective.Target.Matches(targetId, targetType))
                {
                    var previousCount = objective.CurrentCount;

                    if (objective.IncrementProgress())
                    {
                        var update = ObjectiveProgressUpdate.Create(quest, objective, previousCount);
                        updates.Add(update);

                        LogObjectiveProgress(quest, objective, previousCount);

                        // Check if quest just became completable
                        if (quest.CanTurnIn() && !newlyCompletable.Contains(quest))
                        {
                            newlyCompletable.Add(quest);
                            _logger.LogInformation(
                                "Quest '{QuestName}' is now ready to turn in",
                                quest.Name);
                        }
                    }
                }
            }
        }

        if (updates.Count > 0)
        {
            _logger.LogDebug(
                "Processed {UpdateCount} objective updates for {Type} target {TargetId}",
                updates.Count, type, targetId);
        }

        return QuestProgressResult.WithUpdates(updates, newlyCompletable);
    }

    /// <summary>
    /// Logs objective progress update.
    /// </summary>
    private void LogObjectiveProgress(Quest quest, QuestObjective objective, int previousCount)
    {
        if (objective.IsComplete)
        {
            _logger.LogInformation(
                "Quest '{QuestName}' objective '{ObjectiveDesc}' completed ({Current}/{Required})",
                quest.Name, objective.Description, objective.CurrentCount, objective.RequiredCount);
        }
        else
        {
            _logger.LogDebug(
                "Quest '{QuestName}' objective '{ObjectiveDesc}': {Previous} -> {Current}/{Required}",
                quest.Name, objective.Description, previousCount,
                objective.CurrentCount, objective.RequiredCount);
        }
    }
}
```

---

## 7. Event Integration Specifications

### 7.1 CombatService Integration

```csharp
// In CombatService, after monster defeat:

/// <summary>
/// Called when a monster is defeated in combat.
/// </summary>
private async Task OnMonsterDefeatedAsync(Monster monster, Player player, CancellationToken ct)
{
    // Existing defeat logic (XP, loot, etc.)
    _logger.LogInformation(
        "Player {PlayerId} defeated {MonsterName}",
        player.Id, monster.Name);

    // Quest progress tracking
    var progress = _questProgressService.ProcessMonsterDefeated(
        player,
        monster.DefinitionId,
        monster.MonsterType);

    // Render progress notifications
    if (progress.HasProgress)
    {
        await RenderProgressNotificationsAsync(progress, ct);
    }
}

/// <summary>
/// Renders quest progress notifications.
/// </summary>
private async Task RenderProgressNotificationsAsync(
    QuestProgressResult progress,
    CancellationToken ct)
{
    foreach (var update in progress.UpdatedObjectives)
    {
        await _renderer.RenderQuestProgressAsync(update, ct);
    }

    foreach (var quest in progress.CompletableQuests)
    {
        await _renderer.RenderQuestReadyAsync(quest, ct);
    }
}
```

### 7.2 InventoryService Integration

```csharp
// In InventoryService or item pickup handling:

/// <summary>
/// Called when a player picks up an item.
/// </summary>
private async Task OnItemCollectedAsync(Item item, Player player, CancellationToken ct)
{
    // Existing inventory logic
    _logger.LogDebug(
        "Player {PlayerId} collected {ItemName}",
        player.Id, item.Name);

    // Quest progress tracking
    var progress = _questProgressService.ProcessItemCollected(
        player,
        item.DefinitionId);

    // Render progress notifications
    if (progress.HasProgress)
    {
        await RenderProgressNotificationsAsync(progress, ct);
    }
}
```

### 7.3 MovementService Integration

```csharp
// In room/movement handling:

/// <summary>
/// Called when a player enters a room.
/// </summary>
private async Task OnRoomEnteredAsync(Room room, Player player, CancellationToken ct)
{
    // Existing room entry logic
    _logger.LogDebug(
        "Player {PlayerId} entered room {RoomId}",
        player.Id, room.Id);

    // Quest progress tracking
    var progress = _questProgressService.ProcessRoomEntered(
        player,
        room.DefinitionId ?? room.Id.ToString());

    // Render progress notifications
    if (progress.HasProgress)
    {
        await RenderProgressNotificationsAsync(progress, ct);
    }
}
```

### 7.4 DialogueService Integration

```csharp
// In DialogueService, after dialogue completion:

/// <summary>
/// Called when dialogue with an NPC is completed.
/// </summary>
private async Task OnDialogueCompletedAsync(
    NPC npc,
    Player player,
    DialogueNode node,
    CancellationToken ct)
{
    // Process any Talk objectives
    var progress = _questProgressService.ProcessNpcTalked(
        player,
        npc.DefinitionId);

    if (progress.HasProgress)
    {
        await RenderProgressNotificationsAsync(progress, ct);
    }
}
```

---

## 8. Dialogue Integration Specifications

### 8.1 DialogueOutcome Processing Updates

```csharp
// In DialogueService.ProcessOutcomeAsync():

/// <summary>
/// Processes a dialogue outcome.
/// </summary>
private async Task ProcessOutcomeAsync(
    DialogueOutcome outcome,
    Player player,
    NPC npc,
    CancellationToken ct)
{
    switch (outcome.Type)
    {
        // ... existing cases ...

        case OutcomeType.StartQuest:
            await ProcessStartQuestOutcomeAsync(outcome, player, npc, ct);
            break;

        case OutcomeType.TurnInQuest:
            await ProcessTurnInQuestOutcomeAsync(outcome, player, ct);
            break;
    }
}

/// <summary>
/// Processes the StartQuest dialogue outcome.
/// </summary>
private async Task ProcessStartQuestOutcomeAsync(
    DialogueOutcome outcome,
    Player player,
    NPC npc,
    CancellationToken ct)
{
    var questDefinitionId = outcome.TargetId;

    if (string.IsNullOrEmpty(questDefinitionId))
    {
        _logger.LogError("StartQuest outcome missing quest definition ID");
        return;
    }

    // Check if player already has this quest
    if (_questService.HasActiveQuest(player, questDefinitionId))
    {
        _logger.LogDebug(
            "Player {PlayerId} already has quest {QuestId}",
            player.Id, questDefinitionId);
        await _renderer.RenderMessageAsync(
            "You already have this quest.",
            MessageType.Info,
            ct);
        return;
    }

    // Create and accept the quest
    try
    {
        var quest = _questService.CreateQuest(questDefinitionId, player, npc.DefinitionId);
        var accepted = _questService.AcceptQuest(player, quest);

        if (accepted)
        {
            _logger.LogInformation(
                "Player {PlayerId} accepted quest '{QuestName}' from {NpcName}",
                player.Id, quest.Name, npc.Name);

            var notification = QuestAcceptedNotificationDto.FromQuest(quest);
            await _renderer.RenderQuestAcceptedAsync(notification, ct);
        }
        else
        {
            _logger.LogWarning(
                "Failed to accept quest '{QuestId}' for player {PlayerId}",
                questDefinitionId, player.Id);
        }
    }
    catch (ArgumentException ex)
    {
        _logger.LogError(ex, "Failed to create quest {QuestId}", questDefinitionId);
    }
}

/// <summary>
/// Processes the TurnInQuest dialogue outcome.
/// </summary>
private async Task ProcessTurnInQuestOutcomeAsync(
    DialogueOutcome outcome,
    Player player,
    CancellationToken ct)
{
    var questIdString = outcome.TargetId;

    if (string.IsNullOrEmpty(questIdString) ||
        !Guid.TryParse(questIdString, out var questId))
    {
        _logger.LogError("TurnInQuest outcome has invalid quest ID: {QuestId}", questIdString);
        return;
    }

    var quest = _questService.GetQuest(player, questId);
    if (quest == null)
    {
        _logger.LogWarning("Quest {QuestId} not found for turn-in", questId);
        return;
    }

    if (!quest.CanTurnIn())
    {
        _logger.LogWarning(
            "Quest '{QuestName}' is not ready to turn in",
            quest.Name);
        await _renderer.RenderMessageAsync(
            "This quest is not ready to turn in.",
            MessageType.Warning,
            ct);
        return;
    }

    var completed = _questService.CompleteQuest(player, questId);

    if (completed)
    {
        _logger.LogInformation(
            "Player {PlayerId} completed quest '{QuestName}'",
            player.Id, quest.Name);

        var notification = QuestCompletedNotificationDto.FromQuest(quest);
        await _renderer.RenderQuestCompletedAsync(notification, ct);
    }
}
```

### 8.2 Dialogue Node Quest Conditions

```csharp
// In DialogueService, when building dialogue options:

/// <summary>
/// Builds available dialogue options based on conditions.
/// </summary>
private List<DialogueOption> BuildAvailableOptions(
    DialogueNode node,
    Player player,
    NPC npc)
{
    var options = new List<DialogueOption>();

    foreach (var option in node.Options)
    {
        // Check quest-related conditions
        if (option.Conditions != null)
        {
            if (!CheckQuestConditions(option.Conditions, player))
            {
                continue; // Skip options whose conditions aren't met
            }
        }

        options.Add(option);
    }

    // Add turn-in options for completable quests with this NPC
    var completableQuests = _questService.GetCompletableQuests(player)
        .Where(q => q.TurnInNpcId == npc.DefinitionId)
        .ToList();

    foreach (var quest in completableQuests)
    {
        options.Insert(0, new DialogueOption
        {
            Text = $"[Turn In Quest: {quest.Name}]",
            Outcome = new DialogueOutcome
            {
                Type = OutcomeType.TurnInQuest,
                TargetId = quest.Id.ToString()
            }
        });
    }

    return options;
}

/// <summary>
/// Checks quest-related dialogue conditions.
/// </summary>
private bool CheckQuestConditions(DialogueConditions conditions, Player player)
{
    // Check RequiresQuest condition
    if (!string.IsNullOrEmpty(conditions.RequiresQuest))
    {
        if (!player.HasQuest(conditions.RequiresQuest))
        {
            return false;
        }
    }

    // Check RequiresQuestComplete condition
    if (!string.IsNullOrEmpty(conditions.RequiresQuestComplete))
    {
        if (!player.HasCompletedQuest(conditions.RequiresQuestComplete))
        {
            return false;
        }
    }

    // Check NotHasQuest condition
    if (!string.IsNullOrEmpty(conditions.NotHasQuest))
    {
        if (player.HasQuest(conditions.NotHasQuest))
        {
            return false;
        }
    }

    return true;
}
```

### 8.3 Dialogue Configuration Example

```json
{
  "dialogues": {
    "guard-captain": {
      "greeting": {
        "text": "The Guard Captain looks you over. 'You look capable enough. We have a goblin problem that needs dealing with.'",
        "options": [
          {
            "text": "Tell me about the goblin problem.",
            "nextNode": "goblin-problem-details"
          },
          {
            "text": "I'll handle it.",
            "displayText": "[Accept Quest: The Goblin Menace]",
            "outcome": {
              "type": "StartQuest",
              "targetId": "goblin-menace"
            },
            "conditions": {
              "notHasQuest": "goblin-menace"
            }
          },
          {
            "text": "Not interested right now.",
            "nextNode": "farewell"
          }
        ]
      },
      "goblin-problem-details": {
        "text": "Goblins have been raiding caravans on the road. We need someone to thin their numbers. Kill at least 5 of them.",
        "options": [
          {
            "text": "I'll take care of it.",
            "displayText": "[Accept Quest: The Goblin Menace]",
            "outcome": {
              "type": "StartQuest",
              "targetId": "goblin-menace"
            },
            "conditions": {
              "notHasQuest": "goblin-menace"
            }
          },
          {
            "text": "Maybe later.",
            "nextNode": "farewell"
          }
        ]
      },
      "quest-complete": {
        "text": "The Guard Captain nods approvingly. 'I see you've dealt with those goblins. Well done, adventurer.'",
        "conditions": {
          "requiresQuest": "goblin-menace"
        }
      }
    }
  }
}
```

---

## 9. Rendering Specifications

### 9.1 IGameRenderer Additions

```csharp
// Add to IGameRenderer interface:

/// <summary>
/// Renders a quest progress update notification.
/// </summary>
/// <param name="update">The objective progress update.</param>
/// <param name="ct">Cancellation token.</param>
Task RenderQuestProgressAsync(ObjectiveProgressUpdate update, CancellationToken ct = default);

/// <summary>
/// Renders a quest ready-to-turn-in notification.
/// </summary>
/// <param name="quest">The quest that is ready.</param>
/// <param name="ct">Cancellation token.</param>
Task RenderQuestReadyAsync(Quest quest, CancellationToken ct = default);

/// <summary>
/// Renders a quest accepted notification.
/// </summary>
/// <param name="notification">The quest accepted notification data.</param>
/// <param name="ct">Cancellation token.</param>
Task RenderQuestAcceptedAsync(QuestAcceptedNotificationDto notification, CancellationToken ct = default);

/// <summary>
/// Renders a quest completed notification.
/// </summary>
/// <param name="notification">The quest completed notification data.</param>
/// <param name="ct">Cancellation token.</param>
Task RenderQuestCompletedAsync(QuestCompletedNotificationDto notification, CancellationToken ct = default);
```

### 9.2 Progress Notification Display

```
┌─────────────────────────────────────────────────────────────────────────┐
│                        COMBAT VICTORY                                   │
├─────────────────────────────────────────────────────────────────────────┤
│  You defeated the Goblin!                                               │
│  Experience gained: 15 XP                                               │
│                                                                         │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │  [QUEST] The Goblin Menace: Defeat goblins (4/5)                │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

### 9.3 Objective Completion Display

```
┌─────────────────────────────────────────────────────────────────────────┐
│                        COMBAT VICTORY                                   │
├─────────────────────────────────────────────────────────────────────────┤
│  You defeated the Goblin!                                               │
│  Experience gained: 15 XP                                               │
│                                                                         │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │  [QUEST] The Goblin Menace: Defeat goblins (5/5) - COMPLETE!    │   │
│  │  [QUEST] The Goblin Menace is ready to turn in!                 │   │
│  │          Return to Guard Captain                                 │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

### 9.4 Quest Accepted Display

```
┌─────────────────────────────────────────────────────────────────────────┐
│                          NEW QUEST                                      │
├─────────────────────────────────────────────────────────────────────────┤
│  The Goblin Menace                                                      │
│                                                                         │
│  The dungeon entrance is overrun with goblins. Clear them out to        │
│  make the area safe for other adventurers.                              │
│                                                                         │
│  OBJECTIVES:                                                            │
│  • Defeat goblins (0/5)                                                 │
│                                                                         │
│  HINT: Goblins are commonly found in the upper dungeon levels.          │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

### 9.5 Quest Completed Display

```
┌─────────────────────────────────────────────────────────────────────────┐
│                       QUEST COMPLETE!                                   │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  ★ The Goblin Menace ★                                                  │
│                                                                         │
│  You have completed this quest!                                         │
│                                                                         │
│  [Rewards will be implemented in v0.3.1]                                │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

### 9.6 Console Output Examples

**Progress Update:**
```
=== COMBAT VICTORY ===
You defeated the Goblin!
Experience gained: 15 XP

[QUEST] The Goblin Menace: Defeat goblins (4/5)
```

**Objective Completion:**
```
=== COMBAT VICTORY ===
You defeated the Goblin!
Experience gained: 15 XP

[QUEST] The Goblin Menace: Defeat goblins (5/5) - COMPLETE!
[QUEST] The Goblin Menace is ready to turn in!
        Return to Guard Captain
```

**Quest Accepted:**
```
You accept the quest: The Goblin Menace

=== NEW QUEST ===
The Goblin Menace
Defeat goblins (0/5)

Hint: Goblins are commonly found in the upper dungeon levels.
```

**Quest Completed:**
```
You complete the quest: The Goblin Menace!

=== QUEST COMPLETE ===
The Goblin Menace
[Rewards will be implemented in v0.3.1]
```

---

## 10. User-Facing Changes

### 10.1 Automatic Progress Tracking

| Event | Quest Update |
|-------|--------------|
| Defeating a monster | Kill objectives matching the monster update |
| Picking up an item | Collect objectives matching the item update |
| Entering a room | Explore objectives matching the room update |
| Completing NPC dialogue | Talk objectives matching the NPC update |

### 10.2 Dialogue Changes

| Dialogue Feature | Description |
|------------------|-------------|
| Quest Offer | Dialogue options can offer quests with `[Accept Quest: name]` |
| Quest Turn-in | Completable quests show `[Turn In Quest: name]` option |
| Conditional Options | Options can require/exclude quests |

### 10.3 Notifications

| Notification | When Displayed |
|--------------|----------------|
| Progress Update | Each time an objective progresses |
| Objective Complete | When an objective reaches its goal |
| Quest Ready | When all objectives are complete |
| Quest Accepted | When accepting a quest via dialogue |
| Quest Complete | When turning in a completed quest |

---

## 11. Logging Requirements

### 11.1 Log Events

| Event | Level | Message Template | Properties |
|-------|-------|------------------|------------|
| Monster Processed | Debug | "Processing monster defeat for player {PlayerId}: {MonsterId} (type: {MonsterType})" | PlayerId, MonsterId, MonsterType |
| Item Processed | Debug | "Processing item collection for player {PlayerId}: {ItemId}" | PlayerId, ItemId |
| Room Processed | Debug | "Processing room entry for player {PlayerId}: {RoomId}" | PlayerId, RoomId |
| NPC Processed | Debug | "Processing NPC dialogue for player {PlayerId}: {NpcId}" | PlayerId, NpcId |
| Objective Progress | Debug | "Quest '{QuestName}' objective '{ObjectiveDesc}': {Previous} -> {Current}/{Required}" | QuestName, ObjectiveDesc, Previous, Current, Required |
| Objective Complete | Information | "Quest '{QuestName}' objective '{ObjectiveDesc}' completed ({Current}/{Required})" | QuestName, ObjectiveDesc, Current, Required |
| Quest Ready | Information | "Quest '{QuestName}' is now ready to turn in" | QuestName |
| Quest Accepted | Information | "Player {PlayerId} accepted quest '{QuestName}' from {NpcName}" | PlayerId, QuestName, NpcName |
| Quest Completed | Information | "Player {PlayerId} completed quest '{QuestName}'" | PlayerId, QuestName |
| Updates Processed | Debug | "Processed {UpdateCount} objective updates for {Type} target {TargetId}" | UpdateCount, Type, TargetId |

### 11.2 Example Log Output

```
[2024-01-20 14:35:10 DBG] Processing monster defeat for player e5f6g7h8-...: goblin-warrior (type: goblin)
[2024-01-20 14:35:10 DBG] Quest 'The Goblin Menace' objective 'Defeat goblins': 3 -> 4/5
[2024-01-20 14:35:10 DBG] Processed 1 objective updates for Kill target goblin-warrior
[2024-01-20 14:37:30 DBG] Processing monster defeat for player e5f6g7h8-...: goblin-scout (type: goblin)
[2024-01-20 14:37:30 INF] Quest 'The Goblin Menace' objective 'Defeat goblins' completed (5/5)
[2024-01-20 14:37:30 INF] Quest 'The Goblin Menace' is now ready to turn in
[2024-01-20 14:40:00 INF] Player e5f6g7h8-... completed quest 'The Goblin Menace'
```

---

## 12. Unit Test Specifications

### 12.1 QuestProgressService Tests (~15 tests)

```csharp
namespace RuneAndRust.Application.Tests.Services;

[TestFixture]
public class QuestProgressServiceTests
{
    private QuestProgressService _progressService;
    private Mock<IQuestService> _questServiceMock;
    private Mock<ILogger<QuestProgressService>> _loggerMock;
    private Player _player;
    private Quest _testQuest;

    [SetUp]
    public void Setup()
    {
        _loggerMock = new Mock<ILogger<QuestProgressService>>();
        _questServiceMock = new Mock<IQuestService>();

        _progressService = new QuestProgressService(
            _questServiceMock.Object,
            _loggerMock.Object);

        _player = Player.Create("Test Player");

        var definition = QuestDefinition.Create(
            "test-quest",
            "Test Quest",
            "A test quest.",
            new[]
            {
                ObjectiveDefinition.Create(
                    ObjectiveType.Kill,
                    "Defeat goblins",
                    ObjectiveTarget.Any("goblin", "Goblins"),
                    5,
                    order: 1),
                ObjectiveDefinition.Create(
                    ObjectiveType.Explore,
                    "Visit the cave",
                    ObjectiveTarget.Specific("room-cave", "Cave"),
                    1,
                    order: 2)
            });

        _testQuest = Quest.Create(definition, _player.Id);
        _testQuest.Accept();
        _player.AcceptQuest(_testQuest);

        _questServiceMock
            .Setup(s => s.GetActiveQuests(_player))
            .Returns(new[] { _testQuest });
    }

    [Test]
    public void ProcessMonsterDefeated_MatchingTarget_IncrementsProgress()
    {
        var result = _progressService.ProcessMonsterDefeated(
            _player, "goblin-1", "goblin");

        result.HasProgress.Should().BeTrue();
        result.UpdatedObjectives.Should().HaveCount(1);
        result.UpdatedObjectives[0].NewCount.Should().Be(1);
    }

    [Test]
    public void ProcessMonsterDefeated_NonMatchingTarget_NoProgress()
    {
        var result = _progressService.ProcessMonsterDefeated(
            _player, "orc-1", "orc");

        result.HasProgress.Should().BeFalse();
        result.UpdatedObjectives.Should().BeEmpty();
    }

    [Test]
    public void ProcessMonsterDefeated_CompletesObjective_MarksJustCompleted()
    {
        // Set progress to 4/5
        _testQuest.Objectives[0].SetProgress(4);

        var result = _progressService.ProcessMonsterDefeated(
            _player, "goblin-1", "goblin");

        result.HasProgress.Should().BeTrue();
        result.UpdatedObjectives[0].JustCompleted.Should().BeTrue();
    }

    [Test]
    public void ProcessMonsterDefeated_AllObjectivesComplete_QuestCompletable()
    {
        // Set kill objective to 4/5
        _testQuest.Objectives[0].SetProgress(4);
        // Set explore objective complete
        _testQuest.Objectives[1].SetProgress(1);

        var result = _progressService.ProcessMonsterDefeated(
            _player, "goblin-1", "goblin");

        result.HasProgress.Should().BeTrue();
        result.CompletableQuests.Should().Contain(_testQuest);
    }

    [Test]
    public void ProcessItemCollected_MatchingTarget_IncrementsProgress()
    {
        var collectQuest = CreateCollectQuest();
        _questServiceMock
            .Setup(s => s.GetActiveQuests(_player))
            .Returns(new[] { collectQuest });

        var result = _progressService.ProcessItemCollected(
            _player, "item-golden-locket");

        result.HasProgress.Should().BeTrue();
    }

    [Test]
    public void ProcessRoomEntered_MatchingTarget_IncrementsProgress()
    {
        var result = _progressService.ProcessRoomEntered(
            _player, "room-cave");

        result.HasProgress.Should().BeTrue();
        result.UpdatedObjectives[0].Objective.Type.Should().Be(ObjectiveType.Explore);
    }

    [Test]
    public void ProcessRoomEntered_NonMatchingRoom_NoProgress()
    {
        var result = _progressService.ProcessRoomEntered(
            _player, "room-other");

        result.HasProgress.Should().BeFalse();
    }

    [Test]
    public void ProcessNpcTalked_MatchingTarget_IncrementsProgress()
    {
        var talkQuest = CreateTalkQuest();
        _questServiceMock
            .Setup(s => s.GetActiveQuests(_player))
            .Returns(new[] { talkQuest });

        var result = _progressService.ProcessNpcTalked(
            _player, "npc-guard-captain");

        result.HasProgress.Should().BeTrue();
    }

    [Test]
    public void ProcessMonsterDefeated_ObjectiveAlreadyComplete_NoProgress()
    {
        _testQuest.Objectives[0].SetProgress(5);

        var result = _progressService.ProcessMonsterDefeated(
            _player, "goblin-1", "goblin");

        result.HasProgress.Should().BeFalse();
    }

    [Test]
    public void ProcessMonsterDefeated_NoActiveQuests_NoProgress()
    {
        _questServiceMock
            .Setup(s => s.GetActiveQuests(_player))
            .Returns(Array.Empty<Quest>());

        var result = _progressService.ProcessMonsterDefeated(
            _player, "goblin-1", "goblin");

        result.HasProgress.Should().BeFalse();
    }

    [Test]
    public void UpdateObjective_ValidObjective_IncrementsProgress()
    {
        _questServiceMock
            .Setup(s => s.GetQuest(_player, _testQuest.Id))
            .Returns(_testQuest);

        var objectiveId = _testQuest.Objectives[0].Id;

        var result = _progressService.UpdateObjective(
            _player, _testQuest.Id, objectiveId, 2);

        result.HasProgress.Should().BeTrue();
        result.UpdatedObjectives[0].NewCount.Should().Be(2);
    }

    [Test]
    public void UpdateObjective_InvalidQuestId_ReturnsNoProgress()
    {
        _questServiceMock
            .Setup(s => s.GetQuest(_player, It.IsAny<Guid>()))
            .Returns((Quest?)null);

        var result = _progressService.UpdateObjective(
            _player, Guid.NewGuid(), Guid.NewGuid(), 1);

        result.HasProgress.Should().BeFalse();
    }

    [Test]
    public void ProcessMonsterDefeated_MultipleMatchingObjectives_UpdatesAll()
    {
        var quest2 = Quest.Create(
            QuestDefinition.Create(
                "quest-2",
                "Quest 2",
                "Another quest.",
                new[]
                {
                    ObjectiveDefinition.Create(
                        ObjectiveType.Kill,
                        "Kill goblins too",
                        ObjectiveTarget.Any("goblin", "Goblins"),
                        3)
                }),
            _player.Id);
        quest2.Accept();

        _questServiceMock
            .Setup(s => s.GetActiveQuests(_player))
            .Returns(new[] { _testQuest, quest2 });

        var result = _progressService.ProcessMonsterDefeated(
            _player, "goblin-1", "goblin");

        result.HasProgress.Should().BeTrue();
        result.UpdatedObjectives.Should().HaveCount(2);
    }

    [Test]
    public void QuestProgressResult_None_HasNoProgress()
    {
        var result = QuestProgressResult.None;

        result.HasProgress.Should().BeFalse();
        result.UpdatedObjectives.Should().BeEmpty();
        result.CompletableQuests.Should().BeEmpty();
        result.CompletedQuests.Should().BeEmpty();
    }

    private Quest CreateCollectQuest()
    {
        var definition = QuestDefinition.Create(
            "collect-quest",
            "Collect Quest",
            "Collect items.",
            new[]
            {
                ObjectiveDefinition.Create(
                    ObjectiveType.Collect,
                    "Find the locket",
                    ObjectiveTarget.Specific("item-golden-locket", "Golden Locket"),
                    1)
            });

        var quest = Quest.Create(definition, _player.Id);
        quest.Accept();
        return quest;
    }

    private Quest CreateTalkQuest()
    {
        var definition = QuestDefinition.Create(
            "talk-quest",
            "Talk Quest",
            "Talk to NPC.",
            new[]
            {
                ObjectiveDefinition.Create(
                    ObjectiveType.Talk,
                    "Talk to the guard captain",
                    ObjectiveTarget.Specific("npc-guard-captain", "Guard Captain"),
                    1)
            });

        var quest = Quest.Create(definition, _player.Id);
        quest.Accept();
        return quest;
    }
}
```

### 12.2 ObjectiveProgressUpdate Tests (~5 tests)

```csharp
[TestFixture]
public class ObjectiveProgressUpdateTests
{
    private Quest _quest;
    private QuestObjective _objective;

    [SetUp]
    public void Setup()
    {
        var definition = QuestDefinition.Create(
            "test-quest",
            "Test Quest",
            "Test.",
            new[]
            {
                ObjectiveDefinition.Create(
                    ObjectiveType.Kill,
                    "Defeat enemies",
                    ObjectiveTarget.Any("enemy", "Enemies"),
                    5)
            });

        _quest = Quest.Create(definition, Guid.NewGuid());
        _quest.Accept();
        _objective = _quest.Objectives[0];
    }

    [Test]
    public void Create_CalculatesJustCompleted_WhenObjectiveCompletes()
    {
        _objective.SetProgress(4);
        var previousCount = 4;
        _objective.IncrementProgress();

        var update = ObjectiveProgressUpdate.Create(_quest, _objective, previousCount);

        update.JustCompleted.Should().BeTrue();
        update.NewCount.Should().Be(5);
    }

    [Test]
    public void Create_NotJustCompleted_WhenObjectiveStillIncomplete()
    {
        var previousCount = 2;
        _objective.SetProgress(3);

        var update = ObjectiveProgressUpdate.Create(_quest, _objective, previousCount);

        update.JustCompleted.Should().BeFalse();
    }

    [Test]
    public void ProgressMade_CalculatesCorrectly()
    {
        var update = new ObjectiveProgressUpdate(_quest, _objective, 2, 4, false);

        update.ProgressMade.Should().Be(2);
    }

    [Test]
    public void ToNotificationString_InProgress_FormatsCorrectly()
    {
        _objective.SetProgress(3);
        var update = new ObjectiveProgressUpdate(_quest, _objective, 2, 3, false);

        var notification = update.ToNotificationString();

        notification.Should().Contain("Test Quest");
        notification.Should().Contain("Defeat enemies");
        notification.Should().Contain("(3/5)");
        notification.Should().NotContain("COMPLETE");
    }

    [Test]
    public void ToNotificationString_JustCompleted_IncludesComplete()
    {
        _objective.SetProgress(5);
        var update = new ObjectiveProgressUpdate(_quest, _objective, 4, 5, true);

        var notification = update.ToNotificationString();

        notification.Should().Contain("COMPLETE!");
    }
}
```

### 12.3 Dialogue Integration Tests (~5 tests)

```csharp
[TestFixture]
public class DialogueQuestIntegrationTests
{
    // Note: These would typically be integration tests
    // Testing the dialogue outcome processing

    [Test]
    public void StartQuestOutcome_CreatesAndAcceptsQuest()
    {
        // Test that StartQuest outcome properly creates and accepts quest
    }

    [Test]
    public void TurnInQuestOutcome_CompletesQuest()
    {
        // Test that TurnInQuest outcome properly completes quest
    }

    [Test]
    public void DialogueOptions_ShowTurnInForCompletableQuests()
    {
        // Test that turn-in options appear for completable quests
    }

    [Test]
    public void DialogueCondition_RequiresQuest_FiltersOptions()
    {
        // Test that quest conditions filter dialogue options
    }

    [Test]
    public void DialogueCondition_NotHasQuest_FiltersOptions()
    {
        // Test that NotHasQuest condition filters options
    }
}
```

---

## 13. Use Cases

### UC-001: Kill Objective Progress
**Actor:** Player
**Flow:**
1. Player defeats monster in combat
2. CombatService calls QuestProgressService.ProcessMonsterDefeated()
3. Service finds matching Kill objectives
4. Service increments objective progress
5. Renderer displays progress notification
6. If all objectives complete, displays ready notification

### UC-002: Collect Objective Progress
**Actor:** Player
**Flow:**
1. Player picks up item
2. InventoryService calls QuestProgressService.ProcessItemCollected()
3. Service finds matching Collect objectives
4. Service increments objective progress
5. Renderer displays progress notification

### UC-003: Explore Objective Progress
**Actor:** Player
**Flow:**
1. Player enters a room
2. MovementService calls QuestProgressService.ProcessRoomEntered()
3. Service finds matching Explore objectives
4. Service marks objective complete
5. Renderer displays completion notification

### UC-004: Accept Quest via Dialogue
**Actor:** Player
**Flow:**
1. Player talks to NPC
2. Player selects "Accept Quest" option
3. DialogueService processes StartQuest outcome
4. QuestService creates quest from definition
5. QuestService accepts quest for player
6. Renderer displays new quest notification

### UC-005: Turn In Quest via Dialogue
**Actor:** Player
**Flow:**
1. Player talks to quest turn-in NPC
2. System shows turn-in option for completable quests
3. Player selects turn-in option
4. DialogueService processes TurnInQuest outcome
5. QuestService completes quest
6. Renderer displays completion notification

---

## 14. Acceptance Criteria

### AC-3.0c-1: QuestProgressService
- [ ] ProcessMonsterDefeated updates Kill objectives matching target
- [ ] ProcessItemCollected updates Collect objectives matching item
- [ ] ProcessRoomEntered updates Explore objectives matching room
- [ ] ProcessNpcTalked updates Talk objectives matching NPC
- [ ] UpdateObjective manually updates specific objective
- [ ] Returns QuestProgressResult with all updates
- [ ] Identifies newly completable quests
- [ ] Appropriate logging for all operations

### AC-3.0c-2: Kill Objective Tracking
- [ ] Specific monster ID matching works
- [ ] "Any of type" matching works
- [ ] Progress increments correctly
- [ ] Objective completion detected
- [ ] Works with multiple active quests

### AC-3.0c-3: Collect Objective Tracking
- [ ] Item ID matching works
- [ ] Progress increments on pickup
- [ ] Objective completion detected

### AC-3.0c-4: Explore Objective Tracking
- [ ] Room ID matching works
- [ ] Room entry marks objective complete
- [ ] Works for first-time visits only

### AC-3.0c-5: Talk Objective Tracking
- [ ] NPC ID matching works
- [ ] Dialogue completion triggers progress
- [ ] Objective completion detected

### AC-3.0c-6: Dialogue Integration
- [ ] StartQuest outcome creates and accepts quest
- [ ] TurnInQuest outcome completes quest
- [ ] Quest conditions filter dialogue options
- [ ] Turn-in options appear for completable quests
- [ ] Quest giver NPC tracked correctly

### AC-3.0c-7: Progress Notifications
- [ ] Progress updates display to player
- [ ] Objective completion shows special notification
- [ ] Quest ready notification includes NPC name
- [ ] Quest accepted shows objectives
- [ ] Quest completed notification displays

### AC-3.0c-8: Unit Tests
- [ ] ~25 unit tests implemented
- [ ] All tests pass
- [ ] Tests cover all objective types
- [ ] Tests cover edge cases

---

## 15. Deliverable Checklist

### Application Layer
- [ ] `Interfaces/IQuestProgressService.cs`
- [ ] `Services/QuestProgressService.cs`
- [ ] `ValueObjects/QuestProgressResult.cs`
- [ ] `ValueObjects/ObjectiveProgressUpdate.cs`
- [ ] `DTOs/QuestAcceptedNotificationDto.cs`
- [ ] `DTOs/QuestCompletedNotificationDto.cs`

### Domain Layer
- [ ] `Enums/OutcomeType.cs` updates (StartQuest, TurnInQuest)

### Service Integration
- [ ] `CombatService.cs` updates (monster defeat integration)
- [ ] `InventoryService.cs` updates (item pickup integration)
- [ ] `MovementService.cs` or room handling updates
- [ ] `DialogueService.cs` updates (quest outcomes)

### Presentation Layer
- [ ] `Interfaces/IGameRenderer.cs` updates (notification methods)
- [ ] `ConsoleRenderer.cs` updates (notification rendering)

### Configuration
- [ ] Dialogue configuration updates for quest outcomes

### Tests
- [ ] `Application.Tests/Services/QuestProgressServiceTests.cs`
- [ ] `Application.Tests/ValueObjects/ObjectiveProgressUpdateTests.cs`
- [ ] `Application.Tests/Integration/DialogueQuestIntegrationTests.cs`

### Documentation
- [ ] XML documentation on all public members
- [ ] Updated dialogue configuration examples

---

## 16. Dependencies

### Required from v0.3.0b
| Type | Location | Usage |
|------|----------|-------|
| IQuestService | Application/Interfaces | Quest queries and operations |
| QuestService | Application/Services | Quest management |
| Quest | Domain/Entities | Quest state access |
| QuestObjective | Domain/Entities | Progress tracking |
| ObjectiveType | Domain/Enums | Objective type matching |
| ObjectiveTarget | Domain/ValueObjects | Target matching |

### Required from Existing Infrastructure
| Type | Location | Usage |
|------|----------|-------|
| CombatService | Application/Services | Monster defeat events |
| DialogueService | Application/Services | Dialogue outcomes |
| IGameRenderer | Presentation/Interfaces | Notification display |
| Player | Domain/Entities | Player state |
| Monster | Domain/Entities | Monster type info |
| Item | Domain/Entities | Item ID info |
| Room | Domain/Entities | Room ID info |
| NPC | Domain/Entities | NPC ID info |
| OutcomeType | Domain/Enums | Dialogue outcomes |

### Provides to v0.3.1 (Quest Rewards)
| Type | Usage |
|------|-------|
| Quest completion flow | Trigger reward distribution |
| Turn-in dialogue | Display rewards |
| QuestCompletedNotification | Include rewards |

---

## 17. Future Considerations

### Deferred to v0.3.1
- **Quest Rewards**: XP, gold, items on completion
- **Reward Display**: Show rewards in completion notification
- **Prerequisite Checking**: Block quests until prerequisites met

### Deferred to v0.3.2
- **Quest Chains**: Auto-offer next quest on completion
- **Time Limits**: Fail quests after time expires
- **Failure Conditions**: Custom failure triggers

### Deferred to Future Versions
- **Deliver Objective Improvements**: Track both NPC and item
- **Use Objective Tracking**: Track item/ability usage
- **Custom Objective Events**: Scripted objective completion
- **Progress Persistence**: Save/load quest progress
- **Objective Discovery**: Reveal hidden objectives on partial progress

### Out of Scope
- **Procedural Quest Generation**: Dynamic quest creation
- **Shared Quest Progress**: Multi-player quest tracking
- **Quest Abandonment**: Cancel active quests

---

*Document Version: 1.0*
*Last Updated: 2024-01-20*
*Author: Claude Code*
