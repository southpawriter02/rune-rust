# v0.18.1e Design Specification: Configuration & Persistence

**Version:** 0.18.1e
**Parent:** v0.18.1 (Runic Blight Corruption)
**Prerequisites:** v0.18.1a-d Complete (Enums, Entity, Interface, Service)
**Status:** Design Complete
**Estimated Unit Tests:** ~3

---

## Table of Contents

1. [Executive Summary](#1-executive-summary)
2. [Feature Overview](#2-feature-overview)
3. [Architecture Diagrams](#3-architecture-diagrams)
4. [User Stories](#4-user-stories)
5. [JSON Schema Definition](#5-json-schema-definition)
6. [Configuration File](#6-configuration-file)
7. [Database Schema](#7-database-schema)
8. [DTO Definitions](#8-dto-definitions)
9. [Repository Implementation](#9-repository-implementation)
10. [Logging Specifications](#10-logging-specifications)
11. [Unit Testing Requirements](#11-unit-testing-requirements)
12. [Use Cases](#12-use-cases)
13. [Deliverable Checklist](#13-deliverable-checklist)
14. [Acceptance Criteria](#14-acceptance-criteria)
15. [Dependencies](#15-dependencies)
16. [Future Considerations](#16-future-considerations)

---

## 1. Executive Summary

This design specification defines the JSON configuration infrastructure and database persistence for the Runic Blight Corruption system, including schema validation, corruption source definitions, penalty formulas, and history tracking.

v0.18.1e establishes the **data-driven foundation** that allows:

- Game designers to define corruption costs without code changes
- Threshold effects to be configured per milestone
- Complete corruption history for analytics and debugging
- Persistence of corruption tracker state across sessions

### Key Deliverables

| Category                | Items                                                       |
| ----------------------- | ----------------------------------------------------------- |
| **Configuration Files** | `config/corruption-sources.json`                            |
| **JSON Schemas**        | `config/schemas/corruption-sources.schema.json`             |
| **Database Migrations** | `character_corruption`, `corruption_history` tables         |
| **Repository**          | `CorruptionRepository` implementing `ICorruptionRepository` |
| **Tests**               | ~3 schema validation tests                                  |

### Configuration Summary

| Config Section      | Purpose                                    |
| ------------------- | ------------------------------------------ |
| `corruptionSources` | Categorized sources with corruption ranges |
| `thresholdEffects`  | Effects triggered at 25/50/75/100          |
| `penalties`         | Formulas for HP/AP/Resolve penalties       |

### Database Summary

| Table                  | Purpose                                |
| ---------------------- | -------------------------------------- |
| `character_corruption` | Current corruption state per character |
| `corruption_history`   | Audit log of all corruption changes    |

---

## 2. Feature Overview

```
v0.18.1e Features
└── Corruption Configuration & Persistence
    │
    ├── JSON SCHEMA (corruption-sources.schema.json)
    │   ├── CorruptionSourceDefinition — id, min/max corruption, etc.
    │   ├── ThresholdEffect — description, effects
    │   └── PenaltyFormula — HP/AP/Resolve calculations
    │
    ├── CONFIGURATION FILE (corruption-sources.json)
    │   ├── corruptionSources
    │   │   ├── mysticMagic[] — Spell casting, overcasting
    │   │   ├── hereticalAbility[] — Berserker, Blót-Priest, Seiðkona
    │   │   ├── environmental[] — Blight zones, Forlorn contact
    │   │   └── items[] — Glitched artifacts, corrupted consumables
    │   ├── thresholdEffects
    │   │   ├── 25 — UI warning
    │   │   ├── 50 — Faction lock
    │   │   ├── 75 — Machine Affinity trauma
    │   │   └── 100 — Terminal Error
    │   └── penalties
    │       ├── maxHpPercent
    │       ├── maxApPercent
    │       └── resolveDice
    │
    ├── DATABASE TABLES
    │   ├── character_corruption — Per-character state
    │   └── corruption_history — Audit log
    │
    └── INFRASTRUCTURE
        └── CorruptionRepository (ICorruptionRepository impl)
```

---

## 3. Architecture Diagrams

### 3.1 Configuration Layer Diagram

```
┌─────────────────────────────────────────────────────────────────────────┐
│                           CONFIG LAYER                                  │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │          config/schemas/corruption-sources.schema.json          │   │
│  │                    (JSON Schema Draft-07)                        │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                               │ validates                              │
│                               ▼                                         │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │                config/corruption-sources.json                    │   │
│  │                    (Game Configuration)                          │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                               │                                         │
└───────────────────────────────┼─────────────────────────────────────────┘
                                │
                                │ loads via IConfigurationProvider
                                ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                       APPLICATION LAYER                                 │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │                  CorruptionConfiguration                         │   │
│  ├─────────────────────────────────────────────────────────────────┤   │
│  │  + CorruptionSources: CorruptionSourceCategories                │   │
│  │  + ThresholdEffects: Dictionary<int, ThresholdEffect>           │   │
│  │  + Penalties: PenaltyFormulas                                   │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                               │                                         │
│                               │ used by                                 │
│                               ▼                                         │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │                    CorruptionService                             │   │
│  │        (Configuration-aware corruption operations)               │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

### 3.2 Database Persistence Diagram

```
┌─────────────────────────────────────────────────────────────────────────┐
│                       PERSISTENCE ARCHITECTURE                          │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  APPLICATION LAYER                                                      │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │                    CorruptionService                             │   │
│  └────────────────────────────┬────────────────────────────────────┘   │
│                               │                                         │
│                               │ uses                                    │
│                               ▼                                         │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │               ICorruptionRepository (Interface)                  │   │
│  ├─────────────────────────────────────────────────────────────────┤   │
│  │  + GetByCharacterId(Guid): CorruptionTracker?                   │   │
│  │  + Add(CorruptionTracker): void                                 │   │
│  │  + Update(CorruptionTracker): void                              │   │
│  │  + Delete(Guid): void                                           │   │
│  │  + AddHistoryEntry(CorruptionHistoryEntry): void                │   │
│  │  + GetHistory(Guid, int?, int?): IEnumerable<...>               │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                               △                                         │
│                               │ implements                              │
│                               │                                         │
│  INFRASTRUCTURE LAYER                                                   │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │                   CorruptionRepository                           │   │
│  │        (EF Core implementation with history tracking)            │   │
│  └────────────────────────────┬────────────────────────────────────┘   │
│                               │                                         │
│                               │ persists to                             │
│                               ▼                                         │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │                         DATABASE                                 │   │
│  ├───────────────────────┬─────────────────────────────────────────┤   │
│  │  character_corruption │          corruption_history             │   │
│  │  ┌─────────────────┐  │  ┌───────────────────────────────────┐  │   │
│  │  │ character_id PK │  │  │ id PK SERIAL                      │  │   │
│  │  │ current_corrupt │  │  │ character_id FK                   │  │   │
│  │  │ threshold_25    │  │  │ amount                            │  │   │
│  │  │ threshold_50    │  │  │ source                            │  │   │
│  │  │ threshold_75    │  │  │ new_total                         │  │   │
│  │  │ updated_at      │  │  │ threshold_crossed                 │  │   │
│  │  └─────────────────┘  │  │ is_transfer                       │  │   │
│  │                       │  │ transfer_target_id FK              │  │   │
│  │                       │  │ created_at                         │  │   │
│  │                       │  └───────────────────────────────────┘  │   │
│  └───────────────────────┴─────────────────────────────────────────┘   │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

### 3.3 Schema Structure Diagram

```
corruption-sources.schema.json
│
├── $schema: "http://json-schema.org/draft-07/schema#"
├── $id: "corruption-sources.schema.json"
├── title: "Corruption Sources Configuration"
│
├── properties
│   │
│   ├── $schema (string)
│   ├── version (string, pattern: "^\d+\.\d+$")
│   │
│   ├── corruptionSources (object)
│   │   ├── mysticMagic: CorruptionSourceDefinition[]
│   │   ├── hereticalAbility: CorruptionSourceDefinition[]
│   │   ├── environmental: CorruptionSourceDefinition[]
│   │   └── items: CorruptionSourceDefinition[]
│   │
│   ├── thresholdEffects (object)
│   │   ├── "25": ThresholdEffect
│   │   ├── "50": ThresholdEffect
│   │   ├── "75": ThresholdEffect
│   │   └── "100": ThresholdEffect
│   │
│   └── penalties (object)
│       ├── maxHpPercent: PenaltyFormula
│       ├── maxApPercent: PenaltyFormula
│       └── resolveDice: PenaltyFormula
│
└── definitions
    │
    ├── CorruptionSourceDefinition
    │   ├── id (string, pattern: "^[a-z][a-z0-9-]*$")
    │   ├── name (string)
    │   ├── minCorruption (integer, 0-100, optional)
    │   ├── maxCorruption (integer, 1-100, optional)
    │   ├── fixedCorruption (integer, 1-100, optional)
    │   ├── corruptionPerHp (integer, optional)
    │   └── perExposure (boolean, optional)
    │
    ├── ThresholdEffect
    │   ├── description (string)
    │   ├── uiWarning (boolean, optional)
    │   ├── factionLock (boolean, optional)
    │   ├── traumaId (string, optional)
    │   └── terminalError (boolean, optional)
    │
    └── PenaltyFormula
        └── formula (string)
```

### 3.4 Corruption Source Categories Diagram

```
┌─────────────────────────────────────────────────────────────────────────┐
│                     CORRUPTION SOURCE CATEGORIES                         │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                          │
│  MYSTIC MAGIC                              HERETICAL ABILITY             │
│  ┌───────────────────────────────┐         ┌──────────────────────────┐ │
│  │ standard-spell     (0-2)      │         │ berserker-rage   (2-5)   │ │
│  │ powerful-spell     (3-5)      │         │ blot-priest-hp   (1/HP)  │ │
│  │ overcasting        (10-15)    │         │ blot-priest-siphon (1)   │ │
│  │                               │         │ seidkona-divin   (3-8)   │ │
│  └───────────────────────────────┘         └──────────────────────────┘ │
│                                                                          │
│  ENVIRONMENTAL                             ITEMS                         │
│  ┌───────────────────────────────┐         ┌──────────────────────────┐ │
│  │ blight-zone        (1-3/exp)  │         │ glitched-artifact (1-5)  │ │
│  │ forlorn-contact    (5-10)     │         │ corrupted-consume (2-5)  │ │
│  │                               │         │                          │ │
│  └───────────────────────────────┘         └──────────────────────────┘ │
│                                                                          │
│  Legend:                                                                 │
│    (X-Y)   = Range corruption (random between X and Y)                   │
│    (X/HP)  = Scales with HP spent                                        │
│    (X)     = Fixed corruption amount                                     │
│    (X/exp) = Per exposure (environmental)                                │
│                                                                          │
└─────────────────────────────────────────────────────────────────────────┘
```

### 3.5 Entity-Table Mapping

```
┌─────────────────────────────────────────────────────────────────────────┐
│                     DOMAIN TO DATABASE MAPPING                           │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                          │
│  CorruptionTracker (Entity)            character_corruption (Table)      │
│  ┌─────────────────────────────┐       ┌────────────────────────────┐   │
│  │ Id: Guid                    │  ──►  │ character_id: UUID PK      │   │
│  │ CharacterId: Guid           │       │                            │   │
│  │ CurrentCorruption: int      │  ──►  │ current_corruption: INT    │   │
│  │ Threshold25Triggered: bool  │  ──►  │ threshold_25_triggered     │   │
│  │ Threshold50Triggered: bool  │  ──►  │ threshold_50_triggered     │   │
│  │ Threshold75Triggered: bool  │  ──►  │ threshold_75_triggered     │   │
│  │ UpdatedAt: DateTime         │  ──►  │ updated_at: TIMESTAMP      │   │
│  └─────────────────────────────┘       └────────────────────────────┘   │
│                                                                          │
│  CorruptionHistoryEntry (VO)           corruption_history (Table)        │
│  ┌─────────────────────────────┐       ┌────────────────────────────┐   │
│  │ Id: int                     │  ──►  │ id: SERIAL PK              │   │
│  │ CharacterId: Guid           │  ──►  │ character_id: UUID FK      │   │
│  │ Amount: int                 │  ──►  │ amount: INT                │   │
│  │ Source: CorruptionSource    │  ──►  │ source: VARCHAR(50)        │   │
│  │ NewTotal: int               │  ──►  │ new_total: INT             │   │
│  │ ThresholdCrossed: int?      │  ──►  │ threshold_crossed: INT     │   │
│  │ IsTransfer: bool            │  ──►  │ is_transfer: BOOLEAN       │   │
│  │ TransferTargetId: Guid?     │  ──►  │ transfer_target_id: UUID   │   │
│  │ CreatedAt: DateTime         │  ──►  │ created_at: TIMESTAMP      │   │
│  └─────────────────────────────┘       └────────────────────────────┘   │
│                                                                          │
└─────────────────────────────────────────────────────────────────────────┘
```

---

## 4. User Stories

### US-18.1e-1: Define Corruption Sources

**As a** game designer
**I want to** define corruption-inducing events in configuration
**So that** I can balance corruption costs without code changes

**Acceptance Criteria:**

- Each corruption source has ID, name, and corruption amount
- Sources support fixed, range, and per-HP corruption types
- Schema validates all required fields

### US-18.1e-2: Configure Threshold Effects

**As a** game designer
**I want to** configure effects triggered at corruption thresholds
**So that** milestone moments are customizable

**Acceptance Criteria:**

- Thresholds at 25, 50, 75, and 100 are configurable
- Each threshold can trigger UI warnings, faction lock, or trauma
- Terminal Error at 100 is clearly marked

### US-18.1e-3: Persist Corruption State

**As a** player
**I want to** have my corruption state saved between sessions
**So that** my progress is not lost

**Acceptance Criteria:**

- Corruption tracker persists to database
- Threshold trigger flags are preserved
- State loads correctly on session resume

### US-18.1e-4: Track Corruption History

**As a** developer
**I want to** log all corruption changes to history
**So that** I can debug and analyze corruption patterns

**Acceptance Criteria:**

- Every corruption change creates history entry
- History includes source and new total
- Transfers are tracked with target character ID

---

## 5. JSON Schema Definition

### 5.1 Schema File

**File:** `config/schemas/corruption-sources.schema.json`

```json
{
    "$schema": "http://json-schema.org/draft-07/schema#",
    "$id": "corruption-sources.schema.json",
    "title": "Corruption Sources Configuration",
    "description": "Configuration schema for Runic Blight Corruption sources, thresholds, and penalties.",
    "type": "object",
    "required": [
        "version",
        "corruptionSources",
        "thresholdEffects",
        "penalties"
    ],
    "properties": {
        "$schema": {
            "type": "string",
            "description": "Reference to this schema file."
        },
        "version": {
            "type": "string",
            "pattern": "^\\d+\\.\\d+$",
            "description": "Configuration version in MAJOR.MINOR format."
        },
        "corruptionSources": {
            "type": "object",
            "description": "Corruption sources organized by category.",
            "properties": {
                "mysticMagic": {
                    "type": "array",
                    "description": "Corruption from mystic magic and spellcasting.",
                    "items": {
                        "$ref": "#/definitions/CorruptionSourceDefinition"
                    }
                },
                "hereticalAbility": {
                    "type": "array",
                    "description": "Corruption from specialization heretical abilities.",
                    "items": {
                        "$ref": "#/definitions/CorruptionSourceDefinition"
                    }
                },
                "environmental": {
                    "type": "array",
                    "description": "Corruption from environmental exposure and hazards.",
                    "items": {
                        "$ref": "#/definitions/CorruptionSourceDefinition"
                    }
                },
                "items": {
                    "type": "array",
                    "description": "Corruption from using corrupted or glitched items.",
                    "items": {
                        "$ref": "#/definitions/CorruptionSourceDefinition"
                    }
                }
            },
            "additionalProperties": false
        },
        "thresholdEffects": {
            "type": "object",
            "description": "Effects triggered when corruption crosses specific thresholds.",
            "properties": {
                "25": { "$ref": "#/definitions/ThresholdEffect" },
                "50": { "$ref": "#/definitions/ThresholdEffect" },
                "75": { "$ref": "#/definitions/ThresholdEffect" },
                "100": { "$ref": "#/definitions/ThresholdEffect" }
            },
            "required": ["25", "50", "75", "100"],
            "additionalProperties": false
        },
        "penalties": {
            "type": "object",
            "description": "Penalty calculation formulas.",
            "required": ["maxHpPercent", "maxApPercent", "resolveDice"],
            "properties": {
                "maxHpPercent": { "$ref": "#/definitions/PenaltyFormula" },
                "maxApPercent": { "$ref": "#/definitions/PenaltyFormula" },
                "resolveDice": { "$ref": "#/definitions/PenaltyFormula" }
            },
            "additionalProperties": false
        }
    },
    "additionalProperties": false,
    "definitions": {
        "CorruptionSourceDefinition": {
            "type": "object",
            "description": "Definition of a single corruption source.",
            "required": ["id", "name"],
            "properties": {
                "id": {
                    "type": "string",
                    "pattern": "^[a-z][a-z0-9-]*$",
                    "description": "Unique identifier in kebab-case format."
                },
                "name": {
                    "type": "string",
                    "description": "Display name for the corruption source."
                },
                "minCorruption": {
                    "type": "integer",
                    "minimum": 0,
                    "maximum": 100,
                    "description": "Minimum corruption for range sources."
                },
                "maxCorruption": {
                    "type": "integer",
                    "minimum": 1,
                    "maximum": 100,
                    "description": "Maximum corruption for range sources."
                },
                "fixedCorruption": {
                    "type": "integer",
                    "minimum": 1,
                    "maximum": 100,
                    "description": "Fixed corruption amount (mutually exclusive with min/max)."
                },
                "corruptionPerHp": {
                    "type": "integer",
                    "minimum": 1,
                    "maximum": 10,
                    "description": "Corruption gained per HP spent (for sacrificial abilities)."
                },
                "perExposure": {
                    "type": "boolean",
                    "description": "If true, corruption applies per exposure (environmental)."
                }
            },
            "additionalProperties": false
        },
        "ThresholdEffect": {
            "type": "object",
            "description": "Effect triggered when a corruption threshold is crossed.",
            "required": ["description"],
            "properties": {
                "description": {
                    "type": "string",
                    "description": "Narrative description shown to player."
                },
                "uiWarning": {
                    "type": "boolean",
                    "description": "If true, display UI warning indicator."
                },
                "factionLock": {
                    "type": "boolean",
                    "description": "If true, lock certain faction reputation gains."
                },
                "traumaId": {
                    "type": "string",
                    "pattern": "^[a-z][a-z0-9-]*$",
                    "description": "ID of trauma to acquire at this threshold."
                },
                "terminalError": {
                    "type": "boolean",
                    "description": "If true, this threshold triggers Terminal Error check."
                }
            },
            "additionalProperties": false
        },
        "PenaltyFormula": {
            "type": "object",
            "description": "Formula for calculating a corruption penalty.",
            "required": ["formula"],
            "properties": {
                "formula": {
                    "type": "string",
                    "description": "Formula expression. Uses 'corruption' as variable."
                }
            },
            "additionalProperties": false
        }
    }
}
```

---

## 6. Configuration File

### 6.1 Configuration

**File:** `config/corruption-sources.json`

```json
{
    "$schema": "schemas/corruption-sources.schema.json",
    "version": "1.0",
    "corruptionSources": {
        "mysticMagic": [
            {
                "id": "standard-spell",
                "name": "Standard Spell",
                "minCorruption": 0,
                "maxCorruption": 2
            },
            {
                "id": "powerful-spell",
                "name": "Powerful Spell",
                "minCorruption": 3,
                "maxCorruption": 5
            },
            {
                "id": "overcasting",
                "name": "Overcasting",
                "minCorruption": 10,
                "maxCorruption": 15
            }
        ],
        "hereticalAbility": [
            {
                "id": "berserker-rage",
                "name": "Berserker Rage Abilities",
                "minCorruption": 2,
                "maxCorruption": 5
            },
            {
                "id": "blot-priest-hp-cast",
                "name": "Sacrificial Casting",
                "corruptionPerHp": 1
            },
            {
                "id": "blot-priest-siphon",
                "name": "Life Siphon",
                "fixedCorruption": 1
            },
            {
                "id": "seidkona-divination",
                "name": "Forbidden Divination",
                "minCorruption": 3,
                "maxCorruption": 8
            }
        ],
        "environmental": [
            {
                "id": "blight-zone",
                "name": "Blight Zone Exposure",
                "minCorruption": 1,
                "maxCorruption": 3,
                "perExposure": true
            },
            {
                "id": "forlorn-contact",
                "name": "Forlorn Contact",
                "minCorruption": 5,
                "maxCorruption": 10
            }
        ],
        "items": [
            {
                "id": "glitched-artifact",
                "name": "Glitched Artifact Use",
                "minCorruption": 1,
                "maxCorruption": 5
            },
            {
                "id": "corrupted-consumable",
                "name": "Corrupted Consumable",
                "minCorruption": 2,
                "maxCorruption": 5
            }
        ]
    },
    "thresholdEffects": {
        "25": {
            "description": "You feel the Blight's touch...",
            "uiWarning": true
        },
        "50": {
            "description": "Human faction reputation gains locked",
            "factionLock": true
        },
        "75": {
            "description": "Acquire [MACHINE AFFINITY] trauma",
            "traumaId": "machine-affinity"
        },
        "100": {
            "description": "Terminal Error - Character transformation",
            "terminalError": true
        }
    },
    "penalties": {
        "maxHpPercent": {
            "formula": "floor(corruption / 10) * 5"
        },
        "maxApPercent": {
            "formula": "floor(corruption / 10) * 5"
        },
        "resolveDice": {
            "formula": "floor(corruption / 20)"
        }
    }
}
```

---

## 7. Database Schema

### 7.1 Migration Script

**File:** `src/Infrastructure/RuneAndRust.Persistence/Migrations/xxxx_AddCorruptionTables.cs`

```sql
-- Character Corruption State Table
CREATE TABLE IF NOT EXISTS character_corruption (
    character_id UUID PRIMARY KEY REFERENCES characters(id) ON DELETE CASCADE,
    current_corruption INT NOT NULL DEFAULT 0
        CONSTRAINT chk_corruption_range CHECK (current_corruption >= 0 AND current_corruption <= 100),
    threshold_25_triggered BOOLEAN NOT NULL DEFAULT false,
    threshold_50_triggered BOOLEAN NOT NULL DEFAULT false,
    threshold_75_triggered BOOLEAN NOT NULL DEFAULT false,
    updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP
);

-- Corruption History Table (Audit Log)
CREATE TABLE IF NOT EXISTS corruption_history (
    id SERIAL PRIMARY KEY,
    character_id UUID NOT NULL REFERENCES characters(id) ON DELETE CASCADE,
    amount INT NOT NULL,
    source VARCHAR(50) NOT NULL,
    new_total INT NOT NULL,
    threshold_crossed INT,
    is_transfer BOOLEAN NOT NULL DEFAULT false,
    transfer_target_id UUID REFERENCES characters(id),
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP
);

-- Indexes for efficient querying
CREATE INDEX idx_corruption_history_char ON corruption_history(character_id);
CREATE INDEX idx_corruption_history_time ON corruption_history(created_at);
CREATE INDEX idx_corruption_history_transfer ON corruption_history(is_transfer) WHERE is_transfer = true;
```

### 7.2 Table Specifications

#### character_corruption

| Column                   | Type      | Constraints                      | Description                       |
| ------------------------ | --------- | -------------------------------- | --------------------------------- |
| `character_id`           | UUID      | PK, FK(characters.id) ON DELETE  | Character this tracker belongs to |
| `current_corruption`     | INT       | NOT NULL, DEFAULT 0, CHECK 0-100 | Current corruption value          |
| `threshold_25_triggered` | BOOLEAN   | NOT NULL, DEFAULT false          | Has 25% threshold been crossed?   |
| `threshold_50_triggered` | BOOLEAN   | NOT NULL, DEFAULT false          | Has 50% threshold been crossed?   |
| `threshold_75_triggered` | BOOLEAN   | NOT NULL, DEFAULT false          | Has 75% threshold been crossed?   |
| `updated_at`             | TIMESTAMP | NOT NULL, DEFAULT CURRENT        | Last modification timestamp       |

#### corruption_history

| Column               | Type        | Constraints                 | Description                               |
| -------------------- | ----------- | --------------------------- | ----------------------------------------- |
| `id`                 | SERIAL      | PK                          | Auto-incrementing history ID              |
| `character_id`       | UUID        | NOT NULL, FK(characters.id) | Character this entry belongs to           |
| `amount`             | INT         | NOT NULL                    | Corruption amount (+ or -)                |
| `source`             | VARCHAR(50) | NOT NULL                    | CorruptionSource enum string              |
| `new_total`          | INT         | NOT NULL                    | Corruption value after this change        |
| `threshold_crossed`  | INT         | NULL                        | Threshold value if crossed (25/50/75/100) |
| `is_transfer`        | BOOLEAN     | NOT NULL, DEFAULT false     | True if this was a transfer               |
| `transfer_target_id` | UUID        | NULL, FK(characters.id)     | Target of transfer (if applicable)        |
| `created_at`         | TIMESTAMP   | NOT NULL, DEFAULT CURRENT   | When this change occurred                 |

---

## 8. DTO Definitions

### 8.1 CorruptionSourceDefinitionDto

**File:** `src/Core/RuneAndRust.Application/DTOs/CorruptionSourceDefinitionDto.cs`

```csharp
namespace RuneAndRust.Application.DTOs;

/// <summary>
/// Data transfer object for corruption source configuration.
/// </summary>
public record CorruptionSourceDefinitionDto
{
    /// <summary>Unique identifier in kebab-case.</summary>
    public required string Id { get; init; }

    /// <summary>Display name of the corruption source.</summary>
    public required string Name { get; init; }

    /// <summary>Minimum corruption for range-based sources.</summary>
    public int? MinCorruption { get; init; }

    /// <summary>Maximum corruption for range-based sources.</summary>
    public int? MaxCorruption { get; init; }

    /// <summary>Fixed corruption amount (if not using range).</summary>
    public int? FixedCorruption { get; init; }

    /// <summary>Corruption per HP spent (for sacrificial abilities).</summary>
    public int? CorruptionPerHp { get; init; }

    /// <summary>If true, applies per exposure (environmental).</summary>
    public bool PerExposure { get; init; }
}
```

### 8.2 ThresholdEffectDto

**File:** `src/Core/RuneAndRust.Application/DTOs/ThresholdEffectDto.cs`

```csharp
namespace RuneAndRust.Application.DTOs;

/// <summary>
/// Data transfer object for threshold effect configuration.
/// </summary>
public record ThresholdEffectDto
{
    /// <summary>Narrative description shown to player.</summary>
    public required string Description { get; init; }

    /// <summary>If true, display UI warning indicator.</summary>
    public bool UiWarning { get; init; }

    /// <summary>If true, lock certain faction reputation gains.</summary>
    public bool FactionLock { get; init; }

    /// <summary>ID of trauma to acquire (if any).</summary>
    public string? TraumaId { get; init; }

    /// <summary>If true, triggers Terminal Error check.</summary>
    public bool TerminalError { get; init; }
}
```

### 8.3 CorruptionHistoryEntryDto

**File:** `src/Core/RuneAndRust.Application/DTOs/CorruptionHistoryEntryDto.cs`

```csharp
namespace RuneAndRust.Application.DTOs;

using RuneAndRust.Domain.Enums;

/// <summary>
/// Data transfer object for corruption history entries.
/// </summary>
public record CorruptionHistoryEntryDto
{
    /// <summary>Unique entry ID.</summary>
    public int Id { get; init; }

    /// <summary>Character this entry belongs to.</summary>
    public Guid CharacterId { get; init; }

    /// <summary>Amount of corruption change (positive = gained, negative = removed).</summary>
    public int Amount { get; init; }

    /// <summary>Source of the corruption change.</summary>
    public CorruptionSource Source { get; init; }

    /// <summary>Corruption value after this change.</summary>
    public int NewTotal { get; init; }

    /// <summary>Threshold crossed by this change, if any.</summary>
    public int? ThresholdCrossed { get; init; }

    /// <summary>True if this was a transfer operation.</summary>
    public bool IsTransfer { get; init; }

    /// <summary>Target character ID if this was a transfer.</summary>
    public Guid? TransferTargetId { get; init; }

    /// <summary>When this change occurred.</summary>
    public DateTime CreatedAt { get; init; }
}
```

### 8.4 CorruptionConfigurationDto

**File:** `src/Core/RuneAndRust.Application/DTOs/CorruptionConfigurationDto.cs`

```csharp
namespace RuneAndRust.Application.DTOs;

/// <summary>
/// Root DTO for corruption configuration loading.
/// </summary>
public record CorruptionConfigurationDto
{
    /// <summary>Configuration version.</summary>
    public required string Version { get; init; }

    /// <summary>Corruption sources by category.</summary>
    public required CorruptionSourceCategoriesDto CorruptionSources { get; init; }

    /// <summary>Effects triggered at corruption thresholds.</summary>
    public required Dictionary<string, ThresholdEffectDto> ThresholdEffects { get; init; }

    /// <summary>Penalty calculation formulas.</summary>
    public required PenaltyFormulasDto Penalties { get; init; }
}

/// <summary>
/// Corruption source categories container.
/// </summary>
public record CorruptionSourceCategoriesDto
{
    public List<CorruptionSourceDefinitionDto> MysticMagic { get; init; } = [];
    public List<CorruptionSourceDefinitionDto> HereticalAbility { get; init; } = [];
    public List<CorruptionSourceDefinitionDto> Environmental { get; init; } = [];
    public List<CorruptionSourceDefinitionDto> Items { get; init; } = [];
}

/// <summary>
/// Penalty formula definitions.
/// </summary>
public record PenaltyFormulasDto
{
    public required FormulaDto MaxHpPercent { get; init; }
    public required FormulaDto MaxApPercent { get; init; }
    public required FormulaDto ResolveDice { get; init; }
}

/// <summary>
/// Single formula definition.
/// </summary>
public record FormulaDto
{
    public required string Formula { get; init; }
}
```

---

## 9. Repository Implementation

### 9.1 ICorruptionRepository Interface

**File:** `src/Core/RuneAndRust.Application/Interfaces/ICorruptionRepository.cs`

```csharp
namespace RuneAndRust.Application.Interfaces;

using RuneAndRust.Domain.Entities;

/// <summary>
/// Repository interface for corruption tracker persistence.
/// </summary>
public interface ICorruptionRepository
{
    /// <summary>
    /// Gets a corruption tracker by character ID.
    /// </summary>
    /// <param name="characterId">The character's unique identifier.</param>
    /// <returns>The tracker, or null if not found.</returns>
    CorruptionTracker? GetByCharacterId(Guid characterId);

    /// <summary>
    /// Adds a new corruption tracker.
    /// </summary>
    void Add(CorruptionTracker tracker);

    /// <summary>
    /// Updates an existing corruption tracker.
    /// </summary>
    void Update(CorruptionTracker tracker);

    /// <summary>
    /// Deletes a corruption tracker.
    /// </summary>
    void Delete(Guid characterId);

    /// <summary>
    /// Adds a history entry for a corruption change.
    /// </summary>
    void AddHistoryEntry(CorruptionHistoryEntry entry);

    /// <summary>
    /// Gets corruption history for a character.
    /// </summary>
    /// <param name="characterId">The character's unique identifier.</param>
    /// <param name="limit">Maximum entries to return (null = all).</param>
    /// <param name="offset">Number of entries to skip.</param>
    /// <returns>History entries ordered by newest first.</returns>
    IEnumerable<CorruptionHistoryEntry> GetHistory(
        Guid characterId,
        int? limit = null,
        int? offset = null);
}
```

### 9.2 CorruptionRepository Implementation

**File:** `src/Infrastructure/RuneAndRust.Persistence/Repositories/CorruptionRepository.cs`

```csharp
namespace RuneAndRust.Persistence.Repositories;

using Microsoft.EntityFrameworkCore;
using Microsoft.Extensions.Logging;
using RuneAndRust.Application.Interfaces;
using RuneAndRust.Domain.Entities;

/// <summary>
/// EF Core implementation of corruption tracker repository.
/// </summary>
public class CorruptionRepository : ICorruptionRepository
{
    private readonly GameDbContext _context;
    private readonly ILogger<CorruptionRepository> _logger;

    public CorruptionRepository(
        GameDbContext context,
        ILogger<CorruptionRepository> logger)
    {
        _context = context;
        _logger = logger;
    }

    /// <inheritdoc/>
    public CorruptionTracker? GetByCharacterId(Guid characterId)
    {
        var tracker = _context.CorruptionTrackers
            .FirstOrDefault(t => t.CharacterId == characterId);

        _logger.LogDebug(
            "Retrieved corruption tracker for {CharacterId}: {Found}",
            characterId, tracker != null);

        return tracker;
    }

    /// <inheritdoc/>
    public void Add(CorruptionTracker tracker)
    {
        _context.CorruptionTrackers.Add(tracker);
        _context.SaveChanges();

        _logger.LogInformation(
            "Created corruption tracker for {CharacterId}",
            tracker.CharacterId);
    }

    /// <inheritdoc/>
    public void Update(CorruptionTracker tracker)
    {
        _context.CorruptionTrackers.Update(tracker);
        _context.SaveChanges();

        _logger.LogDebug(
            "Updated corruption tracker for {CharacterId}: {Corruption}",
            tracker.CharacterId, tracker.CurrentCorruption);
    }

    /// <inheritdoc/>
    public void Delete(Guid characterId)
    {
        var tracker = GetByCharacterId(characterId);
        if (tracker != null)
        {
            _context.CorruptionTrackers.Remove(tracker);
            _context.SaveChanges();

            _logger.LogInformation(
                "Deleted corruption tracker for {CharacterId}",
                characterId);
        }
    }

    /// <inheritdoc/>
    public void AddHistoryEntry(CorruptionHistoryEntry entry)
    {
        _context.CorruptionHistory.Add(entry);
        _context.SaveChanges();

        _logger.LogDebug(
            "Added corruption history: {CharacterId} {Amount:+#;-#;0} [{Source}] → {NewTotal}",
            entry.CharacterId, entry.Amount, entry.Source, entry.NewTotal);
    }

    /// <inheritdoc/>
    public IEnumerable<CorruptionHistoryEntry> GetHistory(
        Guid characterId,
        int? limit = null,
        int? offset = null)
    {
        var query = _context.CorruptionHistory
            .Where(h => h.CharacterId == characterId)
            .OrderByDescending(h => h.CreatedAt);

        if (offset.HasValue)
            query = (IOrderedQueryable<CorruptionHistoryEntry>)query.Skip(offset.Value);

        if (limit.HasValue)
            query = (IOrderedQueryable<CorruptionHistoryEntry>)query.Take(limit.Value);

        return query.ToList();
    }
}
```

---

## 10. Logging Specifications

### 10.1 Configuration Logging

| Event                    | Level       | Template                                                       |
| ------------------------ | ----------- | -------------------------------------------------------------- |
| Config Loaded            | Information | `"Loaded corruption config v{Version}: {SourceCount} sources"` |
| Schema Validated         | Debug       | `"Corruption config schema validation passed"`                 |
| Schema Validation Failed | Error       | `"Corruption config validation failed: {Errors}"`              |

### 10.2 Repository Logging

| Event             | Level       | Template                                                       |
| ----------------- | ----------- | -------------------------------------------------------------- |
| Tracker Retrieved | Debug       | `"Retrieved corruption tracker for {CharacterId}: {Found}"`    |
| Tracker Created   | Information | `"Created corruption tracker for {CharacterId}"`               |
| Tracker Updated   | Debug       | `"Updated corruption tracker for {CharacterId}: {Corruption}"` |
| Tracker Deleted   | Information | `"Deleted corruption tracker for {CharacterId}"`               |
| History Added     | Debug       | `"Added corruption history: {CharacterId} {Amount} → {Total}"` |

---

## 11. Unit Testing Requirements

### 11.1 Test Count

| Feature           | Test Count |
| ----------------- | ---------- |
| Schema Validation | ~2         |
| Repository        | ~1         |
| **Total**         | **~3**     |

### 11.2 CorruptionSourcesSchemaTests

**File:** `tests/RuneAndRust.Infrastructure.UnitTests/Schemas/CorruptionSourcesSchemaTests.cs`

```csharp
namespace RuneAndRust.Infrastructure.UnitTests.Schemas;

using FluentAssertions;
using NUnit.Framework;
using Newtonsoft.Json.Linq;
using Newtonsoft.Json.Schema;

[TestFixture]
public class CorruptionSourcesSchemaTests
{
    private JSchema _schema = null!;

    [SetUp]
    public void SetUp()
    {
        var schemaPath = Path.Combine(
            TestContext.CurrentContext.TestDirectory,
            "../../../../config/schemas/corruption-sources.schema.json");
        var schemaText = File.ReadAllText(schemaPath);
        _schema = JSchema.Parse(schemaText);
    }

    [Test]
    public void Schema_ValidatesProductionConfig()
    {
        // Arrange
        var configPath = Path.Combine(
            TestContext.CurrentContext.TestDirectory,
            "../../../../config/corruption-sources.json");
        var configText = File.ReadAllText(configPath);
        var config = JObject.Parse(configText);

        // Act
        var isValid = config.IsValid(_schema, out IList<string> errors);

        // Assert
        isValid.Should().BeTrue(
            $"Production config should validate. Errors: {string.Join(", ", errors)}");
    }

    [Test]
    public void Schema_RejectsInvalidCorruptionRange()
    {
        // Arrange
        var invalidConfig = JObject.Parse(@"{
            ""version"": ""1.0"",
            ""corruptionSources"": {
                ""mysticMagic"": [{
                    ""id"": ""test"",
                    ""name"": ""Test"",
                    ""minCorruption"": 150
                }]
            },
            ""thresholdEffects"": {
                ""25"": { ""description"": ""Test"" },
                ""50"": { ""description"": ""Test"" },
                ""75"": { ""description"": ""Test"" },
                ""100"": { ""description"": ""Test"" }
            },
            ""penalties"": {
                ""maxHpPercent"": { ""formula"": ""test"" },
                ""maxApPercent"": { ""formula"": ""test"" },
                ""resolveDice"": { ""formula"": ""test"" }
            }
        }");

        // Act
        var isValid = invalidConfig.IsValid(_schema, out IList<string> _);

        // Assert
        isValid.Should().BeFalse("Config with minCorruption > 100 should fail validation");
    }

    [Test]
    public void Schema_EnforcesKebabCaseIds()
    {
        // Arrange
        var invalidConfig = JObject.Parse(@"{
            ""version"": ""1.0"",
            ""corruptionSources"": {
                ""mysticMagic"": [{
                    ""id"": ""InvalidCamelCase"",
                    ""name"": ""Test""
                }]
            },
            ""thresholdEffects"": {
                ""25"": { ""description"": ""Test"" },
                ""50"": { ""description"": ""Test"" },
                ""75"": { ""description"": ""Test"" },
                ""100"": { ""description"": ""Test"" }
            },
            ""penalties"": {
                ""maxHpPercent"": { ""formula"": ""test"" },
                ""maxApPercent"": { ""formula"": ""test"" },
                ""resolveDice"": { ""formula"": ""test"" }
            }
        }");

        // Act
        var isValid = invalidConfig.IsValid(_schema, out IList<string> _);

        // Assert
        isValid.Should().BeFalse("Config with non-kebab-case ID should fail validation");
    }
}
```

---

## 12. Use Cases

### UC-001: Load Corruption Configuration

**Actor:** Application Startup
**Precondition:** Application is starting
**Flow:**

1. Load `config/corruption-sources.json`
2. Validate against schema
3. Deserialize to `CorruptionConfigurationDto`
4. Register configuration with DI container
5. Log successful configuration load

**Postcondition:** Corruption configuration available for injection

### UC-002: Persist Corruption Change

**Actor:** CorruptionService
**Precondition:** Corruption is being added/removed
**Flow:**

1. Update `CorruptionTracker` entity
2. Call `repository.Update(tracker)`
3. Create `CorruptionHistoryEntry`
4. Call `repository.AddHistoryEntry(entry)`
5. Transaction commits

**Postcondition:** State and history persisted to database

### UC-003: Query Corruption History

**Actor:** Analytics/Debug System
**Precondition:** Character has corruption history
**Flow:**

1. Call `repository.GetHistory(characterId, limit: 50)`
2. Return list of `CorruptionHistoryEntry`
3. Display in admin panel or export for analysis

**Postcondition:** History returned for analysis

---

## 13. Deliverable Checklist

### Configuration Layer

- [x] `config/schemas/corruption-sources.schema.json`
- [x] `config/corruption-sources.json`

### Application Layer — DTOs

- [x] `src/Core/RuneAndRust.Application/DTOs/CorruptionSourceDefinitionDto.cs`
- [x] `src/Core/RuneAndRust.Application/DTOs/ThresholdEffectDto.cs`
- [x] `src/Core/RuneAndRust.Application/DTOs/CorruptionHistoryEntryDto.cs`
- [x] `src/Core/RuneAndRust.Application/DTOs/CorruptionConfigurationDto.cs`

### Application Layer — Interfaces

- [x] `src/Core/RuneAndRust.Application/Interfaces/ICorruptionRepository.cs` (extended with DeleteAsync, AddHistoryEntryAsync, GetHistoryAsync)

### Infrastructure Layer — Database

- [x] `src/Infrastructure/RuneAndRust.Infrastructure/Persistence/Configurations/CorruptionTrackerConfiguration.cs` (EF Core config, codebase convention)
- [x] `src/Infrastructure/RuneAndRust.Infrastructure/Persistence/Configurations/CorruptionHistoryEntryConfiguration.cs` (EF Core config, codebase convention)

### Infrastructure Layer — Repository

- [x] `src/Infrastructure/RuneAndRust.Infrastructure/Repositories/InMemoryCorruptionRepository.cs` (in-memory impl, codebase convention)

### Domain Layer — History Entry

- [x] `src/Core/RuneAndRust.Domain/Entities/CorruptionHistoryEntry.cs`

### Unit Tests

- [x] `tests/RuneAndRust.Infrastructure.IntegrationTests/Schemas/CorruptionSourcesSchemaTests.cs` (18 test methods, NJsonSchema — codebase convention)

### Documentation

- [x] Update scope breakdown to mark v0.18.1e complete
- [x] Update glossary.json with new entries (sortOrder 101-104)

---

## 14. Acceptance Criteria

### Schema Criteria

- [x] Schema validates production config
- [x] Schema rejects corruption values > 100
- [x] Schema rejects non-kebab-case IDs
- [x] Schema requires all threshold levels (25/50/75/100)
- [x] Schema validates penalty formula structure

### Configuration Criteria

- [x] All corruption source categories are defined
- [x] Each source has valid ID and name
- [x] Threshold effects have required properties
- [x] Penalty formulas use valid expressions

### Database Criteria

- [x] `character_corruption` table created with proper constraints (via CorruptionTrackerConfiguration)
- [x] `corruption_history` table created with proper constraints (via CorruptionHistoryEntryConfiguration)
- [x] Foreign keys reference Player entity correctly (cascade delete)
- [x] Indexes created for efficient querying (composite + IsTransfer)
- [x] Check constraint validates corruption 0-100

### Repository Criteria

- [x] `GetByCharacterIdAsync` returns tracker or null
- [x] `AddAsync` persists new tracker
- [x] `UpdateAsync` persists tracker changes
- [x] `AddHistoryEntryAsync` creates audit record
- [x] `GetHistoryAsync` returns entries in descending order

### Quality Criteria

- [x] Build succeeds with 0 errors
- [x] Build succeeds with 0 warnings
- [x] All ~3 unit tests pass (18 actual test methods across 11 sections)
- [x] XML documentation on all public types

---

## 15. Dependencies

### Required from v0.18.1a

| Type               | Usage                          |
| ------------------ | ------------------------------ |
| `CorruptionSource` | Enum for history source column |

### Required from v0.18.1b

| Type                | Usage                        |
| ------------------- | ---------------------------- |
| `CorruptionTracker` | Entity persisted to database |

### Required from v0.18.1d

| Type                | Usage                           |
| ------------------- | ------------------------------- |
| `CorruptionService` | Uses repository for persistence |

### Provides to Future Versions

| Type                       | Usage                        |
| -------------------------- | ---------------------------- |
| Configuration              | Data-driven corruption costs |
| `ICorruptionRepository`    | Persistence interface        |
| `corruption_history` table | Analytics and debugging      |

### External Dependencies

| Type                     | Version | Usage                    |
| ------------------------ | ------- | ------------------------ |
| `IConfigurationProvider` | v0.14.x | Load configuration       |
| `GameDbContext`          | v0.4.x  | EF Core database context |

---

## 16. Future Considerations

### Deferred to v0.18.5

- Stress-Corruption interaction configuration
- Combined penalty service that reads both configs

### Deferred to Future Versions

- Configuration hot-reload support
- Admin UI for editing corruption sources
- Analytics dashboard for corruption patterns
- Export corruption history to CSV

### Out of Scope

- Mutation configuration (separate system)
- Wild Magic sources (v0.20.x)
- Forlorn behavior configuration (v0.21.x)

---

_Document Version: 1.0_
_Last Updated: 2026-01-27_
