# v0.31.5 Integration Guide
## CombatEngine & Mystic Ability Integration for Alfheim

**Version:** v0.31.5
**Prerequisites:** v0.31.4 (Unit Tests Complete)
**Estimated Time:** 6-8 hours
**Status:** Ready for Implementation

---

## I. CombatEngine Integration

### **File**: `RuneAndRust.Engine/CombatEngine.cs`

### A. Add Biome Service Dependencies

**Location**: Constructor parameters (around line 28)

**Add to constructor parameters**:
```csharp
private readonly AlfheimBiomeService? _alfheimBiomeService;
private readonly NiflheimBiomeService? _niflheimBiomeService;
private readonly MuspelheimBiomeService? _muspelheimBiomeService;

public CombatEngine(
    DiceService diceService,
    SagaService sagaService,
    LootService lootService,
    EquipmentService equipmentService,
    HazardService hazardService,
    CurrencyService currencyService,
    AdvancedStatusEffectService? statusEffectService = null,
    CounterAttackService? counterAttackService = null,
    AlfheimBiomeService? alfheimBiomeService = null,          // NEW v0.31
    NiflheimBiomeService? niflheimBiomeService = null,        // NEW v0.30
    MuspelheimBiomeService? muspelheimBiomeService = null     // NEW v0.29
)
{
    _diceService = diceService;
    _sagaService = sagaService;
    _lootService = lootService;
    _equipmentService = equipmentService;
    _hazardService = hazardService;
    _currencyService = currencyService;
    _statusEffectService = statusEffectService;
    _counterAttackService = counterAttackService;
    _alfheimBiomeService = alfheimBiomeService;               // NEW v0.31
    _niflheimBiomeService = niflheimBiomeService;             // NEW v0.30
    _muspelheimBiomeService = muspelheimBiomeService;         // NEW v0.29
    // ...existing initialization
}
```

**Update Program.cs** (line ~30):
```csharp
private static CombatEngine _combatEngine = new(
    _diceService,
    _sagaService,
    _lootService,
    _equipmentService,
    _hazardService,
    _currencyService,
    _statusEffectService,
    _counterAttackService,
    _alfheimBiomeService,      // NEW v0.31
    _niflheimBiomeService,     // NEW v0.30
    _muspelheimBiomeService    // NEW v0.29
);
```

---

### B. Apply Biome-Specific Ambient Conditions

**Location**: `InitializeCombat()` method (after line 115, before `return combatState`)

**Add before `return combatState;`**:
```csharp
        // v0.31: Apply biome-specific ambient conditions
        ApplyBiomeAmbientConditions(combatState);

        return combatState;
    }

    /// <summary>
    /// v0.31: Apply ambient conditions based on current room's biome
    /// </summary>
    private void ApplyBiomeAmbientConditions(CombatState combatState)
    {
        if (combatState.CurrentRoom == null)
        {
            return;
        }

        // Get biome name from room
        // NOTE: This assumes Room has a BiomeName property
        // If not, you may need to query from database or use room metadata
        string? biomeName = combatState.CurrentRoom.BiomeName
                         ?? combatState.CurrentRoom.GetMetadata("biome");

        if (string.IsNullOrEmpty(biomeName))
        {
            return;
        }

        // Apply Alfheim ambient conditions: [Runic Instability] + [Psychic Resonance]
        if (biomeName.Equals("Alfheim", StringComparison.OrdinalIgnoreCase))
        {
            if (_alfheimBiomeService != null)
            {
                _log.Information("Applying Alfheim ambient conditions to combat");

                var characters = new List<PlayerCharacter> { combatState.Player };
                _alfheimBiomeService.InitializeCombat(characters);

                combatState.AddLogEntry("üåÄ [RUNIC INSTABILITY] - Ambient Condition Active");
                combatState.AddLogEntry("   Mystic abilities have 25% chance to trigger Wild Magic Surge");
                combatState.AddLogEntry("   Surges modify abilities randomly (¬±50% damage/range/targets/duration)");
                combatState.AddLogEntry("   Each surge applies +5 Psychic Stress");
                combatState.AddLogEntry("   Mystics gain +10% Aether Pool capacity");
                combatState.AddLogEntry("");

                combatState.AddLogEntry("üíÄ [PSYCHIC RESONANCE] - High-Intensity Stress (Ground Zero)");
                combatState.AddLogEntry("   +10 Psychic Stress at combat start");
                combatState.AddLogEntry("   +2 Psychic Stress per turn");
                combatState.AddLogEntry("   Seven billion silenced minds screaming at once...");
                combatState.AddLogEntry("");

                // Store biome flag for per-turn processing
                combatState.CombatFlags["IsAlfheim"] = true;
            }
        }
        // Apply Niflheim ambient condition: [Frigid Cold]
        else if (biomeName.Equals("Niflheim", StringComparison.OrdinalIgnoreCase))
        {
            if (_niflheimBiomeService != null)
            {
                _log.Information("Applying [Frigid Cold] ambient condition to combat");

                var characters = new List<PlayerCharacter> { combatState.Player };
                _niflheimBiomeService.ApplyFrigidColdToCombat(characters, combatState.Enemies);

                combatState.AddLogEntry("‚ùÑÔ∏è [FRIGID COLD] - Ambient Condition Active");
                combatState.AddLogEntry("   All combatants are Vulnerable to Ice damage (+50%)");
                combatState.AddLogEntry("   Critical hits inflict [Slowed] for 2 turns");
                combatState.AddLogEntry("");

                combatState.CombatFlags["IsNiflheim"] = true;
            }
        }
        // Apply Muspelheim ambient condition: [Intense Heat]
        else if (biomeName.Equals("Muspelheim", StringComparison.OrdinalIgnoreCase))
        {
            if (_muspelheimBiomeService != null)
            {
                _log.Information("Applying [Intense Heat] ambient condition to combat");

                combatState.AddLogEntry("üî• [INTENSE HEAT] - Ambient Condition Active");
                combatState.AddLogEntry("   STURDINESS checks (DC 12) at end of each turn");
                combatState.AddLogEntry("   Failure: 2d6 Fire damage");
                combatState.AddLogEntry("");

                combatState.CombatFlags["IsMuspelheim"] = true;
            }
        }
    }
```

---

### C. Process Per-Turn Psychic Resonance Stress (Alfheim)

**Location**: Start of player turn processing (search for `ProcessPlayerTurn` or turn start)

**Add at the start of each turn**:
```csharp
// v0.31: Apply Alfheim per-turn stress
if (combatState.CombatFlags.ContainsKey("IsAlfheim") &&
    combatState.CombatFlags["IsAlfheim"] is true &&
    _alfheimBiomeService != null)
{
    var characters = new List<PlayerCharacter> { combatState.Player };
    var stressResults = _alfheimBiomeService.ProcessTurnStress(characters, combatState.TurnCount);

    foreach (var result in stressResults)
    {
        combatState.AddLogEntry($"üíÄ {result.Message}");
    }
}
```

---

### D. Integrate Wild Magic Surge with Mystic Abilities

**Location**: Mystic ability execution (search for Mystic abilities like "Aetheric Bolt" or ability processing)

**Add surge check before ability execution**:
```csharp
// v0.31: Check for Wild Magic Surge in Alfheim
WildMagicSurgeResult? surge = null;
if (combatState.CombatFlags.ContainsKey("IsAlfheim") &&
    combatState.CombatFlags["IsAlfheim"] is true &&
    _alfheimBiomeService != null &&
    combatState.Player.Archetype?.Name == "Mystic")  // Check if player is Mystic
{
    surge = _alfheimBiomeService.CheckWildMagicSurge(combatState.Player, abilityName);

    if (surge != null)
    {
        combatState.AddLogEntry($"‚ö° WILD MAGIC SURGE TRIGGERED!");
        combatState.AddLogEntry($"   {surge.NarrativeText}");
        combatState.AddLogEntry($"   +5 Psychic Stress from Aetheric feedback");
    }
}

// Apply surge modifications to ability
int finalDamage = baseDamage;
int finalRange = baseRange;
int finalTargets = baseTargets;
int finalDuration = baseDuration;

if (surge != null && _alfheimBiomeService != null)
{
    finalDamage = _alfheimBiomeService.ApplySurgeToDamage(baseDamage, surge);
    finalRange = _alfheimBiomeService.ApplySurgeToRange(baseRange, surge);
    finalTargets = _alfheimBiomeService.ApplySurgeToTargets(baseTargets, surge);
    finalDuration = _alfheimBiomeService.ApplySurgeToDuration(baseDuration, surge);

    if (surge.Type == SurgeType.DamageModification && finalDamage != baseDamage)
    {
        combatState.AddLogEntry($"   Damage modified: {baseDamage} ‚Üí {finalDamage}");
    }
    else if (surge.Type == SurgeType.RangeModification && finalRange != baseRange)
    {
        combatState.AddLogEntry($"   Range modified: {baseRange} ‚Üí {finalRange} tiles");
    }
    else if (surge.Type == SurgeType.TargetModification && finalTargets != baseTargets)
    {
        combatState.AddLogEntry($"   Targets modified: {baseTargets} ‚Üí {finalTargets}");
    }
    else if (surge.Type == SurgeType.DurationModification && finalDuration != baseDuration)
    {
        combatState.AddLogEntry($"   Duration modified: {baseDuration} ‚Üí {finalDuration} turns");
    }
}

// Execute ability with modified values
ExecuteAbility(combatState, abilityName, finalDamage, finalRange, finalTargets, finalDuration);
```

---

### E. Process Reality Tear Encounters

**Location**: Movement processing when player/enemy enters a tile

**Add hazard check after movement**:
```csharp
// v0.31: Check for Reality Tear in Alfheim
if (combatState.CombatFlags.ContainsKey("IsAlfheim") &&
    combatState.CombatFlags["IsAlfheim"] is true &&
    _alfheimBiomeService != null)
{
    // Get tile at new position
    var tile = combatState.Grid.GetTileAt(newPosition);

    if (tile?.HazardType == "Reality Tear")
    {
        _log.Information("{Character} entered Reality Tear at {Position}",
            characterName, newPosition);

        // Apply Reality Tear effects
        if (isPlayer)
        {
            var tearResult = _alfheimBiomeService.ProcessRealityTearEncounter(
                combatState.Player,
                tile.Position,
                combatState.Grid
            );

            combatState.AddLogEntry($"üåÄ {tearResult.Message}");
            combatState.AddLogEntry($"   {combatState.Player.Name} takes {tearResult.EnergyDamage} Energy damage!");
            combatState.AddLogEntry($"   Warped from {tile.Position} to {tearResult.WarpedPosition}");
            combatState.AddLogEntry($"   +{tearResult.CorruptionApplied} Corruption");
            combatState.AddLogEntry($"   [Dazed] for {tearResult.DazedDuration} turn");
        }
        else
        {
            var enemy = GetEnemyByName(combatState, characterName);
            if (enemy != null)
            {
                var tearResult = _alfheimBiomeService.ProcessRealityTearEncounter(
                    enemy,
                    tile.Position,
                    combatState.Grid
                );

                combatState.AddLogEntry($"üåÄ {enemy.Name} enters Reality Tear!");
                combatState.AddLogEntry($"   Takes {tearResult.EnergyDamage} Energy damage");
                combatState.AddLogEntry($"   Warped to {tearResult.WarpedPosition}");
                combatState.AddLogEntry($"   [Dazed] for {tearResult.DazedDuration} turn");
            }
        }
    }
}
```

---

### F. Clean Up Biome Effects at Combat End

**Location**: Combat end method (search for `EndCombat` or similar)

**Add cleanup before final processing**:
```csharp
public void EndCombat(CombatState combatState)
{
    _log.Information("Combat ending");

    // v0.31: Clean up Alfheim combat effects
    if (combatState.CombatFlags.ContainsKey("IsAlfheim") &&
        combatState.CombatFlags["IsAlfheim"] is true &&
        _alfheimBiomeService != null)
    {
        var characters = new List<PlayerCharacter> { combatState.Player };
        _alfheimBiomeService.CleanupCombat(characters);

        _log.Information("Alfheim combat effects cleaned up");
    }

    // v0.30: Clean up Niflheim combat effects
    if (combatState.CombatFlags.ContainsKey("IsNiflheim") &&
        combatState.CombatFlags["IsNiflheim"] is true &&
        _niflheimBiomeService != null)
    {
        var characters = new List<PlayerCharacter> { combatState.Player };
        var stressResults = _niflheimBiomeService.ProcessCombatEndStress(characters);

        foreach (var result in stressResults)
        {
            combatState.AddLogEntry(result.Message);
        }
    }

    // ...existing combat cleanup
}
```

---

## II. Ability System Integration

### **File**: `RuneAndRust.Engine/AbilityService.cs` (or equivalent)

### A. Add Mystic Ability Identification

**Ensure all Mystic abilities are properly tagged**:
```csharp
// In ability definitions or ability service
public bool IsMysticAbility(string abilityName)
{
    var mysticAbilities = new HashSet<string>
    {
        "Aetheric Bolt",
        "Void Shield",
        "Reality Fracture",
        "Temporal Shift",
        "Psychic Lance",
        "Aetheric Pulse",
        // Add all Mystic abilities here
    };

    return mysticAbilities.Contains(abilityName);
}
```

### B. Integrate Surge Check into Ability Execution

**Wrap all Mystic ability executions with surge check**:
```csharp
public AbilityResult ExecuteMysticAbility(
    CombatState combatState,
    string abilityName,
    int baseDamage,
    int baseRange,
    int baseTargets,
    int baseDuration)
{
    // v0.31: Check for Wild Magic Surge
    WildMagicSurgeResult? surge = null;
    if (combatState.CombatFlags.ContainsKey("IsAlfheim") &&
        combatState.CombatFlags["IsAlfheim"] is true &&
        _alfheimBiomeService != null)
    {
        surge = _alfheimBiomeService.CheckWildMagicSurge(
            combatState.Player,
            abilityName
        );
    }

    // Apply surge modifications
    int finalDamage = surge != null
        ? _alfheimBiomeService.ApplySurgeToDamage(baseDamage, surge)
        : baseDamage;
    int finalRange = surge != null
        ? _alfheimBiomeService.ApplySurgeToRange(baseRange, surge)
        : baseRange;
    int finalTargets = surge != null
        ? _alfheimBiomeService.ApplySurgeToTargets(baseTargets, surge)
        : baseTargets;
    int finalDuration = surge != null
        ? _alfheimBiomeService.ApplySurgeToDuration(baseDuration, surge)
        : baseDuration;

    // Execute ability with modified values
    return ExecuteAbility(
        combatState,
        abilityName,
        finalDamage,
        finalRange,
        finalTargets,
        finalDuration
    );
}
```

---

## III. Room Model Extension

### **File**: `RuneAndRust.Core/Room.cs`

**Add BiomeName property** (if not already present):
```csharp
public class Room
{
    // ...existing properties

    /// <summary>
    /// v0.31: Biome identifier for ambient condition application
    /// </summary>
    public string? BiomeName { get; set; }

    // ...existing properties
}
```

**Or add metadata getter**:
```csharp
public string? GetMetadata(string key)
{
    // Implementation depends on existing metadata system
    // Example: return _metadata.TryGetValue(key, out var value) ? value : null;
}
```

---

## IV. CombatState Extension

### **File**: `RuneAndRust.Core/CombatState.cs`

**Add CombatFlags dictionary** (if not already present):
```csharp
public class CombatState
{
    // ...existing properties

    /// <summary>
    /// v0.31: Per-combat state flags for biome-specific mechanics
    /// </summary>
    public Dictionary<string, object> CombatFlags { get; set; } = new();

    // ...existing properties
}
```

---

## V. Testing Integration

### A. Manual Testing Checklist

**Alfheim Combat Initialization**:
- [ ] Enter Alfheim room (Canopy level, levels 8-12)
- [ ] Start combat
- [ ] Verify "[Runic Instability]" message displayed
- [ ] Verify "[Psychic Resonance]" message displayed
- [ ] Verify +10 Psychic Stress applied at combat start
- [ ] Check Mystic characters have +10% Aether Pool

**Wild Magic Surge Testing**:
- [ ] Play as Mystic archetype
- [ ] Cast Mystic ability 100 times
- [ ] Verify ~25 surges triggered (20-30 expected)
- [ ] Verify surge modifications logged (damage/range/targets/duration)
- [ ] Verify +5 Psychic Stress per surge
- [ ] Verify non-Mystics do not trigger surges
- [ ] Verify surges only trigger in Alfheim

**Reality Tear Testing**:
- [ ] Move player onto Reality Tear tile
- [ ] Verify 2d8 Energy damage applied
- [ ] Verify character warped 3-5 tiles (Manhattan distance)
- [ ] Verify +5 Corruption applied
- [ ] Verify [Dazed] status for 1 turn
- [ ] Move enemy onto Reality Tear
- [ ] Verify enemy warped (no Corruption)

**Per-Turn Stress Testing**:
- [ ] Enter Alfheim combat
- [ ] Complete 5 turns
- [ ] Verify +2 Psychic Stress per turn (10 total + 10 initial = 20)
- [ ] Check combat log for stress messages

**Combat End Cleanup**:
- [ ] Win Alfheim combat
- [ ] Verify Aether Pool amplification removed for Mystics
- [ ] Verify combat flags cleared

---

## VI. Database Setup

### Execute SQL Files

**Before testing, ensure database is fully populated**:

```bash
cd /home/user/rune-rust

# Execute Alfheim SQL files
sqlite3 runeandrust.db < Data/v0.31.1_alfheim_schema.sql
sqlite3 runeandrust.db < Data/v0.31.2_environmental_hazards.sql
sqlite3 runeandrust.db < Data/v0.31.3_enemy_definitions.sql

# Verify data inserted
sqlite3 runeandrust.db "SELECT COUNT(*) FROM Biome_RoomTemplates WHERE biome_id = 6;"
# Expected: 8

sqlite3 runeandrust.db "SELECT COUNT(*) FROM Biome_EnvironmentalFeatures WHERE biome_id = 6;"
# Expected: 8

sqlite3 runeandrust.db "SELECT COUNT(*) FROM Biome_EnemySpawns WHERE biome_id = 6;"
# Expected: 5

sqlite3 runeandrust.db "SELECT COUNT(*) FROM Biome_ResourceDrops WHERE biome_id = 6;"
# Expected: 9

sqlite3 runeandrust.db "SELECT condition_id, condition_name FROM Conditions WHERE condition_id = 107;"
# Expected: 107 | Runic Instability
```

---

## VII. Integration Sequence

### Recommended Implementation Order:

1. **Database** (30 min)
   - Execute SQL files
   - Verify data loaded

2. **Room Model** (15 min)
   - Add BiomeName property
   - Test compilation

3. **CombatState Model** (15 min)
   - Add CombatFlags dictionary
   - Test compilation

4. **Program.cs** (Already Complete) ‚úÖ
   - Alfheim services registered
   - Verify compilation

5. **CombatEngine - Phase 1** (1-2 hours)
   - Add dependencies to constructor
   - Apply ambient conditions at combat start
   - Test combat initialization

6. **CombatEngine - Phase 2** (2-3 hours)
   - Per-turn Psychic Resonance stress
   - Wild Magic Surge integration
   - Reality Tear processing
   - Test full combat flow

7. **Ability System** (1-2 hours)
   - Identify Mystic abilities
   - Integrate surge checks
   - Test surge probability and modifications

8. **Combat End Cleanup** (30 min)
   - Remove Aether Pool amplification
   - Clear combat flags
   - Test cleanup

9. **Integration Testing** (2-3 hours)
   - Full Alfheim playthrough
   - Verify all mechanics work together
   - Document any issues

**Total Estimated Time**: 8-12 hours

---

## VIII. Troubleshooting

### Common Issues

**Issue**: "BiomeName not found on Room"
- **Solution**: Add BiomeName property to Room.cs or use metadata system

**Issue**: "AlfheimBiomeService is null"
- **Solution**: Ensure service is passed to CombatEngine constructor in Program.cs

**Issue**: "Wild Magic Surge not triggering"
- **Solution**: Verify player.Archetype?.Name == "Mystic" check is correct

**Issue**: "Surge probability not ~25%"
- **Solution**: Test with larger sample size (100+ casts)

**Issue**: "Reality Tear not warping"
- **Solution**: Verify tile.HazardType == "Reality Tear" (exact match)

**Issue**: "Psychic Stress not accumulating"
- **Solution**: Verify per-turn processing is called each turn

**Issue**: "CombatFlags key not found"
- **Solution**: Use ContainsKey check before accessing

---

## IX. Code Review Checklist

Before committing integration:
- [ ] All biome services injected via DI
- [ ] Null checks on optional biome services
- [ ] Case-insensitive biome name comparisons
- [ ] Logging added for all biome-specific actions
- [ ] Combat log entries are user-friendly
- [ ] No hardcoded magic values (use service constants)
- [ ] Edge cases handled (null rooms, missing biome data)
- [ ] CombatFlags dictionary initialized
- [ ] Wild Magic Surge only affects Mystics
- [ ] Reality Tear warping respects grid boundaries
- [ ] Compilation successful
- [ ] No breaking changes to existing code
- [ ] Unit tests pass

---

## X. Performance Considerations

### Optimization Notes

1. **Biome Name Lookup**: Cache biome name in CombatState to avoid repeated lookups
2. **Service Null Checks**: Check once at combat start, store flag
3. **Logging**: Use Debug level for verbose mechanics, Information for key events
4. **Wild Magic Surge**: Single RNG call per ability (not multiple checks)
5. **Reality Tear**: Cache passable tiles for warp destination selection

### Example Optimization:
```csharp
// In InitializeCombat
combatState.IsAlfheim = currentRoom?.BiomeName?.Equals("Alfheim") ?? false;
combatState.IsNiflheim = currentRoom?.BiomeName?.Equals("Niflheim") ?? false;
combatState.IsMuspelheim = currentRoom?.BiomeName?.Equals("Muspelheim") ?? false;

// Later
if (combatState.IsAlfheim && _alfheimBiomeService != null)
{
    // No repeated string comparison
}
```

---

## XI. Archetype System Note

### Mystic Archetype Detection

The integration assumes player archetype can be checked via:
```csharp
combatState.Player.Archetype?.Name == "Mystic"
```

**If archetype system differs**, adjust the check:
```csharp
// Alternative approaches:
combatState.Player.Class.ToString() == "Mystic"
combatState.Player.IsMystic
combatState.Player.HasTag("Mystic")
```

Verify with existing codebase structure.

---

## XII. Next Steps After Integration

1. **Unit Tests**: Create integration tests for CombatEngine with Alfheim
2. **Balance Tuning**: Adjust stress values based on playtesting
3. **Documentation**: Update user-facing documentation
4. **Performance**: Profile combat with all three biomes
5. **Edge Cases**: Test interactions with other systems (abilities, equipment, etc.)
6. **Enemy AI**: Ensure enemies handle Reality Tear warping correctly
7. **UI/UX**: Add visual indicators for Wild Magic Surges
8. **Boss Fight**: Implement All-Rune's Echo two-phase encounter

---

## XIII. Alfheim-Specific Mechanics Summary

### High-Level Overview

**Ambient Conditions**:
- [Runic Instability]: 25% Wild Magic Surge on Mystic abilities
- [Psychic Resonance]: +10 stress at start, +2 per turn

**Wild Magic Surge**:
- Triggers: 25% chance on Mystic ability use
- Effects: ¬±50% damage/range/targets/duration (random)
- Stress: +5 per surge
- Benefit: +10% Aether Pool for Mystics

**Reality Tear**:
- Damage: 2d8 Energy
- Warp: 3-5 tiles (Manhattan distance)
- Corruption: +5 (players only)
- Status: [Dazed] for 1 turn

**Difficulty**:
- Levels: 8-12 (endgame)
- Verticality: Canopy-exclusive
- Enemies: 4 types + boss (weighted spawns)
- Elite Limiting: Based on difficulty tier

---

**Implementation Guide Complete**
**Version**: v0.31.5
**Date**: 2025-11-16
**Status**: Ready for Development
