# v0.14.7b Design Specification: Combat Descriptor Schema

**Version:** 0.14.7b
**Parent:** v0.14.7 (Descriptor Configuration Schemas)
**Prerequisites:** v0.14.7a Complete (Sensory Descriptor Schema)
**Status:** Design Complete

---

## Table of Contents

1. [Executive Summary](#1-executive-summary)
2. [Feature Overview](#2-feature-overview)
3. [Architecture Diagrams](#3-architecture-diagrams)
4. [Schema Extension Pattern](#4-schema-extension-pattern)
   - 4.1 [AllOf Extension Mechanism](#41-allof-extension-mechanism)
   - 4.2 [Reference to Master Schema](#42-reference-to-master-schema)
5. [Combat Category Enum](#5-combat-category-enum)
   - 5.1 [Category Definitions](#51-category-definitions)
   - 5.2 [Category Selection](#52-category-selection)
6. [CombatDescriptor Definition](#6-combatdescriptor-definition)
   - 6.1 [Core Properties (Inherited)](#61-core-properties-inherited)
   - 6.2 [Combat-Specific Properties](#62-combat-specific-properties)
   - 6.3 [Damage Threshold Properties](#63-damage-threshold-properties)
   - 6.4 [Filter Properties](#64-filter-properties)
7. [HitPoolTypes Enum](#7-hitpooltypes-enum)
   - 7.1 [Weapon-Based Pools](#71-weapon-based-pools)
   - 7.2 [Outcome Pools](#72-outcome-pools)
8. [DeathPoolTypes Enum](#8-deathpooltypes-enum)
   - 8.1 [Creature-Based Pools](#81-creature-based-pools)
   - 8.2 [Special Death Pools](#82-special-death-pools)
9. [Damage Threshold Validation](#9-damage-threshold-validation)
   - 9.1 [Threshold Range Constraints](#91-threshold-range-constraints)
   - 9.2 [Threshold Usage Patterns](#92-threshold-usage-patterns)
10. [Configuration Schema](#10-configuration-schema)
11. [Configuration File Updates](#11-configuration-file-updates)
    - 11.1 [combat-hits.json](#111-combat-hitsjson)
    - 11.2 [combat-deaths.json](#112-combat-deathsjson)
12. [Data Model Changes](#12-data-model-changes)
13. [Logging Specifications](#13-logging-specifications)
14. [Unit Testing Requirements](#14-unit-testing-requirements)
15. [Use Cases](#15-use-cases)
16. [Deliverable Checklist](#16-deliverable-checklist)
17. [Acceptance Criteria](#17-acceptance-criteria)
18. [Dependencies](#18-dependencies)
19. [Future Considerations](#19-future-considerations)
20. [Appendix: Schema Validation Examples](#20-appendix-schema-validation-examples)

---

## 1. Executive Summary

Version 0.14.7b introduces the **Combat Descriptor Schema** (`combat-descriptors.schema.json`), which extends the master descriptor schema (v0.14.7a) with combat-specific validations. This schema provides specialized validation for hit descriptions by weapon type, death descriptions by creature type, critical hit text, miss descriptions, fumble descriptions, and damage threshold filtering.

The Combat Descriptor Schema validates 2 existing configuration files (`combat-hits.json` with 11 pools and `combat-deaths.json` with 10 pools) and ensures combat descriptors follow consistent patterns for dynamic text selection during combat encounters.

### Key Deliverables

| Category | Items |
|----------|-------|
| **Schema Files** | `combat-descriptors.schema.json` |
| **Schema Definitions** | `CombatCategory`, `CombatDescriptor`, `HitPoolTypes`, `DeathPoolTypes` |
| **Configuration Updates** | `combat-hits.json`, `combat-deaths.json` (add schema references) |
| **Tests** | ~6 new unit tests |

### Architectural Significance

This version provides:
- **Schema extension pattern** - Demonstrates `allOf` composition with master schema
- **Combat category validation** - Enforces valid category values for combat files
- **Weapon-type pools** - Validates hit description pools by weapon type
- **Creature-type pools** - Validates death description pools by creature type
- **Damage threshold validation** - Ensures minDamagePercent/maxDamagePercent are 0-1 range
- **Variable substitution** - Validates {player} and {killer} in player death descriptions

### Relationship to Other Schemas

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                  v0.14.7 DESCRIPTOR CONFIGURATION SCHEMAS                    │
└─────────────────────────────────────────────────────────────────────────────┘

  ┌─────────────────────────────────────────────────────────────────────────┐
  │  v0.14.7a: descriptors.schema.json (MASTER SCHEMA)                      │
  │  v0.14.7b: combat-descriptors.schema.json ◀── THIS VERSION (EXTENDS)   │
  │  v0.14.7c: environment-descriptors.schema.json (extends master)        │
  └─────────────────────────────────────────────────────────────────────────┘

  Extension Mechanism:
  ┌─────────────────────────────────────────────────────────────────────────┐
  │  combat-descriptors.schema.json                                         │
  │  └── allOf:                                                             │
  │      └── $ref: "descriptors.schema.json"  ◀── Inherits all master rules │
  │  └── properties:                                                        │
  │      └── category: enum [combat-hits, combat-deaths, combat]            │
  └─────────────────────────────────────────────────────────────────────────┘

  Configuration Files Using This Schema:
  ├── config/descriptors/combat-hits.json (11 pools)
  │   └── hit_sword, hit_axe, hit_bow, hit_staff, hit_dagger
  │   └── hit_fist, hit_mace, hit_spear
  │   └── critical_hit, miss_descriptions, fumble_descriptions
  │
  └── config/descriptors/combat-deaths.json (10 pools)
      └── death_humanoid, death_undead, death_beast
      └── death_construct, death_elemental, death_demon
      └── critical_kill, player_death
      └── near_death_warning, near_death_critical
```

---

## 2. Feature Overview

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                    COMBAT DESCRIPTOR SCHEMA FEATURE TREE                     │
└─────────────────────────────────────────────────────────────────────────────┘

combat-descriptors.schema.json
├── Schema Extension
│   ├── allOf composition
│   └── $ref to descriptors.schema.json
│
├── CombatCategory Enum
│   ├── combat-hits
│   ├── combat-deaths
│   └── combat (general)
│
├── CombatDescriptor (extends Descriptor)
│   ├── Inherited Properties
│   │   ├── id (lowercase with underscores)
│   │   ├── text (descriptor content)
│   │   ├── weight (positive integer)
│   │   ├── tags[] (context filters)
│   │   └── themes[] (genre filters)
│   │
│   ├── Combat-Specific Properties
│   │   ├── weaponTypes[] (filter by weapon)
│   │   ├── damageTypes[] (filter by damage type)
│   │   └── isCritical (critical-only flag)
│   │
│   └── Damage Threshold Properties
│       ├── minDamagePercent (0-1)
│       └── maxDamagePercent (0-1)
│
├── HitPoolTypes Enum (11 types)
│   ├── Weapon Pools (8)
│   │   ├── hit_sword
│   │   ├── hit_axe
│   │   ├── hit_bow
│   │   ├── hit_staff
│   │   ├── hit_dagger
│   │   ├── hit_fist
│   │   ├── hit_mace
│   │   └── hit_spear
│   │
│   └── Outcome Pools (3)
│       ├── critical_hit
│       ├── miss_descriptions
│       └── fumble_descriptions
│
└── DeathPoolTypes Enum (10 types)
    ├── Creature Pools (6)
    │   ├── death_humanoid
    │   ├── death_undead
    │   ├── death_beast
    │   ├── death_construct
    │   ├── death_elemental
    │   └── death_demon
    │
    └── Special Pools (4)
        ├── critical_kill
        ├── player_death
        ├── near_death_warning
        └── near_death_critical
```

---

## 3. Architecture Diagrams

### 3.1 Schema Extension Architecture

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                       SCHEMA EXTENSION ARCHITECTURE                          │
└─────────────────────────────────────────────────────────────────────────────┘

                       ┌───────────────────────────────────┐
                       │    descriptors.schema.json        │
                       │         (MASTER SCHEMA)           │
                       │───────────────────────────────────│
                       │  • DescriptorPool definition      │
                       │  • Descriptor definition          │
                       │  • Weight validation (> 0)        │
                       │  • ID patterns (kebab/snake)      │
                       │  • Tag/theme arrays               │
                       │  • Variable substitution          │
                       └───────────────┬───────────────────┘
                                       │
                              ┌────────┴────────┐
                              │  allOf: $ref    │
                              └────────┬────────┘
                                       │
                       ┌───────────────▼───────────────────┐
                       │  combat-descriptors.schema.json   │
                       │       (COMBAT EXTENSION)          │
                       │───────────────────────────────────│
                       │  INHERITS ALL FROM MASTER:        │
                       │  • DescriptorPool                 │
                       │  • Descriptor base properties     │
                       │  • Weight/ID/Tag validation       │
                       │───────────────────────────────────│
                       │  ADDS COMBAT-SPECIFIC:            │
                       │  • category: combat enum          │
                       │  • CombatDescriptor extension     │
                       │  • HitPoolTypes enum              │
                       │  • DeathPoolTypes enum            │
                       │  • Damage threshold validation    │
                       │  • weaponTypes/damageTypes arrays │
                       └───────────────────────────────────┘
```

### 3.2 Combat Descriptor Flow

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                        COMBAT DESCRIPTOR SELECTION FLOW                      │
└─────────────────────────────────────────────────────────────────────────────┘

  Combat Event (e.g., sword hit dealing 75% max damage)
           │
           ▼
  ┌─────────────────────────────────────────────────────────────────────────┐
  │                    STEP 1: POOL SELECTION                                │
  ├─────────────────────────────────────────────────────────────────────────┤
  │  Input: weapon type = "sword"                                           │
  │  Pool Selected: hit_sword                                               │
  │  Descriptors Available: 12 entries                                      │
  └─────────────────────────────────────────────────────────────────────────┘
           │
           ▼
  ┌─────────────────────────────────────────────────────────────────────────┐
  │                   STEP 2: DAMAGE THRESHOLD FILTER                        │
  ├─────────────────────────────────────────────────────────────────────────┤
  │  Input: damagePercent = 0.75                                            │
  │  Filter: minDamagePercent <= 0.75 AND maxDamagePercent >= 0.75          │
  │  Remaining: 8 descriptors (excluded 4 low-damage entries)               │
  └─────────────────────────────────────────────────────────────────────────┘
           │
           ▼
  ┌─────────────────────────────────────────────────────────────────────────┐
  │                   STEP 3: WEIGHTED SELECTION                             │
  ├─────────────────────────────────────────────────────────────────────────┤
  │  Descriptor Weights:                                                    │
  │  • "cleaves through" (weight: 15)                                       │
  │  • "cuts deep into" (weight: 15)                                        │
  │  • "slashes fiercely across" (weight: 10)                               │
  │  • ... (5 more entries)                                                 │
  │  Total Weight: 85                                                       │
  │  Random Selection: Based on weight distribution                         │
  └─────────────────────────────────────────────────────────────────────────┘
           │
           ▼
  ┌─────────────────────────────────────────────────────────────────────────┐
  │                    RESULT: SELECTED DESCRIPTOR                           │
  ├─────────────────────────────────────────────────────────────────────────┤
  │  Selected: "cleaves through"                                            │
  │  Final Output: "{attacker} cleaves through {target}'s defenses"         │
  └─────────────────────────────────────────────────────────────────────────┘
```

### 3.3 Layer Diagram

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           CLEAN ARCHITECTURE LAYERS                          │
└─────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────┐
│                              INFRASTRUCTURE                                  │
│─────────────────────────────────────────────────────────────────────────────│
│                                                                             │
│  config/schemas/                                                            │
│  ├── descriptors.schema.json          (v0.14.7a - master)                  │
│  └── combat-descriptors.schema.json   (v0.14.7b - THIS VERSION)            │
│                                                                             │
│  config/descriptors/                                                        │
│  ├── combat-hits.json                 (uses combat schema)                 │
│  └── combat-deaths.json               (uses combat schema)                 │
│                                                                             │
│  Unit Tests (RuneAndRust.Tests)                                            │
│  └── Infrastructure/Validation/                                            │
│      └── CombatDescriptorSchemaTests.cs (~6 tests)                         │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 4. Schema Extension Pattern

### 4.1 AllOf Extension Mechanism

The combat descriptor schema extends the master schema using JSON Schema's `allOf` composition. This ensures all combat descriptor files:
1. Meet the base requirements of the master schema
2. Additionally satisfy combat-specific requirements

**Extension Structure:**

```json
{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "allOf": [
    { "$ref": "descriptors.schema.json" }
  ],
  "properties": {
    "category": {
      "description": "Combat category identifier",
      "enum": ["combat-hits", "combat-deaths", "combat"]
    }
  }
}
```

**Inheritance:**
- All `DescriptorPool` validation from master
- All `Descriptor` property validation from master
- All ID pattern validation from master
- All weight validation from master
- Tag and theme array validation from master

### 4.2 Reference to Master Schema

**File Location:** `config/schemas/combat-descriptors.schema.json`

**Reference Path:** The schema uses a relative reference to the master schema in the same directory:

```json
{
  "allOf": [
    { "$ref": "descriptors.schema.json" }
  ]
}
```

This reference ensures:
- Master schema must be valid before combat schema validates
- Changes to master schema automatically affect combat validation
- No duplication of base validation rules

---

## 5. Combat Category Enum

### 5.1 Category Definitions

The combat descriptor schema restricts the `category` property to combat-related values:

| Category | Description | Configuration File |
|----------|-------------|-------------------|
| `combat-hits` | Hit and attack descriptions | `combat-hits.json` |
| `combat-deaths` | Death and kill descriptions | `combat-deaths.json` |
| `combat` | General combat descriptions | (future use) |

### 5.2 Category Selection

**Schema Definition:**

```json
{
  "properties": {
    "category": {
      "description": "Combat category identifier - must be a combat-related category",
      "type": "string",
      "enum": ["combat-hits", "combat-deaths", "combat"]
    }
  },
  "required": ["category"]
}
```

**Validation Rules:**
- Category must be one of the three allowed values
- Category is required (inherits from master)
- Category determines which pool types are valid

---

## 6. CombatDescriptor Definition

### 6.1 Core Properties (Inherited)

CombatDescriptor inherits all properties from the master Descriptor definition:

| Property | Type | Required | Description |
|----------|------|----------|-------------|
| `id` | string | Yes | Unique identifier (pattern: `^[a-z][a-z0-9_]*$`) |
| `text` | string | Yes | The descriptor text content |
| `weight` | integer | No | Selection weight (default: 100, minimum: 1) |
| `tags` | string[] | No | Context filter tags |
| `themes` | string[] | No | Theme filter tags |

### 6.2 Combat-Specific Properties

CombatDescriptor adds combat-specific optional properties:

| Property | Type | Required | Description |
|----------|------|----------|-------------|
| `weaponTypes` | string[] | No | Filter by weapon type (e.g., ["sword", "axe"]) |
| `damageTypes` | string[] | No | Filter by damage type (e.g., ["slashing", "fire"]) |
| `isCritical` | boolean | No | If true, only used for critical hits |

**Schema Definition:**

```json
{
  "definitions": {
    "CombatDescriptor": {
      "description": "Extended descriptor with combat-specific properties",
      "allOf": [
        { "$ref": "descriptors.schema.json#/definitions/Descriptor" }
      ],
      "properties": {
        "weaponTypes": {
          "description": "Weapon types this descriptor applies to",
          "type": "array",
          "items": { "type": "string" },
          "uniqueItems": true
        },
        "damageTypes": {
          "description": "Damage types this descriptor applies to",
          "type": "array",
          "items": { "type": "string" },
          "uniqueItems": true
        },
        "isCritical": {
          "description": "If true, this descriptor is only used for critical hits",
          "type": "boolean",
          "default": false
        }
      }
    }
  }
}
```

### 6.3 Damage Threshold Properties

Damage threshold properties control when a descriptor is eligible for selection based on damage dealt:

| Property | Type | Range | Description |
|----------|------|-------|-------------|
| `minDamagePercent` | number | 0-1 | Minimum damage % to use this descriptor |
| `maxDamagePercent` | number | 0-1 | Maximum damage % to use this descriptor |

**Usage Examples:**

| minDamagePercent | maxDamagePercent | Meaning |
|------------------|------------------|---------|
| 0.75 | (not set) | Only for 75%+ damage hits |
| 0.5 | (not set) | Only for 50%+ damage hits |
| (not set) | 0.25 | Only for 25% or less damage (grazes) |
| 0.25 | 0.5 | Only for damage between 25-50% |

**Schema Definition:**

```json
{
  "definitions": {
    "CombatDescriptor": {
      "properties": {
        "minDamagePercent": {
          "description": "Minimum damage percentage (0-1) required to use this descriptor",
          "type": "number",
          "minimum": 0,
          "maximum": 1
        },
        "maxDamagePercent": {
          "description": "Maximum damage percentage (0-1) allowed to use this descriptor",
          "type": "number",
          "minimum": 0,
          "maximum": 1
        }
      }
    }
  }
}
```

### 6.4 Filter Properties

Combat descriptors can be filtered by context using tags (inherited from master):

**Common Combat Tags:**

| Tag Category | Examples | Usage |
|--------------|----------|-------|
| Creature sub-type | `skeleton`, `zombie`, `vampire` | Filter undead death descriptions |
| Weapon material | `iron`, `silver`, `enchanted` | Filter by weapon material |
| Combat style | `aggressive`, `defensive`, `flanking` | Filter by combat situation |

---

## 7. HitPoolTypes Enum

### 7.1 Weapon-Based Pools

The following pools contain hit descriptions organized by weapon type:

| Pool ID | Weapon Type | Example Descriptors |
|---------|-------------|---------------------|
| `hit_sword` | Sword | "slashes across", "cleaves through", "cuts deep into" |
| `hit_axe` | Axe | "hews into", "buries the axe head in", "hacks at" |
| `hit_bow` | Bow | "'s arrow pierces", "'s shaft buries itself in", "'s bolt strikes" |
| `hit_staff` | Staff | "cracks the staff against", "brings down upon", "jabs with the staff" |
| `hit_dagger` | Dagger | "stabs into", "slips the blade between", "drives the dagger into" |
| `hit_fist` | Unarmed | "hammers a fist into", "pummels", "delivers a crushing blow to" |
| `hit_mace` | Mace | "smashes into", "crushes", "cracks against" |
| `hit_spear` | Spear | "thrusts the spear into", "impales", "drives the point into" |

**Pool Count:** 8 weapon-based pools

### 7.2 Outcome Pools

Additional pools for special combat outcomes:

| Pool ID | Usage | Example Descriptors |
|---------|-------|---------------------|
| `critical_hit` | Critical hit strikes | "lands a devastating strike on", "finds a lethal opening in" |
| `miss_descriptions` | Missed attacks | "swings wide", "is deflected away", "whistles past" |
| `fumble_descriptions` | Critical misses | "stumbles badly", "overextends", "drops their weapon" |

**Pool Count:** 3 outcome pools

**Schema Definition:**

```json
{
  "definitions": {
    "HitPoolTypes": {
      "description": "Valid pool IDs for combat-hits category",
      "type": "string",
      "enum": [
        "hit_sword",
        "hit_axe",
        "hit_bow",
        "hit_staff",
        "hit_dagger",
        "hit_fist",
        "hit_mace",
        "hit_spear",
        "critical_hit",
        "miss_descriptions",
        "fumble_descriptions"
      ]
    }
  }
}
```

---

## 8. DeathPoolTypes Enum

### 8.1 Creature-Based Pools

The following pools contain death descriptions organized by creature type:

| Pool ID | Creature Type | Example Descriptors |
|---------|---------------|---------------------|
| `death_humanoid` | Humanoid | "crumples to the ground", "falls lifeless", "collapses in a heap" |
| `death_undead` | Undead | "collapses into a heap of bones", "crumbles to dust", "dissolves into shadow" |
| `death_beast` | Beast | "lets out a final howl and collapses", "thrashes and goes still", "crashes to the ground" |
| `death_construct` | Construct | "shatters into fragments", "breaks apart", "crumbles to rubble" |
| `death_elemental` | Elemental | "disperses into wisps of energy", "dissipates into nothingness", "explodes in elemental fury" |
| `death_demon` | Demon | "dissolves into shadows with a terrible shriek", "is banished screaming", "implodes in dark flame" |

**Pool Count:** 6 creature-based pools

### 8.2 Special Death Pools

Additional pools for special death and health situations:

| Pool ID | Usage | Example Descriptors |
|---------|-------|---------------------|
| `critical_kill` | Deaths from critical hits | "With a devastating blow,", "In a single lethal strike,", "With merciless precision," |
| `player_death` | Player character deaths | "{player} has fallen in battle against the {killer}...", "{player}'s journey ends here..." |
| `near_death_warning` | Low health warning (25%) | "You're badly wounded!", "Blood loss is making you dizzy." |
| `near_death_critical` | Critical health warning (10%) | "You're on death's door!", "One more hit could be your last!" |

**Pool Count:** 4 special pools

**Variable Usage in player_death:**
- `{player}` - Player character name
- `{killer}` - Name of the creature/entity that killed the player

**Schema Definition:**

```json
{
  "definitions": {
    "DeathPoolTypes": {
      "description": "Valid pool IDs for combat-deaths category",
      "type": "string",
      "enum": [
        "death_humanoid",
        "death_undead",
        "death_beast",
        "death_construct",
        "death_elemental",
        "death_demon",
        "critical_kill",
        "player_death",
        "near_death_warning",
        "near_death_critical"
      ]
    }
  }
}
```

---

## 9. Damage Threshold Validation

### 9.1 Threshold Range Constraints

Damage threshold properties must be within the 0-1 range representing percentage of maximum damage:

**Validation Rules:**

| Property | Minimum | Maximum | Description |
|----------|---------|---------|-------------|
| `minDamagePercent` | 0 | 1 | 0% to 100% of max damage |
| `maxDamagePercent` | 0 | 1 | 0% to 100% of max damage |

**Schema Validation:**

```json
{
  "properties": {
    "minDamagePercent": {
      "type": "number",
      "minimum": 0,
      "maximum": 1
    },
    "maxDamagePercent": {
      "type": "number",
      "minimum": 0,
      "maximum": 1
    }
  }
}
```

### 9.2 Threshold Usage Patterns

**Common Threshold Patterns in Existing Files:**

| Pattern | minDamagePercent | maxDamagePercent | Example Text |
|---------|------------------|------------------|--------------|
| High damage | 0.75 | - | "cleaves through", "skewers" |
| Medium-high damage | 0.5 | - | "cuts deep into", "hews into" |
| Low damage | - | 0.25 | "grazes", "nicks" |
| Any damage | (not set) | (not set) | "strikes", "hits" |

**Example from combat-hits.json:**

```json
{
  "id": "slashes_across",
  "text": "slashes across",
  "weight": 25
},
{
  "id": "cleaves_through",
  "text": "cleaves through",
  "weight": 15,
  "minDamagePercent": 0.5
},
{
  "id": "nearly_bisects",
  "text": "nearly bisects",
  "weight": 5,
  "minDamagePercent": 0.75
}
```

---

## 10. Configuration Schema

**File:** `config/schemas/combat-descriptors.schema.json`

```json
{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "https://runeandrust.game/schemas/combat-descriptors.schema.json",
  "title": "Combat Descriptor Configuration",
  "description": "Schema for combat-related text descriptors including hits, deaths, criticals, and misses. Extends the master descriptor schema.",

  "allOf": [
    { "$ref": "descriptors.schema.json" }
  ],

  "properties": {
    "category": {
      "description": "Combat category identifier - must be a combat-related category",
      "type": "string",
      "enum": ["combat-hits", "combat-deaths", "combat"]
    }
  },

  "definitions": {
    "CombatDescriptor": {
      "description": "Extended descriptor with combat-specific properties for filtering by damage, weapon, and critical status",
      "allOf": [
        { "$ref": "descriptors.schema.json#/definitions/Descriptor" }
      ],
      "properties": {
        "minDamagePercent": {
          "description": "Minimum damage percentage (0-1) required to use this descriptor. Example: 0.5 means 50% or more of max damage.",
          "type": "number",
          "minimum": 0,
          "maximum": 1
        },
        "maxDamagePercent": {
          "description": "Maximum damage percentage (0-1) allowed to use this descriptor. Example: 0.25 means 25% or less of max damage.",
          "type": "number",
          "minimum": 0,
          "maximum": 1
        },
        "weaponTypes": {
          "description": "Array of weapon types this descriptor applies to. If empty or not specified, applies to all weapons.",
          "type": "array",
          "items": { "type": "string" },
          "uniqueItems": true
        },
        "damageTypes": {
          "description": "Array of damage types this descriptor applies to. If empty or not specified, applies to all damage types.",
          "type": "array",
          "items": { "type": "string" },
          "uniqueItems": true
        },
        "isCritical": {
          "description": "If true, this descriptor is only used for critical hits. Defaults to false.",
          "type": "boolean",
          "default": false
        }
      }
    },

    "HitPoolTypes": {
      "description": "Valid pool IDs for combat-hits category",
      "type": "string",
      "enum": [
        "hit_sword",
        "hit_axe",
        "hit_bow",
        "hit_staff",
        "hit_dagger",
        "hit_fist",
        "hit_mace",
        "hit_spear",
        "critical_hit",
        "miss_descriptions",
        "fumble_descriptions"
      ]
    },

    "DeathPoolTypes": {
      "description": "Valid pool IDs for combat-deaths category",
      "type": "string",
      "enum": [
        "death_humanoid",
        "death_undead",
        "death_beast",
        "death_construct",
        "death_elemental",
        "death_demon",
        "critical_kill",
        "player_death",
        "near_death_warning",
        "near_death_critical"
      ]
    }
  }
}
```

---

## 11. Configuration File Updates

### 11.1 combat-hits.json

**File:** `config/descriptors/combat-hits.json`

**Update Required:** Add schema reference to enable validation.

**Current Structure (11 pools):**

| Pool ID | Descriptor Count | Description |
|---------|------------------|-------------|
| `hit_sword` | 12 | Sword attack hit descriptions |
| `hit_axe` | 10 | Axe attack hit descriptions |
| `hit_bow` | 9 | Bow/arrow hit descriptions |
| `hit_staff` | 8 | Staff attack hit descriptions |
| `hit_dagger` | 9 | Dagger attack hit descriptions |
| `hit_fist` | 8 | Unarmed attack hit descriptions |
| `hit_mace` | 8 | Mace attack hit descriptions |
| `hit_spear` | 8 | Spear attack hit descriptions |
| `critical_hit` | 6 | Critical hit descriptions |
| `miss_descriptions` | 8 | Missed attack descriptions |
| `fumble_descriptions` | 6 | Critical miss descriptions |

**Schema Reference Addition:**

```json
{
  "$schema": "../schemas/combat-descriptors.schema.json",
  "category": "combat-hits",
  "pools": {
    // ... existing pools unchanged
  }
}
```

### 11.2 combat-deaths.json

**File:** `config/descriptors/combat-deaths.json`

**Update Required:** Add schema reference to enable validation.

**Current Structure (10 pools):**

| Pool ID | Descriptor Count | Description |
|---------|------------------|-------------|
| `death_humanoid` | 8 | Humanoid creature death descriptions |
| `death_undead` | 8 | Undead creature death descriptions |
| `death_beast` | 7 | Beast creature death descriptions |
| `death_construct` | 6 | Construct creature death descriptions |
| `death_elemental` | 6 | Elemental creature death descriptions |
| `death_demon` | 6 | Demon creature death descriptions |
| `critical_kill` | 5 | Critical kill prefix descriptions |
| `player_death` | 5 | Player death messages (uses {player}, {killer}) |
| `near_death_warning` | 4 | Low health (25%) warning messages |
| `near_death_critical` | 4 | Critical health (10%) warning messages |

**Schema Reference Addition:**

```json
{
  "$schema": "../schemas/combat-descriptors.schema.json",
  "category": "combat-deaths",
  "pools": {
    // ... existing pools unchanged
  }
}
```

---

## 12. Data Model Changes

### Summary

v0.14.7b introduces no new domain entities or value objects. All changes are configuration schema definitions:

| Artifact | Type | Layer | Description |
|----------|------|-------|-------------|
| `combat-descriptors.schema.json` | JSON Schema | Infrastructure | Combat descriptor validation schema |
| `CombatDescriptor` | Schema Definition | Infrastructure | Extended descriptor with combat properties |
| `HitPoolTypes` | Schema Enum | Infrastructure | Valid hit pool identifiers |
| `DeathPoolTypes` | Schema Enum | Infrastructure | Valid death pool identifiers |

### Schema Definitions Overview

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                        COMBAT SCHEMA DEFINITIONS                             │
└─────────────────────────────────────────────────────────────────────────────┘

CombatDescriptor (extends Descriptor)
├── id: string (required, inherited)
├── text: string (required, inherited)
├── weight: integer (optional, inherited, default: 100)
├── tags: string[] (optional, inherited)
├── themes: string[] (optional, inherited)
├── minDamagePercent: number (optional, 0-1)
├── maxDamagePercent: number (optional, 0-1)
├── weaponTypes: string[] (optional)
├── damageTypes: string[] (optional)
└── isCritical: boolean (optional, default: false)

HitPoolTypes (enum)
├── hit_sword
├── hit_axe
├── hit_bow
├── hit_staff
├── hit_dagger
├── hit_fist
├── hit_mace
├── hit_spear
├── critical_hit
├── miss_descriptions
└── fumble_descriptions

DeathPoolTypes (enum)
├── death_humanoid
├── death_undead
├── death_beast
├── death_construct
├── death_elemental
├── death_demon
├── critical_kill
├── player_death
├── near_death_warning
└── near_death_critical
```

---

## 13. Logging Specifications

### Log Levels by Component

| Component | Level | Events |
|-----------|-------|--------|
| Schema Validation | Debug | Schema loading, validation start/end |
| Schema Validation | Information | Successful validation of combat files |
| Schema Validation | Warning | Schema not found, using fallback |
| Schema Validation | Error | Validation failures, invalid damage thresholds |

### Log Message Formats

```
[Debug] Loading combat descriptor schema from: config/schemas/combat-descriptors.schema.json
[Debug] Validating combat-hits.json against combat-descriptors.schema.json
[Information] Successfully validated combat-hits.json (11 pools, 92 descriptors)
[Information] Successfully validated combat-deaths.json (10 pools, 59 descriptors)
[Warning] minDamagePercent (1.5) exceeds maximum (1.0) in descriptor 'massive_strike'
[Error] Schema validation failed for combat-hits.json: Invalid pool ID 'hit_crossbow' - not in HitPoolTypes enum
```

---

## 14. Unit Testing Requirements

### Test Count by Feature

| Feature | Test Count |
|---------|------------|
| Schema Loading | 1 |
| Category Validation | 1 |
| Hit Pool Validation | 1 |
| Death Pool Validation | 1 |
| Damage Threshold Validation | 1 |
| Variable Substitution | 1 |
| **Total** | **~6** |

### Test Specifications

**File:** `tests/RuneAndRust.Tests/Infrastructure/Validation/CombatDescriptorSchemaTests.cs`

```csharp
[TestFixture]
public class CombatDescriptorSchemaTests
{
    /// <summary>
    /// CSC-001: Verify combat-descriptors.schema.json loads and is valid JSON Schema
    /// </summary>
    [Test]
    public void CombatDescriptorSchema_LoadsSuccessfully_ReturnsValidSchema();

    /// <summary>
    /// CSC-002: Verify category enum validation rejects non-combat categories
    /// </summary>
    [Test]
    public void CombatDescriptorSchema_InvalidCategory_FailsValidation();

    /// <summary>
    /// CSC-003: Verify combat-hits.json validates against combat schema
    /// </summary>
    [Test]
    public void CombatHitsJson_ValidatesAgainstSchema_Succeeds();

    /// <summary>
    /// CSC-004: Verify combat-deaths.json validates against combat schema
    /// </summary>
    [Test]
    public void CombatDeathsJson_ValidatesAgainstSchema_Succeeds();

    /// <summary>
    /// CSC-005: Verify damage thresholds outside 0-1 range fail validation
    /// </summary>
    [Test]
    public void CombatDescriptor_InvalidDamageThreshold_FailsValidation();

    /// <summary>
    /// CSC-006: Verify player_death pool variables are documented correctly
    /// </summary>
    [Test]
    public void PlayerDeathPool_ContainsVariables_ValidatesSuccessfully();
}
```

---

## 15. Use Cases

### UC-001: Load Combat Descriptor Schema

**Actor:** System (Configuration Loader)
**Flow:** Application Start → Load combat-descriptors.schema.json → Parse JSON Schema → Cache schema → Ready for validation

### UC-002: Validate Combat Hits File

**Actor:** System (Configuration Validator)
**Flow:** Load combat-hits.json → Apply combat schema → Verify category is "combat-hits" → Validate all 11 pools → Validate all descriptors → Return validation result

### UC-003: Validate Combat Deaths File

**Actor:** System (Configuration Validator)
**Flow:** Load combat-deaths.json → Apply combat schema → Verify category is "combat-deaths" → Validate all 10 pools → Validate descriptors with variables → Return validation result

### UC-004: Select Hit Descriptor by Damage

**Actor:** Combat System (Runtime)
**Flow:** Combat event occurs → Get weapon type → Select pool (e.g., hit_sword) → Filter by minDamagePercent/maxDamagePercent → Weighted random selection → Return descriptor text

### UC-005: Select Death Descriptor by Creature

**Actor:** Combat System (Runtime)
**Flow:** Creature death occurs → Get creature type → Select pool (e.g., death_undead) → Filter by tags (e.g., ["skeleton"]) → Weighted random selection → Return descriptor text

---

## 16. Deliverable Checklist

### Schema Files
- [ ] `config/schemas/combat-descriptors.schema.json` created
- [ ] Schema extends master via allOf reference
- [ ] CombatDescriptor definition complete
- [ ] HitPoolTypes enum defined (11 values)
- [ ] DeathPoolTypes enum defined (10 values)
- [ ] Category enum defined (3 values)

### Configuration Updates
- [ ] `config/descriptors/combat-hits.json` updated with $schema reference
- [ ] `config/descriptors/combat-deaths.json` updated with $schema reference

### Unit Tests
- [ ] CSC-001: Schema loads successfully
- [ ] CSC-002: Invalid category fails validation
- [ ] CSC-003: combat-hits.json validates
- [ ] CSC-004: combat-deaths.json validates
- [ ] CSC-005: Invalid damage threshold fails
- [ ] CSC-006: Player death variables validate

### Documentation
- [ ] Design specification complete (this document)

---

## 17. Acceptance Criteria

### Functional Criteria
- [ ] `combat-descriptors.schema.json` created in `config/schemas/`
- [ ] Schema extends master descriptor schema via allOf
- [ ] Schema validates existing `combat-hits.json` (11 pools)
- [ ] Schema validates existing `combat-deaths.json` (10 pools)
- [ ] Category enum validates: combat-hits, combat-deaths, combat
- [ ] HitPoolTypes enum validates 11 pool IDs
- [ ] DeathPoolTypes enum validates 10 pool IDs
- [ ] Damage thresholds validated in 0-1 range
- [ ] Player death variables ({player}, {killer}) documented in schema

### Quality Criteria
- [ ] Build completes with 0 errors
- [ ] Build completes with 0 warnings
- [ ] ~6 unit tests pass
- [ ] Schema follows JSON Schema Draft-07 specification
- [ ] Schema follows established naming conventions

---

## 18. Dependencies

### Required from v0.14.7a

| Type | Location | Usage in this phase |
|------|----------|---------------------|
| `descriptors.schema.json` | `config/schemas/` | Base schema for allOf extension |
| DescriptorPool definition | Schema definition | Inherited pool structure |
| Descriptor definition | Schema definition | Base for CombatDescriptor |
| ID pattern validation | Schema definition | Inherited ID patterns |
| Weight validation | Schema definition | Inherited weight rules |

### Provides to v0.14.7c

| Type | Usage |
|------|-------|
| Schema extension pattern | Template for environment schema extension |
| Combat pool enum pattern | Reference for environment pool enums |
| Damage threshold pattern | Reference for environment condition patterns |

### Provides to Future Versions

| Type | Usage |
|------|-------|
| Combat descriptor validation | Runtime combat text selection |
| Pool type enums | Combat service pool lookups |
| Damage threshold schema | Conditional text selection logic |

---

## 19. Future Considerations

### Deferred to Future Versions

- **Combat execution logic** - Runtime descriptor selection is out of scope (application layer concern)
- **New weapon types** - Adding new weapon pools (e.g., hit_crossbow) would require schema enum update
- **New creature types** - Adding new death pools (e.g., death_dragon) would require schema enum update
- **Composite damage** - Multi-damage-type descriptors (future consideration)

### Out of Scope

- **Master descriptor schema** - Defined in v0.14.7a
- **Environment descriptor schema** - Defined in v0.14.7c
- **Dynamic pool registration** - Pools are statically defined in schema

---

## 20. Appendix: Schema Validation Examples

### Valid Combat Hits Entry

```json
{
  "$schema": "../schemas/combat-descriptors.schema.json",
  "category": "combat-hits",
  "pools": {
    "hit_sword": {
      "id": "hit_sword",
      "name": "Sword Hit Descriptions",
      "description": "Descriptions for sword attack hits",
      "descriptors": [
        {
          "id": "slashes_across",
          "text": "slashes across",
          "weight": 25
        },
        {
          "id": "cleaves_through",
          "text": "cleaves through",
          "weight": 15,
          "minDamagePercent": 0.5
        },
        {
          "id": "nearly_bisects",
          "text": "nearly bisects",
          "weight": 5,
          "minDamagePercent": 0.75
        }
      ]
    }
  }
}
```

### Valid Combat Deaths Entry with Variables

```json
{
  "$schema": "../schemas/combat-descriptors.schema.json",
  "category": "combat-deaths",
  "pools": {
    "player_death": {
      "id": "player_death",
      "name": "Player Death Messages",
      "description": "Messages displayed when the player dies",
      "descriptors": [
        {
          "id": "falls_battle",
          "text": "{player} has fallen in battle against the {killer}...",
          "weight": 25
        },
        {
          "id": "journey_ends",
          "text": "{player}'s journey ends here, cut down by the {killer}.",
          "weight": 20
        }
      ]
    }
  }
}
```

### Valid Death Descriptor with Tags

```json
{
  "id": "crumbles_bones",
  "text": "crumbles into a pile of ancient bones",
  "weight": 20,
  "tags": ["skeleton"]
}
```

### Invalid: Category Not in Enum

```json
{
  "$schema": "../schemas/combat-descriptors.schema.json",
  "category": "environmental",  // ERROR: Not a valid combat category
  "pools": { }
}
```

**Error:** `category` must be one of: combat-hits, combat-deaths, combat

### Invalid: Damage Threshold Out of Range

```json
{
  "id": "massive_strike",
  "text": "delivers a massive strike",
  "weight": 10,
  "minDamagePercent": 1.5  // ERROR: Exceeds maximum of 1
}
```

**Error:** `minDamagePercent` must be between 0 and 1

### Invalid: Missing Required Properties

```json
{
  "id": "unnamed_hit",
  "weight": 20
  // ERROR: Missing required "text" property
}
```

**Error:** Required property `text` is missing

---

*Document Version: 1.0*
*Last Updated: 2026-01-17*
*Author: Claude (AI Assistant)*
