# Changelog: v0.17.2b - Allocation Mode System

**Release Date:** 2026-01-30
**Phase:** Attribute System (2/7)
**Status:** Complete

---

## Overview

Implements the Allocation Mode System for the v0.17.2 Attribute System: the `AttributeAllocationMode` enum and `AttributeAllocationState` value object. These types define the two available approaches to attribute allocation during character creation (Simple and Advanced) and track the complete state of allocation progress including current attribute values, points spent/remaining, and archetype selection.

This phase establishes the dual-mode allocation pattern that all subsequent v0.17.2x phases depend upon for point-buy cost calculation, derived stat preview, and character creation UI. The `AttributeAllocationState` supports mode switching, archetype-recommended builds (Simple mode), and manual point-buy allocation (Advanced mode).

The configuration file (`attributes.json`) has been extended with a `recommendedBuilds` section containing pre-configured attribute allocations for all four archetypes (Warrior, Skirmisher, Mystic, Adept).

---

## Added

### Domain Layer

#### Enums

- **`AttributeAllocationMode`** (`Enums/AttributeAllocationMode.cs`)
    - Enum with 2 values: `Simple` (0) and `Advanced` (1)
    - Explicit integer assignments (0-1) for stable serialization and database storage
    - Simple mode: archetype-recommended builds, no manual adjustment
    - Advanced mode: full point-buy customization with cost scaling
    - Comprehensive XML documentation with `<summary>`, `<remarks>`, `<list>`, `<para>`, `<seealso>` tags
    - Per-value remarks detailing mode behavior and recommended builds
    - `<seealso>` cross-references to `AttributeAllocationState` and `CoreAttribute`

#### Value Objects

- **`AttributeAllocationState`** (`ValueObjects/AttributeAllocationState.cs`)
    - `readonly record struct` with `{ get; init; }` properties tracking complete allocation state
    - File header with `═══` borders, filename, description, version `0.17.2b`
    - Section separators: PRIVATE FIELDS, PROPERTIES, COMPUTED PROPERTIES, ATTRIBUTE ACCESS, FACTORY METHODS, STATE TRANSITION METHODS, DEBUGGING
    - Static `ILogger<AttributeAllocationState>?` field for diagnostic output
    - Properties: `Mode`, `CurrentMight`, `CurrentFinesse`, `CurrentWits`, `CurrentWill`, `CurrentSturdiness`, `PointsSpent`, `PointsRemaining`, `TotalPoints`, `SelectedArchetypeId`
    - Computed properties: `IsComplete`, `AllowsManualAdjustment`, `HasSelectedArchetype`
    - `GetAttributeValue(CoreAttribute)`: Switch expression accessor for individual attribute values
    - `CreateAdvancedDefault(totalPoints, logger)`: All attributes at 1, full pool available
    - `CreateFromRecommendedBuild(archetypeId, might, finesse, wits, will, sturdiness, totalPoints, logger)`: Simple mode with validation and lowercase normalization
    - `WithAttributeValue(attribute, newValue, pointDelta)`: Advanced-only attribute modification via `with` expression; throws `InvalidOperationException` in Simple mode
    - `SwitchToAdvanced(pointsSpent)`: Preserves attribute values, clears archetype, enables manual adjustment
    - `ToString()`: Formatted as `[Mode] M:x F:x Wi:x Wl:x S:x (remaining/total remaining)`
    - Structured logging: Debug for creation/modification attempts, Information for successful creation/mode switching, Warning for invalid modifications

### Configuration Files

- **`config/attributes.json`** — Extended with `recommendedBuilds` section
    - 4 archetype builds: Warrior (M4 F3 Wi2 Wl2 S4, 15pts), Skirmisher (M3 F4 Wi3 Wl2 S3, 15pts), Mystic (M2 F3 Wi4 Wl4 S2, 15pts), Adept (M3 F3 Wi3 Wl2 S3, 14pts)
    - Each entry: `archetypeId`, `might`, `finesse`, `wits`, `will`, `sturdiness`, `totalPoints`

### Unit Tests

- **`AttributeAllocationModeTests`** (`Enums/AttributeAllocationModeTests.cs`) — 3 tests
    - `AttributeAllocationMode_HasTwoValues`: Verifies exactly 2 enum values
    - `AttributeAllocationMode_ContainsAllExpectedValues`: Verifies Simple and Advanced present
    - `AttributeAllocationMode_HasCorrectIntegerValues`: Parameterized test (Simple=0, Advanced=1)

- **`AttributeAllocationStateTests`** (`ValueObjects/AttributeAllocationStateTests.cs`) — 16 tests
    - `CreateAdvancedDefault_SetsAllAttributesToOne`: All attributes at 1, full pool available
    - `CreateAdvancedDefault_WithAdeptPoints_SetsCorrectPool`: 14-point Adept pool
    - `CreateFromRecommendedBuild_WarriorBuild_AppliesArchetypeValues`: Full Warrior build verification
    - `CreateFromRecommendedBuild_NormalizesArchetypeIdToLowercase`: Uppercase → lowercase normalization
    - `CreateFromRecommendedBuild_WithNullArchetypeId_ThrowsArgumentException`: Null rejection
    - `CreateFromRecommendedBuild_WithWhitespaceArchetypeId_ThrowsArgumentException`: Whitespace rejection
    - `WithAttributeValue_InSimpleMode_ThrowsInvalidOperationException`: Mode restriction enforcement
    - `WithAttributeValue_InAdvancedMode_UpdatesAttributeAndPoints`: Correct point tracking
    - `WithAttributeValue_AllAttributes_UpdatesCorrectAttribute`: Parameterized for all 5 attributes
    - `SwitchToAdvanced_PreservesValuesAndCalculatesPoints`: Mode transition verification
    - `GetAttributeValue_ReturnsCorrectValue`: Parameterized for all 5 attributes from Warrior build
    - `GetAttributeValue_WithInvalidAttribute_ThrowsArgumentOutOfRangeException`: Invalid enum value
    - `ToString_ReturnsFormattedString`: Simple mode format
    - `ToString_AdvancedDefault_ShowsCorrectFormat`: Advanced mode format

### Glossary

- **`config/glossary.json`** — Added allocation mode glossary entries
    - `simple-mode`: Simple Mode — guided attribute allocation using archetype-recommended builds (sortOrder: 8)
    - `advanced-mode`: Advanced Mode — full point-buy attribute customization for experienced players (sortOrder: 9)

---

## Changed

### Configuration Files

- **`config/schemas/attributes.schema.json`** — Extended for recommended builds
    - Added `recommendedBuilds` to root `required` array
    - Added `recommendedBuilds` property: array of `recommendedBuild` definitions (minItems: 1, maxItems: 10)
    - Added `recommendedBuild` definition with required fields: `archetypeId`, `might`, `finesse`, `wits`, `will`, `sturdiness`, `totalPoints`
    - `archetypeId`: lowercase pattern (`^[a-z][a-z0-9-]*$`)
    - Attribute values: integer, minimum 1, maximum 10
    - `totalPoints`: integer, minimum 1, maximum 50
    - `additionalProperties: false` on the definition
    - Updated root description to include recommended builds

---

## Design Decisions

### `{ get; init; }` Pattern for AttributeAllocationState

The design specification uses `{ get; init; }` properties with object initializer syntax rather than a primary constructor (which `AttributeDescription` uses). This pattern was followed as specified because `AttributeAllocationState` relies on `with` expressions for immutable state transitions, and the init-only properties work naturally with both object initializers and `with` expressions.

### Optional Logger Parameter on Factory Methods

The design specification's factory methods do not include a logger parameter, but the established codebase pattern (`BackgroundSkillGrant.Create()`, `AttributeDescription.Create()`) includes an optional `ILogger<T>?` parameter for diagnostic output. The codebase pattern was followed for consistency.

### Recommended Builds as Array (Not Object)

The design specification (Section 7.1) defines recommended builds as an array of objects with `archetypeId` fields, while the scope breakdown uses an object keyed by archetype name. The array format from the design specification was followed as it is more consistent with the existing `attributes` array pattern and allows for future extensibility.

### Glossary Placement in Mechanics Category

The Simple Mode and Advanced Mode terms were added to the `mechanics` category (not `attributes`) because they describe game system mechanics rather than character statistics. This follows the existing pattern where `stress`, `health`, and `resolve` are in the `mechanics` category.

---

## Dependencies

### Prerequisites

- v0.17.2a (CoreAttribute Enum & Description) — Complete, provides `CoreAttribute` for `GetAttributeValue()`

### Provides to Future Phases

| Type | Phase | Usage |
| ---- | ----- | ----- |
| `AttributeAllocationMode` | v0.17.2c | Mode parameter for point-buy cost validation |
| `AttributeAllocationState` | v0.17.2c | State tracking during point-buy operations |
| `AttributeAllocationMode` | v0.17.2f | Mode parameter in allocation service methods |
| `AttributeAllocationState` | v0.17.2f | State management in allocation service |
| `AttributeAllocationMode` | v0.17.5 | Mode selection in character creation Step 3 UI |
| `AttributeAllocationState` | v0.17.5 | Live state display during attribute allocation |
