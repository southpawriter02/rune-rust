# v0.17.2c Changelog: Point-Buy Cost System

**Version:** 0.17.2c
**Phase:** Point-Buy Cost System
**Date:** 2026-01-30
**Status:** Complete

---

## Summary

Implements the `PointBuyCost` and `PointBuyConfiguration` value objects that define the cost scaling system for Advanced mode attribute allocation during character creation. The system uses a tiered cost structure where standard attribute values (2-8) cost 1 point each and premium values (9-10) cost 2 points each, creating meaningful trade-offs during point-buy allocation.

This version provides the cost calculation foundation used by the allocation service (v0.17.2f) and attribute provider (v0.17.2e).

---

## Added

### Domain Layer - Value Objects

| Value Object | Description |
|--------------|-------------|
| `PointBuyCost` | Represents the cost to reach a specific attribute value (individual and cumulative) |
| `PointBuyConfiguration` | Complete point-buy config with pools, constraints, cost table, and calculation logic |

#### PointBuyCost Properties

| Property | Type | Description |
|----------|------|-------------|
| `TargetValue` | `int` | Attribute value this cost applies to (2-10) |
| `IndividualCost` | `int` | Points for single increment (1 standard, 2 premium) |
| `CumulativeCost` | `int` | Total points from base value of 1 |
| `IsPremiumTier` | `bool` | Whether value is 9 or 10 |
| `IsStandardTier` | `bool` | Whether value is 2-8 |

#### PointBuyCost Methods

| Method | Returns | Description |
|--------|---------|-------------|
| `Create(targetValue, individualCost, cumulativeCost)` | `PointBuyCost` | Factory with validation |
| `CreateDefaultCostTable()` | `IReadOnlyList<PointBuyCost>` | 9-entry default cost table |

#### PointBuyConfiguration Properties

| Property | Type | Description |
|----------|------|-------------|
| `StartingPoints` | `int` | Standard pool (15) |
| `AdeptStartingPoints` | `int` | Adept pool (14) |
| `MinAttributeValue` | `int` | Minimum attribute value (1) |
| `MaxAttributeValue` | `int` | Maximum attribute value (10) |
| `CostTable` | `IReadOnlyList<PointBuyCost>` | Tiered cost table |
| `CostTableEntryCount` | `int` | Number of cost entries |
| `HasCostTable` | `bool` | Whether cost table is populated |
| `MaxCumulativeCost` | `int` | Maximum cumulative cost (11) |

#### PointBuyConfiguration Methods

| Method | Returns | Description |
|--------|---------|-------------|
| `CreateDefault()` | `PointBuyConfiguration` | Factory with standard values |
| `GetStartingPointsForArchetype(archetypeId)` | `int` | 14 for Adept, 15 for others |
| `CalculateCost(fromValue, toValue)` | `int` | Bidirectional cost calculation |
| `GetIndividualCost(targetValue)` | `int` | Cost for single increment |
| `GetCumulativeCost(targetValue)` | `int` | Total cost from base |
| `CanAfford(currentValue, targetValue, pointsRemaining)` | `bool` | Affordability check |
| `GetMaxReachableValue(currentValue, pointsRemaining)` | `int` | Highest affordable value |

### Configuration

| File | Change |
|------|--------|
| `config/attributes.json` | Added `pointBuy` section with cost table, starting points, value constraints |
| `config/schemas/attributes.schema.json` | Added `pointBuyConfiguration` and `pointBuyCostEntry` definitions |
| `config/glossary.json` | Added "Point-Buy" and "Premium Tier" glossary terms |

### Tests

#### PointBuyCostTests (~15 tests)

- Default cost table structure (entry count, target values, individual costs, cumulative costs)
- Tier classification (IsPremiumTier, IsStandardTier)
- Factory method validation (valid params, out-of-range target, negative costs)
- ToString formatting

#### PointBuyConfigurationTests (~30 tests)

- CreateDefault factory values
- Cost calculations (standard tier, premium tier, full range, decreases/refunds, no-change)
- Individual and cumulative cost lookups (via TestCase parametrized tests)
- Archetype starting points (Adept=14, others=15, case-insensitive)
- Affordability checks (sufficient, insufficient, out-of-range, exact boundary, decreases)
- Max reachable value calculations (full pool, standard-only, no points, limited premium)
- ToString formatting

#### AttributePointBuySchemaTests (~4 tests)

- Schema structure (contains pointBuy definitions)
- Schema requires pointBuy property
- Existing attributes.json validates against updated schema
- Invalid data fails validation (missing pointBuy, missing costTable)

---

## Cost Table Reference

| Target Value | Individual Cost | Cumulative Cost | Tier |
|:---:|:---:|:---:|:---|
| 2 | 1 | 1 | Standard |
| 3 | 1 | 2 | Standard |
| 4 | 1 | 3 | Standard |
| 5 | 1 | 4 | Standard |
| 6 | 1 | 5 | Standard |
| 7 | 1 | 6 | Standard |
| 8 | 1 | 7 | Standard |
| 9 | 2 | 9 | Premium |
| 10 | 2 | 11 | Premium |

---

## Files Created

| Path | Description |
|------|-------------|
| `src/Core/RuneAndRust.Domain/ValueObjects/PointBuyCost.cs` | Point-buy cost value object |
| `src/Core/RuneAndRust.Domain/ValueObjects/PointBuyConfiguration.cs` | Point-buy configuration value object |
| `tests/RuneAndRust.Domain.UnitTests/ValueObjects/PointBuyCostTests.cs` | PointBuyCost unit tests |
| `tests/RuneAndRust.Domain.UnitTests/ValueObjects/PointBuyConfigurationTests.cs` | PointBuyConfiguration unit tests |
| `tests/RuneAndRust.Infrastructure.IntegrationTests/Schemas/AttributePointBuySchemaTests.cs` | Schema validation tests |

## Files Modified

| Path | Description |
|------|-------------|
| `config/attributes.json` | Added pointBuy section with cost table |
| `config/schemas/attributes.schema.json` | Added pointBuy schema definitions |
| `config/glossary.json` | Added Point-Buy and Premium Tier terms |
| `docs/design/v0.17.x/v0.17.2-scope-breakdown.md` | Checked off v0.17.2c deliverables |
| `docs/design/v0.17.x/v0.17.x-overview.md` | Updated v0.17.2 deliverable checkboxes |

---

## Dependencies

### Required From Prior Versions

| Version | Dependency | Usage |
|---------|------------|-------|
| v0.17.2b | `AttributeAllocationState` | Uses TotalPoints from config |
| v0.17.2a | `CoreAttribute` | Referenced in cost context |

### Provides To Future Versions

| Version | Feature | Usage |
|---------|---------|-------|
| v0.17.2e | `PointBuyConfiguration` | Provider loads and returns config |
| v0.17.2f | `PointBuyConfiguration` | Allocation service uses for cost validation |

---

## Key Design Decisions

1. **Tiered Pricing** - Premium tier (9-10) costs 2x standard to create meaningful max-attribute trade-offs
2. **Bidirectional Calculation** - CalculateCost supports both increases (positive) and decreases (negative refund)
3. **Archetype Variance** - Adept gets 14 points (vs 15) to balance broader utility access
4. **Configuration-Driven** - Cost table loaded from JSON for easy balance tuning
5. **Fallback Logic** - GetIndividualCost falls back to tier-based defaults if table entry not found
6. **Immutable Value Objects** - Both types are `readonly record struct` for thread safety

---

## Logging Strategy

| Level | When |
|-------|------|
| Debug | Cost calculation steps, affordability checks, table lookups |
| Information | Configuration created, cost table generated |
| Warning | (Reserved for future configuration validation issues) |

---

## Notes

- The cost table contains 9 entries (values 2-10); base value 1 has no cost
- Maximum cumulative cost is 11 points (to reach value 10 from base)
- 15-point pool can achieve one maxed attribute (10) plus 4 remaining points
- 14-point Adept pool can achieve one maxed attribute (10) plus 3 remaining points
- Refund symmetry: decreasing always returns exactly the cost of the equivalent increase
