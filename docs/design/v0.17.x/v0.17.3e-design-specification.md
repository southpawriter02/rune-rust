# v0.17.3e Design Specification: Archetype Provider Service

**Version:** 0.17.3e  
**Phase Name:** Archetype Provider Service  
**Parent Version:** v0.17.3 (Archetype System)  
**Prerequisites:** v0.17.3d Complete (Available Specializations)  
**Estimated Tests:** ~10 unit tests

---

## Table of Contents

1. [Executive Summary](#1-executive-summary)
2. [Feature Overview](#2-feature-overview)
3. [Architecture Diagrams](#3-architecture-diagrams)
4. [IArchetypeProvider Interface](#4-iarchetypeprovider-interface)
5. [ArchetypeProvider Implementation](#5-archetypeprovider-implementation)
6. [Data Model Changes](#6-data-model-changes)
7. [Configuration Loading](#7-configuration-loading)
8. [Logging Specifications](#8-logging-specifications)
9. [Unit Testing Requirements](#9-unit-testing-requirements)
10. [Use Cases](#10-use-cases)
11. [User Stories](#11-user-stories)
12. [Deliverable Checklist](#12-deliverable-checklist)
13. [Acceptance Criteria](#13-acceptance-criteria)
14. [Dependencies](#14-dependencies)
15. [Future Considerations](#15-future-considerations)

---

## 1. Executive Summary

### 1.1 Purpose

This specification defines the `IArchetypeProvider` interface and `ArchetypeProvider` service that provides access to archetype definitions, resource bonuses, starting abilities, and specialization mappings. This service is the central access point for all archetype-related data.

The provider service:

- Loads archetype configurations from `archetypes.json`
- Provides lookup methods for archetype definitions
- Returns resource bonuses, abilities, and specializations
- Supports recommended builds based on archetype and lineage
- Caches loaded data for performance

### 1.2 Key Deliverables

| Category       | Items                |
| -------------- | -------------------- |
| **Interfaces** | `IArchetypeProvider` |
| **Services**   | `ArchetypeProvider`  |
| **Tests**      | ~10 unit tests       |

### 1.3 Architectural Significance

This version establishes the **Provider Pattern** for archetype data access:

- **Single Source of Truth**: All archetype data flows through this provider
- **Configuration-Driven**: Loads from JSON for runtime customization
- **Lazy Loading**: Data loaded on first access, then cached
- **Dependency Injection Ready**: Interface-based design for testability
- **Composite Data Access**: Aggregates definitions, bonuses, abilities, and specializations

---

## 2. Feature Overview

```
v0.17.3e Archetype Provider Service
├── IArchetypeProvider Interface
│   ├── GetArchetype(Archetype): ArchetypeDefinition?
│   ├── GetAllArchetypes(): IReadOnlyList<ArchetypeDefinition>
│   ├── GetResourceBonuses(Archetype): ArchetypeResourceBonuses
│   ├── GetStartingAbilities(Archetype): IReadOnlyList<ArchetypeAbilityGrant>
│   ├── GetSpecializationMapping(Archetype): ArchetypeSpecializationMapping
│   ├── GetSelectionText(Archetype): string
│   └── GetRecommendedBuild(Archetype, Lineage?): RecommendedBuild?
├── ArchetypeProvider Implementation
│   ├── JSON configuration loading
│   ├── Data caching
│   ├── Archetype lookup by enum
│   └── Composite data aggregation
└── Configuration Integration
    └── archetypes.json (full schema)
```

### 2.1 Scope Alignment

**In Scope:**

- `IArchetypeProvider` interface with all lookup methods
- `ArchetypeProvider` service implementation
- JSON configuration loading from `archetypes.json`
- Data caching for performance
- Full archetype data aggregation

**Out of Scope:**

- Archetype application to characters → v0.17.3f
- Character creation workflow → v0.17.5
- Runtime archetype modification
- Database persistence (configuration-based only)

---

## 3. Architecture Diagrams

### 3.1 Provider Service Overview

```
┌─────────────────────────────────────────────────────────────────────┐
│                  ARCHETYPE PROVIDER SERVICE OVERVIEW                 │
└─────────────────────────────────────────────────────────────────────┘

    Consumer (Character Creation, Combat, UI)
           │
           │  Request archetype data
           ▼
┌─────────────────────────────────────────────────────────────────────┐
│                       IArchetypeProvider                             │
├─────────────────────────────────────────────────────────────────────┤
│  + GetArchetype(Archetype): ArchetypeDefinition?                    │
│  + GetAllArchetypes(): IReadOnlyList<ArchetypeDefinition>           │
│  + GetResourceBonuses(Archetype): ArchetypeResourceBonuses          │
│  + GetStartingAbilities(Archetype): IReadOnlyList<AbilityGrant>     │
│  + GetSpecializationMapping(Archetype): SpecializationMapping       │
│  + GetSelectionText(Archetype): string                              │
│  + GetRecommendedBuild(Archetype, Lineage?): RecommendedBuild?      │
└─────────────────────────────────────────────────────────────────────┘
           │
           │  Implements
           ▼
┌─────────────────────────────────────────────────────────────────────┐
│                       ArchetypeProvider                              │
├─────────────────────────────────────────────────────────────────────┤
│  - _archetypes: Dictionary<Archetype, ArchetypeData>                │
│  - _isLoaded: bool                                                   │
│  - _configPath: string                                               │
│  - _logger: ILogger                                                  │
├─────────────────────────────────────────────────────────────────────┤
│  Private methods:                                                    │
│  - LoadConfiguration()                                               │
│  - EnsureLoaded()                                                    │
│  - ParseArchetypeData(json)                                          │
└─────────────────────────────────────────────────────────────────────┘
           │
           │  Loads from
           ▼
┌─────────────────────────────────────────────────────────────────────┐
│                       archetypes.json                                │
├─────────────────────────────────────────────────────────────────────┤
│  {                                                                   │
│    "archetypes": [                                                   │
│      { definition, resourceBonuses, abilities, specializations }    │
│    ]                                                                 │
│  }                                                                   │
└─────────────────────────────────────────────────────────────────────┘
```

### 3.2 Data Flow Diagram

```
┌─────────────────────────────────────────────────────────────────────┐
│                        DATA FLOW DIAGRAM                             │
└─────────────────────────────────────────────────────────────────────┘

    archetypes.json
           │
           │  Load on first access
           ▼
    ┌──────────────────────────────────────────────────────────────────┐
    │ Parse JSON to intermediate DTOs                                  │
    │ ArchetypeConfigDto → ArchetypeData                               │
    └──────────────────────────────────────────────────────────────────┘
           │
           ▼
    ┌──────────────────────────────────────────────────────────────────┐
    │ Build domain objects from parsed data                            │
    │ - ArchetypeDefinition (v0.17.3a)                                 │
    │ - ArchetypeResourceBonuses (v0.17.3b)                            │
    │ - ArchetypeAbilityGrant[] (v0.17.3c)                             │
    │ - ArchetypeSpecializationMapping (v0.17.3d)                      │
    └──────────────────────────────────────────────────────────────────┘
           │
           ▼
    ┌──────────────────────────────────────────────────────────────────┐
    │ Cache in Dictionary<Archetype, ArchetypeData>                    │
    │ (4 entries, one per archetype)                                   │
    └──────────────────────────────────────────────────────────────────┘
           │
           ▼
    Consumers access via IArchetypeProvider methods
```

### 3.3 Lookup Flow

```
┌─────────────────────────────────────────────────────────────────────┐
│                         LOOKUP FLOW                                  │
└─────────────────────────────────────────────────────────────────────┘

    GetArchetype(Archetype.Warrior)
           │
           ▼
    ┌──────────────────────┐
    │ EnsureLoaded()       │
    └──────────┬───────────┘
               │
        ┌──────┴──────┐
    Already           Not
    Loaded            Loaded
        │              │
        │              ▼
        │         ┌────────────────┐
        │         │ LoadConfiguration()
        │         │ Parse JSON     │
        │         │ Cache data     │
        │         └────────────────┘
        │              │
        └──────────────┘
               │
               ▼
    ┌──────────────────────────────────────────────────────────────────┐
    │ Look up archetype in cache                                       │
    │ _archetypes.TryGetValue(Archetype.Warrior, out data)             │
    └──────────────────────────────────────────────────────────────────┘
               │
        ┌──────┴──────┐
      Found        Not Found
        │              │
        ▼              ▼
    Return         Return null
    Definition     (log warning)
```

### 3.4 Composite Data Structure

```
┌─────────────────────────────────────────────────────────────────────┐
│                   COMPOSITE DATA STRUCTURE                           │
└─────────────────────────────────────────────────────────────────────┘

    Dictionary<Archetype, ArchetypeData>
           │
           ├─── Archetype.Warrior ─────────────────────────────────────┐
           │    ArchetypeData                                          │
           │    ├── Definition: ArchetypeDefinition                    │
           │    │   (Warrior, "The Unyielding Bulwark", ...)          │
           │    ├── ResourceBonuses: ArchetypeResourceBonuses          │
           │    │   (HP+49, Stamina+5, AP+0, Move+0)                   │
           │    ├── StartingAbilities: List<ArchetypeAbilityGrant>     │
           │    │   [Power Strike, Defensive Stance, Iron Will]        │
           │    └── SpecializationMapping: ArchetypeSpecializationMap  │
           │        (6 specs, recommended: guardian)                   │
           │                                                           │
           ├─── Archetype.Skirmisher ──────────────────────────────────┤
           │    ...                                                    │
           ├─── Archetype.Mystic ──────────────────────────────────────┤
           │    ...                                                    │
           └─── Archetype.Adept ───────────────────────────────────────┘
                ...
```

### 3.5 Layer Diagram

```
┌─────────────────────────────────────────────────────────────────────┐
│                        PRESENTATION LAYER                            │
├─────────────────────────────────────────────────────────────────────┤
│  CharacterCreationView (v0.17.5)                                     │
│  └── Calls IArchetypeProvider.GetAllArchetypes()                    │
│  └── Calls IArchetypeProvider.GetSelectionText()                    │
│                                                                      │
│  ArchetypeSelectionPanel                                             │
│  └── Calls IArchetypeProvider.GetResourceBonuses()                  │
│  └── Calls IArchetypeProvider.GetStartingAbilities()                │
└───────┬─────────────────────────────────────────────────────────────┘
        │
        ▼
┌─────────────────────────────────────────────────────────────────────┐
│                       APPLICATION LAYER                              │
├─────────────────────────────────────────────────────────────────────┤
│  ┌───────────────────────────────────────────────────────────────┐  │
│  │                    IArchetypeProvider                         │  │
│  │                      (Interface)                              │  │
│  ├───────────────────────────────────────────────────────────────┤  │
│  │  + GetArchetype(Archetype): ArchetypeDefinition?              │  │
│  │  + GetAllArchetypes(): IReadOnlyList<ArchetypeDefinition>     │  │
│  │  + GetResourceBonuses(Archetype): ResourceBonuses             │  │
│  │  + GetStartingAbilities(Archetype): IReadOnlyList<Grant>      │  │
│  │  + GetSpecializationMapping(Archetype): Mapping               │  │
│  │  + GetSelectionText(Archetype): string                        │  │
│  │  + GetRecommendedBuild(Archetype, Lineage?): Build?           │  │
│  └───────────────────────────────────────────────────────────────┘  │
│                              ▲                                       │
│                              │ implements                            │
│  ┌───────────────────────────────────────────────────────────────┐  │
│  │                     ArchetypeProvider                         │  │
│  │                    (Implementation)                           │  │
│  ├───────────────────────────────────────────────────────────────┤  │
│  │  - _archetypes: Dictionary                                    │  │
│  │  - _logger: ILogger                                           │  │
│  │  - LoadConfiguration()                                        │  │
│  └───────────────────────────────────────────────────────────────┘  │
└───────┬─────────────────────────────────────────────────────────────┘
        │
        ▼
┌─────────────────────────────────────────────────────────────────────┐
│                         DOMAIN LAYER                                 │
├─────────────────────────────────────────────────────────────────────┤
│  ArchetypeDefinition (v0.17.3a)                                      │
│  ArchetypeResourceBonuses (v0.17.3b)                                 │
│  ArchetypeAbilityGrant (v0.17.3c)                                    │
│  ArchetypeSpecializationMapping (v0.17.3d)                           │
└─────────────────────────────────────────────────────────────────────┘
```

---

## 4. IArchetypeProvider Interface

### 4.1 Purpose

The `IArchetypeProvider` interface defines the contract for accessing archetype data throughout the application. This is the primary entry point for any component needing archetype information.

### 4.2 Implementation

**File:** `src/Core/RuneAndRust.Application/Interfaces/IArchetypeProvider.cs`

```csharp
namespace RuneAndRust.Application.Interfaces;

using RuneAndRust.Domain.Entities;
using RuneAndRust.Domain.Enums;
using RuneAndRust.Domain.ValueObjects;

/// <summary>
/// Provides access to archetype definitions and related data.
/// </summary>
/// <remarks>
/// <para>
/// IArchetypeProvider is the central access point for all archetype-related
/// data. It aggregates definitions, resource bonuses, starting abilities,
/// and specialization mappings into a single cohesive API.
/// </para>
/// <para>
/// Implementations load data from configuration and cache it for performance.
/// All methods are safe to call multiple times without performance penalty.
/// </para>
/// </remarks>
public interface IArchetypeProvider
{
    /// <summary>
    /// Gets the definition for a specific archetype.
    /// </summary>
    /// <param name="archetype">The archetype to look up.</param>
    /// <returns>The archetype definition, or null if not found.</returns>
    ArchetypeDefinition? GetArchetype(Archetype archetype);

    /// <summary>
    /// Gets all archetype definitions.
    /// </summary>
    /// <returns>List of all 4 archetype definitions.</returns>
    IReadOnlyList<ArchetypeDefinition> GetAllArchetypes();

    /// <summary>
    /// Gets the resource bonuses for an archetype.
    /// </summary>
    /// <param name="archetype">The archetype to look up.</param>
    /// <returns>The resource bonuses for the archetype.</returns>
    ArchetypeResourceBonuses GetResourceBonuses(Archetype archetype);

    /// <summary>
    /// Gets the starting abilities for an archetype.
    /// </summary>
    /// <param name="archetype">The archetype to look up.</param>
    /// <returns>List of 3 starting ability grants.</returns>
    IReadOnlyList<ArchetypeAbilityGrant> GetStartingAbilities(Archetype archetype);

    /// <summary>
    /// Gets the specialization mapping for an archetype.
    /// </summary>
    /// <param name="archetype">The archetype to look up.</param>
    /// <returns>The specialization mapping with available specs and recommended first.</returns>
    ArchetypeSpecializationMapping GetSpecializationMapping(Archetype archetype);

    /// <summary>
    /// Gets the selection flavor text for an archetype.
    /// </summary>
    /// <param name="archetype">The archetype to look up.</param>
    /// <returns>The selection text for character creation display.</returns>
    string GetSelectionText(Archetype archetype);

    /// <summary>
    /// Gets a recommended attribute build for an archetype and optional lineage.
    /// </summary>
    /// <param name="archetype">The archetype for the build.</param>
    /// <param name="lineage">Optional lineage for build optimization.</param>
    /// <returns>
    /// A recommended build with attribute allocation, or null if no
    /// recommendation is available for the combination.
    /// </returns>
    /// <remarks>
    /// Recommended builds suggest optimal attribute distributions based on
    /// archetype role and lineage synergies.
    /// </remarks>
    RecommendedBuild? GetRecommendedBuild(Archetype archetype, Lineage? lineage = null);

    /// <summary>
    /// Checks if a specialization is available for an archetype.
    /// </summary>
    /// <param name="archetype">The archetype to check.</param>
    /// <param name="specializationId">The specialization ID to check.</param>
    /// <returns>True if the specialization is available for the archetype.</returns>
    bool IsSpecializationAvailable(Archetype archetype, string specializationId);
}
```

---

## 5. ArchetypeProvider Implementation

### 5.1 Purpose

The `ArchetypeProvider` service implements `IArchetypeProvider`, loading archetype data from JSON configuration and caching it for efficient access.

### 5.2 Implementation

**File:** `src/Core/RuneAndRust.Application/Services/ArchetypeProvider.cs`

```csharp
namespace RuneAndRust.Application.Services;

using System.Text.Json;
using Microsoft.Extensions.Logging;
using RuneAndRust.Application.Interfaces;
using RuneAndRust.Domain.Entities;
using RuneAndRust.Domain.Enums;
using RuneAndRust.Domain.ValueObjects;

/// <summary>
/// Provides archetype data loaded from JSON configuration.
/// </summary>
public class ArchetypeProvider : IArchetypeProvider
{
    private readonly string _configPath;
    private readonly ILogger<ArchetypeProvider> _logger;
    private readonly Dictionary<Archetype, ArchetypeData> _archetypes = new();
    private bool _isLoaded;
    private readonly object _loadLock = new();

    /// <summary>
    /// Initializes a new instance of the ArchetypeProvider.
    /// </summary>
    /// <param name="configPath">Path to archetypes.json configuration file.</param>
    /// <param name="logger">Logger instance.</param>
    public ArchetypeProvider(string configPath, ILogger<ArchetypeProvider> logger)
    {
        ArgumentException.ThrowIfNullOrWhiteSpace(configPath);
        ArgumentNullException.ThrowIfNull(logger);

        _configPath = configPath;
        _logger = logger;

        _logger.LogInformation(
            "ArchetypeProvider initialized with config path: {ConfigPath}",
            configPath);
    }

    /// <inheritdoc />
    public ArchetypeDefinition? GetArchetype(Archetype archetype)
    {
        EnsureLoaded();

        if (_archetypes.TryGetValue(archetype, out var data))
        {
            _logger.LogDebug("Retrieved archetype definition: {Archetype}", archetype);
            return data.Definition;
        }

        _logger.LogWarning("Archetype not found: {Archetype}", archetype);
        return null;
    }

    /// <inheritdoc />
    public IReadOnlyList<ArchetypeDefinition> GetAllArchetypes()
    {
        EnsureLoaded();

        var definitions = _archetypes.Values
            .Select(a => a.Definition)
            .OrderBy(d => (int)d.ArchetypeId)
            .ToList();

        _logger.LogDebug("Retrieved all {Count} archetype definitions", definitions.Count);
        return definitions;
    }

    /// <inheritdoc />
    public ArchetypeResourceBonuses GetResourceBonuses(Archetype archetype)
    {
        EnsureLoaded();

        if (_archetypes.TryGetValue(archetype, out var data))
        {
            _logger.LogDebug(
                "Retrieved resource bonuses for {Archetype}: {Summary}",
                archetype, data.ResourceBonuses.GetDisplaySummary());
            return data.ResourceBonuses;
        }

        _logger.LogWarning(
            "Resource bonuses not found for {Archetype}, returning None",
            archetype);
        return ArchetypeResourceBonuses.None;
    }

    /// <inheritdoc />
    public IReadOnlyList<ArchetypeAbilityGrant> GetStartingAbilities(Archetype archetype)
    {
        EnsureLoaded();

        if (_archetypes.TryGetValue(archetype, out var data))
        {
            _logger.LogDebug(
                "Retrieved {Count} starting abilities for {Archetype}",
                data.StartingAbilities.Count, archetype);
            return data.StartingAbilities;
        }

        _logger.LogWarning(
            "Starting abilities not found for {Archetype}, returning empty",
            archetype);
        return Array.Empty<ArchetypeAbilityGrant>();
    }

    /// <inheritdoc />
    public ArchetypeSpecializationMapping GetSpecializationMapping(Archetype archetype)
    {
        EnsureLoaded();

        if (_archetypes.TryGetValue(archetype, out var data))
        {
            _logger.LogDebug(
                "Retrieved specialization mapping for {Archetype}: {Count} available",
                archetype, data.SpecializationMapping.Count);
            return data.SpecializationMapping;
        }

        _logger.LogWarning(
            "Specialization mapping not found for {Archetype}",
            archetype);
        return ArchetypeSpecializationMapping.GetForArchetype(archetype);
    }

    /// <inheritdoc />
    public string GetSelectionText(Archetype archetype)
    {
        var definition = GetArchetype(archetype);
        return definition?.SelectionText ?? string.Empty;
    }

    /// <inheritdoc />
    public RecommendedBuild? GetRecommendedBuild(Archetype archetype, Lineage? lineage = null)
    {
        EnsureLoaded();

        if (!_archetypes.TryGetValue(archetype, out var data))
        {
            _logger.LogWarning(
                "No recommended build available for {Archetype}",
                archetype);
            return null;
        }

        // Get base recommended build for archetype
        var build = data.RecommendedBuilds.FirstOrDefault(b =>
            lineage.HasValue
                ? b.OptimalLineage == lineage
                : b.OptimalLineage == null);

        // Fall back to default build if no lineage-specific build
        build ??= data.RecommendedBuilds.FirstOrDefault(b => b.OptimalLineage == null);

        _logger.LogDebug(
            "Retrieved recommended build for {Archetype}/{Lineage}: {Build}",
            archetype, lineage, build?.Name ?? "None");

        return build;
    }

    /// <inheritdoc />
    public bool IsSpecializationAvailable(Archetype archetype, string specializationId)
    {
        var mapping = GetSpecializationMapping(archetype);
        return mapping.IsSpecializationAvailable(specializationId);
    }

    private void EnsureLoaded()
    {
        if (_isLoaded) return;

        lock (_loadLock)
        {
            if (_isLoaded) return;

            LoadConfiguration();
            _isLoaded = true;
        }
    }

    private void LoadConfiguration()
    {
        _logger.LogInformation("Loading archetype configuration from {Path}", _configPath);

        try
        {
            var json = File.ReadAllText(_configPath);
            var config = JsonSerializer.Deserialize<ArchetypeConfigRoot>(json, new JsonSerializerOptions
            {
                PropertyNameCaseInsensitive = true
            });

            if (config?.Archetypes == null || config.Archetypes.Count == 0)
            {
                _logger.LogError("No archetypes found in configuration");
                LoadDefaultArchetypes();
                return;
            }

            foreach (var archetypeConfig in config.Archetypes)
            {
                var data = ParseArchetypeData(archetypeConfig);
                _archetypes[data.Definition.ArchetypeId] = data;
            }

            _logger.LogInformation(
                "Loaded {Count} archetypes from configuration",
                _archetypes.Count);
        }
        catch (Exception ex)
        {
            _logger.LogError(ex, "Failed to load archetype configuration, using defaults");
            LoadDefaultArchetypes();
        }
    }

    private void LoadDefaultArchetypes()
    {
        _logger.LogWarning("Loading default archetype definitions");

        foreach (Archetype archetype in Enum.GetValues<Archetype>())
        {
            _archetypes[archetype] = CreateDefaultArchetypeData(archetype);
        }
    }

    private static ArchetypeData ParseArchetypeData(ArchetypeConfigDto config)
    {
        var archetypeId = Enum.Parse<Archetype>(config.ArchetypeId, ignoreCase: true);

        var definition = ArchetypeDefinition.Create(
            archetypeId,
            config.DisplayName,
            config.Tagline,
            config.Description,
            config.SelectionText,
            config.CombatRole,
            Enum.Parse<ResourceType>(config.PrimaryResource, ignoreCase: true),
            config.PlaystyleDescription);

        var resourceBonuses = ArchetypeResourceBonuses.Create(
            config.ResourceBonuses.MaxHpBonus,
            config.ResourceBonuses.MaxStaminaBonus,
            config.ResourceBonuses.MaxAetherPoolBonus,
            config.ResourceBonuses.MovementBonus,
            config.ResourceBonuses.SpecialBonus != null
                ? ArchetypeSpecialBonus.Create(
                    config.ResourceBonuses.SpecialBonus.BonusType,
                    config.ResourceBonuses.SpecialBonus.BonusValue,
                    config.ResourceBonuses.SpecialBonus.Description)
                : null);

        var startingAbilities = config.StartingAbilities
            .Select(a => ArchetypeAbilityGrant.Create(
                a.AbilityId,
                a.AbilityName,
                Enum.Parse<AbilityType>(a.AbilityType, ignoreCase: true),
                a.Description))
            .ToList();

        var specializationMapping = ArchetypeSpecializationMapping.Create(
            archetypeId,
            config.AvailableSpecializations.Specializations,
            config.AvailableSpecializations.RecommendedFirst);

        var recommendedBuilds = config.RecommendedBuilds?
            .Select(b => new RecommendedBuild(
                b.Name,
                b.Might, b.Finesse, b.Wits, b.Will, b.Sturdiness,
                b.OptimalLineage != null
                    ? Enum.Parse<Lineage>(b.OptimalLineage, ignoreCase: true)
                    : null))
            .ToList() ?? new List<RecommendedBuild>();

        return new ArchetypeData(
            definition,
            resourceBonuses,
            startingAbilities,
            specializationMapping,
            recommendedBuilds);
    }

    private static ArchetypeData CreateDefaultArchetypeData(Archetype archetype) =>
        archetype switch
        {
            Archetype.Warrior => new ArchetypeData(
                ArchetypeDefinition.Create(
                    Archetype.Warrior, "Warrior", "The Unyielding Bulwark",
                    "Warriors are the frontline fighters.",
                    "You are the shield.", "Tank / Melee DPS",
                    ResourceType.Stamina, "Tank and deal melee damage."),
                ArchetypeResourceBonuses.Warrior,
                CreateDefaultWarriorAbilities(),
                ArchetypeSpecializationMapping.Warrior,
                new List<RecommendedBuild>()),
            // ... similar for other archetypes
            _ => throw new ArgumentOutOfRangeException(nameof(archetype))
        };

    private static List<ArchetypeAbilityGrant> CreateDefaultWarriorAbilities() =>
        new()
        {
            ArchetypeAbilityGrant.CreateActive("power-strike", "Power Strike",
                "A powerful melee attack."),
            ArchetypeAbilityGrant.CreateStance("defensive-stance", "Defensive Stance",
                "Reduces damage taken."),
            ArchetypeAbilityGrant.CreatePassive("iron-will", "Iron Will",
                "Resistance to fear.")
        };

    // Internal record for cached archetype data
    private sealed record ArchetypeData(
        ArchetypeDefinition Definition,
        ArchetypeResourceBonuses ResourceBonuses,
        IReadOnlyList<ArchetypeAbilityGrant> StartingAbilities,
        ArchetypeSpecializationMapping SpecializationMapping,
        IReadOnlyList<RecommendedBuild> RecommendedBuilds);
}

// Configuration DTOs for JSON deserialization
internal sealed record ArchetypeConfigRoot(List<ArchetypeConfigDto> Archetypes);

internal sealed record ArchetypeConfigDto(
    string ArchetypeId,
    string DisplayName,
    string Tagline,
    string Description,
    string SelectionText,
    string CombatRole,
    string PrimaryResource,
    string PlaystyleDescription,
    ResourceBonusesDto ResourceBonuses,
    List<AbilityGrantDto> StartingAbilities,
    SpecializationsDto AvailableSpecializations,
    List<RecommendedBuildDto>? RecommendedBuilds);

internal sealed record ResourceBonusesDto(
    int MaxHpBonus,
    int MaxStaminaBonus,
    int MaxAetherPoolBonus,
    int MovementBonus,
    SpecialBonusDto? SpecialBonus);

internal sealed record SpecialBonusDto(
    string BonusType,
    float BonusValue,
    string Description);

internal sealed record AbilityGrantDto(
    string AbilityId,
    string AbilityName,
    string AbilityType,
    string Description);

internal sealed record SpecializationsDto(
    List<string> Specializations,
    string RecommendedFirst);

internal sealed record RecommendedBuildDto(
    string Name,
    int Might,
    int Finesse,
    int Wits,
    int Will,
    int Sturdiness,
    string? OptimalLineage);
```

---

## 6. Data Model Changes

### 6.1 New Types Summary

| Type                 | Layer       | Category     | Description                    |
| -------------------- | ----------- | ------------ | ------------------------------ |
| `IArchetypeProvider` | Application | Interface    | Archetype data access contract |
| `ArchetypeProvider`  | Application | Service      | JSON-based implementation      |
| `RecommendedBuild`   | Domain      | Value Object | Recommended attribute build    |

### 6.2 File Locations

```
src/Core/RuneAndRust.Application/
├── Interfaces/
│   └── IArchetypeProvider.cs                    ← NEW
├── Services/
│   └── ArchetypeProvider.cs                     ← NEW

src/Core/RuneAndRust.Domain/
├── ValueObjects/
│   └── RecommendedBuild.cs                      ← NEW
```

---

## 7. Configuration Loading

### 7.1 Complete archetypes.json Schema

The provider loads from a complete `archetypes.json` that combines all previous sections:

```json
{
    "$schema": "./schemas/archetypes.schema.json",
    "archetypes": [
        {
            "archetypeId": "Warrior",
            "displayName": "Warrior",
            "tagline": "The Unyielding Bulwark",
            "description": "Warriors are the frontline fighters...",
            "selectionText": "You are the shield...",
            "combatRole": "Tank / Melee DPS",
            "primaryResource": "Stamina",
            "playstyleDescription": "Stand in the front...",
            "resourceBonuses": { ... },
            "startingAbilities": [ ... ],
            "availableSpecializations": { ... },
            "recommendedBuilds": [
                {
                    "name": "Standard Warrior",
                    "might": 4,
                    "finesse": 3,
                    "wits": 2,
                    "will": 2,
                    "sturdiness": 4,
                    "optimalLineage": null
                }
            ]
        }
    ]
}
```

---

## 8. Logging Specifications

### 8.1 Log Levels by Component

| Component           | Level       | Events                              |
| ------------------- | ----------- | ----------------------------------- |
| `ArchetypeProvider` | Information | Provider initialized, config loaded |
| `ArchetypeProvider` | Debug       | Individual lookups, cache hits      |
| `ArchetypeProvider` | Warning     | Archetype not found, using defaults |
| `ArchetypeProvider` | Error       | Config load failure                 |

### 8.2 Logging Templates

```csharp
// Information
"ArchetypeProvider initialized with config path: {ConfigPath}"
"Loaded {Count} archetypes from configuration"

// Debug
"Retrieved archetype definition: {Archetype}"
"Retrieved resource bonuses for {Archetype}: {Summary}"
"Retrieved {Count} starting abilities for {Archetype}"

// Warning
"Archetype not found: {Archetype}"
"Loading default archetype definitions"

// Error
"Failed to load archetype configuration, using defaults"
"No archetypes found in configuration"
```

---

## 9. Unit Testing Requirements

### 9.1 Test Count: ~10 tests

```csharp
[TestFixture]
public class ArchetypeProviderTests
{
    private IArchetypeProvider _provider;
    private Mock<ILogger<ArchetypeProvider>> _loggerMock;

    [SetUp]
    public void Setup()
    {
        _loggerMock = new Mock<ILogger<ArchetypeProvider>>();
        // Use test config or in-memory approach
        _provider = CreateTestProvider();
    }

    [Test]
    public void GetArchetype_Warrior_ReturnsDefinition()
    {
        // Act
        var definition = _provider.GetArchetype(Archetype.Warrior);

        // Assert
        definition.Should().NotBeNull();
        definition!.DisplayName.Should().Be("Warrior");
        definition.CombatRole.Should().Be("Tank / Melee DPS");
    }

    [Test]
    public void GetAllArchetypes_ReturnsFourArchetypes()
    {
        // Act
        var archetypes = _provider.GetAllArchetypes();

        // Assert
        archetypes.Should().HaveCount(4);
        archetypes.Select(a => a.ArchetypeId).Should().BeEquivalentTo(
            new[] { Archetype.Warrior, Archetype.Skirmisher, Archetype.Mystic, Archetype.Adept });
    }

    [Test]
    public void GetResourceBonuses_Warrior_ReturnsCorrectBonuses()
    {
        // Act
        var bonuses = _provider.GetResourceBonuses(Archetype.Warrior);

        // Assert
        bonuses.MaxHpBonus.Should().Be(49);
        bonuses.MaxStaminaBonus.Should().Be(5);
        bonuses.HasSpecialBonus.Should().BeFalse();
    }

    [Test]
    public void GetResourceBonuses_Adept_HasSpecialBonus()
    {
        // Act
        var bonuses = _provider.GetResourceBonuses(Archetype.Adept);

        // Assert
        bonuses.HasSpecialBonus.Should().BeTrue();
        bonuses.SpecialBonus!.Value.BonusType.Should().Be("ConsumableEffectiveness");
    }

    [Test]
    public void GetStartingAbilities_Warrior_ReturnsThreeAbilities()
    {
        // Act
        var abilities = _provider.GetStartingAbilities(Archetype.Warrior);

        // Assert
        abilities.Should().HaveCount(3);
        abilities.Should().Contain(a => a.AbilityId == "power-strike");
        abilities.Should().Contain(a => a.AbilityId == "defensive-stance");
        abilities.Should().Contain(a => a.AbilityId == "iron-will");
    }

    [Test]
    public void GetSpecializationMapping_Warrior_ReturnsSixSpecs()
    {
        // Act
        var mapping = _provider.GetSpecializationMapping(Archetype.Warrior);

        // Assert
        mapping.Count.Should().Be(6);
        mapping.RecommendedFirst.Should().Be("guardian");
    }

    [Test]
    public void GetSpecializationMapping_Mystic_ReturnsTwoSpecs()
    {
        // Act
        var mapping = _provider.GetSpecializationMapping(Archetype.Mystic);

        // Assert
        mapping.Count.Should().Be(2);
        mapping.RecommendedFirst.Should().Be("elementalist");
    }

    [Test]
    public void IsSpecializationAvailable_ValidSpec_ReturnsTrue()
    {
        // Act & Assert
        _provider.IsSpecializationAvailable(Archetype.Warrior, "guardian").Should().BeTrue();
        _provider.IsSpecializationAvailable(Archetype.Mystic, "elementalist").Should().BeTrue();
    }

    [Test]
    public void IsSpecializationAvailable_InvalidSpec_ReturnsFalse()
    {
        // Act & Assert
        _provider.IsSpecializationAvailable(Archetype.Warrior, "elementalist").Should().BeFalse();
        _provider.IsSpecializationAvailable(Archetype.Mystic, "guardian").Should().BeFalse();
    }

    [Test]
    public void GetSelectionText_ReturnsNonEmptyString()
    {
        // Act
        var text = _provider.GetSelectionText(Archetype.Warrior);

        // Assert
        text.Should().NotBeNullOrWhiteSpace();
        text.Should().Contain("shield");
    }
}
```

---

## 10. Use Cases

### UC-001: Retrieve All Archetypes for Selection

**Actor:** Character Creation UI  
**Flow:** Call `GetAllArchetypes()` → Receive 4 definitions → Display selection panel  
**Postcondition:** UI shows all archetypes with display names and taglines

### UC-002: Get Full Archetype Details

**Actor:** Archetype Selection Panel  
**Flow:** Call `GetArchetype()`, `GetResourceBonuses()`, `GetStartingAbilities()`, `GetSpecializationMapping()` → Combine for detail view  
**Postcondition:** Player sees complete archetype information

### UC-003: Validate Specialization Selection

**Actor:** Creation Workflow  
**Flow:** Call `IsSpecializationAvailable(archetype, specId)` → Return true/false  
**Postcondition:** Invalid selections are rejected

---

## 11. User Stories

**US-001:** As a developer, I want a single provider for all archetype data so I don't have to manage multiple services.

**US-002:** As a developer, I want archetype data cached after first load for performance.

**US-003:** As a game designer, I want archetype definitions in JSON so I can modify them without code changes.

**US-004:** As a player, I want the UI to load quickly when viewing archetypes.

---

## 12. Deliverable Checklist

### Interface

- [ ] `IArchetypeProvider` interface with all 8 methods
- [ ] Full XML documentation on interface and methods

### Service

- [ ] `ArchetypeProvider` implementing `IArchetypeProvider`
- [ ] JSON configuration loading
- [ ] Thread-safe lazy loading with caching
- [ ] Default fallback if config missing
- [ ] All lookup methods implemented
- [ ] DTOs for JSON deserialization
- [ ] Full XML documentation

### Testing

- [ ] ~10 unit tests implemented
- [ ] All tests passing
- [ ] Coverage for all public methods

---

## 13. Acceptance Criteria

### Functional

- [ ] `GetAllArchetypes()` returns exactly 4 definitions
- [ ] `GetArchetype(Warrior)` returns Warrior definition
- [ ] `GetResourceBonuses(Warrior)` returns HP+49, Stamina+5
- [ ] `GetStartingAbilities(Warrior)` returns 3 abilities
- [ ] `GetSpecializationMapping(Warrior)` returns 6 specs
- [ ] `IsSpecializationAvailable(Warrior, "guardian")` returns true
- [ ] `IsSpecializationAvailable(Warrior, "elementalist")` returns false
- [ ] Configuration loads from JSON file
- [ ] Falls back to defaults if config missing

### Quality

- [ ] Build succeeds with 0 errors
- [ ] Build succeeds with 0 warnings
- [ ] All ~10 unit tests pass
- [ ] XML documentation complete

---

## 14. Dependencies

### Required from Previous Phases

| Type                             | Phase    | Usage                    |
| -------------------------------- | -------- | ------------------------ |
| `Archetype`                      | v0.17.3a | Enum for lookups         |
| `ArchetypeDefinition`            | v0.17.3a | Return type              |
| `ArchetypeResourceBonuses`       | v0.17.3b | Return type              |
| `ArchetypeAbilityGrant`          | v0.17.3c | Return type              |
| `ArchetypeSpecializationMapping` | v0.17.3d | Return type              |
| `Lineage`                        | v0.17.0  | Recommended build lookup |

### Provides to Future Phases

| Type                 | Phase    | Usage                             |
| -------------------- | -------- | --------------------------------- |
| `IArchetypeProvider` | v0.17.3f | Application service uses provider |
| `IArchetypeProvider` | v0.17.5  | Creation workflow uses provider   |

---

## 15. Future Considerations

### Deferred to v0.17.3f

- Application service for applying archetype to characters

### Deferred to v0.17.5

- UI integration with provider
- Real-time archetype comparison views

### Out of Scope for v0.17.3

- Database-backed archetype storage
- Runtime archetype modification
- Archetype versioning

---

_Document Version: 1.0_  
_Last Updated: 2026-01-27_
