# v0.14.6a Design Specification: Sound Effect Schema

**Version:** 0.14.6a
**Parent:** v0.14.6 (Audio Configuration Schemas)
**Prerequisites:** v0.14.5 Complete (Economy Configuration Schemas)
**Status:** Design Complete

---

## Table of Contents

1. [Executive Summary](#1-executive-summary)
2. [Feature Overview](#2-feature-overview)
3. [Architecture Diagrams](#3-architecture-diagrams)
4. [Sound Effect Schema Root Definition](#4-sound-effect-schema-root-definition)
   - 4.1 [Root Configuration Properties](#41-root-configuration-properties)
   - 4.2 [Categories Structure](#42-categories-structure)
5. [Sound Category Configuration](#5-sound-category-configuration)
   - 5.1 [SoundCategory Definition](#51-soundcategory-definition)
   - 5.2 [Standard Categories](#52-standard-categories)
6. [Sound Effect Configuration](#6-sound-effect-configuration)
   - 6.1 [SoundEffect Definition](#61-soundeffect-definition)
   - 6.2 [File Array Configuration](#62-file-array-configuration)
   - 6.3 [Volume and Pitch Settings](#63-volume-and-pitch-settings)
   - 6.4 [Playback Options](#64-playback-options)
   - 6.5 [Fallback Handling](#65-fallback-handling)
7. [Volume and Pitch Variance](#7-volume-and-pitch-variance)
   - 7.1 [VolumeRange Definition](#71-volumerange-definition)
   - 7.2 [PitchRange Definition](#72-pitchrange-definition)
   - 7.3 [Variance Calculation](#73-variance-calculation)
8. [Global Settings Configuration](#8-global-settings-configuration)
   - 8.1 [GlobalSettings Definition](#81-globalsettings-definition)
   - 8.2 [Playback Limits](#82-playback-limits)
9. [Trigger Associations](#9-trigger-associations)
   - 9.1 [Event to Sound Mapping](#91-event-to-sound-mapping)
   - 9.2 [Trigger Categories](#92-trigger-categories)
10. [Validation Rules](#10-validation-rules)
    - 10.1 [ID Pattern Validation](#101-id-pattern-validation)
    - 10.2 [Range Validation](#102-range-validation)
    - 10.3 [Required Fields](#103-required-fields)
    - 10.4 [File Path Validation](#104-file-path-validation)
11. [Configuration Schema](#11-configuration-schema)
12. [Configuration File Updates](#12-configuration-file-updates)
13. [Data Model Changes](#13-data-model-changes)
14. [Logging Specifications](#14-logging-specifications)
15. [Unit Testing Requirements](#15-unit-testing-requirements)
16. [Use Cases](#16-use-cases)
17. [Deliverable Checklist](#17-deliverable-checklist)
18. [Acceptance Criteria](#18-acceptance-criteria)
19. [Dependencies](#19-dependencies)
20. [Future Considerations](#20-future-considerations)

---

## 1. Executive Summary

Version 0.14.6a introduces the **Sound Effect Schema** (`sound-effects.schema.json`), which validates sound effect definitions including categories, trigger associations, volume/pitch variance, and fallback handling. This schema enables full customization of game audio without code changes, supporting modding scenarios such as custom sound packs, themed audio, regional variations, or accessibility-focused audio profiles.

The Sound Effect Schema validates the existing `sound-effects.json` configuration file which currently defines 6 categories (combat, ability, ui, items, puzzle, movement) with 19 sound effects. The schema establishes patterns for audio-related configurations that will be extended by music themes (v0.14.6b).

### Key Deliverables

| Category | Items |
|----------|-------|
| **Schema Files** | `sound-effects.schema.json` |
| **Schema Definitions** | `SoundCategory`, `SoundEffect`, `VolumeRange`, `PitchRange`, `GlobalSettings` |
| **Configuration Files** | Update `sound-effects.json` to reference new schema |
| **Tests** | ~6 new unit tests |

### Architectural Significance

This version provides:
- **Flexible category system** - Dynamic category names via additionalProperties
- **Multi-file support** - Multiple audio files per effect with randomization
- **Volume/pitch variance** - Dynamic audio variation for realism
- **Fallback system** - Graceful degradation for missing audio files
- **Priority system** - Control over simultaneous sound playback
- **Tag-based filtering** - Optional metadata for sound organization

### Relationship to Other Schemas

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                    v0.14.6 AUDIO CONFIGURATION SCHEMAS                       │
└─────────────────────────────────────────────────────────────────────────────┘

  ┌─────────────────────────────────────────────────────────────────────────┐
  │  v0.14.6a: sound-effects.schema.json ◀── THIS VERSION                  │
  │  v0.14.6b: music-themes.schema.json                                    │
  └─────────────────────────────────────────────────────────────────────────┘

  Cross-references:
  • sound-effects.json → files[] references audio file paths
  • sound-effects.json → fallbackEffectId references other effects
  • damage-types.json → sfxId references sound-effects (future)
  • abilities.json → soundEffects references sound-effects (future)

  Shared definitions:
  • ID pattern: ^[a-z][a-z0-9-]*$ (lowercase kebab-case)
  • Schema location: config/schemas/
  • Volume range: 0-1 normalized
```

---

## 2. Feature Overview

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                      SOUND EFFECT SCHEMA FEATURE TREE                        │
└─────────────────────────────────────────────────────────────────────────────┘

sound-effects.schema.json
├── Root Configuration
│   ├── $schema reference
│   ├── version (optional)
│   ├── categories object
│   └── settings object
│
├── SoundCategory
│   ├── description (optional)
│   └── effects object
│       └── [effectId]: SoundEffect
│
├── SoundEffect
│   ├── Core Properties
│   │   ├── files[] (audio file paths)
│   │   ├── volume (0-1)
│   │   └── randomize (boolean)
│   │
│   ├── Variance Properties
│   │   ├── volumeVariance → VolumeRange
│   │   ├── pitch (0.5-2.0)
│   │   └── pitchVariance → PitchRange
│   │
│   ├── Playback Properties
│   │   ├── loop (boolean)
│   │   ├── cooldown (seconds)
│   │   └── priority (0-10)
│   │
│   ├── Fallback Properties
│   │   └── fallbackEffectId (reference)
│   │
│   └── Metadata Properties
│       └── tags[] (optional)
│
├── VolumeRange
│   ├── min (0-1)
│   └── max (0-1)
│
├── PitchRange
│   ├── min (0.5-2.0)
│   └── max (0.5-2.0)
│
└── GlobalSettings
    ├── maxSimultaneous (integer)
    ├── defaultVolume (0-1)
    ├── masterMute (boolean)
    └── fallbackEnabled (boolean)
```

---

## 3. Architecture Diagrams

### 3.1 Sound Effect Structure

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                        SOUND EFFECT STRUCTURE                                │
└─────────────────────────────────────────────────────────────────────────────┘

                              sound-effects.json
                    ┌──────────────────────────────────┐
                    │  $schema: reference              │
                    │  version: "1.0.0" (optional)     │
                    │  categories: { ... }             │
                    │  settings: { ... }               │
                    └──────────┬───────────────────────┘
                               │
       ┌───────────────────────┴───────────────────────────┐
       │                                                   │
       ▼                                                   ▼
┌──────────────────────────┐                  ┌───────────────────────┐
│      categories          │                  │     settings          │
│──────────────────────────│                  │───────────────────────│
│ "combat": SoundCategory  │                  │ maxSimultaneous: 8    │
│ "ability": SoundCategory │                  │ defaultVolume: 0.8    │
│ "ui": SoundCategory      │                  │ masterMute: false     │
│ "items": SoundCategory   │                  │ fallbackEnabled: true │
│ "puzzle": SoundCategory  │                  └───────────────────────┘
│ "movement": SoundCategory│
│ ... (extensible)         │
└──────────┬───────────────┘
           │
           ▼
┌─────────────────────────────────────────────────────────────────┐
│                        SoundCategory                             │
│─────────────────────────────────────────────────────────────────│
│  description: "Battle sounds" (optional)                        │
│  effects: {                                                     │
│    "attack-hit": SoundEffect,                                   │
│    "attack-miss": SoundEffect,                                  │
│    "attack-critical": SoundEffect,                              │
│    ... (extensible)                                             │
│  }                                                              │
└──────────┬──────────────────────────────────────────────────────┘
           │
           ▼
┌─────────────────────────────────────────────────────────────────┐
│                         SoundEffect                              │
│─────────────────────────────────────────────────────────────────│
│  files: ["audio/sfx/combat/hit_01.ogg", ...]                    │
│  volume: 0.8                                                    │
│  volumeVariance: { min: 0.7, max: 0.9 } (optional)              │
│  pitch: 1.0                                                     │
│  pitchVariance: { min: 0.9, max: 1.1 } (optional)               │
│  randomize: true                                                │
│  loop: false                                                    │
│  cooldown: 0.1 (optional)                                       │
│  priority: 5                                                    │
│  fallbackEffectId: "generic-hit" (optional)                     │
│  tags: ["weapon", "melee"] (optional)                           │
└─────────────────────────────────────────────────────────────────┘
```

### 3.2 Sound Playback Flow

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                         SOUND PLAYBACK FLOW                                  │
└─────────────────────────────────────────────────────────────────────────────┘

                    Game Event (e.g., "OnAttackHit")
                              │
                              ▼
                  ┌───────────────────────┐
                  │ Check masterMute      │
                  └───────────┬───────────┘
                              │
              ┌───────────────┴───────────────┐
              │ true                          │ false
              ▼                               ▼
        ┌───────────┐              ┌─────────────────────┐
        │  No Sound │              │ Look up category    │
        └───────────┘              │ and effect ID       │
                                   └──────────┬──────────┘
                                              │
                                              ▼
                                   ┌─────────────────────┐
                                   │ Effect found?       │
                                   └──────────┬──────────┘
                                              │
                              ┌───────────────┴───────────────┐
                              │ No                            │ Yes
                              ▼                               ▼
                  ┌─────────────────────┐         ┌─────────────────────┐
                  │ fallbackEnabled?    │         │ Check cooldown      │
                  └──────────┬──────────┘         └──────────┬──────────┘
                             │                               │
             ┌───────────────┴───────────┐                   │
             │ true                      │ false             │
             ▼                           ▼                   │
  ┌─────────────────────┐       ┌───────────────┐           │
  │ Use fallbackEffectId│       │ Log warning   │           │
  └──────────┬──────────┘       │ Skip playback │           │
             │                  └───────────────┘           │
             └──────────────────────┬────────────────────────┘
                                    │
                                    ▼
                        ┌───────────────────────┐
                        │ Check maxSimultaneous │
                        └───────────┬───────────┘
                                    │
                ┌───────────────────┴───────────────────┐
                │ At limit                              │ Under limit
                ▼                                       ▼
    ┌─────────────────────────┐            ┌─────────────────────────┐
    │ Compare priority        │            │ Select audio file       │
    │ Stop lowest if lower    │            │ (randomize if enabled)  │
    └────────────┬────────────┘            └───────────┬─────────────┘
                 │                                     │
                 └──────────────┬──────────────────────┘
                                │
                                ▼
                    ┌───────────────────────┐
                    │ Calculate final volume│
                    │ (base × variance)     │
                    └───────────┬───────────┘
                                │
                                ▼
                    ┌───────────────────────┐
                    │ Calculate final pitch │
                    │ (base × variance)     │
                    └───────────┬───────────┘
                                │
                                ▼
                    ┌───────────────────────┐
                    │ Play sound            │
                    │ (loop if enabled)     │
                    └───────────────────────┘
```

### 3.3 Schema Layer Diagram

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           SCHEMA LAYER DIAGRAM                               │
└─────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────┐
│                              PRESENTATION                                    │
│                                                                              │
│  Audio system plays sounds based on game events                              │
│  • Combat sounds on attacks, deaths                                          │
│  • UI sounds on button interactions                                          │
│  • Ambient sounds for environment                                            │
│  • Ability sounds for spell casting                                          │
└─────────────────────────────────────────────────────────────────────────────┘
                                     │
                                     ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                              APPLICATION                                     │
│                                                                              │
│  SoundEffectService loads and provides sound effect data                     │
│  • GetAllCategories() → IEnumerable<string>                                  │
│  • GetEffectsByCategory(category) → IEnumerable<SoundEffect>                 │
│  • GetEffect(category, effectId) → SoundEffect?                              │
│  • GetGlobalSettings() → GlobalSettings                                      │
│  • PlayEffect(category, effectId) → void                                     │
└─────────────────────────────────────────────────────────────────────────────┘
                                     │
                                     ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                             DOMAIN LAYER                                     │
│                                                                              │
│  Sound effect definitions loaded from JSON                                   │
│  • SoundCategory (description, effects dictionary)                           │
│  • SoundEffect (files, volume, pitch, randomize, etc.)                       │
│  • VolumeRange (min, max)                                                    │
│  • PitchRange (min, max)                                                     │
│  • GlobalSettings (maxSimultaneous, defaultVolume, etc.)                     │
└─────────────────────────────────────────────────────────────────────────────┘
                                     │
                                     ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                           INFRASTRUCTURE                                     │
│                                                                              │
│  SoundEffectProvider loads from JSON with schema validation                  │
│  • LoadSoundEffects() → reads config/sound-effects.json                      │
│  • Validates against config/schemas/sound-effects.schema.json                │
│  • Caches loaded definitions for performance                                 │
│  • Logs warnings for invalid entries                                         │
└─────────────────────────────────────────────────────────────────────────────┘
                                     │
                                     ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                            CONFIGURATION                                     │
│                                                                              │
│  config/schemas/sound-effects.schema.json                                    │
│  config/sound-effects.json                                                   │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 3.4 Category Organization

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                        CATEGORY ORGANIZATION                                 │
└─────────────────────────────────────────────────────────────────────────────┘

  ┌─────────────┐    ┌─────────────┐    ┌─────────────┐    ┌─────────────┐
  │   combat    │    │   ability   │    │     ui      │    │    items    │
  ├─────────────┤    ├─────────────┤    ├─────────────┤    ├─────────────┤
  │ attack-hit  │    │ ability-cast│    │ button-click│    │ item-pickup │
  │ attack-miss │    │ ability-fire│    │ button-hover│    │ item-equip  │
  │ attack-crit │    │ ability-heal│    │ menu-open   │    │ gold-coins  │
  │ attack-block│    │             │    │ menu-close  │    │             │
  │ death-monstr│    │             │    │             │    │             │
  │ death-player│    │             │    │             │    │             │
  └─────────────┘    └─────────────┘    └─────────────┘    └─────────────┘

  ┌─────────────┐    ┌─────────────┐    ┌─────────────┐
  │   puzzle    │    │  movement   │    │   ambient   │
  ├─────────────┤    ├─────────────┤    ├─────────────┤
  │puzzle-correct│   │footstep-stone│   │ wind        │
  │puzzle-incorr│    │ door-open   │    │ water       │
  │puzzle-compl │    │ chest-open  │    │ fire        │
  │             │    │             │    │ crowd       │
  └─────────────┘    └─────────────┘    └─────────────┘

  Note: Category and effect names are flexible (additionalProperties).
        The above are standard categories from the existing configuration.
```

---

## 4. Sound Effect Schema Root Definition

### 4.1 Root Configuration Properties

The root schema defines the top-level structure of the `sound-effects.json` configuration file.

| Property | Type | Required | Default | Description |
|----------|------|----------|---------|-------------|
| `$schema` | string | No | - | Reference to the JSON schema for validation |
| `version` | string | No | - | Configuration file version for compatibility |
| `categories` | object | **Yes** | - | Object containing sound categories (additionalProperties) |
| `settings` | object | No | - | `GlobalSettings` object for audio system configuration |

### 4.2 Categories Structure

The `categories` property uses `additionalProperties` to allow flexible category names. Each property key is the category ID (kebab-case), and the value is a `SoundCategory` object.

```
categories: {
  "combat": SoundCategory,      // Built-in category
  "ability": SoundCategory,     // Built-in category
  "ui": SoundCategory,          // Built-in category
  "items": SoundCategory,       // Built-in category
  "puzzle": SoundCategory,      // Built-in category
  "movement": SoundCategory,    // Built-in category
  "ambient": SoundCategory,     // Built-in category
  "custom-mod": SoundCategory   // Custom category (extensible)
}
```

---

## 5. Sound Category Configuration

### 5.1 SoundCategory Definition

Each sound category groups related sound effects together.

| Property | Type | Required | Default | Description |
|----------|------|----------|---------|-------------|
| `description` | string | No | - | Optional description of the category |
| `effects` | object | **Yes** | - | Object containing sound effects (additionalProperties) |

The `effects` property uses `additionalProperties` to allow flexible effect IDs. Each property key is the effect ID (kebab-case), and the value is a `SoundEffect` object.

### 5.2 Standard Categories

The following categories are defined in the existing configuration:

| Category | Description | Effect Count | Example Effects |
|----------|-------------|--------------|-----------------|
| `combat` | Battle and damage sounds | 6 | attack-hit, attack-miss, death-monster |
| `ability` | Spell and skill sounds | 3 | ability-cast, ability-fire, ability-heal |
| `ui` | User interface sounds | 4 | button-click, menu-open, menu-close |
| `items` | Item interaction sounds | 3 | item-pickup, item-equip, gold-coins |
| `puzzle` | Puzzle feedback sounds | 3 | puzzle-correct, puzzle-incorrect, puzzle-complete |
| `movement` | Movement and interaction | 3 | footstep-stone, door-open, chest-open |
| `ambient` | Environmental sounds | - | wind, water, fire, crowd (suggested) |

---

## 6. Sound Effect Configuration

### 6.1 SoundEffect Definition

Each sound effect defines one or more audio files and playback parameters.

| Property | Type | Required | Default | Range | Description |
|----------|------|----------|---------|-------|-------------|
| `files` | array | **Yes** | - | minItems: 1 | Array of audio file paths |
| `volume` | number | No | 1.0 | 0-1 | Base volume level |
| `volumeVariance` | object | No | - | - | `VolumeRange` for dynamic volume |
| `pitch` | number | No | 1.0 | 0.5-2.0 | Base pitch multiplier |
| `pitchVariance` | object | No | - | - | `PitchRange` for dynamic pitch |
| `randomize` | boolean | No | `false` | - | Randomly select from files array |
| `loop` | boolean | No | `false` | - | Loop the sound continuously |
| `cooldown` | number | No | - | ≥0 | Minimum seconds between plays |
| `priority` | integer | No | 5 | 0-10 | Priority for simultaneous playback |
| `fallbackEffectId` | string | No | - | pattern | Effect ID to use if files missing |
| `tags` | array | No | `[]` | - | Optional tags for filtering |

### 6.2 File Array Configuration

The `files` array contains paths to audio files relative to the game's root directory.

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                          FILE ARRAY BEHAVIOR                                 │
└─────────────────────────────────────────────────────────────────────────────┘

  Single File:
  ────────────
  "files": ["audio/sfx/combat/hit.ogg"]
  → Always plays the same file

  Multiple Files (randomize: false):
  ──────────────────────────────────
  "files": ["audio/sfx/combat/hit_01.ogg", "audio/sfx/combat/hit_02.ogg"]
  → Plays files sequentially or first file only (implementation-defined)

  Multiple Files (randomize: true):
  ─────────────────────────────────
  "files": [
    "audio/sfx/combat/hit_01.ogg",
    "audio/sfx/combat/hit_02.ogg",
    "audio/sfx/combat/hit_03.ogg"
  ]
  → Randomly selects one file per play
  → Provides audio variety and avoids repetition fatigue
```

### 6.3 Volume and Pitch Settings

Base volume and pitch can be set with optional variance for dynamic audio.

| Setting | Base Property | Variance Property | Range | Description |
|---------|---------------|-------------------|-------|-------------|
| Volume | `volume` | `volumeVariance` | 0-1 | How loud the sound plays |
| Pitch | `pitch` | `pitchVariance` | 0.5-2.0 | Speed/frequency multiplier |

### 6.4 Playback Options

| Option | Default | Description |
|--------|---------|-------------|
| `loop` | `false` | When true, sound repeats until stopped |
| `cooldown` | none | Prevents rapid repeated playback |
| `priority` | 5 | Higher priority sounds preempt lower when at limit |

### 6.5 Fallback Handling

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                          FALLBACK HANDLING                                   │
└─────────────────────────────────────────────────────────────────────────────┘

  Primary Effect Definition:
  ──────────────────────────
  "fire-sword-hit": {
    "files": ["audio/sfx/weapons/fire_sword_impact.ogg"],
    "volume": 0.9,
    "fallbackEffectId": "attack-hit"   ← References another effect
  }

  Fallback Chain:
  ────────────────
  1. Attempt to load "fire_sword_impact.ogg"
  2. If file missing and fallbackEnabled = true:
     → Look up "attack-hit" effect
     → Use its files instead
  3. If fallback also missing:
     → Log warning, no sound played

  Note: Circular fallback references should be detected and prevented.
```

---

## 7. Volume and Pitch Variance

### 7.1 VolumeRange Definition

The `VolumeRange` object defines minimum and maximum volume for dynamic variation.

| Property | Type | Required | Range | Description |
|----------|------|----------|-------|-------------|
| `min` | number | **Yes** | 0-1 | Minimum volume multiplier |
| `max` | number | **Yes** | 0-1 | Maximum volume multiplier |

### 7.2 PitchRange Definition

The `PitchRange` object defines minimum and maximum pitch for dynamic variation.

| Property | Type | Required | Range | Description |
|----------|------|----------|-------|-------------|
| `min` | number | **Yes** | 0.5-2.0 | Minimum pitch multiplier |
| `max` | number | **Yes** | 0.5-2.0 | Maximum pitch multiplier |

### 7.3 Variance Calculation

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                        VARIANCE CALCULATION                                  │
└─────────────────────────────────────────────────────────────────────────────┘

VOLUME CALCULATION:
═══════════════════

  If volumeVariance is defined:
    randomFactor = random(volumeVariance.min, volumeVariance.max)
    finalVolume = volume × randomFactor
  Else:
    finalVolume = volume

  Example:
    volume: 0.8
    volumeVariance: { min: 0.9, max: 1.1 }

    randomFactor = 0.95 (random between 0.9 and 1.1)
    finalVolume = 0.8 × 0.95 = 0.76


PITCH CALCULATION:
══════════════════

  If pitchVariance is defined:
    randomFactor = random(pitchVariance.min, pitchVariance.max)
    finalPitch = pitch × randomFactor
  Else:
    finalPitch = pitch

  Example:
    pitch: 1.0
    pitchVariance: { min: 0.9, max: 1.1 }

    randomFactor = 1.05 (random between 0.9 and 1.1)
    finalPitch = 1.0 × 1.05 = 1.05


PITCH EFFECTS:
══════════════

  pitch < 1.0  →  Lower frequency, slower playback
  pitch = 1.0  →  Normal playback
  pitch > 1.0  →  Higher frequency, faster playback

  Common uses:
  • Footsteps: pitch variance makes steps sound more natural
  • Hits: slight pitch variance prevents "machine gun" effect
  • UI: consistent pitch (no variance) for clarity
```

---

## 8. Global Settings Configuration

### 8.1 GlobalSettings Definition

The `GlobalSettings` object configures system-wide audio behavior.

| Property | Type | Required | Default | Range | Description |
|----------|------|----------|---------|-------|-------------|
| `maxSimultaneous` | integer | No | 8 | ≥1 | Maximum concurrent sound effects |
| `defaultVolume` | number | No | 1.0 | 0-1 | Default volume for effects without explicit volume |
| `masterMute` | boolean | No | `false` | - | Global mute toggle |
| `fallbackEnabled` | boolean | No | `true` | - | Enable fallback effect resolution |

### 8.2 Playback Limits

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                          PLAYBACK LIMITS                                     │
└─────────────────────────────────────────────────────────────────────────────┘

  maxSimultaneous = 8
  ════════════════════

  Currently Playing:
  ┌───┬───┬───┬───┬───┬───┬───┬───┐
  │ 1 │ 2 │ 3 │ 4 │ 5 │ 6 │ 7 │ 8 │  ← All slots filled
  │p=3│p=5│p=7│p=2│p=5│p=8│p=4│p=6│  ← Priority values
  └───┴───┴───┴───┴───┴───┴───┴───┘

  New sound requested with priority = 6:
  ───────────────────────────────────────

  1. Find lowest priority sound: slot 4 (priority=2)
  2. If new priority > lowest priority:
     → Stop slot 4
     → Play new sound in slot 4
  3. If new priority <= lowest priority:
     → New sound is dropped (not played)

  Result after new sound with priority=6:
  ┌───┬───┬───┬───┬───┬───┬───┬───┐
  │ 1 │ 2 │ 3 │NEW│ 5 │ 6 │ 7 │ 8 │
  │p=3│p=5│p=7│p=6│p=5│p=8│p=4│p=6│
  └───┴───┴───┴───┴───┴───┴───┴───┘
```

---

## 9. Trigger Associations

### 9.1 Event to Sound Mapping

Trigger associations map game events to sound effects. This is documented for runtime implementation reference.

| Trigger Event | Category | Effect ID | Description |
|---------------|----------|-----------|-------------|
| `OnAttackHit` | combat | attack-hit | Successful attack lands |
| `OnAttackMiss` | combat | attack-miss | Attack misses target |
| `OnCriticalHit` | combat | attack-critical | Critical hit scored |
| `OnAttackBlocked` | combat | attack-blocked | Attack blocked by defense |
| `OnEnemyDeath` | combat | death-monster | Enemy defeated |
| `OnPlayerDeath` | combat | death-player | Player character dies |
| `OnAbilityCast` | ability | ability-cast | Generic ability activation |
| `OnFireAbility` | ability | ability-fire | Fire-based ability |
| `OnHealAbility` | ability | ability-heal | Healing ability |
| `OnItemPickup` | items | item-pickup | Item collected |
| `OnItemEquip` | items | item-equip | Item equipped |
| `OnGoldPickup` | items | gold-coins | Currency collected |
| `OnButtonClick` | ui | button-click | UI button pressed |
| `OnButtonHover` | ui | button-hover | UI button mouse over |
| `OnMenuOpen` | ui | menu-open | Menu panel opened |
| `OnMenuClose` | ui | menu-close | Menu panel closed |
| `OnPuzzleCorrect` | puzzle | puzzle-correct | Correct puzzle input |
| `OnPuzzleIncorrect` | puzzle | puzzle-incorrect | Wrong puzzle input |
| `OnPuzzleComplete` | puzzle | puzzle-complete | Puzzle solved |
| `OnMovement` | movement | footstep-stone | Character moves |
| `OnDoorOpen` | movement | door-open | Door interaction |
| `OnChestOpen` | movement | chest-open | Container interaction |

### 9.2 Trigger Categories

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                          TRIGGER CATEGORIES                                  │
└─────────────────────────────────────────────────────────────────────────────┘

  COMBAT TRIGGERS                    ABILITY TRIGGERS
  ════════════════                   ════════════════
  • OnAttackHit                      • OnAbilityCast
  • OnAttackMiss                     • OnFireAbility
  • OnCriticalHit                    • OnHealAbility
  • OnAttackBlocked                  • OnBuffApplied
  • OnEnemyDeath                     • OnDebuffApplied
  • OnPlayerDeath

  UI TRIGGERS                        ITEM TRIGGERS
  ═══════════                        ═════════════
  • OnButtonClick                    • OnItemPickup
  • OnButtonHover                    • OnItemEquip
  • OnMenuOpen                       • OnItemDrop
  • OnMenuClose                      • OnGoldPickup
  • OnNotification                   • OnPotionUse

  PUZZLE TRIGGERS                    MOVEMENT TRIGGERS
  ═══════════════                    ═════════════════
  • OnPuzzleCorrect                  • OnMovement
  • OnPuzzleIncorrect                • OnDoorOpen
  • OnPuzzleComplete                 • OnChestOpen
  • OnPuzzleReset                    • OnTrapTrigger
```

---

## 10. Validation Rules

### 10.1 ID Pattern Validation

Category IDs and effect IDs should follow kebab-case convention for consistency.

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                          ID PATTERN VALIDATION                               │
└─────────────────────────────────────────────────────────────────────────────┘

  Pattern: ^[a-z][a-z0-9-]*$

  ✓ Valid Examples:
    • attack-hit
    • ability-fire
    • combat
    • ui-button-click
    • footstep-stone-01

  ✗ Invalid Examples:
    • Attack-Hit           (uppercase)
    • 1-attack             (starts with number)
    • attack_hit           (underscore)
    • attack hit           (space)
    • -attack              (starts with hyphen)

  Note: The schema uses additionalProperties for flexibility.
        Pattern validation is recommended but not enforced on keys.
```

### 10.2 Range Validation

| Field | Minimum | Maximum | Notes |
|-------|---------|---------|-------|
| `volume` | 0 | 1 | Normalized volume |
| `volumeVariance.min` | 0 | 1 | Must be ≤ max |
| `volumeVariance.max` | 0 | 1 | Must be ≥ min |
| `pitch` | 0.5 | 2.0 | Half to double speed |
| `pitchVariance.min` | 0.5 | 2.0 | Must be ≤ max |
| `pitchVariance.max` | 0.5 | 2.0 | Must be ≥ min |
| `cooldown` | 0 | - | Seconds |
| `priority` | 0 | 10 | Higher = more important |
| `maxSimultaneous` | 1 | - | Positive integer |
| `defaultVolume` | 0 | 1 | System default |

### 10.3 Required Fields

| Level | Required Fields |
|-------|-----------------|
| Root | `categories` |
| SoundCategory | `effects` |
| SoundEffect | `files` |
| VolumeRange | `min`, `max` |
| PitchRange | `min`, `max` |
| GlobalSettings | (none - all have defaults) |

### 10.4 File Path Validation

The schema validates that `files` is a non-empty array of strings. Actual file existence is validated at runtime, not by the schema.

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                         FILE PATH VALIDATION                                 │
└─────────────────────────────────────────────────────────────────────────────┘

  Schema Validation (build-time):
  ═══════════════════════════════
  ✓ files is an array
  ✓ files has at least 1 item (minItems: 1)
  ✓ Each item is a string
  ✗ Does NOT validate file existence
  ✗ Does NOT validate file format (.ogg, .wav, etc.)

  Runtime Validation (load-time):
  ═══════════════════════════════
  • Check if file exists at path
  • Verify supported audio format
  • Use fallbackEffectId if file missing
  • Log warning for missing files
```

---

## 11. Configuration Schema

### Complete `sound-effects.schema.json`

```json
{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "https://rune-game.com/schemas/sound-effects.schema.json",
  "title": "Sound Effects Configuration",
  "description": "Schema for sound effect definitions including categories, effects, variance, and global settings",
  "type": "object",
  "properties": {
    "$schema": {
      "type": "string",
      "description": "Reference to this schema for validation"
    },
    "version": {
      "type": "string",
      "description": "Configuration file version for compatibility tracking"
    },
    "categories": {
      "type": "object",
      "description": "Sound effect categories (e.g., combat, ability, ui)",
      "additionalProperties": {
        "$ref": "#/definitions/SoundCategory"
      },
      "minProperties": 1
    },
    "settings": {
      "$ref": "#/definitions/GlobalSettings",
      "description": "Global audio system settings"
    }
  },
  "required": ["categories"],
  "additionalProperties": false,
  "definitions": {
    "SoundCategory": {
      "type": "object",
      "description": "A category grouping related sound effects",
      "properties": {
        "description": {
          "type": "string",
          "description": "Optional description of this sound category"
        },
        "effects": {
          "type": "object",
          "description": "Sound effects within this category",
          "additionalProperties": {
            "$ref": "#/definitions/SoundEffect"
          },
          "minProperties": 0
        }
      },
      "required": ["effects"],
      "additionalProperties": false
    },
    "SoundEffect": {
      "type": "object",
      "description": "A single sound effect with playback configuration",
      "properties": {
        "files": {
          "type": "array",
          "description": "Array of audio file paths (relative to game root)",
          "items": {
            "type": "string",
            "minLength": 1
          },
          "minItems": 1
        },
        "volume": {
          "type": "number",
          "description": "Base volume level (0 = silent, 1 = full)",
          "minimum": 0,
          "maximum": 1,
          "default": 1.0
        },
        "volumeVariance": {
          "$ref": "#/definitions/VolumeRange",
          "description": "Optional volume variance for dynamic playback"
        },
        "pitch": {
          "type": "number",
          "description": "Base pitch multiplier (0.5 = half speed, 2.0 = double speed)",
          "minimum": 0.5,
          "maximum": 2.0,
          "default": 1.0
        },
        "pitchVariance": {
          "$ref": "#/definitions/PitchRange",
          "description": "Optional pitch variance for dynamic playback"
        },
        "randomize": {
          "type": "boolean",
          "description": "Randomly select from files array on each play",
          "default": false
        },
        "loop": {
          "type": "boolean",
          "description": "Loop the sound continuously until stopped",
          "default": false
        },
        "cooldown": {
          "type": "number",
          "description": "Minimum seconds between consecutive plays",
          "minimum": 0
        },
        "priority": {
          "type": "integer",
          "description": "Priority for simultaneous playback (higher = more important)",
          "minimum": 0,
          "maximum": 10,
          "default": 5
        },
        "fallbackEffectId": {
          "type": "string",
          "description": "Effect ID to use if primary files are missing",
          "pattern": "^[a-z][a-z0-9-]*$"
        },
        "tags": {
          "type": "array",
          "description": "Optional tags for filtering and organization",
          "items": {
            "type": "string",
            "minLength": 1
          },
          "uniqueItems": true
        }
      },
      "required": ["files"],
      "additionalProperties": false
    },
    "VolumeRange": {
      "type": "object",
      "description": "Volume variance range for dynamic playback",
      "properties": {
        "min": {
          "type": "number",
          "description": "Minimum volume multiplier",
          "minimum": 0,
          "maximum": 1
        },
        "max": {
          "type": "number",
          "description": "Maximum volume multiplier",
          "minimum": 0,
          "maximum": 1
        }
      },
      "required": ["min", "max"],
      "additionalProperties": false
    },
    "PitchRange": {
      "type": "object",
      "description": "Pitch variance range for dynamic playback",
      "properties": {
        "min": {
          "type": "number",
          "description": "Minimum pitch multiplier",
          "minimum": 0.5,
          "maximum": 2.0
        },
        "max": {
          "type": "number",
          "description": "Maximum pitch multiplier",
          "minimum": 0.5,
          "maximum": 2.0
        }
      },
      "required": ["min", "max"],
      "additionalProperties": false
    },
    "GlobalSettings": {
      "type": "object",
      "description": "Global audio system configuration",
      "properties": {
        "maxSimultaneous": {
          "type": "integer",
          "description": "Maximum number of concurrent sound effects",
          "minimum": 1,
          "default": 8
        },
        "defaultVolume": {
          "type": "number",
          "description": "Default volume for effects without explicit volume setting",
          "minimum": 0,
          "maximum": 1,
          "default": 1.0
        },
        "masterMute": {
          "type": "boolean",
          "description": "Global mute toggle for all sound effects",
          "default": false
        },
        "fallbackEnabled": {
          "type": "boolean",
          "description": "Enable fallback effect resolution for missing files",
          "default": true
        }
      },
      "additionalProperties": false
    }
  }
}
```

---

## 12. Configuration File Updates

### Updated `sound-effects.json` with Enhanced Features

The existing configuration already references the schema. The schema validates the current structure and enables the following optional enhancements:

```json
{
  "$schema": "./schemas/sound-effects.schema.json",
  "version": "1.0.0",
  "categories": {
    "combat": {
      "description": "Battle and damage sounds",
      "effects": {
        "attack-hit": {
          "files": [
            "audio/sfx/combat/hit_01.ogg",
            "audio/sfx/combat/hit_02.ogg",
            "audio/sfx/combat/hit_03.ogg"
          ],
          "volume": 0.8,
          "volumeVariance": {
            "min": 0.9,
            "max": 1.1
          },
          "pitchVariance": {
            "min": 0.95,
            "max": 1.05
          },
          "randomize": true,
          "priority": 6,
          "tags": ["weapon", "impact"]
        },
        "attack-miss": {
          "files": [
            "audio/sfx/combat/whoosh.ogg"
          ],
          "volume": 0.6,
          "pitchVariance": {
            "min": 0.9,
            "max": 1.1
          },
          "randomize": false,
          "priority": 4,
          "tags": ["weapon", "miss"]
        },
        "attack-critical": {
          "files": [
            "audio/sfx/combat/critical_hit.ogg"
          ],
          "volume": 1.0,
          "randomize": false,
          "priority": 8,
          "tags": ["weapon", "critical"]
        },
        "attack-blocked": {
          "files": [
            "audio/sfx/combat/block_01.ogg",
            "audio/sfx/combat/block_02.ogg"
          ],
          "volume": 0.7,
          "randomize": true,
          "priority": 5,
          "tags": ["defense", "block"]
        },
        "death-monster": {
          "files": [
            "audio/sfx/combat/monster_death_01.ogg",
            "audio/sfx/combat/monster_death_02.ogg"
          ],
          "volume": 0.9,
          "randomize": true,
          "priority": 7,
          "tags": ["death", "enemy"]
        },
        "death-player": {
          "files": [
            "audio/sfx/combat/player_death.ogg"
          ],
          "volume": 1.0,
          "randomize": false,
          "priority": 10,
          "tags": ["death", "player"]
        }
      }
    },
    "ability": {
      "description": "Spell and skill casting sounds",
      "effects": {
        "ability-cast": {
          "files": [
            "audio/sfx/ability/cast_generic.ogg"
          ],
          "volume": 0.7,
          "randomize": false,
          "priority": 5,
          "tags": ["magic", "generic"]
        },
        "ability-fire": {
          "files": [
            "audio/sfx/ability/fire_cast.ogg"
          ],
          "volume": 0.8,
          "randomize": false,
          "priority": 6,
          "fallbackEffectId": "ability-cast",
          "tags": ["magic", "fire", "elemental"]
        },
        "ability-heal": {
          "files": [
            "audio/sfx/ability/heal_cast.ogg"
          ],
          "volume": 0.7,
          "randomize": false,
          "priority": 5,
          "fallbackEffectId": "ability-cast",
          "tags": ["magic", "healing"]
        }
      }
    },
    "ui": {
      "description": "User interface interaction sounds",
      "effects": {
        "button-click": {
          "files": [
            "audio/sfx/ui/click.ogg"
          ],
          "volume": 0.5,
          "randomize": false,
          "priority": 3,
          "cooldown": 0.05,
          "tags": ["interface", "button"]
        },
        "button-hover": {
          "files": [
            "audio/sfx/ui/hover.ogg"
          ],
          "volume": 0.3,
          "randomize": false,
          "priority": 2,
          "cooldown": 0.1,
          "tags": ["interface", "hover"]
        },
        "menu-open": {
          "files": [
            "audio/sfx/ui/menu_open.ogg"
          ],
          "volume": 0.4,
          "randomize": false,
          "priority": 4,
          "tags": ["interface", "menu"]
        },
        "menu-close": {
          "files": [
            "audio/sfx/ui/menu_close.ogg"
          ],
          "volume": 0.4,
          "randomize": false,
          "priority": 4,
          "tags": ["interface", "menu"]
        }
      }
    },
    "items": {
      "description": "Item interaction and inventory sounds",
      "effects": {
        "item-pickup": {
          "files": [
            "audio/sfx/items/pickup.ogg"
          ],
          "volume": 0.7,
          "randomize": false,
          "priority": 5,
          "tags": ["inventory", "pickup"]
        },
        "item-equip": {
          "files": [
            "audio/sfx/items/equip.ogg"
          ],
          "volume": 0.7,
          "randomize": false,
          "priority": 5,
          "tags": ["inventory", "equip"]
        },
        "gold-coins": {
          "files": [
            "audio/sfx/items/coins.ogg"
          ],
          "volume": 0.6,
          "pitchVariance": {
            "min": 0.9,
            "max": 1.2
          },
          "randomize": false,
          "priority": 4,
          "tags": ["currency", "pickup"]
        }
      }
    },
    "puzzle": {
      "description": "Puzzle feedback and completion sounds",
      "effects": {
        "puzzle-correct": {
          "files": [
            "audio/sfx/puzzle/correct.ogg"
          ],
          "volume": 0.8,
          "randomize": false,
          "priority": 6,
          "tags": ["puzzle", "success"]
        },
        "puzzle-incorrect": {
          "files": [
            "audio/sfx/puzzle/incorrect.ogg"
          ],
          "volume": 0.7,
          "randomize": false,
          "priority": 5,
          "tags": ["puzzle", "failure"]
        },
        "puzzle-complete": {
          "files": [
            "audio/sfx/puzzle/fanfare.ogg"
          ],
          "volume": 1.0,
          "randomize": false,
          "priority": 9,
          "tags": ["puzzle", "complete"]
        }
      }
    },
    "movement": {
      "description": "Movement and environmental interaction sounds",
      "effects": {
        "footstep-stone": {
          "files": [
            "audio/sfx/movement/step_stone_01.ogg",
            "audio/sfx/movement/step_stone_02.ogg",
            "audio/sfx/movement/step_stone_03.ogg"
          ],
          "volume": 0.4,
          "volumeVariance": {
            "min": 0.8,
            "max": 1.0
          },
          "pitchVariance": {
            "min": 0.9,
            "max": 1.1
          },
          "randomize": true,
          "priority": 2,
          "cooldown": 0.2,
          "tags": ["footstep", "stone"]
        },
        "door-open": {
          "files": [
            "audio/sfx/movement/door_open.ogg"
          ],
          "volume": 0.6,
          "randomize": false,
          "priority": 5,
          "tags": ["interaction", "door"]
        },
        "chest-open": {
          "files": [
            "audio/sfx/movement/chest_open.ogg"
          ],
          "volume": 0.7,
          "randomize": false,
          "priority": 6,
          "tags": ["interaction", "container"]
        }
      }
    }
  },
  "settings": {
    "maxSimultaneous": 8,
    "defaultVolume": 0.8,
    "masterMute": false,
    "fallbackEnabled": true
  }
}
```

---

## 13. Data Model Changes

### Domain Layer Additions

This version introduces no new domain entities—only JSON Schema validation. Future runtime implementation would include:

| Component | Type | Purpose |
|-----------|------|---------|
| `SoundCategory` | Value Object | Category grouping with description |
| `SoundEffect` | Value Object | Complete effect configuration |
| `VolumeRange` | Value Object | Min/max volume variance |
| `PitchRange` | Value Object | Min/max pitch variance |
| `GlobalSettings` | Value Object | System-wide audio settings |

### No Cross-Reference Changes

The sound effect schema is self-contained. Effect IDs reference other effects within the same file via `fallbackEffectId`.

---

## 14. Logging Specifications

### Schema Validation Logging

| Event | Level | Message Format |
|-------|-------|----------------|
| Schema loaded | INFO | `Sound effects schema loaded from {path}` |
| Validation success | DEBUG | `Sound effects configuration validated ({categoryCount} categories, {effectCount} effects)` |
| Validation failure | ERROR | `Sound effects configuration validation failed: {errors}` |
| Missing required | WARN | `Sound effect {categoryId}/{effectId}: missing required field {field}` |
| Invalid range | WARN | `Sound effect {categoryId}/{effectId}: {field} value {value} outside valid range` |
| Empty files array | ERROR | `Sound effect {categoryId}/{effectId}: files array must have at least 1 item` |

### Runtime Logging (Future)

| Event | Level | Message Format |
|-------|-------|----------------|
| Effect loaded | DEBUG | `Loaded sound effect {categoryId}/{effectId} with {fileCount} files` |
| File not found | WARN | `Sound file not found: {filePath}, using fallback` |
| Fallback used | DEBUG | `Sound effect {effectId} using fallback: {fallbackEffectId}` |
| Fallback failed | WARN | `Sound effect {effectId} fallback {fallbackEffectId} also missing` |
| Playback started | DEBUG | `Playing {categoryId}/{effectId} at volume {volume}, pitch {pitch}` |
| Priority preempt | DEBUG | `Sound {effectId} preempted lower priority sound` |
| Cooldown blocked | DEBUG | `Sound {effectId} blocked by cooldown ({remaining}s remaining)` |
| Master muted | DEBUG | `Sound {effectId} skipped: master mute enabled` |

---

## 15. Unit Testing Requirements

### Test Summary

| Test ID | Test Name | Description |
|---------|-----------|-------------|
| SFX-001 | ValidSoundEffectConfiguration | Validates a complete configuration with all fields |
| SFX-002 | CategoryStructureValidation | Validates category additionalProperties structure |
| SFX-003 | EffectStructureValidation | Validates effect required/optional fields |
| SFX-004 | VolumeRangeValidation | Validates volume and volumeVariance ranges (0-1) |
| SFX-005 | PitchRangeValidation | Validates pitch and pitchVariance ranges (0.5-2.0) |
| SFX-006 | GlobalSettingsValidation | Validates settings with defaults and ranges |

### Test Specifications

#### SFX-001: ValidSoundEffectConfiguration

```
Test: Valid complete sound effects configuration passes schema validation
Given: A sound-effects.json with all required and optional fields populated correctly
When: Schema validation is performed
Then: Validation passes with no errors
And: All categories and effects are accessible
```

#### SFX-002: CategoryStructureValidation

```
Test: Category structure validates correctly with additionalProperties
Given: Sound effects configuration with various category names
When: Schema validation is performed with categories:
  - "combat" with effects → passes
  - "custom-category" with effects → passes
  - "ui-sounds" with effects → passes
  - Category missing "effects" property → fails
Then: Valid categories pass, invalid structure fails
```

#### SFX-003: EffectStructureValidation

```
Test: Effect structure validates required and optional fields correctly
Given: Sound effect definitions with various configurations
When: Schema validation is performed:
  - { "files": ["sound.ogg"] } → passes (minimal)
  - { "files": ["sound.ogg"], "volume": 0.5, "randomize": true } → passes
  - { "files": [] } → fails (empty array)
  - { "volume": 0.5 } → fails (missing files)
  - { "files": ["sound.ogg"], "unknownField": true } → fails
Then: Required fields enforced, optional fields allowed, unknown fields rejected
```

#### SFX-004: VolumeRangeValidation

```
Test: Volume values validate within 0-1 range
Given: Sound effects with various volume configurations
When: Schema validation is performed:
  - volume: 0 → passes (minimum)
  - volume: 1 → passes (maximum)
  - volume: 0.5 → passes
  - volume: -0.1 → fails (below minimum)
  - volume: 1.1 → fails (above maximum)
  - volumeVariance: { min: 0.5, max: 0.8 } → passes
  - volumeVariance: { min: 0.8, max: 0.5 } → passes (schema allows, runtime should validate)
  - volumeVariance: { min: -0.1, max: 1.0 } → fails
Then: Range violations produce validation errors
```

#### SFX-005: PitchRangeValidation

```
Test: Pitch values validate within 0.5-2.0 range
Given: Sound effects with various pitch configurations
When: Schema validation is performed:
  - pitch: 0.5 → passes (minimum)
  - pitch: 2.0 → passes (maximum)
  - pitch: 1.0 → passes (default)
  - pitch: 0.4 → fails (below minimum)
  - pitch: 2.1 → fails (above maximum)
  - pitchVariance: { min: 0.9, max: 1.1 } → passes
  - pitchVariance: { min: 0.4, max: 1.0 } → fails (min below range)
Then: Range violations produce validation errors
```

#### SFX-006: GlobalSettingsValidation

```
Test: Global settings validate correctly with defaults
Given: Settings configurations with various values
When: Schema validation is performed:
  - { "maxSimultaneous": 8 } → passes
  - { "maxSimultaneous": 1 } → passes (minimum)
  - { "maxSimultaneous": 0 } → fails (below minimum)
  - { "defaultVolume": 0.5 } → passes
  - { "defaultVolume": 1.5 } → fails (above maximum)
  - { "masterMute": true, "fallbackEnabled": false } → passes
  - { "unknownSetting": true } → fails
Then: Valid settings pass, invalid values and unknown fields fail
```

---

## 16. Use Cases

### UC-001: Load Sound Effects Configuration

```
┌─────────────────────────────────────────────────────────────────────────────┐
│ UC-001: Load Sound Effects Configuration                                     │
├─────────────────────────────────────────────────────────────────────────────┤
│ Actors: Game System                                                          │
│ Trigger: Game startup or configuration reload                                │
│ Preconditions: sound-effects.json exists in config directory                 │
├─────────────────────────────────────────────────────────────────────────────┤
│ Flow:                                                                        │
│ 1. System loads sound-effects.schema.json                                    │
│ 2. System loads sound-effects.json                                           │
│ 3. System validates sound-effects.json against schema                        │
│ 4. System parses categories and effects into memory                          │
│ 5. System logs successful load with category/effect counts                   │
├─────────────────────────────────────────────────────────────────────────────┤
│ Postconditions: Sound effect definitions available for playback              │
│ Exceptions: Invalid JSON → log error, use empty configuration                │
└─────────────────────────────────────────────────────────────────────────────┘
```

### UC-002: Play Sound Effect

```
┌─────────────────────────────────────────────────────────────────────────────┐
│ UC-002: Play Sound Effect                                                    │
├─────────────────────────────────────────────────────────────────────────────┤
│ Actors: Game System                                                          │
│ Trigger: Game event (attack, pickup, UI interaction, etc.)                   │
│ Preconditions: Sound effects configuration loaded                            │
├─────────────────────────────────────────────────────────────────────────────┤
│ Flow:                                                                        │
│ 1. System receives category and effect ID                                    │
│ 2. System looks up effect in configuration                                   │
│ 3. If randomize=true, select random file from array                          │
│ 4. Calculate final volume (base × variance if defined)                       │
│ 5. Calculate final pitch (base × variance if defined)                        │
│ 6. Check cooldown (skip if too recent)                                       │
│ 7. Check maxSimultaneous (preempt lower priority if needed)                  │
│ 8. Play audio file with calculated parameters                                │
├─────────────────────────────────────────────────────────────────────────────┤
│ Postconditions: Sound plays at appropriate volume/pitch                      │
│ Exceptions: Effect not found → try fallback → log warning if both fail       │
└─────────────────────────────────────────────────────────────────────────────┘
```

### UC-003: Resolve Fallback Effect

```
┌─────────────────────────────────────────────────────────────────────────────┐
│ UC-003: Resolve Fallback Effect                                              │
├─────────────────────────────────────────────────────────────────────────────┤
│ Actors: Game System                                                          │
│ Trigger: Primary sound file not found during playback                        │
│ Preconditions: fallbackEnabled = true in settings                            │
├─────────────────────────────────────────────────────────────────────────────┤
│ Flow:                                                                        │
│ 1. System attempts to load primary audio file                                │
│ 2. File load fails (file not found)                                          │
│ 3. System checks if effect has fallbackEffectId                              │
│ 4. If fallback exists, look up fallback effect                               │
│ 5. Attempt to play fallback effect instead                                   │
│ 6. Log warning about fallback usage                                          │
├─────────────────────────────────────────────────────────────────────────────┤
│ Postconditions: Fallback sound plays, or silence with warning logged         │
│ Exceptions: Fallback also missing → log warning, no sound                    │
└─────────────────────────────────────────────────────────────────────────────┘
```

### UC-004: Apply Volume/Pitch Variance

```
┌─────────────────────────────────────────────────────────────────────────────┐
│ UC-004: Apply Volume/Pitch Variance                                          │
├─────────────────────────────────────────────────────────────────────────────┤
│ Actors: Game System                                                          │
│ Trigger: Sound effect playback with variance configured                      │
│ Preconditions: Effect has volumeVariance and/or pitchVariance defined        │
├─────────────────────────────────────────────────────────────────────────────┤
│ Flow:                                                                        │
│ 1. Read base volume and pitch from effect definition                         │
│ 2. If volumeVariance defined:                                                │
│    a. Generate random value between min and max                              │
│    b. Multiply base volume by random value                                   │
│ 3. If pitchVariance defined:                                                 │
│    a. Generate random value between min and max                              │
│    b. Multiply base pitch by random value                                    │
│ 4. Clamp final values to valid ranges                                        │
│ 5. Apply to audio playback                                                   │
├─────────────────────────────────────────────────────────────────────────────┤
│ Postconditions: Sound plays with dynamically varied volume/pitch             │
│ Exceptions: None (variance is optional enhancement)                          │
└─────────────────────────────────────────────────────────────────────────────┘
```

### UC-005: Manage Simultaneous Playback

```
┌─────────────────────────────────────────────────────────────────────────────┐
│ UC-005: Manage Simultaneous Playback                                         │
├─────────────────────────────────────────────────────────────────────────────┤
│ Actors: Game System                                                          │
│ Trigger: New sound effect requested while at playback limit                  │
│ Preconditions: Currently playing sounds equals maxSimultaneous               │
├─────────────────────────────────────────────────────────────────────────────┤
│ Flow:                                                                        │
│ 1. New sound effect requested                                                │
│ 2. Count currently playing sounds                                            │
│ 3. If count >= maxSimultaneous:                                              │
│    a. Find sound with lowest priority                                        │
│    b. Compare new sound priority to lowest                                   │
│    c. If new priority > lowest priority:                                     │
│       - Stop lowest priority sound                                           │
│       - Play new sound in freed slot                                         │
│    d. If new priority <= lowest priority:                                    │
│       - Drop new sound (don't play)                                          │
│       - Log debug message                                                    │
├─────────────────────────────────────────────────────────────────────────────┤
│ Postconditions: Higher priority sounds preempt lower priority                │
│ Exceptions: None                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 17. Deliverable Checklist

### Configuration Files

| Status | File | Description |
|--------|------|-------------|
| ☐ | `config/schemas/sound-effects.schema.json` | Complete JSON Schema for sound effect validation |
| ☐ | `config/sound-effects.json` | Update with schema reference (already has reference) |

### Unit Tests

| Status | Test | Description |
|--------|------|-------------|
| ☐ | SFX-001 | Valid complete sound effect configuration |
| ☐ | SFX-002 | Category structure validation |
| ☐ | SFX-003 | Effect structure validation |
| ☐ | SFX-004 | Volume range validation |
| ☐ | SFX-005 | Pitch range validation |
| ☐ | SFX-006 | Global settings validation |

### Documentation

| Status | Document | Description |
|--------|----------|-------------|
| ☑ | Design Specification | This document |
| ☐ | Schema Documentation | Inline in schema file |

---

## 18. Acceptance Criteria

### Functional Criteria

- [ ] `sound-effects.schema.json` created in `config/schemas/`
- [ ] Schema validates existing `sound-effects.json` without errors
- [ ] Category names validated as strings (additionalProperties)
- [ ] Effect IDs validated as strings (additionalProperties)
- [ ] Files array validated (minItems: 1)
- [ ] Volume validated (0-1 range)
- [ ] Pitch validated (0.5-2.0 range)
- [ ] Volume/pitch variance validated
- [ ] Randomize flag validated as boolean
- [ ] Global settings validated
- [ ] ~6 unit tests pass

### Quality Criteria

- [ ] Schema follows JSON Schema Draft-07 specification
- [ ] All properties include descriptive comments
- [ ] Default values documented for optional fields
- [ ] Range constraints clearly specified
- [ ] Existing sound-effects.json validates without modification

### Integration Criteria

- [ ] Schema follows patterns from v0.14.5 schemas
- [ ] File path references use consistent format
- [ ] Fallback effect ID uses kebab-case pattern

---

## 19. Dependencies

### Required From

| Version | Dependency | Usage |
|---------|------------|-------|
| v0.14.5 | Economy Configuration Schemas | Schema infrastructure patterns |
| Existing | `config/sound-effects.json` | Configuration to validate |

### Provides To

| Version | Consumer | Usage |
|---------|----------|-------|
| v0.14.6b | Music Theme Schema | Audio schema patterns |
| Future | SoundEffectService | Sound effect data loading |
| Future | AudioSystem | Playback configuration |
| Future | abilities.json | Sound effect references |
| Future | damage-types.json | Sound effect references |

---

## 20. Future Considerations

### Deferred to Later Versions

| Feature | Rationale |
|---------|-----------|
| Audio file existence validation | Runtime concern, not schema |
| Audio format validation | External tooling concern |
| Spatial/3D audio configuration | Advanced audio feature |
| Dynamic music layer references | Music theme schema (v0.14.6b) |
| Event trigger binding schema | Runtime mapping concern |

### Potential Enhancements

| Enhancement | Description |
|-------------|-------------|
| Audio bus routing | Categorize sounds into mix buses |
| Distance attenuation | Configure volume by distance |
| Reverb/echo effects | Environmental audio processing |
| Ducking configuration | Lower sounds when others play |
| Sound pooling config | Pre-load sounds for performance |
| Audio compression hints | Quality vs size tradeoffs |

---

## Appendix A: Schema Validation Examples

### Valid Effect (Minimal)

```json
{
  "files": ["audio/sfx/generic/beep.ogg"]
}
```

### Valid Effect (Complete)

```json
{
  "files": [
    "audio/sfx/combat/hit_01.ogg",
    "audio/sfx/combat/hit_02.ogg"
  ],
  "volume": 0.8,
  "volumeVariance": {
    "min": 0.9,
    "max": 1.1
  },
  "pitch": 1.0,
  "pitchVariance": {
    "min": 0.95,
    "max": 1.05
  },
  "randomize": true,
  "loop": false,
  "cooldown": 0.1,
  "priority": 6,
  "fallbackEffectId": "generic-hit",
  "tags": ["weapon", "melee", "impact"]
}
```

### Invalid Examples

```json
// Invalid: Empty files array
{
  "files": []
}
// Error: 'files' must have at least 1 item

// Invalid: Missing files property
{
  "volume": 0.5,
  "randomize": true
}
// Error: Missing required property 'files'

// Invalid: Volume out of range
{
  "files": ["sound.ogg"],
  "volume": 1.5
}
// Error: 'volume' must be <= 1

// Invalid: Pitch out of range
{
  "files": ["sound.ogg"],
  "pitch": 0.3
}
// Error: 'pitch' must be >= 0.5

// Invalid: Unknown property
{
  "files": ["sound.ogg"],
  "stereo": true
}
// Error: Additional properties not allowed: 'stereo'

// Invalid: Priority out of range
{
  "files": ["sound.ogg"],
  "priority": 15
}
// Error: 'priority' must be <= 10
```

---

*End of v0.14.6a Design Specification*
