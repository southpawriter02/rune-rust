using Microsoft.Extensions.Logging;
using RuneAndRust.Application.Interfaces;
using RuneAndRust.Presentation.Tui.Configuration;
using RuneAndRust.Presentation.Tui.DTOs;
using RuneAndRust.Presentation.Tui.Renderers;

namespace RuneAndRust.Presentation.Tui.UI;

/// <summary>
/// Displays vulnerability window status showing when the boss takes
/// increased damage and the remaining duration.
/// </summary>
/// <remarks>
/// <para>The vulnerability window is triggered by SetVulnerable() and lasts
/// for a configured number of turns. During this time, the boss takes
/// increased damage (default 1.5x = 50% bonus).</para>
/// <para>Features:</para>
/// <list type="bullet">
///   <item><description>Active window display with turns remaining</description></item>
///   <item><description>Damage bonus indicator (e.g., "+50% damage")</description></item>
///   <item><description>Urgent flashing when 1 turn remaining</description></item>
///   <item><description>Window closed notification</description></item>
/// </list>
/// </remarks>
/// <example>
/// <code>
/// var window = new VulnerabilityWindow(renderer, terminalService, config, logger);
/// 
/// // Show active vulnerability
/// var activeDto = new VulnerabilityDisplayDto(true, 2, 1.5f);
/// window.RenderWindow(activeDto);
/// 
/// // Show window closed
/// window.ShowWindowClosed();
/// </code>
/// </example>
public class VulnerabilityWindow
{
    private readonly BossStatusRenderer _renderer;
    private readonly ITerminalService _terminalService;
    private readonly BossStatusDisplayConfig _config;
    private readonly ILogger<VulnerabilityWindow>? _logger;

    private VulnerabilityDisplayDto? _currentStatus;

    /// <summary>
    /// Creates a new instance of the VulnerabilityWindow.
    /// </summary>
    /// <param name="renderer">The renderer for formatting vulnerability elements.</param>
    /// <param name="terminalService">The terminal output service.</param>
    /// <param name="config">Configuration for display settings.</param>
    /// <param name="logger">Logger for diagnostic output.</param>
    /// <exception cref="ArgumentNullException">
    /// Thrown when <paramref name="renderer"/> or <paramref name="terminalService"/> is null.
    /// </exception>
    public VulnerabilityWindow(
        BossStatusRenderer renderer,
        ITerminalService terminalService,
        BossStatusDisplayConfig? config = null,
        ILogger<VulnerabilityWindow>? logger = null)
    {
        _renderer = renderer ?? throw new ArgumentNullException(nameof(renderer));
        _terminalService = terminalService ?? throw new ArgumentNullException(nameof(terminalService));
        _config = config ?? BossStatusDisplayConfig.CreateDefault();
        _logger = logger;

        _logger?.LogDebug(
            "VulnerabilityWindow initialized at position ({X}, {Y})",
            _config.VulnerabilityWindow.StartX, _config.VulnerabilityWindow.StartY);
    }

    /// <summary>
    /// Renders the vulnerability window status.
    /// </summary>
    /// <param name="displayDto">The vulnerability display data.</param>
    /// <exception cref="ArgumentNullException">Thrown when <paramref name="displayDto"/> is null.</exception>
    /// <remarks>
    /// <para>Renders based on active state:</para>
    /// <list type="bullet">
    ///   <item><description>Active: Shows open window with turns remaining</description></item>
    ///   <item><description>Inactive: Clears the display</description></item>
    /// </list>
    /// </remarks>
    public void RenderWindow(VulnerabilityDisplayDto displayDto)
    {
        _currentStatus = displayDto ?? throw new ArgumentNullException(nameof(displayDto));

        _logger?.LogDebug(
            "Rendering vulnerability window: IsActive={IsActive}, Turns={Turns}",
            displayDto.IsActive,
            displayDto.TurnsRemaining);

        if (displayDto.IsActive)
        {
            ShowWindowOpen(displayDto.TurnsRemaining);
        }
        else
        {
            Clear();
        }
    }

    /// <summary>
    /// Displays the vulnerability window open indicator.
    /// </summary>
    /// <param name="turnsRemaining">Number of turns remaining.</param>
    /// <remarks>
    /// <para>Display format:</para>
    /// <example>[!] VULNERABILITY WINDOW OPEN (2 turns) - Deal +50% damage!</example>
    /// <para>When 1 turn remaining, triggers urgent flashing effect.</para>
    /// </remarks>
    public void ShowWindowOpen(int turnsRemaining)
    {
        _logger?.LogInformation(
            "Vulnerability window OPEN - {Turns} turns remaining",
            turnsRemaining);

        var windowText = _renderer.FormatVulnerabilityWindow(
            turnsRemaining,
            _config.VulnerabilityWindow.DamageMultiplier);

        _terminalService.WriteColoredAt(
            _config.VulnerabilityWindow.StartX,
            _config.VulnerabilityWindow.StartY,
            windowText,
            _config.Colors.VulnerableColor);

        // Add flashing effect for urgency when 1 turn remaining
        if (turnsRemaining == 1)
        {
            FlashUrgency();
        }
    }

    /// <summary>
    /// Displays the vulnerability window closed notification.
    /// </summary>
    /// <remarks>
    /// <para>Shows a brief "[x] Vulnerability window closed" message,
    /// then clears after the configured duration.</para>
    /// </remarks>
    public void ShowWindowClosed()
    {
        _logger?.LogInformation("Vulnerability window CLOSED");

        var closedText = _renderer.FormatWindowClosed();

        _terminalService.WriteColoredAt(
            _config.VulnerabilityWindow.StartX,
            _config.VulnerabilityWindow.StartY,
            closedText,
            _config.Colors.WindowClosedColor);

        // Brief display then clear
        _terminalService.FlashDelay(_config.VulnerabilityWindow.ClosedDisplayMs);
        Clear();
    }

    /// <summary>
    /// Clears the vulnerability window display.
    /// </summary>
    /// <remarks>
    /// Resets internal state and clears the display area.
    /// </remarks>
    public void Clear()
    {
        _currentStatus = null;

        var clearWidth = _config.VulnerabilityWindow.Width;
        var clearLine = new string(' ', clearWidth);

        _terminalService.WriteAt(
            _config.VulnerabilityWindow.StartX,
            _config.VulnerabilityWindow.StartY,
            clearLine);

        _logger?.LogDebug("Cleared vulnerability window display");
    }

    /// <summary>
    /// Gets whether the vulnerability window is currently active.
    /// </summary>
    public bool IsActive => _currentStatus?.IsActive ?? false;

    /// <summary>
    /// Gets the current turns remaining, if active.
    /// </summary>
    public int? TurnsRemaining => _currentStatus?.TurnsRemaining;

    #region Private Methods

    /// <summary>
    /// Flashes the vulnerability text to indicate urgency (1 turn remaining).
    /// </summary>
    /// <remarks>
    /// <para>Flash sequence:</para>
    /// <list type="number">
    ///   <item><description>Wait for flash interval</description></item>
    ///   <item><description>Show urgent message in urgent color</description></item>
    ///   <item><description>Wait for flash interval</description></item>
    ///   <item><description>Repeat once</description></item>
    /// </list>
    /// </remarks>
    private void FlashUrgency()
    {
        _logger?.LogDebug("Flashing urgency for last turn");

        // Flash the vulnerability text to indicate urgency
        for (var i = 0; i < 2; i++)
        {
            _terminalService.FlashDelay(_config.VulnerabilityWindow.FlashIntervalMs);

            var urgentText = _renderer.FormatVulnerabilityUrgent();
            _terminalService.WriteColoredAt(
                _config.VulnerabilityWindow.StartX,
                _config.VulnerabilityWindow.StartY,
                urgentText,
                _config.Colors.UrgentColor);

            _terminalService.FlashDelay(_config.VulnerabilityWindow.FlashIntervalMs);
        }
    }

    #endregion
}
