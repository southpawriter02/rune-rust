> **Archived** - This changelog has been consolidated. See the complete version at [v0.3.3](../v0.3.x/v0.3.3.md).

# Changelog: v0.3.3a - The Ground (Dynamic Hazards)

**Release Date:** 2025-12-21

## Summary

This release introduces the Dynamic Hazard system - interactive environmental objects that transform static rooms into reactive battlefields. Hazards (traps, vents, spore pods) trigger based on player/enemy actions: movement, damage taken, turn start, or manual interaction. The system leverages a shared EffectScriptExecutor utility extracted from AbilityService, enabling consistent "DAMAGE:Fire:2d6;STATUS:Bleeding:2" parsing across abilities and hazards. DynamicHazard extends InteractableObject via TPH inheritance, gaining hazard-specific properties (HazardState, TriggerType, cooldowns, effect scripts). HazardService handles trigger detection, effect execution, and lifecycle state management (Dormant -> Triggered -> Cooldown -> Dormant or Destroyed for one-time hazards). Integration hooks in CombatService and NavigationService enable automatic hazard triggering on damage dealt and room entry. This release includes 28 new unit tests (21 EffectScriptExecutorTests + 28 HazardServiceTests) validating the hazard system.

---

## New Files Created

### Core Layer
| File | Purpose |
|------|---------|
| `RuneAndRust.Core/Enums/HazardState.cs` | Lifecycle states: Dormant, Triggered, Cooldown, Destroyed |
| `RuneAndRust.Core/Enums/TriggerType.cs` | Trigger conditions: Movement, DamageTaken, TurnStart, ManualInteraction |
| `RuneAndRust.Core/Enums/HazardType.cs` | Classification: Mechanical, Environmental, Biological |
| `RuneAndRust.Core/Enums/DamageType.cs` | Damage types: Physical, Fire, Ice, Lightning, Poison, Acid, Psychic, Blight |
| `RuneAndRust.Core/Entities/DynamicHazard.cs` | Entity extending InteractableObject with hazard-specific properties |
| `RuneAndRust.Core/Models/HazardResult.cs` | Result record for hazard activation with damage, healing, statuses, state |
| `RuneAndRust.Core/Interfaces/IHazardService.cs` | Service contract for hazard processing |

### Engine Layer
| File | Purpose |
|------|---------|
| `RuneAndRust.Engine/Services/EffectScriptExecutor.cs` | Shared utility for parsing and executing effect scripts ("DAMAGE:Fire:2d6;STATUS:Bleeding:2") |
| `RuneAndRust.Engine/Services/HazardService.cs` | Core hazard trigger logic and lifecycle state management |

### Test Layer
| File | Purpose |
|------|---------|
| `RuneAndRust.Tests/Engine/EffectScriptExecutorTests.cs` | 21 unit tests for effect script parsing (DAMAGE, HEAL, STATUS commands) |
| `RuneAndRust.Tests/Engine/HazardServiceTests.cs` | 28 unit tests for hazard triggers, cooldowns, state transitions |

---

## Files Modified

| File | Change |
|------|--------|
| `RuneAndRust.Core/Enums/ObjectType.cs` | Added `Hazard = 5` enum value |
| `RuneAndRust.Core/Entities/Room.cs` | Added `Hazards` collection property (List<DynamicHazard>) |
| `RuneAndRust.Engine/Services/AbilityService.cs` | Refactored to use EffectScriptExecutor instead of inline parsing |
| `RuneAndRust.Engine/Services/CombatService.cs` | Added IHazardService/IRoomRepository dependencies, ProcessDamageHazardsAsync() and TickHazardCooldownsAsync() methods |
| `RuneAndRust.Engine/Services/NavigationService.cs` | Added IHazardService/IInputHandler dependencies, hazard trigger on room entry |
| `RuneAndRust.Engine/Services/ObjectSpawner.cs` | Excluded Hazard type from random spawning (hazards are placed intentionally) |
| `RuneAndRust.Persistence/Data/RuneAndRustDbContext.cs` | Configured TPH discriminator for DynamicHazard, added DbSet<DynamicHazard> |
| `RuneAndRust.Terminal/Program.cs` | Registered EffectScriptExecutor (Singleton) and HazardService (Scoped), updated version to v0.3.3a |
| `RuneAndRust.Tests/Engine/AbilityServiceTests.cs` | Updated constructor to use EffectScriptExecutor |
| `RuneAndRust.Tests/Engine/CombatServiceTests.cs` | Added IHazardService and IRoomRepository mocks |
| `RuneAndRust.Tests/Engine/NavigationServiceTests.cs` | Added IHazardService and IInputHandler mocks |
| `RuneAndRust.Tests/Core/ObjectTypeTests.cs` | Updated count from 5 to 6 values |

---

## Code Implementation Details

### HazardState Enum

```csharp
public enum HazardState
{
    Dormant = 0,    // Ready to trigger
    Triggered = 1,  // Currently activating (transient)
    Cooldown = 2,   // Recharging
    Destroyed = 3   // One-time use, consumed
}
```

### TriggerType Enum

```csharp
public enum TriggerType
{
    Movement = 0,        // Triggered when entering room
    DamageTaken = 1,     // Triggered when damage dealt in room
    TurnStart = 2,       // Triggered at combat turn start
    ManualInteraction = 3 // Triggered by explicit "activate" command
}
```

### DynamicHazard Entity

**Key Properties:**
- `HazardType`: Classification (Mechanical, Environmental, Biological)
- `State`: Current lifecycle state (Dormant/Triggered/Cooldown/Destroyed)
- `CooldownRemaining`/`MaxCooldown`: Cooldown tracking
- `OneTimeUse`: If true, transitions to Destroyed after trigger
- `Trigger`: What activates this hazard
- `RequiredDamageType`: Optional filter for damage-triggered hazards
- `DamageThreshold`: Minimum damage required to trigger
- `EffectScript`: Command string (e.g., "DAMAGE:Fire:2d6;STATUS:Bleeding:2")
- `TriggerMessage`: Custom activation message

**Constructor:**
```csharp
public DynamicHazard()
{
    ObjectType = ObjectType.Hazard;
}
```

### EffectScriptExecutor

**Constructor:**
```csharp
public EffectScriptExecutor(
    IDiceService diceService,
    IStatusEffectService statusEffectService,
    ILogger<EffectScriptExecutor> logger)
```

**Execute Method:**
```csharp
public EffectScriptResult Execute(
    string effectScript,
    Combatant target,
    string sourceName,
    Guid? sourceId = null)
```

**Supported Commands:**
- `DAMAGE:Type:Dice` - Deal damage (e.g., "DAMAGE:Fire:2d6")
- `HEAL:Amount` - Restore HP (e.g., "HEAL:15" or "HEAL:2d4")
- `STATUS:Type:Duration:Stacks` - Apply status effect (e.g., "STATUS:Bleeding:3:2")

**Damage Soak Logic:**
- Physical damage: Reduced by ArmorSoak + status modifiers
- Elemental damage (Fire, Ice, Lightning, etc.): Bypasses armor soak

### HazardService

**Constructor:**
```csharp
public HazardService(
    IInteractableObjectRepository objectRepository,
    EffectScriptExecutor scriptExecutor,
    ILogger<HazardService> logger)
```

**Key Methods:**

**TriggerOnRoomEnterAsync(Room room, Combatant? entrant)**
- Finds all Dormant hazards with TriggerType.Movement
- Activates each, executing EffectScript against entrant
- Returns list of HazardResult records

**TriggerOnDamageAsync(Room room, DamageType damageType, int amount, Combatant? target)**
- Finds all Dormant hazards with TriggerType.DamageTaken
- Filters by RequiredDamageType and DamageThreshold
- Activates matching hazards

**ProcessTurnStartHazardsAsync(Room room, List<Combatant> combatants)**
- Finds all Dormant hazards with TriggerType.TurnStart
- Applies effects to ALL combatants in room

**TickCooldownsAsync(Room room)**
- Decrements CooldownRemaining for hazards in Cooldown state
- Transitions to Dormant when cooldown reaches 0

**ManualActivateAsync(DynamicHazard hazard, Combatant activator)**
- Allows explicit activation of ManualInteraction hazards
- Validates trigger type and Dormant state

**ActivateHazardAsync (Private):**
```csharp
private async Task<HazardResult> ActivateHazardAsync(DynamicHazard hazard, Combatant? target)
{
    hazard.State = HazardState.Triggered;

    // Execute effect script if target provided
    if (target != null && !string.IsNullOrWhiteSpace(hazard.EffectScript))
    {
        var scriptResult = _scriptExecutor.Execute(
            hazard.EffectScript,
            target,
            hazard.Name,
            hazard.Id);
        // Aggregate results...
    }

    // Update state
    if (hazard.OneTimeUse)
    {
        hazard.State = HazardState.Destroyed;
    }
    else
    {
        hazard.State = HazardState.Cooldown;
        hazard.CooldownRemaining = hazard.MaxCooldown;
    }

    await _objectRepository.UpdateAsync(hazard);
    return new HazardResult(...);
}
```

### CombatService Integration

**New Dependencies:**
```csharp
private readonly IHazardService _hazardService;
private readonly IRoomRepository _roomRepository;
```

**Hazard Processing Region:**
```csharp
#region Hazard System (v0.3.3a)

private async Task ProcessDamageHazardsAsync(DamageType damageType, int amount, Combatant target)
{
    if (_gameState.CurrentRoomId == null) return;

    var room = await _roomRepository.GetByIdAsync(_gameState.CurrentRoomId.Value);
    if (room == null) return;

    var hazardResults = await _hazardService.TriggerOnDamageAsync(room, damageType, amount, target);
    foreach (var result in hazardResults.Where(r => r.WasTriggered))
    {
        _inputHandler.DisplayMessage($"[HAZARD] {result.Message}");
    }
}

private async Task TickHazardCooldownsAsync()
{
    if (_gameState.CurrentRoomId == null) return;

    var room = await _roomRepository.GetByIdAsync(_gameState.CurrentRoomId.Value);
    if (room != null)
    {
        await _hazardService.TickCooldownsAsync(room);
    }
}

#endregion
```

### NavigationService Integration

**New Dependencies:**
```csharp
private readonly IHazardService _hazardService;
private readonly IInputHandler _inputHandler;
```

**Hazard Trigger on Room Entry:**
```csharp
// After room change:
_gameState.CurrentRoomId = nextRoomId;
_gameState.TurnCount++;

// Trigger movement hazards (v0.3.3a)
var hazardResults = await _hazardService.TriggerOnRoomEnterAsync(nextRoom);
foreach (var result in hazardResults.Where(r => r.WasTriggered))
{
    _inputHandler.DisplayMessage($"[HAZARD] {result.Message}");
}
```

### Database Configuration (TPH)

**RuneAndRustDbContext OnModelCreating:**
```csharp
// TPH Discriminator for InteractableObject hierarchy
modelBuilder.Entity<InteractableObject>()
    .HasDiscriminator<ObjectType>("ObjectType")
    .HasValue<InteractableObject>(ObjectType.Furniture)
    .HasValue<DynamicHazard>(ObjectType.Hazard);

// DynamicHazard-specific columns
modelBuilder.Entity<DynamicHazard>(entity =>
{
    entity.Property(e => e.HazardType).HasConversion<int>();
    entity.Property(e => e.State).HasConversion<int>();
    entity.Property(e => e.Trigger).HasConversion<int>();
    entity.Property(e => e.RequiredDamageType).HasConversion<int?>();
    entity.Property(e => e.EffectScript).HasMaxLength(500);
    entity.Property(e => e.TriggerMessage).HasMaxLength(500);
});
```

---

## Logging Matrix

| Context | Level | Template |
|---------|-------|----------|
| Hazard Triggered | Info | `"[Hazard] [{Hazard}] triggered by {Trigger} in {Room}"` |
| Hazard Effect | Debug | `"[Hazard] [{Hazard}] executing script: {Script}"` |
| Hazard Destroyed | Debug | `"[Hazard] [{Hazard}] destroyed after one-time trigger"` |
| Hazard Cooldown | Debug | `"[Hazard] [{Hazard}] entering cooldown: {Cooldown} turns"` |
| Hazard Reset | Trace | `"[Hazard] [{Hazard}] cooldown complete, returning to Dormant"` |
| EffectScript Parse | Debug | `"[EffectScript] Executing script: {Script} on {Target} from {Source}"` |
| EffectScript Command | Debug | `"[EffectScript] Executing command: {Command}"` |
| EffectScript Complete | Info | `"[EffectScript] Execution complete. Damage: {Damage}, Healing: {Healing}, Statuses: [{Statuses}]"` |
| Unknown Command | Warning | `"[EffectScript] Unknown command type: {CommandType}"` |

---

## Test Coverage

### EffectScriptExecutorTests (21 tests)

| Test | Description |
|------|-------------|
| Execute_EmptyScript_ReturnsEmptyResult | Empty string returns zero damage/healing |
| Execute_NullScript_ReturnsEmptyResult | Null script handled gracefully |
| Execute_WhitespaceScript_ReturnsEmptyResult | Whitespace-only script returns empty |
| Execute_DamageCommand_RollsDiceAndAppliesDamage | Fire damage rolls dice and applies |
| Execute_PhysicalDamage_AppliesArmorSoak | Physical damage reduced by armor |
| Execute_PhysicalDamage_SoakCapsAtZero | Soak can't make damage negative |
| Execute_FireDamage_BypassesArmorSoak | Elemental damage ignores soak |
| Execute_DamageCommand_AppliesVulnerabilityMultiplier | Vulnerability increases damage |
| Execute_DamageCommand_IncludesNarrative | Result includes narrative text |
| Execute_DamageCommand_MissingParameters_ReturnsZeroDamage | Missing params handled |
| Execute_DamageCommand_InvalidDiceNotation_ReturnsZeroDamage | Bad notation handled |
| Execute_HealCommand_FlatValue_RestoresHP | Flat healing works |
| Execute_HealCommand_ClampsToMaxHP | Healing capped at max HP |
| Execute_HealCommand_AtFullHP_ReturnsZeroHealing | Full HP returns 0 heal |
| Execute_HealCommand_DiceNotation_RollsAndHeals | Dice-based healing works |
| Execute_HealCommand_MissingAmount_ReturnsZeroHealing | Missing amount handled |
| Execute_StatusCommand_AppliesEffect | Status applied via service |
| Execute_StatusCommand_WithStacks_AppliesMultipleTimes | Stacks call ApplyEffect multiple times |
| Execute_StatusCommand_UnknownStatusType_DoesNotApply | Unknown status skipped |
| Execute_StatusCommand_MissingDuration_DoesNotApply | Missing duration handled |
| Execute_MultipleCommands_AllExecute | Multiple commands in one script |
| Execute_MultipleCommands_AggregatesDamage | Damage aggregates across commands |
| Execute_MultipleCommands_CombinesNarratives | Narratives combined |
| Execute_UnknownCommand_SkippedAndLogged | Unknown commands skipped |

### HazardServiceTests (28 tests)

| Test | Description |
|------|-------------|
| TriggerOnRoomEnterAsync_DormantMovementHazard_TriggersAndAppliesDamage | Movement trigger activates |
| TriggerOnRoomEnterAsync_CooldownHazard_DoesNotTrigger | Cooldown hazards skipped |
| TriggerOnRoomEnterAsync_DestroyedHazard_NotIncluded | Destroyed excluded |
| TriggerOnRoomEnterAsync_DamageTriggerHazard_DoesNotTriggerOnMovement | Wrong trigger type skipped |
| TriggerOnRoomEnterAsync_NoEntrant_TriggersWithoutApplyingDamage | No target = no damage |
| TriggerOnDamageAsync_MatchingDamageType_Triggers | Matching type triggers |
| TriggerOnDamageAsync_WrongDamageType_DoesNotTrigger | Wrong type filtered |
| TriggerOnDamageAsync_AnyDamageType_TriggersOnAnyType | Null RequiredDamageType = any |
| TriggerOnDamageAsync_BelowThreshold_DoesNotTrigger | Below threshold skipped |
| TriggerOnDamageAsync_AtThreshold_Triggers | At threshold triggers |
| ActivateHazard_OneTimeUse_SetsDestroyedState | OneTimeUse -> Destroyed |
| ActivateHazard_Reusable_SetsCooldownState | Reusable -> Cooldown |
| TickCooldownsAsync_DecrementsCooldown | Cooldown decrements |
| TickCooldownsAsync_ZeroCooldown_ReturnsToDormant | 0 cooldown -> Dormant |
| TickCooldownsAsync_DormantHazard_NoChange | Dormant unaffected |
| TickCooldownsAsync_MultipleCooldownHazards_AllTicked | All hazards ticked |
| ProcessTurnStartHazardsAsync_ActiveHazard_AppliesEffectToAllCombatants | Applies to all |
| ManualActivateAsync_ManualTriggerHazard_Activates | Manual activation works |
| ManualActivateAsync_NotManualTriggerHazard_DoesNotActivate | Wrong trigger rejected |
| ManualActivateAsync_NotDormantHazard_DoesNotActivate | Non-dormant rejected |
| GetActiveHazardsAsync_ReturnsOnlyNonDestroyedHazards | Destroyed filtered |
| ActivateHazard_MechanicalType_ReturnsGrindingMessage | Mechanical message |
| ActivateHazard_EnvironmentalType_ReturnsEruptsMessage | Environmental message |
| ActivateHazard_BiologicalType_ReturnsNoxiousMessage | Biological message |
| ActivateHazard_CustomTriggerMessage_UsesCustomMessage | Custom message used |

---

## DI Registration

**Program.cs Additions:**
```csharp
// Register Hazard Services (v0.3.3a)
services.AddSingleton<EffectScriptExecutor>();
services.AddScoped<IHazardService, HazardService>();
```

---

## Seed Data Examples

Three starter hazards for testing (not seeded in this release, for manual testing):

### Steam Vent
- **Trigger:** DamageTaken (any type, threshold 5)
- **Effect:** "DAMAGE:Fire:2d6"
- **Cooldown:** 2 turns
- **OneTimeUse:** false

### Pressure Plate
- **Trigger:** Movement
- **Effect:** "DAMAGE:Physical:1d8"
- **Cooldown:** 0 (instant reset)
- **OneTimeUse:** false

### Volatile Spore Pod
- **Trigger:** DamageTaken (any type, threshold 1)
- **Effect:** "DAMAGE:Poison:1d6;STATUS:Poisoned:3"
- **Cooldown:** N/A
- **OneTimeUse:** true

---

## Deferred to Later Versions

The following features are planned for later versions in the v0.3.3 cycle:

### v0.3.3b - The Haze (Ambient Conditions)
- **Ambient Conditions System**: Room-wide buffs/debuffs affecting all combatants
- **Condition Types**: Low Visibility, Toxic Atmosphere, Extreme Cold, etc.
- **Duration Management**: Temporary vs. permanent room conditions
- **UI Integration**: Condition display in exploration and combat

### v0.3.3c - The Mind (AI Hazard Awareness)
- **AI Hazard Awareness**: Enemies can detect and avoid traps
- **Tactical AI Updates**: Smarter enemy positioning around hazards
- **Chain Reactions**: Explosions triggering nearby hazards
- **UI Hazard Rendering**: Visual representation of hazards in TUI

### Future Milestone
- **Tile-Based Positioning**: Spatial hazard placement on room grid
- **Area of Effect**: Hazards affecting specific tiles vs. room-wide
- **Player Hazard Interaction**: Disarm, trigger, or leverage hazards tactically

---

## Breaking Changes

None. This release is backward compatible.

---

## Migration Notes

### Database
A new migration may be required to add the DynamicHazard columns to the InteractableObjects table (using TPH inheritance). The discriminator column `ObjectType` should already exist; new columns include:
- `HazardType` (int)
- `State` (int)
- `Trigger` (int)
- `RequiredDamageType` (int, nullable)
- `DamageThreshold` (int)
- `EffectScript` (varchar 500)
- `TriggerMessage` (varchar 500)
- `OneTimeUse` (bit)
- `MaxCooldown` (int)
- `CooldownRemaining` (int)

---

## Contributors

- Claude Code (Architect Agent)
