> **Archived** - This changelog has been consolidated. See the complete version at [v0.3.4](../v0.3.x/v0.3.4.md).

# Changelog: v0.3.4b - The Forge (Creation Wizard)

**Release Date:** 2025-12-21

## Summary

This release implements an interactive split-screen character creation wizard with real-time stat previews. The CreationWizard replaces the linear CharacterCreationController with a dynamic UI that shows live stat calculations as the player hovers over lineage and archetype options. The left panel displays selectable options with descriptions and bonuses, while the right panel renders a BarChart visualization of attributes and derived stats. WizardService provides preview stat calculations by combining base attributes with lineage and archetype bonuses. StatPreviewRenderer creates the visual representation using Spectre.Console's BarChart. A custom non-blocking input loop using Console.KeyAvailable and Console.ReadKey(intercept: true) enables ~60fps UI refresh while polling for arrow key navigation. This release includes 33 unit tests validating preview stat calculations, lineage/archetype bonuses, derived stat formulas, and display name retrieval.

---

## New Files Created

### Core Layer
| File | Purpose |
|------|---------|
| `RuneAndRust.Core/Models/WizardContext.cs` | Tracks partial wizard selections (Name, Lineage, Archetype, CurrentStep) |
| `RuneAndRust.Core/Interfaces/IWizardService.cs` | Interface for preview stat calculations with DerivedStats record |

### Engine Layer
| File | Purpose |
|------|---------|
| `RuneAndRust.Engine/Services/WizardService.cs` | Implementation of preview calculations using StatCalculationService |

### Terminal Layer
| File | Purpose |
|------|---------|
| `RuneAndRust.Terminal/Rendering/StatPreviewRenderer.cs` | Static renderer for BarChart stat visualization |
| `RuneAndRust.Terminal/Services/CreationWizard.cs` | Split-screen wizard controller with custom input loop |

### Test Layer
| File | Purpose |
|------|---------|
| `RuneAndRust.Tests/Engine/WizardServiceTests.cs` | 33 unit tests for preview calculations and display names |

---

## Files Modified

| File | Change |
|------|--------|
| `RuneAndRust.Terminal/Program.cs` | Added IWizardService and CreationWizard DI registration, updated NewGame case to use CreationWizard, updated version to v0.3.4b |

---

## Code Implementation Details

### WizardContext Model

```csharp
public class WizardContext
{
    public string Name { get; set; } = string.Empty;
    public LineageType? Lineage { get; set; }
    public ArchetypeType? Archetype { get; set; }
    public int CurrentStep { get; set; } = 0;

    public bool IsStepComplete(int stepIndex) => stepIndex switch
    {
        0 => !string.IsNullOrWhiteSpace(Name),
        1 => Lineage.HasValue,
        2 => Archetype.HasValue,
        _ => false
    };

    public void Reset() { /* clears all fields */ }
    public void ClearCurrentStep() { /* clears current step field */ }
}
```

### DerivedStats Record

```csharp
public record DerivedStats(int MaxHP, int MaxStamina, int ActionPoints);

// Formulas:
// MaxHP = 50 + Sturdiness * 10
// MaxStamina = 20 + Finesse * 5 + Sturdiness * 3
// ActionPoints = 2 + Wits / 4
```

### IWizardService Interface

```csharp
public interface IWizardService
{
    Dictionary<CharacterAttribute, int> GetPreviewStats(
        WizardContext context,
        LineageType? previewLineage = null,
        ArchetypeType? previewArchetype = null);

    DerivedStats GetDerivedStats(
        Dictionary<CharacterAttribute, int> stats,
        ArchetypeType? archetype);

    string GetLineageDisplayName(LineageType lineage);
    string GetLineageDescription(LineageType lineage);
    string GetLineageBonusSummary(LineageType lineage);
    string GetArchetypeDisplayName(ArchetypeType archetype);
    string GetArchetypeDescription(ArchetypeType archetype);
    string GetArchetypeBonusSummary(ArchetypeType archetype);
}
```

### StatPreviewRenderer

```csharp
public static IRenderable Render(
    Dictionary<CharacterAttribute, int> stats,
    DerivedStats derived,
    string? lineageName = null,
    string? archetypeName = null)
{
    // Creates BarChart with 5 attributes
    var chart = new BarChart()
        .Width(30)
        .AddItem("STU", stats[CharacterAttribute.Sturdiness], Color.Green)
        .AddItem("MIG", stats[CharacterAttribute.Might], Color.Red)
        .AddItem("WIT", stats[CharacterAttribute.Wits], Color.Blue)
        .AddItem("WIL", stats[CharacterAttribute.Will], Color.Purple)
        .AddItem("FIN", stats[CharacterAttribute.Finesse], Color.Yellow);

    // Plus derived stats table
    // Returns Rows composition of all elements
}
```

### CreationWizard Split-Screen Layout

```csharp
private async Task<T?> RunSelectionStepAsync<T>(...)
{
    await AnsiConsole.Live(new Text(""))
        .AutoClear(false)
        .StartAsync(async ctx =>
        {
            while (result == null && !cancelled)
            {
                var layout = new Layout("Root")
                    .SplitColumns(
                        new Layout("Left").Size(50),  // Menu panel
                        new Layout("Right"));         // Preview panel

                layout["Left"].Update(menuPanel);
                layout["Right"].Update(previewPanel);
                ctx.UpdateTarget(layout);

                // Non-blocking input check
                if (Console.KeyAvailable)
                {
                    var key = Console.ReadKey(intercept: true);
                    switch (key.Key)
                    {
                        case ConsoleKey.UpArrow:
                        case ConsoleKey.K:
                            _selectedIndex = Math.Max(0, _selectedIndex - 1);
                            break;
                        case ConsoleKey.DownArrow:
                        case ConsoleKey.J:
                            _selectedIndex = Math.Min(options.Length - 1, _selectedIndex + 1);
                            break;
                        case ConsoleKey.Enter:
                        case ConsoleKey.Spacebar:
                            result = options[_selectedIndex];
                            break;
                        case ConsoleKey.Backspace:
                        case ConsoleKey.Escape:
                        case ConsoleKey.Q:
                            cancelled = true;
                            break;
                    }
                }

                await Task.Delay(16); // ~60fps refresh
            }
        });
}
```

---

## Lineage & Archetype Data

### Lineages

| Type | Display Name | Description | Bonuses |
|------|--------------|-------------|---------|
| Human | Human | Adaptable survivors who endure through sheer determination. | +1 to all attributes |
| RuneMarked | Rune-Marked | Descendants bearing ancient runic inscriptions in their skin. | +2 Wits, +2 Will, -1 Sturdiness |
| IronBlooded | Iron-Blooded | Those with machine-integrated bloodlines from the old world. | +2 Sturdiness, +2 Might, -1 Wits |
| VargrKin | Vargr-Kin | Wolf-kin bearing the curse of the northern wastes. | +2 Finesse, +2 Wits, -1 Will |

### Archetypes

| Type | Display Name | Description | Bonuses |
|------|--------------|-------------|---------|
| Warrior | Warrior | Frontline combatant specializing in durability and melee damage. | +2 Sturdiness, +1 Might |
| Skirmisher | Skirmisher | Cunning fighter favoring speed and precision over raw power. | +2 Finesse, +1 Wits |
| Adept | Adept | Runic practitioner channeling ancient power through inscribed formulas. | +2 Wits, +1 Will |
| Mystic | Mystic | Wielder of primal forces, drawing power from the world's corruption. | +2 Will, +1 Sturdiness |

---

## Test Coverage

### WizardServiceTests (33 tests)

| Test Name | Description |
|-----------|-------------|
| `GetPreviewStats_NoSelections_ReturnsBaseStats` | All stats = 5 when nothing selected |
| `GetPreviewStats_EmptyContext_AllAttributesFive` | Verifies all 5 attributes start at 5 |
| `GetPreviewStats_HumanLineage_AddsPlusOneToAll` | Human gives +1 to all attributes |
| `GetPreviewStats_RuneMarkedLineage_AppliesBonuses` | +2 Wits, +2 Will, -1 Sturdiness |
| `GetPreviewStats_IronBloodedLineage_AppliesBonuses` | +2 Sturdiness, +2 Might, -1 Wits |
| `GetPreviewStats_VargrKinLineage_AppliesBonuses` | +2 Finesse, +2 Wits, -1 Will |
| `GetPreviewStats_WarriorArchetype_AppliesBonuses` | +2 Sturdiness, +1 Might |
| `GetPreviewStats_SkirmisherArchetype_AppliesBonuses` | +2 Finesse, +1 Wits |
| `GetPreviewStats_AdeptArchetype_AppliesBonuses` | +2 Wits, +1 Will |
| `GetPreviewStats_MysticArchetype_AppliesBonuses` | +2 Will, +1 Sturdiness |
| `GetPreviewStats_LineageAndArchetype_StackBonuses` | Combines both bonuses correctly |
| `GetPreviewStats_IronBloodedWarrior_MaxSturdiness` | Tests highest possible Sturdiness |
| `GetPreviewStats_PreviewLineage_AppliesWhenContextLineageIsNull` | Preview applied when not confirmed |
| `GetPreviewStats_PreviewLineage_IgnoredWhenContextHasLineage` | Confirmed takes precedence |
| `GetPreviewStats_PreviewArchetype_AppliesWhenContextArchetypeIsNull` | Preview applied when not confirmed |
| `GetPreviewStats_PreviewArchetype_IgnoredWhenContextHasArchetype` | Confirmed takes precedence |
| `GetDerivedStats_CalculatesHPCorrectly` | HP = 50 + Sturdiness * 10 |
| `GetDerivedStats_CalculatesStaminaCorrectly` | Stamina = 20 + Finesse * 5 + Sturdiness * 3 |
| `GetDerivedStats_CalculatesAPCorrectly` | AP = 2 + Wits / 4 |
| `GetDerivedStats_HighStats_CalculatesCorrectly` | Max stats scenario (10s) |
| `GetDerivedStats_LowStats_CalculatesCorrectly` | Min stats scenario (1s) |
| `GetLineageDisplayName_ReturnsCorrectName` | Theory test for all lineages |
| `GetArchetypeDisplayName_ReturnsCorrectName` | Theory test for all archetypes |
| `GetLineageDescription_ReturnsNonEmpty` | All lineages have descriptions |
| `GetArchetypeDescription_ReturnsNonEmpty` | All archetypes have descriptions |
| `GetLineageBonusSummary_ReturnsNonEmpty` | All lineages have bonus summaries |
| `GetArchetypeBonusSummary_ReturnsNonEmpty` | All archetypes have bonus summaries |

---

## Logging Matrix

| Context | Level | Template |
|---------|-------|----------|
| Wizard Start | Info | `"[Wizard] Starting character creation wizard"` |
| Name Entry Cancelled | Info | `"[Wizard] Character creation cancelled at name entry"` |
| Lineage Cancelled | Info | `"[Wizard] Character creation cancelled at lineage selection"` |
| Archetype Cancelled | Info | `"[Wizard] Character creation cancelled at archetype selection"` |
| Step Navigation | Debug | `"[Wizard] Step {StepIndex} - Selection: {Selection}"` |
| Preview Stats | Trace | `"[Wizard] Preview stats: STU:{} MIG:{} WIT:{} WIL:{} FIN:{}"` |
| Character Created | Info | `"[Wizard] Character created: {Name} (ID: {Id})"` |
| Duplicate Name | Warning | `"[Wizard] Duplicate character name attempted: {Name}"` |

---

## User Interface

### Keyboard Controls

| Key | Action |
|-----|--------|
| ↑ / K | Move selection up |
| ↓ / J | Move selection down |
| Enter / Space | Confirm selection |
| Esc / Q / Backspace | Cancel / Go back |

### Split-Screen Layout

```
┌─────────────────────────────────┐┌─────────────────────────────────┐
│ Choose Your Lineage             ││ Preview                         │
│                                 ││ ─────────────────────────────── │
│ ► Human                         ││ STAT PREVIEW                    │
│   Adaptable survivors who...    ││                                 │
│   +1 to all attributes          ││ Lineage: Human                  │
│                                 ││                                 │
│   Rune-Marked                   ││ STU ████████████████ 6          │
│   Descendants bearing...        ││ MIG ████████████████ 6          │
│   +2 Wits, +2 Will, -1 Stur...  ││ WIT ████████████████ 6          │
│                                 ││ WIL ████████████████ 6          │
│   Iron-Blooded                  ││ FIN ████████████████ 6          │
│   Those with machine-integrated ││                                 │
│   +2 Sturdiness, +2 Might, -1...││ Max HP     60                   │
│                                 ││ Stamina    28                   │
│   Vargr-Kin                     ││ Action Pts 2                    │
│   Wolf-kin bearing...           ││                                 │
│   +2 Finesse, +2 Wits, -1 Will  ││                                 │
│─────────────────────────────────││                                 │
│ ↑↓/JK Navigate | Enter/Space... ││                                 │
└─────────────────────────────────┘└─────────────────────────────────┘
```

---

## Dependencies

- `Spectre.Console` - Layout, BarChart, Panel, Rule, Markup for UI rendering
- `Microsoft.Extensions.Logging` - Structured logging
- `RuneAndRust.Core.Interfaces.IStatCalculationService` - Lineage/archetype bonus lookups
- `RuneAndRust.Engine.Factories.CharacterFactory` - CreateSimple() for character creation

---

## Notes

- Name entry uses blocking TextPrompt (no preview needed for name)
- Lineage/Archetype steps use custom input loop with `Console.ReadKey(intercept: true)`
- `AnsiConsole.Live()` enables real-time updates at ~60fps (16ms delay)
- Stats clamped to [1, 10] range via `StatCalculationService.ClampAttribute()`
- BarChart uses abbreviated attribute names: STU, MIG, WIT, WIL, FIN
- Vim-style navigation (J/K) supported in addition to arrow keys
- Version string updated to v0.3.4b in Program.cs boot message
