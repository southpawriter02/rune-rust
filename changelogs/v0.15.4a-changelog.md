# v0.15.4a Changelog - Lockpicking System

## Summary

Implements the **Lockpicking System** as the first subsystem of the System Bypass skill. Enables lockpicking mechanics following cargo cult patterns where characters manipulate incomprehensible mechanisms through pattern recognition. Features 6 lock classification tiers (ImprovisedLatch DC6 to JotunForged DC26), 4 tool quality levels with dice modifiers (-2 to +2), corruption-based DC modifications (+2/+4/+6), critical success salvage components with rarity tiers, and the [Mechanism Jammed] fumble consequence that permanently increases DC by +2 and renders keys useless.

## Added

### Domain Layer - Enums (2 files)

| File | Description |
|------|-------------|
| `LockType.cs` | 6-level enum with DC values: ImprovisedLatch (6), SimpleLock (10), StandardLock (14), ComplexLock (18), MasterLock (22), JotunForged (26). Represents lock classification from makeshift latches to legendary giant-craft. |
| `ItemRarity.cs` | 5-tier enum: Common (x1), Uncommon (x2), Rare (x5), Epic (x10), Legendary (x25). Used for salvageable component value calculation. |

### Domain Layer - Extensions (3 files)

| File | Description |
|------|-------------|
| `LockTypeExtensions.cs` | `GetBaseDc()`, `GetDisplayName()`, `GetDescription()`, `GetDifficultyRating()`, `GetMinimumToolQuality()`, `GetTypicalSalvageRarity()`, `RequiresTools()`, `GetColorHint()`, `GetIconHint()` |
| `ToolQualityExtensions.cs` | `GetDiceModifier()`, `GetDisplayName()`, `GetDescription()`, `CanAttemptLock()`, `CanBreakOnFumble()`, `GetColorHint()`, `GetIconHint()`, `IsAtLeast()`, `ProvidesBonus()`, `IncursPenalty()` |
| `ItemRarityExtensions.cs` | `GetDisplayName()`, `GetDescription()`, `GetValueMultiplier()`, `CalculateValue()`, `GetCraftingBonus()`, `ProvidesCraftingBonus()`, `GetBaseDropRate()`, `GetSelectionWeight()`, `GetDisplayColor()`, `GetColorHint()`, `GetIconHint()`, `GetBorderStyle()`, `IsAtLeast()`, `IsHighValue()`, `IsExceptional()`, `GetTypicalSalvageRarity()` |

### Domain Layer - Value Objects (3 files)

| File | Description |
|------|-------------|
| `SalvageableComponent.cs` | Salvage from locks: ComponentId, Name, Description, Quantity, Rarity, BaseValue, Weight, CraftingTags. Computed: `TotalValue`, `TotalWeight`, `HasCraftingTags`, `Tags`. Methods: `ToDisplayString()`, `ToDetailedString()`, `ToLogString()`, `HasTag()`, `WithQuantity()`. Factory methods: `WireBundle()`, `SmallSpring()`, `HighTensionSpring()`, `PinSet()`, `CircuitFragment()`, `PowerCellFragment()`, `EncryptionChip()`, `BiometricSensor()`, `None` |
| `LockContext.cs` | Sealed class with lock state: LockId, LockType, CorruptionLevel, ToolQuality, PreviousAttempts, IsJammed, LockName. Computed: `BaseDc`, `CorruptionDcModifier`, `JammedDcModifier`, `EffectiveDc`, `ToolDiceModifier`, `RequiresTools`, `HasRequiredTools`, `MinimumToolQuality`, `HasRecommendedTools`, `DisplayName`, `DifficultyRating`. Methods: `WithJammed()`, `WithFailedAttempt()`, `WithToolQuality()`, `ToSkillContext()`, `GetBlockedReason()`, `ToString()`, `ToLogString()`. Factory methods: `Create()`, `CreateCorrupted()` |
| `LockpickingResult.cs` | Attempt outcome: IsSuccess, Outcome, LockContext, SkillCheckResult, SalvagedComponent, FumbleConsequence, UpdatedContext, NarrativeDescription, ToolBroken. Computed: `HasSalvage`, `IsFumble`, `IsCriticalSuccess`, `LockStateChanged`, `FinalContext`, `IsLockJammed`, `NetSuccesses`, `Margin`, `HasConsequences`. Methods: `ToString()`, `ToDetailedString()`, `ToLogString()`, `GetNarrativeTemplate()`. Factory methods: `Success()`, `Failure()`, `Fumble()`, `Blocked()` |

### Domain Layer - Interface (1 file)

| File | Description |
|------|-------------|
| `ILockpickingService.cs` | Service interface: `AttemptLockpick()`, `CanAttempt()`, `GetAttemptBlockedReason()`, `GetPossibleSalvage()`, `SelectRandomSalvage()`, `GetEffectiveDc()`, `GetDiceModifier()`, `EstimateSuccessRate()`, `GetDifficultyDescription()` |

### Application Layer - Interface Update (1 file)

| File | Description |
|------|-------------|
| `IFumbleConsequenceService.cs` | Added overload: `CreateConsequence(characterId, skillId, fumbleType, targetId, description)` - Creates consequence with explicit FumbleType and custom description. Used by lockpicking for [Mechanism Jammed] consequence. |

### Application Layer - Service (2 files)

| File | Description |
|------|-------------|
| `LockpickingService.cs` | Full implementation: Validates prerequisites, builds SkillContext from LockContext, performs skill check via SkillCheckService.PerformCheckWithContext(), processes outcomes (Success/CriticalSuccess/Failure/Fumble), creates [Mechanism Jammed] consequences, selects random salvage on critical success, comprehensive logging throughout |
| `FumbleConsequenceService.cs` | Updated: Added `CreateConsequence(characterId, skillId, fumbleType, targetId, description)` implementation that uses explicit FumbleType and optional custom description |

### Configuration (4 files)

| File | Description |
|------|-------------|
| `config/system-bypass/lock-types.json` | Lock type definitions: 6 lock types with id, name, baseDc, difficultyRating, minimumToolQuality, description, examples, salvageComponents (componentId, weight), flavorText. Corruption modifiers (Normal/Glitched/Blighted/Resonance with dcModifier). Global settings (jammedDcPenalty, toolRequirementThreshold, dice modifiers) |
| `config/system-bypass/lockpicking-tools.json` | Tool definitions: 4 tool qualities with id, name, diceModifier, maxLockDc, canBreakOnFumble, description, examples, flavorText. Salvageable components: 8 components with componentId, name, description, rarity, baseValue, weight, craftingTags, sourceLockTypes. Rarity multipliers |
| `config/schemas/lock-types.schema.json` | JSON Schema for lock-types.json: lockTypeDefinition, salvageEntry, corruptionModifier, globalSettings definitions |
| `config/schemas/lockpicking-tools.schema.json` | JSON Schema for lockpicking-tools.json: toolQualityDefinition, componentDefinition, rarityMultipliers definitions |

### Unit Tests (1 file, 30+ tests)

| File | Tests |
|------|-------|
| `LockpickingSystemTests.cs` | LockType base DC tests (6/10/14/18/22/26), LockType unique DC values, LockType progressive scaling, ToolQuality dice modifiers (-2/0/+1/+2), BareHands lock restrictions, Improvised tool breakage, LockContext effective DC calculation, Corruption DC modifiers (+0/+2/+4/+6), Jammed DC penalty (+2), Corruption+Jammed stacking, Tool requirement validation, LockContext immutable state changes (WithJammed/WithFailedAttempt/WithToolQuality), SalvageableComponent factory methods, Component value scaling with rarity, TotalValue rarity multiplier, ItemRarity value multipliers, Lock-to-rarity mapping, LockpickingResult factory methods, SkillContext conversion |

## Key Features

### Lock Classification

| Lock Type | Base DC | Rating | Min Tools | Salvage Rarity | Description |
|-----------|:-------:|--------|:---------:|:--------------:|-------------|
| Improvised Latch | 6 | Trivial | BareHands | Common | Makeshift latches on shanty dwellings |
| Simple Lock | 10 | Easy | Improvised | Uncommon | Pre-Shattering residential locks |
| Standard Lock | 14 | Moderate | Proper | Uncommon | Commercial building security |
| Complex Lock | 18 | Hard | Proper | Rare | Military/research facility locks |
| Master Lock | 22 | Very Hard | Masterwork | Rare | Dvergr-quality bank vaults |
| Jotun-Forged | 26 | Legendary | Masterwork | Legendary | Ancient giant-craft mechanisms |

### Tool Quality System

| Quality | Dice Modifier | Max Lock DC | Breaks on Fumble | Description |
|---------|:-------------:|:-----------:|:----------------:|-------------|
| Bare Hands | -2d10 | 9 | No | Fingers only, ImprovisedLatch only |
| Improvised | +0 | Any | Yes | Bent wire, hairpins, scrap metal |
| Proper | +1d10 | Any | No | Tinker's Toolkit, quality picks |
| Masterwork | +2d10 | Any | No | Dvergr-crafted, legendary tools |

### Corruption Modifiers

| Corruption Tier | DC Modifier | Description |
|-----------------|:-----------:|-------------|
| Normal | +0 | Lock functions normally |
| Glitched | +2 | Minor corruption causing unpredictable behavior |
| Blighted | +4 | Significant corruption warping mechanism |
| Resonance | +6 | Severe corruption with reality-distorting effects |

### Salvageable Components

| Component | Rarity | Base Value | Source Lock Types |
|-----------|:------:|:----------:|-------------------|
| Wire Bundle | Common | 2 | ImprovisedLatch |
| Small Spring | Common | 3 | ImprovisedLatch |
| High-Tension Spring | Uncommon | 8 | SimpleLock, StandardLock |
| Pin Set | Uncommon | 10 | SimpleLock, StandardLock |
| Circuit Fragment | Rare | 25 | ComplexLock, MasterLock |
| Power Cell Fragment | Rare | 30 | ComplexLock, MasterLock |
| Encryption Chip | Legendary | 100 | JotunForged |
| Biometric Sensor | Legendary | 150 | JotunForged |

### Lockpicking Outcomes

| Outcome | Lock Opens | Consequences | Description |
|---------|:----------:|:------------:|-------------|
| Critical Failure | No | Mechanism Jammed (DC +2), Tools may break | Pick snaps, mechanism grinds |
| Failure | No | None (can retry) | Lock resists, remains closed |
| Marginal Success | Yes | None | Lock yields after extra effort |
| Full Success | Yes | None | Lock opens smoothly |
| Exceptional Success | Yes | None | Lock surrenders immediately |
| Critical Success | Yes | Salvage component | Masterful, extract valuable component |

## Files Changed

### Added (14 files)
- `src/Core/RuneAndRust.Domain/Enums/LockType.cs`
- `src/Core/RuneAndRust.Domain/Enums/ItemRarity.cs`
- `src/Core/RuneAndRust.Domain/Extensions/LockTypeExtensions.cs`
- `src/Core/RuneAndRust.Domain/Extensions/ToolQualityExtensions.cs`
- `src/Core/RuneAndRust.Domain/Extensions/ItemRarityExtensions.cs`
- `src/Core/RuneAndRust.Domain/ValueObjects/SalvageableComponent.cs`
- `src/Core/RuneAndRust.Domain/ValueObjects/LockContext.cs`
- `src/Core/RuneAndRust.Domain/ValueObjects/LockpickingResult.cs`
- `src/Core/RuneAndRust.Domain/Interfaces/ILockpickingService.cs`
- `src/Core/RuneAndRust.Application/Services/LockpickingService.cs`
- `config/system-bypass/lock-types.json`
- `config/system-bypass/lockpicking-tools.json`
- `config/schemas/lock-types.schema.json`
- `config/schemas/lockpicking-tools.schema.json`
- `tests/RuneAndRust.Domain.UnitTests/Services/LockpickingSystemTests.cs`

### Modified (2 files)
- `src/Core/RuneAndRust.Application/Interfaces/IFumbleConsequenceService.cs` - Added CreateConsequence overload
- `src/Core/RuneAndRust.Application/Services/FumbleConsequenceService.cs` - Implemented CreateConsequence overload

## Dependencies

- Existing `ToolQuality.cs` enum (ToolQuality values used)
- `CorruptionTier.cs` enum (for corruption DC modifiers)
- `SkillOutcome.cs` enum (for outcome classification)
- `FumbleType.cs` enum (MechanismJammed value)
- `FumbleConsequence.cs` entity (for fumble tracking)
- `SkillCheckService.cs` (for performing skill checks)
- `IFumbleConsequenceService.cs` (for consequence management)
- `SkillContext.cs` and modifiers (for skill check integration)

## Integration Points

- **SkillCheckService**: Uses `PerformCheckWithContext()` for lockpicking rolls
- **FumbleConsequenceService**: Creates [Mechanism Jammed] on fumble via new overload
- **SkillContext**: LockContext converts to SkillContext with tool/corruption/jammed modifiers
- **FumbleType**: Uses existing `MechanismJammed` enum value

## Notes

- LockType enum values ARE the base DC (e.g., `LockType.StandardLock = 14`)
- LockContext is a sealed class (mutable via With* methods) not a record struct
- Tool quality affects dice pool, corruption and jammed affect DC
- Bare hands can only attempt DC < 10 locks (ImprovisedLatch only)
- Improvised tools break on fumble; proper/masterwork do not
- Critical success on any lock type yields salvage based on lock tier
- [Mechanism Jammed] consequence: DC +2 permanent, key becomes useless
