> **Archived** - This plan has been consolidated. See the complete version at [v0.3.24](../v0.3.x/v0.3.24.md).

Here is the comprehensive implementation plan for v0.3.24a: The Broom (Deprecation Cleanup).
This sub-version is a critical "housekeeping" phase. It physically removes the scaffolding used to build the Alpha (like the hardcoded test dungeon and debug commands) to ensure the Release build is secure, performant, and free of development artifacts.

v0.3.24a: The Broom
Goal: Remove [Obsolete] code paths, delete temporary test assets (specifically GenerateTestMapAsync), and secure debug commands behind conditional compilation directives.
1. Architecture & Data Flow
	•	Static Analysis Strategy: We will use Roslyn analyzers and reflection-based unit tests to enforce architectural purity (e.g., ensuring the Engine layer never writes directly to System.Console).
	•	Debug Stripping: The DebugConsoleService and CheatService (v0.3.17) are powerful tools that ruin the game economy. We will use #if DEBUG preprocessor directives to ensure these classes are physically excluded or disabled in the Release binary.
	•	Legacy Retirement: The hardcoded GenerateTestMapAsync (v0.0.5) [Source 1778, 3060] is replaced entirely by the data-driven GenerateDungeonAsync (v0.3.8) [Source 5551].
Data Flow: The Cleanup Pipeline
	1	Audit: Identify all methods marked [Obsolete].
	2	Refactor: Update any lingering references to use the new implementations.
	3	Delete: Remove the obsolete code.
	4	Verify: Run the full integration test suite to ensure no regressions.

2. Logic Decision Trees
A. Obsolete Member Removal Logic Input: Method M tagged [Obsolete]
	1	Usage Scan: Find All References in Solution.
	◦	Found in Production Code: STOP. Refactor call site to use new API (e.g., replace GenerateTestMapAsync with GenerateDungeonAsync).
	◦	Found in Test Code: Update test to use new API.
	◦	No References: Proceed.
	2	Removal: Delete method signature and body.
	3	Compilation Check: Rebuild solution.
B. Debug Feature Security Logic Input: Application Startup (Program.cs)
	1	Check Build Configuration:
	◦	#if DEBUG: Register IDebugConsoleService and ICheatService. Enable "~" toggle.
	◦	#else: Do not register services. InputHandler ignores "~".
	2	Runtime Check (Cheat Command):
	◦	User types /god.
	◦	Parser attempts to resolve ICheatService.
	◦	Result: Service resolution fails (null or exception). Command ignored/logged as "Unknown".

3. Code Implementation
A. DungeonGenerator Cleanup (Engine Layer) File: RuneAndRust.Engine/Services/DungeonGenerator.cs
public class DungeonGenerator : IDungeonGenerator
{
    // ... Dependencies ...

    // REPLACED: This method is deleted in v0.3.24a
    // [Obsolete("Use GenerateDungeonAsync instead.")]
    // public async Task GenerateTestMapAsync() { ... }

    // KEEP: The data-driven generator from v0.3.8
    public async Task<Guid> GenerateDungeonAsync(string biomeId)
    {
        // ... Implementation ...
    }
}
B. Program.cs Debug Isolation (Terminal Layer) File: RuneAndRust.Terminal/Program.cs
// Register Core Services
services.AddSingleton<IGameService, GameService>();

// Register Debug Tools (v0.3.24a Security)
#if DEBUG
    // Only available in Debug builds
    services.AddSingleton<IDebugConsoleService, DebugConsoleService>();
    services.AddSingleton<ICheatService, CheatService>();
    AnsiConsole.MarkupLine("[yellow]Debug Tools Enabled (~ to toggle)[/]");
#else
    // In Release, these interfaces resolve to null or no-op stubs if strict DI required
    // Ideally, the CommandParser checks for null before accessing.
#endif
C. Architecture Enforcement Test File: RuneAndRust.Tests/Architecture/LayerPolicyTests.cs
[Fact]
public void EngineLayer_ShouldNotReference_SystemConsole()
{
    var engineAssembly = typeof(GameService).Assembly;
    var violations = new List<string>();

    foreach (var type in engineAssembly.GetTypes())
    {
        foreach (var method in type.GetMethods())
        {
            if (method.GetMethodBody()?.LocalVariables
                .Any(v => v.LocalType == typeof(System.Console)) == true)
            {
                violations.Add($"{type.Name}.{method.Name}");
            }
        }
    }

    violations.Should().BeEmpty("The Engine layer must rely on IPresenter, not Console.Write");
}

4. Deliverable Checklist (v0.3.24a)
	•	Cleanup:
	◦	[ ] Delete GenerateTestMapAsync from DungeonGenerator.
	◦	[ ] Delete CreateSimple from CharacterFactory (if fully replaced by CreateWithDistribution).
	◦	[ ] Remove any legacy Console.WriteLine debugging calls in Engine.
	•	Security:
	◦	[ ] Wrap DebugConsoleService registration in #if DEBUG.
	◦	[ ] Wrap CheatService registration in #if DEBUG.
	◦	[ ] Ensure CommandParser handles missing Debug services gracefully (null check).
	•	Configuration:
	◦	[ ] Verify appsettings.json in Release output does not contain cheat flags.

5. Logging Requirements
Reference: logging.md
System
Event
Level
Message Template
Properties
System
Startup
Info
"Rune & Rust {Version} ({Config}) Initialized."
Version, Config (Debug/Release)
Parser
Cheat Attempt
Warn
"Unauthorized cheat attempt: {Command}"
Command

6. Testing Strategy
Unit Tests (ArchitectureTests.cs):
	•	No_Direct_Console_Access: Reflection test scanning RuneAndRust.Engine.dll to ensure System.Console is never invoked directly (enforcing the IPresenter pattern).
	•	No_Obsolete_Usage: Scan codebase for usage of [Obsolete] attributes; assert count is 0.
Integration Tests (ReleaseReadinessTests.cs):
	•	Debug_Commands_Disabled_In_Release:
	◦	Setup: Run test with Release configuration.
	◦	Action: Input ~ or /god.
	◦	Assert: UI does not open; Command returns "Unknown command".
	•	Legacy_Map_Generation:
	◦	Action: Call DungeonGenerator without arguments (if overload removed).
	◦	Assert: Compilation Error (Static check) or MethodNotFound (Runtime).

7. Draft Changelog (v0.3.24a)
# Changelog: v0.3.24a - The Broom

**Release Date:** 2026-03-XX

## Summary
"The Broom" is a technical cleanup update preparing the engine for the Alpha release. It removes deprecated development tools, secures cheat commands, and enforces strict architectural separation between game logic and the terminal UI.

## Changes
- **Deprecation:** Removed `GenerateTestMapAsync`. All dungeons are now procedurally generated via the Dynamic Room Engine.
- **Security:** Debug Console (`~`) and Cheat Commands (`/god`, `/tp`) are now disabled in Release builds.
- **Architecture:** Added automated tests to ensure the Engine layer never accesses `System.Console` directly, preserving compatibility for future GUI ports.
- **Cleanup:** Removed unused assets from the `data/templates/` directory.

## Developer Notes
- If your local build fails, ensure you have updated any calls relying on `GenerateTestMapAsync` to use `GenerateDungeonAsync("the_roots")`.