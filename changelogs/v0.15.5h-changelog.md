# v0.15.5h Changelog - Specialization Integration

## Summary

Implements the **Specialization Integration** system for the Wasteland Survival skill. This subsystem allows characters to specialize in one of three wasteland archetypes, each granting unique passive bonuses and active abilities that enhance Wasteland Survival checks. Features three specializations (Veioimaor, Myr-Stalker, Gantry-Runner), 9 unique abilities total, terrain-based bonuses (+1d10 to +2d10), advantage mechanics for hazard saves, zone markers for persistent bonuses, path-revealing active abilities, and creature analysis through Predator's Eye.

## Added

### Domain Layer - Enums (3 files)

| File | Description |
|------|-------------|
| `WastelandSurvivalSpecializationType.cs` | 4-value enum for character specializations: None (0), Veioimaor (1), MyrStalker (2), GantryRunner (3). Extension methods: `GetDisplayName()`, `GetDescription()`, `GetPrimarySkill()`, `GetAbilityIds()`. Includes `[Description]` attributes for UI display. |
| `WastelandSurvivalCheckType.cs` | 7-value enum for check type categorization: General (0), Tracking (1), Foraging (2), Navigation (3), HazardDetection (4), SignReading (5), Scouting (6). Maps to v0.15.5a-g subsystems. Extension methods: `GetDisplayName()`, `GetDescription()`, `GetSubsystemVersion()`. |
| `TargetType.cs` | 5-value enum for tracking target classification: Unknown (0), LivingCreature (1), Construct (2), Vehicle (3), Group (4). Used for Beast Tracker conditional bonus evaluation. Extension methods: `GetDisplayName()`, `GetDescription()`, `IsTrackable()`, `RequiresSpecialTracking()`. |

### Domain Layer - Value Objects (3 files)

| File | Description |
|------|-------------|
| `SpecializationBonus.cs` | `readonly record struct` for ability bonuses. Properties: AbilityId, BonusDice, Type, Description. Enum `SpecializationBonusType` with values: DicePool (0), Advantage (1), SpecialEffect (2). Computed: AddsDice, GrantsAdvantage, HasSpecialEffect, IsValid. Factory methods: `DiceBonus()`, `Advantage()`, `SpecialEffect()`, `Empty()`. String formatting: `ToDisplayString()`. |
| `AbilityActivation.cs` | `readonly record struct` for active ability results. Properties: AbilityId, Type, EffectDescription, AdditionalData (IReadOnlyDictionary). Enum `AbilityActivationType` with values: PostCheck (0), PathReveal (1), ZoneMarker (2). Computed: IsValid, HasAdditionalData, IsPostCheck, RevealsPath, MarksZone. Factory methods: `PredatorsEye()`, `HuntingGrounds()`, `MireKnowledge()`, `RooftopRoutes()`, `Empty()`. Data access: `GetData()`, `HasData()`. |
| `HuntingGroundsMarker.cs` | `readonly record struct` for zone markers. Properties: PlayerId, AreaId, AreaName, MarkedAt, ExpiresAt. Constants: HuntingGroundsBonusDice (2), AbilityId. Computed: IsActive, IsExpired, IsValid, ActiveDuration, RemainingTime. Methods: `GetBonus()`, `AppliesToArea()`, `BelongsToPlayer()`. Factory methods: `Create()`, `CreateWithDuration()`, `Empty()`. String formatting: `ToDisplayString()`, `ToDetailedString()`. |

### Application Layer - Interface (1 file)

| File | Description |
|------|-------------|
| `ISpecializationBonusService.cs` | Service interface with methods: **Registration**: `GetCharacterSpecialization()`, `RegisterCharacterSpecialization()`, `UnregisterCharacter()`. **Bonus Evaluation**: `GetBonusesForCheck()`, `GetTotalBonusDice()`, `HasAdvantage()`. **Ability Management**: `HasAbility()`, `ActivateAbility()`. **Hunting Grounds**: `GetActiveHuntingGrounds()`, `MarkHuntingGrounds()`, `ClearHuntingGrounds()`. **Terrain Helpers**: `IsSwampTerrain()`, `IsRuinsTerrain()`. Full XML documentation with ability tables and usage examples. |

### Application Layer - Service (1 file)

| File | Description |
|------|-------------|
| `SpecializationBonusService.cs` | Full implementation of ISpecializationBonusService. Dependencies: ILogger. Constants for ability IDs (beast-tracker, predators-eye, hunting-grounds, swamp-navigator, toxin-resistance, mire-knowledge, urban-navigator, rooftop-routes, scrap-familiar) and bonus values (+1d10 to +2d10). In-memory dictionaries: `_characterSpecializations`, `_huntingGrounds`. Static mapping: `SpecializationAbilities`. Helper methods: `EvaluateVeioimaorBonuses()`, `EvaluateMyrStalkerBonuses()`, `EvaluateGantryRunnerBonuses()`. Comprehensive logging at Information, Debug, and Warning levels. |

### Configuration (2 files updated)

| File | Description |
|------|-------------|
| `config/specialization-abilities.json` | Extended with 3 Wasteland Survival specializations alongside existing Acrobatics/Stealth specializations. Each ability includes: id, name, type (passive/active), trigger conditions (checkType, targetType, terrain, hazardType), effect (dice-bonus, advantage, post-check, zone-marker, path-reveal), narrative templates, and ability-specific data (creature weaknesses, behavior patterns, avoids, bypasses). |
| `config/schemas/specialization-abilities.schema.json` | Extended with `triggerCondition` definition supporting: checkType (enum of 7 WS check types), targetType (enum of 5 target types), terrain (array), hazardType (string). Added effect properties: duration, checkTypes, reveals, avoids, pathType, bypasses. Added ability properties: creatureWeaknesses, behaviorPatterns. |

### Unit Tests (1 file, 40+ tests)

| File | Tests |
|------|-------|
| `SpecializationBonusServiceTests.cs` | **Registration tests** (4 tests: GetCharacterSpecialization without/with registration, overwrite, unregister). **Veioimaor tests** (10 tests: Beast Tracker +2d10 with living creature, no bonus without creature/non-tracking; Predator's Eye HasAbility/ActivateAbility/without ability; Hunting Grounds mark/get/clear/bonus in zone/bonus outside zone). **Myr-Stalker tests** (5 tests: Swamp Navigator terrain parameterized; Toxin Resistance advantage for PoisonGas/non-poison/non-Myr-Stalker; Mire Knowledge HasAbility/ActivateAbility). **Gantry-Runner tests** (6 tests: Urban Navigator terrain parameterized; Rooftop Routes HasAbility/ActivateAbility; Scrap Familiar foraging in ruins/outside/non-foraging). **Total Bonus Dice tests** (3 tests: multiple bonuses sum, no bonuses returns 0, stacked Veioimaor bonuses). **Terrain Helper tests** (2 tests: IsRuinsTerrain parameterized, IsSwampTerrain). **Edge Case tests** (5 tests: null/empty character ID, null ability ID, unknown ability, marker replacement). **Value Object tests** (12 tests: SpecializationBonus factory methods/ToDisplayString, HuntingGroundsMarker factory methods/GetBonus/AppliesToArea, AbilityActivation factory methods for all 4 active abilities). |

## Key Features

### Specializations

| Specialization | Primary Focus | Abilities |
|----------------|---------------|-----------|
| Veioimaor (Hunter) | Tracking & hunting | Beast Tracker, Predator's Eye, Hunting Grounds |
| Myr-Stalker | Swamp/marsh survival | Swamp Navigator, Toxin Resistance, Mire Knowledge |
| Gantry-Runner | Urban ruins survival | Urban Navigator, Rooftop Routes, Scrap Familiar |

### Ability Summary

#### Veioimaor (Hunter) Abilities

| Ability | Type | Trigger | Effect |
|---------|------|---------|--------|
| Beast Tracker | Passive | Tracking check + LivingCreature target | +2d10 |
| Predator's Eye | Active | After successful tracking check | Reveal creature weakness & behavior pattern |
| Hunting Grounds | Active | Player marks area | +2d10 all WS checks in zone until rest |

#### Myr-Stalker Abilities

| Ability | Type | Trigger | Effect |
|---------|------|---------|--------|
| Swamp Navigator | Passive | Swamp/Marsh terrain | +1d10 all WS checks |
| Toxin Resistance | Passive | PoisonGas hazard save | Advantage on save |
| Mire Knowledge | Active | Navigating bog/swamp | Reveal safe path avoiding hazards |

#### Gantry-Runner (Wasteland) Abilities

| Ability | Type | Trigger | Effect |
|---------|------|---------|--------|
| Urban Navigator | Passive | ModerateRuins/DenseRuins terrain | +1d10 all WS checks |
| Rooftop Routes | Active | Seeking elevated path in ruins | Reveal elevated route bypassing obstacles |
| Scrap Familiar | Passive | Foraging check + ruins terrain | +1d10 foraging |

### Bonus Stacking

| Scenario | Total Bonus |
|----------|-------------|
| Veioimaor tracking living creature in hunting grounds | +4d10 (Beast Tracker + Hunting Grounds) |
| Gantry-Runner foraging in ruins | +2d10 (Urban Navigator + Scrap Familiar) |
| Myr-Stalker navigating swamp | +1d10 (Swamp Navigator) |
| Myr-Stalker poison gas hazard save | Advantage (Toxin Resistance) |

### Creature Weaknesses (Predator's Eye)

| Weakness | Description |
|----------|-------------|
| fire | Creature is vulnerable to fire damage |
| cold | Creature is vulnerable to cold damage |
| electricity | Creature is vulnerable to electrical damage |
| poison | Creature is vulnerable to poison damage |
| sonic | Creature is vulnerable to sonic damage |
| radiation | Creature is vulnerable to radiation damage |
| psychic | Creature is vulnerable to psychic damage |

### Behavior Patterns (Predator's Eye)

| Pattern | Description |
|---------|-------------|
| aggressive-territorial | Attacks intruders on sight, defends territory |
| pack-hunter | Hunts in groups, coordinates attacks |
| ambush-predator | Waits for prey, strikes from concealment |
| scavenger-opportunist | Avoids direct conflict, targets weak/isolated prey |
| nocturnal-stalker | Active at night, uses darkness for advantage |
| migratory-herd | Travels in groups, follows seasonal patterns |
| solitary-hunter | Hunts alone, territorial but non-aggressive until threatened |

## Files Changed

### Added (12 files)
- `src/Core/RuneAndRust.Domain/Enums/WastelandSurvivalSpecializationType.cs`
- `src/Core/RuneAndRust.Domain/Enums/WastelandSurvivalCheckType.cs`
- `src/Core/RuneAndRust.Domain/Enums/TargetType.cs`
- `src/Core/RuneAndRust.Domain/ValueObjects/SpecializationBonus.cs`
- `src/Core/RuneAndRust.Domain/ValueObjects/AbilityActivation.cs`
- `src/Core/RuneAndRust.Domain/ValueObjects/HuntingGroundsMarker.cs`
- `src/Core/RuneAndRust.Application/Interfaces/ISpecializationBonusService.cs`
- `src/Core/RuneAndRust.Application/Services/SpecializationBonusService.cs`
- `tests/RuneAndRust.Application.UnitTests/Services/SpecializationBonusServiceTests.cs`
- `changelogs/v0.15.5h-changelog.md`

### Modified (2 files)
- `config/specialization-abilities.json` - Added Wasteland Survival specializations (Veioimaor, Myr-Stalker, WS-Gantry-Runner)
- `config/schemas/specialization-abilities.schema.json` - Extended schema with trigger conditions and new effect properties

## Dependencies

- `NavigationTerrainType.cs` - For terrain-based bonus evaluation (ModerateRuins, DenseRuins)
- `HazardType.cs` - For hazard-specific advantage (PoisonGas)
- `ILogger<SpecializationBonusService>` - For comprehensive logging

## Integration Points

- **TrackingService (v0.15.5a)**: Call `GetBonusesForCheck()` with `WastelandSurvivalCheckType.Tracking` and `TargetType`
- **ForagingService (v0.15.5c)**: Call `GetBonusesForCheck()` with `WastelandSurvivalCheckType.Foraging`
- **NavigationService (v0.15.5d)**: Call `GetBonusesForCheck()` with `WastelandSurvivalCheckType.Navigation`
- **HazardDetectionService (v0.15.5e)**: Call `HasAdvantage()` for poison gas hazard saves
- **ScavengerSignService (v0.15.5f)**: Call `GetBonusesForCheck()` with `WastelandSurvivalCheckType.SignReading`
- **ScoutService (v0.15.5g)**: Call `GetBonusesForCheck()` with `WastelandSurvivalCheckType.Scouting`

## Logging Specifications

| Level | Events |
|-------|--------|
| Information | Character specialization registered, ability activated, hunting grounds marked/cleared |
| Debug | Bonus evaluations, condition checks, bonus counts, terrain checks |
| Warning | Invalid ability activations, unregistered character queries, empty character IDs |

### Log Message Templates

```
[Debug] Evaluating bonuses for character {CharacterId} ({Specialization}) - Check: {CheckType}, Terrain: {Terrain}
[Debug] Found {Count} applicable bonuses for character {CharacterId}
[Information] Character {CharacterId} activating ability {AbilityId}
[Information] Character {CharacterId} marked area {AreaId} as hunting grounds
[Information] Character {CharacterId} registered with specialization {Specialization}
[Warning] Character {CharacterId} attempted to activate ability {AbilityId} they don't have
[Debug] Cleared hunting grounds for character {CharacterId}
```

## Notes

- Uses `NavigationTerrainType` for terrain checks (not `TerrainType` which is for combat grids)
- Uses `HazardType.PoisonGas` for toxin resistance (not `ToxicZone` as mentioned in original spec)
- Swamp terrain types (Swamp, Marsh, Bog, Wetland) are defined in configuration but `IsSwampTerrain()` currently returns false until these are added to `NavigationTerrainType`
- Only one hunting grounds marker can be active per character; marking a new area replaces the existing marker
- Hunting grounds markers persist until rest or manual clearing
- Advantage from Toxin Resistance does not stack with other advantage sources (per core advantage rules)
- Dice bonuses from multiple abilities stack additively
- Active abilities (Predator's Eye, Mire Knowledge, Rooftop Routes) return `AbilityActivation` with additional data for game system integration
- This builds upon v0.15.5a-g subsystems and provides foundation for v0.15.5i (Exploration Synergies)
