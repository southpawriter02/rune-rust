# Design Specification: v0.20.1a - Skjaldmær Framework & Tier 1 Abilities

**Version:** v0.20.1a
**Status:** Design Phase
**Last Updated:** 2026-01-28
**Target Tests:** ~10 unit and integration tests
**Specialization:** Skjaldmær (Shield-Maiden)
**Theme:** The Living Shield - Tier 1 Foundation

---

## Table of Contents

1. [Executive Summary](#1-executive-summary)
2. [Feature Overview](#2-feature-overview)
3. [Architecture Diagrams](#3-architecture-diagrams)
4. [User Stories](#4-user-stories)
5. [Domain Layer Specifications](#5-domain-layer-specifications)
6. [Application Layer Specifications](#6-application-layer-specifications)
7. [Infrastructure Layer Configuration](#7-infrastructure-layer-configuration)
8. [Decision Trees and Flow Diagrams](#8-decision-trees-and-flow-diagrams)
9. [Block Charge Resource System](#9-block-charge-resource-system)
10. [Shield Wall Stance Ability](#10-shield-wall-stance-ability)
11. [Intercept Reaction Ability](#11-intercept-reaction-ability)
12. [Bulwark Passive Ability](#12-bulwark-passive-ability)
13. [Code Examples with XML Documentation](#13-code-examples-with-xml-documentation)
14. [Logging Specifications](#14-logging-specifications)
15. [Unit Testing Requirements](#15-unit-testing-requirements)
16. [Integration Testing Requirements](#16-integration-testing-requirements)
17. [Deliverable Checklist](#17-deliverable-checklist)
18. [Acceptance Criteria](#18-acceptance-criteria)
19. [Dependencies](#19-dependencies)
20. [Deferrals and Future Considerations](#20-deferrals-and-future-considerations)

---

## 1. Executive Summary

Version 0.20.1a introduces the **Skjaldmær (Shield-Maiden)** specialization framework and implements the three Tier 1 defensive abilities that form the foundation of the Warrior archetype's Coherent path. This phase establishes:

- **Specialization Registration:** Full integration with v0.17.4 Specialization Framework
- **Block Charge Resource:** A custom resource system managing up to 3 charges for powering defensive abilities
- **Shield Wall Stance:** A defensive posture granting +3 Defense to self and +1 Defense to adjacent allies
- **Intercept Reaction:** A reactive ability redirecting attacks from nearby allies at the cost of 1 Block Charge
- **Bulwark Passive:** A passive ability providing +5 Max HP per Block Charge held

### Phase Objectives

- Establish Skjaldmær specialization within the specialization framework
- Implement Block Charges resource with restoration on rest mechanics
- Create three foundational defensive abilities with clear tactical roles
- Provide infrastructure configuration for ability registration
- Establish unit test coverage baseline (~10 tests)

### Key Deliverables

| Category | Count | Details |
|----------|-------|---------|
| **Domain Value Objects** | 2 | `BlockChargeResource`, `ShieldWallState` |
| **Domain Enums** | 1 | `SkjaldmaerAbilityId` |
| **Application Services** | 2 | `IBlockChargeService`, `ISkjaldmaerAbilityService` |
| **Ability Implementations** | 3 | Shield Wall, Intercept, Bulwark |
| **Configuration Files** | 2 | specializations.json updates, abilities.json updates |
| **Unit Tests** | ~10 | Comprehensive Block Charge and Tier 1 coverage |

### Implementation Status

| Component | Status | Complexity | Est. Effort |
|-----------|--------|-----------|-------------|
| **BlockChargeResource** | Design Phase | Low | 2 hours |
| **ShieldWallState** | Design Phase | Medium | 3 hours |
| **BlockChargeService** | Design Phase | Low | 2 hours |
| **Shield Wall Ability** | Design Phase | Medium | 4 hours |
| **Intercept Ability** | Design Phase | Medium | 4 hours |
| **Bulwark Passive** | Design Phase | Low | 2 hours |
| **Configuration** | Design Phase | Low | 1 hour |
| **Unit Tests** | Design Phase | Medium | 5 hours |

**Total Estimated Effort:** ~23 hours

---

## 2. Feature Overview

### 2.1 Skjaldmær Specialization

**Conceptual Theme:** A disciplined warrior-protector who stands as a living shield against the horrors of a broken world. The Skjaldmær represents order, discipline, and the willingness to absorb punishment meant for others.

**Design Philosophy:**
- Protection First: Abilities prioritize ally survival
- Positional Awareness: Many mechanics reward tactical positioning
- Resource Management: Block Charges create meaningful decisions
- Reactive Combat: Strong reaction-based abilities reward anticipation
- Coherent Path: No Corruption risk — absolute stability

### 2.2 Block Charge Resource

**Conceptual Model:** Block Charges represent the Skjaldmær's momentary defensive readiness, accumulated through rest and discipline. When not actively defending, charges are held in reserve; when used, they power the most potent defensive reactions.

**Characteristics:**
- **Maximum Charges:** 3 (balanced for meaningful decisions without overwhelming complexity)
- **Restoration:** All charges restore on any rest (short or long)
- **Spending:** Costs vary by ability (1 charge for Intercept, 2 for Guardian's Sacrifice)
- **Display:** Visual representation (e.g., "███ 3/3") in combat UI
- **Interaction:** Affects Max HP dynamically through Bulwark passive

### 2.3 Shield Wall Stance

**Conceptual Role:** The cornerstone defensive ability, establishing the Skjaldmær's primary tactical posture. When activated, the shield becomes an extension of the warrior's will, granting enhanced defense to self and nearby allies.

**Key Features:**
- Grants +3 Defense to self (significant but not overwhelming)
- Grants +1 Defense to adjacent allies (area effect incentivizes positioning)
- Persists until explicitly ended or character is incapacitated
- Requires shield equipped (enforces equipment dependency)
- Costs 2 AP to activate (meaningful AP cost, not trivial)

### 2.4 Intercept Reaction

**Conceptual Role:** A reactive ability representing the Skjaldmær's aggressive positioning and protective instincts. When a nearby ally faces danger, the Skjaldmær steps forward to intercept the blow.

**Key Features:**
- Triggered when ally within 2 spaces is targeted by attack
- Costs 1 Block Charge (allows multiple uses per combat)
- Redirects entire attack to self before resolution
- Cannot intercept area-of-effect or self-targeted attacks
- Requires line of sight to defended ally

### 2.5 Bulwark Passive

**Conceptual Role:** A passive representation of defensive discipline, where the Skjaldmær's reserves of tactical readiness translate directly to resilience.

**Key Features:**
- Grants +5 Max HP per Block Charge currently held
- Max bonus: +15 HP (at 3 charges)
- Dynamically adjusts as charges are spent/restored
- Integrates with character HP calculation system
- No activation cost (always active when specialization is active)

---

## 3. Architecture Diagrams

### 3.1 Domain Layer Architecture

```
┌────────────────────────────────────────────────────────────────┐
│              v0.20.1a Skjaldmær Framework                      │
├────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ┌──────────────────────────┐  ┌──────────────────────────┐   │
│  │ BlockChargeResource      │  │ ShieldWallState          │   │
│  │ (Value Object)           │  │ (Value Object)           │   │
│  ├──────────────────────────┤  ├──────────────────────────┤   │
│  │ CurrentCharges: int      │  │ IsActive: bool           │   │
│  │ MaxCharges: int          │  │ DefenseBonus: int        │   │
│  │ LastRestoredAt: DateTime │  │ AllyDefenseBonus: int    │   │
│  │                          │  │ ActivatedAt: DateTime    │   │
│  │ + Spend(amount)          │  │ + GetAffectedAllies()    │   │
│  │ + Restore(amount)        │  │ + IsExpired()            │   │
│  │ + RestoreAll()           │  │ + GetBonusDefense()      │   │
│  │ + GetBulwarkHpBonus()    │  │                          │   │
│  └──────────────────────────┘  └──────────────────────────┘   │
│           │                                    │               │
│           └────────────────┬───────────────────┘               │
│                            │                                   │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │ SkjaldmaerAbilityId (Enum)                              │  │
│  ├──────────────────────────────────────────────────────────┤  │
│  │ • ShieldWall (T1)                                        │  │
│  │ • Intercept (T1)                                         │  │
│  │ • Bulwark (T1)                                           │  │
│  │ • HoldTheLine (T2)                                       │  │
│  │ • CounterShield (T2)                                     │  │
│  │ • Rally (T2)                                             │  │
│  │ • Unbreakable (T3)                                       │  │
│  │ • GuardiansSacrifice (T3)                                │  │
│  │ • TheWallLives (Capstone)                                │  │
│  └──────────────────────────────────────────────────────────┘  │
│                            │                                   │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │ Character (Entity) - Extensions                          │  │
│  ├──────────────────────────────────────────────────────────┤  │
│  │ + BlockCharges: BlockChargeResource?                     │  │
│  │ + ActiveStance: StanceId?                                │  │
│  │ + GetEffectiveDefense(): int                             │  │
│  │ + GetBulwarkBonus(): int                                 │  │
│  └──────────────────────────────────────────────────────────┘  │
│                                                                 │
└────────────────────────────────────────────────────────────────┘

Block Charge Flow:
┌───────────┐         ┌─────────────┐         ┌──────────────┐
│   Rest    │────────►│   Block     │────────►│  Defensive   │
│ (Any)     │ Restore │   Charges   │ Spend   │  Abilities   │
└───────────┘         │  (max 3)    │         │              │
                      └─────────────┘         └──────────────┘
                             │
                             ├─► Bulwark (Max HP +5 each)
                             │
                             ├─► Intercept (cost 1 charge)
                             │
                             └─► Guardian's Sacrifice (cost 2 charges)
```

### 3.2 Application Layer Architecture

```
┌────────────────────────────────────────────────────────────────┐
│           Application Services & Ability Handlers              │
├────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ┌──────────────────────┐  ┌────────────────────────────────┐  │
│  │ IBlockChargeService  │  │ ISkjaldmaerAbilityService      │  │
│  │ Interface            │  │ Interface                       │  │
│  ├──────────────────────┤  ├────────────────────────────────┤  │
│  │ + Spend(chr, amt)    │  │ + ActivateShieldWall(chr)      │  │
│  │ + Restore(chr, amt)  │  │ + EndShieldWall(chr)           │  │
│  │ + RestoreAll(chr)    │  │ + TryIntercept(chr, attacker)  │  │
│  │ + CanSpend(chr, amt) │  │ + ApplyBulwark(chr)            │  │
│  │ + GetCurrentValue()  │  │ + CalculateDefenseBonus(chr)   │  │
│  │ + GetMaxValue()      │  │ + GetAdjacentAllies(chr)       │  │
│  └──────────────────────┘  └────────────────────────────────┘  │
│           │                              │                     │
│           ▼                              ▼                     │
│  ┌──────────────────────┐  ┌────────────────────────────────┐  │
│  │ BlockChargeService   │  │ SkjaldmaerAbilityService       │  │
│  │ Implementation       │  │ Implementation                  │  │
│  └──────────────────────┘  └────────────────────────────────┘  │
│           │                              │                     │
│           └──────────────┬───────────────┘                     │
│                          │                                     │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │ Core Integration Layer                                   │  │
│  ├──────────────────────────────────────────────────────────┤  │
│  │ • Character repository (load/save BlockCharges)         │  │
│  │ • Combat system (Intercept reaction triggers)           │  │
│  │ • Rest system (Block Charge restoration)                │  │
│  │ • Position system (adjacent ally detection)             │  │
│  │ • Defense calculation (Shield Wall integration)          │  │
│  │ • Status effect system (Bulwark integration)            │  │
│  │ • Specialization framework (v0.17.4 compliance)         │  │
│  └──────────────────────────────────────────────────────────┘  │
│                                                                 │
└────────────────────────────────────────────────────────────────┘
```

### 3.3 Configuration Layer Architecture

```
┌────────────────────────────────────────────────────────────────┐
│            Configuration Files & Data Structures               │
├────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ┌──────────────────────────────┐  ┌──────────────────────┐   │
│  │ specializations.json          │  │ abilities.json       │   │
│  │ (Skjaldmær Entry)             │  │ (Tier 1 Abilities)   │   │
│  ├──────────────────────────────┤  ├──────────────────────┤   │
│  │ • specializationId            │  │ • shield-wall        │   │
│  │ • displayName                 │  │ • intercept          │   │
│  │ • parentArchetype: Warrior    │  │ • bulwark            │   │
│  │ • pathType: Coherent          │  │                      │   │
│  │ • specialResource config      │  │ Each with:           │   │
│  │   - block-charges             │  │ • tier              │   │
│  │   - maxValue: 3               │  │ • type              │   │
│  │   - startingValue: 3          │  │ • apCost            │   │
│  │ • abilityTiers[1]             │  │ • effects[]         │   │
│  │   - ppRequirement: 0          │  │ • description       │   │
│  │   - abilityCost: 0            │  │ • requirements[]    │   │
│  │   - abilities[]               │  │                      │   │
│  └──────────────────────────────┘  └──────────────────────┘   │
│           │                               │                   │
│           └───────────────┬───────────────┘                   │
│                           │                                   │
│           ┌───────────────▼───────────────┐                  │
│           │ Configuration Loader          │                  │
│           │ (Dependency Injection)        │                  │
│           └───────────────────────────────┘                  │
│                                                                 │
└────────────────────────────────────────────────────────────────┘
```

---

## 4. User Stories

### 4.1 Character Creation & Specialization Selection

**As a** new player creating a Skjaldmær character
**I want to** select the Skjaldmær specialization from the Warrior archetype
**So that** I can experience the defensive tank gameplay immediately

**Acceptance Criteria:**
- Skjaldmær appears as an option under Warrior archetype selection
- Selection displays specialization tagline "The Living Shield"
- Character initializes with Block Charges: 3/3
- Shield Wall, Intercept, and Bulwark are available as Tier 1 abilities
- Starting Proficiency Points (PP) are set according to specialization design

### 4.2 Block Charge Resource Management

**As a** Skjaldmær player in combat
**I want to** see my Block Charges clearly displayed
**So that** I can make informed decisions about using defensive reactions

**Acceptance Criteria:**
- Status display shows "Block Charges: ███ 3/3" or similar visual
- Charges decrease visibly when Intercept or Guardian's Sacrifice is used
- Charges restore to full after any rest (short or long)
- UI clearly indicates when charges are unavailable

### 4.3 Shield Wall Combat Usage

**As a** Skjaldmær player in combat
**I want to** activate Shield Wall and gain defense bonuses
**So that** I can protect myself and nearby allies

**Acceptance Criteria:**
- Can activate Shield Wall stance with 2 AP
- Self gains +3 Defense immediately upon activation
- Adjacent allies gain +1 Defense while stance is active
- Stance persists until explicitly ended
- Cannot have multiple stances active simultaneously
- Defense bonuses appear in character sheet and combat log

### 4.4 Intercept Reaction Usage

**As a** Skjaldmær player in combat
**I want to** intercept attacks targeting nearby allies
**So that** I can take the damage meant for them

**Acceptance Criteria:**
- Intercept is triggered automatically when ally within 2 spaces is targeted
- Intercepting redirects the attack to self before resolution
- Using Intercept costs exactly 1 Block Charge
- Cannot intercept if Block Charges are depleted
- Attack resolves against Skjaldmær's Defense instead of ally's
- Skjaldmær takes the damage if attack hits

### 4.5 Bulwark Passive Benefit

**As a** Skjaldmær player
**I want to** have additional Max HP based on Block Charges held
**So that** I'm rewarded for holding charges in reserve

**Acceptance Criteria:**
- Max HP increases by 5 for each Block Charge held
- Bonus displays in character sheet (e.g., "Max HP: 45 (+15 from Bulwark)")
- Bonus updates immediately when charges are spent/restored
- Bonus applies correctly: 0 charges = 0 bonus, 1 charge = +5, 2 charges = +10, 3 charges = +15

---

## 5. Domain Layer Specifications

### 5.1 BlockChargeResource Value Object

**Purpose:** Encapsulates the Block Charge resource for Skjaldmær specialization, managing current/max charges and providing methods for spending and restoration.

**Immutability Model:** Record type with init-only properties (C# records), ensuring thread-safe value equality.

**Detailed Specification:**

```csharp
/// <summary>
/// Represents the special Block Charge resource for Skjaldmær specialization.
/// Block Charges power defensive reactions and modify Max HP through Bulwark.
/// Immutable value object following domain-driven design principles.
/// </summary>
public sealed record BlockChargeResource
{
    /// <summary>
    /// Current number of Block Charges (0-3).
    /// Represents available defensive reactions ready to be executed.
    /// </summary>
    public int CurrentCharges { get; private set; }

    /// <summary>
    /// Maximum Block Charges (default 3).
    /// Defines the hard limit for charge accumulation.
    /// This value rarely changes; typically 3 for all Skjaldmær characters.
    /// </summary>
    public int MaxCharges { get; init; } = 3;

    /// <summary>
    /// Timestamp when charges were last restored to maximum.
    /// Used for UI display and audit trails.
    /// </summary>
    public DateTime? LastRestoredAt { get; private set; }

    /// <summary>
    /// Attempts to spend the specified number of Block Charges.
    /// </summary>
    /// <param name="amount">Number of charges to spend (must be positive)</param>
    /// <returns>
    /// True if the specified amount was available and successfully spent;
    /// False if insufficient charges were available (no partial spend).
    /// </returns>
    /// <remarks>
    /// Spending is atomic — if not enough charges are available,
    /// CurrentCharges remains unchanged and False is returned.
    /// This prevents accidental partial consumption of charges.
    /// </remarks>
    public bool Spend(int amount)
    {
        if (amount <= 0 || CurrentCharges < amount)
            return false;

        CurrentCharges -= amount;
        return true;
    }

    /// <summary>
    /// Restores the specified number of Block Charges toward maximum.
    /// </summary>
    /// <param name="amount">Number of charges to restore (must be positive)</param>
    /// <remarks>
    /// Restoration is capped at MaxCharges; excess is lost.
    /// For example, if CurrentCharges is 2 and amount is 3, result is 3 (not 5).
    /// Updates LastRestoredAt timestamp.
    /// </remarks>
    public void Restore(int amount)
    {
        if (amount <= 0)
            return;

        CurrentCharges = Math.Min(CurrentCharges + amount, MaxCharges);
        LastRestoredAt = DateTime.UtcNow;
    }

    /// <summary>
    /// Fully restores all Block Charges to maximum.
    /// </summary>
    /// <remarks>
    /// This is the standard behavior when resting (short or long rest).
    /// Updates LastRestoredAt timestamp.
    /// </remarks>
    public void RestoreAll()
    {
        CurrentCharges = MaxCharges;
        LastRestoredAt = DateTime.UtcNow;
    }

    /// <summary>
    /// Calculates the Max HP bonus provided by Bulwark passive ability.
    /// </summary>
    /// <returns>
    /// HP bonus equal to CurrentCharges * 5.
    /// Range: 0 (no charges) to 15 (3 charges).
    /// </returns>
    /// <remarks>
    /// This method is called by the character HP calculation system
    /// whenever defensive calculations are performed.
    /// See Bulwark ability specification for details.
    /// </remarks>
    public int GetBulwarkHpBonus() => CurrentCharges * 5;

    /// <summary>
    /// Determines if this resource has changed since creation.
    /// </summary>
    /// <returns>True if current state differs from initial full-charge state.</returns>
    public bool IsModified() => CurrentCharges != MaxCharges;
}
```

**Equality and Hashing:**
- Record type provides structural equality by default
- Two BlockChargeResource instances are equal if CurrentCharges and MaxCharges match
- LastRestoredAt is NOT considered in equality (timestamp variance)
- Suitable for use in collections and equality assertions

**Validation Rules:**
- CurrentCharges must always be >= 0 and <= MaxCharges
- MaxCharges should be 3 (design decision, not enforced in code)
- Spend amount must be positive; zero or negative amounts are rejected
- Restore amount can be zero (no-op) or positive; negative amounts are rejected

### 5.2 ShieldWallState Value Object

**Purpose:** Encapsulates the state of an active Shield Wall stance, managing defense bonuses and affected allies.

```csharp
/// <summary>
/// Represents the state of an active Shield Wall stance.
/// Tracks defense bonuses for self and adjacent allies.
/// Immutable value object managed by stances/buffs system.
/// </summary>
public sealed record ShieldWallState
{
    /// <summary>
    /// Whether Shield Wall is currently active for this character.
    /// </summary>
    public bool IsActive { get; private set; }

    /// <summary>
    /// Defense bonus granted to the Skjaldmær while stance is active (+3).
    /// </summary>
    public int DefenseBonus { get; init; } = 3;

    /// <summary>
    /// Defense bonus granted to each adjacent ally (+1).
    /// </summary>
    public int AllyDefenseBonus { get; init; } = 1;

    /// <summary>
    /// Position of the Skjaldmær when stance was activated.
    /// Used to calculate adjacent ally positions for bonus application.
    /// </summary>
    public Position ActivatedPosition { get; init; }

    /// <summary>
    /// UTC timestamp when the stance was activated.
    /// Used for UI display and duration calculations.
    /// </summary>
    public DateTime ActivatedAt { get; private set; }

    /// <summary>
    /// Retrieves the list of character IDs for all adjacent allies
    /// who should receive the Alliance defense bonus.
    /// </summary>
    /// <param name="allies">All allied characters in the combat area</param>
    /// <param name="characterPosition">Current position of the Skjaldmær</param>
    /// <returns>
    /// Ordered list of character IDs for all allies within 1 space
    /// (including diagonals, standard 8-directional adjacency).
    /// </returns>
    /// <remarks>
    /// "Adjacent" is defined as within 1 space in any direction (8-directional).
    /// This includes diagonal positions.
    /// If Skjaldmær moves, affected allies change; recalculate on each position change.
    /// </remarks>
    public IReadOnlyList<Guid> GetAffectedAllies(IReadOnlyList<Character> allies, Position characterPosition)
    {
        if (!IsActive)
            return Array.Empty<Guid>();

        return allies
            .Where(ally => ally.Id != characterPosition.OwnerId &&
                          characterPosition.IsAdjacentTo(ally.Position))
            .Select(ally => ally.Id)
            .ToList();
    }

    /// <summary>
    /// Determines if the stance has expired or been dispelled.
    /// </summary>
    public bool IsExpired() => !IsActive;

    /// <summary>
    /// Activates the Shield Wall stance.
    /// </summary>
    /// <remarks>
    /// Called when Skjaldmær invokes the Shield Wall ability.
    /// </remarks>
    public void Activate()
    {
        IsActive = true;
        ActivatedAt = DateTime.UtcNow;
    }

    /// <summary>
    /// Deactivates the Shield Wall stance.
    /// </summary>
    /// <remarks>
    /// Called when Skjaldmær ends the stance or becomes incapacitated.
    /// </remarks>
    public void Deactivate()
    {
        IsActive = false;
    }

    /// <summary>
    /// Calculates total Defense bonus for Skjaldmær while stance is active.
    /// </summary>
    public int GetBonusDefense() => IsActive ? DefenseBonus : 0;

    /// <summary>
    /// Calculates Defense bonus for a specific ally if adjacent.
    /// </summary>
    /// <param name="allyId">The ID of the ally to check</param>
    /// <param name="affectedAllies">List of affected allies from GetAffectedAllies()</param>
    /// <returns>Defense bonus (+1) if ally is affected, 0 otherwise</returns>
    public int GetAllyBonus(Guid allyId, IReadOnlyList<Guid> affectedAllies)
    {
        return affectedAllies.Contains(allyId) ? AllyDefenseBonus : 0;
    }
}
```

### 5.3 SkjaldmaerAbilityId Enum

**Purpose:** Strongly-typed enum for all Skjaldmær abilities, used throughout the system to reference specific abilities.

```csharp
/// <summary>
/// Enumeration of all Skjaldmær specialization abilities.
/// Used for type-safe ability identification and routing.
/// </summary>
public enum SkjaldmaerAbilityId
{
    /// <summary>Tier 1 - Defensive stance granting +3 Defense to self and +1 to adjacent allies.</summary>
    ShieldWall = 1,

    /// <summary>Tier 1 - Reaction ability redirecting nearby ally attacks to self.</summary>
    Intercept = 2,

    /// <summary>Tier 1 - Passive ability granting +5 Max HP per Block Charge held.</summary>
    Bulwark = 3,

    /// <summary>Tier 2 - Active ability preventing enemies from moving through character's space.</summary>
    HoldTheLine = 4,

    /// <summary>Tier 2 - Reaction ability dealing damage on successful block.</summary>
    CounterShield = 5,

    /// <summary>Tier 2 - Active ability granting +2 save bonus to nearby allies.</summary>
    Rally = 6,

    /// <summary>Tier 3 - Passive ability reducing all damage taken by 3.</summary>
    Unbreakable = 7,

    /// <summary>Tier 3 - Reaction ability absorbing all damage from ally attacks (2 charges).</summary>
    GuardiansSacrifice = 8,

    /// <summary>Capstone - Ultimate ability preventing HP from dropping below 1 for 3 turns.</summary>
    TheWallLives = 9
}
```

### 5.4 Character Entity Extensions

**Modifications to existing Character entity:**

```csharp
public partial class Character : Entity
{
    /// <summary>
    /// Block Charge resource for Skjaldmær specialization (null for non-Skjaldmær).
    /// </summary>
    public BlockChargeResource? BlockCharges { get; set; }

    /// <summary>
    /// Currently active stance identifier (Shield Wall, etc.).
    /// Only one stance can be active at a time.
    /// </summary>
    public StanceId? ActiveStance { get; set; }

    /// <summary>
    /// Current state of Shield Wall if active.
    /// </summary>
    public ShieldWallState? ShieldWallState { get; set; }

    /// <summary>
    /// Gets effective Defense value including all modifiers.
    /// Integrates Shield Wall stance bonus.
    /// </summary>
    public int GetEffectiveDefense()
    {
        int baseDefense = Defense;
        if (ShieldWallState?.IsActive == true)
            baseDefense += ShieldWallState.DefenseBonus;
        return baseDefense;
    }

    /// <summary>
    /// Gets HP bonus from Bulwark passive ability.
    /// </summary>
    public int GetBulwarkBonus()
    {
        if (Specialization != SpecializationId.Skjaldmaer || BlockCharges == null)
            return 0;

        return BlockCharges.GetBulwarkHpBonus();
    }
}
```

---

## 6. Application Layer Specifications

### 6.1 IBlockChargeService Interface

**Purpose:** Defines contract for Block Charge management, including spending, restoration, and validation.

```csharp
/// <summary>
/// Service interface for managing Block Charges resource.
/// Provides operations for spending, restoring, and validating charges.
/// </summary>
public interface IBlockChargeService
{
    /// <summary>
    /// Attempts to spend Block Charges from a character.
    /// </summary>
    /// <param name="character">The character spending charges</param>
    /// <param name="amount">Number of charges to spend (must be positive)</param>
    /// <returns>
    /// True if charges were spent successfully;
    /// False if insufficient charges or character is not Skjaldmær.
    /// </returns>
    /// <remarks>
    /// Logs spending action for audit trail.
    /// This is the authoritative method for consuming charges in abilities.
    /// </remarks>
    Task<bool> SpendChargesAsync(Character character, int amount);

    /// <summary>
    /// Restores Block Charges to a character.
    /// </summary>
    /// <param name="character">The character receiving charges</param>
    /// <param name="amount">Number of charges to restore</param>
    /// <returns>New current charge count after restoration</returns>
    /// <remarks>
    /// Logs restoration action for audit trail.
    /// Respects MaxCharges cap; excess restoration is lost.
    /// </remarks>
    Task<int> RestoreChargesAsync(Character character, int amount);

    /// <summary>
    /// Fully restores Block Charges to maximum (typically after rest).
    /// </summary>
    /// <param name="character">The character to restore</param>
    /// <returns>Confirmation of full restoration (should always be MaxCharges)</returns>
    /// <remarks>
    /// This is the standard behavior for rest mechanics.
    /// Called by rest system after short/long rest completion.
    /// </remarks>
    Task<int> RestoreAllChargesAsync(Character character);

    /// <summary>
    /// Checks if a character can spend the specified number of charges.
    /// </summary>
    /// <param name="character">The character to check</param>
    /// <param name="amount">Number of charges required</param>
    /// <returns>
    /// True if character has sufficient charges or is not Skjaldmær;
    /// False if character has insufficient charges.
    /// </returns>
    /// <remarks>
    /// Non-destructive check; does not modify character state.
    /// Used by ability handlers to validate preconditions.
    /// </remarks>
    bool CanSpend(Character character, int amount);

    /// <summary>
    /// Gets the current Block Charge count for a character.
    /// </summary>
    /// <param name="character">The character to query</param>
    /// <returns>Current charges (0-3) or -1 if not Skjaldmær</returns>
    int GetCurrentValue(Character character);

    /// <summary>
    /// Gets the maximum Block Charge count for a character.
    /// </summary>
    /// <param name="character">The character to query</param>
    /// <returns>Maximum charges (typically 3) or -1 if not Skjaldmær</returns>
    int GetMaxValue(Character character);
}
```

### 6.2 BlockChargeService Implementation

**Purpose:** Concrete implementation of IBlockChargeService with logging and validation.

```csharp
/// <summary>
/// Standard implementation of IBlockChargeService.
/// Manages Block Charge operations with comprehensive logging.
/// </summary>
public class BlockChargeService : IBlockChargeService
{
    private readonly ICharacterRepository _characterRepository;
    private readonly ILogger<BlockChargeService> _logger;

    public BlockChargeService(
        ICharacterRepository characterRepository,
        ILogger<BlockChargeService> logger)
    {
        _characterRepository = characterRepository;
        _logger = logger;
    }

    /// <inheritdoc/>
    public async Task<bool> SpendChargesAsync(Character character, int amount)
    {
        if (character.BlockCharges == null)
            return false;

        if (!character.BlockCharges.Spend(amount))
        {
            _logger.LogWarning(
                "Block Charge spend failed for character {CharacterId}: " +
                "Attempted to spend {Amount} but only {Current} available",
                character.Id, amount, character.BlockCharges.CurrentCharges);
            return false;
        }

        await _characterRepository.UpdateAsync(character);

        _logger.LogInformation(
            "Block Charges spent: Character {CharacterId} spent {Amount} charges, " +
            "{Remaining} remaining",
            character.Id, amount, character.BlockCharges.CurrentCharges);

        return true;
    }

    /// <inheritdoc/>
    public async Task<int> RestoreChargesAsync(Character character, int amount)
    {
        if (character.BlockCharges == null)
            return -1;

        character.BlockCharges.Restore(amount);
        await _characterRepository.UpdateAsync(character);

        _logger.LogInformation(
            "Block Charges restored: Character {CharacterId} restored {Amount} charges, " +
            "now {Current}/{Max}",
            character.Id, amount, character.BlockCharges.CurrentCharges,
            character.BlockCharges.MaxCharges);

        return character.BlockCharges.CurrentCharges;
    }

    /// <inheritdoc/>
    public async Task<int> RestoreAllChargesAsync(Character character)
    {
        if (character.BlockCharges == null)
            return -1;

        character.BlockCharges.RestoreAll();
        await _characterRepository.UpdateAsync(character);

        _logger.LogInformation(
            "Block Charges fully restored: Character {CharacterId} restored to {Max}",
            character.Id, character.BlockCharges.MaxCharges);

        return character.BlockCharges.MaxCharges;
    }

    /// <inheritdoc/>
    public bool CanSpend(Character character, int amount)
    {
        if (character.BlockCharges == null)
            return true; // Non-Skjaldmær can't fail on charge check

        return character.BlockCharges.CurrentCharges >= amount;
    }

    /// <inheritdoc/>
    public int GetCurrentValue(Character character)
    {
        return character.BlockCharges?.CurrentCharges ?? -1;
    }

    /// <inheritdoc/>
    public int GetMaxValue(Character character)
    {
        return character.BlockCharges?.MaxCharges ?? -1;
    }
}
```

### 6.3 ISkjaldmaerAbilityService Interface

**Purpose:** Defines contract for Skjaldmær-specific ability operations.

```csharp
/// <summary>
/// Service interface for Skjaldmær ability operations.
/// Provides methods for activating stances and calculating bonuses.
/// </summary>
public interface ISkjaldmaerAbilityService
{
    /// <summary>
    /// Activates Shield Wall stance for a character.
    /// </summary>
    /// <param name="character">The character activating the stance</param>
    /// <param name="apCost">AP cost for activation (typically 2)</param>
    /// <returns>True if stance was activated successfully</returns>
    /// <remarks>
    /// Validates shield equipment requirement.
    /// Ends any existing stances (mutual exclusivity).
    /// Deducts AP cost from character.
    /// </remarks>
    Task<bool> ActivateShieldWallAsync(Character character, int apCost);

    /// <summary>
    /// Ends the active Shield Wall stance.
    /// </summary>
    /// <param name="character">The character ending the stance</param>
    /// <returns>True if stance was ended successfully</returns>
    Task<bool> EndShieldWallAsync(Character character);

    /// <summary>
    /// Attempts to execute Intercept reaction.
    /// </summary>
    /// <param name="character">The Skjaldmær performing Intercept</param>
    /// <param name="defendedAlly">The ally whose attack is being intercepted</param>
    /// <param name="attacker">The character performing the redirected attack</param>
    /// <returns>True if intercept was successful</returns>
    /// <remarks>
    /// Validates range, line of sight, and charge availability.
    /// Spends 1 Block Charge.
    /// Redirects attack to character instead of ally.
    /// </remarks>
    Task<bool> TryInterceptAsync(Character character, Character defendedAlly, Character attacker);

    /// <summary>
    /// Applies Bulwark passive bonuses to character.
    /// </summary>
    /// <param name="character">The character to apply bonuses to</param>
    /// <remarks>
    /// Called whenever character HP calculations are performed.
    /// Integrates Block Charges into Max HP calculation.
    /// </remarks>
    void ApplyBulwark(Character character);

    /// <summary>
    /// Calculates Shield Wall defense bonus for a character.
    /// </summary>
    /// <param name="character">The character to calculate bonus for</param>
    /// <returns>Defense bonus (+3 if active, 0 otherwise)</returns>
    int CalculateDefenseBonus(Character character);

    /// <summary>
    /// Gets all characters adjacent to a specific character.
    /// </summary>
    /// <param name="character">The reference character</param>
    /// <param name="allCharacters">All characters in the area</param>
    /// <returns>List of adjacent character IDs</returns>
    IReadOnlyList<Guid> GetAdjacentAllies(Character character, IReadOnlyList<Character> allCharacters);
}
```

---

## 7. Infrastructure Layer Configuration

### 7.1 specializations.json Entry

**Location:** `/data/specializations.json`

**Skjaldmær Entry Schema:**

```json
{
    "specializations": [
        {
            "specializationId": "Skjaldmaer",
            "displayName": "Skjaldmær",
            "tagline": "The Living Shield",
            "description": "The Skjaldmær stands between allies and danger, absorbing blows that would fell lesser warriors. Their shield is not just a tool—it is an extension of their will. Through discipline and tactical positioning, the Skjaldmær becomes an unshakeable bulwark against the horrors of a broken world.",
            "selectionText": "None shall fall while I stand. Your shield is the last line between the horror and the innocent.",
            "parentArchetype": "Warrior",
            "pathType": "Coherent",
            "specialResource": {
                "resourceId": "block-charges",
                "resourceName": "Block Charges",
                "description": "Consumable charges for powerful defensive abilities. Restored fully on any rest.",
                "maxValue": 3,
                "startingValue": 3,
                "generationMethod": "RestoreAllOnRest",
                "consumptionMethod": "Spent by Intercept (1 charge) and Guardian's Sacrifice (2 charges)",
                "displayFormat": "Numeric",
                "visualRepresentation": "BlockIcon",
                "recoveryBehavior": "FullRestoration"
            },
            "unlockCost": 0,
            "prerequisites": {
                "archetypeId": "Warrior",
                "minimumLevel": 1
            },
            "abilityTiers": [
                {
                    "tier": 1,
                    "displayName": "Foundation",
                    "ppRequirement": 0,
                    "abilityCost": 0,
                    "abilities": [
                        "shield-wall",
                        "intercept",
                        "bulwark"
                    ]
                },
                {
                    "tier": 2,
                    "displayName": "Discipline",
                    "ppRequirement": 8,
                    "abilityCost": 4,
                    "abilities": [
                        "hold-the-line",
                        "counter-shield",
                        "rally"
                    ]
                },
                {
                    "tier": 3,
                    "displayName": "Mastery",
                    "ppRequirement": 16,
                    "abilityCost": 5,
                    "abilities": [
                        "unbreakable",
                        "guardians-sacrifice"
                    ]
                },
                {
                    "tier": "capstone",
                    "displayName": "The Wall",
                    "ppRequirement": 24,
                    "abilityCost": 6,
                    "abilities": [
                        "the-wall-lives"
                    ]
                }
            ]
        }
    ]
}
```

### 7.2 abilities.json Entries (Tier 1)

**Location:** `/data/abilities.json` - Skjaldmær section

```json
{
    "abilities": [
        {
            "abilityId": "shield-wall",
            "displayName": "Shield Wall",
            "specialization": "Skjaldmaer",
            "tier": 1,
            "type": "Stance",
            "apCost": 2,
            "duration": null,
            "durationUnit": "Stance",
            "cooldown": 0,
            "cooldownUnit": "Turns",
            "range": 0,
            "rangeType": "Self",
            "targetType": "Self",
            "targetCount": 1,
            "description": "Enter a defensive stance, gaining +3 Defense. Adjacent allies gain +1 Defense while this stance is active.",
            "flavorText": "You plant your feet and raise your shield, becoming a bastion of protection.",
            "requirements": {
                "equippedItemType": "Shield",
                "armor": "Any"
            },
            "effects": [
                {
                    "effectId": "shield-wall-defense",
                    "type": "DefenseModifier",
                    "target": "Self",
                    "modifier": 3,
                    "stacking": "Replace"
                },
                {
                    "effectId": "shield-wall-ally-aura",
                    "type": "AuraModifier",
                    "target": "AdjacentAllies",
                    "range": 1,
                    "modifier": 1,
                    "modifierType": "Defense",
                    "stacking": "Stack"
                }
            ],
            "keywords": [
                "Stance",
                "Defense",
                "Aura",
                "Protection"
            ],
            "tags": [
                "v0.20.1a"
            ]
        },
        {
            "abilityId": "intercept",
            "displayName": "Intercept",
            "specialization": "Skjaldmaer",
            "tier": 1,
            "type": "Reaction",
            "apCost": 0,
            "resourceCost": {
                "resourceId": "block-charges",
                "amount": 1
            },
            "trigger": {
                "event": "AllyTargetedByAttack",
                "range": 2,
                "requiresLineOfSight": true
            },
            "description": "When an ally within 2 spaces is targeted by an attack, spend 1 Block Charge to redirect the attack to yourself.",
            "flavorText": "You dart forward, your shield suddenly blocking the deadly blow meant for your ally.",
            "requirements": {
                "targetRange": 2,
                "targetType": "Ally",
                "blockChargesRequired": 1
            },
            "effects": [
                {
                    "effectId": "intercept-redirect",
                    "type": "RedirectAttack",
                    "source": "TriggeredAttack",
                    "newTarget": "Self",
                    "timing": "BeforeResolution"
                }
            ],
            "restrictions": [
                "CannotInterceptAreaOfEffect",
                "CannotInterceptSelfTargeted",
                "CannotInterceptIfTargetIsSelf"
            ],
            "keywords": [
                "Reaction",
                "Protective",
                "ResourceCost",
                "Redirect"
            ],
            "tags": [
                "v0.20.1a"
            ]
        },
        {
            "abilityId": "bulwark",
            "displayName": "Bulwark",
            "specialization": "Skjaldmaer",
            "tier": 1,
            "type": "Passive",
            "apCost": 0,
            "description": "Gain +5 maximum HP for each Block Charge you currently hold.",
            "flavorText": "Your reserves of defensive readiness translate into sheer physical resilience.",
            "effects": [
                {
                    "effectId": "bulwark-max-hp",
                    "type": "MaxHpModifier",
                    "formula": "BlockCharges * 5",
                    "min": 0,
                    "max": 15,
                    "scaling": "Linear"
                }
            ],
            "keywords": [
                "Passive",
                "Defensive",
                "Resource-Dependent",
                "Scaling"
            ],
            "tags": [
                "v0.20.1a"
            ]
        }
    ]
}
```

---

## 8. Decision Trees and Flow Diagrams

### 8.1 Shield Wall Activation Flow

```
┌─────────────────────────────────────────┐
│ Shield Wall Ability Activated            │
│ (2 AP, Stance)                          │
└──────────────────┬──────────────────────┘
                   │
        ┌──────────▼──────────┐
        │ Has Shield Equipped? │
        └──────┬──────────────┘
               │
         ┌─────┴──────┐
    Yes  │            │  No
         │            └────────────────────┐
         │                                 │
    ┌────▼─────┐                      ┌────▼──────┐
    │ Can Spend │                      │   Fail    │
    │  2 AP?    │                      │  (Output  │
    └────┬──────┘                      │  message) │
         │                             └───────────┘
    ┌────┴─────┐
 No │           │ Yes
    │           │
┌───▼──┐   ┌────▼──────────────────┐
│ Fail │   │ End Active Stance     │
└──────┘   │ (if any)              │
           └────┬───────────────────┘
                │
           ┌────▼──────────────────┐
           │ Spend 2 AP from Pool  │
           └────┬───────────────────┘
                │
           ┌────▼──────────────────┐
           │ Activate Shield Wall  │
           │ • Grant +3 Defense    │
           │ • Calculate adjacent  │
           │   allies             │
           │ • Apply +1 Defense   │
           └────┬───────────────────┘
                │
           ┌────▼──────────────────┐
           │ Log Action            │
           │ Update Character      │
           │ Return Success        │
           └───────────────────────┘
```

### 8.2 Intercept Reaction Flow

```
┌──────────────────────────────────┐
│ Attack Targeting Ally Detected    │
│ (Pre-resolution hook)            │
└──────────┬───────────────────────┘
           │
    ┌──────▼──────────┐
    │ Find Skjaldmær  │
    │ in Range (2sp)  │
    └──────┬──────────┘
           │
    ┌──────▼──────────────────┐
    │ Has Line of Sight to    │
    │ Ally?                   │
    └──────┬──────────────────┘
           │
      ┌────┴─────┐
   No │           │ Yes
      │           │
      │      ┌────▼─────────┐
      │      │ Has Block    │
      │      │ Charges >= 1?│
      │      └──┬───────────┘
      │         │
      │    ┌────┴─────┐
      │ No │          │ Yes
      │    │          │
      │    │      ┌───▼──────────────┐
      │    │      │ Spend 1 Charge   │
      │    │      └────┬─────────────┘
      │    │           │
      │    │      ┌────▼──────────────┐
      │    │      │ Redirect Attack   │
      │    │      │ to Skjaldmær      │
      │    │      └────┬─────────────┘
      │    │           │
      └────┼───────────┼──────────────┐
           │           │              │
      ┌────▼──────┐    │         ┌────▼──────┐
      │ Continue  │    │         │   Resolve │
      │ Normal    │    │         │  Attack   │
      │ Attack    │    │         │ vs Skjald │
      │ Resolution│    │         │ Defense   │
      └───────────┘    │         └───────────┘
                  ┌────▼──────┐
                  │ Skjaldmær │
                  │  Takes     │
                  │  Damage    │
                  │ (if hit)   │
                  └────────────┘
```

### 8.3 Bulwark HP Calculation

```
┌──────────────────────┐
│ Character HP Updated │
└──────────┬───────────┘
           │
    ┌──────▼──────────────┐
    │ Is Skjaldmær with   │
    │ Block Charges?      │
    └──────┬──────────────┘
           │
      ┌────┴─────┐
   No │           │ Yes
      │           │
 ┌────▼──┐   ┌────▼──────────────┐
 │ Base  │   │ Get Block Charge  │
 │ Max HP│   │ Current Count     │
 └───────┘   └────┬──────────────┘
                  │
             ┌────▼──────────────┐
             │ Calculate Bonus   │
             │ Bonus = Count * 5 │
             │ Max: 15           │
             └────┬──────────────┘
                  │
             ┌────▼──────────────┐
             │ Max HP = Base +   │
             │ Bonus             │
             └────┬──────────────┘
                  │
         ┌────────▼─────────┐
         │ If Current HP    │
         │ > New Max HP     │
         └────┬─────────────┘
              │
         ┌────▼──────────────┐
         │ Reduce Current HP │
         │ to New Max        │
         └────────────────────┘
```

---

## 9. Block Charge Resource System

### 9.1 Resource Lifecycle

**Initialization (Character Creation):**
1. Character created with Skjaldmær specialization
2. BlockCharges initialized to `new BlockChargeResource { CurrentCharges = 3, MaxCharges = 3 }`
3. LastRestoredAt set to creation timestamp
4. Persisted to database

**During Combat:**
1. Character begins combat with all charges available (3/3)
2. Intercept ability may consume 1 charge
3. Guardian's Sacrifice ability may consume 2 charges
4. Charges persist across multiple turns

**Post-Combat / Rest:**
1. Character completes rest (short or long)
2. Rest system calls `RestoreAllChargesAsync` on all Skjaldmær characters
3. BlockCharges.CurrentCharges set to MaxCharges
4. LastRestoredAt timestamp updated
5. Changes persisted to database

### 9.2 Resource Validation Rules

| Rule | Enforcement | Impact |
|------|-------------|--------|
| CurrentCharges >= 0 | Spend() rejects negative results | Cannot over-spend |
| CurrentCharges <= MaxCharges | Restore() caps at max | No overflow |
| Spend amount > 0 | Spend() rejects <= 0 | Prevents no-op calls |
| Restore amount >= 0 | Restore() ignores < 0 | Safe no-op behavior |

### 9.3 Resource Display

**Character Status Display:**
```
╔════════════════════════════════════════╗
║  Erikka Ironshield (Skjaldmær) - Lvl 5║
╠════════════════════════════════════════╣
║ HP: 45/45 (+15 from Bulwark)           ║
║ Defense: 18 (+3 Shield Wall)           ║
║ Block Charges: ███ 3/3                 ║
║ Active Stance: Shield Wall             ║
║ └─ +1 Defense to adjacent allies       ║
╚════════════════════════════════════════╝
```

**Combat Log Entry (on charge spend):**
```
[Turn 5] Erikka Ironshield spent 1 Block Charge to Intercept attack on Bjorn Stonekin
[Turn 5] Block Charges: 2/3 remaining
```

---

## 10. Shield Wall Stance Ability

### 10.1 Ability Specification

**Core Mechanics:**

| Property | Value | Notes |
|----------|-------|-------|
| **ID** | `shield-wall` | Configuration key |
| **Type** | Stance | Persistent, mutually exclusive |
| **AP Cost** | 2 | Meaningful but not prohibitive |
| **Duration** | Until ended | Persists through turns |
| **Self Bonus** | +3 Defense | Applied immediately upon activation |
| **Ally Bonus** | +1 Defense | Applied to each adjacent ally |
| **Requirements** | Shield equipped | Enforced at ability activation |
| **Restrictions** | One stance at a time | Ending previous stance required |

### 10.2 Effect Resolution

**On Activation:**
1. Validate shield equipment requirement
2. End any existing active stance
3. Deduct 2 AP from character action pool
4. Set character.ActiveStance = StanceId.ShieldWall
5. Create ShieldWallState with ActivatedAt timestamp
6. Calculate adjacent allies within 1 space
7. Apply +1 Defense buff to each adjacent ally
8. Log activation in combat log

**During Combat (each turn):**
1. Before each action phase, recalculate adjacent allies
2. Remove +1 Defense buff from previous adjacent allies (if positions changed)
3. Apply +1 Defense buff to new adjacent allies
4. Update visual indicators

**On Deactivation (explicit end or incapacitation):**
1. Set character.ActiveStance = null
2. Remove +3 Defense from self
3. Remove +1 Defense from all affected allies
4. Clear ShieldWallState
5. Log deactivation

### 10.3 Adjacent Ally Detection

**Definition:** An ally is adjacent if their position is within 1 space in any cardinal or diagonal direction.

**8-Directional Adjacency:**
```
    N  NE  E
    NW  X  SE
    S  SW  W
```

**Position Calculation Logic:**
```csharp
public bool IsAdjacentTo(Position other)
{
    int dx = Math.Abs(this.X - other.X);
    int dy = Math.Abs(this.Y - other.Y);
    int dz = Math.Abs(this.Z - other.Z); // Z-level (elevation)

    // Adjacent on same Z-level
    if (dz == 0 && dx <= 1 && dy <= 1 && !(dx == 0 && dy == 0))
        return true;

    // Diagonal up/down ladder (Z adjacent, same XY)
    if (dz == 1 && dx == 0 && dy == 0)
        return true;

    return false;
}
```

---

## 11. Intercept Reaction Ability

### 11.1 Ability Specification

| Property | Value | Notes |
|----------|-------|-------|
| **ID** | `intercept` | Configuration key |
| **Type** | Reaction | Triggered, no AP cost |
| **Trigger Event** | AllyTargetedByAttack | Pre-resolution |
| **Trigger Range** | 2 spaces | Distance from Skjaldmær to ally |
| **Resource Cost** | 1 Block Charge | Atomic cost |
| **Target** | Attack redirected to self | Before attack roll |
| **Timing** | Pre-resolution | Before attack hits/misses |
| **Requirements** | Line of sight to ally | Unobstructed path |
| **Restrictions** | No AoE attacks | Cannot intercept area effects |

### 11.2 Trigger Validation

**Pre-conditions for triggering:**
1. Skjaldmær is conscious and active
2. Target is an allied character
3. Attack originates from hostile character
4. Target distance <= 2 spaces
5. Line of sight unobstructed between Skjaldmær and target
6. Skjaldmær has >= 1 Block Charge available

**Attack types that CAN be intercepted:**
- Single-target melee attacks
- Single-target ranged attacks
- Single-target ability attacks
- Redirectable status effects

**Attack types that CANNOT be intercepted:**
- Area-of-effect abilities (affects multiple targets)
- Self-targeted abilities (attacker = defender)
- Persistent auras (no single "attack" event)
- Environmental damage (no specific attacker)

### 11.3 Execution Flow

```csharp
/// <summary>
/// Executes Intercept reaction when attack is detected.
/// Called by combat system during attack resolution phase.
/// </summary>
public async Task<bool> TryInterceptAsync(
    Character skjaldmaer,
    Character defendedAlly,
    Character attacker,
    Attack incomingAttack)
{
    // 1. Validate Skjaldmær state
    if (skjaldmaer.IsIncapacitated || skjaldmaer.BlockCharges == null)
        return false;

    // 2. Validate range and LoS
    int distance = skjaldmaer.Position.DistanceTo(defendedAlly.Position);
    if (distance > 2)
        return false;

    if (!HasLineOfSight(skjaldmaer.Position, defendedAlly.Position))
        return false;

    // 3. Validate charges
    if (!_blockChargeService.CanSpend(skjaldmaer, 1))
        return false;

    // 4. Validate attack type
    if (!CanInterceptAttack(incomingAttack))
        return false;

    // 5. Spend charge
    if (!await _blockChargeService.SpendChargesAsync(skjaldmaer, 1))
        return false;

    // 6. Redirect attack
    incomingAttack.Target = skjaldmaer;
    _logger.LogInformation(
        "Intercept executed: {Skjaldmaer} redirected attack from {Attacker} " +
        "on {Ally} to self",
        skjaldmaer.Name, attacker.Name, defendedAlly.Name);

    return true;
}
```

---

## 12. Bulwark Passive Ability

### 12.1 Ability Specification

| Property | Value | Notes |
|----------|-------|-------|
| **ID** | `bulwark` | Configuration key |
| **Type** | Passive | Always active, no activation |
| **Effect** | +5 Max HP per Block Charge | Dynamic, updates with charges |
| **Calculation** | `CurrentCharges * 5` | Linear scaling |
| **Minimum** | 0 HP bonus | At 0 charges |
| **Maximum** | +15 HP bonus | At 3 charges |
| **Timing** | Recalculated on charge change | Immediate integration |
| **Prerequisites** | None | Works with any equipment/level |

### 12.2 HP Bonus Calculation

**Formula:**
```
BulwarkBonus = CurrentCharges * 5

Examples:
- 0 charges: 0 * 5 = +0 HP
- 1 charge:  1 * 5 = +5 HP
- 2 charges: 2 * 5 = +10 HP
- 3 charges: 3 * 5 = +15 HP
```

**Integration with Character HP System:**

```csharp
public int GetMaxHealth()
{
    int baseMaxHP = BaseStats.Constitution * 5; // Example calculation

    // Add specialization-specific bonuses
    if (Specialization == SpecializationId.Skjaldmaer)
    {
        baseMaxHP += GetBulwarkBonus();
    }

    // Add equipment bonuses, buffs, etc.
    baseMaxHP += GetArmorBonus();
    baseMaxHP += GetStatusEffectBonus();

    return Math.Max(1, baseMaxHP); // Minimum 1 HP
}

public int GetBulwarkBonus()
{
    if (BlockCharges == null)
        return 0;

    return BlockCharges.GetBulwarkHpBonus();
}
```

### 12.3 Overheal Prevention

**When Block Charges are spent (e.g., Intercept is used):**

```csharp
public async Task OnBlockChargesSpent(Character character, int amountSpent)
{
    int oldMaxHP = character.GetMaxHealth();

    // Charges are spent
    await _blockChargeService.SpendChargesAsync(character, amountSpent);

    int newMaxHP = character.GetMaxHealth();

    // If current HP exceeds new Max HP, reduce to new Max
    if (character.CurrentHP > newMaxHP)
    {
        character.CurrentHP = newMaxHP;
        _logger.LogInformation(
            "Character {CharacterId} Max HP reduced from {Old} to {New}, " +
            "Current HP adjusted to {Current}",
            character.Id, oldMaxHP, newMaxHP, character.CurrentHP);
    }
}
```

---

## 13. Code Examples with XML Documentation

### 13.1 Complete BlockChargeService Implementation

```csharp
/// <summary>
/// Manages Block Charge resource operations for Skjaldmær specialization.
/// Handles spending, restoration, and validation of charges with comprehensive logging.
/// </summary>
public class BlockChargeService : IBlockChargeService
{
    private readonly ICharacterRepository _characterRepository;
    private readonly ILogger<BlockChargeService> _logger;

    /// <summary>
    /// Initializes a new instance of BlockChargeService.
    /// </summary>
    /// <param name="characterRepository">Repository for persisting character changes</param>
    /// <param name="logger">Logger for audit trail</param>
    public BlockChargeService(
        ICharacterRepository characterRepository,
        ILogger<BlockChargeService> logger)
    {
        _characterRepository = characterRepository ?? throw new ArgumentNullException(nameof(characterRepository));
        _logger = logger ?? throw new ArgumentNullException(nameof(logger));
    }

    /// <summary>
    /// Spends Block Charges from a character's reserve.
    /// </summary>
    /// <param name="character">Character spending charges</param>
    /// <param name="amount">Number of charges to spend</param>
    /// <returns>Task result indicating success</returns>
    /// <exception cref="ArgumentNullException">If character is null</exception>
    /// <remarks>
    /// This is the authoritative spend operation. It performs atomic spending,
    /// meaning the entire amount is spent or nothing is changed.
    /// Only Skjaldmær characters have Block Charges.
    /// </remarks>
    public async Task<bool> SpendChargesAsync(Character character, int amount)
    {
        if (character == null)
            throw new ArgumentNullException(nameof(character));

        // Non-Skjaldmær characters don't have Block Charges
        if (character.BlockCharges == null)
            return false;

        // Attempt to spend charges
        if (!character.BlockCharges.Spend(amount))
        {
            _logger.LogWarning(
                "Block Charge spend rejected for character {CharacterId} " +
                "({CharacterName}): Attempted to spend {Amount} charges but " +
                "only {Current} available (max {Max})",
                character.Id, character.Name, amount,
                character.BlockCharges.CurrentCharges,
                character.BlockCharges.MaxCharges);
            return false;
        }

        // Persist changes
        await _characterRepository.UpdateAsync(character);

        _logger.LogInformation(
            "Block Charges successfully spent: Character {CharacterId} " +
            "({CharacterName}) spent {Amount} charges. " +
            "Status: {Current}/{Max}",
            character.Id, character.Name, amount,
            character.BlockCharges.CurrentCharges,
            character.BlockCharges.MaxCharges);

        return true;
    }

    /// <summary>
    /// Restores a specified number of Block Charges.
    /// </summary>
    /// <param name="character">Character receiving charges</param>
    /// <param name="amount">Number of charges to restore</param>
    /// <returns>Task result with new current charge count</returns>
    /// <remarks>
    /// Restoration respects the MaxCharges cap.
    /// If character already has 2 charges and restores 3, result is 3 (not 5).
    /// </remarks>
    public async Task<int> RestoreChargesAsync(Character character, int amount)
    {
        if (character?.BlockCharges == null)
            return -1;

        int previousValue = character.BlockCharges.CurrentCharges;
        character.BlockCharges.Restore(amount);
        int newValue = character.BlockCharges.CurrentCharges;

        await _characterRepository.UpdateAsync(character);

        _logger.LogInformation(
            "Block Charges restored: Character {CharacterId} ({CharacterName}) " +
            "restored {Amount} charges. Status: {Previous}/{Max} -> {Current}/{Max}",
            character.Id, character.Name, amount, previousValue,
            character.BlockCharges.MaxCharges, newValue,
            character.BlockCharges.MaxCharges);

        return newValue;
    }

    /// <summary>
    /// Fully restores Block Charges to maximum.
    /// Typically called after rest completion.
    /// </summary>
    /// <param name="character">Character to restore</param>
    /// <returns>Task result with max charge count</returns>
    public async Task<int> RestoreAllChargesAsync(Character character)
    {
        if (character?.BlockCharges == null)
            return -1;

        character.BlockCharges.RestoreAll();
        await _characterRepository.UpdateAsync(character);

        _logger.LogInformation(
            "Block Charges fully restored: Character {CharacterId} ({CharacterName}) " +
            "restored to full ({Max} charges)",
            character.Id, character.Name, character.BlockCharges.MaxCharges);

        return character.BlockCharges.MaxCharges;
    }

    /// <summary>
    /// Checks if a character can spend specified charges without modifying state.
    /// </summary>
    /// <param name="character">Character to check</param>
    /// <param name="amount">Number of charges required</param>
    /// <returns>True if character has sufficient charges or is not Skjaldmær</returns>
    public bool CanSpend(Character character, int amount)
    {
        if (character?.BlockCharges == null)
            return true; // Non-Skjaldmær always passes check

        return character.BlockCharges.CurrentCharges >= amount;
    }

    /// <inheritdoc/>
    public int GetCurrentValue(Character character)
    {
        return character?.BlockCharges?.CurrentCharges ?? -1;
    }

    /// <inheritdoc/>
    public int GetMaxValue(Character character)
    {
        return character?.BlockCharges?.MaxCharges ?? -1;
    }
}
```

### 13.2 Shield Wall Ability Handler

```csharp
/// <summary>
/// Handles activation and management of Shield Wall stance ability.
/// </summary>
public class ShieldWallAbilityHandler : IAbilityHandler
{
    private const int AP_COST = 2;
    private const int SELF_DEFENSE_BONUS = 3;
    private const int ALLY_DEFENSE_BONUS = 1;
    private const int ADJACENT_RANGE = 1;

    private readonly ISkjaldmaerAbilityService _abilityService;
    private readonly IPositionService _positionService;
    private readonly ILogger<ShieldWallAbilityHandler> _logger;

    public ShieldWallAbilityHandler(
        ISkjaldmaerAbilityService abilityService,
        IPositionService positionService,
        ILogger<ShieldWallAbilityHandler> logger)
    {
        _abilityService = abilityService;
        _positionService = positionService;
        _logger = logger;
    }

    /// <summary>
    /// Attempts to activate Shield Wall stance.
    /// </summary>
    /// <param name="character">Skjaldmær activating the stance</param>
    /// <param name="context">Combat context</param>
    /// <returns>Result indicating success or failure reason</returns>
    public async Task<AbilityResult> ExecuteAsync(
        Character character,
        CombatContext context)
    {
        // Validate specialization
        if (character.Specialization != SpecializationId.Skjaldmaer)
        {
            return AbilityResult.Failure("Only Skjaldmær can use Shield Wall");
        }

        // Validate shield equipment
        if (!HasShieldEquipped(character))
        {
            _logger.LogWarning(
                "Shield Wall activation failed: Character {CharacterId} " +
                "does not have a shield equipped",
                character.Id);
            return AbilityResult.Failure("You must have a shield equipped to use Shield Wall");
        }

        // Validate AP
        if (character.CurrentAP < AP_COST)
        {
            return AbilityResult.Failure($"Not enough AP. Required: {AP_COST}, Available: {character.CurrentAP}");
        }

        // End existing stance
        if (character.ActiveStance.HasValue)
        {
            await _abilityService.EndShieldWallAsync(character);
        }

        // Deduct AP
        character.CurrentAP -= AP_COST;

        // Activate stance
        character.ShieldWallState = new ShieldWallState
        {
            ActivatedPosition = character.Position,
            ActivatedAt = DateTime.UtcNow
        };
        character.ShieldWallState.Activate();
        character.ActiveStance = StanceId.ShieldWall;

        // Get affected allies
        var allCharacters = context.GetAllCharactersInArea(character.Position, 10);
        var affectedAllies = character.ShieldWallState.GetAffectedAllies(allCharacters, character.Position);

        _logger.LogInformation(
            "Shield Wall activated: Character {CharacterId} ({CharacterName}) " +
            "gained +{Bonus} Defense and {AffectedCount} allies gained +1 Defense",
            character.Id, character.Name, SELF_DEFENSE_BONUS, affectedAllies.Count);

        return AbilityResult.Success(
            $"Shield Wall activated! +{SELF_DEFENSE_BONUS} Defense. " +
            $"{affectedAllies.Count} allies receive +{ALLY_DEFENSE_BONUS} Defense");
    }

    /// <summary>
    /// Determines if character has a shield equipped.
    /// </summary>
    private bool HasShieldEquipped(Character character)
    {
        return character.Equipment != null &&
               character.Equipment.OffHand != null &&
               character.Equipment.OffHand.ItemType == ItemType.Shield;
    }
}
```

---

## 14. Logging Specifications

### 14.1 Block Charge Operations

**Log Level: Information**

```
Block Charge Spent:
[INFO] BlockChargeService: Block Charges successfully spent: Character {CharacterId} ({CharacterName}) spent {Amount} charges. Status: {Current}/{Max}

Block Charge Restored:
[INFO] BlockChargeService: Block Charges restored: Character {CharacterId} ({CharacterName}) restored {Amount} charges. Status: {Previous}/{Max} -> {Current}/{Max}

Block Charges Full Restore:
[INFO] BlockChargeService: Block Charges fully restored: Character {CharacterId} ({CharacterName}) restored to full ({Max} charges)
```

**Log Level: Warning**

```
Insufficient Charges:
[WARN] BlockChargeService: Block Charge spend rejected for character {CharacterId} ({CharacterName}): Attempted to spend {Amount} charges but only {Current} available (max {Max})
```

### 14.2 Ability Execution

**Log Level: Information**

```
Shield Wall Activated:
[INFO] ShieldWallAbilityHandler: Shield Wall activated: Character {CharacterId} ({CharacterName}) gained +{Bonus} Defense and {AffectedCount} allies gained +1 Defense

Shield Wall Ended:
[INFO] ShieldWallAbilityHandler: Shield Wall ended: Character {CharacterId} ({CharacterName}) lost +{Bonus} Defense

Intercept Executed:
[INFO] InterceptAbilityHandler: Intercept executed: {Skjaldmaer} redirected attack from {Attacker} on {Ally} to self

Bulwark Applied:
[INFO] BulwarkAbilityHandler: Bulwark active: Character {CharacterId} ({CharacterName}) gains +{Bonus} Max HP from {ChargeCount} Block Charges
```

### 14.3 Error Conditions

**Log Level: Error**

```
Character Repository Failure:
[ERROR] BlockChargeService: Failed to persist character {CharacterId}: {Exception}

Null Character:
[ERROR] BlockChargeService: Null character passed to SpendChargesAsync
```

---

## 15. Unit Testing Requirements

### 15.1 BlockChargeResourceTests

**File:** `Tests/Domain/BlockChargeResourceTests.cs`

**Test Count:** 5 tests

```csharp
[TestFixture]
public class BlockChargeResourceTests
{
    [Test]
    public void Constructor_CreatesResourceWithMaxCharges()
    {
        // Arrange & Act
        var resource = new BlockChargeResource();

        // Assert
        Assert.That(resource.CurrentCharges, Is.EqualTo(3));
        Assert.That(resource.MaxCharges, Is.EqualTo(3));
        Assert.That(resource.LastRestoredAt, Is.Null);
    }

    [Test]
    public void Spend_WithSufficientCharges_ReducesCountAndReturnsTrue()
    {
        // Arrange
        var resource = new BlockChargeResource();

        // Act
        bool result = resource.Spend(1);

        // Assert
        Assert.That(result, Is.True);
        Assert.That(resource.CurrentCharges, Is.EqualTo(2));
    }

    [Test]
    public void Spend_WithInsufficientCharges_ReturnsFalseAndDoesNotModify()
    {
        // Arrange
        var resource = new BlockChargeResource { CurrentCharges = 1 };

        // Act
        bool result = resource.Spend(2);

        // Assert
        Assert.That(result, Is.False);
        Assert.That(resource.CurrentCharges, Is.EqualTo(1)); // Unchanged
    }

    [Test]
    public void RestoreAll_SetsToMaxCharges()
    {
        // Arrange
        var resource = new BlockChargeResource { CurrentCharges = 0 };

        // Act
        resource.RestoreAll();

        // Assert
        Assert.That(resource.CurrentCharges, Is.EqualTo(3));
        Assert.That(resource.LastRestoredAt, Is.Not.Null);
    }

    [Test]
    public void GetBulwarkHpBonus_ReturnsCorrectMultiple()
    {
        // Arrange
        var resource = new BlockChargeResource { CurrentCharges = 2 };

        // Act
        int bonus = resource.GetBulwarkHpBonus();

        // Assert
        Assert.That(bonus, Is.EqualTo(10));
    }
}
```

### 15.2 BlockChargeServiceTests

**File:** `Tests/Application/BlockChargeServiceTests.cs`

**Test Count:** 5 tests

```csharp
[TestFixture]
public class BlockChargeServiceTests
{
    private BlockChargeService _service;
    private Mock<ICharacterRepository> _mockRepository;
    private Mock<ILogger<BlockChargeService>> _mockLogger;

    [SetUp]
    public void Setup()
    {
        _mockRepository = new Mock<ICharacterRepository>();
        _mockLogger = new Mock<ILogger<BlockChargeService>>();
        _service = new BlockChargeService(_mockRepository.Object, _mockLogger.Object);
    }

    [Test]
    public async Task SpendChargesAsync_WithValidCharacter_ReducesChargesAndPersists()
    {
        // Arrange
        var character = CreateSkjaldmaerCharacter();
        character.BlockCharges = new BlockChargeResource { CurrentCharges = 3 };
        _mockRepository.Setup(r => r.UpdateAsync(It.IsAny<Character>())).ReturnsAsync(true);

        // Act
        bool result = await _service.SpendChargesAsync(character, 1);

        // Assert
        Assert.That(result, Is.True);
        Assert.That(character.BlockCharges.CurrentCharges, Is.EqualTo(2));
        _mockRepository.Verify(r => r.UpdateAsync(character), Times.Once);
    }

    [Test]
    public async Task RestoreAllChargesAsync_RestoresAndPersists()
    {
        // Arrange
        var character = CreateSkjaldmaerCharacter();
        character.BlockCharges = new BlockChargeResource { CurrentCharges = 0 };

        // Act
        int result = await _service.RestoreAllChargesAsync(character);

        // Assert
        Assert.That(result, Is.EqualTo(3));
        Assert.That(character.BlockCharges.CurrentCharges, Is.EqualTo(3));
    }

    [Test]
    public void CanSpend_WithSufficientCharges_ReturnsTrue()
    {
        // Arrange
        var character = CreateSkjaldmaerCharacter();
        character.BlockCharges = new BlockChargeResource { CurrentCharges = 2 };

        // Act
        bool result = _service.CanSpend(character, 1);

        // Assert
        Assert.That(result, Is.True);
    }

    [Test]
    public void CanSpend_WithInsufficientCharges_ReturnsFalse()
    {
        // Arrange
        var character = CreateSkjaldmaerCharacter();
        character.BlockCharges = new BlockChargeResource { CurrentCharges = 0 };

        // Act
        bool result = _service.CanSpend(character, 1);

        // Assert
        Assert.That(result, Is.False);
    }

    [Test]
    public void GetCurrentValue_ReturnsCorrectValue()
    {
        // Arrange
        var character = CreateSkjaldmaerCharacter();
        character.BlockCharges = new BlockChargeResource { CurrentCharges = 2 };

        // Act
        int result = _service.GetCurrentValue(character);

        // Assert
        Assert.That(result, Is.EqualTo(2));
    }

    // Helper method
    private Character CreateSkjaldmaerCharacter()
    {
        return new Character
        {
            Id = Guid.NewGuid(),
            Name = "Test Skjaldmaer",
            Specialization = SpecializationId.Skjaldmaer
        };
    }
}
```

---

## 16. Integration Testing Requirements

### 16.1 Character Creation Integration Test

**File:** `Tests/Integration/SkjaldmaerCharacterCreationTests.cs`

```csharp
[TestFixture]
public class SkjaldmaerCharacterCreationTests
{
    private IServiceProvider _serviceProvider;

    [SetUp]
    public void Setup()
    {
        _serviceProvider = new ServiceCollection()
            .AddScoped<IBlockChargeService, BlockChargeService>()
            .AddScoped<ISkjaldmaerAbilityService, SkjaldmaerAbilityService>()
            .AddScoped<ICharacterRepository, InMemoryCharacterRepository>()
            .BuildServiceProvider();
    }

    [Test]
    public async Task CreateSkjaldmaerCharacter_InitializesBlockCharges()
    {
        // Arrange
        var characterService = _serviceProvider.GetRequiredService<ICharacterService>();

        // Act
        var character = await characterService.CreateCharacterAsync(
            "Erikka",
            ArchetypeId.Warrior,
            SpecializationId.Skjaldmaer);

        // Assert
        Assert.That(character.BlockCharges, Is.Not.Null);
        Assert.That(character.BlockCharges.CurrentCharges, Is.EqualTo(3));
        Assert.That(character.BlockCharges.MaxCharges, Is.EqualTo(3));
    }
}
```

---

## 17. Deliverable Checklist

### Domain Layer Deliverables

- [ ] `BlockChargeResource` value object implemented
  - [ ] CurrentCharges property (0-3 range)
  - [ ] MaxCharges property (default 3)
  - [ ] LastRestoredAt property (timestamp)
  - [ ] Spend() method
  - [ ] Restore() method
  - [ ] RestoreAll() method
  - [ ] GetBulwarkHpBonus() method
  - [ ] Structural equality (record type)
  - [ ] XML documentation complete

- [ ] `ShieldWallState` value object implemented
  - [ ] IsActive property
  - [ ] DefenseBonus property (+3)
  - [ ] AllyDefenseBonus property (+1)
  - [ ] ActivatedPosition property
  - [ ] ActivatedAt timestamp
  - [ ] GetAffectedAllies() method
  - [ ] IsExpired() method
  - [ ] Activate() method
  - [ ] Deactivate() method
  - [ ] XML documentation complete

- [ ] `SkjaldmaerAbilityId` enum implemented
  - [ ] All 9 ability identifiers defined (T1, T2, T3, Capstone)
  - [ ] XML documentation for each value
  - [ ] Correct ordinal values (1-9)

- [ ] `Character` entity extensions
  - [ ] BlockCharges nullable property
  - [ ] ActiveStance nullable property
  - [ ] ShieldWallState nullable property
  - [ ] GetEffectiveDefense() method
  - [ ] GetBulwarkBonus() method

### Application Layer Deliverables

- [ ] `IBlockChargeService` interface
  - [ ] All 6 method signatures defined
  - [ ] XML documentation complete
  - [ ] Async task signatures correct

- [ ] `BlockChargeService` implementation
  - [ ] SpendChargesAsync() implementation
  - [ ] RestoreChargesAsync() implementation
  - [ ] RestoreAllChargesAsync() implementation
  - [ ] CanSpend() implementation
  - [ ] GetCurrentValue() implementation
  - [ ] GetMaxValue() implementation
  - [ ] Comprehensive logging throughout
  - [ ] XML documentation complete

- [ ] `ISkjaldmaerAbilityService` interface
  - [ ] All method signatures defined
  - [ ] XML documentation complete

- [ ] Ability Handlers
  - [ ] ShieldWallAbilityHandler implemented
  - [ ] InterceptAbilityHandler implemented
  - [ ] BulwarkAbilityHandler (passive integration)

### Infrastructure Layer Deliverables

- [ ] `specializations.json` updated
  - [ ] Skjaldmaer entry added
  - [ ] Block Charges resource defined
  - [ ] All ability tier data correct
  - [ ] Prerequisite information complete

- [ ] `abilities.json` updated
  - [ ] `shield-wall` ability entry
  - [ ] `intercept` ability entry
  - [ ] `bulwark` ability entry
  - [ ] All effect definitions complete
  - [ ] All keyword tags added

### Testing Deliverables

- [ ] Unit Tests (10 total)
  - [ ] BlockChargeResourceTests.cs (5 tests)
  - [ ] BlockChargeServiceTests.cs (5 tests)

- [ ] Integration Tests
  - [ ] Character creation with Block Charges
  - [ ] Shield Wall activation with ally detection
  - [ ] Intercept reaction execution

- [ ] All tests passing
  - [ ] 100% success rate
  - [ ] No ignored/skipped tests
  - [ ] Coverage > 85%

### Documentation Deliverables

- [ ] Design specification (this document)
  - [ ] 20+ sections complete
  - [ ] 600+ lines
  - [ ] Code examples included
  - [ ] Architecture diagrams complete
  - [ ] User stories defined
  - [ ] Acceptance criteria clear

---

## 18. Acceptance Criteria

### Functional Acceptance Criteria

- [ ] **AC-1a:** Block Charges initialize to 3/3 on Skjaldmær character creation
- [ ] **AC-1b:** Block Charges restore to 3/3 after any rest (short or long)
- [ ] **AC-1c:** Block Charges never exceed 3 or drop below 0
- [ ] **AC-2a:** Shield Wall stance grants +3 Defense to self
- [ ] **AC-2b:** Shield Wall stance grants +1 Defense to each adjacent ally (within 1 space)
- [ ] **AC-2c:** Shield Wall persists until explicitly ended or character incapacitated
- [ ] **AC-2d:** Only one stance can be active at a time
- [ ] **AC-3a:** Intercept reaction triggered when ally within 2 spaces targeted by attack
- [ ] **AC-3b:** Intercept costs exactly 1 Block Charge
- [ ] **AC-3c:** Intercept redirects attack to Skjaldmær before resolution
- [ ] **AC-3d:** Cannot intercept if insufficient charges
- [ ] **AC-4a:** Bulwark grants +5 Max HP per Block Charge held
- [ ] **AC-4b:** Bulwark bonus updates immediately when charges change
- [ ] **AC-4c:** Bulwark calculation: (CurrentCharges * 5), max +15 HP

### Non-Functional Acceptance Criteria

- [ ] **AC-NF-1:** All operations logged with appropriate levels (Info/Warn/Error)
- [ ] **AC-NF-2:** Database transactions are atomic (all-or-nothing)
- [ ] **AC-NF-3:** Character state persisted after ability execution
- [ ] **AC-NF-4:** No memory leaks in service implementations
- [ ] **AC-NF-5:** Unit test coverage >= 85%
- [ ] **AC-NF-6:** Integration tests cover critical paths

### UI/UX Acceptance Criteria

- [ ] **AC-UI-1:** Block Charges displayed clearly in character status
- [ ] **AC-UI-2:** Shield Wall active indicator shows on character
- [ ] **AC-UI-3:** Adjacent allies visually indicated during Shield Wall
- [ ] **AC-UI-4:** Defense bonuses displayed in character sheet
- [ ] **AC-UI-5:** Bulwark bonus shown as "Max HP: XX (+YY from Bulwark)"

---

## 19. Dependencies

### Hard Dependencies (Required for v0.20.1a)

```
v0.17.3 (Archetype System)
    └─► Warrior archetype must exist
        └─► Required for specialization association

v0.17.4 (Specialization Framework)
    ├─► SpecializationDefinition entity structure
    ├─► SpecializationId enum includes Skjaldmaer
    ├─► SpecializationPathType.Coherent defined
    ├─► Tier unlock mechanics (PP requirements)
    ├─► SpecialResourceDefinition support
    └─► IAbilitySlotService interface

v0.20.0 (Legacy Class Removal & Migration)
    ├─► Character entity structure (v2.0)
    ├─► ICharacterRepository interface
    ├─► Specialization prerequisite services
    ├─► Ability framework (IAbility interface)
    └─► Combat system hooks (reaction triggers)

Core Systems (Pre-existing)
    ├─► Combat System (attack resolution, reaction hooks)
    ├─► Rest System (rest triggers)
    ├─► Position System (distance calculations, adjacency)
    ├─► Defense Calculation System (bonus application)
    ├─► Status Effect System (buff application)
    └─► Logging Infrastructure (ILogger<T>)
```

### Internal Dependencies (Within v0.20.1a)

| Dependency | Type | Usage |
|-----------|------|-------|
| BlockChargeResource → Character | Composition | Character holds BlockCharges |
| ShieldWallState → Character | Composition | Character holds ShieldWallState |
| BlockChargeService → ICharacterRepository | Service | Persistence of character changes |
| SkjaldmaerAbilityService → BlockChargeService | Service | Charge spending for abilities |
| ShieldWallHandler → ISkjaldmaerAbilityService | Service | Stance activation |
| InterceptHandler → BlockChargeService | Service | Charge spending |

### Soft Dependencies (Recommended but not strict)

- Detailed logging framework (can use simpler logger if needed)
- Async/await infrastructure (can use sync if needed)
- Dependency injection container (can wire manually if needed)

---

## 20. Deferrals and Future Considerations

### Deferred to v0.20.1b

- **Hold the Line** active ability (enemy movement blocking)
- **Counter-Shield** reaction ability (damage on block)
- **Rally** support ability (ally save bonus)
- **Tier 2 prerequisite validation** (8 PP requirement)

### Deferred to v0.20.1c

- **Unbreakable** passive ability (damage reduction)
- **Guardian's Sacrifice** reaction ability (damage absorption)
- **The Wall Lives** capstone ultimate (lethal protection)
- **Tier 3/Capstone prerequisite validation** (16/24 PP requirements)

### Future Enhancement Opportunities

**Block Charge Generation:**
- Parry on successful defense (generate 1 charge)
- Block ability (active ability spending AP to restore 1 charge)
- Enemy abilities that grant charges
- Passive generation over time (low rate)

**Resource Expansion:**
- Alternative resource systems for other specializations
- Hybrid resource systems (multiple resource types)
- Resource item pickups (consumables restoring charges)
- Difficulty scaling (harder content = charge depletion)

**Ability Interactions:**
- Combo system (Shield Wall + Intercept = special effect)
- Charge consumption modifiers (talents reducing costs)
- Area-of-effect stances affecting larger areas
- Charge sharing with nearby allies

**UI/UX Improvements:**
- Custom character portraits for Skjaldmær
- Shield Wall visual effects (shield glow/barrier)
- Charge UI animations (visual feedback on spend)
- Adjacent ally highlighting during stance
- Ability preview (show affected allies before activation)

**Balance Adjustments:**
- Charge depletion rate tuning based on playtesting
- Adjacent ally detection range customization
- Defense bonus value tuning
- AP cost adjustments based on power level

---

## Conclusion

v0.20.1a establishes the foundational framework for the Skjaldmær specialization, implementing the Block Charges resource system and three Tier 1 defensive abilities that define the core protective identity. The design prioritizes clear mechanics, meaningful decision-making, and seamless integration with existing systems while maintaining consistency with the Coherent path philosophy.

Subsequent phases (v0.20.1b, v0.20.1c) will expand the ability tree with mid-tier tactical abilities and late-tier mastery powers, culminating in the signature ultimate "The Wall Lives" capstone.

---

**Document Version:** 0.20.1a-v1.0
**Last Updated:** 2026-01-28
**Status:** Design Phase - Ready for Review
**Next Phase:** v0.20.1b Design Specification (Tier 2 Abilities)
