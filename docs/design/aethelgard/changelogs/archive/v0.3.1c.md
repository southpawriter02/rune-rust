> **Archived** - This changelog has been consolidated. See the complete version at [v0.3.1](../v0.3.x/v0.3.1.md).

# v0.3.1c Changelog: The Alchemist (Alchemy & Runeforging)

**Release Date:** December 20, 2025
**Total Tests:** 1704 (12 new tests added)

---

## Summary

Version 0.3.1c introduces **trade-specific catastrophe mechanics** for Alchemy and Runeforging crafting trades. When crafters roll net negative successes, they now suffer consequences unique to their trade: Alchemists take explosive damage, while Runeforgers accumulate Corruption.

Key architectural additions:
- **CatastropheType Enum**: Five catastrophe types (None, Explosive, Toxic, Corrosive, Corruption)
- **ItemProperty Entity**: Foundation for runic enchantment buffs on items
- **Trade-Specific Handling**: CraftingService applies damage or Corruption based on recipe CatastropheType
- **Extended Recipe Model**: Recipes now define catastrophe type, damage, and corruption values
- **Extended Command Parser**: New verbs (brew, mix, concoct, forge, inscribe, etch)

---

## New Features

### Trade-Specific Catastrophe Mechanics

#### Alchemy: Explosive Catastrophe
- **Trigger**: Net negative successes on Alchemy recipe
- **Effect**: Crafter takes physical damage (CatastropheDamage property)
- **Damage Values**:
  - Basic Stimulant: 5 damage
  - Crude Antitoxin: 8 damage
  - Alchemist Fire: 15 damage
- **HP Clamping**: Damage cannot reduce HP below 0

#### Runeforging: Corruption Catastrophe
- **Trigger**: Net negative successes on Runeforging recipe
- **Effect**: Crafter gains permanent Corruption via TraumaService
- **Corruption Values**:
  - Glow Stone: 3 Corruption
  - Minor Ward Token: 5 Corruption
  - Runic Battery: 8 Corruption
- **Integration**: Uses existing ITraumaService.AddCorruption() method

### ItemProperty System (Foundation)
- **Entity Created**: Stores runic buffs for future enchantment features
- **StatModifiers Dictionary**: Maps stat names to modifier values
- **Item.Properties Collection**: Equipment can hold multiple properties
- **Ready for v0.3.1d**: Target item enchantment implementation

### New Commands
- **Alchemy**: `brew <recipe>`, `mix <recipe>`, `concoct <recipe>`
- **Runeforging**: `forge <rune>`, `forge <rune> on <item>`, `inscribe`, `etch`

---

## Files Created

### Core Layer

| File | Purpose |
|------|---------|
| `RuneAndRust.Core/Enums/CatastropheType.cs` | Enum with 5 catastrophe types |
| `RuneAndRust.Core/Entities/ItemProperty.cs` | Entity for runic buffs with stat modifiers |

---

## Files Modified

| File | Change |
|------|--------|
| `RuneAndRust.Core/Entities/Item.cs` | Added Properties collection for enchantments |
| `RuneAndRust.Core/Entities/Recipe.cs` | Added CatastropheType, CatastropheDamage, CatastropheCorruption, OutputProperties, RequiresTargetItem |
| `RuneAndRust.Core/Models/Crafting/CraftingResult.cs` | Added DamageDealt, CorruptionAdded, EnchantedItem optional fields |
| `RuneAndRust.Engine/Services/CraftingService.cs` | Injected ITraumaService, added trade-specific catastrophe handling |
| `RuneAndRust.Core/Data/RecipeRegistry.cs` | Updated Alchemy (Explosive) and Runeforging (Corruption) recipes |
| `RuneAndRust.Engine/Services/CommandParser.cs` | Added brew/mix/concoct and forge/inscribe/etch commands |
| `RuneAndRust.Tests/Engine/CraftingServiceTests.cs` | Added 12 new catastrophe tests |

---

## Code Implementation Details

### CatastropheType Enum
```csharp
public enum CatastropheType
{
    None = 0,       // Standard catastrophe: materials lost only
    Explosive = 1,  // Alchemy: deals physical damage
    Toxic = 2,      // Reserved for future
    Corrosive = 3,  // Reserved for future
    Corruption = 4  // Runeforging: adds permanent Corruption
}
```

### ItemProperty Entity
```csharp
public class ItemProperty
{
    public Guid Id { get; set; } = Guid.NewGuid();
    public string Name { get; set; } = string.Empty;
    public string Description { get; set; } = string.Empty;
    public Dictionary<string, int> StatModifiers { get; set; } = new();
    public DateTime AppliedAt { get; set; } = DateTime.UtcNow;
}
```

### Recipe Catastrophe Properties
```csharp
public class Recipe
{
    // Existing properties...

    // Catastrophe Properties (v0.3.1c)
    public CatastropheType CatastropheType { get; set; } = CatastropheType.None;
    public int CatastropheDamage { get; set; } = 0;
    public int CatastropheCorruption { get; set; } = 0;

    // Runeforging Properties (v0.3.1c)
    public List<ItemProperty> OutputProperties { get; set; } = new();
    public bool RequiresTargetItem { get; set; } = false;
}
```

### CraftingResult Extensions
```csharp
public record CraftingResult(
    // Existing parameters...
    int? DamageDealt = null,       // HP damage from Explosive catastrophe
    int? CorruptionAdded = null,   // Corruption from Runeforging catastrophe
    Equipment? EnchantedItem = null // Target item enchanted by Runeforging
);
```

### CraftingService Catastrophe Handler
```csharp
private CraftingResult HandleCatastrophe(Character crafter, Recipe recipe, DiceResult diceResult, int netSuccesses)
{
    switch (recipe.CatastropheType)
    {
        case CatastropheType.Explosive:
            crafter.CurrentHP = Math.Max(0, crafter.CurrentHP - recipe.CatastropheDamage);
            // Return result with DamageDealt set
            break;

        case CatastropheType.Corruption:
            _traumaService.AddCorruption(crafter, recipe.CatastropheCorruption, "Runic Backlash");
            // Return result with CorruptionAdded set
            break;

        default:
            // Standard catastrophe: materials lost only
            break;
    }
}
```

### ParseResult Extensions
```csharp
public class ParseResult
{
    // Existing properties...

    // Alchemy & Runeforging Commands (v0.3.1c)
    public bool RequiresBrew { get; set; }
    public string? BrewTarget { get; set; }
    public bool RequiresForge { get; set; }
    public string? ForgeRune { get; set; }
    public string? ForgeTarget { get; set; }
}
```

---

## Commands Reference (Updated)

### Exploration Phase Commands
| Command | Aliases | Action |
|---------|---------|--------|
| `brew <recipe>` | `mix <recipe>`, `concoct <recipe>` | Attempt to brew an Alchemy recipe |
| `forge <rune>` | `inscribe <rune>`, `etch <rune>` | Forge a runic item |
| `forge <rune> on <item>` | `inscribe <rune> on <item>` | Inscribe a rune onto equipment |

---

## Logging Matrix (v0.3.1c)

### CraftingService Logs
| Event | Level | Template |
|-------|-------|----------|
| Alchemy Catastrophe | Warning | `"ALCHEMY CATASTROPHE: {CharacterName} takes {Damage} explosive damage!"` |
| Runeforging Catastrophe | Warning | `"RUNEFORGING CATASTROPHE: {CharacterName} gains {Corruption} Corruption!"` |

### CommandParser Logs
| Event | Level | Template |
|-------|-------|----------|
| Brew Command | Debug | `"Brew command for target: {Target}"` |
| Forge Command | Debug | `"Forge command: {Rune} on {Target}"` |
| Forge Command (no target) | Debug | `"Forge command (no target): {Rune}"` |

---

## Complete Test Inventory

### Engine/CraftingServiceTests.cs (12 new tests)

#### Alchemy Catastrophe Tests (4 tests)
| Test Name | Description |
|-----------|-------------|
| `CraftItem_AlchemyCatastrophe_DealsDamage` | Verifies HP reduction on explosive failure |
| `CraftItem_AlchemyCatastrophe_SetsResultDamage` | Verifies DamageDealt is set in result |
| `CraftItem_AlchemyCatastrophe_DoesNotReduceHpBelowZero` | HP clamped to 0 minimum |
| `CraftItem_FirebombCatastrophe_DealsHighDamage` | High-risk recipe deals 15 damage |

#### Runeforging Catastrophe Tests (3 tests)
| Test Name | Description |
|-----------|-------------|
| `CraftItem_RuneforgingCatastrophe_AddsCorruption` | Verifies TraumaService.AddCorruption called |
| `CraftItem_RuneforgingCatastrophe_SetsResultCorruption` | Verifies CorruptionAdded is set in result |
| `CraftItem_RuneforgingSuccess_NoCorruptionAdded` | Success does not add Corruption |

#### Cross-Trade Tests (3 tests)
| Test Name | Description |
|-----------|-------------|
| `CraftItem_BodgingCatastrophe_NoDamageOrCorruption` | Bodging has no special catastrophe |
| `CraftItem_AlchemySuccess_CreatesPotionWithNoDamage` | Success causes no damage |
| `Recipe_CatastropheType_DefaultsToNone` | Default catastrophe type is None |

#### Recipe Validation Tests (2 tests)
| Test Name | Description |
|-----------|-------------|
| `Recipe_AlchemyRecipes_HaveExplosiveCatastrophe` | All Alchemy recipes have Explosive type |
| `Recipe_RuneforgingRecipes_HaveCorruptionCatastrophe` | All Runeforging recipes have Corruption type |

---

## DI Registration

No new DI registrations required. ITraumaService already registered in Program.cs from v0.3.0b.

---

## Build Verification

```
Build succeeded.
    0 Error(s)

Unit Test run (excludes integration tests):
  Passed: 1567
  Failed: 0
  Skipped: 0

Note: 137 integration tests require a running PostgreSQL database.
Run with: dotnet test --filter "FullyQualifiedName!~Integration"
```

---

## Directory Structure After v0.3.1c

```
RuneAndRust/
├── RuneAndRust.Core/
│   ├── Data/
│   │   └── RecipeRegistry.cs                    [MODIFIED - catastrophe data]
│   ├── Entities/
│   │   ├── Item.cs                              [MODIFIED - Properties]
│   │   ├── ItemProperty.cs                      [NEW]
│   │   ├── Recipe.cs                            [MODIFIED - catastrophe fields]
│   │   └── ... (existing entities)
│   ├── Enums/
│   │   ├── CatastropheType.cs                   [NEW]
│   │   └── ... (existing enums)
│   └── Models/
│       └── Crafting/
│           ├── CraftingResult.cs                [MODIFIED - new fields]
│           └── ... (existing models)
├── RuneAndRust.Engine/
│   └── Services/
│       ├── CraftingService.cs                   [MODIFIED - catastrophe logic]
│       ├── CommandParser.cs                     [MODIFIED - brew/forge commands]
│       └── ... (existing services)
├── RuneAndRust.Tests/
│   └── Engine/
│       ├── CraftingServiceTests.cs              [MODIFIED - 12 new tests]
│       └── ... (existing tests)
└── docs/
    └── changelogs/
        ├── v0.3.1a.md
        ├── v0.3.1b.md
        └── v0.3.1c.md                           [NEW]
```

---

## Dependencies

### Service Dependencies
| Service | Depends On |
|---------|------------|
| CraftingService | IDiceService, IInventoryService, IItemRepository, ITraumaService, ILogger |

### Existing Infrastructure Used
| Component | Usage |
|-----------|-------|
| ITraumaService | AddCorruption() for Runeforging catastrophe |
| Character.CurrentHP | HP reduction for Alchemy catastrophe |
| Character.Corruption | Corruption tracking (0-100) |
| CraftingOutcome | Reused for outcome determination |

---

## Test Summary by Category

| Category | Test Count |
|----------|------------|
| CraftingServiceTests - Alchemy Catastrophe | 4 |
| CraftingServiceTests - Runeforging Catastrophe | 3 |
| CraftingServiceTests - Cross-Trade | 3 |
| CraftingServiceTests - Recipe Validation | 2 |
| **v0.3.1c New Tests** | **12** |
| **Total** | **1704** |

---

## Running Tests

```bash
# Run all tests
dotnet test RuneAndRust.Tests

# Run only v0.3.1c new tests (catastrophe-related)
dotnet test RuneAndRust.Tests --filter "FullyQualifiedName~CraftingServiceTests&FullyQualifiedName~Catastrophe"

# Run all crafting service tests
dotnet test RuneAndRust.Tests --filter "FullyQualifiedName~CraftingServiceTests"

# Run non-integration tests only
dotnet test RuneAndRust.Tests --filter "FullyQualifiedName!~Integration"
```

---

## Migration Notes

- **No database migrations required**: All new properties have defaults and are in-memory state
- **Existing recipes unaffected**: CatastropheType defaults to None (no special effect)
- **TraumaService integration**: Uses existing AddCorruption() method from v0.3.0b
- **Backward compatible**: Existing crafting continues to work unchanged

---

## Next Steps (v0.3.1d: Runeforging Enchantment)

Potential features for the next sub-release:
- Runeforging target item enchantment (apply OutputProperties to equipment)
- ItemProperty persistence to database
- Property stacking and conflict resolution
- Visual indicators for enchanted items in inventory
- Equipment bonuses from ItemProperty.StatModifiers

---

## Catastrophe Damage Reference

### Alchemy Recipes
| Recipe | Base DC | Catastrophe Damage |
|--------|---------|-------------------|
| Basic Stimulant | 3 | 5 HP |
| Crude Antitoxin | 4 | 8 HP |
| Alchemist Fire | 5 | 15 HP |

### Runeforging Recipes
| Recipe | Base DC | Catastrophe Corruption |
|--------|---------|----------------------|
| Glow Stone | 2 | 3 Corruption |
| Minor Ward Token | 4 | 5 Corruption |
| Runic Battery | 5 | 8 Corruption |
