# v0.14.7a Changelog: Sensory Descriptor Schema

**Version:** 0.14.7a
**Phase:** Sensory Descriptor Schema (Master Descriptor Configuration Schema)
**Date:** 2026-01-21
**Status:** ✅ Complete

---

## Summary

Implements the Sensory Descriptor Schema (`descriptors.schema.json`), which serves as the master JSON schema for all text descriptor configuration files. This schema validates pool structure, weighted selection, context tags, theme tags, and variable substitution patterns used throughout the game's descriptive text system.

The Sensory Descriptor Schema validates 17 existing descriptor configuration files including combat-hits, combat-deaths, environmental, weather, and ambient-events. It establishes the foundational patterns that will be extended by combat-descriptors (v0.14.7b) and environment-descriptors (v0.14.7c) schemas.

---

## Added

### Configuration Files - Schema

| File | Description |
|------|-------------|
| `config/schemas/descriptors.schema.json` | Master JSON Schema for all descriptor configuration files |

### Schema Definitions

| Definition | Type | Description |
|------------|------|-------------|
| `DescriptorPool` | Object | Pool of related text descriptors with id, name, and descriptors array |
| `Descriptor` | Object | Single text entry with selection parameters (weight, tags, themes, conditions) |
| `VariablePattern` | Object | Documentation for variable substitution syntax |

### DescriptorPool Properties

| Property | Type | Required | Description |
|----------|------|----------|-------------|
| `id` | string | Yes | Pool identifier (lowercase with underscores, pattern: `^[a-z][a-z0-9_]*$`) |
| `name` | string | Yes | Human-readable display name |
| `description` | string | No | Optional description of pool's purpose |
| `descriptors` | array | Yes | Array of Descriptor objects (minItems: 1) |

### Descriptor Properties

| Property | Type | Required | Default | Description |
|----------|------|----------|---------|-------------|
| `id` | string | Yes | - | Descriptor identifier (lowercase with underscores) |
| `text` | string | Yes | - | Descriptive text content (may contain {variable} placeholders) |
| `weight` | integer | No | 100 | Selection weight for probability (minimum: 1) |
| `tags` | string[] | No | - | Context filter tags (location, biome, mood) |
| `themes` | string[] | No | - | Genre/mood filter tags (dark_fantasy, horror) |
| `minDamagePercent` | number | No | - | Minimum damage percentage (0-1) |
| `maxDamagePercent` | number | No | - | Maximum damage percentage (0-1) |
| `minHealthPercent` | number | No | - | Minimum health percentage (0-1) |
| `maxHealthPercent` | number | No | - | Maximum health percentage (0-1) |
| `variables` | string[] | No | - | Documents variable placeholders in text |
| `fallbackId` | string | No | - | Alternative descriptor ID if conditions not met |

### Root Schema Properties

| Property | Type | Required | Description |
|----------|------|----------|-------------|
| `$schema` | string | No | Reference to schema file |
| `version` | string | No | Configuration file version |
| `category` | string | Yes | Category identifier (kebab-case, pattern: `^[a-z][a-z0-9-]*$`) |
| `pools` | object | Yes | Descriptor pools (minProperties: 1) |

### ID Pattern Conventions

| ID Type | Pattern | Format | Examples |
|---------|---------|--------|----------|
| Category | `^[a-z][a-z0-9-]*$` | kebab-case | combat-hits, environmental, ambient-events |
| Pool ID | `^[a-z][a-z0-9_]*$` | snake_case | hit_sword, death_humanoid, lighting |
| Descriptor ID | `^[a-z][a-z0-9_]*$` | snake_case | slashes_across, dim_torch, falls_battle |

### Context Tags (Documentation)

| Category | Example Tags | Use Case |
|----------|--------------|----------|
| Location | indoor, outdoor, underground, underwater | Filter by area type |
| Biome | cave, dungeon, forest, swamp, volcanic, frozen | Filter by environment |
| Mood | danger, safe, atmospheric, magical | Filter by situation |
| Type | creature, natural, supernatural | Filter by source |

### Theme Tags (Documentation)

| Theme | Description | Typical Use |
|-------|-------------|-------------|
| `dark_fantasy` | Grim, mature tone | Default game setting |
| `high_fantasy` | Heroic, bright tone | Alternative mood |
| `horror` | Scary, unsettling | Fear-focused areas |

### Variable Substitution (Documentation)

| Variable | Context | Example Value |
|----------|---------|---------------|
| `{player}` | Combat, death | "John" |
| `{killer}` | Death | "the Goblin" |
| `{target}` | Combat | "the Skeleton" |
| `{weapon}` | Combat | "Iron Sword" |
| `{damage}` | Combat | "15" |
| `{attacker}` | Combat | "the Orc" |

---

## Modified

### Configuration Files - Descriptors

| File | Change |
|------|--------|
| `config/descriptors/combat-hits.json` | Added `$schema` reference to descriptors.schema.json |
| `config/descriptors/environmental.json` | Added `$schema` reference to descriptors.schema.json |

---

## Unit Tests

### Schema Structure Tests (DSC-001)

| Test | Description |
|------|-------------|
| `Schema_IsValidJsonSchemaDraft07` | Validates schema structure, title, and all 3 definitions |

### Pool Structure Tests (DSC-002)

| Test | Description |
|------|-------------|
| `Pool_EmptyDescriptorsArray_FailsValidation` | Verifies minItems: 1 constraint on descriptors |
| `Pool_UnknownProperty_FailsValidation` | Verifies additionalProperties: false |
| `Pools_Empty_FailsValidation` | Verifies minProperties: 1 on pools |

### Descriptor Structure Tests (DSC-003)

| Test | Description |
|------|-------------|
| `Descriptor_MinimalConfiguration_PassesValidation` | Minimal valid descriptor (id + text only) |
| `Descriptor_MissingId_FailsValidation` | Verifies id is required |
| `Descriptor_MissingText_FailsValidation` | Verifies text is required |

### Weight Validation Tests (DSC-004)

| Test | Description |
|------|-------------|
| `Weight_Zero_FailsValidation` | Verifies minimum: 1 constraint |
| `Weight_Negative_FailsValidation` | Verifies positive integer required |
| `Weight_Fractional_FailsValidation` | Verifies integer type (not number) |

### Percentage Range Tests (DSC-005)

| Test | Description |
|------|-------------|
| `MinDamagePercent_AboveMaximum_FailsValidation` | Verifies maximum: 1 constraint |
| `MaxDamagePercent_BelowMinimum_FailsValidation` | Verifies minimum: 0 constraint |
| `MaxHealthPercent_AboveMaximum_FailsValidation` | Verifies health percent 0-1 range |
| `PercentageValues_WithinRange_PassValidation` | Valid percentage values pass |

### ID Pattern Tests (DSC-006)

| Test | Description |
|------|-------------|
| `Category_WithUnderscore_FailsValidation` | Category must use hyphens (kebab-case) |
| `Category_WithUppercase_FailsValidation` | Category must be lowercase |
| `PoolId_WithHyphen_FailsValidation` | Pool ID must use underscores (snake_case) |
| `DescriptorId_WithUppercase_FailsValidation` | Descriptor ID must be lowercase |

### Backward Compatibility Tests

| Test | Description |
|------|-------------|
| `CombatHitsJson_ValidatesAgainstSchema` | Existing combat-hits.json (11 pools) validates |
| `EnvironmentalJson_ValidatesAgainstSchema` | Existing environmental.json (4 pools) validates |

### Complete Configuration Tests

| Test | Description |
|------|-------------|
| `CompleteConfiguration_AllOptionalFields_PassesValidation` | All optional fields together |

**Total Tests:** 19

---

## Files Created

| Path | Description |
|------|-------------|
| `config/schemas/descriptors.schema.json` | Master JSON Schema for descriptor validation |
| `tests/.../Schemas/DescriptorsSchemaTests.cs` | Unit tests for schema validation |
| `docs/changelogs/v0.14.7a-changelog.md` | This changelog |

## Files Modified

| Path | Description |
|------|-------------|
| `config/descriptors/combat-hits.json` | Added $schema reference |
| `config/descriptors/environmental.json` | Added $schema reference |
| `docs/design/v0.14.x/v0.14.7-scope-breakdown.md` | Updated v0.14.7a acceptance criteria |

---

## Schema Validation Rules

### Validation Summary

| Rule | Constraint | Error Message |
|------|------------|---------------|
| Category required | required: ["category", "pools"] | Missing required property 'category' |
| Category pattern | `^[a-z][a-z0-9-]*$` | 'category' does not match pattern |
| Pools not empty | minProperties: 1 | 'pools' must have at least 1 property |
| Pool ID pattern | `^[a-z][a-z0-9_]*$` | 'id' does not match pattern |
| Descriptors not empty | minItems: 1 | 'descriptors' must have at least 1 item |
| Descriptor ID pattern | `^[a-z][a-z0-9_]*$` | 'id' does not match pattern |
| Text required | required: ["id", "text"] | Missing required property 'text' |
| Weight minimum | minimum: 1 | 'weight' must be >= 1 |
| Weight type | type: integer | 'weight' must be integer |
| Percentage range | minimum: 0, maximum: 1 | '{field}' value outside valid range |
| No unknown properties | additionalProperties: false | Additional properties not allowed |

---

## Weight System

### Weight Calculation

```
totalWeight = sum of all descriptor weights in pool
probability(descriptor) = descriptor.weight / totalWeight
```

### Typical Weight Values

| Weight | Use Case | Selection Frequency |
|--------|----------|---------------------|
| 10-15 | Rare/dramatic text | Low |
| 20-25 | Common text | Medium |
| 30-35 | Very common text | High |
| 100 | Default equal weight | Baseline |

---

## v0.14.7 Progress

| Version | Feature | Status |
|---------|---------|--------|
| v0.14.7a | Sensory Descriptor Schema | ✅ Complete |
| v0.14.7b | Combat Descriptor Schema | Pending |
| v0.14.7c | Environment Descriptor Schema | Pending |

---

## Dependencies

### Required From Prior Versions

| Version | Dependency | Usage |
|---------|------------|-------|
| v0.14.6 | Audio Configuration Schemas | Schema infrastructure patterns |
| Existing | `config/descriptors/*.json` | Configuration files to validate |

### Provides To Future Versions

| Version | Consumer | Usage |
|---------|----------|-------|
| v0.14.7b | Combat Descriptor Schema | Base schema for extension via allOf |
| v0.14.7c | Environment Descriptor Schema | Base schema for extension via allOf |
| Future | DescriptorService | Descriptor data loading and validation |
| Future | CombatService | Hit/death text selection |
| Future | EnvironmentService | Atmosphere text selection |

---

## Key Design Decisions

1. **additionalProperties Pattern** - Pools use additionalProperties to allow flexible pool naming while enforcing pool structure
2. **Dual ID Patterns** - Category uses kebab-case (file naming) while pool/descriptor IDs use snake_case (property keys)
3. **Weight Default** - Weight defaults to 100 for equal probability baseline
4. **Percentage Normalization** - All percentage values normalized to 0-1 range (not 0-100)
5. **No Unknown Properties** - additionalProperties: false on pools and descriptors prevents typos
6. **Variable Documentation** - variables array documents placeholders for tooling support
7. **Schema Extension Ready** - Designed for extension via allOf in v0.14.7b/c

---

## Logging Specifications

| Level | Event | Message |
|-------|-------|---------|
| INFO | Schema loaded | `Descriptor schema loaded from {path}` |
| DEBUG | Validation success | `Descriptor file validated ({category}: {poolCount} pools, {descriptorCount} descriptors)` |
| ERROR | Validation failure | `Descriptor configuration validation failed: {errors}` |
| WARN | Invalid pattern | `Descriptor {poolId}/{descriptorId}: ID does not match pattern` |
| WARN | Invalid weight | `Descriptor {poolId}/{descriptorId}: weight must be positive integer` |
| WARN | Invalid range | `Descriptor {poolId}/{descriptorId}: {field} value {value} outside valid range` |

---

## Notes

- Schema follows JSON Schema Draft-07 specification
- All 17 existing descriptor files should validate against this schema
- The schema is self-contained with no external references
- Future versions (v0.14.7b, v0.14.7c) will extend this schema using allOf
- Variable substitution is runtime concern; schema only documents expected variables
- Fallback resolution is runtime concern; schema only validates ID pattern
