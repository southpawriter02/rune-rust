# Changelog: v0.0.3 - The Loop (Input/Output Pipeline)

**Release Date:** December 18, 2025
**Total Tests:** 168 (82 new tests added)

## Table of Contents

- [Summary](#summary)
- [New Features](#new-features)
- [Files Created](#files-created)
- [Files Modified](#files-modified)
- [Complete Test Inventory](#complete-test-inventory)
- [Test Summary by Category](#test-summary-by-category)
- [Build Verification](#build-verification)
- [Directory Structure After v0.0.3](#directory-structure-after-v003)
- [Commands Reference](#commands-reference)
- [Usage Example](#usage-example)
- [Next Steps (v0.0.4)](#next-steps-v004)

---

## Summary

Version 0.0.3 transforms the static application into an **interactive state machine** that accepts user input, parses commands, and updates game state until the player quits. This release implements the core game loop architecture with phase-based command handling.

---

## New Features

### Game State Machine
- **GamePhase Enum**: Four distinct phases (MainMenu, Exploration, Combat, Quit)
- **GameState Class**: Central state container with phase tracking, character reference, turn counter, and session status
- **Phase Transitions**: Validated state transitions between game phases

### Command Processing
- **CommandParser Service**: Phase-aware command parsing with extensive command aliases
- **Case-insensitive Input**: All commands accept any case variation
- **Whitespace Handling**: Leading/trailing whitespace automatically trimmed

### Input/Output Abstraction
- **IInputHandler Interface**: Decouples game logic from terminal I/O
- **TerminalInputHandler**: Spectre.Console implementation with styled prompts
- **Phase-specific Prompts**: Visual indicators for current game phase

---

## Files Created

### Core Layer

#### `RuneAndRust.Core/Enums/GamePhase.cs`
Game phase state enumeration:
```csharp
public enum GamePhase
{
    MainMenu = 0,    // Initial state, game menu
    Exploration = 1, // Active gameplay exploration
    Combat = 2,      // Combat encounter
    Quit = 3         // Exit state
}
```

#### `RuneAndRust.Core/Models/GameState.cs`
Central game state container:
- `Phase` - Current GamePhase (default: MainMenu)
- `CurrentCharacter` - Active character reference (nullable)
- `TurnCount` - Number of exploration turns taken
- `IsSessionActive` - Whether a game session is in progress
- `Reset()` - Restores all properties to defaults

#### `RuneAndRust.Core/Interfaces/IInputHandler.cs`
Input/output abstraction interface:
```csharp
public interface IInputHandler
{
    string GetInput(string prompt);
    void DisplayMessage(string message);
    void DisplayError(string message);
}
```

### Engine Layer

#### `RuneAndRust.Engine/Services/CommandParser.cs`
Phase-aware command processor with:

**MainMenu Commands:**
| Command | Aliases | Action |
|---------|---------|--------|
| start | new, play | Begin new game → Exploration |
| quit | exit, q | Exit application → Quit |
| help | ? | Display MainMenu help |

**Exploration Commands:**
| Command | Aliases | Action |
|---------|---------|--------|
| look | l | Observe surroundings (increments turn) |
| status | stats | Display current game status |
| menu | mainmenu | Return to MainMenu |
| quit | exit, q | Exit application → Quit |
| help | ? | Display Exploration help |

**Combat Commands:**
| Command | Aliases | Action |
|---------|---------|--------|
| flee | run | Escape combat → Exploration |
| quit | exit, q | Exit application → Quit |
| help | ? | Display Combat help |

**Logging Matrix:**
| Event | Level | Template |
|-------|-------|----------|
| Parse entry | Debug | `"Parsing command '{Command}' in phase {Phase}"` |
| Start game | Information | `"Starting new game session"` |
| Quit game | Information | `"Player quit the game"` |
| Phase change | Information | `"Phase changed from {OldPhase} to {NewPhase}"` |
| Unknown command | Warning | `"Unknown command '{Command}' in phase {Phase}"` |

### Terminal Layer

#### `RuneAndRust.Terminal/Services/TerminalInputHandler.cs`
Spectre.Console implementation:
- Styled input prompts with phase indicators
- Green messages for normal output
- Red error messages for invalid commands
- ASCII art welcome banner

**Prompt Styles:**
- MainMenu: `[yellow][MENU][/] > `
- Exploration: `[cyan][EXPLORE][/] > `
- Combat: `[red][COMBAT][/] > `

### Test Layer

#### `RuneAndRust.Tests/Core/GamePhaseTests.cs`
Enum validation tests (9 tests):
- Value count validation
- Individual value existence tests
- Sequential numbering verification
- ToString() behavior tests
- Integer conversion tests
- Default value verification

#### `RuneAndRust.Tests/Core/GameStateTests.cs`
State management tests (23 tests):
- Default value tests for all properties
- Property setter tests
- Reset() method tests (individual and combined)
- Phase transition tests (all valid phases)
- TurnCount behavior (increment, negative values)
- Character association tests

#### `RuneAndRust.Tests/Engine/CommandParserTests.cs`
Command parsing tests (32 tests):
- Empty/null/whitespace input handling
- MainMenu phase commands (start, quit, help, unknown)
- Exploration phase commands (quit, menu, help, look, status, unknown)
- Combat phase commands (quit, flee, help, unknown)
- Logging verification (Debug, Information levels)
- Case insensitivity tests
- Turn count reset on new game

#### `RuneAndRust.Tests/Engine/GameLoopTests.cs`
Integration tests (18 tests):
- Basic loop tests (quit, start-quit sequences)
- Phase transition tests (full game cycle)
- Invalid input handling
- Empty input handling
- Help command tests (MainMenu, Exploration)
- State persistence tests (turn count)
- Prompt tests (phase-specific prompts)

---

## Files Modified

### `RuneAndRust.Engine/Services/GameService.cs`
Updated with game loop implementation:
- New constructor: `GameService(ILogger, IInputHandler, CommandParser, GameState)`
- `Start()` method with while loop until Quit phase
- Welcome and farewell messages
- Phase-specific prompt selection
- Empty input filtering

### `RuneAndRust.Terminal/Program.cs`
New DI registrations:
```csharp
services.AddSingleton<GameState>();
services.AddSingleton<IInputHandler, TerminalInputHandler>();
services.AddSingleton<CommandParser>();
```

### `RuneAndRust.Tests/Engine/GameServiceTests.cs`
Updated for new GameService constructor:
- Mock IInputHandler injection
- CommandParser integration
- GameState injection
- Input simulation for quit sequence

---

## Complete Test Inventory

### Core/GamePhaseTests.cs (9 tests)
| Test Name | Description |
|-----------|-------------|
| `GamePhase_ShouldHaveExactlyFourValues` | Validates enum has 4 values |
| `GamePhase_ShouldContain_MainMenu` | MainMenu value exists |
| `GamePhase_ShouldContain_Exploration` | Exploration value exists |
| `GamePhase_ShouldContain_Combat` | Combat value exists |
| `GamePhase_ShouldContain_Quit` | Quit value exists |
| `GamePhase_EnumValues_ShouldBeSequential` | Values are 0,1,2,3 |
| `GamePhase_ToString_ReturnsExpectedName` | ToString returns name (4 cases) |
| `GamePhase_FromInt_ReturnsCorrectPhase` | Cast from int works (4 cases) |
| `GamePhase_DefaultValue_ShouldBeMainMenu` | default(GamePhase) is MainMenu |

### Core/GameStateTests.cs (23 tests)
| Test Name | Description |
|-----------|-------------|
| `GameState_DefaultPhase_ShouldBeMainMenu` | Default phase is MainMenu |
| `GameState_DefaultCurrentCharacter_ShouldBeNull` | Default character is null |
| `GameState_DefaultTurnCount_ShouldBeZero` | Default turn count is 0 |
| `GameState_DefaultIsSessionActive_ShouldBeFalse` | Default session inactive |
| `GameState_Phase_CanBeSet` | Phase property settable |
| `GameState_CurrentCharacter_CanBeSet` | Character property settable |
| `GameState_TurnCount_CanBeSet` | TurnCount property settable |
| `GameState_IsSessionActive_CanBeSet` | IsSessionActive settable |
| `Reset_ShouldSetPhaseToMainMenu` | Reset restores MainMenu |
| `Reset_ShouldSetCurrentCharacterToNull` | Reset clears character |
| `Reset_ShouldSetTurnCountToZero` | Reset clears turn count |
| `Reset_ShouldSetIsSessionActiveToFalse` | Reset deactivates session |
| `Reset_ShouldResetAllProperties` | Reset restores all defaults |
| `GameState_Phase_CanBeSetToAnyValidPhase` | All phases settable (4 cases) |
| `TurnCount_CanIncrement` | TurnCount++ works |
| `TurnCount_CanBeNegative` | Negative values allowed |
| `CurrentCharacter_WhenSet_ShouldRetainCharacterProperties` | Character data preserved |
| `CurrentCharacter_CanBeReassigned` | Character can be changed |

### Engine/CommandParserTests.cs (32 tests)
| Test Name | Description |
|-----------|-------------|
| `Constructor_WithValidDependencies_ShouldNotThrow` | Valid construction |
| `ParseAndExecute_EmptyInput_ShouldNotChangeState` | Empty string ignored |
| `ParseAndExecute_WhitespaceInput_ShouldNotChangeState` | Whitespace ignored |
| `ParseAndExecute_NullInput_ShouldNotChangeState` | Null input safe |
| `ParseAndExecute_MainMenu_StartCommands_ShouldTransitionToExploration` | start/new/play → Exploration (6 cases) |
| `ParseAndExecute_MainMenu_QuitCommands_ShouldTransitionToQuit` | quit/exit/q → Quit (4 cases) |
| `ParseAndExecute_MainMenu_HelpCommands_ShouldDisplayHelp` | help/? displays help (2 cases) |
| `ParseAndExecute_MainMenu_UnknownCommand_ShouldDisplayError` | Unknown shows error |
| `ParseAndExecute_MainMenu_Start_ShouldResetTurnCount` | New game resets turns |
| `ParseAndExecute_Exploration_QuitCommands_ShouldTransitionToQuit` | quit/exit/q → Quit (3 cases) |
| `ParseAndExecute_Exploration_MenuCommands_ShouldReturnToMainMenu` | menu/mainmenu → MainMenu (2 cases) |
| `ParseAndExecute_Exploration_HelpCommands_ShouldDisplayHelp` | help/? displays help (2 cases) |
| `ParseAndExecute_Exploration_LookCommands_ShouldIncrementTurn` | look/l increments turn (2 cases) |
| `ParseAndExecute_Exploration_StatusCommands_ShouldDisplayStatus` | status/stats shows status (2 cases) |
| `ParseAndExecute_Exploration_UnknownCommand_ShouldDisplayError` | Unknown shows error |
| `ParseAndExecute_Combat_QuitCommands_ShouldTransitionToQuit` | quit/exit/q → Quit (3 cases) |
| `ParseAndExecute_Combat_FleeCommands_ShouldReturnToExploration` | flee/run → Exploration (2 cases) |
| `ParseAndExecute_Combat_HelpCommands_ShouldDisplayHelp` | help/? displays help (2 cases) |
| `ParseAndExecute_Combat_UnknownCommand_ShouldDisplayError` | Unknown shows error |
| `ParseAndExecute_ShouldLogDebug_WhenParsingCommand` | Debug log on parse |
| `ParseAndExecute_ShouldLogInformation_WhenStartingGame` | Info log on start |
| `ParseAndExecute_ShouldLogInformation_WhenQuitting` | Info log on quit |
| `ParseAndExecute_ShouldBeCaseInsensitiveAndTrimWhitespace` | Case/whitespace handling (4 cases) |

### Engine/GameLoopTests.cs (18 tests)
| Test Name | Description |
|-----------|-------------|
| `Start_InputQuit_ShouldExitLoopImmediately` | Single quit exits |
| `Start_InputStartThenQuit_ShouldTransitionPhases` | start → quit sequence |
| `Start_InputStartExploreQuit_ShouldProcessMultipleCommands` | Multiple commands processed |
| `Start_FullGameCycle_ShouldTransitionCorrectly` | MainMenu → Exploration → MainMenu → Quit |
| `Start_MainMenuToExploration_ShouldSetSessionActive` | Session activated on start |
| `Start_InvalidCommands_ShouldNotExitLoop` | Invalid commands don't crash |
| `Start_EmptyInputs_ShouldBeIgnored` | Empty inputs skipped |
| `Start_HelpInMainMenu_ShouldStayInMainMenu` | Help doesn't change phase |
| `Start_HelpInExploration_ShouldStayInExploration` | Help doesn't change phase |
| `Start_TurnCount_ShouldPersistAcrossCommands` | Turns accumulate |
| `Start_NewGame_ShouldResetTurnCount` | New game resets turns |
| `Start_InMainMenu_ShouldShowMenuPrompt` | [MENU] prompt shown |
| `Start_InExploration_ShouldShowExplorePrompt` | [EXPLORE] prompt shown |

### Engine/GameServiceTests.cs (5 tests)
| Test Name | Description |
|-----------|-------------|
| `Start_ShouldLogGameLoopInitializedMessage` | Logs initialization |
| `Start_ShouldLogGameLoopEndedMessage` | Logs shutdown |
| `Constructor_WithValidDependencies_ShouldNotThrow` | Valid construction |
| `Start_ShouldDisplayWelcomeMessage` | Welcome message shown |
| `Start_ShouldDisplayFarewellMessage` | Farewell message shown |

---

## Test Summary by Category

| Category | Test Count |
|----------|------------|
| Core/AttributeTests | 12 |
| Core/CharacterTests | 10 |
| Core/GamePhaseTests | 9 |
| Core/GameStateTests | 23 |
| Engine/CommandParserTests | 32 |
| Engine/DiceServiceTests | 24 |
| Engine/GameLoopTests | 18 |
| Engine/GameServiceTests | 5 |
| Engine/StatCalculationServiceTests | 35 |
| **Total** | **168** |

---

## Build Verification

```
Build succeeded.
    0 Warning(s)
    0 Error(s)

Test run:
  Passed: 168
  Failed: 0
  Skipped: 0
```

---

## Directory Structure After v0.0.3

```
RuneAndRust/
├── RuneAndRust.Core/
│   ├── Enums/
│   │   ├── Attribute.cs
│   │   └── GamePhase.cs           # NEW
│   ├── Interfaces/
│   │   ├── IDiceService.cs
│   │   ├── IGameService.cs
│   │   ├── IInputHandler.cs       # NEW
│   │   └── IStatCalculationService.cs
│   └── Models/
│       ├── Character.cs
│       └── GameState.cs           # NEW
├── RuneAndRust.Engine/
│   └── Services/
│       ├── CommandParser.cs       # NEW
│       ├── DiceService.cs
│       ├── GameService.cs         # MODIFIED
│       └── StatCalculationService.cs
├── RuneAndRust.Terminal/
│   ├── Program.cs                 # MODIFIED
│   └── Services/
│       └── TerminalInputHandler.cs # NEW
├── RuneAndRust.Tests/
│   ├── Core/
│   │   ├── AttributeTests.cs
│   │   ├── CharacterTests.cs
│   │   ├── GamePhaseTests.cs      # NEW
│   │   └── GameStateTests.cs      # NEW
│   └── Engine/
│       ├── CommandParserTests.cs  # NEW
│       ├── DiceServiceTests.cs
│       ├── GameLoopTests.cs       # NEW
│       ├── GameServiceTests.cs    # MODIFIED
│       └── StatCalculationServiceTests.cs
└── docs/
    └── changelogs/
        ├── v0.0.2.md
        └── v0.0.3.md              # NEW
```

---

## Commands Reference

### MainMenu Phase
```
start, new, play  - Begin a new game session
quit, exit, q     - Exit the application
help, ?           - Display available commands
```

### Exploration Phase
```
look, l           - Observe your surroundings
status, stats     - Display current game status
menu, mainmenu    - Return to main menu
quit, exit, q     - Exit the application
help, ?           - Display available commands
```

### Combat Phase
```
flee, run         - Attempt to escape combat
quit, exit, q     - Exit the application
help, ?           - Display available commands
```

---

## Usage Example

```bash
# Run the game
dotnet run --project RuneAndRust.Terminal

# Output:
╔════════════════════════════════════════╗
║       Welcome to Rune & Rust           ║
║    A Post-Apocalyptic Text Adventure   ║
╚════════════════════════════════════════╝
[MENU] > start
Entering the world of Rune & Rust...
[EXPLORE] > look
You observe your surroundings carefully...
[EXPLORE] > status
═══════ STATUS ═══════
Turn: 1
═══════════════════════
[EXPLORE] > quit
Farewell, traveler!
```

---

## Next Steps (v0.0.4)

Potential features for the next release:
- Character creation flow during "start" command
- Movement commands (north, south, east, west)
- Basic combat system with attack command
- Inventory management
- Save/Load game state
