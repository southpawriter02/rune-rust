# v0.16.1d Design Specification: Character Proficiency Tracking

**Version:** 0.16.1d  
**Phase Name:** Character Proficiency Tracking  
**Parent Version:** v0.16.1 (Weapon Proficiency System)  
**Prerequisites:** v0.16.1a Complete (Proficiency Level Enum), v0.16.1b Complete (Weapon Category System), v0.16.1c Complete (Archetype Proficiency Matrix)  
**Estimated Tests:** ~4 unit tests

---

## Table of Contents

1. [Executive Summary](#1-executive-summary)
2. [Feature Overview](#2-feature-overview)
3. [Architecture Diagrams](#3-architecture-diagrams)
4. [CharacterProficiencies Entity](#4-characterproficiencies-entity)
5. [ProficiencyProgress Value Object](#5-proficiencyprogress-value-object)
6. [Data Model Changes](#6-data-model-changes)
7. [Configuration File Schemas](#7-configuration-file-schemas)
8. [Logging Specifications](#8-logging-specifications)
9. [Unit Testing Requirements](#9-unit-testing-requirements)
10. [Use Cases](#10-use-cases)
11. [Deliverable Checklist](#11-deliverable-checklist)
12. [Acceptance Criteria](#12-acceptance-criteria)
13. [Dependencies](#13-dependencies)
14. [Future Considerations](#14-future-considerations)

---

## 1. Executive Summary

### 1.1 Purpose

This specification defines character-level proficiency tracking, enabling individual characters to track their current proficiency level and combat experience progress for each weapon category. Characters start with proficiencies based on their archetype and can advance through combat experience.

The three advancement thresholds are:

- **NonProficient → Proficient**: 10 combats with category
- **Proficient → Expert**: 25 combats with category
- **Expert → Master**: 50 combats with category

### 1.2 Key Deliverables

| Category          | Items                         |
| ----------------- | ----------------------------- |
| **Entities**      | `CharacterProficiencies`      |
| **Value Objects** | `ProficiencyProgress`         |
| **Configuration** | `proficiency-thresholds.json` |
| **Tests**         | ~4 unit tests                 |

### 1.3 Architectural Significance

This version establishes the **Character-Level Proficiency State Pattern**:

- **Per-Category Tracking**: Each character tracks proficiency level and progress for all 11 weapon categories
- **Experience-Based Advancement**: Combat usage incrementally advances proficiency
- **Threshold-Based Promotion**: Progress thresholds trigger level increases
- **State Encapsulation**: `CharacterProficiencies` entity manages all proficiency state

---

## 2. Feature Overview

```
v0.16.1d Character Proficiency Tracking
├── CharacterProficiencies Entity
│   ├── CharacterId: Guid
│   ├── Proficiencies: Dictionary<WeaponCategory, ProficiencyProgress>
│   ├── GetLevel(category): WeaponProficiencyLevel
│   ├── GetProgress(category): ProficiencyProgress
│   ├── CanAdvance(category): bool
│   └── Initialize from archetype matrix
├── ProficiencyProgress Value Object
│   ├── Category: WeaponCategory
│   ├── CurrentLevel: WeaponProficiencyLevel
│   ├── CombatExperience: int (combats using this category)
│   ├── ExperienceToNextLevel: int (remaining combats needed)
│   ├── IsAtMaxLevel: bool
│   └── CanAdvance: bool
└── Configuration: proficiency-thresholds.json
    ├── NonProficient → Proficient: 10 combats
    ├── Proficient → Expert: 25 combats
    └── Expert → Master: 50 combats
```

### 2.1 Scope Alignment

**In Scope:**

- `CharacterProficiencies` domain entity
- `ProficiencyProgress` domain value object
- Combat experience tracking (integer count per category)
- Experience thresholds configuration (10/25/50 combats)
- Initialization from archetype matrix (v0.16.1c)
- Proficiency level queries and progress checks

**Out of Scope:**

- Proficiency acquisition service (v0.16.1e)
- Combat integration and experience awarding (v0.16.1f)
- Alternative acquisition methods (training, PP purchase) (v0.16.1e)
- Proficiency effects application in combat (v0.16.1f)

---

## 3. Architecture Diagrams

### 3.1 Character Proficiency Tracking System Overview

```
┌─────────────────────────────────────────────────────────────────────┐
│           CHARACTER PROFICIENCY TRACKING SYSTEM OVERVIEW             │
└─────────────────────────────────────────────────────────────────────┘

    Character Creation
         │
         │  1. Select archetype (e.g., "warrior")
         ▼
┌─────────────────────────────────────────────────────────────────────┐
│              IArchetypeProficiencyProvider                           │
│                    (from v0.16.1c)                                   │
├─────────────────────────────────────────────────────────────────────┤
│  GetProficiencySet("warrior") → ArchetypeProficiencySet              │
│    ProficientCategories = [All 11 categories]                       │
└─────────────────────────────────────────────────────────────────────┘
         │
         │  2. Initialize character proficiencies
         ▼
┌─────────────────────────────────────────────────────────────────────┐
│                   CharacterProficiencies.Create()                    │
├─────────────────────────────────────────────────────────────────────┤
│  For each WeaponCategory:                                            │
│    IF archetype.IsProficientWith(category)                          │
│      → ProficiencyProgress(category, Proficient, 0 exp)             │
│    ELSE                                                              │
│      → ProficiencyProgress(category, NonProficient, 0 exp)          │
└─────────────────────────────────────────────────────────────────────┘
         │
         │  3. Store in character
         ▼
┌─────────────────────────────────────────────────────────────────────┐
│                      Character Entity                                │
├─────────────────────────────────────────────────────────────────────┤
│  Proficiencies: CharacterProficiencies                               │
│  └── Proficiencies: Dictionary<WeaponCategory, ProficiencyProgress>  │
│      ├─ Axes       → (Proficient, 0/25 exp to Expert)               │
│      ├─ Swords     → (Proficient, 0/25 exp to Expert)               │
│      ├─ Daggers    → (Proficient, 0/25 exp to Expert)               │
│      └─ ...                                                          │
└─────────────────────────────────────────────────────────────────────┘
         │
         │  4. Combat experience awarded (v0.16.1f)
         ▼
┌─────────────────────────────────────────────────────────────────────┐
│              Proficiency Acquisition Service                         │
│                    (v0.16.1e)                                        │
├─────────────────────────────────────────────────────────────────────┤
│  RecordCombatExperience(character, WeaponCategory.Swords)           │
│    → Increment CombatExperience                                     │
│    → Check if threshold reached                                     │
│    → Advance level if threshold met                                 │
└─────────────────────────────────────────────────────────────────────┘
```

### 3.2 Proficiency Advancement Flow

```
┌─────────────────────────────────────────────────────────────────────┐
│                  PROFICIENCY ADVANCEMENT FLOW                        │
└─────────────────────────────────────────────────────────────────────┘

    Character uses Sword in combat
         │
         ▼
    ┌──────────────────────────────────────────────────────────────────┐
    │  1. GET CURRENT PROGRESS                                          │
    ├──────────────────────────────────────────────────────────────────┤
    │  progress = character.Proficiencies.GetProgress(Swords)          │
    │    CurrentLevel = Proficient                                     │
    │    CombatExperience = 24                                         │
    │    ExperienceToNextLevel = 1 (25 required for Expert)            │
    └──────────────────────────────────────────────────────────────────┘
         │
         ▼
    ┌──────────────────────────────────────────────────────────────────┐
    │  2. AWARD COMBAT EXPERIENCE (v0.16.1e)                            │
    ├──────────────────────────────────────────────────────────────────┤
    │  acquisitionService.RecordCombatExperience(character, Swords)    │
    │    CombatExperience = 24 + 1 = 25                                │
    └──────────────────────────────────────────────────────────────────┘
         │
         ▼
    ┌──────────────────────────────────────────────────────────────────┐
    │  3. CHECK ADVANCEMENT THRESHOLD                                   │
    ├──────────────────────────────────────────────────────────────────┤
    │  IF CombatExperience >= threshold[Proficient → Expert]           │
    │    25 >= 25? → TRUE                                              │
    │    → ADVANCE TO EXPERT                                           │
    └──────────────────────────────────────────────────────────────────┘
         │
         ▼
    ┌──────────────────────────────────────────────────────────────────┐
    │  4. UPDATE PROFICIENCY PROGRESS                                   │
    ├──────────────────────────────────────────────────────────────────┤
    │  Old: ProficiencyProgress(Swords, Proficient, 25 exp)            │
    │  New: ProficiencyProgress(Swords, Expert, 0 exp)                 │
    │  ExperienceToNextLevel = 50 (for Expert → Master)                │
    └──────────────────────────────────────────────────────────────────┘
         │
         ▼
    ┌──────────────────────────────────────────────────────────────────┐
    │  5. APPLY NEW PROFICIENCY EFFECTS (v0.16.1f)                      │
    ├──────────────────────────────────────────────────────────────────┤
    │  Get ProficiencyEffect for Expert level                          │
    │    AttackModifier = +1 (was 0)                                   │
    │    DamageModifier = 0                                            │
    │    UnlockedTechniques = Advanced                                 │
    │  → Character's sword attacks now have +1 bonus                   │
    └──────────────────────────────────────────────────────────────────┘
```

### 3.3 Experience Threshold Visualization

```
┌─────────────────────────────────────────────────────────────────────┐
│                 PROFICIENCY ADVANCEMENT THRESHOLDS                   │
└─────────────────────────────────────────────────────────────────────┘

NonProficient (0 exp)
    │
    │  ┌─────────────────────────────────────────────────────────┐
    │  │  10 combats with weapon category                        │
    │  │  Effect: -3 attack, -2 damage → baseline (0/0)         │
    │  │  Techniques: None → Basic                               │
    │  └─────────────────────────────────────────────────────────┘
    │
    ▼
Proficient (0 exp, need 25 for next)
    │
    │  ┌─────────────────────────────────────────────────────────┐
    │  │  25 combats with weapon category                        │
    │  │  Effect: 0 attack → +1 attack                          │
    │  │  Techniques: Basic → Advanced                           │
    │  └─────────────────────────────────────────────────────────┘
    │
    ▼
Expert (0 exp, need 50 for next)
    │
    │  ┌─────────────────────────────────────────────────────────┐
    │  │  50 combats with weapon category                        │
    │  │  Effect: +1 attack → +2 attack, +1 damage              │
    │  │  Techniques: Advanced → Signature                       │
    │  └─────────────────────────────────────────────────────────┘
    │
    ▼
Master (MAX LEVEL)


TOTAL COMBATS TO MAX OUT A CATEGORY:
  NonProficient → Proficient:  10 combats
  Proficient → Expert:         25 combats
  Expert → Master:             50 combats
  ────────────────────────────────────────
  TOTAL:                       85 combats

NOTES:
- Experience thresholds are cumulative at each level
- Once Master is reached, no further advancement possible
- Starting proficiencies (from archetype) skip the first 10 combats
- Each combat with a weapon increments that category's experience by 1
```

### 3.4 Layer Diagram

```
┌─────────────────────────────────────────────────────────────────────┐
│                        PRESENTATION LAYER                            │
├─────────────────────────────────────────────────────────────────────┤
│  CharacterSheet                                                      │
│  └── Displays proficiency levels with progress bars                 │
│                                                                      │
│  ProficiencyProgressPanel                                            │
│  └── Shows "24/25 combats to Expert" for each category              │
└───────┬─────────────────────────────────────────────────────────────┘
        │
        ▼
┌─────────────────────────────────────────────────────────────────────┐
│                       APPLICATION LAYER                              │
├─────────────────────────────────────────────────────────────────────┤
│  ProficiencyAcquisitionService (v0.16.1e)                            │
│  └── Uses CharacterProficiencies to track and advance levels        │
│                                                                      │
│  CombatService (v0.16.1f)                                            │
│  └── Awards experience after combat, queries current levels         │
└───────┬─────────────────────────────────────────────────────────────┘
        │
        ▼
┌─────────────────────────────────────────────────────────────────────┐
│                         DOMAIN LAYER                                 │
├─────────────────────────────────────────────────────────────────────┤
│  ┌───────────────────────────────────────────────────────────────┐  │
│  │              CharacterProficiencies                            │  │
│  │                    (Entity)                                    │  │
│  ├───────────────────────────────────────────────────────────────┤  │
│  │  Id: Guid                                                      │  │
│  │  CharacterId: Guid                                             │  │
│  │  Proficiencies: Dictionary<WeaponCategory, ProficiencyProgress>│ │
│  │                                                               │  │
│  │  + GetLevel(category): WeaponProficiencyLevel                │  │
│  │  + GetProgress(category): ProficiencyProgress                │  │
│  │  + GetCombatExperience(category): int                        │  │
│  │  + CanAdvance(category): bool                                │  │
│  │  + IsAtMaxLevel(category): bool                              │  │
│  └───────────────────────────────────────────────────────────────┘  │
│                                                                      │
│  ┌───────────────────────────────────────────────────────────────┐  │
│  │              ProficiencyProgress                               │  │
│  │               (Value Object)                                   │  │
│  ├───────────────────────────────────────────────────────────────┤  │
│  │  Category: WeaponCategory                                      │  │
│  │  CurrentLevel: WeaponProficiencyLevel                          │  │
│  │  CombatExperience: int                                         │  │
│  │  ExperienceToNextLevel: int                                    │  │
│  │  ProgressPercentage: decimal                                   │  │
│  │  IsAtMaxLevel: bool                                            │  │
│  │  CanAdvance: bool                                              │  │
│  └───────────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────────┘
```

---

## 4. CharacterProficiencies Entity

### 4.1 Purpose

The `CharacterProficiencies` entity tracks all weapon category proficiencies for a single character. It stores current levels and combat experience for each category, providing queries and state management.

### 4.2 Implementation

**File:** `src/Core/RuneAndRust.Domain/Entities/CharacterProficiencies.cs`

```csharp
namespace RuneAndRust.Domain.Entities;

using RuneAndRust.Domain.Enums;
using RuneAndRust.Domain.Interfaces;
using RuneAndRust.Domain.ValueObjects;

/// <summary>
/// Tracks weapon category proficiency levels and progress for a character.
/// </summary>
/// <remarks>
/// <para>
/// CharacterProficiencies maintains the current proficiency state for all
/// weapon categories. It is initialized from the character's archetype
/// proficiency matrix and updated as the character gains combat experience.
/// </para>
/// <para>
/// Each category tracks both the current proficiency level and combat
/// experience progress toward the next level.
/// </para>
/// </remarks>
public class CharacterProficiencies : IEntity
{
    private readonly Dictionary<WeaponCategory, ProficiencyProgress> _proficiencies;

    /// <summary>
    /// Gets the unique identifier for this proficiency tracking entity.
    /// </summary>
    public Guid Id { get; private set; }

    /// <summary>
    /// Gets the character this proficiency state belongs to.
    /// </summary>
    public Guid CharacterId { get; private set; }

    /// <summary>
    /// Gets all proficiency progress entries.
    /// </summary>
    public IReadOnlyDictionary<WeaponCategory, ProficiencyProgress> Proficiencies =>
        _proficiencies;

    // Private constructor for EF Core
    private CharacterProficiencies()
    {
        _proficiencies = new Dictionary<WeaponCategory, ProficiencyProgress>();
    }

    /// <summary>
    /// Creates a new CharacterProficiencies entity from an archetype proficiency set.
    /// </summary>
    /// <param name="characterId">The character's unique identifier.</param>
    /// <param name="archetypeProficiencySet">The archetype proficiency matrix.</param>
    /// <param name="thresholds">Experience thresholds configuration.</param>
    /// <returns>Initialized CharacterProficiencies instance.</returns>
    /// <remarks>
    /// Characters start with Proficient level in archetype categories and
    /// NonProficient in all others. All categories start with 0 combat experience.
    /// </remarks>
    public static CharacterProficiencies CreateFromArchetype(
        Guid characterId,
        ArchetypeProficiencySet archetypeProficiencySet,
        ProficiencyThresholds thresholds)
    {
        ArgumentNullException.ThrowIfNull(archetypeProficiencySet);
        ArgumentNullException.ThrowIfNull(thresholds);

        var proficiencies = new CharacterProficiencies
        {
            Id = Guid.NewGuid(),
            CharacterId = characterId
        };

        // Initialize all weapon categories
        foreach (var category in Enum.GetValues<WeaponCategory>())
        {
            var startingLevel = archetypeProficiencySet.GetStartingLevel(category);
            var progress = ProficiencyProgress.Create(
                category,
                startingLevel,
                combatExperience: 0,
                thresholds);

            proficiencies._proficiencies[category] = progress;
        }

        return proficiencies;
    }

    /// <summary>
    /// Gets the current proficiency level for a weapon category.
    /// </summary>
    /// <param name="category">The weapon category.</param>
    /// <returns>The current proficiency level.</returns>
    public WeaponProficiencyLevel GetLevel(WeaponCategory category)
    {
        return _proficiencies.TryGetValue(category, out var progress)
            ? progress.CurrentLevel
            : WeaponProficiencyLevel.NonProficient;
    }

    /// <summary>
    /// Gets the full progress details for a weapon category.
    /// </summary>
    /// <param name="category">The weapon category.</param>
    /// <returns>The proficiency progress.</returns>
    /// <exception cref="ArgumentException">Thrown when category not found.</exception>
    public ProficiencyProgress GetProgress(WeaponCategory category)
    {
        if (!_proficiencies.TryGetValue(category, out var progress))
        {
            throw new ArgumentException(
                $"Proficiency not found for category: {category}",
                nameof(category));
        }

        return progress;
    }

    /// <summary>
    /// Gets the combat experience for a weapon category.
    /// </summary>
    /// <param name="category">The weapon category.</param>
    /// <returns>Number of combats using this category.</returns>
    public int GetCombatExperience(WeaponCategory category)
    {
        return _proficiencies.TryGetValue(category, out var progress)
            ? progress.CombatExperience
            : 0;
    }

    /// <summary>
    /// Checks if a category can advance to the next level.
    /// </summary>
    /// <param name="category">The weapon category.</param>
    /// <returns>True if not at max level, false otherwise.</returns>
    public bool CanAdvance(WeaponCategory category)
    {
        return _proficiencies.TryGetValue(category, out var progress)
            && progress.CanAdvance;
    }

    /// <summary>
    /// Checks if a category is at maximum proficiency level.
    /// </summary>
    /// <param name="category">The weapon category.</param>
    /// <returns>True if at Master level, false otherwise.</returns>
    public bool IsAtMaxLevel(WeaponCategory category)
    {
        return _proficiencies.TryGetValue(category, out var progress)
            && progress.IsAtMaxLevel;
    }

    /// <summary>
    /// Gets all categories at a specific proficiency level.
    /// </summary>
    /// <param name="level">The proficiency level to filter by.</param>
    /// <returns>Categories at the specified level.</returns>
    public IReadOnlyList<WeaponCategory> GetCategoriesAtLevel(
        WeaponProficiencyLevel level)
    {
        return _proficiencies
            .Where(kvp => kvp.Value.CurrentLevel == level)
            .Select(kvp => kvp.Key)
            .ToList()
            .AsReadOnly();
    }

    /// <summary>
    /// Gets the count of categories at a specific proficiency level.
    /// </summary>
    /// <param name="level">The proficiency level.</param>
    /// <returns>Number of categories at that level.</returns>
    public int GetCountAtLevel(WeaponProficiencyLevel level)
    {
        return _proficiencies.Count(kvp => kvp.Value.CurrentLevel == level);
    }

    /// <summary>
    /// Gets the total combat experience across all categories.
    /// </summary>
    public int GetTotalCombatExperience()
    {
        return _proficiencies.Values.Sum(p => p.CombatExperience);
    }

    /// <summary>
    /// Updates the proficiency progress for a category.
    /// </summary>
    /// <param name="category">The weapon category.</param>
    /// <param name="newProgress">The updated progress.</param>
    /// <remarks>
    /// This method is internal to domain logic. External advancement should
    /// go through IProficiencyAcquisitionService (v0.16.1e).
    /// </remarks>
    internal void UpdateProgress(WeaponCategory category, ProficiencyProgress newProgress)
    {
        ArgumentNullException.ThrowIfNull(newProgress);

        if (newProgress.Category != category)
        {
            throw new ArgumentException(
                $"Progress category mismatch. Expected {category}, got {newProgress.Category}",
                nameof(newProgress));
        }

        _proficiencies[category] = newProgress;
    }

    /// <summary>
    /// Creates a display string for debug/logging purposes.
    /// </summary>
    public override string ToString()
    {
        var profCount = GetCountAtLevel(WeaponProficiencyLevel.Proficient);
        var expertCount = GetCountAtLevel(WeaponProficiencyLevel.Expert);
        var masterCount = GetCountAtLevel(WeaponProficiencyLevel.Master);

        return $"Proficiencies for Character {CharacterId}: " +
               $"Proficient={profCount}, Expert={expertCount}, Master={masterCount}";
    }
}
```

---

## 5. ProficiencyProgress Value Object

### 5.1 Purpose

The `ProficiencyProgress` value object represents the current state and advancement progress for a single weapon category. It encapsulates level, experience, and threshold calculations.

### 5.2 Implementation

**File:** `src/Core/RuneAndRust.Domain/ValueObjects/ProficiencyProgress.cs`

```csharp
namespace RuneAndRust.Domain.ValueObjects;

using RuneAndRust.Domain.Enums;

/// <summary>
/// Tracks proficiency level and advancement progress for a weapon category.
/// </summary>
/// <remarks>
/// <para>
/// ProficiencyProgress is immutable. To advance a proficiency, create a new
/// instance with updated values using the factory methods.
/// </para>
/// </remarks>
/// <param name="Category">The weapon category being tracked.</param>
/// <param name="CurrentLevel">The current proficiency level.</param>
/// <param name="CombatExperience">Total combats using this category.</param>
/// <param name="Thresholds">Experience thresholds configuration.</param>
public readonly record struct ProficiencyProgress(
    WeaponCategory Category,
    WeaponProficiencyLevel CurrentLevel,
    int CombatExperience,
    ProficiencyThresholds Thresholds)
{
    /// <summary>
    /// Gets whether this proficiency is at maximum level (Master).
    /// </summary>
    public bool IsAtMaxLevel => CurrentLevel == WeaponProficiencyLevel.Master;

    /// <summary>
    /// Gets whether this proficiency can advance to the next level.
    /// </summary>
    public bool CanAdvance => !IsAtMaxLevel;

    /// <summary>
    /// Gets the experience required to reach the next level.
    /// </summary>
    /// <remarks>
    /// Returns 0 if already at Master level.
    /// </remarks>
    public int ExperienceToNextLevel
    {
        get
        {
            if (IsAtMaxLevel) return 0;

            var requiredForNext = CurrentLevel switch
            {
                WeaponProficiencyLevel.NonProficient => Thresholds.NonProficientToProficient,
                WeaponProficiencyLevel.Proficient => Thresholds.ProficientToExpert,
                WeaponProficiencyLevel.Expert => Thresholds.ExpertToMaster,
                _ => 0
            };

            return Math.Max(0, requiredForNext - CombatExperience);
        }
    }

    /// <summary>
    /// Gets the threshold required for the next level.
    /// </summary>
    /// <remarks>
    /// Returns 0 if already at Master level.
    /// </remarks>
    public int ThresholdForNextLevel
    {
        get
        {
            if (IsAtMaxLevel) return 0;

            return CurrentLevel switch
            {
                WeaponProficiencyLevel.NonProficient => Thresholds.NonProficientToProficient,
                WeaponProficiencyLevel.Proficient => Thresholds.ProficientToExpert,
                WeaponProficiencyLevel.Expert => Thresholds.ExpertToMaster,
                _ => 0
            };
        }
    }

    /// <summary>
    /// Gets the progress percentage toward the next level (0-100).
    /// </summary>
    /// <remarks>
    /// Returns 100 if already at Master level.
    /// </remarks>
    public decimal ProgressPercentage
    {
        get
        {
            if (IsAtMaxLevel) return 100m;

            var threshold = ThresholdForNextLevel;
            if (threshold == 0) return 0m;

            return Math.Min(100m, (decimal)CombatExperience / threshold * 100m);
        }
    }

    /// <summary>
    /// Gets whether the experience threshold for the next level has been reached.
    /// </summary>
    public bool HasReachedNextThreshold
    {
        get
        {
            if (IsAtMaxLevel) return false;
            return CombatExperience >= ThresholdForNextLevel;
        }
    }

    /// <summary>
    /// Creates a new ProficiencyProgress with validation.
    /// </summary>
    public static ProficiencyProgress Create(
        WeaponCategory category,
        WeaponProficiencyLevel currentLevel,
        int combatExperience,
        ProficiencyThresholds thresholds)
    {
        ArgumentNullException.ThrowIfNull(thresholds);
        ArgumentOutOfRangeException.ThrowIfNegative(combatExperience);

        return new ProficiencyProgress(
            category,
            currentLevel,
            combatExperience,
            thresholds);
    }

    /// <summary>
    /// Creates a new progress instance with incremented experience.
    /// </summary>
    /// <param name="combatsToAdd">Number of combats to add (default 1).</param>
    /// <returns>New progress instance with updated experience.</returns>
    public ProficiencyProgress AddExperience(int combatsToAdd = 1)
    {
        ArgumentOutOfRangeException.ThrowIfNegativeOrZero(combatsToAdd);

        return this with { CombatExperience = CombatExperience + combatsToAdd };
    }

    /// <summary>
    /// Creates a new progress instance advanced to the next level.
    /// </summary>
    /// <returns>New progress instance at next level with reset experience.</returns>
    /// <exception cref="InvalidOperationException">Thrown when already at Master.</exception>
    public ProficiencyProgress AdvanceToNextLevel()
    {
        if (IsAtMaxLevel)
        {
            throw new InvalidOperationException(
                $"Cannot advance {Category} beyond Master level");
        }

        var nextLevel = CurrentLevel switch
        {
            WeaponProficiencyLevel.NonProficient => WeaponProficiencyLevel.Proficient,
            WeaponProficiencyLevel.Proficient => WeaponProficiencyLevel.Expert,
            WeaponProficiencyLevel.Expert => WeaponProficiencyLevel.Master,
            _ => throw new InvalidOperationException($"Invalid level: {CurrentLevel}")
        };

        return new ProficiencyProgress(
            Category,
            nextLevel,
            combatExperience: 0, // Reset experience on level up
            Thresholds);
    }

    /// <summary>
    /// Formats the progress for display.
    /// </summary>
    /// <returns>String like "Proficient (24/25 to Expert)"</returns>
    public string FormatProgress()
    {
        if (IsAtMaxLevel)
        {
            return $"{CurrentLevel} (MAX)";
        }

        return $"{CurrentLevel} ({CombatExperience}/{ThresholdForNextLevel} to " +
               $"{GetNextLevelName()})";
    }

    /// <summary>
    /// Gets the name of the next proficiency level.
    /// </summary>
    private string GetNextLevelName()
    {
        return CurrentLevel switch
        {
            WeaponProficiencyLevel.NonProficient => "Proficient",
            WeaponProficiencyLevel.Proficient => "Expert",
            WeaponProficiencyLevel.Expert => "Master",
            _ => "Unknown"
        };
    }

    /// <summary>
    /// Creates a display string for debug/logging purposes.
    /// </summary>
    public override string ToString() => FormatProgress();
}
```

### 5.3 ProficiencyThresholds Value Object

**File:** `src/Core/RuneAndRust.Domain/ValueObjects/ProficiencyThresholds.cs`

```csharp
namespace RuneAndRust.Domain.ValueObjects;

/// <summary>
/// Defines combat experience thresholds for proficiency advancement.
/// </summary>
/// <remarks>
/// <para>
/// Thresholds are loaded from configuration to allow balance adjustments
/// without code changes.
/// </para>
/// </remarks>
/// <param name="NonProficientToProficient">Combats needed: NonProficient → Proficient</param>
/// <param name="ProficientToExpert">Combats needed: Proficient → Expert</param>
/// <param name="ExpertToMaster">Combats needed: Expert → Master</param>
public readonly record struct ProficiencyThresholds(
    int NonProficientToProficient,
    int ProficientToExpert,
    int ExpertToMaster)
{
    /// <summary>
    /// Gets the total combats needed to reach Master from NonProficient.
    /// </summary>
    public int TotalToMaster =>
        NonProficientToProficient + ProficientToExpert + ExpertToMaster;

    /// <summary>
    /// Creates default thresholds (10/25/50).
    /// </summary>
    public static ProficiencyThresholds Default =>
        new(
            nonProficientToProficient: 10,
            proficientToExpert: 25,
            expertToMaster: 50);

    /// <summary>
    /// Creates thresholds with validation.
    /// </summary>
    public static ProficiencyThresholds Create(
        int nonProficientToProficient,
        int proficientToExpert,
        int expertToMaster)
    {
        ArgumentOutOfRangeException.ThrowIfNegativeOrZero(nonProficientToProficient);
        ArgumentOutOfRangeException.ThrowIfNegativeOrZero(proficientToExpert);
        ArgumentOutOfRangeException.ThrowIfNegativeOrZero(expertToMaster);

        return new ProficiencyThresholds(
            nonProficientToProficient,
            proficientToExpert,
            expertToMaster);
    }

    /// <summary>
    /// Creates a display string for debug/logging purposes.
    /// </summary>
    public override string ToString() =>
        $"Thresholds: {NonProficientToProficient}/{ProficientToExpert}/{ExpertToMaster} " +
        $"(Total: {TotalToMaster})";
}
```

---

## 6. Data Model Changes

### 6.1 New Types Summary

| Type                     | Layer  | Category     | Description                         |
| ------------------------ | ------ | ------------ | ----------------------------------- |
| `CharacterProficiencies` | Domain | Entity       | Per-character proficiency state     |
| `ProficiencyProgress`    | Domain | Value Object | Progress tracking for one category  |
| `ProficiencyThresholds`  | Domain | Value Object | Experience thresholds configuration |

### 6.2 File Locations

```
src/Core/RuneAndRust.Domain/
├── Entities/
│   └── CharacterProficiencies.cs        ← NEW
└── ValueObjects/
    ├── ProficiencyProgress.cs           ← NEW
    └── ProficiencyThresholds.cs         ← NEW

config/
├── proficiency-thresholds.json          ← NEW
└── schemas/
    └── proficiency-thresholds.schema.json ← NEW
```

### 6.3 Character Entity Integration

```
Character (existing entity)
├── UPDATED: Add Proficiencies property
│   OLD: (no proficiency tracking)
│   NEW: Proficiencies: CharacterProficiencies

CharacterProficiencies (new entity)
├── CharacterId: Guid → references Character.Id
└── Proficiencies: Dictionary<WeaponCategory, ProficiencyProgress>
    ├─ Axes       → ProficiencyProgress(Axes, Proficient, 5/25 exp)
    ├─ Swords     → ProficiencyProgress(Swords, Expert, 12/50 exp)
    ├─ Daggers    → ProficiencyProgress(Daggers, Master, 0 exp MAX)
    └─ ... (all 11 categories)
```

---

## 7. Configuration File Schemas

### 7.1 proficiency-thresholds.json

**File:** `config/proficiency-thresholds.json`

```json
{
    "$schema": "./schemas/proficiency-thresholds.schema.json",
    "thresholds": {
        "nonProficientToProficient": {
            "combatsRequired": 10,
            "description": "Combats needed to gain basic proficiency through experience"
        },
        "proficientToExpert": {
            "combatsRequired": 25,
            "description": "Combats needed to advance from Proficient to Expert"
        },
        "expertToMaster": {
            "combatsRequired": 50,
            "description": "Combats needed to achieve mastery"
        }
    },
    "notes": [
        "Experience is tracked per weapon category",
        "Characters start with archetype proficiencies at Proficient level (0 exp)",
        "Total combats to master a category from scratch: 85 (10 + 25 + 50)",
        "Experience resets to 0 when advancing to the next level"
    ]
}
```

### 7.2 proficiency-thresholds.schema.json

**File:** `config/schemas/proficiency-thresholds.schema.json`

```json
{
    "$schema": "http://json-schema.org/draft-07/schema#",
    "$id": "proficiency-thresholds.schema.json",
    "title": "Proficiency Thresholds Configuration",
    "description": "Defines combat experience thresholds for proficiency advancement",
    "type": "object",
    "required": ["thresholds"],
    "properties": {
        "$schema": {
            "type": "string",
            "description": "JSON schema reference"
        },
        "thresholds": {
            "type": "object",
            "required": [
                "nonProficientToProficient",
                "proficientToExpert",
                "expertToMaster"
            ],
            "properties": {
                "nonProficientToProficient": {
                    "$ref": "#/$defs/thresholdEntry"
                },
                "proficientToExpert": {
                    "$ref": "#/$defs/thresholdEntry"
                },
                "expertToMaster": {
                    "$ref": "#/$defs/thresholdEntry"
                }
            },
            "additionalProperties": false
        },
        "notes": {
            "type": "array",
            "description": "Optional design notes",
            "items": { "type": "string" }
        }
    },
    "$defs": {
        "thresholdEntry": {
            "type": "object",
            "required": ["combatsRequired"],
            "properties": {
                "combatsRequired": {
                    "type": "integer",
                    "description": "Number of combats needed for advancement",
                    "minimum": 1,
                    "maximum": 1000
                },
                "description": {
                    "type": "string",
                    "description": "Human-readable description of this threshold"
                }
            },
            "additionalProperties": false
        }
    }
}
```

---

## 8. Logging Specifications

### 8.1 Log Levels by Component

| Component                | Level       | Events                                        |
| ------------------------ | ----------- | --------------------------------------------- |
| `CharacterProficiencies` | Information | Proficiency initialization, level advancement |
| `CharacterProficiencies` | Debug       | Progress queries, experience checks           |
| `ProficiencyProgress`    | Debug       | Experience increments, threshold checks       |

### 8.2 Structured Logging Templates

```csharp
// Information - Character proficiencies initialized
_logger.LogInformation(
    "Character proficiencies initialized. CharacterId={CharacterId}, " +
    "ArchetypeId={ArchetypeId}, ProficientCount={ProficientCount}",
    characterId,
    archetypeId,
    proficientCategories.Count);

// Information - Proficiency advanced
_logger.LogInformation(
    "Proficiency advanced. CharacterId={CharacterId}, Category={Category}, " +
    "OldLevel={OldLevel}, NewLevel={NewLevel}, CombatsUsed={CombatsUsed}",
    characterId,
    category,
    oldLevel,
    newLevel,
    combatExperience);

// Debug - Progress retrieved
_logger.LogDebug(
    "Proficiency progress queried. CharacterId={CharacterId}, Category={Category}, " +
    "Level={Level}, Experience={Experience}, ToNext={ToNext}",
    characterId,
    category,
    progress.CurrentLevel,
    progress.CombatExperience,
    progress.ExperienceToNextLevel);

// Debug - Experience added
_logger.LogDebug(
    "Combat experience added. CharacterId={CharacterId}, Category={Category}, " +
    "OldExp={OldExp}, NewExp={NewExp}, ThresholdReached={ThresholdReached}",
    characterId,
    category,
    oldExperience,
    newExperience,
    hasReachedThreshold);
```

---

## 9. Unit Testing Requirements

### 9.1 Test Count by Feature

| Feature                          | Test Count |
| -------------------------------- | ---------- |
| CharacterProficiencies entity    | ~2         |
| ProficiencyProgress value object | ~2         |
| **Total**                        | **~4**     |

### 9.2 Test Specifications

#### CharacterProficienciesTests.cs

**File:** `tests/RuneAndRust.Domain.UnitTests/Entities/CharacterProficienciesTests.cs`

```csharp
[TestFixture]
public class CharacterProficienciesTests
{
    [Test]
    public void CreateFromArchetype_ForWarrior_InitializesAllProficient();

    [Test]
    public void CreateFromArchetype_ForMystic_Initializes3ProficientRest NonProficient();

    [Test]
    public void GetLevel_ForInitializedCategory_ReturnsCorrectLevel();

    [Test]
    public void GetProgress_ForValidCategory_ReturnsProgressObject();

    [Test]
    public void GetProgress_ForInvalidCategory_ThrowsArgumentException();

    [Test]
    public void CanAdvance_ForProficientLevel_ReturnsTrue();

    [Test]
    public void CanAdvance_ForMasterLevel_ReturnsFalse();

    [Test]
    public void IsAtMaxLevel_ForMasterLevel_ReturnsTrue();

    [Test]
    public void GetCategoriesAtLevel_FiltersByLevel_ReturnsMatchingCategories();

    [Test]
    public void GetTotalCombatExperience_SumsAllCategories_ReturnsCorrectTotal();

    [Test]
    public void UpdateProgress_WithValidProgress_UpdatesCategory();

    [Test]
    public void UpdateProgress_WithMismatchedCategory_ThrowsArgumentException();
}
```

#### ProficiencyProgressTests.cs

**File:** `tests/RuneAndRust.Domain.UnitTests/ValueObjects/ProficiencyProgressTests.cs`

```csharp
[TestFixture]
public class ProficiencyProgressTests
{
    private ProficiencyThresholds _defaultThresholds;

    [SetUp]
    public void SetUp()
    {
        _defaultThresholds = ProficiencyThresholds.Default;
    }

    [Test]
    public void Create_WithValidParameters_CreatesProgress();

    [Test]
    public void Create_WithNegativeExperience_ThrowsArgumentOutOfRangeException();

    [Test]
    public void ExperienceToNextLevel_AtNonProficientWith5Exp_Returns5();

    [Test]
    public void ExperienceToNextLevel_AtMasterLevel_Returns0();

    [Test]
    public void ProgressPercentage_WithHalfExperience_Returns50Percent();

    [Test]
    public void HasReachedNextThreshold_WhenAtThreshold_ReturnsTrue();

    [Test]
    public void HasReachedNextThreshold_WhenBelowThreshold_ReturnsFalse();

    [Test]
    public void AddExperience_Increments CombatExperience();

    [Test]
    public void AdvanceToNextLevel_FromProficient_ReturnsExpertWith0Exp();

    [Test]
    public void AdvanceToNextLevel_FromMaster_ThrowsInvalidOperationException();

    [Test]
    public void IsAtMaxLevel_ForMaster_ReturnsTrue();

    [Test]
    public void IsAtMaxLevel_ForProficient_ReturnsFalse();

    [Test]
    public void FormatProgress_ReturnsReadableString();
}
```

---

## 10. Use Cases

### UC-001: Initialize Character Proficiencies on Creation

**Actor:** Character Creation Service  
**Flow:** Create character → Get archetype proficiency set → Create CharacterProficiencies from archetype → Store in character entity

### UC-002: Query Current Proficiency Level

**Actor:** Combat Service (v0.16.1f)  
**Flow:** Character uses weapon → Get weapon category → Query character.Proficiencies.GetLevel(category) → Return proficiency level

### UC-003: Display Proficiency Progress

**Actor:** Character Sheet UI  
**Flow:** For each category → Get progress → Display level with progress bar (e.g., "Proficient 15/25 to Expert")

### UC-004: Check Advancement Eligibility

**Actor:** Proficiency Acquisition Service (v0.16.1e)  
**Flow:** After combat → Get category progress → Check HasReachedNextThreshold → Advance level if threshold met

---

## 11. Deliverable Checklist

### Domain Layer

- [ ] `CharacterProficiencies.cs` entity created in `src/Core/RuneAndRust.Domain/Entities/`
- [ ] `ProficiencyProgress.cs` value object created in `src/Core/RuneAndRust.Domain/ValueObjects/`
- [ ] `ProficiencyThresholds.cs` value object created in `src/Core/RuneAndRust.Domain/ValueObjects/`
- [ ] All types have complete XML documentation
- [ ] Factory methods with validation

### Configuration Files

- [ ] `config/proficiency-thresholds.json` created
- [ ] `config/schemas/proficiency-thresholds.schema.json` created
- [ ] Configuration validates against schema

### Testing

- [ ] `CharacterProficienciesTests.cs` created
- [ ] `ProficiencyProgressTests.cs` created
- [ ] ~4 unit tests passing

### Documentation

- [ ] `v0.16.1d-changelog.md` created
- [ ] Inline code comments complete

---

## 12. Acceptance Criteria

### Functional

- [ ] New character initialized with archetype proficiencies has correct starting levels
- [ ] Warrior character starts with Proficient in all 11 categories
- [ ] Mystic character starts with Proficient in 3 categories, NonProficient in 8
- [ ] All categories start with 0 combat experience
- [ ] `GetLevel()` returns correct proficiency level for each category
- [ ] `GetProgress()` returns progress with correct thresholds (10/25/50)
- [ ] `ExperienceToNextLevel` calculates correctly (threshold - current experience)
- [ ] `ProgressPercentage` calculates correctly (0-100%)
- [ ] `HasReachedNextThreshold` returns true when experience >= threshold
- [ ] `AdvanceToNextLevel()` creates new progress at next level with 0 experience
- [ ] `AdvanceToNextLevel()` throws exception when called on Master level
- [ ] `CanAdvance` returns false for Master level, true for all others
- [ ] `UpdateProgress()` correctly updates category progress

### Quality

- [ ] Build succeeds with 0 errors
- [ ] Build succeeds with 0 warnings
- [ ] ~4 unit tests pass
- [ ] Configuration validates against JSON schema
- [ ] All public types have XML documentation

---

## 13. Dependencies

### Required from v0.16.1a

| Type                     | Usage                         |
| ------------------------ | ----------------------------- |
| `WeaponProficiencyLevel` | Stored in ProficiencyProgress |

### Required from v0.16.1b

| Type             | Usage                                    |
| ---------------- | ---------------------------------------- |
| `WeaponCategory` | Dictionary key in CharacterProficiencies |

### Required from v0.16.1c

| Type                      | Usage                               |
| ------------------------- | ----------------------------------- |
| `ArchetypeProficiencySet` | Initializes character proficiencies |

### Provides to v0.16.1e

| Type                     | Usage                                     |
| ------------------------ | ----------------------------------------- |
| `CharacterProficiencies` | Updated by acquisition service            |
| `ProficiencyProgress`    | Queried and updated during advancement    |
| `ProficiencyThresholds`  | Used to determine advancement eligibility |

### Provides to v0.16.1f

| Type                     | Usage                                     |
| ------------------------ | ----------------------------------------- |
| `CharacterProficiencies` | Combat queries current proficiency levels |
| `ProficiencyProgress`    | Combat awards experience increments       |

---

## 14. Future Considerations

### Deferred to v0.16.1e

- **IProficiencyAcquisitionService**: Service for awarding experience and advancing levels
- **ProficiencyGainResult**: Result object for advancement outcomes
- **Alternative acquisition methods**: Training, PP purchase, specializations

### Deferred to v0.16.1f

- **Combat integration**: Automatic experience awarding after combat
- **Proficiency effect application**: Applying attack/damage modifiers in combat
- **Combat technique unlocking**: Using advanced/signature techniques based on level

### Out of Scope

- **Experience decay**: Proficiency never decreases once gained
- **Category-switching penalties**: No penalty for switching between weapon categories mid-combat
- **Per-weapon tracking**: Experience is per-category, not per-individual-weapon

---

_Document Version: 1.0_  
_Last Updated: 2026-01-27_  
_Author: AI Assistant_
