# Design Specification: v0.20.4b - Myrk-gengr Tier 2 Abilities

**Version:** v0.20.4b
**Status:** Design Phase
**Last Updated:** 2026-01-28
**Target Tests:** ~8 unit and integration tests
**Specialization:** Myrk-gengr (Shadow-Walker)
**Prerequisites:** v0.20.4a Complete
**Archetype:** Skirmisher

---

## Table of Contents

1. [Executive Summary](#1-executive-summary)
2. [Tier 2 Specialization Overview](#2-tier-2-specialization-overview)
3. [Architecture Diagrams](#3-architecture-diagrams)
4. [Domain Model Specifications](#4-domain-model-specifications)
5. [Umbral Strike Ability Specification](#5-umbral-strike-ability-specification)
6. [Shadow Clone Ability Specification](#6-shadow-clone-ability-specification)
7. [Void Touched Ability Specification](#7-void-touched-ability-specification)
8. [Tier 2 Unlock Mechanics](#8-tier-2-unlock-mechanics)
9. [User Stories](#9-user-stories)
10. [Application Service Layer](#10-application-service-layer)
11. [Shadow Damage Type Integration](#11-shadow-damage-type-integration)
12. [Configuration Specifications](#12-configuration-specifications)
13. [Clone Behavior System](#13-clone-behavior-system)
14. [Damage Calculation Examples](#14-damage-calculation-examples)
15. [State Machine Diagrams](#15-state-machine-diagrams)
16. [Corruption Mechanics for Tier 2](#16-corruption-mechanics-for-tier-2)
17. [Combat Interaction Examples](#17-combat-interaction-examples)
18. [Logging Specifications](#18-logging-specifications)
19. [Unit Testing Requirements](#19-unit-testing-requirements)
20. [Deliverable Checklist](#20-deliverable-checklist)
21. [Acceptance Criteria](#21-acceptance-criteria)
22. [Design Decisions & Rationale](#22-design-decisions--rationale)

---

## 1. Executive Summary

Version 0.20.4b implements **Tier 2 abilities** for the Myrk-gengr specialization, expanding offensive and defensive capabilities while introducing sophisticated mechanics like shadow damage, illusory clones, and Aetheric resistance.

### Key Deliverables

| Category | Count | Details |
|----------|-------|---------|
| **Tier 2 Abilities** | 3 | Umbral Strike, Shadow Clone, Void Touched |
| **Domain Value Objects** | 2 | ShadowClone, UmbralStrikeResult |
| **Domain Enums** | 1 | CloneBehavior |
| **Application Services** | 2 | Tier2AbilityService, ShadowCloneManager |
| **Combat Integration** | 2 | Shadow damage type, Aetheric resistance |
| **Configuration Updates** | 1 | abilities.json Tier 2 section |
| **Unit Tests** | ~8 | Comprehensive ability testing |

### Tier 2 Profile

| Ability | Type | AP Cost | Essence Cost | Range | PP Cost | Notes |
|---------|------|---------|--------------|-------|---------|-------|
| **Umbral Strike** | Attack | 3 AP | 15 | Melee | 4 PP | +2d6 shadow damage |
| **Shadow Clone** | Active | 2 AP | 20 | 3 spaces | 4 PP | Create illusory duplicate |
| **Void Touched** | Passive | — | — | — | 4 PP | Aetheric resistance |

**Unlock Requirement:** 8 PP invested in Myrk-gengr specialization tree

---

## 2. Tier 2 Specialization Overview

### 2.1 Design Philosophy

**Tier 2 represents offensive and defensive expansion:**

- **Umbral Strike** adds burst damage capability, requiring shadow positioning
- **Shadow Clone** introduces tactical deception and positioning complexity
- **Void Touched** provides survivability against magical threats

### 2.2 Combat Role Enhancement

**Before Tier 2:** Stealth and mobility focused
**After Tier 2:** Stealth + offensive pressure + magical defense

---

## 3. Architecture Diagrams

### 3.1 Tier 2 Service Layer Architecture

```
┌──────────────────────────────────────────────────────────────────┐
│         v0.20.4b - Tier 2 Application Services Layer             │
├──────────────────────────────────────────────────────────────────┤
│                                                                   │
│  ┌────────────────────────────┐  ┌─────────────────────────────┐ │
│  │ ITier2AbilityService       │  │ IShadowCloneManager         │ │
│  │ (Interface)                │  │ (Interface)                 │ │
│  ├────────────────────────────┤  ├─────────────────────────────┤ │
│  │ + ExecuteUmbralStrike()    │  │ + CreateClone()             │ │
│  │ + CanUseUmbralStrike()     │  │ + DestroyClone()            │ │
│  │ + CalculateShadowDamage()  │  │ + GetActiveClones()         │ │
│  │ + GetUmbralStrikeInfo()    │  │ + MoveClonesAsGroup()       │ │
│  │ + ApplyVoidTouched()       │  │ + EvaluateCloneDetection()  │ │
│  │ + CalculateAethericReduct.─│  │ + ConsumePlanetClone()      │ │
│  └────────┬───────────────────┘  │ + ManageClonesPerTurn()     │ │
│           │                       └────────┬────────────────────┘ │
│           └───────────────┬────────────────┘                      │
│                           │                                       │
│  ┌────────────────────────────────────────────────────────────┐  │
│  │ IDamageCalculationService (v0.18.x dependency)            │  │
│  │ (Enhanced for shadow damage type)                         │  │
│  ├────────────────────────────────────────────────────────────┤  │
│  │ + CalculateDamage()                                        │  │
│  │ + ApplyDamageType(DamageType.Shadow)                       │  │
│  │ + ApplyResistance(ResistanceType.Aetheric)                 │  │
│  │ + GetDamageMultiplier()                                    │  │
│  └────────────────────────────────────────────────────────────┘  │
│                                                                   │
└──────────────────────────────────────────────────────────────────┘

Tier 2 Dependencies:
├─ v0.20.4a (Shadow Essence, Light Level, Corruption)
├─ v0.18.x (Damage, Resistance, Status Effects)
└─ Combat System (Attack rolls, damage application)
```

### 3.2 Shadow Clone Entity Diagram

```
┌─────────────────────────────────────────────────────┐
│         ShadowClone (Value Object)                  │
├─────────────────────────────────────────────────────┤
│ Properties:                                         │
│ • CloneId: Guid                                     │
│ • OwnerId: Guid                                     │
│ • Position: Position                                │
│ • CurrentHp: int (always 1)                         │
│ • Defense: int (matches owner)                      │
│ • Behavior: CloneBehavior                           │
│ • CreatedAt: DateTime                               │
│ • ExpiresAt: DateTime                               │
│ • IsDestroyed: bool                                 │
│ • DetectionDc: int (14)                             │
│ • PerceptionPenalty: int (-1 for detection)         │
└─────────────────────────────────────────────────────┘
         │
         ├─► Mirror (Copies owner movements)
         ├─► Independent (Random movement)
         ├─► Decoy (Toward nearest enemy)
         └─► Static (Remains stationary)

Clone Destruction:
├─ Any damage >= 1 (1 HP)
├─ Duration expires (1 minute default)
├─ Owner ends combat
├─ Owner used Eclipse
└─ Owner consumed clone for Umbral Strike
```

### 3.3 Damage Type Integration

```
Existing Damage Types:        +New for Tier 2:
├─ Physical
├─ Fire                       ├─► Shadow
├─ Frost                      │   • Bypasses non-magical armor
├─ Lightning                  │   • Enhanced vs. Light-using enemies
├─ Poison                     │   • Reduced vs. pure Darkness
├─ Aetheric                   │
└─ Divine

Resistance/Weakness Matrix:
┌──────────────┬─────────────────┬──────────────┐
│ Source Type  │ Shadow Bonus    │ Shadow Weak  │
├──────────────┼─────────────────┼──────────────┤
│ Light        │ +1d4 (vs light) │ -1d4 (dark)  │
│ Neutral      │ Normal          │ Normal       │
│ Shadow/Dark  │ -1d4 (overlap)  │ +1d4 (synergy)
└──────────────┴─────────────────┴──────────────┘
```

---

## 4. Domain Model Specifications

### 4.1 ShadowClone (Value Object)

**Purpose:** Represents an illusory shadow duplicate created by Shadow Clone ability.

**Properties:**

```csharp
public sealed record ShadowClone
{
    /// <summary>Unique identifier for this clone.</summary>
    public Guid CloneId { get; init; }

    /// <summary>Character ID of the clone's creator.</summary>
    public Guid OwnerId { get; init; }

    /// <summary>Current position (X, Y).</summary>
    public Position Position { get; set; }

    /// <summary>Hit points (always 1 for clones).</summary>
    public int CurrentHp { get; private set; } = 1;

    /// <summary>Defense value (copies from owner).</summary>
    public int Defense { get; init; }

    /// <summary>Clone movement behavior pattern.</summary>
    public CloneBehavior Behavior { get; set; }

    /// <summary>When this clone was created.</summary>
    public DateTime CreatedAt { get; init; }

    /// <summary>When this clone expires (1 minute default).</summary>
    public DateTime ExpiresAt { get; init; }

    /// <summary>Has this clone been destroyed.</summary>
    public bool IsDestroyed { get; private set; }

    /// <summary>DC to identify this as illusion (14).</summary>
    public int DetectionDc { get; init; } = 14;

    /// <summary>Penalty enemies suffer to detect illusion.</summary>
    public int PerceptionPenalty { get; init; } = -1;

    /// <summary>Can this clone be consumed for Umbral Strike advantage.</summary>
    public bool CanBeConsumed { get; set; } = true;
}

/// <summary>Clone movement behavior.</summary>
public enum CloneBehavior
{
    /// <summary>Copies owner's exact movements.</summary>
    Mirror = 0,

    /// <summary>Moves randomly within 6 spaces.</summary>
    Independent = 1,

    /// <summary>Moves toward nearest enemy.</summary>
    Decoy = 2,

    /// <summary>Remains stationary.</summary>
    Static = 3
}
```

**Factory Method:**

```csharp
public static ShadowClone Create(
    Guid ownerId,
    Position initialPosition,
    int ownerDefense,
    CloneBehavior behavior = CloneBehavior.Mirror)
{
    return new ShadowClone
    {
        CloneId = Guid.NewGuid(),
        OwnerId = ownerId,
        Position = initialPosition,
        Defense = ownerDefense,
        Behavior = behavior,
        CreatedAt = DateTime.UtcNow,
        ExpiresAt = DateTime.UtcNow.AddMinutes(1),
        IsDestroyed = false
    };
}
```

**Query Methods:**

| Method | Returns | Purpose |
|--------|---------|---------|
| IsActive() | `bool` | Not destroyed and not expired |
| IsExpired() | `bool` | DateTime.UtcNow > ExpiresAt |
| GetRemainingSeconds() | `int` | Time until expiration |
| GetDetectionDifficulty() | `int` | DC for detection (14) |
| TakeDamage(int amount) | `bool` | Returns true if destroyed |

### 4.2 UmbralStrikeResult (Value Object)

**Purpose:** Encapsulates the result of an Umbral Strike attack with full damage breakdown.

**Properties:**

```csharp
public sealed record UmbralStrikeResult
{
    /// <summary>D20 attack roll result.</summary>
    public int AttackRoll { get; init; }

    /// <summary>Defender's defense/AC value.</summary>
    public int TargetDefense { get; init; }

    /// <summary>Was the attack a hit.</summary>
    public bool IsHit { get; init; }

    /// <summary>Was this a critical hit (nat 20).</summary>
    public bool IsCritical { get; init; }

    /// <summary>Base weapon damage (e.g., 1d8+3).</summary>
    public int BaseDamage { get; init; }

    /// <summary>Shadow bonus damage (2d6).</summary>
    public int ShadowDamage { get; init; }

    /// <summary>Critical bonus shadow damage (1d6, if critical).</summary>
    public int CriticalBonusDamage { get; init; }

    /// <summary>Total damage dealt.</summary>
    public int TotalDamage { get; init; }

    /// <summary>Was target unaware (surprise).</summary>
    public bool WasSurprise { get; init; }

    /// <summary>Was a shadow clone consumed for advantage.</summary>
    public bool ConsumedClone { get; init; }

    /// <summary>Did this attack trigger Corruption.</summary>
    public bool CorruptionTriggered { get; init; }

    /// <summary>Damage type breakdown.</summary>
    public DamageBreakdown DamageBreakdown { get; init; }

    /// <summary>Narrative description of strike.</summary>
    public string NarrativeDescription { get; init; }
}

public sealed record DamageBreakdown
{
    public int PhysicalDamage { get; init; }
    public int ShadowDamage { get; init; }
    public int CriticalBonus { get; init; }

    public int Total => PhysicalDamage + ShadowDamage + CriticalBonus;
}
```

### 4.3 CloneBehavior State Management

**Behavior Processing:**

```csharp
/// <summary>
/// Processes clone behavior at start of owner's turn.
/// </summary>
public interface ICloneBehaviorProcessor
{
    /// <summary>
    /// Calculate clone's next position based on behavior.
    /// </summary>
    Position ProcessBehavior(
        ShadowClone clone,
        Position ownerPosition,
        IReadOnlyList<Position> nearbyEnemies);

    /// <summary>
    /// Get movement description for narrative feedback.
    /// </summary>
    string GetBehaviorDescription(ShadowClone clone);
}
```

---

## 5. Umbral Strike Ability Specification

### 5.1 Core Mechanics

**Type:** Attack Ability (Combat only)
**AP Cost:** 3 AP
**Shadow Essence Cost:** 15
**Range:** Melee (adjacent target)
**PP Cost to Unlock:** 4 PP
**Prerequisite:** 8 PP invested in Myrk-gengr tree
**Cooldown:** None (essence is limiter)

### 5.2 Attack Requirements

**Must satisfy ALL conditions:**

```
1. Caster in shadow (Darkness or DimLight)
2. 15+ Shadow Essence available
3. Target within melee range (adjacent)
4. Target alive and present
5. Not already attacking this turn
```

**Automatic Failure If:**

```
• Caster in bright light or normal light
• Caster < 15 Shadow Essence
• Target not adjacent
• Caster incapacitated
```

### 5.3 Damage Calculation

**Base Formula:**

```
Total Damage = Weapon Damage + Shadow Bonus (2d6) + Critical Bonus (if applicable)

Example with longsword (1d8+3):
Roll 1d8 = 7, add modifier = 10 (physical damage)
Roll 2d6 = 9 (shadow damage)
Total = 19 damage

If critical (nat 20):
Roll 1d6 = 4 (critical bonus shadow damage)
Total = 19 + 4 = 23 damage
```

**Damage Type Calculation:**

```
Physical Portion = [Weapon Damage]
Shadow Portion = [2d6] (always added)
Critical Portion = [1d6] (only on crit)

Shadow damage bypasses non-magical armor:
• Full magical armor protection applies
• Half damage against mundane armor
• Full damage against no armor
```

### 5.4 Attack Resolution

**Step-by-step execution:**

```
1. Validate prerequisites (shadow location, essence, range)
2. Check if target is surprised/unaware
3. Roll d20 + attack modifier
4. Compare to target defense/AC
5. If miss: Report failure
6. If hit:
   ├─ Roll weapon damage (1d8+mod, etc.)
   ├─ Roll 2d6 shadow damage
   ├─ Check for critical (nat 20)
   │  └─ If critical: Add 1d6 bonus shadow damage
   ├─ Calculate total damage
   ├─ Apply damage to target
   ├─ Check clone consumption (can be used for advantage)
   ├─ Evaluate Corruption risk (if target Coherent)
   └─ Log attack result
7. Return damage breakdown to player
```

### 5.5 Surprise Attack Mechanic

**If target unaware:**

```
Conditions:
├─ Target hasn't acted in combat yet
├─ Caster successfully hid (Stealth check DC beaten)
└─ Target can't see caster

Result:
├─ Attack roll has advantage (+roll extra d20, use higher)
├─ Damage automatically hit
├─ Narrative: "Your shadow-empowered blade pierces from darkness"
└─ No saving throw for target
```

### 5.6 Shadow Clone Consumption

**Optional mechanic for attack advantage:**

```
Before rolling attack:
├─ Caster has active shadow clones
├─ Caster chooses to consume one
└─ (Consumes clone immediately)

Effect:
├─ Attack roll has advantage
├─ Shadow damage increased by +1d4
└─ Narrative: "You pull the clone's essence into your strike"

Consuming Clone Example:
Without Clone: d20 + 5 attack, 2d6 shadow
With Clone: (d20 + 5 or d20 + 5, use higher) attack, 2d6+1d4 shadow
```

### 5.7 Corruption Risk

**Triggers:**

| Scenario | Corruption | Notes |
|----------|-----------|-------|
| Attack Coherent-aligned target | +1 | Moral dimension |
| Target is innocent/unrelated | +1 | GM discretion |
| Attack in bright light | Not allowed | Ability blocked |
| Total per use | 0-2 | Depends on target |

---

## 6. Shadow Clone Ability Specification

### 6.1 Core Mechanics

**Type:** Active Ability (Combat or out-of-combat)
**AP Cost:** 2 AP
**Shadow Essence Cost:** 20
**Range:** 3 spaces (within range of caster)
**Duration:** 1 minute (or until destroyed)
**PP Cost to Unlock:** 4 PP
**Prerequisite:** 8 PP invested in Myrk-gengr tree
**Maximum Active:** 2 clones simultaneously

### 6.2 Clone Creation

**Execution:**

```
1. Designate clone creation location (within 3 spaces)
2. Spend 20 Shadow Essence
3. Verify location is empty and accessible
4. Create ShadowClone entity with:
   ├─ Appearance identical to caster
   ├─ Position set to designated location
   ├─ Defense = caster defense
   ├─ HP = 1 (fragile illusion)
   ├─ Behavior = selected by caster
   └─ Duration = 1 minute
5. Clone appears: "A shadow duplicate materializes!"
```

**Failure Conditions:**

```
• Insufficient Shadow Essence (need 20)
• Target location occupied
• Target location not accessible
• Already 2 clones active (max reached)
• Caster incapacitated
```

### 6.3 Clone Properties

**Clone Stats:**

| Stat | Value | Notes |
|------|-------|-------|
| **HP** | 1 | Any damage destroys |
| **Defense** | Equal to caster | But only 1 HP |
| **Movement** | 4 spaces/turn | If movement behavior enabled |
| **Attack** | Cannot attack | Illusory only |
| **Interaction** | No item use | Cannot manipulate objects |
| **Detection DC** | 14 | Enemy Perception vs. DC 14 |
| **Duration** | 1 minute | Then auto-expires |

### 6.4 Clone Behavior Patterns

**Mirror (Default):**

```
Mechanics:
• Clone copies caster's movements exactly
• If caster moves 3 spaces left, clone moves 3 left
• Provides illusion of duplicates moving together
• Enemies check Perception DC 14 each round to recognize

Tactical Use:
• Confuse enemies about which is real
• Make party size ambiguous
• Suggest reinforcements arriving
```

**Independent:**

```
Mechanics:
• Clone moves randomly within 6 spaces per turn
• 50% chance to move, 50% chance to stay
• Direction randomized each turn
• Enemies have -1 penalty to recognize fakeness

Tactical Use:
• Create chaotic appearance
• Distract enemies with unpredictable movement
• Suggest friendly intervention
```

**Decoy:**

```
Mechanics:
• Clone moves toward nearest visible enemy (up to 4 spaces/turn)
• Attacks enemies if able (but attacks always fail, no damage)
• Enemies must beat DC 14 Perception to recognize decoy
• Provides -2 penalty to detect clone fakeness (harder to tell)

Tactical Use:
• Draw enemy aggression
• Position enemies poorly
• Create tactical opportunities
```

**Static:**

```
Mechanics:
• Clone remains in place, does not move
• Enemies can attack it freely
• 1 HP means destroyed on any hit
• Detection DC 14 applies

Tactical Use:
• Bait attacks toward clone instead of caster
• Position as "distraction" point
• Use as landmark to block line of sight
```

### 6.5 Clone Interaction

**Enemy Actions Against Clone:**

```
Enemy attacking clone:
├─ If Perception <= 14: Treats clone as real, attacks
├─ If Perception > 14: Recognizes clone, may not waste action
└─ Either way: Any damage destroys clone

Enemy attempting to interact:
├─ Clone has no items/abilities
├─ Cannot be commanded
└─ Attacking it is typical response
```

**Caster Interactions with Clones:**

```
Caster can:
├─ Change clone behavior (1 AP to issue command)
├─ Move clones manually (up to movement speed)
├─ Consume clone for Umbral Strike advantage
├─ End clones early (no action required)
└─ Query clone status (no action)

Caster cannot:
├─ Attack through clone
├─ See from clone perspective
├─ Transfer consciousness to clone
└─ Use clone to cast abilities
```

### 6.6 Corruption Risk

**Triggers:**

| Scenario | Corruption | Notes |
|----------|-----------|-------|
| Create in Darkness | 0 | Safe in shadow |
| Create in Dim Light | 0 | Still shadow |
| Create in Normal Light | +1 | Creating in bright conditions |
| Create in Bright Light | +1 | Significant risk |
| Total per creation | 0-1 | Depends on light only |

---

## 7. Void Touched Ability Specification

### 7.1 Core Mechanics

**Type:** Passive (Always Active)
**AP Cost:** None
**Resource Cost:** None
**PP Cost to Unlock:** 4 PP
**Prerequisite:** 8 PP invested in Myrk-gengr tree
**Automatic Activation:** Upon specialization unlock

### 7.2 Aetheric Resistance Mechanics

**Primary Effect:**

```
Aetheric Damage Reduction:
Normal Aetheric Damage: X
With Void Touched: X / 2 (rounded down)

Example:
• Seiðr Bolt deals 3d6 = 12 damage
• With Void Touched: 12 / 2 = 6 damage (50% reduction)

• Aether Storm deals 4d6 = 15 damage
• With Void Touched: 15 / 2 = 7 damage (rounded down)
```

**Secondary Effects:**

```
Aetheric Effect Mitigation:
• Status effects from Aetheric sources: -2 to hit against character
• Example: Stun effects have lower chance to affect you
• Example: Charm effects grant advantage on saves

Save Bonus:
• Advantage on all saves against Aetheric effects
• Example: Save DC 14 Aetheric stun = roll twice, use higher
```

### 7.3 Scope & Limitations

**What Void Touched PROTECTS Against:**

```
✓ Aetheric damage (all sources)
✓ Seiðr-based attacks
✓ Aether Storm environmental effects
✓ Magical enchantments (Aetheric origin)
✓ Divine spell damage (if Aetheric)
✓ Glitch discharge (partially, may vary)
```

**What Void Touched DOES NOT Protect Against:**

```
✗ Physical damage (even from magical weapons)
✗ Fire/Frost/Poison damage
✗ Corruption (Corruption is metaphysical, not Aetheric damage)
✗ Non-Aetheric status effects
✗ Control effects (Rooted, Stunned from non-Aetheric sources)
✗ Drain effects (not purely Aetheric)
```

### 7.4 Interaction with Other Resistances

**Stacking Resistances:**

```
If character has multiple Aetheric sources:
Character has:
• Void Touched (from Tier 2)
• Divine Protection (from other source) - 25% resistance

Total calculation:
Base damage: 12 Aetheric
First: 12 * 0.5 (Void Touched) = 6
Then: 6 * 0.75 (Divine Protection) = 4.5 = 5 (rounded)
Total reduction: 12 → 5 (58% reduction)
```

**Vs. Weakness:**

```
If enemy has Aetheric vulnerability bonus:
• Void Touched resistance applies first
• Then vulnerability multiplier applied
• Net effect often neutral or negative for character

Example:
Enemy does 2x Aetheric damage (vulnerability to Shadow):
Base: 10 damage × 2 = 20
With Void Touched: 20 / 2 = 10 (net reduction still applies)
```

### 7.5 Passive Application

**Automatic benefit, no action required:**

```
Turn 1:
• Enemy casts Seiðr Bolt (3d6 = 15)
• Damage applies: 15 / 2 = 7 (Void Touched automatic)
• Character takes 7 damage

Turn 2:
• Enemy casts Aether Storm (4d6 = 18)
• Damage applies: 18 / 2 = 9 (Void Touched automatic)
• Character takes 9 damage

All Aetheric damage automatically halved (no choice to activate/deactivate)
```

### 7.6 Thematic Integration

**Narrative Justification:**

```
"Your connection to the void grants you natural resistance
to Aetheric damage. The Glitch's own power—normally anathema
to shadow magic—finds itself nullified by your embrace of
the in-between space."

This reflects:
• Shadow-walker nature granting resistance
• Void connection to Aetheric forces
• Balance between light and dark (nullifies pure light magic)
```

---

## 8. Tier 2 Unlock Mechanics

### 8.1 PP Requirement System

**Tier 2 Unlocking:**

```
Current System:
├─ Tier 1: 0 PP invested (available immediately)
├─ Tier 2: 8 PP invested required
│  ├─ Umbral Strike: 4 PP
│  ├─ Shadow Clone: 4 PP
│  └─ Void Touched: 4 PP
└─ Total cost: 12 PP (8 to unlock tier + 4+4+4 per ability)
```

**Lock Validation:**

```
Before ability becomes available:
1. Check character's total PP invested in Myrk-gengr
2. Is total >= 8?
   ├─ No: Ability locked, show message "Requires 8 PP invested"
   ├─ Yes: Ability unlocked
3. For each ability:
   ├─ Additional 4 PP per ability
   └─ User can selectively unlock which Tier 2 abilities
```

**Unlock UI Display:**

```
Tier 2 Abilities (Requires 8 PP):

[LOCKED] Umbral Strike (4 PP)
├─ Attack from shadow with +2d6 damage
└─ Status: Unlocked at 8 PP total (current: 5/8 PP)

[LOCKED] Shadow Clone (4 PP)
├─ Create illusory duplicate for 1 minute
└─ Status: Unlocked at 8 PP total (current: 5/8 PP)

[UNLOCKED] Void Touched (4 PP)
├─ Passive: Aetheric resistance
└─ Status: Already purchased
```

### 8.2 PP Cost Enforcement

**Per Ability Spending:**

```
Each Tier 2 ability costs 4 PP:
• Total cost for all Tier 2: 12 PP (8 baseline + 4+4+4)
• Can selectively purchase (don't need all 3)
• Each ability independent
```

**Purchase Flow:**

```
Character has 10 PP to allocate:
1. Player allocates 8 PP to Myrk-gengr → Tier 1 (complete)
2. Player allocates 4 PP to Umbral Strike → Tier 2 ability unlocked
3. Remaining 2 PP: insufficient for second Tier 2 ability (need 4)
4. Later, player allocates 4 more to Shadow Clone → unlocked
5. Later, player allocates 4 more to Void Touched → unlocked
```

---

## 9. User Stories

### User Story 1: Assassin Delivers Surprise Attack

**As a** Myrk-gengr with Umbral Strike unlocked
**I want to** attack an unaware enemy from shadow
**So that** I can deal burst damage and eliminate threats

**Acceptance Criteria:**

- [ ] Umbral Strike requires being in Darkness or Dim Light
- [ ] Attack from surprise grants advantage
- [ ] Base weapon damage + 2d6 shadow damage applied
- [ ] 15 Shadow Essence deducted before damage calculation
- [ ] Coherent-aligned targets trigger +1 Corruption
- [ ] Narrative feedback shows damage breakdown

### User Story 2: Tactical Clone Positioning

**As a** Myrk-gengr using Shadow Clone for tactical advantage
**I want to** position clones to confuse or distract enemies
**So that** I can control the battlefield and protect allies

**Acceptance Criteria:**

- [ ] Shadow Clone created within 3 spaces of caster
- [ ] Maximum 2 clones active simultaneously
- [ ] Clone has 1 HP and Defense = caster Defense
- [ ] Enemies must beat DC 14 Perception to recognize clone
- [ ] Clone lasts 1 minute (expires automatically)
- [ ] Caster can select clone behavior (Mirror/Independent/Decoy/Static)
- [ ] Clones can be consumed for Umbral Strike advantage

### User Story 3: Magical Defense

**As a** Myrk-gengr with Void Touched passive
**I want to** resist Aetheric damage from enemy spellcasters
**So that** I can survive magical encounters longer

**Acceptance Criteria:**

- [ ] Aetheric damage automatically halved (rounded down)
- [ ] Advantage on saves against Aetheric effects
- [ ] Aetheric status effects have -2 to hit
- [ ] Passive applies automatically (no activation needed)
- [ ] Non-Aetheric damage unaffected
- [ ] Corruption effects not protected

### User Story 4: Unlocking Tier 2 Abilities

**As a** character specializing in Myrk-gengr
**I want to** invest 8 PP to unlock Tier 2 abilities
**So that** I can access advanced shadow techniques

**Acceptance Criteria:**

- [ ] Tier 2 locked until 8 PP invested in tree
- [ ] Each ability costs 4 PP to unlock individually
- [ ] Can selectively purchase Tier 2 abilities (not all-or-nothing)
- [ ] UI shows unlock requirements and progress
- [ ] Once purchased, abilities remain available
- [ ] Cannot refund abilities (permanent purchase)

---

## 10. Application Service Layer

### 10.1 ITier2AbilityService Implementation

```csharp
/// <summary>
/// Service for executing Myrk-gengr Tier 2 abilities.
/// </summary>
public interface ITier2AbilityService
{
    /// <summary>
    /// Execute Umbral Strike attack ability.
    /// </summary>
    Task<UmbralStrikeResult> ExecuteUmbralStrikeAsync(
        Guid characterId,
        Guid targetId);

    /// <summary>
    /// Create a new shadow clone.
    /// </summary>
    Task<ShadowClone> CreateShadowCloneAsync(
        Guid characterId,
        int targetX,
        int targetY,
        CloneBehavior behavior);

    /// <summary>
    /// Validate if Umbral Strike can be used.
    /// </summary>
    Task<(bool CanUse, string Reason)> CanUseUmbralStrikeAsync(
        Guid characterId,
        Guid targetId);

    /// <summary>
    /// Validate if Shadow Clone can be created.
    /// </summary>
    Task<(bool CanCreate, string Reason)> CanCreateShadowCloneAsync(
        Guid characterId,
        int targetX,
        int targetY);

    /// <summary>
    /// Apply Void Touched passive (damage reduction).
    /// </summary>
    int ApplyVoidTouched(int incomingAethericDamage);

    /// <summary>
    /// Get detailed info about ability.
    /// </summary>
    Task<AbilityInfo> GetAbilityInfoAsync(
        Guid characterId,
        MyrkgengrAbilityId abilityId);
}

/// <summary>
/// Implementation of Tier 2 ability service.
/// </summary>
public class Tier2AbilityService : ITier2AbilityService
{
    private readonly IShadowEssenceService _essenceService;
    private readonly ICharacterRepository _characterRepository;
    private readonly IDamageCalculationService _damageService;
    private readonly IShadowCloneManager _cloneManager;
    private readonly IShadowCorruptionService _corruptionService;
    private readonly ILogger<Tier2AbilityService> _logger;

    public async Task<UmbralStrikeResult> ExecuteUmbralStrikeAsync(
        Guid characterId,
        Guid targetId)
    {
        // Validate prerequisites
        var caster = await _characterRepository.GetByIdAsync(characterId);
        var target = await _characterRepository.GetByIdAsync(targetId);

        if (caster?.ShadowEssence == null)
            return CreateFailedUmbralStrike("Caster not found or not Myrk-gengr");

        // Check location requirement
        var light = caster.CurrentLightLevel;
        if (!light.QualifiesAsUsableShadow())
            return CreateFailedUmbralStrike(
                $"Must be in shadow to use Umbral Strike (currently {light.CurrentLevel})");

        // Check essence
        if (!await _essenceService.TrySpendEssenceAsync(characterId, 15, "umbral-strike"))
            return CreateFailedUmbralStrike("Insufficient Shadow Essence (need 15)");

        // Validate melee range (adjacent)
        int distance = Math.Max(
            Math.Abs(caster.Position.X - target.Position.X),
            Math.Abs(caster.Position.Y - target.Position.Y));

        if (distance > 1)
            return CreateFailedUmbralStrike($"Target too far ({distance} spaces, must be adjacent)");

        // Roll attack
        int attackRoll = DiceRoller.Roll(20) + caster.GetAttackModifier();
        bool isHit = attackRoll >= target.Defense;
        bool isCritical = attackRoll == 20;

        // Surprise check
        bool isSurprise = target.IsUnaware;

        // Calculate damage
        int baseDamage = _damageService.CalculateWeaponDamage(caster.CurrentWeapon);
        int shadowDamage = DiceRoller.Roll(6) + DiceRoller.Roll(6); // 2d6

        int criticalBonus = 0;
        if (isCritical)
        {
            criticalBonus = DiceRoller.Roll(6); // 1d6
        }

        int totalDamage = baseDamage + shadowDamage + criticalBonus;

        // Apply damage if hit
        if (isHit && !isSurprise)
        {
            await _damageService.ApplyDamageAsync(
                targetId,
                baseDamage,
                DamageType.Physical);

            await _damageService.ApplyDamageAsync(
                targetId,
                shadowDamage,
                DamageType.Shadow);

            if (isCritical)
            {
                await _damageService.ApplyDamageAsync(
                    targetId,
                    criticalBonus,
                    DamageType.Shadow);
            }
        }

        // Check corruption
        var corruption = _corruptionService.EvaluateRisk(
            MyrkgengrAbilityId.UmbralStrike,
            light.CurrentLevel,
            targetIsCoherent: target.Alignment == Alignment.Coherent);

        if (corruption.RiskTriggered)
        {
            _corruptionService.ApplyCorruption(characterId, corruption);
        }

        var result = new UmbralStrikeResult
        {
            AttackRoll = attackRoll,
            TargetDefense = target.Defense,
            IsHit = isHit,
            IsCritical = isCritical,
            BaseDamage = baseDamage,
            ShadowDamage = shadowDamage,
            CriticalBonusDamage = criticalBonus,
            TotalDamage = isHit ? totalDamage : 0,
            WasSurprise = isSurprise,
            ConsumedClone = false,
            CorruptionTriggered = corruption.RiskTriggered,
            DamageBreakdown = new DamageBreakdown
            {
                PhysicalDamage = baseDamage,
                ShadowDamage = shadowDamage,
                CriticalBonus = criticalBonus
            },
            NarrativeDescription = BuildNarrative(
                isHit, isSurprise, isCritical, targetId, totalDamage)
        };

        _logger.LogInformation(
            "Umbral Strike: {CharId} → {TargetId} | Hit: {Hit} | Damage: {Dmg}",
            characterId, targetId, isHit, totalDamage);

        return result;
    }

    public async Task<ShadowClone> CreateShadowCloneAsync(
        Guid characterId,
        int targetX,
        int targetY,
        CloneBehavior behavior)
    {
        var caster = await _characterRepository.GetByIdAsync(characterId);
        if (caster?.ShadowEssence == null)
            throw new InvalidOperationException("Character not found");

        // Check essence
        if (!await _essenceService.TrySpendEssenceAsync(characterId, 20, "shadow-clone"))
            throw new InvalidOperationException("Insufficient Shadow Essence");

        // Check range
        int distance = Math.Max(
            Math.Abs(caster.Position.X - targetX),
            Math.Abs(caster.Position.Y - targetY));

        if (distance > 3)
            throw new InvalidOperationException(
                $"Target location too far ({distance} spaces, max 3)");

        // Check for existing clones (max 2)
        var activeClones = await _cloneManager.GetActiveClonesAsync(characterId);
        if (activeClones.Count >= 2)
            throw new InvalidOperationException("Maximum 2 clones already active");

        // Create clone
        var clone = ShadowClone.Create(
            characterId,
            new Position { X = targetX, Y = targetY },
            caster.Defense,
            behavior);

        await _cloneManager.AddCloneAsync(clone);

        _logger.LogInformation(
            "Shadow Clone created: {CloneId} for {CharId} at ({X}, {Y})",
            clone.CloneId, characterId, targetX, targetY);

        return clone;
    }

    public int ApplyVoidTouched(int incomingAethericDamage)
    {
        // Reduce by 50%
        int reducedDamage = incomingAethericDamage / 2;
        return reducedDamage;
    }

    // ... additional methods
}
```

### 10.2 IShadowCloneManager Implementation

```csharp
/// <summary>
/// Manages shadow clone lifecycle and behavior.
/// </summary>
public interface IShadowCloneManager
{
    /// <summary>
    /// Add clone to active tracking.
    /// </summary>
    Task AddCloneAsync(ShadowClone clone);

    /// <summary>
    /// Get all active clones for character.
    /// </summary>
    Task<IReadOnlyList<ShadowClone>> GetActiveClonesAsync(Guid characterId);

    /// <summary>
    /// Remove/destroy clone.
    /// </summary>
    Task DestroyCloneAsync(Guid cloneId);

    /// <summary>
    /// Process clone behavior at turn start.
    /// </summary>
    Task ProcessCloneBehaviorAsync(Guid characterId);

    /// <summary>
    /// Update clone position.
    /// </summary>
    Task MoveCloneAsync(Guid cloneId, Position newPosition);

    /// <summary>
    /// Consume clone for Umbral Strike advantage.
    /// </summary>
    Task<bool> ConsumeCloneAsync(Guid cloneId);

    /// <summary>
    /// Evaluate if clone is detected by enemy.
    /// </summary>
    Task<bool> IsCloneDetectedAsync(Guid cloneId, Guid perceiverCharacterId);

    /// <summary>
    /// Clean up expired clones.
    /// </summary>
    Task PurgeExpiredClonesAsync();
}

/// <summary>
/// Implementation of shadow clone manager.
/// </summary>
public class ShadowCloneManager : IShadowCloneManager
{
    private readonly Dictionary<Guid, ShadowClone> _activeClonesRepository;
    private readonly ICloneBehaviorProcessor _behaviorProcessor;
    private readonly ILogger<ShadowCloneManager> _logger;

    public async Task ProcessCloneBehaviorAsync(Guid characterId)
    {
        var clones = await GetActiveClonesAsync(characterId);
        // Process each clone's behavior pattern
        foreach (var clone in clones)
        {
            // Get nearby enemies
            // Calculate new position based on behavior
            // Update clone position
        }
    }

    public async Task<bool> IsCloneDetectedAsync(
        Guid cloneId,
        Guid perceiverCharacterId)
    {
        var clone = _activeClonesRepository[cloneId];

        // Perceiver rolls against DC 14
        int perceptionRoll = DiceRoller.Roll(20) + perceiverCharacterId.GetPerceptionModifier();
        bool detected = perceptionRoll > clone.DetectionDc;

        _logger.LogInformation(
            "Clone detection: {CloneId} vs {Perceiver} | Perception: {Roll} vs DC {Dc} | Detected: {Result}",
            cloneId, perceiverCharacterId, perceptionRoll, clone.DetectionDc, detected);

        return detected;
    }
}
```

---

## 11. Shadow Damage Type Integration

### 11.1 Damage Type System

**Shadow Damage Registration:**

```csharp
/// <summary>
/// New damage type for shadow abilities.
/// </summary>
public enum DamageType
{
    Physical = 0,
    Fire = 1,
    Frost = 2,
    Lightning = 3,
    Poison = 4,
    Aetheric = 5,
    Divine = 6,
    Shadow = 7  // NEW for v0.20.4b
}
```

**Damage Type Characteristics:**

| Type | Bypasses Armor | Resisted By | Effective Against | Notes |
|------|---|---|---|---|
| **Shadow** | Half vs. mundane | Shadow/Dark | Light-wielders | New for Tier 2 |

### 11.2 Damage Calculation Integration

**Modify DamageCalculationService:**

```csharp
public int CalculateFinalDamage(
    int baseDamage,
    DamageType damageType,
    IReadOnlyList<Resistance> targetResistances)
{
    // Apply damage type modifiers
    float multiplier = damageType switch
    {
        DamageType.Shadow => CalculateShadowModifier(targetResistances),
        _ => 1.0f
    };

    int finalDamage = (int)(baseDamage * multiplier);
    return Math.Max(finalDamage, 1); // Minimum 1 damage
}

private float CalculateShadowModifier(IReadOnlyList<Resistance> resistances)
{
    // Check for relevant resistances
    var shadowResistance = resistances.FirstOrDefault(r => r.Type == DamageType.Shadow);
    if (shadowResistance != null)
    {
        return 1.0f - shadowResistance.Percentage; // e.g., 50% resist = 0.5 multiplier
    }

    return 1.0f; // No resistance = full damage
}
```

---

## 12. Configuration Specifications

### 12.1 abilities.json (Tier 2 Section)

```json
{
    "abilities": [
        {
            "abilityId": "umbral-strike",
            "displayName": "Umbral Strike",
            "specializationId": "Myrkgengr",
            "tier": 2,
            "type": "Attack",
            "apCost": 3,
            "cooldown": 0,
            "resourceCost": {
                "resourceId": "shadow-essence",
                "amount": 15
            },
            "range": {
                "value": 1,
                "unit": "Spaces",
                "requiresLineOfSight": true
            },
            "targetType": "Creature",
            "ppCost": 4,
            "ppRequirement": 8,
            "description": "Strike from the shadows with devastating force. Deals weapon damage + 2d6 shadow damage. Must be in Darkness or Dim Light. On critical hit, +1d6 additional shadow damage.",
            "detailedDescription": "You step from shadow and deliver a strike empowered by darkness itself. Your weapon glows with shadow essence, adding supernatural force to your attack.",
            "requirements": {
                "casterLightLevel": ["Darkness", "DimLight"],
                "minimumEssence": 15,
                "targetDistance": "Melee (adjacent)"
            },
            "effects": [
                {
                    "type": "WeaponAttack",
                    "rollModifier": 0,
                    "advantage": false
                },
                {
                    "type": "BonusDamage",
                    "dice": "2d6",
                    "damageType": "Shadow",
                    "bypasses": "NonMagicalArmor"
                },
                {
                    "type": "CriticalBonusDamage",
                    "dice": "1d6",
                    "damageType": "Shadow",
                    "onlyOnCritical": true
                },
                {
                    "type": "AdvantageOnSurprise",
                    "condition": "TargetUnaware"
                }
            ],
            "cloneInteraction": {
                "canConsumeClone": true,
                "cloneConsumptionBenefit": {
                    "type": "AdvantagePlusBonus",
                    "bonusDamage": "1d4",
                    "damageType": "Shadow"
                }
            },
            "corruptionRisk": {
                "trigger": "TargetIsCoherent",
                "amount": 1
            },
            "combatUse": "Burst damage from stealth",
            "synergies": ["shadow-clone", "cloak-of-night"]
        },
        {
            "abilityId": "shadow-clone",
            "displayName": "Shadow Clone",
            "specializationId": "Myrkgengr",
            "tier": 2,
            "type": "Active",
            "apCost": 2,
            "cooldown": 0,
            "resourceCost": {
                "resourceId": "shadow-essence",
                "amount": 20
            },
            "range": {
                "value": 3,
                "unit": "Spaces",
                "requiresLineOfSight": false
            },
            "duration": {
                "value": 1,
                "unit": "Minutes"
            },
            "ppCost": 4,
            "ppRequirement": 8,
            "description": "Create an illusory shadow duplicate within 3 spaces. Clone has 1 HP and cannot attack. Enemies must succeed DC 14 Perception to identify as illusion. Maximum 2 clones active.",
            "cloneProperties": {
                "hitPoints": 1,
                "defense": "MatchCaster",
                "appearance": "IdenticalToCaster",
                "detectionDc": 14,
                "maxActive": 2,
                "expirationMinutes": 1
            },
            "behaviors": [
                {
                    "name": "Mirror",
                    "description": "Copies caster's exact movements",
                    "detectionPenalty": 0
                },
                {
                    "name": "Independent",
                    "description": "Moves randomly within 6 spaces",
                    "detectionPenalty": -1
                },
                {
                    "name": "Decoy",
                    "description": "Moves toward nearest enemy",
                    "detectionPenalty": -2
                },
                {
                    "name": "Static",
                    "description": "Remains stationary",
                    "detectionPenalty": 0
                }
            ],
            "corruptionRisk": {
                "trigger": "CreatedInBrightLight",
                "amount": 1
            },
            "combatUse": "Tactical positioning and distraction",
            "synergies": ["umbral-strike", "cloak-of-night"]
        },
        {
            "abilityId": "void-touched",
            "displayName": "Void Touched",
            "specializationId": "Myrkgengr",
            "tier": 2,
            "type": "Passive",
            "apCost": 0,
            "cooldown": 0,
            "resourceCost": null,
            "ppCost": 4,
            "ppRequirement": 8,
            "description": "Your connection to the void grants resistance to Aetheric damage. Take half damage from Aetheric sources and gain advantage on saves against Aetheric effects.",
            "passiveEffects": [
                {
                    "type": "DamageResistance",
                    "damageType": "Aetheric",
                    "multiplier": 0.5,
                    "rounding": "Down"
                },
                {
                    "type": "SaveAdvantage",
                    "affectedSaves": ["Aetheric", "MagicalEffects"],
                    "condition": "TargetIsAetheric"
                },
                {
                    "type": "StatusEffectMitigation",
                    "source": "Aetheric",
                    "penalty": -2
                }
            ],
            "limitations": [
                "Does not protect against physical damage",
                "Does not protect against Corruption",
                "Does not protect against non-Aetheric effects"
            ],
            "stacking": "Stacks with other Aetheric resistances",
            "combatUse": "Magical defense and survivability",
            "synergies": []
        }
    ]
}
```

---

## 13. Clone Behavior System

### 13.1 Behavior Processing Algorithm

**Each turn, for each active clone:**

```
1. Retrieve clone behavior type
2. Based on behavior:

   MIRROR:
   ├─ Get caster's movement this turn
   ├─ Mirror exact movement
   ├─ Verify destination is valid
   └─ Update clone position

   INDEPENDENT:
   ├─ 50% chance: move randomly
   ├─ If move: 4 spaces max in random direction
   ├─ If no move: stay in place
   └─ Update clone position

   DECOY:
   ├─ Find nearest enemy (by distance)
   ├─ Move clone toward that enemy (4 spaces max)
   ├─ Avoid moving into danger if possible
   └─ Update clone position

   STATIC:
   ├─ Do not move
   ├─ Clone remains in place
   └─ No position update

3. Check if clone expired (1 minute)
4. Mark as destroyed if expired
5. All clones become apparent after turn ends
```

### 13.2 Behavior Selection UI

```
Shadow Clone options at creation:

/clone <position> mirror      → Copies your movements
/clone <position> independent → Random movement
/clone <position> decoy       → Attacks nearest enemy (distraction)
/clone <position> static      → Remains in place (bait)

Default: mirror (if no behavior specified)
```

---

## 14. Damage Calculation Examples

### 14.1 Scenario: Standard Umbral Strike

```
Setup:
• Caster: Myrk-gengr with d8 longsword +3 modifier
• Target: Enemy with Defense 13
• Caster in Darkness
• Attack Roll: d20 + 4 (attack mod) = 15 (+4 = 19)

Resolution:
• Attack vs. Defense: 19 >= 13 → HIT
• Weapon damage: d8 = 6, +3 = 9
• Shadow damage: d6 = 4, d6 = 5 → 9
• Critical: No (rolled 15, not 20)

Result:
Damage: 9 (physical) + 9 (shadow) = 18 total
Shadow Essence: 35/50 (spent 15)
Corruption: 0 (enemy not Coherent, in darkness)
```

### 14.2 Scenario: Critical Umbral Strike

```
Setup:
• Same as above, but Attack Roll = 20 (critical)

Resolution:
• Attack: CRITICAL HIT
• Weapon damage: 9
• Shadow damage: 9
• Critical shadow bonus: d6 = 3

Result:
Damage: 9 (phys) + 9 (shadow) + 3 (crit shadow) = 21 total
Message: "Your shadow-empowered strike finds its mark!
         The darkness amplifies the blow! Critical Strike!"
```

### 14.3 Scenario: Umbral Strike with Clone Consumption

```
Setup:
• Same as scenario 1, but caster has active shadow clone
• Caster chooses to consume clone for advantage

Resolution:
• Attack rolls: d20 + 4 = 12, d20 + 4 = 18 → use 18
• Attack vs Defense: 18 >= 13 → HIT
• Weapon damage: 9
• Shadow damage: 9 + 1d4 = 9 + 3 = 12
• Clone destroyed (consumed)

Result:
Damage: 9 (phys) + 12 (shadow+bonus) = 21 total
Active Clones: 1/2 (one consumed)
Message: "You pull the clone's essence into your strike!"
```

### 14.4 Scenario: Void Touched Damage Reduction

```
Setup:
• Enemy casts Seiðr Bolt: 3d6 = 14 damage (Aetheric)
• Target is Myrk-gengr with Void Touched

Resolution:
• Incoming: 14 Aetheric damage
• Void Touched: 14 / 2 = 7 damage
• Character takes: 7 damage

Alternative:
• If no Void Touched: 14 damage taken
• With Void Touched: 7 damage taken
• Reduction: 50% (7 damage avoided)
```

---

## 15. State Machine Diagrams

### 15.1 Shadow Clone Lifecycle

```
┌──────────────────────────────┐
│  Clone Creation              │
│  Shadow Clone ability used   │
└────────────┬─────────────────┘
             │
             ▼
┌──────────────────────────────┐
│  Active (Behavior Running)   │
│                              │
│ • Clone exists and moves     │
│ • Enemies can target clone   │
│ • Time until expiration: <60 │
└────┬─────────────────────────┘
     │
     ├─ Any damage >= 1
     │  ▼
     │ ┌──────────────────┐
     │ │ Destroyed        │
     │ │ (HP too low)     │
     │ └──────────────────┘
     │
     ├─ Consumed by Umbral Strike
     │  ▼
     │ ┌──────────────────┐
     │ │ Consumed         │
     │ │ (For advantage)  │
     │ └──────────────────┘
     │
     └─ 1 minute passes
        ▼
     ┌──────────────────┐
     │ Expired          │
     │ (Auto-destroy)   │
     └──────────────────┘
```

### 15.2 Umbral Strike Attack Resolution

```
┌──────────────────────┐
│ Umbral Strike Used   │
└────────┬─────────────┘
         │
         ▼
┌──────────────────────────────┐
│ Validate Requirements         │
├──────────────────────────────┤
│ 1. In shadow (Darkness/Dim)? │
│ 2. 15+ Shadow Essence?       │
│ 3. Target adjacent?          │
└────┬─────────────────────────┘
     │
  ┌──┴──┐
  │     │
  NO   YES
  │     │
  │     ▼
  │  ┌─────────────────────┐
  │  │ Spend 15 Essence    │
  │  └────────┬────────────┘
  │           │
  │           ▼
  │  ┌──────────────────┐
  │  │ Roll d20 Attack  │
  │  └────┬─────────────┘
  │       │
  │       ▼
  │  ┌──────────────────┐
  │  │ Compare vs Def   │
  │  └────┬────────────┬┘
  │       │            │
  │      HIT          MISS
  │       │            │
  │       ▼            ▼
  │  ┌──────────────────┐  ┌──────────────────┐
  │  │ Calculate Dam    │  │ No Damage        │
  │  │ • Weapon + 2d6   │  │ Report Miss      │
  │  │ • +1d6 if crit   │  └──────────────────┘
  │  └────┬─────────────┘
  │       │
  │       ▼
  │  ┌──────────────────┐
  │  │ Check Clone Use  │
  │  │ (optional)       │
  │  └────┬─────────────┘
  │       │
  │       ▼
  │  ┌──────────────────┐
  │  │ Apply Damage     │
  │  └────┬─────────────┘
  │       │
  │       ▼
  │  ┌──────────────────┐
  │  │ Check Corruption │
  │  └────┬─────────────┘
  │       │
  │       ▼
  │  ┌──────────────────┐
  │  │ Return Result    │
  │  └──────────────────┘
  │
  ▼
┌──────────────────┐
│ Failure          │
│ Return error msg │
└──────────────────┘
```

---

## 16. Corruption Mechanics for Tier 2

### 16.1 Umbral Strike Corruption

**Triggers:**

```
Using Umbral Strike against Coherent-aligned target: +1 Corruption
Using Umbral Strike against innocent/non-combatant: +1 Corruption
Total possible: 0-2 Corruption per use

Examples:
• Attacking evil creature: 0 Corruption
• Attacking neutral creature: +1 Corruption
• Attacking good/holy creature: +2 Corruption
• Attacking innocent: +2 Corruption (potentially +3 if both apply)
```

### 16.2 Shadow Clone Corruption

**Triggers:**

```
Creating clone in Darkness/DimLight: 0 Corruption
Creating clone in Normal Light: +1 Corruption
Creating clone in Bright Light: +1 Corruption
Total possible: 0-1 Corruption per creation
```

### 16.3 Void Touched Corruption

**Never triggers corruption:**

```
Passive ability - never causes Corruption
Only reduces incoming Aetheric damage
No moral or Heretical implications
```

---

## 17. Combat Interaction Examples

### 17.1 Example Combat Turn

```
Turn Sequence:

SETUP:
• Myrk-gengr character named Ragnhild
• HP 22/22, Essence 45/50
• In Darkness with 2 enemies nearby

RAGNHILD'S TURN:
1. Movement: Move 2 spaces closer (4 spaces available)
2. Action: Create Shadow Clone
   └─ Cost: 20 Essence
   └─ Behavior: Decoy (toward enemy)
   └─ Clone appears 3 spaces away
   └─ Essence now: 25/50
3. Bonus Action: None
4. End of Turn:
   └─ No stance maintenance
   └─ Cloak of Night not active
   └─ Essence stays 25/50

ENEMY TURN:
Enemy 1 (Orc):
• Sees Ragnhild
• Sees clone 3 spaces away
• Perception roll: 18 vs DC 14 → DETECTED CLONE
• Moves toward real Ragnhild
• Attacks Ragnhild (not clone)

Enemy 2 (Goblin):
• Perception roll: 9 vs DC 14 → FAILED
• Sees both, treats clone as real ally
• Moves away from clone
• Attacks clone
└─ Clone has 1 HP → DESTROYED
└─ Clone defeated by goblin

RESULTS:
• Ragnhild unharmed but essence low
• Clone used as distraction
• Goblin wasted turn on illusion
• Orc correctly identified Ragnhild
• Essence: 25/50 (recovers to 30/50 next darkness turn)
```

### 17.2 Shadow Clone Surprise

```
SETUP:
• Myrk-gengr wants to sneak attack
• Dimly lit room with 2 enemies
• Caster 6 spaces away, hidden behind pillar

EXECUTION:
1. Create Shadow Clone (2 AP, 20 Essence)
   └─ Clone appears 3 spaces away
   └─ Behavior: Mirror

2. Use Shadow Step (2 AP, 10 Essence)
   └─ Step through shadow to adjacent enemy
   └─ Now 1 space from target

ENEMY TURN:
Enemy 1:
• Sees clone moving with caster's original position
• Perception check: 12 vs DC 14 → FAILED
• Believes clone is the real Ragnhild
• Attacks clone (1 HP) → DESTROYED
• Wasted turn

Enemy 2:
• Notices discrepancy
• Perception check: 16 vs DC 14 → DETECTED
• Identifies original position is wrong
• Targets real Ragnhild
• But Ragnhild already moved...

RAGNHILD'S NEXT TURN:
• Use Umbral Strike (3 AP, 15 Essence)
• From darkness, adjacent to Enemy 2
• Attack roll: 18 vs Defense 12 → HIT
• Damage: 9 (weapon) + 9 (2d6 shadow) = 18

RESULT:
• Successfully positioned using clone as distraction
• Delivered powerful opening strike
• Two clones and step = 30 essence (60% of pool)
• Essence now: 15/50, but positioned for advantage
```

---

## 18. Logging Specifications

### 18.1 Ability Execution Logging

```
[INFO] Umbral Strike executed: {CharId} → {TargetId}
       Hit: Yes | Damage: 18 (9 phys + 9 shadow)
       Critical: No | Corruption: No

[INFO] Shadow Clone created: {CloneId}
       Owner: {CharId} | Position: (15, 20) | Behavior: Mirror
       Duration: 60 seconds | Max Active: 2/2

[DEBUG] Void Touched damage reduction:
        Incoming Aetheric: 14 → Reduced: 7 (50%)
```

### 18.2 Corruption Logging

```
[WARN] Corruption applied: +1 to {CharId}
       Ability: Umbral Strike | Target Alignment: Coherent | Reason: Attacking good creature

[INFO] Corruption risk evaluated:
       Ability: Shadow Clone | Light Level: Bright Light | Corruption: +1
```

---

## 19. Unit Testing Requirements

### 19.1 UmbralStrikeTests (~3 tests)

```csharp
[TestFixture]
public class UmbralStrikeTests
{
    [Test]
    public async Task ExecuteUmbralStrike_ValidTarget_DealsCorrectDamage()
    {
        // Arrange
        var caster = CreateCharacter(inDarkness: true, essence: 50);
        var target = CreateCharacter(defense: 12);

        // Act
        var result = await _service.ExecuteUmbralStrikeAsync(caster.Id, target.Id);

        // Assert
        Assert.That(result.IsHit, Is.True);
        Assert.That(result.BaseDamage + result.ShadowDamage, Is.GreaterThan(0));
    }

    [Test]
    public async Task ExecuteUmbralStrike_InBrightLight_Fails()
    {
        // Arrange
        var caster = CreateCharacter(inBrightLight: true);

        // Act
        var result = await _service.ExecuteUmbralStrikeAsync(caster.Id, targetId);

        // Assert
        Assert.That(result.IsHit, Is.False);
    }

    [Test]
    public async Task ExecuteUmbralStrike_InsufficientEssence_Fails()
    {
        // Arrange
        var caster = CreateCharacter(essence: 5); // Less than 15 required

        // Act
        var result = await _service.ExecuteUmbralStrikeAsync(caster.Id, targetId);

        // Assert
        Assert.That(result.IsHit, Is.False);
    }
}
```

### 19.2 ShadowCloneTests (~3 tests)

```csharp
[TestFixture]
public class ShadowCloneTests
{
    [Test]
    public async Task CreateClone_ValidLocation_CreatesClone()
    {
        // Arrange
        var caster = CreateCharacter(essence: 50);

        // Act
        var clone = await _service.CreateShadowCloneAsync(caster.Id, 15, 20, CloneBehavior.Mirror);

        // Assert
        Assert.That(clone, Is.Not.Null);
        Assert.That(clone.IsActive(), Is.True);
    }

    [Test]
    public async Task CreateClone_MaxActive_Fails()
    {
        // Arrange
        var caster = CreateCharacter(essence: 50);
        await _service.CreateShadowCloneAsync(caster.Id, 15, 20, CloneBehavior.Mirror);
        await _service.CreateShadowCloneAsync(caster.Id, 20, 20, CloneBehavior.Mirror);

        // Act & Assert
        Assert.ThrowsAsync<InvalidOperationException>(
            () => _service.CreateShadowCloneAsync(caster.Id, 25, 20, CloneBehavior.Mirror));
    }

    [Test]
    public async Task CloneDetection_AgainstDC14_CalculatesCorrectly()
    {
        // Arrange
        var clone = CreateClone(detectionDc: 14);

        // Act
        bool detected = await _manager.IsCloneDetectedAsync(clone.Id, characterId);

        // Assert
        // Perception roll vs DC 14 determines detection
        Assert.That(detected, Is.TypeOf<bool>());
    }
}
```

### 19.3 VoidTouchedTests (~2 tests)

```csharp
[TestFixture]
public class VoidTouchedTests
{
    [Test]
    public void ApplyVoidTouched_ReducesAethericDamage()
    {
        // Arrange
        int incomingDamage = 14;

        // Act
        int reduced = _service.ApplyVoidTouched(incomingDamage);

        // Assert
        Assert.That(reduced, Is.EqualTo(7)); // 50% reduction
    }

    [Test]
    public void ApplyVoidTouched_RoundsDown()
    {
        // Arrange
        int incomingDamage = 15;

        // Act
        int reduced = _service.ApplyVoidTouched(incomingDamage);

        // Assert
        Assert.That(reduced, Is.EqualTo(7)); // 15 / 2 = 7.5 → 7
    }
}
```

---

## 20. Deliverable Checklist

### Domain Layer

- [ ] `ShadowClone` value object
- [ ] `UmbralStrikeResult` value object
- [ ] `DamageBreakdown` value object
- [ ] `CloneBehavior` enum
- [ ] Shadow damage type integration

### Application Layer

- [ ] `ITier2AbilityService` interface
- [ ] `Tier2AbilityService` implementation
- [ ] `IShadowCloneManager` interface
- [ ] `ShadowCloneManager` implementation
- [ ] `ICloneBehaviorProcessor` interface
- [ ] `CloneBehaviorProcessor` implementations (4)

### Infrastructure & Integration

- [ ] Damage calculation for shadow damage type
- [ ] Aetheric resistance integration
- [ ] Character modifications for clone support
- [ ] Tier 2 unlock validation
- [ ] Configuration updates (abilities.json)

### Tests

- [ ] `UmbralStrikeTests` (~3 tests)
- [ ] `ShadowCloneTests` (~3 tests)
- [ ] `VoidTouchedTests` (~2 tests)
- [ ] Total: ~8 tests

---

## 21. Acceptance Criteria

### Functional Acceptance

- [ ] Umbral Strike requires being in shadow (Darkness/DimLight)
- [ ] Umbral Strike costs 15 Shadow Essence
- [ ] Umbral Strike deals weapon damage + 2d6 shadow damage
- [ ] Umbral Strike deals +1d6 shadow damage on critical hits
- [ ] Umbral Strike automatically hits surprised targets
- [ ] Shadow Clone costs 20 Shadow Essence
- [ ] Shadow Clone lasts 1 minute or until destroyed
- [ ] Shadow Clone has 1 HP (destroyed by any damage)
- [ ] Shadow Clone detection DC is 14
- [ ] Maximum 2 shadow clones active simultaneously
- [ ] Void Touched reduces Aetheric damage by 50%
- [ ] Void Touched grants advantage on Aetheric saves
- [ ] Tier 2 abilities locked until 8 PP invested
- [ ] Each Tier 2 ability costs 4 PP to unlock
- [ ] Corruption integration working for all Tier 2 abilities

### Performance Acceptance

- [ ] Ability execution < 200ms
- [ ] Clone creation < 100ms
- [ ] Clone behavior processing < 150ms
- [ ] Damage calculation < 50ms

### Test Coverage

- [ ] Minimum 8 unit tests pass
- [ ] 85%+ code coverage for services
- [ ] All ability paths tested

---

## 22. Design Decisions & Rationale

### Decision: 2d6 Shadow Damage Bonus

**Rationale:**
- Scales well with weapon damage (1d8+3 → 8-11 base)
- 2d6 averages 7, creating meaningful damage (40-60% boost)
- Not overpowering compared to other Tier 2 abilities
- Encourages positioning in shadow (requirement adds tactical depth)

### Decision: Shadow Clone Maximum 2 Active

**Rationale:**
- Prevents clone spam (3+ would be overwhelming)
- Balances resource cost (20 essence each)
- Keeps tactical options clear (manageable number)
- Matches pattern from other summoning abilities

### Decision: Void Touched as Passive Only

**Rationale:**
- Passive fits thematic "void connection"
- Always-on benefit encourages magical encounters
- No activation cost encourages magical defense
- Simplifies mechanic (no upkeep or resource drain)

### Decision: Tier 2 Unlock at 8 PP

**Rationale:**
- Tier 1 available at 0 PP (immediate)
- Tier 2 at 8 PP (roughly 1/3 of max tree)
- Tier 3 at 16 PP (2/3 of max)
- Capstone at 24 PP (full tree)
- Creates meaningful progression gates
- Matches v0.20.x patterns

---

## Conclusion

**v0.20.4b** expands the Myrk-gengr specialization with powerful Tier 2 abilities that introduce offensive pressure, tactical complexity, and magical defense. **Umbral Strike** provides burst damage capability, **Shadow Clone** enables sophisticated battlefield tactics, and **Void Touched** offers survivability against magical threats.

Together with Tier 1 abilities (Shadow Step, Cloak of Night, Dark-Adapted), Tier 2 creates a complete stealth/assassin specialization with depth and flexibility for varied playstyles.

**Next phase:** v0.20.4c - Tier 3 & Capstone abilities (Merge with Darkness, Shadow Snare, Eclipse)

---

_End of v0.20.4b Design Specification_
