# v0.7.2 Main Menu - Scope Breakdown

**Version:** 0.7.2
**Theme:** Interactive Panels
**Prerequisites:** v0.7.1c Complete (Core Display Panels - Message Log)
**Total Estimated Tests:** ~30 new tests

---

## Executive Summary

The Interactive Panels sub-version implements panels that allow direct user interaction: a clickable inventory panel with item selection and management, context menus for items and monsters (right-click actions), and the command input panel with history navigation and tab completion. These components transform the GUI from read-only displays to a fully interactive experience.

Key focus areas:
- **Inventory Panel**: Clickable item grid with selection and details
- **Context Menus**: Right-click actions for items, equipment, and monsters
- **Command Input**: Text input with history and auto-completion

The work is divided into **three sub-parts**:

| Part | Name | Focus | Est. Tests |
|------|------|-------|------------|
| v0.7.2a | Inventory Panel | Clickable grid, item selection, details display | ~10 |
| v0.7.2b | Context Menus | Right-click menus for items and entities | ~10 |
| v0.7.2c | Command Input Panel | Text input, history, tab completion popup | ~10 |

---

## Existing Infrastructure

### Already Implemented (from v0.7.2)

| Feature | Location | Notes |
|---------|----------|-------|
| RoomDisplayPanel | `Views/RoomDisplayPanel.axaml` | Room view |
| PlayerStatusPanel | `Views/PlayerStatusPanel.axaml` | Status view |
| MessageLogPanel | `Views/MessageLogPanel.axaml` | Message view |
| HealthBarControl | `Controls/HealthBarControl.cs` | Bar control |
| WindowLayoutService | `Services/WindowLayoutService.cs` | Panel regions |

### Already Implemented (from prior versions)

| Feature | Location | Notes |
|---------|----------|-------|
| Inventory | `Domain/Entities/Inventory.cs` | Item storage |
| Item | `Domain/Entities/Item.cs` | Item data |
| CommandHistoryService | `Application/Services/CommandHistoryService.cs` | Input history |
| TabCompletionService | `Application/Services/TabCompletionService.cs` | Auto-complete |
| CommandHandler | `Presentation/Commands/CommandHandler.cs` | Command processing |

### Needs Implementation (v0.7.2)

| Feature | Part | Notes |
|---------|------|-------|
| InventoryPanel | v0.7.2a | Clickable grid UserControl |
| InventoryPanelViewModel | v0.7.2a | Item state binding |
| ItemSlotControl | v0.7.2a | Individual slot control |
| IContextMenuService | v0.7.2b | Menu interface |
| ContextMenuService | v0.7.2b | Menu creation |
| ItemContextMenu | v0.7.2b | Item actions menu |
| EntityContextMenu | v0.7.2b | Monster actions menu |
| CommandInputPanel | v0.7.1c | Input UserControl |
| CommandInputViewModel | v0.7.1c | Input state binding |
| CompletionPopupControl | v0.7.1c | Suggestion popup |

---

## Feature Analysis & Categorization

### Inventory Features

| Feature | Complexity | Dependencies | Assigned Part |
|---------|------------|--------------|---------------|
| Item grid display | Medium | Inventory entity | **v0.7.2a** |
| Item selection | Low | Click handling | **v0.7.2a** |
| Item details display | Low | Selected item | **v0.7.2a** |
| Drag-and-drop reorder | Medium | Avalonia DnD | **v0.7.2a** |

### Context Menu Features

| Feature | Complexity | Dependencies | Assigned Part |
|---------|------------|--------------|---------------|
| Item context menu | Medium | ContextMenu API | **v0.7.2b** |
| Equipment context menu | Medium | Item type detection | **v0.7.2b** |
| Monster context menu | Medium | Entity click | **v0.7.2b** |
| Action execution | Low | CommandHandler | **v0.7.2b** |

### Command Input Features

| Feature | Complexity | Dependencies | Assigned Part |
|---------|------------|--------------|---------------|
| Text input field | Low | TextBox | **v0.7.1c** |
| History navigation | Medium | CommandHistoryService | **v0.7.1c** |
| Tab completion | High | TabCompletionService | **v0.7.1c** |
| Completion popup | Medium | Popup control | **v0.7.1c** |

---

## Part Definitions

---

## v0.7.2a: Inventory Panel

[v0.7.2a Design Specification](v0.7.2a-design-specification.md)

### Overview

Implement the interactive inventory panel that displays items in a clickable grid. Users can select items to view details, and optionally reorder items via drag-and-drop. The panel integrates with context menus (v0.7.2b) for item actions.

### Scope

**In Scope:**
- `InventoryPanel` UserControl
- `InventoryPanelViewModel` with item binding
- `ItemSlotControl` for grid slots
- Item grid layout (configurable columns)
- Click-to-select items
- Selected item highlighting
- Item details pane (name, description, stats)
- Category icons
- Empty slot display
- Capacity indicator
- Basic drag-and-drop reordering
- Keyboard navigation (arrow keys)

**Out of Scope:**
- Context menus (v0.7.2b)
- Command input (v0.7.1c)
- Equipment management UI (v0.8.0)

### Key Deliverables

| Type | Count | Details |
|------|-------|---------|
| User Controls | 2 | `InventoryPanel`, `ItemSlotControl` |
| ViewModels | 2 | `InventoryPanelViewModel`, `ItemSlotViewModel` |
| Behaviors | 1 | Drag-and-drop behavior |
| Styles | 1 | `InventoryStyles.axaml` |
| Unit Tests | ~10 | Selection, grid layout tests |

### Inventory Panel Design

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           INVENTORY                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                     â”‚
â”‚ â”Œâ”€â”€â”€â” â”Œâ”€â”€â”€â” â”Œâ”€â”€â”€â” â”Œâ”€â”€â”€â” â”Œâ”€â”€â”€â”      â”‚
â”‚ â”‚ âš” â”‚ â”‚ ğŸ›¡ â”‚ â”‚ ğŸ§ªâ”‚ â”‚ ğŸ§ªâ”‚ â”‚ ğŸ”‘â”‚      â”‚   Row 1
â”‚ â”‚Swdâ”‚ â”‚Shdâ”‚ â”‚Potâ”‚ â”‚Potâ”‚ â”‚Keyâ”‚      â”‚
â”‚ â””â”€â”€â”€â”˜ â””â”€â”€â”€â”˜ â””â”€â”€â”€â”˜ â””â”€â”€â”€â”˜ â””â”€â”€â”€â”˜      â”‚
â”‚ â”Œâ”€â”€â”€â” â”Œâ”€â”€â”€â” â”Œâ”€â”€â”€â” â”Œâ”€â”€â”€â” â”Œâ”€â”€â”€â”      â”‚
â”‚ â”‚ ğŸ“œâ”‚ â”‚ ğŸ’â”‚ â”‚â–“â–“â–“â”‚ â”‚   â”‚ â”‚   â”‚      â”‚   Row 2 (â–“ = selected)
â”‚ â”‚Scrâ”‚ â”‚Rngâ”‚ â”‚Gemâ”‚ â”‚   â”‚ â”‚   â”‚      â”‚
â”‚ â””â”€â”€â”€â”˜ â””â”€â”€â”€â”˜ â””â”€â”€â”€â”˜ â””â”€â”€â”€â”˜ â””â”€â”€â”€â”˜      â”‚
â”‚ â”Œâ”€â”€â”€â” â”Œâ”€â”€â”€â” â”Œâ”€â”€â”€â” â”Œâ”€â”€â”€â” â”Œâ”€â”€â”€â”      â”‚
â”‚ â”‚   â”‚ â”‚   â”‚ â”‚   â”‚ â”‚   â”‚ â”‚   â”‚      â”‚   Row 3 (empty)
â”‚ â”‚   â”‚ â”‚   â”‚ â”‚   â”‚ â”‚   â”‚ â”‚   â”‚      â”‚
â”‚ â””â”€â”€â”€â”˜ â””â”€â”€â”€â”˜ â””â”€â”€â”€â”˜ â””â”€â”€â”€â”˜ â””â”€â”€â”€â”˜      â”‚
â”‚                                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ ğŸ’ Red Gem                      â”‚ â”‚
â”‚ â”‚                                 â”‚ â”‚
â”‚ â”‚ A brilliant red gemstone that  â”‚ â”‚
â”‚ â”‚ sparkles with inner fire.      â”‚ â”‚
â”‚ â”‚                                 â”‚ â”‚
â”‚ â”‚ Type: Treasure                  â”‚ â”‚
â”‚ â”‚ Value: 50 gold                  â”‚ â”‚
â”‚ â”‚ Weight: 0.5 lbs                 â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Capacity: 8/15 items                â”‚
â”‚ Weight: 12.5/50 lbs                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ItemSlotControl

```csharp
namespace RuneAndRust.Avalonia.Controls;

/// <summary>
/// Represents a single inventory slot.
/// </summary>
public class ItemSlotControl : TemplatedControl
{
    public static readonly StyledProperty<Item?> ItemProperty =
        AvaloniaProperty.Register<ItemSlotControl, Item?>(nameof(Item));
    
    public static readonly StyledProperty<bool> IsSelectedProperty =
        AvaloniaProperty.Register<ItemSlotControl, bool>(nameof(IsSelected));
    
    public static readonly StyledProperty<bool> IsEmptyProperty =
        AvaloniaProperty.Register<ItemSlotControl, bool>(nameof(IsEmpty), true);
    
    public Item? Item
    {
        get => GetValue(ItemProperty);
        set => SetValue(ItemProperty, value);
    }
    
    public bool IsSelected
    {
        get => GetValue(IsSelectedProperty);
        set => SetValue(IsSelectedProperty, value);
    }
    
    public bool IsEmpty => Item is null;
    
    public string Icon => Item?.GetCategoryIcon() ?? " ";
    public string ShortName => Item?.Name.Substring(0, Math.Min(3, Item.Name.Length)) ?? "";
    public string Tooltip => Item?.Name ?? "Empty Slot";
}
```

### InventoryPanelViewModel

```csharp
namespace RuneAndRust.Avalonia.ViewModels;

public partial class InventoryPanelViewModel : ViewModelBase
{
    private readonly IGameSessionService _gameSession;
    
    [ObservableProperty]
    private ObservableCollection<ItemSlotViewModel> _slots = new();
    
    [ObservableProperty]
    private ItemSlotViewModel? _selectedSlot;
    
    [ObservableProperty]
    private Item? _selectedItem;
    
    [ObservableProperty]
    private int _currentCapacity;
    
    [ObservableProperty]
    private int _maxCapacity;
    
    [ObservableProperty]
    private double _currentWeight;
    
    [ObservableProperty]
    private double _maxWeight;
    
    public int GridColumns { get; } = 5;
    
    public InventoryPanelViewModel(IGameSessionService gameSession)
    {
        _gameSession = gameSession;
        _gameSession.OnInventoryChanged += HandleInventoryChanged;
        
        InitializeSlots();
    }
    
    [RelayCommand]
    private void SelectSlot(ItemSlotViewModel slot)
    {
        // Deselect previous
        if (SelectedSlot is not null)
            SelectedSlot.IsSelected = false;
        
        // Select new
        SelectedSlot = slot;
        slot.IsSelected = true;
        SelectedItem = slot.Item;
    }
    
    [RelayCommand]
    private void MoveItem(ItemSlotViewModel from, ItemSlotViewModel to)
    {
        if (from.Item is null) return;
        
        // Swap items
        (from.Item, to.Item) = (to.Item, from.Item);
        
        // Update inventory
        _gameSession.ReorderInventory(from.Index, to.Index);
    }
    
    private void InitializeSlots()
    {
        Slots.Clear();
        for (int i = 0; i < MaxCapacity; i++)
        {
            Slots.Add(new ItemSlotViewModel { Index = i });
        }
    }
    
    private void HandleInventoryChanged(Inventory inventory)
    {
        CurrentCapacity = inventory.Items.Count;
        MaxCapacity = inventory.MaxCapacity;
        CurrentWeight = inventory.TotalWeight;
        MaxWeight = inventory.MaxWeight;
        
        // Update slot items
        for (int i = 0; i < Slots.Count; i++)
        {
            Slots[i].Item = i < inventory.Items.Count ? inventory.Items[i] : null;
        }
    }
}
```

### Acceptance Criteria

- [ ] Inventory grid displays items
- [ ] Click on slot selects item
- [ ] Selected slot is highlighted
- [ ] Item details show for selected item
- [ ] Empty slots display correctly
- [ ] Category icons display
- [ ] Capacity indicator updates
- [ ] Arrow keys navigate slots
- [ ] Drag-and-drop reorders items
- [ ] Grid columns configurable
- [ ] ~10 unit tests pass

---

## v0.7.2b: Context Menus

[v0.7.2b Design Specification](v0.7.2b-design-specification.md)

### Overview

Implement context menu functionality for right-click actions on items, equipment, and monsters. Context menus provide quick access to common actions without typing commands.

### Scope

**In Scope:**
- `IContextMenuService` interface
- `ContextMenuService` implementation
- Item context menu (Use, Equip, Drop, Examine)
- Consumable context menu (Use, Drop, Examine)
- Weapon/Armor context menu (Equip, Drop, Examine)
- Equipped item menu (Unequip, Examine)
- Monster context menu (Attack, Examine)
- NPC context menu (Talk, Examine)
- Ground item menu (Take, Examine)
- Menu action execution
- Menu styling

**Out of Scope:**
- Inventory panel (v0.7.2a)
- Command input (v0.7.1c)
- Shop context menu (v0.8.0)

### Key Deliverables

| Type | Count | Details |
|------|-------|---------|
| Interfaces | 1 | `IContextMenuService` |
| Services | 1 | `ContextMenuService` |
| Context Menus | 5 | Item, consumable, equipment, entity, ground |
| Menu Actions | 8 | Use, Equip, Unequip, Drop, Take, Attack, Talk, Examine |
| Styles | 1 | `ContextMenuStyles.axaml` |
| Unit Tests | ~10 | Menu creation, action tests |

### Context Menu Designs

```
GENERIC ITEM MENU:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸ’ Red Gem           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ğŸ” Examine           â”‚
â”‚ â¬‡ï¸ Drop              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ âŒ Cancel            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

CONSUMABLE MENU:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸ§ª Healing Potion    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ğŸ” Examine           â”‚
â”‚ âœ‹ Use               â”‚
â”‚ â¬‡ï¸ Drop              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ âŒ Cancel            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

WEAPON MENU:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ âš” Iron Sword         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ğŸ” Examine           â”‚
â”‚ âš” Equip             â”‚
â”‚ â¬‡ï¸ Drop              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ âŒ Cancel            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

EQUIPPED ITEM MENU:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ âš” Iron Sword [E]     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ğŸ” Examine           â”‚
â”‚ â¬†ï¸ Unequip           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ âŒ Cancel            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

MONSTER MENU:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ â˜  Skeleton           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ğŸ” Examine           â”‚
â”‚ âš” Attack            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ âŒ Cancel            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

NPC MENU:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸ‘¤ Shopkeeper        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ğŸ” Examine           â”‚
â”‚ ğŸ’¬ Talk              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ âŒ Cancel            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

GROUND ITEM MENU:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸ’ Red Gem [Ground]  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ğŸ” Examine           â”‚
â”‚ âœ‹ Take              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ âŒ Cancel            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### IContextMenuService Interface

```csharp
namespace RuneAndRust.Avalonia.Services;

/// <summary>
/// Creates and manages context menus for game elements.
/// </summary>
public interface IContextMenuService
{
    /// <summary>Creates a context menu for an inventory item.</summary>
    ContextMenu CreateItemMenu(Item item, bool isEquipped = false);
    
    /// <summary>Creates a context menu for a monster.</summary>
    ContextMenu CreateMonsterMenu(Monster monster);
    
    /// <summary>Creates a context menu for an NPC.</summary>
    ContextMenu CreateNpcMenu(Npc npc);
    
    /// <summary>Creates a context menu for a ground item.</summary>
    ContextMenu CreateGroundItemMenu(Item item);
    
    /// <summary>Shows a context menu at the specified location.</summary>
    void ShowMenu(ContextMenu menu, Control target, Point position);
}
```

### ContextMenuService Implementation

```csharp
namespace RuneAndRust.Avalonia.Services;

public class ContextMenuService : IContextMenuService
{
    private readonly IGameSessionService _gameSession;
    private readonly ILogger<ContextMenuService> _logger;
    
    public ContextMenuService(IGameSessionService gameSession, ILogger<ContextMenuService> logger)
    {
        _gameSession = gameSession;
        _logger = logger;
    }
    
    public ContextMenu CreateItemMenu(Item item, bool isEquipped = false)
    {
        var menu = new ContextMenu();
        
        // Header
        menu.Items.Add(new MenuItem 
        { 
            Header = $"{item.GetCategoryIcon()} {item.Name}" + (isEquipped ? " [E]" : ""),
            IsEnabled = false,
            Classes = { "menu-header" }
        });
        menu.Items.Add(new Separator());
        
        // Examine (always available)
        menu.Items.Add(CreateMenuItem("ğŸ” Examine", () => ExecuteCommand($"examine {item.Id}")));
        
        // Type-specific actions
        if (isEquipped)
        {
            menu.Items.Add(CreateMenuItem("â¬†ï¸ Unequip", () => ExecuteCommand($"unequip {item.Id}")));
        }
        else
        {
            if (item.IsConsumable)
                menu.Items.Add(CreateMenuItem("âœ‹ Use", () => ExecuteCommand($"use {item.Id}")));
            
            if (item.IsEquippable)
                menu.Items.Add(CreateMenuItem("âš” Equip", () => ExecuteCommand($"equip {item.Id}")));
            
            menu.Items.Add(CreateMenuItem("â¬‡ï¸ Drop", () => ExecuteCommand($"drop {item.Id}")));
        }
        
        // Cancel
        menu.Items.Add(new Separator());
        menu.Items.Add(CreateMenuItem("âŒ Cancel", () => menu.Close()));
        
        return menu;
    }
    
    public ContextMenu CreateMonsterMenu(Monster monster)
    {
        var menu = new ContextMenu();
        
        menu.Items.Add(new MenuItem 
        { 
            Header = $"â˜  {monster.Name}",
            IsEnabled = false,
            Classes = { "menu-header" }
        });
        menu.Items.Add(new Separator());
        
        menu.Items.Add(CreateMenuItem("ğŸ” Examine", () => ExecuteCommand($"examine {monster.Id}")));
        menu.Items.Add(CreateMenuItem("âš” Attack", () => ExecuteCommand($"attack {monster.Id}")));
        
        menu.Items.Add(new Separator());
        menu.Items.Add(CreateMenuItem("âŒ Cancel", () => menu.Close()));
        
        return menu;
    }
    
    private MenuItem CreateMenuItem(string header, Action action)
    {
        var item = new MenuItem { Header = header };
        item.Click += (_, _) => action();
        return item;
    }
    
    private void ExecuteCommand(string command)
    {
        _logger.LogDebug("Executing context menu command: {Command}", command);
        _gameSession.ExecuteCommand(command);
    }
}
```

### Integration with Inventory Panel

```csharp
// In InventoryPanel.axaml.cs or via behavior
private void OnSlotRightClick(object sender, PointerPressedEventArgs e)
{
    if (e.GetCurrentPoint(this).Properties.IsRightButtonPressed)
    {
        if (sender is ItemSlotControl slot && slot.Item is not null)
        {
            var menu = _contextMenuService.CreateItemMenu(
                slot.Item, 
                isEquipped: _gameSession.IsEquipped(slot.Item));
            
            _contextMenuService.ShowMenu(menu, slot, e.GetPosition(slot));
        }
    }
}
```

### Acceptance Criteria

- [ ] Right-click on inventory item shows menu
- [ ] Item menu shows correct actions for type
- [ ] Consumables show Use option
- [ ] Equipment shows Equip/Unequip
- [ ] Equipped items show [E] indicator
- [ ] Right-click on monster shows attack menu
- [ ] Right-click on NPC shows talk menu
- [ ] Right-click on ground item shows take menu
- [ ] Menu actions execute commands
- [ ] Cancel closes menu
- [ ] ~10 unit tests pass

---

## v0.7.1c: Command Input Panel

[v0.7.1c Design Specification](v0.7.1c-design-specification.md)

### Overview

Implement the command input panel that provides a text input field with command history navigation (up/down arrows) and tab completion with a popup showing suggestions. This integrates the TUI input services with the GUI.

### Scope

**In Scope:**
- `CommandInputPanel` UserControl
- `CommandInputViewModel` with input binding
- `CompletionPopupControl` for suggestions
- Text input field
- Up/down arrow history navigation
- Tab key triggers completion
- Completion popup display
- Arrow key popup navigation
- Enter to accept completion
- Escape to cancel completion
- Command submission on Enter
- Input prompt styling

**Out of Scope:**
- Inventory panel (v0.7.2a)
- Context menus (v0.7.2b)
- Voice commands (future)

### Key Deliverables

| Type | Count | Details |
|------|-------|---------|
| User Controls | 2 | `CommandInputPanel`, `CompletionPopupControl` |
| ViewModels | 1 | `CommandInputViewModel` |
| Behaviors | 1 | Input key handling behavior |
| Styles | 1 | `InputPanelStyles.axaml` |
| Unit Tests | ~10 | History, completion tests |

### Command Input Panel Design

```
STANDARD INPUT:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ > attack skeleton_                                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

WITH HISTORY (up arrow pressed):
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ > go north                                                   [History â–²]â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

WITH COMPLETION POPUP:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ > use hea                                                               â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                          â”‚
â”‚   â”‚ healing-potion        â—„â”€â”€â”‚ (selected)                               â”‚
â”‚   â”‚ health-scroll            â”‚                                          â”‚
â”‚   â”‚ heavy-armor              â”‚                                          â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

COMMAND COMPLETION:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ > at                                                                    â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                          â”‚
â”‚   â”‚ attack              â—„â”€â”€â”€â”€â”‚                                          â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### CommandInputPanel UserControl

```xml
<!-- Views/CommandInputPanel.axaml -->
<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:vm="using:RuneAndRust.Avalonia.ViewModels"
             xmlns:controls="using:RuneAndRust.Avalonia.Controls"
             x:Class="RuneAndRust.Avalonia.Views.CommandInputPanel"
             x:DataType="vm:CommandInputViewModel">
    
    <Panel>
        <DockPanel>
            <!-- Prompt -->
            <TextBlock DockPanel.Dock="Left" 
                       Text="> " 
                       Classes="input-prompt"
                       VerticalAlignment="Center"/>
            
            <!-- Input -->
            <TextBox x:Name="InputBox"
                     Text="{Binding InputText, Mode=TwoWay}"
                     Watermark="Enter command..."
                     Classes="command-input"
                     KeyDown="OnInputKeyDown"/>
        </DockPanel>
        
        <!-- Completion Popup -->
        <Popup x:Name="CompletionPopup"
               IsOpen="{Binding IsCompletionVisible}"
               PlacementTarget="{Binding #InputBox}"
               Placement="Top">
            <controls:CompletionPopupControl 
                Suggestions="{Binding Suggestions}"
                SelectedIndex="{Binding SelectedSuggestionIndex}"
                OnAccepted="OnCompletionAccepted"/>
        </Popup>
    </Panel>
</UserControl>
```

### CommandInputViewModel

```csharp
namespace RuneAndRust.Avalonia.ViewModels;

public partial class CommandInputViewModel : ViewModelBase
{
    private readonly IGameSessionService _gameSession;
    private readonly ICommandHistoryService _history;
    private readonly ITabCompletionService _completion;
    
    [ObservableProperty]
    private string _inputText = string.Empty;
    
    [ObservableProperty]
    private bool _isCompletionVisible;
    
    [ObservableProperty]
    private ObservableCollection<string> _suggestions = new();
    
    [ObservableProperty]
    private int _selectedSuggestionIndex = -1;
    
    [ObservableProperty]
    private bool _isNavigatingHistory;
    
    private string _inputBeforeHistory = string.Empty;
    
    public CommandInputViewModel(
        IGameSessionService gameSession,
        ICommandHistoryService history,
        ITabCompletionService completion)
    {
        _gameSession = gameSession;
        _history = history;
        _completion = completion;
    }
    
    /// <summary>Handles key press events.</summary>
    public bool HandleKeyDown(Key key)
    {
        switch (key)
        {
            case Key.Enter:
                if (IsCompletionVisible && SelectedSuggestionIndex >= 0)
                    AcceptCompletion();
                else
                    SubmitCommand();
                return true;
            
            case Key.Up:
                if (IsCompletionVisible)
                    MoveSuggestionSelection(-1);
                else
                    NavigateHistoryBack();
                return true;
            
            case Key.Down:
                if (IsCompletionVisible)
                    MoveSuggestionSelection(1);
                else
                    NavigateHistoryForward();
                return true;
            
            case Key.Tab:
                TriggerCompletion();
                return true;
            
            case Key.Escape:
                if (IsCompletionVisible)
                {
                    HideCompletion();
                    return true;
                }
                return false;
            
            default:
                return false;
        }
    }
    
    private void SubmitCommand()
    {
        if (string.IsNullOrWhiteSpace(InputText))
            return;
        
        _history.Add(InputText);
        _gameSession.ExecuteCommand(InputText);
        InputText = string.Empty;
        _history.ResetNavigation();
    }
    
    private void NavigateHistoryBack()
    {
        if (!IsNavigatingHistory)
        {
            _inputBeforeHistory = InputText;
            IsNavigatingHistory = true;
        }
        
        var previous = _history.GetPrevious();
        if (previous is not null)
            InputText = previous;
    }
    
    private void NavigateHistoryForward()
    {
        var next = _history.GetNext();
        if (next is not null)
            InputText = next;
        else
        {
            InputText = _inputBeforeHistory;
            IsNavigatingHistory = false;
        }
    }
    
    private void TriggerCompletion()
    {
        if (string.IsNullOrWhiteSpace(InputText))
            return;
        
        var context = CreateCompletionContext();
        var completions = _completion.GetCompletions(InputText, context);
        
        if (completions.Count == 0)
        {
            HideCompletion();
            return;
        }
        
        if (completions.Count == 1)
        {
            // Single match - complete inline
            ApplyCompletion(completions[0]);
            HideCompletion();
        }
        else
        {
            // Multiple matches - show popup
            Suggestions.Clear();
            foreach (var c in completions)
                Suggestions.Add(c);
            
            SelectedSuggestionIndex = 0;
            IsCompletionVisible = true;
        }
    }
    
    private void AcceptCompletion()
    {
        if (SelectedSuggestionIndex >= 0 && SelectedSuggestionIndex < Suggestions.Count)
        {
            ApplyCompletion(Suggestions[SelectedSuggestionIndex]);
        }
        HideCompletion();
    }
    
    private void ApplyCompletion(string completion)
    {
        // Replace current word with completion
        var words = InputText.Split(' ');
        words[^1] = completion;
        InputText = string.Join(' ', words) + " ";
    }
    
    private void HideCompletion()
    {
        IsCompletionVisible = false;
        Suggestions.Clear();
        SelectedSuggestionIndex = -1;
    }
}
```

### CompletionPopupControl

```csharp
namespace RuneAndRust.Avalonia.Controls;

/// <summary>
/// Displays tab completion suggestions.
/// </summary>
public class CompletionPopupControl : TemplatedControl
{
    public static readonly StyledProperty<IEnumerable<string>> SuggestionsProperty =
        AvaloniaProperty.Register<CompletionPopupControl, IEnumerable<string>>(nameof(Suggestions));
    
    public static readonly StyledProperty<int> SelectedIndexProperty =
        AvaloniaProperty.Register<CompletionPopupControl, int>(nameof(SelectedIndex), -1);
    
    public IEnumerable<string> Suggestions
    {
        get => GetValue(SuggestionsProperty);
        set => SetValue(SuggestionsProperty, value);
    }
    
    public int SelectedIndex
    {
        get => GetValue(SelectedIndexProperty);
        set => SetValue(SelectedIndexProperty, value);
    }
    
    public event EventHandler<string>? OnAccepted;
    
    protected override void OnPointerPressed(PointerPressedEventArgs e)
    {
        // Handle click to select
        base.OnPointerPressed(e);
    }
}
```

### Acceptance Criteria

- [ ] Text input accepts typing
- [ ] Enter submits command
- [ ] Command added to history
- [ ] Up arrow recalls previous command
- [ ] Down arrow moves forward in history
- [ ] Tab triggers completion lookup
- [ ] Single match completes inline
- [ ] Multiple matches show popup
- [ ] Arrow keys navigate popup
- [ ] Enter accepts popup selection
- [ ] Escape closes popup
- [ ] Input prompt displays (>)
- [ ] ~10 unit tests pass

---

## Dependencies & Prerequisites

```
v0.7.1c (Message Log Panel) - REQUIRED
    â”‚
    â””â”€â”€ Core panels, WindowLayoutService â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                                                          â”‚
v0.7.2 (Interactive Panels)                                               â”‚
    â”‚                                                                     â”‚
    â”œâ”€â”€ v0.7.2a: Inventory Panel â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
    â”‚       Dependencies: Inventory entity, WindowLayoutService           â”‚
    â”‚       Provides: InventoryPanel, ItemSlotControl                     â”‚
    â”‚                                                                     â”‚
    â”œâ”€â”€ v0.7.2b: Context Menus â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
    â”‚       Dependencies: v0.7.2a (inventory integration)                 â”‚
    â”‚       Provides: IContextMenuService, item/entity menus              â”‚
    â”‚                                                                     â”‚
    â””â”€â”€ v0.7.1c: Command Input Panel â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            Dependencies: CommandHistoryService, TabCompletionService
            Provides: CommandInputPanel, CompletionPopupControl
```

---

## Estimated Effort Summary

| Part | New Files | Modified Files | Est. Tests | Complexity |
|------|-----------|----------------|------------|------------|
| v0.7.2a | ~5 | ~2 | ~10 | Medium-High |
| v0.7.2b | ~4 | ~2 | ~10 | Medium |
| v0.7.1c | ~4 | ~1 | ~10 | High |
| **Total** | **~13** | **~5** | **~30** | |

---

## Risk Assessment

| Risk | Impact | Probability | Mitigation |
|------|--------|-------------|------------|
| Drag-and-drop complexity | Medium | Medium | Start with basic, iterate |
| Context menu positioning | Low | Medium | Use Avalonia's PlacementTarget |
| Completion popup focus | Medium | Medium | Handle focus carefully |
| Key event handling | Low | Low | Use Avalonia's tunneling events |

---

## Design Decisions (Confirmed)

### Inventory Panel

| Decision | Value | Notes |
|----------|-------|-------|
| **Grid Columns** | 5 (configurable) | Standard layout |
| **Selection** | Single-select | Simple interaction |
| **Drag-and-Drop** | Basic reorder | No equipment swap |

### Context Menus

| Decision | Value | Notes |
|----------|-------|-------|
| **Trigger** | Right-click | Standard convention |
| **Action Execution** | Command strings | Reuse TUI commands |
| **Menu Style** | Fluent theme | Match app style |

### Command Input

| Decision | Value | Notes |
|----------|-------|-------|
| **History** | Reuse TUI service | ICommandHistoryService |
| **Completion** | Reuse TUI service | ITabCompletionService |
| **Popup Position** | Above input | Clear visibility |

---

## Next Steps

1. **Review & Approve** - Confirm scope breakdown
2. **v0.7.2a Design Spec** - Create detailed design for Inventory Panel
3. **v0.7.2a Implementation** - Build inventory grid and selection
4. **v0.7.2b Design Spec** - Create specification for Context Menus
5. **v0.7.2b Implementation** - Build context menu service and menus
6. **v0.7.1c Design Spec** - Create specification for Command Input Panel
7. **v0.7.1c Implementation** - Build input panel with history/completion

---

*This scope breakdown provides a structured approach to implementing v0.7.2 Interactive Panels. These panels complete the core GUI interaction model, enabling mouse-based item management, context actions, and keyboard command input.*
