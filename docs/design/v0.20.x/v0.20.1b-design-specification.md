# Design Specification: v0.20.1b - Skjaldmær Tier 2 Abilities

**Version:** v0.20.1b
**Status:** Design Phase
**Last Updated:** 2026-01-28
**Target Tests:** ~8 unit and integration tests
**Specialization:** Skjaldmær (Shield-Maiden)
**Focus:** Tier 2 Tactical Abilities

---

## Table of Contents

1. [Executive Summary](#1-executive-summary)
2. [Feature Overview](#2-feature-overview)
3. [Architecture Diagrams](#3-architecture-diagrams)
4. [User Stories](#4-user-stories)
5. [Domain Layer Specifications](#5-domain-layer-specifications)
6. [Application Layer Specifications](#6-application-layer-specifications)
7. [Infrastructure Layer Configuration](#7-infrastructure-layer-configuration)
8. [Hold the Line Ability](#8-hold-the-line-ability)
9. [Counter-Shield Ability](#9-counter-shield-ability)
10. [Rally Ability](#10-rally-ability)
11. [Prerequisite System](#11-prerequisite-system)
12. [Decision Trees and Flow Diagrams](#12-decision-trees-and-flow-diagrams)
13. [Code Examples with XML Documentation](#13-code-examples-with-xml-documentation)
14. [Logging Specifications](#14-logging-specifications)
15. [Unit Testing Requirements](#15-unit-testing-requirements)
16. [Integration Testing Requirements](#16-integration-testing-requirements)
17. [Deliverable Checklist](#17-deliverable-checklist)
18. [Acceptance Criteria](#18-acceptance-criteria)
19. [Dependencies](#19-dependencies)
20. [Deferrals and Future Considerations](#20-deferrals-and-future-considerations)

---

## 1. Executive Summary

Version 0.20.1b introduces the three Tier 2 abilities that expand the Skjaldmær's tactical toolkit with crowd control, offensive counterplay, and party support mechanics. This phase builds directly on v0.20.1a's foundation, leveraging the Block Charge resource and establishing progression through the specialization ability tree.

### Phase Objectives

- Implement Tier 2 prerequisite validation (requires 8 PP invested in tree)
- Create three tactical Tier 2 abilities with distinct roles:
  - **Hold the Line:** Crowd control via movement blocking
  - **Counter-Shield:** Offensive reaction on successful defense
  - **Rally:** Supportive ability enhancing party resilience
- Establish 4 PP unlock cost per ability
- Provide complete infrastructure configuration
- Establish unit test coverage (~8 tests)

### Key Deliverables

| Category | Count | Details |
|----------|-------|---------|
| **Domain Value Objects** | 2 | `HoldTheLineState`, `RallyBuff` |
| **Application Services** | 1 | Enhanced `ISkjaldmaerAbilityService` |
| **Ability Implementations** | 3 | Hold the Line, Counter-Shield, Rally |
| **Status Effects** | 1 | Rally bonus effect |
| **Configuration Updates** | 2 | specializations.json, abilities.json |
| **Unit Tests** | ~8 | Comprehensive Tier 2 coverage |

### Tier 2 Abilities Overview

| Ability | Type | Cost | Key Mechanic | Purpose |
|---------|------|------|--------------|---------|
| **Hold the Line** | Active | 3 AP | Block space (2 turns) | Positional control |
| **Counter-Shield** | Reaction | None | 1d6 damage on block | Offensive counterplay |
| **Rally** | Active | 2 AP | +2 save bonus to allies | Party support |

---

## 2. Feature Overview

### 2.1 Hold the Line (Active Ability)

**Conceptual Role:** A tactical positioning ability that turns the Skjaldmær into an immovable obstacle. The warrior plants themselves so firmly that enemies cannot advance through their space.

**Key Features:**
- **Type:** Active ability with 3 AP cost
- **Duration:** 2 turns (meaningful impact without overpowering)
- **Range:** Self (affects only Skjaldmær's current space)
- **Mechanics:** Enemies cannot move through character's space; allies move freely
- **Effect Ends:** When Skjaldmær moves, dies, or 2 turns elapse
- **Synergy:** Works well with Shield Wall for fortress-like defense

**Tactical Applications:**
- Prevent enemy reinforcements from reaching allies
- Protect vulnerable ranged characters
- Create bottleneck positions in corridor-like terrain
- Force enemies to take longer routes around position

### 2.2 Counter-Shield (Reaction)

**Conceptual Role:** An offensive reaction that punishes enemies who fail to overcome the Skjaldmær's defense. When an attack bounces off shield or armor, the warrior strikes back.

**Key Features:**
- **Type:** Reaction ability (no AP cost)
- **Trigger:** Successful block (attack misses due to Defense)
- **Damage:** 1d6 physical damage (untyped)
- **Trigger Requirements:** Melee range (attacker must be adjacent)
- **No Resource Cost:** Triggers automatically on successful defense
- **Synergy:** More valuable with Shield Wall (+3 Defense increases block chance)

**Tactical Applications:**
- Reward defensive positioning
- Create damage output from successful defense
- Encourage enemies to consider alternative targets
- Scale with character Defense investments

### 2.3 Rally (Active)

**Conceptual Role:** A party support ability that bolsters the resolve of nearby allies, granting them improved resilience against adverse effects and harm.

**Key Features:**
- **Type:** Active ability with 2 AP cost
- **Range:** 6 spaces (area denial)
- **Effect:** All allies within range gain +2 to next saving throw
- **Duration:** Until consumed by a save or combat ends
- **Affects:** Multiple allies simultaneously
- **Exclusions:** Does not affect self
- **Stacking:** Stacks with other save bonuses

**Tactical Applications:**
- Pre-emptively grant save bonuses before dangerous ability phases
- Support allies facing fear/control effects
- Increase survivability in AoE damage scenarios
- Enable riskier ally positioning with safety net

---

## 3. Architecture Diagrams

### 3.1 Tier 2 Ability Dependencies

```
┌──────────────────────────────────────────────────────┐
│         v0.20.1b Tier 2 Ability Framework            │
├──────────────────────────────────────────────────────┤
│                                                       │
│  v0.20.1a (Foundation) ─────────────────────────┐    │
│  ├── BlockChargeResource                        │    │
│  ├── ShieldWallState                            │    │
│  ├── Character Extensions                       │    │
│  └── SkjaldmaerAbilityId Enum                  │    │
│                                                 │    │
│  ▼──────────────────────────────────────────────┘    │
│                                                       │
│  ┌────────────────────────────────────────────────┐  │
│  │ v0.20.1b Value Objects (NEW)                  │  │
│  ├────────────────────────────────────────────────┤  │
│  │ • HoldTheLineState                            │  │
│  │   ├── IsActive: bool                          │  │
│  │   ├── TurnsRemaining: int                      │  │
│  │   ├── Character Position: Position            │  │
│  │   └── GetBlockedPositions(): Position[]       │  │
│  │                                               │  │
│  │ • RallyBuff                                   │  │
│  │   ├── AffectedCharacterId: Guid               │  │
│  │   ├── SaveBonus: int                          │  │
│  │   ├── IsConsumed: bool                        │  │
│  │   └── Consume(): void                         │  │
│  │                                               │  │
│  │ • CounterShieldResult                         │  │
│  │   ├── DamageRoll: int                         │  │
│  │   └── AttackerDefense: int                    │  │
│  └────────────────────────────────────────────────┘  │
│                    │                                 │
│  ┌────────────────▼──────────────────────────────┐  │
│  │ Service Extensions                            │  │
│  ├────────────────────────────────────────────────┤  │
│  │ • ISkjaldmaerAbilityService (enhanced)        │  │
│  │   ├── ActivateHoldTheLineAsync()              │  │
│  │   ├── TryCounterShieldAsync()                 │  │
│  │   ├── ActivateRallyAsync()                    │  │
│  │   └── GetAllyDefenseBonus()                   │  │
│  │                                               │  │
│  │ • IPrerequisiteService                        │  │
│  │   ├── CanUnlockTier2()                        │  │
│  │   └── GetPPInvested()                         │  │
│  └────────────────────────────────────────────────┘  │
│                    │                                 │
│  ┌────────────────▼──────────────────────────────┐  │
│  │ Ability Handlers (NEW)                        │  │
│  ├────────────────────────────────────────────────┤  │
│  │ • HoldTheLineAbilityHandler                   │  │
│  │ • CounterShieldAbilityHandler                 │  │
│  │ • RallyAbilityHandler                         │  │
│  └────────────────────────────────────────────────┘  │
│                                                       │
└──────────────────────────────────────────────────────┘
```

### 3.2 Prerequisite Validation System

```
┌──────────────────────────────┐
│ Tier 2 Ability Unlock Request│
└──────────────┬───────────────┘
               │
        ┌──────▼──────────┐
        │ Is Skjaldmær?   │
        └──────┬──────────┘
               │
          ┌────┴─────┐
       No │           │ Yes
          │           │
     ┌────▼───┐  ┌────▼──────────────┐
     │  Fail  │  │ Check Tier 2 Lock  │
     └────────┘  └────┬───────────────┘
                      │
                 ┌────▼───────────────┐
                 │ Is Tier 2 Locked?  │
                 └────┬──────────────┘
                      │
                  ┌───┴───┐
               No │       │ Yes
                  │       │
            ┌─────▼─┐ ┌───▼──────────────┐
            │ Allow │ │ Calculate PP     │
            │       │ │ Invested in Tree │
            └───────┘ └────┬─────────────┘
                           │
                      ┌────▼──────────────┐
                      │ >= 8 PP Invested? │
                      └────┬─────────────┘
                           │
                       ┌───┴────┐
                    No │        │ Yes
                       │        │
                   ┌───▼─┐ ┌───▼──────────┐
                   │Fail │ │ Allow Unlock │
                   │     │ │ (costs 4 PP) │
                   └─────┘ └──────────────┘
```

### 3.3 Rally Buff Application

```
┌────────────────────────────────────┐
│ Rally Ability Activated            │
│ (2 AP, Range 6)                    │
└──────────────┬─────────────────────┘
               │
        ┌──────▼────────────┐
        │ Find All Allies   │
        │ Within 6 Spaces   │
        └──────┬────────────┘
               │
        ┌──────▼──────────────┐
        │ For Each Ally:      │
        │ • Create RallyBuff  │
        │ • Set +2 SaveBonus  │
        │ • Mark: Unconsumed  │
        └──────┬──────────────┘
               │
        ┌──────▼──────────────┐
        │ Apply to Inventory  │
        │ Save to Character   │
        └──────┬──────────────┘
               │
        ┌──────▼──────────────┐
        │ When Ally Makes     │
        │ Saving Throw:       │
        │ • Add +2 Bonus      │
        │ • Mark: Consumed    │
        │ • Remove Buff       │
        └──────────────────────┘
```

---

## 4. User Stories

### 4.1 Hold the Line Usage

**As a** Skjaldmær with 8+ PP invested in the ability tree
**I want to** activate Hold the Line and prevent enemies from advancing
**So that** I can protect vulnerable allies from incoming threats

**Acceptance Criteria:**
- Tier 2 abilities unlock after investing 8 PP
- Can activate Hold the Line with 3 AP
- Enemies cannot move through Skjaldmær's space for 2 turns
- Allies can move through space freely
- Effect ends when Skjaldmær moves or turns expire
- Movement attempts are blocked with clear feedback message

### 4.2 Counter-Shield Offensive Play

**As a** Skjaldmær with good Defense bonuses
**I want to** automatically damage enemies when they miss attacks
**So that** blocking attacks becomes an offensive opportunity

**Acceptance Criteria:**
- Counter-Shield triggers automatically on successful block (attack misses)
- Deals 1d6 damage to melee attacker
- Does not trigger on ranged attacks
- Damage is logged in combat log
- Damage is included in character's damage output

### 4.3 Rally Support Ability

**As a** Skjaldmær supporting my party
**I want to** grant save bonuses to nearby allies
**So that** they're protected from control and harmful effects

**Acceptance Criteria:**
- Rally affects all allies within 6 spaces
- Grants +2 to next saving throw for each affected ally
- Bonus is consumed after one save (successful or failed)
- Buff can be seen in ally status
- Buff stacks with other save bonuses
- Does not affect self

---

## 5. Domain Layer Specifications

### 5.1 HoldTheLineState Value Object

```csharp
/// <summary>
/// Represents the state of an active Hold the Line ability effect.
/// Manages the blocking of enemy movement through Skjaldmær's position.
/// </summary>
public sealed record HoldTheLineState
{
    /// <summary>
    /// Whether Hold the Line is currently active.
    /// </summary>
    public bool IsActive { get; private set; }

    /// <summary>
    /// Number of turns remaining for this effect (0-2).
    /// Decrements at end of each turn.
    /// </summary>
    public int TurnsRemaining { get; private set; } = 2;

    /// <summary>
    /// Position where Hold the Line was activated.
    /// Blocked position is this location throughout duration.
    /// </summary>
    public Position BlockedPosition { get; init; }

    /// <summary>
    /// UTC timestamp when effect was activated.
    /// </summary>
    public DateTime ActivatedAt { get; private set; }

    /// <summary>
    /// Activates the Hold the Line effect.
    /// </summary>
    /// <remarks>
    /// Sets TurnsRemaining to 2 and marks as active.
    /// Called when ability is executed.
    /// </remarks>
    public void Activate()
    {
        IsActive = true;
        TurnsRemaining = 2;
        ActivatedAt = DateTime.UtcNow;
    }

    /// <summary>
    /// Decrements turns remaining and deactivates if expired.
    /// </summary>
    /// <remarks>
    /// Called at end of each turn during combat.
    /// </remarks>
    public void Tick()
    {
        if (!IsActive)
            return;

        TurnsRemaining--;
        if (TurnsRemaining <= 0)
            IsActive = false;
    }

    /// <summary>
    /// Determines if the effect has expired.
    /// </summary>
    public bool IsExpired() => !IsActive || TurnsRemaining <= 0;

    /// <summary>
    /// Gets the positions that are blocked by this effect.
    /// </summary>
    /// <returns>
    /// List containing blocked position (typically just the Skjaldmær's position).
    /// </returns>
    public IReadOnlyList<Position> GetBlockedPositions()
    {
        if (!IsActive)
            return Array.Empty<Position>();

        return new[] { BlockedPosition };
    }

    /// <summary>
    /// Checks if a specific movement would pass through the blocked space.
    /// </summary>
    /// <param name="from">Starting position of movement</param>
    /// <param name="to">Destination position of movement</param>
    /// <returns>True if movement passes through blocked space</returns>
    public bool IsMovementBlocked(Position from, Position to)
    {
        if (!IsActive)
            return false;

        // Check if path includes blocked position
        return from.LineOfSightIncludes(to, BlockedPosition);
    }

    /// <summary>
    /// Deactivates the effect immediately.
    /// </summary>
    /// <remarks>
    /// Called when Skjaldmær moves or is incapacitated.
    /// </remarks>
    public void Deactivate()
    {
        IsActive = false;
        TurnsRemaining = 0;
    }
}
```

### 5.2 RallyBuff Value Object

```csharp
/// <summary>
/// Represents a Rally ability buff applied to an affected ally.
/// Provides +2 bonus to next saving throw, consumed on save.
/// </summary>
public sealed record RallyBuff
{
    /// <summary>
    /// ID of the character receiving this buff.
    /// </summary>
    public Guid AffectedCharacterId { get; init; }

    /// <summary>
    /// Bonus to apply to saving throws (+2).
    /// </summary>
    public int SaveBonus { get; init; } = 2;

    /// <summary>
    /// Whether this buff has been consumed by a save.
    /// Once consumed, buff is removed.
    /// </summary>
    public bool IsConsumed { get; private set; }

    /// <summary>
    /// UTC timestamp when buff was applied.
    /// Used for sorting and prioritization.
    /// </summary>
    public DateTime AppliedAt { get; init; }

    /// <summary>
    /// ID of the Skjaldmær who cast Rally.
    /// Used for attribution in logs.
    /// </summary>
    public Guid CasterCharacterId { get; init; }

    /// <summary>
    /// Consumes the buff by marking it as used.
    /// </summary>
    /// <remarks>
    /// Called when affected character makes a saving throw.
    /// After this, the buff is removed.
    /// </remarks>
    public void Consume()
    {
        IsConsumed = true;
    }

    /// <summary>
    /// Determines if the buff is still active.
    /// </summary>
    public bool IsActive() => !IsConsumed;

    /// <summary>
    /// Gets the effective save bonus for this character's save.
    /// </summary>
    /// <param name="allyId">ID of character making the save</param>
    /// <returns>Save bonus (+2) if buff is for this character and active, 0 otherwise</returns>
    public int GetBonusForCharacter(Guid allyId)
    {
        if (!IsActive() || AffectedCharacterId != allyId)
            return 0;

        return SaveBonus;
    }
}
```

### 5.3 CounterShieldResult Value Object

```csharp
/// <summary>
/// Represents the result of a Counter-Shield reaction.
/// Captures damage dealt and defender information.
/// </summary>
public sealed record CounterShieldResult
{
    /// <summary>
    /// Damage roll result (1-6 from 1d6).
    /// </summary>
    public int DamageRoll { get; init; }

    /// <summary>
    /// Defense value of the attacker.
    /// Used to determine if counter-damage hits (if mechanics require).
    /// </summary>
    public int AttackerDefense { get; init; }

    /// <summary>
    /// ID of the attacker taking counter damage.
    /// </summary>
    public Guid AttackerId { get; init; }

    /// <summary>
    /// ID of the Skjaldmær performing Counter-Shield.
    /// </summary>
    public Guid SkjaldmaerId { get; init; }

    /// <summary>
    /// UTC timestamp of reaction.
    /// </summary>
    public DateTime ExecutedAt { get; init; }

    /// <summary>
    /// Gets whether the counter-damage should be applied.
    /// Currently always true (counter-damage is guaranteed).
    /// </summary>
    public bool ShouldApplyDamage() => true;
}
```

### 5.4 Character Entity Extensions

**New properties for Tier 2 integration:**

```csharp
public partial class Character : Entity
{
    /// <summary>
    /// Active Hold the Line effect (if any).
    /// </summary>
    public HoldTheLineState? HoldTheLineState { get; set; }

    /// <summary>
    /// List of Rally buffs applied to this character.
    /// Multiple buffs can stack.
    /// </summary>
    public IList<RallyBuff> RallyBuffs { get; } = new List<RallyBuff>();

    /// <summary>
    /// Gets total save bonus from all active Rally buffs.
    /// </summary>
    /// <returns>Sum of all active buffs' save bonuses</returns>
    public int GetRallySaveBonus()
    {
        return RallyBuffs
            .Where(b => b.IsActive())
            .Sum(b => b.SaveBonus);
    }

    /// <summary>
    /// Consumes next available Rally buff for a saving throw.
    /// </summary>
    /// <returns>True if a buff was consumed</returns>
    public bool ConsumeRallyBuff()
    {
        var buff = RallyBuffs.FirstOrDefault(b => b.IsActive());
        if (buff != null)
        {
            buff.Consume();
            RallyBuffs.Remove(buff);
            return true;
        }
        return false;
    }

    /// <summary>
    /// Gets effective movement cost with Hold the Line modifiers.
    /// </summary>
    public int GetMovementCost()
    {
        int baseCost = MovementStats.BaseCost;

        // Additional costs if Hold the Line is active
        if (HoldTheLineState?.IsActive == true)
            baseCost += 1; // Movement from blocked position costs extra AP

        return baseCost;
    }
}
```

---

## 6. Application Layer Specifications

### 6.1 Enhanced ISkjaldmaerAbilityService Interface

```csharp
/// <summary>
/// Extended service interface for Tier 2 Skjaldmær abilities.
/// </summary>
public interface ISkjaldmaerAbilityService
{
    // Tier 1 methods (from v0.20.1a)
    Task<bool> ActivateShieldWallAsync(Character character, int apCost);
    Task<bool> EndShieldWallAsync(Character character);
    Task<bool> TryInterceptAsync(Character character, Character defendedAlly, Character attacker);
    void ApplyBulwark(Character character);
    int CalculateDefenseBonus(Character character);
    IReadOnlyList<Guid> GetAdjacentAllies(Character character, IReadOnlyList<Character> allCharacters);

    // Tier 2 methods (NEW)

    /// <summary>
    /// Activates Hold the Line ability.
    /// </summary>
    /// <param name="character">Skjaldmær activating ability</param>
    /// <returns>True if ability activated successfully</returns>
    Task<bool> ActivateHoldTheLineAsync(Character character);

    /// <summary>
    /// Attempts to execute Counter-Shield reaction.
    /// </summary>
    /// <param name="character">Skjaldmær executing reaction</param>
    /// <param name="attacker">Character whose attack is being countered</param>
    /// <returns>Damage dealt by counter-attack</returns>
    Task<int> TryCounterShieldAsync(Character character, Character attacker);

    /// <summary>
    /// Activates Rally ability affecting nearby allies.
    /// </summary>
    /// <param name="character">Skjaldmær casting Rally</param>
    /// <param name="allCharacters">All characters in area to evaluate range</param>
    /// <returns>Number of allies affected</returns>
    Task<int> ActivateRallyAsync(Character character, IReadOnlyList<Character> allCharacters);

    /// <summary>
    /// Checks if character can unlock Tier 2 abilities.
    /// </summary>
    /// <param name="character">Character to check</param>
    /// <returns>True if character has 8+ PP invested in tree</returns>
    bool CanUnlockTier2(Character character);

    /// <summary>
    /// Gets total PP invested in Skjaldmær ability tree.
    /// </summary>
    /// <param name="character">Character to evaluate</param>
    /// <returns>Total PP spent on abilities (0-24+)</returns>
    int GetPPInvested(Character character);

    /// <summary>
    /// Gets save bonus from all active Rally buffs.
    /// </summary>
    /// <param name="character">Character to check</param>
    /// <returns>Total save bonus from Rally (+2 per active buff)</returns>
    int GetAllySaveBonus(Character character);
}
```

### 6.2 IPrerequisiteService Interface

**New service for Tier 2+ prerequisite checking:**

```csharp
/// <summary>
/// Service for validating ability prerequisites and unlock requirements.
/// </summary>
public interface IPrerequisiteService
{
    /// <summary>
    /// Determines if a character can unlock a specific ability.
    /// </summary>
    /// <param name="character">Character to check</param>
    /// <param name="abilityId">Ability to check</param>
    /// <returns>
    /// Result with details about whether ability can be unlocked
    /// and what prerequisites are missing (if any).
    /// </returns>
    PrerequisiteCheckResult CanUnlockAbility(Character character, SkjaldmaerAbilityId abilityId);

    /// <summary>
    /// Gets all missing prerequisites for an ability.
    /// </summary>
    /// <param name="character">Character to check</param>
    /// <param name="abilityId">Ability to check</param>
    /// <returns>List of missing prerequisite descriptions</returns>
    IReadOnlyList<string> GetMissingPrerequisites(Character character, SkjaldmaerAbilityId abilityId);

    /// <summary>
    /// Calculates total PP invested in a specialization's ability tree.
    /// </summary>
    /// <param name="character">Character to evaluate</param>
    /// <returns>Sum of all PP spent on unlocked abilities</returns>
    int GetTotalPPInvested(Character character);
}

/// <summary>
/// Result of a prerequisite check.
/// </summary>
public sealed record PrerequisiteCheckResult
{
    public bool CanUnlock { get; init; }
    public IReadOnlyList<string> MissingPrerequisites { get; init; }
    public string FailureReason { get; init; }

    public static PrerequisiteCheckResult Success() => new() { CanUnlock = true };
    public static PrerequisiteCheckResult Failure(params string[] reasons) =>
        new() { CanUnlock = false, MissingPrerequisites = reasons };
}
```

### 6.3 HoldTheLineAbilityHandler

```csharp
/// <summary>
/// Handles Hold the Line ability execution.
/// Prevents enemy movement through Skjaldmær's position.
/// </summary>
public class HoldTheLineAbilityHandler : IAbilityHandler
{
    private const int AP_COST = 3;
    private const int DURATION_TURNS = 2;

    private readonly ISkjaldmaerAbilityService _abilityService;
    private readonly IPrerequisiteService _prerequisiteService;
    private readonly ICharacterRepository _characterRepository;
    private readonly ILogger<HoldTheLineAbilityHandler> _logger;

    public HoldTheLineAbilityHandler(
        ISkjaldmaerAbilityService abilityService,
        IPrerequisiteService prerequisiteService,
        ICharacterRepository characterRepository,
        ILogger<HoldTheLineAbilityHandler> logger)
    {
        _abilityService = abilityService;
        _prerequisiteService = prerequisiteService;
        _characterRepository = characterRepository;
        _logger = logger;
    }

    /// <summary>
    /// Executes Hold the Line ability.
    /// </summary>
    public async Task<AbilityResult> ExecuteAsync(Character character, CombatContext context)
    {
        // Validate specialization
        if (character.Specialization != SpecializationId.Skjaldmaer)
            return AbilityResult.Failure("Only Skjaldmær can use Hold the Line");

        // Validate prerequisite
        if (!_abilityService.CanUnlockTier2(character))
            return AbilityResult.Failure("Hold the Line requires 8+ PP invested in Skjaldmær tree");

        // Validate AP
        if (character.CurrentAP < AP_COST)
            return AbilityResult.Failure($"Requires {AP_COST} AP, you have {character.CurrentAP}");

        // Deduct AP
        character.CurrentAP -= AP_COST;

        // Create effect
        character.HoldTheLineState = new HoldTheLineState
        {
            BlockedPosition = character.Position,
            ActivatedAt = DateTime.UtcNow
        };
        character.HoldTheLineState.Activate();

        // Persist
        await _characterRepository.UpdateAsync(character);

        _logger.LogInformation(
            "Hold the Line activated: Character {CharacterId} ({CharacterName}) " +
            "blocks position {Position} for {Turns} turns",
            character.Id, character.Name, character.Position, DURATION_TURNS);

        return AbilityResult.Success(
            $"Hold the Line activated! Enemies cannot move through your space for {DURATION_TURNS} turns");
    }
}
```

### 6.4 RallyAbilityHandler

```csharp
/// <summary>
/// Handles Rally ability execution.
/// Grants save bonuses to nearby allies.
/// </summary>
public class RallyAbilityHandler : IAbilityHandler
{
    private const int AP_COST = 2;
    private const int RANGE = 6;
    private const int SAVE_BONUS = 2;

    private readonly ISkjaldmaerAbilityService _abilityService;
    private readonly IPrerequisiteService _prerequisiteService;
    private readonly ICharacterRepository _characterRepository;
    private readonly ILogger<RallyAbilityHandler> _logger;

    public RallyAbilityHandler(
        ISkjaldmaerAbilityService abilityService,
        IPrerequisiteService prerequisiteService,
        ICharacterRepository characterRepository,
        ILogger<RallyAbilityHandler> logger)
    {
        _abilityService = abilityService;
        _prerequisiteService = prerequisiteService;
        _characterRepository = characterRepository;
        _logger = logger;
    }

    /// <summary>
    /// Executes Rally ability.
    /// </summary>
    public async Task<AbilityResult> ExecuteAsync(Character character, CombatContext context)
    {
        // Validate specialization
        if (character.Specialization != SpecializationId.Skjaldmaer)
            return AbilityResult.Failure("Only Skjaldmær can use Rally");

        // Validate prerequisite
        if (!_abilityService.CanUnlockTier2(character))
            return AbilityResult.Failure("Rally requires 8+ PP invested in Skjaldmær tree");

        // Validate AP
        if (character.CurrentAP < AP_COST)
            return AbilityResult.Failure($"Requires {AP_COST} AP, you have {character.CurrentAP}");

        // Deduct AP
        character.CurrentAP -= AP_COST;

        // Find affected allies
        var allCharacters = context.GetAllCharactersInArea(character.Position, RANGE);
        var affectedAllies = allCharacters
            .Where(c => c.Id != character.Id && !c.IsEnemy(character))
            .ToList();

        // Apply buff to each ally
        int affectedCount = 0;
        foreach (var ally in affectedAllies)
        {
            var buff = new RallyBuff
            {
                AffectedCharacterId = ally.Id,
                SaveBonus = SAVE_BONUS,
                AppliedAt = DateTime.UtcNow,
                CasterCharacterId = character.Id
            };

            ally.RallyBuffs.Add(buff);
            await _characterRepository.UpdateAsync(ally);
            affectedCount++;
        }

        _logger.LogInformation(
            "Rally activated: Character {CasterId} ({CasterName}) granted " +
            "+{Bonus} save bonus to {AffectedCount} allies within {Range} spaces",
            character.Id, character.Name, SAVE_BONUS, affectedCount, RANGE);

        return AbilityResult.Success(
            $"Rally activated! Granted +{SAVE_BONUS} save bonus to {affectedCount} allies");
    }
}
```

---

## 7. Infrastructure Layer Configuration

### 7.1 specializations.json - Tier 2 Update

```json
{
    "specializations": [
        {
            "specializationId": "Skjaldmaer",
            "abilityTiers": [
                {
                    "tier": 1,
                    "displayName": "Foundation",
                    "ppRequirement": 0,
                    "abilityCost": 0,
                    "abilities": ["shield-wall", "intercept", "bulwark"]
                },
                {
                    "tier": 2,
                    "displayName": "Discipline",
                    "ppRequirement": 8,
                    "abilityCost": 4,
                    "abilities": ["hold-the-line", "counter-shield", "rally"],
                    "unlockDescription": "Unlock tactical mid-tier abilities requiring 8+ PP invested"
                },
                {
                    "tier": 3,
                    "displayName": "Mastery",
                    "ppRequirement": 16,
                    "abilityCost": 5,
                    "abilities": ["unbreakable", "guardians-sacrifice"]
                },
                {
                    "tier": "capstone",
                    "displayName": "The Wall",
                    "ppRequirement": 24,
                    "abilityCost": 6,
                    "abilities": ["the-wall-lives"]
                }
            ]
        }
    ]
}
```

### 7.2 abilities.json - Tier 2 Entries

```json
{
    "abilities": [
        {
            "abilityId": "hold-the-line",
            "displayName": "Hold the Line",
            "specialization": "Skjaldmaer",
            "tier": 2,
            "type": "Active",
            "apCost": 3,
            "duration": 2,
            "durationUnit": "Turns",
            "range": 0,
            "rangeType": "Self",
            "description": "For 2 turns, enemies cannot move through your space. Allies pass freely.",
            "flavorText": "You plant your feet and become an immovable obstacle.",
            "requirements": {
                "ppInvested": 8
            },
            "effects": [
                {
                    "effectId": "hold-the-line-block",
                    "type": "BlockMovement",
                    "target": "Enemies",
                    "affectedPosition": "Self",
                    "duration": 2
                }
            ],
            "keywords": ["Active", "Control", "Duration", "Tactical"],
            "tags": ["v0.20.1b"]
        },
        {
            "abilityId": "counter-shield",
            "displayName": "Counter-Shield",
            "specialization": "Skjaldmaer",
            "tier": 2,
            "type": "Reaction",
            "resourceCost": null,
            "trigger": {
                "event": "SuccessfulBlock",
                "rangeType": "Melee"
            },
            "description": "When you successfully block an attack from a melee attacker, deal 1d6 damage to them.",
            "flavorText": "The attacker's blow glances off your shield as you strike back.",
            "requirements": {
                "ppInvested": 8,
                "targetRange": "Melee"
            },
            "effects": [
                {
                    "effectId": "counter-shield-damage",
                    "type": "Damage",
                    "target": "Attacker",
                    "dice": "1d6",
                    "damageType": "Physical",
                    "guaranteed": true
                }
            ],
            "keywords": ["Reaction", "Offensive", "Counterattack", "Automatic"],
            "tags": ["v0.20.1b"]
        },
        {
            "abilityId": "rally",
            "displayName": "Rally",
            "specialization": "Skjaldmaer",
            "tier": 2,
            "type": "Active",
            "apCost": 2,
            "range": 6,
            "rangeType": "Radius",
            "targetType": "AlliesInRange",
            "description": "All allies within 6 spaces gain +2 to their next saving throw.",
            "flavorText": "Your rallying cry steadies your companions' resolve.",
            "requirements": {
                "ppInvested": 8
            },
            "effects": [
                {
                    "effectId": "rally-buff",
                    "type": "ApplyBuff",
                    "buffId": "rally-save-bonus",
                    "target": "AlliesInRange",
                    "range": 6,
                    "modifier": 2,
                    "modifierType": "SavingThrow",
                    "duration": "UntilConsumed",
                    "stackingBehavior": "Stack"
                }
            ],
            "keywords": ["Active", "Support", "Buff", "Party"],
            "tags": ["v0.20.1b"]
        }
    ]
}
```

---

## 8. Hold the Line Ability

### 8.1 Mechanics Specification

**Duration Calculation:**

```
Turn 1: Hold the Line activated → TurnsRemaining = 2
Turn 2: End of turn tick → TurnsRemaining = 1
Turn 3: End of turn tick → TurnsRemaining = 0 → Effect ends
```

**Movement Blocking:**

| Scenario | Result | Notes |
|----------|--------|-------|
| Enemy in line of sight moves toward blocked space | Blocked | Path includes blocked space |
| Enemy adjacent to blocked space moves away | Allowed | Moving away from space |
| Ally moves through space | Allowed | Allies not restricted |
| Skjaldmær moves | Effect ends | Source moved |
| Skjaldmær incapacitated | Effect ends | Character unconscious |

### 8.2 Early Termination Conditions

```csharp
public bool ShouldTerminateEffect(Character skjaldmaer)
{
    // Effect ends if Skjaldmær moves
    if (skjaldmaer.Position != BlockedPosition)
        return true;

    // Effect ends if Skjaldmær is incapacitated
    if (skjaldmaer.IsIncapacitated)
        return true;

    // Effect ends if duration expires
    if (TurnsRemaining <= 0)
        return true;

    return false;
}
```

---

## 9. Counter-Shield Ability

### 9.1 Trigger Mechanics

**Successful Block Definition:**
```
SuccessfulBlock = (
    Attack.Result == AttackResult.Miss &&
    Reason == BlockReason.Defense
)
```

**Conditions:**
- Attack roll must fail
- Failure due to target's Defense (not dodge/evasion)
- Attacker must be in melee range (1 space)
- Damage dealt regardless of attacker's Defense against counter

---

## 10. Rally Ability

### 10.1 Save Bonus Calculation

**When affected ally makes saving throw:**

```csharp
public int CalculateSaveBonus(Character character)
{
    int totalBonus = 0;

    // Add bonuses from active Rally buffs
    foreach (var buff in character.RallyBuffs.Where(b => b.IsActive()))
    {
        totalBonus += buff.GetBonusForCharacter(character.Id);
        buff.Consume(); // Mark consumed after applying
    }

    // Remove consumed buffs
    character.RallyBuffs.RemoveAll(b => b.IsConsumed);

    return totalBonus;
}
```

---

## 11. Prerequisite System

### 11.1 Tier 2 Unlock Logic

```csharp
public class Tier2PrerequisiteValidator
{
    public bool CanUnlockTier2(Character character)
    {
        if (character.Specialization != SpecializationId.Skjaldmaer)
            return false;

        int ppInvested = CalculatePPInvested(character);
        return ppInvested >= 8;
    }

    private int CalculatePPInvested(Character character)
    {
        int total = 0;

        // Sum PP costs of unlocked abilities
        if (character.HasAbilityUnlocked(SkjaldmaerAbilityId.ShieldWall))
            total += 0; // Tier 1 abilities free

        if (character.HasAbilityUnlocked(SkjaldmaerAbilityId.Intercept))
            total += 0;

        if (character.HasAbilityUnlocked(SkjaldmaerAbilityId.Bulwark))
            total += 0;

        if (character.HasAbilityUnlocked(SkjaldmaerAbilityId.HoldTheLine))
            total += 4;

        if (character.HasAbilityUnlocked(SkjaldmaerAbilityId.CounterShield))
            total += 4;

        if (character.HasAbilityUnlocked(SkjaldmaerAbilityId.Rally))
            total += 4;

        return total;
    }
}
```

---

## 12. Decision Trees and Flow Diagrams

### 12.1 Hold the Line Activation Flow

```
┌─────────────────────────────────┐
│ Hold the Line Ability Activated  │
│ (3 AP, Tier 2)                  │
└────────────┬──────────────────────┘
             │
      ┌──────▼──────────┐
      │ Is Skjaldmær?   │
      └──────┬──────────┘
             │
        ┌────┴──────┐
     No │           │ Yes
        │           │
   ┌────▼────┐ ┌────▼──────────────┐
   │   Fail  │ │ 8+ PP Invested?    │
   └─────────┘ └────┬───────────────┘
                    │
                ┌───┴────┐
             No │        │ Yes
                │        │
            ┌───▼─┐ ┌────▼──────┐
            │Fail │ │ >= 3 AP?   │
            └─────┘ └────┬───────┘
                         │
                     ┌───┴────┐
                  No │        │ Yes
                     │        │
                 ┌───▼─┐ ┌────▼────────────┐
                 │Fail │ │ Spend 3 AP      │
                 └─────┘ └────┬────────────┘
                              │
                         ┌────▼──────────────┐
                         │ Create Effect     │
                         │ Duration: 2 turns │
                         │ Position: Current │
                         └────┬──────────────┘
                              │
                         ┌────▼──────────────┐
                         │ Mark Enemies:     │
                         │ Cannot Move       │
                         │ Through Space     │
                         └────┬──────────────┘
                              │
                         ┌────▼──────────────┐
                         │ Log Action        │
                         │ Return Success    │
                         └────────────────────┘
```

### 12.2 Counter-Shield Trigger Flow

```
┌──────────────────────────────────┐
│ Melee Attack Resolution           │
│ Against Skjaldmær                 │
└────────────┬───────────────────────┘
             │
      ┌──────▼──────────┐
      │ Did Attack Hit?  │
      └──────┬──────────┘
             │
        ┌────┴────┐
     Yes│         │ No
        │         │
   ┌────▼─┐  ┌───▼──────────────┐
   │ Hit  │  │ Due to Defense?  │
   │      │  │ (Not Dodge/Etc)  │
   └──────┘  └───┬──────────────┘
                │
            ┌───┴────┐
         No │        │ Yes
            │        │
        ┌───▼─┐ ┌───▼──────────────┐
        │None │ │ Melee Range?     │
        └─────┘ └───┬──────────────┘
                    │
                ┌───┴────┐
             No │        │ Yes
                │        │
            ┌───▼─┐ ┌───▼────────────┐
            │None │ │ Roll 1d6       │
            └─────┘ └───┬────────────┘
                        │
                   ┌────▼──────────┐
                   │ Apply Damage  │
                   │ to Attacker   │
                   └────┬──────────┘
                        │
                   ┌────▼──────────┐
                   │ Log Counter   │
                   │ Return Result │
                   └───────────────┘
```

---

## 13. Code Examples with XML Documentation

### 13.1 Complete SkjaldmaerAbilityService (Tier 2 Methods)

```csharp
/// <summary>
/// Enhanced Skjaldmær ability service with Tier 2 support.
/// </summary>
public class SkjaldmaerAbilityService : ISkjaldmaerAbilityService
{
    private readonly ICharacterRepository _characterRepository;
    private readonly IPrerequisiteService _prerequisiteService;
    private readonly IDiceRoller _diceRoller;
    private readonly ILogger<SkjaldmaerAbilityService> _logger;

    public SkjaldmaerAbilityService(
        ICharacterRepository characterRepository,
        IPrerequisiteService prerequisiteService,
        IDiceRoller diceRoller,
        ILogger<SkjaldmaerAbilityService> logger)
    {
        _characterRepository = characterRepository;
        _prerequisiteService = prerequisiteService;
        _diceRoller = diceRoller;
        _logger = logger;
    }

    /// <summary>
    /// Activates Hold the Line ability.
    /// </summary>
    public async Task<bool> ActivateHoldTheLineAsync(Character character)
    {
        if (!CanUnlockTier2(character))
        {
            _logger.LogWarning(
                "Hold the Line activation denied: Character {CharacterId} " +
                "insufficient PP invested ({PPInvested} < 8)",
                character.Id, GetPPInvested(character));
            return false;
        }

        character.HoldTheLineState = new HoldTheLineState
        {
            BlockedPosition = character.Position,
            ActivatedAt = DateTime.UtcNow
        };
        character.HoldTheLineState.Activate();

        await _characterRepository.UpdateAsync(character);

        _logger.LogInformation(
            "Hold the Line activated: Character {CharacterId} ({Name}) " +
            "blocks position {Position}",
            character.Id, character.Name, character.Position);

        return true;
    }

    /// <summary>
    /// Executes Counter-Shield reaction.
    /// </summary>
    public async Task<int> TryCounterShieldAsync(Character character, Character attacker)
    {
        // Roll damage (1d6)
        int damageRoll = _diceRoller.Roll(1, 6);

        // Apply to attacker
        attacker.CurrentHP -= damageRoll;

        await _characterRepository.UpdateAsync(attacker);

        _logger.LogInformation(
            "Counter-Shield executed: Character {CharacterId} ({Name}) " +
            "dealt {Damage} counter damage to {AttackerId}",
            character.Id, character.Name, damageRoll, attacker.Id);

        return damageRoll;
    }

    /// <summary>
    /// Activates Rally for affected allies.
    /// </summary>
    public async Task<int> ActivateRallyAsync(Character character, IReadOnlyList<Character> allCharacters)
    {
        const int RANGE = 6;
        const int SAVE_BONUS = 2;

        // Find affected allies
        var affectedAllies = allCharacters
            .Where(c => c.Id != character.Id &&
                       !c.IsEnemy(character) &&
                       character.Position.DistanceTo(c.Position) <= RANGE)
            .ToList();

        int affectedCount = 0;

        // Apply buff to each
        foreach (var ally in affectedAllies)
        {
            var buff = new RallyBuff
            {
                AffectedCharacterId = ally.Id,
                SaveBonus = SAVE_BONUS,
                AppliedAt = DateTime.UtcNow,
                CasterCharacterId = character.Id
            };

            ally.RallyBuffs.Add(buff);
            await _characterRepository.UpdateAsync(ally);
            affectedCount++;
        }

        _logger.LogInformation(
            "Rally activated: Character {CasterId} ({CasterName}) affected " +
            "{AffectedCount} allies within {Range} spaces",
            character.Id, character.Name, affectedCount, RANGE);

        return affectedCount;
    }

    /// <summary>
    /// Checks if character can unlock Tier 2 abilities.
    /// </summary>
    public bool CanUnlockTier2(Character character)
    {
        if (character.Specialization != SpecializationId.Skjaldmaer)
            return false;

        return GetPPInvested(character) >= 8;
    }

    /// <summary>
    /// Calculates total PP invested in ability tree.
    /// </summary>
    public int GetPPInvested(Character character)
    {
        int total = 0;

        // Tier 1 abilities (free)
        // No cost

        // Tier 2 abilities (4 PP each)
        if (character.HasAbilityUnlocked(SkjaldmaerAbilityId.HoldTheLine))
            total += 4;
        if (character.HasAbilityUnlocked(SkjaldmaerAbilityId.CounterShield))
            total += 4;
        if (character.HasAbilityUnlocked(SkjaldmaerAbilityId.Rally))
            total += 4;

        // Tier 3 abilities (5 PP each)
        if (character.HasAbilityUnlocked(SkjaldmaerAbilityId.Unbreakable))
            total += 5;
        if (character.HasAbilityUnlocked(SkjaldmaerAbilityId.GuardiansSacrifice))
            total += 5;

        // Capstone (6 PP)
        if (character.HasAbilityUnlocked(SkjaldmaerAbilityId.TheWallLives))
            total += 6;

        return total;
    }

    /// <summary>
    /// Gets save bonus from active Rally buffs.
    /// </summary>
    public int GetAllySaveBonus(Character character)
    {
        return character.RallyBuffs
            .Where(b => b.IsActive())
            .Sum(b => b.SaveBonus);
    }

    // Tier 1 methods omitted for brevity...
}
```

### 13.2 PrerequisiteService Implementation

```csharp
/// <summary>
/// Service for validating ability prerequisites and unlock costs.
/// </summary>
public class PrerequisiteService : IPrerequisiteService
{
    private readonly ICharacterRepository _characterRepository;
    private readonly ILogger<PrerequisiteService> _logger;

    public PrerequisiteService(
        ICharacterRepository characterRepository,
        ILogger<PrerequisiteService> logger)
    {
        _characterRepository = characterRepository;
        _logger = logger;
    }

    /// <summary>
    /// Determines if character can unlock specified ability.
    /// </summary>
    public PrerequisiteCheckResult CanUnlockAbility(Character character, SkjaldmaerAbilityId abilityId)
    {
        var missingPrereqs = GetMissingPrerequisites(character, abilityId).ToList();

        if (missingPrereqs.Count > 0)
        {
            _logger.LogWarning(
                "Cannot unlock ability {AbilityId} for character {CharacterId}: " +
                "{MissingCount} missing prerequisites",
                abilityId, character.Id, missingPrereqs.Count);

            return PrerequisiteCheckResult.Failure(missingPrereqs.ToArray());
        }

        return PrerequisiteCheckResult.Success();
    }

    /// <summary>
    /// Gets list of missing prerequisites for an ability.
    /// </summary>
    public IReadOnlyList<string> GetMissingPrerequisites(Character character, SkjaldmaerAbilityId abilityId)
    {
        var missing = new List<string>();

        // All abilities require Skjaldmær specialization
        if (character.Specialization != SpecializationId.Skjaldmaer)
        {
            missing.Add("Only Skjaldmær can use this ability");
            return missing;
        }

        int ppInvested = GetTotalPPInvested(character);

        // Tier 2 abilities
        if (abilityId is >= SkjaldmaerAbilityId.HoldTheLine and <= SkjaldmaerAbilityId.Rally)
        {
            if (ppInvested < 8)
                missing.Add($"Requires 8 PP invested (you have {ppInvested})");
        }

        // Tier 3 abilities
        if (abilityId is >= SkjaldmaerAbilityId.Unbreakable and <= SkjaldmaerAbilityId.GuardiansSacrifice)
        {
            if (ppInvested < 16)
                missing.Add($"Requires 16 PP invested (you have {ppInvested})");
        }

        // Capstone
        if (abilityId == SkjaldmaerAbilityId.TheWallLives)
        {
            if (ppInvested < 24)
                missing.Add($"Requires 24 PP invested (you have {ppInvested})");
        }

        return missing;
    }

    /// <summary>
    /// Calculates total PP invested in specialization tree.
    /// </summary>
    public int GetTotalPPInvested(Character character)
    {
        int total = 0;

        // Tier 2 (4 PP each)
        if (character.HasAbilityUnlocked(SkjaldmaerAbilityId.HoldTheLine)) total += 4;
        if (character.HasAbilityUnlocked(SkjaldmaerAbilityId.CounterShield)) total += 4;
        if (character.HasAbilityUnlocked(SkjaldmaerAbilityId.Rally)) total += 4;

        // Tier 3 (5 PP each)
        if (character.HasAbilityUnlocked(SkjaldmaerAbilityId.Unbreakable)) total += 5;
        if (character.HasAbilityUnlocked(SkjaldmaerAbilityId.GuardiansSacrifice)) total += 5;

        // Capstone (6 PP)
        if (character.HasAbilityUnlocked(SkjaldmaerAbilityId.TheWallLives)) total += 6;

        return total;
    }
}
```

---

## 14. Logging Specifications

### 14.1 Hold the Line Logging

```
Activation:
[INFO] SkjaldmaerAbilityService: Hold the Line activated: Character {CharacterId} ({Name}) blocks position {Position}

Tick (turn decrement):
[DEBUG] CombatSystem: Hold the Line tick: Character {CharacterId}, turns remaining {TurnsRemaining}

Movement Blocked:
[INFO] MovementSystem: Hold the Line blocked movement: Character {CharacterId} attempted to move through {BlockedPosition}, blocked by {BlockingCharacterId}

Early Termination:
[INFO] SkjaldmaerAbilityService: Hold the Line terminated: Character {CharacterId} moved/incapacitated
```

### 14.2 Counter-Shield Logging

```
Successful Block Detected:
[DEBUG] CombatSystem: Block detected: Attack from {AttackerId} on {SkjaldmaerId} missed due to Defense

Counter-Shield Triggered:
[INFO] SkjaldmaerAbilityService: Counter-Shield executed: Character {CharacterId} ({Name}) dealt {Damage} counter damage to {AttackerId}

Damage Applied:
[INFO] DamageSystem: Counter-Shield damage: {SkjaldmaerId} dealt {Damage} to {AttackerId}
```

### 14.3 Rally Logging

```
Activation:
[INFO] SkjaldmaerAbilityService: Rally activated: Character {CasterId} ({CasterName}) affected {AffectedCount} allies within {Range} spaces

Buff Applied:
[DEBUG] StatusEffectSystem: Rally buff applied to character {CharacterId}: +{Bonus} to next save

Buff Consumed:
[INFO] SavingThrowSystem: Rally buff consumed: Character {CharacterId} used +{Bonus} on save

Buff Removed (Combat End):
[DEBUG] StatusEffectSystem: Rally buff removed: Character {CharacterId} combat ended
```

---

## 15. Unit Testing Requirements

### 15.1 Tier 2 Ability Tests

**File:** `Tests/Application/Tier2AbilityTests.cs`

**Test Count:** 8 tests

```csharp
[TestFixture]
public class Tier2AbilityTests
{
    private ISkjaldmaerAbilityService _abilityService;
    private IPrerequisiteService _prerequisiteService;
    private Mock<ICharacterRepository> _mockRepository;
    private Character _character;

    [SetUp]
    public void Setup()
    {
        _mockRepository = new Mock<ICharacterRepository>();
        _prerequisiteService = new PrerequisiteService(_mockRepository.Object, Mock.Of<ILogger<PrerequisiteService>>());
        _abilityService = new SkjaldmaerAbilityService(
            _mockRepository.Object,
            _prerequisiteService,
            new DiceRoller(),
            Mock.Of<ILogger<SkjaldmaerAbilityService>>());

        _character = CreateSkjaldmaerCharacter();
    }

    [Test]
    public void CanUnlockTier2_With8PPInvested_ReturnsTrue()
    {
        // Arrange
        _character.UnlockAbility(SkjaldmaerAbilityId.HoldTheLine); // 4 PP
        _character.UnlockAbility(SkjaldmaerAbilityId.CounterShield); // 4 PP
        // Total: 8 PP

        // Act
        bool result = _abilityService.CanUnlockTier2(_character);

        // Assert
        Assert.That(result, Is.True);
    }

    [Test]
    public void CanUnlockTier2_With7PPInvested_ReturnsFalse()
    {
        // Arrange
        _character.UnlockAbility(SkjaldmaerAbilityId.HoldTheLine); // 4 PP
        // Total: 4 PP

        // Act
        bool result = _abilityService.CanUnlockTier2(_character);

        // Assert
        Assert.That(result, Is.False);
    }

    [Test]
    public async Task ActivateHoldTheLineAsync_CreatesBlockingEffect()
    {
        // Arrange
        _character.UnlockAbility(SkjaldmaerAbilityId.HoldTheLine);
        _character.UnlockAbility(SkjaldmaerAbilityId.CounterShield);

        // Act
        bool result = await _abilityService.ActivateHoldTheLineAsync(_character);

        // Assert
        Assert.That(result, Is.True);
        Assert.That(_character.HoldTheLineState, Is.Not.Null);
        Assert.That(_character.HoldTheLineState.IsActive, Is.True);
        Assert.That(_character.HoldTheLineState.TurnsRemaining, Is.EqualTo(2));
    }

    [Test]
    public async Task TryCounterShieldAsync_DealsDamage()
    {
        // Arrange
        var attacker = CreateCharacter();
        attacker.CurrentHP = 20;

        // Act
        int damage = await _abilityService.TryCounterShieldAsync(_character, attacker);

        // Assert
        Assert.That(damage, Is.GreaterThanOrEqualTo(1).And.LessThanOrEqualTo(6));
        Assert.That(attacker.CurrentHP, Is.LessThan(20));
    }

    [Test]
    public async Task ActivateRallyAsync_AppliesBuffToAllies()
    {
        // Arrange
        var allies = new[]
        {
            CreateCharacter(),
            CreateCharacter(),
            CreateCharacter()
        };
        var allCharacters = new List<Character> { _character }.Concat(allies).ToList();

        // Act
        int affectedCount = await _abilityService.ActivateRallyAsync(_character, allCharacters);

        // Assert
        Assert.That(affectedCount, Is.EqualTo(3));
        foreach (var ally in allies)
        {
            Assert.That(ally.RallyBuffs, Has.Count.GreaterThan(0));
        }
    }

    [Test]
    public void GetPPInvested_ReturnsCorrectSum()
    {
        // Arrange
        _character.UnlockAbility(SkjaldmaerAbilityId.HoldTheLine); // 4 PP
        _character.UnlockAbility(SkjaldmaerAbilityId.CounterShield); // 4 PP
        _character.UnlockAbility(SkjaldmaerAbilityId.Unbreakable); // 5 PP
        // Total: 13 PP

        // Act
        int ppInvested = _abilityService.GetPPInvested(_character);

        // Assert
        Assert.That(ppInvested, Is.EqualTo(13));
    }

    [Test]
    public void HoldTheLineState_Tick_DecrementsTurns()
    {
        // Arrange
        var state = new HoldTheLineState { BlockedPosition = new Position(5, 5, 0) };
        state.Activate();

        // Act
        state.Tick();

        // Assert
        Assert.That(state.TurnsRemaining, Is.EqualTo(1));
        Assert.That(state.IsActive, Is.True);

        state.Tick();

        Assert.That(state.TurnsRemaining, Is.EqualTo(0));
        Assert.That(state.IsActive, Is.False);
    }

    [Test]
    public void RallyBuff_Consume_MarksAsConsumed()
    {
        // Arrange
        var buff = new RallyBuff
        {
            AffectedCharacterId = Guid.NewGuid(),
            SaveBonus = 2,
            AppliedAt = DateTime.UtcNow,
            CasterCharacterId = Guid.NewGuid()
        };

        // Act
        buff.Consume();

        // Assert
        Assert.That(buff.IsConsumed, Is.True);
        Assert.That(buff.IsActive(), Is.False);
    }

    private Character CreateSkjaldmaerCharacter()
    {
        return new Character
        {
            Id = Guid.NewGuid(),
            Name = "Test Skjaldmaer",
            Specialization = SpecializationId.Skjaldmaer,
            CurrentAP = 10
        };
    }

    private Character CreateCharacter()
    {
        return new Character { Id = Guid.NewGuid() };
    }
}
```

---

## 16. Integration Testing Requirements

### 16.1 Tier 2 Integration Tests

**File:** `Tests/Integration/Tier2AbilityIntegrationTests.cs`

```csharp
[TestFixture]
public class Tier2AbilityIntegrationTests
{
    private IServiceProvider _serviceProvider;
    private ICombatContext _combatContext;

    [SetUp]
    public void Setup()
    {
        _serviceProvider = new ServiceCollection()
            .AddScoped<ISkjaldmaerAbilityService, SkjaldmaerAbilityService>()
            .AddScoped<IPrerequisiteService, PrerequisiteService>()
            .AddScoped<ICharacterRepository, InMemoryCharacterRepository>()
            .BuildServiceProvider();

        _combatContext = new CombatContext();
    }

    [Test]
    public async Task HoldTheLine_BlocksEnemyMovement()
    {
        // Arrange
        var abilityService = _serviceProvider.GetRequiredService<ISkjaldmaerAbilityService>();
        var skjaldmaer = CreateSkjaldmaerWithAbility(SkjaldmaerAbilityId.HoldTheLine);
        var enemy = CreateEnemy();

        var combatant1 = new Position(5, 5, 0); // Skjaldmaer
        var combatant2 = new Position(6, 5, 0); // Enemy
        var destination = new Position(4, 5, 0); // Through Skjaldmaer

        skjaldmaer.Position = combatant1;
        enemy.Position = combatant2;

        // Act
        await abilityService.ActivateHoldTheLineAsync(skjaldmaer);
        bool canMove = _combatContext.CanMoveTo(enemy, destination);

        // Assert
        Assert.That(canMove, Is.False, "Enemy should not be able to move through blocked position");
    }

    [Test]
    public async Task Rally_IncreasesAllySaveBonus()
    {
        // Arrange
        var abilityService = _serviceProvider.GetRequiredService<ISkjaldmaerAbilityService>();
        var skjaldmaer = CreateSkjaldmaerWithAbility(SkjaldmaerAbilityId.Rally);
        var ally = new Character { Id = Guid.NewGuid() };

        var characters = new[] { skjaldmaer, ally };

        // Act
        await abilityService.ActivateRallyAsync(skjaldmaer, characters);

        int saveBonus = ally.GetRallySaveBonus();

        // Assert
        Assert.That(saveBonus, Is.EqualTo(2));
    }
}
```

---

## 17. Deliverable Checklist

### Domain Layer Deliverables

- [ ] `HoldTheLineState` value object
- [ ] `RallyBuff` value object
- [ ] `CounterShieldResult` value object
- [ ] Character entity extensions (new properties/methods)
- [ ] Prerequisite enum/constants

### Application Layer Deliverables

- [ ] Enhanced `ISkjaldmaerAbilityService` interface
- [ ] `IPrerequisiteService` interface
- [ ] `SkjaldmaerAbilityService` implementation (Tier 2 methods)
- [ ] `PrerequisiteService` implementation
- [ ] `HoldTheLineAbilityHandler` implementation
- [ ] `CounterShieldAbilityHandler` implementation
- [ ] `RallyAbilityHandler` implementation

### Infrastructure Layer Deliverables

- [ ] `specializations.json` Tier 2 update
- [ ] `abilities.json` three Tier 2 entries (hold-the-line, counter-shield, rally)

### Testing Deliverables

- [ ] Tier 2 unit tests (~8 tests)
- [ ] Integration tests for Hold the Line
- [ ] Integration tests for Rally
- [ ] All tests passing with 85%+ coverage

### Documentation Deliverables

- [ ] v0.20.1b Design Specification (this document)
- [ ] Logging specifications documented
- [ ] Architecture diagrams completed

---

## 18. Acceptance Criteria

- [ ] **AC-T2-1:** Tier 2 abilities locked until 8 PP invested in tree
- [ ] **AC-T2-2:** Each Tier 2 ability costs exactly 4 PP to unlock
- [ ] **AC-T2-3:** Hold the Line prevents enemy movement for exactly 2 turns
- [ ] **AC-T2-4:** Hold the Line effect ends when Skjaldmær moves
- [ ] **AC-T2-5:** Counter-Shield triggers automatically on successful block
- [ ] **AC-T2-6:** Counter-Shield deals 1d6 damage to melee attacker
- [ ] **AC-T2-7:** Counter-Shield does not trigger on ranged attacks
- [ ] **AC-T2-8:** Rally grants +2 to all allies' next saving throw
- [ ] **AC-T2-9:** Rally buff consumed after one save (successful or failed)
- [ ] **AC-T2-10:** Rally affects all allies within 6 spaces
- [ ] **AC-T2-11:** Rally does not affect self

---

## 19. Dependencies

**Hard Dependencies:**
- v0.20.1a (Block Charges, Tier 1 abilities, framework)
- v0.17.4 (Specialization framework, PP system)
- v0.20.0 (Character entity v2, ability system)

**Core System Dependencies:**
- Combat system (attack resolution, triggers)
- Position system (distance, movement blocking)
- Saving throw system (save bonus integration)
- Status effect system (buff application)

---

## 20. Deferrals and Future Considerations

**Deferred to v0.20.1c:**
- Unbreakable passive (damage reduction)
- Guardian's Sacrifice reaction (damage absorption)
- The Wall Lives capstone (lethal protection)
- Tier 3+ prerequisites

**Future Enhancements:**
- Hold the Line extension (block larger areas)
- Counter-Shield scaling (damage based on Defense)
- Rally cooldown (reuse limitation)
- Movement cost modification (Hold the Line exit penalty)

---

**Document Version:** 0.20.1b-v1.0
**Last Updated:** 2026-01-28
**Status:** Design Phase - Ready for Review
**Next Phase:** v0.20.1c Design Specification (Tier 3 & Capstone)
