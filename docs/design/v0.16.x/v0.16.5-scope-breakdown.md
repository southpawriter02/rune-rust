## v0.16.5 - Unique Items & Myth-Forged System

**Focus:** Unique item registry, duplicate prevention, special effects, and legendary drop presentation

**Source Specification:** [loot-generation.md](../../aethelgard/design/04-systems/loot-generation.md)

### Overview

This version implements the Myth-Forged (Tier 4) unique item system. Legendary items have special effects that can define a run, require duplicate prevention to maintain their "legendary" status, and deserve special presentation (visual/audio feedback). Each unique can only drop once per run.

---

### Deliverables Summary

| Category | Items | Estimated Tests |
|----------|-------|-----------------|
| Enums | 1 | 2 |
| Value Objects | 3 | 3 |
| Entities | 2 | 3 |
| Services | 2 | 2 |
| **Total** | **8** | **~10** |

---

### v0.16.5a - Unique Item Definition

#### UniqueItem Entity
```
UniqueItem
├── ItemId: string
├── Name: string
├── Quality: QualityTier (always MythForged)
├── ItemCategory: string (Weapon, Armor, Accessory)
├── WeaponCategory: WeaponCategory? (if weapon)
├── ArmorCategory: ArmorCategory? (if armor)
├── BaseStats: ItemStats
├── SpecialEffects: List<SpecialEffect>
├── LoreText: string
├── FlavorText: string
├── DropSources: List<DropSource>
├── IsOnePerRun: bool (true for most uniques)
├── ClassAffinity: EquipmentClassAffinity
```

#### ItemStats Value Object
```
ItemStats
├── DamageDice: string? (for weapons)
├── AccuracyBonus: int
├── DefenseBonus: int (for armor)
├── HpBonus: int (for armor)
├── AttributeBonuses: Dictionary<string, int>
├── SpecialProperties: List<string>
```

#### DropSource Value Object
```
DropSource
├── SourceType: DropSourceType enum
├── SourceId: string (enemy ID, container ID, etc.)
├── DropChance: float (within Myth-Forged pool)
├── RequiredConditions: List<string>?
```

#### DropSourceType Enum
```
DropSourceType
├── Boss - Specific boss enemy
├── AnyBoss - Any boss encounter
├── Elite - Elite enemies
├── Container - Boss chests, hidden caches
├── Quest - Quest reward
├── Vendor - Special vendor (rare)
```

**Example Unique Items:**
| Name | Category | Effect | Drop Source |
|------|----------|--------|-------------|
| Dvergr Maul | Weapon (Hammer) | +2 MIGHT, Ignores Armor | Any Boss |
| Frostbane | Weapon (Sword) | +2 FINESSE, Ice damage, Slow on hit | Niflheim Boss |
| Paradox Blade | Weapon (Dagger) | +2 WITS, Phase through blocks | Alfheim Boss |
| Ironheart Plate | Armor (Heavy) | +3 STURDINESS, Damage reflection | Jötunheim Boss |
| Whispercloak | Armor (Light) | +2 FINESSE, Auto-hide after kill | Any Boss |
| Eye of the Deep | Accessory | +2 WILL, See hidden, Detect traps | Hidden Cache |

**Configuration (`unique-items.json`):**
```json
{
  "uniqueItems": [
    {
      "itemId": "dvergr_maul",
      "name": "Dvergr Maul",
      "quality": "MythForged",
      "itemCategory": "Weapon",
      "weaponCategory": "Hammers",
      "baseStats": {
        "damageDice": "2d6+4",
        "accuracyBonus": 2,
        "attributeBonuses": { "MIGHT": 2 }
      },
      "specialEffects": [
        { "effectId": "ignore_armor", "description": "Attacks ignore target's Defense bonus" }
      ],
      "loreText": "A heavy hammer humming with ancient power. The Deep Kings forged this for the final war.",
      "flavorText": "The air hums. A relic of the Deep Kings lies before you.",
      "dropSources": [
        { "sourceType": "AnyBoss", "dropChance": 0.15 }
      ],
      "isOnePerRun": true,
      "classAffinity": "Warrior"
    }
  ]
}
```

**Unit Tests (~2):**
- [ ] Unique item loads from configuration
- [ ] Special effects parsed correctly

---

### v0.16.5b - Special Effect System

#### SpecialEffect Value Object
```
SpecialEffect
├── EffectId: string
├── EffectType: SpecialEffectType enum
├── Description: string
├── Magnitude: float? (for scaling effects)
├── TriggerCondition: string?
├── Duration: int? (rounds, if temporary)
├── Cooldown: int? (rounds between uses)
```

#### SpecialEffectType Enum
```
SpecialEffectType
├── IgnoreArmor - Bypass defense
├── LifeSteal - Heal on damage
├── Cleave - Hit multiple targets
├── ElementalDamage - Add fire/ice/lightning
├── AttributeBoost - Attribute bonuses (stacks with base)
├── Slow - Reduce target speed
├── Stun - Chance to stun
├── Phase - Bypass blocks/parries
├── Reflect - Damage reflection
├── AutoHide - Enter stealth on trigger
├── Detection - Reveal hidden/traps
├── Regeneration - Heal over time
├── DamageReduction - Flat damage reduction
├── CriticalBonus - Increased crit chance
├── AbilityUnlock - Grants unique ability
```

**Effect Implementations:**
| Effect | Trigger | Magnitude | Notes |
|--------|---------|-----------|-------|
| IgnoreArmor | On attack | 100% | Target Defense = 0 |
| LifeSteal | On damage | 20-50% | Heal % of damage dealt |
| Cleave | On attack | 2-3 targets | Adjacent enemies hit |
| ElementalDamage | On hit | +1d6-2d6 | Type determines effect |
| Slow | On hit | -10 to -20 speed | Lasts 2 rounds |
| Phase | On attack | — | Cannot be blocked |
| AutoHide | On kill | — | Enter [Hidden] state |

**Effect Processing:**
```
OnWeaponHit(attacker, target, weapon):
  For each SpecialEffect in weapon.SpecialEffects:
    If effect.TriggerCondition met:
      If effect.Cooldown == 0 OR not on cooldown:
        Apply effect.EffectType with effect.Magnitude
        If effect.Cooldown: Start cooldown timer
```

**Unit Tests (~2):**
- [ ] IgnoreArmor sets defense to 0
- [ ] LifeSteal heals correct percentage

---

### v0.16.5c - Unique Item Registry

#### UniqueItemRegistry Entity
```
UniqueItemRegistry
├── RunId: string
├── DroppedUniques: HashSet<string>
├── EquippedUniques: Dictionary<string, string> (itemId → characterId)
├── PendingDrops: Queue<string> (guaranteed future drops)
├── Methods:
│   ├── HasDropped(itemId) → bool
│   ├── RegisterDrop(itemId) → void
│   ├── GetAvailableUniques(tier, source) → List<UniqueItem>
│   ├── CanDrop(itemId) → bool
│   ├── EquipUnique(itemId, characterId) → void
│   └── Reset() → void
```

**Duplicate Prevention Logic:**
```
GetAvailableUniques(tier, dropSource):
  1. Get all unique items of specified tier
  2. Filter by drop source compatibility
  3. For each item where IsOnePerRun:
     - If HasDropped(itemId): Exclude
  4. Return remaining pool
```

**Registration Flow:**
```
On Unique Item Drop:
  1. Check registry: CanDrop(itemId)
  2. If can drop:
     a. RegisterDrop(itemId)
     b. Create item instance
     c. Add to loot
  3. If cannot drop:
     a. Re-roll from available pool
     b. If pool empty: Downgrade to Tier 3 item
```

**Unit Tests (~2):**
- [ ] Same unique cannot drop twice
- [ ] Registry resets between runs

---

### v0.16.5d - Myth-Forged Drop Integration

#### IMythForgedService Interface
```csharp
public interface IMythForgedService
{
    /// <summary>
    /// Attempts to generate a Myth-Forged unique item.
    /// </summary>
    UniqueItem? TryGenerateMythForged(
        DropSourceType sourceType,
        string sourceId,
        PlayerCharacter? player,
        Random rng);

    /// <summary>
    /// Gets drop chance for Myth-Forged from source.
    /// </summary>
    float GetMythForgedChance(DropSourceType sourceType, string sourceId);

    /// <summary>
    /// Checks if any uniques available for drop.
    /// </summary>
    bool HasAvailableUniques(DropSourceType sourceType);

    /// <summary>
    /// Gets all unique items for display/catalog.
    /// </summary>
    IReadOnlyList<UniqueItem> GetAllUniques();
}
```

**Myth-Forged Generation Flow:**
```
TryGenerateMythForged(sourceType, sourceId, player, rng):
  1. Get available uniques for source
  2. If empty: Return null (downgrade to Tier 3)
  3. Apply class affinity filter (if player provided):
     a. 60% chance: Filter to player's class
     b. 40% chance: Use full pool
  4. If filtered pool empty: Use full pool
  5. Select random unique from pool
  6. Register in UniqueItemRegistry
  7. Return unique item
```

**Drop Chance by Source:**
| Source | Base Chance | Notes |
|--------|-------------|-------|
| Boss | 70% | Already rolled as Tier 4 |
| Elite | 10% | Within Tier 3-4 pool |
| Boss Chest | 50% | One item guaranteed Myth-Forged |
| Hidden Cache | 15% | Rare but possible |
| Quest Reward | 100% | If quest rewards Myth-Forged |

**Unit Tests (~2):**
- [ ] Myth-Forged generates from available pool
- [ ] Class affinity filter applies 60% of time

---

### v0.16.5e - Legendary Drop Presentation

#### MythForgedDropEvent Value Object
```
MythForgedDropEvent
├── ItemId: string
├── ItemName: string
├── DropSource: string
├── DroppedAt: DateTime
├── CharacterId: string?
├── RoomId: string
├── FlavorText: string
├── ShouldPlayFanfare: bool
```

#### ILegendaryPresentation Interface
```csharp
public interface ILegendaryPresentation
{
    /// <summary>
    /// Gets the announcement text for a legendary drop.
    /// </summary>
    string GetDropAnnouncement(UniqueItem item);

    /// <summary>
    /// Gets the examination text for a legendary item.
    /// </summary>
    string GetExaminationText(UniqueItem item, bool isExpertLevel);

    /// <summary>
    /// Gets color for item name display.
    /// </summary>
    string GetDisplayColor(QualityTier tier);
}
```

**Drop Announcement Examples:**
```
Standard Drop:
  "A Scavenged Iron Sword clatters to the floor."

Myth-Forged Drop:
  ═══════════════════════════════════════════════
  ✦ LEGENDARY DROP ✦
  The air hums. A relic of the Deep Kings lies before you.

  [Myth-Forged] Dvergr Maul
  2d6+4 Damage | +2 MIGHT | Ignores Armor
  ═══════════════════════════════════════════════
```

**Examination Text:**
```
> examine dvergr maul

[Myth-Forged] Dvergr Maul
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
Type: Weapon (Heavy Hammer)
Damage: 2d6+4
Accuracy: +2
Attribute: +2 MIGHT

Special: Ignores Armor
  Attacks bypass target's Defense bonus entirely.

Lore: A heavy hammer humming with ancient power.
The Deep Kings forged this for the final war.
They lost, but the hammer endures.
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
```

**Color Constants:**
```csharp
public static class TierColors
{
    public const string JuryRigged = "#808080";  // Gray
    public const string Scavenged = "#FFFFFF";   // White
    public const string ClanForged = "#00FF00";  // Green
    public const string Optimized = "#800080";   // Purple
    public const string MythForged = "#FFD700";  // Gold
}
```

**Unit Tests (~2):**
- [ ] Myth-Forged drop shows special announcement
- [ ] Color constants match tier

---

### v0.16.5f - Achievement Integration

#### UniqueItemAchievements Value Object
```
UniqueItemAchievements
├── FirstMythForged - First legendary drop
├── CollectorBronze - 5 unique items found
├── CollectorSilver - 15 unique items found
├── CollectorGold - All unique items found
├── ClassMaster - All class-specific uniques for one class
```

**Achievement Tracking:**
```
OnUniqueDrop(item):
  1. Add to player's collection tracker
  2. Check achievement progress:
     - If first Myth-Forged: Unlock FirstMythForged
     - If collection size thresholds met: Unlock tier
  3. Update persistent collection (across runs)
```

**Note:** Achievement system is a future feature - this provides hooks for integration.

---

### Configuration Files

| File | Purpose |
|------|---------|
| `unique-items.json` | All unique item definitions |
| `special-effects.json` | Effect type definitions |
| `legendary-presentation.json` | Announcement text templates |

---

### Dependencies

**Requires:**
- v0.16.0: Quality tier system (Myth-Forged tier)
- v0.16.3: Smart loot (class affinity)
- v0.16.4: Container loot (boss chests)
- Combat system: Special effect processing

**Provides to:**
- Achievement system: Collection tracking
- Character power: Run-defining upgrades
- Player engagement: Excitement through rarity

---

### Acceptance Criteria

- [ ] UniqueItem entity has all required fields
- [ ] SpecialEffectType enum covers all effect types
- [ ] Special effects process correctly in combat
- [ ] IgnoreArmor bypasses defense
- [ ] LifeSteal heals correct amount
- [ ] UniqueItemRegistry tracks drops per run
- [ ] Same unique cannot drop twice per run
- [ ] Registry resets between runs
- [ ] Class affinity filter applies 60% of time
- [ ] Empty pool falls back to Tier 3
- [ ] Myth-Forged drops show special presentation
- [ ] Gold color (#FFD700) used for display
- [ ] Lore text appears in examination
- [ ] ~10 unit tests pass
