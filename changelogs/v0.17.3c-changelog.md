# Changelog: v0.17.3c - Starting Abilities

**Release Date:** 2026-01-30
**Phase:** Archetype System (3/6)
**Status:** Complete

---

## Overview

Implements the `AbilityType` enumeration and `ArchetypeAbilityGrant` value object that encapsulate the starting abilities each archetype receives during character creation. Every archetype grants exactly 3 starting abilities that define the character's initial combat capabilities.

The starting abilities per archetype are:

| Archetype  | Ability 1              | Ability 2               | Ability 3           |
| ---------- | ---------------------- | ----------------------- | ------------------- |
| Warrior    | Power Strike (Active)  | Defensive Stance (Stance) | Iron Will (Passive) |
| Skirmisher | Quick Strike (Active)  | Evasive Maneuvers (Active) | Opportunist (Passive) |
| Mystic     | Aether Bolt (Active)   | Aether Shield (Active)  | Aether Sense (Passive) |
| Adept      | Precise Strike (Active) | Assess Weakness (Active) | Resourceful (Passive) |

Each ability is classified by `AbilityType` (Active, Passive, Stance) and identified by a kebab-case `AbilityId` that references the Ability System (v0.15.x). The `ArchetypeAbilityGrant` value object is an immutable `readonly record struct` following the established codebase pattern (matching `ArchetypeSpecialBonus`, `ArchetypeResourceBonuses`).

---

## Added

### Domain Layer

#### Enums

- **`AbilityType`** (`Enums/AbilityType.cs`)
    - Enum with 3 values: `Active` (0), `Passive` (1), `Stance` (2)
    - Explicit integer assignments (0-2) for stable serialization and database storage
    - Comprehensive XML documentation with `<summary>`, `<remarks>`, `<list>`, `<para>`, `<seealso>` tags
    - Per-value remarks detailing activation behavior, cost, effect duration, and examples
    - Per-value lists of starting abilities by archetype for each type
    - `<seealso>` cross-references to `ArchetypeAbilityGrant`, `Archetype`, `ArchetypeDefinition`

#### Value Objects

- **`ArchetypeAbilityGrant`** (`ValueObjects/ArchetypeAbilityGrant.cs`)
    - `readonly record struct` with primary constructor `(string AbilityId, string AbilityName, AbilityType AbilityType, string Description)`
    - File header with `═══` borders, Version: 0.17.3c
    - Section separators: PRIVATE FIELDS, COMPUTED PROPERTIES, FACTORY METHODS, HELPER METHODS, DEBUGGING
    - Static `ILogger<ArchetypeAbilityGrant>?` field for diagnostic output
    - Computed properties: `IsPassive`, `IsActive`, `IsStance`, `RequiresActivation`, `TypeDisplay`
    - `Create()` factory method with:
        - 4 required parameters + optional logger
        - `ArgumentException.ThrowIfNullOrWhiteSpace` for all 3 string parameters
        - AbilityId normalization to lowercase via `ToLowerInvariant()`
        - Debug logging on entry and after validation
        - Information logging on successful creation with all properties
    - `CreateActive()`: Convenience factory for Active ability grants
    - `CreatePassive()`: Convenience factory for Passive ability grants
    - `CreateStance()`: Convenience factory for Stance ability grants
    - `GetDisplayString()`: Returns multi-line `"{AbilityName} {TypeDisplay}\n{Description}"`
    - `GetShortDisplay()`: Returns single-line `"{AbilityName} {TypeDisplay}"`
    - `ToString()`: Returns `"{AbilityId}: {AbilityName} ({AbilityType})"`
    - Full XML documentation on every member with `<summary>`, `<value>`, `<remarks>`, `<param>`, `<returns>`, `<exception>`, `<example>`, `<seealso>`

### Unit Tests

- **`AbilityTypeTests`** (`Enums/AbilityTypeTests.cs`) — 5 tests
    - `AbilityType_HasThreeValues`: Verifies exactly 3 enum values
    - `AbilityType_ContainsAllExpectedValues`: Verifies Active, Passive, Stance present
    - `AbilityType_HasCorrectIntegerValues`: Parameterized test (Active=0, Passive=1, Stance=2)

- **`ArchetypeAbilityGrantTests`** (`ValueObjects/ArchetypeAbilityGrantTests.cs`) — 22 tests
    - `Create_WithValidData_ReturnsGrant`: Full property verification for Active ability
    - `Create_NormalizesAbilityIdToLowercase`: "Power-Strike" → "power-strike"
    - `Create_WithNullAbilityId_ThrowsArgumentException`: Null ability ID rejection
    - `Create_WithWhitespaceAbilityId_ThrowsArgumentException`: Whitespace ability ID rejection
    - `Create_WithNullAbilityName_ThrowsArgumentException`: Null ability name rejection
    - `Create_WithWhitespaceAbilityName_ThrowsArgumentException`: Whitespace ability name rejection
    - `Create_WithNullDescription_ThrowsArgumentException`: Null description rejection
    - `Create_WithWhitespaceDescription_ThrowsArgumentException`: Whitespace description rejection
    - `CreateActive_SetsCorrectType`: Active type with all computed properties verified
    - `CreatePassive_SetsCorrectType`: Passive type with all computed properties verified
    - `CreateStance_SetsCorrectType`: Stance type with all computed properties verified
    - `IsPassive_ReturnsFalse_ForActiveAbility`: Cross-type verification
    - `IsStance_ReturnsFalse_ForPassiveAbility`: Cross-type verification
    - `RequiresActivation_ReturnsTrue_ForActiveAbility`: Activation requirement
    - `RequiresActivation_ReturnsTrue_ForStanceAbility`: Activation requirement
    - `RequiresActivation_ReturnsFalse_ForPassiveAbility`: No activation for passives
    - `TypeDisplay_Active_ReturnsActiveTag`: "[ACTIVE]" format
    - `TypeDisplay_Passive_ReturnsPassiveTag`: "[PASSIVE]" format
    - `TypeDisplay_Stance_ReturnsStanceTag`: "[STANCE]" format
    - `GetDisplayString_ReturnsFormattedOutput`: Multi-line display verification
    - `GetShortDisplay_ReturnsNameAndType`: "Power Strike [ACTIVE]" format
    - `GetShortDisplay_Passive_ReturnsNameAndPassiveTag`: "Iron Will [PASSIVE]" format
    - `ToString_ReturnsFormattedString`: "power-strike: Power Strike (Active)" format
    - `ToString_Stance_ReturnsFormattedString`: "defensive-stance: Defensive Stance (Stance)" format

### Glossary

- **`config/glossary.json`** — Added 2 glossary entries
    - `ability-type`: Classification of abilities by activation behavior — Active, Passive, Stance (sortOrder: 29)
    - `archetype-ability-grant`: Starting abilities (3 per archetype) granted during character creation (sortOrder: 30)

---

## Changed

### Configuration Files

- **`config/archetypes.json`** — Added `startingAbilities` section to all 4 archetypes
    - Each archetype entry now includes a `startingAbilities` array with exactly 3 ability objects
    - Each ability object has `abilityId` (kebab-case), `abilityName`, `abilityType`, and `description` fields
    - Warrior: power-strike (Active), defensive-stance (Stance), iron-will (Passive)
    - Skirmisher: quick-strike (Active), evasive-maneuvers (Active), opportunist (Passive)
    - Mystic: aether-bolt (Active), aether-shield (Active), aether-sense (Passive)
    - Adept: precise-strike (Active), assess-weakness (Active), resourceful (Passive)

- **`config/schemas/archetypes.schema.json`** — Extended with starting ability definitions
    - Added `startingAbilities` as required property in `archetypeDefinition`
    - Added `startingAbilities` property: array with minItems: 3, maxItems: 3
    - Added `abilityGrant` definition with 4 required fields: `abilityId`, `abilityName`, `abilityType`, `description`
    - `abilityId`: string with kebab-case pattern `^[a-z][a-z0-9-]*$`, minLength: 3, maxLength: 50
    - `abilityType`: enum constrained to `["Active", "Passive", "Stance"]`
    - All definitions use `additionalProperties: false`
    - Updated top-level description to include "starting abilities"

### Documentation

- **`docs/design/v0.17.x/v0.17.3-scope-breakdown.md`** — Checked off v0.17.3c unit test items
    - `[x] Warrior starts with Strike, Defensive Stance, Warrior's Vigor`
    - `[x] Mystic starts with Aether Dart, Focus Aether, Aetheric Attunement`
    - `[x] Abilities correctly registered to character`

- **`docs/design/v0.17.x/v0.17.x-overview.md`** — Checked off v0.17.3 deliverable
    - `[x] ArchetypeAbilityGrant value object`

---

## Design Decisions

### readonly record struct Pattern

`ArchetypeAbilityGrant` uses the `readonly record struct` pattern, matching `ArchetypeSpecialBonus` (v0.17.3b), `ArchetypeResourceBonuses` (v0.17.3b), `DerivedStats` (v0.17.2d), and `PointBuyCost` (v0.17.2c). This provides value equality semantics, immutability, and zero-allocation access for frequently-used ability lookups during character creation.

### AbilityId Normalization to Lowercase

The `Create()` factory method normalizes the `AbilityId` to lowercase via `ToLowerInvariant()`. This ensures consistent lookups against the Ability System (v0.15.x) regardless of casing in configuration files. The canonical format is kebab-case (e.g., "power-strike", "defensive-stance").

### Convenience Factory Methods (CreateActive, CreatePassive, CreateStance)

Three convenience factory methods are provided in addition to the general `Create()` method. This follows the pattern established by `ArchetypeSpecialBonus.CreateConsumableEffectiveness()` where common construction patterns get dedicated methods for improved readability and reduced parameter counts.

### TypeDisplay as Bracketed Uppercase Tags

The `TypeDisplay` property returns `[ACTIVE]`, `[PASSIVE]`, or `[STANCE]` matching the design specification's UI formatting convention. This format is used consistently in ability lists, character creation screens, and tooltip displays.

### Design Spec Ability Names vs. Scope Breakdown Names

The v0.17.3c design specification defines updated ability names (e.g., "Power Strike" instead of "Strike", "Iron Will" instead of "Warrior's Vigor") compared to the earlier scope breakdown document. The design specification was followed as the authoritative source since it is the more detailed and recent document. The scope breakdown checkboxes were checked off as-is per convention.

### JSON Schema Draft-07 Consistency

The schema extension uses Draft-07 with `definitions` (not `$defs`) matching the existing v0.17.3a/b schema and all other schemas in the codebase (`backgrounds.schema.json`, `lineages.schema.json`, `attributes.schema.json`).

### No isPassive Field in Configuration

The design specification's scope breakdown (v0.17.3-scope-breakdown.md) shows an `isPassive` field in the JSON configuration. However, the v0.17.3c design specification's schema section does not include `isPassive` as it is a computed property derived from `abilityType`. The `isPassive` field was omitted from the configuration to avoid data redundancy, following the principle that derived values should be computed rather than stored.

---

## Dependencies

### Prerequisites

| Type                  | Phase    | Usage                            |
| --------------------- | -------- | -------------------------------- |
| `Archetype`           | v0.17.3a | Archetype identification         |
| `ArchetypeDefinition` | v0.17.3a | Will compose with ability grants |

### Provides to Future Phases

| Type                    | Phase    | Usage                                |
| ----------------------- | -------- | ------------------------------------ |
| `AbilityType`           | v0.17.3e | Provider categorizes abilities       |
| `ArchetypeAbilityGrant` | v0.17.3e | Provider returns ability grants      |
| `ArchetypeAbilityGrant` | v0.17.3f | Application service grants abilities |
| `AbilityType`           | v0.15.x  | Integration with Ability System      |

---

## Logging Strategy

| Level       | When                                                                   |
|-------------|------------------------------------------------------------------------|
| Debug       | Grant creation entry with ability ID, name, type, and description      |
| Debug       | Validation passed confirmation with validated ability ID and type      |
| Information | Successful grant creation with all property values and computed flags  |

---

## Files Created

| Path | Description |
|------|-------------|
| `src/Core/RuneAndRust.Domain/Enums/AbilityType.cs` | AbilityType enum with 3 activation types |
| `src/Core/RuneAndRust.Domain/ValueObjects/ArchetypeAbilityGrant.cs` | Starting ability grant value object |
| `tests/RuneAndRust.Domain.UnitTests/Enums/AbilityTypeTests.cs` | AbilityType enum unit tests |
| `tests/RuneAndRust.Domain.UnitTests/ValueObjects/ArchetypeAbilityGrantTests.cs` | ArchetypeAbilityGrant unit tests |

## Files Modified

| Path | Description |
|------|-------------|
| `config/archetypes.json` | Added startingAbilities section to all 4 archetypes |
| `config/schemas/archetypes.schema.json` | Added abilityGrant definition and startingAbilities property |
| `config/glossary.json` | Added 2 glossary entries (ability-type, archetype-ability-grant) |
| `docs/design/v0.17.x/v0.17.3-scope-breakdown.md` | Checked off v0.17.3c deliverables |
| `docs/design/v0.17.x/v0.17.x-overview.md` | Updated v0.17.3 deliverable checkboxes |

---

## Notes

- Total unit tests for v0.17.3c: 27 tests (5 + 22)
- The design specification estimated ~8 tests; 27 were implemented for comprehensive coverage of all factory methods, validation paths, computed properties, convenience factories, type display, and formatting methods
- Only the Warrior archetype has a Stance starting ability (Defensive Stance); all other archetypes have 2 Active + 1 Passive
- The `isPassive` field from the scope breakdown's JSON example was intentionally omitted from the configuration schema — `IsPassive` is a computed property derived from `AbilityType` on the C# value object
- AbilityId uses kebab-case format (e.g., "power-strike") matching the design specification, not snake_case (e.g., "power_strike") which was used in the earlier scope breakdown document
- The design specification's ability names differ from the scope breakdown's legacy names (e.g., "Power Strike" vs. "Strike", "Iron Will" vs. "Warrior's Vigor"); the design specification was treated as authoritative
- Specialization mappings, provider service, and application service are deferred to v0.17.3d-f
