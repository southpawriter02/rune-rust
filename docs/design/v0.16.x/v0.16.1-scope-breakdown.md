## v0.16.1 - Weapon Proficiency System

**Focus:** Weapon proficiency levels, category definitions, archetype matrices, and acquisition methods

**Source Specification:** [weap-proficiencies.md](../../aethelgard/design/resources/items/weapons/weap-proficiencies.md)

### Overview

This version implements the weapon proficiency system that determines how effectively characters can use different weapon types. Using a weapon without proficiency imposes significant penalties, while advanced proficiency levels provide bonuses. Each archetype starts with different proficiencies, and characters can acquire new ones through training or experience.

---

### Deliverables Summary

| Category | Items | Estimated Tests |
|----------|-------|-----------------|
| Enums | 2 | 4 |
| Value Objects | 3 | 4 |
| Entities | 2 | 6 |
| Services | 2 | 6 |
| **Total** | **9** | **~20** |

---

### v0.16.1a - Proficiency Level Enum

#### WeaponProficiencyLevel Enum
```
WeaponProficiencyLevel
├── NonProficient (0) - Severe penalties
├── Proficient (1) - Normal function
├── Expert (2) - Bonuses, advanced techniques
├── Master (3) - Maximum bonuses, signature techniques
```

#### ProficiencyEffect Value Object
```
ProficiencyEffect
├── Level: WeaponProficiencyLevel
├── AttackModifier: int
├── DamageModifier: int
├── CanUseSpecialProperties: bool
├── UnlockedTechniques: List<string>
```

**Proficiency Effects:**
| Level | Attack | Damage | Special Props | Techniques |
|-------|--------|--------|---------------|------------|
| NonProficient | -3 | -2 | No | None |
| Proficient | 0 | 0 | Yes | Basic |
| Expert | +1 | 0 | Yes | Advanced |
| Master | +2 | +1 | Yes | Signature |

**Configuration (`proficiency-effects.json`):**
```json
{
  "proficiencyEffects": [
    {
      "level": "NonProficient",
      "attackModifier": -3,
      "damageModifier": -2,
      "canUseSpecialProperties": false,
      "unlockedTechniques": []
    },
    {
      "level": "Master",
      "attackModifier": 2,
      "damageModifier": 1,
      "canUseSpecialProperties": true,
      "unlockedTechniques": ["basic", "advanced", "signature"]
    }
  ]
}
```

**Unit Tests (~4):**
- [ ] NonProficient applies -3 attack, -2 damage
- [ ] Proficient has no penalties
- [ ] Expert grants +1 attack
- [ ] Master grants +2 attack, +1 damage

---

### v0.16.1b - Weapon Category System

#### WeaponCategory Enum
```
WeaponCategory
├── Axes - Hand axes, bearded axes, greataxes, throwing axes
├── Swords - Short swords, arming swords, sabers, greatswords, claymores
├── Hammers - Maces, war hammers, flails, mauls, morning stars
├── Daggers - Knives, stilettos, dirks, throwing knives
├── Polearms - Spears, javelins, halberds, pikes, atgeirs, glaives
├── Staves - Quarterstaffs, walking sticks, iron-shod staves
├── Bows - Shortbows, longbows, recurve bows, composite bows
├── Crossbows - Light crossbows, heavy crossbows, repeating crossbows
├── Shields - Bucklers, round shields, kite shields, tower shields
├── Firearms - Pistols, rifles, hand cannons
├── ArcaneImplements - Wands, orbs, foci, channeling implements
```

#### WeaponCategoryDefinition Value Object
```
WeaponCategoryDefinition
├── Category: WeaponCategory
├── DisplayName: string
├── Description: string
├── ExampleWeapons: List<string>
├── PrimaryAttribute: string (MIGHT, FINESSE, WILL, WITS)
├── RequiresSpecialTraining: bool
```

**Category to Attribute Mapping:**
| Category | Primary Attribute | Notes |
|----------|-------------------|-------|
| Axes | MIGHT | All variants |
| Swords | MIGHT/FINESSE | One-handed = FINESSE, Two-handed = MIGHT |
| Hammers | MIGHT | Includes flails |
| Daggers | FINESSE | All variants |
| Polearms | MIGHT/FINESSE | Spears = FINESSE, Heavy = MIGHT |
| Staves | WILL | Arcane focus |
| Bows | FINESSE | All variants |
| Crossbows | WITS | Mechanical operation |
| Shields | MIGHT | Defensive use |
| Firearms | WITS | Special training required |
| ArcaneImplements | WILL | Mystic only |

**Configuration (`weapon-categories.json`):**
```json
{
  "categories": [
    {
      "category": "Axes",
      "displayName": "Axes",
      "description": "Brutal chopping weapons favored by Warriors",
      "examples": ["Hand Axe", "Bearded Axe", "Greataxe", "Throwing Axe"],
      "primaryAttribute": "MIGHT",
      "requiresSpecialTraining": false
    },
    {
      "category": "Firearms",
      "displayName": "Firearms",
      "description": "Rare gunpowder weapons requiring specialized knowledge",
      "examples": ["Pistol", "Rifle", "Hand Cannon"],
      "primaryAttribute": "WITS",
      "requiresSpecialTraining": true
    }
  ]
}
```

**Unit Tests (~2):**
- [ ] All 11 categories defined
- [ ] Special training flag set for Firearms

---

### v0.16.1c - Archetype Proficiency Matrix

#### ArchetypeProficiencySet Entity
```
ArchetypeProficiencySet
├── Archetype: string (Warrior, Skirmisher, Mystic, Adept)
├── ProficientCategories: List<WeaponCategory>
├── NonProficientCategories: List<WeaponCategory>
├── Notes: string (special restrictions)
```

**Archetype Matrix:**
| Archetype | Proficient | Non-Proficient |
|-----------|------------|----------------|
| Warrior | All weapons, all armor, shields | None |
| Skirmisher | Daggers, one-handed swords, one-handed axes, bows, crossbows | Two-handed melee, shields, heavy armor |
| Mystic | Daggers, staves, arcane implements | All martial weapons, medium/heavy armor, shields |
| Adept | Daggers, staves, one-handed hammers, light crossbows | Most martial weapons, heavy armor |

#### IArchetypeProficiencyProvider Interface
```csharp
public interface IArchetypeProficiencyProvider
{
    /// <summary>
    /// Gets the proficiency set for an archetype.
    /// </summary>
    ArchetypeProficiencySet GetProficiencySet(string archetype);

    /// <summary>
    /// Checks if an archetype is proficient with a weapon category.
    /// </summary>
    bool IsProficient(string archetype, WeaponCategory category);

    /// <summary>
    /// Gets all proficient categories for an archetype.
    /// </summary>
    IReadOnlyList<WeaponCategory> GetProficientCategories(string archetype);
}
```

**Configuration (`archetype-proficiencies.json`):**
```json
{
  "archetypes": [
    {
      "archetype": "Warrior",
      "proficientCategories": ["Axes", "Swords", "Hammers", "Daggers", "Polearms", "Staves", "Bows", "Crossbows", "Shields"],
      "nonProficientCategories": [],
      "notes": "Full martial proficiency"
    },
    {
      "archetype": "Mystic",
      "proficientCategories": ["Daggers", "Staves", "ArcaneImplements"],
      "nonProficientCategories": ["Axes", "Swords", "Hammers", "Polearms", "Bows", "Crossbows", "Shields", "Firearms"],
      "notes": "Arcane focus; martial weapons interfere with Galdr channeling"
    }
  ]
}
```

**Unit Tests (~4):**
- [ ] Warrior proficient with all weapons
- [ ] Mystic only proficient with Daggers, Staves, ArcaneImplements
- [ ] Skirmisher non-proficient with two-handed melee
- [ ] Adept proficient with light crossbows

---

### v0.16.1d - Character Proficiency Tracking

#### CharacterProficiencies Entity
```
CharacterProficiencies
├── CharacterId: string
├── WeaponProficiencies: Dictionary<WeaponCategory, WeaponProficiencyLevel>
├── CombatExperience: Dictionary<WeaponCategory, int> (fights toward proficiency)
├── Methods:
│   ├── GetProficiencyLevel(category) → WeaponProficiencyLevel
│   ├── SetProficiencyLevel(category, level)
│   ├── AddCombatExperience(category) → bool (returns true if leveled up)
│   └── CanAdvance(category) → bool
```

#### ProficiencyProgress Value Object
```
ProficiencyProgress
├── Category: WeaponCategory
├── CurrentLevel: WeaponProficiencyLevel
├── CombatCount: int
├── RequiredCombats: int (10 for proficiency)
├── ProgressPercent: float
```

**Combat Experience Thresholds:**
| Current Level | Combats Required | Notes |
|---------------|------------------|-------|
| NonProficient → Proficient | 10 | Using weapon in combat |
| Proficient → Expert | 25 | Special training preferred |
| Expert → Master | 50 | Requires Master trainer |

**Unit Tests (~4):**
- [ ] New character has archetype proficiencies
- [ ] Combat experience increments correctly
- [ ] 10 combats grants proficiency
- [ ] Cannot advance beyond Master

---

### v0.16.1e - Proficiency Acquisition Service

#### IProficiencyAcquisitionService Interface
```csharp
public interface IProficiencyAcquisitionService
{
    /// <summary>
    /// Initializes proficiencies from archetype.
    /// </summary>
    CharacterProficiencies InitializeFromArchetype(string characterId, string archetype);

    /// <summary>
    /// Adds specialization proficiencies.
    /// </summary>
    void ApplySpecializationProficiencies(string characterId, string specialization);

    /// <summary>
    /// Records combat with weapon, potentially granting proficiency.
    /// </summary>
    ProficiencyGainResult RecordCombatExperience(string characterId, WeaponCategory category);

    /// <summary>
    /// Purchases proficiency with progression points.
    /// </summary>
    bool PurchaseProficiency(string characterId, WeaponCategory category, int ppCost);

    /// <summary>
    /// Trains with NPC for proficiency (cost + time).
    /// </summary>
    TrainingResult StartNpcTraining(string characterId, WeaponCategory category, string trainerId);
}
```

#### ProficiencyGainResult Value Object
```
ProficiencyGainResult
├── Success: bool
├── NewLevel: WeaponProficiencyLevel?
├── Message: string
├── CombatsRemaining: int?
```

#### TrainingResult Value Object
```
TrainingResult
├── Success: bool
├── Cost: int (Progression Stones)
├── Duration: TimeSpan
├── Category: WeaponCategory
├── TargetLevel: WeaponProficiencyLevel
```

**Acquisition Methods:**
| Method | PP Cost | PS Cost | Time | Level Gained |
|--------|---------|---------|------|--------------|
| Archetype | Free | — | Instant | Proficient |
| Specialization | Free | — | Instant | Proficient or Expert |
| NPC Training | — | 50-200 | 1-4 weeks | +1 level |
| Combat Experience | — | — | 10 fights | Proficient (from Non) |
| Progression Point | 2 PP | — | Instant | +1 level |

**Unit Tests (~4):**
- [ ] InitializeFromArchetype sets correct proficiencies
- [ ] 10 combats transitions to Proficient
- [ ] PP purchase grants proficiency
- [ ] Training calculates correct cost/time

---

### v0.16.1f - Combat Integration

#### IProficiencyCheckService Interface
```csharp
public interface IProficiencyCheckService
{
    /// <summary>
    /// Gets effective attack modifier for character with weapon.
    /// </summary>
    int GetAttackModifier(string characterId, WeaponDefinition weapon);

    /// <summary>
    /// Gets effective damage modifier for character with weapon.
    /// </summary>
    int GetDamageModifier(string characterId, WeaponDefinition weapon);

    /// <summary>
    /// Checks if character can use weapon's special properties.
    /// </summary>
    bool CanUseSpecialProperties(string characterId, WeaponDefinition weapon);

    /// <summary>
    /// Gets available techniques for character with weapon.
    /// </summary>
    IReadOnlyList<string> GetAvailableTechniques(string characterId, WeaponDefinition weapon);
}
```

**Combat Integration Points:**
```
On Attack Roll:
  1. Get weapon category from WeaponDefinition
  2. Get character's proficiency level for category
  3. Apply attack modifier from proficiency
  4. If NonProficient, disable special weapon properties

On Damage Roll:
  1. Get proficiency level
  2. Apply damage modifier (-2 for NonProficient, +1 for Master)
  3. Record combat experience with this weapon category
```

**Unit Tests (~2):**
- [ ] NonProficient attack has -3 modifier
- [ ] Combat experience recorded on attack

---

### Configuration Files

| File | Purpose |
|------|---------|
| `proficiency-effects.json` | Level bonuses/penalties |
| `weapon-categories.json` | Category definitions |
| `archetype-proficiencies.json` | Starting proficiency matrix |
| `proficiency-training.json` | NPC training costs/times |

---

### Dependencies

**Requires:**
- v0.16.0: Quality tier system (for weapon stats)
- Character/archetype system
- Combat resolution system

**Provides to:**
- v0.16.2: Armor proficiency (similar pattern)
- Combat system: Attack/damage modifiers
- Character progression: PP spending

---

### Acceptance Criteria

- [ ] WeaponProficiencyLevel enum has 4 values
- [ ] WeaponCategory enum has 11 categories
- [ ] NonProficient penalty is -3 attack, -2 damage
- [ ] Expert bonus is +1 attack
- [ ] Master bonus is +2 attack, +1 damage
- [ ] Archetype matrix correctly assigns starting proficiencies
- [ ] Warrior proficient with all weapons
- [ ] Mystic only proficient with Daggers, Staves, ArcaneImplements
- [ ] Combat experience tracks per category
- [ ] 10 combats grants proficiency from NonProficient
- [ ] PP spending works (2 PP per category)
- [ ] Special properties blocked for NonProficient
- [ ] ~20 unit tests pass
