# v0.9.2a Design Specification: Sound Effect Service

**Version:** 0.9.2a
**Parent:** v0.9.2 (Sound Effects)
**Prerequisites:** v0.9.1c Complete (Theme Transitions)
**Status:** Design Complete
**Estimated Unit Tests:** ~8

---

## 1. Overview

### Purpose

Implement the core sound effect service managing SFX playback across the application. Includes `ISoundEffectService` interface, `SoundEffectService` implementation, category-based organization (combat, ui, items, puzzle, movement, ability), randomized sound variations for natural feel, and configuration loading from `sound-effects.json`.

### Key Deliverables

| Category | Items |
|----------|-------|
| **Interfaces** | `ISoundEffectService`, `ISoundEffectConfig` |
| **Services** | `SoundEffectService`, `SoundEffectConfig` |
| **DTOs** | `SoundEffectDefinition`, `SoundEffectsJson` |
| **Configuration** | `sound-effects.json` |
| **Tests** | ~8 unit tests |

---

## 2. Feature Overview

```
v0.9.2a Features
├── ISoundEffectService Interface
│   ├── Play(effectId, volume)
│   ├── PlayRandom(category, volume)
│   ├── PlayAt(effectId, position, volume)
│   ├── StopAll()
│   ├── SetVolume(volume) / GetVolume()
│   ├── PreloadCategoryAsync(category)
│   ├── GetAvailableEffects()
│   └── GetCategories()
│
├── SoundEffectService Implementation
│   ├── Uses IAudioService (AudioChannel.Effects)
│   ├── Category-based organization
│   ├── Randomized file selection
│   ├── Max simultaneous sounds (8)
│   ├── Active playback tracking
│   └── Cleanup finished playbacks
│
├── Sound Categories
│   ├── combat: hits, misses, criticals, deaths
│   ├── ability: casts, heals, buffs
│   ├── ui: clicks, hovers, menus
│   ├── items: pickup, drop, equip, use
│   ├── puzzle: correct, incorrect, complete, hint
│   └── movement: footsteps, doors, chest
│
├── ISoundEffectConfig Interface
│   ├── GetEffect(effectId) → SoundEffectDefinition?
│   ├── GetEffectsInCategory(category) → list
│   ├── GetAllEffectIds() → list
│   └── GetAllCategories() → list
│
└── Configuration (sound-effects.json)
    ├── Categories with nested effects
    ├── Multiple files per effect
    ├── Volume per effect
    ├── Randomize flag
    └── Global settings
```

---

## 3. Architecture

```
┌─────────────────────────────────────────────────────────────────────────┐
│                       GAME SYSTEMS                                      │
├─────────────────────────────────────────────────────────────────────────┤
│  Combat, UI, Items, Puzzles, Movement                                  │
│                                                                         │
│                    Play("attack-hit")                                  │
│                    PlayRandom("combat")                                │
│                              │                                         │
└──────────────────────────────┼─────────────────────────────────────────┘
                               ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                       ISoundEffectService                               │
├─────────────────────────────────────────────────────────────────────────┤
│  Methods:                                                               │
│  ├── Play(effectId, volume)                                            │
│  ├── PlayRandom(category, volume)                                      │
│  ├── PlayAt(effectId, position, volume)                                │
│  ├── StopAll()                                                         │
│  ├── SetVolume(volume) / GetVolume()                                   │
│  ├── PreloadCategoryAsync(category)                                    │
│  ├── GetAvailableEffects()                                             │
│  └── GetCategories()                                                   │
└─────────────────────────────────────────────────────────────────────────┘
                               │
                               ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                       SoundEffectService                                │
├─────────────────────────────────────────────────────────────────────────┤
│  Dependencies:                                                          │
│  ├── IAudioService _audioService                                       │
│  ├── ISoundEffectConfig _config                                        │
│  └── ILogger<SoundEffectService> _logger                               │
│                                                                         │
│  State:                                                                 │
│  ├── List<Guid> _activePlaybacks                                       │
│  ├── Random _random                                                    │
│  └── MaxSimultaneousSounds = 8                                         │
└─────────────────────────────────────────────────────────────────────────┘
                               │
              ┌────────────────┴────────────────┐
              ▼                                 ▼
┌─────────────────────────────┐   ┌─────────────────────────────────────┐
│    IAudioService (v0.9.0a)  │   │     ISoundEffectConfig              │
│   AudioChannel.Effects      │   │     (loads sound-effects.json)      │
└─────────────────────────────┘   └─────────────────────────────────────┘
```

---

## 4. ISoundEffectService Interface

**File:** `src/Core/RuneAndRust.Application/Interfaces/ISoundEffectService.cs`

```csharp
namespace RuneAndRust.Application.Interfaces;

/// <summary>
/// Manages sound effect playback across the application.
/// </summary>
public interface ISoundEffectService
{
    /// <summary>Plays a sound effect by its ID.</summary>
    /// <param name="effectId">The effect ID (e.g., "attack-hit", "button-click").</param>
    /// <param name="volume">Optional volume multiplier (0.0-1.0).</param>
    void Play(string effectId, float volume = 1.0f);

    /// <summary>Plays a random sound from a category.</summary>
    /// <param name="category">The category (e.g., "combat", "ui").</param>
    /// <param name="volume">Optional volume multiplier.</param>
    void PlayRandom(string category, float volume = 1.0f);

    /// <summary>Plays a sound at a grid position (for spatial mixing).</summary>
    /// <param name="effectId">The effect ID.</param>
    /// <param name="position">Grid position for spatial calculation.</param>
    /// <param name="volume">Optional volume multiplier.</param>
    void PlayAt(string effectId, GridPosition position, float volume = 1.0f);

    /// <summary>Stops all currently playing effects.</summary>
    void StopAll();

    /// <summary>Sets the global effects volume.</summary>
    void SetVolume(float volume);

    /// <summary>Gets the global effects volume.</summary>
    float GetVolume();

    /// <summary>Preloads all effects in a category.</summary>
    Task PreloadCategoryAsync(string category, CancellationToken ct = default);

    /// <summary>Gets all available effect IDs.</summary>
    IReadOnlyList<string> GetAvailableEffects();

    /// <summary>Gets all categories.</summary>
    IReadOnlyList<string> GetCategories();
}
```

---

## 5. ISoundEffectConfig Interface

**File:** `src/Core/RuneAndRust.Application/Interfaces/ISoundEffectConfig.cs`

```csharp
namespace RuneAndRust.Application.Interfaces;

/// <summary>
/// Configuration for sound effect definitions.
/// </summary>
public interface ISoundEffectConfig
{
    /// <summary>Gets an effect definition by ID.</summary>
    SoundEffectDefinition? GetEffect(string effectId);

    /// <summary>Gets all effect IDs in a category.</summary>
    IReadOnlyList<string> GetEffectsInCategory(string category);

    /// <summary>Gets all effect IDs.</summary>
    IReadOnlyList<string> GetAllEffectIds();

    /// <summary>Gets all category names.</summary>
    IReadOnlyList<string> GetAllCategories();

    /// <summary>Gets global settings.</summary>
    SoundEffectSettings GetSettings();
}
```

---

## 6. DTOs

**File:** `src/Core/RuneAndRust.Application/DTOs/SoundEffectDefinitions.cs`

```csharp
namespace RuneAndRust.Application.DTOs;

/// <summary>Definition of a single sound effect.</summary>
public class SoundEffectDefinition
{
    public string EffectId { get; set; } = string.Empty;
    public string Category { get; set; } = string.Empty;
    public List<string> Files { get; set; } = new();
    public float Volume { get; set; } = 1.0f;
    public bool Randomize { get; set; } = false;
}

/// <summary>Global sound effect settings.</summary>
public class SoundEffectSettings
{
    public int MaxSimultaneous { get; set; } = 8;
    public float DefaultVolume { get; set; } = 0.8f;
}

/// <summary>Root configuration for sound-effects.json.</summary>
public class SoundEffectsJson
{
    public Dictionary<string, CategoryDefinition> Categories { get; set; } = new();
    public SoundEffectSettings Settings { get; set; } = new();
}

/// <summary>Category with its effects.</summary>
public class CategoryDefinition
{
    public Dictionary<string, EffectFileConfig> Effects { get; set; } = new();
}

/// <summary>Raw effect config from JSON.</summary>
public class EffectFileConfig
{
    public List<string> Files { get; set; } = new();
    public float Volume { get; set; } = 1.0f;
    public bool Randomize { get; set; } = false;
}
```

---

## 7. SoundEffectService Implementation

**File:** `src/Infrastructure/RuneAndRust.Infrastructure/Services/SoundEffectService.cs`

```csharp
namespace RuneAndRust.Infrastructure.Services;

public class SoundEffectService : ISoundEffectService
{
    private readonly IAudioService _audioService;
    private readonly ISoundEffectConfig _config;
    private readonly ILogger<SoundEffectService> _logger;
    private readonly Random _random = new();
    private readonly List<Guid> _activePlaybacks = new();
    private readonly int _maxSimultaneous;

    public SoundEffectService(IAudioService audioService, ISoundEffectConfig config,
        ILogger<SoundEffectService> logger)
    {
        _audioService = audioService;
        _config = config;
        _logger = logger;
        _maxSimultaneous = _config.GetSettings().MaxSimultaneous;
    }

    public void Play(string effectId, float volume = 1.0f)
    {
        var effect = _config.GetEffect(effectId);
        if (effect is null)
        {
            _logger.LogWarning("Sound effect not found: {EffectId}", effectId);
            return;
        }

        // Enforce max simultaneous sounds
        CleanupFinishedPlaybacks();
        if (_activePlaybacks.Count >= _maxSimultaneous)
        {
            _logger.LogDebug("Max simultaneous sounds ({Max}) reached, skipping: {EffectId}",
                _maxSimultaneous, effectId);
            return;
        }

        // Select file (random if multiple and randomize enabled)
        var file = effect.Files.Count > 1 && effect.Randomize
            ? effect.Files[_random.Next(effect.Files.Count)]
            : effect.Files[0];

        var effectiveVolume = effect.Volume * Math.Clamp(volume, 0f, 1f);
        var playbackId = _audioService.Play(file, AudioChannel.Effects, effectiveVolume, loop: false);

        if (playbackId != Guid.Empty)
        {
            _activePlaybacks.Add(playbackId);
            _logger.LogDebug("Playing SFX: {EffectId} → {File}", effectId, file);
        }
    }

    public void PlayRandom(string category, float volume = 1.0f)
    {
        var effects = _config.GetEffectsInCategory(category);
        if (effects.Count == 0)
        {
            _logger.LogWarning("No effects in category: {Category}", category);
            return;
        }

        var effectId = effects[_random.Next(effects.Count)];
        Play(effectId, volume);
    }

    public void PlayAt(string effectId, GridPosition position, float volume = 1.0f)
    {
        // Simple spatial: adjust volume based on distance from player
        // For now, just play normally (spatial is optional enhancement)
        Play(effectId, volume);
    }

    public void StopAll()
    {
        foreach (var id in _activePlaybacks)
        {
            _audioService.Stop(id);
        }
        _activePlaybacks.Clear();
        _logger.LogDebug("Stopped all sound effects");
    }

    public void SetVolume(float volume)
    {
        _audioService.SetChannelVolume(AudioChannel.Effects, Math.Clamp(volume, 0f, 1f));
    }

    public float GetVolume() => _audioService.GetChannelVolume(AudioChannel.Effects);

    public async Task PreloadCategoryAsync(string category, CancellationToken ct = default)
    {
        var effects = _config.GetEffectsInCategory(category);
        var allFiles = new List<string>();

        foreach (var effectId in effects)
        {
            var effect = _config.GetEffect(effectId);
            if (effect is not null)
                allFiles.AddRange(effect.Files);
        }

        await _audioService.PreloadAsync(allFiles, ct);
        _logger.LogDebug("Preloaded {Count} files for category: {Category}", allFiles.Count, category);
    }

    public IReadOnlyList<string> GetAvailableEffects() => _config.GetAllEffectIds();

    public IReadOnlyList<string> GetCategories() => _config.GetAllCategories();

    private void CleanupFinishedPlaybacks()
    {
        _activePlaybacks.RemoveAll(id => !_audioService.IsPlaying(id));
    }
}
```

---

## 8. SoundEffectConfig Implementation

**File:** `src/Infrastructure/RuneAndRust.Infrastructure/Services/SoundEffectConfig.cs`

```csharp
namespace RuneAndRust.Infrastructure.Services;

public class SoundEffectConfig : ISoundEffectConfig
{
    private readonly Dictionary<string, SoundEffectDefinition> _effects = new();
    private readonly Dictionary<string, List<string>> _categoryEffects = new();
    private readonly SoundEffectSettings _settings;
    private readonly ILogger<SoundEffectConfig> _logger;

    public SoundEffectConfig(IConfigurationProvider configProvider, ILogger<SoundEffectConfig> logger)
    {
        _logger = logger;
        var json = configProvider.LoadConfig<SoundEffectsJson>("sound-effects.json");
        _settings = json.Settings;

        foreach (var (categoryName, category) in json.Categories)
        {
            _categoryEffects[categoryName] = new List<string>();

            foreach (var (effectName, effectConfig) in category.Effects)
            {
                var effectId = effectName; // Already kebab-case in JSON
                var definition = new SoundEffectDefinition
                {
                    EffectId = effectId,
                    Category = categoryName,
                    Files = effectConfig.Files,
                    Volume = effectConfig.Volume,
                    Randomize = effectConfig.Randomize
                };

                _effects[effectId] = definition;
                _categoryEffects[categoryName].Add(effectId);
            }
        }

        _logger.LogInformation("Loaded {EffectCount} effects across {CategoryCount} categories",
            _effects.Count, _categoryEffects.Count);
    }

    public SoundEffectDefinition? GetEffect(string effectId)
    {
        return _effects.GetValueOrDefault(effectId.ToLowerInvariant());
    }

    public IReadOnlyList<string> GetEffectsInCategory(string category)
    {
        return _categoryEffects.GetValueOrDefault(category.ToLowerInvariant()) ?? Array.Empty<string>();
    }

    public IReadOnlyList<string> GetAllEffectIds() => _effects.Keys.ToList();

    public IReadOnlyList<string> GetAllCategories() => _categoryEffects.Keys.ToList();

    public SoundEffectSettings GetSettings() => _settings;
}
```

---

## 9. Configuration File

**File:** `config/sound-effects.json`

```json
{
  "$schema": "./schemas/sound-effects.schema.json",
  "categories": {
    "combat": {
      "effects": {
        "attack-hit": {
          "files": [
            "audio/sfx/combat/hit_01.ogg",
            "audio/sfx/combat/hit_02.ogg",
            "audio/sfx/combat/hit_03.ogg"
          ],
          "volume": 0.8,
          "randomize": true
        },
        "attack-miss": {
          "files": ["audio/sfx/combat/whoosh.ogg"],
          "volume": 0.6,
          "randomize": false
        },
        "attack-critical": {
          "files": ["audio/sfx/combat/critical_hit.ogg"],
          "volume": 1.0,
          "randomize": false
        },
        "attack-blocked": {
          "files": ["audio/sfx/combat/block_01.ogg", "audio/sfx/combat/block_02.ogg"],
          "volume": 0.7,
          "randomize": true
        },
        "death-monster": {
          "files": ["audio/sfx/combat/monster_death_01.ogg", "audio/sfx/combat/monster_death_02.ogg"],
          "volume": 0.9,
          "randomize": true
        },
        "death-player": {
          "files": ["audio/sfx/combat/player_death.ogg"],
          "volume": 1.0,
          "randomize": false
        }
      }
    },
    "ability": {
      "effects": {
        "ability-cast": {
          "files": ["audio/sfx/ability/cast_generic.ogg"],
          "volume": 0.7,
          "randomize": false
        },
        "ability-fire": {
          "files": ["audio/sfx/ability/fire_cast.ogg"],
          "volume": 0.8,
          "randomize": false
        },
        "ability-heal": {
          "files": ["audio/sfx/ability/heal_cast.ogg"],
          "volume": 0.7,
          "randomize": false
        }
      }
    },
    "ui": {
      "effects": {
        "button-click": {
          "files": ["audio/sfx/ui/click.ogg"],
          "volume": 0.5,
          "randomize": false
        },
        "button-hover": {
          "files": ["audio/sfx/ui/hover.ogg"],
          "volume": 0.3,
          "randomize": false
        },
        "menu-open": {
          "files": ["audio/sfx/ui/menu_open.ogg"],
          "volume": 0.4,
          "randomize": false
        },
        "menu-close": {
          "files": ["audio/sfx/ui/menu_close.ogg"],
          "volume": 0.4,
          "randomize": false
        }
      }
    },
    "items": {
      "effects": {
        "item-pickup": {
          "files": ["audio/sfx/items/pickup.ogg"],
          "volume": 0.7,
          "randomize": false
        },
        "item-equip": {
          "files": ["audio/sfx/items/equip.ogg"],
          "volume": 0.7,
          "randomize": false
        },
        "gold-coins": {
          "files": ["audio/sfx/items/coins.ogg"],
          "volume": 0.6,
          "randomize": false
        }
      }
    },
    "puzzle": {
      "effects": {
        "puzzle-correct": {
          "files": ["audio/sfx/puzzle/correct.ogg"],
          "volume": 0.8,
          "randomize": false
        },
        "puzzle-incorrect": {
          "files": ["audio/sfx/puzzle/incorrect.ogg"],
          "volume": 0.7,
          "randomize": false
        },
        "puzzle-complete": {
          "files": ["audio/sfx/puzzle/fanfare.ogg"],
          "volume": 1.0,
          "randomize": false
        }
      }
    },
    "movement": {
      "effects": {
        "footstep-stone": {
          "files": [
            "audio/sfx/movement/step_stone_01.ogg",
            "audio/sfx/movement/step_stone_02.ogg",
            "audio/sfx/movement/step_stone_03.ogg"
          ],
          "volume": 0.4,
          "randomize": true
        },
        "door-open": {
          "files": ["audio/sfx/movement/door_open.ogg"],
          "volume": 0.6,
          "randomize": false
        },
        "chest-open": {
          "files": ["audio/sfx/movement/chest_open.ogg"],
          "volume": 0.7,
          "randomize": false
        }
      }
    }
  },
  "settings": {
    "maxSimultaneous": 8,
    "defaultVolume": 0.8
  }
}
```

---

## 10. Sound Category Summary

| Category | Effects | Purpose |
|----------|---------|---------|
| **combat** | attack-hit, attack-miss, attack-critical, attack-blocked, death-monster, death-player | Combat feedback |
| **ability** | ability-cast, ability-fire, ability-heal | Spell effects |
| **ui** | button-click, button-hover, menu-open, menu-close | UI interaction |
| **items** | item-pickup, item-equip, gold-coins | Inventory |
| **puzzle** | puzzle-correct, puzzle-incorrect, puzzle-complete | Puzzle feedback |
| **movement** | footstep-stone, door-open, chest-open | Environment |

---

## 11. Unit Testing Requirements (~8 tests)

| Feature | Tests |
|---------|-------|
| Play by effect ID works | 1 |
| PlayRandom selects from category | 1 |
| Missing effect logs warning | 1 |
| Max simultaneous enforced | 1 |
| Randomize selects different files | 1 |
| StopAll clears playbacks | 1 |
| Volume control via channel | 1 |
| PreloadCategoryAsync caches files | 1 |

---

## 12. Acceptance Criteria

- [ ] SoundEffectService can play effects by ID
- [ ] PlayRandom selects from category
- [ ] Randomized files cycle through options
- [ ] Max simultaneous sounds (8) enforced
- [ ] Volume control works
- [ ] Categories are loaded from config
- [ ] Preload caches category files
- [ ] GetAvailableEffects lists all IDs
- [ ] GetCategories lists all categories
- [ ] Missing effects log warning
- [ ] StopAll stops all active effects
- [ ] Effect volume multiplier applied
- [ ] ~8 unit tests pass

---

## 13. Dependencies

| From | Required |
|------|----------|
| v0.9.0a | `IAudioService`, `AudioChannel.Effects` |
| Infrastructure | `IConfigurationProvider` |
| Domain | `GridPosition` (optional, for PlayAt) |

---

*Document Version: 1.0 | Last Updated: 2026-01-10*
