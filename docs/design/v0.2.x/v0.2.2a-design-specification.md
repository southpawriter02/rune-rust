# v0.2.2a Design Specification: Shop Foundation

## Overview

**Version:** 0.2.2a
**Status:** Planning
**Focus:** Establish the core merchant system with Merchant entity, buy/sell commands, and basic pricing
**Prerequisites:** v0.2.1d (Codex UI Enhancements), v0.2.0 (NPC System)
**Estimated Unit Tests:** ~30

---

## Table of Contents

1. [Executive Summary](#1-executive-summary)
2. [Feature Overview](#2-feature-overview)
3. [Architecture Diagrams](#3-architecture-diagrams)
4. [User Stories](#4-user-stories)
5. [Data Models](#5-data-models)
6. [Configuration Schemas](#6-configuration-schemas)
7. [Service Specifications](#7-service-specifications)
8. [Transaction Flow](#8-transaction-flow)
9. [User-Facing Changes](#9-user-facing-changes)
10. [Logging Requirements](#10-logging-requirements)
11. [Unit Test Specifications](#11-unit-test-specifications)
12. [Use Cases](#12-use-cases)
13. [Acceptance Criteria](#13-acceptance-criteria)
14. [Deliverable Checklist](#14-deliverable-checklist)
15. [Dependencies](#15-dependencies)
16. [Future Considerations](#16-future-considerations)

---

## 1. Executive Summary

This version introduces the foundational shop system, enabling players to buy and sell items with merchants using gold currency. The Merchant entity extends NPC with shop capabilities, managing inventory, pricing, and transactions. Players can purchase items from merchant stock and sell items from their inventory for gold.

### Key Deliverables

| Category | Items |
|----------|-------|
| **Entities** | Merchant (extends NPC) |
| **Value Objects** | ShopInventory, ShopItem, TransactionResult |
| **Enums** | TransactionType |
| **Commands** | `buy <item>`, `sell <item>` |
| **Services** | ShopService (IShopService) |
| **Configuration** | merchants.json, merchants.schema.json |
| **Entity Updates** | Item (BasePrice, SellMultiplier, CanBeSold, IsQuestItem), Player (Gold) |
| **Tests** | ~30 new unit tests |

### Architectural Significance

This version establishes the **economy and transaction pattern** that will be extended throughout future versions:
- Merchant entity as specialized NPC with commerce capabilities
- Value object-based inventory and transaction tracking
- Service layer for transaction processing and validation
- Foundation for dynamic pricing (v0.2.2b), haggling (v0.2.2b), and shop UI (v0.2.2c)

---

## 2. Feature Overview

```
v0.2.2a Features
├── Merchant Entity
│   ├── Extends NPC with shop capabilities
│   ├── ShopInventory for stock management
│   ├── Gold reserves for buying items
│   ├── Buy/Sell price multipliers
│   └── Transaction tracking
├── Shop Inventory System
│   ├── ShopInventory value object (collection management)
│   ├── ShopItem value object (priced entries)
│   ├── Quantity tracking
│   └── Unlimited stock support
├── Transaction Processing
│   ├── TransactionResult value object
│   ├── TransactionType enum (PlayerBuy, PlayerSell)
│   ├── Gold exchange handling
│   └── Inventory updates
├── Buy/Sell Commands
│   ├── buy <item> - Purchase from merchant
│   ├── sell <item> - Sell to merchant
│   └── Merchant inventory display in talk
├── Item Pricing
│   ├── BasePrice on Item entity
│   ├── SellMultiplier for sell pricing
│   ├── CanBeSold flag
│   └── IsQuestItem flag (prevents selling)
├── Player Economy
│   ├── Gold currency tracking
│   ├── SpendGold/AddGold methods
│   └── CanAfford validation
└── Service Layer
    ├── ShopService (transaction management)
    ├── IShopService interface
    └── Integration with NPC/Item services
```

---

## 3. Architecture Diagrams

### 3.1 Layer Diagram

```
┌─────────────────────────────────────────────────────────────────────────┐
│                         PRESENTATION LAYER                              │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  ┌─────────────────────┐  ┌─────────────────────┐  ┌────────────────┐  │
│  │    ShopHandler      │  │   InputHandler      │  │ IGameRenderer  │  │
│  │                     │  │   (updated)         │  │ (updated)      │  │
│  │ - HandleBuy()       │  │ - ParseBuyCmd()     │  │ - RenderShop() │  │
│  │ - HandleSell()      │  │ - ParseSellCmd()    │  │ - RenderTxn()  │  │
│  │ - HandleTalkShop()  │  │                     │  │                │  │
│  └─────────┬───────────┘  └─────────┬───────────┘  └───────┬────────┘  │
│            │                        │                      │           │
└────────────┼────────────────────────┼──────────────────────┼───────────┘
             │                        │                      │
             ▼                        ▼                      ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                         APPLICATION LAYER                               │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │                          ShopService                             │   │
│  ├─────────────────────────────────────────────────────────────────┤   │
│  │ + GetMerchantInventory(merchant) : IEnumerable<ShopItem>        │   │
│  │ + BuyItem(player, merchant, itemId) : TransactionResult         │   │
│  │ + SellItem(player, merchant, item) : TransactionResult          │   │
│  │ + GetBuyPrice(merchant, item) : int                             │   │
│  │ + GetSellPrice(merchant, item) : int                            │   │
│  │ + FindMerchant(room, name?) : Merchant?                         │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │                    GameSessionService (updated)                  │   │
│  ├─────────────────────────────────────────────────────────────────┤   │
│  │ + BuyFromMerchant(itemName) : TransactionResultDto              │   │
│  │ + SellToMerchant(itemName) : TransactionResultDto               │   │
│  │ + GetMerchantInRoom() : MerchantDto?                            │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │                    NPCService (updated)                          │   │
│  ├─────────────────────────────────────────────────────────────────┤   │
│  │ // Merchant extends NPC, loads from merchants.json              │   │
│  │ + GetMerchantByName(room, name) : Merchant?                     │   │
│  │ + GetMerchantsInRoom(room) : IEnumerable<Merchant>              │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                           DOMAIN LAYER                                  │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  ENTITIES                                                               │
│  ┌────────────────────────────────────────────────────────────────┐    │
│  │                        Merchant : NPC                           │    │
│  ├────────────────────────────────────────────────────────────────┤    │
│  │ + Inventory: ShopInventory                                      │    │
│  │ + Gold: int                                                     │    │
│  │ + BuyMultiplier: decimal                                        │    │
│  │ + SellMultiplier: decimal                                       │    │
│  │ + FactionId: string?                                            │    │
│  │ + IsOpen: bool                                                  │    │
│  │ + LastRefresh: DateTime?                                        │    │
│  │ + TransactionCount: int                                         │    │
│  │ + GetBuyPrice(item): int                                        │    │
│  │ + GetSellPrice(item): int                                       │    │
│  │ + SellToPlayer(shopItem, player): TransactionResult             │    │
│  │ + BuyFromPlayer(item, player): TransactionResult                │    │
│  └────────────────────────────────────────────────────────────────┘    │
│                                                                         │
│  ┌────────────────────────────────────────────────────────────────┐    │
│  │                     Player (updated)                            │    │
│  ├────────────────────────────────────────────────────────────────┤    │
│  │ + Gold: int                                                     │    │
│  │ + SpendGold(amount): bool                                       │    │
│  │ + AddGold(amount): void                                         │    │
│  │ + CanAfford(amount): bool                                       │    │
│  └────────────────────────────────────────────────────────────────┘    │
│                                                                         │
│  ┌────────────────────────────────────────────────────────────────┐    │
│  │                      Item (updated)                             │    │
│  ├────────────────────────────────────────────────────────────────┤    │
│  │ + BasePrice: int                                                │    │
│  │ + SellMultiplier: decimal                                       │    │
│  │ + CanBeSold: bool                                               │    │
│  │ + IsQuestItem: bool                                             │    │
│  └────────────────────────────────────────────────────────────────┘    │
│                                                                         │
│  VALUE OBJECTS                                                          │
│  ┌────────────────────────┐  ┌────────────────────────┐                │
│  │    ShopInventory       │  │      ShopItem          │                │
│  ├────────────────────────┤  ├────────────────────────┤                │
│  │ + Items: IReadOnlyList │  │ + ItemId: string       │                │
│  │ + Empty: ShopInventory │  │ + Item: Item           │                │
│  │ + Contains(id): bool   │  │ + Quantity: int        │                │
│  │ + GetItem(id): ShopItem│  │ + IsUnlimited: bool    │                │
│  │ + AddItem(item, qty)   │  └────────────────────────┘                │
│  │ + RemoveItem(id, qty)  │                                            │
│  │ + UniqueItemCount: int │                                            │
│  │ + TotalQuantity: int   │                                            │
│  └────────────────────────┘                                            │
│                                                                         │
│  ┌────────────────────────┐  ┌────────────────────────┐                │
│  │  TransactionResult     │  │   TransactionType      │                │
│  ├────────────────────────┤  ├────────────────────────┤                │
│  │ + IsSuccess: bool      │  │ PlayerBuy              │                │
│  │ + Type: TransactionType│  │ PlayerSell             │                │
│  │ + Item: Item?          │  └────────────────────────┘                │
│  │ + Price: int           │                                            │
│  │ + ErrorMessage: string?│                                            │
│  │ + Success(type, item,  │                                            │
│  │           price)       │                                            │
│  │ + Failure(message)     │                                            │
│  └────────────────────────┘                                            │
│                                                                         │
│  DEFINITIONS                                                            │
│  ┌────────────────────────────────────────────────────────────────┐    │
│  │                   MerchantDefinition                            │    │
│  ├────────────────────────────────────────────────────────────────┤    │
│  │ + Id: string                                                    │    │
│  │ + Name: string                                                  │    │
│  │ + Type: NPCType (Merchant)                                      │    │
│  │ + DefaultAttitude: NPCAttitude                                  │    │
│  │ + Greeting: string                                              │    │
│  │ + Description: string                                           │    │
│  │ + StartingGold: int                                             │    │
│  │ + BuyMultiplier: decimal                                        │    │
│  │ + SellMultiplier: decimal                                       │    │
│  │ + FactionId: string?                                            │    │
│  │ + InitialStock: IReadOnlyList<StockEntry>                       │    │
│  └────────────────────────────────────────────────────────────────┘    │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                        INFRASTRUCTURE LAYER                             │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │                IConfigurationProvider (updated)                  │   │
│  ├─────────────────────────────────────────────────────────────────┤   │
│  │ + LoadMerchantDefinitions() : IReadOnlyList<MerchantDefinition> │   │
│  │ + GetMerchantDefinition(string id) : MerchantDefinition?        │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
│  Configuration Files:                                                   │
│  ├── config/merchants.json                                             │
│  └── config/schemas/merchants.schema.json                              │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

### 3.2 Buy Transaction Flow

```
┌───────────────────┐
│   Player Input    │
│ "buy iron sword"  │
└─────────┬─────────┘
          │
          ▼
┌───────────────────┐
│   InputHandler    │
│  ParseBuyCommand  │
└─────────┬─────────┘
          │
          ▼
┌───────────────────┐
│ GameSessionService│
│ .BuyFromMerchant()│
└─────────┬─────────┘
          │
          ▼
┌───────────────────┐
│    ShopService    │
│ .FindMerchant()   │
└─────────┬─────────┘
          │
          ▼
┌───────────────────────────────────────────────────────────────┐
│                      MERCHANT FOUND?                          │
├───────────────────────────────────────────────────────────────┤
│                                                               │
│  NO                                                           │
│  ┌───────────────────┐                                        │
│  │ Return error:     │                                        │
│  │ "No merchant here"│                                        │
│  └───────────────────┘                                        │
│                                                               │
│  YES                                                          │
│            │                                                  │
│            ▼                                                  │
│  ┌───────────────────┐                                        │
│  │  Find item in     │                                        │
│  │  merchant stock   │                                        │
│  └─────────┬─────────┘                                        │
│            │                                                  │
│            ▼                                                  │
│  ┌───────────────────────────────────────────────────────┐   │
│  │                 ITEM IN STOCK?                         │   │
│  ├───────────────────────────────────────────────────────┤   │
│  │                                                        │   │
│  │  NO → Return: "Item not in stock"                      │   │
│  │                                                        │   │
│  │  YES                                                   │   │
│  │           │                                            │   │
│  │           ▼                                            │   │
│  │  ┌───────────────────┐                                 │   │
│  │  │ Calculate price   │                                 │   │
│  │  │ (base * buyMult)  │                                 │   │
│  │  └─────────┬─────────┘                                 │   │
│  │            │                                           │   │
│  │            ▼                                           │   │
│  │  ┌───────────────────────────────────────────────┐    │   │
│  │  │            PLAYER CAN AFFORD?                  │    │   │
│  │  ├───────────────────────────────────────────────┤    │   │
│  │  │                                                │    │   │
│  │  │  NO → Return: "Not enough gold"                │    │   │
│  │  │                                                │    │   │
│  │  │  YES                                           │    │   │
│  │  │          │                                     │    │   │
│  │  │          ▼                                     │    │   │
│  │  │  ┌───────────────────┐                         │    │   │
│  │  │  │ Execute Purchase: │                         │    │   │
│  │  │  │ - Player.SpendGold│                         │    │   │
│  │  │  │ - Merchant.AddGold│                         │    │   │
│  │  │  │ - Remove from inv │                         │    │   │
│  │  │  │ - Add to player   │                         │    │   │
│  │  │  │ - Increment txn   │                         │    │   │
│  │  │  └─────────┬─────────┘                         │    │   │
│  │  │            │                                   │    │   │
│  │  └────────────┼───────────────────────────────────┘    │   │
│  │               │                                        │   │
│  └───────────────┼────────────────────────────────────────┘   │
│                  │                                            │
└──────────────────┼────────────────────────────────────────────┘
                   │
                   ▼
┌───────────────────┐
│ Return            │
│ TransactionResult │
│ .Success(...)     │
└─────────┬─────────┘
          │
          ▼
┌───────────────────┐
│ Display purchase  │
│ confirmation to   │
│ player            │
└───────────────────┘
```

### 3.3 Sell Transaction Flow

```
┌───────────────────┐
│   Player Input    │
│ "sell rusty dag"  │
└─────────┬─────────┘
          │
          ▼
┌───────────────────┐
│   InputHandler    │
│  ParseSellCommand │
└─────────┬─────────┘
          │
          ▼
┌───────────────────┐
│ GameSessionService│
│ .SellToMerchant() │
└─────────┬─────────┘
          │
          ▼
┌───────────────────────────────────────────────────────────────┐
│                      VALIDATIONS                              │
├───────────────────────────────────────────────────────────────┤
│                                                               │
│  ┌───────────────────┐                                        │
│  │ Merchant in room? │──NO──▶ Return: "No merchant here"      │
│  └─────────┬─────────┘                                        │
│           YES                                                 │
│            │                                                  │
│            ▼                                                  │
│  ┌───────────────────┐                                        │
│  │ Item in player    │──NO──▶ Return: "You don't have that"   │
│  │ inventory?        │                                        │
│  └─────────┬─────────┘                                        │
│           YES                                                 │
│            │                                                  │
│            ▼                                                  │
│  ┌───────────────────┐                                        │
│  │ IsQuestItem?      │──YES─▶ Return: "Cannot sell quest item"│
│  └─────────┬─────────┘                                        │
│            NO                                                 │
│            │                                                  │
│            ▼                                                  │
│  ┌───────────────────┐                                        │
│  │ CanBeSold?        │──NO──▶ Return: "Cannot sell this item" │
│  └─────────┬─────────┘                                        │
│           YES                                                 │
│            │                                                  │
│            ▼                                                  │
│  ┌───────────────────┐                                        │
│  │ Calculate price   │                                        │
│  │ (base * sellMult) │                                        │
│  └─────────┬─────────┘                                        │
│            │                                                  │
│            ▼                                                  │
│  ┌───────────────────┐                                        │
│  │ Merchant has gold?│──NO──▶ Return: "Merchant can't afford" │
│  └─────────┬─────────┘                                        │
│           YES                                                 │
│            │                                                  │
│            ▼                                                  │
│  ┌───────────────────┐                                        │
│  │ Execute Sale:     │                                        │
│  │ - Remove from plyr│                                        │
│  │ - Player.AddGold  │                                        │
│  │ - Merchant loses  │                                        │
│  │ - Increment txn   │                                        │
│  └─────────┬─────────┘                                        │
│            │                                                  │
└────────────┼──────────────────────────────────────────────────┘
             │
             ▼
┌───────────────────┐
│ Return            │
│ TransactionResult │
│ .Success(...)     │
└─────────┬─────────┘
          │
          ▼
┌───────────────────┐
│ Display sale      │
│ confirmation to   │
│ player            │
└───────────────────┘
```

---

## 4. User Stories

### US-2.2a-1: View Merchant Inventory
**As a** player interacting with a merchant
**I want to** see what items are available for purchase
**So that** I know what I can buy

**Acceptance Criteria:**
- `talk <merchant>` shows available items with prices
- Each item shows name, price, and quantity in stock
- Unlimited stock items show "unlimited" or "∞"
- Player's current gold is displayed

### US-2.2a-2: Buy Item from Merchant
**As a** player with gold
**I want to** purchase items from a merchant
**So that** I can acquire equipment and supplies

**Acceptance Criteria:**
- `buy <item>` purchases item from merchant in room
- Gold is deducted from player
- Item is added to player inventory
- Merchant stock decreases (unless unlimited)
- Clear error message if insufficient gold

### US-2.2a-3: Sell Item to Merchant
**As a** player with items to sell
**I want to** sell items to a merchant
**So that** I can earn gold

**Acceptance Criteria:**
- `sell <item>` sells item to merchant in room
- Gold is added to player
- Item is removed from player inventory
- Clear feedback on sale price
- Quest items cannot be sold

### US-2.2a-4: Configure Merchants via JSON
**As a** game designer
**I want to** define merchants in configuration files
**So that** I can create shops without code changes

**Acceptance Criteria:**
- Merchants can be defined in merchants.json
- All merchant properties are configurable
- Initial stock is defined per merchant
- Schema validation catches errors

### US-2.2a-5: Item Pricing
**As a** player considering purchases
**I want to** understand item prices
**So that** I can make informed trading decisions

**Acceptance Criteria:**
- Buy price = BasePrice × merchant's BuyMultiplier
- Sell price = BasePrice × merchant's SellMultiplier
- Default sell price is 50% of base price
- Prices are always whole numbers (rounded)

### US-2.2a-6: Merchant Gold Reserves
**As a** player selling items
**I want to** know if the merchant can afford my items
**So that** I understand trading limitations

**Acceptance Criteria:**
- Merchants have limited gold reserves
- Cannot sell if merchant lacks gold
- Merchant gold increases when player buys
- Merchant gold decreases when player sells

---

## 5. Data Models

### 5.1 Merchant Entity

```csharp
namespace RuneAndRust.Domain.Entities;

/// <summary>
/// Represents a merchant NPC that buys and sells items.
/// </summary>
/// <remarks>
/// Merchants extend the base NPC with shop capabilities including
/// inventory management, pricing, and transaction processing.
/// </remarks>
public class Merchant : NPC
{
    /// <summary>
    /// Gets the merchant's inventory of items for sale.
    /// </summary>
    /// <remarks>
    /// Contains ShopItems with quantity tracking. Empty by default.
    /// </remarks>
    public ShopInventory Inventory { get; private set; } = ShopInventory.Empty;

    /// <summary>
    /// Gets the merchant's gold reserves for buying items from players.
    /// </summary>
    /// <remarks>
    /// Limits how much the merchant can pay for player items.
    /// Increases when players buy, decreases when players sell.
    /// </remarks>
    public int Gold { get; private set; }

    /// <summary>
    /// Gets the buy price multiplier (what player pays).
    /// </summary>
    /// <remarks>
    /// Applied to item's BasePrice. Default 1.0 = no markup.
    /// Values > 1.0 mean player pays more than base price.
    /// </remarks>
    public decimal BuyMultiplier { get; private set; } = 1.0m;

    /// <summary>
    /// Gets the sell price multiplier (what merchant pays player).
    /// </summary>
    /// <remarks>
    /// Applied to item's BasePrice. Default 0.5 = 50% of base.
    /// Lower values mean merchant pays less for items.
    /// </remarks>
    public decimal SellMultiplier { get; private set; } = 0.5m;

    /// <summary>
    /// Gets the faction this merchant belongs to for reputation pricing.
    /// </summary>
    /// <remarks>
    /// Used in v0.2.2b for reputation-based price modifiers.
    /// </remarks>
    public string? FactionId { get; private set; }

    /// <summary>
    /// Gets whether the merchant is currently open for business.
    /// </summary>
    /// <remarks>
    /// Closed merchants refuse all transactions.
    /// </remarks>
    public bool IsOpen { get; private set; } = true;

    /// <summary>
    /// Gets the last time inventory was refreshed.
    /// </summary>
    /// <remarks>
    /// Used in v0.2.2c for inventory refresh mechanics.
    /// </remarks>
    public DateTime? LastRefresh { get; private set; }

    /// <summary>
    /// Gets the number of successful transactions with this merchant.
    /// </summary>
    /// <remarks>
    /// Used for tracking and potential reputation effects.
    /// </remarks>
    public int TransactionCount { get; private set; }

    /// <summary>
    /// Private constructor for EF Core.
    /// </summary>
    private Merchant() : base() { }

    /// <summary>
    /// Creates a merchant from a definition.
    /// </summary>
    /// <param name="definition">The merchant definition from configuration.</param>
    /// <param name="roomId">Optional room placement.</param>
    /// <returns>A new Merchant instance.</returns>
    /// <exception cref="ArgumentNullException">Thrown if definition is null.</exception>
    public static Merchant CreateMerchant(
        MerchantDefinition definition,
        Guid? roomId = null)
    {
        ArgumentNullException.ThrowIfNull(definition);

        var merchant = new Merchant
        {
            Gold = definition.StartingGold,
            BuyMultiplier = definition.BuyMultiplier,
            SellMultiplier = definition.SellMultiplier,
            FactionId = definition.FactionId,
            Inventory = ShopInventory.Create(definition.InitialStock),
            IsOpen = true,
            LastRefresh = DateTime.UtcNow
        };

        // Initialize base NPC properties
        merchant.InitializeFromDefinition(definition, roomId);

        return merchant;
    }

    /// <summary>
    /// Calculates the buy price for an item (what player pays).
    /// </summary>
    /// <param name="item">The item to price.</param>
    /// <returns>The calculated buy price.</returns>
    /// <remarks>
    /// Formula: ceiling(BasePrice × BuyMultiplier)
    /// Returns 0 for items with no base price.
    /// </remarks>
    public int GetBuyPrice(Item item)
    {
        if (item.BasePrice <= 0) return 0;
        return (int)Math.Ceiling(item.BasePrice * BuyMultiplier);
    }

    /// <summary>
    /// Calculates the sell price for an item (what merchant pays player).
    /// </summary>
    /// <param name="item">The item to price.</param>
    /// <returns>The calculated sell price.</returns>
    /// <remarks>
    /// Formula: floor(BasePrice × SellMultiplier)
    /// Returns 0 for items with no base price.
    /// </remarks>
    public int GetSellPrice(Item item)
    {
        if (item.BasePrice <= 0) return 0;
        return (int)Math.Floor(item.BasePrice * SellMultiplier);
    }

    /// <summary>
    /// Attempts to sell an item to a player (player buying).
    /// </summary>
    /// <param name="shopItem">The shop item being purchased.</param>
    /// <param name="player">The buying player.</param>
    /// <returns>Result of the transaction attempt.</returns>
    /// <remarks>
    /// Validates shop is open, item in stock, and player can afford.
    /// On success: deducts player gold, adds merchant gold, removes from stock.
    /// </remarks>
    public TransactionResult SellToPlayer(ShopItem shopItem, Player player)
    {
        if (!IsOpen)
            return TransactionResult.Failure("The shop is closed.");

        if (!Inventory.Contains(shopItem.ItemId))
            return TransactionResult.Failure("Item not in stock.");

        var price = GetBuyPrice(shopItem.Item);

        if (player.Gold < price)
            return TransactionResult.Failure($"Not enough gold. You need {price} gold.");

        // Process transaction
        player.SpendGold(price);
        Gold += price;
        Inventory = Inventory.RemoveItem(shopItem.ItemId);
        TransactionCount++;

        return TransactionResult.Success(
            TransactionType.PlayerBuy,
            shopItem.Item,
            price);
    }

    /// <summary>
    /// Attempts to buy an item from a player (player selling).
    /// </summary>
    /// <param name="item">The item being sold.</param>
    /// <param name="player">The selling player.</param>
    /// <returns>Result of the transaction attempt.</returns>
    /// <remarks>
    /// Validates shop is open, item is sellable, and merchant has gold.
    /// On success: adds player gold, deducts merchant gold.
    /// </remarks>
    public TransactionResult BuyFromPlayer(Item item, Player player)
    {
        if (!IsOpen)
            return TransactionResult.Failure("The shop is closed.");

        var price = GetSellPrice(item);

        if (price <= 0)
            return TransactionResult.Failure("The merchant isn't interested in that item.");

        if (Gold < price)
            return TransactionResult.Failure("The merchant doesn't have enough gold.");

        // Process transaction
        player.AddGold(price);
        Gold -= price;
        TransactionCount++;

        return TransactionResult.Success(
            TransactionType.PlayerSell,
            item,
            price);
    }

    /// <summary>
    /// Adds an item to the merchant's inventory.
    /// </summary>
    /// <param name="item">The item to add.</param>
    /// <param name="quantity">Quantity to add.</param>
    public void AddToInventory(Item item, int quantity = 1)
    {
        Inventory = Inventory.AddItem(item, quantity);
    }

    /// <summary>
    /// Sets the shop's open/closed status.
    /// </summary>
    /// <param name="isOpen">True to open, false to close.</param>
    public void SetOpen(bool isOpen)
    {
        IsOpen = isOpen;
    }

    /// <summary>
    /// Adds gold to merchant's reserves.
    /// </summary>
    /// <param name="amount">Amount to add (must be positive).</param>
    public void AddGold(int amount)
    {
        if (amount > 0)
            Gold += amount;
    }
}
```

### 5.2 ShopInventory Value Object

```csharp
namespace RuneAndRust.Domain.ValueObjects;

/// <summary>
/// Represents a merchant's inventory of items for sale.
/// </summary>
/// <remarks>
/// Immutable value object that manages the collection of ShopItems.
/// All modification methods return new instances.
/// </remarks>
public class ShopInventory
{
    /// <summary>
    /// Gets the items available for purchase.
    /// </summary>
    public IReadOnlyList<ShopItem> Items { get; private set; } = Array.Empty<ShopItem>();

    /// <summary>
    /// Gets an empty inventory instance.
    /// </summary>
    public static ShopInventory Empty => new() { Items = Array.Empty<ShopItem>() };

    /// <summary>
    /// Private constructor for controlled instantiation.
    /// </summary>
    private ShopInventory() { }

    /// <summary>
    /// Creates an inventory from a list of shop items.
    /// </summary>
    /// <param name="items">The items to include.</param>
    /// <returns>A new ShopInventory instance.</returns>
    public static ShopInventory Create(IEnumerable<ShopItem> items)
    {
        return new ShopInventory
        {
            Items = items.ToList()
        };
    }

    /// <summary>
    /// Checks if the inventory contains an item with available quantity.
    /// </summary>
    /// <param name="itemId">The item identifier.</param>
    /// <returns>True if item exists and has quantity > 0.</returns>
    public bool Contains(string itemId)
    {
        return Items.Any(i => i.ItemId == itemId && (i.Quantity > 0 || i.IsUnlimited));
    }

    /// <summary>
    /// Gets an item by its identifier.
    /// </summary>
    /// <param name="itemId">The item identifier.</param>
    /// <returns>The ShopItem, or null if not found.</returns>
    public ShopItem? GetItem(string itemId)
    {
        return Items.FirstOrDefault(i => i.ItemId == itemId);
    }

    /// <summary>
    /// Creates a new inventory with an item added or quantity increased.
    /// </summary>
    /// <param name="item">The item to add.</param>
    /// <param name="quantity">Quantity to add.</param>
    /// <returns>A new ShopInventory with the item added.</returns>
    public ShopInventory AddItem(Item item, int quantity = 1)
    {
        var items = Items.ToList();
        var existing = items.FirstOrDefault(i => i.ItemId == item.Id.ToString());

        if (existing != null)
        {
            var index = items.IndexOf(existing);
            items[index] = existing with { Quantity = existing.Quantity + quantity };
        }
        else
        {
            items.Add(new ShopItem
            {
                ItemId = item.Id.ToString(),
                Item = item,
                Quantity = quantity
            });
        }

        return new ShopInventory { Items = items };
    }

    /// <summary>
    /// Creates a new inventory with an item removed or quantity decreased.
    /// </summary>
    /// <param name="itemId">The item identifier.</param>
    /// <param name="quantity">Quantity to remove.</param>
    /// <returns>A new ShopInventory with the item removed.</returns>
    /// <remarks>
    /// Unlimited items are not affected by removal.
    /// Items reduced to 0 quantity are removed from the list.
    /// </remarks>
    public ShopInventory RemoveItem(string itemId, int quantity = 1)
    {
        var items = Items.ToList();
        var existing = items.FirstOrDefault(i => i.ItemId == itemId);

        if (existing == null) return this;

        // Unlimited items don't decrease
        if (existing.IsUnlimited) return this;

        var newQuantity = existing.Quantity - quantity;
        if (newQuantity <= 0)
        {
            items.Remove(existing);
        }
        else
        {
            var index = items.IndexOf(existing);
            items[index] = existing with { Quantity = newQuantity };
        }

        return new ShopInventory { Items = items };
    }

    /// <summary>
    /// Gets the total number of unique items in stock.
    /// </summary>
    public int UniqueItemCount => Items.Count;

    /// <summary>
    /// Gets the total quantity of all items in stock.
    /// </summary>
    /// <remarks>
    /// Unlimited items count as their current quantity value.
    /// </remarks>
    public int TotalQuantity => Items.Sum(i => i.Quantity);
}
```

### 5.3 ShopItem Value Object

```csharp
namespace RuneAndRust.Domain.ValueObjects;

/// <summary>
/// Represents an item in a merchant's inventory with quantity tracking.
/// </summary>
/// <remarks>
/// Record struct for efficient value semantics. Tracks the item reference,
/// quantity in stock, and whether stock is unlimited.
/// </remarks>
public readonly record struct ShopItem
{
    /// <summary>
    /// Gets the item's unique identifier.
    /// </summary>
    /// <remarks>
    /// References the item definition ID for lookup.
    /// </remarks>
    public string ItemId { get; init; }

    /// <summary>
    /// Gets the item reference.
    /// </summary>
    /// <remarks>
    /// The actual Item entity with all properties.
    /// </remarks>
    public Item Item { get; init; }

    /// <summary>
    /// Gets the quantity in stock.
    /// </summary>
    /// <remarks>
    /// For limited stock items, decreases when purchased.
    /// For unlimited items, this value is informational only.
    /// </remarks>
    public int Quantity { get; init; }

    /// <summary>
    /// Gets whether this item has unlimited stock.
    /// </summary>
    /// <remarks>
    /// Unlimited items never run out regardless of purchases.
    /// Typically used for basic consumables like torches.
    /// </remarks>
    public bool IsUnlimited { get; init; }
}
```

### 5.4 TransactionResult Value Object

```csharp
namespace RuneAndRust.Domain.ValueObjects;

/// <summary>
/// Result of a buy/sell transaction attempt.
/// </summary>
/// <remarks>
/// Captures success/failure status, transaction details, and error messages.
/// Used for both player-buy and player-sell transactions.
/// </remarks>
public readonly record struct TransactionResult
{
    /// <summary>
    /// Gets whether the transaction succeeded.
    /// </summary>
    public bool IsSuccess { get; init; }

    /// <summary>
    /// Gets the type of transaction attempted.
    /// </summary>
    public TransactionType Type { get; init; }

    /// <summary>
    /// Gets the item involved in the transaction.
    /// </summary>
    /// <remarks>
    /// Null on failure. Contains the item bought/sold on success.
    /// </remarks>
    public Item? Item { get; init; }

    /// <summary>
    /// Gets the final transaction price.
    /// </summary>
    /// <remarks>
    /// The actual gold exchanged. Zero on failure.
    /// </remarks>
    public int Price { get; init; }

    /// <summary>
    /// Gets the error message if the transaction failed.
    /// </summary>
    /// <remarks>
    /// Human-readable error for display. Null on success.
    /// </remarks>
    public string? ErrorMessage { get; init; }

    /// <summary>
    /// Creates a successful transaction result.
    /// </summary>
    /// <param name="type">The transaction type.</param>
    /// <param name="item">The item transacted.</param>
    /// <param name="price">The price paid/received.</param>
    /// <returns>A successful TransactionResult.</returns>
    public static TransactionResult Success(TransactionType type, Item item, int price)
    {
        return new TransactionResult
        {
            IsSuccess = true,
            Type = type,
            Item = item,
            Price = price
        };
    }

    /// <summary>
    /// Creates a failed transaction result.
    /// </summary>
    /// <param name="message">The error message.</param>
    /// <returns>A failed TransactionResult.</returns>
    public static TransactionResult Failure(string message)
    {
        return new TransactionResult
        {
            IsSuccess = false,
            ErrorMessage = message
        };
    }
}
```

### 5.5 TransactionType Enum

```csharp
namespace RuneAndRust.Domain.Enums;

/// <summary>
/// Types of shop transactions.
/// </summary>
/// <remarks>
/// Distinguishes between player buying (gold flows to merchant)
/// and player selling (gold flows to player).
/// </remarks>
public enum TransactionType
{
    /// <summary>
    /// Player is buying from merchant.
    /// </summary>
    /// <remarks>
    /// Gold: Player → Merchant
    /// Item: Merchant → Player
    /// </remarks>
    PlayerBuy,

    /// <summary>
    /// Player is selling to merchant.
    /// </summary>
    /// <remarks>
    /// Gold: Merchant → Player
    /// Item: Player → Merchant
    /// </remarks>
    PlayerSell
}
```

### 5.6 MerchantDefinition

```csharp
namespace RuneAndRust.Domain.Definitions;

/// <summary>
/// Configuration template for merchants loaded from JSON.
/// </summary>
/// <remarks>
/// Extends NPCDefinition with shop-specific properties.
/// Used to create Merchant instances at runtime.
/// </remarks>
public class MerchantDefinition : NPCDefinition
{
    /// <summary>
    /// Gets the merchant's starting gold reserves.
    /// </summary>
    /// <remarks>
    /// Determines initial capacity for buying from players.
    /// </remarks>
    public int StartingGold { get; init; } = 500;

    /// <summary>
    /// Gets the buy price multiplier.
    /// </summary>
    /// <remarks>
    /// Applied to item BasePrice for player purchases.
    /// Default 1.0 = no markup from base price.
    /// </remarks>
    public decimal BuyMultiplier { get; init; } = 1.0m;

    /// <summary>
    /// Gets the sell price multiplier.
    /// </summary>
    /// <remarks>
    /// Applied to item BasePrice for player sales.
    /// Default 0.5 = merchant pays 50% of base price.
    /// </remarks>
    public decimal SellMultiplier { get; init; } = 0.5m;

    /// <summary>
    /// Gets the faction ID for reputation pricing.
    /// </summary>
    /// <remarks>
    /// Used in v0.2.2b for reputation-based modifiers.
    /// </remarks>
    public string? FactionId { get; init; }

    /// <summary>
    /// Gets the initial stock entries for this merchant.
    /// </summary>
    public IReadOnlyList<StockEntry> InitialStock { get; init; } = [];
}

/// <summary>
/// Represents a stock entry in merchant configuration.
/// </summary>
public readonly record struct StockEntry
{
    /// <summary>
    /// Gets the item definition ID.
    /// </summary>
    public string ItemId { get; init; }

    /// <summary>
    /// Gets the quantity in stock.
    /// </summary>
    /// <remarks>
    /// Use -1 or set Unlimited = true for unlimited stock.
    /// </remarks>
    public int Quantity { get; init; }

    /// <summary>
    /// Gets whether this item has unlimited stock.
    /// </summary>
    public bool Unlimited { get; init; }
}
```

### 5.7 Item Entity Updates

```csharp
// Add to existing Item entity

/// <summary>
/// Gets the base price of this item in gold.
/// </summary>
/// <remarks>
/// Used for buy/sell calculations. Zero means item has no trade value.
/// </remarks>
public int BasePrice { get; private set; } = 0;

/// <summary>
/// Gets the sell multiplier specific to this item type.
/// </summary>
/// <remarks>
/// Combined with merchant's SellMultiplier. Default 1.0 = no adjustment.
/// Rare items might have higher multipliers.
/// </remarks>
public decimal SellMultiplier { get; private set; } = 1.0m;

/// <summary>
/// Gets whether this item can be sold to merchants.
/// </summary>
/// <remarks>
/// False for items like quest items or soulbound equipment.
/// </remarks>
public bool CanBeSold { get; private set; } = true;

/// <summary>
/// Gets whether this item is a quest item.
/// </summary>
/// <remarks>
/// Quest items cannot be sold or dropped. Marked clearly in inventory.
/// </remarks>
public bool IsQuestItem { get; private set; } = false;
```

### 5.8 Player Entity Updates

```csharp
// Add to existing Player entity

/// <summary>
/// Gets the player's current gold amount.
/// </summary>
public int Gold { get; private set; } = 0;

/// <summary>
/// Attempts to spend gold.
/// </summary>
/// <param name="amount">Amount to spend.</param>
/// <returns>True if successful, false if insufficient gold.</returns>
public bool SpendGold(int amount)
{
    if (amount <= 0) return false;
    if (Gold < amount) return false;

    Gold -= amount;
    return true;
}

/// <summary>
/// Adds gold to the player.
/// </summary>
/// <param name="amount">Amount to add (must be positive).</param>
public void AddGold(int amount)
{
    if (amount > 0)
        Gold += amount;
}

/// <summary>
/// Checks if player can afford an amount.
/// </summary>
/// <param name="amount">Amount to check.</param>
/// <returns>True if player has sufficient gold.</returns>
public bool CanAfford(int amount)
{
    return Gold >= amount;
}
```

---

## 6. Configuration Schemas

### 6.1 merchants.json

```json
{
  "$schema": "../schemas/merchants.schema.json",
  "merchants": [
    {
      "id": "grimbold-trader",
      "name": "Grimbold the Trader",
      "type": "Merchant",
      "defaultAttitude": "Neutral",
      "greeting": "Welcome to my shop! See anything you like?",
      "description": "A stout dwarf with a braided beard sits behind a worn counter, eyeing you appraisingly.",
      "startingGold": 500,
      "buyMultiplier": 1.0,
      "sellMultiplier": 0.5,
      "factionId": "merchant-guild",
      "initialStock": [
        { "itemId": "iron-sword", "quantity": 3 },
        { "itemId": "leather-armor", "quantity": 2 },
        { "itemId": "health-potion", "quantity": 10 },
        { "itemId": "torch", "quantity": -1, "unlimited": true },
        { "itemId": "rope", "quantity": 5 }
      ]
    },
    {
      "id": "mira-alchemist",
      "name": "Mira the Alchemist",
      "type": "Merchant",
      "defaultAttitude": "Friendly",
      "greeting": "Ah, a customer! Looking for potions or perhaps some reagents?",
      "description": "A young woman in a stained apron stands amid bubbling flasks and strange smells.",
      "startingGold": 300,
      "buyMultiplier": 1.1,
      "sellMultiplier": 0.6,
      "factionId": null,
      "initialStock": [
        { "itemId": "health-potion", "quantity": 15 },
        { "itemId": "mana-potion", "quantity": 10 },
        { "itemId": "antidote", "quantity": 5 },
        { "itemId": "empty-vial", "quantity": -1, "unlimited": true }
      ]
    }
  ]
}
```

### 6.2 merchants.schema.json

```json
{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "title": "Merchants Configuration",
  "description": "Defines merchants and their initial inventories",
  "type": "object",
  "required": ["merchants"],
  "properties": {
    "merchants": {
      "type": "array",
      "description": "List of merchant definitions",
      "items": {
        "$ref": "#/definitions/merchantDefinition"
      }
    }
  },
  "definitions": {
    "merchantDefinition": {
      "type": "object",
      "required": ["id", "name", "type", "startingGold", "initialStock"],
      "properties": {
        "id": {
          "type": "string",
          "pattern": "^[a-z][a-z0-9-]*$",
          "description": "Unique identifier (lowercase, alphanumeric with hyphens)"
        },
        "name": {
          "type": "string",
          "minLength": 1,
          "maxLength": 100,
          "description": "Display name of the merchant"
        },
        "type": {
          "type": "string",
          "const": "Merchant",
          "description": "NPC type (must be Merchant)"
        },
        "defaultAttitude": {
          "type": "string",
          "enum": ["Friendly", "Neutral", "Wary", "Hostile"],
          "default": "Neutral",
          "description": "Initial attitude toward players"
        },
        "greeting": {
          "type": "string",
          "maxLength": 500,
          "description": "Greeting when player talks to merchant"
        },
        "description": {
          "type": "string",
          "maxLength": 1000,
          "description": "Physical description of the merchant"
        },
        "startingGold": {
          "type": "integer",
          "minimum": 0,
          "maximum": 100000,
          "description": "Initial gold reserves for buying from players"
        },
        "buyMultiplier": {
          "type": "number",
          "minimum": 0.1,
          "maximum": 10.0,
          "default": 1.0,
          "description": "Price multiplier for player purchases (1.0 = base price)"
        },
        "sellMultiplier": {
          "type": "number",
          "minimum": 0.1,
          "maximum": 1.0,
          "default": 0.5,
          "description": "Price multiplier for player sales (0.5 = 50% of base)"
        },
        "factionId": {
          "type": ["string", "null"],
          "pattern": "^[a-z][a-z0-9-]*$",
          "description": "Optional faction for reputation pricing"
        },
        "initialStock": {
          "type": "array",
          "items": {
            "$ref": "#/definitions/stockEntry"
          },
          "description": "Initial inventory items"
        }
      }
    },
    "stockEntry": {
      "type": "object",
      "required": ["itemId", "quantity"],
      "properties": {
        "itemId": {
          "type": "string",
          "pattern": "^[a-z][a-z0-9-]*$",
          "description": "Item definition ID"
        },
        "quantity": {
          "type": "integer",
          "minimum": -1,
          "description": "Quantity in stock (-1 for unlimited)"
        },
        "unlimited": {
          "type": "boolean",
          "default": false,
          "description": "Whether stock is unlimited"
        }
      }
    }
  }
}
```

---

## 7. Service Specifications

### 7.1 IShopService Interface

```csharp
namespace RuneAndRust.Application.Interfaces;

/// <summary>
/// Provides operations for shop transactions and merchant interactions.
/// </summary>
public interface IShopService
{
    /// <summary>
    /// Gets available items from a merchant's inventory.
    /// </summary>
    /// <param name="merchant">The merchant.</param>
    /// <returns>Enumerable of shop items in stock.</returns>
    IEnumerable<ShopItem> GetMerchantInventory(Merchant merchant);

    /// <summary>
    /// Attempts to buy an item from a merchant.
    /// </summary>
    /// <param name="player">The buying player.</param>
    /// <param name="merchant">The selling merchant.</param>
    /// <param name="itemId">The item to purchase.</param>
    /// <returns>Result of the transaction attempt.</returns>
    TransactionResult BuyItem(Player player, Merchant merchant, string itemId);

    /// <summary>
    /// Attempts to sell an item to a merchant.
    /// </summary>
    /// <param name="player">The selling player.</param>
    /// <param name="merchant">The buying merchant.</param>
    /// <param name="item">The item to sell.</param>
    /// <returns>Result of the transaction attempt.</returns>
    TransactionResult SellItem(Player player, Merchant merchant, Item item);

    /// <summary>
    /// Gets the buy price for an item from a specific merchant.
    /// </summary>
    /// <param name="merchant">The merchant.</param>
    /// <param name="item">The item to price.</param>
    /// <returns>The price in gold.</returns>
    int GetBuyPrice(Merchant merchant, Item item);

    /// <summary>
    /// Gets the sell price for an item from a specific merchant.
    /// </summary>
    /// <param name="merchant">The merchant.</param>
    /// <param name="item">The item to price.</param>
    /// <returns>The price in gold.</returns>
    int GetSellPrice(Merchant merchant, Item item);

    /// <summary>
    /// Finds a merchant in the specified room.
    /// </summary>
    /// <param name="room">The room to search.</param>
    /// <param name="merchantName">Optional merchant name filter.</param>
    /// <returns>The merchant, or null if not found.</returns>
    Merchant? FindMerchant(Room room, string? merchantName = null);
}
```

### 7.2 ShopService Implementation

```csharp
namespace RuneAndRust.Application.Services;

/// <summary>
/// Manages shop transactions and merchant interactions.
/// </summary>
public class ShopService : IShopService
{
    private readonly INPCService _npcService;
    private readonly IItemService _itemService;
    private readonly ILogger<ShopService> _logger;

    /// <summary>
    /// Initializes a new instance of ShopService.
    /// </summary>
    /// <param name="npcService">NPC service for merchant lookup.</param>
    /// <param name="itemService">Item service for item operations.</param>
    /// <param name="logger">Logger instance.</param>
    public ShopService(
        INPCService npcService,
        IItemService itemService,
        ILogger<ShopService> logger)
    {
        _npcService = npcService;
        _itemService = itemService;
        _logger = logger;
    }

    /// <inheritdoc />
    public IEnumerable<ShopItem> GetMerchantInventory(Merchant merchant)
    {
        _logger.LogDebug(
            "GetMerchantInventory called for merchant: {MerchantName}",
            merchant.Name);

        return merchant.Inventory.Items
            .Where(i => i.Quantity > 0 || i.IsUnlimited);
    }

    /// <inheritdoc />
    public TransactionResult BuyItem(Player player, Merchant merchant, string itemId)
    {
        _logger.LogInformation(
            "BuyItem: Player {PlayerId} attempting to buy {ItemId} from {MerchantName}",
            player.Id, itemId, merchant.Name);

        // Find item in merchant inventory
        var shopItem = merchant.Inventory.GetItem(itemId);
        if (shopItem == null)
        {
            _logger.LogDebug("Item {ItemId} not found in merchant inventory", itemId);
            return TransactionResult.Failure("That item is not available.");
        }

        // Validate stock
        if (!merchant.Inventory.Contains(itemId))
        {
            _logger.LogDebug("Item {ItemId} is out of stock", itemId);
            return TransactionResult.Failure("That item is out of stock.");
        }

        // Execute transaction through merchant
        var result = merchant.SellToPlayer(shopItem.Value, player);

        if (result.IsSuccess)
        {
            // Add item to player inventory
            _itemService.AddToInventory(player, result.Item!);

            _logger.LogInformation(
                "BuyItem SUCCESS: Player {PlayerId} bought {ItemName} for {Price} gold",
                player.Id, result.Item!.Name, result.Price);
        }
        else
        {
            _logger.LogDebug(
                "BuyItem FAILED: {ErrorMessage}",
                result.ErrorMessage);
        }

        return result;
    }

    /// <inheritdoc />
    public TransactionResult SellItem(Player player, Merchant merchant, Item item)
    {
        _logger.LogInformation(
            "SellItem: Player {PlayerId} attempting to sell {ItemName} to {MerchantName}",
            player.Id, item.Name, merchant.Name);

        // Validate item can be sold
        if (item.IsQuestItem)
        {
            _logger.LogDebug("Cannot sell quest item: {ItemName}", item.Name);
            return TransactionResult.Failure("You cannot sell quest items.");
        }

        if (!item.CanBeSold)
        {
            _logger.LogDebug("Item cannot be sold: {ItemName}", item.Name);
            return TransactionResult.Failure("This item cannot be sold.");
        }

        // Execute transaction through merchant
        var result = merchant.BuyFromPlayer(item, player);

        if (result.IsSuccess)
        {
            // Remove item from player inventory
            _itemService.RemoveFromInventory(player, item);

            _logger.LogInformation(
                "SellItem SUCCESS: Player {PlayerId} sold {ItemName} for {Price} gold",
                player.Id, item.Name, result.Price);
        }
        else
        {
            _logger.LogDebug(
                "SellItem FAILED: {ErrorMessage}",
                result.ErrorMessage);
        }

        return result;
    }

    /// <inheritdoc />
    public int GetBuyPrice(Merchant merchant, Item item)
    {
        return merchant.GetBuyPrice(item);
    }

    /// <inheritdoc />
    public int GetSellPrice(Merchant merchant, Item item)
    {
        return merchant.GetSellPrice(item);
    }

    /// <inheritdoc />
    public Merchant? FindMerchant(Room room, string? merchantName = null)
    {
        _logger.LogDebug(
            "FindMerchant: Looking in room {RoomId}, name filter: {Name}",
            room.Id, merchantName ?? "(any)");

        var merchants = _npcService.GetNPCsInRoom(room)
            .OfType<Merchant>()
            .Where(m => m.IsOpen);

        if (!string.IsNullOrWhiteSpace(merchantName))
        {
            return merchants.FirstOrDefault(m =>
                m.Name.Contains(merchantName, StringComparison.OrdinalIgnoreCase));
        }

        return merchants.FirstOrDefault();
    }
}
```

---

## 8. Transaction Flow

### 8.1 Buy Command Flow

```
Player Input: "buy iron sword"
        │
        ▼
┌───────────────────────────────────────────────────────┐
│ InputHandler.ParseCommand()                           │
│ - Identifies "buy" command                            │
│ - Extracts item name: "iron sword"                    │
└───────────────────────────────────────────────────────┘
        │
        ▼
┌───────────────────────────────────────────────────────┐
│ GameSessionService.BuyFromMerchant("iron sword")      │
│ - Gets current room                                   │
│ - Calls ShopService.FindMerchant(room)                │
└───────────────────────────────────────────────────────┘
        │
        ▼
┌───────────────────────────────────────────────────────┐
│ ShopService.BuyItem(player, merchant, "iron-sword")   │
│ - Finds item in merchant.Inventory                    │
│ - Validates item in stock                             │
│ - Calls merchant.SellToPlayer(shopItem, player)       │
└───────────────────────────────────────────────────────┘
        │
        ▼
┌───────────────────────────────────────────────────────┐
│ Merchant.SellToPlayer()                               │
│ - Validates shop is open                              │
│ - Validates item in stock                             │
│ - Calculates price: BasePrice × BuyMultiplier         │
│ - Validates player can afford                         │
│ - player.SpendGold(price)                             │
│ - merchant.Gold += price                              │
│ - inventory.RemoveItem(itemId)                        │
│ - TransactionCount++                                  │
│ - Returns TransactionResult.Success(...)              │
└───────────────────────────────────────────────────────┘
        │
        ▼
┌───────────────────────────────────────────────────────┐
│ ShopService (continued)                               │
│ - ItemService.AddToInventory(player, item)            │
│ - Returns TransactionResult to GameSessionService     │
└───────────────────────────────────────────────────────┘
        │
        ▼
┌───────────────────────────────────────────────────────┐
│ Renderer displays result:                             │
│ "You purchase the Iron Sword for 50 gold."            │
│ "Remaining gold: 77"                                  │
└───────────────────────────────────────────────────────┘
```

### 8.2 Sell Command Flow

```
Player Input: "sell rusty dagger"
        │
        ▼
┌───────────────────────────────────────────────────────┐
│ InputHandler.ParseCommand()                           │
│ - Identifies "sell" command                           │
│ - Extracts item name: "rusty dagger"                  │
└───────────────────────────────────────────────────────┘
        │
        ▼
┌───────────────────────────────────────────────────────┐
│ GameSessionService.SellToMerchant("rusty dagger")     │
│ - Gets current room                                   │
│ - Finds item in player inventory                      │
│ - Calls ShopService.FindMerchant(room)                │
└───────────────────────────────────────────────────────┘
        │
        ▼
┌───────────────────────────────────────────────────────┐
│ ShopService.SellItem(player, merchant, item)          │
│ - Validates item.IsQuestItem == false                 │
│ - Validates item.CanBeSold == true                    │
│ - Calls merchant.BuyFromPlayer(item, player)          │
└───────────────────────────────────────────────────────┘
        │
        ▼
┌───────────────────────────────────────────────────────┐
│ Merchant.BuyFromPlayer()                              │
│ - Validates shop is open                              │
│ - Calculates price: BasePrice × SellMultiplier        │
│ - Validates merchant has gold                         │
│ - player.AddGold(price)                               │
│ - merchant.Gold -= price                              │
│ - TransactionCount++                                  │
│ - Returns TransactionResult.Success(...)              │
└───────────────────────────────────────────────────────┘
        │
        ▼
┌───────────────────────────────────────────────────────┐
│ ShopService (continued)                               │
│ - ItemService.RemoveFromInventory(player, item)       │
│ - Returns TransactionResult to GameSessionService     │
└───────────────────────────────────────────────────────┘
        │
        ▼
┌───────────────────────────────────────────────────────┐
│ Renderer displays result:                             │
│ "Grimbold examines the Rusty Dagger."                 │
│ "You sell the Rusty Dagger for 3 gold."               │
│ "Your gold: 80"                                       │
└───────────────────────────────────────────────────────┘
```

---

## 9. User-Facing Changes

### 9.1 New Commands

| Command | Description | Example |
|---------|-------------|---------|
| `buy <item>` | Purchase item from merchant | `buy iron sword` |
| `buy "<item>"` | Purchase item with spaces | `buy "Health Potion"` |
| `sell <item>` | Sell item to merchant | `sell rusty dagger` |
| `sell "<item>"` | Sell item with spaces | `sell "Goblin Ear"` |

### 9.2 Talk Command Enhancement

The `talk` command with a merchant now displays shop information:

```
> talk grimbold
Grimbold looks up from his ledger. "Welcome to my shop! See anything
you like?"

FOR SALE:
  Iron Sword .......... 50 gold (3 in stock)
  Leather Armor ....... 35 gold (2 in stock)
  Health Potion ....... 15 gold (10 in stock)
  Torch ............... 5 gold (unlimited)
  Rope ................ 8 gold (5 in stock)

Your gold: 127

Type 'buy <item>' to purchase or 'sell <item>' to sell.
```

### 9.3 Transaction Output Examples

**Successful Purchase:**
```
> buy "Iron Sword"
You purchase the Iron Sword for 50 gold.
Remaining gold: 77
```

**Insufficient Gold:**
```
> buy "Plate Armor"
You don't have enough gold. The Plate Armor costs 250 gold.
You have: 77 gold
```

**Item Not In Stock:**
```
> buy "Steel Sword"
Grimbold doesn't have that item.
```

**Successful Sale:**
```
> sell "Rusty Dagger"
Grimbold examines the Rusty Dagger.
"I'll give you 3 gold for it."

You sell the Rusty Dagger for 3 gold.
Your gold: 80
```

**Cannot Sell Quest Item:**
```
> sell "Ancient Key"
You cannot sell the Ancient Key. It's a quest item.
```

**Merchant Can't Afford:**
```
> sell "Legendary Artifact"
Grimbold sighs. "That's worth more than I have. Come back when my
coffers are fuller."
```

---

## 10. Logging Requirements

### 10.1 Log Events

| Event | Level | Format |
|-------|-------|--------|
| Merchant loaded | Information | `Loaded merchant {MerchantId} with {ItemCount} items, {Gold} gold` |
| Buy attempt | Information | `BuyItem: Player {PlayerId} attempting to buy {ItemId} from {MerchantName}` |
| Buy success | Information | `BuyItem SUCCESS: Player {PlayerId} bought {ItemName} for {Price} gold` |
| Buy failure | Debug | `BuyItem FAILED: {ErrorMessage}` |
| Sell attempt | Information | `SellItem: Player {PlayerId} attempting to sell {ItemName} to {MerchantName}` |
| Sell success | Information | `SellItem SUCCESS: Player {PlayerId} sold {ItemName} for {Price} gold` |
| Sell failure | Debug | `SellItem FAILED: {ErrorMessage}` |
| Merchant not found | Debug | `FindMerchant: No merchant in room {RoomId}` |
| Shop closed | Debug | `Transaction refused: Shop {MerchantId} is closed` |

### 10.2 Structured Logging Fields

```csharp
// Buy transaction log
_logger.LogInformation(
    "BuyItem SUCCESS: Player {PlayerId} bought {ItemName} for {Price} gold from {MerchantName}",
    player.Id,      // Guid
    item.Name,      // string
    price,          // int
    merchant.Name   // string
);

// Sell transaction log
_logger.LogInformation(
    "SellItem SUCCESS: Player {PlayerId} sold {ItemName} for {Price} gold to {MerchantName}",
    player.Id,      // Guid
    item.Name,      // string
    price,          // int
    merchant.Name   // string
);
```

---

## 11. Unit Test Specifications

### 11.1 Merchant Entity Tests (~10 tests)

```csharp
namespace RuneAndRust.Tests.Domain.Entities;

[TestFixture]
public class MerchantTests
{
    [Test]
    public void CreateMerchant_WithValidDefinition_InitializesCorrectly()
    {
        // Arrange: Create MerchantDefinition
        // Act: Call Merchant.CreateMerchant()
        // Assert: Verify all properties set correctly
    }

    [Test]
    public void GetBuyPrice_WithValidItem_ReturnsMultipliedPrice()
    {
        // Arrange: Merchant with BuyMultiplier 1.2, Item with BasePrice 100
        // Act: Call GetBuyPrice()
        // Assert: Returns 120 (ceiling)
    }

    [Test]
    public void GetBuyPrice_WithZeroBasePrice_ReturnsZero()
    {
        // Arrange: Item with BasePrice 0
        // Act: Call GetBuyPrice()
        // Assert: Returns 0
    }

    [Test]
    public void GetSellPrice_WithValidItem_ReturnsMultipliedPrice()
    {
        // Arrange: Merchant with SellMultiplier 0.5, Item with BasePrice 100
        // Act: Call GetSellPrice()
        // Assert: Returns 50 (floor)
    }

    [Test]
    public void SellToPlayer_WhenShopClosed_ReturnsFailure()
    {
        // Arrange: Merchant with IsOpen = false
        // Act: Call SellToPlayer()
        // Assert: Returns failure with "shop is closed" message
    }

    [Test]
    public void SellToPlayer_WhenItemNotInStock_ReturnsFailure()
    {
        // Arrange: Merchant without requested item
        // Act: Call SellToPlayer()
        // Assert: Returns failure with "not in stock" message
    }

    [Test]
    public void SellToPlayer_WhenPlayerCantAfford_ReturnsFailure()
    {
        // Arrange: Player with 10 gold, item costs 50
        // Act: Call SellToPlayer()
        // Assert: Returns failure with gold requirement message
    }

    [Test]
    public void SellToPlayer_WhenValid_TransfersGoldAndItem()
    {
        // Arrange: Valid purchase scenario
        // Act: Call SellToPlayer()
        // Assert: Player gold decreased, merchant gold increased, stock decreased
    }

    [Test]
    public void BuyFromPlayer_WhenMerchantCantAfford_ReturnsFailure()
    {
        // Arrange: Merchant with 10 gold, item worth 50
        // Act: Call BuyFromPlayer()
        // Assert: Returns failure with "not enough gold" message
    }

    [Test]
    public void BuyFromPlayer_WhenValid_TransfersGold()
    {
        // Arrange: Valid sale scenario
        // Act: Call BuyFromPlayer()
        // Assert: Player gold increased, merchant gold decreased
    }
}
```

### 11.2 ShopInventory Tests (~8 tests)

```csharp
namespace RuneAndRust.Tests.Domain.ValueObjects;

[TestFixture]
public class ShopInventoryTests
{
    [Test]
    public void Empty_ReturnsEmptyInventory()
    {
        // Act: Access ShopInventory.Empty
        // Assert: Items is empty, UniqueItemCount is 0
    }

    [Test]
    public void Create_WithItems_ContainsAllItems()
    {
        // Arrange: List of ShopItems
        // Act: Call Create()
        // Assert: Items contains all provided items
    }

    [Test]
    public void Contains_WhenItemExists_ReturnsTrue()
    {
        // Arrange: Inventory with item
        // Act: Call Contains() with item ID
        // Assert: Returns true
    }

    [Test]
    public void Contains_WhenItemMissing_ReturnsFalse()
    {
        // Arrange: Empty inventory
        // Act: Call Contains() with any ID
        // Assert: Returns false
    }

    [Test]
    public void AddItem_NewItem_AddsToInventory()
    {
        // Arrange: Empty inventory, new item
        // Act: Call AddItem()
        // Assert: New inventory contains item with quantity 1
    }

    [Test]
    public void AddItem_ExistingItem_IncreasesQuantity()
    {
        // Arrange: Inventory with item quantity 3
        // Act: Call AddItem() with quantity 2
        // Assert: New inventory has quantity 5
    }

    [Test]
    public void RemoveItem_DecreasesQuantity()
    {
        // Arrange: Inventory with item quantity 5
        // Act: Call RemoveItem() with quantity 2
        // Assert: New inventory has quantity 3
    }

    [Test]
    public void RemoveItem_WhenUnlimited_DoesNotDecrease()
    {
        // Arrange: Inventory with unlimited item
        // Act: Call RemoveItem()
        // Assert: Quantity unchanged
    }
}
```

### 11.3 TransactionResult Tests (~4 tests)

```csharp
namespace RuneAndRust.Tests.Domain.ValueObjects;

[TestFixture]
public class TransactionResultTests
{
    [Test]
    public void Success_CreatesSuccessfulResult()
    {
        // Act: Call TransactionResult.Success()
        // Assert: IsSuccess true, Item set, Price set
    }

    [Test]
    public void Failure_CreatesFailedResult()
    {
        // Act: Call TransactionResult.Failure()
        // Assert: IsSuccess false, ErrorMessage set
    }

    [Test]
    public void Success_SetsCorrectTransactionType()
    {
        // Arrange: TransactionType.PlayerBuy
        // Act: Call Success()
        // Assert: Type is PlayerBuy
    }

    [Test]
    public void Failure_HasNullItem()
    {
        // Act: Call Failure()
        // Assert: Item is null
    }
}
```

### 11.4 ShopService Tests (~8 tests)

```csharp
namespace RuneAndRust.Tests.Application.Services;

[TestFixture]
public class ShopServiceTests
{
    [Test]
    public void GetMerchantInventory_ReturnsInStockItems()
    {
        // Arrange: Merchant with mixed inventory (some out of stock)
        // Act: Call GetMerchantInventory()
        // Assert: Only items with quantity > 0 or unlimited returned
    }

    [Test]
    public void BuyItem_WhenItemNotFound_ReturnsFailure()
    {
        // Arrange: Merchant without item
        // Act: Call BuyItem()
        // Assert: Returns failure, no gold transferred
    }

    [Test]
    public void BuyItem_WhenSuccessful_AddsToPlayerInventory()
    {
        // Arrange: Valid buy scenario with mock ItemService
        // Act: Call BuyItem()
        // Assert: ItemService.AddToInventory called
    }

    [Test]
    public void SellItem_WhenQuestItem_ReturnsFailure()
    {
        // Arrange: Item with IsQuestItem = true
        // Act: Call SellItem()
        // Assert: Returns failure with quest item message
    }

    [Test]
    public void SellItem_WhenCannotBeSold_ReturnsFailure()
    {
        // Arrange: Item with CanBeSold = false
        // Act: Call SellItem()
        // Assert: Returns failure
    }

    [Test]
    public void SellItem_WhenSuccessful_RemovesFromInventory()
    {
        // Arrange: Valid sell scenario with mock ItemService
        // Act: Call SellItem()
        // Assert: ItemService.RemoveFromInventory called
    }

    [Test]
    public void FindMerchant_WhenExists_ReturnsMerchant()
    {
        // Arrange: Room with merchant
        // Act: Call FindMerchant()
        // Assert: Returns merchant
    }

    [Test]
    public void FindMerchant_WhenClosed_ReturnsNull()
    {
        // Arrange: Room with closed merchant
        // Act: Call FindMerchant()
        // Assert: Returns null
    }
}
```

---

## 12. Use Cases

### UC-2.2a-1: Player Purchases Item

**Primary Actor:** Player
**Preconditions:** Player is in room with open merchant, player has sufficient gold
**Postconditions:** Item added to player inventory, gold transferred

**Main Flow:**
1. Player enters `buy <item>` command
2. System finds merchant in current room
3. System locates item in merchant inventory
4. System calculates price (BasePrice × BuyMultiplier)
5. System verifies player has sufficient gold
6. System deducts gold from player
7. System adds gold to merchant
8. System removes item from merchant inventory
9. System adds item to player inventory
10. System displays success message

**Alternative Flows:**
- 2a. No merchant in room → Display error
- 3a. Item not in inventory → Display error
- 5a. Insufficient gold → Display required amount

### UC-2.2a-2: Player Sells Item

**Primary Actor:** Player
**Preconditions:** Player is in room with open merchant, player has sellable item
**Postconditions:** Item removed from player, gold transferred

**Main Flow:**
1. Player enters `sell <item>` command
2. System finds merchant in current room
3. System locates item in player inventory
4. System verifies item is sellable (not quest item)
5. System calculates price (BasePrice × SellMultiplier)
6. System verifies merchant has sufficient gold
7. System removes item from player inventory
8. System adds gold to player
9. System deducts gold from merchant
10. System displays success message

**Alternative Flows:**
- 2a. No merchant in room → Display error
- 3a. Item not in inventory → Display error
- 4a. Quest item → Display cannot sell message
- 6a. Merchant insufficient gold → Display error

### UC-2.2a-3: Player Views Merchant Inventory

**Primary Actor:** Player
**Preconditions:** Player is in room with merchant
**Postconditions:** Inventory displayed

**Main Flow:**
1. Player enters `talk <merchant>` command
2. System finds merchant by name
3. System retrieves merchant inventory
4. System displays greeting and inventory list
5. System shows item names, prices, and quantities
6. System shows player's current gold

---

## 13. Acceptance Criteria

### AC-2.2a-1: Merchant Entity
- [ ] Merchant entity extends NPC with shop properties
- [ ] Merchant has Gold, BuyMultiplier, SellMultiplier properties
- [ ] Merchant has ShopInventory for stock tracking
- [ ] Merchant calculates buy/sell prices correctly
- [ ] Merchant processes transactions and updates state

### AC-2.2a-2: Shop Inventory
- [ ] ShopInventory tracks items with quantities
- [ ] ShopInventory supports unlimited stock items
- [ ] ShopInventory is immutable (returns new instances)
- [ ] Stock decreases when items purchased (except unlimited)

### AC-2.2a-3: Buy Command
- [ ] `buy <item>` purchases item from merchant in room
- [ ] Player gold decreases by buy price
- [ ] Merchant gold increases by buy price
- [ ] Item added to player inventory
- [ ] Clear error when insufficient gold
- [ ] Clear error when item not in stock

### AC-2.2a-4: Sell Command
- [ ] `sell <item>` sells item to merchant in room
- [ ] Player gold increases by sell price
- [ ] Merchant gold decreases by sell price
- [ ] Item removed from player inventory
- [ ] Quest items cannot be sold
- [ ] Clear error when merchant lacks gold

### AC-2.2a-5: Item Pricing
- [ ] Items have BasePrice property
- [ ] Buy price = BasePrice × BuyMultiplier (rounded up)
- [ ] Sell price = BasePrice × SellMultiplier (rounded down)
- [ ] Items can be marked as non-sellable
- [ ] Quest items are automatically non-sellable

### AC-2.2a-6: Configuration
- [ ] Merchants defined in merchants.json
- [ ] Schema validation for merchant configuration
- [ ] Initial stock configurable per merchant
- [ ] Buy/Sell multipliers configurable per merchant

### AC-2.2a-7: Tests
- [ ] ~30 unit tests implemented and passing
- [ ] Merchant entity tests cover all methods
- [ ] ShopInventory tests cover add/remove operations
- [ ] ShopService tests cover transaction flows

---

## 14. Deliverable Checklist

### Domain Layer
- [ ] `Merchant.cs` - Merchant entity extending NPC
- [ ] `ShopInventory.cs` - Shop inventory value object
- [ ] `ShopItem.cs` - Shop item value object
- [ ] `TransactionResult.cs` - Transaction result value object
- [ ] `TransactionType.cs` - Transaction type enum
- [ ] `MerchantDefinition.cs` - Merchant definition class
- [ ] `StockEntry.cs` - Stock entry struct
- [ ] Update `Item.cs` - Add BasePrice, SellMultiplier, CanBeSold, IsQuestItem
- [ ] Update `Player.cs` - Add Gold, SpendGold, AddGold, CanAfford

### Application Layer
- [ ] `IShopService.cs` - Shop service interface
- [ ] `ShopService.cs` - Shop service implementation
- [ ] Update `GameSessionService.cs` - Add shop methods

### Infrastructure Layer
- [ ] Update `IConfigurationProvider.cs` - Add merchant loading
- [ ] Update `ConfigurationProvider.cs` - Implement merchant loading

### Presentation Layer
- [ ] `ShopHandler.cs` - Command handler for buy/sell
- [ ] Update `InputHandler.cs` - Parse buy/sell commands
- [ ] Update renderer for shop display

### Configuration
- [ ] `config/merchants.json` - Merchant definitions
- [ ] `config/schemas/merchants.schema.json` - JSON schema

### Tests
- [ ] `MerchantTests.cs` - Merchant entity tests (~10)
- [ ] `ShopInventoryTests.cs` - Inventory tests (~8)
- [ ] `TransactionResultTests.cs` - Result tests (~4)
- [ ] `ShopServiceTests.cs` - Service tests (~8)

---

## 15. Dependencies

### Internal Dependencies (from v0.2.0 and v0.2.1)

| Dependency | Location | Usage |
|------------|----------|-------|
| NPC entity | `Domain/Entities/NPC.cs` | Base class for Merchant |
| NPCType enum | `Domain/Enums/NPCType.cs` | Includes Merchant type |
| NPCAttitude enum | `Domain/Enums/NPCAttitude.cs` | Merchant attitude |
| Item entity | `Domain/Entities/Item.cs` | Trade goods |
| Player entity | `Domain/Entities/Player.cs` | Gold transactions |
| Inventory entity | `Domain/Entities/Inventory.cs` | Player items |
| Room entity | `Domain/Entities/Room.cs` | Merchant location |
| INPCService | `Application/Interfaces/INPCService.cs` | NPC lookup |
| IItemService | `Application/Interfaces/IItemService.cs` | Item management |
| FactionDefinition | `Domain/Definitions/FactionDefinition.cs` | Future pricing |

### External Dependencies

| Package | Version | Purpose |
|---------|---------|---------|
| Microsoft.Extensions.Logging | 8.0.0+ | Logging |
| System.Text.Json | 8.0.0+ | Configuration loading |

---

## 16. Future Considerations

### v0.2.2b: Dynamic Pricing & Haggling
- PriceModifier value object for price adjustments
- Charisma stat affecting prices
- Reputation-based price modifiers
- `haggle` command for negotiation
- Price discounts from successful haggling

### v0.2.2c: Shop UI & Specialty Merchants
- MerchantType enum for specializations
- TUI shop interface with navigation
- Item comparison display
- `appraise` command for value breakdown
- Inventory refresh mechanics

### v0.3.0: Quest System Integration
- Quest rewards include gold
- Merchants as quest givers
- Quest-related inventory items

### v0.11.0: Crafting Integration
- Merchants sell crafting materials
- Players sell crafted items
- Specialty crafting merchants

---

*This design specification provides the complete foundation for the Shop Foundation phase (v0.2.2a). It establishes the merchant entity, transaction system, and buy/sell commands that will be extended with dynamic pricing, haggling, and the shop UI in subsequent phases.*
