# v0.15.3i Design Specification: Specialization Integration

**Version:** 0.15.3i
**Theme:** Specialization Integration for Rhetoric
**Author:** Claude
**Created:** 2026-01-17
**Status:** Draft
**Parent:** v0.15.3 (Rhetoric Skill Expansion)
**Prerequisites:** v0.15.3h Complete (Extended Influence), v0.15.1c Complete (Master Abilities)

---

## Table of Contents

1. [Executive Summary](#1-executive-summary)
2. [Feature Overview](#2-feature-overview)
3. [Architecture Diagrams](#3-architecture-diagrams)
4. [Thul Abilities](#4-thul-abilities)
5. [Skald Abilities](#5-skald-abilities)
6. [Kupmaðr Abilities](#6-kupmaðr-abilities)
7. [Myrk-gengr Abilities](#7-myrk-gengr-abilities)
8. [Data Model Changes](#8-data-model-changes)
9. [Services](#9-services)
10. [Configuration](#10-configuration)
11. [Logging Specifications](#11-logging-specifications)
12. [Unit Testing Requirements](#12-unit-testing-requirements)
13. [Use Cases](#13-use-cases)
14. [Deliverable Checklist](#14-deliverable-checklist)
15. [Acceptance Criteria](#15-acceptance-criteria)
16. [Dependencies](#16-dependencies)
17. [Future Considerations](#17-future-considerations)
18. [Document Metadata](#18-document-metadata)

---

## 1. Executive Summary

### 1.1 Purpose

This document provides a comprehensive design specification for v0.15.3i, the Specialization Integration for Rhetoric. This version connects archetype-specific abilities to the Rhetoric skill system, enabling Thul, Skald, Kupmaðr, and Myrk-gengr specializations to modify social interaction mechanics in unique ways.

Each archetype represents a distinct approach to social encounters:
- **Thul** (Scholar): Reasoned discourse and academic authority
- **Skald** (Bard): Inspiring oratory and stress relief through storytelling
- **Kupmaðr** (Merchant): Negotiation mastery and deception detection
- **Myrk-gengr** (Infiltrator): Cover maintenance and document forgery

### 1.2 Key Deliverables

| Category | Items | Details |
|----------|-------|---------|
| **Ability Definitions** | 8 | 2 per archetype specialization |
| **Enums** | 1 | `RhetoricSpecializationAbility` |
| **Value Objects** | 1 | `SpecializationAbilityEffect` |
| **Services** | 1 | `RhetoricSpecializationService` |
| **Interfaces** | 1 | `IRhetoricSpecializationService` |
| **Configuration** | 1 | `rhetoric-specialization-abilities.json` |
| **Unit Tests** | ~2-3 | Per scope breakdown specification |

### 1.3 Architectural Significance

This version establishes the **Specialization Bonus Hook Pattern** for Rhetoric skills, providing:

1. **Conditional Ability Activation** - Abilities trigger based on check type, context, and outcome
2. **Outcome Modification** - Some abilities modify results (prevent option locking, auto-succeed)
3. **Dice Pool Augmentation** - Some abilities add bonus dice under specific conditions
4. **Party-Wide Effects** - Skald abilities affect multiple party members

This pattern parallels the archetype bonus systems in:
- Combat specializations (v0.11.x)
- System Bypass specializations (v0.15.4i planned)
- Wasteland Survival specializations (v0.15.5i planned)

---

## 2. Feature Overview

### 2.1 ASCII Feature Tree

```
v0.15.3i Features
├── Thul Abilities (Scholar)
│   ├── [Voice of Reason] - Failed persuasion doesn't lock options
│   └── [Scholarly Authority] - +2d10 when discussing lore/history
├── Skald Abilities (Bard)
│   ├── [Inspiring Words] - Grant allies bonus dice through oratory
│   └── [Saga of Heroes] - Reduce party Stress through storytelling
├── Kupmaðr Abilities (Merchant)
│   ├── [Silver Tongue] - Auto-succeed negotiation DC ≤ 12
│   └── [Sniff Out Lies] - Bonus dice to detect NPC deception
├── Myrk-gengr Abilities (Infiltrator)
│   ├── [Maintain Cover] - Stay in character under pressure
│   └── [Forge Documents] - Create convincing proof
└── Integration Points
    ├── Persuasion outcome modification
    ├── Negotiation auto-success
    ├── Deception detection bonus
    └── Party stress management
```

### 2.2 Scope Verification

**From v0.15.3-scope-breakdown.md (v0.15.3i section):**

| Specified Feature | Included | Section |
|-------------------|----------|---------|
| Thul: `[Voice of Reason]` | ✓ | 4.1 |
| Thul: `[Scholarly Authority]` | ✓ | 4.2 |
| Skald: `[Inspiring Words]` | ✓ | 5.1 |
| Skald: `[Saga of Heroes]` | ✓ | 5.2 |
| Kupmaðr: `[Silver Tongue]` | ✓ | 6.1 |
| Kupmaðr: `[Sniff Out Lies]` | ✓ | 6.2 |
| Myrk-gengr: `[Maintain Cover]` | ✓ | 7.1 |
| Myrk-gengr: `[Forge Documents]` | ✓ | 7.2 |
| Unit Tests (~2) | ✓ | 12 |

---

## 3. Architecture Diagrams

### 3.1 Specialization Ability Integration Flow

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                 SPECIALIZATION ABILITY INTEGRATION FLOW                      │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  Social Check Initiated                                                      │
│           │                                                                  │
│           ▼                                                                  │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │              GET PLAYER SPECIALIZATION                              │    │
│  │                                                                      │    │
│  │  Player.ArchetypeId → SpecializationLookup                          │    │
│  │                                                                      │    │
│  │  Thul      → [Voice of Reason], [Scholarly Authority]              │    │
│  │  Skald     → [Inspiring Words], [Saga of Heroes]                   │    │
│  │  Kupmaðr   → [Silver Tongue], [Sniff Out Lies]                     │    │
│  │  Myrk-gengr → [Maintain Cover], [Forge Documents]                  │    │
│  │                                                                      │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
│           │                                                                  │
│           ▼                                                                  │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │              CHECK ABILITY ACTIVATION CONDITIONS                    │    │
│  │                                                                      │    │
│  │  For each ability in specialization:                                │    │
│  │    - Does interaction type match?                                   │    │
│  │    - Does context match (topic, situation)?                         │    │
│  │    - Is ability on cooldown?                                        │    │
│  │    - Are prerequisites met?                                         │    │
│  │                                                                      │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
│           │                                                                  │
│           ├─── PRE-CHECK ───┬─── POST-CHECK ───┐                            │
│           │                 │                   │                            │
│           ▼                 ▼                   ▼                            │
│  ┌────────────────┐  ┌────────────────┐  ┌────────────────┐                 │
│  │  AUTO-SUCCEED  │  │  DICE BONUS    │  │ OUTCOME MODIFY │                 │
│  │                │  │                │  │                │                 │
│  │ [Silver Tongue]│  │ [Scholarly     │  │ [Voice of      │                 │
│  │ DC ≤ 12 nego   │  │  Authority]    │  │  Reason]       │                 │
│  │                │  │ +2d10 lore     │  │ No option lock │                 │
│  │                │  │                │  │                │                 │
│  │ [Maintain      │  │ [Sniff Out     │  │                │                 │
│  │  Cover]        │  │  Lies]         │  │                │                 │
│  │ resist pressure│  │ detect lies    │  │                │                 │
│  │                │  │                │  │                │                 │
│  └────────────────┘  └────────────────┘  └────────────────┘                 │
│           │                 │                   │                            │
│           └─────────────────┴───────────────────┘                            │
│                             │                                                │
│                             ▼                                                │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │                     APPLY ABILITY EFFECTS                           │    │
│  │                                                                      │    │
│  │  SpecializationAbilityEffect returned with:                         │    │
│  │  - DiceBonus: int (added to pool)                                   │    │
│  │  - AutoSuccess: bool (bypass check)                                 │    │
│  │  - PreventOptionLock: bool (on failure)                             │    │
│  │  - BonusApplied: string (ability name for logging)                  │    │
│  │                                                                      │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 3.2 Archetype Ability Matrix

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                      RHETORIC SPECIALIZATION ABILITIES                       │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  ARCHETYPE      ABILITY                  TYPE           TRIGGER             │
│  ─────────────────────────────────────────────────────────────────────────  │
│                                                                              │
│  Thul           [Voice of Reason]        Outcome Mod    Persuasion Failure  │
│  (Scholar)      [Scholarly Authority]    Dice Bonus     Lore/History topic  │
│                                                                              │
│  ─────────────────────────────────────────────────────────────────────────  │
│                                                                              │
│  Skald          [Inspiring Words]        Party Dice     Before ally check   │
│  (Bard)         [Saga of Heroes]         Stress Relief  Rest/downtime       │
│                                                                              │
│  ─────────────────────────────────────────────────────────────────────────  │
│                                                                              │
│  Kupmaðr        [Silver Tongue]          Auto-Success   Negotiation DC ≤ 12 │
│  (Merchant)     [Sniff Out Lies]         Dice Bonus     Detect deception    │
│                                                                              │
│  ─────────────────────────────────────────────────────────────────────────  │
│                                                                              │
│  Myrk-gengr     [Maintain Cover]         Dice Bonus     Resisting exposure  │
│  (Infiltrator)  [Forge Documents]        Special Action Create false proof  │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 3.3 Layer Architecture

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           LAYER ARCHITECTURE                                 │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │                      DOMAIN LAYER                                    │    │
│  ├─────────────────────────────────────────────────────────────────────┤    │
│  │                                                                      │    │
│  │  Enums/                                                              │    │
│  │  └── RhetoricSpecializationAbility.cs    ←── NEW                    │    │
│  │                                                                      │    │
│  │  ValueObjects/                                                       │    │
│  │  └── SpecializationAbilityEffect.cs      ←── NEW                    │    │
│  │                                                                      │    │
│  │  Interfaces/                                                         │    │
│  │  └── IRhetoricSpecializationService.cs   ←── NEW                    │    │
│  │                                                                      │    │
│  │  Existing References:                                                │    │
│  │  ├── Player.cs (ArchetypeId property)                               │    │
│  │  ├── ArchetypeDefinition.cs                                         │    │
│  │  └── SocialInteractionType.cs (from v0.15.3a)                       │    │
│  │                                                                      │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
│                                  │                                           │
│                                  │ implements                                │
│                                  ▼                                           │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │                    APPLICATION LAYER                                 │    │
│  ├─────────────────────────────────────────────────────────────────────┤    │
│  │                                                                      │    │
│  │  Services/                                                           │    │
│  │  └── RhetoricSpecializationService.cs    ←── NEW                    │    │
│  │                                                                      │    │
│  │  Dependencies:                                                       │    │
│  │  ├── IClassService (for archetype lookup)                           │    │
│  │  ├── ISkillCheckService (from v0.15.0c)                             │    │
│  │  ├── ITraumaService (for stress relief)                             │    │
│  │  └── ILogger<RhetoricSpecializationService>                         │    │
│  │                                                                      │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
│                                  │                                           │
│                                  ▼                                           │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │                  CONFIGURATION LAYER                                 │    │
│  ├─────────────────────────────────────────────────────────────────────┤    │
│  │                                                                      │    │
│  │  config/                                                             │    │
│  │  └── rhetoric-specialization-abilities.json  ←── NEW                │    │
│  │                                                                      │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 3.4 Service Interaction Diagram

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                      SERVICE INTERACTION DIAGRAM                             │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│           ┌───────────────────────────────────────┐                         │
│           │       Social Check Handler            │                         │
│           │   (Persuasion, Negotiation, etc.)     │                         │
│           └───────────────────┬───────────────────┘                         │
│                               │                                              │
│                               ▼                                              │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │               IRhetoricSpecializationService                         │    │
│  ├─────────────────────────────────────────────────────────────────────┤    │
│  │                                                                      │    │
│  │  + GetPreCheckBonus(playerId, interactionType, context)             │    │
│  │  + ApplyPostCheckModification(playerId, result, context)            │    │
│  │  + CanAutoSucceed(playerId, interactionType, dc)                    │    │
│  │  + ApplyInspiration(skaldId, targetIds)                             │    │
│  │  + PerformStorytelling(skaldId, partyIds)                           │    │
│  │  + CreateForgedDocument(forgerId, documentType)                     │    │
│  │                                                                      │    │
│  └──────────┬───────────────────────────────────────┬──────────────────┘    │
│             │                                       │                        │
│             ▼                                       ▼                        │
│  ┌──────────────────────────────┐    ┌──────────────────────────────────┐   │
│  │       IClassService          │    │      ITraumaService              │   │
│  ├──────────────────────────────┤    ├──────────────────────────────────┤   │
│  │                              │    │                                  │   │
│  │  GetPlayerArchetype()        │    │  ReduceStress(characterId, amt) │   │
│  │  GetArchetypeAbilities()     │    │  GetCurrentStress()             │   │
│  │                              │    │                                  │   │
│  └──────────────────────────────┘    └──────────────────────────────────┘   │
│             │                                                                │
│             ▼                                                                │
│  ┌──────────────────────────────────────────────────────────────────────┐   │
│  │                  Configuration Service                                │   │
│  ├──────────────────────────────────────────────────────────────────────┤   │
│  │                                                                       │   │
│  │  rhetoric-specialization-abilities.json                               │   │
│  │  ├── ability definitions                                              │   │
│  │  ├── activation conditions                                            │   │
│  │  └── effect parameters                                                │   │
│  │                                                                       │   │
│  └──────────────────────────────────────────────────────────────────────┘   │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 4. Thul Abilities

### 4.1 [Voice of Reason]

**Description:** Failed persuasion doesn't lock options

**Purpose:** The Thul's measured, logical approach to discourse means that even when they fail to convince someone, they don't alienate them. Where other characters might push too hard and permanently close dialogue options, the Thul's respectful reasoning leaves the door open for future attempts.

**Mechanic:**

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                      [VOICE OF REASON] MECHANIC                              │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  NORMAL PERSUASION FAILURE:                                                 │
│  ──────────────────────────────────────────────────────────────────────────  │
│  Player fails persuasion check                                              │
│       ↓                                                                     │
│  Dialogue option [locked] - "You've already asked about this."              │
│       ↓                                                                     │
│  Cannot attempt same persuasion again                                       │
│                                                                              │
│  ──────────────────────────────────────────────────────────────────────────  │
│                                                                              │
│  THUL WITH [VOICE OF REASON]:                                               │
│  ──────────────────────────────────────────────────────────────────────────  │
│  Thul fails persuasion check                                                │
│       ↓                                                                     │
│  Dialogue option remains [available]                                        │
│       ↓                                                                     │
│  NPC: "I don't agree, but I respect your reasoning. Perhaps later."         │
│       ↓                                                                     │
│  Can attempt same persuasion again (next conversation)                      │
│                                                                              │
│  ──────────────────────────────────────────────────────────────────────────  │
│                                                                              │
│  LIMITATIONS:                                                               │
│  • Does NOT prevent fumble consequences (Trust Shattered still locks)       │
│  • Only applies to Persuasion, not Deception or Intimidation                │
│  • Requires waiting for next conversation (not immediate retry)             │
│  • Does NOT prevent disposition loss from failure                           │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

**Activation Conditions:**
- Player archetype is Thul
- Social interaction type is Persuasion
- Check result is Failure (not Fumble)

**Effect:**
```csharp
SpecializationAbilityEffect.Create(
    ability: RhetoricSpecializationAbility.VoiceOfReason,
    preventOptionLock: true,
    description: "Your reasoned approach leaves the conversation open for future attempts."
)
```

### 4.2 [Scholarly Authority]

**Description:** +2d10 when discussing lore/history

**Purpose:** When the topic of conversation involves academic knowledge, historical events, ancient lore, or scholarly matters, the Thul's reputation and expertise grants them significant social leverage.

**Mechanic:**

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                    [SCHOLARLY AUTHORITY] MECHANIC                            │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  TRIGGER CONDITIONS:                                                        │
│  ──────────────────────────────────────────────────────────────────────────  │
│  Topic involves:                                                            │
│  • Historical events ("The Fall of the Old Kingdom")                        │
│  • Ancient lore ("The Rune-Singers of Mímir")                               │
│  • Academic knowledge ("The principles of æthercraft")                      │
│  • Written records ("As documented in the Archives")                        │
│  • Cultural traditions ("According to Dvergr custom")                       │
│                                                                              │
│  ──────────────────────────────────────────────────────────────────────────  │
│                                                                              │
│  EFFECT APPLICATION:                                                        │
│  ──────────────────────────────────────────────────────────────────────────  │
│                                                                              │
│  Base Dice Pool: WILL + Rhetoric (e.g., 4 + 3 = 7d10)                       │
│                        ↓                                                    │
│  [Scholarly Authority] triggered by lore topic                              │
│                        ↓                                                    │
│  Modified Pool: 7d10 + 2d10 = 9d10                                          │
│                                                                              │
│  ──────────────────────────────────────────────────────────────────────────  │
│                                                                              │
│  EXAMPLE INTERACTIONS:                                                      │
│  • Persuading archivist to grant access: +2d10                              │
│  • Convincing elder about historical precedent: +2d10                       │
│  • Negotiating with historian faction: +2d10                                │
│  • Intimidating with knowledge of ancient curses: +2d10                     │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

**Activation Conditions:**
- Player archetype is Thul
- Conversation topic is tagged as Lore, History, Academic, or Scholarly
- Any social interaction type (Persuasion, Deception, Intimidation, etc.)

**Effect:**
```csharp
SpecializationAbilityEffect.Create(
    ability: RhetoricSpecializationAbility.ScholarlyAuthority,
    diceBonus: 2,
    description: "Your scholarly expertise lends weight to your words."
)
```

---

## 5. Skald Abilities

### 5.1 [Inspiring Words]

**Description:** Grant allies bonus dice through oratory

**Purpose:** The Skald can inspire their companions before a critical social encounter, giving them the confidence and presence to perform better in the upcoming interaction.

**Mechanic:**

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                      [INSPIRING WORDS] MECHANIC                              │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  ACTION TIMING: Before ally's social check (preparation phase)              │
│                                                                              │
│  ──────────────────────────────────────────────────────────────────────────  │
│                                                                              │
│  SKALD DECLARES INSPIRATION:                                                │
│  "Remember who you are! The blood of heroes flows in your veins!"           │
│                                                                              │
│       ↓                                                                     │
│                                                                              │
│  SKALD MAKES RHETORIC CHECK:                                                │
│  DC 12 (base inspiration difficulty)                                        │
│                                                                              │
│       ↓                                                                     │
│                                                                              │
│  ON SUCCESS:                                                                │
│  ┌─────────────────────────────────────────────────────────────────┐        │
│  │  Target ally gains +1d10 on their next social check            │        │
│  │  Duration: One check (within next 10 minutes)                  │        │
│  │  Stacks: No (cannot stack multiple inspirations)               │        │
│  └─────────────────────────────────────────────────────────────────┘        │
│                                                                              │
│  ON EXCEPTIONAL SUCCESS (Net ≥ 3):                                          │
│  ┌─────────────────────────────────────────────────────────────────┐        │
│  │  All party members within earshot gain +1d10                   │        │
│  │  Duration: One check each (within next 10 minutes)             │        │
│  └─────────────────────────────────────────────────────────────────┘        │
│                                                                              │
│  ──────────────────────────────────────────────────────────────────────────  │
│                                                                              │
│  COOLDOWN: Once per scene (cannot spam inspiration)                         │
│                                                                              │
│  COST: None (represents Skald's innate oratory gift)                        │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

**Activation Conditions:**
- Player archetype is Skald
- Player declares intention to inspire before ally's check
- Skald succeeds DC 12 Rhetoric check
- Ability not on cooldown (once per scene)

**Effect:**
```csharp
SpecializationAbilityEffect.Create(
    ability: RhetoricSpecializationAbility.InspiringWords,
    diceBonus: 1,
    isPartyWide: isExceptionalSuccess,
    duration: TimeSpan.FromMinutes(10),
    description: "Your rousing words fill your allies with confidence."
)
```

### 5.2 [Saga of Heroes]

**Description:** Reduce party Stress through storytelling

**Purpose:** During downtime or rest, the Skald can tell tales of heroic deeds, legendary figures, and inspiring triumphs. This storytelling helps the party process their experiences and reduces accumulated psychic stress.

**Mechanic:**

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                       [SAGA OF HEROES] MECHANIC                              │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  TIMING: During rest or downtime (not in combat/social encounter)           │
│                                                                              │
│  ──────────────────────────────────────────────────────────────────────────  │
│                                                                              │
│  SKALD PERFORMS STORYTELLING:                                               │
│  "Gather close, companions. Let me tell you of Hrothgar the Brave,          │
│   who faced the Wyrm of the Broken Spire..."                                │
│                                                                              │
│       ↓                                                                     │
│                                                                              │
│  SKALD MAKES RHETORIC CHECK:                                                │
│  DC 10 (base storytelling difficulty)                                       │
│                                                                              │
│       ↓                                                                     │
│                                                                              │
│  STRESS REDUCTION BASED ON SUCCESS:                                         │
│  ┌─────────────────────────────────────────────────────────────────┐        │
│  │  Marginal Success (DC exact): -1 Stress to all listeners       │        │
│  │  Full Success (DC +1-2):      -2 Stress to all listeners       │        │
│  │  Exceptional (DC +3-4):       -3 Stress to all listeners       │        │
│  │  Critical (DC +5+):           -4 Stress to all listeners       │        │
│  └─────────────────────────────────────────────────────────────────┘        │
│                                                                              │
│  ON FAILURE:                                                                │
│  ┌─────────────────────────────────────────────────────────────────┐        │
│  │  No stress reduction                                           │        │
│  │  Skald may feel embarrassed but no penalty                     │        │
│  └─────────────────────────────────────────────────────────────────┘        │
│                                                                              │
│  ──────────────────────────────────────────────────────────────────────────  │
│                                                                              │
│  COOLDOWN: Once per rest period                                             │
│                                                                              │
│  DURATION: Takes approximately 30 minutes in-game                           │
│                                                                              │
│  LISTENERS: All party members within earshot who choose to listen           │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

**Activation Conditions:**
- Player archetype is Skald
- Party is in rest/downtime phase
- At least one party member has Stress > 0
- Ability not on cooldown (once per rest)

**Effect:**
```csharp
SpecializationAbilityEffect.Create(
    ability: RhetoricSpecializationAbility.SagaOfHeroes,
    stressReduction: netSuccesses, // 1-4 based on success tier
    isPartyWide: true,
    description: "Your tale of heroism soothes troubled minds."
)
```

---

## 6. Kupmaðr Abilities

### 6.1 [Silver Tongue]

**Description:** Auto-succeed negotiation DC ≤ 12

**Purpose:** The Kupmaðr has conducted so many deals and haggled in so many markets that routine negotiations are effortless. Low-difficulty negotiations are automatically successful, representing the merchant's instinctive mastery of the bargaining process.

**Mechanic:**

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                       [SILVER TONGUE] MECHANIC                               │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  TRIGGER: Negotiation check with final DC ≤ 12                              │
│                                                                              │
│  ──────────────────────────────────────────────────────────────────────────  │
│                                                                              │
│  DC CALCULATION:                                                            │
│                                                                              │
│  Base DC (from negotiation complexity)         Example                      │
│  + Target modifiers                                                         │
│  + Situational modifiers                                                    │
│  = Final DC                                                                 │
│                                                                              │
│  ┌─────────────────────────────────────────────────────────────────┐        │
│  │  If Final DC ≤ 12:                                              │        │
│  │    → Skip dice roll                                             │        │
│  │    → Automatically succeed                                      │        │
│  │    → Treat as "Full Success" for outcome                        │        │
│  │                                                                  │        │
│  │  If Final DC > 12:                                              │        │
│  │    → Normal negotiation check proceeds                          │        │
│  │    → [Silver Tongue] provides no benefit                        │        │
│  └─────────────────────────────────────────────────────────────────┘        │
│                                                                              │
│  ──────────────────────────────────────────────────────────────────────────  │
│                                                                              │
│  EXAMPLES OF DC ≤ 12 NEGOTIATIONS:                                          │
│  • Fair trade exchanges (DC 10)                                             │
│  • Slight advantage in common goods (DC 12)                                 │
│  • Standard bartering with neutral merchants (DC 10-12)                     │
│                                                                              │
│  EXAMPLES OF DC > 12 NEGOTIATIONS:                                          │
│  • Noticeable advantage (DC 18) → Normal check                              │
│  • Major advantage (DC 22) → Normal check                                   │
│  • One-sided deal (DC 26) → Normal check                                    │
│                                                                              │
│  ──────────────────────────────────────────────────────────────────────────  │
│                                                                              │
│  NOTE: This mirrors the Master Ability pattern from v0.15.1c                │
│  (Auto-succeed abilities bypass checks below threshold)                     │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

**Activation Conditions:**
- Player archetype is Kupmaðr
- Social interaction type is Negotiation
- Final DC (after all modifiers) ≤ 12

**Effect:**
```csharp
SpecializationAbilityEffect.Create(
    ability: RhetoricSpecializationAbility.SilverTongue,
    autoSuccess: true,
    autoSuccessThreshold: 12,
    description: "Your mercantile expertise makes this negotiation trivial."
)
```

### 6.2 [Sniff Out Lies]

**Description:** Bonus dice to detect NPC deception

**Purpose:** Years of dealing with unscrupulous merchants, con artists, and competitors have given the Kupmaðr a keen sense for when someone is being dishonest. They receive bonus dice when attempting to detect lies or deception.

**Mechanic:**

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                      [SNIFF OUT LIES] MECHANIC                               │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  TRIGGER: Opposed check to detect NPC deception                             │
│                                                                              │
│  ──────────────────────────────────────────────────────────────────────────  │
│                                                                              │
│  DETECTION SCENARIOS:                                                       │
│                                                                              │
│  1. NPC attempts to deceive player                                          │
│     NPC rolls: WILL + Rhetoric                                              │
│     Player rolls: WITS + Insight (or Rhetoric)                              │
│     Kupmaðr bonus: +2d10 to detection roll                                  │
│                                                                              │
│  2. Player actively questions NPC's honesty                                 │
│     Player declares: "I don't believe you."                                 │
│     Player rolls: WITS + Insight                                            │
│     Kupmaðr bonus: +2d10                                                    │
│                                                                              │
│  3. Passive detection (GM-initiated)                                        │
│     NPC lies during conversation                                            │
│     GM calls for detection check                                            │
│     Kupmaðr bonus: +2d10                                                    │
│                                                                              │
│  ──────────────────────────────────────────────────────────────────────────  │
│                                                                              │
│  EFFECT APPLICATION:                                                        │
│  ┌─────────────────────────────────────────────────────────────────┐        │
│  │  Base Dice Pool: WITS + Insight (e.g., 3 + 2 = 5d10)           │        │
│  │                          ↓                                      │        │
│  │  [Sniff Out Lies] applies                                      │        │
│  │                          ↓                                      │        │
│  │  Modified Pool: 5d10 + 2d10 = 7d10                              │        │
│  └─────────────────────────────────────────────────────────────────┘        │
│                                                                              │
│  ──────────────────────────────────────────────────────────────────────────  │
│                                                                              │
│  COOLDOWN: None (always active when detecting deception)                    │
│                                                                              │
│  LIMITATION: Only applies to deception detection, not other social checks   │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

**Activation Conditions:**
- Player archetype is Kupmaðr
- Player is target of deception OR actively detecting lies
- Check type is Insight/Deception Detection

**Effect:**
```csharp
SpecializationAbilityEffect.Create(
    ability: RhetoricSpecializationAbility.SniffOutLies,
    diceBonus: 2,
    description: "Your merchant's instincts detect something false."
)
```

---

## 7. Myrk-gengr Abilities

### 7.1 [Maintain Cover]

**Description:** Stay in character under pressure

**Purpose:** When an infiltrator's cover identity is challenged—whether through pointed questions, suspicious NPCs, or stressful situations—the Myrk-gengr can draw on their training to remain calm and maintain the deception.

**Mechanic:**

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                      [MAINTAIN COVER] MECHANIC                               │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  TRIGGER: Cover identity is challenged or threatened                        │
│                                                                              │
│  ──────────────────────────────────────────────────────────────────────────  │
│                                                                              │
│  COVER CHALLENGE SCENARIOS:                                                 │
│                                                                              │
│  1. Direct Questioning                                                      │
│     NPC: "Papers say you're from Ironhold. Name the three districts."       │
│     Challenge: DC based on question difficulty                              │
│                                                                              │
│  2. Suspicious Behavior Noticed                                             │
│     NPC: "Why were you near the restricted section?"                        │
│     Challenge: Deception check to explain                                   │
│                                                                              │
│  3. Stress Under Observation                                                │
│     Situation: Patrol passes while you're in disguise                       │
│     Challenge: Composure check to avoid tells                               │
│                                                                              │
│  4. Contradiction Detected                                                  │
│     NPC: "But earlier you said you arrived yesterday..."                    │
│     Challenge: Deception check to reconcile                                 │
│                                                                              │
│  ──────────────────────────────────────────────────────────────────────────  │
│                                                                              │
│  EFFECT APPLICATION:                                                        │
│  ┌─────────────────────────────────────────────────────────────────┐        │
│  │  When cover is challenged:                                      │        │
│  │                                                                  │        │
│  │  Base Dice Pool: WILL + Rhetoric (Deception)                    │        │
│  │                          ↓                                      │        │
│  │  [Maintain Cover] applies                                       │        │
│  │                          ↓                                      │        │
│  │  Modified Pool: Base + 2d10                                      │        │
│  │                                                                  │        │
│  │  Additionally:                                                   │        │
│  │  • Stress from cover challenges reduced by 1                    │        │
│  │  • Fumble consequences are downgraded one tier                  │        │
│  │    (Lie Exposed → normal failure instead)                       │        │
│  └─────────────────────────────────────────────────────────────────┘        │
│                                                                              │
│  ──────────────────────────────────────────────────────────────────────────  │
│                                                                              │
│  LIMITATION:                                                                │
│  • Only applies when maintaining an established cover identity              │
│  • Does not help with initial deception attempts                            │
│  • Cover must have been set up beforehand                                   │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

**Activation Conditions:**
- Player archetype is Myrk-gengr
- Player has an active cover identity
- Cover identity is being challenged (questions, suspicion, stress)

**Effect:**
```csharp
SpecializationAbilityEffect.Create(
    ability: RhetoricSpecializationAbility.MaintainCover,
    diceBonus: 2,
    stressReduction: 1,
    fumbleDowngrade: true,
    description: "Your training allows you to stay calm and in character."
)
```

### 7.2 [Forge Documents]

**Description:** Create convincing proof

**Purpose:** The Myrk-gengr can create forged documents, fake credentials, and other false proof to support their cover stories and deceptions. These forgeries provide bonuses to deception checks or can be used as evidence in persuasion/negotiation.

**Mechanic:**

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                      [FORGE DOCUMENTS] MECHANIC                              │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  ACTION TYPE: Extended action during downtime                               │
│                                                                              │
│  ──────────────────────────────────────────────────────────────────────────  │
│                                                                              │
│  FORGERY PROCESS:                                                           │
│                                                                              │
│  Step 1: Declare document type                                              │
│  ┌─────────────────────────────────────────────────────────────────┐        │
│  │  Document Type          DC     Time Required                    │        │
│  │  ──────────────────────────────────────────────────────────────│        │
│  │  Simple note            10     10 minutes                       │        │
│  │  Travel papers          12     30 minutes                       │        │
│  │  Guild credentials      14     1 hour                           │        │
│  │  Official orders        16     2 hours                          │        │
│  │  Faction authorization  18     4 hours                          │        │
│  │  Rare/complex document  20+    8+ hours                         │        │
│  └─────────────────────────────────────────────────────────────────┘        │
│                                                                              │
│  Step 2: Myrk-gengr makes Rhetoric + WITS check                             │
│                                                                              │
│  Step 3: Determine forgery quality                                          │
│  ┌─────────────────────────────────────────────────────────────────┐        │
│  │  Result vs DC           Forgery Quality                         │        │
│  │  ──────────────────────────────────────────────────────────────│        │
│  │  Failure                Obvious fake (unusable)                 │        │
│  │  Marginal Success       Passable (-2 DC to detect)              │        │
│  │  Full Success           Good (-4 DC to detect)                  │        │
│  │  Exceptional            Excellent (-6 DC to detect)             │        │
│  │  Critical               Masterwork (requires expertise)         │        │
│  └─────────────────────────────────────────────────────────────────┘        │
│                                                                              │
│  ──────────────────────────────────────────────────────────────────────────  │
│                                                                              │
│  USING FORGED DOCUMENTS:                                                    │
│                                                                              │
│  • As evidence in Persuasion: Grants bonus per quality tier                 │
│  • To support Deception: Reduces deception DC                               │
│  • For access: May bypass checks entirely if quality sufficient             │
│                                                                              │
│  ──────────────────────────────────────────────────────────────────────────  │
│                                                                              │
│  REQUIREMENTS:                                                              │
│  • Appropriate materials (paper, ink, seals - or improvisation)             │
│  • Reference sample (optional, but grants +2d10 if available)               │
│  • Time and privacy to work                                                 │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

**Activation Conditions:**
- Player archetype is Myrk-gengr
- Player has materials and time for forgery
- Player is not in combat or stressful situation

**Effect:**
```csharp
SpecializationAbilityEffect.Create(
    ability: RhetoricSpecializationAbility.ForgeDocuments,
    createsAsset: true,
    assetType: "ForgedDocument",
    assetQuality: qualityFromCheck,
    description: "You craft a convincing forgery."
)
```

---

## 8. Data Model Changes

### 8.1 New Enum: RhetoricSpecializationAbility

**File:** `src/Core/RuneAndRust.Domain/Enums/RhetoricSpecializationAbility.cs`

```csharp
namespace RuneAndRust.Domain.Enums;

/// <summary>
/// Identifies rhetoric-focused abilities granted by archetype specializations.
/// </summary>
/// <remarks>
/// <para>
/// Each archetype has two rhetoric specialization abilities:
/// <list type="bullet">
///   <item><description>Thul: Voice of Reason, Scholarly Authority</description></item>
///   <item><description>Skald: Inspiring Words, Saga of Heroes</description></item>
///   <item><description>Kupmaðr: Silver Tongue, Sniff Out Lies</description></item>
///   <item><description>Myrk-gengr: Maintain Cover, Forge Documents</description></item>
/// </list>
/// </para>
/// </remarks>
public enum RhetoricSpecializationAbility
{
    /// <summary>
    /// Thul ability: Failed persuasion doesn't lock dialogue options.
    /// </summary>
    VoiceOfReason = 0,

    /// <summary>
    /// Thul ability: +2d10 when discussing lore/history topics.
    /// </summary>
    ScholarlyAuthority = 1,

    /// <summary>
    /// Skald ability: Grant allies +1d10 on social checks through oratory.
    /// </summary>
    InspiringWords = 2,

    /// <summary>
    /// Skald ability: Reduce party stress through storytelling during rest.
    /// </summary>
    SagaOfHeroes = 3,

    /// <summary>
    /// Kupmaðr ability: Auto-succeed negotiation checks with DC ≤ 12.
    /// </summary>
    SilverTongue = 4,

    /// <summary>
    /// Kupmaðr ability: +2d10 when detecting NPC deception.
    /// </summary>
    SniffOutLies = 5,

    /// <summary>
    /// Myrk-gengr ability: +2d10 and reduced stress when cover is challenged.
    /// </summary>
    MaintainCover = 6,

    /// <summary>
    /// Myrk-gengr ability: Create forged documents as evidence/credentials.
    /// </summary>
    ForgeDocuments = 7
}
```

### 8.2 New Value Object: SpecializationAbilityEffect

**File:** `src/Core/RuneAndRust.Domain/ValueObjects/SpecializationAbilityEffect.cs`

```csharp
using RuneAndRust.Domain.Enums;

namespace RuneAndRust.Domain.ValueObjects;

/// <summary>
/// Represents the effect of a triggered specialization ability.
/// </summary>
/// <remarks>
/// This value object captures what modifications should be applied
/// to a social check or interaction based on specialization abilities.
/// </remarks>
/// <param name="Ability">The specialization ability that triggered.</param>
/// <param name="DiceBonus">Bonus dice to add to the pool (0 if none).</param>
/// <param name="AutoSuccess">If true, bypass the check entirely.</param>
/// <param name="AutoSuccessThreshold">DC threshold for auto-success abilities.</param>
/// <param name="PreventOptionLock">If true, failed check doesn't lock options.</param>
/// <param name="StressReduction">Amount of stress reduction applied.</param>
/// <param name="IsPartyWide">If true, effect applies to all party members.</param>
/// <param name="FumbleDowngrade">If true, fumble is treated as normal failure.</param>
/// <param name="CreatesAsset">If true, ability creates a usable asset.</param>
/// <param name="AssetType">Type of asset created (e.g., "ForgedDocument").</param>
/// <param name="AssetQuality">Quality tier of created asset.</param>
/// <param name="Duration">How long the effect lasts (null = immediate).</param>
/// <param name="Description">Human-readable description of the effect.</param>
public readonly record struct SpecializationAbilityEffect(
    RhetoricSpecializationAbility Ability,
    int DiceBonus,
    bool AutoSuccess,
    int AutoSuccessThreshold,
    bool PreventOptionLock,
    int StressReduction,
    bool IsPartyWide,
    bool FumbleDowngrade,
    bool CreatesAsset,
    string? AssetType,
    int AssetQuality,
    TimeSpan? Duration,
    string Description)
{
    /// <summary>
    /// Whether this effect modifies the dice pool.
    /// </summary>
    public bool ModifiesDicePool => DiceBonus > 0;

    /// <summary>
    /// Whether this effect modifies the check outcome.
    /// </summary>
    public bool ModifiesOutcome => PreventOptionLock || FumbleDowngrade;

    /// <summary>
    /// Whether this effect bypasses the check entirely.
    /// </summary>
    public bool BypassesCheck => AutoSuccess;

    /// <summary>
    /// Whether this effect affects party members.
    /// </summary>
    public bool AffectsParty => IsPartyWide;

    /// <summary>
    /// Creates an effect with only a dice bonus.
    /// </summary>
    public static SpecializationAbilityEffect DiceBonusEffect(
        RhetoricSpecializationAbility ability,
        int bonus,
        string description) => new(
            Ability: ability,
            DiceBonus: bonus,
            AutoSuccess: false,
            AutoSuccessThreshold: 0,
            PreventOptionLock: false,
            StressReduction: 0,
            IsPartyWide: false,
            FumbleDowngrade: false,
            CreatesAsset: false,
            AssetType: null,
            AssetQuality: 0,
            Duration: null,
            Description: description);

    /// <summary>
    /// Creates an effect that auto-succeeds below a threshold.
    /// </summary>
    public static SpecializationAbilityEffect AutoSucceedEffect(
        RhetoricSpecializationAbility ability,
        int threshold,
        string description) => new(
            Ability: ability,
            DiceBonus: 0,
            AutoSuccess: true,
            AutoSuccessThreshold: threshold,
            PreventOptionLock: false,
            StressReduction: 0,
            IsPartyWide: false,
            FumbleDowngrade: false,
            CreatesAsset: false,
            AssetType: null,
            AssetQuality: 0,
            Duration: null,
            Description: description);

    /// <summary>
    /// Creates an effect that prevents option locking on failure.
    /// </summary>
    public static SpecializationAbilityEffect PreventLockEffect(
        RhetoricSpecializationAbility ability,
        string description) => new(
            Ability: ability,
            DiceBonus: 0,
            AutoSuccess: false,
            AutoSuccessThreshold: 0,
            PreventOptionLock: true,
            StressReduction: 0,
            IsPartyWide: false,
            FumbleDowngrade: false,
            CreatesAsset: false,
            AssetType: null,
            AssetQuality: 0,
            Duration: null,
            Description: description);

    /// <summary>
    /// Creates a party-wide stress reduction effect.
    /// </summary>
    public static SpecializationAbilityEffect StressReliefEffect(
        RhetoricSpecializationAbility ability,
        int reduction,
        string description) => new(
            Ability: ability,
            DiceBonus: 0,
            AutoSuccess: false,
            AutoSuccessThreshold: 0,
            PreventOptionLock: false,
            StressReduction: reduction,
            IsPartyWide: true,
            FumbleDowngrade: false,
            CreatesAsset: false,
            AssetType: null,
            AssetQuality: 0,
            Duration: null,
            Description: description);

    /// <summary>
    /// Creates an effect for the Myrk-gengr's Maintain Cover ability.
    /// </summary>
    public static SpecializationAbilityEffect MaintainCoverEffect(
        string description) => new(
            Ability: RhetoricSpecializationAbility.MaintainCover,
            DiceBonus: 2,
            AutoSuccess: false,
            AutoSuccessThreshold: 0,
            PreventOptionLock: false,
            StressReduction: 1,
            IsPartyWide: false,
            FumbleDowngrade: true,
            CreatesAsset: false,
            AssetType: null,
            AssetQuality: 0,
            Duration: null,
            Description: description);

    /// <summary>
    /// Creates an effect for document forgery.
    /// </summary>
    public static SpecializationAbilityEffect ForgeryEffect(
        int quality,
        string description) => new(
            Ability: RhetoricSpecializationAbility.ForgeDocuments,
            DiceBonus: 0,
            AutoSuccess: false,
            AutoSuccessThreshold: 0,
            PreventOptionLock: false,
            StressReduction: 0,
            IsPartyWide: false,
            FumbleDowngrade: false,
            CreatesAsset: true,
            AssetType: "ForgedDocument",
            AssetQuality: quality,
            Duration: null,
            Description: description);

    /// <summary>
    /// Represents no effect (ability did not trigger).
    /// </summary>
    public static SpecializationAbilityEffect None => new(
        Ability: default,
        DiceBonus: 0,
        AutoSuccess: false,
        AutoSuccessThreshold: 0,
        PreventOptionLock: false,
        StressReduction: 0,
        IsPartyWide: false,
        FumbleDowngrade: false,
        CreatesAsset: false,
        AssetType: null,
        AssetQuality: 0,
        Duration: null,
        Description: string.Empty);
}
```

---

## 9. Services

### 9.1 IRhetoricSpecializationService Interface

**File:** `src/Core/RuneAndRust.Domain/Interfaces/IRhetoricSpecializationService.cs`

```csharp
using RuneAndRust.Domain.Enums;
using RuneAndRust.Domain.ValueObjects;

namespace RuneAndRust.Domain.Interfaces;

/// <summary>
/// Service for applying archetype specialization abilities to rhetoric checks.
/// </summary>
public interface IRhetoricSpecializationService
{
    /// <summary>
    /// Gets any pre-check bonuses applicable to the social interaction.
    /// </summary>
    /// <param name="playerId">The player character's ID.</param>
    /// <param name="interactionType">The type of social interaction.</param>
    /// <param name="context">Additional context (topic, target, situation).</param>
    /// <returns>Effect containing dice bonuses or auto-success conditions.</returns>
    SpecializationAbilityEffect GetPreCheckBonus(
        Guid playerId,
        SocialInteractionType interactionType,
        SocialContext context);

    /// <summary>
    /// Applies post-check modifications based on specialization abilities.
    /// </summary>
    /// <param name="playerId">The player character's ID.</param>
    /// <param name="result">The social check result.</param>
    /// <param name="context">The social interaction context.</param>
    /// <returns>Modified effect (e.g., preventing option lock).</returns>
    SpecializationAbilityEffect ApplyPostCheckModification(
        Guid playerId,
        SocialResult result,
        SocialContext context);

    /// <summary>
    /// Checks if the player can auto-succeed on a check.
    /// </summary>
    /// <param name="playerId">The player character's ID.</param>
    /// <param name="interactionType">The type of social interaction.</param>
    /// <param name="finalDc">The final DC after all modifiers.</param>
    /// <returns>True if auto-success applies.</returns>
    bool CanAutoSucceed(
        Guid playerId,
        SocialInteractionType interactionType,
        int finalDc);

    /// <summary>
    /// Applies Skald's [Inspiring Words] to party members.
    /// </summary>
    /// <param name="skaldId">The Skald player's ID.</param>
    /// <param name="targetIds">Party members to inspire.</param>
    /// <returns>Result of the inspiration attempt.</returns>
    Task<SpecializationAbilityEffect> ApplyInspirationAsync(
        Guid skaldId,
        IEnumerable<Guid> targetIds);

    /// <summary>
    /// Performs Skald's [Saga of Heroes] during rest.
    /// </summary>
    /// <param name="skaldId">The Skald player's ID.</param>
    /// <param name="listenerIds">Party members listening to the story.</param>
    /// <returns>Result of the storytelling session.</returns>
    Task<SpecializationAbilityEffect> PerformStorytellingAsync(
        Guid skaldId,
        IEnumerable<Guid> listenerIds);

    /// <summary>
    /// Creates a forged document using Myrk-gengr's [Forge Documents].
    /// </summary>
    /// <param name="forgerId">The Myrk-gengr player's ID.</param>
    /// <param name="documentType">The type of document to forge.</param>
    /// <param name="hasReferenceSample">Whether a reference is available.</param>
    /// <returns>Result of the forgery attempt.</returns>
    Task<SpecializationAbilityEffect> CreateForgedDocumentAsync(
        Guid forgerId,
        string documentType,
        bool hasReferenceSample);

    /// <summary>
    /// Gets all rhetoric abilities for a player's archetype.
    /// </summary>
    /// <param name="playerId">The player character's ID.</param>
    /// <returns>List of available abilities.</returns>
    IReadOnlyList<RhetoricSpecializationAbility> GetPlayerAbilities(Guid playerId);
}
```

### 9.2 RhetoricSpecializationService Implementation

**File:** `src/Core/RuneAndRust.Application/Services/RhetoricSpecializationService.cs`

```csharp
using Microsoft.Extensions.Logging;
using RuneAndRust.Domain.Enums;
using RuneAndRust.Domain.Interfaces;
using RuneAndRust.Domain.ValueObjects;

namespace RuneAndRust.Application.Services;

/// <summary>
/// Implementation of rhetoric specialization ability logic.
/// </summary>
public class RhetoricSpecializationService : IRhetoricSpecializationService
{
    private readonly IClassService _classService;
    private readonly ISkillCheckService _skillCheckService;
    private readonly ITraumaService _traumaService;
    private readonly ILogger<RhetoricSpecializationService> _logger;

    // Archetype ID constants
    private const string ThulArchetypeId = "thul";
    private const string SkaldArchetypeId = "skald";
    private const string KupmadrArchetypeId = "kupmadr";
    private const string MyrkGengrArchetypeId = "myrk-gengr";

    // Ability thresholds and bonuses
    private const int SilverTongueDcThreshold = 12;
    private const int ScholarlyAuthorityBonus = 2;
    private const int SniffOutLiesBonus = 2;
    private const int MaintainCoverBonus = 2;
    private const int InspiringWordsDc = 12;

    public RhetoricSpecializationService(
        IClassService classService,
        ISkillCheckService skillCheckService,
        ITraumaService traumaService,
        ILogger<RhetoricSpecializationService> logger)
    {
        _classService = classService;
        _skillCheckService = skillCheckService;
        _traumaService = traumaService;
        _logger = logger;
    }

    /// <inheritdoc />
    public SpecializationAbilityEffect GetPreCheckBonus(
        Guid playerId,
        SocialInteractionType interactionType,
        SocialContext context)
    {
        var archetypeId = _classService.GetPlayerArchetype(playerId);

        return archetypeId switch
        {
            ThulArchetypeId => GetThulPreCheckBonus(interactionType, context),
            SkaldArchetypeId => SpecializationAbilityEffect.None, // Skald bonuses are party-focused
            KupmadrArchetypeId => GetKupmadrPreCheckBonus(interactionType, context),
            MyrkGengrArchetypeId => GetMyrkGengrPreCheckBonus(interactionType, context),
            _ => SpecializationAbilityEffect.None
        };
    }

    private SpecializationAbilityEffect GetThulPreCheckBonus(
        SocialInteractionType interactionType,
        SocialContext context)
    {
        // [Scholarly Authority]: +2d10 when discussing lore/history
        if (IsLoreOrHistoryTopic(context.TopicTags))
        {
            _logger.LogDebug(
                "[Scholarly Authority] triggered for topic: {Topic}",
                string.Join(", ", context.TopicTags));

            return SpecializationAbilityEffect.DiceBonusEffect(
                RhetoricSpecializationAbility.ScholarlyAuthority,
                ScholarlyAuthorityBonus,
                "Your scholarly expertise lends weight to your words.");
        }

        return SpecializationAbilityEffect.None;
    }

    private SpecializationAbilityEffect GetKupmadrPreCheckBonus(
        SocialInteractionType interactionType,
        SocialContext context)
    {
        // [Sniff Out Lies]: +2d10 when detecting deception
        if (context.IsDeceptionDetection)
        {
            _logger.LogDebug("[Sniff Out Lies] triggered for deception detection");

            return SpecializationAbilityEffect.DiceBonusEffect(
                RhetoricSpecializationAbility.SniffOutLies,
                SniffOutLiesBonus,
                "Your merchant's instincts detect something false.");
        }

        return SpecializationAbilityEffect.None;
    }

    private SpecializationAbilityEffect GetMyrkGengrPreCheckBonus(
        SocialInteractionType interactionType,
        SocialContext context)
    {
        // [Maintain Cover]: +2d10 when cover is challenged
        if (context.IsCoverChallenged)
        {
            _logger.LogDebug("[Maintain Cover] triggered for cover challenge");

            return SpecializationAbilityEffect.MaintainCoverEffect(
                "Your training allows you to stay calm and in character.");
        }

        return SpecializationAbilityEffect.None;
    }

    /// <inheritdoc />
    public SpecializationAbilityEffect ApplyPostCheckModification(
        Guid playerId,
        SocialResult result,
        SocialContext context)
    {
        var archetypeId = _classService.GetPlayerArchetype(playerId);

        // [Voice of Reason]: Failed persuasion doesn't lock options (Thul only)
        if (archetypeId == ThulArchetypeId &&
            context.InteractionType == SocialInteractionType.Persuasion &&
            result.Outcome == SkillOutcome.Failure &&
            result.Outcome != SkillOutcome.CriticalFailure) // Fumbles still lock
        {
            _logger.LogDebug("[Voice of Reason] preventing option lock on persuasion failure");

            return SpecializationAbilityEffect.PreventLockEffect(
                RhetoricSpecializationAbility.VoiceOfReason,
                "Your reasoned approach leaves the conversation open for future attempts.");
        }

        return SpecializationAbilityEffect.None;
    }

    /// <inheritdoc />
    public bool CanAutoSucceed(
        Guid playerId,
        SocialInteractionType interactionType,
        int finalDc)
    {
        var archetypeId = _classService.GetPlayerArchetype(playerId);

        // [Silver Tongue]: Auto-succeed negotiation DC ≤ 12 (Kupmaðr only)
        if (archetypeId == KupmadrArchetypeId &&
            interactionType == SocialInteractionType.Negotiation &&
            finalDc <= SilverTongueDcThreshold)
        {
            _logger.LogDebug(
                "[Silver Tongue] auto-succeeding negotiation with DC {Dc} (≤ {Threshold})",
                finalDc, SilverTongueDcThreshold);

            return true;
        }

        return false;
    }

    /// <inheritdoc />
    public async Task<SpecializationAbilityEffect> ApplyInspirationAsync(
        Guid skaldId,
        IEnumerable<Guid> targetIds)
    {
        var archetypeId = _classService.GetPlayerArchetype(skaldId);
        if (archetypeId != SkaldArchetypeId)
        {
            _logger.LogWarning(
                "ApplyInspiration called for non-Skald player {PlayerId}",
                skaldId);
            return SpecializationAbilityEffect.None;
        }

        // Skald makes DC 12 Rhetoric check
        var checkResult = await _skillCheckService.PerformCheckAsync(
            skaldId, "rhetoric", InspiringWordsDc);

        if (!checkResult.IsSuccess)
        {
            _logger.LogDebug(
                "[Inspiring Words] failed - Skald did not succeed DC {Dc} check",
                InspiringWordsDc);
            return SpecializationAbilityEffect.None;
        }

        // Exceptional success (net ≥ 3) affects all party members
        bool isPartyWide = checkResult.NetSuccesses >= 3;

        _logger.LogDebug(
            "[Inspiring Words] succeeded with {Net} net successes, party-wide: {PartyWide}",
            checkResult.NetSuccesses, isPartyWide);

        return new SpecializationAbilityEffect(
            Ability: RhetoricSpecializationAbility.InspiringWords,
            DiceBonus: 1,
            AutoSuccess: false,
            AutoSuccessThreshold: 0,
            PreventOptionLock: false,
            StressReduction: 0,
            IsPartyWide: isPartyWide,
            FumbleDowngrade: false,
            CreatesAsset: false,
            AssetType: null,
            AssetQuality: 0,
            Duration: TimeSpan.FromMinutes(10),
            Description: isPartyWide
                ? "Your rousing words fill all your allies with confidence."
                : "Your words of encouragement bolster your ally's confidence.");
    }

    /// <inheritdoc />
    public async Task<SpecializationAbilityEffect> PerformStorytellingAsync(
        Guid skaldId,
        IEnumerable<Guid> listenerIds)
    {
        var archetypeId = _classService.GetPlayerArchetype(skaldId);
        if (archetypeId != SkaldArchetypeId)
        {
            _logger.LogWarning(
                "PerformStorytelling called for non-Skald player {PlayerId}",
                skaldId);
            return SpecializationAbilityEffect.None;
        }

        // Skald makes DC 10 Rhetoric check
        const int storytellingDc = 10;
        var checkResult = await _skillCheckService.PerformCheckAsync(
            skaldId, "rhetoric", storytellingDc);

        if (!checkResult.IsSuccess)
        {
            _logger.LogDebug(
                "[Saga of Heroes] failed - story didn't resonate");
            return SpecializationAbilityEffect.None;
        }

        // Stress reduction based on success tier
        int stressReduction = checkResult.NetSuccesses switch
        {
            >= 5 => 4, // Critical
            >= 3 => 3, // Exceptional
            >= 1 => 2, // Full success
            _ => 1     // Marginal
        };

        // Apply stress reduction to all listeners
        var listeners = listenerIds.ToList();
        foreach (var listenerId in listeners)
        {
            await _traumaService.ReduceStressAsync(listenerId, stressReduction);
        }

        _logger.LogInformation(
            "[Saga of Heroes] reduced stress by {Amount} for {Count} listeners",
            stressReduction, listeners.Count);

        return SpecializationAbilityEffect.StressReliefEffect(
            RhetoricSpecializationAbility.SagaOfHeroes,
            stressReduction,
            $"Your tale of heroism soothes troubled minds, reducing stress by {stressReduction}.");
    }

    /// <inheritdoc />
    public async Task<SpecializationAbilityEffect> CreateForgedDocumentAsync(
        Guid forgerId,
        string documentType,
        bool hasReferenceSample)
    {
        var archetypeId = _classService.GetPlayerArchetype(forgerId);
        if (archetypeId != MyrkGengrArchetypeId)
        {
            _logger.LogWarning(
                "CreateForgedDocument called for non-Myrk-gengr player {PlayerId}",
                forgerId);
            return SpecializationAbilityEffect.None;
        }

        // Determine DC based on document type
        int baseDc = GetForgeryDc(documentType);

        // Reference sample grants +2d10
        int bonusDice = hasReferenceSample ? 2 : 0;

        // Make the forgery check (WITS + Rhetoric)
        var checkResult = await _skillCheckService.PerformCheckAsync(
            forgerId, "rhetoric", baseDc, bonusDice);

        if (!checkResult.IsSuccess)
        {
            _logger.LogDebug(
                "[Forge Documents] failed - obvious fake produced");
            return SpecializationAbilityEffect.None;
        }

        // Quality based on success tier
        int quality = checkResult.NetSuccesses switch
        {
            >= 5 => 5, // Masterwork
            >= 3 => 4, // Excellent
            >= 1 => 3, // Good
            _ => 2     // Passable
        };

        _logger.LogInformation(
            "[Forge Documents] created {DocumentType} with quality {Quality}",
            documentType, quality);

        return SpecializationAbilityEffect.ForgeryEffect(
            quality,
            $"You craft a convincing {documentType} (quality: {quality}/5).");
    }

    /// <inheritdoc />
    public IReadOnlyList<RhetoricSpecializationAbility> GetPlayerAbilities(Guid playerId)
    {
        var archetypeId = _classService.GetPlayerArchetype(playerId);

        return archetypeId switch
        {
            ThulArchetypeId => new[]
            {
                RhetoricSpecializationAbility.VoiceOfReason,
                RhetoricSpecializationAbility.ScholarlyAuthority
            },
            SkaldArchetypeId => new[]
            {
                RhetoricSpecializationAbility.InspiringWords,
                RhetoricSpecializationAbility.SagaOfHeroes
            },
            KupmadrArchetypeId => new[]
            {
                RhetoricSpecializationAbility.SilverTongue,
                RhetoricSpecializationAbility.SniffOutLies
            },
            MyrkGengrArchetypeId => new[]
            {
                RhetoricSpecializationAbility.MaintainCover,
                RhetoricSpecializationAbility.ForgeDocuments
            },
            _ => Array.Empty<RhetoricSpecializationAbility>()
        };
    }

    private static bool IsLoreOrHistoryTopic(IEnumerable<string> topicTags)
    {
        var loreTags = new HashSet<string>(StringComparer.OrdinalIgnoreCase)
        {
            "lore", "history", "academic", "scholarly", "ancient",
            "archives", "records", "traditions", "cultural", "mythology"
        };

        return topicTags.Any(tag => loreTags.Contains(tag));
    }

    private static int GetForgeryDc(string documentType)
    {
        return documentType.ToLowerInvariant() switch
        {
            "note" or "simple" => 10,
            "travel" or "papers" => 12,
            "guild" or "credentials" => 14,
            "orders" or "official" => 16,
            "faction" or "authorization" => 18,
            _ => 20 // Complex/rare documents
        };
    }
}
```

---

## 10. Configuration

### 10.1 rhetoric-specialization-abilities.json

**File:** `config/rhetoric-specialization-abilities.json`

```json
{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "version": "0.15.3i",
  "description": "Rhetoric specialization ability definitions for archetype bonuses",
  "abilities": [
    {
      "id": "voice-of-reason",
      "name": "Voice of Reason",
      "archetypeId": "thul",
      "abilityEnum": "VoiceOfReason",
      "description": "Failed persuasion doesn't lock dialogue options",
      "type": "outcomeModification",
      "trigger": {
        "interactionType": "persuasion",
        "outcome": "failure",
        "excludeOutcome": "criticalFailure"
      },
      "effect": {
        "preventOptionLock": true
      },
      "flavorText": "Your reasoned approach leaves the conversation open for future attempts."
    },
    {
      "id": "scholarly-authority",
      "name": "Scholarly Authority",
      "archetypeId": "thul",
      "abilityEnum": "ScholarlyAuthority",
      "description": "+2d10 when discussing lore/history topics",
      "type": "diceBonus",
      "trigger": {
        "topicTags": ["lore", "history", "academic", "scholarly", "ancient", "archives", "records", "traditions", "cultural", "mythology"]
      },
      "effect": {
        "diceBonus": 2
      },
      "flavorText": "Your scholarly expertise lends weight to your words."
    },
    {
      "id": "inspiring-words",
      "name": "Inspiring Words",
      "archetypeId": "skald",
      "abilityEnum": "InspiringWords",
      "description": "Grant allies +1d10 on social checks through oratory",
      "type": "partyBuff",
      "trigger": {
        "action": "inspire",
        "timing": "beforeAllyCheck"
      },
      "activation": {
        "checkRequired": true,
        "checkSkill": "rhetoric",
        "checkDc": 12,
        "cooldown": "perScene"
      },
      "effect": {
        "diceBonus": 1,
        "duration": "10 minutes",
        "partyWideOnExceptional": true,
        "exceptionalThreshold": 3
      },
      "flavorText": "Your rousing words fill your allies with confidence."
    },
    {
      "id": "saga-of-heroes",
      "name": "Saga of Heroes",
      "archetypeId": "skald",
      "abilityEnum": "SagaOfHeroes",
      "description": "Reduce party Stress through storytelling during rest",
      "type": "partyStressRelief",
      "trigger": {
        "timing": "rest",
        "action": "storytelling"
      },
      "activation": {
        "checkRequired": true,
        "checkSkill": "rhetoric",
        "checkDc": 10,
        "cooldown": "perRest",
        "durationMinutes": 30
      },
      "effect": {
        "stressReduction": {
          "marginal": 1,
          "full": 2,
          "exceptional": 3,
          "critical": 4
        },
        "isPartyWide": true
      },
      "flavorText": "Your tale of heroism soothes troubled minds."
    },
    {
      "id": "silver-tongue",
      "name": "Silver Tongue",
      "archetypeId": "kupmadr",
      "abilityEnum": "SilverTongue",
      "description": "Auto-succeed negotiation checks with DC ≤ 12",
      "type": "autoSuccess",
      "trigger": {
        "interactionType": "negotiation",
        "dcThreshold": 12
      },
      "effect": {
        "autoSuccess": true,
        "treatAsOutcome": "fullSuccess"
      },
      "flavorText": "Your mercantile expertise makes this negotiation trivial."
    },
    {
      "id": "sniff-out-lies",
      "name": "Sniff Out Lies",
      "archetypeId": "kupmadr",
      "abilityEnum": "SniffOutLies",
      "description": "+2d10 when detecting NPC deception",
      "type": "diceBonus",
      "trigger": {
        "context": "deceptionDetection"
      },
      "effect": {
        "diceBonus": 2
      },
      "flavorText": "Your merchant's instincts detect something false."
    },
    {
      "id": "maintain-cover",
      "name": "Maintain Cover",
      "archetypeId": "myrk-gengr",
      "abilityEnum": "MaintainCover",
      "description": "+2d10 and reduced stress when cover is challenged",
      "type": "composite",
      "trigger": {
        "context": "coverChallenged",
        "requiresActiveCover": true
      },
      "effect": {
        "diceBonus": 2,
        "stressReduction": 1,
        "fumbleDowngrade": true
      },
      "flavorText": "Your training allows you to stay calm and in character."
    },
    {
      "id": "forge-documents",
      "name": "Forge Documents",
      "archetypeId": "myrk-gengr",
      "abilityEnum": "ForgeDocuments",
      "description": "Create forged documents as evidence/credentials",
      "type": "specialAction",
      "trigger": {
        "timing": "downtime",
        "action": "forge"
      },
      "activation": {
        "checkRequired": true,
        "checkSkill": "rhetoric",
        "checkAttribute": "wits",
        "referenceSampleBonus": 2
      },
      "documentTypes": {
        "simple": { "dc": 10, "timeMinutes": 10 },
        "travel": { "dc": 12, "timeMinutes": 30 },
        "guild": { "dc": 14, "timeMinutes": 60 },
        "official": { "dc": 16, "timeMinutes": 120 },
        "faction": { "dc": 18, "timeMinutes": 240 },
        "rare": { "dc": 20, "timeMinutes": 480 }
      },
      "qualityBySuccess": {
        "marginal": { "quality": 2, "detectDcReduction": -2 },
        "full": { "quality": 3, "detectDcReduction": -4 },
        "exceptional": { "quality": 4, "detectDcReduction": -6 },
        "critical": { "quality": 5, "detectDcReduction": null, "note": "Requires expertise to detect" }
      },
      "flavorText": "You craft a convincing forgery."
    }
  ],
  "archetypeMapping": {
    "thul": ["voice-of-reason", "scholarly-authority"],
    "skald": ["inspiring-words", "saga-of-heroes"],
    "kupmadr": ["silver-tongue", "sniff-out-lies"],
    "myrk-gengr": ["maintain-cover", "forge-documents"]
  }
}
```

---

## 11. Logging Specifications

### 11.1 Log Categories

| Category | Level | Purpose |
|----------|-------|---------|
| `RhetoricSpecialization.AbilityTrigger` | Debug | When an ability activation is checked |
| `RhetoricSpecialization.AbilityApplied` | Information | When an ability effect is applied |
| `RhetoricSpecialization.AutoSuccess` | Information | When auto-success bypasses a check |
| `RhetoricSpecialization.PartyEffect` | Information | When party-wide effects are applied |
| `RhetoricSpecialization.Forgery` | Information | When a document is forged |

### 11.2 Log Message Templates

```csharp
// Ability trigger check
_logger.LogDebug(
    "[{Ability}] checking activation for {InteractionType} with context: {Context}",
    ability, interactionType, context);

// Ability applied
_logger.LogInformation(
    "[{Ability}] applied for player {PlayerId}: {Effect}",
    ability, playerId, effectDescription);

// Auto-success
_logger.LogInformation(
    "[Silver Tongue] auto-succeeding negotiation for {PlayerId} - DC {Dc} ≤ threshold {Threshold}",
    playerId, dc, threshold);

// Party-wide effect
_logger.LogInformation(
    "[{Ability}] applied to {Count} party members: {Effect}",
    ability, count, effectDescription);

// Forgery created
_logger.LogInformation(
    "[Forge Documents] {PlayerId} created {DocumentType} with quality {Quality}/5",
    playerId, documentType, quality);
```

### 11.3 Structured Log Properties

```json
{
  "ability": "SilverTongue",
  "playerId": "guid",
  "archetypeId": "kupmadr",
  "interactionType": "negotiation",
  "dc": 12,
  "autoSucceeded": true,
  "timestamp": "2026-01-17T12:00:00Z"
}
```

---

## 12. Unit Testing Requirements

### 12.1 Required Tests (Per Scope Breakdown)

**From v0.15.3-scope-breakdown.md:**
```
**Unit Tests (~2):**
- [ ] Thul failed persuasion doesn't lock
- [ ] Kupmaðr auto-succeeds low DC negotiation
```

### 12.2 Test Implementations

**File:** `tests/RuneAndRust.Tests/Services/RhetoricSpecializationServiceTests.cs`

```csharp
using FluentAssertions;
using Microsoft.Extensions.Logging;
using Moq;
using RuneAndRust.Application.Services;
using RuneAndRust.Domain.Enums;
using RuneAndRust.Domain.Interfaces;
using RuneAndRust.Domain.ValueObjects;
using Xunit;

namespace RuneAndRust.Tests.Services;

public class RhetoricSpecializationServiceTests
{
    private readonly Mock<IClassService> _classServiceMock;
    private readonly Mock<ISkillCheckService> _skillCheckServiceMock;
    private readonly Mock<ITraumaService> _traumaServiceMock;
    private readonly Mock<ILogger<RhetoricSpecializationService>> _loggerMock;
    private readonly RhetoricSpecializationService _service;

    public RhetoricSpecializationServiceTests()
    {
        _classServiceMock = new Mock<IClassService>();
        _skillCheckServiceMock = new Mock<ISkillCheckService>();
        _traumaServiceMock = new Mock<ITraumaService>();
        _loggerMock = new Mock<ILogger<RhetoricSpecializationService>>();

        _service = new RhetoricSpecializationService(
            _classServiceMock.Object,
            _skillCheckServiceMock.Object,
            _traumaServiceMock.Object,
            _loggerMock.Object);
    }

    /// <summary>
    /// Test: Thul failed persuasion doesn't lock options.
    /// Verifies [Voice of Reason] ability prevents option locking on failed persuasion.
    /// </summary>
    [Fact]
    public void ApplyPostCheckModification_ThulFailedPersuasion_PreventsOptionLock()
    {
        // Arrange
        var playerId = Guid.NewGuid();
        _classServiceMock
            .Setup(x => x.GetPlayerArchetype(playerId))
            .Returns("thul");

        var context = new SocialContext
        {
            InteractionType = SocialInteractionType.Persuasion,
            TargetId = Guid.NewGuid()
        };

        var failedResult = new SocialResult
        {
            Outcome = SkillOutcome.Failure,
            // Note: Not a fumble/critical failure
        };

        // Act
        var effect = _service.ApplyPostCheckModification(playerId, failedResult, context);

        // Assert
        effect.Ability.Should().Be(RhetoricSpecializationAbility.VoiceOfReason);
        effect.PreventOptionLock.Should().BeTrue();
        effect.Description.Should().Contain("open for future attempts");
    }

    /// <summary>
    /// Test: Thul fumble still locks options (Voice of Reason doesn't prevent fumble consequences).
    /// </summary>
    [Fact]
    public void ApplyPostCheckModification_ThulFumblePersuasion_DoesNotPreventLock()
    {
        // Arrange
        var playerId = Guid.NewGuid();
        _classServiceMock
            .Setup(x => x.GetPlayerArchetype(playerId))
            .Returns("thul");

        var context = new SocialContext
        {
            InteractionType = SocialInteractionType.Persuasion,
            TargetId = Guid.NewGuid()
        };

        var fumbleResult = new SocialResult
        {
            Outcome = SkillOutcome.CriticalFailure, // Fumble
        };

        // Act
        var effect = _service.ApplyPostCheckModification(playerId, fumbleResult, context);

        // Assert
        effect.PreventOptionLock.Should().BeFalse();
        effect.Should().Be(SpecializationAbilityEffect.None);
    }

    /// <summary>
    /// Test: Kupmaðr auto-succeeds low DC negotiation.
    /// Verifies [Silver Tongue] ability auto-succeeds negotiation when DC ≤ 12.
    /// </summary>
    [Fact]
    public void CanAutoSucceed_KupmadrNegotiationDc12OrLess_ReturnsTrue()
    {
        // Arrange
        var playerId = Guid.NewGuid();
        _classServiceMock
            .Setup(x => x.GetPlayerArchetype(playerId))
            .Returns("kupmadr");

        // Act & Assert - DC exactly 12
        var resultDc12 = _service.CanAutoSucceed(
            playerId, SocialInteractionType.Negotiation, 12);
        resultDc12.Should().BeTrue();

        // Act & Assert - DC below 12
        var resultDc10 = _service.CanAutoSucceed(
            playerId, SocialInteractionType.Negotiation, 10);
        resultDc10.Should().BeTrue();
    }

    /// <summary>
    /// Test: Kupmaðr does not auto-succeed high DC negotiation.
    /// Verifies [Silver Tongue] doesn't trigger when DC > 12.
    /// </summary>
    [Fact]
    public void CanAutoSucceed_KupmadrNegotiationDcAbove12_ReturnsFalse()
    {
        // Arrange
        var playerId = Guid.NewGuid();
        _classServiceMock
            .Setup(x => x.GetPlayerArchetype(playerId))
            .Returns("kupmadr");

        // Act
        var result = _service.CanAutoSucceed(
            playerId, SocialInteractionType.Negotiation, 14);

        // Assert
        result.Should().BeFalse();
    }

    /// <summary>
    /// Test: Kupmaðr [Silver Tongue] only applies to Negotiation, not other types.
    /// </summary>
    [Fact]
    public void CanAutoSucceed_KupmadrPersuasion_ReturnsFalse()
    {
        // Arrange
        var playerId = Guid.NewGuid();
        _classServiceMock
            .Setup(x => x.GetPlayerArchetype(playerId))
            .Returns("kupmadr");

        // Act - Persuasion at DC 10 should NOT auto-succeed
        var result = _service.CanAutoSucceed(
            playerId, SocialInteractionType.Persuasion, 10);

        // Assert
        result.Should().BeFalse();
    }

    /// <summary>
    /// Test: Non-Kupmaðr archetype doesn't get auto-succeed on negotiation.
    /// </summary>
    [Fact]
    public void CanAutoSucceed_NonKupmadrNegotiation_ReturnsFalse()
    {
        // Arrange
        var playerId = Guid.NewGuid();
        _classServiceMock
            .Setup(x => x.GetPlayerArchetype(playerId))
            .Returns("thul"); // Thul, not Kupmaðr

        // Act
        var result = _service.CanAutoSucceed(
            playerId, SocialInteractionType.Negotiation, 10);

        // Assert
        result.Should().BeFalse();
    }
}
```

### 12.3 Extended Test Coverage (Recommended)

| Test | Ability | Purpose |
|------|---------|---------|
| `ScholarlyAuthority_LoreTopic_GrantsBonus` | Scholarly Authority | Verify +2d10 on lore topics |
| `ScholarlyAuthority_NonLoreTopic_NoBonus` | Scholarly Authority | Verify no bonus on non-lore |
| `InspiringWords_SuccessfulCheck_GrantsAllyBonus` | Inspiring Words | Verify ally buff on success |
| `InspiringWords_ExceptionalSuccess_PartyWide` | Inspiring Words | Verify party-wide on net ≥ 3 |
| `SagaOfHeroes_Success_ReducesPartyStress` | Saga of Heroes | Verify stress reduction |
| `SniffOutLies_DeceptionDetection_GrantsBonus` | Sniff Out Lies | Verify +2d10 on lie detection |
| `MaintainCover_CoverChallenged_GrantsBonusAndReducesStress` | Maintain Cover | Verify composite effect |
| `ForgeDocuments_Success_CreatesAsset` | Forge Documents | Verify forgery creation |

---

## 13. Use Cases

### 13.1 Use Case: Thul Persuading a Skeptic

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                USE CASE: THUL PERSUADING A SKEPTIC                           │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  SCENARIO: A Thul player attempts to convince a neutral NPC to share        │
│  information about a historical artifact. The check fails.                  │
│                                                                              │
│  ──────────────────────────────────────────────────────────────────────────  │
│                                                                              │
│  1. PLAYER INITIATES PERSUASION                                             │
│     Player: "I believe this artifact may be connected to the Rune-Singers.  │
│              Would you share what you know of its origins?"                 │
│                                                                              │
│  2. SYSTEM CHECKS FOR PRE-CHECK BONUSES                                     │
│     Topic tagged: ["history", "artifact", "lore"]                           │
│     [Scholarly Authority] TRIGGERS: +2d10                                   │
│                                                                              │
│  3. PERSUASION CHECK PERFORMED                                              │
│     Base Pool: WILL 3 + Rhetoric 2 = 5d10                                   │
│     + [Scholarly Authority]: +2d10 = 7d10                                   │
│     DC: 14 (Moderate request)                                               │
│                                                                              │
│     Roll: 3 successes (net below DC)                                        │
│     Result: FAILURE                                                         │
│                                                                              │
│  4. SYSTEM APPLIES POST-CHECK MODIFICATION                                  │
│     [Voice of Reason] TRIGGERS: PreventOptionLock = true                    │
│                                                                              │
│  5. OUTCOME                                                                 │
│     NPC: "I'm not convinced of your theory, scholar. But you argue         │
│           your case well. Perhaps another time, with more evidence."        │
│                                                                              │
│     → Disposition: No change (neutral response)                             │
│     → Dialogue Option: NOT LOCKED (can retry next conversation)            │
│     → Reputation: No change                                                 │
│                                                                              │
│  ──────────────────────────────────────────────────────────────────────────  │
│                                                                              │
│  WITHOUT THUL ABILITIES:                                                    │
│  • No +2d10 bonus (lower success chance)                                    │
│  • Dialogue option LOCKED on failure ("You already asked about this")      │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 13.2 Use Case: Kupmaðr Auto-Succeeding Negotiation

```
┌─────────────────────────────────────────────────────────────────────────────┐
│            USE CASE: KUPMAÐR AUTO-SUCCEEDING NEGOTIATION                     │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  SCENARIO: A Kupmaðr player enters a fair trade negotiation with a neutral  │
│  merchant. The base DC is 10 (fair trade).                                  │
│                                                                              │
│  ──────────────────────────────────────────────────────────────────────────  │
│                                                                              │
│  1. NEGOTIATION INITIATED                                                   │
│     Player: "I'd like to trade my recovered salvage for those rations."    │
│     Merchant: "Hmm, let's see what you've got."                             │
│                                                                              │
│  2. SYSTEM CALCULATES FINAL DC                                              │
│     Base DC: 10 (Fair trade)                                                │
│     + Modifiers: 0 (neutral disposition, no complications)                  │
│     = Final DC: 10                                                          │
│                                                                              │
│  3. SYSTEM CHECKS AUTO-SUCCESS                                              │
│     Player Archetype: Kupmaðr                                               │
│     Interaction Type: Negotiation                                           │
│     Final DC: 10 ≤ 12                                                       │
│                                                                              │
│     [Silver Tongue] TRIGGERS: Auto-Success!                                 │
│                                                                              │
│  4. OUTCOME (No dice rolled)                                                │
│     Merchant: "Yes, this looks like a fair exchange. Deal."                 │
│                                                                              │
│     → Trade completed successfully                                          │
│     → Treated as "Full Success" outcome                                     │
│     → No stress, no risk of failure                                         │
│                                                                              │
│  ──────────────────────────────────────────────────────────────────────────  │
│                                                                              │
│  NOTE: If DC was 14+ (e.g., seeking advantage), normal check would apply    │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 13.3 Use Case: Skald Performing Saga of Heroes

```
┌─────────────────────────────────────────────────────────────────────────────┐
│              USE CASE: SKALD PERFORMING SAGA OF HEROES                       │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  SCENARIO: After a harrowing dungeon crawl, the party rests at camp.        │
│  Party members have accumulated stress: Warrior (4), Scout (3), Mage (5).   │
│                                                                              │
│  ──────────────────────────────────────────────────────────────────────────  │
│                                                                              │
│  1. SKALD INITIATES STORYTELLING                                            │
│     Skald: "Gather close, friends. Let me tell you of Sigurd the Bold,     │
│             who faced the Shadow-Wyrm with naught but a broken blade..."   │
│                                                                              │
│  2. RHETORIC CHECK PERFORMED                                                │
│     Pool: WILL 4 + Rhetoric 3 = 7d10                                        │
│     DC: 10 (base storytelling)                                              │
│                                                                              │
│     Roll: 4 successes, 1 botch = Net 3 (Success with margin 3)              │
│     Result: EXCEPTIONAL SUCCESS                                             │
│                                                                              │
│  3. [SAGA OF HEROES] APPLIES                                                │
│     Success Tier: Exceptional (net ≥ 3)                                     │
│     Stress Reduction: 3 points                                              │
│     Effect: Party-wide                                                      │
│                                                                              │
│  4. STRESS UPDATED                                                          │
│     Warrior: 4 → 1 Stress                                                   │
│     Scout:   3 → 0 Stress                                                   │
│     Mage:    5 → 2 Stress                                                   │
│                                                                              │
│  5. NARRATIVE RESULT                                                        │
│     "As the tale concludes, you see the tension ease from your companions' │
│      faces. The fire crackles warmly, and for a moment, the wasteland      │
│      seems less oppressive."                                                │
│                                                                              │
│     → Ability on cooldown until next rest                                   │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 14. Deliverable Checklist

### 14.1 Enums

- [ ] `RhetoricSpecializationAbility` - 8 ability identifiers

### 14.2 Value Objects

- [ ] `SpecializationAbilityEffect` - Effect container with factory methods

### 14.3 Interfaces

- [ ] `IRhetoricSpecializationService` - Service contract

### 14.4 Services

- [ ] `RhetoricSpecializationService` - Implementation with all 8 abilities

### 14.5 Configuration

- [ ] `rhetoric-specialization-abilities.json` - Ability definitions

### 14.6 Unit Tests

- [ ] `ThulFailedPersuasion_DoesNotLockOptions`
- [ ] `KupmadrAutoSucceeds_LowDcNegotiation`

### 14.7 Documentation

- [ ] Design specification (this document)
- [ ] Ability descriptions for player reference

---

## 15. Acceptance Criteria

### 15.1 Functional Requirements

- [ ] Thul [Voice of Reason] prevents option locking on failed persuasion
- [ ] Thul [Voice of Reason] does NOT prevent locking on fumbles
- [ ] Thul [Scholarly Authority] grants +2d10 on lore/history topics
- [ ] Skald [Inspiring Words] grants +1d10 to ally on success
- [ ] Skald [Inspiring Words] affects party on exceptional success
- [ ] Skald [Saga of Heroes] reduces party stress during rest
- [ ] Kupmaðr [Silver Tongue] auto-succeeds negotiation DC ≤ 12
- [ ] Kupmaðr [Silver Tongue] does NOT apply to DC > 12
- [ ] Kupmaðr [Sniff Out Lies] grants +2d10 on deception detection
- [ ] Myrk-gengr [Maintain Cover] grants +2d10 and stress reduction
- [ ] Myrk-gengr [Forge Documents] creates usable forgery assets

### 15.2 Technical Requirements

- [ ] All abilities are configuration-driven
- [ ] Abilities integrate with existing social check flow
- [ ] Party-wide effects properly iterate through party members
- [ ] Logging provides visibility into ability triggers
- [ ] Unit tests cover core functionality per scope breakdown

### 15.3 Quality Requirements

- [ ] No feature invention beyond scope breakdown specification
- [ ] Consistent with existing ability patterns (v0.15.1c Master Abilities)
- [ ] Clean separation between ability logic and social check logic

---

## 16. Dependencies

### 16.1 Required (Prerequisites)

| Version | Component | Usage |
|---------|-----------|-------|
| v0.15.0c | ISkillCheckService | Performing rhetoric checks |
| v0.15.1c | Master Abilities Pattern | Auto-succeed ability design |
| v0.15.3a | SocialInteractionType | Interaction type classification |
| v0.15.3b-g | Social Check Services | Persuasion, Deception, etc. |
| v0.10.x | Status Effects | Stress management |

### 16.2 Existing Components

| Component | Usage |
|-----------|-------|
| IClassService | Archetype lookup |
| ITraumaService | Stress reduction |
| Player Entity | ArchetypeId property |
| ArchetypeDefinition | Archetype metadata |

### 16.3 Provides To

| Version/Component | Integration Point |
|-------------------|-------------------|
| Social Check Handlers | Pre/post check modifications |
| Rest System | Saga of Heroes during downtime |
| Dialogue System | Option lock prevention |
| Item System | Forged document assets |

---

## 17. Future Considerations

### 17.1 Planned Extensions

1. **Additional Archetypes** - As new archetypes are added, their rhetoric abilities would follow this pattern
2. **Ability Upgrades** - Potential for ability ranks/improvements with character progression
3. **Cross-Skill Synergies** - Abilities that combine rhetoric with other skills

### 17.2 Design Flexibility

The `SpecializationAbilityEffect` value object is designed to accommodate:
- New effect types (add properties)
- Composite effects (multiple properties active)
- Duration-based effects (with Duration property)
- Asset creation (forgery pattern extensible)

### 17.3 Balance Considerations

- Auto-succeed thresholds should remain conservative to preserve challenge
- Dice bonuses are additive with other modifiers
- Party-wide effects have cooldowns to prevent exploitation

---

## 18. Document Metadata

### 18.1 Version History

| Version | Date | Author | Changes |
|---------|------|--------|---------|
| 1.0 | 2026-01-17 | Claude | Initial specification |

### 18.2 Review Status

| Reviewer | Role | Status | Date |
|----------|------|--------|------|
| - | - | Pending | - |

### 18.3 Related Documents

| Document | Relationship |
|----------|--------------|
| v0.15.3-scope-breakdown.md | Source specification |
| v0.15.3h-design-specification.md | Previous version in sequence |
| v0.15.1c-design-specification.md | Master Abilities pattern reference |
| rhetoric.md (source) | Original game design |

### 18.4 Scope Alignment Verification

**Source:** v0.15.3-scope-breakdown.md, section "v0.15.3i - Specialization Integration"

| Specified Item | This Document | Notes |
|----------------|---------------|-------|
| Thul [Voice of Reason] | Section 4.1 | Implemented as specified |
| Thul [Scholarly Authority] | Section 4.2 | Implemented as specified |
| Skald [Inspiring Words] | Section 5.1 | Implemented as specified |
| Skald [Saga of Heroes] | Section 5.2 | Implemented as specified |
| Kupmaðr [Silver Tongue] | Section 6.1 | Implemented as specified |
| Kupmaðr [Sniff Out Lies] | Section 6.2 | Implemented as specified |
| Myrk-gengr [Maintain Cover] | Section 7.1 | Implemented as specified |
| Myrk-gengr [Forge Documents] | Section 7.2 | Implemented as specified |
| Unit Tests (~2) | Section 12 | 2 required + extended coverage |

**No features invented beyond scope specification.**
