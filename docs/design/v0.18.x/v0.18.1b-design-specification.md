# v0.18.1b Design Specification: CorruptionState Entity & Result Objects

**Version:** 0.18.1b
**Parent:** v0.18.1 (Runic Blight Corruption)
**Prerequisites:** v0.18.1a Complete (CorruptionStage Enum, CorruptionState Value Object)
**Status:** Design Complete
**Estimated Unit Tests:** ~5

---

## Table of Contents

1. [Executive Summary](#1-executive-summary)
2. [Feature Overview](#2-feature-overview)
3. [Architecture Diagrams](#3-architecture-diagrams)
4. [User Stories](#4-user-stories)
5. [CorruptionTracker Entity](#5-corruptiontracker-entity)
6. [CorruptionAddResult Record](#6-corruptionaddresult-record)
7. [TerminalErrorResult Record](#7-terminalerrorresult-record)
8. [Logging Specifications](#8-logging-specifications)
9. [Unit Testing Requirements](#9-unit-testing-requirements)
10. [Use Cases](#10-use-cases)
11. [Deliverable Checklist](#11-deliverable-checklist)
12. [Acceptance Criteria](#12-acceptance-criteria)
13. [Dependencies](#13-dependencies)
14. [Future Considerations](#14-future-considerations)

---

## 1. Executive Summary

This design specification defines the stateful entity and result objects for the Runic Blight Corruption system. v0.18.1b establishes `CorruptionTracker` — a mutable domain entity that tracks per-character corruption accumulation, threshold crossings, and computed penalties.

Unlike the immutable `CorruptionState` value object (v0.18.1a), `CorruptionTracker` maintains persistent state including character association, threshold trigger history, and provides domain methods for corruption manipulation.

### Key Deliverables

| Category                 | Items                                        |
| ------------------------ | -------------------------------------------- |
| **Domain Entities**      | `CorruptionTracker`                          |
| **Domain Value Objects** | `CorruptionAddResult`, `TerminalErrorResult` |
| **Tests**                | ~5 unit tests                                |

### Architectural Significance

This version establishes the **Corruption Domain Model** with:

- Per-character corruption tracking via `CharacterId`
- Computed penalties: Max HP/AP penalty, Resolve dice penalty
- Threshold crossing events at 25/50/75 corruption
- Terminal Error detection at 100 corruption
- Result objects for operation outcomes

### Core Mechanics Summary

| Mechanic             | Formula/Value                 |
| -------------------- | ----------------------------- |
| Max HP Penalty       | `floor(Corruption / 10) × 5%` |
| Max AP Penalty       | `floor(Corruption / 10) × 5%` |
| Resolve Dice Penalty | `floor(Corruption / 20)`      |
| Tech Bonus           | By threshold (0/+1/+2/+2/+2)  |
| Social Penalty       | By threshold (0/-1/-2/-2/-2)  |
| Faction Lock         | Corruption ≥ 50               |
| Terminal Error       | Corruption = 100              |

---

## 2. Feature Overview

```
v0.18.1b Features
└── Corruption Domain Model
    │
    ├── ENTITIES
    │   └── CorruptionTracker — Per-character corruption state
    │       ├── Id: Guid (IEntity)
    │       ├── CharacterId: Guid
    │       ├── CurrentCorruption: int (0-100)
    │       ├── Threshold25Triggered: bool
    │       ├── Threshold50Triggered: bool
    │       ├── Threshold75Triggered: bool
    │       ├── Stage: CorruptionStage (computed)
    │       ├── MaxHpPenaltyPercent: int (computed)
    │       ├── MaxApPenaltyPercent: int (computed)
    │       ├── ResolveDicePenalty: int (computed)
    │       ├── TechBonus: int (computed)
    │       ├── SocialPenalty: int (computed)
    │       ├── IsFactionLocked: bool (computed)
    │       ├── IsTerminalError: bool (computed)
    │       └── AddCorruption(amount, source): CorruptionAddResult
    │
    └── VALUE OBJECTS
        ├── CorruptionAddResult — Outcome of adding corruption
        │   ├── PreviousCorruption: int
        │   ├── NewCorruption: int
        │   ├── AmountGained: int
        │   ├── Source: CorruptionSource
        │   ├── ThresholdCrossed: int? (25/50/75 or null)
        │   ├── StageCrossed: bool
        │   ├── PreviousStage: CorruptionStage
        │   ├── NewStage: CorruptionStage
        │   └── IsTerminalError: bool
        │
        └── TerminalErrorResult — Outcome of Terminal Error check
            ├── Survived: bool
            ├── FinalCorruption: int
            ├── BecameForlorn: bool
            ├── SuccessesRolled: int
            └── RequiredDc: int
```

---

## 3. Architecture Diagrams

### 3.1 Domain Layer Diagram

```
┌─────────────────────────────────────────────────────────────────────────┐
│                          DOMAIN LAYER                                   │
│                   src/Core/RuneAndRust.Domain                           │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  FROM v0.18.1a (Dependencies)                                           │
│  ┌────────────────┐  ┌────────────────┐  ┌────────────────┐            │
│  │CorruptionStage │  │CorruptionSource│  │CorruptionState │            │
│  │    (Enum)      │  │    (Enum)      │  │ (Value Object) │            │
│  └────────────────┘  └────────────────┘  └────────────────┘            │
│           │                   │                   │                     │
│           └───────────────────┼───────────────────┘                     │
│                               │                                         │
│                               ▼                                         │
│  NEW: ENTITY                                                            │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │                   Entities/CorruptionTracker.cs                  │   │
│  ├─────────────────────────────────────────────────────────────────┤   │
│  │ + Id: Guid                        // IEntity                    │   │
│  │ + CharacterId: Guid               // Owner reference            │   │
│  │ + CurrentCorruption: int          // 0-100                      │   │
│  │ + Threshold25Triggered: bool      // One-time flag              │   │
│  │ + Threshold50Triggered: bool      // One-time flag              │   │
│  │ + Threshold75Triggered: bool      // One-time flag              │   │
│  │ ─────────────────────────────────────────────────────────────── │   │
│  │ + Stage: CorruptionStage          // Computed                   │   │
│  │ + MaxHpPenaltyPercent: int        // floor(C/10) × 5            │   │
│  │ + MaxApPenaltyPercent: int        // floor(C/10) × 5            │   │
│  │ + ResolveDicePenalty: int         // floor(C/20)                │   │
│  │ + TechBonus: int                  // By stage                   │   │
│  │ + SocialPenalty: int              // By stage                   │   │
│  │ + IsFactionLocked: bool           // Corruption >= 50           │   │
│  │ + IsTerminalError: bool           // Corruption >= 100          │   │
│  │ ─────────────────────────────────────────────────────────────── │   │
│  │ + AddCorruption(amount, source): CorruptionAddResult            │   │
│  │ + SetCorruption(value): void      // For deserialization        │   │
│  │ + Create(characterId): CorruptionTracker                        │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
│  NEW: RESULT VALUE OBJECTS                                              │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │                     CorruptionAddResult                          │   │
│  ├─────────────────────────────────────────────────────────────────┤   │
│  │ + PreviousCorruption: int                                        │   │
│  │ + NewCorruption: int                                             │   │
│  │ + AmountGained: int                                              │   │
│  │ + Source: CorruptionSource                                       │   │
│  │ + ThresholdCrossed: int? (25, 50, 75, or null)                   │   │
│  │ + StageCrossed: bool                                             │   │
│  │ + PreviousStage: CorruptionStage                                 │   │
│  │ + NewStage: CorruptionStage                                      │   │
│  │ + IsTerminalError: bool                                          │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │                    TerminalErrorResult                           │   │
│  ├─────────────────────────────────────────────────────────────────┤   │
│  │ + Survived: bool                                                 │   │
│  │ + FinalCorruption: int (99 if survived, 100 if Forlorn)          │   │
│  │ + BecameForlorn: bool                                            │   │
│  │ + SuccessesRolled: int                                           │   │
│  │ + RequiredDc: int                                                │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

### 3.2 Penalty Calculation Flow

```
┌─────────────────────────────────────────────────────────────────────────┐
│                     PENALTY CALCULATION FORMULAS                         │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                          │
│  MaxHpPenaltyPercent = floor(CurrentCorruption / 10) × 5                │
│  MaxApPenaltyPercent = floor(CurrentCorruption / 10) × 5                │
│  ResolveDicePenalty  = floor(CurrentCorruption / 20)                    │
│                                                                          │
│  ┌─────────────────────────────────────────────────────────────────────┐│
│  │ Corruption │ HP Penalty │ AP Penalty │ Resolve Dice │ Example       ││
│  ├────────────┼────────────┼────────────┼──────────────┼───────────────┤│
│  │     0-9    │     0%     │     0%     │      0       │ Pure          ││
│  │   10-19    │     5%     │     5%     │      0       │ Touched       ││
│  │   20-29    │    10%     │    10%     │     -1       │ Tainted       ││
│  │   30-39    │    15%     │    15%     │     -1       │ Marked        ││
│  │   40-49    │    20%     │    20%     │     -2       │ Infected      ││
│  │   50-59    │    25%     │    25%     │     -2       │ Blighted      ││
│  │   60-69    │    30%     │    30%     │     -3       │ Corrupting    ││
│  │   70-79    │    35%     │    35%     │     -3       │ Severe        ││
│  │   80-89    │    40%     │    40%     │     -4       │ Critical      ││
│  │   90-99    │    45%     │    45%     │     -4       │ Terminal      ││
│  │    100     │    50%     │    50%     │     -5       │ ERROR         ││
│  └─────────────────────────────────────────────────────────────────────┘│
│                                                                          │
└─────────────────────────────────────────────────────────────────────────┘
```

### 3.3 Threshold Crossing Detection Flow

```
                     AddCorruption(amount, source)
                                │
                                ▼
                  ┌───────────────────────────┐
                  │ previousCorr = Current    │
                  │ newCorr = Clamp(prev+amt) │
                  └─────────────┬─────────────┘
                                │
                                ▼
              ┌─────────────────────────────────────┐
              │ Check 25 Threshold                  │
              │ prev < 25 && new >= 25 &&           │
              │ !Threshold25Triggered?              │
              └─────────────────┬───────────────────┘
                     │                    │
                    YES                  NO
                     │                    │
                     ▼                    │
        ┌─────────────────────────┐       │
        │ Threshold25Triggered    │       │
        │ = true                  │       │
        │ ThresholdCrossed = 25   │       │
        └─────────────────────────┘       │
                     │                    │
                     └─────────┬──────────┘
                               │
                               ▼
              ┌─────────────────────────────────────┐
              │ Check 50 Threshold                  │
              │ (Same pattern for 50)               │
              └─────────────────┬───────────────────┘
                               │
                               ▼
              ┌─────────────────────────────────────┐
              │ Check 75 Threshold                  │
              │ (Same pattern for 75)               │
              └─────────────────┬───────────────────┘
                               │
                               ▼
              ┌─────────────────────────────────────┐
              │ Check Terminal Error (100)          │
              └─────────────────┬───────────────────┘
                               │
                               ▼
                  ┌───────────────────────────┐
                  │ Return CorruptionAddResult│
                  └───────────────────────────┘
```

### 3.4 Stage Bonus/Penalty Table

```
┌─────────────────────────────────────────────────────────────────────────┐
│                    STAGE-BASED BONUSES & PENALTIES                       │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                          │
│  ┌────────────┬────────────┬─────────────┬──────────────┬─────────────┐ │
│  │   Stage    │ Tech Bonus │ Social Pen  │ Faction Lock │   Notes     │ │
│  ├────────────┼────────────┼─────────────┼──────────────┼─────────────┤ │
│  │Uncorrupted │     +0     │     -0      │      No      │ Pure        │ │
│  │  Tainted   │     +1     │     -1      │      No      │ Signs shown │ │
│  │  Infected  │     +2     │     -2      │     YES      │ Visible     │ │
│  │  Blighted  │     +2     │     -2      │     YES      │ Mutations   │ │
│  │  Corrupted │     +2     │     -2      │     YES      │ Severe      │ │
│  │  Consumed  │     N/A    │     N/A     │     YES      │ TERMINAL    │ │
│  └────────────┴────────────┴─────────────┴──────────────┴─────────────┘ │
│                                                                          │
│  Note: Faction Lock occurs at Corruption >= 50 (Infected+)               │
│        Tech bonus caps at +2, Social penalty caps at -2                  │
│                                                                          │
└─────────────────────────────────────────────────────────────────────────┘
```

---

## 4. User Stories

### US-18.1b-1: Track Per-Character Corruption

**As a** game system
**I want to** maintain corruption state for each character individually
**So that** corruption effects persist across sessions

**Acceptance Criteria:**

- CorruptionTracker has unique Id (IEntity)
- CorruptionTracker references CharacterId
- Corruption value persists between method calls
- Threshold triggers are one-time flags

### US-18.1b-2: Calculate Corruption Penalties

**As a** combat system
**I want to** retrieve computed penalties from corruption
**So that** I can apply them to combat calculations

**Acceptance Criteria:**

- MaxHpPenaltyPercent computed as `floor(Corruption/10) × 5`
- MaxApPenaltyPercent computed as `floor(Corruption/10) × 5`
- ResolveDicePenalty computed as `floor(Corruption/20)`
- Penalties update when corruption changes

### US-18.1b-3: Detect Threshold Crossings

**As a** narrative system
**I want to** know when corruption crosses significant thresholds
**So that** I can trigger appropriate story events

**Acceptance Criteria:**

- Threshold 25 crossing triggers exactly once
- Threshold 50 crossing triggers exactly once
- Threshold 75 crossing triggers exactly once
- ThresholdCrossed in result indicates which was crossed

### US-18.1b-4: Capture Corruption Change Results

**As a** UI developer
**I want to** see complete before/after state when corruption changes
**So that** I can display appropriate feedback

**Acceptance Criteria:**

- CorruptionAddResult includes previous and new values
- Stage transitions detected and reported
- Terminal Error flag set at 100 corruption

---

## 5. CorruptionTracker Entity

### 5.1 Definition

**File:** `src/Core/RuneAndRust.Domain/Entities/CorruptionTracker.cs`

```csharp
namespace RuneAndRust.Domain.Entities;

using RuneAndRust.Domain.Enums;
using RuneAndRust.Domain.Interfaces;
using RuneAndRust.Domain.ValueObjects;

/// <summary>
/// Entity that tracks per-character Runic Blight Corruption accumulation and effects.
/// </summary>
/// <remarks>
/// <para>
/// CorruptionTracker maintains the mutable corruption state for a single character,
/// including threshold trigger history and computed penalty values.
/// </para>
/// <para>
/// Unlike the immutable <see cref="CorruptionState"/> value object, this entity
/// persists state across operations and implements <see cref="IEntity"/>.
/// </para>
/// <para>
/// Key Features:
/// <list type="bullet">
/// <item>Per-character corruption tracking via CharacterId</item>
/// <item>One-time threshold crossing events at 25/50/75</item>
/// <item>Computed penalties: Max HP, Max AP, Resolve Dice</item>
/// <item>Stage-based bonuses: Tech, Social penalties</item>
/// <item>Terminal Error detection at 100 corruption</item>
/// </list>
/// </para>
/// </remarks>
/// <example>
/// <code>
/// // Create tracker for a character
/// var tracker = CorruptionTracker.Create(characterId);
///
/// // Add corruption from a heretical ability
/// var result = tracker.AddCorruption(15, CorruptionSource.HereticalAbility);
///
/// // Check computed penalties
/// Console.WriteLine($"HP Penalty: {tracker.MaxHpPenaltyPercent}%");
/// Console.WriteLine($"Resolve Penalty: -{tracker.ResolveDicePenalty} dice");
/// </code>
/// </example>
public class CorruptionTracker : IEntity
{
    #region Constants

    /// <summary>Minimum corruption value.</summary>
    public const int MinCorruption = 0;

    /// <summary>Maximum corruption value (Terminal Error).</summary>
    public const int MaxCorruption = 100;

    /// <summary>First major threshold crossing.</summary>
    public const int Threshold25 = 25;

    /// <summary>Second major threshold crossing (Faction Lock).</summary>
    public const int Threshold50 = 50;

    /// <summary>Third major threshold crossing.</summary>
    public const int Threshold75 = 75;

    #endregion

    #region Properties

    /// <summary>
    /// Gets the unique identifier for this corruption tracker.
    /// </summary>
    public Guid Id { get; private set; }

    /// <summary>
    /// Gets the identifier of the character this tracker belongs to.
    /// </summary>
    public Guid CharacterId { get; private set; }

    /// <summary>
    /// Gets the current corruption value (0-100).
    /// </summary>
    public int CurrentCorruption { get; private set; }

    /// <summary>
    /// Gets whether the 25% threshold has been triggered.
    /// </summary>
    /// <remarks>
    /// This flag is set exactly once when corruption first crosses 25.
    /// Used to trigger narrative events that should only occur once.
    /// </remarks>
    public bool Threshold25Triggered { get; private set; }

    /// <summary>
    /// Gets whether the 50% threshold has been triggered.
    /// </summary>
    /// <remarks>
    /// This threshold also triggers faction reputation lock.
    /// </remarks>
    public bool Threshold50Triggered { get; private set; }

    /// <summary>
    /// Gets whether the 75% threshold has been triggered.
    /// </summary>
    public bool Threshold75Triggered { get; private set; }

    #endregion

    #region Computed Properties

    /// <summary>
    /// Gets the current corruption stage based on <see cref="CurrentCorruption"/>.
    /// </summary>
    public CorruptionStage Stage => CorruptionState.DetermineStage(CurrentCorruption);

    /// <summary>
    /// Gets the maximum HP percentage penalty.
    /// </summary>
    /// <remarks>
    /// Formula: floor(Corruption / 10) × 5
    /// Range: 0% at 0-9 corruption to 50% at 100 corruption.
    /// </remarks>
    public int MaxHpPenaltyPercent => (CurrentCorruption / 10) * 5;

    /// <summary>
    /// Gets the maximum AP percentage penalty.
    /// </summary>
    /// <remarks>
    /// Formula: floor(Corruption / 10) × 5
    /// Same calculation as HP penalty.
    /// </remarks>
    public int MaxApPenaltyPercent => (CurrentCorruption / 10) * 5;

    /// <summary>
    /// Gets the Resolve dice pool penalty.
    /// </summary>
    /// <remarks>
    /// Formula: floor(Corruption / 20)
    /// Range: 0 at 0-19 corruption to -5 at 100 corruption.
    /// </remarks>
    public int ResolveDicePenalty => CurrentCorruption / 20;

    /// <summary>
    /// Gets the technology interaction bonus based on corruption stage.
    /// </summary>
    /// <remarks>
    /// Corrupted characters have enhanced affinity with malfunctioning tech.
    /// </remarks>
    public int TechBonus => Stage switch
    {
        CorruptionStage.Uncorrupted => 0,
        CorruptionStage.Tainted => 1,
        CorruptionStage.Infected => 2,
        CorruptionStage.Blighted => 2,
        CorruptionStage.Corrupted => 2,
        CorruptionStage.Consumed => 0, // Terminal Error - bonuses irrelevant
        _ => 0
    };

    /// <summary>
    /// Gets the social interaction penalty based on corruption stage.
    /// </summary>
    /// <remarks>
    /// Pure entities and uncorrupted NPCs react negatively to visible corruption.
    /// </remarks>
    public int SocialPenalty => Stage switch
    {
        CorruptionStage.Uncorrupted => 0,
        CorruptionStage.Tainted => -1,
        CorruptionStage.Infected => -2,
        CorruptionStage.Blighted => -2,
        CorruptionStage.Corrupted => -2,
        CorruptionStage.Consumed => 0, // Terminal Error - penalties irrelevant
        _ => 0
    };

    /// <summary>
    /// Gets whether faction reputation changes are locked.
    /// </summary>
    /// <remarks>
    /// At 50+ corruption, the character's reputation with certain factions
    /// can no longer be improved through normal means.
    /// </remarks>
    public bool IsFactionLocked => CurrentCorruption >= Threshold50;

    /// <summary>
    /// Gets whether corruption has reached Terminal Error (100).
    /// </summary>
    /// <remarks>
    /// At Terminal Error, the character must immediately resolve a
    /// Terminal Error check or become Forlorn (unplayable NPC).
    /// </remarks>
    public bool IsTerminalError => CurrentCorruption >= MaxCorruption;

    #endregion

    #region Constructors

    /// <summary>
    /// Private parameterless constructor for EF Core.
    /// </summary>
    private CorruptionTracker()
    {
        Id = Guid.Empty;
        CharacterId = Guid.Empty;
    }

    /// <summary>
    /// Private constructor for factory method.
    /// </summary>
    private CorruptionTracker(Guid characterId)
    {
        Id = Guid.NewGuid();
        CharacterId = characterId;
        CurrentCorruption = MinCorruption;
        Threshold25Triggered = false;
        Threshold50Triggered = false;
        Threshold75Triggered = false;
    }

    #endregion

    #region Factory Methods

    /// <summary>
    /// Creates a new corruption tracker for a character.
    /// </summary>
    /// <param name="characterId">The character to track corruption for.</param>
    /// <returns>A new <see cref="CorruptionTracker"/> with zero corruption.</returns>
    /// <exception cref="ArgumentException">Thrown if characterId is empty.</exception>
    public static CorruptionTracker Create(Guid characterId)
    {
        if (characterId == Guid.Empty)
        {
            throw new ArgumentException("Character ID cannot be empty.", nameof(characterId));
        }

        return new CorruptionTracker(characterId);
    }

    #endregion

    #region Domain Methods

    /// <summary>
    /// Adds corruption to the character.
    /// </summary>
    /// <param name="amount">The amount of corruption to add (can be negative for rare reduction).</param>
    /// <param name="source">The source category of the corruption.</param>
    /// <returns>A <see cref="CorruptionAddResult"/> describing the outcome.</returns>
    /// <example>
    /// <code>
    /// var result = tracker.AddCorruption(15, CorruptionSource.HereticalAbility);
    /// if (result.IsTerminalError)
    ///     InitiateTerminalErrorCheck();
    /// if (result.ThresholdCrossed.HasValue)
    ///     TriggerThresholdEvent(result.ThresholdCrossed.Value);
    /// </code>
    /// </example>
    public CorruptionAddResult AddCorruption(int amount, CorruptionSource source)
    {
        var previousCorruption = CurrentCorruption;
        var previousStage = Stage;

        // Calculate new corruption, clamped to valid range
        var newCorruption = Math.Clamp(CurrentCorruption + amount, MinCorruption, MaxCorruption);
        CurrentCorruption = newCorruption;

        // Detect threshold crossings (one-time triggers)
        int? thresholdCrossed = null;

        if (!Threshold25Triggered && previousCorruption < Threshold25 && newCorruption >= Threshold25)
        {
            Threshold25Triggered = true;
            thresholdCrossed = Threshold25;
        }
        else if (!Threshold50Triggered && previousCorruption < Threshold50 && newCorruption >= Threshold50)
        {
            Threshold50Triggered = true;
            thresholdCrossed = Threshold50;
        }
        else if (!Threshold75Triggered && previousCorruption < Threshold75 && newCorruption >= Threshold75)
        {
            Threshold75Triggered = true;
            thresholdCrossed = Threshold75;
        }

        var newStage = Stage;
        var stageCrossed = newStage != previousStage;

        return CorruptionAddResult.Create(
            previousCorruption: previousCorruption,
            newCorruption: newCorruption,
            source: source,
            thresholdCrossed: thresholdCrossed,
            previousStage: previousStage,
            newStage: newStage);
    }

    /// <summary>
    /// Sets the corruption value directly (for deserialization/testing).
    /// </summary>
    /// <param name="value">The corruption value to set.</param>
    /// <remarks>
    /// This method bypasses threshold trigger logic. Use only for
    /// persistence reconstitution or test setup.
    /// </remarks>
    internal void SetCorruption(int value)
    {
        CurrentCorruption = Math.Clamp(value, MinCorruption, MaxCorruption);
    }

    /// <summary>
    /// Sets threshold trigger flags directly (for deserialization).
    /// </summary>
    internal void SetThresholdTriggers(bool t25, bool t50, bool t75)
    {
        Threshold25Triggered = t25;
        Threshold50Triggered = t50;
        Threshold75Triggered = t75;
    }

    #endregion

    #region Object Overrides

    /// <inheritdoc/>
    public override string ToString() =>
        $"CorruptionTracker[{CharacterId}]: {CurrentCorruption}/{MaxCorruption} [{Stage}]" +
        $" HP:-{MaxHpPenaltyPercent}% AP:-{MaxApPenaltyPercent}% Resolve:-{ResolveDicePenalty}" +
        (IsTerminalError ? " [TERMINAL ERROR]" : "") +
        (IsFactionLocked ? " [FACTION LOCKED]" : "");

    #endregion
}
```

---

## 6. CorruptionAddResult Record

### 6.1 Definition

**File:** `src/Core/RuneAndRust.Domain/ValueObjects/CorruptionAddResult.cs`

```csharp
namespace RuneAndRust.Domain.ValueObjects;

using RuneAndRust.Domain.Enums;

/// <summary>
/// Represents the result of adding corruption to a character.
/// </summary>
/// <remarks>
/// <para>
/// This immutable record captures the complete before/after state of a
/// corruption change, including threshold crossings and stage transitions.
/// </para>
/// <para>
/// Key information captured:
/// <list type="bullet">
/// <item>Previous and new corruption values</item>
/// <item>Corruption source for tracking</item>
/// <item>Threshold crossing (25/50/75 or null)</item>
/// <item>Stage transition detection</item>
/// <item>Terminal Error flag</item>
/// </list>
/// </para>
/// </remarks>
/// <example>
/// <code>
/// var result = tracker.AddCorruption(20, CorruptionSource.BlightExposure);
///
/// if (result.ThresholdCrossed.HasValue)
///     Console.WriteLine($"Crossed {result.ThresholdCrossed}% threshold!");
///
/// if (result.StageCrossed)
///     Console.WriteLine($"Stage changed: {result.PreviousStage} → {result.NewStage}");
///
/// if (result.IsTerminalError)
///     Console.WriteLine("TERMINAL ERROR - Initiate survival check!");
/// </code>
/// </example>
public readonly record struct CorruptionAddResult
{
    /// <summary>
    /// Gets the corruption value before the change.
    /// </summary>
    public int PreviousCorruption { get; }

    /// <summary>
    /// Gets the corruption value after the change.
    /// </summary>
    public int NewCorruption { get; }

    /// <summary>
    /// Gets the actual amount of corruption gained (after clamping).
    /// </summary>
    public int AmountGained { get; }

    /// <summary>
    /// Gets the source category of the corruption.
    /// </summary>
    public CorruptionSource Source { get; }

    /// <summary>
    /// Gets the threshold that was crossed, if any (25, 50, 75, or null).
    /// </summary>
    /// <remarks>
    /// Each threshold can only be crossed once per character lifetime.
    /// Used to trigger narrative events and unlock certain mechanics.
    /// </remarks>
    public int? ThresholdCrossed { get; }

    /// <summary>
    /// Gets whether a stage boundary was crossed.
    /// </summary>
    public bool StageCrossed { get; }

    /// <summary>
    /// Gets the corruption stage before the change.
    /// </summary>
    public CorruptionStage PreviousStage { get; }

    /// <summary>
    /// Gets the corruption stage after the change.
    /// </summary>
    public CorruptionStage NewStage { get; }

    /// <summary>
    /// Gets whether corruption reached 100 (Terminal Error).
    /// </summary>
    public bool IsTerminalError { get; }

    /// <summary>
    /// Gets whether faction reputation is now locked.
    /// </summary>
    public bool NowFactionLocked => NewCorruption >= 50 && PreviousCorruption < 50;

    /// <summary>
    /// Private constructor to enforce factory pattern.
    /// </summary>
    private CorruptionAddResult(
        int previousCorruption,
        int newCorruption,
        CorruptionSource source,
        int? thresholdCrossed,
        CorruptionStage previousStage,
        CorruptionStage newStage)
    {
        PreviousCorruption = previousCorruption;
        NewCorruption = newCorruption;
        AmountGained = newCorruption - previousCorruption;
        Source = source;
        ThresholdCrossed = thresholdCrossed;
        StageCrossed = newStage != previousStage;
        PreviousStage = previousStage;
        NewStage = newStage;
        IsTerminalError = newCorruption >= CorruptionTracker.MaxCorruption;
    }

    /// <summary>
    /// Creates a corruption add result.
    /// </summary>
    public static CorruptionAddResult Create(
        int previousCorruption,
        int newCorruption,
        CorruptionSource source,
        int? thresholdCrossed,
        CorruptionStage previousStage,
        CorruptionStage newStage) =>
        new(previousCorruption, newCorruption, source, thresholdCrossed, previousStage, newStage);

    /// <inheritdoc/>
    public override string ToString() =>
        $"Corruption: {PreviousCorruption} → {NewCorruption} [{Source}]" +
        (ThresholdCrossed.HasValue ? $" (Crossed {ThresholdCrossed}%)" : "") +
        (StageCrossed ? $" Stage: {PreviousStage} → {NewStage}" : "") +
        (IsTerminalError ? " [TERMINAL ERROR!]" : "");
}
```

---

## 7. TerminalErrorResult Record

### 7.1 Definition

**File:** `src/Core/RuneAndRust.Domain/ValueObjects/TerminalErrorResult.cs`

```csharp
namespace RuneAndRust.Domain.ValueObjects;

/// <summary>
/// Represents the result of a Terminal Error survival check.
/// </summary>
/// <remarks>
/// <para>
/// When corruption reaches 100, the character must make a Terminal Error check
/// to avoid becoming Forlorn (lost to the Blight). This record captures the
/// outcome of that check.
/// </para>
/// <para>
/// Terminal Error Check Mechanics:
/// <list type="bullet">
/// <item>Roll: WILL dice pool vs DC (default 3)</item>
/// <item>Success: Character survives, corruption set to 99</item>
/// <item>Failure: Character becomes Forlorn (unplayable NPC)</item>
/// </list>
/// </para>
/// </remarks>
/// <example>
/// <code>
/// var result = TerminalErrorResult.Survived(successes: 4, dc: 3);
/// if (result.Survived)
///     Console.WriteLine($"Barely escaped! Corruption reduced to {result.FinalCorruption}");
/// else
///     Console.WriteLine("Character lost to the Blight...");
/// </code>
/// </example>
public readonly record struct TerminalErrorResult
{
    /// <summary>
    /// Gets whether the character survived the Terminal Error.
    /// </summary>
    public bool Survived { get; }

    /// <summary>
    /// Gets the final corruption value after resolution.
    /// </summary>
    /// <remarks>
    /// If survived: 99 (just below terminal)
    /// If failed: 100 (character is Forlorn)
    /// </remarks>
    public int FinalCorruption { get; }

    /// <summary>
    /// Gets whether the character became Forlorn (lost to the Blight).
    /// </summary>
    /// <remarks>
    /// A Forlorn character is an unplayable NPC, controlled by the GM.
    /// The character may appear as an antagonist in future encounters.
    /// </remarks>
    public bool BecameForlorn { get; }

    /// <summary>
    /// Gets the number of successes rolled on the survival check.
    /// </summary>
    public int SuccessesRolled { get; }

    /// <summary>
    /// Gets the difficulty class that was required.
    /// </summary>
    public int RequiredDc { get; }

    /// <summary>
    /// Gets whether the check was a critical success (double required successes).
    /// </summary>
    public bool WasCriticalSuccess => Survived && SuccessesRolled >= RequiredDc * 2;

    /// <summary>
    /// Private constructor to enforce factory pattern.
    /// </summary>
    private TerminalErrorResult(
        bool survived,
        int finalCorruption,
        int successesRolled,
        int requiredDc)
    {
        Survived = survived;
        FinalCorruption = finalCorruption;
        BecameForlorn = !survived;
        SuccessesRolled = successesRolled;
        RequiredDc = requiredDc;
    }

    /// <summary>
    /// Creates a result for a successful survival check.
    /// </summary>
    /// <param name="successes">Number of successes rolled.</param>
    /// <param name="dc">The required DC (default 3).</param>
    /// <returns>A survival result with corruption set to 99.</returns>
    public static TerminalErrorResult Success(int successes, int dc = 3) =>
        new(survived: true, finalCorruption: 99, successesRolled: successes, requiredDc: dc);

    /// <summary>
    /// Creates a result for a failed survival check.
    /// </summary>
    /// <param name="successes">Number of successes rolled.</param>
    /// <param name="dc">The required DC (default 3).</param>
    /// <returns>A failure result indicating the character became Forlorn.</returns>
    public static TerminalErrorResult Failure(int successes, int dc = 3) =>
        new(survived: false, finalCorruption: 100, successesRolled: successes, requiredDc: dc);

    /// <inheritdoc/>
    public override string ToString() =>
        Survived
            ? $"Terminal Error SURVIVED: {SuccessesRolled}/{RequiredDc} successes, corruption → {FinalCorruption}" +
              (WasCriticalSuccess ? " [CRITICAL]" : "")
            : $"Terminal Error FAILED: {SuccessesRolled}/{RequiredDc} successes - CHARACTER BECAME FORLORN";
}
```

---

## 8. Logging Specifications

### 8.1 Log Events

| Event                  | Level       | Template                                                                                    | Properties                                 |
| ---------------------- | ----------- | ------------------------------------------------------------------------------------------- | ------------------------------------------ |
| Corruption Added       | Information | `"Corruption added for {CharacterId}: +{Amount} [{Source}] ({Previous} → {New})"`           | CharacterId, Amount, Source, Previous, New |
| Threshold Crossed      | Warning     | `"Corruption threshold {Threshold}% crossed for {CharacterId}"`                             | Threshold, CharacterId                     |
| Stage Changed          | Information | `"Corruption stage changed for {CharacterId}: {PreviousStage} → {NewStage}"`                | CharacterId, PreviousStage, NewStage       |
| Faction Locked         | Warning     | `"Faction reputation LOCKED for {CharacterId}: Corruption at {Corruption}"`                 | CharacterId, Corruption                    |
| Terminal Error         | Error       | `"TERMINAL ERROR for {CharacterId}: Corruption at 100 - survival check required"`           | CharacterId                                |
| Survival Check Success | Warning     | `"Terminal Error SURVIVED for {CharacterId}: {Successes}/{DC} successes, corruption → 99"`  | CharacterId, Successes, DC                 |
| Survival Check Failure | Error       | `"Terminal Error FAILED for {CharacterId}: {Successes}/{DC} successes - CHARACTER FORLORN"` | CharacterId, Successes, DC                 |

> **Note:** CorruptionTracker is a domain entity and does not perform logging directly.
> Logging occurs in the service layer (v0.18.1d).

---

## 9. Unit Testing Requirements

### 9.1 Test Count by Feature

| Feature                  | Test Count |
| ------------------------ | ---------- |
| CorruptionTracker Entity | ~3         |
| CorruptionAddResult      | ~1         |
| TerminalErrorResult      | ~1         |
| **Total**                | **~5**     |

### 9.2 CorruptionTrackerTests

**File:** `tests/RuneAndRust.Domain.UnitTests/Entities/CorruptionTrackerTests.cs`

```csharp
namespace RuneAndRust.Domain.UnitTests.Entities;

using FluentAssertions;
using NUnit.Framework;
using RuneAndRust.Domain.Entities;
using RuneAndRust.Domain.Enums;

[TestFixture]
public class CorruptionTrackerTests
{
    #region Penalty Calculation Tests

    [Test]
    [TestCase(0, 0, 0, 0)]
    [TestCase(10, 5, 5, 0)]
    [TestCase(25, 10, 10, 1)]
    [TestCase(45, 20, 20, 2)]
    [TestCase(60, 30, 30, 3)]
    [TestCase(85, 40, 40, 4)]
    [TestCase(100, 50, 50, 5)]
    public void PenaltyProperties_CalculateCorrectly(
        int corruption,
        int expectedHpPenalty,
        int expectedApPenalty,
        int expectedResolvePenalty)
    {
        // Arrange
        var tracker = CorruptionTracker.Create(Guid.NewGuid());
        tracker.SetCorruption(corruption);

        // Assert
        tracker.MaxHpPenaltyPercent.Should().Be(expectedHpPenalty);
        tracker.MaxApPenaltyPercent.Should().Be(expectedApPenalty);
        tracker.ResolveDicePenalty.Should().Be(expectedResolvePenalty);
    }

    #endregion

    #region Threshold Crossing Tests

    [Test]
    public void AddCorruption_CrossingThreshold25_TriggersOnce()
    {
        // Arrange
        var tracker = CorruptionTracker.Create(Guid.NewGuid());

        // Act - First crossing
        var result1 = tracker.AddCorruption(30, CorruptionSource.BlightExposure);

        // Assert - First crossing detected
        result1.ThresholdCrossed.Should().Be(25);
        tracker.Threshold25Triggered.Should().BeTrue();

        // Act - Second addition (already past threshold)
        tracker.SetCorruption(20); // Reset for test
        tracker.SetThresholdTriggers(true, false, false);
        var result2 = tracker.AddCorruption(10, CorruptionSource.BlightExposure);

        // Assert - Threshold not triggered again
        result2.ThresholdCrossed.Should().BeNull();
    }

    #endregion

    #region Stage and Faction Tests

    [Test]
    [TestCase(49, false)]
    [TestCase(50, true)]
    [TestCase(75, true)]
    public void IsFactionLocked_CorrectAtThreshold(int corruption, bool expectedLocked)
    {
        // Arrange
        var tracker = CorruptionTracker.Create(Guid.NewGuid());
        tracker.SetCorruption(corruption);

        // Assert
        tracker.IsFactionLocked.Should().Be(expectedLocked);
    }

    #endregion
}
```

### 9.3 CorruptionAddResultTests

**File:** `tests/RuneAndRust.Domain.UnitTests/ValueObjects/CorruptionAddResultTests.cs`

```csharp
namespace RuneAndRust.Domain.UnitTests.ValueObjects;

using FluentAssertions;
using NUnit.Framework;
using RuneAndRust.Domain.Entities;
using RuneAndRust.Domain.Enums;

[TestFixture]
public class CorruptionAddResultTests
{
    [Test]
    [TestCase(35, 65, true)]        // Tainted → Blighted
    [TestCase(35, 38, false)]       // Tainted → Tainted (same stage)
    [TestCase(0, 15, false)]        // Uncorrupted → Uncorrupted
    [TestCase(95, 100, true)]       // Corrupted → Consumed (Terminal Error)
    public void AddCorruption_DetectsStageCrossingCorrectly(
        int previousCorruption,
        int addAmount,
        bool expectedStageCrossed)
    {
        // Arrange
        var tracker = CorruptionTracker.Create(Guid.NewGuid());
        tracker.SetCorruption(previousCorruption);

        // Act
        var result = tracker.AddCorruption(addAmount, CorruptionSource.MysticMagic);

        // Assert
        result.StageCrossed.Should().Be(expectedStageCrossed);
    }
}
```

### 9.4 TerminalErrorResultTests

**File:** `tests/RuneAndRust.Domain.UnitTests/ValueObjects/TerminalErrorResultTests.cs`

```csharp
namespace RuneAndRust.Domain.UnitTests.ValueObjects;

using FluentAssertions;
using NUnit.Framework;
using RuneAndRust.Domain.ValueObjects;

[TestFixture]
public class TerminalErrorResultTests
{
    [Test]
    public void Success_CreatesCorrectResult()
    {
        // Arrange & Act
        var result = TerminalErrorResult.Success(successes: 4, dc: 3);

        // Assert
        result.Survived.Should().BeTrue();
        result.BecameForlorn.Should().BeFalse();
        result.FinalCorruption.Should().Be(99);
        result.SuccessesRolled.Should().Be(4);
        result.RequiredDc.Should().Be(3);
    }

    [Test]
    public void Failure_CreatesCorrectResult()
    {
        // Arrange & Act
        var result = TerminalErrorResult.Failure(successes: 2, dc: 3);

        // Assert
        result.Survived.Should().BeFalse();
        result.BecameForlorn.Should().BeTrue();
        result.FinalCorruption.Should().Be(100);
    }

    [Test]
    public void WasCriticalSuccess_DetectsCorrectly()
    {
        // Arrange & Act
        var critSuccess = TerminalErrorResult.Success(successes: 6, dc: 3);
        var normalSuccess = TerminalErrorResult.Success(successes: 4, dc: 3);

        // Assert
        critSuccess.WasCriticalSuccess.Should().BeTrue();
        normalSuccess.WasCriticalSuccess.Should().BeFalse();
    }
}
```

---

## 10. Use Cases

### UC-001: Apply Heretical Ability Corruption

**Actor:** CombatService
**Precondition:** Character uses a Berserker or Blót-Priest ability
**Flow:**

1. Determine corruption amount from ability definition
2. Call `tracker.AddCorruption(amount, CorruptionSource.HereticalAbility)`
3. Check result for threshold crossings
4. Check result for Terminal Error
5. Update UI with new penalties

**Postcondition:** Corruption tracked, events triggered appropriately

### UC-002: Check Faction Lock Status

**Actor:** ReputationService
**Precondition:** Character attempts to gain faction reputation
**Flow:**

1. Query `tracker.IsFactionLocked`
2. If locked, prevent reputation gain
3. Display appropriate message

**Postcondition:** Faction reputation change blocked if corruption ≥ 50

### UC-003: Process Terminal Error

**Actor:** CorruptionService (v0.18.1d)
**Precondition:** Corruption reaches 100
**Flow:**

1. Detect `IsTerminalError` flag
2. Roll WILL dice pool vs DC 3
3. Create `TerminalErrorResult` based on outcome
4. If survived, set corruption to 99
5. If failed, mark character as Forlorn

**Postcondition:** Character either survives at 99 corruption or becomes Forlorn NPC

---

## 11. Deliverable Checklist

### Domain Layer — Entity

- [x] `src/Core/RuneAndRust.Domain/Entities/CorruptionTracker.cs`

### Domain Layer — Value Objects

- [x] `src/Core/RuneAndRust.Domain/ValueObjects/CorruptionAddResult.cs`
- [x] `src/Core/RuneAndRust.Domain/ValueObjects/TerminalErrorResult.cs`

### Unit Tests

- [x] `tests/RuneAndRust.Domain.UnitTests/Entities/CorruptionTrackerTests.cs`
- [x] `tests/RuneAndRust.Domain.UnitTests/ValueObjects/CorruptionAddResultTests.cs`
- [x] `tests/RuneAndRust.Domain.UnitTests/ValueObjects/TerminalErrorResultTests.cs`

### Documentation

- [x] XML documentation on all public members
- [x] Code examples in remarks sections
- [x] Update scope breakdown to mark v0.18.1b complete

---

## 12. Acceptance Criteria

### Functional Criteria

- [x] `CorruptionTracker.MaxHpPenaltyPercent` equals `floor(Corruption/10) × 5`
- [x] `CorruptionTracker.MaxApPenaltyPercent` equals `floor(Corruption/10) × 5`
- [x] `CorruptionTracker.ResolveDicePenalty` equals `floor(Corruption/20)`
- [x] `CorruptionTracker.TechBonus` returns stage-appropriate bonus (0/+1/+2)
- [x] `CorruptionTracker.SocialPenalty` returns stage-appropriate penalty (0/-1/-2)
- [x] `CorruptionTracker.IsFactionLocked` is `true` when corruption ≥ 50
- [x] `CorruptionTracker.IsTerminalError` is `true` when corruption = 100
- [x] Threshold 25/50/75 crossings trigger exactly once per character
- [x] `CorruptionAddResult` correctly captures stage transitions
- [x] `TerminalErrorResult.Success` sets corruption to 99
- [x] `TerminalErrorResult.Failure` marks character as Forlorn

### Quality Criteria

- [x] Build succeeds with 0 errors
- [x] Build succeeds with 0 warnings
- [x] All ~5 unit tests pass (59 actual test methods, 140 test case executions)
- [x] XML documentation complete on all public types and members
- [x] Code follows project conventions

---

## 13. Dependencies

### Required from v0.18.1a

| Type               | Usage                                      |
| ------------------ | ------------------------------------------ |
| `CorruptionStage`  | Stage enum for computed properties         |
| `CorruptionSource` | Source categorization for AddCorruption    |
| `CorruptionState`  | `DetermineStage()` method for stage lookup |

### Provides to v0.18.1c

| Type                  | Usage                                   |
| --------------------- | --------------------------------------- |
| `CorruptionTracker`   | Entity managed by `ICorruptionService`  |
| `CorruptionAddResult` | Return type for service methods         |
| `TerminalErrorResult` | Return type for Terminal Error handling |

---

## 14. Future Considerations

### Deferred to v0.18.1c

- `ICorruptionService` interface using these types

### Deferred to v0.18.1d

- `CorruptionService` implementation with full logging
- `CorruptionTransferResult` for Blót-Priest mechanics

### Deferred to v0.18.1e

- Database persistence configuration
- JSON configuration for thresholds

### Out of Scope

- Mutation table implementation (v0.18.3)
- Stress-Corruption interaction (v0.18.5)
- UI corruption display (presentation layer)

---

_Document Version: 1.0_
_Last Updated: 2026-01-27_
