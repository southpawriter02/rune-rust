# v0.16.2d Design Specification: Penalty Calculation Service

**Version:** 0.16.2d  
**Phase Name:** Penalty Calculation Service  
**Parent Version:** v0.16.2 (Armor Proficiency System)  
**Prerequisites:** v0.16.2a (Levels), v0.16.2b (Categories), v0.16.2c (Archetype Matrix)  
**Estimated Tests:** ~4 unit tests

---

## Table of Contents

1. [Executive Summary](#1-executive-summary)
2. [Feature Overview](#2-feature-overview)
3. [Architecture Diagrams](#3-architecture-diagrams)
4. [EffectiveArmorPenalties Value Object](#4-effectivearmorpenalties-value-object)
5. [IArmorPenaltyCalculator Interface](#5-iarmorpenaltycalculator-interface)
6. [ArmorPenaltyCalculator Service](#6-armorpenaltycalculator-service)
7. [Data Model Changes](#7-data-model-changes)
8. [Logging Specifications](#8-logging-specifications)
9. [Unit Testing Requirements](#9-unit-testing-requirements)
10. [Use Cases](#10-use-cases)
11. [Deliverable Checklist](#11-deliverable-checklist)
12. [Acceptance Criteria](#12-acceptance-criteria)
13. [Dependencies](#13-dependencies)
14. [Future Considerations](#14-future-considerations)

---

## 1. Executive Summary

### 1.1 Purpose

This specification defines the penalty calculation service that combines armor category base penalties with proficiency level modifiers. The service applies tier reduction for Expert/Master proficiency and penalty doubling for NonProficient characters.

**Key Calculation Rules:**

1. **NonProficient**: Penalties doubled (2.0x multiplier), -2 attack modifier
2. **Proficient**: Normal penalties (1.0x), no attack modifier
3. **Expert**: Tier reduced by 1 (Heavy → Medium penalties), 1.0x multiplier
4. **Master**: Tier reduced by 1, +1 Defense bonus, 1.0x multiplier

**Example Calculations:**

| Situation              | Base Penalties     | Effective Penalties              |
| ---------------------- | ------------------ | -------------------------------- |
| NonProficient in Heavy | -2d10 Agi, +5 Stam | -4d10 Agi, +10 Stam, -2 Atk      |
| Expert in Heavy        | -2d10 Agi, +5 Stam | -1d10 Agi, +2 Stam (Medium tier) |
| Master in Heavy        | -2d10 Agi, +5 Stam | -1d10 Agi, +2 Stam, +1 Def       |

### 1.2 Key Deliverables

| Category          | Items                     |
| ----------------- | ------------------------- |
| **Value Objects** | `EffectiveArmorPenalties` |
| **Interfaces**    | `IArmorPenaltyCalculator` |
| **Services**      | `ArmorPenaltyCalculator`  |
| **Tests**         | ~4 unit tests             |

### 1.3 Architectural Significance

This version establishes the **Penalty Calculation Pipeline**:

- **Input**: Armor category + Character proficiency level
- **Processing**: Tier reduction → Base penalty lookup → Multiplier application
- **Output**: `EffectiveArmorPenalties` with all calculated modifiers

The calculator service orchestrates all previously created components:

- `IArmorProficiencyEffectProvider` (v0.16.2a) for proficiency modifiers
- `IArmorCategoryProvider` (v0.16.2b) for base penalties
- `IArchetypeArmorProficiencyProvider` (v0.16.2c) for archetype lookups

---

## 2. Feature Overview

```
v0.16.2d Penalty Calculation Service
├── EffectiveArmorPenalties Value Object
│   ├── BasePenalties: ArmorPenalties
│   ├── EffectivePenalties: ArmorPenalties (after modifiers)
│   ├── ProficiencyLevel: ArmorProficiencyLevel
│   ├── WasMultiplied: bool (true if NonProficient)
│   ├── WasTierReduced: bool (true if Expert/Master)
│   ├── AttackModifier: int (from proficiency)
│   ├── DefenseModifier: int (from proficiency)
│   └── EffectiveTier: int (after reduction)
├── IArmorPenaltyCalculator Interface
│   ├── CalculatePenalties(category, level): EffectiveArmorPenalties
│   ├── CalculateForCharacter(character, armor): EffectiveArmorPenalties
│   └── GetEffectiveTier(category, level): int
└── ArmorPenaltyCalculator Service
    ├── Dependencies: IArmorCategoryProvider, IArmorProficiencyEffectProvider
    ├── ApplyTierReduction(): Uses reduced tier for penalty lookup
    ├── ApplyMultiplier(): Doubles penalties for NonProficient
    └── ApplyModifiers(): Adds attack/defense modifiers
```

### 2.1 Calculation Pipeline

```
┌─────────────────────────────────────────────────────────────────────┐
│                    PENALTY CALCULATION PIPELINE                      │
└─────────────────────────────────────────────────────────────────────┘

    INPUT: ArmorCategory + ArmorProficiencyLevel
           │
           ▼
    ┌──────────────────────────────────────────────────────────────────┐
    │  STEP 1: GET PROFICIENCY EFFECT                                  │
    ├──────────────────────────────────────────────────────────────────┤
    │  From IArmorProficiencyEffectProvider:                           │
    │  - PenaltyMultiplier (1.0 or 2.0)                                │
    │  - TierReduction (0 or 1)                                        │
    │  - AttackModifier (-2 to 0)                                      │
    │  - DefenseModifier (0 to +1)                                     │
    └──────────────────────────────────────────────────────────────────┘
           │
           ▼
    ┌──────────────────────────────────────────────────────────────────┐
    │  STEP 2: APPLY TIER REDUCTION                                    │
    ├──────────────────────────────────────────────────────────────────┤
    │  EffectiveTier = BaseTier - TierReduction                        │
    │  EffectiveTier = Max(0, EffectiveTier)  // Cannot go below Light │
    │                                                                  │
    │  Example: Heavy (Tier 2), Expert (Reduction 1)                   │
    │           EffectiveTier = 2 - 1 = 1 (Medium)                     │
    └──────────────────────────────────────────────────────────────────┘
           │
           ▼
    ┌──────────────────────────────────────────────────────────────────┐
    │  STEP 3: GET BASE PENALTIES FOR EFFECTIVE TIER                   │
    ├──────────────────────────────────────────────────────────────────┤
    │  From IArmorCategoryProvider:                                    │
    │  - If EffectiveTier == 0: Light penalties (none)                 │
    │  - If EffectiveTier == 1: Medium penalties                       │
    │  - If EffectiveTier == 2: Heavy penalties                        │
    └──────────────────────────────────────────────────────────────────┘
           │
           ▼
    ┌──────────────────────────────────────────────────────────────────┐
    │  STEP 4: APPLY PENALTY MULTIPLIER                                │
    ├──────────────────────────────────────────────────────────────────┤
    │  EffectivePenalties = BasePenalties × PenaltyMultiplier          │
    │                                                                  │
    │  NonProficient: All numerical penalties doubled                  │
    │  Proficient/Expert/Master: No change (1.0x)                      │
    └──────────────────────────────────────────────────────────────────┘
           │
           ▼
    ┌──────────────────────────────────────────────────────────────────┐
    │  STEP 5: BUILD RESULT                                            │
    ├──────────────────────────────────────────────────────────────────┤
    │  EffectiveArmorPenalties {                                       │
    │    BasePenalties: Original category penalties                    │
    │    EffectivePenalties: After tier reduction + multiplier         │
    │    AttackModifier: From proficiency effect                       │
    │    DefenseModifier: From proficiency effect                      │
    │    WasMultiplied: PenaltyMultiplier > 1.0                        │
    │    WasTierReduced: TierReduction > 0                             │
    │  }                                                               │
    └──────────────────────────────────────────────────────────────────┘
           │
           ▼
    OUTPUT: EffectiveArmorPenalties
```

### 2.2 Scope Alignment

**In Scope:**

- `EffectiveArmorPenalties` value object for calculation results
- `IArmorPenaltyCalculator` interface for penalty calculation
- `ArmorPenaltyCalculator` service implementation
- Tier reduction logic (Expert/Master: Heavy → Medium)
- Penalty doubling logic (NonProficient: 2.0x)
- Attack/Defense modifier application

**Out of Scope:**

- Proficiency acquisition (v0.16.2e)
- Combat integration (v0.16.2f)
- Actual combat penalty application

---

## 3. Architecture Diagrams

### 3.1 Penalty Calculator System Overview

```
┌─────────────────────────────────────────────────────────────────────┐
│               PENALTY CALCULATOR SYSTEM OVERVIEW                     │
└─────────────────────────────────────────────────────────────────────┘

    Character (has Archetype)  +  Armor (has Category)
           │                             │
           │  Get proficiency level      │  Get category
           ▼                             ▼
┌──────────────────────────┐   ┌──────────────────────────┐
│ IArchetypeArmorProvider  │   │   IArmorCategoryProvider │
│       (v0.16.2c)         │   │        (v0.16.2b)        │
└──────────────────────────┘   └──────────────────────────┘
           │                             │
           │  ArmorProficiencyLevel      │  ArmorCategory
           ▼                             ▼
┌─────────────────────────────────────────────────────────────────────┐
│                     IArmorPenaltyCalculator                          │
├─────────────────────────────────────────────────────────────────────┤
│  + CalculatePenalties(category, level): EffectiveArmorPenalties     │
│  + CalculateForCharacter(character, armor): EffectiveArmorPenalties │
│  + GetEffectiveTier(category, level): int                           │
└─────────────────────────────────────────────────────────────────────┘
           │
           │  Uses for proficiency effects
           ▼
┌─────────────────────────────────────────────────────────────────────┐
│                  IArmorProficiencyEffectProvider                     │
│                         (v0.16.2a)                                   │
├─────────────────────────────────────────────────────────────────────┤
│  + GetEffect(level): ArmorProficiencyEffect                         │
│  + GetPenaltyMultiplier(level): decimal                             │
│  + GetTierReduction(level): int                                     │
│  + GetAttackModifier(level): int                                    │
│  + GetDefenseModifier(level): int                                   │
└─────────────────────────────────────────────────────────────────────┘
           │
           │  Returns calculated result
           ▼
┌─────────────────────────────────────────────────────────────────────┐
│                     EffectiveArmorPenalties                          │
├─────────────────────────────────────────────────────────────────────┤
│  BasePenalties: ArmorPenalties       (original category penalties)  │
│  EffectivePenalties: ArmorPenalties  (after all modifiers)          │
│  ProficiencyLevel: ArmorProficiencyLevel                            │
│  AttackModifier: int                 (-2 for NonProficient)         │
│  DefenseModifier: int                (+1 for Master)                │
│  EffectiveTier: int                  (after reduction)              │
│  WasMultiplied: bool                 (true if 2.0x applied)         │
│  WasTierReduced: bool                (true if tier lowered)         │
└─────────────────────────────────────────────────────────────────────┘
```

### 3.2 Tier Reduction Decision Tree

```
┌─────────────────────────────────────────────────────────────────────┐
│                   TIER REDUCTION DECISION TREE                       │
└─────────────────────────────────────────────────────────────────────┘

    Get ArmorCategory and ArmorProficiencyLevel
           │
           ▼
    ┌──────────────────────────────────────────────────────────────────┐
    │  IS CATEGORY TIERED? (Light/Medium/Heavy)                        │
    ├──────────────────────────────────────────────────────────────────┤
    │    Shields → NO tier reduction applies (use base Shield penalty)│
    │    Specialized → NO tier reduction (use Specialized penalty)    │
    │    Light/Medium/Heavy → Continue                                 │
    └──────────────────────────────────────────────────────────────────┘
           │ Tiered category
           ▼
    ┌──────────────────────────────────────────────────────────────────┐
    │  GET TIER REDUCTION FROM PROFICIENCY                             │
    ├──────────────────────────────────────────────────────────────────┤
    │    NonProficient → TierReduction = 0                             │
    │    Proficient    → TierReduction = 0                             │
    │    Expert        → TierReduction = 1                             │
    │    Master        → TierReduction = 1                             │
    └──────────────────────────────────────────────────────────────────┘
           │
           ▼
    ┌──────────────────────────────────────────────────────────────────┐
    │  CALCULATE EFFECTIVE TIER                                        │
    ├──────────────────────────────────────────────────────────────────┤
    │  BaseTier = Category.WeightTier (Light=0, Medium=1, Heavy=2)     │
    │  EffectiveTier = Max(0, BaseTier - TierReduction)                │
    │                                                                  │
    │  Examples:                                                       │
    │  - Heavy(2) + Expert(reduce 1) = Tier 1 (Medium penalties)       │
    │  - Medium(1) + Master(reduce 1) = Tier 0 (Light/no penalties)    │
    │  - Light(0) + Expert(reduce 1) = Tier 0 (already minimum)        │
    └──────────────────────────────────────────────────────────────────┘
           │
           ▼
    ┌──────────────────────────────────────────────────────────────────┐
    │  GET PENALTIES FOR EFFECTIVE TIER                                │
    ├──────────────────────────────────────────────────────────────────┤
    │  Tier 0 → ArmorPenalties.None (Light)                            │
    │  Tier 1 → Medium penalties: -1d10 Agi, +2 Stam, -5 ft            │
    │  Tier 2 → Heavy penalties: -2d10 Agi, +5 Stam, -10 ft            │
    └──────────────────────────────────────────────────────────────────┘
```

### 3.3 Penalty Multiplier Flow

```
┌─────────────────────────────────────────────────────────────────────┐
│                   PENALTY MULTIPLIER FLOW                            │
└─────────────────────────────────────────────────────────────────────┘

    Get Penalties for Effective Tier (from Step 2)
           │
           ▼
    ┌──────────────────────────────────────────────────────────────────┐
    │  GET PENALTY MULTIPLIER FROM PROFICIENCY LEVEL                   │
    ├──────────────────────────────────────────────────────────────────┤
    │    NonProficient → PenaltyMultiplier = 2.0                       │
    │    Proficient    → PenaltyMultiplier = 1.0                       │
    │    Expert        → PenaltyMultiplier = 1.0                       │
    │    Master        → PenaltyMultiplier = 1.0                       │
    └──────────────────────────────────────────────────────────────────┘
           │
           │ Multiplier > 1.0?
           ├─────── NO ──────────────────────────────────────────────────┐
           │                                                             │
    YES    ▼                                                             │
    ┌──────────────────────────────────────────────────────────────────┐│
    │  APPLY PENALTY MULTIPLIER (NonProficient = 2.0x)                 ││
    ├──────────────────────────────────────────────────────────────────┤│
    │  EffectiveAgility = BaseAgility × 2 = -4d10 (was -2d10)          ││
    │  EffectiveStamina = BaseStamina × 2 = +10 (was +5)               ││
    │  EffectiveMovement = BaseMovement × 2 = -20 ft (was -10 ft)      ││
    │  StealthDisadvantage: unchanged (boolean, not multiplied)        ││
    │                                                                  ││
    │  WasMultiplied = true                                            ││
    └──────────────────────────────────────────────────────────────────┘│
           │                                                             │
           ▼                                                             │
    ┌──────────────────────────────────────────────────────────────────┐│
    │  OUTPUT: Multiplied Penalties                                    ││
    └──────────────────────────────────────────────────────────────────┘│
                                                                        │
           ┌────────────────────────────────────────────────────────────┘
           │ No multiplication needed
           ▼
    ┌──────────────────────────────────────────────────────────────────┐
    │  OUTPUT: Original Tier Penalties (WasMultiplied = false)         │
    └──────────────────────────────────────────────────────────────────┘
```

### 3.4 Layer Diagram

```
┌─────────────────────────────────────────────────────────────────────┐
│                        PRESENTATION LAYER                            │
├─────────────────────────────────────────────────────────────────────┤
│  EquipmentView                                                       │
│  └── Shows effective penalties when hovering armor                  │
│                                                                      │
│  CharacterSheet                                                      │
│  └── Displays current armor penalties summary                       │
│  └── Highlights penalty doubling warnings                           │
│                                                                      │
│  CombatView (v0.16.2f)                                               │
│  └── Will show real-time penalty effects                            │
└───────┬─────────────────────────────────────────────────────────────┘
        │
        ▼
┌─────────────────────────────────────────────────────────────────────┐
│                       APPLICATION LAYER                              │
├─────────────────────────────────────────────────────────────────────┤
│  ┌───────────────────────────────────────────────────────────────┐  │
│  │                ArmorPenaltyCalculator                          │  │
│  │           (implements IArmorPenaltyCalculator)                 │  │
│  ├───────────────────────────────────────────────────────────────┤  │
│  │  Dependencies:                                                │  │
│  │  - IArmorCategoryProvider (v0.16.2b)                          │  │
│  │  - IArmorProficiencyEffectProvider (v0.16.2a)                 │  │
│  │  - IArchetypeArmorProficiencyProvider (v0.16.2c)              │  │
│  │                                                               │  │
│  │  + CalculatePenalties(category, level)                        │  │
│  │  + CalculateForCharacter(character, armor)                    │  │
│  │  + GetEffectiveTier(category, level)                          │  │
│  │                                                               │  │
│  │  - ApplyTierReduction(category, tierReduction)                │  │
│  │  - ApplyMultiplier(penalties, multiplier)                     │  │
│  │  - BuildResult(base, effective, profLevel, modifiers)         │  │
│  └───────────────────────────────────────────────────────────────┘  │
└───────┬─────────────────────────────────────────────────────────────┘
        │
        ▼
┌─────────────────────────────────────────────────────────────────────┐
│                         DOMAIN LAYER                                 │
├─────────────────────────────────────────────────────────────────────┤
│  ┌───────────────────────────────────────────────────────────────┐  │
│  │                  EffectiveArmorPenalties                       │  │
│  │                     (Value Object)                             │  │
│  ├───────────────────────────────────────────────────────────────┤  │
│  │  BasePenalties: ArmorPenalties                                │  │
│  │  EffectivePenalties: ArmorPenalties                           │  │
│  │  ProficiencyLevel: ArmorProficiencyLevel                      │  │
│  │  AttackModifier: int                                          │  │
│  │  DefenseModifier: int                                         │  │
│  │  EffectiveTier: int                                           │  │
│  │  WasMultiplied: bool                                          │  │
│  │  WasTierReduced: bool                                         │  │
│  │  OriginalCategory: ArmorCategory                              │  │
│  └───────────────────────────────────────────────────────────────┘  │
│                                                                      │
│  Uses from previous phases:                                         │
│  ┌────────────────────┐ ┌────────────────────┐ ┌─────────────────┐  │
│  │ ArmorProficiency   │ │   ArmorCategory    │ │  ArmorPenalties │  │
│  │   Level (v0.16.2a) │ │    (v0.16.2b)      │ │   (v0.16.2b)    │  │
│  └────────────────────┘ └────────────────────┘ └─────────────────┘  │
└─────────────────────────────────────────────────────────────────────┘
```

---

## 4. EffectiveArmorPenalties Value Object

### 4.1 Purpose

The `EffectiveArmorPenalties` value object contains the complete result of penalty calculation, including both base and effective penalties, along with metadata about what modifications were applied.

### 4.2 Implementation

**File:** `src/Core/RuneAndRust.Domain/ValueObjects/EffectiveArmorPenalties.cs`

```csharp
namespace RuneAndRust.Domain.ValueObjects;

using RuneAndRust.Domain.Enums;

/// <summary>
/// Contains the result of armor penalty calculation.
/// </summary>
/// <remarks>
/// <para>
/// EffectiveArmorPenalties captures both the original and calculated penalties,
/// allowing UI to show "before and after" comparisons and explain modifications.
/// </para>
/// <para>
/// The calculation considers:
/// - Tier reduction (Expert/Master can use lower tier penalties)
/// - Penalty multiplier (NonProficient doubles all penalties)
/// - Attack/Defense modifiers from proficiency level
/// </para>
/// </remarks>
/// <param name="OriginalCategory">The armor's original category.</param>
/// <param name="BasePenalties">Base penalties for the original category.</param>
/// <param name="EffectivePenalties">Penalties after tier reduction and multiplier.</param>
/// <param name="ProficiencyLevel">The character's proficiency level.</param>
/// <param name="AttackModifier">Attack modifier from proficiency.</param>
/// <param name="DefenseModifier">Defense modifier from proficiency.</param>
/// <param name="OriginalTier">The original weight tier (0-2).</param>
/// <param name="EffectiveTier">The tier after reduction (0-2).</param>
/// <param name="WasMultiplied">Whether penalties were doubled.</param>
/// <param name="WasTierReduced">Whether tier reduction was applied.</param>
public readonly record struct EffectiveArmorPenalties(
    ArmorCategory OriginalCategory,
    ArmorPenalties BasePenalties,
    ArmorPenalties EffectivePenalties,
    ArmorProficiencyLevel ProficiencyLevel,
    int AttackModifier,
    int DefenseModifier,
    int OriginalTier,
    int EffectiveTier,
    bool WasMultiplied,
    bool WasTierReduced)
{
    /// <summary>
    /// Gets whether the character is non-proficient.
    /// </summary>
    public bool IsNonProficient => ProficiencyLevel == ArmorProficiencyLevel.NonProficient;

    /// <summary>
    /// Gets whether the character has mastery.
    /// </summary>
    public bool IsMaster => ProficiencyLevel == ArmorProficiencyLevel.Master;

    /// <summary>
    /// Gets whether any penalties are active.
    /// </summary>
    public bool HasAnyPenalty => EffectivePenalties.HasAnyPenalty || AttackModifier < 0;

    /// <summary>
    /// Gets whether there are any bonuses.
    /// </summary>
    public bool HasAnyBonus => DefenseModifier > 0;

    /// <summary>
    /// Gets the total attack impact (base penalty + modifier).
    /// </summary>
    public int TotalAttackImpact => AttackModifier;

    /// <summary>
    /// Gets the total defense impact.
    /// </summary>
    public int TotalDefenseImpact => DefenseModifier;

    /// <summary>
    /// Gets a penalties-free result (for Light armor with proficiency).
    /// </summary>
    public static EffectiveArmorPenalties None(ArmorCategory category) => new(
        category,
        ArmorPenalties.None,
        ArmorPenalties.None,
        ArmorProficiencyLevel.Proficient,
        0, 0, 0, 0, false, false);

    /// <summary>
    /// Creates a new EffectiveArmorPenalties result.
    /// </summary>
    public static EffectiveArmorPenalties Create(
        ArmorCategory originalCategory,
        ArmorPenalties basePenalties,
        ArmorPenalties effectivePenalties,
        ArmorProficiencyLevel proficiencyLevel,
        int attackModifier,
        int defenseModifier,
        int originalTier,
        int effectiveTier)
    {
        ArgumentOutOfRangeException.ThrowIfLessThan(originalTier, -1);
        ArgumentOutOfRangeException.ThrowIfGreaterThan(originalTier, 3);
        ArgumentOutOfRangeException.ThrowIfLessThan(effectiveTier, 0);
        ArgumentOutOfRangeException.ThrowIfGreaterThan(effectiveTier, 3);

        return new EffectiveArmorPenalties(
            originalCategory,
            basePenalties,
            effectivePenalties,
            proficiencyLevel,
            attackModifier,
            defenseModifier,
            originalTier,
            effectiveTier,
            WasMultiplied: basePenalties != effectivePenalties &&
                           effectivePenalties.AgilityDicePenalty < basePenalties.AgilityDicePenalty,
            WasTierReduced: effectiveTier < originalTier);
    }

    /// <summary>
    /// Formats the penalty summary for display.
    /// </summary>
    public string FormatSummary()
    {
        var parts = new List<string>();

        if (EffectivePenalties.HasAgilityPenalty)
            parts.Add($"Agility {EffectivePenalties.FormatAgilityPenalty()}");

        if (EffectivePenalties.HasStaminaCost)
            parts.Add($"Stamina {EffectivePenalties.FormatStaminaCost()}");

        if (EffectivePenalties.HasMovementPenalty)
            parts.Add($"Movement {EffectivePenalties.FormatMovementPenalty()}");

        if (AttackModifier != 0)
            parts.Add($"Attack {(AttackModifier >= 0 ? "+" : "")}{AttackModifier}");

        if (DefenseModifier != 0)
            parts.Add($"Defense +{DefenseModifier}");

        return parts.Count > 0 ? string.Join(", ", parts) : "No penalties";
    }

    /// <summary>
    /// Formats modification notes for UI tooltips.
    /// </summary>
    public string FormatModificationNotes()
    {
        var notes = new List<string>();

        if (WasTierReduced)
            notes.Add($"Tier reduced: {GetTierName(OriginalTier)} → {GetTierName(EffectiveTier)}");

        if (WasMultiplied)
            notes.Add("Penalties doubled (non-proficient)");

        return notes.Count > 0 ? string.Join("; ", notes) : "Standard penalties";
    }

    private static string GetTierName(int tier) => tier switch
    {
        0 => "Light",
        1 => "Medium",
        2 => "Heavy",
        _ => "Unknown"
    };

    /// <summary>
    /// Creates a display string for debug/logging.
    /// </summary>
    public override string ToString() =>
        $"{OriginalCategory} ({ProficiencyLevel}): {FormatSummary()}" +
        (WasMultiplied || WasTierReduced ? $" [{FormatModificationNotes()}]" : "");
}
```

---

## 5. IArmorPenaltyCalculator Interface

### 5.1 Purpose

The `IArmorPenaltyCalculator` interface defines the contract for calculating effective armor penalties.

### 5.2 Implementation

**File:** `src/Core/RuneAndRust.Application/Interfaces/IArmorPenaltyCalculator.cs`

```csharp
namespace RuneAndRust.Application.Interfaces;

using RuneAndRust.Domain.Enums;
using RuneAndRust.Domain.ValueObjects;

/// <summary>
/// Calculates effective armor penalties based on category and proficiency.
/// </summary>
/// <remarks>
/// <para>
/// The calculator combines base category penalties with proficiency modifiers:
/// - Tier reduction for Expert/Master levels
/// - Penalty doubling for NonProficient level
/// - Attack/Defense modifiers from proficiency effects
/// </para>
/// </remarks>
public interface IArmorPenaltyCalculator
{
    /// <summary>
    /// Calculates penalties for an armor category at a proficiency level.
    /// </summary>
    /// <param name="category">The armor category.</param>
    /// <param name="proficiencyLevel">The character's proficiency level.</param>
    /// <returns>The calculated effective penalties.</returns>
    EffectiveArmorPenalties CalculatePenalties(
        ArmorCategory category,
        ArmorProficiencyLevel proficiencyLevel);

    /// <summary>
    /// Calculates penalties for a character equipping specific armor.
    /// </summary>
    /// <param name="archetypeId">The character's archetype.</param>
    /// <param name="category">The armor category being equipped.</param>
    /// <returns>The calculated effective penalties.</returns>
    /// <remarks>
    /// This method automatically determines proficiency level from archetype.
    /// </remarks>
    EffectiveArmorPenalties CalculateForArchetype(
        string archetypeId,
        ArmorCategory category);

    /// <summary>
    /// Gets the effective weight tier after proficiency reduction.
    /// </summary>
    /// <param name="category">The armor category.</param>
    /// <param name="proficiencyLevel">The proficiency level.</param>
    /// <returns>The effective tier (0=Light, 1=Medium, 2=Heavy).</returns>
    int GetEffectiveTier(ArmorCategory category, ArmorProficiencyLevel proficiencyLevel);

    /// <summary>
    /// Gets penalties for a specific weight tier.
    /// </summary>
    /// <param name="tier">The weight tier (0-2).</param>
    /// <returns>The base penalties for that tier.</returns>
    ArmorPenalties GetPenaltiesForTier(int tier);

    /// <summary>
    /// Checks if penalties would be doubled for a category + level.
    /// </summary>
    bool WouldDoublepenalties(ArmorCategory category, ArmorProficiencyLevel level);

    /// <summary>
    /// Checks if tier would be reduced for a category + level.
    /// </summary>
    bool WouldReduceTier(ArmorCategory category, ArmorProficiencyLevel level);
}
```

### 5.3 Usage Examples

```csharp
// Calculate penalties for NonProficient in Heavy
var penalties = _calculator.CalculatePenalties(
    ArmorCategory.Heavy,
    ArmorProficiencyLevel.NonProficient);

Console.WriteLine($"Penalties: {penalties.FormatSummary()}");
// Output: "Agility -4d10, Stamina +10, Movement -20 ft, Attack -2"
Console.WriteLine($"Notes: {penalties.FormatModificationNotes()}");
// Output: "Penalties doubled (non-proficient)"

// Calculate for Expert in Heavy (tier reduction)
var expertPenalties = _calculator.CalculatePenalties(
    ArmorCategory.Heavy,
    ArmorProficiencyLevel.Expert);

Console.WriteLine($"Effective tier: {expertPenalties.EffectiveTier}");
// Output: "1" (Medium)
Console.WriteLine($"Penalties: {expertPenalties.FormatSummary()}");
// Output: "Agility -1d10, Stamina +2, Movement -5 ft"

// Calculate for Master in Heavy (tier reduction + defense bonus)
var masterPenalties = _calculator.CalculatePenalties(
    ArmorCategory.Heavy,
    ArmorProficiencyLevel.Master);

Console.WriteLine($"Defense bonus: {masterPenalties.DefenseModifier}");
// Output: "+1"

// Calculate using archetype
var mysticPenalties = _calculator.CalculateForArchetype("mystic", ArmorCategory.Medium);
Console.WriteLine($"Mystic in Medium (non-proficient): {mysticPenalties.FormatSummary()}");
// Output: "Agility -2d10, Stamina +4, Movement -10 ft, Attack -2"
```

---

## 6. ArmorPenaltyCalculator Service

### 6.1 Purpose

The `ArmorPenaltyCalculator` service implements the penalty calculation logic, coordinating between category, proficiency, and archetype providers.

### 6.2 Implementation

**File:** `src/Core/RuneAndRust.Application/Services/ArmorPenaltyCalculator.cs`

```csharp
namespace RuneAndRust.Application.Services;

using Microsoft.Extensions.Logging;
using RuneAndRust.Application.Interfaces;
using RuneAndRust.Domain.Enums;
using RuneAndRust.Domain.ValueObjects;

/// <summary>
/// Calculates effective armor penalties based on category and proficiency.
/// </summary>
/// <remarks>
/// <para>
/// ArmorPenaltyCalculator orchestrates the penalty calculation pipeline:
/// 1. Get proficiency effect (multiplier, tier reduction, modifiers)
/// 2. Apply tier reduction to get effective tier
/// 3. Get base penalties for effective tier
/// 4. Apply penalty multiplier
/// 5. Build result with all metadata
/// </para>
/// </remarks>
public class ArmorPenaltyCalculator : IArmorPenaltyCalculator
{
    private readonly IArmorCategoryProvider _categoryProvider;
    private readonly IArmorProficiencyEffectProvider _effectProvider;
    private readonly IArchetypeArmorProficiencyProvider _archetypeProvider;
    private readonly ILogger<ArmorPenaltyCalculator> _logger;

    /// <summary>
    /// Initializes a new instance of ArmorPenaltyCalculator.
    /// </summary>
    public ArmorPenaltyCalculator(
        IArmorCategoryProvider categoryProvider,
        IArmorProficiencyEffectProvider effectProvider,
        IArchetypeArmorProficiencyProvider archetypeProvider,
        ILogger<ArmorPenaltyCalculator> logger)
    {
        _categoryProvider = categoryProvider ?? throw new ArgumentNullException(nameof(categoryProvider));
        _effectProvider = effectProvider ?? throw new ArgumentNullException(nameof(effectProvider));
        _archetypeProvider = archetypeProvider ?? throw new ArgumentNullException(nameof(archetypeProvider));
        _logger = logger ?? throw new ArgumentNullException(nameof(logger));
    }

    /// <inheritdoc />
    public EffectiveArmorPenalties CalculatePenalties(
        ArmorCategory category,
        ArmorProficiencyLevel proficiencyLevel)
    {
        _logger.LogDebug(
            "Calculating penalties for {Category} at {ProficiencyLevel}",
            category, proficiencyLevel);

        // Step 1: Get proficiency effect
        var effect = _effectProvider.GetEffect(proficiencyLevel);

        // Step 2: Get original category data
        var categoryDef = _categoryProvider.GetDefinition(category);
        var basePenalties = categoryDef.Penalties;
        var originalTier = categoryDef.WeightTier;

        // Step 3: Apply tier reduction (only for tiered categories)
        var effectiveTier = originalTier;
        if (categoryDef.UsesWeightTierSystem && effect.TierReduction > 0)
        {
            effectiveTier = Math.Max(0, originalTier - effect.TierReduction);

            _logger.LogDebug(
                "Tier reduced: {OriginalTier} → {EffectiveTier} for {Category}",
                originalTier, effectiveTier, category);
        }

        // Step 4: Get penalties for effective tier
        var tierPenalties = GetPenaltiesForTier(effectiveTier);

        // Step 5: Apply penalty multiplier
        var effectivePenalties = tierPenalties;
        if (effect.PenaltyMultiplier > 1.0m)
        {
            effectivePenalties = tierPenalties.Multiply(effect.PenaltyMultiplier);

            _logger.LogDebug(
                "Penalties multiplied by {Multiplier}x for NonProficient",
                effect.PenaltyMultiplier);
        }

        // Step 6: Build result
        var result = EffectiveArmorPenalties.Create(
            category,
            basePenalties,
            effectivePenalties,
            proficiencyLevel,
            effect.AttackModifier,
            effect.DefenseModifier,
            originalTier,
            effectiveTier);

        _logger.LogInformation(
            "Calculated penalties for {Category} ({Level}): {Summary}",
            category, proficiencyLevel, result.FormatSummary());

        return result;
    }

    /// <inheritdoc />
    public EffectiveArmorPenalties CalculateForArchetype(
        string archetypeId,
        ArmorCategory category)
    {
        ArgumentException.ThrowIfNullOrWhiteSpace(archetypeId);

        // Get proficiency level from archetype
        var proficiencyLevel = _archetypeProvider.GetStartingProficiency(archetypeId, category);

        _logger.LogDebug(
            "Archetype {ArchetypeId} has {Level} proficiency with {Category}",
            archetypeId, proficiencyLevel, category);

        return CalculatePenalties(category, proficiencyLevel);
    }

    /// <inheritdoc />
    public int GetEffectiveTier(ArmorCategory category, ArmorProficiencyLevel proficiencyLevel)
    {
        var categoryDef = _categoryProvider.GetDefinition(category);

        if (!categoryDef.UsesWeightTierSystem)
            return -1; // Not tiered

        var tierReduction = _effectProvider.GetTierReduction(proficiencyLevel);
        return Math.Max(0, categoryDef.WeightTier - tierReduction);
    }

    /// <inheritdoc />
    public ArmorPenalties GetPenaltiesForTier(int tier)
    {
        return tier switch
        {
            0 => ArmorPenalties.None,
            1 => _categoryProvider.GetPenalties(ArmorCategory.Medium),
            2 => _categoryProvider.GetPenalties(ArmorCategory.Heavy),
            _ => ArmorPenalties.None
        };
    }

    /// <inheritdoc />
    public bool WouldDoublePenalties(ArmorCategory category, ArmorProficiencyLevel level)
    {
        return _effectProvider.GetPenaltyMultiplier(level) > 1.0m;
    }

    /// <inheritdoc />
    public bool WouldReduceTier(ArmorCategory category, ArmorProficiencyLevel level)
    {
        var categoryDef = _categoryProvider.GetDefinition(category);
        if (!categoryDef.UsesWeightTierSystem)
            return false;

        var tierReduction = _effectProvider.GetTierReduction(level);
        return tierReduction > 0 && categoryDef.WeightTier > 0;
    }
}
```

---

## 7. Data Model Changes

### 7.1 New Types Summary

| Type                      | Layer       | Category     | Description                  |
| ------------------------- | ----------- | ------------ | ---------------------------- |
| `EffectiveArmorPenalties` | Domain      | Value Object | Complete calculation result  |
| `IArmorPenaltyCalculator` | Application | Interface    | Penalty calculation contract |
| `ArmorPenaltyCalculator`  | Application | Service      | Calculation implementation   |

### 7.2 File Locations

```
src/Core/RuneAndRust.Domain/
└── ValueObjects/
    └── EffectiveArmorPenalties.cs       ← NEW

src/Core/RuneAndRust.Application/
├── Interfaces/
│   └── IArmorPenaltyCalculator.cs       ← NEW
└── Services/
    └── ArmorPenaltyCalculator.cs        ← NEW
```

---

## 8. Logging Specifications

### 8.1 Log Levels by Component

| Component                | Level       | Events                        |
| ------------------------ | ----------- | ----------------------------- |
| `ArmorPenaltyCalculator` | Information | Penalty calculation completed |
| `ArmorPenaltyCalculator` | Debug       | Tier reduction applied        |
| `ArmorPenaltyCalculator` | Debug       | Multiplier applied            |
| `ArmorPenaltyCalculator` | Debug       | Archetype proficiency lookup  |

### 8.2 Log Message Templates

```csharp
// Information - Calculation complete
_logger.LogInformation(
    "Calculated penalties for {Category} ({Level}): {Summary}",
    category, proficiencyLevel, result.FormatSummary());

// Debug - Tier reduction
_logger.LogDebug(
    "Tier reduced: {OriginalTier} → {EffectiveTier} for {Category}",
    originalTier, effectiveTier, category);

// Debug - Multiplier applied
_logger.LogDebug(
    "Penalties multiplied by {Multiplier}x for NonProficient",
    effect.PenaltyMultiplier);
```

---

## 9. Unit Testing Requirements

### 9.1 Test Count by Feature

| Feature                    | Test Count |
| -------------------------- | ---------- |
| EffectiveArmorPenalties VO | ~1         |
| Tier Reduction Logic       | ~1         |
| Penalty Doubling Logic     | ~1         |
| Full Calculation Pipeline  | ~1         |
| **Total**                  | **~4**     |

### 9.2 Test Specifications

**File:** `tests/RuneAndRust.Application.UnitTests/Services/ArmorPenaltyCalculatorTests.cs`

```csharp
[TestFixture]
public class ArmorPenaltyCalculatorTests
{
    private Mock<IArmorCategoryProvider> _categoryProvider;
    private Mock<IArmorProficiencyEffectProvider> _effectProvider;
    private Mock<IArchetypeArmorProficiencyProvider> _archetypeProvider;
    private ArmorPenaltyCalculator _calculator;

    [SetUp]
    public void Setup()
    {
        _categoryProvider = new Mock<IArmorCategoryProvider>();
        _effectProvider = new Mock<IArmorProficiencyEffectProvider>();
        _archetypeProvider = new Mock<IArchetypeArmorProficiencyProvider>();

        // Setup category definitions
        _categoryProvider.Setup(x => x.GetDefinition(ArmorCategory.Heavy))
            .Returns(new ArmorCategoryDefinition(
                ArmorCategory.Heavy, "Heavy", "desc",
                new[] { "Plate" },
                ArmorPenalties.Create(-2, 5, -10, true),
                2, false));

        _categoryProvider.Setup(x => x.GetPenalties(ArmorCategory.Medium))
            .Returns(ArmorPenalties.Create(-1, 2, -5, true));

        _calculator = new ArmorPenaltyCalculator(
            _categoryProvider.Object,
            _effectProvider.Object,
            _archetypeProvider.Object,
            Mock.Of<ILogger<ArmorPenaltyCalculator>>());
    }

    [Test]
    public void CalculatePenalties_NonProficientInHeavy_DoublesPenalties()
    {
        // Arrange
        _effectProvider.Setup(x => x.GetEffect(ArmorProficiencyLevel.NonProficient))
            .Returns(ArmorProficiencyEffect.Create(
                ArmorProficiencyLevel.NonProficient,
                2.0m, -2, 0, 0, false, "Non-Proficient", "desc"));

        // Act
        var result = _calculator.CalculatePenalties(
            ArmorCategory.Heavy,
            ArmorProficiencyLevel.NonProficient);

        // Assert
        result.WasMultiplied.Should().BeTrue();
        result.EffectivePenalties.AgilityDicePenalty.Should().Be(-4);
        result.EffectivePenalties.StaminaCostModifier.Should().Be(10);
        result.AttackModifier.Should().Be(-2);
    }

    [Test]
    public void CalculatePenalties_ExpertInHeavy_UsesMediumPenalties()
    {
        // Arrange
        _effectProvider.Setup(x => x.GetEffect(ArmorProficiencyLevel.Expert))
            .Returns(ArmorProficiencyEffect.Create(
                ArmorProficiencyLevel.Expert,
                1.0m, 0, 0, 1, true, "Expert", "desc"));

        // Act
        var result = _calculator.CalculatePenalties(
            ArmorCategory.Heavy,
            ArmorProficiencyLevel.Expert);

        // Assert
        result.WasTierReduced.Should().BeTrue();
        result.EffectiveTier.Should().Be(1); // Medium
        result.EffectivePenalties.AgilityDicePenalty.Should().Be(-1);
        result.EffectivePenalties.StaminaCostModifier.Should().Be(2);
    }

    [Test]
    public void CalculatePenalties_MasterInHeavy_HasDefenseBonus()
    {
        // Arrange
        _effectProvider.Setup(x => x.GetEffect(ArmorProficiencyLevel.Master))
            .Returns(ArmorProficiencyEffect.Create(
                ArmorProficiencyLevel.Master,
                1.0m, 0, 1, 1, true, "Master", "desc"));

        // Act
        var result = _calculator.CalculatePenalties(
            ArmorCategory.Heavy,
            ArmorProficiencyLevel.Master);

        // Assert
        result.DefenseModifier.Should().Be(1);
        result.WasTierReduced.Should().BeTrue();
    }

    [Test]
    public void CalculateForArchetype_MysticWithMedium_ReturnsNonProficientPenalties()
    {
        // Arrange
        _archetypeProvider.Setup(x => x.GetStartingProficiency("mystic", ArmorCategory.Medium))
            .Returns(ArmorProficiencyLevel.NonProficient);

        _effectProvider.Setup(x => x.GetEffect(ArmorProficiencyLevel.NonProficient))
            .Returns(ArmorProficiencyEffect.Create(
                ArmorProficiencyLevel.NonProficient,
                2.0m, -2, 0, 0, false, "Non-Proficient", "desc"));

        _categoryProvider.Setup(x => x.GetDefinition(ArmorCategory.Medium))
            .Returns(new ArmorCategoryDefinition(
                ArmorCategory.Medium, "Medium", "desc",
                new[] { "Chain" },
                ArmorPenalties.Create(-1, 2, -5, true),
                1, false));

        // Act
        var result = _calculator.CalculateForArchetype("mystic", ArmorCategory.Medium);

        // Assert
        result.IsNonProficient.Should().BeTrue();
        result.WasMultiplied.Should().BeTrue();
    }
}
```

---

## 10. Use Cases

### UC-001: Calculate Standard Penalties

**Actor:** System  
**Flow:** Character equips armor → Service calculates penalties → Result returned to combat system

### UC-002: Apply Tier Reduction

**Actor:** System (for Expert/Master)  
**Flow:** Expert equips Heavy → Service reduces tier to Medium → Medium penalties returned

### UC-003: Apply Penalty Doubling

**Actor:** System (for NonProficient)  
**Flow:** NonProficient equips armor → Service doubles all penalties → Doubled result returned

### UC-004: Display Penalty Preview

**Actor:** Player  
**Flow:** Player hovers armor in shop → Service calculates for character → UI shows preview

---

## 11. Deliverable Checklist

### Domain Layer

- [ ] `EffectiveArmorPenalties` value object created

### Application Layer

- [ ] `IArmorPenaltyCalculator` interface created
- [ ] `ArmorPenaltyCalculator` service created

### Testing

- [ ] ~4 unit tests implemented
- [ ] All tests passing

---

## 12. Acceptance Criteria

### Functional

- [ ] NonProficient doubles all numerical penalties (2.0x)
- [ ] NonProficient applies -2 attack modifier
- [ ] Expert reduces tier by 1 (Heavy → Medium)
- [ ] Master reduces tier by 1 AND grants +1 Defense
- [ ] Tier reduction cannot go below 0 (Light)
- [ ] Shields are not affected by tier reduction
- [ ] Calculation returns complete `EffectiveArmorPenalties`

### Quality

- [ ] Build succeeds with 0 errors/warnings
- [ ] All ~4 tests pass
- [ ] XML documentation complete

---

## 13. Dependencies

### 13.1 Required from Previous Phases

| Type                                 | Source   | Usage                        |
| ------------------------------------ | -------- | ---------------------------- |
| `ArmorProficiencyLevel`              | v0.16.2a | Proficiency level input      |
| `ArmorProficiencyEffect`             | v0.16.2a | Modifier data                |
| `IArmorProficiencyEffectProvider`    | v0.16.2a | Effect data access           |
| `ArmorCategory`                      | v0.16.2b | Category identification      |
| `ArmorPenalties`                     | v0.16.2b | Base penalty structure       |
| `ArmorCategoryDefinition`            | v0.16.2b | Category metadata            |
| `IArmorCategoryProvider`             | v0.16.2b | Category data access         |
| `IArchetypeArmorProficiencyProvider` | v0.16.2c | Archetype proficiency lookup |

### 13.2 Provides to Future Phases

| Type                      | Usage                            |
| ------------------------- | -------------------------------- |
| `EffectiveArmorPenalties` | v0.16.2f: Combat penalty display |
| `IArmorPenaltyCalculator` | v0.16.2f: Real-time calculation  |

---

## 14. Future Considerations

### 14.1 Deferred to v0.16.2e

- **Proficiency Acquisition Service**: Training to gain proficiency

### 14.2 Deferred to v0.16.2f

- **Combat Integration**: Actual penalty application in combat
- **Real-time Recalculation**: Update on equipment change

### 14.3 Out of Scope

- **Buff/Debuff Interactions**: Modifying penalties via skills
- **Equipment Set Bonuses**: Penalty reduction from set completion

---

_Document Version: 1.0_  
_Last Updated: 2026-01-27_  
_Author: Assistant_
