## v0.16.4 - Container Loot Generation

**Focus:** Automatic loot generation for containers, container type definitions, biome modifiers, and persistence

**Source Specification:** [loot-generation.md](../../aethelgard/design/04-systems/loot-generation.md)

### Overview

This version implements automatic loot generation for containers (chests, lockers, caches). Currently, container loot must be manually populated - this version adds auto-generation based on container type, room biome, and quality tier ranges. Containers remember their looted state to prevent exploitation.

---

### Deliverables Summary

| Category | Items | Estimated Tests |
|----------|-------|-----------------|
| Enums | 1 | 2 |
| Value Objects | 4 | 4 |
| Entities | 2 | 3 |
| Services | 2 | 3 |
| **Total** | **9** | **~12** |

---

### v0.16.4a - Container Type System

#### ContainerType Enum
```
ContainerType
├── SmallChest - 1-2 items, Tier 0-1
├── MediumChest - 2-4 items, Tier 1-2
├── LargeChest - 3-5 items, Tier 2-3
├── BossChest - 4-6 items, Tier 3-4, guaranteed currency
├── HiddenCache - 1-3 items, Tier 1-3, requires discovery
├── Corpse - 0-2 items, Tier 0-1
├── Locker - 1-2 items, Tier 0-2
├── SupplyCrate - 2-3 items, consumables focus
├── WeaponRack - 1-2 weapons only
├── ArmorStand - 1 armor only
```

#### ContainerTypeDefinition Value Object
```
ContainerTypeDefinition
├── Type: ContainerType
├── DisplayName: string
├── MinItems: int
├── MaxItems: int
├── MinTier: QualityTier
├── MaxTier: QualityTier
├── GuaranteedCurrency: bool
├── CurrencyRange: (min, max)?
├── ItemCategoryFilter: List<string>? (weapons only, armor only, etc.)
├── RequiresDiscovery: bool
├── DiscoveryDc: int?
```

**Container Specifications:**
| Type | Items | Tier Range | Currency | Special |
|------|-------|------------|----------|---------|
| SmallChest | 1-2 | 0-1 | 10-30 gold | — |
| MediumChest | 2-4 | 1-2 | 25-75 gold | — |
| LargeChest | 3-5 | 2-3 | 50-150 gold | — |
| BossChest | 4-6 | 3-4 | 100-300 gold | Always has Myth-Forged chance |
| HiddenCache | 1-3 | 1-3 | 50-200 gold | DC 14 Perception to find |
| Corpse | 0-2 | 0-1 | 5-20 gold | May have nothing |
| Locker | 1-2 | 0-2 | 10-40 gold | — |
| SupplyCrate | 2-3 | 0-1 | — | Consumables only |
| WeaponRack | 1-2 | 1-3 | — | Weapons only |
| ArmorStand | 1 | 1-3 | — | Armor only |

**Configuration (`container-types.json`):**
```json
{
  "containerTypes": [
    {
      "type": "SmallChest",
      "displayName": "Small Chest",
      "minItems": 1,
      "maxItems": 2,
      "minTier": "JuryRigged",
      "maxTier": "Scavenged",
      "guaranteedCurrency": true,
      "currencyRange": { "min": 10, "max": 30 },
      "itemCategoryFilter": null,
      "requiresDiscovery": false
    },
    {
      "type": "HiddenCache",
      "displayName": "Hidden Cache",
      "minItems": 1,
      "maxItems": 3,
      "minTier": "Scavenged",
      "maxTier": "ClanForged",
      "guaranteedCurrency": true,
      "currencyRange": { "min": 50, "max": 200 },
      "itemCategoryFilter": null,
      "requiresDiscovery": true,
      "discoveryDc": 14
    }
  ]
}
```

**Unit Tests (~2):**
- [ ] Container type has correct item count range
- [ ] Tier range enforced for each type

---

### v0.16.4b - Container Loot Table Entity

#### ContainerLootTable Entity
```
ContainerLootTable
├── ContainerId: string
├── RoomId: string
├── ContainerType: ContainerType
├── BiomeId: string
├── GeneratedContents: List<DroppedItem>?
├── GeneratedCurrency: Dictionary<string, int>?
├── IsLooted: bool
├── LootedAt: DateTime?
├── LootedBy: string? (character ID)
├── RequiresKey: bool
├── KeyId: string?
├── IsLocked: bool
├── LockDc: int?
├── Methods:
│   ├── GenerateContents(rng) → void
│   ├── MarkAsLooted(characterId) → void
│   ├── GetContents() → ContainerContents
│   └── CanOpen(characterId) → bool
```

#### ContainerContents Value Object
```
ContainerContents
├── Items: List<DroppedItem>
├── Currency: Dictionary<string, int>
├── WasGenerated: bool
├── HighestTier: QualityTier
├── TotalValue: int (estimated)
```

**Container State Tracking:**
```
Container States:
  1. Undiscovered - Hidden containers not yet found
  2. Discovered - Found but not opened
  3. Locked - Requires key or lockpicking
  4. Open - Contents visible
  5. Looted - Already emptied
```

**Unit Tests (~2):**
- [ ] Container generates contents on first access
- [ ] Looted container returns empty on subsequent access

---

### v0.16.4c - Biome Loot Modifiers

#### BiomeLootModifiers Value Object
```
BiomeLootModifiers
├── BiomeId: string
├── GoldMultiplier: float (1.0 = normal)
├── DropRateMultiplier: float
├── QualityBonus: int (shifts tier up)
├── RareChanceBonus: float (increases Tier 3-4 odds)
├── SpecialItems: List<string>? (biome-unique items)
├── ExcludedItems: List<string>? (items that don't appear)
```

**Biome Modifier Examples:**
| Biome | Gold | Drop Rate | Quality | Rare Chance | Notes |
|-------|------|-----------|---------|-------------|-------|
| The Roots | 1.0 | 1.0 | 0 | 0% | Standard baseline |
| Muspelheim | 1.2 | 0.9 | 0 | +5% | Rich but dangerous |
| Niflheim | 0.8 | 1.1 | 0 | +5% | Preserved items |
| Alfheim | 1.5 | 0.7 | +1 | +15% | Corrupted treasure |
| Jötunheim | 2.0 | 0.8 | +1 | +20% | Ancient wealth |
| Boss Rooms | 1.5 | 1.0 | +1 | +25% | Always better loot |

**Modifier Application:**
```
ApplyBiomeModifiers(baseContents, biome):
  1. Get BiomeLootModifiers for biome
  2. Scale currency by GoldMultiplier
  3. Reduce item count by (1 - DropRateMultiplier) chance
  4. For each item:
     a. If QualityBonus > 0: Shift tier up
     b. Apply RareChanceBonus to tier roll
  5. Add biome-specific items if applicable
  6. Remove excluded items
```

**Configuration (`biome-loot-modifiers.json`):**
```json
{
  "biomeModifiers": [
    {
      "biomeId": "alfheim",
      "goldMultiplier": 1.5,
      "dropRateMultiplier": 0.7,
      "qualityBonus": 1,
      "rareChanceBonus": 0.15,
      "specialItems": ["paradox_shard", "blight_crystal"],
      "excludedItems": ["pristine_armor"]
    }
  ]
}
```

**Unit Tests (~2):**
- [ ] Gold scaled by multiplier
- [ ] Quality bonus shifts tier correctly

---

### v0.16.4d - Container Loot Service

#### IContainerLootService Interface
```csharp
public interface IContainerLootService
{
    /// <summary>
    /// Generates loot for a container based on type and biome.
    /// </summary>
    ContainerContents GenerateContainerLoot(
        ContainerType type,
        string biomeId,
        PlayerCharacter? player,
        Random rng);

    /// <summary>
    /// Opens a container and returns contents.
    /// Generates if not yet generated.
    /// </summary>
    ContainerContents OpenContainer(
        string containerId,
        string characterId);

    /// <summary>
    /// Checks if container has been looted.
    /// </summary>
    bool IsLooted(string containerId);

    /// <summary>
    /// Gets container type definition.
    /// </summary>
    ContainerTypeDefinition GetContainerType(ContainerType type);
}
```

#### ContainerLootGenerator
```csharp
public class ContainerLootGenerator
{
    public ContainerContents Generate(
        ContainerTypeDefinition typeDef,
        BiomeLootModifiers biomeModifiers,
        PlayerCharacter? player,
        Random rng)
    {
        // Determine item count
        var itemCount = rng.Next(typeDef.MinItems, typeDef.MaxItems + 1);

        // Apply drop rate modifier
        itemCount = ApplyDropRateModifier(itemCount, biomeModifiers.DropRateMultiplier, rng);

        var items = new List<DroppedItem>();
        for (int i = 0; i < itemCount; i++)
        {
            // Roll tier within container's range
            var tier = RollTierInRange(
                typeDef.MinTier,
                typeDef.MaxTier,
                biomeModifiers,
                rng);

            // Generate item using smart loot if player provided
            var item = GenerateItem(tier, typeDef.ItemCategoryFilter, player, rng);
            items.Add(item);
        }

        // Generate currency if guaranteed
        var currency = GenerateCurrency(typeDef, biomeModifiers, rng);

        return new ContainerContents(items, currency);
    }
}
```

**Generation Flow:**
```
OpenContainer(containerId, characterId):
  1. Get ContainerLootTable for containerId
  2. If IsLooted: Return empty contents
  3. If GeneratedContents == null:
     a. Get container type definition
     b. Get biome modifiers for room
     c. Get player for smart loot
     d. Generate contents
     e. Store in GeneratedContents
  4. Mark as looted
  5. Return contents
```

**Unit Tests (~3):**
- [ ] Container generates correct item count
- [ ] Biome modifiers affect generation
- [ ] Looted container returns empty

---

### v0.16.4e - Container State Persistence

#### ContainerStateRepository
```csharp
public interface IContainerStateRepository
{
    /// <summary>
    /// Saves container state (looted, contents, etc.).
    /// </summary>
    void SaveContainerState(ContainerLootTable state);

    /// <summary>
    /// Loads container state by ID.
    /// </summary>
    ContainerLootTable? LoadContainerState(string containerId);

    /// <summary>
    /// Gets all containers in a room.
    /// </summary>
    IReadOnlyList<ContainerLootTable> GetContainersInRoom(string roomId);

    /// <summary>
    /// Resets all containers (for new run).
    /// </summary>
    void ResetAllContainers();
}
```

**Persistence Strategy:**
```
Per-Run Persistence:
  - Container looted state persists within a run
  - Contents generated once and cached
  - Reset on new run/game

Save Data Structure:
  {
    "containerId": "chest_001",
    "isLooted": true,
    "lootedAt": "2025-01-17T12:00:00Z",
    "lootedBy": "player_001",
    "generatedContents": [...],
    "generatedCurrency": { "gold": 45 }
  }
```

**Unit Tests (~2):**
- [ ] Container state persists after looting
- [ ] Reset clears all container states

---

### v0.16.4f - Room Integration

#### Room Container Discovery
```csharp
public partial class Room
{
    /// <summary>
    /// Gets all containers in the room.
    /// </summary>
    public IReadOnlyList<ContainerInfo> GetContainers();

    /// <summary>
    /// Gets undiscovered hidden containers.
    /// </summary>
    public IReadOnlyList<ContainerInfo> GetHiddenContainers();

    /// <summary>
    /// Reveals a hidden container.
    /// </summary>
    public void RevealContainer(string containerId);
}
```

#### ContainerInfo Value Object
```
ContainerInfo
├── ContainerId: string
├── ContainerType: ContainerType
├── DisplayName: string
├── IsDiscovered: bool
├── IsLooted: bool
├── IsLocked: bool
├── LockDc: int?
├── DiscoveryDc: int? (for hidden)
```

**Container Commands:**
```
> search
  You search the room and find a hidden cache! (DC 14 passed)

> open chest
  You open the small chest...
  Found: Iron Sword (Scavenged), 23 gold

> open cache
  You open the hidden cache...
  Found: Steel Dagger (Clan-Forged), Healing Potion, 87 gold
```

**Unit Tests (~3):**
- [ ] Room lists all containers
- [ ] Hidden containers require discovery
- [ ] Open command triggers loot generation

---

### Configuration Files

| File | Purpose |
|------|---------|
| `container-types.json` | Container type definitions |
| `biome-loot-modifiers.json` | Biome-specific modifiers |
| `container-placements.json` | Default containers per room type |

---

### Dependencies

**Requires:**
- v0.16.0: Quality tier system
- v0.16.3: Smart loot generation
- Room system: Container placement
- Perception system: Hidden container discovery

**Provides to:**
- v0.16.5: Unique items (can appear in containers)
- Exploration: Meaningful container interaction
- Economy: Resource distribution

---

### Acceptance Criteria

- [ ] ContainerType enum has 10 container types
- [ ] Each type has defined item count range
- [ ] Each type has defined tier range
- [ ] Boss chests have higher tier guarantee
- [ ] Hidden caches require perception check
- [ ] Biome modifiers affect loot quality
- [ ] Gold multiplier scales currency
- [ ] Quality bonus shifts tiers up
- [ ] Containers generate contents once
- [ ] Looted containers stay empty
- [ ] Container state persists in run
- [ ] Reset works for new runs
- [ ] ~12 unit tests pass
