# Changelog: v0.18.0b - Stress Result Objects

**Release Date:** 2026-01-31
**Phase:** Psychic Stress System (2/6)
**Status:** Complete

---

## Overview

Implements the three result value objects for stress system operations — the immutable records that capture the before/after state of stress changes and enable the service layer and UI to respond appropriately to stress events. This is the second phase of v0.18.0 (Psychic Stress System), establishing the **Result Object Pattern** that will be reused for Corruption (v0.18.1), CPS (v0.18.2), and Trauma (v0.18.3) result types.

`StressCheckResult` captures WILL-based resistance check outcomes and maps successes to a reduction percentage via the resistance reduction table (0%/50%/75%/100%). `StressApplicationResult` tracks the complete state change when stress is applied, including threshold crossings and trauma check triggers. `StressRecoveryResult` tracks stress recovery from rest, including threshold improvements and full recovery detection.

All three types are `readonly record struct` with private constructors enforcing the factory pattern, comprehensive XML documentation, and arrow-expression properties for common queries.

---

## Added

### Domain Layer — Value Objects

- **`StressCheckResult`** (`Domain/ValueObjects/StressCheckResult.cs`)
    - `readonly record struct` with private constructor enforcing factory pattern
    - Stored properties: `Succeeded`, `Successes`, `BaseStress`, `FinalStress`, `ReductionPercent`
    - Arrow-expression properties: `WasFullyResisted` (FinalStress == 0), `WasPartiallyResisted` (Succeeded && FinalStress > 0)
    - Resistance reduction table via switch expression: 0 → 0%, 1 → 50%, 2-3 → 75%, 4+ → 100%
    - FinalStress uses decimal truncation (not rounding): `(int)(baseStress * (1m - ReductionPercent))`
    - Factory methods: `Create(successes, baseStress)`, `NoResistance(baseStress)`
    - Input validation: `ArgumentOutOfRangeException.ThrowIfNegative` on both parameters

- **`StressApplicationResult`** (`Domain/ValueObjects/StressApplicationResult.cs`)
    - `readonly record struct` with private constructor enforcing factory pattern
    - Stored properties: `PreviousStress`, `NewStress` (clamped 0-100), `StressGained`, `Source`, `PreviousThreshold`, `NewThreshold`, `ThresholdCrossed`, `TraumaCheckTriggered`, `ResistanceResult` (nullable)
    - Arrow-expression properties: `WasResisted`, `DefensePenaltyChange`
    - Threshold detection: `ThresholdCrossed = NewThreshold > PreviousThreshold`
    - Trauma trigger: `TraumaCheckTriggered = NewStress >= StressState.MaxStress`
    - NewStress clamped via `Math.Clamp(newStress, MinStress, MaxStress)`; PreviousStress NOT clamped (expected valid from StressState)
    - Factory method: `Create(previousStress, newStress, source, resistanceResult?)`

- **`StressRecoveryResult`** (`Domain/ValueObjects/StressRecoveryResult.cs`)
    - `readonly record struct` with private constructor enforcing factory pattern
    - Stored properties: `PreviousStress`, `NewStress` (clamped to min 0), `AmountRecovered`, `RecoverySource`, `PreviousThreshold`, `NewThreshold`, `ThresholdDropped`
    - Arrow-expression properties: `IsFullyRecovered` (NewStress == 0), `IsNowCalm` (NewThreshold == Calm), `DefensePenaltyImprovement`
    - Threshold detection: `ThresholdDropped = NewThreshold < PreviousThreshold`
    - NewStress clamped via `Math.Max(newStress, MinStress)` — only clamps to minimum (recovery cannot increase stress)
    - Factory method: `Create(previousStress, newStress, recoverySource)`

### Unit Tests

- **`StressCheckResultTests`** (`ValueObjects/StressCheckResultTests.cs`) — 26 test methods
    - Factory — Create: Reduction table correctness (6 TestCases), zero base stress (4 TestCases), large success count, value storage, negative successes throws, negative base stress throws
    - Factory — NoResistance: Zero successes full stress, reduction percent is zero, negative base stress throws
    - Computed — Succeeded: 4 TestCases reflecting success count
    - Arrow — WasFullyResisted: 6 TestCases covering all reduction tiers and zero base stress
    - Arrow — WasPartiallyResisted: 5 TestCases covering partial/full/no resistance
    - FinalStress truncation: 3 explicit truncation tests + 5 boundary value TestCases
    - ToString: 3 formatting tests (with successes, zero successes, full resistance)

- **`StressApplicationResultTests`** (`ValueObjects/StressApplicationResultTests.cs`) — 30 test methods
    - Factory — Create: Value storage, resistance result storage, null resistance result, clamping to max/min
    - ThresholdCrossed: 4 spec TestCases, 6 boundary TestCases, 4 same-threshold TestCases, multi-threshold crossing
    - TraumaCheckTriggered: At 100, above 100 (clamped), at 99, at 0
    - StressGained: Correct delta, delta with clamping, zero change
    - Thresholds: PreviousThreshold (7 TestCases), NewThreshold (7 TestCases)
    - WasResisted: True with success, false with null, false with failure
    - DefensePenaltyChange: 6 TestCases covering all tiers
    - Source: All 6 StressSource enum values
    - ToString: No crossing, with crossing, with trauma, trauma without crossing

- **`StressRecoveryResultTests`** (`ValueObjects/StressRecoveryResultTests.cs`) — 28 test methods
    - Factory — Create: Value storage, clamping to min, zero new stress
    - ThresholdDropped: 3 spec TestCases, 5 boundary TestCases, 4 same-threshold TestCases, multi-threshold drop, no change
    - AmountRecovered: Correct delta, delta with clamping, full recovery
    - Thresholds: PreviousThreshold (7 TestCases), NewThreshold (7 TestCases)
    - IsFullyRecovered: 4 TestCases
    - IsNowCalm: 4 TestCases
    - DefensePenaltyImprovement: 5 TestCases
    - RecoverySource: All 4 RestType enum values
    - ToString: No drop, with drop, full recovery

### Glossary

- **`config/glossary.json`** — Added 3 glossary entries (sortOrder 79-81)
    - `stress-check-result`: Immutable result of WILL-based resistance check with reduction table
    - `stress-application-result`: Immutable result of applying stress with threshold crossing and trauma triggers
    - `stress-recovery-result`: Immutable result of stress recovery with threshold improvement tracking

---

## Design Decisions

### Adherence to Design Specification

All three value objects follow the design specification exactly as written in sections 5, 6, and 7 of `v0.18.0b-design-specification.md`. No deviations were required.

### FinalStress Truncation vs Rounding

The design specification specifies `(int)(baseStress * (1m - ReductionPercent))` which truncates toward zero. For example, 15 base stress with 50% reduction yields 7.5 → 7 (not 8). This truncation behavior is intentional and documented in the XML remarks. The test suite includes explicit truncation verification tests.

### PreviousStress Not Clamped

In both `StressApplicationResult` and `StressRecoveryResult`, the `previousStress` parameter is NOT clamped. It is expected to come from a valid `StressState` (already 0-100). If an out-of-range value is passed, `StressThresholdExtensions.FromStressValue()` will throw `ArgumentOutOfRangeException`. This is intentional — the service layer (v0.18.0d) is responsible for providing valid previous stress values.

### Test Count Expansion

The design specification estimated ~3 tests (one per value object). The implementation includes 84 test methods across 3 test files, consistent with v0.18.0a's pattern where ~4 estimated tests became 66 actual test methods. The expanded coverage includes boundary conditions, truncation behavior, all enum value pass-through, clamping edge cases, and ToString formatting.

---

## Dependencies

### Prerequisites

| Type | Phase | Usage |
| --- | --- | --- |
| `StressThreshold` | v0.18.0a | Threshold tier comparison in application/recovery results |
| `StressSource` | v0.18.0a | Source categorization in application result |
| `RestType` | v0.18.0a | Recovery source type in recovery result |
| `StressState` | v0.18.0a | MinStress/MaxStress constants for clamping |
| `StressThresholdExtensions` | v0.18.0a | `FromStressValue()` for threshold resolution |

### Provides to Future Phases

| Type | Phase | Usage |
| --- | --- | --- |
| `StressCheckResult` | v0.18.0c | Return type for `PerformResistanceCheck()` |
| `StressApplicationResult` | v0.18.0c | Return type for `ApplyStress()` |
| `StressRecoveryResult` | v0.18.0c | Return type for `RecoverStress()` |

---

## Logging Strategy

No runtime logging in v0.18.0b — all types are immutable value objects with no side effects. Logging is deferred to v0.18.0d (StressService implementation) which will log when creating these result objects. The design specification documents log event templates in section 9 for future use.

---

## Files Created

| Path | Description |
|------|-------------|
| `src/Core/RuneAndRust.Domain/ValueObjects/StressCheckResult.cs` | Resistance check result value object |
| `src/Core/RuneAndRust.Domain/ValueObjects/StressApplicationResult.cs` | Stress application result value object |
| `src/Core/RuneAndRust.Domain/ValueObjects/StressRecoveryResult.cs` | Stress recovery result value object |
| `tests/RuneAndRust.Domain.UnitTests/ValueObjects/StressCheckResultTests.cs` | StressCheckResult tests (26 tests) |
| `tests/RuneAndRust.Domain.UnitTests/ValueObjects/StressApplicationResultTests.cs` | StressApplicationResult tests (30 tests) |
| `tests/RuneAndRust.Domain.UnitTests/ValueObjects/StressRecoveryResultTests.cs` | StressRecoveryResult tests (28 tests) |
| `changelogs/v0.18.0b-changelog.md` | This changelog |

## Files Modified

| Path | Description |
|------|-------------|
| `config/glossary.json` | Added 3 glossary entries (sortOrder 79-81) |
| `docs/design/v0.18.x/v0.18.0-scope-breakdown.md` | Checked off v0.18.0b acceptance criteria |
| `docs/design/v0.18.x/v0.18.0b-design-specification.md` | Checked off deliverable and acceptance criteria |

---

## Notes

- Total unit tests for v0.18.0b: 84 test methods across 3 test files (far exceeding the ~3 estimate)
- All 84 new tests pass; all existing tests unaffected (0 regressions)
- Build succeeds with 0 errors, 0 warnings
- All new files follow established codebase patterns: `═══════` section separators for value objects, file-scoped namespaces, comprehensive XML documentation with `<example>`, `<remarks>`, `<list>`, and `<seealso>` tags
- The Result Object Pattern established here (before/after state, threshold detection, computed delta properties) will be reused for Corruption and Trauma result objects in later phases
- Pre-existing glossary schema validation failure at term #88 (unrelated to v0.18.0b changes)
