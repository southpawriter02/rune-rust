# v0.14.8 Dice Configuration Schemas - Scope Breakdown

**Version:** 0.14.8
**Theme:** Dice Configuration Schemas
**Prerequisites:** v0.14.7 Complete (Descriptor Configuration Schemas)
**Total Estimated Tests:** ~12 new tests

---

## Executive Summary

The Dice Configuration Schemas version creates comprehensive JSON schemas for dice pool mechanics and dice expression validation, enabling full customization of dice types, roll mechanics, and dice pool rules without code changes. This supports modding scenarios like custom die types (d7, d30), alternative dice pool systems (Fate dice, exploding dice), or probability-tuned roll mechanics.

The work is divided into **two sub-parts**:

| Part | Name | Focus | Est. Tests |
|------|------|-------|------------|
| v0.14.8a | Dice Types Schema | dice-types.schema.json with die definitions, expression patterns, validation rules | ~6 |
| v0.14.8b | Dice Mechanics Schema | dice-mechanics.schema.json with pool rules, modifiers, critical thresholds | ~6 |

---

## Feature Analysis & Categorization

### Dice Type Configuration

| Feature | Complexity | Dependencies | Assigned Part |
|---------|------------|--------------|---------------|
| dice-types.schema.json | Medium | None | **v0.14.8a** |
| Die type definitions | Low | dice-types.schema.json | **v0.14.8a** |
| Dice expression pattern | Medium | dice-types.schema.json | **v0.14.8a** |
| Expression validation rules | Medium | dice-types.schema.json | **v0.14.8a** |
| Custom die ranges | Low | dice-types.schema.json | **v0.14.8a** |

### Dice Mechanics Configuration

| Feature | Complexity | Dependencies | Assigned Part |
|---------|------------|--------------|---------------|
| dice-mechanics.schema.json | Medium | dice-types.schema.json | **v0.14.8b** |
| Pool configuration | Medium | dice-mechanics.schema.json | **v0.14.8b** |
| Roll modifiers | Medium | dice-mechanics.schema.json | **v0.14.8b** |
| Critical thresholds | Low | dice-mechanics.schema.json | **v0.14.8b** |
| Advantage/disadvantage rules | Low | dice-mechanics.schema.json | **v0.14.8b** |

---

## Existing Infrastructure

### Current Dice Usage

Dice expressions appear throughout configuration files as strings:

| File | Field | Example Value |
|------|-------|---------------|
| `config/skills.json` | `baseDicePool` | `"1d10"` |
| `config/hazards.json` | `damagePerTurn.dice` | `"1d6"`, `"2d6"` |
| `config/hazards.json` | `entryDamage.dice` | `"1d8"` |
| Various weapon configs | `damage` | `"1d8+2"`, `"2d6"` |

### Current Dice Expression Pattern

```
^\d+d\d+([+-]\d+)?$

Examples:
- "1d6"      → 1 six-sided die
- "2d10"     → 2 ten-sided dice
- "1d8+2"    → 1 eight-sided die plus 2
- "3d6-1"    → 3 six-sided dice minus 1
```

### No Centralized Dice Configuration

Currently, there is no configuration file that defines:
- Valid die types (d4, d6, d8, d10, d12, d20)
- Dice pool mechanics (exploding, advantage, keep)
- Critical thresholds (natural 1, natural max)
- Default dice for different roll categories

### Key Schema Conventions

- JSON Schema Draft-07 format
- ID pattern: `^[a-z][a-z0-9-]*$` (lowercase kebab-case)
- Definitions section for reusable types
- Required fields explicitly listed
- Descriptions on all properties

---

## Phase Definitions

---

## v0.14.8a: Dice Types Schema

[v0.14.8a Design Specification](v0.14.8a-design-specification.md)

### Overview

Create a comprehensive JSON schema for dice type definitions that validates die types, dice expression patterns, and provides validation rules for dice notation used throughout other configuration files.

### Scope

**In Scope:**
- `dice-types.schema.json` - Schema for die type definitions
- Standard die types (d4, d6, d8, d10, d12, d20, d100)
- Custom die type support (arbitrary face counts)
- Dice expression pattern definition and validation
- Modifier syntax (+N, -N)
- Die type metadata (min, max, average, distribution)
- Visual/display properties (color, icon)

**Out of Scope:**
- Dice mechanics schema (v0.14.8b)
- Roll execution logic (runtime concern)
- Dice probability calculations (runtime concern)

### Key Deliverables

| Type | Count | Details |
|------|-------|---------|
| JSON Schemas | 1 | `dice-types.schema.json` |
| Schema Definitions | 3 | `DieType`, `DiceExpression`, `DiceExpressionPattern` |
| Configuration Files | 1 | `dice-types.json` with standard dice |
| Unit Tests | ~6 | Schema validation tests |

### Schema Structure

```
dice-types.schema.json
|-- $schema: "http://json-schema.org/draft-07/schema#"
|-- title: "Dice Types Configuration"
|-- description: "Schema for die type definitions"
|-- type: object
|-- properties:
|   |-- $schema: string
|   |-- version: string (optional)
|   |-- dieTypes: array of DieType
|   +-- expressionPattern: DiceExpressionPattern
|-- required: ["dieTypes"]
+-- definitions:
    |-- DieType
    |   |-- id: string (pattern: ^d\d+$, e.g., "d6", "d20")
    |   |-- name: string (minLength: 1)
    |   |-- faces: integer (minimum: 2)
    |   |-- minValue: integer (minimum: 0, default: 1)
    |   |-- maxValue: integer (computed from faces + minValue - 1)
    |   |-- average: number (computed)
    |   |-- isStandard: boolean (default: true)
    |   |-- color: string (optional, hex color for display)
    |   |-- iconId: string (optional, icon reference)
    |   |-- description: string (optional)
    |   +-- sortOrder: integer (minimum: 0)
    |-- DiceExpression
    |   |-- count: integer (minimum: 1, default: 1)
    |   |-- dieType: string (references DieType.id)
    |   |-- modifier: integer (default: 0)
    |   +-- raw: string (the original expression string)
    +-- DiceExpressionPattern
        |-- pattern: string (regex for validation)
        |-- captureGroups: object (describes regex groups)
        +-- examples: array of string
```

### Standard Die Types

| ID | Name | Faces | Min | Max | Average | Use Case |
|----|------|-------|-----|-----|---------|----------|
| `d4` | Four-sided | 4 | 1 | 4 | 2.5 | Small weapons, healing |
| `d6` | Six-sided | 6 | 1 | 6 | 3.5 | Common damage, hazards |
| `d8` | Eight-sided | 8 | 1 | 8 | 4.5 | Medium weapons |
| `d10` | Ten-sided | 10 | 1 | 10 | 5.5 | Skill checks, large weapons |
| `d12` | Twelve-sided | 12 | 1 | 12 | 6.5 | Heavy weapons |
| `d20` | Twenty-sided | 20 | 1 | 20 | 10.5 | Attack rolls, saves |
| `d100` | Percentile | 100 | 1 | 100 | 50.5 | Random tables, percentages |

### Dice Expression Examples

| Expression | Count | Die | Modifier | Total Range |
|------------|-------|-----|----------|-------------|
| `1d6` | 1 | d6 | 0 | 1-6 |
| `2d6` | 2 | d6 | 0 | 2-12 |
| `1d8+2` | 1 | d8 | +2 | 3-10 |
| `3d6-1` | 3 | d6 | -1 | 2-17 |
| `1d20` | 1 | d20 | 0 | 1-20 |
| `1d10+5` | 1 | d10 | +5 | 6-15 |

### Acceptance Criteria

- [x] `dice-types.schema.json` created in `config/schemas/`
- [x] `dice-types.json` created with standard die types
- [x] Die type ID pattern validated (d followed by number)
- [x] Faces validated as integer >= 2
- [x] Min/max values validated
- [x] Dice expression pattern defined
- [x] Expression examples documented
- [x] Color validated as optional hex string
- [x] ~6 unit tests pass (55 tests implemented)

---

## v0.14.8b: Dice Mechanics Schema

[v0.14.8b Design Specification](v0.14.8b-design-specification.md)

### Overview

Create a comprehensive JSON schema for dice pool mechanics that validates roll modifiers, critical thresholds, advantage/disadvantage rules, and advanced dice pool features like exploding dice and keeping highest/lowest.

### Scope

**In Scope:**
- `dice-mechanics.schema.json` - Schema for dice pool rules
- Pool modifier rules (advantage, disadvantage, bonuses)
- Critical success/failure thresholds
- Exploding dice rules (dice that reroll on max)
- Keep rules (keep highest N, keep lowest N)
- Reroll rules (reroll 1s, reroll below threshold)
- Default dice for roll categories (skills, attacks, saves)
- Difficulty class (DC) definitions

**Out of Scope:**
- Dice types schema (v0.14.8a)
- Roll execution logic (runtime concern)
- Probability calculations (runtime concern)

### Key Deliverables

| Type | Count | Details |
|------|-------|---------|
| JSON Schemas | 1 | `dice-mechanics.schema.json` |
| Schema Definitions | 5 | `PoolMechanics`, `CriticalThresholds`, `KeepRules`, `RerollRules`, `DefaultDice` |
| Configuration Files | 1 | `dice-mechanics.json` with default mechanics |
| Unit Tests | ~6 | Schema validation tests |

### Schema Structure

```
dice-mechanics.schema.json
|-- $schema: "http://json-schema.org/draft-07/schema#"
|-- title: "Dice Mechanics Configuration"
|-- description: "Schema for dice pool mechanics and rules"
|-- type: object
|-- properties:
|   |-- $schema: string
|   |-- version: string (optional)
|   |-- criticalThresholds: CriticalThresholds
|   |-- advantageRules: AdvantageRules
|   |-- explodingDice: ExplodingDiceRules
|   |-- keepRules: KeepRules
|   |-- rerollRules: RerollRules
|   |-- defaultDice: DefaultDice
|   +-- difficultyClasses: array of DifficultyClass
|-- required: ["criticalThresholds", "defaultDice"]
+-- definitions:
    |-- CriticalThresholds
    |   |-- naturalMin: integer (default: 1, critical failure)
    |   |-- naturalMax: string (default: "max", critical success)
    |   |-- criticalMultiplier: number (minimum: 1, default: 2)
    |   |-- criticalBonusDice: string (optional, e.g., "1d6")
    |   |-- autoFailOnNatMin: boolean (default: true)
    |   +-- autoSuccessOnNatMax: boolean (default: true)
    |-- AdvantageRules
    |   |-- advantageDice: integer (default: 1, extra dice to roll)
    |   |-- advantageKeep: string (enum: Highest, Lowest, default: Highest)
    |   |-- disadvantageDice: integer (default: 1)
    |   |-- disadvantageKeep: string (enum: Highest, Lowest, default: Lowest)
    |   +-- stackable: boolean (default: false)
    |-- ExplodingDiceRules
    |   |-- enabled: boolean (default: false)
    |   |-- explodeOn: string (enum: Max, Threshold)
    |   |-- threshold: integer (optional, for Threshold mode)
    |   |-- maxExplosions: integer (minimum: 1, default: 10)
    |   +-- appliesToTypes: array of string (die type IDs, optional)
    |-- KeepRules
    |   |-- keepHighest: integer (optional, keep N highest)
    |   |-- keepLowest: integer (optional, keep N lowest)
    |   +-- dropHighest: integer (optional, drop N highest)
    |-- RerollRules
    |   |-- rerollOnes: boolean (default: false)
    |   |-- rerollBelow: integer (optional, reroll if below threshold)
    |   |-- maxRerolls: integer (minimum: 1, default: 1)
    |   +-- keepOriginalOnReroll: boolean (default: false)
    |-- DefaultDice
    |   |-- skillCheck: string (dice expression, default: "1d10")
    |   |-- attackRoll: string (dice expression, default: "1d20")
    |   |-- saveRoll: string (dice expression, default: "1d20")
    |   |-- damageRoll: string (dice expression, default: "1d6")
    |   |-- initiativeRoll: string (dice expression, default: "1d10")
    |   +-- healingRoll: string (dice expression, default: "1d8")
    +-- DifficultyClass
        |-- id: string (pattern: ^[a-z][a-z0-9-]*$)
        |-- name: string (e.g., "Easy", "Hard")
        |-- dc: integer (minimum: 1)
        |-- description: string (optional)
        +-- sortOrder: integer (minimum: 0)
```

### Critical Thresholds

| Setting | Default | Description |
|---------|---------|-------------|
| `naturalMin` | 1 | Value that triggers critical failure |
| `naturalMax` | "max" | Value that triggers critical success (die maximum) |
| `criticalMultiplier` | 2 | Damage multiplier on critical hit |
| `criticalBonusDice` | null | Extra dice rolled on critical (e.g., "1d6") |
| `autoFailOnNatMin` | true | Natural min always fails regardless of bonuses |
| `autoSuccessOnNatMax` | true | Natural max always succeeds regardless of DC |

### Advantage/Disadvantage Rules

| Setting | Default | Description |
|---------|---------|-------------|
| `advantageDice` | 1 | Roll 1 extra die with advantage |
| `advantageKeep` | Highest | Keep the highest result |
| `disadvantageDice` | 1 | Roll 1 extra die with disadvantage |
| `disadvantageKeep` | Lowest | Keep the lowest result |
| `stackable` | false | Whether multiple advantages/disadvantages stack |

### Default Dice by Category

| Category | Default | Typical Use |
|----------|---------|-------------|
| `skillCheck` | 1d10 | Skill checks against DCs |
| `attackRoll` | 1d20 | Melee/ranged attack rolls |
| `saveRoll` | 1d20 | Saving throws |
| `damageRoll` | 1d6 | Base damage (overridden by weapon) |
| `initiativeRoll` | 1d10 | Combat initiative |
| `healingRoll` | 1d8 | Base healing (overridden by spell) |

### Difficulty Classes

| ID | Name | DC | Description |
|----|------|-----|-------------|
| `trivial` | Trivial | 5 | Almost automatic success |
| `easy` | Easy | 8 | Simple tasks |
| `moderate` | Moderate | 12 | Average difficulty |
| `hard` | Hard | 16 | Challenging tasks |
| `very-hard` | Very Hard | 20 | Expert-level difficulty |
| `nearly-impossible` | Nearly Impossible | 25 | Legendary difficulty |

### Acceptance Criteria

- [x] `dice-mechanics.schema.json` created in `config/schemas/`
- [x] `dice-mechanics.json` created with default mechanics
- [x] Critical thresholds validated
- [x] Advantage/disadvantage rules validated
- [x] Exploding dice rules validated (optional)
- [x] Keep/drop rules validated
- [x] Reroll rules validated
- [x] Default dice expressions validated
- [x] Difficulty classes validated with DC values
- [x] ~6 unit tests pass (40 tests implemented)

---

## Dependencies & Prerequisites

```
v0.14.7 (Descriptor Configuration Schemas) - REQUIRED
    |
    +-- All descriptor schemas available ─────────────────────────────────────┐
                                                                              |
                                      v
v0.14.8 (Dice Configuration Schemas)
    |
    |-- v0.14.8a: Dice Types Schema ──────────────────────────────────────────┐
    |       Dependencies: None                                                 |
    |       Provides: dice-types.schema.json, dice-types.json                  |
    |                                                                          |
    +-- v0.14.8b: Dice Mechanics Schema ──────────────────────────────────────┘
            Dependencies: v0.14.8a (references die types)
            Provides: dice-mechanics.schema.json, dice-mechanics.json

Note: v0.14.8a must be completed first as it defines valid die types.
      v0.14.8b references die types for expression validation.
```

---

## Estimated Effort Summary

| Part | New Files | Modified Files | Est. Tests | Complexity |
|------|-----------|----------------|------------|------------|
| v0.14.8a | 2 | 0 | ~6 | Medium |
| v0.14.8b | 2 | 0 | ~6 | Medium |
| **Total** | **4** | **0** | **~12** | |

---

## Risk Assessment

| Risk | Impact | Probability | Mitigation |
|------|--------|-------------|------------|
| Expression pattern complexity | Medium | Low | Use well-tested regex patterns |
| Backwards compatibility with existing dice strings | Low | Low | Ensure pattern matches current usage |
| Exploding dice infinite loops | Low | Low | Enforce maxExplosions limit |
| Custom die type edge cases | Low | Low | Validate faces >= 2 |

---

## Design Decisions (Confirmed)

### Schema Standards

| Decision | Value | Notes |
|----------|-------|-------|
| **JSON Schema Version** | Draft-07 | Consistent with v0.14.0-v0.14.7 |
| **Die Type ID Pattern** | `^d\d+$` | "d" followed by face count |
| **Expression Pattern** | `^\d+d\d+([+-]\d+)?$` | Standard dice notation |
| **Schema Location** | `config/schemas/` | Centralized schema storage |

### Dice Type Design

| Decision | Value | Notes |
|----------|-------|-------|
| **Standard Dice** | d4, d6, d8, d10, d12, d20, d100 | Common RPG dice |
| **Minimum Faces** | 2 | Coin flip minimum |
| **Default Min Value** | 1 | Standard die starts at 1 |
| **Custom Dice** | Supported | Arbitrary face counts allowed |

### Dice Mechanics Design

| Decision | Value | Notes |
|----------|-------|-------|
| **Critical Min** | 1 | Natural 1 is critical failure |
| **Critical Max** | Die maximum | Natural max is critical success |
| **Advantage Default** | Roll 2, keep highest | Standard advantage rule |
| **Exploding Dice** | Optional | Disabled by default |
| **Max Explosions** | 10 | Prevent infinite loops |

### Default Dice Assignments

| Decision | Value | Notes |
|----------|-------|-------|
| **Skill Checks** | 1d10 | Matches current skills.json |
| **Attack Rolls** | 1d20 | Traditional d20 system |
| **Save Rolls** | 1d20 | Consistent with attacks |
| **Initiative** | 1d10 | Quick resolution |

---

## Integration Points

### Impact on Existing Schemas

Once v0.14.8 is complete, the dice expression pattern can be referenced by:

| Schema | Field | Current Pattern | Future Reference |
|--------|-------|-----------------|------------------|
| `skills.schema.json` | `baseDicePool` | Inline pattern | `$ref: dice-types.schema.json#/definitions/DiceExpression` |
| `hazards.schema.json` | `dice` | Inline pattern | `$ref: dice-types.schema.json#/definitions/DiceExpression` |
| `weapons.schema.json` | `damage` | Inline pattern | `$ref: dice-types.schema.json#/definitions/DiceExpression` |
| `abilities.schema.json` | `damage` | Inline pattern | `$ref: dice-types.schema.json#/definitions/DiceExpression` |

### Cross-Reference Benefits

- Single source of truth for dice expression validation
- Consistent error messages across all dice fields
- Easy to update dice notation if patterns change
- Enables tooling to understand dice expressions

---

## Next Steps

1. **Review & Approve** - Confirm scope breakdown
2. **v0.14.8a Design Spec** - Create dice types schema
3. **v0.14.8a Implementation** - Build dice-types.schema.json, dice-types.json
4. **v0.14.8b Design Spec** - Create dice mechanics schema
5. **v0.14.8b Implementation** - Build dice-mechanics.schema.json, dice-mechanics.json
6. **Update v0.14.x-overview.md** - Add v0.14.8 section

---

*This scope breakdown provides a structured approach to implementing v0.14.8 Dice Configuration Schemas. The dice types schema (v0.14.8a) must be completed first as it defines the valid die types referenced by the mechanics schema (v0.14.8b). Together, these schemas enable full customization of dice mechanics including custom die types, alternative pool rules, and probability-tuned roll mechanics without code changes.*
