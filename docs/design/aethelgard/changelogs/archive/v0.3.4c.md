> **Archived** - This changelog has been consolidated. See the complete version at [v0.3.4](../v0.3.x/v0.3.4.md).

# Changelog: v0.3.4c - The Prologue (Narrative)

**Release Date:** 2025-12-21

## Summary

This release implements a narrative engine to deliver immersive, typewriter-style introductory sequences after character creation. The NarrativeService generates Domain 4-compliant prologue text based on the player's chosen Background, while the TypewriterRenderer provides animated text output with dynamic pacing and skip functionality. A critical fix bridges the character from CreationWizard to GameState, ensuring proper world initialization before the game loop starts. This release includes a new Background selection step in the character creation wizard and 37 unit tests validating prologue generation and Domain 4 compliance.

---

## New Files Created

### Core Layer
| File | Purpose |
|------|---------|
| `RuneAndRust.Core/Enums/BackgroundType.cs` | Enum for narrative backgrounds: Scavenger, Exile, Scholar, Soldier, Noble, Cultist |
| `RuneAndRust.Core/Interfaces/INarrativeService.cs` | Interface for prologue text generation |
| `RuneAndRust.Core/Interfaces/ITypewriterRenderer.cs` | Interface for typewriter animation |

### Engine Layer
| File | Purpose |
|------|---------|
| `RuneAndRust.Engine/Services/NarrativeService.cs` | Generates Domain 4-compliant prologue text for each background |

### Terminal Layer
| File | Purpose |
|------|---------|
| `RuneAndRust.Terminal/Rendering/TypewriterRenderer.cs` | Animated text output with dynamic pacing and skip functionality |

### Test Layer
| File | Purpose |
|------|---------|
| `RuneAndRust.Tests/Engine/NarrativeServiceTests.cs` | 37 unit tests for prologue generation and Domain 4 compliance |

---

## Files Modified

| File | Change |
|------|--------|
| `RuneAndRust.Core/Entities/Character.cs` | Added `BackgroundType Background` property |
| `RuneAndRust.Core/Models/WizardContext.cs` | Added `BackgroundType? Background` property, updated IsStepComplete, Reset, ClearCurrentStep |
| `RuneAndRust.Engine/Factories/CharacterFactory.cs` | Updated CreateSimple() to accept BackgroundType parameter |
| `RuneAndRust.Terminal/Services/CreationWizard.cs` | Added INarrativeService dependency, Step 3 Background selection, RunSimpleSelectionStepAsync method |
| `RuneAndRust.Terminal/Program.cs` | CRITICAL FIX: Capture character from wizard, bridge to GameState, initialize dungeon, play prologue, register new services, update version to v0.3.4c |

---

## Code Implementation Details

### BackgroundType Enum

```csharp
public enum BackgroundType
{
    Scavenger = 0,  // Born among the rust heaps, surviving on salvage
    Exile = 1,      // Cast out from a settlement for crimes real or imagined
    Scholar = 2,    // Seeker of forbidden knowledge from the old world
    Soldier = 3,    // Former soldier from a fallen outpost
    Noble = 4,      // Survivor of noble lineage, now dispossessed
    Cultist = 5     // Once a follower of a corrupted faith
}
```

### NarrativeService Prologue Generation

```csharp
public string GetPrologueText(Character character)
{
    return character.Background switch
    {
        BackgroundType.Scavenger =>
            $"The rust has always been your horizon, {character.Name}. You were born in the shadow of " +
            $"the Great Looms, scavenging the bones of dead gods...",

        BackgroundType.Scholar =>
            $"You have read the forbidden slates, {character.Name}. You know the world is not a tragedy, " +
            $"but a broken mechanism...",

        // ... other backgrounds
    };
}
```

### TypewriterRenderer with Dynamic Pacing

```csharp
public async Task PlaySequenceAsync(string text, int delayMs = 30)
{
    foreach (char c in text)
    {
        if (Console.KeyAvailable)
        {
            Console.ReadKey(intercept: true);
            // Print remaining text instantly
            var remaining = text.Substring(charIndex);
            AnsiConsole.Markup($"[grey]{Markup.Escape(remaining)}[/]");
            break;
        }

        AnsiConsole.Markup($"[grey]{Markup.Escape(c.ToString())}[/]");

        // Dynamic pacing: longer pause at punctuation
        var currentDelay = c is '.' or '!' or '?' ? delayMs * 8 :
                           c is ',' or ';' or ':' ? delayMs * 3 :
                           c is '—' ? delayMs * 4 : delayMs;
        await Task.Delay(currentDelay);
    }

    AnsiConsole.MarkupLine("[grey italic]Press any key to enter the ruins...[/]");
    Console.ReadKey(intercept: true);
}
```

### Critical Bridge Fix in Program.cs

```csharp
case MainMenuOption.NewGame:
    Character? character = null;
    using (var scope = host.Services.CreateScope())
    {
        var wizard = scope.ServiceProvider.GetRequiredService<CreationWizard>();
        character = wizard.RunAsync().GetAwaiter().GetResult();
    }

    if (character != null)
    {
        // CRITICAL FIX: Bridge character to GameState
        var gameState = host.Services.GetRequiredService<GameState>();
        gameState.CurrentCharacter = character;
        gameState.Phase = GamePhase.Exploration;

        // Generate starting dungeon
        using (var scope = host.Services.CreateScope())
        {
            var dungeonGen = scope.ServiceProvider.GetRequiredService<DungeonGenerator>();
            var startRoomId = dungeonGen.GenerateTestMapAsync().GetAwaiter().GetResult();
            gameState.CurrentRoomId = startRoomId;
        }

        // Play prologue
        using (var scope = host.Services.CreateScope())
        {
            var narrative = scope.ServiceProvider.GetRequiredService<INarrativeService>();
            var typewriter = scope.ServiceProvider.GetRequiredService<ITypewriterRenderer>();
            var prologueText = narrative.GetPrologueText(character);
            typewriter.PlaySequenceAsync(prologueText).GetAwaiter().GetResult();
        }
    }
    break;
```

---

## Background Templates (Domain 4 Compliant)

| Background | Prologue Theme | Key Imagery |
|------------|---------------|-------------|
| Scavenger | Born in rust, survival instinct | Great Looms, dead gods, thinning scrap |
| Scholar | Forbidden knowledge, broken mechanism | Forbidden slates, Iron Hearts, burden of understanding |
| Exile | Outcast, survival alone | Stones and curses, wastelands, cold stars |
| Soldier | Fallen defender, lost purpose | Screaming iron, fallen walls, forgotten peace |
| Noble | Fallen aristocracy, blood-earned respect | Black glass towers, worthless bloodline |
| Cultist | Corrupted faith, seeking silence | Corroded Altar, forbidden prayers, unhearable voice |

---

## Test Coverage

### NarrativeServiceTests (37 tests)

| Test Name | Description |
|-----------|-------------|
| `GetPrologueText_Scavenger_ContainsGreatLooms` | Scavenger text includes "Great Looms" |
| `GetPrologueText_Scholar_ContainsForbiddenSlates` | Scholar text includes "forbidden slates" |
| `GetPrologueText_AllBackgrounds_ContainsCharacterName` | Theory: All 6 prologues include character name |
| `GetPrologueText_AllBackgrounds_ContainsArchetype` | Theory: All prologues include archetype |
| `GetPrologueText_NoPrecisionMeasurements` | Theory: No "meters", "seconds", "percent" in text (Domain 4) |
| `GetPrologueText_Exile_ContainsWastelands` | Exile text includes "wastelands" |
| `GetPrologueText_Soldier_ContainsWallsFell` | Soldier text includes "walls fell" |
| `GetPrologueText_Noble_ContainsBlackGlass` | Noble text includes "black glass" |
| `GetPrologueText_Cultist_ContainsCorrodedAltar` | Cultist text includes "Corroded Altar" |
| `GetBackgroundDisplayName_ReturnsCorrectName` | Theory: All 6 backgrounds return correct names |
| `GetBackgroundDescription_ReturnsNonEmpty` | Theory: All backgrounds have descriptions |
| `GetBackgroundDescription_Scavenger_ContainsSalvage` | Scavenger description includes "salvage" |

---

## Logging Matrix

| Context | Level | Template |
|---------|-------|----------|
| Prologue Start | Info | `"[Narrative] Generating prologue for {Name}, Background: {Background}"` |
| Prologue Length | Debug | `"[Narrative] Prologue generated: {Length} characters"` |
| Typewriter Start | Info | `"[Narrative] Starting typewriter sequence, {Length} characters"` |
| Prologue Skip | Debug | `"[Narrative] User skipped prologue sequence at character {Index}"` |
| Prologue End | Info | `"[Narrative] Prologue complete. Transitioning to Exploration."` |
| Character Bridge | Debug | `"[Program] Character {Name} set to GameState"` |
| World Init | Info | `"[Program] World initialized: Starting room {RoomId}"` |

---

## User Interface

### Character Creation Flow (Updated)

```
Step 0: Name Entry (blocking TextPrompt)
   ↓
Step 1: Lineage Selection (split-screen with stat preview)
   ↓
Step 2: Archetype Selection (split-screen with stat preview)
   ↓
Step 3: Background Selection (simple menu) ← NEW
   ↓
Character Created → Dungeon Generated → Prologue Played → Game Loop
```

### Prologue Display

```
────────────────────────────────────────────────────────────────────
 PROLOGUE
────────────────────────────────────────────────────────────────────

The rust has always been your horizon, Ragnar. You were born in the
shadow of the Great Looms, scavenging the bones of dead gods while
others huddled behind their walls. But the scrap is thinning. The
whispers in the dark grow louder. You seek the Warrior path not for
glory, but to survive the silence that follows the machines.



Press any key to enter the ruins...
```

---

## Dependencies

- `Spectre.Console` - AnsiConsole, Rule, Markup for typewriter rendering
- `Microsoft.Extensions.Logging` - Structured logging
- `RuneAndRust.Core.Entities.Character` - Character entity with Background property
- `RuneAndRust.Engine.Services.DungeonGenerator` - World initialization

---

## Critical Fixes

### Issue: Character Not Bridged to GameState

**Before v0.3.4c:**
- CreationWizard returned Character but Program.cs ignored the return value
- GameState.CurrentCharacter remained null after wizard
- No dungeon was generated before GameService.StartAsync()

**After v0.3.4c:**
- Character captured from wizard return value
- GameState.CurrentCharacter properly set
- DungeonGenerator.GenerateTestMapAsync() called to create starting room
- GameState.CurrentRoomId set to starting room
- GamePhase set to Exploration before game loop
- Prologue played after world initialization

---

## Notes

- All prologue text is **Domain 4 compliant**: no precision measurements, no modern tech terms
- Typewriter uses dynamic pacing: 8x delay at periods, 3x at commas, 4x at em dashes
- Skip functionality uses `Console.KeyAvailable` check each character
- Background selection uses simple menu (no stat preview needed)
- Character must be bridged to GameState BEFORE GameService.StartAsync()
- Version string updated to v0.3.4c in Program.cs boot message
