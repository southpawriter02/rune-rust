# v0.16.3c Design Specification: Weighted Item Selection

**Version:** 0.16.3c  
**Phase Name:** Weighted Item Selection  
**Parent Version:** v0.16.3 (Smart Loot Generation)  
**Prerequisites:** v0.16.3b Complete (Smart Loot Algorithm)  
**Estimated Tests:** ~3 unit tests

---

## Table of Contents

1. [Executive Summary](#1-executive-summary)
2. [Feature Overview](#2-feature-overview)
3. [Architecture Diagrams](#3-architecture-diagrams)
4. [WeightedItem Value Object](#4-weighteditem-value-object)
5. [WeightedItemPool Entity](#5-weighteditempool-entity)
6. [Weighted Selection Algorithm](#6-weighted-selection-algorithm)
7. [Data Model Changes](#7-data-model-changes)
8. [Logging Specifications](#8-logging-specifications)
9. [Unit Testing Requirements](#9-unit-testing-requirements)
10. [Use Cases](#10-use-cases)
11. [Deliverable Checklist](#11-deliverable-checklist)
12. [Acceptance Criteria](#12-acceptance-criteria)
13. [Dependencies](#13-dependencies)
14. [Future Considerations](#14-future-considerations)

---

## 1. Executive Summary

### 1.1 Purpose

This specification defines the weighted random selection system for loot drops. Unlike uniform random selection where all items have equal chance, weighted selection allows rarer items to drop less frequently based on configurable weight values.

The weight distribution follows a rarity-based model:

| Rarity    | Weight | Drop Rate (Approx) |
| --------- | ------ | ------------------ |
| Common    | 100    | ~52.6%             |
| Uncommon  | 50     | ~26.3%             |
| Rare      | 25     | ~13.2%             |
| Very Rare | 10     | ~5.3%              |
| Unique    | 5      | ~2.6%              |

This phase provides the data structures (`WeightedItem`, `WeightedItemPool`) and selection algorithm. Integration with `ISmartLootService` is handled in v0.16.3d.

### 1.2 Key Deliverables

| Category          | Items              |
| ----------------- | ------------------ |
| **Value Objects** | `WeightedItem`     |
| **Entities**      | `WeightedItemPool` |
| **Tests**         | ~3 unit tests      |

### 1.3 Architectural Significance

This version establishes the **Weighted Selection Pattern**:

- **Weight-Based Probability**: Items selected based on relative weight, not uniform random
- **Pool Aggregation**: `WeightedItemPool` manages items with weight totals
- **Zero-Weight Exclusion**: Items with weight 0 are never selected
- **Cumulative Selection**: Efficient O(log n) selection using cumulative weights

---

## 2. Feature Overview

```
v0.16.3c Weighted Item Selection
├── WeightedItem Value Object
│   ├── Item: LootEntry (the underlying item)
│   ├── Weight: int (selection weight, e.g., 100, 50, 25)
│   ├── Rarity: string (optional display label)
│   └── SelectionProbability: double (calculated from pool)
├── WeightedItemPool Entity
│   ├── Items: IReadOnlyList<WeightedItem>
│   ├── TotalWeight: int
│   ├── Add(item, weight): void
│   ├── Remove(itemId): bool
│   ├── SelectRandom(random): WeightedItem
│   ├── SelectRandom(seed): WeightedItem (for testing)
│   └── GetSelectionProbability(itemId): double
└── Selection Algorithm
    ├── Calculate cumulative weights
    ├── Roll random 0 to TotalWeight-1
    ├── Binary search for matching item
    └── Return selected WeightedItem
```

### 2.1 Weight Distribution Reference

```
┌─────────────────────────────────────────────────────────────────────┐
│                    WEIGHT DISTRIBUTION TABLE                         │
└─────────────────────────────────────────────────────────────────────┘

| Rarity    | Weight | Example Items                              |
|-----------|--------|--------------------------------------------|
| Common    | 100    | Iron Sword, Leather Armor, Healing Potion  |
| Uncommon  | 50     | Steel Blade, Chain Mail, Greater Potion    |
| Rare      | 25     | Runed Axe, Mithril Plate, Elixir           |
| Very Rare | 10     | Dragon Slayer, Phoenix Armor, Epic Scroll  |
| Unique    | 5      | Excalibur, Crown of Kings, Legendary Rune  |

Example Pool (5 items, one of each rarity):
─────────────────────────────────────────────
Total Weight: 100 + 50 + 25 + 10 + 5 = 190

Selection Probabilities:
  Common:    100/190 = 52.63%
  Uncommon:   50/190 = 26.32%
  Rare:       25/190 = 13.16%
  Very Rare:  10/190 =  5.26%
  Unique:      5/190 =  2.63%
```

### 2.2 Scope Alignment

**In Scope:**

- `WeightedItem` value object with item and weight
- `WeightedItemPool` entity for managing weighted collections
- Weighted random selection algorithm
- Probability calculation methods
- Zero-weight item exclusion

**Out of Scope:**

- LootService integration (v0.16.3d)
- Configuration file for weights (future consideration)
- Dynamic weight modification during gameplay

---

## 3. Architecture Diagrams

### 3.1 Weighted Selection System Overview

```
┌─────────────────────────────────────────────────────────────────────┐
│              WEIGHTED SELECTION SYSTEM OVERVIEW                      │
└─────────────────────────────────────────────────────────────────────┘

    SmartLootService (v0.16.3b)
           │
           │  Request item selection
           ▼
┌─────────────────────────────────────────────────────────────────────┐
│                      WeightedItemPool                                │
├─────────────────────────────────────────────────────────────────────┤
│  Items: IReadOnlyList<WeightedItem>                                 │
│  TotalWeight: int                                                   │
│  ItemCount: int                                                     │
├─────────────────────────────────────────────────────────────────────┤
│  + Add(item, weight): void                                          │
│  + Remove(itemId): bool                                             │
│  + SelectRandom(random): WeightedItem                               │
│  + SelectRandom(seed): WeightedItem                                 │
│  + GetSelectionProbability(itemId): double                          │
│  + Contains(itemId): bool                                           │
└─────────────────────────────────────────────────────────────────────┘
           │
           │  Contains weighted items
           ▼
┌─────────────────────────────────────────────────────────────────────┐
│                        WeightedItem                                  │
├─────────────────────────────────────────────────────────────────────┤
│  Item: LootEntry             (the underlying item data)             │
│  Weight: int                 (selection weight, e.g., 100)          │
│  Rarity: string              (display label, e.g., "Common")        │
│  CumulativeWeight: int       (sum of weights up to this item)       │
└─────────────────────────────────────────────────────────────────────┘
```

### 3.2 Weighted Selection Algorithm Flow

```
┌─────────────────────────────────────────────────────────────────────┐
│              WEIGHTED SELECTION ALGORITHM FLOW                       │
└─────────────────────────────────────────────────────────────────────┘

    SelectRandom() Called
           │
           ▼
    ┌──────────────────────────────────────────────────────────────────┐
    │  STEP 1: VALIDATE POOL                                           │
    ├──────────────────────────────────────────────────────────────────┤
    │  Pool empty?                                                     │
    │    → Throw InvalidOperationException                             │
    │                                                                  │
    │  TotalWeight == 0?                                               │
    │    → Throw InvalidOperationException (all weights zero)          │
    └──────────────────────────────────────────────────────────────────┘
           │
           ▼
    ┌──────────────────────────────────────────────────────────────────┐
    │  STEP 2: GENERATE RANDOM VALUE                                   │
    ├──────────────────────────────────────────────────────────────────┤
    │  roll = Random.Next(0, TotalWeight)                              │
    │                                                                  │
    │  Example: TotalWeight = 190                                      │
    │           roll = 73 (a random value 0-189)                       │
    └──────────────────────────────────────────────────────────────────┘
           │
           ▼
    ┌──────────────────────────────────────────────────────────────────┐
    │  STEP 3: FIND MATCHING ITEM (Binary Search)                      │
    ├──────────────────────────────────────────────────────────────────┤
    │  Cumulative Weights:                                             │
    │    Item 0 (Common):    0 to 99   (cumulative: 100)              │
    │    Item 1 (Uncommon): 100 to 149 (cumulative: 150)              │
    │    Item 2 (Rare):     150 to 174 (cumulative: 175)              │
    │    Item 3 (VeryRare): 175 to 184 (cumulative: 185)              │
    │    Item 4 (Unique):   185 to 189 (cumulative: 190)              │
    │                                                                  │
    │  roll = 73 falls in range 0-99 → Select Item 0 (Common)         │
    └──────────────────────────────────────────────────────────────────┘
           │
           ▼
    ┌──────────────────────────────────────────────────────────────────┐
    │  STEP 4: RETURN SELECTED ITEM                                    │
    ├──────────────────────────────────────────────────────────────────┤
    │  Return WeightedItem with:                                       │
    │    - Item (LootEntry)                                            │
    │    - Weight (100)                                                │
    │    - Rarity ("Common")                                           │
    └──────────────────────────────────────────────────────────────────┘
```

### 3.3 Cumulative Weight Visualization

```
┌─────────────────────────────────────────────────────────────────────┐
│                CUMULATIVE WEIGHT VISUALIZATION                       │
└─────────────────────────────────────────────────────────────────────┘

    Total Weight Range: 0 to 189 (TotalWeight = 190)

    ├────────────────────────────────────────────────────────────────────┤
    │          COMMON (100)         │ UNCOMMON (50) │RARE│VR│U│
    │             52.6%             │     26.3%     │13.2│5.3│2.6│
    ├────────────────────────────────────────────────────────────────────┤
    0                              100             150  175 185 190

    Roll Examples:
    ─────────────────────────────────────────────────────────────────────
    Roll = 15   → Common    (0-99 range)
    Roll = 73   → Common    (0-99 range)
    Roll = 125  → Uncommon  (100-149 range)
    Roll = 165  → Rare      (150-174 range)
    Roll = 180  → Very Rare (175-184 range)
    Roll = 187  → Unique    (185-189 range)
```

### 3.4 Layer Diagram

```
┌─────────────────────────────────────────────────────────────────────┐
│                        APPLICATION LAYER                             │
├─────────────────────────────────────────────────────────────────────┤
│  SmartLootService (v0.16.3b)                                         │
│  └── Uses WeightedItemPool for selection                            │
│                                                                      │
│  LootService (v0.16.3d - future)                                     │
│  └── Creates WeightedItemPool from available items                   │
└───────┬─────────────────────────────────────────────────────────────┘
        │
        ▼
┌─────────────────────────────────────────────────────────────────────┐
│                         DOMAIN LAYER                                 │
├─────────────────────────────────────────────────────────────────────┤
│  ┌─────────────────────────────────────────────────────────────────┐│
│  │                    WeightedItemPool                             ││
│  │                      (Entity)                                    ││
│  ├─────────────────────────────────────────────────────────────────┤│
│  │  Id: Guid                                                       ││
│  │  Items: List<WeightedItem>                                      ││
│  │  TotalWeight: int (calculated)                                  ││
│  │  _cumulativeWeights: List<int> (for binary search)              ││
│  ├─────────────────────────────────────────────────────────────────┤│
│  │  + Create(): WeightedItemPool                                   ││
│  │  + Add(item, weight, rarity): void                              ││
│  │  + AddRange(weightedItems): void                                ││
│  │  + Remove(itemId): bool                                         ││
│  │  + SelectRandom(Random): WeightedItem                           ││
│  │  + SelectRandom(int seed): WeightedItem                         ││
│  │  + GetSelectionProbability(itemId): double                      ││
│  │  + Contains(itemId): bool                                       ││
│  │  + Clear(): void                                                ││
│  └─────────────────────────────────────────────────────────────────┘│
│                                                                      │
│  ┌─────────────────────────────────────────────────────────────────┐│
│  │                      WeightedItem                               ││
│  │                   (Value Object)                                 ││
│  ├─────────────────────────────────────────────────────────────────┤│
│  │  Item: LootEntry                                                ││
│  │  Weight: int                                                    ││
│  │  Rarity: string                                                 ││
│  ├─────────────────────────────────────────────────────────────────┤│
│  │  + IsSelectable: bool (Weight > 0)                              ││
│  │  + SelectionProbability(totalWeight): double                    ││
│  │  + Create(item, weight, rarity): WeightedItem                   ││
│  └─────────────────────────────────────────────────────────────────┘│
└─────────────────────────────────────────────────────────────────────┘
```

---

## 4. WeightedItem Value Object

### 4.1 Purpose

The `WeightedItem` value object wraps a `LootEntry` with its selection weight and optional rarity label.

### 4.2 Implementation

**File:** `src/Core/RuneAndRust.Domain/ValueObjects/WeightedItem.cs`

```csharp
namespace RuneAndRust.Domain.ValueObjects;

/// <summary>
/// Represents an item with an associated selection weight.
/// </summary>
/// <remarks>
/// <para>
/// WeightedItem wraps a LootEntry with a weight value that determines
/// its relative probability of being selected from a WeightedItemPool.
/// </para>
/// <para>
/// Higher weights mean higher selection probability. A weight of 100
/// is twice as likely to be selected as a weight of 50.
/// </para>
/// <para>
/// Items with Weight = 0 are never selected (excluded from selection).
/// </para>
/// </remarks>
/// <param name="Item">The underlying loot entry.</param>
/// <param name="Weight">Selection weight (higher = more likely). Must be >= 0.</param>
/// <param name="Rarity">Optional display label (e.g., "Common", "Rare").</param>
public readonly record struct WeightedItem(
    LootEntry Item,
    int Weight,
    string Rarity = "")
{
    /// <summary>
    /// Standard weight for Common items.
    /// </summary>
    public const int CommonWeight = 100;

    /// <summary>
    /// Standard weight for Uncommon items.
    /// </summary>
    public const int UncommonWeight = 50;

    /// <summary>
    /// Standard weight for Rare items.
    /// </summary>
    public const int RareWeight = 25;

    /// <summary>
    /// Standard weight for Very Rare items.
    /// </summary>
    public const int VeryRareWeight = 10;

    /// <summary>
    /// Standard weight for Unique items.
    /// </summary>
    public const int UniqueWeight = 5;

    /// <summary>
    /// Gets whether this item can be selected (weight > 0).
    /// </summary>
    public bool IsSelectable => Weight > 0;

    /// <summary>
    /// Gets the item's ID from the underlying LootEntry.
    /// </summary>
    public string ItemId => Item.ItemId;

    /// <summary>
    /// Calculates selection probability given a pool's total weight.
    /// </summary>
    /// <param name="totalWeight">The sum of all weights in the pool.</param>
    /// <returns>Probability as a value between 0 and 1.</returns>
    public double GetSelectionProbability(int totalWeight) =>
        totalWeight > 0 ? (double)Weight / totalWeight : 0;

    /// <summary>
    /// Formats selection probability as a percentage string.
    /// </summary>
    /// <param name="totalWeight">The sum of all weights in the pool.</param>
    /// <returns>Formatted percentage (e.g., "52.63%").</returns>
    public string FormatProbability(int totalWeight) =>
        $"{GetSelectionProbability(totalWeight) * 100:F2}%";

    /// <summary>
    /// Creates a WeightedItem with validation.
    /// </summary>
    public static WeightedItem Create(
        LootEntry item,
        int weight,
        string rarity = "")
    {
        ArgumentNullException.ThrowIfNull(item);
        ArgumentOutOfRangeException.ThrowIfNegative(weight);

        return new WeightedItem(item, weight, rarity ?? string.Empty);
    }

    /// <summary>
    /// Creates a Common-weight item.
    /// </summary>
    public static WeightedItem CreateCommon(LootEntry item) =>
        new(item, CommonWeight, "Common");

    /// <summary>
    /// Creates an Uncommon-weight item.
    /// </summary>
    public static WeightedItem CreateUncommon(LootEntry item) =>
        new(item, UncommonWeight, "Uncommon");

    /// <summary>
    /// Creates a Rare-weight item.
    /// </summary>
    public static WeightedItem CreateRare(LootEntry item) =>
        new(item, RareWeight, "Rare");

    /// <summary>
    /// Creates a Very Rare-weight item.
    /// </summary>
    public static WeightedItem CreateVeryRare(LootEntry item) =>
        new(item, VeryRareWeight, "Very Rare");

    /// <summary>
    /// Creates a Unique-weight item.
    /// </summary>
    public static WeightedItem CreateUnique(LootEntry item) =>
        new(item, UniqueWeight, "Unique");

    /// <summary>
    /// Creates a display string for debug/logging.
    /// </summary>
    public override string ToString() =>
        $"{Item.ItemId} (Weight={Weight}, Rarity={Rarity})";
}
```

---

## 5. WeightedItemPool Entity

### 5.1 Purpose

The `WeightedItemPool` entity manages a collection of weighted items and provides efficient weighted random selection.

### 5.2 Implementation

**File:** `src/Core/RuneAndRust.Domain/Entities/WeightedItemPool.cs`

```csharp
namespace RuneAndRust.Domain.Entities;

using RuneAndRust.Domain.ValueObjects;

/// <summary>
/// Manages a collection of weighted items for random selection.
/// </summary>
/// <remarks>
/// <para>
/// WeightedItemPool provides O(log n) weighted random selection using
/// cumulative weights and binary search.
/// </para>
/// <para>
/// Items with Weight = 0 are stored but excluded from selection.
/// Empty pools throw InvalidOperationException on selection attempts.
/// </para>
/// </remarks>
public class WeightedItemPool : IEntity
{
    private readonly List<WeightedItem> _items = new();
    private readonly List<int> _cumulativeWeights = new();
    private int _totalWeight;
    private bool _isDirty;

    /// <summary>
    /// Gets the unique identifier.
    /// </summary>
    public Guid Id { get; private set; }

    /// <summary>
    /// Gets the items in this pool.
    /// </summary>
    public IReadOnlyList<WeightedItem> Items => _items.AsReadOnly();

    /// <summary>
    /// Gets the total weight of all selectable items.
    /// </summary>
    public int TotalWeight
    {
        get
        {
            EnsureCumulativeWeightsUpdated();
            return _totalWeight;
        }
    }

    /// <summary>
    /// Gets the count of items in the pool.
    /// </summary>
    public int ItemCount => _items.Count;

    /// <summary>
    /// Gets the count of selectable items (weight > 0).
    /// </summary>
    public int SelectableItemCount => _items.Count(i => i.IsSelectable);

    /// <summary>
    /// Gets whether the pool has any selectable items.
    /// </summary>
    public bool HasSelectableItems => TotalWeight > 0;

    /// <summary>
    /// Private constructor for EF Core.
    /// </summary>
    private WeightedItemPool()
    {
        Id = Guid.NewGuid();
    }

    /// <summary>
    /// Creates an empty WeightedItemPool.
    /// </summary>
    public static WeightedItemPool Create() => new();

    /// <summary>
    /// Creates a WeightedItemPool from existing weighted items.
    /// </summary>
    public static WeightedItemPool CreateFrom(IEnumerable<WeightedItem> items)
    {
        var pool = new WeightedItemPool();
        pool.AddRange(items);
        return pool;
    }

    /// <summary>
    /// Adds an item with the specified weight.
    /// </summary>
    /// <param name="item">The loot entry to add.</param>
    /// <param name="weight">Selection weight (>= 0).</param>
    /// <param name="rarity">Optional rarity label.</param>
    public void Add(LootEntry item, int weight, string rarity = "")
    {
        ArgumentNullException.ThrowIfNull(item);
        ArgumentOutOfRangeException.ThrowIfNegative(weight);

        _items.Add(WeightedItem.Create(item, weight, rarity));
        _isDirty = true;
    }

    /// <summary>
    /// Adds a pre-created WeightedItem.
    /// </summary>
    public void Add(WeightedItem weightedItem)
    {
        _items.Add(weightedItem);
        _isDirty = true;
    }

    /// <summary>
    /// Adds multiple weighted items.
    /// </summary>
    public void AddRange(IEnumerable<WeightedItem> items)
    {
        ArgumentNullException.ThrowIfNull(items);
        _items.AddRange(items);
        _isDirty = true;
    }

    /// <summary>
    /// Removes an item by ID.
    /// </summary>
    /// <returns>True if item was found and removed.</returns>
    public bool Remove(string itemId)
    {
        var index = _items.FindIndex(i => i.ItemId == itemId);
        if (index < 0) return false;

        _items.RemoveAt(index);
        _isDirty = true;
        return true;
    }

    /// <summary>
    /// Checks if an item exists in the pool.
    /// </summary>
    public bool Contains(string itemId) =>
        _items.Any(i => i.ItemId == itemId);

    /// <summary>
    /// Clears all items from the pool.
    /// </summary>
    public void Clear()
    {
        _items.Clear();
        _cumulativeWeights.Clear();
        _totalWeight = 0;
        _isDirty = false;
    }

    /// <summary>
    /// Selects a random item using weighted probability.
    /// </summary>
    /// <param name="random">Random number generator.</param>
    /// <returns>The selected WeightedItem.</returns>
    /// <exception cref="InvalidOperationException">Pool is empty or has no selectable items.</exception>
    public WeightedItem SelectRandom(Random random)
    {
        ArgumentNullException.ThrowIfNull(random);
        EnsureCumulativeWeightsUpdated();

        if (_items.Count == 0)
            throw new InvalidOperationException("Cannot select from empty pool.");

        if (_totalWeight == 0)
            throw new InvalidOperationException("No selectable items (all weights are zero).");

        // Roll random value in weight range
        var roll = random.Next(0, _totalWeight);

        // Binary search for the item
        return FindItemByRoll(roll);
    }

    /// <summary>
    /// Selects a random item using a seed (for testing).
    /// </summary>
    /// <param name="seed">Random seed for deterministic results.</param>
    /// <returns>The selected WeightedItem.</returns>
    public WeightedItem SelectRandom(int seed) =>
        SelectRandom(new Random(seed));

    /// <summary>
    /// Gets the selection probability for an item.
    /// </summary>
    /// <param name="itemId">The item ID to check.</param>
    /// <returns>Probability as value between 0 and 1, or 0 if not found.</returns>
    public double GetSelectionProbability(string itemId)
    {
        EnsureCumulativeWeightsUpdated();

        var item = _items.FirstOrDefault(i => i.ItemId == itemId);
        return item.Weight > 0 && _totalWeight > 0
            ? (double)item.Weight / _totalWeight
            : 0;
    }

    /// <summary>
    /// Gets all selection probabilities as a dictionary.
    /// </summary>
    public IReadOnlyDictionary<string, double> GetAllProbabilities()
    {
        EnsureCumulativeWeightsUpdated();

        return _items.ToDictionary(
            i => i.ItemId,
            i => i.GetSelectionProbability(_totalWeight));
    }

    /// <summary>
    /// Recalculates cumulative weights if items have changed.
    /// </summary>
    private void EnsureCumulativeWeightsUpdated()
    {
        if (!_isDirty) return;

        _cumulativeWeights.Clear();
        _totalWeight = 0;

        foreach (var item in _items)
        {
            if (item.Weight > 0)
            {
                _totalWeight += item.Weight;
            }
            _cumulativeWeights.Add(_totalWeight);
        }

        _isDirty = false;
    }

    /// <summary>
    /// Finds the item corresponding to a roll value using binary search.
    /// </summary>
    private WeightedItem FindItemByRoll(int roll)
    {
        // Binary search for the first cumulative weight > roll
        var low = 0;
        var high = _items.Count - 1;

        while (low < high)
        {
            var mid = (low + high) / 2;

            if (_cumulativeWeights[mid] <= roll)
            {
                low = mid + 1;
            }
            else
            {
                high = mid;
            }
        }

        return _items[low];
    }

    /// <summary>
    /// Creates a display string for debug/logging.
    /// </summary>
    public override string ToString() =>
        $"WeightedItemPool: {ItemCount} items, TotalWeight={TotalWeight}";
}
```

---

## 6. Weighted Selection Algorithm

### 6.1 Algorithm Details

```
FUNCTION SelectRandom(pool: WeightedItemPool, random: Random) -> WeightedItem:

    // Step 1: Validate pool state
    IF pool.ItemCount == 0:
        THROW InvalidOperationException("Empty pool")

    IF pool.TotalWeight == 0:
        THROW InvalidOperationException("No selectable items")

    // Step 2: Generate roll in weight range
    roll = random.Next(0, pool.TotalWeight)

    // Step 3: Binary search for matching item
    // Cumulative weights example: [100, 150, 175, 185, 190]
    // Roll 73 should find index 0 (Common, cumulative 100)
    // Roll 125 should find index 1 (Uncommon, cumulative 150)

    low = 0
    high = pool.ItemCount - 1

    WHILE low < high:
        mid = (low + high) / 2

        IF cumulativeWeights[mid] <= roll:
            low = mid + 1
        ELSE:
            high = mid

    RETURN pool.Items[low]
```

### 6.2 Selection Examples

```
Pool Contents:
─────────────────────────────────────────────────────────────────────
  Index 0: Iron Sword (Common, Weight=100)     Cumulative: 100
  Index 1: Steel Blade (Uncommon, Weight=50)   Cumulative: 150
  Index 2: Runed Axe (Rare, Weight=25)         Cumulative: 175
  Index 3: Dragon Slayer (Very Rare, Weight=10) Cumulative: 185
  Index 4: Excalibur (Unique, Weight=5)        Cumulative: 190

Total Weight: 190

Selection Examples:
─────────────────────────────────────────────────────────────────────
  Roll = 0   → Index 0 (0 < 100)     → Iron Sword (Common)
  Roll = 99  → Index 0 (99 < 100)    → Iron Sword (Common)
  Roll = 100 → Index 1 (100 = 100)   → Steel Blade (Uncommon)
  Roll = 149 → Index 1 (149 < 150)   → Steel Blade (Uncommon)
  Roll = 150 → Index 2 (150 = 150)   → Runed Axe (Rare)
  Roll = 184 → Index 3 (184 < 185)   → Dragon Slayer (Very Rare)
  Roll = 189 → Index 4 (189 < 190)   → Excalibur (Unique)
```

### 6.3 Statistical Distribution

```
Expected Distribution (1000 selections from above pool):
─────────────────────────────────────────────────────────────────────
  Iron Sword (Common):       ~526 selections (52.6%)
  Steel Blade (Uncommon):    ~263 selections (26.3%)
  Runed Axe (Rare):          ~132 selections (13.2%)
  Dragon Slayer (Very Rare):  ~53 selections (5.3%)
  Excalibur (Unique):         ~26 selections (2.6%)
```

---

## 7. Data Model Changes

### 7.1 New Types Summary

| Type               | Layer  | Category     | Description                           |
| ------------------ | ------ | ------------ | ------------------------------------- |
| `WeightedItem`     | Domain | Value Object | Item with selection weight            |
| `WeightedItemPool` | Domain | Entity       | Weighted item collection and selector |

### 7.2 File Locations

```
src/Core/RuneAndRust.Domain/
├── Entities/
│   └── WeightedItemPool.cs                    ← NEW
└── ValueObjects/
    └── WeightedItem.cs                        ← NEW
```

### 7.3 Weight Constants Reference

```csharp
// Standard rarity weights from WeightedItem
public const int CommonWeight = 100;
public const int UncommonWeight = 50;
public const int RareWeight = 25;
public const int VeryRareWeight = 10;
public const int UniqueWeight = 5;
```

---

## 8. Logging Specifications

### 8.1 Log Levels by Component

| Component          | Level       | Events                                 |
| ------------------ | ----------- | -------------------------------------- |
| `WeightedItemPool` | Debug       | Item selected, roll value, pool stats  |
| `WeightedItemPool` | Information | Pool created, items added              |
| `WeightedItemPool` | Warning     | Selection from small pool, zero-weight |
| `WeightedItemPool` | Error       | Empty pool selection attempt           |

### 8.2 Log Message Templates

```csharp
// Information - Pool created
_logger.LogInformation(
    "Created WeightedItemPool with {ItemCount} items, TotalWeight={TotalWeight}",
    pool.ItemCount, pool.TotalWeight);

// Debug - Item selected
_logger.LogDebug(
    "WeightedItemPool selected {ItemId} (Roll={Roll}/{TotalWeight}, Rarity={Rarity})",
    item.ItemId, roll, pool.TotalWeight, item.Rarity);

// Warning - Small pool
_logger.LogWarning(
    "WeightedItemPool has only {Count} selectable items, distribution may be limited",
    pool.SelectableItemCount);

// Error - Empty pool
_logger.LogError(
    "Attempted to select from empty WeightedItemPool");
```

---

## 9. Unit Testing Requirements

### 9.1 Test Count by Feature

| Feature          | Test Count |
| ---------------- | ---------- |
| WeightedItem     | ~1         |
| WeightedItemPool | ~2         |
| **Total**        | **~3**     |

### 9.2 Test Specifications

**File:** `tests/RuneAndRust.Domain.UnitTests/ValueObjects/WeightedItemTests.cs`

```csharp
[TestFixture]
public class WeightedItemTests
{
    [Test]
    public void Create_WithValidWeight_SetsPropertiesCorrectly()
    {
        // Arrange
        var entry = new LootEntry("sword-01", "Iron Sword", "blades");

        // Act
        var item = WeightedItem.Create(entry, 100, "Common");

        // Assert
        item.Item.Should().Be(entry);
        item.Weight.Should().Be(100);
        item.Rarity.Should().Be("Common");
        item.IsSelectable.Should().BeTrue();
    }

    [Test]
    public void IsSelectable_WithZeroWeight_ReturnsFalse()
    {
        // Arrange
        var entry = new LootEntry("disabled-01", "Disabled Item", "misc");

        // Act
        var item = WeightedItem.Create(entry, 0, "Disabled");

        // Assert
        item.IsSelectable.Should().BeFalse();
    }

    [Test]
    public void GetSelectionProbability_CalculatesCorrectly()
    {
        // Arrange
        var item = WeightedItem.CreateCommon(
            new LootEntry("item-01", "Item", "misc"));

        // Act
        var probability = item.GetSelectionProbability(200);

        // Assert (100/200 = 0.5)
        probability.Should().Be(0.5);
    }
}
```

**File:** `tests/RuneAndRust.Domain.UnitTests/Entities/WeightedItemPoolTests.cs`

```csharp
[TestFixture]
public class WeightedItemPoolTests
{
    [Test]
    public void SelectRandom_ReturnsItemsWithCorrectDistribution()
    {
        // Arrange
        var pool = WeightedItemPool.Create();
        pool.Add(WeightedItem.CreateCommon(new LootEntry("common", "Common", "misc")));
        pool.Add(WeightedItem.CreateRare(new LootEntry("rare", "Rare", "misc")));

        var selectionCounts = new Dictionary<string, int>
        {
            ["common"] = 0,
            ["rare"] = 0
        };

        // Act - Select 1000 times with fixed seed sequences
        for (var i = 0; i < 1000; i++)
        {
            var result = pool.SelectRandom(seed: i);
            selectionCounts[result.ItemId]++;
        }

        // Assert - Common (100) should be ~4x more frequent than Rare (25)
        // Expected: Common ~80% (800), Rare ~20% (200)
        selectionCounts["common"].Should().BeGreaterThan(700);
        selectionCounts["rare"].Should().BeGreaterThan(150);
    }

    [Test]
    public void SelectRandom_WithEmptyPool_ThrowsException()
    {
        // Arrange
        var pool = WeightedItemPool.Create();

        // Act
        var act = () => pool.SelectRandom(new Random());

        // Assert
        act.Should().Throw<InvalidOperationException>()
            .WithMessage("*empty*");
    }

    [Test]
    public void TotalWeight_CalculatesCorrectly()
    {
        // Arrange
        var pool = WeightedItemPool.Create();
        pool.Add(new LootEntry("item1", "Item 1", "misc"), 100);
        pool.Add(new LootEntry("item2", "Item 2", "misc"), 50);
        pool.Add(new LootEntry("item3", "Item 3", "misc"), 0); // Zero weight

        // Assert
        pool.TotalWeight.Should().Be(150); // 100 + 50, excludes 0
        pool.ItemCount.Should().Be(3);
        pool.SelectableItemCount.Should().Be(2);
    }
}
```

---

## 10. Use Cases

### UC-001: Build Weighted Pool from Loot Table

**Actor:** Loot Generation System  
**Flow:** Load loot table → For each item, create WeightedItem with rarity weight → Add to pool → Return pool  
**Postcondition:** Pool ready for weighted selection

### UC-002: Select Item Based on Rarity

**Actor:** Smart Loot Service  
**Flow:** Get weighted pool → Call SelectRandom → Return selected item → Log selection  
**Postcondition:** Item selected with probability matching its weight

### UC-003: Verify Distribution Over Time

**Actor:** Analytics System  
**Flow:** Track all selections → Compare to expected probabilities → Report variance  
**Postcondition:** Game can verify loot tables are working as designed

### UC-004: Disable Item Without Removal

**Actor:** Event System  
**Flow:** Set item weight to 0 → Item remains in pool but cannot be selected  
**Postcondition:** Item effectively disabled but can be re-enabled

---

## 11. Deliverable Checklist

### Domain Layer

- [ ] `WeightedItem` value object created
- [ ] `WeightedItemPool` entity created

### Testing

- [ ] ~3 unit tests implemented
- [ ] All tests passing
- [ ] Distribution test validates weighted selection

### Documentation

- [ ] XML documentation on all public types
- [ ] Inline comments for binary search algorithm

---

## 12. Acceptance Criteria

### Functional

- [ ] Weighted selection favors higher-weight items
- [ ] Zero-weight items are never selected
- [ ] Empty pool throws `InvalidOperationException`
- [ ] Distribution matches expected weights over large sample (1000+ selections)
- [ ] Binary search provides O(log n) selection
- [ ] Cumulative weights correctly calculated after modifications

### Quality

- [ ] Build succeeds with 0 errors/warnings
- [ ] All ~3 tests pass
- [ ] XML documentation complete on all public members
- [ ] Code follows established patterns from v0.16.3b

---

## 13. Dependencies

### 13.1 Required from Previous Versions

| Type               | Location            | Usage in this phase       |
| ------------------ | ------------------- | ------------------------- |
| `LootEntry`        | Domain/Entities     | Wrapped by WeightedItem   |
| `SmartLootContext` | Domain/ValueObjects | Will use pool in v0.16.3d |
| `SmartLootResult`  | Domain/ValueObjects | Will use pool in v0.16.3d |

### 13.2 Provides to Future Phases

| Type               | Usage                                        |
| ------------------ | -------------------------------------------- |
| `WeightedItem`     | v0.16.3d: Item representation in LootService |
| `WeightedItemPool` | v0.16.3d: Pool creation and selection        |

---

## 14. Future Considerations

### 14.1 Deferred to v0.16.3d

- **LootService Integration**: Using WeightedItemPool in actual loot drops
- **Pool Creation Helpers**: Building pools from loot table configuration

### 14.2 Deferred to v0.16.3e

- **Stat Verification**: Ensuring selected items have appropriate stats for tier

### 14.3 Out of Scope

- **Dynamic Weight Modification**: Changing weights during gameplay (future)
- **Weight Configuration File**: Loading weights from JSON (future)
- **Luck Modifier**: Player stats affecting effective weights (future)
- **Pity Timer**: Increased rare chances after consecutive common drops (future)

---

_Document Version: 1.0_  
_Last Updated: 2026-01-27_  
_Author: Assistant_
