# v0.3.2 Quest Chains & Advanced Features - Scope Breakdown

**Version:** 0.3.2
**Theme:** Quest Chains & Advanced Features
**Prerequisites:** v0.3.1 Complete (Quest Rewards & NPCs)
**Total Estimated Tests:** ~80 new tests

---

## Executive Summary

The Quest Chains & Advanced Features version completes the quest system by adding quest chains for narrative progression, failure conditions for time-sensitive quests, and organizational tools for managing multiple quests. Players can follow story-driven quest sequences where completing one quest unlocks the next, and must manage time limits and failure conditions. Quest categories and filters help organize the expanding quest log.

Key focus areas:
- **Quest Chains**: Linked quest sequences with automatic unlocking
- **Failure Conditions**: Time limits and impossible conditions
- **Quest Categories**: Main, Side, Daily, Repeatable organization
- **Quest Management**: Abandonment, filters, and UI enhancements

The work is divided into **three sub-phases**:

| Phase | Name | Focus | Est. Tests |
|-------|------|-------|------------|
| v0.3.2a | Quest Chains | QuestChain entity, chain order, unlock progression | ~30 |
| v0.3.2b | Failure Conditions | Time limits, failure detection, failed quest tracking | ~25 |
| v0.3.2c | Categories & Management | Quest categories, abandonment, log filters | ~25 |

---

## Existing Infrastructure

### Already Implemented (from v0.3.0 & v0.3.1)

| Feature | Location | Notes |
|---------|----------|-------|
| Quest entity | `Domain/Entities/Quest.cs` | Chain attachment point |
| QuestObjective entity | `Domain/Entities/QuestObjective.cs` | Completion tracking |
| QuestService | `Application/Services/QuestService.cs` | Quest management |
| QuestStatus enum | `Domain/Enums/QuestStatus.cs` | Status tracking |
| QuestPrerequisite | `Domain/ValueObjects/QuestPrerequisite.cs` | Unlock conditions |
| PrerequisiteType enum | `Domain/Enums/PrerequisiteType.cs` | Quest prerequisite |
| QuestReward | `Domain/ValueObjects/QuestReward.cs` | Reward bundles |
| QuestRewardService | `Application/Services/QuestRewardService.cs` | Reward delivery |
| Player.ActiveQuests | `Domain/Entities/Player.cs` | Quest ownership |
| Player.CompletedQuests | `Domain/Entities/Player.cs` | Completion tracking |
| NPC.OfferedQuests | `Domain/Entities/NPC.cs` | Quest givers |
| QuestIndicator enum | `Domain/Enums/QuestIndicator.cs` | Visual markers |

### Needs Implementation (v0.3.2)

| Feature | Phase | Notes |
|---------|-------|-------|
| QuestChain entity | v0.3.2a | Chain container |
| QuestChainService | v0.3.2a | Chain management |
| Quest.ChainId, ChainOrder | v0.3.2a | Chain membership |
| Quest.TimeLimit | v0.3.2b | Time constraints |
| Quest.FailureConditions | v0.3.2b | Failure triggers |
| Player.FailedQuests | v0.3.2b | Failed tracking |
| QuestCategory enum | v0.3.2c | Organization |
| Quest abandonment | v0.3.2c | User control |
| Quest log filters | v0.3.2c | UI management |

---

## Feature Analysis & Categorization

### Quest Chain Features

| Feature | Complexity | Dependencies | Assigned Phase |
|---------|------------|--------------|----------------|
| QuestChain entity | High | Quest | **v0.3.2a** |
| Main Quest Line | Medium | QuestChain | **v0.3.2a** |
| Side Quests | Low | QuestCategory | **v0.3.2c** |
| Chain progression | Medium | QuestChainService | **v0.3.2a** |
| Chain completion tracking | Medium | QuestChain | **v0.3.2a** |
| Chain rewards (bonus) | Medium | QuestReward | **v0.3.2a** |

### Failure & Time Features

| Feature | Complexity | Dependencies | Assigned Phase |
|---------|------------|--------------|----------------|
| Timed Quests | Medium | Quest | **v0.3.2b** |
| Time limit tracking | Medium | Turn system | **v0.3.2b** |
| Failed Quests collection | Low | Player | **v0.3.2b** |
| Failure conditions | High | QuestObjective | **v0.3.2b** |
| Failure notification | Medium | IGameRenderer | **v0.3.2b** |
| Quest expiration | Medium | QuestService | **v0.3.2b** |

### Management Features

| Feature | Complexity | Dependencies | Assigned Phase |
|---------|------------|--------------|----------------|
| Quest Categories | Medium | Quest | **v0.3.2c** |
| Quest Abandonment | Medium | QuestService | **v0.3.2c** |
| Quest Log Filters | Medium | UI | **v0.3.2c** |
| Repeatable Quests | Medium | Quest | **v0.3.2c** |
| Daily Quests | Medium | Time system | **v0.3.2c** |

---

## Phase Definitions

---

## v0.3.2a: Quest Chains

### Overview

Implement quest chains that link related quests into narrative sequences. Completing one quest in a chain automatically unlocks the next, enabling story-driven progression through connected objectives.

### Scope

**In Scope:**
- `QuestChain` entity for chain containers
- `QuestChainService` for chain management
- Chain membership properties on Quest
- Automatic unlock on quest completion
- Chain progress tracking
- Chain completion bonuses
- Main quest line support
- Chain display in journal

**Out of Scope:**
- Time limits (v0.3.2b)
- Failure conditions (v0.3.2b)
- Quest categories (v0.3.2c)
- Quest abandonment (v0.3.2c)

### Key Deliverables

| Type | Count | Details |
|------|-------|---------|
| Entities | 1 | `QuestChain` |
| Services | 1 | `QuestChainService` |
| Quest Updates | 3 | ChainId, ChainOrder, IsChainStart |
| Player Updates | 1 | ChainProgress tracking |
| Configuration | 1 | `quest-chains.json` |
| Unit Tests | ~30 | Chain entity, progression tests |

### QuestChain Entity

```csharp
namespace RuneAndRust.Domain.Entities;

/// <summary>
/// Represents a sequence of related quests forming a narrative chain.
/// </summary>
public class QuestChain
{
    /// <summary>
    /// Gets the unique identifier.
    /// </summary>
    public Guid Id { get; private set; }

    /// <summary>
    /// Gets the definition ID from configuration.
    /// </summary>
    public string DefinitionId { get; private set; } = string.Empty;

    /// <summary>
    /// Gets the chain name.
    /// </summary>
    public string Name { get; private set; } = string.Empty;

    /// <summary>
    /// Gets the chain description.
    /// </summary>
    public string Description { get; private set; } = string.Empty;

    /// <summary>
    /// Gets whether this is the main story quest line.
    /// </summary>
    public bool IsMainQuest { get; private set; }

    /// <summary>
    /// Gets the ordered quest definition IDs in this chain.
    /// </summary>
    public IReadOnlyList<string> QuestIds { get; private set; } = Array.Empty<string>();

    /// <summary>
    /// Gets the total number of quests in the chain.
    /// </summary>
    public int TotalQuests => QuestIds.Count;

    /// <summary>
    /// Gets bonus rewards granted on chain completion.
    /// </summary>
    public QuestReward? CompletionBonus { get; private set; }

    /// <summary>
    /// Gets prerequisites for starting the chain.
    /// </summary>
    public IReadOnlyList<QuestPrerequisite> Prerequisites { get; private set; } = Array.Empty<QuestPrerequisite>();

    private QuestChain() { }

    /// <summary>
    /// Creates a new quest chain.
    /// </summary>
    public static QuestChain Create(
        string definitionId,
        string name,
        string description,
        IEnumerable<string> questIds,
        bool isMainQuest = false,
        QuestReward? completionBonus = null,
        IEnumerable<QuestPrerequisite>? prerequisites = null)
    {
        ArgumentException.ThrowIfNullOrWhiteSpace(definitionId);
        ArgumentException.ThrowIfNullOrWhiteSpace(name);

        var questList = questIds.ToList();
        if (questList.Count == 0)
            throw new ArgumentException("Quest chain must contain at least one quest.", nameof(questIds));

        return new QuestChain
        {
            Id = Guid.NewGuid(),
            DefinitionId = definitionId,
            Name = name,
            Description = description,
            QuestIds = questList,
            IsMainQuest = isMainQuest,
            CompletionBonus = completionBonus,
            Prerequisites = prerequisites?.ToList() ?? Array.Empty<QuestPrerequisite>()
        };
    }

    /// <summary>
    /// Gets the quest definition ID at a specific position.
    /// </summary>
    public string? GetQuestAt(int order)
    {
        if (order < 0 || order >= QuestIds.Count)
            return null;
        return QuestIds[order];
    }

    /// <summary>
    /// Gets the next quest in the chain after the given quest.
    /// </summary>
    public string? GetNextQuest(string currentQuestId)
    {
        var index = QuestIds.IndexOf(currentQuestId);
        if (index < 0 || index >= QuestIds.Count - 1)
            return null;
        return QuestIds[index + 1];
    }

    /// <summary>
    /// Gets whether a quest is the first in the chain.
    /// </summary>
    public bool IsFirstQuest(string questId) => QuestIds.Count > 0 && QuestIds[0] == questId;

    /// <summary>
    /// Gets whether a quest is the last in the chain.
    /// </summary>
    public bool IsLastQuest(string questId) => QuestIds.Count > 0 && QuestIds[^1] == questId;

    /// <summary>
    /// Gets the order/position of a quest in the chain.
    /// </summary>
    public int GetQuestOrder(string questId)
    {
        var index = QuestIds.IndexOf(questId);
        return index >= 0 ? index : -1;
    }
}
```

### Quest Modifications

```csharp
// Add to Quest entity

/// <summary>
/// Gets the chain ID if this quest belongs to a chain.
/// </summary>
public string? ChainId { get; private set; }

/// <summary>
/// Gets the order within the chain (0-based).
/// </summary>
public int? ChainOrder { get; private set; }

/// <summary>
/// Gets whether this quest is part of a chain.
/// </summary>
public bool IsInChain => !string.IsNullOrEmpty(ChainId);

/// <summary>
/// Gets whether this is the first quest in its chain.
/// </summary>
public bool IsChainStart => ChainOrder == 0;

/// <summary>
/// Gets whether this is the last quest in its chain.
/// </summary>
public bool IsChainEnd { get; private set; }

/// <summary>
/// Sets chain membership.
/// </summary>
public void SetChainMembership(string chainId, int order, bool isChainEnd = false)
{
    ChainId = chainId;
    ChainOrder = order;
    IsChainEnd = isChainEnd;
}
```

### QuestChainService Interface

```csharp
namespace RuneAndRust.Application.Interfaces;

/// <summary>
/// Service for managing quest chains.
/// </summary>
public interface IQuestChainService
{
    /// <summary>
    /// Gets a chain by definition ID.
    /// </summary>
    QuestChain? GetChain(string chainId);

    /// <summary>
    /// Gets the main quest chain.
    /// </summary>
    QuestChain? GetMainQuestChain();

    /// <summary>
    /// Gets all chains a player can access.
    /// </summary>
    IEnumerable<QuestChain> GetAvailableChains(Player player);

    /// <summary>
    /// Gets the player's progress in a chain.
    /// </summary>
    ChainProgress GetChainProgress(Player player, string chainId);

    /// <summary>
    /// Handles quest completion within a chain.
    /// </summary>
    ChainProgressionResult ProcessQuestCompletion(Player player, Quest quest);

    /// <summary>
    /// Unlocks the next quest in a chain for a player.
    /// </summary>
    Quest? UnlockNextQuest(Player player, QuestChain chain, string completedQuestId);

    /// <summary>
    /// Checks if a player has completed a chain.
    /// </summary>
    bool HasCompletedChain(Player player, string chainId);

    /// <summary>
    /// Gets the bonus reward for completing a chain.
    /// </summary>
    QuestReward? GetChainCompletionBonus(string chainId);
}

/// <summary>
/// Progress tracking for a quest chain.
/// </summary>
public readonly record struct ChainProgress
{
    public string ChainId { get; init; }
    public string ChainName { get; init; }
    public int CompletedQuests { get; init; }
    public int TotalQuests { get; init; }
    public string? CurrentQuestId { get; init; }
    public string? NextQuestId { get; init; }
    public bool IsComplete { get; init; }
    public float ProgressPercent => TotalQuests > 0 ? (float)CompletedQuests / TotalQuests * 100 : 0;

    public string GetProgressDisplay() => $"{CompletedQuests}/{TotalQuests}";
}

/// <summary>
/// Result of processing quest completion in a chain.
/// </summary>
public readonly record struct ChainProgressionResult
{
    public bool WasInChain { get; init; }
    public string? ChainId { get; init; }
    public Quest? UnlockedQuest { get; init; }
    public bool ChainCompleted { get; init; }
    public QuestReward? ChainBonus { get; init; }
}
```

### User-Facing Changes

**Quest Journal with Chains:**
```
┌─────────────────────────────────────────────────────────────┐
│                    QUEST JOURNAL                            │
├─────────────────────────────────────────────────────────────┤
│  [MAIN QUEST]                                   Progress    │
│  ───────────────────────────────────────────────────────────│
│  The Shadow Over Thornwood                       (2/5)      │
│    ► Into the Dark Forest [ACTIVE]                          │
│      Investigate the source of the corruption               │
│                                                             │
│  [SIDE QUESTS]                                              │
│  ───────────────────────────────────────────────────────────│
│  The Goblin Menace                               [COMPLETE] │
│  Lost Heirloom                                   [ACTIVE]   │
│                                                             │
└─────────────────────────────────────────────────────────────┘

> quest "Into the Dark Forest"

┌─────────────────────────────────────────────────────────────┐
│                  INTO THE DARK FOREST                       │
├─────────────────────────────────────────────────────────────┤
│  Chain: The Shadow Over Thornwood  (Quest 2 of 5)           │
│  Status: Active                                             │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  The hermit spoke of a darkness spreading from deep within  │
│  the forest. Travel to the Corrupted Grove and discover     │
│  what lurks there.                                          │
│                                                             │
├─────────────────────────────────────────────────────────────┤
│  OBJECTIVES                                                 │
│  • Reach the Corrupted Grove                      [  ]      │
│  • Investigate the source of corruption           [  ]      │
│                                                             │
├─────────────────────────────────────────────────────────────┤
│  REWARDS                                                    │
│  • 100 XP                                                   │
│  • 50 gold                                                  │
│                                                             │
│  CHAIN COMPLETION BONUS                                     │
│  • 500 XP                                                   │
│  • Shadow Cloak (Unique Item)                               │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

**Chain Progression Notification:**
```
=== QUEST COMPLETE ===
Into the Dark Forest

REWARDS RECEIVED:
  + 100 XP
  + 50 gold

═══════════════════════════════════════════════════════════════
CHAIN PROGRESS: The Shadow Over Thornwood
  [■■■■■■■■░░░░░░░░░░░░] 40% (2/5)

NEW QUEST UNLOCKED:
  "The Heart of Corruption"
  The source has been found - a corrupted druid who must be
  confronted.

═══════════════════════════════════════════════════════════════
```

### Configuration Example

```json
{
  "$schema": "../schemas/quest-chains.schema.json",
  "questChains": [
    {
      "id": "shadow-over-thornwood",
      "name": "The Shadow Over Thornwood",
      "description": "A dark force threatens the village of Thornwood. Uncover the mystery and save the villagers.",
      "isMainQuest": true,
      "questIds": [
        "shadow-chapter-1",
        "shadow-chapter-2",
        "shadow-chapter-3",
        "shadow-chapter-4",
        "shadow-chapter-5"
      ],
      "completionBonus": {
        "entries": [
          { "type": "XP", "amount": 500 },
          { "type": "Item", "targetId": "shadow-cloak", "displayName": "Shadow Cloak" },
          { "type": "Reputation", "targetId": "thornwood-village", "amount": 500 }
        ]
      }
    },
    {
      "id": "merchant-guild-intro",
      "name": "Merchant Guild Introduction",
      "description": "Prove your worth to the Merchant Guild.",
      "isMainQuest": false,
      "questIds": [
        "guild-trial-1",
        "guild-trial-2",
        "guild-trial-3"
      ],
      "prerequisites": [
        { "type": "Reputation", "targetId": "merchant-guild", "requiredValue": 100 }
      ],
      "completionBonus": {
        "entries": [
          { "type": "XP", "amount": 200 },
          { "type": "Gold", "amount": 100 },
          { "type": "Unlock", "targetId": "merchant-guild-membership" }
        ]
      }
    }
  ]
}
```

### Acceptance Criteria

- [ ] QuestChain entity stores ordered quest sequences
- [ ] QuestChainService manages chain progression
- [ ] Quest.ChainId and ChainOrder track membership
- [ ] Completing a quest unlocks the next in chain
- [ ] Chain progress displays correctly in journal
- [ ] Main quest chains display prominently
- [ ] Chain completion bonuses distribute correctly
- [ ] Chain prerequisites evaluate correctly
- [ ] GetNextQuest returns correct quest
- [ ] ~30 unit tests pass

---

## v0.3.2b: Failure Conditions

### Overview

Implement quest failure mechanics including time limits, failure conditions, and tracking of failed quests. Players must manage time-sensitive quests and can experience quest failure when conditions are not met.

### Scope

**In Scope:**
- `Quest.TimeLimit` property (in turns)
- `Quest.TurnsRemaining` tracking
- `Quest.FailureConditions` collection
- `FailureCondition` value object
- `FailureType` enum
- `Player.FailedQuests` collection
- Failure detection in turn processing
- Failure notification display
- Quest expiration on time limit

**Out of Scope:**
- Quest categories (v0.3.2c)
- Quest abandonment (v0.3.2c)
- Quest log filters (v0.3.2c)

### Key Deliverables

| Type | Count | Details |
|------|-------|---------|
| Value Objects | 1 | `FailureCondition` |
| Enums | 1 | `FailureType` |
| Quest Updates | 3 | TimeLimit, TurnsRemaining, FailureConditions |
| Player Updates | 1 | FailedQuests collection |
| Service Updates | 1 | QuestService failure detection |
| Unit Tests | ~25 | Failure condition, expiration tests |

### FailureCondition Value Object

```csharp
namespace RuneAndRust.Domain.ValueObjects;

/// <summary>
/// Represents a condition that causes quest failure.
/// </summary>
public readonly record struct FailureCondition
{
    /// <summary>
    /// Gets the failure type.
    /// </summary>
    public FailureType Type { get; init; }

    /// <summary>
    /// Gets the target ID (NPC, monster, item, location).
    /// </summary>
    public string TargetId { get; init; }

    /// <summary>
    /// Gets the threshold value for the condition.
    /// </summary>
    public int Threshold { get; init; }

    /// <summary>
    /// Gets the failure message shown to the player.
    /// </summary>
    public string FailureMessage { get; init; }

    /// <summary>
    /// Creates a time limit failure condition.
    /// </summary>
    public static FailureCondition TimeExpired(int turnLimit, string? message = null) => new()
    {
        Type = FailureType.TimeExpired,
        TargetId = string.Empty,
        Threshold = turnLimit,
        FailureMessage = message ?? "Time has run out."
    };

    /// <summary>
    /// Creates an NPC death failure condition.
    /// </summary>
    public static FailureCondition NPCDied(string npcId, string? message = null) => new()
    {
        Type = FailureType.NPCDied,
        TargetId = npcId,
        FailureMessage = message ?? "The NPC you were protecting has died."
    };

    /// <summary>
    /// Creates an item lost failure condition.
    /// </summary>
    public static FailureCondition ItemLost(string itemId, string? message = null) => new()
    {
        Type = FailureType.ItemLost,
        TargetId = itemId,
        FailureMessage = message ?? "You have lost a required item."
    };

    /// <summary>
    /// Creates a reputation drop failure condition.
    /// </summary>
    public static FailureCondition ReputationDropped(string factionId, int minRep, string? message = null) => new()
    {
        Type = FailureType.ReputationDropped,
        TargetId = factionId,
        Threshold = minRep,
        FailureMessage = message ?? "Your standing has fallen too low."
    };

    /// <summary>
    /// Creates a location-based failure (left area before completing).
    /// </summary>
    public static FailureCondition LeftArea(string locationId, string? message = null) => new()
    {
        Type = FailureType.LeftArea,
        TargetId = locationId,
        FailureMessage = message ?? "You left the area before completing the objective."
    };

    /// <summary>
    /// Evaluates this condition against game state.
    /// </summary>
    public bool ShouldFail(Player player, GameState state)
    {
        return Type switch
        {
            FailureType.TimeExpired => false, // Handled by turn counter
            FailureType.NPCDied => state.IsNPCDead(TargetId),
            FailureType.ItemLost => !player.Inventory.HasItem(TargetId),
            FailureType.ReputationDropped => player.GetReputation(TargetId) < Threshold,
            FailureType.LeftArea => player.CurrentRoomId != TargetId,
            _ => false
        };
    }
}
```

### FailureType Enum

```csharp
namespace RuneAndRust.Domain.Enums;

/// <summary>
/// Types of quest failure conditions.
/// </summary>
public enum FailureType
{
    /// <summary>Quest time limit expired.</summary>
    TimeExpired,

    /// <summary>A required NPC died.</summary>
    NPCDied,

    /// <summary>A required item was lost.</summary>
    ItemLost,

    /// <summary>Reputation fell below threshold.</summary>
    ReputationDropped,

    /// <summary>Player left required area.</summary>
    LeftArea,

    /// <summary>A monster that shouldn't die was killed.</summary>
    WrongTarget,

    /// <summary>Custom condition evaluated by script.</summary>
    Custom
}
```

### Quest Modifications

```csharp
// Add to Quest entity

/// <summary>
/// Gets the time limit in turns (null = no limit).
/// </summary>
public int? TimeLimit { get; private set; }

/// <summary>
/// Gets the remaining turns (null = no limit).
/// </summary>
public int? TurnsRemaining { get; private set; }

/// <summary>
/// Gets whether this quest is timed.
/// </summary>
public bool IsTimed => TimeLimit.HasValue;

/// <summary>
/// Gets whether this quest has expired.
/// </summary>
public bool IsExpired => TurnsRemaining.HasValue && TurnsRemaining <= 0;

/// <summary>
/// Gets failure conditions for this quest.
/// </summary>
public IReadOnlyList<FailureCondition> FailureConditions { get; private set; } = Array.Empty<FailureCondition>();

/// <summary>
/// Gets the reason for failure (if failed).
/// </summary>
public string? FailureReason { get; private set; }

/// <summary>
/// Sets the time limit for this quest.
/// </summary>
public void SetTimeLimit(int turns)
{
    if (turns <= 0)
        throw new ArgumentException("Time limit must be positive.", nameof(turns));

    TimeLimit = turns;
    TurnsRemaining = turns;
}

/// <summary>
/// Decrements the remaining time.
/// </summary>
/// <returns>True if time has expired.</returns>
public bool TickTime()
{
    if (!TurnsRemaining.HasValue || TurnsRemaining <= 0)
        return false;

    TurnsRemaining--;
    return TurnsRemaining <= 0;
}

/// <summary>
/// Fails the quest with a reason.
/// </summary>
public void Fail(string reason)
{
    if (Status != QuestStatus.Active)
        throw new InvalidOperationException("Can only fail active quests.");

    Status = QuestStatus.Failed;
    FailureReason = reason;
}

/// <summary>
/// Checks failure conditions.
/// </summary>
public FailureCondition? CheckFailureConditions(Player player, GameState state)
{
    foreach (var condition in FailureConditions)
    {
        if (condition.ShouldFail(player, state))
            return condition;
    }
    return null;
}
```

### Player Modifications

```csharp
// Add to Player entity

/// <summary>
/// Gets quests that have been failed.
/// </summary>
public IReadOnlyList<Quest> FailedQuests => _failedQuests;
private readonly List<Quest> _failedQuests = new();

/// <summary>
/// Moves a quest to the failed collection.
/// </summary>
public void MoveFailed(Quest quest)
{
    if (_activeQuests.Remove(quest))
    {
        _failedQuests.Add(quest);
    }
}

/// <summary>
/// Gets whether a quest has been failed.
/// </summary>
public bool HasFailedQuest(string questDefinitionId)
{
    return _failedQuests.Any(q => q.DefinitionId == questDefinitionId);
}
```

### Turn Processing Update

```csharp
// In TurnProcessingService or QuestService

/// <summary>
/// Processes quest timers and failure conditions at end of turn.
/// </summary>
public IEnumerable<QuestFailureResult> ProcessQuestTimers(Player player, GameState state)
{
    var failures = new List<QuestFailureResult>();

    foreach (var quest in player.ActiveQuests.ToList())
    {
        // Check time expiration
        if (quest.IsTimed && quest.TickTime())
        {
            quest.Fail("Time has run out.");
            player.MoveFailed(quest);
            failures.Add(new QuestFailureResult(quest, FailureType.TimeExpired, "Time has run out."));
            continue;
        }

        // Check other failure conditions
        var failedCondition = quest.CheckFailureConditions(player, state);
        if (failedCondition.HasValue)
        {
            quest.Fail(failedCondition.Value.FailureMessage);
            player.MoveFailed(quest);
            failures.Add(new QuestFailureResult(quest, failedCondition.Value.Type, failedCondition.Value.FailureMessage));
        }
    }

    return failures;
}

/// <summary>
/// Result of a quest failure.
/// </summary>
public readonly record struct QuestFailureResult
{
    public Quest Quest { get; init; }
    public FailureType Type { get; init; }
    public string Message { get; init; }

    public QuestFailureResult(Quest quest, FailureType type, string message)
    {
        Quest = quest;
        Type = type;
        Message = message;
    }
}
```

### User-Facing Changes

**Timed Quest Display:**
```
┌─────────────────────────────────────────────────────────────┐
│                  URGENT DELIVERY                            │
├─────────────────────────────────────────────────────────────┤
│  Status: Active                        ⏱ 15 turns remaining │
│  Given by: Courier Master                                   │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  The medicine must reach the village before sunset!         │
│  Travel quickly through the forest to deliver the package.  │
│                                                             │
├─────────────────────────────────────────────────────────────┤
│  OBJECTIVES                                                 │
│  • Deliver medicine to Thornwood                  [  ]      │
│                                                             │
├─────────────────────────────────────────────────────────────┤
│  ⚠ FAILURE CONDITIONS                                       │
│  • Time expires (15 turns)                                  │
│  • Medicine is lost or destroyed                            │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

**Quest Failure Notification:**
```
═══════════════════════════════════════════════════════════════
                    QUEST FAILED
═══════════════════════════════════════════════════════════════

  "Urgent Delivery"

  Time has run out. The medicine could not be delivered
  in time, and the villagers suffered for it.

═══════════════════════════════════════════════════════════════

---

═══════════════════════════════════════════════════════════════
                    QUEST FAILED
═══════════════════════════════════════════════════════════════

  "Protect the Merchant"

  Grimbold the Trader has been killed. You failed to
  protect him from the bandit ambush.

═══════════════════════════════════════════════════════════════
```

**Time Warning:**
```
=== END OF TURN ===

⚠ QUEST TIME WARNING: "Urgent Delivery"
  Only 3 turns remaining!
```

### Configuration Example

```json
{
  "quests": [
    {
      "id": "urgent-delivery",
      "name": "Urgent Delivery",
      "description": "Deliver medicine to the village before time runs out.",
      "timeLimit": 20,
      "objectives": [
        { "type": "Talk", "description": "Deliver medicine to Thornwood", "target": { "targetId": "village-healer" } }
      ],
      "failureConditions": [
        { "type": "ItemLost", "targetId": "medicine-package", "message": "The medicine was lost!" }
      ],
      "rewards": {
        "entries": [
          { "type": "XP", "amount": 100 },
          { "type": "Gold", "amount": 50 },
          { "type": "Reputation", "targetId": "thornwood-village", "amount": 200 }
        ]
      }
    },
    {
      "id": "protect-merchant",
      "name": "Protect the Merchant",
      "description": "Escort Grimbold safely through the dangerous pass.",
      "objectives": [
        { "type": "Explore", "description": "Reach the Mountain Pass exit", "target": { "targetId": "room-pass-exit" } }
      ],
      "failureConditions": [
        { "type": "NPCDied", "targetId": "grimbold-trader", "message": "Grimbold has been killed!" },
        { "type": "LeftArea", "targetId": "zone-mountain-pass", "message": "You abandoned Grimbold in the pass." }
      ],
      "rewards": {
        "entries": [
          { "type": "XP", "amount": 150 },
          { "type": "Gold", "amount": 100 }
        ]
      }
    }
  ]
}
```

### Acceptance Criteria

- [ ] Quest.TimeLimit tracks turn-based time constraints
- [ ] Quest.TurnsRemaining decrements each turn
- [ ] Quest fails automatically when time expires
- [ ] FailureConditions evaluate correctly
- [ ] NPCDied condition triggers on NPC death
- [ ] ItemLost condition triggers when item removed
- [ ] Player.FailedQuests tracks failed quests
- [ ] Failure notifications display clearly
- [ ] Time warnings show at low turns remaining
- [ ] Timed quests show remaining time in journal
- [ ] ~25 unit tests pass

---

## v0.3.2c: Categories & Management

### Overview

Implement quest organization features including categories, abandonment, and filtering. Players can organize their quest log by category, abandon unwanted quests, and filter the view.

### Scope

**In Scope:**
- `QuestCategory` enum (Main, Side, Daily, Repeatable)
- Quest.Category property
- Quest abandonment command
- Abandonment confirmation
- Repeatable quest reset
- Daily quest cooldowns
- Quest log filters
- Filter persistence

**Out of Scope:**
- Escort quest mechanics (future version)
- Complex quest scripting (future version)

### Key Deliverables

| Type | Count | Details |
|------|-------|---------|
| Enums | 1 | `QuestCategory` |
| Quest Updates | 2 | Category, IsRepeatable |
| Commands | 2 | `abandon`, filter commands |
| UI Updates | 1 | Filtered quest journal |
| Service Updates | 1 | QuestService abandonment |
| Unit Tests | ~25 | Category, abandonment tests |

### QuestCategory Enum

```csharp
namespace RuneAndRust.Domain.Enums;

/// <summary>
/// Categories for organizing quests.
/// </summary>
public enum QuestCategory
{
    /// <summary>Main story quests.</summary>
    Main,

    /// <summary>Optional side quests.</summary>
    Side,

    /// <summary>Daily repeatable quests.</summary>
    Daily,

    /// <summary>Infinitely repeatable quests.</summary>
    Repeatable,

    /// <summary>Event or seasonal quests.</summary>
    Event
}
```

### Quest Modifications

```csharp
// Add to Quest entity

/// <summary>
/// Gets the quest category.
/// </summary>
public QuestCategory Category { get; private set; } = QuestCategory.Side;

/// <summary>
/// Gets whether this quest is repeatable.
/// </summary>
public bool IsRepeatable { get; private set; }

/// <summary>
/// Gets whether this is a daily quest.
/// </summary>
public bool IsDaily => Category == QuestCategory.Daily;

/// <summary>
/// Gets the cooldown for repeatable quests (in real-time or turns).
/// </summary>
public int? RepeatCooldown { get; private set; }

/// <summary>
/// Gets when this quest can be repeated (for completed repeatables).
/// </summary>
public DateTime? RepeatableAfter { get; private set; }

/// <summary>
/// Sets the quest category.
/// </summary>
public void SetCategory(QuestCategory category)
{
    Category = category;
}

/// <summary>
/// Marks as repeatable with optional cooldown.
/// </summary>
public void SetRepeatable(int? cooldownTurns = null)
{
    IsRepeatable = true;
    RepeatCooldown = cooldownTurns;
}

/// <summary>
/// Resets a repeatable quest for another completion.
/// </summary>
public void ResetForRepeat()
{
    if (!IsRepeatable)
        throw new InvalidOperationException("Quest is not repeatable.");

    Status = QuestStatus.Available;
    foreach (var objective in _objectives)
    {
        objective.ResetProgress();
    }
}

/// <summary>
/// Abandons this quest.
/// </summary>
public void Abandon()
{
    if (Status != QuestStatus.Active)
        throw new InvalidOperationException("Can only abandon active quests.");

    if (Category == QuestCategory.Main)
        throw new InvalidOperationException("Cannot abandon main quests.");

    Status = QuestStatus.Available;
    foreach (var objective in _objectives)
    {
        objective.ResetProgress();
    }
}
```

### Player Modifications

```csharp
// Add to Player entity

/// <summary>
/// Gets quests that have been abandoned.
/// </summary>
public IReadOnlyList<string> AbandonedQuestIds => _abandonedQuestIds;
private readonly List<string> _abandonedQuestIds = new();

/// <summary>
/// Abandons a quest.
/// </summary>
public void AbandonQuest(Quest quest)
{
    if (_activeQuests.Remove(quest))
    {
        quest.Abandon();
        _abandonedQuestIds.Add(quest.DefinitionId);
    }
}

/// <summary>
/// Gets whether a quest was abandoned.
/// </summary>
public bool HasAbandonedQuest(string questDefinitionId)
{
    return _abandonedQuestIds.Contains(questDefinitionId);
}

/// <summary>
/// Gets active quests filtered by category.
/// </summary>
public IEnumerable<Quest> GetQuestsByCategory(QuestCategory category)
{
    return _activeQuests.Where(q => q.Category == category);
}
```

### Quest Journal Filter

```csharp
namespace RuneAndRust.Domain.ValueObjects;

/// <summary>
/// Filter options for the quest journal.
/// </summary>
public readonly record struct QuestJournalFilter
{
    /// <summary>
    /// Gets the category filter (null = all).
    /// </summary>
    public QuestCategory? Category { get; init; }

    /// <summary>
    /// Gets the status filter (null = all).
    /// </summary>
    public QuestStatus? Status { get; init; }

    /// <summary>
    /// Gets whether to show only timed quests.
    /// </summary>
    public bool TimedOnly { get; init; }

    /// <summary>
    /// Gets whether to show only chain quests.
    /// </summary>
    public bool ChainsOnly { get; init; }

    /// <summary>
    /// Gets the text search filter.
    /// </summary>
    public string? SearchText { get; init; }

    /// <summary>
    /// Gets the default filter (show all).
    /// </summary>
    public static QuestJournalFilter Default => new();

    /// <summary>
    /// Creates a category filter.
    /// </summary>
    public static QuestJournalFilter ForCategory(QuestCategory category) => new()
    {
        Category = category
    };

    /// <summary>
    /// Creates an active quests filter.
    /// </summary>
    public static QuestJournalFilter ActiveOnly => new()
    {
        Status = QuestStatus.Active
    };

    /// <summary>
    /// Applies the filter to a quest collection.
    /// </summary>
    public IEnumerable<Quest> Apply(IEnumerable<Quest> quests)
    {
        var result = quests;

        if (Category.HasValue)
            result = result.Where(q => q.Category == Category.Value);

        if (Status.HasValue)
            result = result.Where(q => q.Status == Status.Value);

        if (TimedOnly)
            result = result.Where(q => q.IsTimed);

        if (ChainsOnly)
            result = result.Where(q => q.IsInChain);

        if (!string.IsNullOrEmpty(SearchText))
            result = result.Where(q =>
                q.Name.Contains(SearchText, StringComparison.OrdinalIgnoreCase) ||
                q.Description.Contains(SearchText, StringComparison.OrdinalIgnoreCase));

        return result;
    }
}
```

### User-Facing Changes

**Commands:**
```
> quests                    # Show all quests
> quests main               # Show main quests only
> quests side               # Show side quests only
> quests daily              # Show daily quests
> quests active             # Show active quests only
> quests completed          # Show completed quests
> quests failed             # Show failed quests
> quests timed              # Show timed quests only

> abandon "Quest Name"      # Abandon a quest
> abandon                   # Show abandonable quests
```

**Filtered Quest Journal:**
```
> quests main

┌─────────────────────────────────────────────────────────────┐
│               QUEST JOURNAL - MAIN QUESTS                   │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  THE SHADOW OVER THORNWOOD                        (2/5)     │
│  ───────────────────────────────────────────────────────────│
│    Chapter 2: Into the Dark Forest          [ACTIVE]        │
│    Next: The Heart of Corruption                            │
│                                                             │
│  THE MERCHANT GUILD                               (0/3)     │
│  ───────────────────────────────────────────────────────────│
│    [LOCKED] Requires: Merchant Guild reputation 100+        │
│                                                             │
│  Filter: Main | Showing 2 quest chains                      │
│                                                             │
└─────────────────────────────────────────────────────────────┘

> quests side

┌─────────────────────────────────────────────────────────────┐
│               QUEST JOURNAL - SIDE QUESTS                   │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  • The Goblin Menace                            [COMPLETE]  │
│  • Lost Heirloom                                [ACTIVE]    │
│  • Rat Problem                                  [AVAILABLE] │
│                                                             │
│  Filter: Side | Showing 3 quests                            │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

**Quest Abandonment:**
```
> abandon "Lost Heirloom"

┌─────────────────────────────────────────────────────────────┐
│                   ABANDON QUEST?                            │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  Quest: Lost Heirloom                                       │
│  Progress: 50% (1/2 objectives)                             │
│                                                             │
│  WARNING: All progress will be lost.                        │
│  You may be able to restart this quest later.               │
│                                                             │
│  [1] Confirm - Abandon this quest                           │
│  [2] Cancel - Keep the quest                                │
│                                                             │
└─────────────────────────────────────────────────────────────┘

> 1

Quest "Lost Heirloom" has been abandoned.
```

**Daily Quest Example:**
```
> quests daily

┌─────────────────────────────────────────────────────────────┐
│               QUEST JOURNAL - DAILY QUESTS                  │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  • Training Dummy Practice                      [AVAILABLE] │
│      Defeat 3 training dummies                              │
│      Rewards: 25 XP, 10 gold                                │
│                                                             │
│  • Guard Patrol                                 [COMPLETED] │
│      Resets in: 18 hours                                    │
│                                                             │
│  • Gather Herbs                                 [ACTIVE]    │
│      Collect 5 medicinal herbs (2/5)                        │
│      Rewards: 20 XP, 15 gold                                │
│                                                             │
│  Daily quests reset each day at midnight.                   │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### Configuration Example

```json
{
  "quests": [
    {
      "id": "training-dummy",
      "name": "Training Dummy Practice",
      "description": "Keep your skills sharp by practicing on the training dummies.",
      "category": "Daily",
      "isRepeatable": true,
      "repeatCooldown": "daily",
      "objectives": [
        { "type": "Kill", "description": "Defeat training dummies", "target": { "targetType": "training-dummy" }, "requiredCount": 3 }
      ],
      "rewards": {
        "entries": [
          { "type": "XP", "amount": 25 },
          { "type": "Gold", "amount": 10 }
        ]
      }
    },
    {
      "id": "rat-problem",
      "name": "Rat Problem",
      "description": "The innkeeper needs help with a pest problem.",
      "category": "Side",
      "isRepeatable": false,
      "objectives": [
        { "type": "Kill", "description": "Kill rats in the cellar", "target": { "targetType": "rat" }, "requiredCount": 5 }
      ],
      "rewards": {
        "entries": [
          { "type": "XP", "amount": 30 },
          { "type": "Gold", "amount": 15 }
        ]
      }
    }
  ]
}
```

### Acceptance Criteria

- [ ] QuestCategory organizes quests correctly
- [ ] Main quests display prominently
- [ ] Side quests display in separate section
- [ ] Daily quests show cooldown status
- [ ] Repeatable quests can be reset
- [ ] Quest abandonment works for non-main quests
- [ ] Main quests cannot be abandoned
- [ ] Abandonment shows confirmation
- [ ] Quest log filters work correctly
- [ ] Multiple filters can combine
- [ ] Filter persists across views
- [ ] ~25 unit tests pass

---

## Dependencies & Prerequisites

```
v0.3.1 (Quest Rewards & NPCs) - REQUIRED
    │
    ├── QuestReward value object ────────┐
    ├── QuestRewardService ──────────────┤
    ├── QuestPrerequisite ───────────────┤
    ├── NPC quest integration ───────────┘
                                         │
                                         ▼
v0.3.2 (Quest Chains & Advanced)
    │
    ├── v0.3.2a: Quest Chains ───────────────────────────┐
    │       Dependencies: Quest, QuestReward             │
    │                                                    │
    ├── v0.3.2b: Failure Conditions ─────────────────────┤
    │       Dependencies: v0.3.2a, Turn system           │
    │                                                    │
    └── v0.3.2c: Categories & Management ────────────────┘
            Dependencies: v0.3.2a, v0.3.2b
```

---

## Estimated Effort Summary

| Phase | New Files | Modified Files | Est. Tests | Complexity |
|-------|-----------|----------------|------------|------------|
| v0.3.2a | ~6 | ~4 | ~30 | High |
| v0.3.2b | ~4 | ~4 | ~25 | Medium |
| v0.3.2c | ~3 | ~5 | ~25 | Medium |
| **Total** | **~13** | **~13** | **~80** | |

---

## Risk Assessment

| Risk | Impact | Probability | Mitigation |
|------|--------|-------------|------------|
| Chain progression complexity | High | Medium | Clear state machine, thorough testing |
| Failure condition edge cases | Medium | Medium | Comprehensive condition evaluation |
| Time tracking accuracy | Medium | Low | Turn-based, deterministic |
| Daily reset timing | Low | Medium | Server-side time, consistent zones |
| Abandonment abuse | Low | Low | Cannot abandon main quests, cooldowns |

---

## Design Decisions (Confirmed)

### Quest Chain Architecture

| Decision | Value | Notes |
|----------|-------|-------|
| **Chain Storage** | Separate entity | QuestChain holds ordered list |
| **Progression** | Automatic unlock | On quest completion |
| **Chain Bonuses** | Completion reward | Extra rewards for finishing chain |

### Failure System

| Decision | Value | Notes |
|----------|-------|-------|
| **Time Tracking** | Turn-based | Consistent, save-friendly |
| **Failure Detection** | End of turn | Check all conditions |
| **Failed Quest Storage** | Player collection | Separate from completed |

### Category System

| Decision | Value | Notes |
|----------|-------|-------|
| **Categories** | Enum-based | Main, Side, Daily, Repeatable, Event |
| **Daily Reset** | Real-time | Midnight server time |
| **Abandonment** | Non-main only | Main quests cannot be abandoned |

---

## Integration Points

### From v0.3.1
- QuestReward for chain completion bonuses
- QuestPrerequisite for chain unlock logic
- NPC quest giver indicators for chain quests

### To v0.4.0 (Puzzles)
- Puzzle quests can use chain structure
- Timed puzzles use failure conditions
- Puzzle categories (if needed)

### To Future Versions
- Event system can use Event category
- Seasonal quests fit category system
- Complex scripted quests use failure conditions

---

## Next Steps

1. **Review & Approve** - Confirm scope breakdown
2. **v0.3.2a Design Spec** - Create detailed design specification
3. **Implement v0.3.2a** - Build quest chain system
4. **v0.3.2b Design Spec** - Failure condition details
5. **Implement v0.3.2b** - Build failure mechanics
6. **Implement v0.3.2c** - Build category and management features

---

*This scope breakdown provides a structured approach to implementing v0.3.2 Quest Chains & Advanced Features. Each sub-phase builds on the previous, completing the full quest system with narrative chains, meaningful failure states, and organizational tools.*
