> **Archived** - This plan has been consolidated. See the complete version at [v0.3.22](../v0.3.x/v0.3.22.md).

Here is the comprehensive implementation plan for v0.3.22b: The Inspector (Analysis Engine).
This sub-version integrates the Data Capture System (v0.1.3) with the Combat Engine (v0.2.0). It transforms the Bestiary from a passive lore repository into an active tactical tool. Players who collect lore fragments unlock progressively more detailed combat data, rewarding exploration with tactical foresight.

v0.3.22b: The Inspector
Goal: Implement the AnalysisService to query the DataCaptureService for enemy knowledge levels and return sanitized EnemyIntel to the UI via the inspect command.
1. Architecture & Data Flow
	•	Knowledge Source: The system relies on the CodexEntry associated with the enemy's TemplateId.
	•	Tier Calculation: Completion percentage determines the KnowledgeTier (Unknown, Obscured, Known, Mastered).
	•	Archetype Synergy: Jötun-Readers and Adepts receive a "Scholar's Insight" bonus, effectively boosting the calculated tier by +1.
	•	Data Masking: The AnalysisService acts as a filter, hiding exact numbers (HP, Armor) unless the tier is sufficient.
Data Flow: The Inspection Pipeline
	1	Input: Player types inspect draugr.
	2	Resolution: CombatService identifies the target Combatant.
	3	Query: AnalysisService.InspectAsync(combatant) is called.
	4	Lookup: Service calls IDataCaptureService.GetCompletionPercentageAsync using the enemy's TemplateId.
	5	Calculation:
	◦	Map Percentage to Base Tier.
	◦	Apply GameState.CurrentCharacter.Archetype modifiers.
	6	Masking: Populate EnemyIntel DTO. Fields below the effective tier are set to null or "???".
	7	Presentation: CombatScreenRenderer draws a modal popup over the battlefield with the intel.

2. Logic Decision Trees
A. Knowledge Tier Logic Input: CompletionPct (0-100), PlayerArchetype
	1	Determine Base Tier:
	◦	0% - 24%: Unknown (Tier 0)
	◦	25% - 74%: Obscured (Tier 1)
	◦	75% - 99%: Known (Tier 2)
	◦	100%: Mastered (Tier 3)
	2	Apply Bonus:
	◦	Is Player Adept (Jötun-Reader)?
	▪	Yes: Effective Tier = Min(Tier + 1, 3).
	3	Output: Effective Tier.
B. Data Masking Logic Input: Effective Tier, Enemy Stats
	1	Tier 0 (Unknown): Show Name, Flavor Description.
	◦	HP: "???"
	◦	Resistances: Hidden.
	2	Tier 1 (Obscured): Show Archetype (Tank/DPS).
	◦	HP: Narrative (e.g., "Wounded").
	◦	Resistances: Partial hints (e.g., "Thick Armor").
	3	Tier 2 (Known):
	◦	HP: Exact values (45/60).
	◦	Resistances: List specific types (e.g., "Resist: Fire").
	4	Tier 3 (Mastered):
	◦	Abilities: List known moves.
	◦	Behaviors: AI hints (e.g., "Prioritizes Healers").

3. Code Implementation
A. Knowledge Models File: RuneAndRust.Core/Models/Combat/EnemyIntel.cs
public enum KnowledgeTier { Unknown = 0, Obscured = 1, Known = 2, Mastered = 3 }

public record EnemyIntel(
    string Name,
    string Description,
    KnowledgeTier Tier,
    string HpDisplay,        // "???" vs "45/100" vs "Healthy"
    string ArmorDisplay,     // "???" vs "4"
    List<string> Traits,     // "Mechanical", "Undying"
    List<string> Weaknesses, // "Fire", "Blunt"
    List<string> Abilities   // "Rust Slam", "Vent Steam"
);
B. Analysis Service File: RuneAndRust.Engine/Services/AnalysisService.cs
public class AnalysisService
{
    private readonly IDataCaptureService _captureService;
    private readonly ICodexEntryRepository _codexRepo;

    public async Task<EnemyIntel> InspectAsync(Combatant target, Character player)
    {
        // 1. Get Base Knowledge
        int completion = 0;
        if (target.EnemySource?.TemplateId != null)
        {
            var entry = await _codexRepo.GetByTemplateIdAsync(target.EnemySource.TemplateId);
            if (entry != null)
                completion = await _captureService.GetCompletionPercentageAsync(entry.Id, player.Id);
        }

        // 2. Calculate Tier
        var tier = CalculateTier(completion, player.Archetype);

        // 3. Mask Data
        return new EnemyIntel(
            Name: target.Name,
            Description: GetDescription(target, tier),
            Tier: tier,
            HpDisplay: GetHpDisplay(target, tier),
            ArmorDisplay: tier >= KnowledgeTier.Known ? target.ArmorSoak.ToString() : "???",
            Traits: tier >= KnowledgeTier.Obscured ? target.Tags : new List<string>(),
            Weaknesses: tier >= KnowledgeTier.Known ? GetWeaknesses(target) : new List<string>(),
            Abilities: tier >= KnowledgeTier.Mastered ? GetAbilityNames(target) : new List<string>()
        );
    }

    private KnowledgeTier CalculateTier(int completion, ArchetypeType archetype)
    {
        var baseTier = completion switch
        {
            >= 100 => KnowledgeTier.Mastered,
            >= 75 => KnowledgeTier.Known,
            >= 25 => KnowledgeTier.Obscured,
            _ => KnowledgeTier.Unknown
        };

        if (archetype == ArchetypeType.Adept || archetype == ArchetypeType.Mystic) // Jötun-Reader logic
            return (KnowledgeTier)Math.Min((int)baseTier + 1, (int)KnowledgeTier.Mastered);

        return baseTier;
    }

    private string GetHpDisplay(Combatant c, KnowledgeTier tier)
    {
        if (tier >= KnowledgeTier.Known) return $"{c.CurrentHp}/{c.MaxHp}";
        if (tier >= KnowledgeTier.Obscured) return c.HealthStatus; // Narrative "Wounded"
        return "???";
    }
}

4. Deliverable Checklist (v0.3.22b)
	•	Core:
	◦	[ ] Define EnemyIntel record and KnowledgeTier enum.
	◦	[ ] Add GetByTemplateIdAsync to ICodexEntryRepository [Source 2101].
	•	Engine:
	◦	[ ] Implement AnalysisService.
	◦	[ ] Register AnalysisService in DI.
	◦	[ ] Update CommandParser to handle inspect <target>.
	•	Terminal:
	◦	[ ] Implement InspectWindowRenderer (Spectre.Console Popup).
	◦	[ ] Hook renderer to CommandParser output.
	•	Tests:
	◦	[ ] Verify Tier thresholds.
	◦	[ ] Verify Archetype bonus logic.

5. Logging Requirements
Reference: logging.md
System
Event
Level
Message Template
Properties
Analysis
Inspection
Info
"[Combat] Inspected {Target}. Completion: {Pct}%. Effective Tier: {Tier}."
Target, Pct, Tier
Analysis
Bonus Applied
Debug
"[Combat] Archetype bonus applied for {Character}."
Character

6. Testing Strategy
Unit Tests (AnalysisServiceTests.cs):
	•	Tier_Calculation_Standard:
	◦	Input: 10% Completion, Warrior.
	◦	Assert: Tier is Unknown. HpDisplay is "???".
	•	Tier_Calculation_Bonus:
	◦	Input: 10% Completion, Adept.
	◦	Assert: Tier is Obscured. HpDisplay is Narrative (e.g. "Healthy").
	•	Masking_Mastered:
	◦	Input: 100% Completion.
	◦	Assert: Abilities list is populated. Weaknesses list is populated.
Integration Tests:
	•	Unknown_Enemy: Inspecting a generic entity without a Template ID (e.g., dynamic spawn) should default to Unknown tier gracefully without crashing.

7. Draft Changelog (v0.3.22b)
# Changelog: v0.3.22b - The Inspector

**Release Date:** 2026-03-XX

## Summary
"The Inspector" activates the Bestiary, turning collected lore into tactical power. Players can now analyze enemies in combat to reveal stats, weaknesses, and abilities, with the level of detail directly tied to their progress in the Scavenger's Journal.

## Changes
- **Analysis Engine:** Implemented `AnalysisService` which correlates Bestiary completion with combat intelligence.
- **Inspect Command:** Added `inspect <target>` command in combat.
- **Knowledge Tiers:** Defined 4 levels of intel (Unknown, Obscured, Known, Mastered).
- **Archetype Bonus:** Adept characters (Jötun-Readers) automatically perceive one tier higher than their actual collection progress.
- **UI:** Added a popup inspection window to the combat screen.
Would you like to proceed to v0.3.22c: The Forecast (Predictive UI)?
