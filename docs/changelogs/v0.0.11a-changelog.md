# v0.0.11a Changelog - Descriptor Framework Expansion

**Release Date:** 2026-01-08
**Focus:** Environment categories, coherence validation, and biome-based descriptor selection

## Summary

This release expands the descriptor framework to support environment categories, coherence validation, and biome-based descriptor selection. This foundation prevents incoherent environmental descriptions (e.g., frozen + volcanic rooms) and enables rich, biome-aware atmosphere generation for future descriptor enhancements.

## New Features

### Environment Category System
- **5 environment categories** defined: Biome, Climate, Lighting, Era, Condition
- **Category values** with implied tags for automatic descriptor filtering
- **Exclusion rules** prevent incoherent combinations:
  - Volcanic + Freezing/Cold (hard rule)
  - Frozen + Hot/Scorching (hard rule)
  - Flooded + Burning (hard rule)
  - Desert + Flooded (hard rule)
  - Ancient + Pristine (soft rule - warning only)
  - Volcanic + Overgrown (soft rule - warning only)

### Biome Definitions
- **8 biomes** defined: Cave, Dungeon, Volcanic, Frozen, Swamp, Ruins, Forest, Desert
- Each biome includes:
  - Default category values (climate, lighting, etc.)
  - Implied tags for descriptor filtering
  - Descriptor pool overrides for biome-specific atmosphere
  - Emphasized and excluded terms for thematic consistency

### EnvironmentContext Value Object
- Immutable value object for room-level environment state
- Convenience properties: `Biome`, `Climate`, `Lighting`, `Era`, `Condition`
- `GetValue()`, `HasCategory()`, `WithValue()` methods for manipulation
- `DerivedTags` collection from biome and category values

### EnvironmentCoherenceService
- `Validate()` - checks environment context for exclusion rule violations
- `CreateFromBiome()` - builds context from biome with optional overrides
- `GetValidValues()` - returns non-conflicting values for a category
- `GetBiome()`, `GetAllBiomes()`, `GetCategory()`, `GetAllCategories()` accessors

### DescriptorService Extensions
- `DescriptorContext.Environment` property for environment-aware selection
- `DescriptorContext.IncludeEnvironmentTags` flag for tag merging control
- `GetEffectiveTags()` method combines explicit and derived tags
- `GetDescriptorWithEnvironment()` applies biome pool overrides
- `GenerateRoomAtmosphereWithEnvironment()` for coherent atmosphere generation

### Room Entity Extension
- `Environment` property (nullable `EnvironmentContext`)
- `SetEnvironment()` and `ClearEnvironment()` methods

## Files Created

### Domain Layer
- `src/Core/RuneAndRust.Domain/ValueObjects/EnvironmentContext.cs`

### Application Layer
- `src/Core/RuneAndRust.Application/Configuration/EnvironmentCategoryConfiguration.cs`
- `src/Core/RuneAndRust.Application/Configuration/BiomeConfiguration.cs`
- `src/Core/RuneAndRust.Application/Services/EnvironmentCoherenceService.cs`

### Configuration Files
- `config/environment-categories.json`
- `config/biomes.json`

### Unit Tests
- `tests/RuneAndRust.Domain.UnitTests/ValueObjects/EnvironmentContextTests.cs` (10 tests)
- `tests/RuneAndRust.Application.UnitTests/Services/EnvironmentCoherenceServiceTests.cs` (13 tests)
- `tests/RuneAndRust.Application.UnitTests/Services/DescriptorServiceEnvironmentTests.cs` (6 tests)

## Files Modified

- `src/Core/RuneAndRust.Domain/Entities/Room.cs` - Added Environment property and methods
- `src/Core/RuneAndRust.Application/Services/DescriptorService.cs` - Extended DescriptorContext and added environment methods
- `src/Core/RuneAndRust.Application/Interfaces/IConfigurationProvider.cs` - Added GetEnvironmentCategories() and GetBiomeConfiguration()
- `src/Infrastructure/RuneAndRust.Infrastructure/Configuration/JsonConfigurationProvider.cs` - Implemented environment configuration loading
- `src/Infrastructure/RuneAndRust.Infrastructure/DependencyInjection.cs` - Registered EnvironmentCoherenceService
- `tests/RuneAndRust.TestUtilities/Mocks/MockConfigurationProvider.cs` - Added environment configuration methods

## Test Results

- **29 new tests** added (exceeded estimated ~18)
- **All 819 tests pass** (build verified)
- **0 warnings**

## Breaking Changes

None. All changes are additive and backwards compatible.

## Dependencies

- Requires v0.0.10 (Documentation & Polish) complete
- No new NuGet package dependencies

## Configuration Format

### environment-categories.json
```json
{
  "version": "1.0",
  "categories": {
    "biome": { "id": "biome", "values": [...] },
    "climate": { "id": "climate", "values": [...] }
  },
  "exclusionRules": [
    { "id": "volcanic_freezing", "isHardRule": true, ... }
  ]
}
```

### biomes.json
```json
{
  "version": "1.0",
  "biomes": {
    "cave": {
      "id": "cave",
      "defaultCategoryValues": { "climate": "cold", "lighting": "dim" },
      "impliedTags": ["underground", "natural", "stone"],
      "descriptorPoolOverrides": { "environmental.lighting": "environmental.lighting.cave" }
    }
  }
}
```

## Usage Example

```csharp
// Create environment from biome
var environment = coherenceService.CreateFromBiome("cave");

// Apply to room
room.SetEnvironment(environment);

// Generate coherent atmosphere
var atmosphere = descriptorService.GenerateRoomAtmosphereWithEnvironment(environment);
// Returns: "Darkness presses in from all sides. Water drips somewhere in the distance."
```

## Next Steps

- **v0.0.11b**: Combat & Ability Descriptors (weapon-type hits, damage tiers, death descriptions)
- **v0.0.11c**: Environmental & Sensory Descriptors (lighting, sounds, smells, temperature)
