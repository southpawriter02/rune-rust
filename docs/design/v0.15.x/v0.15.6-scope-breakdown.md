## v0.15.6 - Advanced Perception System

**Focus:** Passive perception on room entry, three-layer examination depth, flora/fauna observation, and puzzle hint integration

**Source Specification:** [examination.md](../../aethelgard/design/07-environment/room-engine/examination.md)

### Overview

This version transforms the examination system from basic active commands into a comprehensive perception framework. Characters automatically detect hidden elements on room entry based on passive perception, gain layered information depth from active examination checks, and receive contextual observations about flora and fauna based on biome.

---

### Deliverables Summary

| Category | Items | Estimated Tests |
|----------|-------|-----------------|
| Enums | 3 | 3 |
| Value Objects | 6 | 10 |
| Entities | 2 | 4 |
| Services | 3 | 8 |
| **Total** | **14** | **~25** |

---

### v0.15.6a - Passive Perception System

#### PassivePerception Value Object
```
PassivePerception
├── CharacterId: string
├── WitsAttribute: int
├── PassiveValue: int (WITS ÷ 2, round up)
├── ModifierBreakdown: List<PerceptionModifier>
└── EffectiveValue: int (with modifiers)
```

**Passive Perception Formula:**
```
Passive Perception = WITS ÷ 2 (round up)

Example:
  WITS 6 → Passive 3
  WITS 7 → Passive 4
  WITS 10 → Passive 5
```

#### PerceptionModifier Value Object
- [ ] `ModifierId` - Unique identifier
- [ ] `Source` - What grants modifier (equipment, status, specialization)
- [ ] `Value` - Bonus/penalty to passive perception
- [ ] `Description` - Display text

**Modifier Sources:**
| Source | Modifier |
|--------|----------|
| [Alert] status | +2 |
| [Fatigued] status | -1 |
| [Exhausted] status | -2 |
| Familiar territory | +1 |
| Dim lighting | -1 |
| Total darkness | -3 |
| [Psychic Resonance] zone | -2 |

#### HiddenElement Entity
```
HiddenElement
├── ElementId: string
├── RoomId: string
├── ElementType: HiddenElementType enum
├── DiscoveryDc: int
├── IsRevealed: bool
├── RevealedBy: string? (character ID)
├── RevealedAt: DateTime?
├── DiscoveryText: string
└── InteractionData: object? (trap trigger, door ID, cache contents)
```

#### HiddenElementType Enum
```
HiddenElementType
├── Trap - Pressure plate, tripwire, etc.
├── SecretDoor - Concealed passage
├── HiddenCache - Loot container
├── SecretCompartment - Hidden storage
├── AmbushSite - Enemy hiding spot
└── ClueElement - Investigation clue
```

#### IPassivePerceptionService Interface
```csharp
public interface IPassivePerceptionService
{
    /// <summary>
    /// Calculates passive perception for a character.
    /// </summary>
    PassivePerception CalculatePassivePerception(string characterId);

    /// <summary>
    /// Checks passive perception against all hidden elements in a room.
    /// Called automatically on room entry.
    /// </summary>
    PassivePerceptionResult CheckRoomEntry(string characterId, string roomId);

    /// <summary>
    /// Reveals a specific hidden element (for active search).
    /// </summary>
    void RevealElement(string elementId, string characterId);
}
```

#### PassivePerceptionResult Value Object
- [ ] `RoomId` - Room checked
- [ ] `PassiveValue` - Character's passive perception
- [ ] `ElementsChecked` - Total hidden elements in room
- [ ] `ElementsRevealed` - List of revealed elements
- [ ] `ElementsMissed` - Count of undetected elements (no details)

**Passive Perception Logic:**
```
On Room Entry:
  1. Calculate Passive Perception (WITS ÷ 2, round up)
  2. Apply active modifiers (status effects, lighting)
  3. For each hidden element in room:
     - If Passive >= Element DC: Auto-reveal
     - If Passive < Element DC: Remains hidden
  4. Generate discovery text for revealed elements
  5. Add revealed elements to room description
```

**Discovery Text Integration:**
```
As you enter the corridor, something catches your eye...

Your trained eye catches a discrepancy—a pressure plate, barely
visible beneath the dust!

[Trap revealed: Pressure Plate (disarm DC 14)]
```

**Unit Tests (~4):**
- [ ] Passive perception calculates correctly from WITS
- [ ] Status effect modifiers apply correctly
- [ ] Room entry reveals elements at or below passive DC
- [ ] Elements above passive DC remain hidden

---

### v0.15.6b - Three-Layer Examination System

#### ExaminationLayer Enum
```
ExaminationLayer
├── Cursory (Layer 1) - No check required
├── Detailed (Layer 2) - WITS DC 12
├── Expert (Layer 3) - WITS DC 18
```

#### LayerDC Table
| Layer | Name | DC Required | Information Depth |
|-------|------|-------------|-------------------|
| 1 | Cursory | 0 (auto) | Basic visual, obvious features |
| 2 | Detailed | 12 | Functional details, condition, hints |
| 3 | Expert | 18 | Historical context, secrets, solutions |

#### ExaminationContext Value Object
- [ ] `ObjectId` - What is being examined
- [ ] `ObjectType` - Door, Machinery, Decorative, etc.
- [ ] `CharacterId` - Who is examining
- [ ] `WitsPool` - Character's WITS dice pool
- [ ] `BiomeId` - Current biome for context
- [ ] `PreviousExaminations` - Has character examined this before?

#### ExaminationResult Value Object
```
ExaminationResult
├── ObjectId: string
├── ObjectName: string
├── WitsCheckResult: int (net successes)
├── HighestLayerUnlocked: int (1, 2, or 3)
├── CompositeDescription: string (all unlocked layers combined)
├── LayerTexts: List<string> (individual layer texts)
├── RevealedHint: bool
├── RevealedSolutionId: string?
└── RevealedInteractions: List<string> (new commands available)
```

#### IExaminationService Interface
```csharp
public interface IExaminationService
{
    /// <summary>
    /// Examines an object with WITS check, returning layered description.
    /// </summary>
    ExaminationResult ExamineObject(
        string objectId,
        string characterId,
        SkillContext? context = null);

    /// <summary>
    /// Gets the base (Layer 1) description without a check.
    /// Used for `look` command.
    /// </summary>
    string GetCursoryDescription(string objectId);

    /// <summary>
    /// Checks if an object has been fully examined (Layer 3) by character.
    /// </summary>
    bool HasExpertKnowledge(string characterId, string objectId);
}
```

**Layer Composition Logic:**
```
On Examine Command:
  1. Roll WITS pool vs DC 12 (for Layer 2)
  2. If success, also check vs DC 18 (for Layer 3)
  3. Compose description from all unlocked layers
  4. Track highest layer unlocked for this character/object
  5. Reveal any puzzle hints or new interactions
```

**Example Progression:**
```
Layer 1 (Cursory - Always):
  "A heavy iron door, currently locked."

Layer 2 (Detailed - DC 12):
  "A heavy iron door reinforced with Jötun metalwork. The lock
  mechanism is complex—Jötun engineering, designed to resist
  forced entry. No visible signs of recent use; dust coats the handle."

Layer 3 (Expert - DC 18):
  "A heavy iron door bearing the seal of Level 7 Security Clearance.
  The lock mechanism uses a combination of physical tumblers and runic
  authentication. Age has corrupted the rune-lock—a skilled lockpicker
  might bypass the physical mechanism, or someone with Galdr knowledge
  could attempt to restore the runic component."
```

**Unit Tests (~4):**
- [ ] Layer 1 always returns without check
- [ ] Layer 2 requires DC 12 success
- [ ] Layer 3 requires DC 18 success
- [ ] Composite description includes all unlocked layers

---

### v0.15.6c - Object Category Descriptors

#### ObjectCategory Enum
```
ObjectCategory
├── Door - Locked, blast, security doors
├── Machinery - Consoles, servitors, devices
├── Decorative - Inscriptions, skeletons, art
├── Container - Chests, lockers, crates
├── Furniture - Tables, chairs, beds
├── Environmental - Walls, floors, features
└── Creature - Corpses, remains
```

#### ObjectDescriptor Entity
```
ObjectDescriptor
├── DescriptorId: string
├── ObjectCategory: ObjectCategory enum
├── ObjectType: string (LockedDoor, BlastDoor, etc.)
├── Layer: int (1, 2, or 3)
├── RequiredDc: int
├── BiomeAffinity: string? (null = universal)
├── DescriptorText: string
├── RevealsHint: bool
├── RevealsSolutionId: string?
├── Weight: int (for variant selection)
```

**Descriptor Coverage:**
| Category | Example Types | Descriptor Count |
|----------|---------------|------------------|
| Door | Locked, Blast, Security, Jammed | ~20 |
| Machinery | Console, Servitor, Terminal, Device | ~30 |
| Decorative | Inscription, Skeleton, Mural, Statue | ~25 |
| Container | Chest, Locker, Crate, Compartment | ~15 |
| Environmental | Wall, Floor, Ceiling, Pillar | ~10 |
| **Total** | | ~100 |

**Configuration (`examination-descriptors.json`):**
```json
{
  "descriptors": [
    {
      "id": "locked-door-cursory-01",
      "category": "Door",
      "type": "LockedDoor",
      "layer": 1,
      "dc": 0,
      "text": "A heavy iron door, currently locked.",
      "weight": 1
    },
    {
      "id": "locked-door-detailed-01",
      "category": "Door",
      "type": "LockedDoor",
      "layer": 2,
      "dc": 12,
      "text": "A heavy iron door reinforced with Jötun metalwork...",
      "weight": 1
    }
  ]
}
```

**Unit Tests (~2):**
- [ ] Descriptor lookup by category and type works
- [ ] Biome affinity filters correctly

---

### v0.15.6d - Flora & Fauna Observation

#### FloraFaunaCategory Enum
```
FloraFaunaCategory
├── Flora - Plants, fungi, moss, growths
├── Fauna - Ambient creatures, non-hostile animals
```

#### FloraFaunaDescriptor Value Object
```
FloraFaunaDescriptor
├── DescriptorId: string
├── Category: FloraFaunaCategory enum
├── SpeciesName: string (common name)
├── ScientificName: string? (Aethelgard Latin)
├── Layer: int (1, 2, or 3)
├── RequiredDc: int
├── Biome: string (The Roots, Muspelheim, etc.)
├── DescriptorText: string
├── AlchemicalUse: string?
├── HarvestDc: int?
├── HarvestRisk: string?
```

**Flora by Biome:**
| Biome | Flora | Description |
|-------|-------|-------------|
| The Roots | Luminous Shelf Fungus | Bioluminescent, alchemical use |
| The Roots | Rust-Eater Moss | Orange, feeds on metal |
| Muspelheim | Ember Moss | Thermophilic, generates heat |
| Niflheim | Frost Lichen | Blue, cold-adapted |
| Alfheim | Paradox Spore Clusters | Reality-warping, dangerous |

**Fauna by Biome:**
| Biome | Fauna | Behavior |
|-------|-------|----------|
| Universal | Cave Rat | Ambient, indicates safety |
| The Roots | Rust Beetles | Feed on corroded metal |
| Alfheim | Blight-Moths | Attracted to runic energy |

#### IFloraFaunaService Interface
```csharp
public interface IFloraFaunaService
{
    /// <summary>
    /// Gets ambient flora/fauna observation for room.
    /// </summary>
    string GetAmbientObservation(
        string roomId,
        string biome,
        int witsPool);

    /// <summary>
    /// Examines specific flora/fauna with layered detail.
    /// </summary>
    ExaminationResult ExamineSpecies(
        string speciesId,
        int witsPool);

    /// <summary>
    /// Gets harvestable flora in current room.
    /// </summary>
    IReadOnlyList<HarvestableFlora> GetHarvestableFlora(string roomId);
}
```

**Unit Tests (~3):**
- [ ] Biome-appropriate flora appears in room
- [ ] Expert observation reveals alchemical uses
- [ ] Harvestable flora lists correctly

---

### v0.15.6e - Puzzle Hint Integration

#### PuzzleHint Value Object
```
PuzzleHint
├── HintId: string
├── PuzzleId: string
├── HintLevel: int (1 = subtle, 3 = obvious)
├── RevealedBy: string (examination, perception, dialogue)
├── HintText: string
├── UnlocksInteraction: string? (new command)
```

#### ExaminationHintLink Value Object
```
ExaminationHintLink
├── ObjectId: string
├── RequiredLayer: int (usually 3)
├── PuzzleId: string
├── HintId: string
├── RevealCondition: string? (optional prereq)
```

**Puzzle Reveal Logic:**
```
On Expert Examination (Layer 3):
  1. Check for linked puzzle hints
  2. If hint exists and conditions met:
     - Add hint to player's discovered hints
     - Display hint revelation text
     - Unlock new interaction if specified
  3. Track puzzle progress
```

**Example Expert Reveal:**
```
> examine console

[WITS Check vs DC 18]
Rolling... 4 successes

A Jötun Environmental Control Console, Designation ENV-4422...
The console could potentially be used to divert power, vent
atmospheres, or even access locked-down emergency protocols.

[Hint revealed: Console Override (WITS DC 4)]
[New command available: override console]
```

**Unit Tests (~2):**
- [ ] Expert examination reveals linked puzzle hints
- [ ] New interactions unlock on hint reveal

---

### v0.15.6f - Search Command Enhancement

#### SearchResult Value Object
```
SearchResult
├── RoomId: string
├── CharacterId: string
├── WitsCheckResult: int
├── ItemsFound: List<FoundItem>
├── HiddenElementsRevealed: List<HiddenElement>
├── ContainersSearched: List<string>
├── TimeSpent: int (minutes)
```

#### FoundItem Value Object
- [ ] `ItemId` - What was found
- [ ] `Location` - Where it was found
- [ ] `DiscoveryDc` - How hard it was to find
- [ ] `DiscoveryText` - Flavor text

**Search vs Examine vs Passive:**
| Method | Trigger | Target | Result |
|--------|---------|--------|--------|
| Passive | Room entry | All hidden elements | Auto-reveal at/below DC |
| Search | `search` command | Room or container | Active reveal with bonus |
| Examine | `examine <object>` | Single object | Layered description |

**Active Search Bonus:**
- Active `search` command grants +2 to effective perception
- Can find elements above passive perception threshold
- Takes time (varies by room size)

**Unit Tests (~2):**
- [ ] Search reveals elements above passive threshold
- [ ] Search includes time cost

---

### v0.15.6g - Investigation Command

#### InvestigationContext Value Object
```
InvestigationContext
├── TargetType: InvestigationTarget enum
├── TargetId: string
├── CharacterId: string
├── CluesGathered: List<ClueId>
├── TimeSpent: int
├── DeductionsAvailable: List<Deduction>
```

#### InvestigationTarget Enum
```
InvestigationTarget
├── Crime Scene - Murder, theft, etc.
├── Remains - Corpse, skeleton
├── Wreckage - Destroyed equipment
├── Trail - Footprints, blood trail
├── Document - Written clues
```

#### InvestigationResult Value Object
- [ ] `Success` - Was investigation successful
- [ ] `CluesDiscovered` - New clues found
- [ ] `DeductionsMade` - Logical conclusions
- [ ] `NarrativeText` - Description of findings

**Investigation Logic:**
```
investigate <target>:
  1. Requires WITS + Investigation skill
  2. DC based on target complexity
  3. Success reveals clues
  4. Multiple clues enable deductions
  5. Expert success reveals hidden connections
```

**Unit Tests (~2):**
- [ ] Investigation discovers appropriate clues
- [ ] Multiple clues enable deductions

---

### v0.15.6h - Specialization Integration

#### Jötun-Reader Abilities
- [ ] `[Deep Scan]` - +2d10 to examine machinery/terminals
- [ ] `[Pattern Recognition]` - Auto-succeed Layer 2 for Jötun tech

#### Ruin-Stalker Abilities
- [ ] `[Trap Sense]` - +2 passive perception vs traps
- [ ] `[Sixth Sense]` - Auto-detect traps within 10 feet

#### Veiðimaðr (Hunter) Abilities
- [ ] `[Keen Senses]` - +1 passive perception (always)
- [ ] `[Read the Signs]` - Bonus to investigate creature remains

#### Thul Abilities
- [ ] `[Lore Keeper]` - Auto-succeed Layer 3 for historical objects
- [ ] `[Ancient Knowledge]` - Reveal extra lore on expert examination

**Unit Tests (~2):**
- [ ] Ruin-Stalker trap bonus applies to passive perception
- [ ] Thul auto-succeeds Layer 3 for historical objects

---

### v0.15.6i - Room Entry Integration

#### RoomEntryPerceptionFlow
```
On Character Enters Room:
  1. Calculate passive perception
  2. Check all hidden elements in room
  3. Reveal elements at or below passive DC
  4. Generate ambient flora/fauna observations
  5. Compose room description with discoveries
  6. Display to player
```

#### PerceptionGatedDescription Value Object
```
PerceptionGatedDescription
├── RoomId: string
├── BaseDescription: string (always shown)
├── GatedElements: List<GatedElement>
│   ├── ElementId: string
│   ├── RequiredDc: int
│   ├── DescriptionFragment: string
│   └── IsRevealed: bool
```

**Gated Description Example:**
```
Base (always):
  "A dimly lit corridor stretches before you."

DC 12 (if passive >= 12):
  "Dust patterns on the floor suggest recent passage."

DC 16 (if passive >= 16):
  "A concealed pressure plate lies beneath the dust near the doorway."
```

**Unit Tests (~2):**
- [ ] Room entry triggers passive perception check
- [ ] Gated descriptions appear based on passive value

---

### Configuration Files

| File | Purpose |
|------|---------|
| `examination-descriptors.json` | Object examination text by category/layer |
| `perception-descriptors.json` | Hidden element discovery text |
| `flora-fauna-descriptors.json` | Biome flora and fauna descriptions |
| `puzzle-hints.json` | Puzzle hint definitions and links |
| `hidden-elements.json` | Room hidden element definitions |
| `perception-modifiers.json` | Status effect perception modifiers |

---

### Dependencies

**Requires:**
- v0.15.0: Dice pool refactor (success-counting for WITS checks)
- v0.15.1: Skill infrastructure (SkillContext, SkillOutcome)
- v0.10.x: Status effects ([Alert], [Fatigued])
- Room system: Room entry events, description composition

**Provides to:**
- Puzzle system: Hint discovery mechanism
- Trap system: Detection before trigger
- Exploration: Hidden content discovery
- Lore system: Environmental storytelling

---

### Acceptance Criteria

- [ ] Passive perception calculates correctly (WITS ÷ 2, round up)
- [ ] Room entry triggers automatic passive perception check
- [ ] Hidden elements reveal when passive >= DC
- [ ] Three-layer examination provides progressive detail
- [ ] Layer 1 (Cursory) always available without check
- [ ] Layer 2 (Detailed) requires DC 12 WITS success
- [ ] Layer 3 (Expert) requires DC 18 WITS success
- [ ] Composite description includes all unlocked layers
- [ ] Flora/fauna observations match room biome
- [ ] Expert examination reveals puzzle hints
- [ ] New interactions unlock from hints
- [ ] Search command provides active perception bonus
- [ ] Investigation command processes clues correctly
- [ ] Specialization perception bonuses apply
- [ ] Status effect modifiers affect passive perception
- [ ] ~25 unit tests pass
