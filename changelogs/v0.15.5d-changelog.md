# v0.15.5d Changelog - Navigation System

## Summary

Implements the **Navigation System** for the Wasteland Survival skill. This subsystem allows characters to navigate through various terrain types with difficulty based on terrain complexity, equipment bonuses, familiarity, and environmental conditions. Features 5 terrain types with DCs from 8-24, weather modifiers (+1 to -4), compass and familiar territory bonuses, fumble consequences with dangerous area encounters, and time penalties for partial success/failure outcomes.

## Added

### Domain Layer - Enums (2 files)

| File | Description |
|------|-------------|
| `NavigationOutcome.cs` | 4-value enum for navigation outcomes: Success (×1.0 time), PartialSuccess (×1.25 time), Failure (×1.5 time), Fumble (dangerous area). Extension methods: `GetTimeMultiplier()`, `GetDisplayName()`, `GetDescription()`, `ReachedDestination()`, `GotLost()`, `EnteredDangerousArea()`. |
| `DangerousAreaType.cs` | 3-value enum for dangerous areas entered on fumble: HazardZone (roll 1-2), HostileTerritory (roll 3-4), GlitchPocket (roll 5-6). Extension methods: `GetDisplayName()`, `GetDescription()`, `GetMinRoll()`, `GetMaxRoll()`, `FromRoll()`, `HasEnvironmentalHazards()`, `MayTriggerCombat()`, `HasGlitchEffects()`. |

### Domain Layer - Modified Enums (2 files)

| File | Changes |
|------|---------|
| `FumbleType.cs` | Added `Disoriented = 11` value for navigation fumbles. Updated all 6 extension methods: `BlocksAllTargets()` → false, `IsInstant()` → false, `GetAssociatedSkillId()` → "wasteland-survival", `GetDisplayName()` → "Disoriented", `GetDescription()`, `TriggersCombat()` → false, `IsPermanent()` → false. |
| `NavigationTerrainType.cs` | Added extension methods to existing enum: `GetBaseDc()` (8-24), `GetDisplayName()`, `GetDescription()`, `GetTravelSpeedMultiplier()` (1.0-0.3), `IsCompassEffective()` (false for GlitchedLabyrinth). |

### Domain Layer - Value Objects (2 files)

| File | Description |
|------|-------------|
| `NavigationContext.cs` | `readonly record struct` for navigation context. Properties: TerrainType, Destination, HasCompass, FamiliarTerritory, WeatherConditions, IsNightWithoutLight. Constants: CompassBonusDice (1), FamiliarTerritoryBonusDice (2), NightWithoutLightPenalty (2). Computed: BaseDc, CompassEffective, CompassModifier, FamiliarTerritoryModifier, WeatherModifier (+1 to -4), NightPenalty, TotalDiceModifier. Methods: `ToSkillContext()`, `ToDisplayString()`, `ToDetailedString()`. Factory methods: `CreateSimple()`, `CreateWithBonuses()`, `CreateFull()`. |
| `NavigationResult.cs` | `readonly record struct` result container. Properties: Outcome, TimeModifier, NetSuccesses, TargetDc, HazardEncountered, DangerousAreaType, RollDetails. Computed: ReachedDestination, GotLost, EnteredDangerousArea, Failed, Margin, TimeModifierPercent. Factory methods: `Success()`, `PartialSuccess()`, `Failure()`, `Fumble()`, `Empty()`. Methods: `ToDisplayString()`, `ToDetailedString()`. |

### Application Layer - Interface (1 file)

| File | Description |
|------|-------------|
| `IWastelandNavigationService.cs` | Service interface: `AttemptNavigation()`, `CanNavigate()`, `GetNavigationBlockedReason()`, `CalculateBaseDc()`, `CalculateDiceModifiers()`, `GetTerrainDescription()`, `GetTerrainSpeedMultiplier()`, `IsCompassEffective()`, `GetWeatherModifier()`, `GetDangerousAreaDescription()`, `RollDangerousAreaType()`, `CalculateActualTravelTime()`, `GetOutcomeTimeMultiplier()`. Full XML documentation with examples. |

### Application Layer - Service (1 file)

| File | Description |
|------|-------------|
| `WastelandNavigationService.cs` | Full implementation of IWastelandNavigationService. Dependencies: SkillCheckService, DiceService, IFumbleConsequenceService, ILogger. Constants for terrain DCs (8-24), speed multipliers (1.0-0.3), outcome time multipliers (1.0, 1.25, 1.5), dice modifiers (compass +1, familiar +2, night -2), weather modifiers (+1 to -4), partial success margin (2). Implements outcome determination logic including fumble detection (0 successes + botch). Creates Disoriented fumble consequence on navigation fumbles. Comprehensive logging at Information, Debug, and Warning levels. |

### Configuration (2 files)

| File | Description |
|------|-------------|
| `config/terrain-types.json` | Configuration for terrain types (DCs, speed multipliers, compass effectiveness), weather modifiers, equipment modifiers (compass variants), familiar territory bonus, night penalty, outcome time multipliers, outcome thresholds, dangerous area definitions with d6 roll ranges, fumble consequence definition, and balance notes. |
| `config/schemas/terrain-types.schema.json` | JSON Schema 2020-12 for terrain-types.json validation. Defines terrainDefinition, weatherDefinition, equipmentDefinition, bonusDefinition, penaltyDefinition, outcomeDefinition, outcomeThresholdsDefinition, dangerousAreaDefinition, fumbleConsequenceDefinition. |

### Unit Tests (1 file, 30+ tests)

| File | Tests |
|------|-------|
| `WastelandNavigationServiceTests.cs` | Terrain DC tests (5 parameterized cases), Terrain description tests (3 types), Terrain speed multiplier tests (5 parameterized cases), Compass effectiveness tests (5 parameterized cases), Dice modifier tests (6 cases: compass in normal/glitched terrain, familiar territory, all bonuses combined, weather modifiers, night penalty, worst case scenario), Time multiplier tests (4 parameterized outcome cases), Travel time calculation test, Dangerous area tests (2 cases: roll validation, descriptions), Navigation prerequisites tests (4 cases), NavigationContext tests (5 cases: BaseDc, CompassEffective, TotalDiceModifier, ToSkillContext, factory methods), NavigationResult tests (6 cases: Success/PartialSuccess/Failure/Fumble properties, Empty factory, ToDisplayString), NavigationOutcome extension tests (3 cases), DangerousAreaType extension tests (2 cases). |

## Key Features

### Terrain Types

| Terrain | Base DC | Speed | Compass |
|---------|---------|-------|---------|
| Open Wasteland | 8 | ×1.0 | Effective |
| Moderate Ruins | 12 | ×0.8 | Effective |
| Dense Ruins | 16 | ×0.6 | Effective |
| Labyrinthine | 20 | ×0.4 | Effective |
| Glitched Labyrinth | 24 | ×0.3 | **Ineffective** |

### Dice Modifiers

| Source | Modifier | Notes |
|--------|----------|-------|
| Working Compass | +1d10 | Ineffective in Glitched Labyrinth |
| Familiar Territory | +2d10 | Previously explored area |
| Clear Weather | +1d10 | Good visibility |
| Cloudy Weather | +0 | Normal conditions |
| Light Rain | -1d10 | Reduced visibility |
| Heavy Rain | -2d10 | Poor visibility |
| Fog | -3d10 | Very poor visibility |
| Storm | -4d10 | Severe conditions |
| Night (no light) | -2d10 | Traveling without light source |

### Navigation Outcomes

| Outcome | Condition | Time Modifier |
|---------|-----------|---------------|
| Success | Net successes ≥ DC | ×1.0 (no penalty) |
| Partial Success | Net successes ≥ DC - 2 | ×1.25 (+25% time) |
| Failure | Net successes < DC - 2 | ×1.5 (+50% time) |
| Fumble | 0 successes + ≥1 botch | Dangerous area |

### Dangerous Areas (on Fumble)

| d6 Roll | Area Type | Effects |
|---------|-----------|---------|
| 1-2 | Hazard Zone | Environmental hazards (radiation, toxic, unstable) |
| 3-4 | Hostile Territory | Combat encounter likely |
| 5-6 | Glitch Pocket | Reality distortion, Glitch corruption risk |

### Fumble Consequence

- **Type**: Disoriented
- **Effect**: Cannot attempt navigation until recovered
- **Recovery**: Rest at safe location OR successful orientation check (DC 12)

## Files Changed

### Added (9 files)
- `src/Core/RuneAndRust.Domain/Enums/NavigationOutcome.cs`
- `src/Core/RuneAndRust.Domain/Enums/DangerousAreaType.cs`
- `src/Core/RuneAndRust.Domain/ValueObjects/NavigationContext.cs`
- `src/Core/RuneAndRust.Domain/ValueObjects/NavigationResult.cs`
- `src/Core/RuneAndRust.Application/Interfaces/IWastelandNavigationService.cs`
- `src/Core/RuneAndRust.Application/Services/WastelandNavigationService.cs`
- `config/terrain-types.json`
- `config/schemas/terrain-types.schema.json`
- `tests/RuneAndRust.Application.UnitTests/Services/WastelandNavigationServiceTests.cs`
- `changelogs/v0.15.5d-changelog.md`

### Modified (2 files)
- `src/Core/RuneAndRust.Domain/Enums/FumbleType.cs` - Added `Disoriented = 11`
- `src/Core/RuneAndRust.Domain/Enums/NavigationTerrainType.cs` - Added extension methods

## Dependencies

- `SkillCheckService.cs` - For performing Wasteland Survival navigation checks
- `DiceService.cs` - For rolling d6 on fumble (dangerous area determination)
- `IFumbleConsequenceService.cs` - For creating Disoriented fumble consequence
- `WeatherType.cs` - Existing weather conditions enum (used for weather modifiers)
- `NavigationTerrainType.cs` - Existing terrain type enum (added extension methods)
- `SkillContext.cs` - For passing situational modifiers from NavigationContext
- `Player.cs` entity - For navigator identification
- `ILogger<WastelandNavigationService>` - For comprehensive logging

## Integration Points

- **SkillCheckService**: Uses `PerformCheckWithContext()` for navigation skill checks
- **DiceService**: Uses `RollTotal("1d6")` for dangerous area type determination
- **IFumbleConsequenceService**: Uses `CreateConsequence()` to apply Disoriented on fumble
- **SkillContext**: NavigationContext converts to SkillContext via `ToSkillContext()`
- **WeatherType**: Maps existing weather enum to navigation modifiers

## Notes

- Named service `IWastelandNavigationService` to avoid collision with UI navigation services
- Weather modifiers adapted from existing `WeatherType` enum (not `WeatherCondition` from spec)
- Compass bonus is +1d10, not +2d10 (spec adjustment for balance)
- Glitched Labyrinth is the only terrain where compasses fail
- Fumble requires BOTH 0 successes AND at least 1 botch (not just 0 successes)
- Partial success margin is 2 (net successes ≥ DC - 2)
- All modifiers stack additively (can result in highly negative values in worst case)
- This builds upon v0.15.5a (Extended Tracking), v0.15.5b (Counter-Tracking), v0.15.5c (Foraging)
- Provides foundation for v0.15.5e (Hazard Detection) and future navigation-related features
