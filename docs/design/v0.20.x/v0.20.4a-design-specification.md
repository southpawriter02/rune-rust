# Design Specification: v0.20.4a - Myrk-gengr Framework & Tier 1 Abilities

**Version:** v0.20.4a
**Status:** Design Phase
**Last Updated:** 2026-01-28
**Target Tests:** ~10 unit and integration tests
**Specialization:** Myrk-gengr (Shadow-Walker)
**Path Type:** Heretical (First)
**Archetype:** Skirmisher

---

## Table of Contents

1. [Executive Summary](#1-executive-summary)
2. [Specialization Overview](#2-specialization-overview)
3. [Architecture Diagrams](#3-architecture-diagrams)
4. [Domain Model Specifications](#4-domain-model-specifications)
5. [Shadow Essence Resource System](#5-shadow-essence-resource-system)
6. [Light Level Detection System](#6-light-level-detection-system)
7. [Corruption Risk Framework](#7-corruption-risk-framework)
8. [Shadow Step Ability Specification](#8-shadow-step-ability-specification)
9. [Cloak of Night Ability Specification](#9-cloak-of-night-ability-specification)
10. [Dark-Adapted Ability Specification](#10-dark-adapted-ability-specification)
11. [User Stories](#11-user-stories)
12. [Application Service Layer](#12-application-service-layer)
13. [Configuration Specifications](#13-configuration-specifications)
14. [Code Examples & Implementation](#14-code-examples--implementation)
15. [State Machine Diagrams](#15-state-machine-diagrams)
16. [Corruption Integration Patterns](#16-corruption-integration-patterns)
17. [Logging Specifications](#17-logging-specifications)
18. [Unit Testing Requirements](#18-unit-testing-requirements)
19. [Deliverable Checklist](#19-deliverable-checklist)
20. [Acceptance Criteria](#20-acceptance-criteria)
21. [Dependencies & Prerequisites](#21-dependencies--prerequisites)
22. [Design Decisions & Rationale](#22-design-decisions--rationale)

---

## 1. Executive Summary

Version 0.20.4a introduces the **Myrk-gengr (Shadow-Walker)** specialization framework, establishing the **first Heretical path** in the v0.20.x series. This phase focuses on:

- **Shadow Essence Resource:** A special resource unique to Myrk-gengr, generated from darkness and consumed by shadow abilities
- **Corruption Risk Integration:** First implementation of Heretical path mechanics that penalizes ability use in bright light or against Coherent-aligned targets
- **Light Level Detection:** Dynamic light level evaluation system that affects ability effectiveness and Shadow Essence generation
- **Tier 1 Abilities (3):** Shadow Step (mobility), Cloak of Night (stealth stance), Dark-Adapted (passive immunity to dim light penalties)

### Key Deliverables

| Category | Count | Details |
|----------|-------|---------|
| **Domain Value Objects** | 4 | ShadowEssenceResource, ShadowPosition, LightLevel, CorruptionRiskResult |
| **Domain Enums** | 3 | MyrkgengrAbilityId, LightLevelType, ShadowAbilityType |
| **Application Services** | 3 | ShadowEssenceService, MyrkgengrAbilityService, ShadowCorruptionService |
| **Ability Implementations** | 3 | Shadow Step, Cloak of Night, Dark-Adapted |
| **Configuration Files** | 2 | specializations.json (Myrk-gengr entry), abilities.json (Tier 1) |
| **Unit Tests** | ~10 | Comprehensive coverage of services and abilities |

### Specialization Profile

| Attribute | Value |
|-----------|-------|
| **Display Name** | Myrk-gengr |
| **Pronunciation** | MIRK-gen-gur |
| **Translation** | Shadow-Walker / Darkness-Goer |
| **Archetype** | Skirmisher |
| **Path Type** | Heretical |
| **Role** | Stealth / Assassination / Shadow Magic |
| **Special Resource** | Shadow Essence (Max 50) |
| **Tagline** | "One with the Darkness" |
| **Unlock Cost** | 0 PP (immediately available after Skirmisher selection) |

---

## 2. Specialization Overview

### 2.1 Thematic Foundation

The Myrk-gengr walks a dangerous path, having touched the void between light and shadow. In Aethelgard, shadows are not merely the absence of light — they are a liminal space where reality grows thin and the Glitch seeps through. The Myrk-gengr has learned to draw power from this dangerous boundary, becoming more shadow than flesh.

**Design Principles:**

1. **Heretical Risk:** Shadow abilities carry Corruption risk, especially in bright light
2. **Darkness Dependency:** Power increases in shadow, penalties in bright light
3. **Mobility Focus:** Teleportation and phasing for tactical repositioning
4. **Assassination Mastery:** High burst damage from stealth (Tier 2+)
5. **First Heretical Specialization:** Establishes Corruption integration patterns for v0.20.5+

### 2.2 Tier 1 Identity

**Tier 1 Abilities (Immediately Available):**

| Ability | Type | AP Cost | Resource Cost | Range |
|---------|------|---------|---------------|-------|
| Shadow Step | Active | 2 AP | 10 Shadow Essence | 6 spaces |
| Cloak of Night | Stance | 1 AP | 5 Shadow Essence/turn | Self |
| Dark-Adapted | Passive | — | — | — |

**Mechanical Focus:** Foundation abilities establish the core identity of shadow manipulation and stealth

---

## 3. Architecture Diagrams

### 3.1 Domain Layer Architecture

```
┌─────────────────────────────────────────────────────────────────┐
│             v0.20.4a - Myrk-gengr Domain Layer                  │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  ┌────────────────────────┐  ┌────────────────────────────┐    │
│  │ ShadowEssenceResource  │  │ ShadowPosition             │    │
│  │ (Value Object)         │  │ (Value Object)             │    │
│  ├────────────────────────┤  ├────────────────────────────┤    │
│  │ + CurrentEssence: int  │  │ + PositionId: Guid         │    │
│  │ + MaxEssence: int      │  │ + X: int                   │    │
│  │ + LastGeneratedAt?     │  │ + Y: int                   │    │
│  │ + GenerationRate: int  │  │ + LightLevel: enum         │    │
│  ├────────────────────────┤  │ + IsShadow: bool           │    │
│  │ + Spend(int): bool     │  │ + IsValidTeleportTarget    │    │
│  │ + Generate(int): void  │  │ ├────────────────────────┤    │
│  │ + GenerateFromDarkness │  │ │ + DistanceTo(): int    │    │
│  │ + IsInDarkness(): bool │  │ │ + IsWithinRange(): bool│    │
│  └────────────────────────┘  │ │ + GetShadowQuality()   │    │
│                              └────────────────────────────┘    │
│  ┌────────────────────────┐  ┌────────────────────────────┐    │
│  │ LightLevel             │  │ CorruptionRiskResult       │    │
│  │ (Value Object)         │  │ (Value Object)             │    │
│  ├────────────────────────┤  ├────────────────────────────┤    │
│  │ + CurrentLevel: enum   │  │ + RiskTriggered: bool      │    │
│  │ + SourceType: string   │  │ + CorruptionGained: int    │    │
│  │ + Intensity: int       │  │ + Reason: string           │    │
│  │ + AffectedArea: int    │  │ + AbilityUsed: string      │    │
│  ├────────────────────────┤  │ + LightCondition: enum     │    │
│  │ + IsDarkness(): bool   │  │ ├────────────────────────┤    │
│  │ + IsDimLight(): bool   │  │ │ + GetDescription()     │    │
│  │ + IsBrightLight(): bool│  │ │ + WasInBrightLight()   │    │
│  │ + GetShadowEssence...  │  │ └────────────────────────┘    │
│  │   Multiplier(): float  │  │                                │
│  └────────────────────────┘  └────────────────────────────────┘    │
│                                                                  │
│  ┌────────────────────────┐  ┌────────────────────────────┐    │
│  │ MyrkgengrAbilityId     │  │ LightLevelType             │    │
│  │ (Enum)                 │  │ (Enum)                     │    │
│  ├────────────────────────┤  ├────────────────────────────┤    │
│  │ - ShadowStep           │  │ - Darkness                 │    │
│  │ - CloakOfNight         │  │ - DimLight                 │    │
│  │ - DarkAdapted          │  │ - NormalLight              │    │
│  │ - UmbralStrike         │  │ - BrightLight              │    │
│  │ - ShadowClone          │  │ - MagicalLight             │    │
│  │ - VoidTouched          │  │                            │    │
│  │ - MergeWithDarkness    │  │                            │    │
│  │ - ShadowSnare          │  │                            │    │
│  │ - Eclipse              │  │                            │    │
│  └────────────────────────┘  └────────────────────────────┘    │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

### 3.2 Application Service Layer Architecture

```
┌──────────────────────────────────────────────────────────────────┐
│         v0.20.4a - Application Services Layer                    │
├──────────────────────────────────────────────────────────────────┤
│                                                                   │
│  ┌────────────────────────────┐  ┌─────────────────────────────┐ │
│  │ IShadowEssenceService      │  │ ILightLevelService         │ │
│  │ (Interface)                │  │ (Interface)                 │ │
│  ├────────────────────────────┤  ├─────────────────────────────┤ │
│  │ + GetCurrentEssence()      │  │ + GetLightLevelAt()         │ │
│  │ + SpendEssence()           │  │ + DetermineLightLevel()     │ │
│  │ + GenerateEssence()        │  │ + GetShadowQuality()        │ │
│  │ + GenerateFromDarkness()   │  │ + IsValidShadowArea()       │ │
│  │ + GetMaxEssence()          │  │ + EvaluateVisibility()      │ │
│  │ + RestoreEssence()         │  │ + CalculatePenalties()      │ │
│  └────────────────────────────┘  └─────────────────────────────┘ │
│             │                                   │                  │
│             └────────────────┬──────────────────┘                  │
│                              │                                    │
│  ┌────────────────────────────────────────────────────────────┐   │
│  │ IMyrkgengrAbilityService                                   │   │
│  │ (Core Ability Handler)                                     │   │
│  ├────────────────────────────────────────────────────────────┤   │
│  │ + ExecuteShadowStep()                                      │   │
│  │ + ExecuteCloakOfNight()                                    │   │
│  │ + ApplyDarkAdapted()                                       │   │
│  │ + ValidateAbilityUsage()                                   │   │
│  │ + CalculateResourceCost()                                  │   │
│  │ + GetAbilityDescription()                                  │   │
│  └────────────────────────────────────────────────────────────┘   │
│                              │                                    │
│  ┌────────────────────────────────────────────────────────────┐   │
│  │ IShadowCorruptionService                                   │   │
│  │ (Heretical Path Integration)                               │   │
│  ├────────────────────────────────────────────────────────────┤   │
│  │ + EvaluateRisk()                                           │   │
│  │ + ApplyCorruption()                                        │   │
│  │ + GetCorruptionTriggers()                                  │   │
│  │ + CalculateCorruptionAmount()                              │   │
│  │ + CheckBrightLightPenalty()                                │   │
│  │ + CheckCoherentTargetPenalty()                             │   │
│  └────────────────────────────────────────────────────────────┘   │
│                              │                                    │
│                              ▼                                    │
│  ┌────────────────────────────────────────────────────────────┐   │
│  │ ICorruptionService (from v0.18.x)                          │   │
│  │ (Dependency: Existing System)                              │   │
│  └────────────────────────────────────────────────────────────┘   │
│                                                                   │
└──────────────────────────────────────────────────────────────────┘
```

### 3.3 Shadow Essence Flow Diagram

```
┌─────────────┐
│   Darkness  │  +5/turn
│             │
└────────┬────┘
         │
         ▼
┌─────────────────────────┐
│  Shadow Essence Pool    │
│  (0-50 current)         │
├─────────────────────────┤
│ Sources:                │
│ • Darkness (5/turn)     │
│ • Dim Light (2/turn)    │
│ • Ability bonuses       │
│ • Shadow Step arrival   │
│ • Rest recovery         │
└────────┬────────────────┘
         │
    ┌────┴────────────────────┬─────────────┬─────────────┐
    │                         │             │             │
    ▼                         ▼             ▼             ▼
┌─────────────┐    ┌─────────────────┐ ┌──────────┐ ┌──────────────┐
│ Shadow Step │    │ Cloak of Night  │ │ Umbral   │ │ Shadow Clone │
│ (10 Essence)│    │ (5/turn Stance) │ │ Strike   │ │ (20 Essence) │
└─────────────┘    │                 │ │(15)      │ └──────────────┘
                   │ (Tier 2)        │ │(Tier 2)  │
                   └─────────────────┘ └──────────┘
```

---

## 4. Domain Model Specifications

### 4.1 ShadowEssenceResource (Value Object)

**Purpose:** Encapsulates the special resource pool unique to Myrk-gengr specialization.

**Properties:**

```csharp
public sealed record ShadowEssenceResource
{
    /// <summary>Current Shadow Essence points (0-50).</summary>
    public int CurrentEssence { get; private set; }

    /// <summary>Maximum Shadow Essence (default 50).</summary>
    public int MaxEssence { get; init; } = 50;

    /// <summary>When essence was last generated.</summary>
    public DateTime? LastGeneratedAt { get; private set; }

    /// <summary>Generation rate per turn in darkness (default 5).</summary>
    public int GenerationRate { get; init; } = 5;

    /// <summary>Timestamp of last resource update.</summary>
    public DateTime LastUpdatedAt { get; private set; }
}
```

**Methods:**

| Method | Signature | Purpose |
|--------|-----------|---------|
| Spend | `bool Spend(int amount)` | Deducts essence; returns success |
| Generate | `void Generate(int amount)` | Adds essence up to max |
| GenerateFromDarkness | `void GenerateFromDarkness(LightLevelType lightLevel)` | Generates based on light condition |
| IsInDarkness | `bool IsInDarkness(LightLevelType lightLevel)` | Checks if light level qualifies for generation |
| GetPercentage | `double GetPercentage()` | Returns current essence as percentage (0.0-1.0) |
| IsFullyCharged | `bool IsFullyCharged()` | Returns true if CurrentEssence == MaxEssence |
| GetDeficitAmount | `int GetDeficitAmount()` | Returns difference between max and current |

**Invariants:**

- `CurrentEssence` must be >= 0 and <= `MaxEssence`
- `MaxEssence` must be > 0
- `GenerationRate` must be >= 0

### 4.2 ShadowPosition (Value Object)

**Purpose:** Represents a position with shadow and light level properties for teleportation targeting.

**Properties:**

```csharp
public sealed record ShadowPosition
{
    public Guid PositionId { get; init; }
    public int X { get; init; }
    public int Y { get; init; }
    public LightLevelType LightLevel { get; init; }
    public bool IsShadow { get; init; }
    public bool IsValidTeleportTarget { get; init; }
    public int ShadowQuality { get; init; } // 0-100 (quality of shadow)
    public DateTime EvaluatedAt { get; init; }
}
```

**Factory Methods:**

```csharp
public static ShadowPosition FromGamePosition(Position pos, LightLevel light)
{
    bool isShadow = light.IsDarkness() || light.IsDimLight();
    return new ShadowPosition
    {
        PositionId = pos.Id,
        X = pos.X,
        Y = pos.Y,
        LightLevel = light.CurrentLevel,
        IsShadow = isShadow,
        IsValidTeleportTarget = isShadow && !pos.IsOccupied,
        ShadowQuality = CalculateShadowQuality(light),
        EvaluatedAt = DateTime.UtcNow
    };
}
```

### 4.3 LightLevel (Value Object)

**Purpose:** Represents the current light conditions at a location with mechanics for ability resolution.

**Properties:**

```csharp
public sealed record LightLevel
{
    public LightLevelType CurrentLevel { get; init; }
    public string SourceType { get; init; } // "Torch", "Daylight", "Magical", etc.
    public int Intensity { get; init; } // 0-100 (0 = total darkness, 100 = bright daylight)
    public int AffectedArea { get; init; } // Radius in spaces
    public bool IsTransitional { get; init; }
}
```

**Query Methods:**

| Method | Returns | Purpose |
|--------|---------|---------|
| IsDarkness() | `bool` | Intensity == 0 |
| IsDimLight() | `bool` | 1-40 intensity |
| IsNormalLight() | `bool` | 41-70 intensity |
| IsBrightLight() | `bool` | 71-100 intensity |
| IsMagicalLight() | `bool` | SourceType contains "Magical" or "Aetheric" |
| GetShadowEssenceMultiplier() | `float` | 5.0 (darkness), 2.0 (dim), 0 (light) |
| QualifiesAsUsableShadow() | `bool` | Darkness or DimLight |

### 4.4 CorruptionRiskResult (Value Object)

**Purpose:** Encapsulates the result of a corruption risk evaluation for an ability use.

**Properties:**

```csharp
public sealed record CorruptionRiskResult
{
    public bool RiskTriggered { get; init; }
    public int CorruptionGained { get; init; }
    public string Reason { get; init; }
    public string AbilityUsed { get; init; }
    public LightLevelType LightCondition { get; init; }
    public bool TargetIsCoherent { get; init; }
    public DateTime EvaluatedAt { get; init; }
}
```

**Query Methods:**

| Method | Returns | Purpose |
|--------|---------|---------|
| WasInBrightLight() | `bool` | LightCondition == BrightLight |
| WasTargetCoherent() | `bool` | TargetIsCoherent == true |
| GetDescriptionForPlayer() | `string` | Human-readable reason |

---

## 5. Shadow Essence Resource System

### 5.1 Generation Rules

**Generation occurs at the START of each turn, before ability execution.**

| Light Level | Generation | Notes |
|-------------|-----------|-------|
| **Darkness** | +5 Shadow Essence | Full connection to void |
| **Dim Light** | +2 Shadow Essence | Partial shadow benefit |
| **Normal Light** | 0 Shadow Essence | No generation |
| **Bright Light** | 0 Shadow Essence | No generation |
| **Magical Light** | 0 Shadow Essence | Aetheric light blocks shadow power |

**Bonus Generation Sources:**

| Trigger | Bonus Essence | Condition |
|---------|---------------|-----------|
| Shadow Step arrival in Darkness | +5 | Only on successful teleport destination |
| Rest (short rest, 1 hour) | +10 | Recovers to max if no interruption |
| Rest (long rest, 8 hours) | Full Restore | Restores all Shadow Essence to 50 |
| Critical Success on ability | +3 | Rare, only on nat 20 ability checks |

### 5.2 Consumption Rules

**Resources are consumed IMMEDIATELY upon ability execution (before resolution).**

| Ability | Cost | Notes |
|---------|------|-------|
| **Shadow Step** | 10 Essence | Must have sufficient essence to cast |
| **Cloak of Night** (entry) | 0 Essence | Entered with 1 AP cost |
| **Cloak of Night** (maintain/turn) | 5 Essence/turn | Deducted at end of turn if active |
| **Umbral Strike** | 15 Essence | Tier 2 (v0.20.4b) |
| **Shadow Clone** | 20 Essence | Tier 2 (v0.20.4b) |

**Insufficient Essence Behavior:**

- Ability cannot be executed if current essence < required cost
- UI displays "Insufficient Shadow Essence" error
- No partial casting or reduced-effect casting allowed
- Resources are NOT consumed if ability fails pre-execution validation

### 5.3 Display & Feedback

**Character Status Display:**

```
Shadow Essence: ██████████████████████████░░░░░░░░░░░░░░░░░░░░░░ 35/50
```

**Color Coding:**

- Green (80-100%): Full power
- Yellow (40-79%): Usable
- Red (20-39%): Low reserves
- Critical Red (0-19%): Emergency only

**Resource Tooltips:**

When hovering over Shadow Essence bar:

```
Shadow Essence
Current: 35/50 (70%)

Generation (next turn):
• Darkness: +5 (current light level: Dim Light, +2)
• Short Rest: +10
• Long Rest: Full restore

Recent actions:
• Shadow Step: -10 (used 5 turns ago)
• Cloak of Night: -5 (maintaining, -5/turn ongoing)
```

---

## 6. Light Level Detection System

### 6.1 Light Level Determination

**System evaluates light level at character's current position when needed.**

**Priority Order for Light Sources:**

1. **Direct Light:** Torches, lanterns, magical globes (highest intensity)
2. **Ambient Light:** Daylight, moon, city lights (medium intensity)
3. **Magical Light:** Seiðr-empowered lights, Aetheric sources (variable)
4. **Shadows:** Absence of above (lowest)

**Calculation Formula:**

```
Intensity = (Source1_Intensity + Source2_Intensity + ...) / NumberOfSources
            Capped at 100

If Intensity == 0: Darkness
Else if 1-40: Dim Light
Else if 41-70: Normal Light
Else if 71-100: Bright Light
```

### 6.2 Shadow Validation for Abilities

**For Shadow Step and other abilities requiring shadow:**

1. Evaluate light level at TARGET position
2. Check if light level is Darkness or DimLight
3. Verify position is unoccupied
4. Confirm position is within range
5. Return validation result

**Invalid Shadow Targets:**

```
- Normal Light (DC 14 Perception to see through glare)
- Bright Light (automatic failure)
- Occupied spaces (blocked)
- Out of range (checked)
- Solid objects blocking LOS (for non-phasing abilities)
```

### 6.3 Penalty & Bonus Application

**Light Level Effects on Abilities:**

| Light Level | Shadow Step | Cloak of Night | Dark-Adapted | Essence Gen |
|-------------|-------------|----------------|-------------|-------------|
| **Darkness** | Usable | +3 Stealth | +2/turn gen | +5/turn |
| **Dim Light** | Usable | +3 Stealth | No penalty | +2/turn |
| **Normal Light** | Not usable | +1 Stealth | Normal | 0 |
| **Bright Light** | Not usable | -1 Stealth + Corruption | Normal | 0 |
| **Magical Light** | Not usable (unless null Aetheric) | Varies | Normal | 0 |

---

## 7. Corruption Risk Framework

### 7.1 Corruption Triggers for Tier 1 Abilities

**Shadow Step Corruption:**

| Scenario | Corruption Gain | Notes |
|----------|-----------------|-------|
| Used in Darkness | 0 | No risk in shadow |
| Used in Dim Light | 0 | Still in shadow |
| Used in Normal Light | +1 | Moving away from shadow |
| Used in Bright Light | +1 | Significant risk |
| Used in Magical Light | +1 | Aetheric opposition |

**Cloak of Night Corruption:**

| Scenario | Corruption Gain | Notes |
|----------|-----------------|-------|
| Maintained in Darkness/Dim Light | 0/turn | Safe in shadow |
| Maintained in Normal Light | +1 | Per turn if maintained |
| Maintained in Bright Light | +1 | Per turn if maintained |
| Auto-end from low essence | 0 | No corruption for running out |

**Dark-Adapted Corruption:**

| Scenario | Corruption Gain | Notes |
|----------|-----------------|-------|
| Passive ability | 0 | Never triggers corruption |
| In any light level | 0 | Cannot cause corruption |

### 7.2 Corruption Risk Service Interface

```csharp
/// <summary>
/// Service for handling Myrk-gengr Corruption risks.
/// First implementation of Heretical path mechanics.
/// </summary>
public interface IShadowCorruptionService
{
    /// <summary>
    /// Evaluates Corruption risk for a shadow ability.
    /// </summary>
    CorruptionRiskResult EvaluateRisk(
        MyrkgengrAbilityId ability,
        LightLevelType lightLevel,
        bool targetIsCoherent = false);

    /// <summary>
    /// Applies Corruption from a shadow ability use.
    /// </summary>
    void ApplyCorruption(Guid characterId, CorruptionRiskResult risk);

    /// <summary>
    /// Gets all possible Corruption triggers for an ability.
    /// </summary>
    IReadOnlyList<CorruptionRiskTrigger> GetCorruptionTriggers(
        MyrkgengrAbilityId ability);

    /// <summary>
    /// Calculates total Corruption amount based on conditions.
    /// </summary>
    int CalculateCorruptionAmount(
        MyrkgengrAbilityId ability,
        LightLevelType lightLevel,
        bool targetIsCoherent = false);
}
```

### 7.3 Corruption Thresholds & Effects

**Corruption Accumulation:**

```
0-2:  No effects
3-5:  First visual indicator (aura darkening)
6-8:  Mechanical penalty (-1 to light-based checks)
9-10: Threshold reached - character needs rest/redemption arc
11+:  Transformation risk (v0.20.5+ mechanics)
```

**V0.20.4a Focus:** Only tracks and applies corruption; no consequences (those come in v0.20.5+)

---

## 8. Shadow Step Ability Specification

### 8.1 Core Mechanics

**Type:** Active Ability (Combat / Out-of-combat usable)
**AP Cost:** 2 AP
**Shadow Essence Cost:** 10
**Range:** 6 spaces (from caster to target shadow)
**Cooldown:** None (costs are the limiter)
**Line of Sight:** Not required (can teleport through walls to shadows)

### 8.2 Execution Flow

```
1. Player inputs command: "ability shadow-step <position>"
2. System validates:
   ├─ Does character have 10+ Shadow Essence? → No: fail
   ├─ Is target position within 6 spaces? → No: fail
   ├─ Is target position in shadow (Darkness/DimLight)? → No: fail
   ├─ Is target position unoccupied? → No: fail
   └─ Is character able to use abilities? → No: fail

3. If all valid:
   ├─ Spend 10 Shadow Essence
   ├─ Teleport character to target position
   ├─ Check if destination is in Darkness
   │  ├─ If yes: Generate +5 Shadow Essence
   │  └─ If no: No bonus (shouldn't happen if validation correct)
   ├─ Evaluate Corruption risk (if used in bright light)
   │  └─ If in bright light: +1 Corruption
   └─ Log ability execution

4. Output feedback to player:
   "You dissolve into shadow and emerge 5 spaces away.
    Shadow Essence: 30/50 (-10)
    Arrived in Darkness: +5 Shadow Essence → 35/50"
```

### 8.3 Targeting Requirements

**Valid Shadow Destinations:**

| Condition | Required | Reason |
|-----------|----------|--------|
| Light Level: Darkness or DimLight | YES | Must be in shadow |
| Within 6 spaces | YES | Range limit |
| Unoccupied | YES | Cannot teleport into creatures |
| Not in solid object | YES | Cannot end in walls |
| Line of Sight | NO | Can teleport through objects |

**Invalid Cases (Feedback):**

```
"Cannot shadow-step: destination too far (7 spaces, max 6)"
"Cannot shadow-step: destination is too bright (Normal Light)"
"Cannot shadow-step: destination occupied by hostile creature"
"Cannot shadow-step: insufficient Shadow Essence (need 10, have 7)"
```

### 8.4 Special Cases

**Occupied Destination:**

- If destination has allies: "Shadow Step cannot target occupied spaces"
- If destination has enemies: "Shadow Step cannot target occupied spaces" (same message)
- If destination has objects/terrain: Depends on terrain passability

**Darkness Bonus on Arrival:**

- Automatically grants +5 Shadow Essence if arriving in Darkness
- Does not require player action; happens automatically
- Visual feedback shows the bonus

**Bright Light Usage:**

- Ability IS usable from bright light (moving away from light)
- Ability is NOT usable TO bright light (shadow requirement on target)
- Using FROM bright light triggers +1 Corruption risk

### 8.5 Combat Applications

**Offensive Use:**

1. Close distance to out-of-reach enemy
2. Position behind enemy for flanking
3. Escape combat (move to shadow outside of range)

**Defensive Use:**

1. Escape incoming attacks
2. Move to cover/shadow
3. Reposition to better tactical location

**Stealth Use:**

1. Move between shadow areas without exposed movement
2. Maintain concealment while repositioning
3. Approach targets stealthily

---

## 9. Cloak of Night Ability Specification

### 9.1 Core Mechanics

**Type:** Stance (Active, Maintained)
**AP Cost:** 1 AP to enter stance
**Shadow Essence Cost:** 5 per turn to maintain (deducted at end of turn)
**Duration:** Continuous while maintained or until essence depleted
**Automatic End Conditions:**
- Shadow Essence drops below 5 (cannot maintain)
- Player manually ends stance
- Character becomes incapacitated

### 9.2 Effects by Light Level

**In Darkness or Dim Light (Shadow):**

```
Stealth Bonus: +3
Silent Movement: YES (no sound detection possible)
Enemy Perception Penalty: -2 (to detect you)
Essence Cost: 5/turn
Active Effects: True
```

**In Normal Light:**

```
Stealth Bonus: +1 (reduced from +3)
Silent Movement: NO (normal sound rules apply)
Enemy Perception Penalty: 0 (normal sight detection)
Essence Cost: 5/turn (same)
Active Effects: Partial
```

**In Bright Light:**

```
Stealth Bonus: -1 (penalty instead of bonus)
Silent Movement: NO (sounds normally)
Enemy Perception Bonus: +2 (easier to spot you)
Essence Cost: 5/turn + Corruption (5 Shadow Essence + 1 Corruption)
Active Effects: Detrimental
Warning: "Your shadow cloak flickers in the bright light!"
```

### 9.3 Mechanical Interaction

**Stealth Checks:**

```
Without Cloak of Night:
Stealth Check = d20 + Stealth modifier

With Cloak of Night (in shadow):
Stealth Check = d20 + Stealth modifier + 3

Example: Character with Stealth +3
Without cloak: d20 + 3
With cloak: d20 + 3 + 3 = d20 + 6
```

**Enemy Detection:**

```
Normal Perception Check:
Perception = d20 + Perception modifier

Against Cloak of Night user (shadow):
Perception = d20 + Perception modifier - 2

Example: Guard with Perception +2
Normal: d20 + 2
vs. Cloak: d20 + 2 - 2 = d20 + 0 (even odds)
```

### 9.4 Stance Maintenance

**Turn-by-Turn Cost:**

```
Start of Turn 1: Stance entered (1 AP, no cost yet)
End of Turn 1: Essence deducted (-5 Shadow Essence)
Start of Turn 2: Generate essence (+2 in dim light)
End of Turn 2: Essence deducted (-5 Shadow Essence)
...continues until:
  • Player ends stance
  • Essence < 5 (forced end)
  • Character incapacitated
```

**Low Essence Warning:**

```
When Shadow Essence < 10 (can only sustain 2 more turns):
Message: "Your shadow cloak is fading (8 essence remaining, need 5/turn)"
Color: Yellow (warning)
```

**Forced Termination:**

```
When Shadow Essence drops below 5:
Message: "Your shadow cloak fades as darkness abandons you."
Effect: Stance automatically ends
No essence refund
```

### 9.5 Interaction with Other Systems

**With Invisibility:**

- Cloak of Night is NOT invisibility
- Still visible, just harder to notice
- Does not combine with true invisibility spells

**With Stealth Checks:**

- Adds bonus to Stealth, not automatic hiding
- Still must use Stealth action to hide
- Bonus applies to Stealth checks while stance active

**With Movement:**

- Stance is maintained while moving
- Silent movement benefit applies while in shadow
- No movement speed change

---

## 10. Dark-Adapted Ability Specification

### 10.1 Core Mechanics

**Type:** Passive (Always Active, No AP/Resource Cost)
**Automatic Activation:** Granted when specialization selected
**Duration:** Permanent for specialization duration
**No Cooldown:** Passive ability, always active

### 10.2 Dim Light Penalty Removal

**Normal Dim Light Penalties (WITHOUT Dark-Adapted):**

| Check Type | Penalty |
|-----------|---------|
| Perception checks | -2 |
| Attack rolls | -1 |
| Skill checks (sight-based) | -1 |
| Movement speed | Half speed (5 ft → 2.5 ft) |

**WITH Dark-Adapted Passive:**

| Check Type | Penalty |
|-----------|---------|
| Perception checks | 0 (no penalty) |
| Attack rolls | 0 (no penalty) |
| Skill checks (sight-based) | 0 (no penalty) |
| Movement speed | Normal (no reduction) |

**Visual/Mechanical Effects:**

```
Dim Light normally causes squinting, reduced vision range, slower movement.
Dark-Adapted grants you the ability to:
• See clearly in dim conditions
• Move at normal speed
• No disadvantage on sight-based checks
• Attack normally without dim light penalties
```

### 10.3 Passive Essence Generation

**In Darkness (Light Level = Darkness):**

```
Passive generation: +2 Shadow Essence per turn
This stacks with other generation sources
```

**Generation Calculation:**

```
Turn start in Darkness (and not in other generation scenario):
  Base generation = 5 (darkness level)
  Dark-Adapted bonus = +2
  Total = 7 Shadow Essence generated

Turn start in Darkness while already generating from other source:
  Other generation applies
  Dark-Adapted bonus = +2 additional
  Total = other + 2
```

**Timeline Example:**

```
Turn 1, Start:
  Position: Darkness
  Shadow Essence: 20/50
  Action: Dark-Adapted generates +2 → 22/50

Turn 2, Start:
  Position: Dim Light
  Shadow Essence: 22/50
  Action: Normal Dim Light generation (+2), Dark-Adapted check (not darkness, no bonus)
  Result: +2 → 24/50

Turn 3, Start:
  Position: Darkness
  Shadow Essence: 24/50
  Action: Darkness generation (+5) + Dark-Adapted bonus (+2) → +7 total
  Result: +7 → 31/50
```

### 10.4 Limitations

**What Dark-Adapted Does NOT Do:**

- Does NOT grant darkvision
- Does NOT allow sight in total darkness (DC 16 Darkness)
- Does NOT remove penalties from actual darkness (only dim light)
- Does NOT grant bonus in bright light
- Does NOT bypass magical darkness effects

**True Darkness vs. Dim Light:**

```
Dim Light (Light Level 1-40):
  Normal: -2 Perception, -1 Attack, half movement
  With Dark-Adapted: No penalties (REMOVES ALL)

True Darkness (Light Level 0):
  Normal: Vision completely blocked, must use light source or senses
  With Dark-Adapted: NO CHANGE (still blocked, still requires action)

Note: Dark-Adapted does not help against true Darkness!
```

### 10.5 Passive Stacking

**With Other Passive Bonuses:**

- Dark-Adapted stacks with other perception bonuses
- Essence generation from Dark-Adapted stacks with other sources
- No diminishing returns or conflicts

**Example with Multiple Passive Sources:**

```
Character has:
  • Dark-Adapted (Myrk-gengr Tier 1)
  • Keen Senses (other passive)

In Dim Light:
  Perception = d20 + Perception mod + Keen Senses bonus - Dark-Adapted removal
  = d20 + Perception mod + (Keen Senses bonus) - (-2 from dim light)
  = d20 + Perception mod + Keen Senses bonus + 2

In Darkness:
  Shadow Essence generation = 5 (darkness) + 2 (Dark-Adapted) = 7/turn
```

---

## 11. User Stories

### User Story 1: Shadow-Walker Selects Specialization

**As a** Skirmisher archetype player at character creation
**I want to** select Myrk-gengr specialization and immediately receive Shadow Essence resource
**So that** I can begin using shadow-based stealth and mobility abilities

**Acceptance Criteria:**

- [ ] Shadow Essence initialized to 50/50 on specialization selection
- [ ] Character sheet displays Shadow Essence bar with 50/50 value
- [ ] Tier 1 abilities (Shadow Step, Cloak of Night, Dark-Adapted) are unlocked
- [ ] First ability can be used immediately after character creation
- [ ] Corruption starts at 0/10

### User Story 2: Myrk-gengr Teleports in Combat

**As a** combat participant using Shadow Step ability
**I want to** teleport to a shadow location within 6 spaces to reposition
**So that** I can outmaneuver enemies and maintain tactical advantage

**Acceptance Criteria:**

- [ ] Valid shadows (Darkness/DimLight) within 6 spaces are highlighted when ability is active
- [ ] Invalid destinations are grayed out or show reason
- [ ] Teleportation is instant (uses 2 AP only)
- [ ] Arriving in Darkness grants +5 Shadow Essence automatically
- [ ] Insufficient essence (< 10) shows error message
- [ ] Bright light destinations are prevented

### User Story 3: Stealth Approach with Cloak of Night

**As a** Myrk-gengr using Cloak of Night to approach a target stealthily
**I want to** activate stance and move silently through shadows
**So that** I can surprise enemies without detection

**Acceptance Criteria:**

- [ ] Stance activation costs 1 AP and no initial resource
- [ ] +3 Stealth bonus applies while in shadow
- [ ] Silent movement prevents sound-based detection in shadows
- [ ] Enemy Perception penalties apply (-2 DC for detecting character)
- [ ] Each turn: 5 Shadow Essence deducted at turn end
- [ ] Essence warning appears when reserve < 10
- [ ] Exiting shadow reduces bonus to +1 (Stealth still applies)

### User Story 4: Character Navigates Dim Light

**As a** Dark-Adapted Myrk-gengr exploring dim tunnel
**I want to** move and perceive normally despite low light
**So that** I don't suffer penalties from familiar darkness

**Acceptance Criteria:**

- [ ] Perception checks have no -2 penalty in dim light
- [ ] Attack rolls have no -1 penalty in dim light
- [ ] Movement speed remains full (not halved)
- [ ] +2 Shadow Essence generated passively per turn in darkness
- [ ] Ability applies automatically (no action required)
- [ ] Does not affect true darkness (Light Level = 0)

### User Story 5: Corruption from Bright Light Usage

**As a** Myrk-gengr using Shadow Step from bright light
**I want to** understand that shadow magic in brightness costs corruption
**So that** I can make informed decisions about ability usage in light

**Acceptance Criteria:**

- [ ] Using Shadow Step from bright light shows warning
- [ ] +1 Corruption is applied after ability resolves
- [ ] Message states: "Using shadow abilities in bright light risks corruption"
- [ ] Corruption counter increments on character sheet
- [ ] Warning system explains Heretical path mechanic

---

## 12. Application Service Layer

### 12.1 ShadowEssenceService Implementation

```csharp
/// <summary>
/// Service for managing Shadow Essence resource.
/// Handles generation, consumption, and balance checks.
/// </summary>
public class ShadowEssenceService : IShadowEssenceService
{
    private readonly ICharacterRepository _characterRepository;
    private readonly ILightLevelService _lightLevelService;
    private readonly ILogger<ShadowEssenceService> _logger;

    public ShadowEssenceService(
        ICharacterRepository characterRepository,
        ILightLevelService lightLevelService,
        ILogger<ShadowEssenceService> logger)
    {
        _characterRepository = characterRepository;
        _lightLevelService = lightLevelService;
        _logger = logger;
    }

    public async Task<bool> TrySpendEssenceAsync(
        Guid characterId,
        int amount,
        string sourceAbility)
    {
        var character = await _characterRepository.GetByIdAsync(characterId);
        if (character?.ShadowEssence == null)
            return false;

        if (character.ShadowEssence.CurrentEssence < amount)
        {
            _logger.LogWarning(
                "Insufficient shadow essence for {Ability}: need {Amount}, have {Current}",
                sourceAbility, amount, character.ShadowEssence.CurrentEssence);
            return false;
        }

        var updated = character.ShadowEssence with
        {
            CurrentEssence = character.ShadowEssence.CurrentEssence - amount
        };

        character.ShadowEssence = updated;
        await _characterRepository.UpdateAsync(character);

        _logger.LogInformation(
            "Shadow Essence spent: {Amount} ({Source}), remaining {Remaining}/{Max}",
            amount, sourceAbility, updated.CurrentEssence, updated.MaxEssence);

        return true;
    }

    public async Task GenerateEssenceAsync(
        Guid characterId,
        int amount,
        string source)
    {
        var character = await _characterRepository.GetByIdAsync(characterId);
        if (character?.ShadowEssence == null)
            return;

        var updated = character.ShadowEssence with
        {
            CurrentEssence = Math.Min(
                character.ShadowEssence.CurrentEssence + amount,
                character.ShadowEssence.MaxEssence),
            LastGeneratedAt = DateTime.UtcNow
        };

        character.ShadowEssence = updated;
        await _characterRepository.UpdateAsync(character);

        _logger.LogInformation(
            "Shadow Essence generated: +{Amount} ({Source}), total {Current}/{Max}",
            amount, source, updated.CurrentEssence, updated.MaxEssence);
    }

    public async Task GenerateFromDarknessAsync(Guid characterId)
    {
        var character = await _characterRepository.GetByIdAsync(characterId);
        if (character?.ShadowEssence == null)
            return;

        var lightLevel = await _lightLevelService.GetLightLevelAsync(
            character.Position.X,
            character.Position.Y,
            character.CurrentZone);

        int generationAmount = lightLevel.CurrentLevel switch
        {
            LightLevelType.Darkness => 5,
            LightLevelType.DimLight => 2,
            _ => 0
        };

        if (generationAmount > 0)
        {
            await GenerateEssenceAsync(characterId, generationAmount,
                $"Darkness ({lightLevel.CurrentLevel})");
        }
    }

    public int GetCurrentEssence(Guid characterId)
    {
        // Synchronous version for UI display
        var character = _characterRepository.GetById(characterId);
        return character?.ShadowEssence?.CurrentEssence ?? 0;
    }

    public double GetEssencePercentage(Guid characterId)
    {
        var character = _characterRepository.GetById(characterId);
        if (character?.ShadowEssence == null)
            return 0.0;

        return (double)character.ShadowEssence.CurrentEssence /
               character.ShadowEssence.MaxEssence;
    }
}
```

### 12.2 MyrkgengrAbilityService Implementation

```csharp
/// <summary>
/// Service for executing Myrk-gengr abilities with validation.
/// </summary>
public class MyrkgengrAbilityService : IMyrkgengrAbilityService
{
    private readonly IShadowEssenceService _essenceService;
    private readonly ILightLevelService _lightLevelService;
    private readonly IShadowCorruptionService _corruptionService;
    private readonly ICharacterRepository _characterRepository;
    private readonly ILogger<MyrkgengrAbilityService> _logger;

    public async Task<AbilityExecutionResult> ExecuteShadowStepAsync(
        Guid characterId,
        int targetX,
        int targetY)
    {
        var character = await _characterRepository.GetByIdAsync(characterId);
        if (character?.ShadowEssence == null)
            return AbilityExecutionResult.Failure("Character not found or not Myrk-gengr");

        // Validate essence
        if (!await _essenceService.TrySpendEssenceAsync(characterId, 10, "shadow-step"))
            return AbilityExecutionResult.Failure(
                $"Insufficient Shadow Essence (need 10, have {character.ShadowEssence.CurrentEssence})");

        // Validate range
        int distance = Math.Abs(targetX - character.Position.X) +
                      Math.Abs(targetY - character.Position.Y);
        if (distance > 6)
            return AbilityExecutionResult.Failure(
                $"Target too far ({distance} spaces, max 6)");

        // Validate destination light level
        var targetLight = await _lightLevelService.GetLightLevelAsync(
            targetX, targetY, character.CurrentZone);

        if (!targetLight.QualifiesAsUsableShadow())
            return AbilityExecutionResult.Failure(
                $"Cannot shadow-step to {targetLight.CurrentLevel} (must be shadow)");

        // Validate destination unoccupied
        var targetPos = await _characterRepository.GetAtPositionAsync(targetX, targetY);
        if (targetPos != null)
            return AbilityExecutionResult.Failure("Target position occupied");

        // Execute teleportation
        character.Position = new Position { X = targetX, Y = targetY };

        // Generate bonus essence if arriving in darkness
        if (targetLight.CurrentLevel == LightLevelType.Darkness)
        {
            await _essenceService.GenerateEssenceAsync(characterId, 5, "shadow-step-arrival");
        }

        // Check corruption risk
        var originLight = await _lightLevelService.GetLightLevelAsync(
            character.Position.X, character.Position.Y, character.CurrentZone);

        var corruption = _corruptionService.EvaluateRisk(
            MyrkgengrAbilityId.ShadowStep,
            originLight.CurrentLevel);

        if (corruption.RiskTriggered)
        {
            _corruptionService.ApplyCorruption(characterId, corruption);
        }

        await _characterRepository.UpdateAsync(character);

        var message = $"You dissolve into shadow and emerge at ({targetX}, {targetY}). " +
                     $"Shadow Essence: {character.ShadowEssence.CurrentEssence}/50";

        return AbilityExecutionResult.Success(message);
    }

    public async Task<StanceActivationResult> ActivateCloakOfNightAsync(Guid characterId)
    {
        var character = await _characterRepository.GetByIdAsync(characterId);
        if (character?.ShadowEssence == null)
            return StanceActivationResult.Failure("Character not found");

        character.ActiveStance = StanceType.CloakOfNight;
        character.StanceActivatedAt = DateTime.UtcNow;

        await _characterRepository.UpdateAsync(character);

        _logger.LogInformation("Cloak of Night activated for character {CharacterId}", characterId);

        return StanceActivationResult.Success("You wrap yourself in shadow and become one with the darkness");
    }

    public async Task MaintainCloakOfNightAsync(Guid characterId)
    {
        var character = await _characterRepository.GetByIdAsync(characterId);
        if (character?.ActiveStance != StanceType.CloakOfNight)
            return;

        // Deduct 5 essence at end of turn
        if (!await _essenceService.TrySpendEssenceAsync(characterId, 5, "cloak-of-night-maintain"))
        {
            _logger.LogInformation("Cloak of Night ended: insufficient Shadow Essence");
            character.ActiveStance = null;
            await _characterRepository.UpdateAsync(character);
            return;
        }

        // Check for bright light corruption
        var lightLevel = await _lightLevelService.GetLightLevelAsync(
            character.Position.X, character.Position.Y, character.CurrentZone);

        if (lightLevel.IsBrightLight())
        {
            var corruption = _corruptionService.EvaluateRisk(
                MyrkgengrAbilityId.CloakOfNight,
                LightLevelType.BrightLight);

            if (corruption.RiskTriggered)
            {
                _corruptionService.ApplyCorruption(characterId, corruption);
                _logger.LogWarning(
                    "Cloak of Night corruption: +{Amount} (bright light)",
                    corruption.CorruptionGained);
            }
        }
    }
}
```

### 12.3 ShadowCorruptionService Implementation

```csharp
/// <summary>
/// Service for handling Myrk-gengr Corruption risks.
/// First implementation of Heretical path mechanics.
/// </summary>
public class ShadowCorruptionService : IShadowCorruptionService
{
    private readonly ICorruptionService _corruptionService; // from v0.18.x
    private readonly ILogger<ShadowCorruptionService> _logger;

    private static readonly Dictionary<MyrkgengrAbilityId, Dictionary<LightLevelType, int>>
        CorruptionRisks = new()
        {
            {
                MyrkgengrAbilityId.ShadowStep,
                new()
                {
                    { LightLevelType.Darkness, 0 },
                    { LightLevelType.DimLight, 0 },
                    { LightLevelType.NormalLight, 1 },
                    { LightLevelType.BrightLight, 1 },
                    { LightLevelType.MagicalLight, 1 }
                }
            },
            {
                MyrkgengrAbilityId.CloakOfNight,
                new()
                {
                    { LightLevelType.Darkness, 0 },
                    { LightLevelType.DimLight, 0 },
                    { LightLevelType.NormalLight, 1 },
                    { LightLevelType.BrightLight, 1 },
                    { LightLevelType.MagicalLight, 0 }
                }
            },
            {
                MyrkgengrAbilityId.DarkAdapted,
                new()
                {
                    { LightLevelType.Darkness, 0 },
                    { LightLevelType.DimLight, 0 },
                    { LightLevelType.NormalLight, 0 },
                    { LightLevelType.BrightLight, 0 },
                    { LightLevelType.MagicalLight, 0 }
                }
            }
        };

    public CorruptionRiskResult EvaluateRisk(
        MyrkgengrAbilityId ability,
        LightLevelType lightLevel,
        bool targetIsCoherent = false)
    {
        int corruptionAmount = 0;
        string reason = "";

        if (CorruptionRisks.TryGetValue(ability, out var risks))
        {
            if (risks.TryGetValue(lightLevel, out var amount))
            {
                corruptionAmount = amount;
            }
        }

        // Add extra corruption for Coherent targets (future abilities)
        if (targetIsCoherent && ability != MyrkgengrAbilityId.DarkAdapted)
        {
            corruptionAmount += 1;
            reason = $"Using {ability} against Coherent-aligned target";
        }

        if (string.IsNullOrEmpty(reason))
        {
            reason = lightLevel switch
            {
                LightLevelType.BrightLight =>
                    $"Using {ability} in bright light",
                LightLevelType.NormalLight =>
                    $"Using {ability} in normal light",
                _ => $"Using {ability}"
            };
        }

        return new CorruptionRiskResult
        {
            RiskTriggered = corruptionAmount > 0,
            CorruptionGained = corruptionAmount,
            Reason = reason,
            AbilityUsed = ability.ToString(),
            LightCondition = lightLevel,
            TargetIsCoherent = targetIsCoherent,
            EvaluatedAt = DateTime.UtcNow
        };
    }

    public void ApplyCorruption(Guid characterId, CorruptionRiskResult risk)
    {
        if (!risk.RiskTriggered || risk.CorruptionGained <= 0)
            return;

        // Delegate to existing Corruption Service from v0.18.x
        _corruptionService.ApplyCorruption(characterId, risk.CorruptionGained);

        _logger.LogWarning(
            "Corruption applied: +{Amount} to {CharacterId} ({Reason})",
            risk.CorruptionGained, characterId, risk.Reason);
    }

    public IReadOnlyList<CorruptionRiskTrigger> GetCorruptionTriggers(
        MyrkgengrAbilityId ability)
    {
        return ability switch
        {
            MyrkgengrAbilityId.ShadowStep => new List<CorruptionRiskTrigger>
            {
                new(LightLevelType.NormalLight, 1, "Using in normal light"),
                new(LightLevelType.BrightLight, 1, "Using in bright light")
            }.AsReadOnly(),

            MyrkgengrAbilityId.CloakOfNight => new List<CorruptionRiskTrigger>
            {
                new(LightLevelType.NormalLight, 1, "Maintaining in normal light"),
                new(LightLevelType.BrightLight, 1, "Maintaining in bright light")
            }.AsReadOnly(),

            _ => Array.Empty<CorruptionRiskTrigger>().ToList().AsReadOnly()
        };
    }

    public int CalculateCorruptionAmount(
        MyrkgengrAbilityId ability,
        LightLevelType lightLevel,
        bool targetIsCoherent = false)
    {
        var result = EvaluateRisk(ability, lightLevel, targetIsCoherent);
        return result.CorruptionGained;
    }
}
```

---

## 13. Configuration Specifications

### 13.1 specializations.json (Myrk-gengr Entry)

```json
{
    "specializations": [
        {
            "specializationId": "Myrkgengr",
            "displayName": "Myrk-gengr",
            "pronunciation": "MIRK-gen-gur",
            "translation": "Shadow-Walker",
            "tagline": "One with the Darkness",
            "description": "The Myrk-gengr has touched the void between light and shadow, learning to draw power from the dangerous boundary where reality grows thin. They become more shadow than flesh, slipping between spaces and striking from darkness.",
            "selectionText": "The shadows are not where we hide. They are what we become. Step into the darkness with me.",
            "parentArchetype": "Skirmisher",
            "pathType": "Heretical",
            "icon": "myrk-gengr.png",
            "color": "#1a1a2e",
            "unlockCost": 0,
            "specialResource": {
                "resourceId": "shadow-essence",
                "resourceName": "Shadow Essence",
                "description": "Power drawn from darkness. Generated in shadows, spent to fuel shadow abilities.",
                "maxValue": 50,
                "startingValue": 50,
                "displayFormat": "{current}/{max}",
                "colorLow": "#ff4444",
                "colorMid": "#ffdd44",
                "colorHigh": "#44ff44"
            },
            "corruptionRisk": {
                "enabled": true,
                "description": "Shadow abilities risk Corruption in bright light or against Coherent-aligned targets",
                "brightLightAbility": 1,
                "coherentTarget": 1,
                "capstoneUse": 2,
                "extendedShadowForm": 1
            },
            "abilityTiers": [
                {
                    "tier": 1,
                    "ppRequirement": 0,
                    "abilityCost": 0,
                    "abilities": [
                        "shadow-step",
                        "cloak-of-night",
                        "dark-adapted"
                    ]
                },
                {
                    "tier": 2,
                    "ppRequirement": 8,
                    "abilityCost": 4,
                    "abilities": [
                        "umbral-strike",
                        "shadow-clone",
                        "void-touched"
                    ]
                },
                {
                    "tier": 3,
                    "ppRequirement": 16,
                    "abilityCost": 5,
                    "abilities": [
                        "merge-with-darkness",
                        "shadow-snare"
                    ]
                },
                {
                    "tier": "capstone",
                    "ppRequirement": 24,
                    "abilityCost": 6,
                    "abilities": [
                        "eclipse"
                    ]
                }
            ]
        }
    ]
}
```

### 13.2 abilities.json (Tier 1 Abilities Section)

```json
{
    "abilities": [
        {
            "abilityId": "shadow-step",
            "displayName": "Shadow Step",
            "specializationId": "Myrkgengr",
            "tier": 1,
            "type": "Active",
            "apCost": 2,
            "cooldown": 0,
            "resourceCost": {
                "resourceId": "shadow-essence",
                "amount": 10
            },
            "range": {
                "value": 6,
                "unit": "Spaces",
                "requiresLineOfSight": false
            },
            "targetType": "Position",
            "description": "Instantly teleport to any shadow within 6 spaces. Destination must be in Darkness or Dim Light. Generates 5 Shadow Essence if arriving in Darkness.",
            "detailedDescription": "You dissolve into shadow and reform at a location cloaked in darkness within 6 spaces. This ability does not require line of sight to the destination shadow.",
            "requirements": {
                "destinationLightLevel": ["Darkness", "DimLight"],
                "destinationUnoccupied": true,
                "minimumEssence": 10
            },
            "effects": [
                {
                    "type": "Teleport",
                    "range": 6,
                    "lineOfSight": false,
                    "destinationValidation": "shadow-only"
                },
                {
                    "type": "ConditionalEssenceGeneration",
                    "condition": "ArrivalInDarkness",
                    "amount": 5,
                    "reason": "Darkness amplifies shadow magic"
                }
            ],
            "corruptionRisk": {
                "trigger": "BrightLightUsage",
                "amount": 1,
                "description": "Using shadow magic in bright light risks corruption"
            },
            "combatUse": "Mobility/Escape",
            "stealthUse": "Repositioning",
            "notes": "Cloak of Night bonus applies before teleportation"
        },
        {
            "abilityId": "cloak-of-night",
            "displayName": "Cloak of Night",
            "specializationId": "Myrkgengr",
            "tier": 1,
            "type": "Stance",
            "apCost": 1,
            "cooldown": 0,
            "resourceCost": {
                "resourceId": "shadow-essence",
                "amount": 5,
                "recurring": true,
                "recurringFrequency": "EndOfTurn"
            },
            "duration": {
                "value": "Until manually ended or essence depleted",
                "type": "Indefinite"
            },
            "description": "Enter a stance of shadow concealment. Gain +3 Stealth in shadows and move silently. Costs 5 Shadow Essence per turn to maintain.",
            "detailedDescription": "You wrap yourself in a cloak of shadow, becoming one with the darkness. While in shadow, you gain a +3 bonus to Stealth checks and move without making sound. Each turn, this stance consumes 5 Shadow Essence to maintain.",
            "effectsByLightLevel": {
                "Darkness": {
                    "stealthBonus": 3,
                    "silentMovement": true,
                    "essence": 5,
                    "corruption": 0
                },
                "DimLight": {
                    "stealthBonus": 3,
                    "silentMovement": true,
                    "essence": 5,
                    "corruption": 0
                },
                "NormalLight": {
                    "stealthBonus": 1,
                    "silentMovement": false,
                    "essence": 5,
                    "corruption": 0
                },
                "BrightLight": {
                    "stealthBonus": -1,
                    "silentMovement": false,
                    "essence": 5,
                    "corruption": 1
                }
            },
            "effects": [
                {
                    "type": "StealthBonus",
                    "value": 3,
                    "condition": "InShadow",
                    "reducedValue": 1,
                    "normalLightCondition": true
                },
                {
                    "type": "SilentMovement",
                    "condition": "InShadow",
                    "noiseReduction": "Complete"
                },
                {
                    "type": "EnemyPerceptionPenalty",
                    "value": -2,
                    "targets": "AllEnemies",
                    "condition": "InShadow"
                }
            ],
            "maintenanceCost": {
                "resourceId": "shadow-essence",
                "amount": 5,
                "frequency": "EndOfTurn",
                "failureBehavior": "AutomaticEnd"
            },
            "corruptionRisk": {
                "trigger": "MaintainedInBrightLight",
                "amount": 1,
                "frequency": "PerTurn"
            },
            "combatUse": "Concealment",
            "stealthUse": "Silent movement and detection evasion"
        },
        {
            "abilityId": "dark-adapted",
            "displayName": "Dark-Adapted",
            "specializationId": "Myrkgengr",
            "tier": 1,
            "type": "Passive",
            "apCost": 0,
            "cooldown": 0,
            "resourceCost": null,
            "description": "Your eyes have adjusted to the darkness. You suffer no penalties in dim light and passively generate 2 Shadow Essence per turn when in Darkness.",
            "detailedDescription": "Your exposure to shadow has attuned your senses to darkness. You see clearly in dim conditions, move at normal speed despite low light, and do not suffer penalties on perception or attack rolls. Additionally, you passively generate 2 Shadow Essence each turn while in Darkness.",
            "effects": [
                {
                    "type": "RemoveConditionPenalty",
                    "condition": "DimLight",
                    "affectedChecks": ["Perception", "AttackRolls", "SkillChecks", "Movement"]
                },
                {
                    "type": "PassiveEssenceGeneration",
                    "condition": "InDarkness",
                    "amount": 2,
                    "frequency": "PerTurn"
                }
            ],
            "limitations": [
                "Does not grant darkvision",
                "Does not penetrate magical darkness",
                "Does not provide bonuses in bright light"
            ],
            "passiveApplication": "Automatic (no action required)",
            "stacking": "Stacks with other passive bonuses",
            "notes": "Dark-Adapted applies to Dim Light only, not total Darkness"
        }
    ]
}
```

---

## 14. Code Examples & Implementation

### 14.1 Character Modification for Myrk-gengr

```csharp
/// Character aggregate root modifications for Myrk-gengr support
public partial class Character : AggregateRoot
{
    /// <summary>Shadow Essence resource (null if not Myrk-gengr).</summary>
    public ShadowEssenceResource? ShadowEssence { get; set; }

    /// <summary>Current light level at character position.</summary>
    public LightLevel CurrentLightLevel { get; set; } = new()
    {
        CurrentLevel = LightLevelType.NormalLight,
        SourceType = "Ambient",
        Intensity = 50,
        AffectedArea = 50
    };

    /// <summary>Currently active stance (if any).</summary>
    public StanceType? ActiveStance { get; set; }

    /// <summary>When active stance was activated.</summary>
    public DateTime? StanceActivatedAt { get; set; }

    /// <summary>Total Corruption accumulated.</summary>
    public int CorruptionLevel { get; set; } = 0;

    /// <summary>Initialize Shadow Essence on specialization selection.</summary>
    public void SelectMyrkgengrSpecialization()
    {
        if (this.Specialization != SpecializationId.Myrkgengr)
            throw new InvalidOperationException("Character specialization mismatch");

        this.ShadowEssence = new ShadowEssenceResource
        {
            CurrentEssence = 50,
            MaxEssence = 50,
            GenerationRate = 5
        };

        this.CorruptionLevel = 0;
    }

    /// <summary>Update light level at character position.</summary>
    public void UpdateLightLevel(LightLevel newLightLevel)
    {
        this.CurrentLightLevel = newLightLevel;
    }
}
```

### 14.2 Ability Slot Registration

```csharp
/// Myrk-gengr ability slot initialization
public class MyrkgengrAbilitySlotInitializer : IAbilitySlotInitializer
{
    private readonly IAbilitySlotService _abilitySlotService;
    private readonly ILogger<MyrkgengrAbilitySlotInitializer> _logger;

    public async Task InitializeAbilitySlotsAsync(Guid characterId)
    {
        // Tier 1 - Always available (0 PP required)
        await _abilitySlotService.RegisterAbilityAsync(
            characterId,
            "shadow-step",
            tier: 1,
            ppRequired: 0);

        await _abilitySlotService.RegisterAbilityAsync(
            characterId,
            "cloak-of-night",
            tier: 1,
            ppRequired: 0);

        await _abilitySlotService.RegisterAbilityAsync(
            characterId,
            "dark-adapted",
            tier: 1,
            ppRequired: 0);

        _logger.LogInformation(
            "Myrk-gengr Tier 1 abilities registered for character {CharacterId}",
            characterId);
    }

    public async Task UnlockTier2AbilitiesAsync(Guid characterId)
    {
        // Tier 2 - 8 PP requirement
        await _abilitySlotService.RegisterAbilityAsync(
            characterId,
            "umbral-strike",
            tier: 2,
            ppRequired: 8);

        await _abilitySlotService.RegisterAbilityAsync(
            characterId,
            "shadow-clone",
            tier: 2,
            ppRequired: 8);

        await _abilitySlotService.RegisterAbilityAsync(
            characterId,
            "void-touched",
            tier: 2,
            ppRequired: 8);

        _logger.LogInformation(
            "Myrk-gengr Tier 2 abilities unlocked for character {CharacterId}",
            characterId);
    }
}
```

---

## 15. State Machine Diagrams

### 15.1 Cloak of Night Stance State Machine

```
┌─────────┐
│ Inactive│
└────┬────┘
     │ Activate Cloak of Night (1 AP)
     │ [Essence >= 5]
     ▼
┌─────────────────────────┐
│  Active in Shadow       │
│  (+3 Stealth, Silent)   │
├─────────────────────────┤
│ • End Turn Cost: -5     │
│ • Essence regen: +2     │
│ • Net: -3 essence/turn  │
└────┬────────────┬───────┘
     │            │
     │ End Stance │ Low Essence
     │            │ (< 5)
     │            ▼
     │        ┌─────────────────────────┐
     │        │ Forced End              │
     │        │ (Insufficient Essence)  │
     │        └────────┬────────────────┘
     │                 │
     │            Exit Active
     │                 │
     ▼                 ▼
┌──────────────────────────────┐
│ Inactive                     │
│ (Stance ended, resources used)
└──────────────────────────────┘

Optional: Transition to BrightLight
┌─────────────────────────┐
│  Active in Bright Light │
│  (-1 Stealth, Loud)     │
├─────────────────────────┤
│ • End Turn Cost: -5     │
│ • Corruption: +1/turn   │
│ • Essence regen: 0      │
│ • Net: -5 ess, +1 corr  │
└────┬────────────┬───────┘
     │            │
     │ Enter Shadow
     │            │ Low Essence
     │            │
     └─►[Active] └─►[Forced End]
```

### 15.2 Shadow Step Targeting Flow

```
┌─────────────────────────────┐
│ Shadow Step Command Issued  │
│ (ability shadow-step <pos>) │
└────────┬────────────────────┘
         │
         ▼
┌──────────────────────────────┐
│ Validate Prerequisites       │
├──────────────────────────────┤
│ 1. Character exists?         │
│ 2. Is Myrk-gengr?            │
│ 3. Has ShadowEssence >= 10?  │
└────┬─────────────────────────┘
     │
  ┌──┴──┐
  │     │
  NO   YES
  │     │
  │     ▼
  │  ┌──────────────────────────┐
  │  │ Validate Target Position │
  │  ├──────────────────────────┤
  │  │ 1. Within 6 spaces?      │
  │  │ 2. In shadow?            │
  │  │ 3. Unoccupied?           │
  │  │ 4. Not in solid object?  │
  │  └────┬───────────────────────┘
  │       │
  │    ┌──┴──┐
  │    │     │
  │    NO   YES
  │    │     │
  │    │     ▼
  │    │  ┌──────────────────────────┐
  │    │  │ Execute Teleportation    │
  │    │  ├──────────────────────────┤
  │    │  │ 1. Spend 10 Essence      │
  │    │  │ 2. Move to target        │
  │    │  │ 3. Check arrival light   │
  │    │  │ 4. Generate bonus if dark│
  │    │  │ 5. Evaluate corruption   │
  │    │  └────┬────────────────────┘
  │    │       │
  │    │       ▼
  │    │  ┌──────────────────┐
  │    │  │ Success          │
  │    │  │ Movement complete│
  │    │  └──────────────────┘
  │    │
  │    ▼
  │  ┌──────────────────┐
  │  │ Fail             │
  │  │ Show error msg   │
  │  └──────────────────┘
  │
  ▼
┌──────────────────────┐
│ Failure              │
│ Return error message │
└──────────────────────┘
```

---

## 16. Corruption Integration Patterns

### 16.1 Heretical Path Pattern Establishment

**Pattern for v0.20.4a (to be reused in v0.20.5+ for other Heretical specializations):**

```csharp
/// Base interface for Heretical path services
public interface IHeriticalPathService
{
    /// Evaluates risk for heretical ability
    HeriticalRiskResult EvaluateHereiticalRisk(
        SpecializedAbilityId ability,
        LightLevelType? environmentalContext = null,
        TargetAlignment? targetAlignment = null);

    /// Applies corruption to character
    void ApplyHereiticalCorruption(Guid characterId, int corruptionAmount);

    /// Gets all possible corruption triggers
    IReadOnlyList<CorruptionTrigger> GetCorruptionTriggers(
        SpecializedAbilityId ability);
}

/// Myrk-gengr specific implementation (v0.20.4a)
public class ShadowCorruptionService : IHeriticalPathService
{
    // Shadow-specific corruption logic
}

/// Future: Berserkr specific implementation (v0.20.5)
public class BerserkrCorruptionService : IHeriticalPathService
{
    // Rage-specific corruption logic
}
```

### 16.2 Corruption Check Integration Points

**Where corruption is evaluated during ability execution:**

```
SHADOW STEP EXECUTION:
1. Pre-execution validation
2. [NEW] Evaluate corruption risk based on ORIGIN light level
3. Execute teleportation
4. Post-execution: If risk triggered, apply corruption

CLOAK OF NIGHT MAINTENANCE:
1. At end of each turn
2. [NEW] Check current light level
3. If bright light: Evaluate corruption
4. Apply corruption if triggered
5. Deduct essence cost

DARK-ADAPTED PASSIVE:
1. Passive ability - no corruption possible
2. Only generates essence, never causes corruption
```

---

## 17. Logging Specifications

### 17.1 Log Levels & Categories

**Shadow Essence Logging:**

```
[INFO] Shadow Essence spent: 10 (shadow-step), remaining 40/50
[INFO] Shadow Essence generated: +5 (shadow-step-arrival), total 45/50
[WARN] Insufficient shadow essence for shadow-step: need 10, have 7
[INFO] Shadow Essence restored to max during long rest: 50/50
```

**Ability Execution Logging:**

```
[INFO] Shadow Step executed: teleported to (15, 20)
[INFO] Cloak of Night activated for character {id}
[WARN] Cloak of Night ended: insufficient Shadow Essence
[INFO] Dark-Adapted passive applied: no dim light penalties
```

**Corruption Logging:**

```
[WARN] Corruption applied: +1 to {character} (Using shadow-step in bright light)
[WARN] Corruption applied: +1 to {character} (Maintaining cloak-of-night in bright light)
[INFO] Corruption risk evaluated: 0 corruption (shadow-step in darkness)
```

### 17.2 Diagnostic Logging

**Enable diagnostic logging for troubleshooting:**

```
[DEBUG] Light level evaluation: position (10, 15) = Darkness (intensity 0)
[DEBUG] Shadow position validation: (20, 25) = Valid shadow target (DimLight)
[DEBUG] Essence calculation: base 5 + dark-adapted 2 = 7 total
[DEBUG] Corruption risk table lookup: shadow-step + bright-light = 1 corruption
```

---

## 18. Unit Testing Requirements

### 18.1 ShadowEssenceResourceTests (~4 tests)

```csharp
[TestFixture]
public class ShadowEssenceResourceTests
{
    private ShadowEssenceResource _resource;

    [SetUp]
    public void Setup()
    {
        _resource = new ShadowEssenceResource();
    }

    [Test]
    public void Constructor_InitializesWithMaxEssence()
    {
        Assert.That(_resource.CurrentEssence, Is.EqualTo(50));
        Assert.That(_resource.MaxEssence, Is.EqualTo(50));
    }

    [Test]
    public void Spend_SufficientEssence_ReturnsTrueAndDeducts()
    {
        bool result = _resource.Spend(10);
        Assert.That(result, Is.True);
        Assert.That(_resource.CurrentEssence, Is.EqualTo(40));
    }

    [Test]
    public void Spend_InsufficientEssence_ReturnsFalse()
    {
        _resource = _resource with { CurrentEssence = 5 };
        bool result = _resource.Spend(10);
        Assert.That(result, Is.False);
        Assert.That(_resource.CurrentEssence, Is.EqualTo(5));
    }

    [Test]
    public void GenerateFromDarkness_InDarkness_Generates5()
    {
        _resource = _resource with { CurrentEssence = 20 };
        _resource.GenerateFromDarkness(LightLevelType.Darkness);
        Assert.That(_resource.CurrentEssence, Is.EqualTo(25));
    }

    [Test]
    public void GenerateFromDarkness_InBrightLight_GeneratesNothing()
    {
        _resource = _resource with { CurrentEssence = 20 };
        _resource.GenerateFromDarkness(LightLevelType.BrightLight);
        Assert.That(_resource.CurrentEssence, Is.EqualTo(20));
    }

    [Test]
    public void IsInDarkness_WithDarknessLevel_ReturnsTrue()
    {
        Assert.That(_resource.IsInDarkness(LightLevelType.Darkness), Is.True);
        Assert.That(_resource.IsInDarkness(LightLevelType.DimLight), Is.True);
    }

    [Test]
    public void IsInDarkness_WithBrightLight_ReturnsFalse()
    {
        Assert.That(_resource.IsInDarkness(LightLevelType.BrightLight), Is.False);
    }
}
```

### 18.2 MyrkgengrAbilityServiceTests (~4 tests)

```csharp
[TestFixture]
public class MyrkgengrAbilityServiceTests
{
    private MyrkgengrAbilityService _service;
    private Mock<IShadowEssenceService> _essenceServiceMock;
    private Mock<ILightLevelService> _lightLevelServiceMock;
    private Mock<IShadowCorruptionService> _corruptionServiceMock;

    [SetUp]
    public void Setup()
    {
        _essenceServiceMock = new Mock<IShadowEssenceService>();
        _lightLevelServiceMock = new Mock<ILightLevelService>();
        _corruptionServiceMock = new Mock<IShadowCorruptionService>();

        _service = new MyrkgengrAbilityService(
            _essenceServiceMock.Object,
            _lightLevelServiceMock.Object,
            _corruptionServiceMock.Object);
    }

    [Test]
    public async Task ShadowStep_ValidTarget_Teleports()
    {
        // Arrange
        var characterId = Guid.NewGuid();
        var character = CreateCharacter(characterId, x: 10, y: 10);

        _essenceServiceMock.Setup(x => x.TrySpendEssenceAsync(characterId, 10, It.IsAny<string>()))
            .ReturnsAsync(true);

        _lightLevelServiceMock.Setup(x => x.GetLightLevelAsync(20, 15, It.IsAny<string>()))
            .ReturnsAsync(new LightLevel { CurrentLevel = LightLevelType.Darkness });

        // Act
        var result = await _service.ExecuteShadowStepAsync(characterId, 20, 15);

        // Assert
        Assert.That(result.IsSuccess, Is.True);
        Assert.That(result.Message, Contains.Substring("dissolve into shadow"));
    }

    [Test]
    public async Task ShadowStep_InsufficientEssence_Fails()
    {
        // Arrange
        var characterId = Guid.NewGuid();

        _essenceServiceMock.Setup(x => x.TrySpendEssenceAsync(characterId, 10, It.IsAny<string>()))
            .ReturnsAsync(false);

        // Act
        var result = await _service.ExecuteShadowStepAsync(characterId, 20, 15);

        // Assert
        Assert.That(result.IsSuccess, Is.False);
        Assert.That(result.Message, Contains.Substring("Insufficient Shadow Essence"));
    }

    [Test]
    public async Task CloakOfNight_Activate_EntersStance()
    {
        // Arrange
        var characterId = Guid.NewGuid();

        // Act
        var result = await _service.ActivateCloakOfNightAsync(characterId);

        // Assert
        Assert.That(result.IsSuccess, Is.True);
    }

    [Test]
    public async Task DarkAdapted_PassiveAbility_NeverTriggersCorruption()
    {
        // Arrange - Dark-Adapted is passive, no execution needed

        // Act - Verify corruption table shows 0 for all light levels
        var corruptionRisks = _corruptionServiceMock
            .Object
            .GetCorruptionTriggers(MyrkgengrAbilityId.DarkAdapted);

        // Assert
        Assert.That(corruptionRisks, Is.Empty);
    }
}
```

### 18.3 ShadowCorruptionServiceTests (~2 tests)

```csharp
[TestFixture]
public class ShadowCorruptionServiceTests
{
    private ShadowCorruptionService _service;

    [SetUp]
    public void Setup()
    {
        _service = new ShadowCorruptionService();
    }

    [Test]
    public void EvaluateRisk_ShadowStepInBrightLight_Returns1Corruption()
    {
        var result = _service.EvaluateRisk(
            MyrkgengrAbilityId.ShadowStep,
            LightLevelType.BrightLight);

        Assert.That(result.RiskTriggered, Is.True);
        Assert.That(result.CorruptionGained, Is.EqualTo(1));
    }

    [Test]
    public void EvaluateRisk_CloakOfNightInDarkness_Returns0Corruption()
    {
        var result = _service.EvaluateRisk(
            MyrkgengrAbilityId.CloakOfNight,
            LightLevelType.Darkness);

        Assert.That(result.RiskTriggered, Is.False);
        Assert.That(result.CorruptionGained, Is.EqualTo(0));
    }
}
```

---

## 19. Deliverable Checklist

### Domain Layer

- [ ] `ShadowEssenceResource` value object implementation
- [ ] `ShadowPosition` value object implementation
- [ ] `LightLevel` value object implementation
- [ ] `CorruptionRiskResult` value object implementation
- [ ] `MyrkgengrAbilityId` enum (9 abilities)
- [ ] `LightLevelType` enum (5 light levels)
- [ ] `ShadowAbilityType` enum (6 ability types)
- [ ] `StanceType` enum (includes CloakOfNight)

### Application Layer

- [ ] `IShadowEssenceService` interface
- [ ] `ShadowEssenceService` implementation
- [ ] `ILightLevelService` interface (may exist)
- [ ] `IMyrkgengrAbilityService` interface
- [ ] `MyrkgengrAbilityService` implementation
- [ ] `IShadowCorruptionService` interface
- [ ] `ShadowCorruptionService` implementation
- [ ] `IHeriticalPathService` base interface (for future reuse)

### Infrastructure Layer

- [ ] Character aggregate modifications for ShadowEssence
- [ ] `specializations.json` Myrk-gengr entry
- [ ] `abilities.json` Tier 1 abilities (3 entries)
- [ ] Light level configuration (if needed)
- [ ] Corruption integration with v0.18.x service

### Tests

- [ ] `ShadowEssenceResourceTests` (~4 tests)
- [ ] `MyrkgengrAbilityServiceTests` (~4 tests)
- [ ] `ShadowCorruptionServiceTests` (~2 tests)
- [ ] Total: ~10 tests

### Documentation

- [ ] v0.20.4a Design Specification (this file)
- [ ] API documentation for services
- [ ] Integration guide for Corruption Service

---

## 20. Acceptance Criteria

### Functional Acceptance Criteria

- [ ] Myrk-gengr specialization is selectable at character creation
- [ ] Shadow Essence initializes to 50/50 on specialization selection
- [ ] Shadow Essence bar displays correctly in character sheet (XX/50)
- [ ] Shadow Step teleports character to valid shadow destinations (6 space range)
- [ ] Shadow Step costs 10 Shadow Essence and blocks execution if insufficient
- [ ] Shadow Step generates +5 Shadow Essence on arrival in Darkness
- [ ] Shadow Step triggers +1 Corruption when used from bright light
- [ ] Cloak of Night grants +3 Stealth bonus while in shadow
- [ ] Cloak of Night grants silent movement in shadow (no detection by sound)
- [ ] Cloak of Night costs 5 Shadow Essence per turn to maintain
- [ ] Cloak of Night automatically ends when Shadow Essence < 5
- [ ] Cloak of Night triggers +1 Corruption per turn if maintained in bright light
- [ ] Dark-Adapted removes all dim light penalties (Perception, Attack, Skills, Movement)
- [ ] Dark-Adapted generates +2 Shadow Essence passively per turn in Darkness
- [ ] Dark-Adapted applies automatically (no action required)
- [ ] Corruption system integrates with Myrk-gengr abilities
- [ ] Light level detection accurately classifies locations

### Performance Acceptance Criteria

- [ ] Ability execution completes < 200ms
- [ ] Light level evaluation completes < 50ms
- [ ] Corruption check completes < 50ms
- [ ] Resource spending/generation completes < 50ms
- [ ] UI updates with Shadow Essence display < 100ms

### Test Coverage Acceptance Criteria

- [ ] Minimum 10 unit tests pass
- [ ] 90%+ code coverage for service implementations
- [ ] All critical paths tested (success and failure cases)
- [ ] Edge cases tested (low essence, light level transitions, etc.)

---

## 21. Dependencies & Prerequisites

### Hard Dependencies (Must be complete)

```
v0.17.3 (Archetype System) - REQUIRED
    └─> Skirmisher archetype foundation

v0.17.4 (Specialization Framework) - REQUIRED
    ├─> SpecializationDefinition entity
    ├─> SpecializationPathType enum (includes Heretical)
    ├─> SpecializationId enum (includes Myrkgengr)
    ├─> SpecialResourceDefinition
    └─> Tier unlock mechanics (0/8/16/24 PP)

v0.18.x (Corruption System) - REQUIRED
    ├─> ICorruptionService
    ├─> Corruption entity and tracking
    ├─> Corruption thresholds
    └─> Character.Corruption property

v0.20.0 (Legacy Class Removal) - REQUIRED
    ├─> IAbilitySlotService
    ├─> ISpecializationPrerequisiteService
    └─> Character aggregate patterns

v0.20.1-v0.20.3 (Prior Specializations) - REQUIRED
    └─> Establish specialization ability patterns
```

### Soft Dependencies (Should be complete)

```
Lighting System - Recommended
    ├─> Light level detection
    └─> Position-based light evaluation

Stealth System - Recommended
    ├─> Stealth check mechanics
    └─> Detection by enemies

Combat System - Recommended
    ├─> Ability execution framework
    └─> AP consumption

Movement System - Recommended
    ├─> Teleportation support
    └─> Position validation
```

---

## 22. Design Decisions & Rationale

### Decision: 50-Point Shadow Essence Pool

**Rationale:**
- Tier 1 abilities cost 10 (Step) and 5/turn (Cloak)
- Allows ~5 Shadow Steps or 10 turns of Cloak maintenance
- Tier 2 abilities cost more (15, 20), creating resource management
- Capstone costs 40, almost entire pool
- Balances power vs. resource scarcity
- Comparable to similar specialization resources in v0.20.x

### Decision: No Regeneration Outside Darkness

**Rationale:**
- Encourages tactical use of darkness/shadows
- Incentivizes map awareness and environment use
- Prevents spam-casting abilities in open light
- Fits thematic "shadow walker" identity
- Balances Heretical path power

### Decision: Corruption on Bright Light Usage (Not Just Generation)

**Rationale:**
- First Heretical path needs clear consequence system
- Punishes risky playstyle (using shadow magic in light)
- Establishes pattern for v0.20.5 Berserkr (rage in inappropriate situations)
- Encourages roleplay alignment with specialization

### Decision: Tier 1 Abilities Immediately Available

**Rationale:**
- Shadow Step (mobility) is core to Skirmisher archetype
- Cloak of Night (stealth) is stealth foundation
- Dark-Adapted (passive) is free and thematic
- No PP cost needed for identity abilities
- Tier 2+ locked behind 8 PP investment

### Decision: Passive Generation in Darkness Only

**Rationale:**
- Simple rule: if dark = generation ticks
- Encourages resting in safe shadow locations
- Prevents perma-passive charging in bright zones
- Fits theme of shadow-drawn power
- Easy for players to understand

---

## Conclusion

**v0.20.4a** establishes the Myrk-gengr specialization framework as the **first Heretical path** in the Aethelgard system. By implementing Shadow Essence resource management, light level dependency mechanics, and Corruption risk integration, this phase creates the foundational pattern for future Heretical specializations (v0.20.5 Berserkr, v0.20.8 Seiðkona).

The three Tier 1 abilities define the core identity: **mobility through Shadow Step, concealment through Cloak of Night, and adaptation through Dark-Adapted passive**. Together with robust Corruption integration, these abilities create a complete, thematic, and mechanically distinct specialization option for Skirmisher players.

**Next phases:**
- **v0.20.4b:** Tier 2 abilities (Umbral Strike, Shadow Clone, Void Touched)
- **v0.20.4c:** Tier 3 & Capstone (Merge with Darkness, Shadow Snare, Eclipse)
- **v0.20.5:** Berserkr specialization (second Heretical path, using established patterns)

---

_End of v0.20.4a Design Specification_
