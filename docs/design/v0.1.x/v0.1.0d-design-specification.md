# v0.1.0d Design Specification: Map Command & Polish

**Version:** 0.1.0d
**Phase Name:** Map Command & Polish
**Parent Version:** v0.1.0 (Expanded Dungeon & Z-Axis)
**Prerequisites:** v0.1.0c Complete (Room Types & Hidden Passages)
**Estimated Tests:** ~20 unit tests

---

## Table of Contents

1. [Executive Summary](#1-executive-summary)
2. [Feature Overview](#2-feature-overview)
3. [Architecture Diagrams](#3-architecture-diagrams)
4. [ExplorationState Enum](#4-explorationstate-enum)
5. [Room Exploration Tracking](#5-room-exploration-tracking)
6. [MapRendererService](#6-maprendererservice)
7. [Map Command](#7-map-command)
8. [ASCII Map Symbols](#8-ascii-map-symbols)
9. [Multi-Level Map Display](#9-multi-level-map-display)
10. [Data Model Changes](#10-data-model-changes)
11. [Configuration File Schemas](#11-configuration-file-schemas)
12. [Logging Specifications](#12-logging-specifications)
13. [Unit Testing Requirements](#13-unit-testing-requirements)
14. [Use Cases](#14-use-cases)
15. [Deliverable Checklist](#15-deliverable-checklist)
16. [Acceptance Criteria](#16-acceptance-criteria)
17. [Dependencies](#17-dependencies)
18. [Future Considerations](#18-future-considerations)

---

## 1. Executive Summary

### 1.1 Purpose

Implement ASCII map visualization showing explored rooms and add comprehensive exploration state tracking. This final phase of v0.1.0 integrates all prior phases (Z-axis, procedural generation, room types, hidden passages) into a polished multi-level dungeon experience with a visual map command.

### 1.2 Current State

| Area | Current State (v0.1.0c) | Target State (v0.1.0d) |
|------|-------------------------|------------------------|
| Exploration tracking | Boolean visited flag | Three-state exploration (Unexplored, Visited, Cleared) |
| Map visualization | None | ASCII map with room symbols and connections |
| Level awareness | Implicit Z coordinate | Explicit level indicator in display |
| Room state display | No visual indicators | Symbols based on type and state |
| Multi-level view | Not possible | `map all` shows all explored levels |

### 1.3 Key Deliverables

| Category | Items |
|----------|-------|
| **Enums** | `ExplorationState` (3 values) |
| **Services** | `IMapRendererService`, `MapRendererService` |
| **Commands** | `map` command with options |
| **Entity Updates** | `Room` exploration state tracking |
| **IGameRenderer** | `RenderMapAsync()` method |
| **Tests** | ~20 new unit tests |

### 1.4 Architectural Significance

This version completes the **v0.1.0 vertical dungeon system** by:
- Providing visual feedback for dungeon exploration
- Establishing map rendering patterns for future enhancements
- Integrating all v0.1.0 features into a cohesive experience
- Creating foundation for future minimap and graphical map features

---

## 2. Feature Overview

```
v0.1.0d Map Command & Polish
├── ExplorationState Enum
│   ├── Unexplored (known but not visited)
│   ├── Visited (player has entered)
│   └── Cleared (searched, monsters defeated)
├── Room Exploration Tracking
│   ├── ExplorationState property on Room
│   ├── MarkVisited() method
│   ├── MarkCleared() method
│   └── Integration with existing VisitedRooms
├── MapRendererService
│   ├── IMapRendererService interface
│   ├── RenderLevel() for single level
│   ├── RenderAllLevels() for full map
│   ├── GetRoomSymbol() for room display
│   └── GetLegend() for symbol explanation
├── Map Command
│   ├── `map` shows current level
│   ├── `map all` shows all explored levels
│   └── Integration with GameSessionService
├── ASCII Map Symbols
│   ├── @ Player position
│   ├── # Standard room
│   ├── $ Treasure room
│   ├── ! Trap room
│   ├── B Boss room
│   ├── + Safe room
│   ├── * Shrine
│   ├── ? Unexplored adjacent
│   ├── ─│ Connections
│   └── ↑↓≡ Vertical indicators
├── Multi-Level Display
│   ├── Level headers with Z coordinate
│   ├── Stacked level rendering
│   └── Current position summary
└── Integration Polish
    ├── Cleared room detection
    ├── Statistics display
    └── Legend rendering
```

---

## 3. Architecture Diagrams

### 3.1 Layer Diagram

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           PRESENTATION LAYER                                 │
├─────────────────────────────────────────────────────────────────────────────┤
│  CommandParser                        IGameRenderer                          │
│  ├── Parse("map")                     ├── RenderMapAsync()                  │
│  │   └── MapCommand                   │   └── Display ASCII map             │
│  └── Parse("map all")                 └── RenderMessageAsync()              │
│      └── MapAllCommand                    └── Map statistics                │
└─────────────────────────────────────────────────────────────────────────────┘
                                      │
                                      ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                           APPLICATION LAYER                                  │
├─────────────────────────────────────────────────────────────────────────────┤
│  GameSessionService                   MapRendererService                     │
│  ├── HandleMapCommand()               ├── RenderLevel()                     │
│  │   └── Call MapRendererService      │   └── ASCII grid generation         │
│  ├── MarkRoomCleared()                ├── RenderAllLevels()                 │
│  │   └── Update exploration state     │   └── Multi-level rendering         │
│  └── GetExplorationStats()            ├── GetRoomSymbol()                   │
│      └── Room counts by state         │   └── Type + state → char           │
│                                       └── GetLegend()                        │
│  DTOs:                                    └── Symbol explanations            │
│  └── MapDto, MapLevelDto, MapStatisticsDto                                  │
└─────────────────────────────────────────────────────────────────────────────┘
                                      │
                                      ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                             DOMAIN LAYER                                     │
├─────────────────────────────────────────────────────────────────────────────┤
│  Entities:                      Value Objects:           Enums:             │
│  ┌─────────────────────┐       ┌─────────────────────┐  ┌─────────────────┐ │
│  │ Room                │       │ Position3D          │  │ ExplorationState│ │
│  │ ├── ExplorationState│       │ Exit                │  │ ├── Unexplored  │ │
│  │ ├── MarkVisited()   │       └─────────────────────┘  │ ├── Visited     │ │
│  │ └── MarkCleared()   │                                │ └── Cleared     │ │
│  └─────────────────────┘                                └─────────────────┘ │
│  ┌─────────────────────┐                                                    │
│  │ Dungeon             │                                                    │
│  │ ├── GetRoomsOnLevel │                                                    │
│  │ └── GetExploredLevels│                                                   │
│  └─────────────────────┘                                                    │
│  ┌─────────────────────┐                                                    │
│  │ GameSession         │                                                    │
│  │ ├── ExplorationStats│                                                    │
│  │ └── ClearedRooms    │                                                    │
│  └─────────────────────┘                                                    │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 3.2 Map Command Flow

```
┌───────────────────┐
│ Player Input      │
│ "map" or "map all"│
└─────────┬─────────┘
          │
          ▼
┌───────────────────────────────────────┐
│ CommandParser                         │
│ ├── "map" → MapCommand(showAll=false) │
│ └── "map all" → MapCommand(showAll=true)│
└───────────────┬───────────────────────┘
                │
                ▼
┌───────────────────────────────────────────────────┐
│ GameSessionService.HandleMapCommand(showAll)      │
├───────────────────────────────────────────────────┤
│ 1. Get current dungeon and player position        │
│ 2. Get explored levels from dungeon               │
│ 3. If showAll: call RenderAllLevels()             │
│    Else: call RenderLevel() for current Z         │
│ 4. Get exploration statistics                     │
│ 5. Return MapDto with map string and stats        │
└───────────────┬───────────────────────────────────┘
                │
                ▼
┌───────────────────────────────────────────────────┐
│ MapRendererService.RenderLevel(dungeon, z, pos)   │
├───────────────────────────────────────────────────┤
│ 1. Get all rooms on this Z level                  │
│ 2. Calculate grid bounds (minX, maxX, minY, maxY) │
│ 3. Create 2D character grid                       │
│ 4. For each room:                                 │
│    a. Get position in grid                        │
│    b. Get symbol (type + state + player here?)    │
│    c. Place symbol in grid                        │
│    d. Draw connections to adjacent rooms          │
│ 5. Build string from grid                         │
│ 6. Add level header and legend                    │
│ 7. Return formatted map string                    │
└───────────────┬───────────────────────────────────┘
                │
                ▼
┌───────────────────────────────────────────────────┐
│ IGameRenderer.RenderMapAsync(mapDto)              │
├───────────────────────────────────────────────────┤
│ Display:                                          │
│ ┌─────────────────────────────────────────────┐   │
│ │ === The Forgotten Depths - Level 1 (Z=0) ===│   │
│ │                                             │   │
│ │         ?                                   │   │
│ │         │                                   │   │
│ │     ?───#───$                               │   │
│ │         │                                   │   │
│ │     +───@───#───?                           │   │
│ │         │                                   │   │
│ │         #                                   │   │
│ │         ↓                                   │   │
│ │                                             │   │
│ │ Legend: @ You  # Room  $ Treasure  + Safe   │   │
│ │         ↑↓ Stairs  ─│ Passages              │   │
│ │                                             │   │
│ │ Rooms explored: 5/12 on this level          │   │
│ └─────────────────────────────────────────────┘   │
└───────────────────────────────────────────────────┘
```

### 3.3 Room Symbol Selection Flow

```
┌─────────────────────────────────────────────────────────────────────┐
│ MapRendererService.GetRoomSymbol(room, isPlayerHere)                │
├─────────────────────────────────────────────────────────────────────┤
│                                                                      │
│  Is Player Here?                                                     │
│  ├── Yes → Return '@'                                               │
│  └── No → Check ExplorationState                                    │
│                                                                      │
│  ExplorationState?                                                   │
│  ├── Unexplored → Return '?'                                        │
│  ├── Visited/Cleared → Check RoomType                               │
│  │                                                                   │
│  │   RoomType?                                                       │
│  │   ├── Standard → '#'                                              │
│  │   ├── Treasure → '$'                                              │
│  │   ├── Trap → '!'                                                  │
│  │   ├── Boss → 'B'                                                  │
│  │   ├── Safe → '+'                                                  │
│  │   └── Shrine → '*'                                                │
│  │                                                                   │
│  └── Return selected symbol                                          │
│                                                                      │
└─────────────────────────────────────────────────────────────────────┘
```

---

## 4. ExplorationState Enum

### 4.1 Purpose

Track the exploration progress of each room with three distinct states for map visualization and gameplay mechanics.

### 4.2 Implementation

**File:** `src/Core/RuneAndRust.Domain/Enums/ExplorationState.cs`

```csharp
namespace RuneAndRust.Domain.Enums;

/// <summary>
/// Tracks the exploration state of a room.
/// </summary>
/// <remarks>
/// Exploration state affects map display, gameplay mechanics,
/// and is tracked per-room rather than per-session for persistence.
/// </remarks>
public enum ExplorationState
{
    /// <summary>
    /// Room exists and is known (e.g., visible exit) but player has not entered.
    /// </summary>
    /// <remarks>
    /// Shown as '?' on the map. The room's existence is known but contents are unknown.
    /// </remarks>
    Unexplored = 0,

    /// <summary>
    /// Player has entered the room at least once.
    /// </summary>
    /// <remarks>
    /// Shown with the room type symbol on the map. Basic room info is known.
    /// </remarks>
    Visited = 1,

    /// <summary>
    /// Room is fully explored: searched for hidden content, all monsters defeated.
    /// </summary>
    /// <remarks>
    /// May display differently (e.g., dimmed) to indicate no further action needed.
    /// Used for exploration progress tracking and achievements.
    /// </remarks>
    Cleared = 2
}
```

### 4.3 State Transitions

```
Unexplored ──[Player enters]──► Visited ──[Searched + monsters cleared]──► Cleared
     │                              │
     │                              └──[Search only, monsters remain]──► Visited
     │
     └──[Room generated adjacent but not entered]──► Unexplored
```

---

## 5. Room Exploration Tracking

### 5.1 Room Entity Updates

**File:** `src/Core/RuneAndRust.Domain/Entities/Room.cs` (additions)

```csharp
/// <summary>
/// Gets the current exploration state of this room.
/// </summary>
/// <remarks>
/// Exploration state tracks player progress through the dungeon
/// and affects how the room appears on the map.
/// </remarks>
public ExplorationState ExplorationState { get; private set; } = ExplorationState.Unexplored;

/// <summary>
/// Gets whether this room has been visited by the player.
/// </summary>
public bool IsVisited => ExplorationState >= ExplorationState.Visited;

/// <summary>
/// Gets whether this room has been fully cleared.
/// </summary>
public bool IsCleared => ExplorationState == ExplorationState.Cleared;

/// <summary>
/// Gets whether this room can be marked as cleared.
/// </summary>
/// <remarks>
/// A room can be cleared when:
/// - It has been visited
/// - No living monsters remain
/// - All hidden content has been discovered (or none exists)
/// </remarks>
public bool CanBeCleared =>
    IsVisited &&
    !HasMonsters &&
    GetHiddenExits().Count == 0 &&
    GetUndiscoveredHiddenItems().Count == 0;

/// <summary>
/// Marks this room as visited by the player.
/// </summary>
/// <returns>True if state changed; false if already visited or cleared.</returns>
public bool MarkVisited()
{
    if (ExplorationState >= ExplorationState.Visited)
        return false;

    ExplorationState = ExplorationState.Visited;
    return true;
}

/// <summary>
/// Marks this room as fully cleared.
/// </summary>
/// <returns>True if state changed; false if already cleared or cannot be cleared.</returns>
public bool MarkCleared()
{
    if (ExplorationState == ExplorationState.Cleared)
        return false;

    if (!CanBeCleared)
        return false;

    ExplorationState = ExplorationState.Cleared;
    return true;
}

/// <summary>
/// Checks if clearing conditions are met and auto-clears if possible.
/// </summary>
/// <returns>True if the room was auto-cleared.</returns>
public bool TryAutoCleared()
{
    if (CanBeCleared && ExplorationState == ExplorationState.Visited)
    {
        ExplorationState = ExplorationState.Cleared;
        return true;
    }
    return false;
}
```

### 5.2 Dungeon Entity Updates

**File:** `src/Core/RuneAndRust.Domain/Entities/Dungeon.cs` (additions)

```csharp
/// <summary>
/// Gets all rooms on the specified Z level.
/// </summary>
/// <param name="z">The Z coordinate (depth level).</param>
/// <returns>Collection of rooms on that level.</returns>
public IReadOnlyList<Room> GetRoomsOnLevel(int z)
{
    return _rooms.Values
        .Where(r => r.Position.Z == z)
        .ToList()
        .AsReadOnly();
}

/// <summary>
/// Gets all Z levels that have at least one visited room.
/// </summary>
/// <returns>Sorted collection of explored Z levels.</returns>
public IReadOnlyList<int> GetExploredLevels()
{
    return _rooms.Values
        .Where(r => r.IsVisited)
        .Select(r => r.Position.Z)
        .Distinct()
        .OrderBy(z => z)
        .ToList()
        .AsReadOnly();
}

/// <summary>
/// Gets the count of rooms by exploration state on a specific level.
/// </summary>
/// <param name="z">The Z coordinate.</param>
/// <returns>Dictionary of state to count.</returns>
public IReadOnlyDictionary<ExplorationState, int> GetExplorationStatsForLevel(int z)
{
    return _rooms.Values
        .Where(r => r.Position.Z == z)
        .GroupBy(r => r.ExplorationState)
        .ToDictionary(g => g.Key, g => g.Count())
        .AsReadOnly();
}

/// <summary>
/// Gets the grid bounds for rooms on a specific level.
/// </summary>
/// <param name="z">The Z coordinate.</param>
/// <returns>Tuple of (minX, maxX, minY, maxY).</returns>
public (int minX, int maxX, int minY, int maxY) GetLevelBounds(int z)
{
    var rooms = GetRoomsOnLevel(z);
    if (rooms.Count == 0)
        return (0, 0, 0, 0);

    var minX = rooms.Min(r => r.Position.X);
    var maxX = rooms.Max(r => r.Position.X);
    var minY = rooms.Min(r => r.Position.Y);
    var maxY = rooms.Max(r => r.Position.Y);

    return (minX, maxX, minY, maxY);
}
```

### 5.3 GameSession Updates

**File:** `src/Core/RuneAndRust.Domain/Entities/GameSession.cs` (additions)

```csharp
/// <summary>
/// Set of room IDs that have been cleared by the player.
/// </summary>
private readonly HashSet<Guid> _clearedRooms = [];

/// <summary>
/// Gets a read-only set of cleared room IDs.
/// </summary>
public IReadOnlySet<Guid> ClearedRooms => _clearedRooms;

/// <summary>
/// Marks a room as cleared.
/// </summary>
/// <param name="roomId">The ID of the room to mark as cleared.</param>
/// <returns>True if successfully marked; false if already cleared or cannot be cleared.</returns>
public bool MarkRoomCleared(Guid roomId)
{
    var room = Dungeon.GetRoom(roomId);
    if (room == null) return false;

    if (room.MarkCleared())
    {
        _clearedRooms.Add(roomId);
        return true;
    }
    return false;
}

/// <summary>
/// Gets exploration statistics for the current dungeon.
/// </summary>
/// <returns>Statistics about explored rooms.</returns>
public ExplorationStatistics GetExplorationStatistics()
{
    var allRooms = Dungeon.Rooms.Values;
    var visited = allRooms.Count(r => r.IsVisited);
    var cleared = allRooms.Count(r => r.IsCleared);
    var total = allRooms.Count;

    return new ExplorationStatistics(
        TotalRooms: total,
        VisitedRooms: visited,
        ClearedRooms: cleared,
        ExploredLevels: Dungeon.GetExploredLevels());
}
```

---

## 6. MapRendererService

### 6.1 Interface Definition

**File:** `src/Core/RuneAndRust.Application/Interfaces/IMapRendererService.cs`

```csharp
using RuneAndRust.Domain.Entities;
using RuneAndRust.Domain.ValueObjects;

namespace RuneAndRust.Application.Interfaces;

/// <summary>
/// Service for rendering ASCII dungeon maps.
/// </summary>
public interface IMapRendererService
{
    /// <summary>
    /// Renders an ASCII map for the specified dungeon level.
    /// </summary>
    /// <param name="dungeon">The dungeon to render.</param>
    /// <param name="z">The Z level to render.</param>
    /// <param name="playerPosition">The player's current position.</param>
    /// <returns>A formatted ASCII map string.</returns>
    string RenderLevel(Dungeon dungeon, int z, Position3D playerPosition);

    /// <summary>
    /// Renders ASCII maps for all explored levels.
    /// </summary>
    /// <param name="dungeon">The dungeon to render.</param>
    /// <param name="playerPosition">The player's current position.</param>
    /// <returns>A formatted ASCII map string with all levels.</returns>
    string RenderAllLevels(Dungeon dungeon, Position3D playerPosition);

    /// <summary>
    /// Gets the display symbol for a room based on type and state.
    /// </summary>
    /// <param name="room">The room to get a symbol for.</param>
    /// <param name="isPlayerHere">Whether the player is in this room.</param>
    /// <returns>The character symbol for the room.</returns>
    char GetRoomSymbol(Room room, bool isPlayerHere);

    /// <summary>
    /// Generates the legend text explaining map symbols.
    /// </summary>
    /// <returns>Formatted legend string.</returns>
    string GetLegend();

    /// <summary>
    /// Gets the connection character for exits between rooms.
    /// </summary>
    /// <param name="direction">The direction of the connection.</param>
    /// <param name="isHidden">Whether the exit is hidden.</param>
    /// <returns>The character for the connection.</returns>
    char GetConnectionSymbol(Direction direction, bool isHidden);
}
```

### 6.2 Service Implementation

**File:** `src/Core/RuneAndRust.Application/Services/MapRendererService.cs`

```csharp
using System.Text;
using Microsoft.Extensions.Logging;
using RuneAndRust.Application.Interfaces;
using RuneAndRust.Domain.Entities;
using RuneAndRust.Domain.Enums;
using RuneAndRust.Domain.ValueObjects;

namespace RuneAndRust.Application.Services;

/// <summary>
/// Service for rendering ASCII dungeon maps.
/// </summary>
public class MapRendererService : IMapRendererService
{
    private readonly ILogger<MapRendererService> _logger;

    /// <summary>
    /// Character used for the player position.
    /// </summary>
    public const char PlayerSymbol = '@';

    /// <summary>
    /// Character used for unexplored rooms.
    /// </summary>
    public const char UnexploredSymbol = '?';

    /// <summary>
    /// Horizontal connection character.
    /// </summary>
    public const char HorizontalConnection = '─';

    /// <summary>
    /// Vertical connection character.
    /// </summary>
    public const char VerticalConnection = '│';

    /// <summary>
    /// Stairs up indicator.
    /// </summary>
    public const char StairsUpSymbol = '↑';

    /// <summary>
    /// Stairs down indicator.
    /// </summary>
    public const char StairsDownSymbol = '↓';

    /// <summary>
    /// Ladder indicator.
    /// </summary>
    public const char LadderSymbol = '≡';

    /// <summary>
    /// Creates a new MapRendererService.
    /// </summary>
    public MapRendererService(ILogger<MapRendererService> logger)
    {
        _logger = logger ?? throw new ArgumentNullException(nameof(logger));
    }

    /// <inheritdoc />
    public string RenderLevel(Dungeon dungeon, int z, Position3D playerPosition)
    {
        ArgumentNullException.ThrowIfNull(dungeon);

        var rooms = dungeon.GetRoomsOnLevel(z);
        if (rooms.Count == 0)
        {
            return $"No rooms found on level {z}.";
        }

        var (minX, maxX, minY, maxY) = dungeon.GetLevelBounds(z);

        // Add padding for connections
        var gridWidth = (maxX - minX + 1) * 4 + 1;
        var gridHeight = (maxY - minY + 1) * 2 + 1;

        var grid = new char[gridHeight, gridWidth];

        // Initialize with spaces
        for (int y = 0; y < gridHeight; y++)
        {
            for (int x = 0; x < gridWidth; x++)
            {
                grid[y, x] = ' ';
            }
        }

        // Place rooms and connections
        foreach (var room in rooms)
        {
            var gridX = (room.Position.X - minX) * 4 + 2;
            var gridY = (maxY - room.Position.Y) * 2 + 1; // Invert Y for display

            var isPlayerHere = room.Position.Equals(playerPosition);
            grid[gridY, gridX] = GetRoomSymbol(room, isPlayerHere);

            // Draw connections
            DrawConnections(grid, room, gridX, gridY, minX, maxX, minY, maxY);
        }

        // Build output
        var sb = new StringBuilder();
        sb.AppendLine($"=== {dungeon.Name} - Level {z + 1} (Z={z}) ===");
        sb.AppendLine();

        for (int y = 0; y < gridHeight; y++)
        {
            for (int x = 0; x < gridWidth; x++)
            {
                sb.Append(grid[y, x]);
            }
            sb.AppendLine();
        }

        sb.AppendLine();
        sb.AppendLine(GetLegend());

        // Add statistics
        var stats = dungeon.GetExplorationStatsForLevel(z);
        var visited = stats.GetValueOrDefault(ExplorationState.Visited, 0) +
                      stats.GetValueOrDefault(ExplorationState.Cleared, 0);
        var total = rooms.Count;
        sb.AppendLine();
        sb.AppendLine($"Rooms explored: {visited}/{total} on this level");

        _logger.LogDebug("Rendered map for level {Z} with {Rooms} rooms", z, rooms.Count);

        return sb.ToString();
    }

    /// <inheritdoc />
    public string RenderAllLevels(Dungeon dungeon, Position3D playerPosition)
    {
        ArgumentNullException.ThrowIfNull(dungeon);

        var levels = dungeon.GetExploredLevels();
        if (levels.Count == 0)
        {
            return "No explored levels to display.";
        }

        var sb = new StringBuilder();

        foreach (var z in levels)
        {
            if (sb.Length > 0)
            {
                sb.AppendLine();
            }

            sb.AppendLine(RenderLevel(dungeon, z, playerPosition));
        }

        // Summary
        sb.AppendLine("─".PadRight(40, '─'));
        sb.AppendLine($"Current position: Level {playerPosition.Z + 1}, ({playerPosition.X}, {playerPosition.Y})");

        var totalVisited = dungeon.Rooms.Values.Count(r => r.IsVisited);
        sb.AppendLine($"Total rooms explored: {totalVisited}");

        return sb.ToString();
    }

    /// <inheritdoc />
    public char GetRoomSymbol(Room room, bool isPlayerHere)
    {
        ArgumentNullException.ThrowIfNull(room);

        if (isPlayerHere)
            return PlayerSymbol;

        if (!room.IsVisited)
            return UnexploredSymbol;

        return room.RoomType switch
        {
            RoomType.Standard => '#',
            RoomType.Treasure => '$',
            RoomType.Trap => '!',
            RoomType.Boss => 'B',
            RoomType.Safe => '+',
            RoomType.Shrine => '*',
            _ => '#'
        };
    }

    /// <inheritdoc />
    public string GetLegend()
    {
        return "Legend: @ You  # Room  $ Treasure  ! Trap  B Boss  + Safe  * Shrine  ? Unexplored\n" +
               "        ↑↓ Stairs  ≡ Ladder  ─│ Passages";
    }

    /// <inheritdoc />
    public char GetConnectionSymbol(Direction direction, bool isHidden)
    {
        if (isHidden)
            return ' '; // Hidden connections not shown

        return direction switch
        {
            Direction.North or Direction.South => VerticalConnection,
            Direction.East or Direction.West => HorizontalConnection,
            Direction.Up => StairsUpSymbol,
            Direction.Down => StairsDownSymbol,
            _ => ' '
        };
    }

    private void DrawConnections(
        char[,] grid,
        Room room,
        int gridX,
        int gridY,
        int minX,
        int maxX,
        int minY,
        int maxY)
    {
        foreach (var (direction, exit) in room.GetVisibleExits())
        {
            // Only draw connections to visible exits
            if (!exit.IsVisible) continue;

            switch (direction)
            {
                case Direction.North:
                    if (gridY > 0)
                        grid[gridY - 1, gridX] = VerticalConnection;
                    break;

                case Direction.South:
                    if (gridY < grid.GetLength(0) - 1)
                        grid[gridY + 1, gridX] = VerticalConnection;
                    break;

                case Direction.East:
                    if (gridX < grid.GetLength(1) - 2)
                    {
                        grid[gridY, gridX + 1] = HorizontalConnection;
                        grid[gridY, gridX + 2] = HorizontalConnection;
                        grid[gridY, gridX + 3] = HorizontalConnection;
                    }
                    break;

                case Direction.West:
                    if (gridX >= 3)
                    {
                        grid[gridY, gridX - 1] = HorizontalConnection;
                        grid[gridY, gridX - 2] = HorizontalConnection;
                        grid[gridY, gridX - 3] = HorizontalConnection;
                    }
                    break;

                case Direction.Up:
                    // Mark room has stairs up
                    if (gridY > 0)
                        grid[gridY - 1, gridX] = StairsUpSymbol;
                    break;

                case Direction.Down:
                    // Mark room has stairs down
                    if (gridY < grid.GetLength(0) - 1)
                        grid[gridY + 1, gridX] = StairsDownSymbol;
                    break;
            }
        }
    }
}
```

---

## 7. Map Command

### 7.1 Command Handler

The `map` command is integrated into `GameSessionService`:

```csharp
/// <summary>
/// Handles the map command.
/// </summary>
/// <param name="showAllLevels">If true, shows all explored levels.</param>
/// <returns>The rendered map DTO.</returns>
public MapDto HandleMapCommand(bool showAllLevels = false)
{
    var player = _currentSession?.Player
        ?? throw new InvalidOperationException("No active session");

    var dungeon = _currentSession.Dungeon;
    var position = player.Position3D; // Assuming Position3D on Player

    string mapString;
    if (showAllLevels)
    {
        mapString = _mapRendererService.RenderAllLevels(dungeon, position);
    }
    else
    {
        mapString = _mapRendererService.RenderLevel(dungeon, position.Z, position);
    }

    var stats = _currentSession.GetExplorationStatistics();

    return new MapDto(
        MapDisplay: mapString,
        CurrentLevel: position.Z,
        TotalLevels: dungeon.GetExploredLevels().Count,
        Statistics: new MapStatisticsDto(
            TotalRooms: stats.TotalRooms,
            VisitedRooms: stats.VisitedRooms,
            ClearedRooms: stats.ClearedRooms));
}
```

### 7.2 MapDto

**File:** `src/Core/RuneAndRust.Application/DTOs/MapDtos.cs`

```csharp
namespace RuneAndRust.Application.DTOs;

/// <summary>
/// Data transfer object for map display.
/// </summary>
/// <param name="MapDisplay">The rendered ASCII map string.</param>
/// <param name="CurrentLevel">The player's current Z level.</param>
/// <param name="TotalLevels">Total number of explored levels.</param>
/// <param name="Statistics">Exploration statistics.</param>
public record MapDto(
    string MapDisplay,
    int CurrentLevel,
    int TotalLevels,
    MapStatisticsDto Statistics);

/// <summary>
/// Statistics about dungeon exploration.
/// </summary>
/// <param name="TotalRooms">Total rooms in dungeon.</param>
/// <param name="VisitedRooms">Number of visited rooms.</param>
/// <param name="ClearedRooms">Number of cleared rooms.</param>
public record MapStatisticsDto(
    int TotalRooms,
    int VisitedRooms,
    int ClearedRooms)
{
    /// <summary>
    /// Gets the exploration percentage.
    /// </summary>
    public float ExplorationPercent => TotalRooms > 0
        ? (float)VisitedRooms / TotalRooms * 100
        : 0;
}

/// <summary>
/// Single level map data.
/// </summary>
/// <param name="Level">The Z level.</param>
/// <param name="MapDisplay">ASCII map for this level.</param>
/// <param name="RoomCount">Total rooms on this level.</param>
/// <param name="VisitedCount">Visited rooms on this level.</param>
public record MapLevelDto(
    int Level,
    string MapDisplay,
    int RoomCount,
    int VisitedCount);
```

### 7.3 ExplorationStatistics

**File:** `src/Core/RuneAndRust.Domain/ValueObjects/ExplorationStatistics.cs`

```csharp
namespace RuneAndRust.Domain.ValueObjects;

/// <summary>
/// Statistics about dungeon exploration progress.
/// </summary>
/// <param name="TotalRooms">Total rooms discovered.</param>
/// <param name="VisitedRooms">Rooms the player has entered.</param>
/// <param name="ClearedRooms">Rooms fully cleared.</param>
/// <param name="ExploredLevels">Z levels with visited rooms.</param>
public readonly record struct ExplorationStatistics(
    int TotalRooms,
    int VisitedRooms,
    int ClearedRooms,
    IReadOnlyList<int> ExploredLevels)
{
    /// <summary>
    /// Gets the exploration percentage (0-100).
    /// </summary>
    public float ExplorationPercent => TotalRooms > 0
        ? (float)VisitedRooms / TotalRooms * 100
        : 0;

    /// <summary>
    /// Gets the cleared percentage (0-100).
    /// </summary>
    public float ClearedPercent => TotalRooms > 0
        ? (float)ClearedRooms / TotalRooms * 100
        : 0;

    /// <summary>
    /// Gets the number of unexplored rooms.
    /// </summary>
    public int UnexploredRooms => TotalRooms - VisitedRooms;

    /// <summary>
    /// Gets the deepest explored level.
    /// </summary>
    public int DeepestLevel => ExploredLevels.Count > 0
        ? ExploredLevels.Max()
        : 0;
}
```

---

## 8. ASCII Map Symbols

### 8.1 Room Type Symbols

| Symbol | Room Type | Description |
|--------|-----------|-------------|
| `@` | (Player) | Current player position |
| `#` | Standard | Normal room (visited) |
| `$` | Treasure | Treasure room |
| `!` | Trap | Trap room |
| `B` | Boss | Boss chamber |
| `+` | Safe | Safe haven |
| `*` | Shrine | Religious/magical site |
| `?` | (Unexplored) | Known but not visited |

### 8.2 Connection Symbols

| Symbol | Direction | Description |
|--------|-----------|-------------|
| `─` | East/West | Horizontal passage |
| `│` | North/South | Vertical passage |
| `↑` | Up | Stairs going up |
| `↓` | Down | Stairs going down |
| `≡` | Up/Down | Ladder |

### 8.3 Symbol Configuration

**File:** `src/Core/RuneAndRust.Application/Configuration/MapSymbolConfiguration.cs`

```csharp
namespace RuneAndRust.Application.Configuration;

/// <summary>
/// Configuration for map display symbols.
/// </summary>
public class MapSymbolConfiguration
{
    /// <summary>
    /// Player position symbol.
    /// </summary>
    public char PlayerSymbol { get; init; } = '@';

    /// <summary>
    /// Unexplored room symbol.
    /// </summary>
    public char UnexploredSymbol { get; init; } = '?';

    /// <summary>
    /// Room type symbols keyed by room type name.
    /// </summary>
    public IReadOnlyDictionary<string, char> RoomTypeSymbols { get; init; } =
        new Dictionary<string, char>
        {
            ["standard"] = '#',
            ["treasure"] = '$',
            ["trap"] = '!',
            ["boss"] = 'B',
            ["safe"] = '+',
            ["shrine"] = '*'
        };

    /// <summary>
    /// Connection symbols keyed by direction.
    /// </summary>
    public IReadOnlyDictionary<string, char> ConnectionSymbols { get; init; } =
        new Dictionary<string, char>
        {
            ["horizontal"] = '─',
            ["vertical"] = '│',
            ["stairs_up"] = '↑',
            ["stairs_down"] = '↓',
            ["ladder"] = '≡'
        };
}
```

---

## 9. Multi-Level Map Display

### 9.1 Multi-Level Output Format

```
> map all

=== The Forgotten Depths - Level 1 (Z=0) ===

        ?
        │
    ?───#───$
        │
    +───@───#───?
        │
        #
        ↓

Legend: @ You  # Room  $ Treasure  ! Trap  B Boss  + Safe  * Shrine  ? Unexplored
        ↑↓ Stairs  ≡ Ladder  ─│ Passages

Rooms explored: 5/8 on this level

=== The Forgotten Depths - Level 2 (Z=1) ===

        ↑
        │
    #───#───?
        │
        B

Legend: @ You  # Room  $ Treasure  ! Trap  B Boss  + Safe  * Shrine  ? Unexplored
        ↑↓ Stairs  ≡ Ladder  ─│ Passages

Rooms explored: 3/4 on this level

────────────────────────────────────────
Current position: Level 1, (0, 0)
Total rooms explored: 8
```

### 9.2 Level Header Format

Each level displays with:
- Dungeon name
- Level number (1-indexed for display)
- Z coordinate in parentheses
- ASCII map grid
- Legend
- Level-specific exploration stats

---

## 10. Data Model Changes

### 10.1 New Enums

| Type | Name | Location | Description |
|------|------|----------|-------------|
| Enum | `ExplorationState` | `Domain/Enums/ExplorationState.cs` | 3 exploration states |

### 10.2 New Value Objects

| Type | Name | Location | Description |
|------|------|----------|-------------|
| Record | `ExplorationStatistics` | `Domain/ValueObjects/` | Exploration progress stats |

### 10.3 New DTOs

| Type | Name | Location | Description |
|------|------|----------|-------------|
| Record | `MapDto` | `Application/DTOs/` | Map display data |
| Record | `MapStatisticsDto` | `Application/DTOs/` | Map statistics |
| Record | `MapLevelDto` | `Application/DTOs/` | Single level data |

### 10.4 New Configuration Classes

| Type | Name | Location | Description |
|------|------|----------|-------------|
| Class | `MapSymbolConfiguration` | `Application/Configuration/` | Symbol mappings |

### 10.5 New Interfaces

| Type | Name | Location | Description |
|------|------|----------|-------------|
| Interface | `IMapRendererService` | `Application/Interfaces/` | Map rendering contract |

### 10.6 New Services

| Type | Name | Location | Description |
|------|------|----------|-------------|
| Class | `MapRendererService` | `Application/Services/` | Map rendering logic |

### 10.7 Modified Entities

| Entity | Changes |
|--------|---------|
| `Room` | Add `ExplorationState`, `MarkVisited()`, `MarkCleared()`, `CanBeCleared` |
| `Dungeon` | Add `GetRoomsOnLevel()`, `GetExploredLevels()`, `GetExplorationStatsForLevel()`, `GetLevelBounds()` |
| `GameSession` | Add `ClearedRooms`, `MarkRoomCleared()`, `GetExplorationStatistics()` |

### 10.8 Modified Interfaces

| Interface | Changes |
|-----------|---------|
| `IGameRenderer` | Add `RenderMapAsync(MapDto)` |

---

## 11. Configuration File Schemas

### 11.1 map-symbols.json (Optional Override)

**File:** `config/map-symbols.json`

```json
{
  "version": "1.0",
  "playerSymbol": "@",
  "unexploredSymbol": "?",
  "roomTypeSymbols": {
    "standard": "#",
    "treasure": "$",
    "trap": "!",
    "boss": "B",
    "safe": "+",
    "shrine": "*"
  },
  "connectionSymbols": {
    "horizontal": "─",
    "vertical": "│",
    "stairs_up": "↑",
    "stairs_down": "↓",
    "ladder": "≡"
  }
}
```

---

## 12. Logging Specifications

### 12.1 Log Levels by Component

| Component | Level | Events |
|-----------|-------|--------|
| `MapRendererService` | Debug | Map rendered, room count, level bounds |
| `MapRendererService` | Warning | Empty level, no rooms found |
| `GameSessionService` | Information | Map command executed |
| `GameSessionService` | Debug | Exploration stats calculated |
| `Room` | Debug | State changed to Visited/Cleared |
| `Room` | Information | Room cleared |

### 12.2 Log Message Examples

```
[Debug] Rendered map for level 0 with 8 rooms
[Debug] Level bounds: X(-2, 3) Y(-1, 2)
[Information] Player viewed map for level 0
[Debug] Room 'Entrance Hall' marked as Visited
[Information] Room 'Armory' marked as Cleared
[Debug] Exploration stats: 5 visited, 3 cleared of 12 total
[Warning] No rooms found on level 3
```

---

## 13. Unit Testing Requirements

### 13.1 Test Count by Feature

| Feature | Test Count |
|---------|------------|
| ExplorationState enum | ~2 |
| Room exploration methods | ~4 |
| Dungeon level methods | ~3 |
| GameSession exploration | ~2 |
| MapRendererService.RenderLevel | ~3 |
| MapRendererService.GetRoomSymbol | ~3 |
| MapRendererService.RenderAllLevels | ~2 |
| ExplorationStatistics | ~1 |
| **Total** | **~20** |

### 13.2 Test Files

| File | Tests | Coverage |
|------|-------|----------|
| `ExplorationStateTests.cs` | ~2 | Enum values |
| `RoomExplorationTests.cs` | ~4 | MarkVisited, MarkCleared, CanBeCleared |
| `DungeonLevelTests.cs` | ~3 | GetRoomsOnLevel, GetExploredLevels, GetLevelBounds |
| `GameSessionExplorationTests.cs` | ~2 | MarkRoomCleared, GetExplorationStatistics |
| `MapRendererServiceTests.cs` | ~8 | All rendering methods |
| `ExplorationStatisticsTests.cs` | ~1 | Calculations |

### 13.3 Sample Test Cases

#### RoomExplorationTests.cs

```csharp
[Test]
public void MarkVisited_FromUnexplored_ReturnsTrue()
{
    var room = CreateTestRoom();
    Assert.That(room.ExplorationState, Is.EqualTo(ExplorationState.Unexplored));

    var result = room.MarkVisited();

    Assert.That(result, Is.True);
    Assert.That(room.ExplorationState, Is.EqualTo(ExplorationState.Visited));
}

[Test]
public void MarkVisited_AlreadyVisited_ReturnsFalse()
{
    var room = CreateTestRoom();
    room.MarkVisited();

    var result = room.MarkVisited();

    Assert.That(result, Is.False);
}

[Test]
public void MarkCleared_WhenCanBeCleared_ReturnsTrue()
{
    var room = CreateEmptyVisitedRoom(); // No monsters, no hidden exits

    var result = room.MarkCleared();

    Assert.That(result, Is.True);
    Assert.That(room.ExplorationState, Is.EqualTo(ExplorationState.Cleared));
}

[Test]
public void MarkCleared_WithLivingMonsters_ReturnsFalse()
{
    var room = CreateVisitedRoomWithMonster();

    var result = room.MarkCleared();

    Assert.That(result, Is.False);
    Assert.That(room.ExplorationState, Is.EqualTo(ExplorationState.Visited));
}
```

#### MapRendererServiceTests.cs

```csharp
[Test]
public void GetRoomSymbol_PlayerPosition_ReturnsAtSign()
{
    var service = CreateService();
    var room = CreateTestRoom();

    var symbol = service.GetRoomSymbol(room, isPlayerHere: true);

    Assert.That(symbol, Is.EqualTo('@'));
}

[Test]
public void GetRoomSymbol_UnvisitedRoom_ReturnsQuestionMark()
{
    var service = CreateService();
    var room = CreateTestRoom(); // Unexplored by default

    var symbol = service.GetRoomSymbol(room, isPlayerHere: false);

    Assert.That(symbol, Is.EqualTo('?'));
}

[Test]
public void GetRoomSymbol_VisitedTreasureRoom_ReturnsDollarSign()
{
    var service = CreateService();
    var room = CreateTestRoom();
    room.SetRoomType(RoomType.Treasure);
    room.MarkVisited();

    var symbol = service.GetRoomSymbol(room, isPlayerHere: false);

    Assert.That(symbol, Is.EqualTo('$'));
}

[Test]
public void RenderLevel_SingleRoom_ContainsRoomSymbol()
{
    var service = CreateService();
    var dungeon = CreateDungeonWithSingleRoom();
    var playerPos = new Position3D(0, 0, 0);

    var result = service.RenderLevel(dungeon, 0, playerPos);

    Assert.That(result, Does.Contain("@")); // Player symbol
    Assert.That(result, Does.Contain("Level 1")); // Header
}

[Test]
public void RenderLevel_MultipleRooms_ShowsConnections()
{
    var service = CreateService();
    var dungeon = CreateDungeonWithConnectedRooms();
    var playerPos = new Position3D(0, 0, 0);

    var result = service.RenderLevel(dungeon, 0, playerPos);

    Assert.That(result, Does.Contain("─")); // Horizontal connection
}
```

---

## 14. Use Cases

### UC-001: View Current Level Map

**Actor:** Player
**Flow:** Type "map" → System renders current level → ASCII map displayed → Legend shown → Exploration stats shown

### UC-002: View All Explored Levels

**Actor:** Player
**Flow:** Type "map all" → System gathers all explored levels → Each level rendered → Stacked display → Summary with current position

### UC-003: Room Marked as Visited

**Actor:** System
**Flow:** Player enters room → Room.MarkVisited() called → State changes to Visited → Room symbol changes from '?' to type symbol

### UC-004: Room Auto-Cleared

**Actor:** System
**Flow:** Player defeats last monster → Player searches (no hidden) → Room.TryAutoCleared() called → State changes to Cleared

### UC-005: Hidden Exit Not Shown on Map

**Actor:** System
**Flow:** Room has hidden exit (not discovered) → Render map → Connection not drawn → Player searches → Exit discovered → Map now shows connection

### UC-006: Stairs Displayed on Map

**Actor:** System
**Flow:** Room has Down exit → Render map → Room shows '↓' below it → Player can see vertical connection

---

## 15. Deliverable Checklist

### Domain Layer

- [ ] `ExplorationState.cs` enum created (3 values)
- [ ] `ExplorationStatistics.cs` value object created
- [ ] `Room.cs` - Add ExplorationState property
- [ ] `Room.cs` - Add MarkVisited() method
- [ ] `Room.cs` - Add MarkCleared() method
- [ ] `Room.cs` - Add CanBeCleared property
- [ ] `Room.cs` - Add TryAutoCleared() method
- [ ] `Dungeon.cs` - Add GetRoomsOnLevel() method
- [ ] `Dungeon.cs` - Add GetExploredLevels() method
- [ ] `Dungeon.cs` - Add GetExplorationStatsForLevel() method
- [ ] `Dungeon.cs` - Add GetLevelBounds() method
- [ ] `GameSession.cs` - Add ClearedRooms tracking
- [ ] `GameSession.cs` - Add MarkRoomCleared() method
- [ ] `GameSession.cs` - Add GetExplorationStatistics() method

### Application Layer

- [ ] `IMapRendererService.cs` interface created
- [ ] `MapRendererService.cs` implemented
- [ ] `MapDto.cs` DTO created
- [ ] `MapStatisticsDto.cs` DTO created
- [ ] `MapLevelDto.cs` DTO created
- [ ] `MapSymbolConfiguration.cs` created
- [ ] `GameSessionService.cs` - Add HandleMapCommand() method

### Presentation Layer

- [ ] `map` command parsed
- [ ] `map all` command parsed
- [ ] `IGameRenderer.RenderMapAsync()` method added
- [ ] Map display implementation in SpectreGameRenderer

### Configuration Files

- [ ] `config/map-symbols.json` created (optional)

### Infrastructure Updates

- [ ] `DependencyInjection.cs` - Register MapRendererService

### Tests

- [ ] `ExplorationStateTests.cs` (~2 tests)
- [ ] `RoomExplorationTests.cs` (~4 tests)
- [ ] `DungeonLevelTests.cs` (~3 tests)
- [ ] `GameSessionExplorationTests.cs` (~2 tests)
- [ ] `MapRendererServiceTests.cs` (~8 tests)
- [ ] `ExplorationStatisticsTests.cs` (~1 test)
- [ ] All ~20 tests passing

### Documentation

- [ ] XML documentation for all new types
- [ ] Updated code comments for modified types

---

## 16. Acceptance Criteria

### Functional

- [ ] ExplorationState enum has 3 values (Unexplored, Visited, Cleared)
- [ ] Room.ExplorationState defaults to Unexplored
- [ ] Room.MarkVisited() changes state from Unexplored to Visited
- [ ] Room.MarkCleared() only succeeds when CanBeCleared is true
- [ ] Room.CanBeCleared is false when monsters present
- [ ] Room.CanBeCleared is false when undiscovered hidden exits exist
- [ ] Dungeon.GetRoomsOnLevel() returns correct rooms for Z level
- [ ] Dungeon.GetExploredLevels() returns levels with visited rooms
- [ ] `map` command renders ASCII map of current level
- [ ] `map all` command renders all explored levels
- [ ] Player position shown with '@' symbol
- [ ] Room types shown with distinct symbols (#, $, !, B, +, *)
- [ ] Unexplored rooms shown with '?'
- [ ] Horizontal connections shown with '─'
- [ ] Vertical connections shown with '│'
- [ ] Stairs up shown with '↑', stairs down with '↓'
- [ ] Hidden exits not shown on map until discovered
- [ ] Map includes legend explaining symbols
- [ ] Map shows exploration statistics (visited/total)

### Quality

- [ ] Build succeeds with 0 errors and 0 warnings
- [ ] All ~20 unit tests pass
- [ ] XML documentation complete for all new/modified types
- [ ] No breaking changes to existing functionality

---

## 17. Dependencies

### 17.1 Prerequisites (REQUIRES)

```
v0.1.0d Map Command & Polish
    │
    └── REQUIRES from v0.1.0c
        ├── RoomType enum (for room symbols)
        ├── Exit value object (for connection visibility)
        ├── Room.GetVisibleExits() (for drawing connections)
        ├── Room.GetHiddenExits() (for cleared detection)
        └── SearchService (for cleared detection)
    │
    └── REQUIRES from v0.1.0b
        ├── Procedurally generated rooms
        └── Depth/level awareness
    │
    └── REQUIRES from v0.1.0a
        ├── Position3D value object
        ├── Direction enum with Up/Down
        ├── StairType enum
        └── Room with Position3D
    │
    └── REQUIRES from v0.0.11
        ├── GameSession.VisitedRooms
        └── Room entity structure
```

### 17.2 Completes v0.1.0

This phase integrates all v0.1.0 features:
- Z-axis foundation (v0.1.0a)
- Procedural generation (v0.1.0b)
- Room types and hidden passages (v0.1.0c)
- Map visualization and exploration (v0.1.0d)

---

## 18. Future Considerations

### 18.1 Deferred to Future Versions

- **Graphical map**: 2D graphical map view in GUI version
- **Minimap in TUI**: Always-visible corner minimap
- **Auto-mapping toggle**: Option to disable map visibility
- **Fog of war**: Unexplored areas completely hidden
- **Map markers**: Player-placed markers on map
- **Map zoom**: Zoom in/out for large dungeons

### 18.2 Out of Scope

- **Real-time map updates**: Map updates as player moves without command
- **Map export**: Save map to file
- **Map annotations**: Add notes to rooms

---

*Document Version: 1.0*
*Last Updated: 2026-01-08*
*Author: Claude*
