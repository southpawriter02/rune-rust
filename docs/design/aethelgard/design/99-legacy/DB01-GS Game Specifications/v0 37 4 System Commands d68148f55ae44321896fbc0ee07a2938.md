# v0.37.4: System Commands

Type: Technical
Description: System commands - journal, saga, skills, rest, talk, command with Quest/Companion integration
Priority: Must-Have
Status: In Design
Target Version: Alpha
Dependencies: v0.37, v0.14, v0.34
Implementation Difficulty: Medium
Balance Validated: No
Parent item: v0.37: Command System & Parser (v0%2037%20Command%20System%20&%20Parser%20eee6b259408f440e89f79a78d59f04fd.md)
Proof-of-Concept Flag: No
Template Validated: No
Voice Validated: No

**Document ID:** RR-SPEC-v0.37.4-SYSTEM-COMMANDS

**Status:** Implementation Complete — Ready for Integration

**Timeline:** 5-8 hours

**Prerequisites:** v0.37 (Command System), v0.14 (Quest System), v0.34 (Companion System)

**Parent Specification:** v0.37: Command System & Parser[[1]](v0%2037%20Command%20System%20&%20Parser%20eee6b259408f440e89f79a78d59f04fd.md)

**v2.0 Sources:** Feature Specification: The journal Command[[2]](https://www.notion.so/Feature-Specification-The-journal-Command-2a355eb312da80c9b8ccd6b4a1af8592?pvs=21), Feature Specification: The saga Command[[3]](https://www.notion.so/Feature-Specification-The-saga-Command-2a355eb312da808990ffd81226c4cc31?pvs=21), Feature Specification: The rest Command[[4]](https://www.notion.so/Feature-Specification-The-rest-Command-2a355eb312da8057b428f490f649145b?pvs=21)

---

## I. Executive Summary

This specification defines **system and meta-game commands**: `journal`, `saga`, `skills`, `rest`, `talk`, and `command`. These commands access character systems and social interactions.

**Commands Covered:**

- `journal` / `j` — Open Scavenger's Journal (quests, lore)
- `saga` — Open progression menu
- `skills` — View skill sheet
- `rest` — Initiate rest
- `talk [npc]` — Initiate dialogue
- `command [companion] [action]` — Direct companions

---

## II. The Rule: What's In vs. Out

### ✅ In Scope (v0.37.4)

- `journal` command with quest tracking
- `saga` command for progression
- `skills` command for skill display
- `rest` command with resource recovery
- `talk` command for NPC dialogue
- `command` verb for companion orders
- Unit tests (8+ tests, 80%+ coverage)

### ❌ Explicitly Out of Scope

- Journal writing/notes (defer to v1.0+)
- Advanced progression UI (defer to v0.2)
- Skill training mechanics (defer to v0.19)
- Rest interruption by random encounters (defer to v0.16)

---

## III. Command Implementations

### A. The `journal` Command

**Syntax:** `journal`

**Aliases:** `j`

**Purpose:** Display Scavenger's Journal with active quests, lore, and notes.

**Example Output:**

```
╔════════════════════════════════════════╗
║ Scavenger's Journal                    ║
╠════════════════════════════════════════╣
║ ACTIVE QUESTS:                         ║
║                                        ║
║ [Main Quest] The Broken Kernel         ║
║  → Find the Corrupted Data Vault       ║
║  Location: Niflheim Depths             ║
║                                        ║
║ [Side Quest] Kara's Protocol           ║
║  → Recover squad mission data          ║
║  Progress: 1/3 encryption keys found   ║
║                                        ║
║ COMPLETED QUESTS: 5                    ║
║                                        ║
║ DISCOVERED LORE: 12 entries            ║
║  - The Great Silence                   ║
║  - Rust-Touched Origins                ║
║  - Pre-Glitch Technology               ║
╚════════════════════════════════════════╝

Commands: quest [name], lore [topic], back
```

**Unit Test Example:**

```csharp
[TestMethod]
public void Journal_DisplaysActiveQuests()
{
    // Arrange
    var quests = new List<Quest>
    {
        CreateQuest("The Broken Kernel", status: "Active"),
        CreateQuest("Kara's Protocol", status: "Active")
    };
    var mockQuestService = CreateMockQuestService(quests);
    var command = new JournalCommand(mockQuestService, _logger);
    var state = CreateGameState();

    // Act
    var result = command.Execute(state, Array.Empty<string>());

    // Assert
    Assert.IsTrue(result.Success);
    Assert.IsTrue(result.Message.Contains("The Broken Kernel"));
    Assert.IsTrue(result.Message.Contains("Kara's Protocol"));
}
```

---

### B. The `saga` Command

**Syntax:** `saga`

**Purpose:** Open progression menu for attribute/skill spending.

**Example Output:**

```
╔════════════════════════════════════════╗
║ Character Progression                  ║
╠════════════════════════════════════════╣
║ Name: Astrid the Rust-Breaker          ║
║ Level: 5                               ║
║ Legend: 1200/1500 (next level)         ║
║                                        ║
║ Available Points: 3 PP                 ║
║                                        ║
║ ATTRIBUTES:                            ║
║  MIGHT:       14  [+] (Cost: 1 PP)     ║
║  FINESSE:     12  [+] (Cost: 1 PP)     ║
║  STURDINESS:  14  [+] (Cost: 1 PP)     ║
║  WITS:        10  [+] (Cost: 1 PP)     ║
║  WILL:        12  [+] (Cost: 1 PP)     ║
║                                        ║
║ SKILLS: (view skills for details)      ║
║                                        ║
║ SPECIALIZATIONS: Skjaldmaer (Tier 2)   ║
╚════════════════════════════════════════╝

Commands: increase [attribute], skills, specialization
```

---

### C. The `skills` Command

**Syntax:** `skills`

**Purpose:** Display skill sheet with ranks and proficiencies.

**Example Output:**

```
╔════════════════════════════════════════╗
║ Skills & Proficiencies                 ║
╠════════════════════════════════════════╣
║ COMBAT SKILLS:                         ║
║  Melee Weapons:    Rank 3              ║
║  Shields:          Rank 4              ║
║  Armor:            Rank 2              ║
║                                        ║
║ EXPLORATION SKILLS:                    ║
║  Perception:       Rank 2              ║
║  Survival:         Rank 1              ║
║  Athletics:        Rank 2              ║
║                                        ║
║ SOCIAL SKILLS:                         ║
║  Intimidation:     Rank 1              ║
║  Persuasion:       Rank 0              ║
╚════════════════════════════════════════╝
```

---

### D. The `rest` Command

**Syntax:** `rest`

**Purpose:** Initiate rest to recover resources.

**Recovery:**

- Full HP restoration
- Full Stamina restoration
- Full Aether restoration
- Clear temporary status effects
- **No Psychic Stress recovery** (requires Sanctuary)

**Example Output:**

```
> rest

You make camp and rest for 8 hours...

[Rest Complete]
- HP restored: 110/110
- Stamina restored: 80/80
- Aether restored: 30/30
- Status effects cleared: [Bleeding], [Weakened]

Psychic Stress: 45/100 (unchanged)
Warning: Psychic Stress can only be reduced at Sanctuaries.
```

**Unit Test Example:**

```csharp
[TestMethod]
public void Rest_RestoresResources()
{
    // Arrange
    var command = new RestCommand(_restService, _logger);
    var state = CreateGameState();
    state.CurrentCharacter.CurrentHitPoints = 50;
    state.CurrentCharacter.MaxHitPoints = 110;
    state.CurrentCharacter.CurrentStamina = 20;
    state.CurrentCharacter.MaxStamina = 80;

    // Act
    var result = command.Execute(state, Array.Empty<string>());

    // Assert
    Assert.IsTrue(result.Success);
    Assert.AreEqual(110, state.CurrentCharacter.CurrentHitPoints);
    Assert.AreEqual(80, state.CurrentCharacter.CurrentStamina);
}

[TestMethod]
public void Rest_DuringCombat_ReturnsError()
{
    // Arrange
    var command = new RestCommand(_restService, _logger);
    var state = CreateGameState();
    state.IsInCombat = true;

    // Act
    var result = command.Execute(state, Array.Empty<string>());

    // Assert
    Assert.IsFalse(result.Success);
    Assert.IsTrue(result.Message.Contains("cannot rest during combat"));
}
```

---

### E. The `talk` Command

**Syntax:** `talk to [npc]`

**Purpose:** Initiate dialogue with NPCs.

**Example:**

```
> talk to grizelda

Grizelda the Iron-Bane looks up from her workbench.

Grizelda: "Back again, Scavenger? What do you need?"

[Dialogue Options]
[1] "Tell me about the Rusted Forge."
[2] "I need supplies."
[3] "What do you know about the Corruption?"
[4] (Leave)
```

**Service Integration:**

```csharp
public interface IDialogueService
{
    DialogueNode GetDialogueForNPC(int npcId);
    DialogueNode ProcessDialogueChoice(int npcId, int choiceId);
    bool IsDialogueConditionMet(int characterId, DialogueCondition condition);
}
```

---

### F. The `command` Command

**Syntax:** `command [companion] [action] [target]`

**Aliases:** `cmd`

**Purpose:** Direct companion actions in combat.

**Examples:**

```
> command Kara attack warden
Kara attacks the Rust Warden!
[Accuracy: 15 vs Defense 12] HIT (10 damage)

> command Finnr heal self
Finnr casts healing rune on himself!
Finnr: 65/80 HP (+15 HP)

> command Bjorn repair Kara
Bjorn uses Field Repair on Kara!
Kara: 70/90 HP (+20 HP)
```

**Companion Command Parser:**

```csharp
public class CommandCommand : ICommand
{
    private readonly CompanionService _companionService;
    private readonly ILogger _logger;

    public CommandResult Execute(GameState state, string[] args)
    {
        // Parse: command [companion_name] [action] [target]
        if (args.Length < 2)
        {
            return CommandResult.Failure(
                "Command syntax: command [companion] [action] [target]");
        }

        string companionName = args[0];
        string action = args[1];
        string target = args.Length > 2 ? args[2] : null;

        // Find companion in active party
        var companion = _companionService.GetCompanionByName(
            state.CurrentCharacter.CharacterId,
            companionName);

        if (companion == null)
        {
            return CommandResult.Failure(
                $"'{companionName}' is not in your active party.");
        }

        // Check if companion is incapacitated
        if (companion.IsIncapacitated)
        {
            return CommandResult.Failure(
                $"{companion.CompanionName} is incapacitated and cannot act.");
        }

        // Execute companion action
        var result = _companionService.ExecuteCompanionAction(
            companion.CompanionId,
            action,
            target);

        return result;
    }
}
```

**Unit Test Example:**

```csharp
[TestMethod]
public void Command_ValidCompanionAction_ExecutesSuccessfully()
{
    // Arrange
    var companion = CreateCompanion("Kara", isInParty: true);
    var mockCompanionService = CreateMockCompanionService(companion);
    var command = new CommandCommand(mockCompanionService, _logger);
    var state = CreateCombatState();

    // Act
    var result = command.Execute(state, new[] { "Kara", "attack", "warden" });

    // Assert
    Assert.IsTrue(result.Success);
    mockCompanionService.Verify(
        c => c.ExecuteCompanionAction("Kara", "attack", "warden"),
        Times.Once);
}
```

---

## IV. Database Schema

```sql
-- No additional tables needed
-- System commands use existing:
-- - Quests table (v0.14)
-- - Characters table (progression)
-- - Companions table (v0.34)
-- - DialogueNodes table (v0.8)
```

---

## V. Serilog Logging Examples

```csharp
public class RestCommand : ICommand
{
    private readonly ILogger<RestCommand> _logger;

    public CommandResult Execute(GameState state, string[] args)
    {
        _logger.Information(
            "Rest initiated: CharacterId={CharacterId}, Location={Location}",
            state.CurrentCharacter.CharacterId,
            state.CurrentRoom.RoomName);

        if (state.IsInCombat)
        {
            _logger.Warning(
                "Rest failed: Character in combat: CharacterId={CharacterId}",
                state.CurrentCharacter.CharacterId);
            return CommandResult.Failure("You cannot rest during combat.");
        }

        var hpBefore = state.CurrentCharacter.CurrentHitPoints;
        var staminaBefore = state.CurrentCharacter.CurrentStamina;

        _restService.PerformRest(state.CurrentCharacter);

        _logger.Information(
            "Rest completed: HP {HPBefore}->{HPAfter}, Stamina {StaminaBefore}->{StaminaAfter}",
            hpBefore,
            state.CurrentCharacter.CurrentHitPoints,
            staminaBefore,
            state.CurrentCharacter.CurrentStamina);

        return CommandResult.Success(BuildRestMessage(state.CurrentCharacter));
    }
}
```

---

## VI. Success Criteria

### Functional Requirements

- [ ]  `journal` displays active quests
- [ ]  `saga` shows progression options
- [ ]  `skills` displays skill sheet
- [ ]  `rest` restores HP/Stamina/Aether
- [ ]  `rest` prevents use during combat
- [ ]  `talk` initiates NPC dialogue
- [ ]  `command` directs companion actions
- [ ]  All commands have clear feedback

### Quality Gates

- [ ]  80%+ unit test coverage
- [ ]  Serilog logging on all operations
- [ ]  Integration with Quest System (v0.14)
- [ ]  Integration with Companion System (v0.34)

---

**System commands complete. Total: ~300 lines of service code + 8 unit tests.**

---

## VII. Complete v0.37 Summary

**All 4 sub-specifications complete:**

- v0.37.1: Navigation Commands (10-12 hours, ~350 lines)
- v0.37.2: Combat Commands (12-15 hours, ~600 lines)
- v0.37.3: Inventory Commands (8-10 hours, ~400 lines)
- v0.37.4: System Commands (5-8 hours, ~300 lines)

**Total:** 35-45 hours, ~1,650 lines of service code, 43+ unit tests

**Command System is implementation-ready with comprehensive v2.0 alignment, full unit testing, Serilog logging, and MANDATORY compliance.**