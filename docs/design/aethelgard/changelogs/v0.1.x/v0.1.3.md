# Changelog: v0.1.3 - The Codex

**Versions:** v0.1.3a through v0.1.3c
**Release Date:** December 19, 2025

## Table of Contents

- [Overview](#overview)
- [Part A: Data Foundation (December 19, 2025)](#part-a-data-foundation-december-19-2025)
  - [Summary](#summary)
  - [New Files Created](#new-files-created)
  - [Files Modified](#files-modified)
  - [Code Implementation Details](#code-implementation-details)
  - [Part A Test Summary](#part-a-test-summary)
- [Part B: Capture Logic & Distribution (December 19, 2025)](#part-b-capture-logic--distribution-december-19-2025)
  - [Summary](#summary-1)
  - [New Files Created](#new-files-created-1)
  - [Files Modified](#files-modified-1)
  - [Code Implementation Details](#code-implementation-details-1)
  - [Part B Test Summary](#part-b-test-summary)
- [Part C: Terminal Interface (December 19, 2025)](#part-c-terminal-interface-december-19-2025)
  - [Summary](#summary-2)
  - [New Files Created](#new-files-created-2)
  - [Files Modified](#files-modified-2)
  - [Code Implementation Details](#code-implementation-details-2)
  - [Usage Examples](#usage-examples)
  - [Part C Test Summary](#part-c-test-summary)
- [v0.1.3 Trilogy Complete](#v013-trilogy-complete)
- [Verification Results](#verification-results)
- [Test Summary](#test-summary)

---

## Overview

Version 0.1.3 implements the complete **Scavenger's Journal (Codex) system** for Rune & Rust. This three-part release establishes the data foundation for collectible lore fragments and Codex entries (Part A), implements the capture generation and auto-assignment logic (Part B), and delivers the terminal-based Journal UI with progressive text redaction (Part C).

**Key Features:**
- Data Captures: Collectible lore fragments with no weight burden
- Codex Entries: Assembled lore targets with progressive unlock thresholds
- WITS-based capture generation during exploration and examination
- 60+ AAM-VOICE compliant lore templates
- Terminal Journal UI with text redaction based on completion percentage

---

## Part A: Data Foundation (December 19, 2025)

# Changelog: v0.1.3a - The Codex (Data Foundation)

**Release Date:** 2025-12-19

---

## Summary

Version 0.1.3a establishes the **data foundation** for the Scavenger's Journal (Codex) system. This release introduces the core domain models for **Data Captures** (collectible lore fragments) and **Codex Entries** (the assembled lore targets), along with their persistence layer and comprehensive test coverage. Unlike inventory items, Data Captures exist in a separate progression system with no weight burden, allowing players to collect lore without sacrificing survival capacity. The implementation includes JSONB storage for flexible unlock thresholds, a one-to-many relationship between entries and fragments, and seed data for initial Field Guide tutorials and a sample Bestiary entry. This foundation prepares the system for v0.1.3b (capture logic and discovery triggers) and v0.1.3c (the Journal UI).

---

## New Files Created

### Core Layer - Enums

| File | Purpose |
|------|---------|
| `RuneAndRust.Core/Enums/CaptureType.cs` | Classification of data capture methods (TextFragment, EchoRecording, VisualRecord, Specimen, OralHistory, RunicTrace) |
| `RuneAndRust.Core/Enums/EntryCategory.cs` | Codex entry categorization (FieldGuide, BlightOrigin, Bestiary, Factions, Technical, Geography) |

### Core Layer - Entities

| File | Purpose |
|------|---------|
| `RuneAndRust.Core/Entities/CodexEntry.cs` | Static lore content with title, category, full text, fragment count, and JSONB unlock thresholds |
| `RuneAndRust.Core/Entities/DataCapture.cs` | Player-discovered fragments with character ownership, optional entry assignment, content, source, and quality |

### Core Layer - Interfaces

| File | Purpose |
|------|---------|
| `RuneAndRust.Core/Interfaces/ICodexEntryRepository.cs` | Repository contract with category filtering, title search, and eager-loading methods |
| `RuneAndRust.Core/Interfaces/IDataCaptureRepository.cs` | Repository contract with character queries, fragment counting, and unassigned capture retrieval |

### Persistence Layer

| File | Purpose |
|------|---------|
| `RuneAndRust.Persistence/Repositories/CodexEntryRepository.cs` | Full repository implementation with DEBUG logging for all operations |
| `RuneAndRust.Persistence/Repositories/DataCaptureRepository.cs` | Full repository implementation with eager loading and DEBUG logging |
| `RuneAndRust.Persistence/Data/CodexSeeder.cs` | Seeds 3 Field Guide entries and 1 Bestiary entry with Domain 4 compliant content |

### Test Layer

| File | Purpose |
|------|---------|
| `RuneAndRust.Tests/Core/CodexEntryTests.cs` | 26 unit tests for CodexEntry entity properties, defaults, and unlock threshold operations |
| `RuneAndRust.Tests/Core/DataCaptureTests.cs` | 23 unit tests for DataCapture entity properties, defaults, and navigation |
| `RuneAndRust.Tests/Integration/CodexPersistenceTests.cs` | 23 integration tests for CRUD, JSONB serialization, relationships, and repository queries |

---

## Files Modified

| File | Change |
|------|--------|
| `RuneAndRust.Persistence/Data/RuneAndRustDbContext.cs` | Added `DbSet<CodexEntry>` and `DbSet<DataCapture>`; configured entity mappings with JSONB for `UnlockThresholds`, unique index on `Title`, and one-to-many relationship with `SetNull` delete behavior |

---

## Code Implementation Details

### CaptureType Enum

```csharp
public enum CaptureType
{
    TextFragment = 0,    // Readable notes, slates, torn pages
    EchoRecording = 1,   // Audio logs (transcribed)
    VisualRecord = 2,    // Schematics, images, diagrams
    Specimen = 3,        // Biological samples
    OralHistory = 4,     // Dialogue, rumors
    RunicTrace = 5       // Magical/tech trace analysis
}
```

### EntryCategory Enum

```csharp
public enum EntryCategory
{
    FieldGuide = 0,      // Tutorials (unlocked via gameplay triggers)
    BlightOrigin = 1,    // The Glitch lore
    Bestiary = 2,        // Creature data
    Factions = 3,        // Political/social info
    Technical = 4,       // Pre-Glitch technology
    Geography = 5        // Locations
}
```

### CodexEntry Entity

```csharp
public class CodexEntry
{
    public Guid Id { get; set; }
    public string Title { get; set; }
    public EntryCategory Category { get; set; }
    public string FullText { get; set; }
    public int TotalFragments { get; set; }
    public Dictionary<int, string> UnlockThresholds { get; set; }  // JSONB
    public ICollection<DataCapture> Fragments { get; set; }
    public DateTime CreatedAt { get; set; }
    public DateTime LastModified { get; set; }
}
```

**Key Properties:**
- `TotalFragments`: Number of fragments needed for 100% completion
- `UnlockThresholds`: Maps completion percentage to unlock tags (e.g., `{ 25: "WEAKNESS_REVEALED", 50: "HABITAT_REVEALED" }`)

### DataCapture Entity

```csharp
public class DataCapture
{
    public Guid Id { get; set; }
    public Guid CharacterId { get; set; }
    public Guid? CodexEntryId { get; set; }  // Nullable for unassigned
    public CaptureType Type { get; set; }
    public string FragmentContent { get; set; }
    public string Source { get; set; }
    public int Quality { get; set; }  // 15=standard, 30=specialist
    public bool IsAnalyzed { get; set; }
    public DateTime DiscoveredAt { get; set; }
    public CodexEntry? CodexEntry { get; set; }
}
```

**Key Properties:**
- `CodexEntryId`: Nullable FK allows unassigned fragments awaiting auto-assignment
- `Quality`: Affects Legend reward when entry is completed

### Repository Interfaces

**ICodexEntryRepository:**
```csharp
Task<IEnumerable<CodexEntry>> GetByCategoryAsync(EntryCategory category);
Task<CodexEntry?> GetByTitleAsync(string title);
Task<CodexEntry?> GetWithFragmentsAsync(Guid id);
Task AddRangeAsync(IEnumerable<CodexEntry> entries);
```

**IDataCaptureRepository:**
```csharp
Task<IEnumerable<DataCapture>> GetByCharacterIdAsync(Guid characterId);
Task<IEnumerable<DataCapture>> GetByEntryIdAsync(Guid entryId, Guid characterId);
Task<int> GetFragmentCountAsync(Guid entryId, Guid characterId);
Task<IEnumerable<DataCapture>> GetUnassignedAsync(Guid characterId);
Task AddRangeAsync(IEnumerable<DataCapture> captures);
```

### DbContext Configuration

```csharp
// JSONB conversion for UnlockThresholds
entity.Property(e => e.UnlockThresholds)
    .HasColumnType("jsonb")
    .HasConversion(
        v => JsonSerializer.Serialize(v, (JsonSerializerOptions?)null),
        v => JsonSerializer.Deserialize<Dictionary<int, string>>(v, (JsonSerializerOptions?)null)
            ?? new Dictionary<int, string>()
    )
    .IsRequired();

// Relationship with SetNull on delete
entity.HasMany(e => e.Fragments)
    .WithOne(d => d.CodexEntry)
    .HasForeignKey(d => d.CodexEntryId)
    .OnDelete(DeleteBehavior.SetNull);
```

### Seed Data

**Field Guide Entries (3):**
- "Psychic Stress" - Mental coherence mechanics
- "Combat Basics" - Violence and stamina management
- "Burden and Carrying Capacity" - Weight and inventory limits

**Bestiary Entry (1):**
- "Rusted Servitor" - 4-fragment entry with progressive unlocks at 25%, 50%, 75%, 100%

---

## Part A Test Summary

| Category | Count | Status |
|----------|-------|--------|
| CodexEntryTests | 26 | Passed |
| DataCaptureTests | 23 | Passed |
| CodexPersistenceTests | 23 | Passed |
| **v0.1.3a Total** | **72** | **All Passed** |
| **Full Suite Total** | **1,118** | **All Passed** |

---

## Part B: Capture Logic & Distribution (December 19, 2025)

# Changelog: v0.1.3b - The Codex (Capture Logic & Distribution)

**Release Date:** 2025-12-19

---

## Summary

Version 0.1.3b implements the **Engine layer services** for discovering, generating, and assigning Data Captures during gameplay. Building on v0.1.3a's data foundation, this release adds the `DataCaptureService` for probabilistic capture generation during container searches and expert-tier examinations. Captures are automatically matched to Codex Entries by keyword and include WITS-based chance modifiers. The implementation features 19 Domain 4 compliant lore templates across 6 categories, deterministic testing via seeded Random, and comprehensive trace/debug logging throughout all code paths. Integration with `InteractionService` hooks capture generation into existing examine and search mechanics without breaking backward compatibility.

---

## New Files Created

### Core Layer - Models

| File | Purpose |
|------|---------|
| `RuneAndRust.Core/Models/CaptureResult.cs` | Result record for capture operations with factory methods (`Generated`, `NoCapture`) |

### Core Layer - Interfaces

| File | Purpose |
|------|---------|
| `RuneAndRust.Core/Interfaces/IDataCaptureService.cs` | Service contract for capture generation, completion tracking, and threshold unlocking |

### Engine Layer - Services

| File | Purpose |
|------|---------|
| `RuneAndRust.Engine/Services/CaptureTemplates.cs` | Static capture template definitions (19 templates across 6 categories) with Domain 4 compliant lore content |
| `RuneAndRust.Engine/Services/DataCaptureService.cs` | Main capture generation and assignment logic with WITS-based probability modifiers |

### Test Layer

| File | Purpose |
|------|---------|
| `RuneAndRust.Tests/Engine/DataCaptureServiceTests.cs` | 23 unit tests for generation, auto-assignment, and completion percentage calculations |

---

## Files Modified

| File | Change |
|------|--------|
| `RuneAndRust.Engine/Services/InteractionService.cs` | Added optional `IDataCaptureService` injection; integrated capture generation into `ExamineAsync` (expert tier) and `SearchContainerAsync` |
| `RuneAndRust.Terminal/Program.cs` | Registered `ICodexEntryRepository`, `IDataCaptureRepository`, and `IDataCaptureService` in DI container |

---

## Code Implementation Details

### CaptureResult Model

```csharp
public record CaptureResult(
    bool Success,
    string Message,
    DataCapture? Capture,
    bool WasAutoAssigned)
{
    public static CaptureResult Generated(string message, DataCapture capture, bool autoAssigned)
        => new(true, message, capture, autoAssigned);

    public static CaptureResult NoCapture(string message)
        => new(false, message, null, false);
}
```

### IDataCaptureService Interface

```csharp
public interface IDataCaptureService
{
    Task<CaptureResult> TryGenerateFromSearchAsync(
        Guid characterId, InteractableObject container, int witsBonus = 0);

    Task<CaptureResult> TryGenerateFromExaminationAsync(
        Guid characterId, InteractableObject target, int tierRevealed, int witsBonus = 0);

    Task<int> GetCompletionPercentageAsync(Guid entryId, Guid characterId);

    Task<IEnumerable<string>> GetUnlockedThresholdsAsync(Guid entryId, Guid characterId);
}
```

**Key Methods:**
- `TryGenerateFromSearchAsync`: 25% base chance + (WITS × 5%)
- `TryGenerateFromExaminationAsync`: Tier-based chances (Expert: 75%, Detailed: 37%, Base: 0%)
- `GetCompletionPercentageAsync`: Returns (fragmentCount × 100) / totalFragments, capped at 100
- `GetUnlockedThresholdsAsync`: Returns threshold tags where key <= percentage

### Template Categories

| Category | Template Count | Trigger Keywords |
|----------|---------------|------------------|
| RustedServitor | 4 | servitor, automaton, machine, mechanical |
| GenericContainer | 3 | container, chest, crate, box |
| BlightedCreature | 3 | blight, corrupted, infected, mutation |
| IndustrialSite | 3 | industrial, forge, foundry, factory |
| AncientRuin | 3 | ruin, ancient, inscription, tomb |
| FieldGuideTriggers | 3 | psychic, combat, burden, inventory |

### DataCaptureService Constants

```csharp
private const int BaseSearchCaptureChance = 25;     // 25% base on container search
private const int ExpertExamCaptureChance = 75;     // 75% on expert examination
private const int DetailedExamCaptureChance = 37;   // 37% on detailed examination
private const int StandardQuality = 15;              // Quality for search/detailed
private const int SpecialistQuality = 30;           // Quality for expert tier
private const int ExpertTier = 2;                   // 3+ net successes
private const int DetailedTier = 1;                 // 1+ net successes
```

### WITS Bonus Mechanics

| Generation Source | Base Chance | WITS Modifier | Max Effective |
|-------------------|-------------|---------------|---------------|
| Container Search | 25% | +5% per point | 75% (at WITS 10) |
| Expert Examination | 75% | +3% per point | 105% → 100% |
| Detailed Examination | 37% | +3% per point | 67% (at WITS 10) |
| Base Examination | 0% | N/A | 0% (never generates) |

---

## Part B Test Summary

| Category | Count | Status |
|----------|-------|--------|
| DataCaptureServiceTests | 23 | Passed |
| **v0.1.3b Total** | **23** | **All Passed** |
| **Full Suite Total** | **1,141** | **All Passed** |

---

## Part C: Terminal Interface (December 19, 2025)

# Changelog: v0.1.3c - The Journal UI (Terminal Interface)

**Release Date:** 2025-12-19

---

## Summary

Version 0.1.3c completes the **Codex Milestone (v0.1.3)** by implementing the terminal-based Journal UI for viewing discovered lore. Building on v0.1.3a's data foundation and v0.1.3b's capture generation logic, this release adds three new commands (`journal`, `codex <name>`, `fragments`) that render formatted Codex entries with progressive text redaction based on completion percentage. The implementation features a standalone `TextRedactor` service using stable pseudo-random word masking with prime-number-based indexing to ensure consistent redaction patterns at each completion level. The `JournalService` formats output with Spectre.Console markup, groups entries by category, displays completion percentages with visual indicators (★ for complete, ● for incomplete), and reveals unlocked threshold tags (e.g., "Weakness Revealed"). CommandParser was refactored to async to support journal queries, requiring cascading changes to GameService and all command parser tests. The system includes 26 new unit tests with 100% pass rate across the full 1,141-test suite.

---

## New Files Created

### Core Layer - Interfaces

| File | Purpose |
|------|---------|
| `RuneAndRust.Core/Interfaces/IJournalService.cs` | Service contract for Scavenger's Journal display formatting with three formatting methods |

### Engine Layer - Services

| File | Purpose |
|------|---------|
| `RuneAndRust.Engine/Services/JournalService.cs` | Implementation of journal list, entry detail, and unassigned fragment views with Spectre.Console markup |
| `RuneAndRust.Engine/Services/TextRedactor.cs` | Standalone text masking service using stable pseudo-random word-level redaction based on completion percentage |

### Test Layer

| File | Purpose |
|------|---------|
| `RuneAndRust.Tests/Engine/JournalServiceTests.cs` | 14 unit tests for journal formatting, entry detail views, and fragment lists |
| `RuneAndRust.Tests/Engine/TextRedactorTests.cs` | 12 unit tests for text masking edge cases, stability, and progressive reveal behavior |

---

## Files Modified

| File | Change |
|------|--------|
| `RuneAndRust.Core/Interfaces/IDataCaptureRepository.cs` | Added `GetDiscoveredEntryIdsAsync(Guid characterId)` method to retrieve distinct entry IDs with at least one fragment |
| `RuneAndRust.Persistence/Repositories/DataCaptureRepository.cs` | Implemented `GetDiscoveredEntryIdsAsync` with LINQ `Distinct()` query and DEBUG logging |
| `RuneAndRust.Core/Interfaces/IDataCaptureService.cs` | Added `GetDiscoveredEntriesAsync(Guid characterId)` method returning `ValueTuple<CodexEntry, int>` collection |
| `RuneAndRust.Engine/Services/DataCaptureService.cs` | Implemented `GetDiscoveredEntriesAsync` by iterating entry IDs and assembling tuples with completion percentages |
| `RuneAndRust.Core/Interfaces/IGameService.cs` | Changed `Start()` to `Task StartAsync()` for async command support |
| `RuneAndRust.Engine/Services/GameService.cs` | Refactored `Start()` to `async Task StartAsync()` with `await` on parser calls |
| `RuneAndRust.Engine/Services/CommandParser.cs` | Made `ParseAndExecute` fully async (`Task<ParseResult> ParseAndExecuteAsync`); added optional `IJournalService` constructor parameter; added `journal`, `codex <name>`, and `fragments` commands with async execution; updated help text |
| `RuneAndRust.Terminal/Program.cs` | Registered `IJournalService` in DI container; updated GameService call to `StartAsync().GetAwaiter().GetResult()` |
| `RuneAndRust.Tests/Engine/CommandParserTests.cs` | Updated all 48 tests to call `ParseAndExecuteAsync` and `await` results |
| `RuneAndRust.Tests/Engine/GameLoopTests.cs` | Updated tests to await `StartAsync()` calls |
| `RuneAndRust.Tests/Engine/GameServiceTests.cs` | Updated tests to use async patterns with `StartAsync()` |

---

## Code Implementation Details

### IJournalService Interface

```csharp
public interface IJournalService
{
    Task<string> FormatJournalListAsync(Guid characterId);
    Task<string> FormatEntryDetailAsync(Guid characterId, string entryTitle);
    Task<string> FormatUnassignedCapturesAsync(Guid characterId);
}
```

### TextRedactor Service

```csharp
public class TextRedactor
{
    private const string RedactedBlock = "[grey]████[/]";
    private const string FullyRedactedMessage = "[REDACTED]";

    public string RedactText(string fullText, int completionPct)
    {
        // Handle edge cases
        if (completionPct >= 100) return fullText;
        if (completionPct <= 0) return FullyRedactedMessage;
        if (string.IsNullOrWhiteSpace(fullText)) return fullText;

        var words = fullText.Split(' ');
        var result = new StringBuilder();

        for (int i = 0; i < words.Length; i++)
        {
            // Stable pseudo-random based on word index
            // Formula: ((i * 7 + 13) % 100) < completionPct
            // Primes 7 and 13 reduce visible patterns
            bool visible = ((i * 7 + 13) % 100) < completionPct;

            result.Append(visible ? words[i] : RedactedBlock);
            if (i < words.Length - 1) result.Append(' ');
        }

        return result.ToString();
    }
}
```

**Algorithm Behaviors:**
- Uses word-level masking (not character-level) for readability
- Pseudo-random visibility based on `(index * 7 + 13) % 100 < completionPct`
- Multiplier 7 and offset 13 are primes to reduce repeating patterns
- Same text at same completion percentage always produces identical output
- No internal state; thread-safe and deterministic

### New Journal Commands

| Command | Aliases | Description |
|---------|---------|-------------|
| `journal` | `j` | Open the Scavenger's Journal |
| `codex <name>` | - | View a specific journal entry |
| `fragments` | - | View unassigned knowledge fragments |

### Spectre.Console Markup for Terminal Styling

| Markup Pattern | Purpose |
|----------------|---------|
| `[yellow]═══[/]` | Section headers and dividers |
| `[cyan]──[/]` | Category headers |
| `[green]★[/]` | Completion indicator (100%) |
| `[grey]●[/]` | Incomplete indicator (<100%) |
| `[grey]████[/]` | Redacted text blocks |
| `[red]Error[/]` | Error messages |
| `[green]✓[/]` | Unlocked threshold checkmark |

---

## Usage Examples

### Viewing the Journal
```
[EXPLORE] journal
═══ SCAVENGER'S JOURNAL ═══

── Bestiary ──
  ● Rusted Servitor (45%)

── FieldGuide ──
  ★ Burden and Carrying Capacity (100%)
  ★ Combat Basics (100%)
  ★ Psychic Stress (100%)

Use 'codex <name>' to view entry details.
```

### Viewing a Specific Entry (Incomplete)
```
[EXPLORE] codex Rusted Servitor
═══ RUSTED SERVITOR ═══
Category: Bestiary
Completion: 45%

████ ancient ████ stands ████ its joints ████ and seized. ████ chassis shows
evidence ████ mycelial ████ growing through ████ seams.

Discoveries:
  ✓ Weakness Revealed
```

### Viewing a Specific Entry (Complete)
```
[EXPLORE] codex Combat Basics
═══ COMBAT BASICS ═══
Category: FieldGuide
Completion: 100%

Violence in the ruined world is costly. Each blow struck drains stamina, and
exhaustion leaves you vulnerable. Strike with purpose, not panic. Retreat is
not cowardice—it is survival.

Discoveries:
  ✓ Full Entry
```

### Viewing Unassigned Fragments
```
[EXPLORE] fragments
── Unassigned Fragments ──
These fragments don't match any known entries yet.

  TextFragment - Old Container
    "...inscriptions speak of a time before the Glitch, wh..."
  EchoRecording - Servitor Remains
    "...auditory trace suggests mechanical speech patterns..."
```

---

## Part C Test Summary

| Category | Count | Status |
|----------|-------|--------|
| JournalServiceTests | 14 | Passed |
| TextRedactorTests | 12 | Passed |
| **v0.1.3c New Tests** | **26** | **All Passed** |
| **Full Suite Total** | **1,141** | **All Passed** |

---

## v0.1.3 Trilogy Complete

With v0.1.3c, the complete "Codex" feature set is now implemented:

| Version | Focus | Key Components |
|---------|-------|----------------|
| v0.1.3a | Data Foundation | CodexEntry, DataCapture entities, JSONB storage, repository layer |
| v0.1.3b | Capture Logic | DataCaptureService, probability-based generation, WITS bonuses |
| v0.1.3c | Journal UI | JournalService, TextRedactor, terminal commands, Spectre.Console formatting |

**Complete Codex Flow:**
1. Player explores and examines objects in rooms
2. WITS-based rolls determine if captures are generated
3. Captures auto-assign to matching Codex entries by keyword
4. Player views journal (`journal` command) to see progress
5. Player views specific entries (`codex <name>`) with progressive text reveal
6. Unlocked thresholds (e.g., "Weakness Revealed") provide tactical information

---

## Verification Results

### Build Output
```
Build succeeded. 0 Error(s)
Time Elapsed 00:00:03.42
```

### Final Test Output
```
Passed!  - Failed: 0, Passed: 1141, Skipped: 0, Total: 1141, Duration: 414 ms
```

---

## Test Summary

| Part | New Tests | Total After |
|------|-----------|-------------|
| Part A (Data Foundation) | 72 | 1,118 |
| Part B (Capture Logic) | 23 | 1,141 |
| Part C (Journal UI) | 26 | 1,141* |
| **Total New Tests** | **121** | - |

*Part C tests were added alongside async refactor of existing tests
