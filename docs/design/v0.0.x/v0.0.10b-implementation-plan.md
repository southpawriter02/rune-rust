# v0.0.10b Implementation Plan: Unit Test Coverage

**Version:** 0.0.10b
**Parent:** v0.0.10 (Documentation & Polish)
**Prerequisites:** v0.0.9 Complete, v0.0.10a Complete (Logging Infrastructure)
**Design Specification:** [v0.0.10b-design-specification.md](v0.0.10b-design-specification.md)
**Status:** Ready for Implementation
**Target Tests:** ~332 -> ~347 (+15 framework tests)

---

## Table of Contents

1. [Executive Summary](#executive-summary)
2. [Current System Analysis](#current-system-analysis)
3. [Detailed Implementation](#detailed-implementation)
4. [Testing Strategy](#testing-strategy)
5. [Implementation Checklist](#implementation-checklist)
6. [Acceptance Criteria](#acceptance-criteria)
7. [File Summary](#file-summary)

---

## Executive Summary

### Purpose

Establish reusable test infrastructure including fluent entity builders, mock providers, and test fixtures. This phase creates the TestUtilities project containing utilities that simplify test authoring across v0.0.5-v0.0.9 system tests.

### Scope

- **In Scope:**
  - Create `RuneAndRust.TestUtilities` project
  - Fluent builders: `PlayerBuilder`, `MonsterBuilder`, `RoomBuilder`, `GameSessionBuilder`
  - Mock utilities: `MockConfigurationProvider`, `MockRepository`
  - Test fixtures: `TestFixtureBase`, `SeededRandom`
  - Framework tests for utilities (~15 tests)
  - Update existing test projects to reference TestUtilities

- **Out of Scope:**
  - Writing v0.0.5-9 tests (defined in their respective specs)
  - Integration tests, UI tests, performance tests

### Key Decisions

| Decision | Choice | Rationale |
|----------|--------|-----------|
| **Test Framework** | NUnit 4.x | Already in use |
| **Assertions** | FluentAssertions 7.x | Already in use |
| **Mocking** | Moq 4.x | Already in use |
| **Builder Pattern** | Fluent API | Readable, chainable test setup |

---

## Current System Analysis

### Existing Test Projects

| Project | Tests | Coverage |
|---------|-------|----------|
| `RuneAndRust.Domain.UnitTests` | 123 | Entities, ValueObjects, Definitions |
| `RuneAndRust.Application.UnitTests` | 67 | Services |
| `RuneAndRust.Architecture.Tests` | 8 | Layer dependencies |
| **Total** | **198** | |

### Current Test Structure

```
tests/
â”œâ”€â”€ RuneAndRust.Domain.UnitTests/
â”‚   â”œâ”€â”€ Entities/
â”‚   â”œâ”€â”€ ValueObjects/
â”‚   â”œâ”€â”€ Definitions/
â”‚   â””â”€â”€ Validation/
â”œâ”€â”€ RuneAndRust.Application.UnitTests/
â”‚   â””â”€â”€ Services/
â”œâ”€â”€ RuneAndRust.Architecture.Tests/
â””â”€â”€ RuneAndRust.Infrastructure.IntegrationTests/
```

### Target Structure (After v0.0.10b)

```
tests/
â”œâ”€â”€ RuneAndRust.TestUtilities/           # NEW
â”‚   â”œâ”€â”€ Builders/
â”‚   â”‚   â”œâ”€â”€ PlayerBuilder.cs
â”‚   â”‚   â”œâ”€â”€ MonsterBuilder.cs
â”‚   â”‚   â”œâ”€â”€ RoomBuilder.cs
â”‚   â”‚   â””â”€â”€ GameSessionBuilder.cs
â”‚   â”œâ”€â”€ Mocks/
â”‚   â”‚   â”œâ”€â”€ MockConfigurationProvider.cs
â”‚   â”‚   â””â”€â”€ MockRepository.cs
â”‚   â”œâ”€â”€ Fixtures/
â”‚   â”‚   â””â”€â”€ TestFixtureBase.cs
â”‚   â”œâ”€â”€ Logging/                         # From v0.0.10a
â”‚   â”‚   â”œâ”€â”€ TestLogger.cs
â”‚   â”‚   â””â”€â”€ TestLoggerFactory.cs
â”‚   â””â”€â”€ SeededRandom.cs
â”œâ”€â”€ RuneAndRust.Domain.UnitTests/        # Updated with TestUtilities ref
â”œâ”€â”€ RuneAndRust.Application.UnitTests/   # Updated with TestUtilities ref
â””â”€â”€ ...
```

---

## Detailed Implementation

### 1. TestUtilities Project (NEW)

**File:** `tests/RuneAndRust.TestUtilities/RuneAndRust.TestUtilities.csproj`

```xml
<Project Sdk="Microsoft.NET.Sdk">
  <PropertyGroup>
    <TargetFramework>net9.0</TargetFramework>
    <ImplicitUsings>enable</ImplicitUsings>
    <Nullable>enable</Nullable>
  </PropertyGroup>

  <ItemGroup>
    <PackageReference Include="Microsoft.Extensions.Logging.Abstractions" Version="9.0.0" />
    <PackageReference Include="Moq" Version="4.20.72" />
    <PackageReference Include="NUnit" Version="4.2.2" />
    <PackageReference Include="FluentAssertions" Version="7.0.0" />
  </ItemGroup>

  <ItemGroup>
    <ProjectReference Include="..\..\src\Core\RuneAndRust.Domain\RuneAndRust.Domain.csproj" />
    <ProjectReference Include="..\..\src\Core\RuneAndRust.Application\RuneAndRust.Application.csproj" />
  </ItemGroup>
</Project>
```

### 2. PlayerBuilder.cs (NEW)

Fluent builder for creating test Player instances with sensible defaults.

**Key Methods:**
- `Create()` - Static factory
- `WithName(string)` - Set player name
- `WithStats(int, int, int)` - Set maxHealth, attack, defense
- `WithAttributes(int, int, int, int, int)` - Set might, fortitude, will, wits, finesse
- `WithCurrentHealth(int)` - Set current health (damages if needed)
- `AtPosition(int, int)` - Set grid position
- `WithItem(Item)` - Add inventory item
- `WithClass(string, string)` - Set archetype/class
- `WithResource(string, int, int?)` - Add resource pool
- `WithAbility(string, bool, int)` - Add ability
- `Build()` - Create Player instance

### 3. MonsterBuilder.cs (NEW)

Fluent builder for creating test Monster instances.

**Key Methods:**
- `Create()` - Static factory with defaults
- `Goblin()` - Preset for goblin stats
- `Orc()` - Preset for orc stats
- `WithName(string)` - Set name
- `WithStats(int, int, int)` - Set maxHealth, attack, defense
- `WithCurrentHealth(int)` - Set current health
- `WithDefinitionId(string)` - Link to MonsterDefinition
- `WithExperienceValue(int)` - Set XP reward
- `Build()` - Create Monster instance

### 4. RoomBuilder.cs (NEW)

Fluent builder for creating test Room instances.

**Key Methods:**
- `Create()` - Static factory
- `WithId(Guid)` - Set room ID
- `WithName(string)` - Set room name
- `WithDescription(string)` - Set description
- `AtPosition(int, int)` - Set grid position
- `WithExit(Direction, Guid)` - Add exit
- `WithMonster(Monster)` - Add monster
- `WithItem(Item)` - Add item
- `Build()` - Create Room instance

### 5. GameSessionBuilder.cs (NEW)

Fluent builder for creating test GameSession instances.

**Key Methods:**
- `Create()` - Static factory
- `WithPlayer(Player)` - Set player via builder or instance
- `WithDungeon(Dungeon)` - Set dungeon
- `WithRoom(Room)` - Add room
- `InRoom(Guid)` - Set current room
- `WithState(GameState)` - Set game state
- `Build()` - Create GameSession instance

### 6. MockConfigurationProvider.cs (NEW)

In-memory configuration provider implementing `IGameConfigurationProvider`.

**Key Methods:**
- `WithClass(ClassDefinition)` - Add class
- `WithArchetype(ArchetypeDefinition)` - Add archetype
- `WithAbility(AbilityDefinition)` - Add ability
- `WithResourceType(ResourceTypeDefinition)` - Add resource type
- `WithMonster(MonsterDefinition)` - Add monster
- `WithDefaultResourceTypes()` - Add standard resource types

Implements all `IGameConfigurationProvider` methods via in-memory lists.

### 7. MockRepository.cs (NEW)

In-memory repository implementing `IGameRepository`.

**Key Methods:**
- `WithSession(GameSession)` - Pre-populate session
- `SaveAsync(GameSession, CancellationToken)` - Store in dictionary
- `GetByIdAsync(Guid, CancellationToken)` - Retrieve by ID
- `GetAllAsync(CancellationToken)` - Get all sessions
- `DeleteAsync(Guid, CancellationToken)` - Remove session

### 8. TestFixtureBase.cs (NEW)

Base class for test fixtures with common setup.

**Properties:**
- `ConfigProvider` - MockConfigurationProvider instance
- `LoggerFactory` - TestLoggerFactory instance

**Methods:**
- `SetUp()` - Virtual, initializes providers (NUnit `[SetUp]`)
- `CreateMockLogger<T>()` - Creates Moq logger
- `GetTestLogger<T>()` - Gets TestLogger from factory
- `VerifyLog<T>(LogLevel, string)` - Verifies log message exists

### 9. SeededRandom.cs (NEW)

Utility for deterministic random number generation in tests.

**Members:**
- `DefaultSeed = 12345` - Constant for reproducibility
- `Create(int seed)` - Creates seeded Random instance
- `CreateMultiple(int count, int baseSeed)` - Creates multiple instances

---

## Testing Strategy

### Framework Tests (~15 tests)

#### BuilderTests.cs (~5 tests)

| Test | Description |
|------|-------------|
| `PlayerBuilder_Build_CreatesValidPlayer` | Default builder works |
| `PlayerBuilder_WithStats_SetsCorrectValues` | Stats applied correctly |
| `PlayerBuilder_WithResource_InitializesPool` | Resource initialization |
| `MonsterBuilder_Goblin_CreatesGoblinPreset` | Preset configuration |
| `MonsterBuilder_WithCurrentHealth_DamagesCorrectly` | Health damage calculation |

#### MockProviderTests.cs (~5 tests)

| Test | Description |
|------|-------------|
| `MockConfigurationProvider_WithClass_ReturnsClass` | Class storage/retrieval |
| `MockConfigurationProvider_WithAbility_ReturnsAbility` | Ability storage/retrieval |
| `MockConfigurationProvider_GetClassById_FindsClass` | ID lookup |
| `MockConfigurationProvider_WithDefaultResourceTypes_AddsAll` | Default types |
| `MockConfigurationProvider_GetAbilitiesForClass_FiltersCorrectly` | Filtering |

#### UtilityTests.cs (~5 tests)

| Test | Description |
|------|-------------|
| `SeededRandom_Create_ProducesDeterministicValues` | Same seed = same values |
| `SeededRandom_DifferentSeeds_ProduceDifferentValues` | Different seeds differ |
| `TestFixtureBase_SetUp_InitializesProviders` | Setup initialization |
| `TestFixtureBase_GetTestLogger_ReturnsLogger` | Logger retrieval |
| `TestFixtureBase_VerifyLog_FindsMessage` | Log verification |

---

## Implementation Checklist

> **Legend:** ğŸŸ¢ No dependencies | ğŸŸ¡ Has dependencies | ğŸ”´ Critical path
> **Complexity:** â­ Simple | â­â­ Moderate | â­â­â­ Complex

---

### Phase 1: Project Setup

#### 1.1 Create TestUtilities Project ğŸŸ¢ â­ ğŸ”´

**File:** `tests/RuneAndRust.TestUtilities/RuneAndRust.TestUtilities.csproj`

- [ ] Create `RuneAndRust.TestUtilities/` directory
- [ ] Create `.csproj` file with net9.0 target
- [ ] Add PackageReferences: M.E.Logging.Abstractions, Moq, NUnit, FluentAssertions
- [ ] Add ProjectReferences: Domain, Application
- [ ] Add to solution file

**Acceptance:** Project builds successfully.

---

#### 1.2 Move TestLogger Files ğŸŸ¡ â­

**From v0.0.10a:** Move or ensure TestLogger utilities are in TestUtilities project.

- [ ] Ensure `Logging/TestLogger.cs` exists in TestUtilities
- [ ] Ensure `Logging/TestLoggerFactory.cs` exists in TestUtilities
- [ ] Verify namespace is `RuneAndRust.TestUtilities.Logging`

**Acceptance:** Logging utilities accessible from TestUtilities.

---

### Phase 2: Entity Builders

#### 2.1 Create PlayerBuilder.cs ğŸŸ¡ â­â­â­

**File:** `tests/RuneAndRust.TestUtilities/Builders/PlayerBuilder.cs`

- [ ] Create `Builders/` directory
- [ ] Define `PlayerBuilder` class with private fields for all player properties
- [ ] Implement `Create()` static factory
- [ ] Implement fluent methods: `WithName`, `WithStats`, `WithAttributes`, `WithCurrentHealth`, `AtPosition`, `WithItem`, `WithClass`, `WithResource`, `WithAbility`
- [ ] Implement `Build()` method that creates and configures Player
- [ ] Add comprehensive XML documentation

**Acceptance:** `PlayerBuilder.Create().WithName("Hero").Build()` creates valid Player.

---

#### 2.2 Create MonsterBuilder.cs ğŸŸ¡ â­â­

**File:** `tests/RuneAndRust.TestUtilities/Builders/MonsterBuilder.cs`

- [ ] Define `MonsterBuilder` class
- [ ] Implement `Create()` static factory
- [ ] Implement preset factories: `Goblin()`, `Orc()`
- [ ] Implement fluent methods: `WithName`, `WithDescription`, `WithStats`, `WithCurrentHealth`, `WithDefinitionId`, `WithExperienceValue`
- [ ] Implement `Build()` method

**Acceptance:** `MonsterBuilder.Goblin().Build()` creates goblin with correct stats.

---

#### 2.3 Create RoomBuilder.cs ğŸŸ¡ â­â­

**File:** `tests/RuneAndRust.TestUtilities/Builders/RoomBuilder.cs`

- [ ] Define `RoomBuilder` class
- [ ] Implement `Create()` static factory
- [ ] Implement fluent methods: `WithId`, `WithName`, `WithDescription`, `AtPosition`, `WithExit`, `WithMonster`, `WithItem`
- [ ] Implement `Build()` method

**Acceptance:** `RoomBuilder.Create().WithMonster(monster).Build()` creates room with monster.

---

#### 2.4 Create GameSessionBuilder.cs ğŸŸ¡ â­â­

**File:** `tests/RuneAndRust.TestUtilities/Builders/GameSessionBuilder.cs`

- [ ] Define `GameSessionBuilder` class
- [ ] Implement `Create()` static factory
- [ ] Implement fluent methods: `WithPlayer`, `WithDungeon`, `WithRoom`, `InRoom`, `WithState`
- [ ] Implement `Build()` method

**Acceptance:** Builder creates valid GameSession with configured rooms/player.

---

### Phase 3: Mock Utilities

#### 3.1 Create MockConfigurationProvider.cs ğŸŸ¡ â­â­â­

**File:** `tests/RuneAndRust.TestUtilities/Mocks/MockConfigurationProvider.cs`

- [ ] Create `Mocks/` directory
- [ ] Define class implementing `IGameConfigurationProvider`
- [ ] Add private lists for each definition type
- [ ] Implement `With*` fluent methods for each definition type
- [ ] Implement `WithDefaultResourceTypes()` for standard resources
- [ ] Implement all `IGameConfigurationProvider` interface methods

**Acceptance:** Mock provider returns configured definitions.

---

#### 3.2 Create MockRepository.cs ğŸŸ¡ â­â­

**File:** `tests/RuneAndRust.TestUtilities/Mocks/MockRepository.cs`

- [ ] Define class implementing `IGameRepository`
- [ ] Add private dictionary for session storage
- [ ] Implement `WithSession()` for pre-population
- [ ] Implement `SaveAsync`, `GetByIdAsync`, `GetAllAsync`, `DeleteAsync`

**Acceptance:** Mock repository stores and retrieves sessions.

---

### Phase 4: Test Fixtures

#### 4.1 Create TestFixtureBase.cs ğŸŸ¡ â­â­

**File:** `tests/RuneAndRust.TestUtilities/Fixtures/TestFixtureBase.cs`

- [ ] Create `Fixtures/` directory
- [ ] Define `TestFixtureBase` abstract class
- [ ] Add `ConfigProvider` and `LoggerFactory` properties
- [ ] Implement `[SetUp]` method to initialize providers
- [ ] Implement `CreateMockLogger<T>()` helper
- [ ] Implement `GetTestLogger<T>()` helper
- [ ] Implement `VerifyLog<T>()` helper

**Acceptance:** Derived test classes get automatic provider setup.

---

#### 4.2 Create SeededRandom.cs ğŸŸ¢ â­

**File:** `tests/RuneAndRust.TestUtilities/SeededRandom.cs`

- [ ] Define static class `SeededRandom`
- [ ] Add `DefaultSeed = 12345` constant
- [ ] Implement `Create(int seed)` method
- [ ] Implement `CreateMultiple(int count, int baseSeed)` method

**Acceptance:** Same seed produces identical random sequences.

---

### Phase 5: Project Integration

#### 5.1 Update Solution File ğŸŸ¡ â­

**File:** `RuneAndRust.sln`

- [ ] Add TestUtilities project to solution
- [ ] Place in `tests` solution folder

**Acceptance:** Solution builds with new project.

---

#### 5.2 Update Domain.UnitTests Project ğŸŸ¡ â­

**File:** `tests/RuneAndRust.Domain.UnitTests/RuneAndRust.Domain.UnitTests.csproj`

- [ ] Add ProjectReference to TestUtilities

**Acceptance:** Domain tests can use builders.

---

#### 5.3 Update Application.UnitTests Project ğŸŸ¡ â­

**File:** `tests/RuneAndRust.Application.UnitTests/RuneAndRust.Application.UnitTests.csproj`

- [ ] Add ProjectReference to TestUtilities

**Acceptance:** Application tests can use builders and mocks.

---

### Phase 6: Framework Tests

#### 6.1 Create BuilderTests.cs ğŸŸ¡ â­â­

**File:** `tests/RuneAndRust.TestUtilities/Tests/BuilderTests.cs`

- [ ] Create `Tests/` directory
- [ ] Implement 5 builder tests per specification

**Acceptance:** All builder tests pass.

---

#### 6.2 Create MockProviderTests.cs ğŸŸ¡ â­â­

**File:** `tests/RuneAndRust.TestUtilities/Tests/MockProviderTests.cs`

- [ ] Implement 5 mock provider tests per specification

**Acceptance:** All mock provider tests pass.

---

#### 6.3 Create UtilityTests.cs ğŸŸ¡ â­â­

**File:** `tests/RuneAndRust.TestUtilities/Tests/UtilityTests.cs`

- [ ] Implement 5 utility tests per specification

**Acceptance:** All utility tests pass.

---

### Implementation Order Summary

```
Phase 1: Project Setup
  1.1 Create TestUtilities.csproj â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  1.2 Move TestLogger Files â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
                                                â–¼
Phase 2: Entity Builders (Parallel)
  2.1 PlayerBuilder.cs
  2.2 MonsterBuilder.cs
  2.3 RoomBuilder.cs
  2.4 GameSessionBuilder.cs
                                                â–¼
Phase 3: Mock Utilities (Parallel)
  3.1 MockConfigurationProvider.cs
  3.2 MockRepository.cs
                                                â–¼
Phase 4: Test Fixtures
  4.1 TestFixtureBase.cs
  4.2 SeededRandom.cs
                                                â–¼
Phase 5: Project Integration
  5.1 Update Solution
  5.2 Update Domain.UnitTests
  5.3 Update Application.UnitTests
                                                â–¼
Phase 6: Framework Tests
  6.1 BuilderTests.cs
  6.2 MockProviderTests.cs
  6.3 UtilityTests.cs
```

### Estimated Effort

| Phase | Tasks | Complexity | Est. Time |
|-------|-------|------------|-----------|
| Project Setup | 2 items | â­ | 30 min |
| Entity Builders | 4 files | â­â­â­ | 3 hours |
| Mock Utilities | 2 files | â­â­â­ | 2 hours |
| Test Fixtures | 2 files | â­â­ | 1 hour |
| Project Integration | 3 files | â­ | 30 min |
| Framework Tests | 3 files | â­â­ | 2 hours |
| **Total** | **16 items** | | **9 hours** |

---

## Acceptance Criteria

1. **TestUtilities Project:** Builds and is referenced by all test projects
2. **Builders Work:** All fluent builders create valid entities
3. **Mocks Work:** MockConfigurationProvider implements IGameConfigurationProvider
4. **Fixtures Work:** TestFixtureBase provides automatic setup
5. **Tests Pass:** All 15 framework tests pass
6. **Deterministic:** SeededRandom produces reproducible results

---

## File Summary

### Files to Create (New)

| File | Purpose |
|------|---------|
| `tests/RuneAndRust.TestUtilities/RuneAndRust.TestUtilities.csproj` | Project file |
| `tests/RuneAndRust.TestUtilities/Builders/PlayerBuilder.cs` | Player builder |
| `tests/RuneAndRust.TestUtilities/Builders/MonsterBuilder.cs` | Monster builder |
| `tests/RuneAndRust.TestUtilities/Builders/RoomBuilder.cs` | Room builder |
| `tests/RuneAndRust.TestUtilities/Builders/GameSessionBuilder.cs` | Session builder |
| `tests/RuneAndRust.TestUtilities/Mocks/MockConfigurationProvider.cs` | Config mock |
| `tests/RuneAndRust.TestUtilities/Mocks/MockRepository.cs` | Repository mock |
| `tests/RuneAndRust.TestUtilities/Fixtures/TestFixtureBase.cs` | Test base class |
| `tests/RuneAndRust.TestUtilities/SeededRandom.cs` | Deterministic random |
| `tests/RuneAndRust.TestUtilities/Tests/BuilderTests.cs` | Builder tests |
| `tests/RuneAndRust.TestUtilities/Tests/MockProviderTests.cs` | Mock tests |
| `tests/RuneAndRust.TestUtilities/Tests/UtilityTests.cs` | Utility tests |

### Files to Modify

| File | Changes |
|------|---------|
| `RuneAndRust.sln` | Add TestUtilities project |
| `RuneAndRust.Domain.UnitTests.csproj` | Add TestUtilities reference |
| `RuneAndRust.Application.UnitTests.csproj` | Add TestUtilities reference |

### Test Files Summary

| File | Test Count |
|------|------------|
| `BuilderTests.cs` | ~5 |
| `MockProviderTests.cs` | ~5 |
| `UtilityTests.cs` | ~5 |
| **Total** | **~15** |

---

## Provides to Future Phases

### To v0.0.10c (XML Documentation)

| Type | Usage |
|------|-------|
| All builders | Document with XML docs |
| All mocks | Document with XML docs |

### To v0.0.10d (Implementation Specifications)

| Type | Usage |
|------|-------|
| Test patterns | Document in architecture section |
| Builder pattern | Reference as design decision |

### To v0.0.5-9 Tests

| Type | Usage |
|------|-------|
| `PlayerBuilder` | Create test players efficiently |
| `MonsterBuilder` | Create test monsters with presets |
| `MockConfigurationProvider` | Configure service dependencies |
| `TestFixtureBase` | Standardize test setup |
| `SeededRandom` | Deterministic dice/random tests |

---

*This implementation plan establishes reusable test infrastructure that simplifies authoring tests for v0.0.5-v0.0.9 systems while maintaining consistency across the test suite.*
