# v0.18.5c Design Specification: Rest Integration

**Version:** 0.18.5c
**Parent:** v0.18.5 (Resource Integration / Trauma Economy Integration)
**Prerequisites:** v0.18.5a (TraumaEconomyState), All v0.18.0-4
**Status:** Design Complete
**Estimated Unit Tests:** ~4

---

## Table of Contents

1. [Executive Summary](#1-executive-summary)
2. [Feature Overview](#2-feature-overview)
3. [Architecture Diagrams](#3-architecture-diagrams)
4. [User Stories](#4-user-stories)
5. [RestIntegrationResult Value Object](#5-restintegrationresult-value-object)
6. [UnifiedRestHandler Service](#6-unifiedresthandler-service)
7. [Rest Type Effects](#7-rest-type-effects)
8. [Logging Specifications](#8-logging-specifications)
9. [Unit Testing Requirements](#9-unit-testing-requirements)
10. [Deliverable Checklist](#10-deliverable-checklist)
11. [Acceptance Criteria](#11-acceptance-criteria)
12. [Dependencies](#12-dependencies)
13. [Future Considerations](#13-future-considerations)

---

## 1. Executive Summary

This design specification defines the **unified rest processing layer** that coordinates recovery effects across all trauma economy systems.

v0.18.5c establishes **Rest Integration** by defining:

- `RestIntegrationResult` value object — comprehensive rest outcome
- `UnifiedRestHandler` service — coordinates recovery across all systems
- Multiple rest types (Short, Long, Sanctuary) with distinct effects
- Party effects (Berserker Frenzy bonus stress reduction)
- Trauma checks and CPS recovery mechanics

### Key Deliverables

| Category            | Items                                         |
| ------------------- | --------------------------------------------- |
| **Value Objects**   | `RestIntegrationResult`                       |
| **Services**        | `UnifiedRestHandler`                          |
| **Tests**           | ~4 unit tests                                 |

### Rest Flow Overview

```
Rest Type → Calculate Recovery → Reset Resources → Check Traumas → Party Effects → Result
```

---

## 2. Feature Overview

```
v0.18.5c Features
└── Unified Rest Processing
    │
    ├── RestIntegrationResult Value Object
    │   ├── RestType (Short, Long, Sanctuary)
    │   ├── StressRecovered & Formula
    │   ├── CorruptionRecovered
    │   ├── CpsStageChanged & NewStage
    │   ├── TraumaChecksPerformed
    │   ├── TraumasAcquired (if checks fail)
    │   ├── RagePartyBonus
    │   ├── CoherenceRestored
    │   ├── MomentumReset
    │   └── RecoveryMessages
    │
    └── UnifiedRestHandler Service
        ├── ProcessRest() orchestration
        ├── CalculateStressRecovery() by rest type
        ├── ApplyResourceResets()
        ├── PerformTraumaChecks()
        ├── ApplyPartyEffects()
        └── BuildResultObject()
```

---

## 3. Architecture Diagrams

### 3.1 Rest Processing Pipeline

```
┌─────────────────────────────────────────────────────────────────────────┐
│                       UNIFIED REST HANDLER                               │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                           │
│     ┌─────────────────────────────────────────────────────────────────┐ │
│     │  1. SELECT REST TYPE                                            │ │
│     ├─────────────────────────────────────────────────────────────────┤ │
│     │  • Short Rest (5d4 + WILL modifier)                             │ │
│     │  • Long Rest (full recovery to 0)                               │ │
│     │  • Sanctuary (full + bonus)                                     │ │
│     └──────────────────┬──────────────────────────────────────────────┘ │
│                        │                                                 │
│     ┌──────────────────▼──────────────────────────────────────────────┐ │
│     │  2. CALCULATE STRESS RECOVERY                                   │ │
│     ├───────────────────────────────────────────────────────────────┤ │
│     │  Short: 5d4 + WILL                                             │ │
│     │  Long:  Recover to 0 (full)                                    │ │
│     │  Sanctuary: Recover to 0 + additional CPS benefit              │ │
│     └──────────────────┬──────────────────────────────────────────────┘ │
│                        │                                                 │
│     ┌──────────────────▼──────────────────────────────────────────────┐ │
│     │  3. RESET SPECIALIZATION RESOURCES                              │ │
│     ├───────────────────────────────────────────────────────────────┤ │
│     │  Rage:       Reset to 0                                        │ │
│     │  Momentum:   Reset to 0                                        │ │
│     │  Coherence:  On Long Rest → restore to 50 (Balanced)          │ │
│     └──────────────────┬──────────────────────────────────────────────┘ │
│                        │                                                 │
│     ┌──────────────────▼──────────────────────────────────────────────┐ │
│     │  4. PERFORM TRAUMA CHECKS                                       │ │
│     ├───────────────────────────────────────────────────────────────┤ │
│     │  For each active trauma:                                       │ │
│     │  • Roll check                                                  │ │
│     │  • Success: Trauma removed                                     │ │
│     │  • Failure: Trauma persists, new trauma acquired               │ │
│     └──────────────────┬──────────────────────────────────────────────┘ │
│                        │                                                 │
│     ┌──────────────────▼──────────────────────────────────────────────┐ │
│     │  5. APPLY PARTY EFFECTS                                         │ │
│     ├───────────────────────────────────────────────────────────────┤ │
│     │  If Berserker in FrenzyBeyondReason:                           │ │
│     │  • All other party members: -10 bonus stress (inspire/terrify) │ │
│     └──────────────────┬──────────────────────────────────────────────┘ │
│                        │                                                 │
│     ┌──────────────────▼──────────────────────────────────────────────┐ │
│     │  6. BUILD RESULT OBJECT                                         │ │
│     ├───────────────────────────────────────────────────────────────┤ │
│     │  • Populate RestIntegrationResult                             │ │
│     │  • Record all changes                                         │ │
│     │  • Generate recovery messages                                 │ │
│     │  • Return to caller                                           │ │
│     └──────────────────┬──────────────────────────────────────────────┘ │
│                        │                                                 │
│                        ▼                                                 │
│            RestIntegrationResult returned                                │
│                                                                           │
└─────────────────────────────────────────────────────────────────────────┘
```

### 3.2 Rest Type Effects Comparison

```
                   SHORT REST              LONG REST           SANCTUARY REST
                        │                      │                     │
    ┌───────────────────┼──────────────────────┼─────────────────────┘
    │                   │                      │
    ▼                   ▼                      ▼
┌─────────────────┐ ┌───────────────┐ ┌───────────────────────┐
│ Stress Recovery │ │ Full Recovery │ │ Full + Bonus Recovery │
│ 5d4 + WILL      │ │ Stress → 0    │ │ Stress → 0            │
└─────────────────┘ └───────────────┘ │ CPS One Stage Better  │
                                      └───────────────────────┘
    │                   │                     │
    ▼                   ▼                     ▼
┌─────────────────┐ ┌───────────────┐ ┌───────────────────────┐
│ Rage Reset: 0   │ │ Rage Reset: 0 │ │ Rage Reset: 0         │
│ Momentum: 0     │ │ Momentum: 0   │ │ Momentum: 0           │
│ Coherence: ±0   │ │ Coherence: 50 │ │ Coherence: 50         │
└─────────────────┘ └───────────────┘ └───────────────────────┘
    │                   │                     │
    ▼                   ▼                     ▼
┌─────────────────┐ ┌───────────────┐ ┌───────────────────────┐
│ No CPS Stage    │ │ CPS May       │ │ Additional CPS        │
│ Improvement     │ │ Improve One   │ │ Improvement (2 stages)│
│ No Trauma Check │ │ Stage         │ │ Trauma Checks Apply   │
└─────────────────┘ │ Trauma Checks │ └───────────────────────┘
                    │ Apply         │
                    └───────────────┘
```

### 3.3 Trauma Check Recovery Cascade

```
              Trauma Checks Initiated
                       │
        ┌──────────────┼──────────────┐
        │              │              │
        ▼              ▼              ▼
    Roll d20       Roll d20       Roll d20
   Trauma 1       Trauma 2       Trauma N
        │              │              │
    ┌───┴───┐      ┌───┴───┐      ┌───┴───┐
    │       │      │       │      │       │
   Pass   Fail   Pass   Fail   Pass   Fail
    │       │      │       │      │       │
    ▼       ▼      ▼       ▼      ▼       ▼
 Remove  Persist Remove Persist Remove Persist
 Trauma   +New   Trauma  +New   Trauma  +New
            Trauma         Trauma       Trauma
            │              │            │
            └──────────────┴────────────┘
                           │
                           ▼
            Record in RestIntegrationResult
```

---

## 4. User Stories

### US-18.5c-1: Process Unified Rest

**As a** rest system
**I want to** process rest through all trauma economy systems at once
**So that** rest creates appropriate stress recovery, resource resets, and trauma checks

**Acceptance Criteria:**

- Rest type determines recovery amount
- All specialization resources reset appropriately
- Trauma checks performed for all active traumas
- Party effects (if applicable) recorded
- Result object contains all changes
- No service called twice

### US-18.5c-2: Calculate Rest-Based Stress Recovery

**As a** stress recovery system
**I want to** provide different recovery based on rest type
**So that** different rest durations have appropriate mechanical benefits

**Acceptance Criteria:**

- Short rest recovers 5d4 + WILL stress
- Long rest fully recovers stress to 0
- Sanctuary rest fully recovers stress with additional CPS benefit
- Recovery formula is consistent and documented
- Result records recovery method used

### US-18.5c-3: Reset Specialization Resources on Rest

**As a** specialization resource system
**I want to** reset resource states during rest
**So that** resources like Rage and Momentum don't persist indefinitely

**Acceptance Criteria:**

- Rage resets to 0 on any rest
- Momentum resets to 0 on any rest
- Coherence (Arcanist) restores to 50 on Long/Sanctuary rest
- Resets recorded in result
- Each specialization optional (only if active)

### US-18.5c-4: Perform Trauma Recovery Checks

**As a** trauma recovery system
**I want to** give characters chance to heal traumas during long rest
**So that** traumas are not permanent but require effort to overcome

**Acceptance Criteria:**

- Trauma checks performed on Long/Sanctuary rest only
- Each trauma checked individually
- Success removes trauma
- Failure triggers new trauma acquisition
- Results recorded for each trauma

---

## 5. RestIntegrationResult Value Object

### 5.1 Purpose

Comprehensive record of all effects triggered by a rest event across all trauma economy systems.

### 5.2 Definition

**File:** `src/Core/RuneAndRust.Domain/ValueObjects/RestIntegrationResult.cs`

```csharp
namespace RuneAndRust.Domain.ValueObjects;

using RuneAndRust.Domain.Enums;

/// <summary>
/// Immutable value object representing the complete outcome of unified rest processing.
/// </summary>
/// <remarks>
/// <para>
/// Captures all effects triggered by a rest event across trauma economy systems:
/// stress recovery, resource resets, trauma checks, and party effects.
/// </para>
/// <para>
/// Used for:
/// • Logging rest events
/// • Applying recovery effects
/// • Generating rest narratives
/// • Creating save/replay data
/// </para>
/// </remarks>
/// <example>
/// <code>
/// var result = handler.ProcessRest(characterId, RestType.LongRest, partyContext);
/// logger.LogInformation("Rest complete: {StressRecovered} stress recovered, {TraumasAcquired} new traumas",
///     result.StressRecovered, result.TraumasAcquired?.Count ?? 0);
/// </code>
/// </example>
public readonly record struct RestIntegrationResult(
    RestType RestType,
    int StressRecovered,
    string StressRecoveryFormula,
    int CorruptionRecovered,
    bool CpsStageChanged,
    CpsStage? NewCpsStage,
    int TraumaChecksPerformed,
    IReadOnlyList<string>? TraumasAcquired,
    int? RagePartyBonus,
    int? CoherenceRestored,
    bool MomentumReset,
    IReadOnlyList<string> RecoveryMessages)
{
    #region Computed Properties

    /// <summary>
    /// Gets whether any new traumas were acquired during rest.
    /// </summary>
    public bool AcquiredNewTraumas =>
        TraumasAcquired?.Count > 0;

    /// <summary>
    /// Gets the total recovery benefit percentage (for UI display).
    /// </summary>
    public double RecoveryPercentage =>
        StressRecovered / 100.0;

    /// <summary>
    /// Gets whether this rest provided significant recovery.
    /// </summary>
    public bool IsSignificantRecovery =>
        RestType switch
        {
            RestType.LongRest => true,
            RestType.Sanctuary => true,
            RestType.ShortRest => StressRecovered >= 10,
            _ => false
        };

    #endregion

    #region Validation

    /// <summary>
    /// Validates result for consistency.
    /// </summary>
    public bool IsValid()
    {
        // Stress recovery should be non-negative
        if (StressRecovered < 0)
            return false;

        // Stress recovery shouldn't exceed max
        if (StressRecovered > 100)
            return false;

        // Corruption recovery should be non-negative
        if (CorruptionRecovered < 0)
            return false;

        // CPS stage change should match flag
        if (CpsStageChanged && !NewCpsStage.HasValue)
            return false;

        // Trauma checks should be non-negative
        if (TraumaChecksPerformed < 0)
            return false;

        // Party bonus should be non-negative if present
        if (RagePartyBonus.HasValue && RagePartyBonus < 0)
            return false;

        // Coherence restore should be non-negative if present
        if (CoherenceRestored.HasValue && CoherenceRestored < 0)
            return false;

        return true;
    }

    #endregion

    #region Factory Methods

    /// <summary>
    /// Creates a new RestIntegrationResult from components.
    /// </summary>
    public static RestIntegrationResult Create(
        RestType restType,
        int stressRecovered,
        string stressRecoveryFormula,
        int corruptionRecovered = 0,
        bool cpsStageChanged = false,
        CpsStage? newCpsStage = null,
        int traumaChecksPerformed = 0,
        IReadOnlyList<string>? traumasAcquired = null,
        int? ragePartyBonus = null,
        int? coherenceRestored = null,
        bool momentumReset = true,
        IReadOnlyList<string>? recoveryMessages = null)
    {
        return new RestIntegrationResult(
            RestType: restType,
            StressRecovered: stressRecovered,
            StressRecoveryFormula: stressRecoveryFormula,
            CorruptionRecovered: corruptionRecovered,
            CpsStageChanged: cpsStageChanged,
            NewCpsStage: newCpsStage,
            TraumaChecksPerformed: traumaChecksPerformed,
            TraumasAcquired: traumasAcquired ?? new List<string>().AsReadOnly(),
            RagePartyBonus: ragePartyBonus,
            CoherenceRestored: coherenceRestored,
            MomentumReset: momentumReset,
            RecoveryMessages: recoveryMessages ?? new List<string>().AsReadOnly()
        );
    }

    #endregion

    #region Display

    /// <inheritdoc/>
    public override string ToString() =>
        $"RestResult[{RestType}]: {StressRecovered} stress recovered, " +
        $"{TraumaChecksPerformed} trauma checks" +
        (CpsStageChanged ? $" [CPS STAGE → {NewCpsStage}]" : "") +
        (AcquiredNewTraumas ? $" [{TraumasAcquired?.Count} new traumas]" : "");

    #endregion
}

/// <summary>
/// Represents different types of rest and their effects.
/// </summary>
public enum RestType
{
    /// <summary>A short break (typically 1-2 hours).</summary>
    ShortRest = 0,

    /// <summary>A full night's sleep (8+ hours).</summary>
    LongRest = 1,

    /// <summary>Rest in a place of power (sanctified location, maximum recovery).</summary>
    Sanctuary = 2
}
```

---

## 6. UnifiedRestHandler Service

### 6.1 Purpose

Application service that orchestrates rest processing across all trauma economy systems.

### 6.2 Definition

**File:** `src/Application/RuneAndRust.Application/Services/UnifiedRestHandler.cs`

```csharp
namespace RuneAndRust.Application.Services;

using RuneAndRust.Domain.Entities;
using RuneAndRust.Domain.ValueObjects;
using RuneAndRust.Domain.Enums;
using Microsoft.Extensions.Logging;

/// <summary>
/// Coordinates rest processing across all trauma economy systems.
/// </summary>
/// <remarks>
/// <para>
/// Orchestrates the complete rest flow:
/// 1. Calculate stress recovery based on rest type
/// 2. Reset specialization resources
/// 3. Perform trauma recovery checks
/// 4. Apply party effects
/// 5. Aggregate result
/// </para>
/// </remarks>
public class UnifiedRestHandler
{
    private readonly IStressService _stressService;
    private readonly ICorruptionService _corruptionService;
    private readonly IRageService? _rageService;
    private readonly IMomentumService? _momentumService;
    private readonly ICoherenceService? _coherenceService;
    private readonly ITraumaService _traumaService;
    private readonly ISpecializationProvider _specializationProvider;
    private readonly IDiceService _diceService;
    private readonly ILogger<UnifiedRestHandler> _logger;

    public UnifiedRestHandler(
        IStressService stressService,
        ICorruptionService corruptionService,
        ITraumaService traumaService,
        ISpecializationProvider specializationProvider,
        IDiceService diceService,
        IRageService? rageService = null,
        IMomentumService? momentumService = null,
        ICoherenceService? coherenceService = null,
        ILogger<UnifiedRestHandler>? logger = null)
    {
        _stressService = stressService;
        _corruptionService = corruptionService;
        _traumaService = traumaService;
        _specializationProvider = specializationProvider;
        _diceService = diceService;
        _rageService = rageService;
        _momentumService = momentumService;
        _coherenceService = coherenceService;
        _logger = logger ?? NullLogger<UnifiedRestHandler>.Instance;
    }

    /// <summary>
    /// Processes rest through all trauma economy systems.
    /// </summary>
    /// <param name="characterId">The character resting.</param>
    /// <param name="restType">The type of rest.</param>
    /// <param name="partyContext">Optional party context for group effects.</param>
    /// <returns>Complete rest integration result.</returns>
    public RestIntegrationResult ProcessRest(
        Guid characterId,
        RestType restType,
        PartyContext? partyContext = null)
    {
        _logger.LogDebug("Processing {RestType} rest for {CharacterId}", restType, characterId);

        // 1. Calculate stress recovery
        var (stressRecovered, formula) = CalculateStressRecovery(characterId, restType);

        _logger.LogDebug("Stress recovery calculated: {Recovered} using {Formula}", stressRecovered, formula);

        // 2. Reset specialization resources
        ApplyResourceResets(characterId, restType);

        _logger.LogDebug("Specialization resources reset");

        // 3. Perform trauma checks
        var (checksPerformed, newTraumas) = PerformTraumaChecks(characterId, restType);

        _logger.LogDebug("Trauma checks: {Performed} checks, {AcquiredCount} new traumas", checksPerformed, newTraumas?.Count ?? 0);

        // 4. Check for CPS stage improvement
        var (cpsStageChanged, newCpsStage) = CheckCpsRecovery(characterId, restType);

        _logger.LogDebug("CPS stage recovery: Changed={Changed} NewStage={Stage}", cpsStageChanged, newCpsStage);

        // 5. Apply party effects
        var partyBonus = ApplyPartyEffects(characterId, restType, partyContext);

        _logger.LogDebug("Party effects applied: Rage bonus={Bonus}", partyBonus ?? 0);

        // 6. Build result
        var result = BuildResult(
            restType, stressRecovered, formula, checksPerformed, newTraumas,
            cpsStageChanged, newCpsStage, partyBonus);

        _logger.LogInformation("Rest processed: {@Result}", result);

        return result;
    }

    /// <summary>
    /// Calculates stress recovery based on rest type.
    /// </summary>
    private (int stressRecovered, string formula) CalculateStressRecovery(
        Guid characterId,
        RestType restType)
    {
        return restType switch
        {
            RestType.ShortRest =>
            {
                // 5d4 + WILL modifier
                var diceResult = _diceService.Roll(4, 5);
                var willModifier = 2; // TODO: Get from character attributes
                var total = diceResult + willModifier;
                return (total, "5d4 + WILL");
            },

            RestType.LongRest =>
            {
                // Full recovery to 0
                var currentStress = _stressService.GetStress(characterId).CurrentStress;
                return (currentStress, "Full recovery");
            },

            RestType.Sanctuary =>
            {
                // Full recovery with additional benefit (checked separately)
                var currentStress = _stressService.GetStress(characterId).CurrentStress;
                return (currentStress, "Full recovery + Sanctuary bonus");
            },

            _ => (0, "Unknown")
        };
    }

    /// <summary>
    /// Resets specialization resources based on rest type.
    /// </summary>
    private void ApplyResourceResets(Guid characterId, RestType restType)
    {
        // All rest types reset Rage and Momentum
        if (_rageService != null)
        {
            _rageService.ResetRage(characterId);
        }

        if (_momentumService != null)
        {
            _momentumService.ResetMomentum(characterId);
        }

        // Long/Sanctuary rest restores Coherence to 50 (Balanced)
        if ((restType == RestType.LongRest || restType == RestType.Sanctuary) && _coherenceService != null)
        {
            _coherenceService.RestoreToBalanced(characterId);
        }
    }

    /// <summary>
    /// Performs trauma recovery checks if rest type permits.
    /// </summary>
    private (int checksPerformed, IReadOnlyList<string>? traumasAcquired) PerformTraumaChecks(
        Guid characterId,
        RestType restType)
    {
        if (restType == RestType.ShortRest)
        {
            // Short rest doesn't perform trauma checks
            return (0, null);
        }

        // Long/Sanctuary perform checks
        var traumas = _traumaService.GetTraumas(characterId);
        var acquiredTraumas = new List<string>();

        foreach (var trauma in traumas)
        {
            // Roll recovery check (DC varies)
            var dc = restType == RestType.Sanctuary ? 3 : 4; // Sanctuary is easier
            var roll = _diceService.Roll(20, 1);

            if (roll >= dc)
            {
                // Success: remove trauma (handled by trauma service)
                _traumaService.RemoveTrauma(characterId, trauma.TraumaId);
            }
            else
            {
                // Failure: potential new trauma (depending on trauma type)
                var newTraumaId = _traumaService.MaybeAcquireNewTrauma(characterId, trauma);
                if (newTraumaId != null)
                    acquiredTraumas.Add(newTraumaId);
            }
        }

        return (traumas.Count, acquiredTraumas.AsReadOnly());
    }

    /// <summary>
    /// Checks for CPS stage improvement during rest.
    /// </summary>
    private (bool changed, CpsStage? newStage) CheckCpsRecovery(
        Guid characterId,
        RestType restType)
    {
        if (restType == RestType.ShortRest)
        {
            // Short rest doesn't improve CPS stage
            return (false, null);
        }

        // Long/Sanctuary rest may improve one stage
        var currentStress = _stressService.GetStress(characterId);
        var currentCps = CpsState.Create(currentStress.CurrentStress);

        if (currentCps.Stage == CpsStage.HollowShell && restType == RestType.Sanctuary)
        {
            // Sanctuary can improve terminal state (very rare)
            return (true, CpsStage.RuinMadness);
        }

        if (currentCps.Stage != CpsStage.None)
        {
            // Long/Sanctuary improve one stage
            var improvedStage = currentCps.Stage - 1;
            return (true, (CpsStage)improvedStage);
        }

        return (false, null);
    }

    /// <summary>
    /// Applies party-wide effects if applicable.
    /// </summary>
    private int? ApplyPartyEffects(Guid characterId, RestType restType, PartyContext? partyContext)
    {
        if (partyContext == null)
            return null;

        // Check if party has Berserker in FrenzyBeyondReason
        var berserkerInFrenzy = partyContext.Members.Any(m =>
            _specializationProvider.GetSpecializationType(m) == "rage" &&
            _rageService?.IsInFrenzyBeyondReason(m) == true
        );

        if (berserkerInFrenzy)
        {
            // Apply -10 stress bonus to all party members except berserker
            foreach (var memberId in partyContext.Members)
            {
                if (memberId != characterId) // Skip the berserker
                {
                    var currentStress = _stressService.GetStress(memberId);
                    var reduction = Math.Min(10, currentStress.CurrentStress);
                    _stressService.RemoveStress(memberId, reduction, StressSource.RestBonus);
                }
            }

            return 10;
        }

        return null;
    }

    /// <summary>
    /// Builds the complete result object.
    /// </summary>
    private RestIntegrationResult BuildResult(
        RestType restType,
        int stressRecovered,
        string formula,
        int checksPerformed,
        IReadOnlyList<string>? traumasAcquired,
        bool cpsStageChanged,
        CpsStage? newCpsStage,
        int? partyBonus)
    {
        var messages = new List<string>();

        messages.Add($"{restType} rest: {stressRecovered} stress recovered ({formula}).");

        if (cpsStageChanged)
            messages.Add($"Your mind stabilizes. CPS stage improved to {newCpsStage}.");

        if (checksPerformed > 0)
        {
            if (traumasAcquired?.Count > 0)
                messages.Add($"{checksPerformed} trauma checks—{traumasAcquired.Count} new wounds acquired.");
            else
                messages.Add($"{checksPerformed} trauma checks—all wounds are healing.");
        }

        if (partyBonus.HasValue)
            messages.Add($"The party's morale steadies under {partyBonus} stress reduction.");

        return RestIntegrationResult.Create(
            restType: restType,
            stressRecovered: stressRecovered,
            stressRecoveryFormula: formula,
            corruptionRecovered: 0,
            cpsStageChanged: cpsStageChanged,
            newCpsStage: newCpsStage,
            traumaChecksPerformed: checksPerformed,
            traumasAcquired: traumasAcquired,
            ragePartyBonus: partyBonus,
            coherenceRestored: restType != RestType.ShortRest ? 50 : null,
            momentumReset: true,
            recoveryMessages: messages.AsReadOnly()
        );
    }
}

/// <summary>
/// Context information for party-wide rest effects.
/// </summary>
public record PartyContext(
    IReadOnlyList<Guid> Members);
```

---

## 7. Rest Type Effects

### 7.1 Short Rest (5d4 + WILL)

| System        | Effect                              |
| ------------- | ----------------------------------- |
| Stress        | Recover 5d4 + WILL modifier         |
| Corruption    | No recovery                         |
| CPS Stage     | No improvement                      |
| Rage          | Reset to 0                          |
| Momentum      | Reset to 0                          |
| Coherence     | No change                           |
| Trauma Checks | Not performed                       |
| Party Effects | None                                |

### 7.2 Long Rest (Full Recovery)

| System        | Effect                              |
| ------------- | ----------------------------------- |
| Stress        | Full recovery to 0                  |
| Corruption    | No recovery                         |
| CPS Stage     | May improve one stage               |
| Rage          | Reset to 0                          |
| Momentum      | Reset to 0                          |
| Coherence     | Restore to 50 (Balanced)            |
| Trauma Checks | Perform for all active traumas      |
| Party Effects | Apply Berserker Frenzy bonus        |

### 7.3 Sanctuary Rest (Full + Bonus)

| System        | Effect                              |
| ------------- | ----------------------------------- |
| Stress        | Full recovery to 0                  |
| Corruption    | No recovery                         |
| CPS Stage     | May improve one stage (easier)      |
| Rage          | Reset to 0                          |
| Momentum      | Reset to 0                          |
| Coherence     | Restore to 50 (Balanced)            |
| Trauma Checks | Perform with easier DC              |
| Party Effects | Apply Berserker Frenzy bonus        |

### 7.4 Party Rage Bonus

If party contains Berserker in `FrenzyBeyondReason`:

- All other party members gain -10 stress on next rest
- Berserker's rage inspires (or terrifies) party into relative calm
- Only applies to Long/Sanctuary rest

---

## 8. Logging Specifications

### 8.1 Application Layer Logging

| Event                           | Level       | Template                                                      |
| ------------------------------- | ----------- | ------------------------------------------------------------- |
| Rest Processing Started         | Debug       | `"Processing {RestType} rest for {CharacterId}"`              |
| Stress Recovery Calculated      | Debug       | `"Stress recovery: {Amount} using {Formula}"`                 |
| Resources Reset                 | Debug       | `"Specialization resources reset: Rage, Momentum, Coherence"` |
| Trauma Checks Completed         | Debug       | `"Trauma checks: {Count} checks, {AcquiredCount} new traumas"`|
| CPS Stage Improved              | Information | `"CPS stage improved to {NewStage}"`                          |
| Party Effects Applied           | Debug       | `"Party bonus applied: -10 stress for {MemberCount} members"` |
| Rest Processing Complete        | Information | `"Rest complete: {@Result}"`                                  |

---

## 9. Unit Testing Requirements

### 9.1 Test File Location

**File:** `tests/RuneAndRust.Application.UnitTests/Services/UnifiedRestHandlerTests.cs`

### 9.2 Required Tests

| Test Name                                           | Description                         |
| --------------------------------------------------- | ----------------------------------- |
| `ProcessRest_ShortRest_Recovery5d4PlusWill`         | Short rest uses correct formula      |
| `ProcessRest_LongRest_FullRecoveryAndTraumaChecks`  | Long rest recovers fully and checks  |
| `ProcessRest_ResourceResets_RageAndMomentumTo0`     | Rage/Momentum reset on rest          |
| `ProcessRest_PartyBerserkerFrenzy_ApplesBonus`      | Party bonus applies if conditions met|

### 9.3 Example Test

```csharp
[TestFixture]
public class UnifiedRestHandlerTests
{
    private UnifiedRestHandler _handler;
    private IStressService _stressService;
    private IDiceService _diceService;

    [SetUp]
    public void SetUp()
    {
        _stressService = Substitute.For<IStressService>();
        _diceService = Substitute.For<IDiceService>();
        var corruptionService = Substitute.For<ICorruptionService>();
        var traumaService = Substitute.For<ITraumaService>();
        var specializationProvider = Substitute.For<ISpecializationProvider>();

        _diceService.Roll(4, 5).Returns(15);

        _handler = new UnifiedRestHandler(
            _stressService,
            corruptionService,
            traumaService,
            specializationProvider,
            _diceService
        );
    }

    [Test]
    public void ProcessRest_LongRest_RecoveredStressIsZero()
    {
        // Arrange
        var characterId = Guid.NewGuid();
        var stressState = StressState.Create(60);
        _stressService.GetStress(characterId).Returns(stressState);

        // Act
        var result = _handler.ProcessRest(characterId, RestType.LongRest);

        // Assert
        result.RestType.Should().Be(RestType.LongRest);
        result.StressRecovered.Should().Be(60); // Full recovery
        result.RecoveryMessages.Should().Contain(m => m.Contains("Full recovery"));
    }

    [Test]
    public void ProcessRest_ValidResult_PassesValidation()
    {
        // Arrange
        var result = _handler.ProcessRest(Guid.NewGuid(), RestType.ShortRest);

        // Assert
        result.IsValid().Should().BeTrue();
    }
}
```

---

## 10. Deliverable Checklist

### 10.1 Domain Layer

- [ ] `src/Core/RuneAndRust.Domain/ValueObjects/RestIntegrationResult.cs`
- [ ] `src/Core/RuneAndRust.Domain/Enums/RestType.cs` (if separate)

### 10.2 Application Layer

- [ ] `src/Application/RuneAndRust.Application/Services/UnifiedRestHandler.cs`

### 10.3 Tests

- [ ] `tests/RuneAndRust.Application.UnitTests/Services/UnifiedRestHandlerTests.cs`

### 10.4 Documentation

- [ ] Update scope breakdown (mark v0.18.5c complete)
- [ ] Create changelog for v0.18.5c

---

## 11. Acceptance Criteria

### 11.1 Build Verification

- [ ] Solution builds without errors
- [ ] Solution builds without warnings in new code

### 11.2 Test Verification

- [ ] All new unit tests pass
- [ ] All existing unit tests continue to pass

### 11.3 Functional Verification

- [ ] Short rest uses 5d4 + WILL formula
- [ ] Long rest fully recovers stress to 0
- [ ] Sanctuary rest fully recovers stress
- [ ] CPS stage may improve on Long/Sanctuary rest
- [ ] Rage resets to 0 on any rest
- [ ] Momentum resets to 0 on any rest
- [ ] Coherence restores to 50 on Long/Sanctuary rest
- [ ] Trauma checks performed only on Long/Sanctuary rest
- [ ] Berserker party bonus applies correctly (-10 stress)
- [ ] RestIntegrationResult validates correctly
- [ ] Recovery messages generated appropriately
- [ ] All transition effects recorded in result

---

## 12. Dependencies

### 12.1 Required Prerequisites

| Dependency                | Version | Status   | Notes                                  |
| ------------------------- | ------- | -------- | -------------------------------------- |
| TraumaEconomyState        | v0.18.5a | Required | Query character state                  |
| Psychic Stress System     | v0.18.0 | Required | Apply stress recovery                  |
| Specialization Resources  | v0.18.4 | Required | Reset Rage, Momentum, Coherence        |
| Trauma System             | v0.18.3 | Required | Perform trauma checks                  |
| Dice Service              | v0.6.x  | Required | Roll trauma checks, recovery dice      |

### 12.2 Provides to v0.18.5d-e

| Type                     | Usage                                      |
| ------------------------ | ------------------------------------------ |
| `RestIntegrationResult`  | Base rest result for logging               |
| `UnifiedRestHandler`     | Used by orchestration service              |

---

## 13. Future Considerations

### 13.1 Extended Rest Types

- Ritual rest (meditation, prayer)
- Combat rest (emergency recovery in field)
- Forced rest (recovery from exhaustion)

### 13.2 Rest Modifiers

- Location quality (bed quality, environmental safety)
- Companion benefits (healing touch, emotional support)
- Environmental hazards (nightmares, disturbances)

### 13.3 Long-Term Recovery

- Multi-day recovery for severe trauma
- Sanctuary automation for repeated visits
- Recovery tracking over campaign time

---

_This design specification provides the detailed blueprint for implementing v0.18.5c Rest Integration. It forms the foundation for unified rest processing across the trauma economy._

---

## Changelog

| Version | Date       | Changes                          |
| ------- | ---------- | -------------------------------- |
| 1.0     | 2026-01-28 | Initial design specification     |
