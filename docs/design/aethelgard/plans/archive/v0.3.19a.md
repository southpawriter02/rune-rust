> **Archived** - This plan has been consolidated. See the complete version at [v0.3.19](../v0.3.x/v0.3.19.md).

# v0.3.19a: The Instrument

This sub-version establishes the infrastructure for auditory feedback. It decouples the intent to make a sound from the method of playback, allowing the game to switch between primitive Console Beeps (for the TUI) and complex Audio Engines (for the future GUI) without changing game logic.

Goal: Define the IAudioService contract, implement the data models for sound cues, and create a cross-platform ConsoleAudioProvider that respects global settings.

1. Architecture & Data Flow
The system uses the Provider Pattern. The Game Engine requests a sound by ID (e.g., "UI_CLICK"), and the AudioService resolves it to a SoundCue. The service checks settings (Volume), then delegates execution to the registered IAudioProvider.
Data Flow: The Playback Pipeline
	1	Request: Game Logic calls AudioService.PlayAsync(SoundCue).
	2	Validation: Service checks GameSettings.MasterVolume.
	◦	If 0 (Mute), return immediately.
	3	Dispatch: Service calls IAudioProvider.PlayAsync(cue).
	4	Execution (Terminal): ConsoleAudioProvider wraps System.Console.Beep() in a background task to prevent blocking the UI thread.

2. Logic Decision Trees
A. Playback Logic Input: SoundCue (Frequency, Duration), MasterVolume
	1	Volume Check: Is MasterVolume > 0?
	◦	No: Log "Skipped (Muted)". Stop.
	2	Platform Check: Is the OS Windows? (Console.Beep support varies on *nix).
	◦	No: Log "Skipped (Platform)". Stop (unless using ANSI bell).
	3	Execution:
	◦	Wrap Console.Beep(Frequency, Duration) in Task.Run.
	◦	Note: Console.Beep is blocking; async wrapper is mandatory to keep TUI responsive.
B. Cue Selection Logic Input: SoundType (e.g., UI, Combat)
	1	UI Sound: Use High Pitch (800-1200Hz), Short Duration (50-100ms).
	2	Combat Hit: Use Mid Pitch (300-500Hz), Medium Duration (150ms).
	3	Ambience: (Placeholder for v0.3.19c) Ignore for Console Provider (Beeps cannot loop effectively).

3. Code Implementation
A. Core Models (Data Definitions) File: RuneAndRust.Core/Models/SoundCue.cs
public enum SoundCategory { UI, Combat, Ambience, Alert }

public record SoundCue(
    string Id,
    SoundCategory Category,
    int Frequency,   // In Hertz (e.g., 440)
    int DurationMs,  // In Milliseconds
    float VolumeMultiplier = 1.0f
)
{
    // Pre-configured static cues for consistency
    public static SoundCue UiClick => new("ui_click", SoundCategory.UI, 1000, 50);
    public static SoundCue Error => new("ui_error", SoundCategory.UI, 200, 300);
}
B. Service Interface File: RuneAndRust.Core/Interfaces/IAudioService.cs
public interface IAudioService
{
    Task PlayAsync(SoundCue cue);
    Task PlaySystemCueAsync(string cueId); // Lookup wrapper
    bool IsMuted { get; }
}

public interface IAudioProvider
{
    Task PlayAsync(SoundCue cue, int masterVolume);
}
C. Terminal Provider Implementation File: RuneAndRust.Terminal/Services/ConsoleAudioProvider.cs
public class ConsoleAudioProvider : IAudioProvider
{
    public async Task PlayAsync(SoundCue cue, int masterVolume)
    {
        // Console.Beep doesn't support volume amplitude,
        // so we treat masterVolume as a simple on/off gate here,
        // or potentially scale duration for emphasis.

        if (OperatingSystem.IsWindows())
        {
            // Fire and forget to prevent UI blocking
            await Task.Run(() =>
            {
                try
                {
                    Console.Beep(cue.Frequency, cue.DurationMs);
                }
                catch
                {
                    // Swallow hardware errors (no speakers, etc)
                }
            });
        }
        else
        {
            // Fallback for *nix/Mac (Standard Bell)
            Console.Write("\a");
        }
    }
}

4. Deliverable Checklist (v0.3.19a)
	•	Core:
	◦	[ ] Define SoundCategory enum.
	◦	[ ] Define SoundCue record.
	◦	[ ] Define IAudioService and IAudioProvider interfaces.
	•	Engine:
	◦	[ ] Implement AudioService.
	◦	[ ] Integrate GameSettings.MasterVolume check [Source 3389].
	•	Terminal:
	◦	[ ] Implement ConsoleAudioProvider with Windows/Linux differentiation.
	◦	[ ] Register services in Program.cs.
	•	Tests:
	◦	[ ] Verify mute logic works.
	◦	[ ] Verify provider is called when volume is up.

5. Logging Requirements
Reference: logging.md
System
Event
Level
Message Template
Properties
Audio
Play Request
Trace
"[Audio] Requesting cue: {CueId} ({Freq}Hz/{Dur}ms)"
CueId, Freq, Dur
Audio
Muted
Trace
"[Audio] Skipped {CueId} (MasterVolume: 0)"
CueId
Audio
Execution
Debug
"[Audio] Provider executing {CueId}"
CueId

6. Testing Strategy
Unit Tests (AudioServiceTests.cs):
	•	Play_RespectsMute:
	◦	Set GameSettings.MasterVolume = 0.
	◦	Call PlayAsync(SoundCue.UiClick).
	◦	Assert: MockProvider.Verify(x => x.PlayAsync(...), Times.Never).
	•	Play_PassesCue:
	◦	Set Volume = 100.
	◦	Call PlayAsync(SoundCue.UiClick).
	◦	Assert: MockProvider.Verify(x => x.PlayAsync(SoundCue.UiClick, 100), Times.Once).
Manual QA:
	•	Terminal Test:
	◦	Run application.
	◦	Triggers are not wired yet, so temporary injection in MainMenuController is needed.
	◦	Navigating menu should produce Beeps (if wired temporarily).

7. Draft Changelog (v0.3.19a)
# Changelog: v0.3.19a - The Instrument

**Release Date:** 2026-02-XX

## Summary
The first phase of "The Bard" milestone establishes the audio infrastructure. The engine can now issue sound requests which are handled by a platform-specific provider.

## Changes
- **Core:** Added `SoundCue` model and `IAudioService` interface.
- **Engine:** Implemented `AudioService` with Master Volume filtering.
- **Terminal:** Implemented `ConsoleAudioProvider` using system beeps for TUI feedback.
- **System:** Added platform detection to handle audio differences between Windows and Linux/macOS.
