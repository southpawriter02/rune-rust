# v0.20.0 Scope Breakdown: Legacy Class Removal & Migration

## Overview

v0.20.0 removes all placeholder/generic class definitions from the codebase and establishes the migration infrastructure for existing characters. This is a foundational cleanup version that prepares the system for the Aethelgard-specific specialization implementations in v0.20.1-v0.20.8.

---

## In Scope

### Domain Layer

#### Enumerations

| Enum | Purpose | Changes |
|------|---------|---------|
| `LegacyClassId` | Identifies deprecated generic classes for migration | `Rogue`, `Fighter`, `Mage`, `Healer`, `Scholar`, `Crafter` |
| `MigrationStatus` | Tracks character migration state | `Pending`, `InProgress`, `Completed`, `Failed` |

#### Value Objects

| Value Object | Purpose |
|--------------|---------|
| `LegacyClassMapping` | Maps legacy class to replacement archetype and suggested specializations |
| `MigrationResult` | Outcome of a character migration attempt |
| `AbilitySlotPreparation` | Configuration for specialization ability slot system |
| `SpecializationPrerequisite` | Validation rules for specialization selection |

#### Entities

| Entity | Purpose |
|--------|---------|
| `CharacterMigration` | Tracks migration state for a specific character |
| `MigrationLog` | Audit trail of migration actions and PP refunds |

### Application Layer

#### Interfaces

| Interface | Purpose |
|-----------|---------|
| `ILegacyClassDetectionService` | Identifies characters with legacy classes |
| `ICharacterMigrationService` | Orchestrates character migration to archetypes |
| `ISpecializationPrerequisiteService` | Validates specialization selection prerequisites |
| `IAbilitySlotService` | Manages specialization ability slot preparation |

#### Implementations

| Implementation | Purpose |
|----------------|---------|
| `LegacyClassDetectionService` | Scans for legacy class usage in characters |
| `CharacterMigrationService` | Executes migration workflow |
| `SpecializationPrerequisiteService` | Enforces archetype-specialization relationships |
| `AbilitySlotService` | Initializes ability slot structure for specializations |

### Infrastructure Layer

#### Configuration

| File | Purpose |
|------|---------|
| `legacy_class_mappings.json` | Maps legacy classes to archetypes and specializations |
| `legacy_class_mappings.schema.json` | JSON Schema for validation |

---

## Out of Scope (Deferred to v0.20.1+)

- Individual specialization ability implementations (v0.20.1-v0.20.8)
- Special resource mechanics (Rage, Block Charges, etc.)
- Tier-specific ability unlocking
- Specialization-specific UI rendering
- Corruption risk mechanics for Heretical specializations

---

## Domain Layer Specifications

### LegacyClassId Enum

```csharp
/// <summary>
/// Identifies deprecated generic character classes that must be migrated
/// to Aethelgard-specific archetypes and specializations.
/// </summary>
/// <remarks>
/// These classes exist only for migration purposes. No new characters
/// should be created with these classes after v0.20.0.
/// </remarks>
public enum LegacyClassId
{
    /// <summary>Generic stealth/thief class. Migrates to Skirmisher archetype.</summary>
    Rogue,

    /// <summary>Generic melee combat class. Migrates to Warrior archetype.</summary>
    Fighter,

    /// <summary>Generic spellcaster class. Migrates to Mystic archetype.</summary>
    Mage,

    /// <summary>Generic support/healing class. Migrates to Adept archetype.</summary>
    Healer,

    /// <summary>Generic knowledge class. Migrates to Adept archetype.</summary>
    Scholar,

    /// <summary>Generic crafting class. Migrates to Adept archetype.</summary>
    Crafter
}
```

### MigrationStatus Enum

```csharp
/// <summary>
/// Tracks the state of a character's migration from legacy class to archetype.
/// </summary>
public enum MigrationStatus
{
    /// <summary>Character identified for migration but not yet processed.</summary>
    Pending,

    /// <summary>Migration in progress (archetype assigned, awaiting specialization).</summary>
    InProgress,

    /// <summary>Migration completed successfully.</summary>
    Completed,

    /// <summary>Migration failed due to validation or system error.</summary>
    Failed
}
```

### LegacyClassMapping Value Object

```csharp
/// <summary>
/// Defines the migration path from a legacy class to an Aethelgard archetype.
/// </summary>
public sealed record LegacyClassMapping
{
    /// <summary>The legacy class being migrated from.</summary>
    public required LegacyClassId LegacyClass { get; init; }

    /// <summary>The target archetype for migration.</summary>
    public required Archetype TargetArchetype { get; init; }

    /// <summary>Suggested specializations for this migration path.</summary>
    public required IReadOnlyList<SpecializationId> SuggestedSpecializations { get; init; }

    /// <summary>Description of the migration for player-facing UI.</summary>
    public required string MigrationDescription { get; init; }

    /// <summary>Whether this migration grants a free specialization selection.</summary>
    public bool GrantsFreeSpecialization { get; init; } = true;
}
```

### MigrationResult Value Object

```csharp
/// <summary>
/// Outcome of a character migration attempt.
/// </summary>
public sealed record MigrationResult
{
    /// <summary>Character ID that was migrated.</summary>
    public required Guid CharacterId { get; init; }

    /// <summary>Legacy class that was removed.</summary>
    public required LegacyClassId OriginalClass { get; init; }

    /// <summary>Archetype assigned during migration.</summary>
    public required Archetype AssignedArchetype { get; init; }

    /// <summary>Specialization selected (if any).</summary>
    public SpecializationId? SelectedSpecialization { get; init; }

    /// <summary>PP refunded for incompatible abilities.</summary>
    public required int PpRefunded { get; init; }

    /// <summary>Abilities that were preserved during migration.</summary>
    public required IReadOnlyList<string> PreservedAbilities { get; init; }

    /// <summary>Abilities that were removed (incompatible).</summary>
    public required IReadOnlyList<string> RemovedAbilities { get; init; }

    /// <summary>Final migration status.</summary>
    public required MigrationStatus Status { get; init; }

    /// <summary>Error message if migration failed.</summary>
    public string? ErrorMessage { get; init; }

    /// <summary>Timestamp of migration completion.</summary>
    public required DateTime CompletedAt { get; init; }
}
```

### AbilitySlotPreparation Value Object

```csharp
/// <summary>
/// Configuration for a specialization's ability slot structure.
/// Prepares the character for ability unlocking in v0.20.1+.
/// </summary>
public sealed record AbilitySlotPreparation
{
    /// <summary>Character ID receiving ability slots.</summary>
    public required Guid CharacterId { get; init; }

    /// <summary>Specialization receiving slots.</summary>
    public required SpecializationId SpecializationId { get; init; }

    /// <summary>Tier 1 ability slots (3 slots, all unlocked free).</summary>
    public required int Tier1Slots { get; init; }

    /// <summary>Tier 2 ability slots (3 slots, locked until 8 PP invested).</summary>
    public required int Tier2Slots { get; init; }

    /// <summary>Tier 3 ability slots (2 slots, locked until 16 PP invested).</summary>
    public required int Tier3Slots { get; init; }

    /// <summary>Capstone slot (1 slot, locked until 24 PP invested).</summary>
    public required int CapstoneSlots { get; init; }

    /// <summary>Total ability slots for this specialization.</summary>
    public int TotalSlots => Tier1Slots + Tier2Slots + Tier3Slots + CapstoneSlots;
}
```

### SpecializationPrerequisite Value Object

```csharp
/// <summary>
/// Validation rules for specialization selection.
/// </summary>
public sealed record SpecializationPrerequisite
{
    /// <summary>Specialization requiring prerequisites.</summary>
    public required SpecializationId SpecializationId { get; init; }

    /// <summary>Required parent archetype.</summary>
    public required Archetype RequiredArchetype { get; init; }

    /// <summary>Minimum PP invested in archetype tree (0 for first spec).</summary>
    public required int MinimumArchetypePP { get; init; }

    /// <summary>PP cost to unlock this specialization (0 for first, 3 for additional).</summary>
    public required int UnlockCost { get; init; }

    /// <summary>Whether this is available as a free first specialization.</summary>
    public required bool AvailableAsFreeSelection { get; init; }

    /// <summary>Other specializations that must be unlocked first (if any).</summary>
    public IReadOnlyList<SpecializationId>? RequiredSpecializations { get; init; }
}
```

### CharacterMigration Entity

```csharp
/// <summary>
/// Tracks migration state for a specific character transitioning from
/// legacy class to Aethelgard archetype/specialization system.
/// </summary>
public sealed class CharacterMigration
{
    /// <summary>Unique migration record ID.</summary>
    public required Guid Id { get; init; }

    /// <summary>Character being migrated.</summary>
    public required Guid CharacterId { get; init; }

    /// <summary>Original legacy class being replaced.</summary>
    public required LegacyClassId OriginalClass { get; init; }

    /// <summary>Target archetype for migration.</summary>
    public required Archetype TargetArchetype { get; init; }

    /// <summary>Current migration status.</summary>
    public MigrationStatus Status { get; private set; } = MigrationStatus.Pending;

    /// <summary>Selected specialization (null until player chooses).</summary>
    public SpecializationId? SelectedSpecialization { get; private set; }

    /// <summary>PP refunded for removed abilities.</summary>
    public int PpRefunded { get; private set; } = 0;

    /// <summary>When migration was initiated.</summary>
    public required DateTime CreatedAt { get; init; }

    /// <summary>When migration was completed (null if incomplete).</summary>
    public DateTime? CompletedAt { get; private set; }

    /// <summary>Error message if migration failed.</summary>
    public string? ErrorMessage { get; private set; }

    /// <summary>
    /// Begins the migration process by assigning the archetype.
    /// </summary>
    public void BeginMigration()
    {
        if (Status != MigrationStatus.Pending)
            throw new InvalidOperationException($"Cannot begin migration in {Status} state.");

        Status = MigrationStatus.InProgress;
    }

    /// <summary>
    /// Records the player's specialization selection.
    /// </summary>
    public void SelectSpecialization(SpecializationId specialization)
    {
        if (Status != MigrationStatus.InProgress)
            throw new InvalidOperationException($"Cannot select specialization in {Status} state.");

        SelectedSpecialization = specialization;
    }

    /// <summary>
    /// Records PP refunded from incompatible abilities.
    /// </summary>
    public void RecordRefund(int ppAmount)
    {
        if (ppAmount < 0)
            throw new ArgumentException("PP refund cannot be negative.");

        PpRefunded += ppAmount;
    }

    /// <summary>
    /// Completes the migration successfully.
    /// </summary>
    public void Complete()
    {
        if (Status != MigrationStatus.InProgress)
            throw new InvalidOperationException($"Cannot complete migration in {Status} state.");

        if (SelectedSpecialization is null)
            throw new InvalidOperationException("Must select specialization before completing migration.");

        Status = MigrationStatus.Completed;
        CompletedAt = DateTime.UtcNow;
    }

    /// <summary>
    /// Marks the migration as failed.
    /// </summary>
    public void Fail(string errorMessage)
    {
        Status = MigrationStatus.Failed;
        ErrorMessage = errorMessage;
        CompletedAt = DateTime.UtcNow;
    }
}
```

### MigrationLog Entity

```csharp
/// <summary>
/// Audit trail entry for migration actions.
/// </summary>
public sealed class MigrationLog
{
    /// <summary>Unique log entry ID.</summary>
    public required Guid Id { get; init; }

    /// <summary>Associated migration record.</summary>
    public required Guid MigrationId { get; init; }

    /// <summary>Character affected.</summary>
    public required Guid CharacterId { get; init; }

    /// <summary>Type of action logged.</summary>
    public required string ActionType { get; init; }

    /// <summary>Detailed description of the action.</summary>
    public required string Description { get; init; }

    /// <summary>PP affected by this action (positive = refund, negative = cost).</summary>
    public int PpDelta { get; init; } = 0;

    /// <summary>Abilities affected (if any).</summary>
    public IReadOnlyList<string>? AffectedAbilities { get; init; }

    /// <summary>When this action occurred.</summary>
    public required DateTime Timestamp { get; init; }
}
```

---

## Application Layer Specifications

### ILegacyClassDetectionService Interface

```csharp
/// <summary>
/// Identifies characters with legacy class assignments that require migration.
/// </summary>
public interface ILegacyClassDetectionService
{
    /// <summary>Gets all characters with legacy classes.</summary>
    IReadOnlyList<(Guid CharacterId, LegacyClassId LegacyClass)> GetCharactersWithLegacyClasses();

    /// <summary>Checks if a character has a legacy class.</summary>
    bool HasLegacyClass(Guid characterId);

    /// <summary>Gets the legacy class for a character (null if none).</summary>
    LegacyClassId? GetLegacyClass(Guid characterId);

    /// <summary>Gets count of characters requiring migration.</summary>
    int GetPendingMigrationCount();
}
```

### ICharacterMigrationService Interface

```csharp
/// <summary>
/// Orchestrates character migration from legacy classes to archetypes.
/// </summary>
public interface ICharacterMigrationService
{
    /// <summary>Gets the migration mapping for a legacy class.</summary>
    LegacyClassMapping GetMappingForLegacyClass(LegacyClassId legacyClass);

    /// <summary>Initiates migration for a character.</summary>
    CharacterMigration InitiateMigration(Guid characterId);

    /// <summary>Gets available specializations for a migration in progress.</summary>
    IReadOnlyList<SpecializationId> GetAvailableSpecializations(Guid migrationId);

    /// <summary>Selects a specialization for the migration.</summary>
    void SelectSpecialization(Guid migrationId, SpecializationId specialization);

    /// <summary>Completes the migration, applying all changes.</summary>
    MigrationResult CompleteMigration(Guid migrationId);

    /// <summary>Gets migration status for a character.</summary>
    CharacterMigration? GetMigrationStatus(Guid characterId);

    /// <summary>Gets all migration logs for a character.</summary>
    IReadOnlyList<MigrationLog> GetMigrationLogs(Guid characterId);
}
```

### ISpecializationPrerequisiteService Interface

```csharp
/// <summary>
/// Validates specialization selection prerequisites.
/// </summary>
public interface ISpecializationPrerequisiteService
{
    /// <summary>Gets prerequisites for a specialization.</summary>
    SpecializationPrerequisite GetPrerequisites(SpecializationId specialization);

    /// <summary>Checks if a character can select a specialization.</summary>
    bool CanSelectSpecialization(Guid characterId, SpecializationId specialization);

    /// <summary>Gets all specializations available to a character.</summary>
    IReadOnlyList<SpecializationId> GetAvailableSpecializations(Guid characterId);

    /// <summary>Validates that a specialization belongs to the character's archetype.</summary>
    bool ValidateArchetypeCompatibility(Archetype archetype, SpecializationId specialization);

    /// <summary>Gets the PP cost to unlock a specialization for a character.</summary>
    int GetUnlockCost(Guid characterId, SpecializationId specialization);
}
```

### IAbilitySlotService Interface

```csharp
/// <summary>
/// Manages specialization ability slot preparation.
/// </summary>
public interface IAbilitySlotService
{
    /// <summary>Initializes ability slots for a character's specialization.</summary>
    AbilitySlotPreparation InitializeAbilitySlots(Guid characterId, SpecializationId specialization);

    /// <summary>Gets the current ability slot configuration for a character.</summary>
    AbilitySlotPreparation? GetAbilitySlots(Guid characterId, SpecializationId specialization);

    /// <summary>Checks if a tier is unlocked for a character's specialization.</summary>
    bool IsTierUnlocked(Guid characterId, SpecializationId specialization, int tier);

    /// <summary>Gets the PP investment required to unlock the next tier.</summary>
    int GetNextTierUnlockCost(Guid characterId, SpecializationId specialization);
}
```

---

## Migration Flow

```
┌─────────────────────────────────────────────────────────────────┐
│                    CHARACTER MIGRATION FLOW                       │
└─────────────────────────────────────────────────────────────────┘

    Character with Legacy Class (e.g., "Fighter")
           │
           ▼
┌─────────────────────────────────────────────────────────────────┐
│                   STEP 1: DETECTION                              │
├─────────────────────────────────────────────────────────────────┤
│  ILegacyClassDetectionService.HasLegacyClass(characterId)       │
│  └── Returns: true, LegacyClassId.Fighter                       │
└─────────────────────────────────────────────────────────────────┘
           │
           ▼
┌─────────────────────────────────────────────────────────────────┐
│                   STEP 2: INITIATE MIGRATION                     │
├─────────────────────────────────────────────────────────────────┤
│  ICharacterMigrationService.InitiateMigration(characterId)      │
│  ├── Creates CharacterMigration record                          │
│  ├── Maps Fighter → Warrior archetype                           │
│  ├── Status: Pending → InProgress                               │
│  └── Logs: "Migration initiated for Fighter → Warrior"          │
└─────────────────────────────────────────────────────────────────┘
           │
           ▼
┌─────────────────────────────────────────────────────────────────┐
│                   STEP 3: EVALUATE ABILITIES                     │
├─────────────────────────────────────────────────────────────────┤
│  Scan character's existing abilities:                           │
│  ├── Compatible abilities: Preserved                            │
│  ├── Incompatible abilities: Removed, PP refunded               │
│  └── Logs: "Refunded 12 PP for 3 incompatible abilities"        │
└─────────────────────────────────────────────────────────────────┘
           │
           ▼
┌─────────────────────────────────────────────────────────────────┐
│                   STEP 4: SPECIALIZATION SELECTION               │
├─────────────────────────────────────────────────────────────────┤
│  GetAvailableSpecializations() returns:                         │
│  ├── Skjaldmær (Recommended - defensive Fighter)                │
│  ├── Berserkr (aggressive Fighter)                              │
│  └── Player selects: Skjaldmær                                  │
│                                                                  │
│  First specialization is FREE (no PP cost)                      │
└─────────────────────────────────────────────────────────────────┘
           │
           ▼
┌─────────────────────────────────────────────────────────────────┐
│                   STEP 5: PREPARE ABILITY SLOTS                  │
├─────────────────────────────────────────────────────────────────┤
│  IAbilitySlotService.InitializeAbilitySlots()                   │
│  ├── Tier 1: 3 slots (FREE - unlocked immediately)              │
│  ├── Tier 2: 3 slots (locked until 8 PP invested)               │
│  ├── Tier 3: 2 slots (locked until 16 PP invested)              │
│  └── Capstone: 1 slot (locked until 24 PP invested)             │
└─────────────────────────────────────────────────────────────────┘
           │
           ▼
┌─────────────────────────────────────────────────────────────────┐
│                   STEP 6: COMPLETE MIGRATION                     │
├─────────────────────────────────────────────────────────────────┤
│  ICharacterMigrationService.CompleteMigration()                 │
│  ├── Removes legacy class from character                        │
│  ├── Assigns Warrior archetype                                  │
│  ├── Assigns Skjaldmær specialization                           │
│  ├── Status: InProgress → Completed                             │
│  └── Returns: MigrationResult                                   │
└─────────────────────────────────────────────────────────────────┘
           │
           ▼
    Character now has:
    ├── Archetype: Warrior
    ├── Specialization: Skjaldmær
    ├── Ability Slots: Prepared for v0.20.1 abilities
    └── Refunded PP: Available for new abilities
```

---

## Legacy Class Mapping Configuration

### legacy_class_mappings.json

```json
{
  "version": "0.20.0",
  "mappings": [
    {
      "legacyClass": "Rogue",
      "targetArchetype": "Skirmisher",
      "suggestedSpecializations": ["MyrkGengr", "Strandhogg"],
      "migrationDescription": "Your shadowy skills translate well to the Skirmisher's path. Consider the Myrk-gengr for stealth mastery or Strandhögg for tactical raiding.",
      "grantsFreeSpecialization": true
    },
    {
      "legacyClass": "Fighter",
      "targetArchetype": "Warrior",
      "suggestedSpecializations": ["Skjaldmaer", "Berserkr"],
      "migrationDescription": "Your combat prowess aligns with the Warrior's discipline. The Skjaldmær offers defensive mastery, while the Berserkr unleashes raw fury.",
      "grantsFreeSpecialization": true
    },
    {
      "legacyClass": "Mage",
      "targetArchetype": "Mystic",
      "suggestedSpecializations": ["Seidkona"],
      "migrationDescription": "Your arcane knowledge resonates with the Mystic's path. The Seiðkona tradition offers mastery over Aether itself.",
      "grantsFreeSpecialization": true
    },
    {
      "legacyClass": "Healer",
      "targetArchetype": "Adept",
      "suggestedSpecializations": ["BoneSetter"],
      "migrationDescription": "Your healing arts find new expression through the Adept's wisdom. The Bone-Setter specialization continues your healing tradition.",
      "grantsFreeSpecialization": true
    },
    {
      "legacyClass": "Scholar",
      "targetArchetype": "Adept",
      "suggestedSpecializations": ["JotunReader"],
      "migrationDescription": "Your scholarly pursuits align with the Adept's knowledge. The Jötun-Reader unlocks secrets of the ancient giants.",
      "grantsFreeSpecialization": true
    },
    {
      "legacyClass": "Crafter",
      "targetArchetype": "Adept",
      "suggestedSpecializations": ["Runasmidr", "ScrapTinker"],
      "migrationDescription": "Your crafting expertise finds new purpose through the Adept's path. Consider Rúnasmiðr for runic inscription or Scrap-Tinker for mechanical innovation.",
      "grantsFreeSpecialization": true
    }
  ],
  "refundPolicy": {
    "incompatibleAbilities": "Full PP refund",
    "partiallyCompatibleAbilities": "50% PP refund, ability marked for review",
    "fullyCompatibleAbilities": "No refund, ability preserved"
  }
}
```

### legacy_class_mappings.schema.json

```json
{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "legacy_class_mappings.schema.json",
  "title": "Legacy Class Mappings Schema",
  "type": "object",
  "properties": {
    "version": {
      "type": "string",
      "pattern": "^[0-9]+\\.[0-9]+\\.[0-9]+$"
    },
    "mappings": {
      "type": "array",
      "items": {
        "type": "object",
        "properties": {
          "legacyClass": {
            "type": "string",
            "enum": ["Rogue", "Fighter", "Mage", "Healer", "Scholar", "Crafter"]
          },
          "targetArchetype": {
            "type": "string",
            "enum": ["Warrior", "Skirmisher", "Mystic", "Adept"]
          },
          "suggestedSpecializations": {
            "type": "array",
            "items": {
              "type": "string"
            },
            "minItems": 1
          },
          "migrationDescription": {
            "type": "string"
          },
          "grantsFreeSpecialization": {
            "type": "boolean"
          }
        },
        "required": ["legacyClass", "targetArchetype", "suggestedSpecializations", "migrationDescription", "grantsFreeSpecialization"]
      },
      "minItems": 6,
      "maxItems": 6
    },
    "refundPolicy": {
      "type": "object",
      "properties": {
        "incompatibleAbilities": { "type": "string" },
        "partiallyCompatibleAbilities": { "type": "string" },
        "fullyCompatibleAbilities": { "type": "string" }
      },
      "required": ["incompatibleAbilities", "partiallyCompatibleAbilities", "fullyCompatibleAbilities"]
    }
  },
  "required": ["version", "mappings", "refundPolicy"]
}
```

---

## Specialization Prerequisites

### Prerequisite Validation Rules

| Specialization | Required Archetype | First Spec Cost | Additional Cost | Prerequisites |
|----------------|-------------------|-----------------|-----------------|---------------|
| Skjaldmær | Warrior | 0 PP (Free) | 3 PP | None |
| Berserkr | Warrior | 0 PP (Free) | 3 PP | None |
| Veiðimaðr | Skirmisher | 0 PP (Free) | 3 PP | None |
| Myrk-gengr | Skirmisher | 0 PP (Free) | 3 PP | None |
| Seiðkona | Mystic | 0 PP (Free) | 3 PP | None |
| Bone-Setter | Adept | 0 PP (Free) | 3 PP | None |
| Jötun-Reader | Adept | 0 PP (Free) | 3 PP | None |
| Rúnasmiðr | Adept | 0 PP (Free) | 3 PP | None |

### Tier Unlock Requirements

| Tier | PP Invested in Tree | Unlock Cost per Ability |
|------|---------------------|------------------------|
| Tier 1 | 0 PP | 0 PP (Free) |
| Tier 2 | 8 PP | 4 PP each |
| Tier 3 | 16 PP | 5 PP each |
| Capstone | 24 PP | 6 PP |

---

## Unit Testing Requirements

### LegacyClassDetectionService Tests (~2 tests)

| Test | Description |
|------|-------------|
| `GetCharactersWithLegacyClasses_ReturnsAllMatches` | Identifies all characters needing migration |
| `HasLegacyClass_NoLegacyClass_ReturnsFalse` | Returns false for modern characters |

### CharacterMigrationService Tests (~4 tests)

| Test | Description |
|------|-------------|
| `InitiateMigration_ValidCharacter_CreatesMigration` | Creates migration record with correct mapping |
| `GetAvailableSpecializations_Fighter_ReturnsWarriorSpecs` | Returns Skjaldmær, Berserkr for Fighter migration |
| `CompleteMigration_ValidSelection_AppliesChanges` | Removes legacy class, assigns archetype and spec |
| `CompleteMigration_NoSpecialization_ThrowsException` | Requires specialization selection |

### SpecializationPrerequisiteService Tests (~2 tests)

| Test | Description |
|------|-------------|
| `CanSelectSpecialization_WrongArchetype_ReturnsFalse` | Warrior cannot select Mystic specs |
| `GetUnlockCost_FirstSpecialization_ReturnsZero` | First spec is always free |

### AbilitySlotService Tests (~2 tests)

| Test | Description |
|------|-------------|
| `InitializeAbilitySlots_CreatesCorrectStructure` | 3+3+2+1 = 9 total slots per spec |
| `IsTierUnlocked_Tier2_RequiresEightPP` | Tier 2 locked until 8 PP invested |

**Total: ~10 tests**

---

## Acceptance Criteria

### Functional Requirements

- [ ] All 6 legacy class types identified in LegacyClassId enum
- [ ] MigrationStatus tracks full migration lifecycle
- [ ] LegacyClassMapping correctly maps all 6 classes to archetypes
- [ ] Migration preserves compatible abilities where possible
- [ ] PP refunded for incompatible abilities during migration
- [ ] First specialization selection is always free
- [ ] Ability slots initialized with correct tier structure (3+3+2+1)
- [ ] Specialization prerequisites enforce archetype compatibility
- [ ] Migration logs provide complete audit trail

### Quality Requirements

- [ ] All public members have XML documentation
- [ ] Configuration files validate against schema
- [ ] ~10 unit tests pass
- [ ] No placeholder legacy class data remains after migration
- [ ] Build completes with 0 errors
- [ ] Build completes with 0 warnings

---

## Dependencies

### Required From Previous Versions

| Dependency | Source | Usage |
|------------|--------|-------|
| `Archetype` enum | v0.17.3 | Target archetype for migration |
| `SpecializationId` enum | v0.17.4 | Specialization selection |
| `SpecializationDefinition` entity | v0.17.4 | Specialization metadata |
| `SpecializationPathType` enum | v0.17.4 | Coherent/Heretical classification |
| PP System | v0.17.4 | Refunds and unlock costs |

### Provides To Subsequent Versions

| Provides | Consumer |
|----------|----------|
| `IAbilitySlotService` | v0.20.1-v0.20.8 ability implementations |
| `ISpecializationPrerequisiteService` | All specialization unlocking |
| Migration infrastructure | Any future class system changes |
| Ability slot structure | All tier-based ability unlocking |

---

## Architecture Diagram

```
┌─────────────────────────────────────────────────────────────────┐
│                v0.20.0 Migration Infrastructure                   │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │                    Domain Layer                          │   │
│  │  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐  │   │
│  │  │ LegacyClass  │  │  Migration   │  │   Legacy     │  │   │
│  │  │   Id Enum    │  │ Status Enum  │  │ClassMapping  │  │   │
│  │  │  (6 values)  │  │  (4 values)  │  │ Value Object │  │   │
│  │  └──────────────┘  └──────────────┘  └──────────────┘  │   │
│  │                                                          │   │
│  │  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐  │   │
│  │  │  Migration   │  │  AbilitySlot │  │   Spec       │  │   │
│  │  │   Result     │  │ Preparation  │  │ Prerequisite │  │   │
│  │  │ Value Object │  │ Value Object │  │ Value Object │  │   │
│  │  └──────────────┘  └──────────────┘  └──────────────┘  │   │
│  │                                                          │   │
│  │  ┌──────────────┐  ┌──────────────┐                     │   │
│  │  │  Character   │  │  Migration   │                     │   │
│  │  │  Migration   │  │    Log       │                     │   │
│  │  │   Entity     │  │   Entity     │                     │   │
│  │  └──────────────┘  └──────────────┘                     │   │
│  └─────────────────────────────────────────────────────────┘   │
│                              │                                   │
│                              ▼                                   │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │                  Application Layer                       │   │
│  │  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐  │   │
│  │  │   ILegacy    │  │  ICharacter  │  │   ISpec      │  │   │
│  │  │    Class     │  │  Migration   │  │ Prerequisite │  │   │
│  │  │  Detection   │  │   Service    │  │   Service    │  │   │
│  │  └──────────────┘  └──────────────┘  └──────────────┘  │   │
│  │         │                  │                  │         │   │
│  │         ▼                  ▼                  ▼         │   │
│  │  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐  │   │
│  │  │   Legacy     │  │  Character   │  │    Spec      │  │   │
│  │  │   Class      │  │  Migration   │  │ Prerequisite │  │   │
│  │  │  Detection   │  │   Service    │  │   Service    │  │   │
│  │  │    Impl      │  │    Impl      │  │    Impl      │  │   │
│  │  └──────────────┘  └──────────────┘  └──────────────┘  │   │
│  │                                                          │   │
│  │  ┌──────────────┐                                       │   │
│  │  │  IAbility    │                                       │   │
│  │  │   Slot       │                                       │   │
│  │  │  Service     │                                       │   │
│  │  └──────────────┘                                       │   │
│  └─────────────────────────────────────────────────────────┘   │
│                              │                                   │
│                              ▼                                   │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │                 Infrastructure Layer                     │   │
│  │  ┌──────────────────────┐  ┌──────────────────────┐    │   │
│  │  │ legacy_class_        │  │ legacy_class_        │    │   │
│  │  │ mappings.json        │  │ mappings.schema.json │    │   │
│  │  └──────────────────────┘  └──────────────────────┘    │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

---

## Risk Assessment

| Risk | Impact | Probability | Mitigation |
|------|--------|-------------|------------|
| Characters lose abilities during migration | High | Medium | Full PP refund, detailed logging, preserve compatible abilities |
| Player confusion during migration | Medium | Medium | Clear UI messaging, suggested specializations |
| Migration fails mid-process | High | Low | Transaction-based migration, rollback capability |
| Orphaned legacy class references | Medium | Low | Comprehensive codebase scan, automated tests |

---

## Design Decisions (Confirmed)

### Migration Policy

| Decision | Value | Notes |
|----------|-------|-------|
| **First Specialization Cost** | Free (0 PP) | Compensates for forced migration |
| **PP Refund Policy** | Full refund for incompatible | Prevents player PP loss |
| **Migration Timing** | On character load | Transparent to player |
| **Specialization Selection** | Required before completion | Cannot complete without selection |

### Ability Slot Structure

| Decision | Value | Notes |
|----------|-------|-------|
| **Tier 1 Slots** | 3 | All free, unlocked immediately |
| **Tier 2 Slots** | 3 | 4 PP each, requires 8 PP invested |
| **Tier 3 Slots** | 2 | 5 PP each, requires 16 PP invested |
| **Capstone Slot** | 1 | 6 PP, requires 24 PP invested |
| **Total per Spec** | 9 | 35 PP max to complete tree |

---

## Deliverable Checklist

### Domain Layer

- [ ] `LegacyClassId` enum (6 values)
- [ ] `MigrationStatus` enum (4 values)
- [ ] `LegacyClassMapping` value object
- [ ] `MigrationResult` value object
- [ ] `AbilitySlotPreparation` value object
- [ ] `SpecializationPrerequisite` value object
- [ ] `CharacterMigration` entity
- [ ] `MigrationLog` entity

### Application Layer

- [ ] `ILegacyClassDetectionService` interface
- [ ] `ICharacterMigrationService` interface
- [ ] `ISpecializationPrerequisiteService` interface
- [ ] `IAbilitySlotService` interface
- [ ] `LegacyClassDetectionService` implementation
- [ ] `CharacterMigrationService` implementation
- [ ] `SpecializationPrerequisiteService` implementation
- [ ] `AbilitySlotService` implementation

### Infrastructure Layer

- [ ] `legacy_class_mappings.json`
- [ ] `legacy_class_mappings.schema.json`

### Tests

- [ ] LegacyClassDetectionService tests (~2)
- [ ] CharacterMigrationService tests (~4)
- [ ] SpecializationPrerequisiteService tests (~2)
- [ ] AbilitySlotService tests (~2)

---

## Next Steps

1. **Review & Approve** - Confirm scope breakdown with stakeholders
2. **v0.20.0 Design Spec** - Create detailed design specification
3. **Implement v0.20.0** - Build migration infrastructure
4. **Test Migration** - Verify with sample legacy characters
5. **Proceed to v0.20.1** - Skjaldmær specialization abilities

---

*This scope breakdown provides the foundation for removing legacy classes and preparing the system for Aethelgard specialization implementation. The migration infrastructure ensures existing characters transition smoothly to the new archetype/specialization system.*
