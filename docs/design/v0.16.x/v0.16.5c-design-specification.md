# v0.16.5c Design Specification: Unique Item Registry

## Document Information

| Field               | Value                                           |
| ------------------- | ----------------------------------------------- |
| **Version**         | v0.16.5c                                        |
| **Feature**         | Unique Item Registry                            |
| **Status**          | Draft                                           |
| **Dependencies**    | v0.16.5a (UniqueItem), v0.16.5b (SpecialEffect) |
| **Estimated Tests** | 15                                              |

---

## 1. Executive Summary

Version 0.16.5c implements the `UniqueItemRegistry` entity that tracks dropped unique (Myth-Forged) items per run to prevent duplicates. This registry ensures that one-per-run unique items cannot drop more than once during a game session, while allowing the pool to reset between runs. The registry provides methods for checking drop status, registering drops, filtering available uniques, and resetting state.

### 1.1 Feature Overview

```
v0.16.5c: Unique Item Registry
├── Domain Layer
│   ├── UniqueItemRegistry Entity
│   │   ├── RunId (current run identifier)
│   │   ├── DroppedItemIds (hashset of dropped unique IDs)
│   │   ├── HasDropped(itemId) → bool
│   │   ├── RegisterDrop(itemId) → void
│   │   ├── GetDroppedCount() → int
│   │   └── Reset(newRunId) → void
│   └── DropRecord Value Object
│       ├── ItemId (unique item identifier)
│       ├── DroppedAt (timestamp)
│       └── SourceType (where it dropped)
├── Application Layer
│   └── IUniqueItemRegistry Interface
│       ├── HasDropped(itemId) → bool
│       ├── RegisterDrop(itemId, sourceType) → void
│       ├── GetAvailableUniques(sourceType, classId?) → list
│       ├── GetDropHistory() → list
│       └── Reset(newRunId) → void
└── Integration
    └── Run lifecycle hooks
```

### 1.2 Goals

1. Create `UniqueItemRegistry` entity to track dropped unique items
2. Implement `HasDropped()` and `RegisterDrop()` methods
3. Implement `GetAvailableUniques()` filtering logic
4. Support per-run reset functionality
5. Track drop history with timestamps and sources

### 1.3 Non-Goals (Deferred)

- Drop integration with loot service (v0.16.5d)
- Visual presentation of unique drops (v0.16.5e)
- Achievement hooks (v0.16.5f)
- Cross-run persistence (future)

---

## 2. Architecture

### 2.1 Layer Diagram

```
┌─────────────────────────────────────────────────────────────────┐
│                    APPLICATION LAYER                            │
│  ┌─────────────────────────────────────────────────────────────┐│
│  │              IUniqueItemRegistry Interface                  ││
│  │  ┌─────────────────────────────────────────────────────────┐││
│  │  │ HasDropped(itemId: string) → bool                       │││
│  │  │ RegisterDrop(itemId: string, sourceType: DropSourceType)│││
│  │  │ GetAvailableUniques(sourceType, classId?) → List<>      │││
│  │  │ GetDropHistory() → IReadOnlyList<DropRecord>            │││
│  │  │ GetDroppedCount() → int                                 │││
│  │  │ Reset(newRunId: Guid) → void                            │││
│  │  └─────────────────────────────────────────────────────────┘││
│  └─────────────────────────────────────────────────────────────┘│
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│                      DOMAIN LAYER                               │
│  ┌───────────────────────────────────────────────────────────┐  │
│  │               UniqueItemRegistry Entity                    │  │
│  │  ┌─────────────────────────────────────────────────────┐  │  │
│  │  │ Id: Guid                                            │  │  │
│  │  │ RunId: Guid (current run identifier)                │  │  │
│  │  │ CreatedAt: DateTime                                 │  │  │
│  │  │ DropHistory: List<DropRecord>                       │  │  │
│  │  │ _droppedItemIds: HashSet<string> (for fast lookup)  │  │  │
│  │  ├─────────────────────────────────────────────────────┤  │  │
│  │  │ HasDropped(itemId) → bool                           │  │  │
│  │  │ RegisterDrop(itemId, sourceType) → DropRecord       │  │  │
│  │  │ GetDroppedCount() → int                             │  │  │
│  │  │ GetDropHistory() → IReadOnlyList<DropRecord>        │  │  │
│  │  │ Reset(newRunId) → void                              │  │  │
│  │  │ IsCurrentRun(runId) → bool                          │  │  │
│  │  └─────────────────────────────────────────────────────┘  │  │
│  └───────────────────────────────────────────────────────────┘  │
│                                                                 │
│  ┌───────────────────────────────────────────────────────────┐  │
│  │                  DropRecord (VO)                          │  │
│  │  ┌─────────────────────────────────────────────────────┐  │  │
│  │  │ ItemId: string ("shadowfang-blade")                 │  │  │
│  │  │ DroppedAt: DateTime                                 │  │  │
│  │  │ SourceType: DropSourceType                          │  │  │
│  │  │ SourceId: string (specific boss/container ID)       │  │  │
│  │  └─────────────────────────────────────────────────────┘  │  │
│  └───────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────┘
```

### 2.2 Duplicate Prevention Flow

```
┌─────────────────────────────────────────────────────────────────┐
│              UNIQUE ITEM DROP PREVENTION FLOW                   │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  LOOT GENERATION REQUEST                                        │
│       │                                                         │
│       ▼                                                         │
│  ┌──────────────────┐                                           │
│  │ Get Unique Pool  │                                           │
│  │ for Source Type  │                                           │
│  └────────┬─────────┘                                           │
│           │                                                     │
│           ▼                                                     │
│  ┌──────────────────────────────────────────────────────────┐   │
│  │           GetAvailableUniques(sourceType, classId)        │   │
│  ├──────────────────────────────────────────────────────────┤   │
│  │                                                          │   │
│  │  1. Load all UniqueItems from configuration              │   │
│  │           │                                              │   │
│  │           ▼                                              │   │
│  │  2. Filter by CanDropFrom(sourceType)                    │   │
│  │           │                                              │   │
│  │           ▼                                              │   │
│  │  3. Filter by HasAffinityFor(classId) [if provided]      │   │
│  │           │                                              │   │
│  │           ▼                                              │   │
│  │  4. For each remaining item:                             │   │
│  │     ┌─────────────────────────────────────────────┐      │   │
│  │     │ registry.HasDropped(item.ItemId)?           │      │   │
│  │     │     ├─ Yes → EXCLUDE from pool              │      │   │
│  │     │     └─ No  → INCLUDE in pool                │      │   │
│  │     └─────────────────────────────────────────────┘      │   │
│  │           │                                              │   │
│  │           ▼                                              │   │
│  │  5. Return filtered pool                                 │   │
│  │                                                          │   │
│  └──────────────────────────────────────────────────────────┘   │
│           │                                                     │
│           ▼                                                     │
│  ┌──────────────────┐     ┌──────────────────┐                  │
│  │ Pool Empty?      │────►│ Fallback to      │                  │
│  │                  │ Yes │ Tier 3 Item      │                  │
│  └────────┬─────────┘     └──────────────────┘                  │
│           │ No                                                  │
│           ▼                                                     │
│  ┌──────────────────┐                                           │
│  │ Select Random    │                                           │
│  │ Unique Item      │                                           │
│  └────────┬─────────┘                                           │
│           │                                                     │
│           ▼                                                     │
│  ┌──────────────────┐                                           │
│  │ RegisterDrop()   │                                           │
│  │                  │                                           │
│  └──────────────────┘                                           │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 2.3 Run Lifecycle Integration

```
┌─────────────────────────────────────────────────────────────────┐
│                   RUN LIFECYCLE FLOW                            │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ┌──────────────────┐                                           │
│  │   NEW RUN        │                                           │
│  │   STARTED        │                                           │
│  └────────┬─────────┘                                           │
│           │                                                     │
│           ▼                                                     │
│  ┌──────────────────────────────────────────────────────────┐   │
│  │              registry.Reset(newRunId)                    │   │
│  ├──────────────────────────────────────────────────────────┤   │
│  │                                                          │   │
│  │  1. Store new RunId                                      │   │
│  │  2. Clear _droppedItemIds HashSet                        │   │
│  │  3. Clear DropHistory list                               │   │
│  │  4. Update CreatedAt timestamp                           │   │
│  │  5. Log reset event                                      │   │
│  │                                                          │   │
│  └──────────────────────────────────────────────────────────┘   │
│           │                                                     │
│           ▼                                                     │
│  ┌──────────────────┐                                           │
│  │   GAMEPLAY       │ ◄───────────────────────────────┐         │
│  │   LOOP           │                                 │         │
│  └────────┬─────────┘                                 │         │
│           │                                           │         │
│           ▼                                           │         │
│  ┌──────────────────┐                                 │         │
│  │ Unique Drops     │──── RegisterDrop() ─────────────┘         │
│  │ Occur            │                                           │
│  └────────┬─────────┘                                           │
│           │                                                     │
│           ▼                                                     │
│  ┌──────────────────┐                                           │
│  │   RUN ENDS       │                                           │
│  │   (death/win)    │                                           │
│  └────────┬─────────┘                                           │
│           │                                                     │
│           ▼                                                     │
│  ┌──────────────────┐                                           │
│  │ Registry state   │                                           │
│  │ discarded        │                                           │
│  │ (or persisted    │                                           │
│  │ for statistics)  │                                           │
│  └──────────────────┘                                           │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

---

## 3. Data Model

### 3.1 DropRecord Value Object

**Location:** `src/Core/RuneAndRust.Domain/ValueObjects/DropRecord.cs`

```csharp
namespace RuneAndRust.Domain.ValueObjects;

using RuneAndRust.Domain.Enums;

/// <summary>
/// Immutable record of a unique item drop event.
/// Tracks what dropped, when, and from what source.
/// </summary>
public readonly record struct DropRecord
{
    /// <summary>The unique item's configuration ID.</summary>
    public string ItemId { get; }

    /// <summary>When the item dropped.</summary>
    public DateTime DroppedAt { get; }

    /// <summary>The type of source that generated the drop.</summary>
    public DropSourceType SourceType { get; }

    /// <summary>Specific source identifier (boss ID, container ID, etc.).</summary>
    public string SourceId { get; }

    private DropRecord(
        string itemId,
        DateTime droppedAt,
        DropSourceType sourceType,
        string sourceId)
    {
        ItemId = itemId;
        DroppedAt = droppedAt;
        SourceType = sourceType;
        SourceId = sourceId;
    }

    /// <summary>
    /// Creates a new DropRecord with validation.
    /// </summary>
    public static DropRecord Create(
        string itemId,
        DropSourceType sourceType,
        string sourceId,
        DateTime? droppedAt = null)
    {
        ArgumentException.ThrowIfNullOrWhiteSpace(itemId, nameof(itemId));
        ArgumentException.ThrowIfNullOrWhiteSpace(sourceId, nameof(sourceId));

        return new DropRecord(
            itemId.ToLowerInvariant(),
            droppedAt ?? DateTime.UtcNow,
            sourceType,
            sourceId.ToLowerInvariant());
    }

    public override string ToString() =>
        $"DropRecord[{ItemId} from {SourceType}:{SourceId} @ {DroppedAt:u}]";
}
```

### 3.2 UniqueItemRegistry Entity

**Location:** `src/Core/RuneAndRust.Domain/Entities/UniqueItemRegistry.cs`

```csharp
namespace RuneAndRust.Domain.Entities;

using RuneAndRust.Domain.Enums;
using RuneAndRust.Domain.Interfaces;
using RuneAndRust.Domain.ValueObjects;

/// <summary>
/// Tracks unique (Myth-Forged) item drops per run to prevent duplicates.
/// Each run has its own registry that resets when a new run begins.
/// </summary>
public class UniqueItemRegistry : IEntity
{
    private readonly HashSet<string> _droppedItemIds;
    private readonly List<DropRecord> _dropHistory;

    /// <summary>Database identifier.</summary>
    public Guid Id { get; private set; }

    /// <summary>Identifier for the current game run.</summary>
    public Guid RunId { get; private set; }

    /// <summary>When this registry was created/last reset.</summary>
    public DateTime CreatedAt { get; private set; }

    /// <summary>Read-only view of drop history.</summary>
    public IReadOnlyList<DropRecord> DropHistory => _dropHistory.AsReadOnly();

    // Private constructor for EF Core
    private UniqueItemRegistry()
    {
        _droppedItemIds = new HashSet<string>(StringComparer.OrdinalIgnoreCase);
        _dropHistory = new List<DropRecord>();
    }

    /// <summary>
    /// Creates a new UniqueItemRegistry for a run.
    /// </summary>
    public static UniqueItemRegistry Create(Guid runId)
    {
        return new UniqueItemRegistry
        {
            Id = Guid.NewGuid(),
            RunId = runId,
            CreatedAt = DateTime.UtcNow
        };
    }

    /// <summary>
    /// Checks if a unique item has already dropped in this run.
    /// </summary>
    /// <param name="itemId">The unique item's configuration ID.</param>
    /// <returns>True if the item has already dropped.</returns>
    public bool HasDropped(string itemId)
    {
        ArgumentException.ThrowIfNullOrWhiteSpace(itemId, nameof(itemId));
        return _droppedItemIds.Contains(itemId.ToLowerInvariant());
    }

    /// <summary>
    /// Registers that a unique item has dropped.
    /// </summary>
    /// <param name="itemId">The unique item's configuration ID.</param>
    /// <param name="sourceType">What type of source generated the drop.</param>
    /// <param name="sourceId">Specific source identifier.</param>
    /// <returns>The created drop record.</returns>
    /// <exception cref="InvalidOperationException">If item has already dropped.</exception>
    public DropRecord RegisterDrop(string itemId, DropSourceType sourceType, string sourceId)
    {
        ArgumentException.ThrowIfNullOrWhiteSpace(itemId, nameof(itemId));
        ArgumentException.ThrowIfNullOrWhiteSpace(sourceId, nameof(sourceId));

        var normalizedId = itemId.ToLowerInvariant();

        if (_droppedItemIds.Contains(normalizedId))
        {
            throw new InvalidOperationException(
                $"Unique item '{itemId}' has already dropped in this run.");
        }

        _droppedItemIds.Add(normalizedId);

        var record = DropRecord.Create(normalizedId, sourceType, sourceId);
        _dropHistory.Add(record);

        return record;
    }

    /// <summary>
    /// Gets the count of unique items that have dropped in this run.
    /// </summary>
    public int GetDroppedCount() => _droppedItemIds.Count;

    /// <summary>
    /// Gets all item IDs that have dropped in this run.
    /// </summary>
    public IReadOnlySet<string> GetDroppedItemIds() => _droppedItemIds;

    /// <summary>
    /// Checks if this registry is for the specified run.
    /// </summary>
    public bool IsCurrentRun(Guid runId) => RunId == runId;

    /// <summary>
    /// Resets the registry for a new run.
    /// </summary>
    /// <param name="newRunId">The new run's identifier.</param>
    public void Reset(Guid newRunId)
    {
        RunId = newRunId;
        CreatedAt = DateTime.UtcNow;
        _droppedItemIds.Clear();
        _dropHistory.Clear();
    }

    /// <summary>
    /// Gets drop records for a specific source type.
    /// </summary>
    public IEnumerable<DropRecord> GetDropsBySourceType(DropSourceType sourceType) =>
        _dropHistory.Where(r => r.SourceType == sourceType);

    /// <summary>
    /// Gets the most recent drop record, if any.
    /// </summary>
    public DropRecord? GetLastDrop() =>
        _dropHistory.Count > 0 ? _dropHistory[^1] : null;
}
```

### 3.3 IUniqueItemRegistry Interface

**Location:** `src/Core/RuneAndRust.Application/Interfaces/IUniqueItemRegistry.cs`

```csharp
namespace RuneAndRust.Application.Interfaces;

using RuneAndRust.Domain.Entities;
using RuneAndRust.Domain.Enums;
using RuneAndRust.Domain.ValueObjects;

/// <summary>
/// Application-layer interface for managing the unique item registry.
/// Provides filtering logic and integration with unique item definitions.
/// </summary>
public interface IUniqueItemRegistry
{
    /// <summary>
    /// Checks if a unique item has already dropped in the current run.
    /// </summary>
    bool HasDropped(string itemId);

    /// <summary>
    /// Registers that a unique item has dropped.
    /// </summary>
    DropRecord RegisterDrop(string itemId, DropSourceType sourceType, string sourceId);

    /// <summary>
    /// Gets unique items available for a drop source, excluding already-dropped items.
    /// </summary>
    /// <param name="sourceType">The type of source generating loot.</param>
    /// <param name="sourceId">Specific source identifier.</param>
    /// <param name="classId">Optional player class for affinity filtering.</param>
    /// <returns>List of available unique items.</returns>
    IReadOnlyList<UniqueItem> GetAvailableUniques(
        DropSourceType sourceType,
        string sourceId,
        string? classId = null);

    /// <summary>
    /// Gets the full drop history for the current run.
    /// </summary>
    IReadOnlyList<DropRecord> GetDropHistory();

    /// <summary>
    /// Gets the count of unique items dropped in the current run.
    /// </summary>
    int GetDroppedCount();

    /// <summary>
    /// Resets the registry for a new run.
    /// </summary>
    void Reset(Guid newRunId);

    /// <summary>
    /// Gets the current run ID.
    /// </summary>
    Guid CurrentRunId { get; }
}
```

---

## 4. Decision Tree

### 4.1 Available Uniques Decision Tree

```
┌─────────────────────────────────────────────────────────────────┐
│           GetAvailableUniques() DECISION TREE                   │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  INPUT: sourceType, sourceId, classId?                          │
│       │                                                         │
│       ▼                                                         │
│  ┌────────────────────────────────────────────┐                 │
│  │ Q1: Get all UniqueItems from configuration │                 │
│  └────────────────────┬───────────────────────┘                 │
│                       │                                         │
│                       ▼                                         │
│  ┌────────────────────────────────────────────┐                 │
│  │ Q2: Does item.CanDropFrom(sourceType,      │                 │
│  │     sourceId) == true?                     │                 │
│  └────────────────────┬───────────────────────┘                 │
│                       │                                         │
│          ┌────────────┴────────────┐                            │
│          │                         │                            │
│          ▼                         ▼                            │
│        [No]                      [Yes]                          │
│          │                         │                            │
│          ▼                         ▼                            │
│       EXCLUDE              ┌───────────────────┐                │
│                            │ Q3: classId       │                │
│                            │     provided?     │                │
│                            └─────────┬─────────┘                │
│                                      │                          │
│                     ┌────────────────┴────────────────┐         │
│                     │                                 │         │
│                     ▼                                 ▼         │
│                   [No]                              [Yes]       │
│                     │                                 │         │
│                     │                                 ▼         │
│                     │            ┌────────────────────────────┐ │
│                     │            │ Q4: item.HasAffinityFor    │ │
│                     │            │     (classId) == true?     │ │
│                     │            └───────────┬────────────────┘ │
│                     │                        │                  │
│                     │           ┌────────────┴─────────┐        │
│                     │           │                      │        │
│                     │           ▼                      ▼        │
│                     │         [No]                   [Yes]      │
│                     │           │                      │        │
│                     │           ▼                      │        │
│                     │        EXCLUDE                   │        │
│                     │                                  │        │
│                     └──────────────────┬───────────────┘        │
│                                        │                        │
│                                        ▼                        │
│  ┌────────────────────────────────────────────────────────────┐ │
│  │ Q5: registry.HasDropped(item.ItemId) == true?              │ │
│  └────────────────────────────────┬───────────────────────────┘ │
│                                   │                             │
│                  ┌────────────────┴────────────────┐            │
│                  │                                 │            │
│                  ▼                                 ▼            │
│                [Yes]                             [No]           │
│                  │                                 │            │
│                  ▼                                 ▼            │
│               EXCLUDE                           INCLUDE         │
│                                                    │            │
│                                                    ▼            │
│                                          ┌─────────────────┐    │
│                                          │ Add to result   │    │
│                                          │ list            │    │
│                                          └─────────────────┘    │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

---

## 5. User Stories

### 5.1 Duplicate Prevention

**As a** player  
**I want** unique items to only drop once per run  
**So that** finding a unique feels special and I don't get duplicates

**Acceptance:**

- Same unique item cannot appear twice in one run
- Different unique items can still drop
- Registry resets when starting new run

### 5.2 Class Affinity

**As a** warrior player  
**I want** unique drops to favor my class  
**So that** I'm more likely to find gear I can use effectively

**Acceptance:**

- Filtering supports optional class ID
- Items with matching affinity are included
- Items with no restrictions are always included

---

## 6. Logging Specification

### 6.1 Log Events

| Event                          | Level       | Template                                                                           |
| ------------------------------ | ----------- | ---------------------------------------------------------------------------------- |
| Registry created               | Information | `"Created UniqueItemRegistry for run {RunId}"`                                     |
| Item registered                | Information | `"Registered unique drop {ItemId} from {SourceType}:{SourceId}"`                   |
| Drop check                     | Debug       | `"HasDropped check for {ItemId}: {Result}"`                                        |
| Registry reset                 | Information | `"Reset UniqueItemRegistry for new run {NewRunId}, cleared {PreviousCount} drops"` |
| Available uniques filtered     | Debug       | `"Filtered to {Count} available uniques for {SourceType}:{SourceId}"`              |
| Duplicate registration attempt | Warning     | `"Attempted to register already-dropped unique {ItemId}"`                          |

---

## 7. Unit Testing

### 7.1 Test Classes

| Test Class                | Location                         | Tests |
| ------------------------- | -------------------------------- | ----- |
| `DropRecordTests`         | `Domain.UnitTests/ValueObjects/` | 4     |
| `UniqueItemRegistryTests` | `Domain.UnitTests/Entities/`     | 11    |

### 7.2 DropRecordTests

```csharp
[TestFixture]
public class DropRecordTests
{
    [Test]
    public void Create_WithValidData_CreatesRecord()
    {
        // Arrange & Act
        var record = DropRecord.Create(
            "shadowfang-blade",
            DropSourceType.Boss,
            "shadow-lord");

        // Assert
        record.ItemId.Should().Be("shadowfang-blade");
        record.SourceType.Should().Be(DropSourceType.Boss);
        record.SourceId.Should().Be("shadow-lord");
        record.DroppedAt.Should().BeCloseTo(DateTime.UtcNow, TimeSpan.FromSeconds(1));
    }

    [Test]
    public void Create_NormalizesIds()
    {
        // Arrange & Act
        var record = DropRecord.Create(
            "SHADOWFANG-BLADE",
            DropSourceType.Boss,
            "SHADOW-LORD");

        // Assert
        record.ItemId.Should().Be("shadowfang-blade");
        record.SourceId.Should().Be("shadow-lord");
    }

    [Test]
    public void Create_WithNullItemId_ThrowsArgumentException()
    {
        // Arrange & Act
        var act = () => DropRecord.Create(null!, DropSourceType.Boss, "boss-id");

        // Assert
        act.Should().Throw<ArgumentException>();
    }

    [Test]
    public void Create_WithCustomTimestamp_UsesProvidedTime()
    {
        // Arrange
        var timestamp = new DateTime(2025, 1, 15, 12, 0, 0, DateTimeKind.Utc);

        // Act
        var record = DropRecord.Create(
            "item-id",
            DropSourceType.Container,
            "chest-id",
            timestamp);

        // Assert
        record.DroppedAt.Should().Be(timestamp);
    }
}
```

### 7.3 UniqueItemRegistryTests

```csharp
[TestFixture]
public class UniqueItemRegistryTests
{
    private UniqueItemRegistry _registry = null!;
    private Guid _runId;

    [SetUp]
    public void SetUp()
    {
        _runId = Guid.NewGuid();
        _registry = UniqueItemRegistry.Create(_runId);
    }

    [Test]
    public void Create_WithRunId_InitializesCorrectly()
    {
        // Assert
        _registry.RunId.Should().Be(_runId);
        _registry.GetDroppedCount().Should().Be(0);
        _registry.DropHistory.Should().BeEmpty();
    }

    [Test]
    public void HasDropped_WithUnregisteredItem_ReturnsFalse()
    {
        // Arrange & Act
        var result = _registry.HasDropped("shadowfang-blade");

        // Assert
        result.Should().BeFalse();
    }

    [Test]
    public void HasDropped_WithRegisteredItem_ReturnsTrue()
    {
        // Arrange
        _registry.RegisterDrop("shadowfang-blade", DropSourceType.Boss, "shadow-lord");

        // Act
        var result = _registry.HasDropped("shadowfang-blade");

        // Assert
        result.Should().BeTrue();
    }

    [Test]
    public void HasDropped_IsCaseInsensitive()
    {
        // Arrange
        _registry.RegisterDrop("shadowfang-blade", DropSourceType.Boss, "shadow-lord");

        // Act & Assert
        _registry.HasDropped("SHADOWFANG-BLADE").Should().BeTrue();
        _registry.HasDropped("Shadowfang-Blade").Should().BeTrue();
    }

    [Test]
    public void RegisterDrop_AddsToHistoryAndSet()
    {
        // Arrange & Act
        var record = _registry.RegisterDrop(
            "shadowfang-blade",
            DropSourceType.Boss,
            "shadow-lord");

        // Assert
        _registry.GetDroppedCount().Should().Be(1);
        _registry.DropHistory.Should().ContainSingle()
            .Which.ItemId.Should().Be("shadowfang-blade");
        record.ItemId.Should().Be("shadowfang-blade");
    }

    [Test]
    public void RegisterDrop_WithAlreadyDroppedItem_ThrowsInvalidOperationException()
    {
        // Arrange
        _registry.RegisterDrop("shadowfang-blade", DropSourceType.Boss, "shadow-lord");

        // Act
        var act = () => _registry.RegisterDrop(
            "shadowfang-blade",
            DropSourceType.Container,
            "chest");

        // Assert
        act.Should().Throw<InvalidOperationException>()
            .WithMessage("*already dropped*");
    }

    [Test]
    public void Reset_ClearsAllStateAndSetsNewRunId()
    {
        // Arrange
        _registry.RegisterDrop("item-1", DropSourceType.Boss, "boss-1");
        _registry.RegisterDrop("item-2", DropSourceType.Container, "chest-1");
        var newRunId = Guid.NewGuid();

        // Act
        _registry.Reset(newRunId);

        // Assert
        _registry.RunId.Should().Be(newRunId);
        _registry.GetDroppedCount().Should().Be(0);
        _registry.DropHistory.Should().BeEmpty();
        _registry.HasDropped("item-1").Should().BeFalse();
        _registry.HasDropped("item-2").Should().BeFalse();
    }

    [Test]
    public void IsCurrentRun_WithMatchingRunId_ReturnsTrue()
    {
        // Assert
        _registry.IsCurrentRun(_runId).Should().BeTrue();
        _registry.IsCurrentRun(Guid.NewGuid()).Should().BeFalse();
    }

    [Test]
    public void GetDropsBySourceType_FiltersCorrectly()
    {
        // Arrange
        _registry.RegisterDrop("item-1", DropSourceType.Boss, "boss-1");
        _registry.RegisterDrop("item-2", DropSourceType.Container, "chest-1");
        _registry.RegisterDrop("item-3", DropSourceType.Boss, "boss-2");

        // Act
        var bossDrops = _registry.GetDropsBySourceType(DropSourceType.Boss).ToList();

        // Assert
        bossDrops.Should().HaveCount(2);
        bossDrops.Select(d => d.ItemId).Should().Contain("item-1", "item-3");
    }

    [Test]
    public void GetLastDrop_WithNoDrops_ReturnsNull()
    {
        // Act
        var result = _registry.GetLastDrop();

        // Assert
        result.Should().BeNull();
    }

    [Test]
    public void GetLastDrop_WithDrops_ReturnsMostRecent()
    {
        // Arrange
        _registry.RegisterDrop("item-1", DropSourceType.Boss, "boss-1");
        _registry.RegisterDrop("item-2", DropSourceType.Container, "chest-1");

        // Act
        var result = _registry.GetLastDrop();

        // Assert
        result.Should().NotBeNull();
        result!.Value.ItemId.Should().Be("item-2");
    }
}
```

---

## 8. Acceptance Criteria

| #   | Criterion                                                   | Verification |
| --- | ----------------------------------------------------------- | ------------ |
| 1   | `HasDropped()` returns false for unregistered items         | Unit test    |
| 2   | `HasDropped()` returns true for registered items            | Unit test    |
| 3   | `HasDropped()` is case-insensitive                          | Unit test    |
| 4   | `RegisterDrop()` prevents duplicate registration            | Unit test    |
| 5   | `Reset()` clears all state and sets new run ID              | Unit test    |
| 6   | `DropRecord` captures timestamp, source type, and source ID | Unit test    |
| 7   | Same unique cannot drop twice in one run                    | Unit test    |
| 8   | Registry state persists across multiple drops               | Unit test    |
| 9   | `GetDropsBySourceType()` filters correctly                  | Unit test    |

---

## 9. Deliverable Checklist

### 9.1 Domain Layer

- [ ] `DropRecord.cs` - Value object for drop events
- [ ] `UniqueItemRegistry.cs` - Entity for tracking drops

### 9.2 Application Layer

- [ ] `IUniqueItemRegistry.cs` - Interface with filtering logic

### 9.3 Tests

- [ ] `DropRecordTests.cs` - Value object tests
- [ ] `UniqueItemRegistryTests.cs` - Entity tests

---

## 10. Dependencies

### 10.1 Required

| Dependency     | Version  | Purpose               |
| -------------- | -------- | --------------------- |
| UniqueItem     | v0.16.5a | Items being tracked   |
| DropSourceType | v0.16.5a | Source classification |

### 10.2 Dependents

| Feature                      | Version  | Relationship                |
| ---------------------------- | -------- | --------------------------- |
| Myth-Forged Drop Integration | v0.16.5d | Uses registry for filtering |
| Presentation                 | v0.16.5e | Displays drop history       |
| Achievements                 | v0.16.5f | Tracks unique collection    |

---

## 11. Future Considerations

### 11.1 Deferred to v0.16.5d

- Integration with `ContainerLootGenerator`
- `IMythForgedService` implementation using registry

### 11.2 Deferred to Later Versions

- Cross-run persistence for collection tracking
- Statistics aggregation (total uniques ever found)
- "Collection" UI showing all uniques found across runs
