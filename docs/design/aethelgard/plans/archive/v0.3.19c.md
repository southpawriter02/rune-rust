> **Archived** - This plan has been consolidated. See the complete version at [v0.3.19](../v0.3.x/v0.3.19.md).

# v0.3.19c: The Ambience

This sub-version brings the dungeon to life by implementing a background audio layer. Since the TUI relies on Console.Beep, we cannot play true "loops." Instead, we will implement a Procedural Soundscape Generator that triggers periodic "stings" (short tones) simulating environmental noise (e.g., distant machinery, dripping water) based on the current Biome.

Goal: Implement the AmbienceService to generate periodic, biome-specific audio cues that enhance immersion without overwhelming the player or blocking input.
1. Architecture & Data Flow
	•	Ambience Service: A background service (hosted or ticked by GameLoop) that tracks time since the last environmental sound.
	•	Biome Profiles: A mapping logic that translates BiomeType into audio parameters (Pitch Range, Duration Range, Interval).
	◦	The Roots (Industrial): Low frequency, long duration (Rumbles).
	◦	Niflheim (Ice): High frequency, short duration (Chimes/Cracking).
	◦	Organic: Mid-frequency, variable (Rustling).
	•	Settings Integration: Hooks into GameSettings to allow toggling Ambience on/off specifically, separate from Master Volume.
Data Flow: The Soundscape Loop
	1	Tick: AmbienceService wakes up (e.g., every 1 second).
	2	Validation: Checks GameSettings.AmbienceEnabled and GameState.Phase (must be Exploration).
	3	Cooldown: Checks if LastSoundTime + RandomInterval < Now.
	4	Selection: Reads CurrentRoom.BiomeType.
	5	Generation: Creates a randomized SoundCue based on the Biome's profile.
	6	Playback: Sends cue to IAudioService.PlayAsync (Low Priority).

2. Logic Decision Trees
A. Ambience Tick Logic Input: CurrentTime, CurrentRoom
	1	Pre-Flight: Is AmbienceEnabled? Is Game Paused?
	◦	No: Stop/Reset Timer.
	2	Timer Check: Has NextCueTime elapsed?
	◦	No: Return.
	3	Biome Lookup: Switch CurrentRoom.BiomeType:
	◦	Industrial: Freq 100-300Hz (Rumble).
	◦	Void: Freq 50-80Hz (Deep Drone) OR 10000Hz+ (Eerie whine - skipped for Beep safety).
	◦	Ruin: Freq 400-600Hz (Wind).
	4	Execute: Play Sound.
	5	Reschedule: Set NextCueTime = Now + Random(5s, 15s).
B. Profile Generation Logic Input: BiomeType
	•	Profile: Industrial (The Roots)
	◦	Frequency: Random(100, 250) Hz.
	◦	Duration: Random(300, 800) ms.
	◦	Description: "Distant Machinery".
	•	Profile: Ice (Niflheim)
	◦	Frequency: Random(1200, 2000) Hz.
	◦	Duration: Random(50, 100) ms.
	◦	Description: "Ice cracking".

3. Code Implementation
A. Ambience Settings Extension File: RuneAndRust.Core/Settings/GameSettings.cs
public static class GameSettings
{
    // ... existing settings
    public static bool AmbienceEnabled { get; set; } = true;
}
B. Ambience Service File: RuneAndRust.Engine/Services/AmbienceService.cs
public class AmbienceService : IDisposable
{
    private readonly IAudioService _audio;
    private readonly GameState _gameState;
    private readonly Random _rng = new();
    private DateTime _nextCueTime;
    private bool _isRunning;

    public AmbienceService(IAudioService audio, GameState gameState)
    {
        _audio = audio;
        _gameState = gameState;
        ScheduleNextCue();
    }

    public async Task UpdateAsync()
    {
        if (!GameSettings.AmbienceEnabled || _gameState.Phase != GamePhase.Exploration) return;

        if (DateTime.UtcNow >= _nextCueTime)
        {
            await PlayBiomeCue();
            ScheduleNextCue();
        }
    }

    private async Task PlayBiomeCue()
    {
        if (_gameState.CurrentRoom == null) return;

        var (freqMin, freqMax, durMin, durMax) = GetProfile(_gameState.CurrentRoom.BiomeType);

        var cue = new SoundCue(
            "ambience_proc",
            SoundCategory.Ambience,
            _rng.Next(freqMin, freqMax),
            _rng.Next(durMin, durMax)
        );

        await _audio.PlayAsync(cue);
    }

    private (int fMin, int fMax, int dMin, int dMax) GetProfile(BiomeType biome)
    {
        return biome switch
        {
            BiomeType.Industrial => (100, 300, 500, 1000), // Low rumbles
            BiomeType.Void => (200, 250, 1000, 2000),      // Long drones
            BiomeType.Organic => (600, 900, 50, 150),      // Skittering/Rustling
            _ => (400, 600, 200, 400)                      // Standard wind
        };
    }

    private void ScheduleNextCue()
    {
        // Random delay between 5 and 15 seconds
        _nextCueTime = DateTime.UtcNow.AddSeconds(_rng.Next(5, 15));
    }

    public void Dispose() { /* Cleanup if using Timers */ }
}

4. Deliverable Checklist (v0.3.19c)
	•	Core:
	◦	[ ] Add AmbienceEnabled to GameSettings.
	◦	[ ] Add Ambience to SoundCategory enum (if not present).
	•	Engine:
	◦	[ ] Implement AmbienceService.
	◦	[ ] Integrate AmbienceService.UpdateAsync() into GameLoop (or run as background Task).
	◦	[ ] Define frequency profiles for all 5 BiomeTypes.
	•	Terminal:
	◦	[ ] Add "Toggle Ambience" option to the Options Menu (v0.3.10b integration).
	•	Tests:
	◦	[ ] Verify AmbienceEnabled = false prevents playback.
	◦	[ ] Verify Biome switch changes frequency ranges.

5. Logging Requirements
Reference: logging.md
System
Event
Level
Message Template
Properties
Ambience
Cue Generated
Verbose
"[Audio] Generated ambience for {Biome}: {Freq}Hz / {Dur}ms."
Biome, Freq, Dur
Ambience
Disabled
Debug
"[Audio] Ambience tick skipped (Disabled/Wrong Phase)."
-

6. Testing Strategy
Unit Tests (AmbienceServiceTests.cs):
	•	Respects_Settings:
	◦	Set GameSettings.AmbienceEnabled = false.
	◦	Force UpdateAsync past cooldown.
	◦	Assert IAudioService.PlayAsync never called.
	•	Biome_Profile_Selection:
	◦	Set Room Biome to Industrial.
	◦	Force Update.
	◦	Assert PlayAsync called with Freq between 100-300Hz.
	•	Phase_Restriction:
	◦	Set Phase to Combat.
	◦	Force Update.
	◦	Assert PlayAsync never called (Ambience silences during combat to prioritize combat cues).
Manual QA:
	•	Stress Test: Leave the game running in an Industrial room. Listen for periodic low rumbles (every ~10s).
	•	Transition: Move from Industrial to Organic. Verify sound "texture" changes (Rumbles -> Skittering).

7. Draft Changelog (v0.3.19)
# Changelog: v0.3.19 - The Bard

**Release Date:** 2026-02-XX

## Summary
"The Bard" update introduces the audio framework to Rune & Rust. The game now provides auditory feedback for interactions, combat events, and environmental atmosphere, utilizing a cross-platform provider system that respects accessibility settings.

## Changes
- **Engine:** Implemented `IAudioService` and `SoundRegistry` for centralized audio management.
- **Terminal:** Added `ConsoleAudioProvider` for cross-platform system beeps.
- **Combat:** Wired Attack, Damage, and Death events to distinct sound cues (High pitch for Criticals, low thud for Blocks).
- **Atmosphere:** Added `AmbienceService` which generates procedural background audio based on the current Biome (e.g., machinery rumbles for The Roots, crystalline chimes for Niflheim).
- **Settings:** Integrated Master Volume and Ambience Toggles into the Options menu.