# v0.8.1a Design Specification: Map View Panel

**Version:** 0.8.1a
**Parent:** v0.8.1 (Navigation & Information)
**Prerequisites:** v0.8.0c Complete (Keyboard Shortcuts)
**Status:** Design Complete
**Estimated Unit Tests:** ~12

---

## Table of Contents

1. [Overview](#1-overview)
2. [Feature Overview](#2-feature-overview)
3. [Architecture](#3-architecture)
4. [Map View Panel](#4-map-view-panel)
5. [Room Node Control](#5-room-node-control)
6. [Connection Line Control](#6-connection-line-control)
7. [View Models](#7-view-models)
8. [Styles](#8-styles)
9. [Data Model Changes](#9-data-model-changes)
10. [Logging Specifications](#10-logging-specifications)
11. [Unit Testing Requirements](#11-unit-testing-requirements)
12. [Use Cases](#12-use-cases)
13. [Deliverable Checklist](#13-deliverable-checklist)
14. [Acceptance Criteria](#14-acceptance-criteria)
15. [Dependencies](#15-dependencies)
16. [Future Considerations](#16-future-considerations)

---

## 1. Overview

### Purpose

Implement a visual map view panel that displays the dungeon layout with explored rooms, connections between rooms, and the player's current location. The map provides spatial awareness during exploration and combat, with unexplored rooms appearing as "???" until visited. Room type icons and connection indicators (including locked doors) enhance navigation.

### Key Deliverables

| Category | Items |
|----------|-------|
| **Controls** | `MapViewPanel`, `RoomNodeControl`, `ConnectionLineControl` |
| **ViewModels** | `MapViewPanelViewModel`, `RoomNodeViewModel`, `ConnectionViewModel` |
| **Styles** | `MapViewStyles.axaml` |
| **Tests** | ~12 unit tests |

### Design Principles

1. **Fog of War**: Only explored rooms are fully visible
2. **Current Location**: Player's position clearly highlighted
3. **Connection Clarity**: Paths and locked doors visually distinct
4. **Type Recognition**: Room icons indicate function (shop, boss, etc.)
5. **Zoom & Pan**: Optional navigation for larger dungeons

---

## 2. Feature Overview

```
v0.8.1a Features
â”œâ”€â”€ MapViewPanel UserControl
â”‚   â”œâ”€â”€ Canvas-based room layout
â”‚   â”œâ”€â”€ Connection line rendering
â”‚   â”œâ”€â”€ Zoom controls (+/âˆ’/reset)
â”‚   â”œâ”€â”€ Pan with drag
â”‚   â”œâ”€â”€ Legend display
â”‚   â””â”€â”€ Title bar with controls
â”‚
â”œâ”€â”€ RoomNodeControl
â”‚   â”œâ”€â”€ Room name (or "???")
â”‚   â”œâ”€â”€ Explored/unexplored state
â”‚   â”œâ”€â”€ Current room highlight
â”‚   â”œâ”€â”€ Room type icon
â”‚   â””â”€â”€ Hover for details
â”‚
â”œâ”€â”€ ConnectionLineControl
â”‚   â”œâ”€â”€ Standard connection (â”€)
â”‚   â”œâ”€â”€ Locked connection (â•)
â”‚   â”œâ”€â”€ Direction indicators
â”‚   â””â”€â”€ Visibility based on exploration
â”‚
â”œâ”€â”€ MapViewPanelViewModel
â”‚   â”œâ”€â”€ Room collection binding
â”‚   â”œâ”€â”€ Connection collection binding
â”‚   â”œâ”€â”€ Current room tracking
â”‚   â”œâ”€â”€ Zoom level control
â”‚   â”œâ”€â”€ Pan offset tracking
â”‚   â””â”€â”€ Room change event handling
â”‚
â”œâ”€â”€ RoomNodeViewModel
â”‚   â”œâ”€â”€ Room data wrapper
â”‚   â”œâ”€â”€ Position (X, Y)
â”‚   â”œâ”€â”€ Exploration state
â”‚   â””â”€â”€ Room type icon resolver
â”‚
â”œâ”€â”€ ConnectionViewModel
â”‚   â”œâ”€â”€ Source room reference
â”‚   â”œâ”€â”€ Target room reference
â”‚   â”œâ”€â”€ Locked state
â”‚   â””â”€â”€ Line coordinates
â”‚
â””â”€â”€ Keyboard Integration
    â””â”€â”€ M key toggles map visibility
```

---

## 3. Architecture

### Component Diagram

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                       PRESENTATION LAYER                                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Controls                                                               â”‚
â”‚  â”œâ”€â”€ MapViewPanel : UserControl                                         â”‚
â”‚  â”‚    â”œâ”€â”€ TitleBar (DUNGEON MAP + zoom controls)                       â”‚
â”‚  â”‚    â”œâ”€â”€ Canvas (room nodes + connection lines)                       â”‚
â”‚  â”‚    â””â”€â”€ Legend (symbols explained)                                   â”‚
â”‚  â”‚                                                                     â”‚
â”‚  â”œâ”€â”€ RoomNodeControl : TemplatedControl                                â”‚
â”‚  â”‚    â”œâ”€â”€ Room? Room (styled property)                                 â”‚
â”‚  â”‚    â”œâ”€â”€ bool IsExplored (styled property)                            â”‚
â”‚  â”‚    â”œâ”€â”€ bool IsCurrent (styled property)                             â”‚
â”‚  â”‚    â””â”€â”€ RoomType RoomType (styled property)                          â”‚
â”‚  â”‚                                                                     â”‚
â”‚  â””â”€â”€ ConnectionLineControl : TemplatedControl                          â”‚
â”‚       â”œâ”€â”€ Point Start (styled property)                                â”‚
â”‚       â”œâ”€â”€ Point End (styled property)                                  â”‚
â”‚       â””â”€â”€ bool IsLocked (styled property)                              â”‚
â”‚                                                                         â”‚
â”‚  ViewModels                                                             â”‚
â”‚  â”œâ”€â”€ MapViewPanelViewModel : ViewModelBase                             â”‚
â”‚  â”‚    â”œâ”€â”€ ObservableCollection<RoomNodeViewModel> Rooms                â”‚
â”‚  â”‚    â”œâ”€â”€ ObservableCollection<ConnectionViewModel> Connections        â”‚
â”‚  â”‚    â”œâ”€â”€ Guid CurrentRoomId                                           â”‚
â”‚  â”‚    â”œâ”€â”€ double ZoomLevel                                             â”‚
â”‚  â”‚    â”œâ”€â”€ Point PanOffset                                              â”‚
â”‚  â”‚    â”œâ”€â”€ bool IsVisible                                               â”‚
â”‚  â”‚    â”œâ”€â”€ [RelayCommand] ZoomIn()                                      â”‚
â”‚  â”‚    â”œâ”€â”€ [RelayCommand] ZoomOut()                                     â”‚
â”‚  â”‚    â””â”€â”€ [RelayCommand] CenterOnPlayer()                              â”‚
â”‚  â”‚                                                                     â”‚
â”‚  â”œâ”€â”€ RoomNodeViewModel : ViewModelBase                                 â”‚
â”‚  â”‚    â”œâ”€â”€ Guid RoomId                                                  â”‚
â”‚  â”‚    â”œâ”€â”€ string DisplayName                                           â”‚
â”‚  â”‚    â”œâ”€â”€ double X, Y                                                  â”‚
â”‚  â”‚    â”œâ”€â”€ bool IsExplored                                              â”‚
â”‚  â”‚    â”œâ”€â”€ bool IsCurrent                                               â”‚
â”‚  â”‚    â””â”€â”€ string Icon                                                  â”‚
â”‚  â”‚                                                                     â”‚
â”‚  â””â”€â”€ ConnectionViewModel : ViewModelBase                               â”‚
â”‚       â”œâ”€â”€ Point StartPoint                                             â”‚
â”‚       â”œâ”€â”€ Point EndPoint                                               â”‚
â”‚       â””â”€â”€ bool IsLocked                                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                     â”‚
                                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                       APPLICATION LAYER                                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Services                                                               â”‚
â”‚  â”œâ”€â”€ IGameSessionService                                               â”‚
â”‚  â”‚    â”œâ”€â”€ GetExploredRooms(): IReadOnlyList<Room>                      â”‚
â”‚  â”‚    â”œâ”€â”€ GetCurrentRoom(): Room                                       â”‚
â”‚  â”‚    â””â”€â”€ event OnRoomChanged(Room room)                               â”‚
â”‚  â”‚                                                                     â”‚
â”‚  â””â”€â”€ IRoomMapService                                                   â”‚
â”‚       â”œâ”€â”€ CalculateLayout(rooms): Dictionary<Room, Point>              â”‚
â”‚       â””â”€â”€ GetConnections(rooms): IReadOnlyList<RoomConnection>         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                     â”‚
                                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         DOMAIN LAYER                                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Entities                                                               â”‚
â”‚  â””â”€â”€ Room                                                               â”‚
â”‚       â”œâ”€â”€ Guid Id                                                       â”‚
â”‚       â”œâ”€â”€ string Name                                                   â”‚
â”‚       â”œâ”€â”€ RoomType Type                                                 â”‚
â”‚       â””â”€â”€ IReadOnlyList<RoomConnection> Connections                    â”‚
â”‚                                                                         â”‚
â”‚  Value Objects                                                          â”‚
â”‚  â””â”€â”€ RoomConnection                                                     â”‚
â”‚       â”œâ”€â”€ Guid TargetRoomId                                            â”‚
â”‚       â”œâ”€â”€ Direction Direction                                          â”‚
â”‚       â””â”€â”€ bool IsLocked                                                 â”‚
â”‚                                                                         â”‚
â”‚  Enums                                                                  â”‚
â”‚  â””â”€â”€ RoomType { Standard, Shop, Armory, Boss, Exit, Danger, Treasure } â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Map Rendering Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                       MAP RENDERING FLOW                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

    Game Session Initialization / Room Change Event
                        â”‚
                        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                 MapViewPanelViewModel.BuildMapLayout()                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  1. Clear existing rooms and connections                               â”‚
â”‚  2. Get explored rooms from IGameSessionService                        â”‚
â”‚  3. Calculate layout positions via IRoomMapService                     â”‚
â”‚  4. Create RoomNodeViewModel for each room                             â”‚
â”‚  5. Create ConnectionViewModel for each connection                     â”‚
â”‚  6. Update CurrentRoomId to highlight                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚
                        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      MapViewPanel Rendering                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  1. Apply zoom transform (ScaleTransform)                              â”‚
â”‚  2. Apply pan transform (TranslateTransform)                           â”‚
â”‚  3. Render ConnectionLineControls for each connection                  â”‚
â”‚  4. Render RoomNodeControls for each room                              â”‚
â”‚  5. Apply styling based on exploration state                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 4. Map View Panel

### MapViewPanel.axaml

**File:** `src/Presentation/RuneAndRust.Avalonia/Controls/MapViewPanel.axaml`

```xml
<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:vm="using:RuneAndRust.Avalonia.ViewModels"
             xmlns:controls="using:RuneAndRust.Avalonia.Controls"
             x:Class="RuneAndRust.Avalonia.Controls.MapViewPanel"
             x:DataType="vm:MapViewPanelViewModel"
             IsVisible="{Binding IsVisible}">
    
    <Border Classes="map-panel" CornerRadius="4">
        <Grid RowDefinitions="Auto,*,Auto">
            
            <!-- Title Bar -->
            <Border Grid.Row="0" Classes="map-header" Padding="12,8">
                <Grid ColumnDefinitions="*,Auto">
                    <TextBlock Grid.Column="0" 
                               Text="DUNGEON MAP" 
                               Classes="map-title" />
                    
                    <StackPanel Grid.Column="1" 
                                Orientation="Horizontal" 
                                Spacing="4">
                        <Button Content="âˆ’" 
                                Command="{Binding ZoomOutCommand}"
                                Classes="zoom-button"
                                ToolTip.Tip="Zoom Out" />
                        <Button Content="+" 
                                Command="{Binding ZoomInCommand}"
                                Classes="zoom-button"
                                ToolTip.Tip="Zoom In" />
                        <Button Content="â—" 
                                Command="{Binding CenterOnPlayerCommand}"
                                Classes="zoom-button"
                                ToolTip.Tip="Center on Player" />
                    </StackPanel>
                </Grid>
            </Border>
            
            <!-- Map Canvas -->
            <Border Grid.Row="1" 
                    ClipToBounds="True" 
                    Background="{StaticResource MapBackgroundBrush}">
                <Canvas x:Name="MapCanvas"
                        PointerPressed="OnCanvasPointerPressed"
                        PointerMoved="OnCanvasPointerMoved"
                        PointerReleased="OnCanvasPointerReleased">
                    
                    <Canvas.RenderTransform>
                        <TransformGroup>
                            <ScaleTransform ScaleX="{Binding ZoomLevel}" 
                                           ScaleY="{Binding ZoomLevel}" />
                            <TranslateTransform X="{Binding PanOffset.X}" 
                                               Y="{Binding PanOffset.Y}" />
                        </TransformGroup>
                    </Canvas.RenderTransform>
                    
                    <!-- Connection Lines (rendered first, behind rooms) -->
                    <ItemsControl ItemsSource="{Binding Connections}">
                        <ItemsControl.ItemsPanel>
                            <ItemsPanelTemplate>
                                <Canvas />
                            </ItemsPanelTemplate>
                        </ItemsControl.ItemsPanel>
                        <ItemsControl.ItemTemplate>
                            <DataTemplate DataType="vm:ConnectionViewModel">
                                <controls:ConnectionLineControl
                                    StartPoint="{Binding StartPoint}"
                                    EndPoint="{Binding EndPoint}"
                                    IsLocked="{Binding IsLocked}" />
                            </DataTemplate>
                        </ItemsControl.ItemTemplate>
                    </ItemsControl>
                    
                    <!-- Room Nodes -->
                    <ItemsControl ItemsSource="{Binding Rooms}">
                        <ItemsControl.ItemsPanel>
                            <ItemsPanelTemplate>
                                <Canvas />
                            </ItemsPanelTemplate>
                        </ItemsControl.ItemsPanel>
                        <ItemsControl.ItemTemplate>
                            <DataTemplate DataType="vm:RoomNodeViewModel">
                                <controls:RoomNodeControl
                                    Canvas.Left="{Binding X}"
                                    Canvas.Top="{Binding Y}"
                                    DisplayName="{Binding DisplayName}"
                                    Icon="{Binding Icon}"
                                    IsExplored="{Binding IsExplored}"
                                    IsCurrent="{Binding IsCurrent}"
                                    ToolTip.Tip="{Binding TooltipText}" />
                            </DataTemplate>
                        </ItemsControl.ItemTemplate>
                    </ItemsControl>
                    
                </Canvas>
            </Border>
            
            <!-- Legend -->
            <Border Grid.Row="2" Classes="map-legend" Padding="12,8">
                <WrapPanel Orientation="Horizontal" HorizontalAlignment="Center">
                    <StackPanel Orientation="Horizontal" Margin="0,0,16,0">
                        <TextBlock Text="[@]" Classes="legend-symbol current" />
                        <TextBlock Text="You" Classes="legend-label" />
                    </StackPanel>
                    <StackPanel Orientation="Horizontal" Margin="0,0,16,0">
                        <TextBlock Text="[???]" Classes="legend-symbol" />
                        <TextBlock Text="Unexplored" Classes="legend-label" />
                    </StackPanel>
                    <StackPanel Orientation="Horizontal" Margin="0,0,16,0">
                        <TextBlock Text="â•â•" Classes="legend-symbol locked" />
                        <TextBlock Text="Locked" Classes="legend-label" />
                    </StackPanel>
                    <StackPanel Orientation="Horizontal" Margin="0,0,16,0">
                        <TextBlock Text="ğŸ’°" Classes="legend-symbol" />
                        <TextBlock Text="Shop" Classes="legend-label" />
                    </StackPanel>
                    <StackPanel Orientation="Horizontal" Margin="0,0,16,0">
                        <TextBlock Text="ğŸ›¡" Classes="legend-symbol" />
                        <TextBlock Text="Armory" Classes="legend-label" />
                    </StackPanel>
                    <StackPanel Orientation="Horizontal">
                        <TextBlock Text="â˜ " Classes="legend-symbol danger" />
                        <TextBlock Text="Boss" Classes="legend-label" />
                    </StackPanel>
                </WrapPanel>
            </Border>
            
        </Grid>
    </Border>
</UserControl>
```

### MapViewPanel Code-Behind

**File:** `src/Presentation/RuneAndRust.Avalonia/Controls/MapViewPanel.axaml.cs`

```csharp
namespace RuneAndRust.Avalonia.Controls;

public partial class MapViewPanel : UserControl
{
    private bool _isPanning;
    private Point _panStart;
    private Point _panOffsetStart;

    public MapViewPanel()
    {
        InitializeComponent();
    }

    private void OnCanvasPointerPressed(object? sender, PointerPressedEventArgs e)
    {
        if (e.GetCurrentPoint(this).Properties.IsLeftButtonPressed)
        {
            _isPanning = true;
            _panStart = e.GetPosition(this);
            
            if (DataContext is MapViewPanelViewModel vm)
            {
                _panOffsetStart = vm.PanOffset;
            }
            
            e.Handled = true;
        }
    }

    private void OnCanvasPointerMoved(object? sender, PointerEventArgs e)
    {
        if (_isPanning && DataContext is MapViewPanelViewModel vm)
        {
            var currentPos = e.GetPosition(this);
            var delta = currentPos - _panStart;
            
            vm.PanOffset = new Point(
                _panOffsetStart.X + delta.X,
                _panOffsetStart.Y + delta.Y
            );
        }
    }

    private void OnCanvasPointerReleased(object? sender, PointerReleasedEventArgs e)
    {
        _isPanning = false;
    }
}
```

---

## 5. Room Node Control

### RoomNodeControl

**File:** `src/Presentation/RuneAndRust.Avalonia/Controls/RoomNodeControl.cs`

```csharp
namespace RuneAndRust.Avalonia.Controls;

/// <summary>
/// Displays a room node on the dungeon map.
/// </summary>
/// <remarks>
/// The control renders as a bordered rectangle showing the room name
/// (or "???" if unexplored), with an optional type icon. The current
/// room is highlighted with a gold border.
/// </remarks>
public class RoomNodeControl : TemplatedControl
{
    public static readonly StyledProperty<string> DisplayNameProperty =
        AvaloniaProperty.Register<RoomNodeControl, string>(nameof(DisplayName), "???");

    public static readonly StyledProperty<string> IconProperty =
        AvaloniaProperty.Register<RoomNodeControl, string>(nameof(Icon), "");

    public static readonly StyledProperty<bool> IsExploredProperty =
        AvaloniaProperty.Register<RoomNodeControl, bool>(nameof(IsExplored), false);

    public static readonly StyledProperty<bool> IsCurrentProperty =
        AvaloniaProperty.Register<RoomNodeControl, bool>(nameof(IsCurrent), false);

    /// <summary>
    /// Gets or sets the display name shown on the room node.
    /// </summary>
    public string DisplayName
    {
        get => GetValue(DisplayNameProperty);
        set => SetValue(DisplayNameProperty, value);
    }

    /// <summary>
    /// Gets or sets the room type icon (emoji or glyph).
    /// </summary>
    public string Icon
    {
        get => GetValue(IconProperty);
        set => SetValue(IconProperty, value);
    }

    /// <summary>
    /// Gets or sets whether the room has been explored.
    /// </summary>
    public bool IsExplored
    {
        get => GetValue(IsExploredProperty);
        set => SetValue(IsExploredProperty, value);
    }

    /// <summary>
    /// Gets or sets whether this is the player's current room.
    /// </summary>
    public bool IsCurrent
    {
        get => GetValue(IsCurrentProperty);
        set => SetValue(IsCurrentProperty, value);
    }
}
```

### RoomNodeControl Template

**File:** `src/Presentation/RuneAndRust.Avalonia/Controls/RoomNodeControl.axaml`

```xml
<ResourceDictionary xmlns="https://github.com/avaloniaui"
                    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
                    xmlns:controls="using:RuneAndRust.Avalonia.Controls">
    
    <ControlTheme x:Key="{x:Type controls:RoomNodeControl}" 
                  TargetType="controls:RoomNodeControl">
        
        <Setter Property="Width" Value="80" />
        <Setter Property="Height" Value="50" />
        <Setter Property="Cursor" Value="Hand" />
        
        <Setter Property="Template">
            <ControlTemplate>
                <Border x:Name="RoomBorder"
                        CornerRadius="4"
                        BorderThickness="2"
                        Background="{StaticResource RoomBackgroundBrush}"
                        BorderBrush="{StaticResource RoomBorderBrush}">
                    <Grid RowDefinitions="*,Auto">
                        
                        <!-- Room Name -->
                        <TextBlock Grid.Row="0"
                                   Text="{TemplateBinding DisplayName}"
                                   HorizontalAlignment="Center"
                                   VerticalAlignment="Center"
                                   FontSize="11"
                                   TextTrimming="CharacterEllipsis"
                                   Margin="4" />
                        
                        <!-- Room Type Icon -->
                        <TextBlock Grid.Row="1"
                                   Text="{TemplateBinding Icon}"
                                   HorizontalAlignment="Center"
                                   FontSize="12"
                                   IsVisible="{TemplateBinding IsExplored}"
                                   Margin="0,0,0,4" />
                        
                        <!-- Current Room Indicator -->
                        <TextBlock Grid.Row="0"
                                   Text="[@]"
                                   HorizontalAlignment="Left"
                                   VerticalAlignment="Top"
                                   FontSize="9"
                                   Foreground="Gold"
                                   IsVisible="{TemplateBinding IsCurrent}"
                                   Margin="2" />
                        
                    </Grid>
                </Border>
            </ControlTemplate>
        </Setter>
        
        <!-- Current Room Style -->
        <Style Selector="^[IsCurrent=True] /template/ Border#RoomBorder">
            <Setter Property="BorderBrush" Value="Gold" />
            <Setter Property="Background" Value="{StaticResource CurrentRoomBackgroundBrush}" />
        </Style>
        
        <!-- Unexplored Room Style -->
        <Style Selector="^[IsExplored=False] /template/ Border#RoomBorder">
            <Setter Property="Background" Value="{StaticResource UnexploredRoomBackgroundBrush}" />
            <Setter Property="Opacity" Value="0.6" />
        </Style>
        
    </ControlTheme>
    
</ResourceDictionary>
```

---

## 6. Connection Line Control

### ConnectionLineControl

**File:** `src/Presentation/RuneAndRust.Avalonia/Controls/ConnectionLineControl.cs`

```csharp
namespace RuneAndRust.Avalonia.Controls;

/// <summary>
/// Renders a connection line between two room nodes on the map.
/// </summary>
/// <remarks>
/// Standard connections are rendered as single lines.
/// Locked connections are rendered as double lines (â•â•).
/// </remarks>
public class ConnectionLineControl : Control
{
    public static readonly StyledProperty<Point> StartPointProperty =
        AvaloniaProperty.Register<ConnectionLineControl, Point>(nameof(StartPoint));

    public static readonly StyledProperty<Point> EndPointProperty =
        AvaloniaProperty.Register<ConnectionLineControl, Point>(nameof(EndPoint));

    public static readonly StyledProperty<bool> IsLockedProperty =
        AvaloniaProperty.Register<ConnectionLineControl, bool>(nameof(IsLocked), false);

    private static readonly IPen StandardPen = new Pen(Brushes.DimGray, 2);
    private static readonly IPen LockedPen = new Pen(Brushes.DimGray, 2, 
        dashStyle: new DashStyle(new[] { 4.0, 2.0 }, 0));

    public Point StartPoint
    {
        get => GetValue(StartPointProperty);
        set => SetValue(StartPointProperty, value);
    }

    public Point EndPoint
    {
        get => GetValue(EndPointProperty);
        set => SetValue(EndPointProperty, value);
    }

    public bool IsLocked
    {
        get => GetValue(IsLockedProperty);
        set => SetValue(IsLockedProperty, value);
    }

    static ConnectionLineControl()
    {
        AffectsRender<ConnectionLineControl>(StartPointProperty, EndPointProperty, IsLockedProperty);
    }

    public override void Render(DrawingContext context)
    {
        base.Render(context);

        var pen = IsLocked ? LockedPen : StandardPen;
        context.DrawLine(pen, StartPoint, EndPoint);

        // Draw double line for locked connections
        if (IsLocked)
        {
            var offset = CalculatePerpendicularOffset(StartPoint, EndPoint, 4);
            context.DrawLine(pen, StartPoint + offset, EndPoint + offset);
        }
    }

    private static Vector CalculatePerpendicularOffset(Point start, Point end, double distance)
    {
        var direction = end - start;
        var length = Math.Sqrt(direction.X * direction.X + direction.Y * direction.Y);
        
        if (length == 0) return new Vector(0, 0);

        // Perpendicular vector
        return new Vector(-direction.Y / length * distance, direction.X / length * distance);
    }
}
```

---

## 7. View Models

### MapViewPanelViewModel

**File:** `src/Presentation/RuneAndRust.Avalonia/ViewModels/MapViewPanelViewModel.cs`

```csharp
namespace RuneAndRust.Avalonia.ViewModels;

/// <summary>
/// ViewModel for the dungeon map view panel.
/// </summary>
/// <remarks>
/// Manages the visual representation of explored rooms and their connections.
/// Subscribes to room change events to update the map in real-time.
/// </remarks>
public partial class MapViewPanelViewModel : ViewModelBase, IDisposable
{
    private readonly IGameSessionService _gameSession;
    private readonly IRoomMapService _roomMap;
    private readonly ILogger<MapViewPanelViewModel> _logger;

    [ObservableProperty]
    private ObservableCollection<RoomNodeViewModel> _rooms = new();

    [ObservableProperty]
    private ObservableCollection<ConnectionViewModel> _connections = new();

    [ObservableProperty]
    private Guid _currentRoomId;

    [ObservableProperty]
    private double _zoomLevel = 1.0;

    [ObservableProperty]
    private Point _panOffset = new(0, 0);

    [ObservableProperty]
    private bool _isVisible = false;

    private const double MinZoom = 0.5;
    private const double MaxZoom = 2.0;
    private const double ZoomStep = 0.25;

    public MapViewPanelViewModel(
        IGameSessionService gameSession, 
        IRoomMapService roomMap,
        ILogger<MapViewPanelViewModel> logger)
    {
        _gameSession = gameSession;
        _roomMap = roomMap;
        _logger = logger;

        _gameSession.OnRoomChanged += HandleRoomChanged;

        BuildMapLayout();
        _logger.LogDebug("MapViewPanelViewModel initialized with {RoomCount} rooms", Rooms.Count);
    }

    /// <summary>
    /// Zooms the map in by one step.
    /// </summary>
    [RelayCommand]
    private void ZoomIn()
    {
        ZoomLevel = Math.Min(MaxZoom, ZoomLevel + ZoomStep);
        _logger.LogDebug("Map zoomed in to {ZoomLevel}", ZoomLevel);
    }

    /// <summary>
    /// Zooms the map out by one step.
    /// </summary>
    [RelayCommand]
    private void ZoomOut()
    {
        ZoomLevel = Math.Max(MinZoom, ZoomLevel - ZoomStep);
        _logger.LogDebug("Map zoomed out to {ZoomLevel}", ZoomLevel);
    }

    /// <summary>
    /// Centers the map view on the player's current room.
    /// </summary>
    [RelayCommand]
    private void CenterOnPlayer()
    {
        var currentRoom = Rooms.FirstOrDefault(r => r.RoomId == CurrentRoomId);
        if (currentRoom is not null)
        {
            // Center in a 400x400 viewport (adjust based on actual panel size)
            PanOffset = new Point(-currentRoom.X + 200, -currentRoom.Y + 200);
            _logger.LogDebug("Map centered on player at room {RoomId}", CurrentRoomId);
        }
    }

    /// <summary>
    /// Toggles map visibility (called via M key shortcut).
    /// </summary>
    public void ToggleVisibility()
    {
        IsVisible = !IsVisible;
        _logger.LogDebug("Map visibility toggled to {IsVisible}", IsVisible);
    }

    private void BuildMapLayout()
    {
        Rooms.Clear();
        Connections.Clear();

        var exploredRooms = _gameSession.GetExploredRooms();
        var currentRoom = _gameSession.GetCurrentRoom();
        CurrentRoomId = currentRoom?.Id ?? Guid.Empty;

        var layout = _roomMap.CalculateLayout(exploredRooms);

        foreach (var (room, position) in layout)
        {
            var isExplored = exploredRooms.Any(r => r.Id == room.Id);
            var isCurrent = room.Id == CurrentRoomId;

            Rooms.Add(new RoomNodeViewModel(room, position, isExplored, isCurrent));
        }

        var roomConnections = _roomMap.GetConnections(exploredRooms);
        foreach (var connection in roomConnections)
        {
            var sourceRoom = Rooms.FirstOrDefault(r => r.RoomId == connection.SourceRoomId);
            var targetRoom = Rooms.FirstOrDefault(r => r.RoomId == connection.TargetRoomId);

            if (sourceRoom is not null && targetRoom is not null)
            {
                Connections.Add(new ConnectionViewModel(
                    new Point(sourceRoom.X + 40, sourceRoom.Y + 25), // Center of source
                    new Point(targetRoom.X + 40, targetRoom.Y + 25), // Center of target
                    connection.IsLocked
                ));
            }
        }

        _logger.LogInformation("Map layout built: {RoomCount} rooms, {ConnectionCount} connections",
            Rooms.Count, Connections.Count);
    }

    private void HandleRoomChanged(Room room)
    {
        CurrentRoomId = room.Id;
        BuildMapLayout(); // Rebuild to include newly explored rooms
        
        _logger.LogDebug("Map updated for room change: {RoomName}", room.Name);
    }

    public void Dispose()
    {
        _gameSession.OnRoomChanged -= HandleRoomChanged;
    }
}
```

### RoomNodeViewModel

**File:** `src/Presentation/RuneAndRust.Avalonia/ViewModels/RoomNodeViewModel.cs`

```csharp
namespace RuneAndRust.Avalonia.ViewModels;

/// <summary>
/// ViewModel representing a room node on the map.
/// </summary>
public partial class RoomNodeViewModel : ViewModelBase
{
    public Guid RoomId { get; }

    [ObservableProperty]
    private string _displayName;

    [ObservableProperty]
    private double _x;

    [ObservableProperty]
    private double _y;

    [ObservableProperty]
    private bool _isExplored;

    [ObservableProperty]
    private bool _isCurrent;

    [ObservableProperty]
    private string _icon;

    [ObservableProperty]
    private string _tooltipText;

    public RoomNodeViewModel(Room room, Point position, bool isExplored, bool isCurrent)
    {
        RoomId = room.Id;
        X = position.X;
        Y = position.Y;
        IsExplored = isExplored;
        IsCurrent = isCurrent;

        DisplayName = isExplored ? room.Name : "???";
        Icon = GetRoomIcon(room.Type, isExplored);
        TooltipText = BuildTooltip(room, isExplored, isCurrent);
    }

    private static string GetRoomIcon(RoomType type, bool isExplored)
    {
        if (!isExplored) return "";

        return type switch
        {
            RoomType.Shop => "ğŸ’°",
            RoomType.Armory => "ğŸ›¡",
            RoomType.Boss => "â˜ ",
            RoomType.Exit => "ğŸšª",
            RoomType.Danger => "âš ",
            RoomType.Treasure => "ğŸ’",
            _ => ""
        };
    }

    private static string BuildTooltip(Room room, bool isExplored, bool isCurrent)
    {
        if (!isExplored) return "Unexplored area";

        var tooltip = room.Name;
        
        if (isCurrent)
            tooltip += " (You are here)";

        if (room.Type != RoomType.Standard)
            tooltip += $"\n{room.Type}";

        return tooltip;
    }
}
```

### ConnectionViewModel

**File:** `src/Presentation/RuneAndRust.Avalonia/ViewModels/ConnectionViewModel.cs`

```csharp
namespace RuneAndRust.Avalonia.ViewModels;

/// <summary>
/// ViewModel representing a connection between two rooms on the map.
/// </summary>
public partial class ConnectionViewModel : ViewModelBase
{
    [ObservableProperty]
    private Point _startPoint;

    [ObservableProperty]
    private Point _endPoint;

    [ObservableProperty]
    private bool _isLocked;

    public ConnectionViewModel(Point startPoint, Point endPoint, bool isLocked)
    {
        StartPoint = startPoint;
        EndPoint = endPoint;
        IsLocked = isLocked;
    }
}
```

---

## 8. Styles

**File:** `src/Presentation/RuneAndRust.Avalonia/Styles/MapViewStyles.axaml`

```xml
<Styles xmlns="https://github.com/avaloniaui"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml">
    
    <!-- Color Resources -->
    <Style>
        <Style.Resources>
            <SolidColorBrush x:Key="MapBackgroundBrush" Color="#1a1a2e" />
            <SolidColorBrush x:Key="RoomBackgroundBrush" Color="#2d2d44" />
            <SolidColorBrush x:Key="RoomBorderBrush" Color="#4a4a6a" />
            <SolidColorBrush x:Key="CurrentRoomBackgroundBrush" Color="#3d3d1e" />
            <SolidColorBrush x:Key="UnexploredRoomBackgroundBrush" Color="#1a1a1a" />
        </Style.Resources>
    </Style>
    
    <!-- Map Panel Container -->
    <Style Selector="Border.map-panel">
        <Setter Property="Background" Value="{StaticResource SurfaceBrush}" />
        <Setter Property="BorderBrush" Value="{StaticResource BorderBrush}" />
        <Setter Property="BorderThickness" Value="1" />
    </Style>
    
    <!-- Map Header -->
    <Style Selector="Border.map-header">
        <Setter Property="Background" Value="{StaticResource SurfaceDarkBrush}" />
        <Setter Property="BorderThickness" Value="0,0,0,1" />
        <Setter Property="BorderBrush" Value="{StaticResource BorderBrush}" />
    </Style>
    
    <!-- Map Title -->
    <Style Selector="TextBlock.map-title">
        <Setter Property="FontSize" Value="14" />
        <Setter Property="FontWeight" Value="SemiBold" />
        <Setter Property="Foreground" Value="{StaticResource ForegroundBrush}" />
    </Style>
    
    <!-- Zoom Buttons -->
    <Style Selector="Button.zoom-button">
        <Setter Property="Width" Value="28" />
        <Setter Property="Height" Value="28" />
        <Setter Property="FontSize" Value="14" />
        <Setter Property="FontWeight" Value="Bold" />
        <Setter Property="Padding" Value="0" />
    </Style>
    
    <!-- Map Legend -->
    <Style Selector="Border.map-legend">
        <Setter Property="Background" Value="{StaticResource SurfaceDarkBrush}" />
        <Setter Property="BorderThickness" Value="0,1,0,0" />
        <Setter Property="BorderBrush" Value="{StaticResource BorderBrush}" />
    </Style>
    
    <!-- Legend Symbol -->
    <Style Selector="TextBlock.legend-symbol">
        <Setter Property="FontFamily" Value="Consolas, Menlo, monospace" />
        <Setter Property="Foreground" Value="{StaticResource MutedBrush}" />
        <Setter Property="Margin" Value="0,0,4,0" />
    </Style>
    
    <Style Selector="TextBlock.legend-symbol.current">
        <Setter Property="Foreground" Value="Gold" />
    </Style>
    
    <Style Selector="TextBlock.legend-symbol.locked">
        <Setter Property="Foreground" Value="{StaticResource AccentBrush}" />
    </Style>
    
    <Style Selector="TextBlock.legend-symbol.danger">
        <Setter Property="Foreground" Value="{StaticResource DangerBrush}" />
    </Style>
    
    <!-- Legend Label -->
    <Style Selector="TextBlock.legend-label">
        <Setter Property="FontSize" Value="11" />
        <Setter Property="Foreground" Value="{StaticResource MutedBrush}" />
        <Setter Property="VerticalAlignment" Value="Center" />
    </Style>
    
</Styles>
```

---

## 9. Data Model Changes

### New Types

| Type | Layer | Description |
|------|-------|-------------|
| `MapViewPanel` | Presentation | Main map panel control |
| `RoomNodeControl` | Presentation | Individual room display |
| `ConnectionLineControl` | Presentation | Room connection line |
| `MapViewPanelViewModel` | Presentation | Map panel ViewModel |
| `RoomNodeViewModel` | Presentation | Room node ViewModel |
| `ConnectionViewModel` | Presentation | Connection ViewModel |

### Extended Interfaces

| Interface | New Method | Description |
|-----------|------------|-------------|
| `IGameSessionService` | `GetExploredRooms()` | Returns list of explored rooms |
| `IGameSessionService` | `GetCurrentRoom()` | Returns current room |
| `IGameSessionService` | `OnRoomChanged` event | Fired when player enters new room |

### New Service (Optional)

| Interface | Description |
|-----------|-------------|
| `IRoomMapService` | Calculates room layout positions and connections |

```csharp
public interface IRoomMapService
{
    /// <summary>
    /// Calculates 2D positions for rooms on the map.
    /// </summary>
    Dictionary<Room, Point> CalculateLayout(IReadOnlyList<Room> rooms);

    /// <summary>
    /// Gets all connections between the provided rooms.
    /// </summary>
    IReadOnlyList<RoomConnectionInfo> GetConnections(IReadOnlyList<Room> rooms);
}

public record RoomConnectionInfo(
    Guid SourceRoomId, 
    Guid TargetRoomId, 
    bool IsLocked
);
```

---

## 10. Logging Specifications

| Component | Level | Events |
|-----------|-------|--------|
| `MapViewPanelViewModel` | Debug | Zoom changes, center on player |
| `MapViewPanelViewModel` | Debug | Visibility toggle |
| `MapViewPanelViewModel` | Debug | Room change handled |
| `MapViewPanelViewModel` | Information | Map layout built (room/connection counts) |
| `RoomMapService` | Debug | Layout calculation details |

### Log Message Examples

```
Debug: MapViewPanelViewModel initialized with 7 rooms
Debug: Map zoomed in to 1.25
Debug: Map centered on player at room 3f2504e0-4f89-11d3-9a0c-0305e82c3301
Debug: Map visibility toggled to True
Information: Map layout built: 7 rooms, 6 connections
Debug: Map updated for room change: Dark Cave
```

---

## 11. Unit Testing Requirements

| Feature | Tests |
|---------|-------|
| Room node exploration state | 2 |
| Room node icon resolution | 2 |
| Connection locked state | 2 |
| Zoom level constraints | 2 |
| Map layout building | 2 |
| Room change handling | 2 |
| **Total** | **~12** |

### Test Specifications

**File:** `tests/RuneAndRust.Avalonia.UnitTests/ViewModels/MapViewPanelViewModelTests.cs`

```csharp
[TestFixture]
public class MapViewPanelViewModelTests
{
    [Test]
    public void Constructor_WithExploredRooms_PopulatesRoomCollection();

    [Test]
    public void Constructor_WithConnections_PopulatesConnectionCollection();

    [Test]
    public void ZoomIn_WhenBelowMax_IncreasesZoomLevel();

    [Test]
    public void ZoomIn_WhenAtMax_DoesNotExceedMax();

    [Test]
    public void ZoomOut_WhenAboveMin_DecreasesZoomLevel();

    [Test]
    public void ZoomOut_WhenAtMin_DoesNotGoBelowMin();

    [Test]
    public void CenterOnPlayer_UpdatesPanOffset();

    [Test]
    public void HandleRoomChanged_UpdatesCurrentRoomId();

    [Test]
    public void HandleRoomChanged_RebuildLayout_AddsNewRooms();

    [Test]
    public void ToggleVisibility_TogglesIsVisible();
}
```

**File:** `tests/RuneAndRust.Avalonia.UnitTests/ViewModels/RoomNodeViewModelTests.cs`

```csharp
[TestFixture]
public class RoomNodeViewModelTests
{
    [Test]
    public void Constructor_ExploredRoom_ShowsRoomName();

    [Test]
    public void Constructor_UnexploredRoom_ShowsQuestionMarks();

    [Test]
    public void GetRoomIcon_ShopRoom_ReturnsMoneyBag();

    [Test]
    public void GetRoomIcon_BossRoom_ReturnsSkull();

    [Test]
    public void GetRoomIcon_UnexploredRoom_ReturnsEmpty();

    [Test]
    public void BuildTooltip_CurrentRoom_IncludesYouAreHere();
}
```

---

## 12. Use Cases

### UC-081a-001: View Dungeon Map
**Actor:** Player
**Precondition:** Player has entered at least one room
**Flow:** Player presses M key â†’ Map panel becomes visible â†’ Map shows explored rooms and current location
**Postcondition:** Map panel is visible with current exploration state

### UC-081a-002: Identify Current Location
**Actor:** Player
**Flow:** Player views map â†’ Current room is highlighted with gold border â†’ [@] indicator shows player position

### UC-081a-003: Recognize Room Types
**Actor:** Player
**Flow:** Player hovers over explored room on map â†’ Room shows type icon (ğŸ’° for shop, â˜  for boss) â†’ Tooltip shows room name and type

### UC-081a-004: Identify Locked Doors
**Actor:** Player
**Flow:** Player views map with locked connections â†’ Locked paths shown as double lines (â•â•) â†’ Player knows to find key

### UC-081a-005: Navigate Large Dungeons
**Actor:** Player
**Precondition:** Dungeon has many rooms
**Flow:** Player uses zoom controls to see overview â†’ Uses pan/drag to scroll â†’ Centers on player with â— button

### UC-081a-006: Hide Map
**Actor:** Player
**Flow:** Player presses M key while map is visible â†’ Map panel closes â†’ Game view is fully visible

---

## 13. Deliverable Checklist

### Controls
- [ ] `Controls/MapViewPanel.axaml` created
- [ ] `Controls/MapViewPanel.axaml.cs` created
- [ ] `Controls/RoomNodeControl.cs` created
- [ ] `Controls/RoomNodeControl.axaml` created
- [ ] `Controls/ConnectionLineControl.cs` created

### ViewModels
- [ ] `ViewModels/MapViewPanelViewModel.cs` created
- [ ] `ViewModels/RoomNodeViewModel.cs` created
- [ ] `ViewModels/ConnectionViewModel.cs` created

### Styles
- [ ] `Styles/MapViewStyles.axaml` created

### Services (Optional)
- [ ] `Services/IRoomMapService.cs` created
- [ ] `Services/RoomMapService.cs` created

### Integration
- [ ] M key shortcut registered with KeyboardShortcutService
- [ ] MapViewPanel added to game window layout

### Testing
- [ ] ~12 unit tests implemented
- [ ] All tests passing

---

## 14. Acceptance Criteria

### Functional
- [ ] Map panel displays explored rooms
- [ ] Unexplored rooms show as "???"
- [ ] Current room is highlighted (gold border)
- [ ] Room connections display correctly
- [ ] Locked doors show differently (â•â•)
- [ ] Room type icons display correctly
- [ ] Hover shows room name in tooltip
- [ ] Legend explains map symbols
- [ ] M key toggles map visibility
- [ ] Zoom in/out controls work
- [ ] Pan with drag works
- [ ] Center on player button works
- [ ] Map updates when entering new room

### Quality
- [ ] Build succeeds with 0 errors
- [ ] Build succeeds with 0 warnings
- [ ] ~12 unit tests pass
- [ ] XML documentation on all public types
- [ ] Styles consistent with application theme

---

## 15. Dependencies

### Required from v0.8.0c
- `KeyboardShortcutService` for M key binding
- `ShortcutContext` enum for context management

### Required from Domain Layer
- `Room` entity with connections
- `RoomConnection` value object
- `RoomType` enum

### Required from Application Layer
- `IGameSessionService` with exploration tracking
- Room change event mechanism

### Provides to v0.8.1b
- Map panel pattern for window layouts
- Room visualization concepts for quest markers

### Provides to v0.8.1c
- Tooltip integration points for room tooltips

---

## 16. Future Considerations

### Deferred to v0.8.1b+
- **Quest Markers**: Show quest objectives on map rooms
- **Entity Tracking**: Show monsters/NPCs on map in real-time

### Deferred to Later Versions
- **Minimap**: Small permanent map overlay in corner
- **Map Discovery**: Reveal adjacent unexplored rooms
- **Map Notes**: Player-added annotations
- **Fog Animation**: Animated fog-of-war effect

### Out of Scope
- 3D map rendering
- Procedural dungeon generation visualization
- Multi-floor dungeon navigation

---

*Document Version: 1.0*
*Last Updated: 2026-01-10*
