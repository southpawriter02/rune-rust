# v0.18.2d Design Specification: CpsService Implementation & Config

**Version:** 0.18.2d
**Parent:** v0.18.2 (Cognitive Paradox Syndrome)
**Prerequisites:** v0.18.2c (ICpsService Interface), v0.6.x (Dice System)
**Status:** Design Complete
**Estimated Unit Tests:** ~5

---

## Table of Contents

1. [Executive Summary](#1-executive-summary)
2. [Feature Overview](#2-feature-overview)
3. [Architecture Diagrams](#3-architecture-diagrams)
4. [User Stories](#4-user-stories)
5. [CpsService Implementation](#5-cpsservice-implementation)
6. [Configuration Files](#6-configuration-files)
7. [Logging Specifications](#7-logging-specifications)
8. [Unit Testing Requirements](#8-unit-testing-requirements)
9. [Deliverable Checklist](#9-deliverable-checklist)
10. [Acceptance Criteria](#10-acceptance-criteria)
11. [Dependencies](#11-dependencies)
12. [Future Considerations](#12-future-considerations)

---

## 1. Executive Summary

This design specification defines the **CpsService implementation** and **JSON configuration files** — the complete runtime system for managing Cognitive Paradox Syndrome.

v0.18.2d delivers:

- `CpsService` class implementing `ICpsService`
- `config/cps-stages.json` — Stage definitions and symptoms
- `config/panic-table.json` — Panic Table roll mappings
- Full logging implementation for all CPS operations

### Key Deliverables

| Category | Items |
|----------|-------|
| **Application Services** | `CpsService` |
| **Configuration Files** | `cps-stages.json`, `panic-table.json` |
| **Tests** | ~5 unit tests |

### Architectural Significance

This version completes the CPS system by providing the **Infrastructure Layer Implementation** that fulfills the service contract defined in v0.18.2c, following Clean Architecture principles.

---

## 2. Feature Overview

```
v0.18.2d Features
├── CpsService Implementation
│   │
│   ├── State Query Methods
│   │   ├── GetCpsState() — Returns computed CpsState from stress
│   │   ├── GetCurrentStage() — Quick stage lookup
│   │   └── GetUiEffects() — Visual distortion config
│   │
│   ├── Stage Transition Methods
│   │   └── CheckStageChange() — Detect and report transitions
│   │
│   ├── Panic Table Methods
│   │   ├── RollPanicTable() — D10 roll with config lookup
│   │   └── ApplyPanicEffect() — Status effect application
│   │
│   └── Recovery Methods
│       ├── IsRecoverable() — Check recovery possibility
│       └── GetRecoveryProtocol() — Get recovery steps
│
├── Configuration: cps-stages.json
│   ├── Stage definitions (5 stages)
│   ├── Symptoms per stage
│   ├── UI effects per stage
│   └── Recovery protocols per stage
│
└── Configuration: panic-table.json
    ├── D10 roll mappings (1-10)
    ├── Effect definitions
    ├── Status effects per result
    └── Forced action specifications
```

---

## 3. Architecture Diagrams

### 3.1 Service Implementation Structure

```
┌─────────────────────────────────────────────────────────────────────────┐
│                      INFRASTRUCTURE LAYER                                │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                          │
│  ┌─────────────────────────────────────────────────────────────────┐    │
│  │                         CpsService                               │    │
│  │               implements ICpsService                             │    │
│  ├─────────────────────────────────────────────────────────────────┤    │
│  │                                                                  │    │
│  │  Dependencies (Injected):                                        │    │
│  │  ├── IStressService _stressService                              │    │
│  │  ├── IDiceService _diceService                                  │    │
│  │  ├── IStatusEffectService _statusEffectService                  │    │
│  │  ├── IConfigurationProvider _config                             │    │
│  │  └── ILogger<CpsService> _logger                                │    │
│  │                                                                  │    │
│  │  Private Fields:                                                 │    │
│  │  ├── CpsStageConfig[] _stageConfigs                             │    │
│  │  └── PanicTableEntry[] _panicTable                              │    │
│  │                                                                  │    │
│  │  Methods (ICpsService):                                          │    │
│  │  ├── GetCpsState(characterId)                                   │    │
│  │  ├── GetCurrentStage(characterId)                               │    │
│  │  ├── CheckStageChange(id, prev, new)                            │    │
│  │  ├── RollPanicTable(characterId)                                │    │
│  │  ├── ApplyPanicEffect(characterId, result)                      │    │
│  │  ├── GetUiEffects(characterId)                                  │    │
│  │  ├── IsRecoverable(characterId)                                 │    │
│  │  └── GetRecoveryProtocol(characterId)                           │    │
│  │                                                                  │    │
│  │  Private Methods:                                                │    │
│  │  ├── LoadConfiguration()                                        │    │
│  │  ├── GetPanicEffectForRoll(roll)                                │    │
│  │  └── CreatePanicResult(roll, entry)                             │    │
│  │                                                                  │    │
│  └─────────────────────────────────────────────────────────────────┘    │
│                                                                          │
└─────────────────────────────────────────────────────────────────────────┘
```

### 3.2 Configuration Loading Flow

```
┌────────────────────────────────────────────────────────────────────────┐
│                    CONFIGURATION LOADING FLOW                           │
└────────────────────────────────────────────────────────────────────────┘

        ┌─────────────────────┐
        │  Application Start  │
        └──────────┬──────────┘
                   │
                   ▼
        ┌─────────────────────┐
        │  CpsService Created │
        │  (via DI Container) │
        └──────────┬──────────┘
                   │
                   ▼
        ┌─────────────────────┐
        │ LoadConfiguration() │
        └──────────┬──────────┘
                   │
       ┌───────────┴───────────┐
       │                       │
       ▼                       ▼
┌─────────────────┐    ┌─────────────────┐
│  Load           │    │  Load           │
│  cps-stages.json│    │  panic-table.json│
└────────┬────────┘    └────────┬────────┘
         │                      │
         ▼                      ▼
┌─────────────────┐    ┌─────────────────┐
│  Deserialize to │    │  Deserialize to │
│  CpsStageConfig[]│   │  PanicTableEntry[]│
└────────┬────────┘    └────────┬────────┘
         │                      │
         └──────────┬───────────┘
                    │
                    ▼
         ┌─────────────────────┐
         │  Service Ready for  │
         │  Method Calls       │
         └─────────────────────┘
```

### 3.3 RollPanicTable Decision Tree

```
┌────────────────────────────────────────────────────────────────────────┐
│                    PANIC TABLE ROLL DECISION TREE                       │
└────────────────────────────────────────────────────────────────────────┘

                ┌─────────────────────────┐
                │ RollPanicTable(charId)  │
                └───────────┬─────────────┘
                            │
                            ▼
                ┌─────────────────────────┐
                │ Get Current CPS Stage   │
                └───────────┬─────────────┘
                            │
              ┌─────────────┴─────────────┐
              │                           │
              ▼                           ▼
    ┌─────────────────┐         ┌─────────────────┐
    │ Stage < Ruin    │         │ Stage >= Ruin   │
    │ Madness         │         │ Madness         │
    └────────┬────────┘         └────────┬────────┘
             │                           │
             ▼                           ▼
    ┌─────────────────┐         ┌─────────────────┐
    │ THROW           │         │ Roll d10 via    │
    │ InvalidOperation│         │ IDiceService    │
    │ Exception       │         └────────┬────────┘
    └─────────────────┘                  │
                                         ▼
                              ┌─────────────────┐
                              │ Lookup roll in  │
                              │ panic-table.json│
                              └────────┬────────┘
                                       │
           ┌───────────────────────────┼───────────────────────────┐
           │                           │                           │
           ▼                           ▼                           ▼
    ┌─────────────┐           ┌─────────────┐           ┌─────────────┐
    │ Roll 1-2    │           │ Roll 3-9    │           │ Roll 10     │
    │ Frozen/     │           │ Various     │           │ Lucky Break │
    │ Scream      │           │ Effects     │           │ No Effect   │
    └─────────────┘           └─────────────┘           └─────────────┘
           │                           │                           │
           └───────────────────────────┼───────────────────────────┘
                                       │
                                       ▼
                            ┌─────────────────┐
                            │ Create and      │
                            │ Return          │
                            │ PanicResult     │
                            └─────────────────┘
```

---

## 4. User Stories

### US-18.2d-1: Implement CPS State Retrieval

**As a** system developer
**I want to** retrieve CPS state from a working service
**So that** game systems can respond to character mental state

**Acceptance Criteria:**

- CpsService correctly retrieves stress from IStressService
- CpsState computed correctly from stress value
- Logging occurs at appropriate levels

### US-18.2d-2: Implement Panic Table Rolling

**As a** combat system
**I want to** roll on the Panic Table with proper randomization
**So that** panic effects are fairly determined

**Acceptance Criteria:**

- D10 roll uses IDiceService for consistent randomization
- Roll mapped to correct effect from configuration
- PanicResult contains all effect data
- Exception thrown if character not in RuinMadness+

### US-18.2d-3: Apply Panic Effects

**As a** status effect system
**I want to** apply panic effects to characters
**So that** mechanical consequences are realized

**Acceptance Criteria:**

- Status effects applied via IStatusEffectService
- Forced actions queued for combat system
- Duration tracking handled correctly

### US-18.2d-4: Load Configuration

**As a** game designer
**I want to** define CPS stages and panic effects in JSON
**So that** tuning can occur without code changes

**Acceptance Criteria:**

- cps-stages.json loaded at service startup
- panic-table.json loaded at service startup
- Invalid configuration causes clear error messages

---

## 5. CpsService Implementation

### 5.1 Purpose

Full implementation of ICpsService, providing all CPS management functionality with configuration-driven behavior.

### 5.2 Definition

**File:** `src/Infrastructure/RuneAndRust.Infrastructure/Services/CpsService.cs`

```csharp
namespace RuneAndRust.Infrastructure.Services;

using Microsoft.Extensions.Logging;
using RuneAndRust.Application.Interfaces;
using RuneAndRust.Domain.Enums;
using RuneAndRust.Domain.ValueObjects;
using RuneAndRust.Infrastructure.Configuration;

/// <summary>
/// Implementation of the CPS (Cognitive Paradox Syndrome) service.
/// </summary>
/// <remarks>
/// <para>
/// CpsService manages all aspects of character mental deterioration
/// from processing reality-bending paradoxes. It integrates with:
/// </para>
/// <list type="bullet">
/// <item>IStressService — for current stress values</item>
/// <item>IDiceService — for Panic Table rolls</item>
/// <item>IStatusEffectService — for applying panic effects</item>
/// </list>
/// </remarks>
public sealed class CpsService : ICpsService
{
    #region Dependencies

    private readonly IStressService _stressService;
    private readonly IDiceService _diceService;
    private readonly IStatusEffectService _statusEffectService;
    private readonly ILogger<CpsService> _logger;

    #endregion

    #region Configuration Data

    private readonly CpsStageConfig[] _stageConfigs;
    private readonly PanicTableEntry[] _panicTable;

    #endregion

    #region Constructor

    /// <summary>
    /// Initializes a new instance of the <see cref="CpsService"/> class.
    /// </summary>
    /// <param name="stressService">Service for stress value queries.</param>
    /// <param name="diceService">Service for dice rolling.</param>
    /// <param name="statusEffectService">Service for status effect application.</param>
    /// <param name="configProvider">Configuration provider for loading JSON config.</param>
    /// <param name="logger">Logger for CPS operations.</param>
    public CpsService(
        IStressService stressService,
        IDiceService diceService,
        IStatusEffectService statusEffectService,
        IConfigurationProvider configProvider,
        ILogger<CpsService> logger)
    {
        _stressService = stressService ?? throw new ArgumentNullException(nameof(stressService));
        _diceService = diceService ?? throw new ArgumentNullException(nameof(diceService));
        _statusEffectService = statusEffectService ?? throw new ArgumentNullException(nameof(statusEffectService));
        _logger = logger ?? throw new ArgumentNullException(nameof(logger));

        // Load configuration
        _stageConfigs = configProvider.LoadConfig<CpsStageConfig[]>("cps-stages.json")
            ?? GetDefaultStageConfigs();
        _panicTable = configProvider.LoadConfig<PanicTableEntry[]>("panic-table.json")
            ?? GetDefaultPanicTable();

        _logger.LogInformation("CpsService initialized with {StageCount} stages and {PanicEntries} panic table entries",
            _stageConfigs.Length, _panicTable.Length);
    }

    #endregion

    #region State Query Methods

    /// <inheritdoc/>
    public CpsState GetCpsState(Guid characterId)
    {
        var stress = _stressService.GetCurrentStress(characterId);
        var state = CpsState.Create(stress);

        _logger.LogDebug("CPS state for {CharacterId}: Stage={Stage}, Stress={Stress}",
            characterId, state.Stage, state.CurrentStress);

        return state;
    }

    /// <inheritdoc/>
    public CpsStage GetCurrentStage(Guid characterId)
    {
        return GetCpsState(characterId).Stage;
    }

    /// <inheritdoc/>
    public CpsUiEffects GetUiEffects(Guid characterId)
    {
        var stage = GetCurrentStage(characterId);
        return CpsUiEffects.ForStage(stage);
    }

    #endregion

    #region Stage Transition Methods

    /// <inheritdoc/>
    public CpsStageChangeResult CheckStageChange(Guid characterId, int previousStress, int newStress)
    {
        var result = CpsStageChangeResult.FromStressChange(previousStress, newStress);

        if (result.StageChanged)
        {
            var level = result.IsCriticalTransition ? LogLevel.Warning : LogLevel.Information;
            _logger.Log(level, "CPS stage change for {CharacterId}: {PreviousStage} → {NewStage}",
                characterId, result.PreviousStage, result.NewStage);

            if (result.EnteredRuinMadness)
            {
                _logger.LogWarning("Character {CharacterId} entered Ruin-Madness - Panic Table now active",
                    characterId);
            }

            if (result.EnteredHollowShell)
            {
                _logger.LogError("CRITICAL: Character {CharacterId} entered Hollow Shell - survival check required",
                    characterId);
            }
        }

        return result;
    }

    #endregion

    #region Panic Table Methods

    /// <inheritdoc/>
    public PanicResult RollPanicTable(Guid characterId)
    {
        var stage = GetCurrentStage(characterId);

        if (stage < CpsStage.RuinMadness)
        {
            _logger.LogWarning("Attempted Panic Table roll for {CharacterId} in {Stage} (requires RuinMadness+)",
                characterId, stage);
            throw new InvalidOperationException(
                $"Cannot roll Panic Table: character is in {stage}, requires RuinMadness or higher");
        }

        // Roll d10
        var rollResult = _diceService.Roll(1, 10);
        var roll = rollResult.Total;

        // Find matching entry
        var entry = _panicTable.FirstOrDefault(e => roll >= e.MinRoll && roll <= e.MaxRoll)
            ?? GetDefaultPanicEntry(roll);

        var panicResult = CreatePanicResult(roll, entry);

        _logger.LogInformation("Panic Table roll for {CharacterId}: d10={Roll} → {Effect} ({EffectName})",
            characterId, roll, panicResult.Effect, panicResult.EffectName);

        return panicResult;
    }

    /// <inheritdoc/>
    public void ApplyPanicEffect(Guid characterId, PanicResult panicResult)
    {
        if (panicResult.IsLuckyBreak)
        {
            _logger.LogInformation("Lucky break for {CharacterId} - no panic effect applied", characterId);
            return;
        }

        // Apply status effects
        foreach (var statusEffect in panicResult.StatusEffects)
        {
            var duration = panicResult.DurationTurns ?? 1;
            _statusEffectService.ApplyEffect(characterId, statusEffect, duration);

            _logger.LogDebug("Applied status effect {Effect} to {CharacterId} for {Duration} turns",
                statusEffect, characterId, duration);
        }

        // Handle forced actions
        if (panicResult.ForcesAction)
        {
            _logger.LogInformation("Queuing forced action {ActionType} for {CharacterId}",
                panicResult.ForcedActionType, characterId);

            // Note: Forced action handling would integrate with combat system
            // This is a hook for future combat integration
        }

        _logger.LogInformation("Applied panic effect {Effect} to {CharacterId}",
            panicResult.EffectName, characterId);
    }

    #endregion

    #region Recovery Methods

    /// <inheritdoc/>
    public bool IsRecoverable(Guid characterId)
    {
        var stage = GetCurrentStage(characterId);
        var isRecoverable = stage < CpsStage.RuinMadness;

        _logger.LogDebug("Recovery check for {CharacterId}: Stage={Stage}, Recoverable={IsRecoverable}",
            characterId, stage, isRecoverable);

        return isRecoverable;
    }

    /// <inheritdoc/>
    public CpsRecoveryProtocol GetRecoveryProtocol(Guid characterId)
    {
        var stage = GetCurrentStage(characterId);
        return CpsRecoveryProtocol.ForStage(stage);
    }

    #endregion

    #region Private Methods

    private PanicResult CreatePanicResult(int roll, PanicTableEntry entry)
    {
        return new PanicResult(
            DieRoll: roll,
            Effect: entry.Effect,
            EffectName: entry.EffectName,
            Description: entry.Description,
            DurationTurns: entry.DurationTurns,
            SelfDamage: entry.SelfDamage,
            StatusEffects: entry.StatusEffects ?? Array.Empty<string>(),
            ForcesAction: entry.ForcesAction,
            ForcedActionType: entry.ForcedActionType);
    }

    private static CpsStageConfig[] GetDefaultStageConfigs()
    {
        // Fallback if configuration fails to load
        return new[]
        {
            new CpsStageConfig { Stage = CpsStage.None, MinStress = 0, MaxStress = 19 },
            new CpsStageConfig { Stage = CpsStage.WeightOfKnowing, MinStress = 20, MaxStress = 39 },
            new CpsStageConfig { Stage = CpsStage.GlimmerMadness, MinStress = 40, MaxStress = 59 },
            new CpsStageConfig { Stage = CpsStage.RuinMadness, MinStress = 60, MaxStress = 79 },
            new CpsStageConfig { Stage = CpsStage.HollowShell, MinStress = 80, MaxStress = 100 }
        };
    }

    private static PanicTableEntry[] GetDefaultPanicTable()
    {
        return new[]
        {
            new PanicTableEntry { MinRoll = 1, MaxRoll = 1, Effect = PanicEffect.Frozen, EffectName = "Logic Lock" },
            new PanicTableEntry { MinRoll = 2, MaxRoll = 2, Effect = PanicEffect.Scream, EffectName = "Involuntary Scream" },
            new PanicTableEntry { MinRoll = 3, MaxRoll = 3, Effect = PanicEffect.Flee, EffectName = "Evacuation Protocol" },
            new PanicTableEntry { MinRoll = 4, MaxRoll = 4, Effect = PanicEffect.Fetal, EffectName = "Fetal Position" },
            new PanicTableEntry { MinRoll = 5, MaxRoll = 5, Effect = PanicEffect.Blackout, EffectName = "System Blackout" },
            new PanicTableEntry { MinRoll = 6, MaxRoll = 6, Effect = PanicEffect.Denial, EffectName = "Reality Denial" },
            new PanicTableEntry { MinRoll = 7, MaxRoll = 7, Effect = PanicEffect.Violence, EffectName = "Paradox Fury" },
            new PanicTableEntry { MinRoll = 8, MaxRoll = 8, Effect = PanicEffect.Catatonia, EffectName = "System Crash" },
            new PanicTableEntry { MinRoll = 9, MaxRoll = 9, Effect = PanicEffect.Dissociation, EffectName = "Reality Drift" },
            new PanicTableEntry { MinRoll = 10, MaxRoll = 10, Effect = PanicEffect.None, EffectName = "Lucky Break" }
        };
    }

    private static PanicTableEntry GetDefaultPanicEntry(int roll)
    {
        // Fallback for unexpected rolls
        return new PanicTableEntry
        {
            MinRoll = roll,
            MaxRoll = roll,
            Effect = PanicEffect.None,
            EffectName = "Unknown",
            Description = "An unexpected result occurred."
        };
    }

    #endregion
}

#region Configuration DTOs

/// <summary>
/// Configuration DTO for CPS stage definitions.
/// </summary>
internal sealed class CpsStageConfig
{
    public CpsStage Stage { get; set; }
    public int MinStress { get; set; }
    public int MaxStress { get; set; }
    public string[] Symptoms { get; set; } = Array.Empty<string>();
    public CpsUiEffectsConfig? UiEffects { get; set; }
    public CpsRecoveryConfig? RecoveryProtocol { get; set; }
}

/// <summary>
/// Configuration DTO for UI effects.
/// </summary>
internal sealed class CpsUiEffectsConfig
{
    public float DistortionIntensity { get; set; }
    public bool PeripheralStatic { get; set; }
    public bool TextGlitching { get; set; }
    public int LeetSpeakLevel { get; set; }
    public string ColorTint { get; set; } = "#FFFFFF";
}

/// <summary>
/// Configuration DTO for recovery protocols.
/// </summary>
internal sealed class CpsRecoveryConfig
{
    public string ProtocolName { get; set; } = string.Empty;
    public string[] Steps { get; set; } = Array.Empty<string>();
    public string RecoveryTime { get; set; } = "N/A";
    public string Urgency { get; set; } = "None";
}

/// <summary>
/// Configuration DTO for Panic Table entries.
/// </summary>
internal sealed class PanicTableEntry
{
    public int MinRoll { get; set; }
    public int MaxRoll { get; set; }
    public PanicEffect Effect { get; set; }
    public string EffectName { get; set; } = string.Empty;
    public string Description { get; set; } = string.Empty;
    public int? DurationTurns { get; set; }
    public int? SelfDamage { get; set; }
    public string[]? StatusEffects { get; set; }
    public bool ForcesAction { get; set; }
    public string? ForcedActionType { get; set; }
}

#endregion
```

---

## 6. Configuration Files

### 6.1 cps-stages.json

**File:** `config/cps-stages.json`

```json
{
    "$schema": "./schemas/cps-stages.schema.json",
    "version": "1.0",
    "stages": [
        {
            "stage": 0,
            "stageName": "None",
            "displayName": "Clear",
            "stressRange": { "min": 0, "max": 19 },
            "description": "Mind is clear and unaffected by paradox exposure.",
            "symptoms": [],
            "fieldSigns": [],
            "uiEffects": {
                "distortionIntensity": 0.0,
                "peripheralStatic": false,
                "textGlitching": false,
                "leetSpeakLevel": 0,
                "systemWarnings": false,
                "colorTint": "#FFFFFF",
                "screenLag": false
            },
            "recoveryProtocol": null
        },
        {
            "stage": 1,
            "stageName": "WeightOfKnowing",
            "displayName": "Weight of Knowing",
            "stressRange": { "min": 20, "max": 39 },
            "description": "Reality feels subtly wrong. Minor distortions at the edge of vision.",
            "symptoms": [
                "Migraines (The Pressure)",
                "High-pitched tinnitus (The Static Hiss)",
                "Mild auditory paresthesia",
                "Irritability and short temper",
                "Difficulty concentrating"
            ],
            "fieldSigns": [
                "Subject frequently rubs temples",
                "Asks 'Did you hear that?' repeatedly",
                "Stares at geometric patterns too long",
                "Exhibits hypervigilance"
            ],
            "uiEffects": {
                "distortionIntensity": 0.1,
                "peripheralStatic": true,
                "textGlitching": false,
                "leetSpeakLevel": 0,
                "systemWarnings": false,
                "colorTint": "#E8E8E8",
                "screenLag": false
            },
            "recoveryProtocol": {
                "protocolName": "Cognitive Hygiene",
                "steps": [
                    "Find a safe location away from anomalies",
                    "Rest in silence and darkness for 4+ hours",
                    "Avoid exposure to paradox sources",
                    "Engage in grounding activities",
                    "Short Rest to reduce stress"
                ],
                "recoveryTime": "12-24 hours",
                "urgency": "Low"
            }
        },
        {
            "stage": 2,
            "stageName": "GlimmerMadness",
            "displayName": "Glimmer-Madness",
            "stressRange": { "min": 40, "max": 59 },
            "description": "Reality actively flickers. Objects may appear duplicated or distorted.",
            "symptoms": [
                "Visual hallucinations (fractal patterns, geometry)",
                "The Writhing Text (letters rearrange when observed)",
                "Vertigo and spatial disorientation",
                "Semantic drift (forgetting names of common objects)",
                "Déjà vu loops"
            ],
            "fieldSigns": [
                "Subject reads same sentence multiple times",
                "Complains text is 'moving' or 'wrong'",
                "Stumbles on level ground",
                "Calls objects by wrong names",
                "Reports seeing 'two of things'"
            ],
            "uiEffects": {
                "distortionIntensity": 0.4,
                "peripheralStatic": true,
                "textGlitching": true,
                "leetSpeakLevel": 2,
                "systemWarnings": false,
                "colorTint": "#FFE0B0",
                "screenLag": false
            },
            "recoveryProtocol": {
                "protocolName": "Silent Room Protocol",
                "steps": [
                    "IMMEDIATELY cease all paradox exposure",
                    "Isolate in dark, quiet room",
                    "Remove ALL written materials",
                    "Do NOT attempt logic puzzles or complex reasoning",
                    "Have ally monitor for deterioration",
                    "Long Rest REQUIRED (Short Rest insufficient)",
                    "Sanctuary Rest recommended"
                ],
                "recoveryTime": "48+ hours",
                "urgency": "Critical"
            }
        },
        {
            "stage": 3,
            "stageName": "RuinMadness",
            "displayName": "Ruin-Madness",
            "stressRange": { "min": 60, "max": 79 },
            "description": "The mind fractures under paradox weight. Panic Table triggers on stress events.",
            "symptoms": [
                "Violent paranoia (everyone is a threat)",
                "Logic-Locks (repeating same action)",
                "Loss of self-identity",
                "Worship of anomalies",
                "Uncontrollable verbal outbursts"
            ],
            "fieldSigns": [
                "Subject threatens allies without provocation",
                "Performs same action repeatedly",
                "Cannot remember own name",
                "Kneels before or speaks to anomalies",
                "Screams nonsense phrases"
            ],
            "uiEffects": {
                "distortionIntensity": 0.7,
                "peripheralStatic": true,
                "textGlitching": true,
                "leetSpeakLevel": 4,
                "systemWarnings": true,
                "colorTint": "#FF8080",
                "screenLag": true
            },
            "recoveryProtocol": {
                "protocolName": "Terminal Protocol",
                "steps": [
                    "WARNING: Recovery from Ruin-Madness is UNLIKELY",
                    "Focus on preventing HollowShell",
                    "Complete isolation from ALL stimuli",
                    "Sanctuary Rest MAY reduce to GlimmerMadness (GM discretion)",
                    "Consider character retirement if persistent"
                ],
                "recoveryTime": "Unknown",
                "urgency": "Terminal"
            }
        },
        {
            "stage": 4,
            "stageName": "HollowShell",
            "displayName": "The Hollow Shell",
            "stressRange": { "min": 80, "max": 100 },
            "description": "The mind has shattered. Survival check required or character is lost.",
            "symptoms": [
                "Complete catatonia",
                "Hollow behavior (mimicking without comprehension)",
                "No pupillary response",
                "Total lack of survival instinct",
                "Possible Forlorn conversion"
            ],
            "fieldSigns": [
                "Subject is non-responsive",
                "Mimics nearby movements without intent",
                "Does not react to pain",
                "Will not eat, drink, or sleep without direction",
                "Eyes show no recognition"
            ],
            "uiEffects": {
                "distortionIntensity": 1.0,
                "peripheralStatic": false,
                "textGlitching": false,
                "leetSpeakLevel": 0,
                "systemWarnings": true,
                "colorTint": "#000000",
                "screenLag": true
            },
            "recoveryProtocol": {
                "protocolName": "None - Character Lost",
                "steps": [
                    "The character's mind has been ERASED",
                    "NO recovery is possible",
                    "Character becomes unplayable NPC",
                    "May become Forlorn enemy",
                    "Begin new character creation"
                ],
                "recoveryTime": "N/A",
                "urgency": "Terminal"
            }
        }
    ]
}
```

### 6.2 panic-table.json

**File:** `config/panic-table.json`

```json
{
    "$schema": "./schemas/panic-table.schema.json",
    "version": "1.0",
    "description": "Panic Table for Ruin-Madness stage. Roll d10 when character in RuinMadness experiences stress event.",
    "table": [
        {
            "dieRange": { "min": 1, "max": 1 },
            "effect": "Frozen",
            "effectName": "Logic Lock",
            "description": "Your mind freezes, unable to process the paradox before you.",
            "flavorText": "The angles... they don't connect... they can't connect...",
            "mechanicalImpact": {
                "statusEffects": ["Stunned"],
                "duration": 1,
                "selfDamage": null,
                "forcesAction": false,
                "forcedActionType": null,
                "defensePenalty": 5
            }
        },
        {
            "dieRange": { "min": 2, "max": 2 },
            "effect": "Scream",
            "effectName": "Involuntary Scream",
            "description": "A scream tears from your throat before you can stop it.",
            "flavorText": "AAAAAHHHHHH!!!",
            "mechanicalImpact": {
                "statusEffects": [],
                "duration": null,
                "selfDamage": null,
                "forcesAction": false,
                "forcedActionType": null,
                "alertsEnemies": true,
                "stealthImpossible": true
            }
        },
        {
            "dieRange": { "min": 3, "max": 3 },
            "effect": "Flee",
            "effectName": "Evacuation Protocol",
            "description": "Your survival instincts override all else. You MUST flee.",
            "flavorText": "Abort! Abort! Get out! GET OUT!",
            "mechanicalImpact": {
                "statusEffects": [],
                "duration": null,
                "selfDamage": null,
                "forcesAction": true,
                "forcedActionType": "FleeFromSource",
                "willCheckToResist": { "dc": 2 }
            }
        },
        {
            "dieRange": { "min": 4, "max": 4 },
            "effect": "Fetal",
            "effectName": "Fetal Position",
            "description": "You curl into a ball, trying to make yourself as small as possible.",
            "flavorText": "Not real. Not real. Not real...",
            "mechanicalImpact": {
                "statusEffects": ["Prone"],
                "duration": null,
                "selfDamage": null,
                "forcesAction": false,
                "forcedActionType": null,
                "disadvantageUntilRecovered": true
            }
        },
        {
            "dieRange": { "min": 5, "max": 5 },
            "effect": "Blackout",
            "effectName": "System Blackout",
            "description": "Your mind shuts down to protect itself. Darkness takes you.",
            "flavorText": "[SYSTEM OFFLINE]",
            "mechanicalImpact": {
                "statusEffects": ["Unconscious"],
                "duration": "1d4",
                "durationDice": { "count": 1, "sides": 4 },
                "selfDamage": null,
                "forcesAction": false,
                "forcedActionType": null
            }
        },
        {
            "dieRange": { "min": 6, "max": 6 },
            "effect": "Denial",
            "effectName": "Reality Denial",
            "description": "Your mind refuses to acknowledge the threat. It simply... isn't there.",
            "flavorText": "What are you looking at? There's nothing there.",
            "mechanicalImpact": {
                "statusEffects": [],
                "duration": "1d4",
                "durationDice": { "count": 1, "sides": 4 },
                "selfDamage": null,
                "forcesAction": false,
                "forcedActionType": null,
                "cannotPerceiveTrigger": true
            }
        },
        {
            "dieRange": { "min": 7, "max": 7 },
            "effect": "Violence",
            "effectName": "Paradox Fury",
            "description": "Rage fills the void where reason should be. ATTACK!",
            "flavorText": "KILL IT! KILL EVERYTHING!",
            "mechanicalImpact": {
                "statusEffects": [],
                "duration": 1,
                "selfDamage": null,
                "forcesAction": true,
                "forcedActionType": "AttackNearest",
                "friendlyFirePossible": true
            }
        },
        {
            "dieRange": { "min": 8, "max": 8 },
            "effect": "Catatonia",
            "effectName": "System Crash",
            "description": "Your mind shuts down completely. Only pain can reboot you.",
            "flavorText": "[CRITICAL ERROR: CONSCIOUSNESS.EXE NOT RESPONDING]",
            "mechanicalImpact": {
                "statusEffects": ["Prone", "Stunned"],
                "duration": "until_damaged",
                "selfDamage": null,
                "forcesAction": false,
                "forcedActionType": null,
                "wakeOnDamage": true
            }
        },
        {
            "dieRange": { "min": 9, "max": 9 },
            "effect": "Dissociation",
            "effectName": "Reality Drift",
            "description": "Your mind and body disconnect. You act without intent.",
            "flavorText": "Who is moving these hands? Not me. Not me...",
            "mechanicalImpact": {
                "statusEffects": [],
                "duration": 1,
                "selfDamage": null,
                "forcesAction": true,
                "forcedActionType": "RandomAction"
            }
        },
        {
            "dieRange": { "min": 10, "max": 10 },
            "effect": "None",
            "effectName": "Lucky Break",
            "description": "Your mind holds together... for now.",
            "flavorText": "I'm okay. I'm okay. I think I'm okay.",
            "mechanicalImpact": {
                "statusEffects": [],
                "duration": null,
                "selfDamage": null,
                "forcesAction": false,
                "forcedActionType": null
            }
        }
    ]
}
```

---

## 7. Logging Specifications

### 7.1 Log Levels by Operation

| Operation | Level | Condition |
|-----------|-------|-----------|
| GetCpsState | Debug | Always |
| GetCurrentStage | Debug | Always |
| CheckStageChange (no change) | Debug | When stage unchanged |
| CheckStageChange (changed) | Information | When stage changes |
| CheckStageChange (critical) | Warning | When entering RuinMadness |
| CheckStageChange (terminal) | Error | When entering HollowShell |
| RollPanicTable | Information | Always |
| RollPanicTable (invalid stage) | Warning | When stage < RuinMadness |
| ApplyPanicEffect | Information | Always |
| ApplyPanicEffect (status) | Debug | Per status effect |
| IsRecoverable | Debug | Always |
| Service initialization | Information | At startup |

### 7.2 Log Message Templates

```csharp
// State queries
"CPS state for {CharacterId}: Stage={Stage}, Stress={Stress}"
"Recovery check for {CharacterId}: Stage={Stage}, Recoverable={IsRecoverable}"

// Stage changes
"CPS stage change for {CharacterId}: {PreviousStage} → {NewStage}"
"Character {CharacterId} entered Ruin-Madness - Panic Table now active"
"CRITICAL: Character {CharacterId} entered Hollow Shell - survival check required"

// Panic Table
"Panic Table roll for {CharacterId}: d10={Roll} → {Effect} ({EffectName})"
"Lucky break for {CharacterId} - no panic effect applied"
"Applied status effect {Effect} to {CharacterId} for {Duration} turns"
"Queuing forced action {ActionType} for {CharacterId}"
"Applied panic effect {Effect} to {CharacterId}"

// Errors
"Attempted Panic Table roll for {CharacterId} in {Stage} (requires RuinMadness+)"
```

---

## 8. Unit Testing Requirements

### 8.1 Test File Location

**File:** `tests/RuneAndRust.Infrastructure.UnitTests/Services/CpsServiceTests.cs`

### 8.2 Required Tests

| Test Name | Description |
|-----------|-------------|
| `GetCpsState_ReturnsCorrectState_ForGivenStress` | Verify state computation |
| `CheckStageChange_DetectsRuinMadnessEntry` | Verify critical transition detection |
| `RollPanicTable_ThrowsException_WhenNotInRuinMadness` | Verify precondition |
| `RollPanicTable_ReturnsValidResult_ForValidRoll` | Verify roll processing |
| `ApplyPanicEffect_AppliesStatusEffects` | Verify effect application |

### 8.3 Example Tests

```csharp
[TestFixture]
public class CpsServiceTests
{
    private Mock<IStressService> _mockStressService;
    private Mock<IDiceService> _mockDiceService;
    private Mock<IStatusEffectService> _mockStatusEffectService;
    private Mock<IConfigurationProvider> _mockConfigProvider;
    private Mock<ILogger<CpsService>> _mockLogger;
    private CpsService _sut;

    [SetUp]
    public void SetUp()
    {
        _mockStressService = new Mock<IStressService>();
        _mockDiceService = new Mock<IDiceService>();
        _mockStatusEffectService = new Mock<IStatusEffectService>();
        _mockConfigProvider = new Mock<IConfigurationProvider>();
        _mockLogger = new Mock<ILogger<CpsService>>();

        _mockConfigProvider
            .Setup(c => c.LoadConfig<CpsStageConfig[]>(It.IsAny<string>()))
            .Returns((CpsStageConfig[]?)null);
        _mockConfigProvider
            .Setup(c => c.LoadConfig<PanicTableEntry[]>(It.IsAny<string>()))
            .Returns((PanicTableEntry[]?)null);

        _sut = new CpsService(
            _mockStressService.Object,
            _mockDiceService.Object,
            _mockStatusEffectService.Object,
            _mockConfigProvider.Object,
            _mockLogger.Object);
    }

    [Test]
    public void GetCpsState_ReturnsCorrectStage_ForStress65()
    {
        // Arrange
        var characterId = Guid.NewGuid();
        _mockStressService.Setup(s => s.GetCurrentStress(characterId)).Returns(65);

        // Act
        var result = _sut.GetCpsState(characterId);

        // Assert
        result.Stage.Should().Be(CpsStage.RuinMadness);
        result.RequiresPanicCheck.Should().BeTrue();
    }

    [Test]
    public void CheckStageChange_DetectsRuinMadnessEntry_WhenTransitioning()
    {
        // Arrange
        var characterId = Guid.NewGuid();

        // Act
        var result = _sut.CheckStageChange(characterId, previousStress: 55, newStress: 65);

        // Assert
        result.EnteredRuinMadness.Should().BeTrue();
        result.IsCriticalTransition.Should().BeTrue();
    }

    [Test]
    public void RollPanicTable_ThrowsInvalidOperationException_WhenNotInRuinMadness()
    {
        // Arrange
        var characterId = Guid.NewGuid();
        _mockStressService.Setup(s => s.GetCurrentStress(characterId)).Returns(45); // GlimmerMadness

        // Act & Assert
        var act = () => _sut.RollPanicTable(characterId);
        act.Should().Throw<InvalidOperationException>()
            .WithMessage("*requires RuinMadness*");
    }

    [Test]
    public void RollPanicTable_ReturnsCorrectEffect_ForRoll7()
    {
        // Arrange
        var characterId = Guid.NewGuid();
        _mockStressService.Setup(s => s.GetCurrentStress(characterId)).Returns(70);
        _mockDiceService.Setup(d => d.Roll(1, 10))
            .Returns(new DiceRollResult { Total = 7 });

        // Act
        var result = _sut.RollPanicTable(characterId);

        // Assert
        result.Effect.Should().Be(PanicEffect.Violence);
        result.ForcesAction.Should().BeTrue();
    }

    [Test]
    public void ApplyPanicEffect_CallsStatusEffectService_ForFrozenEffect()
    {
        // Arrange
        var characterId = Guid.NewGuid();
        var panicResult = PanicResult.Frozen();

        // Act
        _sut.ApplyPanicEffect(characterId, panicResult);

        // Assert
        _mockStatusEffectService.Verify(
            s => s.ApplyEffect(characterId, "Stunned", It.IsAny<int>()),
            Times.Once);
    }
}
```

---

## 9. Deliverable Checklist

### 9.1 Infrastructure Layer

- [ ] `src/Infrastructure/RuneAndRust.Infrastructure/Services/CpsService.cs`

### 9.2 Configuration Files

- [ ] `config/cps-stages.json`
- [ ] `config/panic-table.json`

### 9.3 Configuration Schemas (Optional)

- [ ] `config/schemas/cps-stages.schema.json`
- [ ] `config/schemas/panic-table.schema.json`

### 9.4 Tests

- [ ] `tests/RuneAndRust.Infrastructure.UnitTests/Services/CpsServiceTests.cs`

### 9.5 Documentation

- [ ] Update `docs/design/v0.18.x/v0.18.2-scope-breakdown.md` (mark v0.18.2d complete)
- [ ] Create `docs/changelogs/v0.18.2d-changelog.md`

---

## 10. Acceptance Criteria

### 10.1 Build Verification

- [ ] Solution builds without errors
- [ ] Solution builds without warnings in new code

### 10.2 Test Verification

- [ ] All new unit tests pass
- [ ] All existing unit tests continue to pass

### 10.3 Functional Verification

- [ ] CpsService correctly retrieves stress from IStressService
- [ ] CpsState computed correctly from stress values
- [ ] CheckStageChange detects all stage transitions
- [ ] RollPanicTable throws for invalid stages
- [ ] RollPanicTable returns valid effects for d10 rolls
- [ ] ApplyPanicEffect applies status effects correctly
- [ ] Configuration files load successfully
- [ ] Default fallbacks work if config missing

### 10.4 Logging Verification

- [ ] Debug logs for state queries
- [ ] Information logs for stage changes
- [ ] Warning logs for critical transitions
- [ ] Error logs for terminal states

---

## 11. Dependencies

### 11.1 Required Prerequisites

| Dependency | Version | Status | Notes |
|------------|---------|--------|-------|
| ICpsService | v0.18.2c | Required | Interface to implement |
| IStressService | v0.18.0 | Required | Stress value queries |
| IDiceService | v0.6.x | Required | Panic Table rolls |
| IStatusEffectService | v0.10.x | Required | Effect application |
| IConfigurationProvider | v0.3.x | Required | JSON config loading |

### 11.2 Provides to Later Phases

| Item | Consumer | Purpose |
|------|----------|---------|
| CpsService | v0.18.5 (Integration) | CPS management |
| CPS Configuration | Combat System | Panic triggers |
| CPS State | UI Layer | Visual distortion |

---

## 12. Future Considerations

### 12.1 v0.18.5 (Resource Integration)

- CpsService integration with TraumaEconomyService
- Stress-to-CPS cascade handling
- Rest recovery coordination

### 12.2 v0.19.x (UI Version)

- Actual shader implementations for distortion
- Text corruption rendering
- Audio distortion effects

### 12.3 Potential Enhancements

- Async versions of methods for large-scale operations
- Caching for frequently-queried characters
- Event sourcing for CPS state history

---

*Document Version: 1.0*
*Last Updated: 2026-01-28*
*Author: Claude (AI Assistant)*
