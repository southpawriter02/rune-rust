# v0.15.3e Changelog - Negotiation System

## Summary

Implements the **Negotiation System** subsystem of the Rhetoric skill. Enables multi-round bargaining with position-track mechanics, four tactical approaches (Persuade, Deceive, Pressure, Concede), five request complexity tiers (DC 10-26), and a concession system granting +2d10 bonus dice plus DC reductions (-2 to -6). Features integration with Persuasion, Deception, and Intimidation subsystems for tactic checks, and introduces the `NegotiationCollapsed` fumble type for catastrophic failures.

## Added

### Domain Layer - Enums (4 files)

| File | Description |
|------|-------------|
| `NegotiationStatus.cs` | 6-state enum: Opening, Bargaining, CrisisManagement, Finalization, DealReached, Collapsed |
| `NegotiationTactic.cs` | 4-tactic enum: Persuade (honest appeal), Deceive (misleading), Pressure (intimidating), Concede (voluntary concession) |
| `RequestComplexity.cs` | 5-tier enum: FairTrade (DC 10), SlightAdvantage (DC 14), NoticeableAdvantage (DC 18), MajorAdvantage (DC 22), OneSidedDeal (DC 26) |
| `ConcessionType.cs` | 5-type enum: OfferItem (-2 DC), PromiseFavor (-2 DC), TradeInformation (-4 DC), TakeRisk (-4 DC), StakeReputation (-6 DC) |

### Domain Layer - Extensions (4 files)

| File | Description |
|------|-------------|
| `NegotiationStatusExtensions.cs` | `IsTerminal()`, `IsSuccess()`, `IsFailure()`, `IsAtRisk()`, `IsNearSuccess()`, `GetDisplayName()`, `GetDescription()`, `GetShortIndicator()`, `GetTacticalHint()`, `GetStatusColor()` |
| `NegotiationTacticExtensions.cs` | `RequiresCheck()`, `GetUnderlyingSystem()`, `GetDisplayName()`, `GetDescription()`, `GetSideEffectWarning()`, `IncursStress()`, `CostsReputation()`, `FumbleCollapsesNegotiation()`, `GetFumbleType()`, `GetPrimaryAttribute()`, `GetRiskLevel()`, `GetExampleDialogue()`, `GetShortName()` |
| `RequestComplexityExtensions.cs` | `GetBaseDc()`, `GetInitialGap()`, `GetDefaultRounds()`, `GetDisplayName()`, `GetDescription()`, `GetDifficultyRating()`, `GetDefaultPcStartPosition()`, `GetDefaultNpcStartPosition()`, `GetExampleRequests()` |
| `ConcessionTypeExtensions.cs` | `GetDcReduction()`, `GetBonusDice()`, `GetDisplayName()`, `GetDescription()`, `GetShortDescription()`, `GetCost()`, `GetExamples()`, `GetMechanicalSummary()`, `ConsumesItem()`, `CreatesDebt()`, `RevealsInformation()`, `RisksReputation()`, `GetRiskLevel()`, `RequiresContextData()` |

### Domain Layer - Value Objects (3 files)

| File | Description |
|------|-------------|
| `Concession.cs` | Tracks voluntary concessions: Type, Description, DcReduction, BonusDice, Cost, ConsumedItemId, DebtCreated, InformationRevealed, RiskAccepted, StakedFactionId. Factory methods: `OfferItem()`, `PromiseFavor()`, `TradeInformation()`, `TakeRisk()`, `StakeReputation()` |
| `NegotiationRound.cs` | Records outcome of single round: RoundNumber, TacticUsed, CheckResult, PositionMovement, PcPositionAfter, NpcPositionAfter, GapAfter, ConcessionMade, StressCost, ReputationCost, DispositionChange, NarrativeDescription. Factory methods: `ForCheck()`, `ForConcession()` |
| `NegotiationContext.cs` | Captures all factors: BaseContext, RequestComplexity, PositionTrack, SelectedTactic, ActiveConcession, NpcFlexibility. Computed properties: `BaseDc`, `EffectiveDc`, `ConcessionBonusDice`, `TotalDiceModifier`, `IsValid`, `IsTacticRisky`. Methods: `GetBaseDc()`, `GetEffectiveDc()`, `GetConcessionBonusDice()`, `ToModifierBreakdown()` |
| `NegotiationResult.cs` | Complete negotiation outcome: Outcome, FinalStatus, FinalDealTerms, FinalPcPosition, FinalNpcPosition, RoundsUsed, DispositionChange, ReputationChange, TotalStressCost, UnlockedOptions, History, FumbleConsequence. Factory methods: `Success()`, `Failure()`, `Fumble()`, `InProgress()` |

### Domain Layer - Entities (1 file)

| File | Description |
|------|-------------|
| `NegotiationPositionTrack.cs` | Tracks bargaining positions: NegotiationId, PcPosition, NpcPosition, Gap, RoundNumber, RoundsRemaining, Status, RequestComplexity, ConsecutiveFailures, History, ActiveConcession. Methods: `Initialize()`, `MovePcPosition()`, `MoveNpcPosition()`, `RecordRound()`, `SetConcessionBonus()`, `ClearConcessionBonus()`, `ForceCollapse()`, `MarkComplete()`, `GetGapAssessment()`, `GetPositionName()`, `GetPositionDisplay()`, `GetStatusSummary()` |

### Application Layer (2 files)

| File | Description |
|------|-------------|
| `INegotiationService.cs` | Interface: `InitiateNegotiationAsync`, `ExecuteRoundAsync`, `ApplyConcessionAsync`, `IsNegotiationComplete`, `FinalizeNegotiationAsync`, `GetAvailableConcessionsAsync`, `CalculateNpcStartPositionAsync`, `GetNpcFlexibilityAsync`, `BuildContextAsync`, `GetStateSummary`, `GetTacticalAdviceAsync`, `CalculatePositionMovement`, `GetActiveNegotiationAsync`, `AbandonNegotiationAsync` |
| `NegotiationService.cs` | Full implementation with comprehensive logging, in-memory active negotiation tracking, tactic delegation to Persuasion/Deception/Intimidation services, concession bonus application, position movement calculation, outcome determination |

### Domain Layer - Modified (1 file)

| File | Change |
|------|--------|
| `FumbleType.cs` | Added `NegotiationCollapsed = 9` enum value with documentation. Updated extension methods: `BlocksAllTargets()`, `IsInstant()`, `GetAssociatedSkillId()`, `GetDisplayName()`, `GetDescription()`, `TriggersCombat()`, `IsPermanent()` |

### Configuration (1 file)

| File | Description |
|------|-------------|
| `config/social/negotiation-config.json` | Request complexity tiers, position track definitions (0-8 scale), tactics configuration, concession types, outcome effects, NPC flexibility levels, disposition modifiers, fumble consequences |

### Unit Tests (1 test file, 50+ tests)

| File | Tests |
|------|-------|
| `NegotiationSystemTests.cs` | RequestComplexity DC mapping, ConcessionType bonuses, position track gap calculation, position movement rules, tactic underlying systems, stress/reputation costs, status terminal states, round recording, context DC calculation, result factory methods, FumbleType.NegotiationCollapsed properties |

## Key Features

### Request Complexity Tiers

| Tier | Base DC | Initial Gap | Default Rounds | PC Start | Difficulty |
|------|:-------:|:-----------:|:--------------:|:--------:|------------|
| FairTrade | 10 | 2 | 3 | 4 (Favorable) | Easy |
| SlightAdvantage | 14 | 3 | 4 | 3 (Favorable+) | Moderate |
| NoticeableAdvantage | 18 | 4 | 5 | 2 (Strong) | Challenging |
| MajorAdvantage | 22 | 5 | 6 | 1 (Strong+) | Difficult |
| OneSidedDeal | 26 | 6 | 7 | 0 (Maximum Demand) | Extremely Difficult |

### Position Track (0-8 Scale)

| Position | Name | Category | Notes |
|:--------:|------|----------|-------|
| 0 | Maximum Demand | PC Demand | Extreme player position |
| 1 | Strong+ | PC Demand | Heavy player advantage |
| 2 | Strong | PC Demand | Clear player benefit |
| 3 | Favorable+ | PC Demand | Notable player edge |
| 4 | Favorable | PC Demand | Minor player advantage |
| 5 | Compromise | Neutral | **Agreement Zone** |
| 6 | Unfavorable | NPC Demand | Standard NPC start |
| 7 | Unfavorable+ | NPC Demand | Notable NPC edge |
| 8 | Walk Away | NPC Demand | **Termination Point** |

### Negotiation Tactics

| Tactic | Check Required | Underlying System | Stress Cost | Rep Cost | Fumble Risk |
|--------|:--------------:|-------------------|:-----------:|:--------:|:-----------:|
| Persuade | Yes | Persuasion | No | No | TrustShattered |
| Deceive | Yes | Deception | Yes (Liar's Burden) | No | LieExposed |
| Pressure | Yes | Intimidation | No | Yes (Cost of Fear) | ChallengeAccepted |
| Concede | **No** | None | No | No | None |

### Concession Types

| Type | DC Reduction | Bonus Dice | Risk Level | Effect |
|------|:------------:|:----------:|:----------:|--------|
| OfferItem | -2 | +2d10 | Low | Item is consumed |
| PromiseFavor | -2 | +2d10 | Medium | Creates debt obligation |
| TradeInformation | -4 | +2d10 | High | Information revealed |
| TakeRisk | -4 | +2d10 | High | Accepts personal danger |
| StakeReputation | -6 | +2d10 | Very High | Faction rep at stake |

### Outcome Position Movement

| Outcome | PC Movement | NPC Movement | Description |
|---------|:-----------:|:------------:|-------------|
| Critical Success | 0 | 2 | NPC moves 2 steps toward PC |
| Full Success | 0 | 1 | NPC moves 1 step toward PC |
| Partial Success | 1 | 1 | Both move 1 step toward each other |
| Failure | 1 | 0 | PC moves 1 step toward NPC |
| Fumble | N/A | N/A | Negotiation collapses immediately |

### NegotiationCollapsed Fumble Consequences

- **Trigger:** Any tactic fumble (Persuade, Deceive, or Pressure)
- **Immediate negotiation termination** - NPC walks away
- **-15 disposition penalty** with target NPC
- **Any concessions already made are still consumed** - items lost, debts created
- **Cannot re-initiate this specific negotiation** - deal is permanently off the table
- **Narrative:** "The negotiation has completely failed. The NPC walks away and the deal is permanently off the table."

## Files Changed

| File | Change |
|------|--------|
| `src/Core/RuneAndRust.Domain/Enums/NegotiationStatus.cs` | Added |
| `src/Core/RuneAndRust.Domain/Enums/NegotiationTactic.cs` | Added |
| `src/Core/RuneAndRust.Domain/Enums/RequestComplexity.cs` | Added |
| `src/Core/RuneAndRust.Domain/Enums/ConcessionType.cs` | Added |
| `src/Core/RuneAndRust.Domain/Enums/FumbleType.cs` | Modified (added NegotiationCollapsed) |
| `src/Core/RuneAndRust.Domain/Extensions/NegotiationStatusExtensions.cs` | Added |
| `src/Core/RuneAndRust.Domain/Extensions/NegotiationTacticExtensions.cs` | Added |
| `src/Core/RuneAndRust.Domain/Extensions/RequestComplexityExtensions.cs` | Added |
| `src/Core/RuneAndRust.Domain/Extensions/ConcessionTypeExtensions.cs` | Added |
| `src/Core/RuneAndRust.Domain/ValueObjects/Concession.cs` | Added |
| `src/Core/RuneAndRust.Domain/ValueObjects/NegotiationRound.cs` | Added |
| `src/Core/RuneAndRust.Domain/ValueObjects/NegotiationContext.cs` | Added |
| `src/Core/RuneAndRust.Domain/ValueObjects/NegotiationResult.cs` | Added |
| `src/Core/RuneAndRust.Domain/Entities/NegotiationPositionTrack.cs` | Added |
| `src/Core/RuneAndRust.Application/Interfaces/INegotiationService.cs` | Added |
| `src/Core/RuneAndRust.Application/Services/NegotiationService.cs` | Added |
| `config/social/negotiation-config.json` | Added |
| `tests/RuneAndRust.Domain.UnitTests/Services/NegotiationSystemTests.cs` | Added |
| `changelogs/v0.15.3e-changelog.md` | Added |

## Test Results

```
Total tests: 50+
     Passed: TBD (run `dotnet test` to verify)
Build succeeded with 0 errors
```

## Dependencies

- **v0.15.3d:** `IntimidationContext`, `IntimidationResult`, `CostOfFear` (Pressure tactic delegation)
- **v0.15.3c:** `DeceptionContext`, `DeceptionResult`, `LiarsBurden` (Deceive tactic delegation)
- **v0.15.3b:** `PersuasionContext`, `PersuasionResult`, `ArgumentAlignment` (Persuade tactic delegation)
- **v0.15.3a:** `NpcDisposition`, `DispositionLevel`, `SocialContext`, `SocialContextBuilder`
- **v0.15.1b:** `FumbleType`, `FumbleConsequence`, `SkillOutcome`
- **v0.15.0:** `DiceRollResult`, `IDiceRollerService`

## Integration Points

### Previous Subsystems (v0.15.3b-d)
- Negotiation delegates tactic checks to specialized services:
  - **Persuade** → PersuasionService
  - **Deceive** → DeceptionService (incurs Liar's Burden stress)
  - **Pressure** → IntimidationService (incurs Cost of Fear reputation)

### v0.15.3f (Interrogation System)
- Negotiation and Interrogation share some mechanics
- Extended negotiations may become interrogations
- Both use multi-round structure

### v0.15.3g (Command System)
- Successful negotiations may establish command hierarchy
- Failed negotiations affect NPC willingness to follow orders

## Notes

- Position track uses 9-point scale (0-8), not 10-point; position 5 is "Compromise" (agreement zone)
- NPC reaching position 8 ("Walk Away") causes automatic collapse
- Concessions always grant +2d10 regardless of type; DC reduction varies (2/4/6)
- Concession bonus applies only to the next check, then clears
- Service uses in-memory tracking for active negotiations; production requires persistence
- Consecutive failure threshold (3 failures) triggers collapse in CrisisManagement status
- NPC flexibility modifies starting position: Desperate (-1), Hostile (+2)
- `FumbleType.NegotiationCollapsed` is instant effect, permanent consequence, single-target only
