# v0.9.0b Design Specification: Audio Settings Integration

**Version:** 0.9.0b
**Parent:** v0.9.0 (Audio Foundation)
**Prerequisites:** v0.9.0a Complete (Core Audio Service)
**Status:** Design Complete
**Estimated Unit Tests:** ~6

---

## 1. Overview

### Purpose

Integrate the audio service with the settings window, making the audio tab fully functional. Includes binding volume sliders to audio channels, mute checkboxes, real-time volume preview with test sounds, and persistence of audio settings across sessions via `settings.json`.

### Key Deliverables

| Category | Items |
|----------|-------|
| **ViewModels** | `AudioSettingsViewModel` |
| **XAML** | `AudioSettingsTab.axaml` bindings |
| **DTOs** | `AudioSettings` |
| **Configuration** | Audio section in `settings.json` |
| **Tests** | ~6 unit tests |

---

## 2. Feature Overview

```
v0.9.0b Features
├── AudioSettingsViewModel
│   ├── IsAudioEnabled (master toggle)
│   ├── MasterVolume (0.0-1.0)
│   ├── MusicVolume (0.0-1.0)
│   ├── EffectsVolume (0.0-1.0)
│   ├── UiVolume (0.0-1.0)
│   ├── IsMuted (global mute)
│   ├── TuiBellEnabled (console beep toggle)
│   └── SaveSettings() / LoadSettings()
│
├── AudioSettingsTab UI
│   ├── Enable Audio checkbox
│   ├── Master volume slider (0-100%)
│   ├── Music volume slider (0-100%)
│   ├── Sound Effects slider (0-100%)
│   ├── UI Sounds slider (0-100%)
│   ├── Mute All checkbox
│   └── Enable Console Bells checkbox
│
├── Real-Time Preview
│   ├── Volume changes apply immediately
│   └── Test sound on slider release
│
├── Settings Persistence
│   ├── Load from settings.json on startup
│   ├── Save to settings.json on Apply/OK
│   └── Cancel reverts to saved values
│
└── Integration
    ├── Binds to IAudioService
    └── Binds to ISettingsService
```

---

## 3. Architecture

```
┌─────────────────────────────────────────────────────────────────────────┐
│                       PRESENTATION LAYER                                │
├─────────────────────────────────────────────────────────────────────────┤
│  Views                                                                  │
│  └── AudioSettingsTab.axaml                                            │
│       ├── Enable Audio CheckBox                                        │
│       ├── Volume Sliders (Master, Music, Effects, UI)                  │
│       ├── Mute All CheckBox                                            │
│       └── TUI Bells CheckBox                                           │
│                                                                         │
│  ViewModels                                                             │
│  └── AudioSettingsViewModel : ViewModelBase                            │
│       ├── IAudioService _audioService                                  │
│       ├── ISettingsService _settingsService                            │
│       ├── bool IsAudioEnabled                                          │
│       ├── float MasterVolume, MusicVolume, EffectsVolume, UiVolume     │
│       ├── bool IsMuted, bool TuiBellEnabled                            │
│       ├── LoadSettings(), SaveSettings(), RevertSettings()             │
│       └── PlayPreviewSound()                                           │
└─────────────────────────────────────────────────────────────────────────┘
                                     │
                                     ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                       APPLICATION / INFRASTRUCTURE                      │
├─────────────────────────────────────────────────────────────────────────┤
│  IAudioService (from v0.9.0a)                                          │
│  ├── SetChannelVolume(channel, volume)                                │
│  ├── SetChannelMuted(channel, muted)                                  │
│  └── SetEnabled(enabled)                                               │
│                                                                         │
│  ISettingsService                                                       │
│  ├── GetAudioSettings() → AudioSettings                                │
│  └── SaveAudioSettings(AudioSettings)                                  │
│                                                                         │
│  AudioSettings (DTO)                                                   │
│  ├── bool Enabled                                                      │
│  ├── float MasterVolume, MusicVolume, EffectsVolume, UiVolume          │
│  ├── bool Muted                                                        │
│  └── bool TuiBellEnabled                                               │
└─────────────────────────────────────────────────────────────────────────┘
```

---

## 4. AudioSettingsTab UI

**File:** `src/Presentation/RuneAndRust.Avalonia/Views/Settings/AudioSettingsTab.axaml`

```xml
<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:vm="using:RuneAndRust.Avalonia.ViewModels"
             x:Class="RuneAndRust.Avalonia.Views.Settings.AudioSettingsTab"
             x:DataType="vm:AudioSettingsViewModel">
    
    <StackPanel Spacing="16" Margin="20">
        <!-- Header -->
        <TextBlock Text="AUDIO SETTINGS" Classes="section-title" />
        <Separator />
        
        <!-- Enable Audio -->
        <CheckBox Content="Enable Audio" IsChecked="{Binding IsAudioEnabled}" />
        
        <!-- Volume Sliders -->
        <Border Classes="settings-group" Padding="16" IsEnabled="{Binding IsAudioEnabled}">
            <StackPanel Spacing="12">
                
                <!-- Master Volume -->
                <Grid ColumnDefinitions="150,*,50">
                    <TextBlock Text="Master Volume" VerticalAlignment="Center" />
                    <Slider Grid.Column="1" Minimum="0" Maximum="1" Value="{Binding MasterVolume}"
                            TickFrequency="0.1" IsSnapToTickEnabled="False" />
                    <TextBlock Grid.Column="2" Text="{Binding MasterVolumePercent}" 
                               HorizontalAlignment="Right" VerticalAlignment="Center" />
                </Grid>
                
                <!-- Music Volume -->
                <Grid ColumnDefinitions="150,*,50">
                    <TextBlock Text="Music Volume" VerticalAlignment="Center" />
                    <Slider Grid.Column="1" Minimum="0" Maximum="1" Value="{Binding MusicVolume}" />
                    <TextBlock Grid.Column="2" Text="{Binding MusicVolumePercent}" 
                               HorizontalAlignment="Right" VerticalAlignment="Center" />
                </Grid>
                
                <!-- Sound Effects -->
                <Grid ColumnDefinitions="150,*,50">
                    <TextBlock Text="Sound Effects" VerticalAlignment="Center" />
                    <Slider Grid.Column="1" Minimum="0" Maximum="1" Value="{Binding EffectsVolume}" />
                    <TextBlock Grid.Column="2" Text="{Binding EffectsVolumePercent}" 
                               HorizontalAlignment="Right" VerticalAlignment="Center" />
                </Grid>
                
                <!-- UI Sounds -->
                <Grid ColumnDefinitions="150,*,50">
                    <TextBlock Text="UI Sounds" VerticalAlignment="Center" />
                    <Slider Grid.Column="1" Minimum="0" Maximum="1" Value="{Binding UiVolume}" />
                    <TextBlock Grid.Column="2" Text="{Binding UiVolumePercent}" 
                               HorizontalAlignment="Right" VerticalAlignment="Center" />
                </Grid>
                
            </StackPanel>
        </Border>
        
        <!-- Mute All -->
        <CheckBox Content="Mute All Audio" IsChecked="{Binding IsMuted}" />
        
        <Separator Margin="0,8" />
        
        <!-- TUI Options -->
        <TextBlock Text="TUI OPTIONS (Console Mode)" Classes="subsection-title" />
        <CheckBox Content="Enable Console Bells" IsChecked="{Binding TuiBellEnabled}" />
        
    </StackPanel>
</UserControl>
```

---

## 5. AudioSettingsViewModel

**File:** `src/Presentation/RuneAndRust.Avalonia/ViewModels/Settings/AudioSettingsViewModel.cs`

```csharp
namespace RuneAndRust.Avalonia.ViewModels.Settings;

public partial class AudioSettingsViewModel : ViewModelBase
{
    private readonly IAudioService _audioService;
    private readonly ISettingsService _settingsService;
    private readonly ILogger<AudioSettingsViewModel> _logger;
    private AudioSettings _savedSettings = null!;

    [ObservableProperty] private bool _isAudioEnabled = true;
    [ObservableProperty] private float _masterVolume = 0.8f;
    [ObservableProperty] private float _musicVolume = 0.6f;
    [ObservableProperty] private float _effectsVolume = 0.8f;
    [ObservableProperty] private float _uiVolume = 0.7f;
    [ObservableProperty] private bool _isMuted;
    [ObservableProperty] private bool _tuiBellEnabled = true;

    // Display percentages
    public string MasterVolumePercent => $"{(int)(MasterVolume * 100)}%";
    public string MusicVolumePercent => $"{(int)(MusicVolume * 100)}%";
    public string EffectsVolumePercent => $"{(int)(EffectsVolume * 100)}%";
    public string UiVolumePercent => $"{(int)(UiVolume * 100)}%";

    public AudioSettingsViewModel(IAudioService audioService, ISettingsService settingsService,
        ILogger<AudioSettingsViewModel> logger)
    {
        _audioService = audioService;
        _settingsService = settingsService;
        _logger = logger;
        LoadSettings();
    }

    partial void OnIsAudioEnabledChanged(bool value)
    {
        _audioService.SetEnabled(value);
        _logger.LogDebug("Audio enabled: {Enabled}", value);
    }

    partial void OnMasterVolumeChanged(float value)
    {
        _audioService.SetChannelVolume(AudioChannel.Master, value);
        OnPropertyChanged(nameof(MasterVolumePercent));
        PlayPreviewSound();
    }

    partial void OnMusicVolumeChanged(float value)
    {
        _audioService.SetChannelVolume(AudioChannel.Music, value);
        OnPropertyChanged(nameof(MusicVolumePercent));
    }

    partial void OnEffectsVolumeChanged(float value)
    {
        _audioService.SetChannelVolume(AudioChannel.Effects, value);
        OnPropertyChanged(nameof(EffectsVolumePercent));
        PlayPreviewSound();
    }

    partial void OnUiVolumeChanged(float value)
    {
        _audioService.SetChannelVolume(AudioChannel.UI, value);
        OnPropertyChanged(nameof(UiVolumePercent));
        PlayPreviewSound();
    }

    partial void OnIsMutedChanged(bool value)
    {
        _audioService.SetChannelMuted(AudioChannel.Master, value);
        _logger.LogDebug("Audio muted: {Muted}", value);
    }

    private void PlayPreviewSound()
    {
        // Debounce: only play if not muted and sufficient time passed
        if (!IsMuted && IsAudioEnabled)
            _audioService.Play("audio/sfx/ui/click.ogg", AudioChannel.UI);
    }

    public void LoadSettings()
    {
        _savedSettings = _settingsService.GetAudioSettings();
        IsAudioEnabled = _savedSettings.Enabled;
        MasterVolume = _savedSettings.MasterVolume;
        MusicVolume = _savedSettings.MusicVolume;
        EffectsVolume = _savedSettings.EffectsVolume;
        UiVolume = _savedSettings.UiVolume;
        IsMuted = _savedSettings.Muted;
        TuiBellEnabled = _savedSettings.TuiBellEnabled;
        _logger.LogDebug("Loaded audio settings");
    }

    public void SaveSettings()
    {
        var settings = new AudioSettings
        {
            Enabled = IsAudioEnabled,
            MasterVolume = MasterVolume,
            MusicVolume = MusicVolume,
            EffectsVolume = EffectsVolume,
            UiVolume = UiVolume,
            Muted = IsMuted,
            TuiBellEnabled = TuiBellEnabled
        };
        _settingsService.SaveAudioSettings(settings);
        _savedSettings = settings;
        _logger.LogInformation("Saved audio settings");
    }

    public void RevertSettings()
    {
        LoadSettings();
        _logger.LogDebug("Reverted audio settings to saved values");
    }
}
```

---

## 6. AudioSettings DTO

**File:** `src/Core/RuneAndRust.Application/DTOs/AudioSettings.cs`

```csharp
namespace RuneAndRust.Application.DTOs;

/// <summary>
/// Audio settings for persistence.
/// </summary>
public class AudioSettings
{
    public bool Enabled { get; set; } = true;
    public float MasterVolume { get; set; } = 0.8f;
    public float MusicVolume { get; set; } = 0.6f;
    public float EffectsVolume { get; set; } = 0.8f;
    public float UiVolume { get; set; } = 0.7f;
    public bool Muted { get; set; } = false;
    public bool TuiBellEnabled { get; set; } = true;
}
```

---

## 7. Settings JSON Schema

**File:** `config/settings.json` (audio section)

```json
{
  "audio": {
    "enabled": true,
    "masterVolume": 0.8,
    "musicVolume": 0.6,
    "effectsVolume": 0.8,
    "uiVolume": 0.7,
    "muted": false,
    "tuiBellEnabled": true
  }
}
```

---

## 8. Visual Design

```
┌─────────────────────────────────────────────────────────────────────┐
│                         SETTINGS                                     │
├────────────┬────────────────────────────────────────────────────────┤
│            │                                                         │
│  [Audio]   │  AUDIO SETTINGS                                        │
│   Display  │  ══════════════════════════════════════════════════    │
│   Gameplay │                                                         │
│   Controls │  ☑ Enable Audio                                        │
│            │                                                         │
│            │  ┌───────────────────────────────────────────────────┐ │
│            │  │ Master Volume                                      │ │
│            │  │ ├────────────────────●──────────────┤  80%        │ │
│            │  │                                                    │ │
│            │  │ Music Volume                                       │ │
│            │  │ ├──────────────●────────────────────┤  60%        │ │
│            │  │                                                    │ │
│            │  │ Sound Effects                                      │ │
│            │  │ ├────────────────────●──────────────┤  80%        │ │
│            │  │                                                    │ │
│            │  │ UI Sounds                                          │ │
│            │  │ ├───────────────────●───────────────┤  70%        │ │
│            │  └───────────────────────────────────────────────────┘ │
│            │                                                         │
│            │  ☐ Mute All Audio                                       │
│            │                                                         │
│            │  ──────────────────────────────────────────────────    │
│            │  TUI OPTIONS (Console Mode)                            │
│            │  ☑ Enable Console Bells                                │
│            │                                                         │
├────────────┴────────────────────────────────────────────────────────┤
│                      [ Apply ]  [ Cancel ]  [ OK ]                   │
└─────────────────────────────────────────────────────────────────────┘
```

---

## 9. Unit Testing Requirements (~6 tests)

| Feature | Tests |
|---------|-------|
| LoadSettings populates ViewModel | 1 |
| SaveSettings persists values | 1 |
| Volume slider updates AudioService | 1 |
| Mute checkbox updates AudioService | 1 |
| RevertSettings restores saved | 1 |
| Percentage display calculation | 1 |

---

## 10. Acceptance Criteria

- [ ] Audio tab shows all volume sliders
- [ ] Enable Audio checkbox toggles audio
- [ ] Master slider adjusts all audio
- [ ] Music slider adjusts music channel
- [ ] Effects slider adjusts effects channel
- [ ] UI slider adjusts UI channel
- [ ] Sliders show percentage (0-100%)
- [ ] Mute All checkbox mutes everything
- [ ] Volume changes apply in real-time
- [ ] Preview sound on volume change
- [ ] TUI Bells checkbox present
- [ ] Settings persist on Apply/OK
- [ ] Cancel reverts to saved values
- [ ] Settings load on startup
- [ ] ~6 unit tests pass

---

## 11. Dependencies

| From | Required |
|------|----------|
| v0.9.0a | `IAudioService`, `AudioChannel` |
| v0.8.0b | `SettingsWindow`, `ISettingsService` |
| Infrastructure | JSON settings persistence |

---

*Document Version: 1.0 | Last Updated: 2026-01-10*
