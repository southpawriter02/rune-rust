# v0.14.8b Changelog - Dice Mechanics Schema

**Release Date:** 2026-01-21
**Version:** v0.14.8b
**Phase:** Configuration Consolidation (v0.14.x)
**Sub-Phase:** Dice Configuration (v0.14.8)

---

## Summary

Implemented the **Dice Mechanics Schema** (`dice-mechanics.schema.json`), which provides a comprehensive JSON schema for dice pool mechanics and roll rules. This schema enables full customization of critical thresholds, advantage/disadvantage mechanics, exploding dice, keep/drop rules, reroll conditions, default dice assignments, and difficulty class definitions—all without code changes.

This version builds upon v0.14.8a (Dice Types Schema) and references the dice expression pattern defined there for validating default dice expressions.

---

## Added

### Schema Files

| File | Description |
|------|-------------|
| `config/schemas/dice-mechanics.schema.json` | JSON Schema for dice mechanics validation |

### Configuration Files

| File | Description |
|------|-------------|
| `config/dice-mechanics.json` | Default dice mechanics configuration |

### Schema Definitions (7 total)

| Definition | Type | Description |
|------------|------|-------------|
| `CriticalThresholds` | object | Critical success/failure configuration |
| `AdvantageRules` | object | Advantage/disadvantage mechanics |
| `ExplodingDiceRules` | object | Exploding dice configuration |
| `KeepRules` | object | Keep/drop dice rules |
| `RerollRules` | object | Automatic reroll conditions |
| `DefaultDice` | object | Default dice for roll categories |
| `DifficultyClass` | object | Named difficulty levels |

---

## Schema Definitions Detail

### CriticalThresholds

| Property | Type | Default | Description |
|----------|------|---------|-------------|
| `naturalMin` | integer | 1 | Die value that triggers critical failure |
| `naturalMax` | "max" \| integer | "max" | Die value that triggers critical success |
| `criticalMultiplier` | number (≥1) | 2 | Damage multiplier on critical hit |
| `criticalBonusDice` | string \| null | null | Extra dice on critical (e.g., "1d6") |
| `autoFailOnNatMin` | boolean | true | Natural min always fails |
| `autoSuccessOnNatMax` | boolean | true | Natural max always succeeds |

### AdvantageRules

| Property | Type | Default | Description |
|----------|------|---------|-------------|
| `advantageDice` | integer (≥1) | 1 | Extra dice rolled with advantage |
| `advantageKeep` | "Highest" \| "Lowest" | "Highest" | Which result to keep |
| `disadvantageDice` | integer (≥1) | 1 | Extra dice rolled with disadvantage |
| `disadvantageKeep` | "Highest" \| "Lowest" | "Lowest" | Which result to keep |
| `stackable` | boolean | false | Multiple advantages stack |

### ExplodingDiceRules

| Property | Type | Default | Description |
|----------|------|---------|-------------|
| `enabled` | boolean | false | Exploding dice active |
| `explodeOn` | "Max" \| "Threshold" | "Max" | Trigger condition |
| `threshold` | integer \| null | null | Threshold value (if Threshold mode) |
| `maxExplosions` | integer (≥1) | 10 | Maximum explosions per die |
| `appliesToTypes` | string[] | [] | Die types that explode (empty = all) |

### KeepRules

| Property | Type | Default | Description |
|----------|------|---------|-------------|
| `keepHighest` | integer \| null | null | Keep N highest dice |
| `keepLowest` | integer \| null | null | Keep N lowest dice |
| `dropHighest` | integer \| null | null | Drop N highest dice |

### RerollRules

| Property | Type | Default | Description |
|----------|------|---------|-------------|
| `rerollOnes` | boolean | false | Reroll natural 1s |
| `rerollBelow` | integer \| null | null | Reroll below threshold |
| `maxRerolls` | integer (≥1) | 1 | Maximum rerolls per die |
| `keepOriginalOnReroll` | boolean | false | Keep original if reroll worse |

### DefaultDice

| Property | Type | Default | Description |
|----------|------|---------|-------------|
| `skillCheck` | dice expression | "1d10" | Default for skill checks |
| `attackRoll` | dice expression | "1d20" | Default for attack rolls |
| `saveRoll` | dice expression | "1d20" | Default for saving throws |
| `damageRoll` | dice expression | "1d6" | Default base damage |
| `initiativeRoll` | dice expression | "1d10" | Default for initiative |
| `healingRoll` | dice expression | "1d8" | Default base healing |

### DifficultyClass

| Property | Type | Required | Description |
|----------|------|----------|-------------|
| `id` | string (kebab-case) | Yes | Unique identifier (e.g., "very-hard") |
| `name` | string | Yes | Display name (e.g., "Very Hard") |
| `dc` | integer (≥1) | Yes | Target number |
| `description` | string | No | Usage description |
| `sortOrder` | integer (≥0) | No | Display ordering |

---

## Standard Difficulty Classes (6 total)

| ID | Name | DC | Description |
|----|------|-----|-------------|
| `trivial` | Trivial | 5 | Almost automatic success |
| `easy` | Easy | 8 | Simple tasks most can accomplish |
| `moderate` | Moderate | 12 | Tasks requiring some skill |
| `hard` | Hard | 16 | Challenging tasks requiring expertise |
| `very-hard` | Very Hard | 20 | Expert-level challenges |
| `nearly-impossible` | Nearly Impossible | 25 | Legendary feats |

---

## Unit Tests

### Test File

`tests/RuneAndRust.Infrastructure.IntegrationTests/Schemas/DiceMechanicsSchemaTests.cs`

### Test Summary

| Test ID | Test Name | Description |
|---------|-----------|-------------|
| DMS-001 | `DiceMechanicsSchema_LoadsAndParses_Successfully` | Schema loads with 7 definitions |
| DMS-002 | `DiceMechanicsSchema_ValidConfiguration_PassesValidation` | Complete config validates |
| DMS-002 | `DiceMechanicsSchema_MinimalConfiguration_PassesValidation` | Minimal config validates |
| DMS-003 | `CriticalThresholds_MultiplierBelowOne_FailsValidation` | Multiplier < 1 rejected |
| DMS-003 | `CriticalThresholds_MultiplierOne_PassesValidation` | Multiplier = 1 accepted |
| DMS-003 | `CriticalThresholds_NaturalMinBelowOne_FailsValidation` | NaturalMin < 1 rejected |
| DMS-003 | `CriticalThresholds_NaturalMaxStringMax_PassesValidation` | "max" accepted |
| DMS-003 | `CriticalThresholds_NaturalMaxInteger_PassesValidation` | Integer accepted |
| DMS-003 | `CriticalThresholds_NaturalMaxZeroInteger_FailsValidation` | Integer 0 rejected |
| DMS-003 | `CriticalThresholds_ValidBonusDice_PassesValidation` | Valid dice expression |
| DMS-003 | `CriticalThresholds_InvalidBonusDice_FailsValidation` | Missing count rejected |
| DMS-004 | `DifficultyClass_UppercaseId_FailsValidation` | Uppercase rejected |
| DMS-004 | `DifficultyClass_ValidKebabCaseId_PassesValidation` | kebab-case accepted |
| DMS-004 | `DifficultyClass_MissingId_FailsValidation` | Missing id rejected |
| DMS-004 | `DifficultyClass_MissingDc_FailsValidation` | Missing dc rejected |
| DMS-004 | `DifficultyClass_DcBelowOne_FailsValidation` | DC < 1 rejected |
| DMS-004 | `DifficultyClass_NegativeSortOrder_FailsValidation` | Negative sortOrder rejected |
| DMS-005 | `MissingRequiredFields_NoCriticalThresholds_FailsValidation` | Missing criticalThresholds |
| DMS-005 | `MissingRequiredFields_NoDefaultDice_FailsValidation` | Missing defaultDice |
| DMS-005 | `MissingRequiredFields_EmptyConfig_FailsValidation` | Empty config rejected |
| DMS-006 | `ExplodingDice_MaxExplosionsZero_FailsValidation` | maxExplosions < 1 rejected |
| DMS-006 | `ExplodingDice_MaxExplosionsOne_PassesValidation` | maxExplosions = 1 accepted |
| DMS-006 | `ExplodingDice_ValidExplodeOn_PassesValidation` | Max/Threshold enums |
| DMS-006 | `ExplodingDice_InvalidExplodeOn_FailsValidation` | Invalid enum rejected |
| DMS-006 | `ExplodingDice_ValidAppliesToTypes_PassesValidation` | Valid die type IDs |
| DMS-006 | `ExplodingDice_InvalidAppliesToTypes_FailsValidation` | Invalid IDs rejected |
| — | `AdvantageRules_ValidKeepEnum_PassesValidation` | Highest/Lowest enums |
| — | `AdvantageRules_InvalidKeepEnum_FailsValidation` | Invalid enum rejected |
| — | `AdvantageRules_AdvantageDiceBelowOne_FailsValidation` | advantageDice < 1 rejected |
| — | `DefaultDice_ValidExpressions_PassesValidation` | All 6 categories valid |
| — | `DefaultDice_InvalidExpression_FailsValidation` | Invalid expression rejected |
| — | `KeepRules_ValidKeepHighest_PassesValidation` | keepHighest accepted |
| — | `KeepRules_KeepHighestBelowOne_FailsValidation` | keepHighest < 1 rejected |
| — | `RerollRules_MaxRerollsBelowOne_FailsValidation` | maxRerolls < 1 rejected |
| — | `RerollRules_ValidRerollBelow_PassesValidation` | rerollBelow accepted |
| — | `Schema_UnknownRootProperty_FailsValidation` | Unknown property rejected |
| — | `DiceMechanicsJson_Contains6DifficultyClasses` | All 6 DCs present |
| — | `DiceMechanicsJson_ContainsAllDefaultDiceCategories` | All 6 categories present |

**Total New Tests:** 40 (including parameterized test cases)

---

## Files Created

| File | Lines | Description |
|------|-------|-------------|
| `config/schemas/dice-mechanics.schema.json` | ~340 | Dice mechanics JSON Schema |
| `config/dice-mechanics.json` | ~90 | Default mechanics configuration |
| `tests/.../Schemas/DiceMechanicsSchemaTests.cs` | ~680 | Unit tests |
| `docs/changelogs/v0.14.8b-changelog.md` | — | This changelog |

---

## Key Design Decisions

### 1. Two Required Sections

**Decision:** Only `criticalThresholds` and `defaultDice` are required; all other sections are optional.

**Rationale:** This allows minimal configurations while still providing the essential mechanics. The optional sections (advantageRules, explodingDice, keepRules, rerollRules, difficultyClasses) can be added as needed.

### 2. naturalMax as "max" or Integer

**Decision:** `naturalMax` uses `oneOf` to accept either the literal string "max" or an integer ≥ 1.

**Rationale:** "max" is the most common case (critical on maximum roll). Integer support enables expanded critical ranges (e.g., 19-20 on a d20).

### 3. Exploding Dice Safety Limit

**Decision:** `maxExplosions` has a minimum of 1 and defaults to 10.

**Rationale:** Prevents infinite loops while allowing reasonable explosion chains. A value of 10 means a die can explode up to 10 times, which is extraordinarily rare.

### 4. Keep/Drop Rule Priority

**Decision:** Only one keep/drop rule should be active at a time; `keepHighest` takes precedence.

**Rationale:** Simplifies implementation and avoids conflicting rules. Documented in schema descriptions.

### 5. Difficulty Class ID Pattern

**Decision:** Difficulty class IDs must match `^[a-z][a-z0-9-]*$` (kebab-case, start with letter).

**Rationale:** Consistent with other ID patterns in the project. Ensures valid identifiers and URL-safe values.

### 6. Dice Expression Pattern

**Decision:** Dice expressions in `defaultDice` use the pattern `^\d+d\d+([+-]\d+)?$`.

**Rationale:** Same pattern as defined in v0.14.8a dice-types.schema.json. Ensures consistency and validates expressions like "1d6", "2d8+3", "1d10-1".

---

## Dependencies

### Required From

| Version | Dependency | Usage |
|---------|------------|-------|
| v0.14.8a | Dice Types Schema | Dice expression pattern for defaultDice |

### Provides To

| Version | Consumer | Usage |
|---------|----------|-------|
| Future | DiceService | Mechanics configuration loading |
| Future | CombatService | Critical hit handling |
| Future | SkillService | Advantage/disadvantage application |

---

## Acceptance Criteria Status

| Criteria | Status |
|----------|--------|
| `dice-mechanics.schema.json` created in `config/schemas/` | ✅ Complete |
| Schema uses JSON Schema Draft-07 format | ✅ Complete |
| Schema includes all 7 definitions | ✅ Complete |
| Schema validates required fields (criticalThresholds, defaultDice) | ✅ Complete |
| `dice-mechanics.json` created with default values | ✅ Complete |
| 6 difficulty classes defined | ✅ Complete |
| Critical multiplier validated ≥ 1 | ✅ Complete |
| Difficulty class ID pattern validated | ✅ Complete |
| Exploding dice maxExplosions validated ≥ 1 | ✅ Complete |
| Advantage keep enum validated | ✅ Complete |
| Default dice expressions validated | ✅ Complete |
| ~6 unit tests pass (40 tests implemented) | ✅ Complete |
| Build completes with 0 errors | ✅ Complete |

---

*Document Version: 1.0*
*Last Updated: 2026-01-21*
*Author: Claude (AI Assistant)*
