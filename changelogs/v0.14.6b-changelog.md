# v0.14.6b Changelog - Music Theme Schema

## Summary

Introduced the comprehensive **Music Theme Schema** (`music-themes.schema.json`) which validates music theme definitions including theme categories, transition rules, intensity layers, stingers, and loop points for seamless audio playback. This schema enables full customization of game music without code changes, supporting modding scenarios such as custom soundtracks, themed music packs, regional variations, or accessibility-focused audio profiles. The schema validates the existing `music-themes.json` configuration file containing 5 themes and 4 stingers. This completes the v0.14.6 Audio Configuration Schemas series.

## Added

### Schema File
- **[config/schemas/music-themes.schema.json](file:///Volumes/GitHub/github/southpawriter02/rune-rust/config/schemas/music-themes.schema.json)** - Comprehensive JSON Schema Draft-07

### Schema Definitions (5 Total)

| Definition | Description | Required Fields |
|------------|-------------|-----------------|
| `ThemeDefinition` | Music theme for a game context | theme, tracks |
| `IntensityLayer` | Dynamic music layer | track, minIntensity, maxIntensity |
| `LoopPoints` | Seamless looping configuration | (none - all optional) |
| `Stinger` | One-shot audio cue | name, track |
| `Transitions` | Theme change settings | (none - all have defaults) |

### Theme Category Enumeration (8 values)

| Theme | Use Case | Typical Characteristics |
|-------|----------|-------------------------|
| `MainMenu` | Title/menu screens | Calm, looping |
| `Exploration` | Dungeon/world navigation | Ambient, shuffle enabled |
| `Combat` | Standard encounters | Intense, quick transition |
| `BossCombat` | Boss battles | Epic, intensity layers |
| `SafeArea` | Towns, rest areas | Relaxing, peaceful |
| `Puzzle` | Puzzle rooms | Thoughtful, non-intrusive |
| `Cinematic` | Cutscenes | Non-looping, timed |
| `Credits` | End credits | Non-looping |

### Transition Type Enumeration (3 values)

| Type | Behavior | Use Case |
|------|----------|----------|
| `Crossfade` | Fade out old while fading in new | Smooth theme changes |
| `Immediate` | Cut directly to new track | Urgent transitions |
| `FadeOutFadeIn` | Fade to silence, then fade in new | Dramatic scene changes |

### ThemeDefinition Properties

| Property | Type | Range | Description |
|----------|------|-------|-------------|
| `theme` | string | enum (8) | Theme category |
| `tracks` | array | minItems: 1 | Audio file paths |
| `introTrack` | string | - | Plays once before main |
| `outroTrack` | string | - | Plays on theme exit |
| `volume` | number | 0-1 | Base volume level |
| `loop` | boolean | - | Loop main tracks |
| `shuffle` | boolean | - | Randomize track order |
| `intensityLayers` | array | - | Dynamic music layers |
| `loopPoints` | object | - | Seamless looping |
| `tags` | array | - | Filtering tags |

### IntensityLayer Properties

| Property | Type | Range | Description |
|----------|------|-------|-------------|
| `track` | string | - | Audio file path |
| `minIntensity` | number | 0-1 | Layer starts fading in |
| `maxIntensity` | number | 0-1 | Layer at full volume |
| `fadeTime` | number | ≥0 | Fade duration (seconds) |
| `volumeMultiplier` | number | 0-1 | Maximum layer volume |

### Stinger Properties

| Property | Type | Range | Description |
|----------|------|-------|-------------|
| `name` | string | pattern | Kebab-case identifier |
| `track` | string | - | Audio file path |
| `volume` | number | 0-1 | Playback volume |
| `duckMusic` | boolean | - | Lower music during playback |
| `duckAmount` | number | 0-1 | Ducked music level |
| `resumeDelay` | number | ≥0 | Resume delay (seconds) |

### Transitions Properties

| Property | Type | Default | Description |
|----------|------|---------|-------------|
| `defaultCrossfade` | number | 2.0 | Default fade duration |
| `combatCrossfade` | number | 0.5 | Combat entry fade |
| `bossCrossfade` | number | 1.0 | Boss encounter fade |
| `stingerFadeOut` | number | 1.0 | Music duck speed |
| `stingerResumeDelay` | number | 0.5 | Resume delay after stinger |
| `transitionType` | string | Crossfade | Default transition method |

### Existing Configuration Validated

| Category | Count | Items |
|----------|-------|-------|
| Themes | 5 | MainMenu, Exploration, Combat, BossCombat, SafeArea |
| Stingers | 4 | victory, defeat, level-up, quest-complete |
| Transitions | 1 | defaultCrossfade, combatCrossfade, stingerFadeOut, stingerResumeDelay |

### Unit Tests
- **[MusicThemesSchemaTests.cs](file:///Volumes/GitHub/github/southpawriter02/rune-rust/tests/RuneAndRust.Infrastructure.IntegrationTests/Schemas/MusicThemesSchemaTests.cs)** - 14 tests
  - `Schema_IsValidJsonSchemaDraft07` - Schema structure validation (5 definitions)
  - `MusicThemesJson_ValidatesAgainstSchema` - Backwards compatibility (5 themes, 4 stingers)
  - `Theme_InvalidEnum_FailsValidation` - Theme enum (8 values)
  - `TransitionType_InvalidEnum_FailsValidation` - Transition type enum (3 values)
  - `Tracks_EmptyArray_FailsValidation` - Tracks minItems: 1
  - `Volume_OutOfRange_FailsValidation` - Volume 0-1
  - `Themes_EmptyArray_FailsValidation` - Themes minItems: 1
  - `StingerName_InvalidPattern_FailsValidation` - Kebab-case pattern
  - `IntensityLayerMinIntensity_OutOfRange_FailsValidation` - Intensity range 0-1
  - `DuckAmount_OutOfRange_FailsValidation` - duckAmount 0-1
  - `CrossfadeDuration_Negative_FailsValidation` - Crossfade ≥ 0
  - `LoopStartSamples_Negative_FailsValidation` - Samples ≥ 0
  - `VolumeMultiplier_OutOfRange_FailsValidation` - volumeMultiplier 0-1
  - `Theme_CaseSensitive_FailsValidation` - Case-sensitive enum

## Files Changed

| File | Change Type |
|------|-------------|
| `config/schemas/music-themes.schema.json` | Added |
| `tests/.../Schemas/MusicThemesSchemaTests.cs` | Added |
| `changelogs/v0.14.6b-changelog.md` | Added |

## Test Results

```
Test summary: total: 14, failed: 0, succeeded: 14, skipped: 0
Build succeeded with 0 errors
```

## Music Theme Schema Structure

```
┌─────────────────────────────────────────────────────────────────┐
│  MUSIC THEMES CONFIGURATION                                     │
├─────────────────────────────────────────────────────────────────┤
│  $schema: "./schemas/music-themes.schema.json"                  │
│  version: "1.0.0" (optional)                                    │
│                                                                 │
│  ┌───────────────────────────────────────────────────────────┐  │
│  │  THEMES (required, minItems: 1)                            │  │
│  │  ┌─────────────────────────────────────────────────────┐  │  │
│  │  │ { theme: "MainMenu", tracks: [...], volume: 0.7 }   │  │  │
│  │  │ { theme: "Exploration", tracks: [...], shuffle: t } │  │  │
│  │  │ { theme: "Combat", tracks: [...], introTrack: ... } │  │  │
│  │  │ { theme: "BossCombat", intensityLayers: [...] }     │  │  │
│  │  │ { theme: "SafeArea", tracks: [...] }                │  │  │
│  │  └─────────────────────────────────────────────────────┘  │  │
│  └───────────────────────────────────────────────────────────┘  │
│                                                                 │
│  ┌───────────────────────────────────────────────────────────┐  │
│  │  STINGERS (optional)                                       │  │
│  │  ┌─────────────────────────────────────────────────────┐  │  │
│  │  │ { name: "victory", track: "...", volume: 1.0 }      │  │  │
│  │  │ { name: "defeat", track: "...", duckAmount: 0.3 }   │  │  │
│  │  │ { name: "level-up", track: "..." }                  │  │  │
│  │  │ { name: "quest-complete", track: "..." }            │  │  │
│  │  └─────────────────────────────────────────────────────┘  │  │
│  └───────────────────────────────────────────────────────────┘  │
│                                                                 │
│  ┌───────────────────────────────────────────────────────────┐  │
│  │  TRANSITIONS (required)                                    │  │
│  │  ┌─────────────────────────────────────────────────────┐  │  │
│  │  │  defaultCrossfade: 2.0                               │  │  │
│  │  │  combatCrossfade: 0.5                                │  │  │
│  │  │  stingerFadeOut: 1.0                                 │  │  │
│  │  │  stingerResumeDelay: 0.5                             │  │  │
│  │  │  transitionType: "Crossfade"                         │  │  │
│  │  └─────────────────────────────────────────────────────┘  │  │
│  └───────────────────────────────────────────────────────────┘  │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

## Intensity Layer System

```
  Game Intensity Value: 0.0 ────────────────────────────────── 1.0
                        │                                       │
                        ▼                                       ▼
                      Low                                     High
                    (Calm)                                  (Crisis)

  Layer Configuration:
  ────────────────────
    minIntensity: 0.2  ← Layer starts fading in at 0.2
    maxIntensity: 0.8  ← Layer at full volume at 0.8
    fadeTime: 1.0      ← Seconds to fade in/out
    volumeMultiplier: 1.0  ← Maximum volume for this layer

  Volume Calculation:
    If intensity < min: volume = 0
    If intensity > max: volume = volumeMultiplier
    Else: volume = (intensity - min) / (max - min) × volumeMultiplier
```

## v0.14.6 Audio Configuration Schemas - COMPLETE ✓

| Version | Schema | Tests |
|---------|--------|-------|
| v0.14.6a | `sound-effects.schema.json` | 13 ✓ |
| v0.14.6b | `music-themes.schema.json` | 14 ✓ |
| **Total** | **2 schemas** | **27 tests** |

## Modding Scenarios Enabled

After this implementation, modders can:
- Define custom music themes for any of the 8 game contexts
- Configure multiple tracks per theme with shuffle support
- Set up intro/outro tracks for theme transitions
- Configure intensity layers for dynamic music scaling
- Define custom loop points (samples or seconds)
- Create stingers with music ducking
- Configure transition timings and types

---

*Final entry in v0.14.6 Audio Configuration Schemas series. See also: v0.14.6a (Sound Effect Schema).*
