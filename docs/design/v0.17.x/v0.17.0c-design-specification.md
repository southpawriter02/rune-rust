# v0.17.0c Design Specification: Unique Traits

**Version:** 0.17.0c  
**Phase Name:** Unique Traits  
**Parent Version:** v0.17.0 (Lineage System)  
**Prerequisites:** v0.17.0b Complete (Passive Bonuses)  
**Estimated Tests:** ~8 unit tests

---

## Table of Contents

1. [Executive Summary](#1-executive-summary)
2. [Feature Overview](#2-feature-overview)
3. [Architecture Diagrams](#3-architecture-diagrams)
4. [LineageTraitEffectType Enum](#4-lineagetraiteffecttype-enum)
5. [LineageTrait Value Object](#5-lineagetrait-value-object)
6. [LineageDefinition Extension](#6-lineagedefinition-extension)
7. [Data Model Changes](#7-data-model-changes)
8. [Configuration File Schema Updates](#8-configuration-file-schema-updates)
9. [Logging Specifications](#9-logging-specifications)
10. [Unit Testing Requirements](#10-unit-testing-requirements)
11. [Use Cases](#11-use-cases)
12. [User Stories](#12-user-stories)
13. [Deliverable Checklist](#13-deliverable-checklist)
14. [Acceptance Criteria](#14-acceptance-criteria)
15. [Dependencies](#15-dependencies)
16. [Future Considerations](#16-future-considerations)

---

## 1. Executive Summary

### 1.1 Purpose

This specification defines the unique trait system for lineages, extending the `LineageDefinition` entity with a signature ability that defines each bloodline's special advantage. Unlike passive bonuses which provide flat stat increases, unique traits are conditional abilities that trigger under specific circumstances.

Each lineage has one thematically appropriate unique trait:

- **Clan-Born** — `[Survivor's Resolve]`: +1d10 to Rhetoric checks with Clan-Born NPCs
- **Rune-Marked** — `[Aether-Tainted]`: +10% Maximum Aether Pool
- **Iron-Blooded** — `[Hazard Acclimation]`: +1d10 to Sturdiness Resolve vs environmental hazards
- **Vargr-Kin** — `[Primal Clarity]`: -10% Psychic Stress from all sources

This phase establishes the `LineageTrait` value object and `LineageTraitEffectType` enum that enable these signature lineage abilities.

### 1.2 Key Deliverables

| Category          | Items                                             |
| ----------------- | ------------------------------------------------- |
| **Enums**         | `LineageTraitEffectType`                          |
| **Value Objects** | `LineageTrait`                                    |
| **Entity Update** | `LineageDefinition` extended with `UniqueTrait`   |
| **Configuration** | `lineages.json` extended with trait section       |
| **Schema Update** | `lineages.schema.json` extended with trait schema |
| **Tests**         | ~8 unit tests                                     |

### 1.3 Architectural Significance

This version extends the **Lineage Pattern** with conditional effect mechanics:

- **Effect Type Classification**: Four distinct effect types enable diverse trait behaviors
- **Conditional Triggering**: Traits activate based on specific game conditions
- **Dice Pool Integration**: Some traits add bonus dice to skill/resolve checks
- **Percentage Modifiers**: Some traits scale values by percentage
- **Condition Expressions**: String-based conditions allow configuration flexibility
- **Trauma Economy Hook**: Primal Clarity integrates with Psychic Stress reduction

---

## 2. Feature Overview

```
v0.17.0c Unique Traits
├── LineageTraitEffectType Enum
│   ├── BonusDiceToSkill (0) — Adds dice to skill checks
│   ├── PercentageModifier (1) — Scales values by percentage
│   ├── BonusDiceToResolve (2) — Adds dice to resolve checks
│   └── PassiveAuraBonus (3) — Percentage bonus to resource pools
├── LineageTrait Value Object
│   ├── TraitId: string              (kebab-case identifier)
│   ├── TraitName: string            (display name with brackets)
│   ├── Description: string          (effect explanation)
│   ├── EffectType: LineageTraitEffectType
│   ├── TriggerCondition: string?    (when effect activates)
│   ├── BonusDice: int?              (dice to add, if applicable)
│   ├── PercentModifier: float?      (percentage, if applicable)
│   ├── TargetCheck: string?         (skill/resolve type)
│   └── TargetCondition: string?     (target requirements)
└── LineageDefinition Extension
    └── UniqueTrait: LineageTrait
```

### 2.1 Scope Alignment

**In Scope:**

- `LineageTraitEffectType` enum with four effect types
- `LineageTrait` value object with all properties
- Extension of `LineageDefinition` entity with `UniqueTrait` property
- Configuration schema updates for trait section
- Trait data for all 4 lineages
- Trait effect type definitions (BonusDice, Percentage, etc.)
- Condition string structure for trait activation

**Out of Scope:**

- Trauma baselines (Corruption, Stress) → v0.17.0d
- LineageProvider service → v0.17.0e
- LineageApplicationService → v0.17.0f
- Trait effect execution engine → Future combat/skill system integration
- Condition expression parser → Uses string matching initially

---

## 3. Architecture Diagrams

### 3.1 Unique Trait System Overview

```
┌─────────────────────────────────────────────────────────────────────┐
│                    UNIQUE TRAIT SYSTEM OVERVIEW                      │
└─────────────────────────────────────────────────────────────────────┘

    LineageDefinition (from v0.17.0a-b)
           │
           │  Contains unique trait
           ▼
┌─────────────────────────────────────────────────────────────────────┐
│                         LineageTrait                                 │
├─────────────────────────────────────────────────────────────────────┤
│  - TraitId: string             ("survivors_resolve")                │
│  - TraitName: string           ("[Survivor's Resolve]")             │
│  - Description: string         (player-facing explanation)          │
│  - EffectType: LineageTraitEffectType                               │
│  - TriggerCondition: string?   ("rhetoric_check_initiated")         │
│  - BonusDice: int?             (1 for +1d10)                        │
│  - PercentModifier: float?     (0.10 for +10%)                      │
│  - TargetCheck: string?        ("rhetoric")                         │
│  - TargetCondition: string?    ("npc.lineage == ClanBorn")          │
└─────────────────────────────────────────────────────────────────────┘
           │
           │  Classified by effect type
           ▼
┌─────────────────────────────────────────────────────────────────────┐
│                    LineageTraitEffectType                            │
├─────────────────────────────────────────────────────────────────────┤
│  BonusDiceToSkill (0)   │  PercentageModifier (1)                   │
│  BonusDiceToResolve (2) │  PassiveAuraBonus (3)                     │
└─────────────────────────────────────────────────────────────────────┘
```

### 3.2 Layer Diagram

```
┌─────────────────────────────────────────────────────────────────────┐
│                        PRESENTATION LAYER                            │
├─────────────────────────────────────────────────────────────────────┤
│  CharacterCreationView (v0.17.5)                                     │
│  └── Displays unique trait name and description                      │
│                                                                      │
│  CharacterSheetView                                                   │
│  └── Shows trait in "Abilities" section                               │
│                                                                      │
│  SkillCheckResultView                                                │
│  └── Displays trait activation and bonus (e.g., "+1d10 from trait") │
└───────┬─────────────────────────────────────────────────────────────┘
        │
        ▼
┌─────────────────────────────────────────────────────────────────────┐
│                       APPLICATION LAYER                              │
├─────────────────────────────────────────────────────────────────────┤
│  SkillCheckService                                                   │
│  └── Evaluates BonusDiceToSkill traits before roll                   │
│                                                                      │
│  ResolveCheckService                                                 │
│  └── Evaluates BonusDiceToResolve traits (e.g., vs hazards)          │
│                                                                      │
│  DerivedStatCalculator (v0.17.2)                                     │
│  └── Applies PassiveAuraBonus to Max AP                              │
│                                                                      │
│  TraumaService (future)                                              │
│  └── Applies PercentageModifier to Stress gain                       │
│                                                                      │
│  ILineageApplicationService (v0.17.0f)                               │
│  └── Registers trait with appropriate systems                        │
└───────┬─────────────────────────────────────────────────────────────┘
        │
        ▼
┌─────────────────────────────────────────────────────────────────────┐
│                         DOMAIN LAYER                                 │
├─────────────────────────────────────────────────────────────────────┤
│  ┌─────────────────────────────────────────────────────────────┐    │
│  │                   LineageDefinition                          │    │
│  │                      (Entity)                                │    │
│  ├─────────────────────────────────────────────────────────────┤    │
│  │ + Id: Guid                                                   │    │
│  │ + LineageId: Lineage                                         │    │
│  │ + AttributeModifiers: LineageAttributeModifiers (v0.17.0a)   │    │
│  │ + PassiveBonuses: LineagePassiveBonuses         (v0.17.0b)   │    │
│  │ + UniqueTrait: LineageTrait                     ← NEW        │    │
│  └─────────────────────────────────────────────────────────────┘    │
│                            │                                         │
│  ┌─────────────────────────┴───────────────────────────────────┐    │
│  │                    LineageTrait (Value Object)              │    │
│  ├─────────────────────────────────────────────────────────────┤    │
│  │ TraitId: string          TargetCheck: string?               │    │
│  │ TraitName: string        TargetCondition: string?           │    │
│  │ Description: string      BonusDice: int?                    │    │
│  │ EffectType: enum         PercentModifier: float?            │    │
│  │ TriggerCondition: string?                                   │    │
│  └─────────────────────────────────────────────────────────────┘    │
│                            │                                         │
│  ┌─────────────────────────┴───────────────────────────────────┐    │
│  │              LineageTraitEffectType (Enum)                  │    │
│  ├─────────────────────────────────────────────────────────────┤    │
│  │ BonusDiceToSkill = 0     BonusDiceToResolve = 2            │    │
│  │ PercentageModifier = 1   PassiveAuraBonus = 3              │    │
│  └─────────────────────────────────────────────────────────────┘    │
└─────────────────────────────────────────────────────────────────────┘
```

### 3.3 Trait Activation Flow - Survivor's Resolve

```
┌─────────────────────────────────────────────────────────────────────┐
│              TRAIT ACTIVATION FLOW: SURVIVOR'S RESOLVE               │
└─────────────────────────────────────────────────────────────────────┘

    Player initiates Rhetoric skill check
           │
           ▼
┌─────────────────────────────────────────────────────────────────────┐
│                    CHECK TRAIT CONDITIONS                            │
├─────────────────────────────────────────────────────────────────────┤
│  1. Get character's lineage trait                                   │
│     → Trait: Survivor's Resolve                                      │
│     → EffectType: BonusDiceToSkill                                  │
│                                                                      │
│  2. Check TriggerCondition                                           │
│     → Condition: "rhetoric_check_initiated"                         │
│     → Current action: Rhetoric check                                 │
│     → Match? YES ✓                                                  │
│                                                                      │
│  3. Check TargetCondition                                            │
│     → Condition: "npc.lineage == ClanBorn"                          │
│     → Target NPC lineage: ClanBorn                                   │
│     → Match? YES ✓                                                  │
└─────────────────────────────────────────────────────────────────────┘
           │
           ▼
    ┌──────────────────────┐
    │ All conditions met?  │
    └──────────┬───────────┘
               │
        ┌──────┴──────┐
       YES            NO
        │              │
        ▼              ▼
┌───────────────┐  ┌───────────────┐
│ Add BonusDice │  │ No bonus      │
│ (+1d10)       │  │ applied       │
└───────┬───────┘  └───────────────┘
        │
        ▼
┌─────────────────────────────────────────────────────────────────────┐
│                    ROLL WITH BONUS                                   │
├─────────────────────────────────────────────────────────────────────┤
│  Base Dice Pool: 3d10 (from Wits + Rhetoric skill)                  │
│  + Lineage Bonus: +1d10 (from [Survivor's Resolve])                 │
│  = Total Pool: 4d10                                                  │
│                                                                      │
│  Display: "Survivor's Resolve activates! +1d10 vs Clan-Born NPC"    │
└─────────────────────────────────────────────────────────────────────┘
```

### 3.4 Trait Activation Flow - Aether-Tainted

```
┌─────────────────────────────────────────────────────────────────────┐
│               TRAIT ACTIVATION FLOW: AETHER-TAINTED                  │
└─────────────────────────────────────────────────────────────────────┘

    Character creation or level-up (Max AP calculation)
           │
           ▼
┌─────────────────────────────────────────────────────────────────────┐
│                    CALCULATE BASE MAX AP                             │
├─────────────────────────────────────────────────────────────────────┤
│  Formula: (WILL × 10) + (WITS × 5) + Archetype Bonus + Lineage AP   │
│                                                                      │
│  Example: (4 × 10) + (3 × 5) + 0 + 5                                │
│         = 40 + 15 + 0 + 5                                           │
│         = 60 Base Max AP                                             │
└─────────────────────────────────────────────────────────────────────┘
           │
           ▼
┌─────────────────────────────────────────────────────────────────────┐
│                    CHECK TRAIT APPLICATION                           │
├─────────────────────────────────────────────────────────────────────┤
│  1. Get character's lineage trait                                   │
│     → Trait: Aether-Tainted                                          │
│     → EffectType: PassiveAuraBonus                                  │
│                                                                      │
│  2. Check TriggerCondition                                           │
│     → Condition: "max_ap_calculation"                               │
│     → Current action: Calculating Max AP                             │
│     → Match? YES ✓                                                  │
│                                                                      │
│  3. Apply PercentModifier                                            │
│     → Modifier: +10% (0.10)                                         │
│     → Calculation: 60 × 1.10 = 66                                   │
└─────────────────────────────────────────────────────────────────────┘
           │
           ▼
┌─────────────────────────────────────────────────────────────────────┐
│                    FINAL MAX AP                                      │
├─────────────────────────────────────────────────────────────────────┤
│  Base: 60                                                            │
│  × Aether-Tainted: 1.10                                              │
│  = Final Max AP: 66                                                  │
│                                                                      │
│  Display: "Max AP: 66 (+10% from [Aether-Tainted])"                 │
└─────────────────────────────────────────────────────────────────────┘
```

### 3.5 Trait Activation Flow - Primal Clarity

```
┌─────────────────────────────────────────────────────────────────────┐
│               TRAIT ACTIVATION FLOW: PRIMAL CLARITY                  │
└─────────────────────────────────────────────────────────────────────┘

    Character receives Psychic Stress
           │
           ▼
┌─────────────────────────────────────────────────────────────────────┐
│                    CALCULATE STRESS BEFORE REDUCTION                 │
├─────────────────────────────────────────────────────────────────────┤
│  Source: Mind-flayer attack                                          │
│  Base Stress: 10 points                                              │
└─────────────────────────────────────────────────────────────────────┘
           │
           ▼
┌─────────────────────────────────────────────────────────────────────┐
│                    CHECK TRAIT APPLICATION                           │
├─────────────────────────────────────────────────────────────────────┤
│  1. Get character's lineage trait                                   │
│     → Trait: Primal Clarity                                          │
│     → EffectType: PercentageModifier                                │
│                                                                      │
│  2. Check TriggerCondition                                           │
│     → Condition: "psychic_stress_gain"                              │
│     → Current action: Gaining Psychic Stress                         │
│     → Match? YES ✓                                                  │
│                                                                      │
│  3. Apply PercentModifier                                            │
│     → Modifier: -10% (-0.10)                                        │
│     → Calculation: 10 × 0.90 = 9                                    │
└─────────────────────────────────────────────────────────────────────┘
           │
           ▼
┌─────────────────────────────────────────────────────────────────────┐
│                    FINAL STRESS GAIN                                 │
├─────────────────────────────────────────────────────────────────────┤
│  Base: 10 Psychic Stress                                             │
│  × Primal Clarity: 0.90                                              │
│  = Final Stress: 9 points                                            │
│                                                                      │
│  Display: "Primal Clarity reduces stress! 9 Psychic Stress gained"  │
└─────────────────────────────────────────────────────────────────────┘
```

### 3.6 Trait Effect Type Decision Tree

```
┌─────────────────────────────────────────────────────────────────────┐
│                    TRAIT EFFECT TYPE DECISION                        │
└─────────────────────────────────────────────────────────────────────┘

    Evaluate LineageTrait.EffectType
           │
           ▼
    ┌──────────────────────────────────────────────────────────────┐
    │                    What is the EffectType?                    │
    └──────────────────────────┬───────────────────────────────────┘
               ┌───────────────┼───────────────┬───────────────┐
               ▼               ▼               ▼               ▼
    ┌──────────────┐ ┌──────────────┐ ┌──────────────┐ ┌──────────────┐
    │BonusDiceToSkill│PercentageMod │BonusDiceResolve│PassiveAura   │
    └──────┬───────┘ └──────┬───────┘ └──────┬───────┘ └──────┬───────┘
           │                │                │                │
           ▼                ▼                ▼                ▼
    ┌──────────────┐ ┌──────────────┐ ┌──────────────┐ ┌──────────────┐
    │ Uses:        │ │ Uses:        │ │ Uses:        │ │ Uses:        │
    │ - BonusDice  │ │ - PercentMod │ │ - BonusDice  │ │ - PercentMod │
    │ - TargetCheck│ │ - TriggerCond│ │ - TriggerCond│ │ - TriggerCond│
    │ - TargetCond │ │              │ │ - TargetCheck│ │              │
    └──────────────┘ └──────────────┘ └──────────────┘ └──────────────┘
           │                │                │                │
           ▼                ▼                ▼                ▼
    ┌──────────────┐ ┌──────────────┐ ┌──────────────┐ ┌──────────────┐
    │ Example:     │ │ Example:     │ │ Example:     │ │ Example:     │
    │ Survivor's   │ │ Primal       │ │ Hazard       │ │ Aether-      │
    │ Resolve      │ │ Clarity      │ │ Acclimation  │ │ Tainted      │
    │ (+1d10 to    │ │ (-10% Stress)│ │ (+1d10 vs    │ │ (+10% Max AP)│
    │ Rhetoric)    │ │              │ │ hazards)     │ │              │
    └──────────────┘ └──────────────┘ └──────────────┘ └──────────────┘
```

---

## 4. LineageTraitEffectType Enum

### 4.1 Purpose

The `LineageTraitEffectType` enum classifies the mechanical behavior of lineage traits, enabling the trait system to apply effects correctly based on their type.

### 4.2 Implementation

**File:** `src/Core/RuneAndRust.Domain/Enums/LineageTraitEffectType.cs`

```csharp
namespace RuneAndRust.Domain.Enums;

/// <summary>
/// Defines the types of effects that lineage traits can apply.
/// </summary>
/// <remarks>
/// <para>
/// LineageTraitEffectType categorizes how a trait modifies gameplay:
/// - BonusDiceToSkill: Adds dice to skill checks under certain conditions
/// - PercentageModifier: Scales incoming or outgoing values by percentage
/// - BonusDiceToResolve: Adds dice to resolve checks (e.g., vs hazards)
/// - PassiveAuraBonus: Applies a percentage bonus to resource pools
/// </para>
/// <para>
/// Effect types are explicitly assigned (0-3) to ensure stable serialization.
/// </para>
/// </remarks>
public enum LineageTraitEffectType
{
    /// <summary>
    /// Adds bonus dice to specific skill checks when conditions are met.
    /// </summary>
    /// <remarks>
    /// Used by traits like [Survivor's Resolve] which adds +1d10 to Rhetoric
    /// checks when interacting with Clan-Born NPCs. Requires BonusDice,
    /// TargetCheck, and TargetCondition properties.
    /// </remarks>
    BonusDiceToSkill = 0,

    /// <summary>
    /// Modifies incoming or outgoing values by a percentage.
    /// </summary>
    /// <remarks>
    /// Used by traits like [Primal Clarity] which reduces Psychic Stress
    /// by 10%. Requires PercentModifier and TriggerCondition properties.
    /// Positive values increase, negative values decrease.
    /// </remarks>
    PercentageModifier = 1,

    /// <summary>
    /// Adds bonus dice to resolve checks (mental/physical resistance).
    /// </summary>
    /// <remarks>
    /// Used by traits like [Hazard Acclimation] which adds +1d10 to
    /// Sturdiness Resolve checks versus environmental hazards. Requires
    /// BonusDice, TargetCheck, and TriggerCondition properties.
    /// </remarks>
    BonusDiceToResolve = 2,

    /// <summary>
    /// Applies a percentage bonus to a resource pool (HP, AP, etc.).
    /// </summary>
    /// <remarks>
    /// Used by traits like [Aether-Tainted] which increases Maximum
    /// Aether Pool by 10%. Requires PercentModifier and TriggerCondition
    /// properties. Applied during derived stat calculation.
    /// </remarks>
    PassiveAuraBonus = 3
}
```

### 4.3 Effect Type Reference Table

| Effect Type        | Value | Uses BonusDice | Uses PercentMod | Example Trait      |
| ------------------ | ----- | -------------- | --------------- | ------------------ |
| BonusDiceToSkill   | 0     | ✓              | —               | Survivor's Resolve |
| PercentageModifier | 1     | —              | ✓               | Primal Clarity     |
| BonusDiceToResolve | 2     | ✓              | —               | Hazard Acclimation |
| PassiveAuraBonus   | 3     | —              | ✓               | Aether-Tainted     |

---

## 5. LineageTrait Value Object

### 5.1 Purpose

The `LineageTrait` value object encapsulates all data for a unique lineage trait, including its name, effect type, trigger conditions, and mechanical modifiers.

### 5.2 Implementation

**File:** `src/Core/RuneAndRust.Domain/ValueObjects/LineageTrait.cs`

```csharp
namespace RuneAndRust.Domain.ValueObjects;

using RuneAndRust.Domain.Enums;

/// <summary>
/// Represents a unique trait granted by a lineage.
/// </summary>
/// <remarks>
/// <para>
/// LineageTrait defines a signature ability unique to each bloodline. Unlike
/// passive bonuses which are always active, traits have conditions that
/// determine when they apply.
/// </para>
/// <para>
/// Traits use one of four effect types:
/// - BonusDiceToSkill: Adds dice to skill checks (e.g., Rhetoric)
/// - PercentageModifier: Scales values (e.g., Stress reduction)
/// - BonusDiceToResolve: Adds dice to resolve checks (e.g., vs hazards)
/// - PassiveAuraBonus: Percentage increase to pools (e.g., Max AP)
/// </para>
/// </remarks>
/// <param name="TraitId">Kebab-case unique identifier.</param>
/// <param name="TraitName">Display name with brackets (e.g., "[Survivor's Resolve]").</param>
/// <param name="Description">Player-facing explanation of the trait effect.</param>
/// <param name="EffectType">The type of effect this trait applies.</param>
/// <param name="TriggerCondition">Condition string for when trait activates.</param>
/// <param name="BonusDice">Number of bonus dice (for dice-based effects).</param>
/// <param name="PercentModifier">Percentage modifier (for percentage effects).</param>
/// <param name="TargetCheck">Skill or resolve check type affected.</param>
/// <param name="TargetCondition">Condition for valid targets.</param>
public readonly record struct LineageTrait(
    string TraitId,
    string TraitName,
    string Description,
    LineageTraitEffectType EffectType,
    string? TriggerCondition,
    int? BonusDice,
    float? PercentModifier,
    string? TargetCheck,
    string? TargetCondition)
{
    /// <summary>
    /// Gets whether this trait uses bonus dice.
    /// </summary>
    public bool UsesBonusDice =>
        EffectType is LineageTraitEffectType.BonusDiceToSkill
                   or LineageTraitEffectType.BonusDiceToResolve;

    /// <summary>
    /// Gets whether this trait uses percentage modification.
    /// </summary>
    public bool UsesPercentModifier =>
        EffectType is LineageTraitEffectType.PercentageModifier
                   or LineageTraitEffectType.PassiveAuraBonus;

    /// <summary>
    /// Gets whether this trait has a target condition.
    /// </summary>
    public bool HasTargetCondition => !string.IsNullOrWhiteSpace(TargetCondition);

    /// <summary>
    /// Gets the effective bonus dice count (0 if not applicable).
    /// </summary>
    public int EffectiveBonusDice => BonusDice ?? 0;

    /// <summary>
    /// Gets the effective percent modifier (0 if not applicable).
    /// </summary>
    public float EffectivePercentModifier => PercentModifier ?? 0f;

    /// <summary>
    /// Creates a new LineageTrait with validation.
    /// </summary>
    public static LineageTrait Create(
        string traitId,
        string traitName,
        string description,
        LineageTraitEffectType effectType,
        string? triggerCondition = null,
        int? bonusDice = null,
        float? percentModifier = null,
        string? targetCheck = null,
        string? targetCondition = null)
    {
        ArgumentException.ThrowIfNullOrWhiteSpace(traitId);
        ArgumentException.ThrowIfNullOrWhiteSpace(traitName);
        ArgumentException.ThrowIfNullOrWhiteSpace(description);

        // Validate effect type has required properties
        if (effectType is LineageTraitEffectType.BonusDiceToSkill
                       or LineageTraitEffectType.BonusDiceToResolve)
        {
            if (!bonusDice.HasValue || bonusDice.Value <= 0)
            {
                throw new ArgumentException(
                    $"Effect type {effectType} requires a positive BonusDice value.",
                    nameof(bonusDice));
            }
        }

        if (effectType is LineageTraitEffectType.PercentageModifier
                       or LineageTraitEffectType.PassiveAuraBonus)
        {
            if (!percentModifier.HasValue)
            {
                throw new ArgumentException(
                    $"Effect type {effectType} requires a PercentModifier value.",
                    nameof(percentModifier));
            }
        }

        return new LineageTrait(
            traitId.ToLowerInvariant(),
            traitName,
            description,
            effectType,
            triggerCondition,
            bonusDice,
            percentModifier,
            targetCheck?.ToLowerInvariant(),
            targetCondition);
    }

    /// <summary>
    /// Default trait for Clan-Born lineage: Survivor's Resolve.
    /// </summary>
    public static LineageTrait SurvivorsResolve => Create(
        traitId: "survivors_resolve",
        traitName: "[Survivor's Resolve]",
        description: "Gain +1d10 to Rhetoric checks when interacting with Clan-Born NPCs.",
        effectType: LineageTraitEffectType.BonusDiceToSkill,
        triggerCondition: "rhetoric_check_initiated",
        bonusDice: 1,
        targetCheck: "rhetoric",
        targetCondition: "npc.lineage == ClanBorn");

    /// <summary>
    /// Default trait for Rune-Marked lineage: Aether-Tainted.
    /// </summary>
    public static LineageTrait AetherTainted => Create(
        traitId: "aether_tainted",
        traitName: "[Aether-Tainted]",
        description: "Your Maximum Aether Pool is increased by 10%.",
        effectType: LineageTraitEffectType.PassiveAuraBonus,
        triggerCondition: "max_ap_calculation",
        percentModifier: 0.10f);

    /// <summary>
    /// Default trait for Iron-Blooded lineage: Hazard Acclimation.
    /// </summary>
    public static LineageTrait HazardAcclimation => Create(
        traitId: "hazard_acclimation",
        traitName: "[Hazard Acclimation]",
        description: "Gain +1d10 to Sturdiness Resolve checks versus environmental hazards.",
        effectType: LineageTraitEffectType.BonusDiceToResolve,
        triggerCondition: "sturdiness_resolve_check",
        bonusDice: 1,
        targetCheck: "sturdiness",
        targetCondition: "source.type == environmental_hazard");

    /// <summary>
    /// Default trait for Vargr-Kin lineage: Primal Clarity.
    /// </summary>
    public static LineageTrait PrimalClarity => Create(
        traitId: "primal_clarity",
        traitName: "[Primal Clarity]",
        description: "Take 10% less Psychic Stress from all sources.",
        effectType: LineageTraitEffectType.PercentageModifier,
        triggerCondition: "psychic_stress_gain",
        percentModifier: -0.10f);

    /// <inheritdoc />
    public override string ToString() =>
        $"{TraitName}: {Description}";
}
```

### 5.3 Trait Reference Table

| Lineage      | Trait ID             | Trait Name           | Effect Type        | Effect                      |
| ------------ | -------------------- | -------------------- | ------------------ | --------------------------- |
| Clan-Born    | `survivors_resolve`  | [Survivor's Resolve] | BonusDiceToSkill   | +1d10 Rhetoric vs Clan-Born |
| Rune-Marked  | `aether_tainted`     | [Aether-Tainted]     | PassiveAuraBonus   | +10% Max AP                 |
| Iron-Blooded | `hazard_acclimation` | [Hazard Acclimation] | BonusDiceToResolve | +1d10 Sturdiness vs hazards |
| Vargr-Kin    | `primal_clarity`     | [Primal Clarity]     | PercentageModifier | -10% Psychic Stress         |

---

## 6. LineageDefinition Extension

### 6.1 Purpose

This section documents the extension of `LineageDefinition` to include the `UniqueTrait` property.

### 6.2 Updated Implementation

**File:** `src/Core/RuneAndRust.Domain/Entities/LineageDefinition.cs`

```csharp
// Add to existing LineageDefinition entity:

/// <summary>
/// Gets the unique trait granted by this lineage.
/// </summary>
/// <remarks>
/// Each lineage has exactly one unique trait that provides a signature
/// ability. Traits are conditional, activating under specific circumstances
/// unlike passive bonuses which are always active.
/// </remarks>
public LineageTrait UniqueTrait { get; private set; }

// Update the Create factory method signature:
public static LineageDefinition Create(
    Lineage lineageId,
    string displayName,
    string description,
    string selectionText,
    LineageAttributeModifiers attributeModifiers,
    LineagePassiveBonuses passiveBonuses,
    LineageTrait uniqueTrait,  // ← NEW PARAMETER
    string appearanceNotes,
    string socialRole)
{
    // ... existing validation ...

    return new LineageDefinition
    {
        Id = Guid.NewGuid(),
        LineageId = lineageId,
        DisplayName = displayName,
        Description = description,
        SelectionText = selectionText,
        AttributeModifiers = attributeModifiers,
        PassiveBonuses = passiveBonuses,
        UniqueTrait = uniqueTrait,  // ← NEW ASSIGNMENT
        AppearanceNotes = appearanceNotes,
        SocialRole = socialRole
    };
}

// Add helper methods:

/// <summary>
/// Gets the display name of the unique trait.
/// </summary>
/// <returns>The trait name with brackets.</returns>
public string GetTraitName() => UniqueTrait.TraitName;

/// <summary>
/// Gets the description of the unique trait.
/// </summary>
/// <returns>The trait description.</returns>
public string GetTraitDescription() => UniqueTrait.Description;

/// <summary>
/// Gets whether the trait uses bonus dice.
/// </summary>
/// <returns>True if the trait adds dice to checks.</returns>
public bool HasBonusDiceTrait() => UniqueTrait.UsesBonusDice;

/// <summary>
/// Gets whether the trait uses percentage modification.
/// </summary>
/// <returns>True if the trait scales values by percentage.</returns>
public bool HasPercentModifierTrait() => UniqueTrait.UsesPercentModifier;
```

---

## 7. Data Model Changes

### 7.1 New Types Summary

| Type                     | Layer  | Category     | Description                          |
| ------------------------ | ------ | ------------ | ------------------------------------ |
| `LineageTraitEffectType` | Domain | Enum         | Four trait effect classifications    |
| `LineageTrait`           | Domain | Value Object | Complete trait data and effect props |

### 7.2 Updated Types Summary

| Type                | Layer  | Category | Changes                      |
| ------------------- | ------ | -------- | ---------------------------- |
| `LineageDefinition` | Domain | Entity   | Added `UniqueTrait` property |

### 7.3 File Locations

```
src/Core/RuneAndRust.Domain/
├── Enums/
│   └── LineageTraitEffectType.cs    ← NEW
├── Entities/
│   └── LineageDefinition.cs         ← UPDATED (add UniqueTrait)
└── ValueObjects/
    └── LineageTrait.cs              ← NEW

config/
└── lineages.json                    ← UPDATED (add uniqueTrait section)
```

---

## 8. Configuration File Schema Updates

### 8.1 lineages.json (Extended - Trait Section)

**File:** `config/lineages.json` (trait additions only)

```json
{
    "lineages": [
        {
            "lineageId": "ClanBorn",
            "uniqueTrait": {
                "traitId": "survivors_resolve",
                "traitName": "[Survivor's Resolve]",
                "description": "Gain +1d10 to Rhetoric checks when interacting with Clan-Born NPCs.",
                "effectType": "BonusDiceToSkill",
                "triggerCondition": "rhetoric_check_initiated",
                "bonusDice": 1,
                "targetCheck": "rhetoric",
                "targetCondition": "npc.lineage == ClanBorn"
            }
        },
        {
            "lineageId": "RuneMarked",
            "uniqueTrait": {
                "traitId": "aether_tainted",
                "traitName": "[Aether-Tainted]",
                "description": "Your Maximum Aether Pool is increased by 10%.",
                "effectType": "PassiveAuraBonus",
                "triggerCondition": "max_ap_calculation",
                "percentModifier": 0.1
            }
        },
        {
            "lineageId": "IronBlooded",
            "uniqueTrait": {
                "traitId": "hazard_acclimation",
                "traitName": "[Hazard Acclimation]",
                "description": "Gain +1d10 to Sturdiness Resolve checks versus environmental hazards.",
                "effectType": "BonusDiceToResolve",
                "triggerCondition": "sturdiness_resolve_check",
                "bonusDice": 1,
                "targetCheck": "sturdiness",
                "targetCondition": "source.type == environmental_hazard"
            }
        },
        {
            "lineageId": "VargrKin",
            "uniqueTrait": {
                "traitId": "primal_clarity",
                "traitName": "[Primal Clarity]",
                "description": "Take 10% less Psychic Stress from all sources.",
                "effectType": "PercentageModifier",
                "triggerCondition": "psychic_stress_gain",
                "percentModifier": -0.1
            }
        }
    ]
}
```

### 8.2 lineages.schema.json (Extended)

**File:** `config/schemas/lineages.schema.json` (additions to `$defs`)

```json
{
    "$defs": {
        "lineageDefinition": {
            "required": [
                "lineageId",
                "displayName",
                "attributeModifiers",
                "passiveBonuses",
                "uniqueTrait"
            ],
            "properties": {
                "uniqueTrait": {
                    "$ref": "#/$defs/lineageTrait"
                }
            }
        },
        "lineageTrait": {
            "type": "object",
            "description": "Unique trait for this lineage",
            "required": ["traitId", "traitName", "description", "effectType"],
            "properties": {
                "traitId": {
                    "type": "string",
                    "description": "Unique identifier (snake_case)",
                    "pattern": "^[a-z][a-z0-9_]*$"
                },
                "traitName": {
                    "type": "string",
                    "description": "Display name with brackets",
                    "pattern": "^\\[.+\\]$"
                },
                "description": {
                    "type": "string",
                    "description": "Player-facing effect description",
                    "minLength": 10,
                    "maxLength": 300
                },
                "effectType": {
                    "type": "string",
                    "description": "Type of effect applied",
                    "enum": [
                        "BonusDiceToSkill",
                        "PercentageModifier",
                        "BonusDiceToResolve",
                        "PassiveAuraBonus"
                    ]
                },
                "triggerCondition": {
                    "type": "string",
                    "description": "Condition when trait activates"
                },
                "bonusDice": {
                    "type": "integer",
                    "description": "Bonus dice to add (for dice effects)",
                    "minimum": 1,
                    "maximum": 5
                },
                "percentModifier": {
                    "type": "number",
                    "description": "Percentage modifier (-1.0 to 1.0)",
                    "minimum": -1.0,
                    "maximum": 1.0
                },
                "targetCheck": {
                    "type": "string",
                    "description": "Skill or resolve check type"
                },
                "targetCondition": {
                    "type": "string",
                    "description": "Condition for valid targets"
                }
            },
            "additionalProperties": false
        }
    }
}
```

---

## 9. Logging Specifications

### 9.1 Log Levels by Component

| Component                | Level       | Events                                     |
| ------------------------ | ----------- | ------------------------------------------ |
| `LineageTrait`           | Debug       | Trait created, effect type validated       |
| `TraitEvaluationService` | Information | Trait activated, bonus applied             |
| `TraitEvaluationService` | Debug       | Condition checked, target evaluated        |
| `LineageProvider`        | Information | Trait configuration loaded                 |
| `LineageProvider`        | Warning     | Invalid trait configuration, defaults used |

### 9.2 Structured Logging Templates

```csharp
// Information - Trait activated
_logger.LogInformation(
    "Lineage trait activated. TraitId={TraitId}, Character={CharId}, EffectType={Effect}, BonusDice={Dice}",
    trait.TraitId,
    characterId,
    trait.EffectType,
    trait.EffectiveBonusDice);

// Debug - Condition evaluation
_logger.LogDebug(
    "Evaluating trait condition. TraitId={TraitId}, Condition={Condition}, Result={Result}",
    trait.TraitId,
    trait.TriggerCondition,
    conditionMet);

// Debug - Percentage modification applied
_logger.LogDebug(
    "Percentage modifier applied. TraitId={TraitId}, BaseValue={Base}, Modifier={Mod}, Result={Result}",
    trait.TraitId,
    baseValue,
    trait.EffectivePercentModifier,
    result);
```

---

## 10. Unit Testing Requirements

### 10.1 Test Count by Feature

| Feature                     | Test Count |
| --------------------------- | ---------- |
| LineageTraitEffectType      | ~2         |
| LineageTrait                | ~4         |
| LineageDefinition (updated) | ~2         |
| **Total**                   | **~8**     |

### 10.2 Test Specifications

#### LineageTraitEffectTypeTests.cs

**File:** `tests/RuneAndRust.Domain.UnitTests/Enums/LineageTraitEffectTypeTests.cs`

```csharp
[TestFixture]
public class LineageTraitEffectTypeTests
{
    [Test]
    public void LineageTraitEffectType_HasFourValues_CountEquals4();

    [Test]
    public void LineageTraitEffectType_AllValuesHaveExpectedIntegers();
}
```

#### LineageTraitTests.cs

**File:** `tests/RuneAndRust.Domain.UnitTests/ValueObjects/LineageTraitTests.cs`

```csharp
[TestFixture]
public class LineageTraitTests
{
    [Test]
    public void Create_WithValidBonusDiceEffect_CreatesTrait();

    [Test]
    public void Create_WithValidPercentageEffect_CreatesTrait();

    [Test]
    public void Create_BonusDiceEffectWithoutDice_ThrowsArgumentException();

    [Test]
    public void Create_PercentageEffectWithoutModifier_ThrowsArgumentException();

    [Test]
    public void SurvivorsResolve_HasCorrectProperties();

    [Test]
    public void AetherTainted_HasCorrectProperties();

    [Test]
    public void HazardAcclimation_HasCorrectProperties();

    [Test]
    public void PrimalClarity_HasCorrectProperties();

    [Test]
    public void UsesBonusDice_ForBonusDiceEffect_ReturnsTrue();

    [Test]
    public void UsesBonusDice_ForPercentageEffect_ReturnsFalse();

    [Test]
    public void UsesPercentModifier_ForPercentageEffect_ReturnsTrue();

    [Test]
    public void HasTargetCondition_WhenConditionSet_ReturnsTrue();
}
```

---

## 11. Use Cases

### UC-001: Display Lineage Trait During Creation

**Actor:** Character Creation UI  
**Flow:** Request lineage definition → Get unique trait → Display name and description → Show effect summary

### UC-002: Evaluate Skill Check Trait

**Actor:** Skill Check Service  
**Flow:** Initiate skill check → Get character trait → Check trigger condition → Check target condition → Apply bonus dice if conditions met

### UC-003: Apply Passive Aura Trait

**Actor:** Derived Stat Calculator  
**Flow:** Calculate Max AP → Get lineage trait → Check if PassiveAuraBonus type → Apply percentage modifier to total

### UC-004: Reduce Stress with Trait

**Actor:** Trauma Service  
**Flow:** Character gains Psychic Stress → Get lineage trait → Check if PercentageModifier for stress → Reduce stress by percentage

---

## 12. User Stories

### US-001: View Trait During Selection

**As a** player creating a new character  
**I want to** see each lineage's unique trait clearly displayed  
**So that** I understand the signature ability of each bloodline

**Acceptance Criteria:**

- Trait name shown in brackets (e.g., "[Survivor's Resolve]")
- Description explains the effect clearly
- Effect type indicated (dice bonus vs percentage)

### US-002: See Trait Activate During Gameplay

**As a** player using my lineage advantage  
**I want to** see when my trait activates and what bonus it provides  
**So that** I understand the mechanical benefit

**Acceptance Criteria:**

- Message displayed when trait activates
- Bonus clearly shown (e.g., "+1d10 from [Survivor's Resolve]")
- Condition that triggered activation noted

### US-003: Understand Trait Requirements

**As a** player choosing a lineage  
**I want to** understand when each trait applies  
**So that** I can choose a trait that matches my playstyle

**Acceptance Criteria:**

- Trigger conditions explained in plain language
- Target requirements (if any) clearly stated
- Examples of when trait would activate

---

## 13. Deliverable Checklist

### Domain Layer

- [ ] `LineageTraitEffectType.cs` enum created in `Enums/`
- [ ] `LineageTrait.cs` value object created in `ValueObjects/`
- [ ] `LineageDefinition.cs` updated with `UniqueTrait` property
- [ ] All types have complete XML documentation

### Configuration Files

- [ ] `config/lineages.json` updated with uniqueTrait for all 4 lineages
- [ ] `config/schemas/lineages.schema.json` updated with trait schema
- [ ] Configuration validates against updated schema

### Testing

- [ ] `LineageTraitEffectTypeTests.cs` created
- [ ] `LineageTraitTests.cs` created
- [ ] ~8 unit tests passing

### Documentation

- [ ] `v0.17.0c-changelog.md` created
- [ ] Inline code comments complete

---

## 14. Acceptance Criteria

### Functional

- [ ] `LineageTraitEffectType` enum defines exactly 4 effect types
- [ ] `LineageTrait.Create()` validates effect type has required properties
- [ ] BonusDice effects require positive BonusDice value
- [ ] Percentage effects require PercentModifier value
- [ ] Survivor's Resolve has BonusDiceToSkill with +1 die
- [ ] Aether-Tainted has PassiveAuraBonus with +10% modifier
- [ ] Hazard Acclimation has BonusDiceToResolve with +1 die
- [ ] Primal Clarity has PercentageModifier with -10% modifier
- [ ] `LineageDefinition.UniqueTrait` property accessible
- [ ] Static trait properties return correct values

### Quality

- [ ] Build succeeds with 0 errors
- [ ] Build succeeds with 0 warnings
- [ ] ~8 unit tests pass
- [ ] Configuration validates against JSON schema
- [ ] All public types have XML documentation

---

## 15. Dependencies

### Required from v0.17.0a-b

| Type                        | Location                           | Usage                      |
| --------------------------- | ---------------------------------- | -------------------------- |
| `Lineage`                   | `RuneAndRust.Domain/Enums/`        | Referenced by definition   |
| `LineageDefinition`         | `RuneAndRust.Domain/Entities/`     | Extended with unique trait |
| `LineageAttributeModifiers` | `RuneAndRust.Domain/ValueObjects/` | Sibling data in definition |
| `LineagePassiveBonuses`     | `RuneAndRust.Domain/ValueObjects/` | Sibling data in definition |

### Provides to v0.17.0d

| Type                     | Usage                               |
| ------------------------ | ----------------------------------- |
| `LineageTrait`           | Component of LineageDefinition      |
| `LineageTraitEffectType` | Used for Trauma Economy integration |

### Provides to v0.17.0f

| Type                     | Usage                                |
| ------------------------ | ------------------------------------ |
| `LineageTrait`           | Registered with trait/effect systems |
| `LineageTraitEffectType` | Used for effect routing              |

### Provides to Future Systems

| Type                     | Usage                         |
| ------------------------ | ----------------------------- |
| `LineageTrait`           | Skill service, trauma service |
| `LineageTraitEffectType` | Effect evaluation engine      |

---

## 16. Future Considerations

### Deferred to v0.17.0d

- **LineageTraumaBaseline Value Object**: Starting Corruption/Stress
- Integration of Primal Clarity with actual Trauma Economy

### Deferred to v0.17.0e-f

- **ILineageProvider Interface**: Access pattern for lineage data
- **Trait registration with game systems**: Actual hookup to skill/trauma services

### Deferred to Future Combat/Skill Systems

- **Trait Evaluation Engine**: Runtime condition evaluation
- **Condition Expression Parser**: Full expression language for conditions
- **Trait Effect Application**: Actual dice pool modification

### Out of Scope

- **Multiple Traits Per Lineage**: Each lineage has exactly one unique trait
- **Trait Leveling/Upgrading**: Traits are fixed at their defined power
- **Trait Trading/Removal**: Lineage traits are permanent

---

_Document Version: 1.0_  
_Last Updated: 2026-01-27_  
_Author: AI Assistant_
