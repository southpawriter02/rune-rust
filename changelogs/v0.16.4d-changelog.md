# v0.16.4d Changelog — Container Loot Service

**Version:** 0.16.4d
**Date:** 2026-01-29
**Phase:** Container Loot Generation

---

## Summary

Implements the Container Loot Service which orchestrates loot generation for containers by integrating container type definitions, biome modifiers, and smart loot selection. Provides the `IContainerLootService` interface and `ContainerLootGenerator` implementation with lazy generation and content caching.

---

## Added

### Application Layer

- **`IContainerLootService`** interface — Contract for container loot generation:
    - Methods:
        - `GenerateContents(container, playerId, biomeId)` — Generates and caches contents
        - `GetContainerDefinition(containerType)` — Retrieves type definition
        - `GetBiomeModifiers(biomeId)` — Retrieves biome modifiers with fallback
        - `HasGeneratedContents(container)` — Checks if contents exist
    - Full XML documentation with examples and remarks

- **`ContainerLootGenerator`** service — Orchestrates loot generation:
    - Constructor dependencies:
        - `ISmartLootService` — For class-appropriate item selection
        - `ILogger<ContainerLootGenerator>` — Diagnostic logging
        - `IReadOnlyDictionary<ContainerType, ContainerTypeDefinition>` — Container definitions
        - `IReadOnlyDictionary<string, BiomeLootModifiers>` — Biome modifiers
        - `IReadOnlyDictionary<QualityTier, IReadOnlyList<LootEntry>>` — Available items
        - `Random?` — Optional for deterministic testing
    - Private methods:
        - `CalculateItemCount` — Applies drop rate modifier
        - `SelectTier` — Applies quality bonus
        - `CalculateCurrency` — Applies gold multiplier
        - `GenerateItems` — Uses smart loot selection

### Unit Tests

- **`ContainerLootGeneratorTests.cs`** — 10 tests covering:
    - `GenerateContents`: new containers, biome modifiers, looted containers, existing contents
    - `GetContainerDefinition`: valid type, unknown type exception
    - `GetBiomeModifiers`: known biome, unknown biome fallback
    - `HasGeneratedContents`: new container, after generation

---

## Design Decisions

| Decision                   | Rationale                                                |
| -------------------------- | -------------------------------------------------------- |
| Lazy generation            | Contents created only on first access, cached thereafter |
| Biome fallback to Default  | Graceful handling of unknown biomes                      |
| Injectable Random          | Enables deterministic unit testing                       |
| Smart loot with RandomOnly | Container loot uses variety, not class-appropriate bias  |
| Currency null check        | Handles containers without currency (weapon racks, etc.) |

---

## Dependencies

| Dependency | Description                               | Status      |
| ---------- | ----------------------------------------- | ----------- |
| v0.16.3    | `ISmartLootService` for selection         | ✅ Complete |
| v0.16.4a   | `ContainerTypeDefinition`                 | ✅ Complete |
| v0.16.4b   | `ContainerLootTable`, `ContainerContents` | ✅ Complete |
| v0.16.4c   | `BiomeLootModifiers`                      | ✅ Complete |

---

## Provides To

| Consumer | Description                                            |
| -------- | ------------------------------------------------------ |
| v0.16.4e | Room integration uses service for container population |
| v0.16.4f | Player interaction flow calls `GenerateContents`       |

---

## Verification

- **Build:** 0 errors, 0 warnings
- **Unit Tests:** 10/10 passed
- **Test Coverage:** GenerateContents, GetContainerDefinition, GetBiomeModifiers, HasGeneratedContents
