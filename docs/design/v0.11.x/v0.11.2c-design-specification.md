# v0.11.2c Design Specification: Quality System

**Version:** 0.11.2c
**Parent:** v0.11.2 (Crafting System)
**Prerequisites:** v0.11.2b Complete (Crafting Service)
**Status:** Design Complete

---

## Table of Contents

1. [Executive Summary](#1-executive-summary)
2. [Feature Overview](#2-feature-overview)
3. [Architecture Diagrams](#3-architecture-diagrams)
4. [CraftedItemQuality Enum](#4-crafteditemquality-enum)
5. [QualityModifier Value Object](#5-qualitymodifier-value-object)
6. [IQualityDeterminationService Interface](#6-iqualitydeterminationservice-interface)
7. [QualityDeterminationService Implementation](#7-qualitydeterminationservice-implementation)
8. [IQualityTierProvider Interface](#8-iqualitytierprovider-interface)
9. [QualityTierProvider Implementation](#9-qualitytierprovider-implementation)
10. [Item Factory Quality Integration](#10-item-factory-quality-integration)
11. [Configuration Schema](#11-configuration-schema)
12. [Configuration File](#12-configuration-file)
13. [Logging Specifications](#13-logging-specifications)
14. [Unit Testing Requirements](#14-unit-testing-requirements)
15. [Use Cases](#15-use-cases)
16. [Deliverable Checklist](#16-deliverable-checklist)
17. [Acceptance Criteria](#17-acceptance-criteria)
18. [Dependencies](#18-dependencies)
19. [Future Considerations](#19-future-considerations)

---

## 1. Executive Summary

### Overview

Version 0.11.2c implements the Quality System, which determines the quality tier of crafted items based on the roll margin above the difficulty class. Higher quality items have enhanced stats and increased value. Natural 20 rolls always produce legendary items with special effects such as magical glow. This system integrates with the Crafting Service from v0.11.2b to enhance the crafting experience with meaningful progression.

### Key Deliverables

| Category | Items |
|----------|-------|
| **Domain Enums** | CraftedItemQuality |
| **Value Objects** | QualityModifier, QualityTierDefinition |
| **Interfaces** | IQualityDeterminationService, IQualityTierProvider |
| **Services** | QualityDeterminationService, QualityTierProvider |
| **Factory Updates** | ItemFactory.CreateFromRecipe quality integration |
| **Configuration** | quality-tiers.json, quality-tiers.schema.json |
| **Tests** | ~8 new unit tests |

### Architectural Significance

This version establishes the **Quality Tier Pattern** that can be extended to other crafting-like systems:
- Configuration-driven quality thresholds
- Roll margin → quality mapping
- Multiplicative stat bonuses
- Special effects for exceptional quality
- Extensible tier definitions

---

## 2. Feature Overview

```
v0.11.2c Quality System Features
├── CraftedItemQuality Enum
│   ├── Standard (base quality)
│   ├── Fine (+10% stats)
│   ├── Masterwork (+25% stats)
│   └── Legendary (+50% stats, special effects)
├── QualityModifier Value Object
│   ├── Stat multiplier application
│   ├── Value multiplier application
│   ├── Name prefix formatting
│   └── Special effect tracking
├── Quality Determination Service
│   ├── Roll margin evaluation
│   ├── Natural 20 detection
│   ├── Tier lookup from config
│   └── Modifier creation
├── Quality Tier Provider
│   ├── JSON configuration loading
│   ├── Schema validation
│   ├── Tier retrieval by quality
│   └── Threshold lookup
├── Item Factory Integration
│   ├── Quality-enhanced item creation
│   ├── Stat modification
│   ├── Value modification
│   ├── Quality description text
│   └── Legendary glow effect
└── Configuration
    ├── quality-tiers.json
    └── quality-tiers.schema.json
```

---

## 3. Architecture Diagrams

### 3.1 Quality System Architecture

```
┌─────────────────────────────────────────────────────────────────────┐
│                     QUALITY SYSTEM ARCHITECTURE                      │
└─────────────────────────────────────────────────────────────────────┘

                         APPLICATION LAYER
                         ─────────────────

    ┌───────────────────────────────┐     ┌───────────────────────────────┐
    │ IQualityDeterminationService   │     │     IQualityTierProvider       │
    ├───────────────────────────────┤     ├───────────────────────────────┤
    │ + DetermineQuality(roll, mrg) │     │ + GetTiers()                   │
    │ + CreateModifier(quality)     │     │ + GetTierByQuality(quality)    │
    │ + IsNatural20Legendary(roll)  │     │ + GetThresholds()              │
    └───────────────┬───────────────┘     └───────────────┬───────────────┘
                    │                                     │
    ┌───────────────┴───────────────┐     ┌───────────────┴───────────────┐
    │  QualityDeterminationService   │     │      QualityTierProvider       │
    ├───────────────────────────────┤     ├───────────────────────────────┤
    │ Dependencies:                  │     │ Dependencies:                  │
    │ - IQualityTierProvider         │     │ - IConfigurationLoader         │
    │ - ILogger                      │     │ - ILogger                      │
    │                                │     │                                │
    │ Methods:                       │     │ Methods:                       │
    │ + DetermineQuality()           │     │ + LoadConfiguration()          │
    │ + CreateModifier()             │     │ + ValidateTiers()              │
    │ + EvaluateMargin()             │     │ + GetTiers()                   │
    │ + CheckNatural20()             │     │ + GetTierByQuality()           │
    └───────────────────────────────┘     └───────────────────────────────┘


                           DOMAIN LAYER
                           ────────────

    ┌─────────────────────────────────────────────────────────────────────┐
    │                        CraftedItemQuality                            │
    ├─────────────────────────────────────────────────────────────────────┤
    │ Standard    │ Fine         │ Masterwork     │ Legendary              │
    │ (1.0x)      │ (1.10x)      │ (1.25x)        │ (1.50x + effects)      │
    └─────────────────────────────────────────────────────────────────────┘

    ┌─────────────────────────────┐     ┌─────────────────────────────────┐
    │      QualityModifier         │     │     QualityTierDefinition        │
    ├─────────────────────────────┤     ├─────────────────────────────────┤
    │ + Quality: CraftedItemQuality│     │ + Quality: CraftedItemQuality    │
    │ + StatMultiplier: float      │     │ + MinMargin: int                 │
    │ + ValueMultiplier: float     │     │ + StatMultiplier: float          │
    │ + HasGlowEffect: bool        │     │ + ValueMultiplier: float         │
    │ + NamePrefix: string         │     │ + NamePrefix: string             │
    │                              │     │ + Description: string            │
    │ + ApplyToStat(int)           │     │ + HasGlowEffect: bool            │
    │ + ApplyToValue(int)          │     │ + RequiresNatural20: bool        │
    │ + FormatName(string)         │     └─────────────────────────────────┘
    └─────────────────────────────┘


                       INFRASTRUCTURE LAYER
                       ────────────────────

    ┌─────────────────────────────────────────────────────────────────────┐
    │                         Configuration                                │
    ├─────────────────────────────────────────────────────────────────────┤
    │ config/quality-tiers.json                                           │
    │ config/schemas/quality-tiers.schema.json                            │
    └─────────────────────────────────────────────────────────────────────┘
```

### 3.2 Quality Determination Flow

```
┌─────────────────────────────────────────────────────────────────────┐
│                    QUALITY DETERMINATION FLOW                        │
└─────────────────────────────────────────────────────────────────────┘

    Craft Roll Result
    (roll=17, modifier=+3, total=20, DC=12)
           │
           ▼
┌─────────────────────────────────────────────────────────────────────┐
│                    STEP 1: CHECK NATURAL 20                          │
├─────────────────────────────────────────────────────────────────────┤
│  Is roll == 20 (before modifiers)?                                  │
│                                                                      │
│  ┌─────────┐                      ┌─────────┐                        │
│  │   YES   │ ─────────────────▶   │LEGENDARY│                        │
│  └─────────┘                      └─────────┘                        │
│  ┌─────────┐                                                         │
│  │   NO    │ ─────────────────▶   Continue to margin check           │
│  └─────────┘                                                         │
└─────────────────────────────────────────────────────────────────────┘
           │
           ▼
┌─────────────────────────────────────────────────────────────────────┐
│                    STEP 2: CALCULATE MARGIN                          │
├─────────────────────────────────────────────────────────────────────┤
│  margin = total - DC                                                 │
│  margin = 20 - 12 = 8                                                │
└─────────────────────────────────────────────────────────────────────┘
           │
           ▼
┌─────────────────────────────────────────────────────────────────────┐
│                    STEP 3: EVALUATE THRESHOLDS                       │
├─────────────────────────────────────────────────────────────────────┤
│  Check tiers from highest to lowest margin requirement:              │
│                                                                      │
│  ┌────────────┬───────────┬─────────────────────────────────┐        │
│  │ Tier       │ MinMargin │ Check                           │        │
│  ├────────────┼───────────┼─────────────────────────────────┤        │
│  │ Masterwork │ 10        │ 8 >= 10? NO                     │        │
│  │ Fine       │ 5         │ 8 >= 5?  YES ◀── MATCH          │        │
│  │ Standard   │ 0         │ (skipped)                       │        │
│  └────────────┴───────────┴─────────────────────────────────┘        │
│                                                                      │
│  Result: Fine Quality                                                │
└─────────────────────────────────────────────────────────────────────┘
           │
           ▼
┌─────────────────────────────────────────────────────────────────────┐
│                    STEP 4: CREATE MODIFIER                           │
├─────────────────────────────────────────────────────────────────────┤
│  QualityModifier                                                     │
│  ├── Quality: Fine                                                   │
│  ├── StatMultiplier: 1.10                                            │
│  ├── ValueMultiplier: 1.5                                            │
│  ├── HasGlowEffect: false                                            │
│  └── NamePrefix: "Fine "                                             │
└─────────────────────────────────────────────────────────────────────┘
           │
           ▼
┌─────────────────────────────────────────────────────────────────────┐
│                    STEP 5: APPLY TO ITEM                             │
├─────────────────────────────────────────────────────────────────────┤
│  Base Iron Sword:                  Fine Iron Sword:                  │
│  ├── Name: "Iron Sword"            ├── Name: "Fine Iron Sword"       │
│  ├── Attack: +4                    ├── Attack: +5 (4 × 1.10)         │
│  ├── Damage: 2d6+2                 ├── Damage: 2d6+3 (2 × 1.10)      │
│  └── Value: 50g                    └── Value: 75g (50 × 1.5)         │
└─────────────────────────────────────────────────────────────────────┘
```

### 3.3 Quality Tier Thresholds

```
┌─────────────────────────────────────────────────────────────────────┐
│                      QUALITY TIER THRESHOLDS                         │
└─────────────────────────────────────────────────────────────────────┘

    MARGIN = Roll Total - Difficulty Class
    ─────────────────────────────────────

    Roll < DC - 5    ──────────────▶    ✗ FAILURE (lose 50% resources)
    (margin < -5)

    Roll < DC        ──────────────▶    ✗ FAILURE (lose 25% resources)
    (margin < 0)

    Roll >= DC       ──────────────▶    ✓ STANDARD (base stats)
    (margin >= 0)                           │
                                            ├── 1.0x stat multiplier
                                            ├── 1.0x value multiplier
                                            └── No special effects

    Roll >= DC + 5   ──────────────▶    ✓ FINE (+10% stats)
    (margin >= 5)                           │
                                            ├── 1.10x stat multiplier
                                            ├── 1.5x value multiplier
                                            └── No special effects

    Roll >= DC + 10  ──────────────▶    ✓ MASTERWORK (+25% stats)
    (margin >= 10)                          │
                                            ├── 1.25x stat multiplier
                                            ├── 2.5x value multiplier
                                            └── No special effects

    Roll = 20 (Nat)  ──────────────▶    ✓ LEGENDARY (+50%, special)
    (natural 20)                            │
                                            ├── 1.50x stat multiplier
                                            ├── 5.0x value multiplier
                                            └── Glow effect, unique name


    QUALITY BONUSES SUMMARY
    ───────────────────────

    ┌────────────┬───────────┬──────────────┬─────────────────────────┐
    │ Quality    │ Stat Mult │ Value Mult   │ Special                 │
    ├────────────┼───────────┼──────────────┼─────────────────────────┤
    │ Standard   │ 1.00x     │ 1.0x         │ None                    │
    │ Fine       │ 1.10x     │ 1.5x         │ None                    │
    │ Masterwork │ 1.25x     │ 2.5x         │ None                    │
    │ Legendary  │ 1.50x     │ 5.0x         │ Glow effect, unique name│
    └────────────┴───────────┴──────────────┴─────────────────────────┘
```

### 3.4 Clean Architecture Layer Diagram

```
┌─────────────────────────────────────────────────────────────────────┐
│                      CLEAN ARCHITECTURE LAYERS                       │
└─────────────────────────────────────────────────────────────────────┘

    ┌─────────────────────────────────────────────────────────────────┐
    │                      PRESENTATION LAYER                          │
    │                                                                  │
    │  (No direct changes - uses CraftingService from v0.11.2b)        │
    │  CraftCommand calls CraftingService which uses quality system    │
    └─────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
    ┌─────────────────────────────────────────────────────────────────┐
    │                      APPLICATION LAYER                           │
    │                                                                  │
    │  ┌─────────────────────────┐  ┌─────────────────────────────┐   │
    │  │IQualityDeterminationSvc │  │    IQualityTierProvider      │   │
    │  │  • DetermineQuality()   │  │    • GetTiers()              │   │
    │  │  • CreateModifier()     │  │    • GetTierByQuality()      │   │
    │  └─────────────────────────┘  └─────────────────────────────┘   │
    │                                                                  │
    │  ┌─────────────────────────┐  ┌─────────────────────────────┐   │
    │  │QualityDeterminationSvc  │  │    QualityTierProvider       │   │
    │  │  (implementation)       │  │    (implementation)          │   │
    │  └─────────────────────────┘  └─────────────────────────────┘   │
    └─────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
    ┌─────────────────────────────────────────────────────────────────┐
    │                        DOMAIN LAYER                              │
    │                                                                  │
    │  ┌─────────────────────────┐  ┌─────────────────────────────┐   │
    │  │   CraftedItemQuality    │  │     QualityModifier          │   │
    │  │   (enum)                │  │     (value object)           │   │
    │  └─────────────────────────┘  └─────────────────────────────┘   │
    │                                                                  │
    │  ┌─────────────────────────┐                                    │
    │  │  QualityTierDefinition  │                                    │
    │  │  (value object)         │                                    │
    │  └─────────────────────────┘                                    │
    └─────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
    ┌─────────────────────────────────────────────────────────────────┐
    │                    INFRASTRUCTURE LAYER                          │
    │                                                                  │
    │  ┌─────────────────────────────────────────────────────────┐    │
    │  │                  Configuration Files                     │    │
    │  │  config/quality-tiers.json                               │    │
    │  │  config/schemas/quality-tiers.schema.json                │    │
    │  └─────────────────────────────────────────────────────────┘    │
    └─────────────────────────────────────────────────────────────────┘
```

---

## 4. CraftedItemQuality Enum

### 4.1 Enum Definition

**File:** `src/Core/RuneAndRust.Domain/Enums/CraftedItemQuality.cs`

```csharp
namespace RuneAndRust.Domain.Enums;

/// <summary>
/// Defines quality tiers for crafted items.
/// </summary>
/// <remarks>
/// <para>Quality is determined by the roll margin above the difficulty class:</para>
/// <list type="bullet">
///   <item><description>Standard: margin >= 0 (base stats)</description></item>
///   <item><description>Fine: margin >= 5 (+10% stats)</description></item>
///   <item><description>Masterwork: margin >= 10 (+25% stats)</description></item>
///   <item><description>Legendary: natural 20 only (+50% stats, special effects)</description></item>
/// </list>
/// </remarks>
public enum CraftedItemQuality
{
    /// <summary>
    /// Standard quality item with base stats.
    /// Created when roll meets DC but margin is less than 5.
    /// </summary>
    Standard = 0,

    /// <summary>
    /// Fine quality item with +10% stats.
    /// Created when roll margin is 5 or more above DC.
    /// </summary>
    Fine = 1,

    /// <summary>
    /// Masterwork quality item with +25% stats.
    /// Created when roll margin is 10 or more above DC.
    /// </summary>
    Masterwork = 2,

    /// <summary>
    /// Legendary quality item with +50% stats and special effects.
    /// Created only on natural 20 rolls, regardless of DC.
    /// </summary>
    Legendary = 3
}
```

### 4.2 Extension Methods

**File:** `src/Core/RuneAndRust.Domain/Enums/CraftedItemQualityExtensions.cs`

```csharp
namespace RuneAndRust.Domain.Enums;

/// <summary>
/// Extension methods for <see cref="CraftedItemQuality"/> providing
/// stat multipliers, value multipliers, and formatting utilities.
/// </summary>
public static class CraftedItemQualityExtensions
{
    /// <summary>
    /// Gets the stat multiplier for this quality tier.
    /// </summary>
    /// <param name="quality">The quality tier.</param>
    /// <returns>The stat multiplier (1.0 to 1.5).</returns>
    public static float GetStatMultiplier(this CraftedItemQuality quality) => quality switch
    {
        CraftedItemQuality.Standard => 1.0f,
        CraftedItemQuality.Fine => 1.10f,
        CraftedItemQuality.Masterwork => 1.25f,
        CraftedItemQuality.Legendary => 1.50f,
        _ => 1.0f
    };

    /// <summary>
    /// Gets the value multiplier for this quality tier.
    /// </summary>
    /// <param name="quality">The quality tier.</param>
    /// <returns>The value multiplier (1.0 to 5.0).</returns>
    public static float GetValueMultiplier(this CraftedItemQuality quality) => quality switch
    {
        CraftedItemQuality.Standard => 1.0f,
        CraftedItemQuality.Fine => 1.5f,
        CraftedItemQuality.Masterwork => 2.5f,
        CraftedItemQuality.Legendary => 5.0f,
        _ => 1.0f
    };

    /// <summary>
    /// Gets the name prefix for this quality tier.
    /// </summary>
    /// <param name="quality">The quality tier.</param>
    /// <returns>The name prefix (empty string for Standard).</returns>
    public static string GetPrefix(this CraftedItemQuality quality) => quality switch
    {
        CraftedItemQuality.Standard => string.Empty,
        CraftedItemQuality.Fine => "Fine ",
        CraftedItemQuality.Masterwork => "Masterwork ",
        CraftedItemQuality.Legendary => "Legendary ",
        _ => string.Empty
    };

    /// <summary>
    /// Determines if this quality tier has special visual effects.
    /// </summary>
    /// <param name="quality">The quality tier.</param>
    /// <returns>True if the quality has special effects (Legendary only).</returns>
    public static bool HasSpecialEffect(this CraftedItemQuality quality)
        => quality == CraftedItemQuality.Legendary;

    /// <summary>
    /// Gets the display name for this quality tier.
    /// </summary>
    /// <param name="quality">The quality tier.</param>
    /// <returns>The human-readable display name.</returns>
    public static string GetDisplayName(this CraftedItemQuality quality) => quality switch
    {
        CraftedItemQuality.Standard => "Standard",
        CraftedItemQuality.Fine => "Fine",
        CraftedItemQuality.Masterwork => "Masterwork",
        CraftedItemQuality.Legendary => "Legendary",
        _ => "Unknown"
    };
}
```

---

## 5. QualityModifier Value Object

### 5.1 Value Object Definition

**File:** `src/Core/RuneAndRust.Domain/ValueObjects/QualityModifier.cs`

```csharp
namespace RuneAndRust.Domain.ValueObjects;

using RuneAndRust.Domain.Enums;

/// <summary>
/// Represents quality-based modifications applied to crafted items.
/// </summary>
/// <remarks>
/// <para>This value object encapsulates all quality-related modifiers:</para>
/// <list type="bullet">
///   <item><description>Stat multiplier for attack/defense/damage bonuses</description></item>
///   <item><description>Value multiplier for item worth</description></item>
///   <item><description>Name prefix for item naming</description></item>
///   <item><description>Special effects flag for legendary items</description></item>
/// </list>
/// </remarks>
public readonly record struct QualityModifier
{
    /// <summary>
    /// Gets the quality tier this modifier represents.
    /// </summary>
    public CraftedItemQuality Quality { get; }

    /// <summary>
    /// Gets the multiplier applied to item stats (attack, defense, damage bonuses).
    /// </summary>
    /// <remarks>
    /// Standard: 1.0, Fine: 1.10, Masterwork: 1.25, Legendary: 1.50
    /// </remarks>
    public float StatMultiplier { get; }

    /// <summary>
    /// Gets the multiplier applied to item base value.
    /// </summary>
    /// <remarks>
    /// Standard: 1.0, Fine: 1.5, Masterwork: 2.5, Legendary: 5.0
    /// </remarks>
    public float ValueMultiplier { get; }

    /// <summary>
    /// Gets a value indicating whether this quality has a glow effect.
    /// </summary>
    /// <remarks>
    /// Only Legendary items have special visual effects.
    /// </remarks>
    public bool HasGlowEffect { get; }

    /// <summary>
    /// Gets the name prefix for this quality (e.g., "Fine ", "Masterwork ").
    /// </summary>
    /// <remarks>
    /// Standard quality returns empty string.
    /// </remarks>
    public string NamePrefix { get; }

    /// <summary>
    /// Initializes a new instance of the <see cref="QualityModifier"/> struct.
    /// </summary>
    /// <param name="quality">The quality tier to create a modifier for.</param>
    public QualityModifier(CraftedItemQuality quality)
    {
        Quality = quality;
        StatMultiplier = quality.GetStatMultiplier();
        ValueMultiplier = quality.GetValueMultiplier();
        HasGlowEffect = quality.HasSpecialEffect();
        NamePrefix = quality.GetPrefix();
    }

    /// <summary>
    /// Applies the stat multiplier to a base stat value.
    /// </summary>
    /// <param name="baseStat">The base stat value to modify.</param>
    /// <returns>The modified stat value, rounded to nearest integer.</returns>
    /// <example>
    /// <code>
    /// var modifier = new QualityModifier(CraftedItemQuality.Fine);
    /// int enhancedAttack = modifier.ApplyToStat(4); // Returns 5 (4 * 1.10 = 4.4, rounded to 5)
    /// </code>
    /// </example>
    public int ApplyToStat(int baseStat)
    {
        return (int)Math.Round(baseStat * StatMultiplier, MidpointRounding.AwayFromZero);
    }

    /// <summary>
    /// Applies the value multiplier to a base item value.
    /// </summary>
    /// <param name="baseValue">The base value in gold.</param>
    /// <returns>The modified value, rounded to nearest integer.</returns>
    /// <example>
    /// <code>
    /// var modifier = new QualityModifier(CraftedItemQuality.Masterwork);
    /// int enhancedValue = modifier.ApplyToValue(50); // Returns 125 (50 * 2.5)
    /// </code>
    /// </example>
    public int ApplyToValue(int baseValue)
    {
        return (int)Math.Round(baseValue * ValueMultiplier, MidpointRounding.AwayFromZero);
    }

    /// <summary>
    /// Formats an item name with the quality prefix.
    /// </summary>
    /// <param name="baseName">The base item name.</param>
    /// <returns>The quality-prefixed name (e.g., "Fine Iron Sword").</returns>
    /// <example>
    /// <code>
    /// var modifier = new QualityModifier(CraftedItemQuality.Legendary);
    /// string name = modifier.FormatName("Iron Sword"); // Returns "Legendary Iron Sword"
    /// </code>
    /// </example>
    public string FormatName(string baseName)
    {
        return $"{NamePrefix}{baseName}";
    }

    /// <summary>
    /// Gets a display string describing this quality modifier.
    /// </summary>
    /// <returns>A formatted string for display purposes.</returns>
    public override string ToString()
    {
        return $"{Quality.GetDisplayName()} (x{StatMultiplier:F2} stats, x{ValueMultiplier:F1} value)";
    }
}
```

### 5.2 QualityTierDefinition Value Object

**File:** `src/Core/RuneAndRust.Domain/ValueObjects/QualityTierDefinition.cs`

```csharp
namespace RuneAndRust.Domain.ValueObjects;

using RuneAndRust.Domain.Enums;

/// <summary>
/// Represents a quality tier definition loaded from configuration.
/// </summary>
/// <remarks>
/// This value object is used by <see cref="IQualityTierProvider"/> to provide
/// configuration-driven quality tier thresholds and multipliers.
/// </remarks>
/// <param name="Quality">The quality tier this definition represents.</param>
/// <param name="MinMargin">Minimum roll margin required for this tier (margin = roll - DC).</param>
/// <param name="StatMultiplier">Multiplier applied to item stats.</param>
/// <param name="ValueMultiplier">Multiplier applied to item value.</param>
/// <param name="NamePrefix">Prefix added to item names.</param>
/// <param name="Description">Description text appended to item descriptions.</param>
/// <param name="HasGlowEffect">Whether this tier grants a glow visual effect.</param>
/// <param name="RequiresNatural20">Whether this tier requires a natural 20 roll.</param>
public readonly record struct QualityTierDefinition(
    CraftedItemQuality Quality,
    int MinMargin,
    float StatMultiplier,
    float ValueMultiplier,
    string NamePrefix,
    string Description,
    bool HasGlowEffect = false,
    bool RequiresNatural20 = false)
{
    /// <summary>
    /// Creates a <see cref="QualityModifier"/> from this tier definition.
    /// </summary>
    /// <returns>A new QualityModifier with this tier's properties.</returns>
    public QualityModifier ToModifier()
    {
        return new QualityModifier(Quality);
    }

    /// <summary>
    /// Determines if a given margin qualifies for this tier.
    /// </summary>
    /// <param name="margin">The roll margin (roll total - DC).</param>
    /// <param name="isNatural20">Whether the roll was a natural 20.</param>
    /// <returns>True if the margin qualifies for this tier.</returns>
    public bool QualifiesForTier(int margin, bool isNatural20)
    {
        if (RequiresNatural20)
        {
            return isNatural20;
        }

        return margin >= MinMargin;
    }
}
```

---

## 6. IQualityDeterminationService Interface

### 6.1 Interface Definition

**File:** `src/Core/RuneAndRust.Application/Interfaces/IQualityDeterminationService.cs`

```csharp
namespace RuneAndRust.Application.Interfaces;

using RuneAndRust.Domain.Enums;
using RuneAndRust.Domain.ValueObjects;

/// <summary>
/// Service interface for determining crafted item quality based on roll results.
/// </summary>
/// <remarks>
/// <para>The quality determination follows these rules:</para>
/// <list type="bullet">
///   <item><description>Natural 20 always produces Legendary quality</description></item>
///   <item><description>Margin >= 10 produces Masterwork quality</description></item>
///   <item><description>Margin >= 5 produces Fine quality</description></item>
///   <item><description>Margin >= 0 produces Standard quality</description></item>
/// </list>
/// <para>Where margin = (roll total) - (difficulty class)</para>
/// </remarks>
public interface IQualityDeterminationService
{
    /// <summary>
    /// Determines the quality tier based on roll result and margin.
    /// </summary>
    /// <param name="roll">The natural d20 roll (1-20, before modifiers).</param>
    /// <param name="margin">The margin above DC (total roll - DC).</param>
    /// <returns>The determined quality tier.</returns>
    /// <example>
    /// <code>
    /// // Natural 20 always produces Legendary
    /// var quality = service.DetermineQuality(20, 15); // Legendary
    ///
    /// // Margin of 8 produces Fine
    /// var quality = service.DetermineQuality(17, 8);  // Fine
    ///
    /// // Margin of 12 produces Masterwork
    /// var quality = service.DetermineQuality(15, 12); // Masterwork
    /// </code>
    /// </example>
    CraftedItemQuality DetermineQuality(int roll, int margin);

    /// <summary>
    /// Creates a quality modifier for applying to crafted items.
    /// </summary>
    /// <param name="quality">The quality tier to create a modifier for.</param>
    /// <returns>A <see cref="QualityModifier"/> with the appropriate multipliers.</returns>
    QualityModifier CreateModifier(CraftedItemQuality quality);

    /// <summary>
    /// Checks if a roll qualifies as a natural 20 for legendary quality.
    /// </summary>
    /// <param name="roll">The natural d20 roll (before modifiers).</param>
    /// <returns>True if the roll is a natural 20.</returns>
    bool IsNatural20Legendary(int roll);

    /// <summary>
    /// Gets the quality tier definition for a specific quality.
    /// </summary>
    /// <param name="quality">The quality tier to get the definition for.</param>
    /// <returns>The tier definition, or null if not found.</returns>
    QualityTierDefinition? GetTierDefinition(CraftedItemQuality quality);
}
```

---

## 7. QualityDeterminationService Implementation

### 7.1 Service Implementation

**File:** `src/Core/RuneAndRust.Application/Services/QualityDeterminationService.cs`

```csharp
namespace RuneAndRust.Application.Services;

using Microsoft.Extensions.Logging;
using RuneAndRust.Application.Interfaces;
using RuneAndRust.Domain.Enums;
using RuneAndRust.Domain.ValueObjects;

/// <summary>
/// Service that determines crafted item quality based on roll results.
/// </summary>
/// <remarks>
/// <para>Quality determination follows these rules:</para>
/// <list type="bullet">
///   <item><description>Natural 20 always produces Legendary quality, regardless of DC</description></item>
///   <item><description>Otherwise, margin (roll total - DC) determines quality tier</description></item>
/// </list>
/// <para>Quality thresholds are loaded from configuration via <see cref="IQualityTierProvider"/>.</para>
/// </remarks>
public class QualityDeterminationService : IQualityDeterminationService
{
    private readonly IQualityTierProvider _tierProvider;
    private readonly ILogger<QualityDeterminationService> _logger;

    /// <summary>
    /// Initializes a new instance of the <see cref="QualityDeterminationService"/> class.
    /// </summary>
    /// <param name="tierProvider">Provider for quality tier configurations.</param>
    /// <param name="logger">Logger instance for diagnostics.</param>
    public QualityDeterminationService(
        IQualityTierProvider tierProvider,
        ILogger<QualityDeterminationService> logger)
    {
        _tierProvider = tierProvider ?? throw new ArgumentNullException(nameof(tierProvider));
        _logger = logger ?? throw new ArgumentNullException(nameof(logger));
    }

    /// <inheritdoc />
    public CraftedItemQuality DetermineQuality(int roll, int margin)
    {
        _logger.LogDebug(
            "Determining quality for roll {Roll} with margin {Margin}",
            roll,
            margin);

        // Natural 20 always produces Legendary
        if (IsNatural20Legendary(roll))
        {
            _logger.LogInformation(
                "Natural 20 rolled! Creating Legendary quality item");
            return CraftedItemQuality.Legendary;
        }

        // Get tiers ordered by minimum margin (highest first)
        var tiers = _tierProvider.GetTiers()
            .Where(t => !t.RequiresNatural20)
            .OrderByDescending(t => t.MinMargin);

        // Find the highest tier that the margin qualifies for
        foreach (var tier in tiers)
        {
            if (margin >= tier.MinMargin)
            {
                _logger.LogDebug(
                    "Margin {Margin} qualifies for {Quality} (min margin: {MinMargin})",
                    margin,
                    tier.Quality,
                    tier.MinMargin);
                return tier.Quality;
            }
        }

        // Default to Standard if no tier matched (shouldn't happen with proper config)
        _logger.LogDebug(
            "No tier matched for margin {Margin}, defaulting to Standard",
            margin);
        return CraftedItemQuality.Standard;
    }

    /// <inheritdoc />
    public QualityModifier CreateModifier(CraftedItemQuality quality)
    {
        _logger.LogDebug("Creating modifier for quality {Quality}", quality);
        return new QualityModifier(quality);
    }

    /// <inheritdoc />
    public bool IsNatural20Legendary(int roll)
    {
        return roll == 20;
    }

    /// <inheritdoc />
    public QualityTierDefinition? GetTierDefinition(CraftedItemQuality quality)
    {
        return _tierProvider.GetTierByQuality(quality);
    }
}
```

---

## 8. IQualityTierProvider Interface

### 8.1 Interface Definition

**File:** `src/Core/RuneAndRust.Application/Interfaces/IQualityTierProvider.cs`

```csharp
namespace RuneAndRust.Application.Interfaces;

using RuneAndRust.Domain.Enums;
using RuneAndRust.Domain.ValueObjects;

/// <summary>
/// Provider interface for loading quality tier configurations.
/// </summary>
/// <remarks>
/// Implementations load quality tier definitions from configuration files
/// (e.g., quality-tiers.json) and provide access to tier thresholds and multipliers.
/// </remarks>
public interface IQualityTierProvider
{
    /// <summary>
    /// Gets all configured quality tier definitions.
    /// </summary>
    /// <returns>A collection of all quality tier definitions.</returns>
    IReadOnlyCollection<QualityTierDefinition> GetTiers();

    /// <summary>
    /// Gets a specific quality tier definition by quality enum.
    /// </summary>
    /// <param name="quality">The quality tier to retrieve.</param>
    /// <returns>The tier definition, or null if not found.</returns>
    QualityTierDefinition? GetTierByQuality(CraftedItemQuality quality);

    /// <summary>
    /// Gets the minimum margin thresholds for each quality tier.
    /// </summary>
    /// <returns>A dictionary mapping quality tiers to their minimum margins.</returns>
    IReadOnlyDictionary<CraftedItemQuality, int> GetThresholds();

    /// <summary>
    /// Validates that all required quality tiers are configured.
    /// </summary>
    /// <returns>True if all tiers are properly configured.</returns>
    bool ValidateConfiguration();
}
```

---

## 9. QualityTierProvider Implementation

### 9.1 Provider Implementation

**File:** `src/Infrastructure/RuneAndRust.Infrastructure/Providers/QualityTierProvider.cs`

```csharp
namespace RuneAndRust.Infrastructure.Providers;

using System.Text.Json;
using Microsoft.Extensions.Logging;
using RuneAndRust.Application.Interfaces;
using RuneAndRust.Domain.Enums;
using RuneAndRust.Domain.ValueObjects;

/// <summary>
/// Provider that loads quality tier configurations from JSON files.
/// </summary>
/// <remarks>
/// <para>Loads configuration from <c>config/quality-tiers.json</c>.</para>
/// <para>The provider caches tier definitions after first load for performance.</para>
/// </remarks>
public class QualityTierProvider : IQualityTierProvider
{
    private readonly ILogger<QualityTierProvider> _logger;
    private readonly string _configPath;
    private readonly Lazy<IReadOnlyList<QualityTierDefinition>> _tiers;

    /// <summary>
    /// Initializes a new instance of the <see cref="QualityTierProvider"/> class.
    /// </summary>
    /// <param name="configPath">Path to the quality-tiers.json configuration file.</param>
    /// <param name="logger">Logger instance for diagnostics.</param>
    public QualityTierProvider(
        string configPath,
        ILogger<QualityTierProvider> logger)
    {
        _configPath = configPath ?? throw new ArgumentNullException(nameof(configPath));
        _logger = logger ?? throw new ArgumentNullException(nameof(logger));
        _tiers = new Lazy<IReadOnlyList<QualityTierDefinition>>(LoadTiers);
    }

    /// <inheritdoc />
    public IReadOnlyCollection<QualityTierDefinition> GetTiers()
    {
        return _tiers.Value;
    }

    /// <inheritdoc />
    public QualityTierDefinition? GetTierByQuality(CraftedItemQuality quality)
    {
        var tier = _tiers.Value.FirstOrDefault(t => t.Quality == quality);
        return tier.Quality == quality ? tier : null;
    }

    /// <inheritdoc />
    public IReadOnlyDictionary<CraftedItemQuality, int> GetThresholds()
    {
        return _tiers.Value.ToDictionary(t => t.Quality, t => t.MinMargin);
    }

    /// <inheritdoc />
    public bool ValidateConfiguration()
    {
        var requiredQualities = Enum.GetValues<CraftedItemQuality>();
        var configuredQualities = _tiers.Value.Select(t => t.Quality).ToHashSet();

        foreach (var required in requiredQualities)
        {
            if (!configuredQualities.Contains(required))
            {
                _logger.LogError(
                    "Quality tier {Quality} is not configured in quality-tiers.json",
                    required);
                return false;
            }
        }

        _logger.LogDebug("Quality tier configuration validated successfully");
        return true;
    }

    /// <summary>
    /// Loads quality tier definitions from the configuration file.
    /// </summary>
    /// <returns>A list of quality tier definitions.</returns>
    private IReadOnlyList<QualityTierDefinition> LoadTiers()
    {
        _logger.LogDebug("Loading quality tiers from {Path}", _configPath);

        if (!File.Exists(_configPath))
        {
            _logger.LogWarning(
                "Quality tiers configuration not found at {Path}, using defaults",
                _configPath);
            return GetDefaultTiers();
        }

        try
        {
            var json = File.ReadAllText(_configPath);
            var config = JsonSerializer.Deserialize<QualityTiersConfig>(
                json,
                new JsonSerializerOptions { PropertyNameCaseInsensitive = true });

            if (config?.QualityTiers == null || config.QualityTiers.Count == 0)
            {
                _logger.LogWarning("No quality tiers found in config, using defaults");
                return GetDefaultTiers();
            }

            var tiers = config.QualityTiers
                .Select(MapToDefinition)
                .ToList();

            _logger.LogInformation(
                "Loaded {Count} quality tier definitions",
                tiers.Count);

            return tiers;
        }
        catch (JsonException ex)
        {
            _logger.LogError(ex, "Failed to parse quality tiers configuration");
            return GetDefaultTiers();
        }
    }

    /// <summary>
    /// Maps a configuration entry to a tier definition.
    /// </summary>
    private static QualityTierDefinition MapToDefinition(QualityTierEntry entry)
    {
        var quality = Enum.Parse<CraftedItemQuality>(entry.Quality, ignoreCase: true);

        return new QualityTierDefinition(
            Quality: quality,
            MinMargin: entry.MinMargin,
            StatMultiplier: entry.StatMultiplier,
            ValueMultiplier: entry.ValueMultiplier,
            NamePrefix: entry.NamePrefix,
            Description: entry.Description,
            HasGlowEffect: entry.HasGlowEffect,
            RequiresNatural20: entry.RequiresNatural20);
    }

    /// <summary>
    /// Gets the default quality tier definitions if configuration is missing.
    /// </summary>
    private static IReadOnlyList<QualityTierDefinition> GetDefaultTiers()
    {
        return new List<QualityTierDefinition>
        {
            new(CraftedItemQuality.Standard, 0, 1.0f, 1.0f, "", "A standard quality item."),
            new(CraftedItemQuality.Fine, 5, 1.10f, 1.5f, "Fine ", "A finely crafted item."),
            new(CraftedItemQuality.Masterwork, 10, 1.25f, 2.5f, "Masterwork ", "A masterwork item."),
            new(CraftedItemQuality.Legendary, 999, 1.50f, 5.0f, "Legendary ", "A legendary item.", true, true)
        };
    }

    /// <summary>
    /// Configuration model for JSON deserialization.
    /// </summary>
    private sealed class QualityTiersConfig
    {
        public List<QualityTierEntry> QualityTiers { get; set; } = new();
    }

    /// <summary>
    /// Configuration entry model for a single tier.
    /// </summary>
    private sealed class QualityTierEntry
    {
        public string Quality { get; set; } = string.Empty;
        public int MinMargin { get; set; }
        public float StatMultiplier { get; set; }
        public float ValueMultiplier { get; set; }
        public string NamePrefix { get; set; } = string.Empty;
        public string Description { get; set; } = string.Empty;
        public bool HasGlowEffect { get; set; }
        public bool RequiresNatural20 { get; set; }
    }
}
```

---

## 10. Item Factory Quality Integration

### 10.1 CreateFromRecipe Method

**File:** `src/Core/RuneAndRust.Application/Factories/ItemFactory.cs` (Updated)

```csharp
namespace RuneAndRust.Application.Factories;

using RuneAndRust.Application.Interfaces;
using RuneAndRust.Domain.Entities;
using RuneAndRust.Domain.Enums;
using RuneAndRust.Domain.ValueObjects;

/// <summary>
/// Factory for creating items, including quality-enhanced crafted items.
/// </summary>
public partial class ItemFactory : IItemFactory
{
    private readonly IItemProvider _itemProvider;

    /// <summary>
    /// Creates an item from a recipe with the specified quality.
    /// </summary>
    /// <param name="recipe">The recipe definition to create an item from.</param>
    /// <param name="quality">The quality tier for the crafted item.</param>
    /// <returns>A new item instance with quality modifications applied.</returns>
    /// <exception cref="ArgumentException">Thrown when the recipe output item is not found.</exception>
    /// <remarks>
    /// <para>Quality modifications include:</para>
    /// <list type="bullet">
    ///   <item><description>Name prefixed with quality tier (e.g., "Fine Iron Sword")</description></item>
    ///   <item><description>Stats multiplied by quality stat multiplier</description></item>
    ///   <item><description>Value multiplied by quality value multiplier</description></item>
    ///   <item><description>Description enhanced with quality text</description></item>
    ///   <item><description>Legendary items receive glow effect</description></item>
    /// </list>
    /// </remarks>
    public Item CreateFromRecipe(RecipeDefinition recipe, CraftedItemQuality quality)
    {
        var baseItem = _itemProvider.GetItem(recipe.Output.ItemId);
        if (baseItem is null)
        {
            throw new ArgumentException(
                $"Item not found: {recipe.Output.ItemId}",
                nameof(recipe));
        }

        var modifier = new QualityModifier(quality);

        // Create quality-enhanced item with modified name
        var item = Item.Create(
            itemId: FormatQualityItemId(baseItem.ItemId, quality),
            name: modifier.FormatName(baseItem.Name),
            description: FormatQualityDescription(baseItem.Description, quality),
            itemType: baseItem.ItemType);

        // Apply stat modifiers based on item type
        ApplyQualityStats(item, baseItem, modifier);

        // Set modified value
        item.SetValue(modifier.ApplyToValue(baseItem.BaseValue));

        // Store quality information
        item.SetQuality(quality);

        // Add legendary glow effect
        if (modifier.HasGlowEffect)
        {
            item.AddEffect(ItemEffect.Create(
                effectId: "legendary_glow",
                description: "Emits a faint magical glow."));
        }

        return item;
    }

    /// <summary>
    /// Applies quality-modified stats to the item based on its type.
    /// </summary>
    private static void ApplyQualityStats(Item item, Item baseItem, QualityModifier modifier)
    {
        // Apply weapon stats if applicable
        if (baseItem.WeaponStats is not null)
        {
            item.SetWeaponStats(
                attackBonus: modifier.ApplyToStat(baseItem.WeaponStats.AttackBonus),
                damageDice: baseItem.WeaponStats.DamageDice,
                damageBonus: modifier.ApplyToStat(baseItem.WeaponStats.DamageBonus));
        }

        // Apply armor stats if applicable
        if (baseItem.ArmorStats is not null)
        {
            item.SetArmorStats(
                defenseBonus: modifier.ApplyToStat(baseItem.ArmorStats.DefenseBonus),
                armorType: baseItem.ArmorStats.ArmorType);
        }
    }

    /// <summary>
    /// Formats the item ID to include quality suffix.
    /// </summary>
    /// <param name="baseId">The base item ID.</param>
    /// <param name="quality">The quality tier.</param>
    /// <returns>The quality-suffixed item ID.</returns>
    private static string FormatQualityItemId(string baseId, CraftedItemQuality quality)
    {
        if (quality == CraftedItemQuality.Standard)
        {
            return baseId;
        }

        var suffix = quality switch
        {
            CraftedItemQuality.Fine => "_fine",
            CraftedItemQuality.Masterwork => "_masterwork",
            CraftedItemQuality.Legendary => "_legendary",
            _ => string.Empty
        };

        return $"{baseId}{suffix}";
    }

    /// <summary>
    /// Formats the item description with quality-specific text.
    /// </summary>
    /// <param name="baseDescription">The base item description.</param>
    /// <param name="quality">The quality tier.</param>
    /// <returns>The enhanced description.</returns>
    private static string FormatQualityDescription(string baseDescription, CraftedItemQuality quality)
    {
        var qualityText = quality switch
        {
            CraftedItemQuality.Fine =>
                " This item shows superior craftsmanship.",
            CraftedItemQuality.Masterwork =>
                " This item is a masterpiece of crafting skill.",
            CraftedItemQuality.Legendary =>
                " This legendary item glows with magical energy.",
            _ => string.Empty
        };

        return $"{baseDescription}{qualityText}";
    }
}
```

---

## 11. Configuration Schema

### 11.1 JSON Schema

**File:** `config/schemas/quality-tiers.schema.json`

```json
{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "https://runeandrust.game/schemas/quality-tiers.schema.json",
  "title": "Quality Tiers Configuration",
  "description": "Schema for defining crafted item quality tiers, thresholds, and modifiers.",
  "type": "object",
  "required": ["qualityTiers"],
  "properties": {
    "$schema": {
      "type": "string",
      "description": "Reference to this schema file."
    },
    "qualityTiers": {
      "type": "array",
      "description": "Array of quality tier definitions.",
      "minItems": 4,
      "items": {
        "type": "object",
        "required": [
          "quality",
          "minMargin",
          "statMultiplier",
          "valueMultiplier",
          "namePrefix",
          "description"
        ],
        "properties": {
          "quality": {
            "type": "string",
            "enum": ["Standard", "Fine", "Masterwork", "Legendary"],
            "description": "The quality tier name matching CraftedItemQuality enum."
          },
          "minMargin": {
            "type": "integer",
            "minimum": 0,
            "maximum": 999,
            "description": "Minimum roll margin (total - DC) required for this tier. Use 999 for natural 20 only tiers."
          },
          "statMultiplier": {
            "type": "number",
            "minimum": 1.0,
            "maximum": 5.0,
            "description": "Multiplier applied to item stats (attack, defense, damage bonuses)."
          },
          "valueMultiplier": {
            "type": "number",
            "minimum": 1.0,
            "maximum": 10.0,
            "description": "Multiplier applied to item base value."
          },
          "namePrefix": {
            "type": "string",
            "description": "Prefix added to item names. Empty string for Standard quality."
          },
          "description": {
            "type": "string",
            "description": "Description text appended to item descriptions."
          },
          "hasGlowEffect": {
            "type": "boolean",
            "default": false,
            "description": "Whether items of this quality have a visual glow effect."
          },
          "requiresNatural20": {
            "type": "boolean",
            "default": false,
            "description": "Whether this quality tier requires a natural 20 roll."
          }
        },
        "additionalProperties": false
      }
    },
    "failureThresholds": {
      "type": "object",
      "description": "Configuration for crafting failure resource loss (defined in v0.11.2b).",
      "properties": {
        "closeFailure": {
          "type": "object",
          "properties": {
            "maxMargin": {
              "type": "integer",
              "description": "Maximum margin for close failure (e.g., -1 means within 5 of DC)."
            },
            "resourceLoss": {
              "type": "number",
              "minimum": 0,
              "maximum": 1,
              "description": "Fraction of resources lost on close failure."
            }
          }
        },
        "badFailure": {
          "type": "object",
          "properties": {
            "maxMargin": {
              "type": "integer",
              "description": "Maximum margin for bad failure (e.g., -6 means beyond 5 of DC)."
            },
            "resourceLoss": {
              "type": "number",
              "minimum": 0,
              "maximum": 1,
              "description": "Fraction of resources lost on bad failure."
            }
          }
        }
      }
    }
  },
  "additionalProperties": false
}
```

---

## 12. Configuration File

### 12.1 Quality Tiers Configuration

**File:** `config/quality-tiers.json`

```json
{
  "$schema": "./schemas/quality-tiers.schema.json",
  "qualityTiers": [
    {
      "quality": "Standard",
      "minMargin": 0,
      "statMultiplier": 1.0,
      "valueMultiplier": 1.0,
      "namePrefix": "",
      "description": "A standard quality item.",
      "hasGlowEffect": false,
      "requiresNatural20": false
    },
    {
      "quality": "Fine",
      "minMargin": 5,
      "statMultiplier": 1.10,
      "valueMultiplier": 1.5,
      "namePrefix": "Fine ",
      "description": "A finely crafted item showing superior workmanship.",
      "hasGlowEffect": false,
      "requiresNatural20": false
    },
    {
      "quality": "Masterwork",
      "minMargin": 10,
      "statMultiplier": 1.25,
      "valueMultiplier": 2.5,
      "namePrefix": "Masterwork ",
      "description": "A masterwork item representing the pinnacle of craft.",
      "hasGlowEffect": false,
      "requiresNatural20": false
    },
    {
      "quality": "Legendary",
      "minMargin": 999,
      "statMultiplier": 1.50,
      "valueMultiplier": 5.0,
      "namePrefix": "Legendary ",
      "description": "A legendary item imbued with magical essence.",
      "hasGlowEffect": true,
      "requiresNatural20": true
    }
  ],
  "failureThresholds": {
    "closeFailure": {
      "maxMargin": -1,
      "resourceLoss": 0.25
    },
    "badFailure": {
      "maxMargin": -6,
      "resourceLoss": 0.50
    }
  }
}
```

---

## 13. Logging Specifications

### 13.1 Log Levels by Component

| Component | Level | Events |
|-----------|-------|--------|
| `QualityDeterminationService` | Information | Natural 20 legendary creation |
| `QualityDeterminationService` | Debug | Quality determination steps, margin evaluation |
| `QualityTierProvider` | Information | Tier configuration loaded |
| `QualityTierProvider` | Debug | Configuration file access, tier lookup |
| `QualityTierProvider` | Warning | Missing configuration, using defaults |
| `QualityTierProvider` | Error | Invalid configuration, parse failures |
| `ItemFactory` | Debug | Quality item creation, stat application |

### 13.2 Log Message Examples

```csharp
// QualityDeterminationService - Information
_logger.LogInformation(
    "Natural 20 rolled! Creating Legendary quality item");

// QualityDeterminationService - Debug
_logger.LogDebug(
    "Determining quality for roll {Roll} with margin {Margin}",
    roll, margin);

_logger.LogDebug(
    "Margin {Margin} qualifies for {Quality} (min margin: {MinMargin})",
    margin, tier.Quality, tier.MinMargin);

// QualityTierProvider - Information
_logger.LogInformation(
    "Loaded {Count} quality tier definitions",
    tiers.Count);

// QualityTierProvider - Warning
_logger.LogWarning(
    "Quality tiers configuration not found at {Path}, using defaults",
    _configPath);

// QualityTierProvider - Error
_logger.LogError(
    "Quality tier {Quality} is not configured in quality-tiers.json",
    required);
```

---

## 14. Unit Testing Requirements

### 14.1 Test Count by Feature

| Feature | Test Count |
|---------|------------|
| CraftedItemQuality Extensions | 2 |
| QualityModifier Value Object | 2 |
| QualityDeterminationService | 3 |
| QualityTierProvider | 1 |
| **Total** | **~8** |

### 14.2 Test Specifications

**File:** `tests/RuneAndRust.Tests/Domain/CraftedItemQualityExtensionsTests.cs`

```csharp
[TestFixture]
public class CraftedItemQualityExtensionsTests
{
    [Test]
    [TestCase(CraftedItemQuality.Standard, 1.0f)]
    [TestCase(CraftedItemQuality.Fine, 1.10f)]
    [TestCase(CraftedItemQuality.Masterwork, 1.25f)]
    [TestCase(CraftedItemQuality.Legendary, 1.50f)]
    public void GetStatMultiplier_ReturnsCorrectMultiplier(
        CraftedItemQuality quality, float expected);

    [Test]
    [TestCase(CraftedItemQuality.Standard, "")]
    [TestCase(CraftedItemQuality.Fine, "Fine ")]
    [TestCase(CraftedItemQuality.Masterwork, "Masterwork ")]
    [TestCase(CraftedItemQuality.Legendary, "Legendary ")]
    public void GetPrefix_ReturnsCorrectPrefix(
        CraftedItemQuality quality, string expected);
}
```

**File:** `tests/RuneAndRust.Tests/Domain/QualityModifierTests.cs`

```csharp
[TestFixture]
public class QualityModifierTests
{
    [Test]
    [TestCase(CraftedItemQuality.Fine, 4, 5)]       // 4 * 1.10 = 4.4 -> 5
    [TestCase(CraftedItemQuality.Masterwork, 4, 5)] // 4 * 1.25 = 5.0 -> 5
    [TestCase(CraftedItemQuality.Legendary, 4, 6)]  // 4 * 1.50 = 6.0 -> 6
    public void ApplyToStat_AppliesMultiplierCorrectly(
        CraftedItemQuality quality, int baseStat, int expected);

    [Test]
    [TestCase(CraftedItemQuality.Fine, "Iron Sword", "Fine Iron Sword")]
    [TestCase(CraftedItemQuality.Legendary, "Iron Sword", "Legendary Iron Sword")]
    public void FormatName_AddsPrefixCorrectly(
        CraftedItemQuality quality, string baseName, string expected);
}
```

**File:** `tests/RuneAndRust.Tests/Application/QualityDeterminationServiceTests.cs`

```csharp
[TestFixture]
public class QualityDeterminationServiceTests
{
    [Test]
    public void DetermineQuality_Natural20_ReturnsLegendary();

    [Test]
    [TestCase(15, 0, CraftedItemQuality.Standard)]
    [TestCase(17, 5, CraftedItemQuality.Fine)]
    [TestCase(19, 8, CraftedItemQuality.Fine)]
    [TestCase(18, 10, CraftedItemQuality.Masterwork)]
    [TestCase(19, 15, CraftedItemQuality.Masterwork)]
    public void DetermineQuality_ByMargin_ReturnsCorrectTier(
        int roll, int margin, CraftedItemQuality expected);

    [Test]
    public void CreateModifier_ReturnsModifierWithCorrectProperties();
}
```

**File:** `tests/RuneAndRust.Tests/Infrastructure/QualityTierProviderTests.cs`

```csharp
[TestFixture]
public class QualityTierProviderTests
{
    [Test]
    public void GetTiers_LoadsAllFourTiers();
}
```

---

## 15. Use Cases

### UC-001: Determine Standard Quality

**Actor:** System (CraftingService)
**Flow:** Roll succeeds (margin 0-4) → QualityDeterminationService evaluates margin → Returns Standard → Item created with base stats

### UC-002: Determine Fine Quality

**Actor:** System (CraftingService)
**Flow:** Roll succeeds (margin 5-9) → QualityDeterminationService evaluates margin → Returns Fine → Item created with +10% stats

### UC-003: Determine Masterwork Quality

**Actor:** System (CraftingService)
**Flow:** Roll succeeds (margin 10+) → QualityDeterminationService evaluates margin → Returns Masterwork → Item created with +25% stats

### UC-004: Determine Legendary Quality (Natural 20)

**Actor:** System (CraftingService)
**Flow:** Roll is natural 20 → QualityDeterminationService detects nat 20 → Returns Legendary → Item created with +50% stats and glow effect

### UC-005: Apply Quality to Item

**Actor:** System (ItemFactory)
**Flow:** Receive quality and recipe → Create QualityModifier → Apply stat/value multipliers → Add quality prefix to name → Add description text → Add glow if Legendary → Return item

---

## 16. Deliverable Checklist

### Domain Layer
- [ ] `CraftedItemQuality` enum created
- [ ] `CraftedItemQualityExtensions` methods implemented
- [ ] `QualityModifier` value object created
- [ ] `QualityTierDefinition` value object created

### Application Layer
- [ ] `IQualityDeterminationService` interface created
- [ ] `QualityDeterminationService` implementation created
- [ ] `IQualityTierProvider` interface created

### Infrastructure Layer
- [ ] `QualityTierProvider` implementation created

### Factory Updates
- [ ] `ItemFactory.CreateFromRecipe` method with quality support

### Configuration Files
- [ ] `config/quality-tiers.json` created
- [ ] `config/schemas/quality-tiers.schema.json` created

### Testing
- [ ] ~8 unit tests implemented
- [ ] All tests passing

---

## 17. Acceptance Criteria

### Functional
- [ ] Roll margin determines quality tier correctly
- [ ] Standard quality at DC exactly (margin 0-4)
- [ ] Fine quality at DC + 5 (margin 5-9)
- [ ] Masterwork quality at DC + 10 (margin 10+)
- [ ] Legendary quality on natural 20 only
- [ ] Stat multipliers apply correctly (1.0x, 1.10x, 1.25x, 1.50x)
- [ ] Value multipliers apply correctly (1.0x, 1.5x, 2.5x, 5.0x)
- [ ] Quality prefix appears in item name
- [ ] Quality description text appended to item description
- [ ] Legendary items receive glow effect
- [ ] Quality thresholds are configurable via JSON

### Quality
- [ ] Build succeeds with 0 errors
- [ ] Build succeeds with 0 warnings
- [ ] All ~8 unit tests pass
- [ ] Configuration validates against schema
- [ ] XML documentation complete on all public members

---

## 18. Dependencies

### Required from v0.11.2b

| Type | Location | Usage in this phase |
|------|----------|---------------------|
| `CraftingService` | Application/Services | Calls quality determination |
| `CraftResult` | Application/Records | Contains quality information |
| `ItemCraftedEvent` | Domain/Events | Includes quality in event |

### Required from v0.11.1

| Type | Location | Usage in this phase |
|------|----------|---------------------|
| `RecipeDefinition` | Domain/Entities | Recipe for item creation |
| `IRecipeProvider` | Application/Interfaces | Recipe lookup |

### Provides to Future Versions

| Type | Usage |
|------|-------|
| `CraftedItemQuality` | Quality display in inventory UI |
| `QualityModifier` | Stat calculations in combat |
| `IQualityTierProvider` | Potential extension for other quality systems |

---

## 19. Future Considerations

### Deferred to Future Versions
- **Quality Visual Indicators in UI**: Visual styling for quality tiers in inventory/equipment screens (future UI version)
- **Quality Sorting/Filtering**: Inventory filtering by quality tier (future inventory version)
- **Quality-based Achievements**: Achievements for crafting items of specific quality (future achievement system)

### Out of Scope
- **Dynamic Quality Thresholds**: Per-recipe quality thresholds (would require recipe schema changes)
- **Quality Degradation**: Item quality degrading over time/use (not in crafting scope)
- **Quality Improvement**: Upgrading item quality after creation (separate enchantment system)

---

*Document Version: 1.0*
*Last Updated: 2026-01-16*
*Author: Claude*
