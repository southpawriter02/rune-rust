# v0.18.2c Design Specification: ICpsService Interface

**Version:** 0.18.2c
**Parent:** v0.18.2 (Cognitive Paradox Syndrome)
**Prerequisites:** v0.18.2a (CPS Enums & State), v0.18.2b (Panic & Result Objects)
**Status:** Design Complete
**Estimated Unit Tests:** ~0 (Interface only)

---

## Table of Contents

1. [Executive Summary](#1-executive-summary)
2. [Feature Overview](#2-feature-overview)
3. [Architecture Diagrams](#3-architecture-diagrams)
4. [User Stories](#4-user-stories)
5. [ICpsService Interface](#5-icpsservice-interface)
6. [Method Specifications](#6-method-specifications)
7. [Logging Specifications](#7-logging-specifications)
8. [Unit Testing Requirements](#8-unit-testing-requirements)
9. [Deliverable Checklist](#9-deliverable-checklist)
10. [Acceptance Criteria](#10-acceptance-criteria)
11. [Dependencies](#11-dependencies)
12. [Future Considerations](#12-future-considerations)

---

## 1. Executive Summary

This design specification defines the **ICpsService interface** — the service contract for all Cognitive Paradox Syndrome operations in the trauma economy system.

v0.18.2c establishes the **Application Layer Contract** that will be implemented in v0.18.2d:

- 8 methods covering CPS state queries and operations
- Integration points with stress system and dice service
- Panic Table triggering and effect application

### Key Deliverables

| Category | Items |
|----------|-------|
| **Application Interfaces** | `ICpsService` |
| **Tests** | ~0 (Interface only — no logic to test) |

### Architectural Significance

This interface defines the **CPS Service Contract** following Clean Architecture principles — the Application Layer depends on this interface, while the implementation details are isolated in Infrastructure.

---

## 2. Feature Overview

```
v0.18.2c Features
└── ICpsService Interface (Application Layer)
    │
    ├── State Query Methods
    │   ├── GetCpsState(characterId) → CpsState
    │   ├── GetCurrentStage(characterId) → CpsStage
    │   └── GetUiEffects(characterId) → CpsUiEffects
    │
    ├── Stage Transition Methods
    │   └── CheckStageChange(characterId, previousStress, newStress) → CpsStageChangeResult
    │
    ├── Panic Table Methods
    │   ├── RollPanicTable(characterId) → PanicResult
    │   └── ApplyPanicEffect(characterId, panicResult) → void
    │
    └── Recovery Methods
        ├── IsRecoverable(characterId) → bool
        └── GetRecoveryProtocol(characterId) → CpsRecoveryProtocol
```

---

## 3. Architecture Diagrams

### 3.1 Clean Architecture Layers

```
┌─────────────────────────────────────────────────────────────────────────┐
│                       PRESENTATION LAYER                                 │
│                  (Commands, Renderers, TUI)                             │
│                            │                                             │
│                            │ uses                                        │
│                            ▼                                             │
├─────────────────────────────────────────────────────────────────────────┤
│                      APPLICATION LAYER                                   │
│  ┌─────────────────────────────────────────────────────────────────┐    │
│  │                    << interface >>                               │    │
│  │                     ICpsService                                  │    │
│  ├─────────────────────────────────────────────────────────────────┤    │
│  │ + GetCpsState(characterId): CpsState                            │    │
│  │ + GetCurrentStage(characterId): CpsStage                        │    │
│  │ + CheckStageChange(id, prev, new): CpsStageChangeResult         │    │
│  │ + RollPanicTable(characterId): PanicResult                      │    │
│  │ + GetUiEffects(characterId): CpsUiEffects                       │    │
│  │ + ApplyPanicEffect(characterId, result): void                   │    │
│  │ + IsRecoverable(characterId): bool                              │    │
│  │ + GetRecoveryProtocol(characterId): CpsRecoveryProtocol         │    │
│  └─────────────────────────────────────────────────────────────────┘    │
│                            ▲                                             │
│                            │ implements                                  │
│                            │                                             │
├─────────────────────────────────────────────────────────────────────────┤
│                    INFRASTRUCTURE LAYER                                  │
│  ┌─────────────────────────────────────────────────────────────────┐    │
│  │                      CpsService                                  │    │
│  │              (Implementation - v0.18.2d)                         │    │
│  └─────────────────────────────────────────────────────────────────┘    │
│                            │                                             │
│                            │ depends on                                  │
│                            ▼                                             │
├─────────────────────────────────────────────────────────────────────────┤
│                        DOMAIN LAYER                                      │
│        (CpsStage, PanicEffect, CpsState, PanicResult, etc.)             │
└─────────────────────────────────────────────────────────────────────────┘
```

### 3.2 Service Integration Points

```
┌───────────────────────────────────────────────────────────────────────────┐
│                        SERVICE INTEGRATION                                 │
└───────────────────────────────────────────────────────────────────────────┘

              ┌───────────────────┐
              │   IStressService  │
              │   (v0.18.0)       │
              └─────────┬─────────┘
                        │
                        │ provides stress values
                        ▼
┌───────────────────────────────────────────────────────────────────────────┐
│                           ICpsService                                      │
│                                                                            │
│  Uses stress values ─────► Determines CPS Stage                            │
│  Uses dice service  ─────► Rolls Panic Table                               │
│  Uses config        ─────► Loads UI effects & protocols                    │
│                                                                            │
└───────────────────────────────────────────────────────────────────────────┘
                        │
                        │ triggers effects
                        ▼
              ┌───────────────────┐
              │ IStatusEffectSvc  │
              │   (v0.10.x)       │
              └───────────────────┘
```

### 3.3 Method Call Flow

```
┌───────────────────────────────────────────────────────────────────────────┐
│                      CPS SERVICE METHOD FLOWS                              │
└───────────────────────────────────────────────────────────────────────────┘

[GetCpsState Flow]
    Caller ──► ICpsService.GetCpsState(characterId)
                    │
                    ├──► Get current stress from IStressService
                    ├──► Create CpsState.Create(stress)
                    └──► Return immutable CpsState

[RollPanicTable Flow]
    Caller ──► ICpsService.RollPanicTable(characterId)
                    │
                    ├──► Verify character is in RuinMadness or above
                    ├──► Call IDiceService.Roll(1, 10) for d10
                    ├──► Map roll result to PanicEffect
                    ├──► Create PanicResult with all effect data
                    └──► Return PanicResult (NOT applied yet)

[ApplyPanicEffect Flow]
    Caller ──► ICpsService.ApplyPanicEffect(characterId, panicResult)
                    │
                    ├──► Apply status effects via IStatusEffectService
                    ├──► Queue forced actions if applicable
                    ├──► Emit events for UI updates
                    └──► Return void (effects applied)

[CheckStageChange Flow]
    Caller ──► ICpsService.CheckStageChange(id, prevStress, newStress)
                    │
                    ├──► Calculate previous stage from prevStress
                    ├──► Calculate new stage from newStress
                    ├──► Detect critical transitions
                    └──► Return CpsStageChangeResult
```

---

## 4. User Stories

### US-18.2c-1: Query Current CPS State

**As a** combat system developer
**I want to** query a character's current CPS state
**So that** I can apply appropriate penalties and triggers

**Acceptance Criteria:**

- GetCpsState returns complete CpsState value object
- GetCurrentStage provides quick stage-only query
- Both methods are idempotent (no side effects)

### US-18.2c-2: Trigger Panic Table

**As a** event handler
**I want to** trigger Panic Table rolls for characters in RuinMadness
**So that** panic effects can be determined and applied

**Acceptance Criteria:**

- RollPanicTable returns PanicResult without applying effects
- ApplyPanicEffect applies the effects from a PanicResult
- Separation allows UI to display result before application

### US-18.2c-3: Detect Stage Transitions

**As a** state change listener
**I want to** detect when CPS stages change
**So that** appropriate events can be triggered

**Acceptance Criteria:**

- CheckStageChange detects all stage transitions
- EnteredRuinMadness flag enables panic table
- EnteredHollowShell flag triggers survival check

### US-18.2c-4: Retrieve UI and Recovery Info

**As a** UI system
**I want to** retrieve visual effects and recovery protocols
**So that** players see appropriate feedback

**Acceptance Criteria:**

- GetUiEffects returns stage-appropriate distortion config
- GetRecoveryProtocol returns actionable recovery steps
- IsRecoverable provides quick check for recovery possibility

---

## 5. ICpsService Interface

### 5.1 Purpose

Defines the service contract for all CPS management operations, following Clean Architecture principles to separate interface from implementation.

### 5.2 Definition

**File:** `src/Core/RuneAndRust.Application/Interfaces/ICpsService.cs`

```csharp
namespace RuneAndRust.Application.Interfaces;

using RuneAndRust.Domain.Enums;
using RuneAndRust.Domain.ValueObjects;

/// <summary>
/// Service contract for Cognitive Paradox Syndrome (CPS) management.
/// </summary>
/// <remarks>
/// <para>
/// ICpsService provides all operations for managing a character's CPS state,
/// which represents mental deterioration from processing reality-bending paradoxes.
/// </para>
/// <para>
/// CPS is derived from Psychic Stress and progresses through stages:
/// <list type="bullet">
/// <item>None (0-19 stress): No symptoms</item>
/// <item>WeightOfKnowing (20-39): Perception distortion</item>
/// <item>GlimmerMadness (40-59): Reality flickers</item>
/// <item>RuinMadness (60-79): Panic Table active</item>
/// <item>HollowShell (80+): Terminal state</item>
/// </list>
/// </para>
/// <para>
/// Unlike corruption, CPS can recover when stress is reduced through rest.
/// </para>
/// </remarks>
public interface ICpsService
{
    #region State Query Methods

    /// <summary>
    /// Gets the complete CPS state for a character.
    /// </summary>
    /// <param name="characterId">The character's unique identifier.</param>
    /// <returns>
    /// An immutable <see cref="CpsState"/> containing the current stress,
    /// stage, and computed properties.
    /// </returns>
    /// <remarks>
    /// This method is idempotent and has no side effects.
    /// The CPS state is computed from the character's current Psychic Stress.
    /// </remarks>
    /// <example>
    /// <code>
    /// var state = cpsService.GetCpsState(characterId);
    /// if (state.RequiresPanicCheck)
    /// {
    ///     // Character is in RuinMadness or worse
    /// }
    /// </code>
    /// </example>
    CpsState GetCpsState(Guid characterId);

    /// <summary>
    /// Gets the current CPS stage for a character.
    /// </summary>
    /// <param name="characterId">The character's unique identifier.</param>
    /// <returns>The character's current <see cref="CpsStage"/>.</returns>
    /// <remarks>
    /// Use this for quick stage checks when the full CpsState is not needed.
    /// </remarks>
    CpsStage GetCurrentStage(Guid characterId);

    /// <summary>
    /// Gets the UI distortion effects for a character's current CPS stage.
    /// </summary>
    /// <param name="characterId">The character's unique identifier.</param>
    /// <returns>
    /// A <see cref="CpsUiEffects"/> record containing all visual distortion parameters.
    /// </returns>
    /// <remarks>
    /// Used by the presentation layer to apply appropriate visual effects
    /// based on the character's mental deterioration.
    /// </remarks>
    CpsUiEffects GetUiEffects(Guid characterId);

    #endregion

    #region Stage Transition Methods

    /// <summary>
    /// Checks for CPS stage changes resulting from stress changes.
    /// </summary>
    /// <param name="characterId">The character's unique identifier.</param>
    /// <param name="previousStress">The stress value before the change.</param>
    /// <param name="newStress">The stress value after the change.</param>
    /// <returns>
    /// A <see cref="CpsStageChangeResult"/> describing any stage transition.
    /// </returns>
    /// <remarks>
    /// <para>
    /// This method detects stage transitions and returns information about
    /// critical transitions that require special handling:
    /// </para>
    /// <list type="bullet">
    /// <item>EnteredRuinMadness — Enables Panic Table rolls</item>
    /// <item>EnteredHollowShell — Requires survival check</item>
    /// </list>
    /// <para>
    /// This method is idempotent and does not modify state.
    /// </para>
    /// </remarks>
    /// <example>
    /// <code>
    /// var result = cpsService.CheckStageChange(characterId, 55, 65);
    /// if (result.EnteredRuinMadness)
    /// {
    ///     // Enable panic table for this character
    /// }
    /// </code>
    /// </example>
    CpsStageChangeResult CheckStageChange(Guid characterId, int previousStress, int newStress);

    #endregion

    #region Panic Table Methods

    /// <summary>
    /// Rolls on the Panic Table for a character in RuinMadness or worse.
    /// </summary>
    /// <param name="characterId">The character's unique identifier.</param>
    /// <returns>
    /// A <see cref="PanicResult"/> containing the roll outcome and all effect data.
    /// </returns>
    /// <remarks>
    /// <para>
    /// The Panic Table is a d10 roll that determines a panic effect when
    /// a character in RuinMadness experiences a stress-inducing event.
    /// </para>
    /// <para>
    /// This method only determines the result — it does NOT apply the effect.
    /// Call <see cref="ApplyPanicEffect"/> to apply the effect after displaying
    /// the result to the player.
    /// </para>
    /// </remarks>
    /// <exception cref="InvalidOperationException">
    /// Thrown if the character is not in RuinMadness or higher stage.
    /// </exception>
    /// <example>
    /// <code>
    /// if (cpsService.GetCurrentStage(characterId) >= CpsStage.RuinMadness)
    /// {
    ///     var panicResult = cpsService.RollPanicTable(characterId);
    ///     // Display result to player
    ///     cpsService.ApplyPanicEffect(characterId, panicResult);
    /// }
    /// </code>
    /// </example>
    PanicResult RollPanicTable(Guid characterId);

    /// <summary>
    /// Applies the effects of a panic result to a character.
    /// </summary>
    /// <param name="characterId">The character's unique identifier.</param>
    /// <param name="panicResult">The panic result to apply.</param>
    /// <remarks>
    /// <para>
    /// This method applies all mechanical effects from the panic result:
    /// </para>
    /// <list type="bullet">
    /// <item>Status effects (Stunned, Prone, etc.)</item>
    /// <item>Forced actions (Flee, Attack Nearest, etc.)</item>
    /// <item>Duration tracking for timed effects</item>
    /// </list>
    /// <para>
    /// Call this after displaying the panic result to the player.
    /// </para>
    /// </remarks>
    void ApplyPanicEffect(Guid characterId, PanicResult panicResult);

    #endregion

    #region Recovery Methods

    /// <summary>
    /// Checks whether a character's CPS state is recoverable.
    /// </summary>
    /// <param name="characterId">The character's unique identifier.</param>
    /// <returns>
    /// <c>true</c> if the character can recover from their current CPS stage;
    /// <c>false</c> if in RuinMadness or HollowShell (terminal states).
    /// </returns>
    /// <remarks>
    /// Recovery is possible for None, WeightOfKnowing, and GlimmerMadness.
    /// RuinMadness and HollowShell are considered terminal (non-recoverable).
    /// </remarks>
    bool IsRecoverable(Guid characterId);

    /// <summary>
    /// Gets the recovery protocol for a character's current CPS stage.
    /// </summary>
    /// <param name="characterId">The character's unique identifier.</param>
    /// <returns>
    /// A <see cref="CpsRecoveryProtocol"/> containing recovery steps and guidance.
    /// </returns>
    /// <remarks>
    /// Even terminal stages have a protocol (explaining there is no recovery).
    /// This method always returns a valid protocol for any stage.
    /// </remarks>
    CpsRecoveryProtocol GetRecoveryProtocol(Guid characterId);

    #endregion
}
```

---

## 6. Method Specifications

### 6.1 GetCpsState

| Aspect | Specification |
|--------|---------------|
| **Input** | `characterId: Guid` |
| **Output** | `CpsState` |
| **Dependencies** | `IStressService` (to get current stress) |
| **Side Effects** | None (read-only) |
| **Exceptions** | `ArgumentException` if character not found |

**Logic:**
1. Retrieve current stress from `IStressService.GetStress(characterId)`
2. Call `CpsState.Create(stress)` to generate state
3. Return immutable `CpsState`

### 6.2 GetCurrentStage

| Aspect | Specification |
|--------|---------------|
| **Input** | `characterId: Guid` |
| **Output** | `CpsStage` |
| **Dependencies** | `IStressService` |
| **Side Effects** | None (read-only) |

**Logic:**
1. Call `GetCpsState(characterId)`
2. Return `state.Stage`

### 6.3 CheckStageChange

| Aspect | Specification |
|--------|---------------|
| **Input** | `characterId: Guid`, `previousStress: int`, `newStress: int` |
| **Output** | `CpsStageChangeResult` |
| **Dependencies** | None (pure calculation) |
| **Side Effects** | None (read-only) |

**Logic:**
1. Call `CpsStageChangeResult.FromStressChange(previousStress, newStress)`
2. Return result with computed flags

### 6.4 RollPanicTable

| Aspect | Specification |
|--------|---------------|
| **Input** | `characterId: Guid` |
| **Output** | `PanicResult` |
| **Dependencies** | `IDiceService`, Configuration |
| **Side Effects** | None (generates result only) |
| **Exceptions** | `InvalidOperationException` if not in RuinMadness+ |

**Logic:**
1. Verify `GetCurrentStage(characterId) >= CpsStage.RuinMadness`
2. Roll `diceService.Roll(1, 10)` for d10
3. Map roll to `PanicEffect` from configuration
4. Create and return `PanicResult`

### 6.5 ApplyPanicEffect

| Aspect | Specification |
|--------|---------------|
| **Input** | `characterId: Guid`, `panicResult: PanicResult` |
| **Output** | `void` |
| **Dependencies** | `IStatusEffectService`, Combat Action Queue |
| **Side Effects** | Applies status effects, queues actions |

**Logic:**
1. For each status effect in `panicResult.StatusEffects`:
   - Call `statusEffectService.Apply(characterId, effect, duration)`
2. If `panicResult.ForcesAction`:
   - Queue forced action of type `panicResult.ForcedActionType`
3. Emit `PanicEffectApplied` event

### 6.6 GetUiEffects

| Aspect | Specification |
|--------|---------------|
| **Input** | `characterId: Guid` |
| **Output** | `CpsUiEffects` |
| **Dependencies** | Configuration (or built-in defaults) |
| **Side Effects** | None (read-only) |

**Logic:**
1. Get current stage via `GetCurrentStage(characterId)`
2. Return `CpsUiEffects.ForStage(stage)`

### 6.7 IsRecoverable

| Aspect | Specification |
|--------|---------------|
| **Input** | `characterId: Guid` |
| **Output** | `bool` |
| **Dependencies** | None |
| **Side Effects** | None (read-only) |

**Logic:**
1. Get current stage via `GetCurrentStage(characterId)`
2. Return `stage < CpsStage.RuinMadness`

### 6.8 GetRecoveryProtocol

| Aspect | Specification |
|--------|---------------|
| **Input** | `characterId: Guid` |
| **Output** | `CpsRecoveryProtocol` |
| **Dependencies** | Configuration (or built-in defaults) |
| **Side Effects** | None (read-only) |

**Logic:**
1. Get current stage via `GetCurrentStage(characterId)`
2. Return `CpsRecoveryProtocol.ForStage(stage)`

---

## 7. Logging Specifications

### 7.1 Interface Logging

> **Note:** Interfaces do not log directly.
> Logging specifications apply to the implementation (v0.18.2d).

### 7.2 Expected Log Events (Implementation)

| Method | Level | Template |
|--------|-------|----------|
| GetCpsState | Debug | `"Getting CPS state for {CharacterId}: Stage={Stage}"` |
| CheckStageChange | Information | `"CPS stage change detected: {CharacterId} {OldStage} → {NewStage}"` |
| RollPanicTable | Information | `"Panic table roll for {CharacterId}: d10={Roll} → {Effect}"` |
| ApplyPanicEffect | Information | `"Applied panic effect {Effect} to {CharacterId}"` |
| Critical Transition | Warning | `"Critical CPS transition: {CharacterId} entered {Stage}"` |

---

## 8. Unit Testing Requirements

### 8.1 Interface Testing

> **Note:** Interfaces have no logic to test.
> Unit tests will be created for the implementation in v0.18.2d.

### 8.2 Mock Requirements

For testing consumers of `ICpsService`, the following mock behaviors should be supported:

```csharp
// Example mock setup for tests
var mockCpsService = new Mock<ICpsService>();

mockCpsService
    .Setup(s => s.GetCpsState(It.IsAny<Guid>()))
    .Returns(CpsState.Create(stress: 45));

mockCpsService
    .Setup(s => s.RollPanicTable(It.IsAny<Guid>()))
    .Returns(PanicResult.Frozen());
```

---

## 9. Deliverable Checklist

### 9.1 Application Layer

- [ ] `src/Core/RuneAndRust.Application/Interfaces/ICpsService.cs`

### 9.2 Documentation

- [ ] Update `docs/design/v0.18.x/v0.18.2-scope-breakdown.md` (mark v0.18.2c complete)
- [ ] Create `docs/changelogs/v0.18.2c-changelog.md`

---

## 10. Acceptance Criteria

### 10.1 Build Verification

- [ ] Solution builds without errors
- [ ] Solution builds without warnings in new code

### 10.2 Interface Verification

- [ ] ICpsService defines all 8 methods
- [ ] All methods have XML documentation
- [ ] All parameters have XML documentation
- [ ] All return types are documented
- [ ] Interface compiles without implementation dependencies

### 10.3 Documentation Verification

- [ ] Remarks explain CPS system overview
- [ ] Examples show typical usage patterns
- [ ] Exceptions are documented where applicable

---

## 11. Dependencies

### 11.1 Required Prerequisites

| Dependency | Version | Status | Notes |
|------------|---------|--------|-------|
| CpsStage Enum | v0.18.2a | Required | Return type for GetCurrentStage |
| CpsState Value Object | v0.18.2a | Required | Return type for GetCpsState |
| PanicResult Record | v0.18.2b | Required | Return type for RollPanicTable |
| CpsStageChangeResult | v0.18.2b | Required | Return type for CheckStageChange |
| CpsUiEffects | v0.18.2b | Required | Return type for GetUiEffects |
| CpsRecoveryProtocol | v0.18.2b | Required | Return type for GetRecoveryProtocol |

### 11.2 Provides to Later Phases

| Item | Consumer | Purpose |
|------|----------|---------|
| `ICpsService` | v0.18.2d (CpsService) | Service contract to implement |
| `ICpsService` | v0.18.5 (Integration) | CPS queries in trauma economy |
| `ICpsService` | Combat System | Panic table triggers |

---

## 12. Future Considerations

### 12.1 v0.18.2d (CpsService Implementation)

- Full implementation of all 8 methods
- Configuration loading from JSON
- Integration with IDiceService
- Logging implementation

### 12.2 v0.18.5 (Resource Integration)

- ICpsService integration with trauma economy orchestration
- Cross-system effect calculations

### 12.3 Potential Interface Extensions

The following methods may be added in future versions:

```csharp
// Future consideration - not in current scope
Task<CpsState> GetCpsStateAsync(Guid characterId, CancellationToken ct = default);
bool TrySurvivalCheck(Guid characterId, out bool survived);
void ResetCps(Guid characterId); // GM override
```

---

*Document Version: 1.0*
*Last Updated: 2026-01-28*
*Author: Claude (AI Assistant)*
