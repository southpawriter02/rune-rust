# v0.9.1a Design Specification: Music Service Core

**Version:** 0.9.1a
**Parent:** v0.9.1 (Music System)
**Prerequisites:** v0.9.0c Complete (TUI Bell Service)
**Status:** Design Complete
**Estimated Unit Tests:** ~8

---

## 1. Overview

### Purpose

Implement the core music service managing background music playback. Includes `IMusicService` interface, `MusicService` implementation using the underlying `AudioService` (from v0.9.0a), track looping, pause/resume on game pause, volume integration with settings, theme switching, and stinger support for one-shot audio events.

### Key Deliverables

| Category | Items |
|----------|-------|
| **Interfaces** | `IMusicService` |
| **Services** | `MusicService` |
| **Support Classes** | `MusicPlayback` |
| **Events** | `OnTrackChanged`, `OnThemeChanged` |
| **Tests** | ~8 unit tests |

---

## 2. Feature Overview

```
v0.9.1a Features
├── IMusicService Interface
│   ├── CurrentTheme (property)
│   ├── CurrentTrack (property)
│   ├── IsPlaying / IsPaused (properties)
│   ├── PlayTrack(path, loop)
│   ├── Stop()
│   ├── Pause() / Resume()
│   ├── SetVolume(volume) / GetVolume()
│   ├── SetTheme(theme)
│   ├── PlayStinger(name, onComplete)
│   ├── PreloadThemeAsync(theme)
│   └── Events: OnTrackChanged, OnThemeChanged
│
├── MusicService Implementation
│   ├── Uses IAudioService for playback
│   ├── Tracks current playback ID
│   ├── Loop support via AudioService
│   ├── Volume delegation to AudioChannel.Music
│   ├── Theme switching with track selection
│   └── Stinger interruption and resume
│
├── Game Pause Integration
│   ├── Subscribe to GamePausedEvent
│   └── Pause/Resume music accordingly
│
├── Stinger Support (One-Shot)
│   ├── Pause current music
│   ├── Play stinger track
│   ├── Resume on completion
│   └── Optional callback
│
└── Preload Support
    └── Cache theme tracks for perf
```

---

## 3. Architecture

```
┌─────────────────────────────────────────────────────────────────────────┐
│                       GAME SYSTEMS                                      │
├─────────────────────────────────────────────────────────────────────────┤
│  Combat, Exploration, UI                                               │
│                                                                         │
│                         SetTheme(theme)                                │
│                         PlayStinger(name)                              │
│                               │                                         │
└───────────────────────────────┼─────────────────────────────────────────┘
                                ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                       IMusicService                                     │
├─────────────────────────────────────────────────────────────────────────┤
│  Properties:                                                            │
│  ├── MusicTheme CurrentTheme                                           │
│  ├── string? CurrentTrack                                              │
│  ├── bool IsPlaying                                                    │
│  └── bool IsPaused                                                     │
│                                                                         │
│  Methods:                                                               │
│  ├── PlayTrack(path, loop)                                            │
│  ├── Stop(), Pause(), Resume()                                        │
│  ├── SetVolume(vol), GetVolume()                                      │
│  ├── SetTheme(theme)                                                   │
│  ├── PlayStinger(name, onComplete)                                    │
│  └── PreloadThemeAsync(theme)                                          │
│                                                                         │
│  Events:                                                                │
│  ├── Action<string> OnTrackChanged                                    │
│  └── Action<MusicTheme> OnThemeChanged                                 │
└─────────────────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                       MusicService                                      │
├─────────────────────────────────────────────────────────────────────────┤
│  Dependencies:                                                          │
│  ├── IAudioService _audioService                                       │
│  ├── IMusicThemeConfig _themeConfig (v0.9.1b)                         │
│  └── ILogger<MusicService> _logger                                     │
│                                                                         │
│  State:                                                                 │
│  ├── Guid _currentPlaybackId                                           │
│  ├── MusicTheme _currentTheme                                          │
│  ├── string? _currentTrack                                             │
│  ├── bool _isPaused                                                    │
│  ├── string? _pausedForStinger                                         │
│  └── Guid _stingerPlaybackId                                           │
└─────────────────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                       IAudioService (v0.9.0a)                          │
├─────────────────────────────────────────────────────────────────────────┤
│  Play(path, AudioChannel.Music, volume, loop)                          │
│  Stop(playbackId)                                                       │
│  Pause(playbackId) / Resume(playbackId)                                │
│  SetChannelVolume(AudioChannel.Music, volume)                          │
└─────────────────────────────────────────────────────────────────────────┘
```

---

## 4. IMusicService Interface

**File:** `src/Core/RuneAndRust.Application/Interfaces/IMusicService.cs`

```csharp
namespace RuneAndRust.Application.Interfaces;

/// <summary>
/// Manages background music playback with theme support.
/// </summary>
public interface IMusicService : IDisposable
{
    /// <summary>Gets the currently playing theme.</summary>
    MusicTheme CurrentTheme { get; }

    /// <summary>Gets the currently playing track path.</summary>
    string? CurrentTrack { get; }

    /// <summary>Gets whether music is currently playing.</summary>
    bool IsPlaying { get; }

    /// <summary>Gets whether music is paused.</summary>
    bool IsPaused { get; }

    /// <summary>Plays a specific track.</summary>
    /// <param name="trackPath">Path to the music file.</param>
    /// <param name="loop">Whether to loop the track.</param>
    void PlayTrack(string trackPath, bool loop = true);

    /// <summary>Stops the current music.</summary>
    void Stop();

    /// <summary>Pauses the current music.</summary>
    void Pause();

    /// <summary>Resumes paused music.</summary>
    void Resume();

    /// <summary>Sets the music volume (0.0 to 1.0).</summary>
    void SetVolume(float volume);

    /// <summary>Gets the current music volume.</summary>
    float GetVolume();

    /// <summary>Sets the current theme (selects track from config).</summary>
    void SetTheme(MusicTheme theme);

    /// <summary>Plays a one-shot stinger track, optionally resuming music after.</summary>
    /// <param name="stingerName">Name of the stinger to play.</param>
    /// <param name="onComplete">Callback when stinger finishes.</param>
    void PlayStinger(string stingerName, Action? onComplete = null);

    /// <summary>Preloads music tracks for a theme.</summary>
    Task PreloadThemeAsync(MusicTheme theme, CancellationToken ct = default);

    /// <summary>Event fired when track changes.</summary>
    event Action<string>? OnTrackChanged;

    /// <summary>Event fired when theme changes.</summary>
    event Action<MusicTheme>? OnThemeChanged;
}
```

---

## 5. MusicTheme Enum (Stub)

**File:** `src/Core/RuneAndRust.Application/Enums/MusicTheme.cs`

```csharp
namespace RuneAndRust.Application.Enums;

/// <summary>
/// Music themes that change based on game context.
/// Full definition in v0.9.1b.
/// </summary>
public enum MusicTheme
{
    /// <summary>No music playing.</summary>
    None,

    /// <summary>Main menu music.</summary>
    MainMenu,

    /// <summary>Dungeon exploration ambient music.</summary>
    Exploration,

    /// <summary>Standard combat music.</summary>
    Combat,

    /// <summary>Boss encounter music.</summary>
    BossCombat,

    /// <summary>Town/safe area peaceful music.</summary>
    SafeArea
}
```

---

## 6. MusicService Implementation

**File:** `src/Infrastructure/RuneAndRust.Infrastructure/Services/MusicService.cs`

```csharp
namespace RuneAndRust.Infrastructure.Services;

public class MusicService : IMusicService
{
    private readonly IAudioService _audioService;
    private readonly IMusicThemeConfig _themeConfig;
    private readonly IEventBus _eventBus;
    private readonly ILogger<MusicService> _logger;

    private Guid _currentPlaybackId;
    private MusicTheme _currentTheme = MusicTheme.None;
    private string? _currentTrack;
    private bool _isPaused;
    
    // Stinger state
    private Guid _stingerPlaybackId;
    private string? _trackBeforeStinger;
    private MusicTheme _themeBeforeStinger;
    private Action? _stingerCallback;

    public MusicTheme CurrentTheme => _currentTheme;
    public string? CurrentTrack => _currentTrack;
    public bool IsPlaying => _currentPlaybackId != Guid.Empty && !_isPaused;
    public bool IsPaused => _isPaused;

    public event Action<string>? OnTrackChanged;
    public event Action<MusicTheme>? OnThemeChanged;

    public MusicService(IAudioService audioService, IMusicThemeConfig themeConfig,
        IEventBus eventBus, ILogger<MusicService> logger)
    {
        _audioService = audioService;
        _themeConfig = themeConfig;
        _eventBus = eventBus;
        _logger = logger;

        // Subscribe to game pause events
        _eventBus.Subscribe<GamePausedEvent>(OnGamePaused);
        _eventBus.Subscribe<GameResumedEvent>(OnGameResumed);
    }

    public void PlayTrack(string trackPath, bool loop = true)
    {
        // Stop current music
        if (_currentPlaybackId != Guid.Empty)
            _audioService.Stop(_currentPlaybackId);

        // Start new track on Music channel
        _currentPlaybackId = _audioService.Play(trackPath, AudioChannel.Music, 1.0f, loop);
        _currentTrack = trackPath;
        _isPaused = false;

        _logger.LogInformation("Playing music: {Track}, Loop: {Loop}", trackPath, loop);
        OnTrackChanged?.Invoke(trackPath);
    }

    public void Stop()
    {
        if (_currentPlaybackId != Guid.Empty)
        {
            _audioService.Stop(_currentPlaybackId);
            _currentPlaybackId = Guid.Empty;
            _currentTrack = null;
            _isPaused = false;
            _logger.LogDebug("Music stopped");
        }
    }

    public void Pause()
    {
        if (_currentPlaybackId != Guid.Empty && !_isPaused)
        {
            _audioService.Pause(_currentPlaybackId);
            _isPaused = true;
            _logger.LogDebug("Music paused");
        }
    }

    public void Resume()
    {
        if (_currentPlaybackId != Guid.Empty && _isPaused)
        {
            _audioService.Resume(_currentPlaybackId);
            _isPaused = false;
            _logger.LogDebug("Music resumed");
        }
    }

    public void SetVolume(float volume)
    {
        var clamped = Math.Clamp(volume, 0f, 1f);
        _audioService.SetChannelVolume(AudioChannel.Music, clamped);
        _logger.LogDebug("Music volume set to {Volume}", clamped);
    }

    public float GetVolume() => _audioService.GetChannelVolume(AudioChannel.Music);

    public void SetTheme(MusicTheme theme)
    {
        if (theme == _currentTheme) return;

        var previousTheme = _currentTheme;
        _currentTheme = theme;

        // Get track for new theme (from config, v0.9.1b)
        var trackPath = _themeConfig.GetTrackForTheme(theme);
        if (trackPath is not null)
            PlayTrack(trackPath, loop: true);
        else
            Stop();

        _logger.LogInformation("Theme changed: {From} → {To}", previousTheme, theme);
        OnThemeChanged?.Invoke(theme);
    }

    public void PlayStinger(string stingerName, Action? onComplete = null)
    {
        var stingerPath = _themeConfig.GetStingerTrack(stingerName);
        if (stingerPath is null)
        {
            _logger.LogWarning("Stinger not found: {Name}", stingerName);
            onComplete?.Invoke();
            return;
        }

        // Save current state
        _trackBeforeStinger = _currentTrack;
        _themeBeforeStinger = _currentTheme;
        _stingerCallback = onComplete;

        // Pause current music
        Pause();

        // Play stinger (no loop)
        _stingerPlaybackId = _audioService.Play(stingerPath, AudioChannel.Music, 1.0f, loop: false);
        _logger.LogDebug("Playing stinger: {Name}", stingerName);

        // Schedule resume after stinger (simplified; real impl uses playback complete callback)
        // In production, AudioService would provide OnPlaybackComplete event
    }

    public async Task PreloadThemeAsync(MusicTheme theme, CancellationToken ct = default)
    {
        var tracks = _themeConfig.GetAllTracksForTheme(theme);
        await _audioService.PreloadAsync(tracks, ct);
        _logger.LogDebug("Preloaded {Count} tracks for theme {Theme}", tracks.Count, theme);
    }

    private void OnGamePaused(GamePausedEvent e)
    {
        if (IsPlaying) Pause();
    }

    private void OnGameResumed(GameResumedEvent e)
    {
        if (IsPaused) Resume();
    }

    public void Dispose()
    {
        Stop();
        _logger.LogInformation("MusicService disposed");
    }
}
```

---

## 7. Music Playback Flow

```
NORMAL PLAYBACK:
  SetTheme(Exploration)
        │
        ▼
  GetTrackForTheme(Exploration) ──▶ "dungeon_ambient_01.ogg"
        │
        ▼
  PlayTrack("dungeon_ambient_01.ogg", loop: true)
        │
        ▼
  IAudioService.Play(path, Music, 1.0, true) ──▶ Guid
        │
        ▼
  Music loops until theme change or Stop()


STINGER INTERRUPTION:
  PlayStinger("victory")
        │
        ▼
  Pause current music
        │
        ▼
  Play stinger (no loop)
        │
        ▼
  [Stinger completes]
        │
        ▼
  Resume previous music
        │
        ▼
  Invoke onComplete callback


GAME PAUSE INTEGRATION:
  [User pauses game]
        │
        ▼
  GamePausedEvent fires
        │
        ▼
  MusicService.Pause()
        │
        ▼
  [User resumes game]
        │
        ▼
  GameResumedEvent fires
        │
        ▼
  MusicService.Resume()
```

---

## 8. Unit Testing Requirements (~8 tests)

| Feature | Tests |
|---------|-------|
| PlayTrack starts playback | 1 |
| Loop parameter passes to AudioService | 1 |
| Stop clears playback state | 1 |
| Pause sets IsPaused true | 1 |
| Resume sets IsPaused false | 1 |
| SetTheme changes CurrentTheme | 1 |
| SetVolume clamps 0-1 | 1 |
| Events fire on track/theme change | 1 |

---

## 9. Acceptance Criteria

- [ ] MusicService can play tracks
- [ ] Tracks loop continuously when loop=true
- [ ] Stop stops playback and clears state
- [ ] Pause pauses playback
- [ ] Resume continues playback
- [ ] SetVolume works (0.0-1.0)
- [ ] GetVolume returns current volume
- [ ] CurrentTrack reports correctly
- [ ] IsPlaying/IsPaused report correctly
- [ ] SetTheme changes theme and plays track
- [ ] Same theme call is idempotent
- [ ] OnTrackChanged fires on play
- [ ] OnThemeChanged fires on theme change
- [ ] PlayStinger plays one-shot audio
- [ ] PreloadThemeAsync caches tracks
- [ ] Game pause pauses music
- [ ] Game resume resumes music
- [ ] ~8 unit tests pass

---

## 10. Dependencies

| From | Required |
|------|----------|
| v0.9.0a | `IAudioService`, `AudioChannel.Music` |
| v0.9.1b | `IMusicThemeConfig` (stub for now) |
| Application | `IEventBus`, `GamePausedEvent`, `GameResumedEvent` |

---

## 11. Future Considerations

**Deferred to v0.9.1c:** Crossfade transitions, intro tracks, stinger complete callbacks, game state triggers (combat detection).

---

*Document Version: 1.0 | Last Updated: 2026-01-10*
