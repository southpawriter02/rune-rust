# v0.4.3: The Weaver (Magic Core System)

> **Status:** Planned
> **Milestone:** v0.4.x - The Saga & The Weaver
> **Theme:** The engine of Aetheric manipulation, Flux tracking, spell casting, and arcane consequence.

---

## Table of Contents

1. [Overview](#overview)
2. [Sub-Version Breakdown](#sub-version-breakdown)
3. [Architecture Overview](#architecture-overview)
4. [Cross-Cutting Concerns](#cross-cutting-concerns)
5. [Domain 4 Compliance](#domain-4-compliance)
6. [Dependency Map](#dependency-map)
7. [Testing Strategy Summary](#testing-strategy-summary)
8. [Changelog Template](#changelog-template)

---

## Overview

v0.4.3 introduces **The Weaver**, the magic system of *Rune & Rust*. Unlike traditional mana-based systems, magic in Domain 4 is governed by **Flux**—a localized environmental volatility that accumulates with each spell cast and dissipates over time. This creates a risk/reward mechanic where aggressive spellcasting increases the probability of **Backlash**—catastrophic magical failures that harm the caster.

### Design Philosophy

The Weaver system follows three core principles:

1. **Environmental Magic**: Flux is not a character resource (like Stamina) but a property of the current location/encounter. Reality thins with each spell.
2. **Escalating Risk**: The more magic is used, the more dangerous it becomes. This creates natural pacing and tactical decisions.
3. **Domain 4 Compliance**: All spell descriptions, flux narratives, and backlash effects use archaeologist-perspective language. No precision measurements.

### Key Mechanics

| Mechanic | Description |
|----------|-------------|
| **Flux** | Environmental magic volatility (0-100). Increases with spells, dissipates each round. |
| **Aether Points (AP)** | Personal magical resource consumed by spellcasting. Regenerates slowly. |
| **Spell Schools** | Categorization: Destruction, Restoration, Alteration, Divination. |
| **Backlash** | Risk mechanic triggered when Flux exceeds critical threshold (50+). |
| **Aether Sickness** | Status effect from severe backlash: stat penalties until rest. |
| **Corruption** | Long-term consequence from repeated backlash exposure. |

---

## Sub-Version Breakdown

To manage complexity and ensure proper testing, v0.4.3 is divided into **5 sub-versions**:

| Sub-Version | Codename | Focus | Estimated Tests |
|-------------|----------|-------|-----------------|
| **v0.4.3a** | The Aether | Flux state, AetherService, FluxState model | ~28 |
| **v0.4.3b** | The Grimoire | Spell entity, SpellSchool enum, SpellRepository | ~32 |
| **v0.4.3c** | The Incantation | Cast command, MagicService, spell execution pipeline | ~45 |
| **v0.4.3d** | The Backlash | Risk mechanics, Corruption checks, Aether Sickness | ~38 |
| **v0.4.3e** | The Resonance | Seeding, TUI integration, `cast` command in GameLoop | ~22 |

**Total Estimated Tests: ~165**

---

## v0.4.3a: The Aether (Flux State & Service)

> **Goal:** Implement environmental Flux tracking and the AetherService for managing magical volatility.

### Scope

- **FluxState** model: Tracks current Flux (0-100), dissipation rate, critical threshold
- **IAetherService** interface: Contract for Flux manipulation
- **AetherService** implementation: Singleton service for Flux state management
- **FluxChangedEvent**: Event for UI/audio hooks when Flux changes significantly
- **CombatService integration**: Hook `DissipateFlux()` into end-of-round processing

### Key Components

| Component | Layer | Description |
|-----------|-------|-------------|
| `FluxState` | Core/Models/Magic | Lightweight POCO tracking Flux values |
| `IAetherService` | Core/Interfaces | Service contract |
| `AetherService` | Engine/Services | Flux manipulation logic |
| `FluxChangedEvent` | Core/Events | Event published on significant changes |
| `FluxThreshold` | Core/Enums | Enum for Safe/Elevated/Critical/Overload |

### Decision Trees

1. **ModifyFlux**: Validation → Clamp → Update → Check Threshold → Publish Event
2. **DissipateFlux**: Get Rate → Subtract → Clamp to 0 → Log
3. **GetFluxThreshold**: Value ranges → Return appropriate enum

### Deliverables

- [ ] `FluxState.cs` - Model with CurrentValue, DissipationRate, CriticalThreshold
- [ ] `FluxThreshold.cs` - Enum: Safe (0-24), Elevated (25-49), Critical (50-74), Overload (75-100)
- [ ] `IAetherService.cs` - Interface with ModifyFlux, DissipateFlux, GetCurrentFlux, GetThreshold, Reset
- [ ] `AetherService.cs` - Implementation with comprehensive logging
- [ ] `FluxChangedEvent.cs` - Event with OldValue, NewValue, Source, Threshold
- [ ] `AetherServiceTests.cs` - 28 unit tests
- [ ] DI registration in `Program.cs`
- [ ] CombatService hook for end-of-round dissipation

### Test Categories (28 tests)

| Category | Tests | Description |
|----------|-------|-------------|
| ModifyFlux | 8 | Add/subtract, clamping, negative prevention |
| DissipateFlux | 5 | Standard dissipation, custom rates, boundary conditions |
| Threshold Detection | 6 | All threshold transitions and edge cases |
| Event Publishing | 5 | Significant change events, threshold crossing |
| Integration | 4 | CombatService round-end hook |

---

## v0.4.3b: The Grimoire (Spell Entity & Repository)

> **Goal:** Define the Spell entity structure, school classification, and data access layer.

### Scope

- **Spell** entity: Core definition (Name, School, AP Cost, Flux Cost, Range, EffectScript)
- **SpellSchool** enum: Destruction, Restoration, Alteration, Divination
- **SpellTargetType** enum: Self, Single, Area, Ally
- **ISpellRepository** interface: Data access contract
- **SpellRepository** implementation: In-memory and/or database-backed
- **SpellDefinition** migration: Database schema for spell storage

### Key Components

| Component | Layer | Description |
|-----------|-------|-------------|
| `Spell` | Core/Entities | Spell definition entity |
| `SpellSchool` | Core/Enums | Magic classification |
| `SpellTargetType` | Core/Enums | Valid target types |
| `SpellRange` | Core/Enums | Close, Medium, Far, Self |
| `ISpellRepository` | Core/Interfaces | Repository contract |
| `SpellRepository` | Infrastructure/Repositories | Data access implementation |

### Spell Entity Structure

```csharp
public class Spell
{
    public Guid Id { get; set; }
    public string Name { get; set; }           // "Spark", "Mend Flesh"
    public string Description { get; set; }    // Domain 4 compliant flavor
    public SpellSchool School { get; set; }    // Destruction, Restoration, etc.
    public SpellTargetType TargetType { get; set; }
    public SpellRange Range { get; set; }
    public int ApCost { get; set; }            // Aether Point cost
    public int FluxCost { get; set; }          // Added to environmental Flux
    public int BasePower { get; set; }         // For damage/healing calculation
    public string EffectScript { get; set; }   // "DAMAGE:Fire:2d6" format
    public string? TelegraphMessage { get; set; } // For charged spells
    public int ChargeTurns { get; set; }       // 0 = instant
    public bool RequiresConcentration { get; set; }
}
```

### Decision Trees

1. **GetByName**: Normalize → Query → Return or null
2. **GetBySchool**: Filter → Order by Name → Return list
3. **ValidateSpell**: Required fields → Range checks → Effect script syntax

### Deliverables

- [ ] `Spell.cs` - Entity with all properties
- [ ] `SpellSchool.cs` - Enum with 4 schools
- [ ] `SpellTargetType.cs` - Enum: Self, SingleEnemy, SingleAlly, AllEnemies, AllAllies, Area
- [ ] `SpellRange.cs` - Enum: Self, Close, Medium, Far
- [ ] `ISpellRepository.cs` - Interface with CRUD + query methods
- [ ] `SpellRepository.cs` - Implementation
- [ ] `V043__CreateSpellTable.sql` - Database migration
- [ ] `SpellRepositoryTests.cs` - 32 unit tests

### Test Categories (32 tests)

| Category | Tests | Description |
|----------|-------|-------------|
| CRUD Operations | 10 | Create, Read, Update, Delete spells |
| Query Methods | 8 | GetByName, GetBySchool, GetAll |
| Validation | 8 | Required fields, range validation, effect script syntax |
| Edge Cases | 6 | Empty collections, null handling, duplicates |

---

## v0.4.3c: The Incantation (Cast Command & MagicService)

> **Goal:** Implement the spell execution pipeline, `cast` command parsing, and MagicService.

### Scope

- **IMagicService** interface: Contract for spell execution
- **MagicService** implementation: Orchestrates casting validation, execution, Flux modification
- **MagicResult** model: Outcome of cast attempts (Success, Failure, Reason, Effects)
- **Cast command parsing**: `cast <spell> [on <target>]` syntax in CommandParser
- **Spell effect execution**: Integration with EffectScriptExecutor
- **AP resource integration**: Deduct AP from caster, check availability

### Key Components

| Component | Layer | Description |
|-----------|-------|-------------|
| `IMagicService` | Core/Interfaces | Spellcasting contract |
| `MagicService` | Engine/Services | Casting orchestration |
| `MagicResult` | Core/Models/Magic | Cast outcome |
| `CastFailureReason` | Core/Enums | Why cast failed |
| `SpellCastEvent` | Core/Events | Event for successful casts |

### Casting Pipeline

```
Input: "cast spark on goblin"
    │
    ▼
┌─────────────────────────────────────┐
│ 1. PARSE COMMAND                    │
│    - Extract spell name: "spark"    │
│    - Extract target: "goblin"       │
│    - Return ParseResult with flags  │
└─────────────────────────────────────┘
    │
    ▼
┌─────────────────────────────────────┐
│ 2. RESOLVE SPELL                    │
│    - SpellRepository.GetByName()    │
│    - If not found → Failure         │
└─────────────────────────────────────┘
    │
    ▼
┌─────────────────────────────────────┐
│ 3. VALIDATE RESOURCES               │
│    - Check caster.CurrentAp >= cost │
│    - If insufficient → Failure      │
└─────────────────────────────────────┘
    │
    ▼
┌─────────────────────────────────────┐
│ 4. VALIDATE TARGET                  │
│    - Check target exists            │
│    - Check target type matches      │
│    - Check range constraints        │
│    - If invalid → Failure           │
└─────────────────────────────────────┘
    │
    ▼
┌─────────────────────────────────────┐
│ 5. EXECUTE SPELL                    │
│    - Deduct AP from caster          │
│    - Add FluxCost to environment    │
│    - Execute EffectScript on target │
│    - Log to combat log              │
└─────────────────────────────────────┘
    │
    ▼
┌─────────────────────────────────────┐
│ 6. RETURN RESULT                    │
│    - MagicResult with damage/heal   │
│    - Narrative message              │
│    - Publish SpellCastEvent         │
└─────────────────────────────────────┘
```

### Decision Trees

1. **CastSpell**: Parse → Resolve → Validate Resources → Validate Target → Execute → Return Result
2. **ValidateTarget**: TargetType switch → Range check → Visibility check
3. **ExecuteEffect**: Get script → Delegate to EffectScriptExecutor → Aggregate results

### Deliverables

- [ ] `IMagicService.cs` - Interface with CastSpell, CanCast, GetAvailableSpells
- [ ] `MagicService.cs` - Full implementation with logging
- [ ] `MagicResult.cs` - Result model with Success, Message, Damage, Healing, StatusesApplied
- [ ] `CastFailureReason.cs` - Enum: UnknownSpell, InsufficientAp, InvalidTarget, OutOfRange, Silenced
- [ ] `SpellCastEvent.cs` - Event with Caster, Spell, Target, FluxAdded
- [ ] `CommandParser` extension - Handle `cast` command in combat phase
- [ ] `MagicServiceTests.cs` - 45 unit tests

### Test Categories (45 tests)

| Category | Tests | Description |
|----------|-------|-------------|
| Successful Casts | 10 | Various spells, targets, schools |
| Resource Validation | 8 | AP checks, deduction, edge cases |
| Target Validation | 10 | Type matching, range, visibility |
| Effect Execution | 8 | Damage, healing, status application |
| Flux Integration | 5 | Flux modification, event publishing |
| Failure Cases | 4 | All failure reasons tested |

---

## v0.4.3d: The Backlash (Risk & Corruption)

> **Goal:** Implement the consequence system for high-Flux spellcasting—Backlash and Corruption.

### Scope

- **Backlash mechanics**: Risk check before each cast when Flux > Critical (50)
- **IBacklashService** interface: Contract for risk evaluation and application
- **BacklashService** implementation: Risk calculation, effect determination
- **BacklashSeverity** enum: Minor, Major, Catastrophic
- **Aether Sickness** status effect: Temporary stat penalties from backlash
- **Corruption tracking**: Long-term consequence counter on Character entity
- **Corruption effects**: Threshold-based permanent penalties

### Backlash Mechanics

When casting a spell:
1. Check current Flux **before** adding spell's FluxCost
2. If Flux > CriticalThreshold (50):
   - Calculate `RiskChance = CurrentFlux - CriticalThreshold` (0-50%)
   - Roll d100
   - If `Roll <= RiskChance`: **BACKLASH TRIGGERED**
3. Determine severity based on how much roll failed by
4. Apply backlash effects

### Severity Table

| Roll vs Risk | Severity | Effects |
|--------------|----------|---------|
| Failed by 1-10 | Minor | 1d6 damage to caster |
| Failed by 11-25 | Major | 2d6 damage + Aether Sickness (2 turns) |
| Failed by 26+ | Catastrophic | 3d6 damage + Aether Sickness (5 turns) + Corruption +1 |

### Key Components

| Component | Layer | Description |
|-----------|-------|-------------|
| `IBacklashService` | Core/Interfaces | Risk evaluation contract |
| `BacklashService` | Engine/Services | Risk calculation and application |
| `BacklashResult` | Core/Models/Magic | Backlash outcome |
| `BacklashSeverity` | Core/Enums | Minor, Major, Catastrophic |
| `AetherSickness` | Status Effect | -2 Will, -1 Wits, prevents concentration |

### Decision Trees

1. **CheckBacklash**: Get Flux → Compare Threshold → Calculate Risk → Roll → Determine Trigger
2. **DetermineSeverity**: Roll - Risk difference → Map to severity enum
3. **ApplyBacklash**: Severity switch → Apply damage → Apply status → Increment corruption

### Aether Sickness Status Effect

```json
{
  "Type": "AetherSickness",
  "CanStack": false,
  "Effects": {
    "WillModifier": -2,
    "WitsModifier": -1,
    "BlocksConcentration": true
  },
  "Description": "The caster's mind reels from arcane feedback. Focus wavers."
}
```

### Corruption System

Corruption is tracked on the Character entity (0-100):

| Corruption Level | Threshold | Effect |
|------------------|-----------|--------|
| Untouched | 0-9 | No effect |
| Tainted | 10-24 | -1 max AP |
| Afflicted | 25-49 | -2 max AP, -1 Will |
| Blighted | 50-74 | -3 max AP, -2 Will, -1 Wits |
| Lost | 75-100 | Cannot cast spells (soul consumed) |

### Deliverables

- [ ] `IBacklashService.cs` - Interface with CheckBacklash, ApplyBacklash, GetCorruptionLevel
- [ ] `BacklashService.cs` - Full implementation
- [ ] `BacklashResult.cs` - Result with Triggered, Severity, Damage, Message
- [ ] `BacklashSeverity.cs` - Enum: None, Minor, Major, Catastrophic
- [ ] `CorruptionLevel.cs` - Enum: Untouched, Tainted, Afflicted, Blighted, Lost
- [ ] `AetherSickness.json` - Status effect definition (or code registration)
- [ ] Character entity extension - `CurrentCorruption` property
- [ ] MagicService integration - Call BacklashService before casting
- [ ] `BacklashServiceTests.cs` - 38 unit tests

### Test Categories (38 tests)

| Category | Tests | Description |
|----------|-------|-------------|
| Risk Calculation | 8 | Various Flux levels, threshold edge cases |
| Trigger Detection | 6 | Roll vs risk comparisons |
| Severity Determination | 6 | All severity levels and boundaries |
| Effect Application | 8 | Damage, status, corruption increment |
| Corruption Levels | 6 | All thresholds and effects |
| Integration | 4 | MagicService → BacklashService flow |

---

## v0.4.3e: The Resonance (Seeding & TUI Integration)

> **Goal:** Seed initial spell data, integrate with game loop, and implement TUI spell display.

### Scope

- **SpellSeeder**: Seed 8-12 starter spells across all schools
- **Combatant AP display**: Show AP in combat HUD
- **Flux display**: Show current Flux in combat HUD
- **Spell list UI**: Display available spells during combat
- **Cast command help**: Add `cast` to help system
- **GameLoop integration**: Handle `cast` command routing

### Starter Spells (Domain 4 Compliant)

| Name | School | AP | Flux | Effect | Description |
|------|--------|-----|------|--------|-------------|
| Spark | Destruction | 2 | 8 | DAMAGE:Fire:1d6 | "A whisper to the old fire-spirits, coaxing forth a tongue of flame." |
| Frost Touch | Destruction | 3 | 10 | DAMAGE:Cold:1d8 | "The caster's hand draws heat from flesh, leaving only the cold of the grave." |
| Mend Flesh | Restoration | 3 | 6 | HEAL:2d6 | "Ancient words spoken over wounds, knitting flesh as the elders once did." |
| Stone Skin | Alteration | 4 | 12 | STATUS:Fortified:3:2 | "The skin hardens like the Old Ones' shells—briefly proof against harm." |
| Weaken | Alteration | 3 | 8 | STATUS:Vulnerable:2 | "A curse that frays the target's defenses, leaving them open to harm." |
| Spirit Sight | Divination | 2 | 4 | STATUS:TrueSeeing:3 | "The caster's eyes cloud, then clear—seeing what others cannot." |
| Thunder Strike | Destruction | 5 | 15 | DAMAGE:Lightning:2d8 | "The sky's anger called down upon foes—a gift the Old Ones left behind." |
| Cleansing Light | Restoration | 4 | 10 | HEAL:1d8;STATUS:Cleansed:1 | "Pure radiance that burns away corruption and soothes the wounded." |

### TUI Components

**Combat HUD Extension:**
```
╭──────────────────────────────────────────────────────────╮
│ ERIK THE WANDERER                                        │
│ HP: ████████░░ 42/50   Stamina: ██████░░░░ 6/10         │
│ AP: ████░░░░░░ 4/10    Flux: ▓▓▓▓▓▓░░░░ [ELEVATED]      │
╰──────────────────────────────────────────────────────────╯
```

**Spell List Display (on `spells` command):**
```
╭─ KNOWN SPELLS ─────────────────────────────────────────╮
│ [1] Spark          (2 AP, 8 Flux)  - Destruction       │
│ [2] Mend Flesh     (3 AP, 6 Flux)  - Restoration       │
│ [3] Stone Skin     (4 AP, 12 Flux) - Alteration        │
╰────────────────────────────────────────────────────────╯
```

### Key Components

| Component | Layer | Description |
|-----------|-------|-------------|
| `SpellSeeder` | Infrastructure/Seeders | Initial spell data |
| `CombatHudRenderer` extension | Terminal/Rendering | AP and Flux display |
| `SpellListRenderer` | Terminal/Rendering | Spell list display |
| `CommandParser` extension | Terminal/Controllers | `spells` and `cast` routing |

### Deliverables

- [ ] `SpellSeeder.cs` - Seed 8+ starter spells with Domain 4 descriptions
- [ ] `CombatHudRenderer` modification - Add AP and Flux bars
- [ ] `SpellListRenderer.cs` - New renderer for spell list
- [ ] `CommandParser` modification - Add `cast` and `spells` commands
- [ ] Help system update - Document new commands
- [ ] `SpellSeederTests.cs` - Seeder validation tests
- [ ] `MagicIntegrationTests.cs` - End-to-end casting tests

### Test Categories (22 tests)

| Category | Tests | Description |
|----------|-------|-------------|
| Seeder | 6 | All spells seeded, idempotency, school coverage |
| TUI Rendering | 6 | AP bar, Flux bar, spell list display |
| Command Parsing | 6 | `cast`, `spells`, target parsing, help |
| Integration | 4 | Full cast cycle in game loop |

---

## Architecture Overview

### Service Dependency Graph

```
                    ┌─────────────────┐
                    │   GameService   │
                    └────────┬────────┘
                             │
              ┌──────────────┼──────────────┐
              │              │              │
              ▼              ▼              ▼
    ┌─────────────────┐ ┌─────────┐ ┌───────────────┐
    │  CombatService  │ │ GameLoop │ │ CommandParser │
    └────────┬────────┘ └─────────┘ └───────┬───────┘
             │                              │
    ┌────────┴────────────────┬─────────────┘
    │                         │
    ▼                         ▼
┌─────────────┐        ┌─────────────┐
│MagicService │◄───────│   Parser    │
└──────┬──────┘        │ (cast cmd)  │
       │               └─────────────┘
       │
┌──────┴──────┬──────────────┬──────────────┐
│             │              │              │
▼             ▼              ▼              ▼
┌───────────┐ ┌───────────┐ ┌───────────┐ ┌───────────────┐
│  Aether   │ │   Spell   │ │ Backlash  │ │ EffectScript  │
│  Service  │ │Repository │ │  Service  │ │   Executor    │
└───────────┘ └───────────┘ └───────────┘ └───────────────┘
```

### Data Flow: Cast Spell

```
Player Input: "cast spark on goblin"
         │
         ▼
    CommandParser
    (ExtractCast)
         │
         ├─── spell: "spark"
         └─── target: "goblin"
              │
              ▼
         MagicService
         .CastSpell()
              │
    ┌─────────┼─────────┬─────────────┐
    │         │         │             │
    ▼         ▼         ▼             ▼
SpellRepo  Resource  Backlash    EffectScript
.GetByName .CheckAp  .Check      .Execute
    │         │         │             │
    └─────────┼─────────┴─────────────┘
              │
              ▼
        AetherService
        .ModifyFlux()
              │
              ▼
         CombatLog
         + Events
```

---

## Cross-Cutting Concerns

### Logging Standards

All magic system components follow the established logging pattern:

| Service | Event | Level | Template |
|---------|-------|-------|----------|
| AetherService | FluxModified | Debug | `"Flux modified by {Source}: {Old} -> {New}"` |
| AetherService | FluxDissipated | Trace | `"Flux dissipated: {Old} -> {New}"` |
| AetherService | ThresholdCrossed | Info | `"Flux threshold changed: {OldThreshold} -> {NewThreshold}"` |
| MagicService | CastAttempt | Info | `"{Caster} attempting to cast {Spell} on {Target}"` |
| MagicService | CastSuccess | Info | `"{Caster} cast {Spell}. Damage: {Damage}, Flux: +{Flux}"` |
| MagicService | CastFailed | Debug | `"Cast failed: {Reason}"` |
| BacklashService | RiskCheck | Debug | `"Backlash check: Roll {Roll} vs Risk {Risk}"` |
| BacklashService | BacklashTriggered | Warning | `"BACKLASH! {Caster} suffers {Severity} backlash"` |
| BacklashService | CorruptionGained | Warning | `"{Character} corruption increased to {Level}"` |

### Event Bus Integration

| Event | Publisher | Consumers | Data |
|-------|-----------|-----------|------|
| `FluxChangedEvent` | AetherService | UI, Audio | OldValue, NewValue, Threshold |
| `SpellCastEvent` | MagicService | UI, Audio, Achievements | Caster, Spell, Target, Result |
| `BacklashEvent` | BacklashService | UI, Audio | Caster, Severity, Damage |
| `CorruptionChangedEvent` | BacklashService | UI | Character, OldLevel, NewLevel |

---

## Domain 4 Compliance

### Spell Description Guidelines

All spell flavor text must follow Domain 4 constraints:

**Forbidden:**
- Precision measurements ("deals 2d6 damage", "lasts 3 turns")
- Technical terminology ("mana", "cooldown", "proc")
- Modern language ("activate", "trigger", "buff")

**Required:**
- Archaeologist perspective ("the Old Ones knew...", "ancient texts speak of...")
- Sensory descriptions ("crackling", "searing", "bone-deep cold")
- Epistemic uncertainty ("appears to", "seems to", "the effect manifests as")

### Examples

❌ **Non-Compliant:**
> "Spark: Deals 1d6 fire damage to a single target. 2 AP cost, 8 Flux generated."

✅ **Compliant:**
> "Spark: A whisper to the old fire-spirits, coaxing forth a tongue of flame. The caster's fingers leave trails of heat in the air before the spark leaps to its mark."

### Backlash Narrative

❌ **Non-Compliant:**
> "Critical failure! You take 12 damage and gain the Aether Sickness debuff for 3 rounds."

✅ **Compliant:**
> "The weave rebels. Reality snaps back like a wounded beast, and agony lances through your skull. Your thoughts scatter like startled birds. Something is... wrong."

---

## Dependency Map

### New Files by Sub-Version

**v0.4.3a (The Aether):**
- `RuneAndRust.Core/Models/Magic/FluxState.cs`
- `RuneAndRust.Core/Enums/FluxThreshold.cs`
- `RuneAndRust.Core/Interfaces/IAetherService.cs`
- `RuneAndRust.Core/Events/FluxChangedEvent.cs`
- `RuneAndRust.Engine/Services/AetherService.cs`
- `RuneAndRust.Tests/Engine/Services/AetherServiceTests.cs`

**v0.4.3b (The Grimoire):**
- `RuneAndRust.Core/Entities/Spell.cs`
- `RuneAndRust.Core/Enums/SpellSchool.cs`
- `RuneAndRust.Core/Enums/SpellTargetType.cs`
- `RuneAndRust.Core/Enums/SpellRange.cs`
- `RuneAndRust.Core/Interfaces/ISpellRepository.cs`
- `RuneAndRust.Infrastructure/Repositories/SpellRepository.cs`
- `RuneAndRust.Infrastructure/Migrations/V043__CreateSpellTable.sql`
- `RuneAndRust.Tests/Infrastructure/Repositories/SpellRepositoryTests.cs`

**v0.4.3c (The Incantation):**
- `RuneAndRust.Core/Interfaces/IMagicService.cs`
- `RuneAndRust.Core/Models/Magic/MagicResult.cs`
- `RuneAndRust.Core/Enums/CastFailureReason.cs`
- `RuneAndRust.Core/Events/SpellCastEvent.cs`
- `RuneAndRust.Engine/Services/MagicService.cs`
- `RuneAndRust.Tests/Engine/Services/MagicServiceTests.cs`

**v0.4.3d (The Backlash):**
- `RuneAndRust.Core/Interfaces/IBacklashService.cs`
- `RuneAndRust.Core/Models/Magic/BacklashResult.cs`
- `RuneAndRust.Core/Enums/BacklashSeverity.cs`
- `RuneAndRust.Core/Enums/CorruptionLevel.cs`
- `RuneAndRust.Engine/Services/BacklashService.cs`
- `RuneAndRust.Tests/Engine/Services/BacklashServiceTests.cs`

**v0.4.3e (The Resonance):**
- `RuneAndRust.Infrastructure/Seeders/SpellSeeder.cs`
- `RuneAndRust.Terminal/Rendering/SpellListRenderer.cs`
- `RuneAndRust.Tests/Infrastructure/Seeders/SpellSeederTests.cs`
- `RuneAndRust.Tests/Integration/MagicIntegrationTests.cs`

### Modified Files

- `RuneAndRust.Core/Entities/Character.cs` - Add CurrentAp, MaxAp, CurrentCorruption
- `RuneAndRust.Core/Entities/Combatant.cs` - Already has AP fields
- `RuneAndRust.Engine/Services/CombatService.cs` - End-of-round Flux dissipation
- `RuneAndRust.Terminal/Controllers/CommandParser.cs` - `cast` and `spells` commands
- `RuneAndRust.Terminal/Rendering/CombatHudRenderer.cs` - AP and Flux display
- `RuneAndRust.Terminal/Program.cs` - DI registration

---

## Testing Strategy Summary

### Unit Tests by Service

| Test Class | Tests | Coverage Target |
|------------|-------|-----------------|
| AetherServiceTests | 28 | 95%+ |
| SpellRepositoryTests | 32 | 90%+ |
| MagicServiceTests | 45 | 95%+ |
| BacklashServiceTests | 38 | 95%+ |
| SpellSeederTests | 6 | 85%+ |

### Integration Tests

| Scenario | Components | Validation |
|----------|------------|------------|
| Full Cast Cycle | Parser → Magic → Aether → Effect | Spell resolved, Flux increased |
| Backlash Cycle | Magic → Backlash → Status | High Flux → Risk → Effect applied |
| Combat Round | Combat → Magic → Aether | Cast → End turn → Flux dissipates |
| Seeder Verification | Seeder → Repository | All spells queryable |

### Mocking Strategy

- **IDiceService**: Mock for deterministic backlash testing
- **ISpellRepository**: Mock for MagicService isolation
- **IAetherService**: Mock for BacklashService isolation
- **IEventBus**: Mock for event publishing verification

---

## Changelog Template

```markdown
## v0.4.3 - The Weaver (Magic Core)

**Release Date:** TBD

### Summary
Introduced the foundational magic system: environmental Flux tracking, spell definitions,
casting mechanics, and the risk/reward Backlash system.

### Features
- **Flux System**: Environmental magic volatility that accumulates with spellcasting and
  dissipates each round.
- **Spell Architecture**: New `Spell` entity with school classification, AP costs, and
  effect scripts.
- **Spellcasting**: New `cast` command for executing spells in combat.
- **Backlash Risk**: High-Flux casting triggers risk checks with escalating consequences.
- **Corruption Tracking**: Long-term consequence system for repeated backlash exposure.

### Technical
- Implemented `AetherService` for Flux state management (singleton).
- Created `MagicService` for spell execution orchestration.
- Added `BacklashService` for risk calculation and effect application.
- Integrated Flux dissipation into `CombatService` round-end processing.
- Extended `CommandParser` with `cast` and `spells` commands.

### Database
- Added `Spell` table with school, cost, and effect columns.
- Seeded 8 starter spells across all four schools.

### UI
- Added AP and Flux bars to combat HUD.
- New spell list display accessible via `spells` command.

### Testing
- 165 new unit tests across magic services.
- 4 integration tests for end-to-end casting validation.

### Domain 4 Compliance
- All spell descriptions use archaeologist perspective.
- Backlash narratives avoid precision measurements.
- Flux thresholds described qualitatively (Safe, Elevated, Critical, Overload).
```

---

## Next Steps

After approving this master plan:

1. **Expand v0.4.3a** with detailed decision trees, code examples, and test specifications
2. **Expand v0.4.3b** with entity definitions, migration scripts, and repository patterns
3. **Expand v0.4.3c** with full MagicService implementation and command parsing
4. **Expand v0.4.3d** with backlash mechanics and corruption system
5. **Expand v0.4.3e** with seeder code and TUI integration

Each sub-version will receive its own detailed markdown file following the established v0.4.2x pattern.
