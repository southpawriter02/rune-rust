# v0.16.4f Design Specification: Room Integration

## Document Information

| Field            | Value                                                                |
| ---------------- | -------------------------------------------------------------------- |
| Version          | v0.16.4f                                                             |
| Parent Version   | v0.16.4 - Container Loot Generation                                  |
| Epic             | v0.16.x - Advanced Loot & Proficiency Systems                        |
| Status           | Draft                                                                |
| Created          | 2025-01-27                                                           |
| Scope Breakdown  | [v0.16.4-scope-breakdown.md](v0.16.4-scope-breakdown.md)             |
| Previous Version | [v0.16.4e-design-specification.md](v0.16.4e-design-specification.md) |

---

## 1. Executive Summary

### 1.1 Overview

Version 0.16.4f introduces **Room Integration**, connecting the container loot system to the room/exploration system. This final sub-phase creates the `ContainerInfo` value object and adds container management methods to the `Room` entity, enabling discovery, listing, and interaction with containers.

### 1.2 Key Deliverables

| Category             | Count | Artifact          |
| -------------------- | ----- | ----------------- |
| Domain Value Objects | 1     | `ContainerInfo`   |
| Modified Entities    | 1     | Update `Room`     |
| Unit Tests           | ~1    | Integration tests |

### 1.3 Success Metrics

- Room lists all containers correctly
- Hidden containers require discovery to be revealed
- Container commands trigger loot generation
- Unit tests pass for room container operations

---

## 2. Feature Overview

### 2.1 Feature Tree

```
v0.16.4f: Room Integration
├── ContainerInfo Value Object
│   ├── Container ID reference
│   ├── Container type
│   ├── Current state
│   ├── Display name
│   └── IsHidden flag
├── Room Entity Extensions
│   ├── Containers collection
│   ├── GetContainers() → visible containers
│   ├── GetHiddenContainers() → undiscovered containers
│   ├── GetAllContainers() → all containers
│   ├── AddContainer(containerInfo)
│   ├── RevealContainer(containerId) → discover hidden
│   └── HasContainers property
└── Command Integration
    ├── Search command → discover hidden
    └── Open command → trigger loot
```

### 2.2 Scope Boundaries

**In Scope:**

- `ContainerInfo` value object for room-level container tracking
- Room entity extensions for container management
- Methods for listing visible/hidden containers
- Container discovery (reveal) mechanism
- Unit tests for room container operations

**Out of Scope:**

- UI rendering (future version)
- Command handler implementations (separate layer)
- Container placement/generation logic
- Trap mechanics

---

## 3. Architecture Diagrams

### 3.1 Component Integration Diagram

```
┌─────────────────────────────────────────────────────────────────────────┐
│                          DOMAIN LAYER                                    │
│                                                                          │
│  ┌─────────────────────────────────────────────────────────────────────┐│
│  │                         Room Entity                                  ││
│  │                                                                      ││
│  │  Existing Properties:                                                ││
│  │  • Id, Name, Description, Biome, etc.                                ││
│  │                                                                      ││
│  │  New Properties:                                                     ││
│  │  • IReadOnlyList<ContainerInfo> Containers                           ││
│  │  • bool HasContainers                                                ││
│  │                                                                      ││
│  │  New Methods:                                                        ││
│  │  • GetContainers() → IReadOnlyList<ContainerInfo>                    ││
│  │  • GetHiddenContainers() → IReadOnlyList<ContainerInfo>              ││
│  │  • GetAllContainers() → IReadOnlyList<ContainerInfo>                 ││
│  │  • AddContainer(ContainerInfo) → void                                ││
│  │  • RemoveContainer(Guid containerId) → bool                          ││
│  │  • RevealContainer(Guid containerId) → bool                          ││
│  │  • GetContainer(Guid containerId) → ContainerInfo?                   ││
│  └─────────────────────────────────────────────────────────────────────┘│
│                                  │                                       │
│                                  │ contains                              │
│                                  ▼                                       │
│  ┌─────────────────────────────────────────────────────────────────────┐│
│  │                     ContainerInfo Value Object                       ││
│  │                                                                      ││
│  │  • Guid ContainerId                                                  ││
│  │  • ContainerType Type                                                ││
│  │  • ContainerState State                                              ││
│  │  • string DisplayName                                                ││
│  │  • bool IsHidden                                                     ││
│  │  • int? DiscoveryDC                                                  ││
│  │                                                                      ││
│  │  + IsVisible → !IsHidden || State != Undiscovered                    ││
│  │  + CanInteract → IsVisible && State != Looted                        ││
│  │  + Reveal() → ContainerInfo (with IsHidden = false)                  ││
│  │  + UpdateState(ContainerState) → ContainerInfo                       ││
│  └─────────────────────────────────────────────────────────────────────┘│
└─────────────────────────────────────────────────────────────────────────┘
                                   │
                                   │ references
                                   ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                     From Previous Sub-Phases                             │
│                                                                          │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────────────┐  │
│  │ ContainerType   │  │ ContainerState  │  │ ContainerLootTable      │  │
│  │ (v0.16.4a)      │  │ (v0.16.4b)      │  │ (v0.16.4b)              │  │
│  └─────────────────┘  └─────────────────┘  └─────────────────────────┘  │
└─────────────────────────────────────────────────────────────────────────┘
```

### 3.2 Discovery Flow Diagram

```
┌──────────────────────────────────────────────────────────────────────────┐
│                      Player Searches Room                                │
└──────────────────────────────────────────────────────────────────────────┘
                                      │
                                      ▼
                         ┌────────────────────────┐
                         │ Get hidden containers  │
                         │ room.GetHiddenContainers()
                         └───────────┬────────────┘
                                     │
                         ┌───────────▼────────────┐
                         │ Any hidden containers? │
                         └───────────┬────────────┘
                              Yes    │    No
                         ┌───────────┴───────────┐
                         ▼                       ▼
              ┌──────────────────┐    ┌──────────────────┐
              │ For each hidden  │    │ "You find        │
              │ container:       │    │ nothing hidden." │
              │ Roll perception  │    └──────────────────┘
              └────────┬─────────┘
                       │
              ┌────────▼─────────┐
              │ Roll >= DC?      │
              └────────┬─────────┘
                Yes    │    No
              ┌────────┴────────┐
              ▼                 ▼
     ┌────────────────┐ ┌────────────────┐
     │ RevealContainer│ │ Container      │
     │ (containerId)  │ │ remains hidden │
     └────────┬───────┘ └────────────────┘
              │
              ▼
     ┌────────────────────┐
     │ "You discover a    │
     │ hidden cache!"     │
     └────────────────────┘
```

### 3.3 Container Interaction Flow

```
┌──────────────────────────────────────────────────────────────────────────┐
│                    Player: "open chest"                                  │
└──────────────────────────────────────────────────────────────────────────┘
                                      │
                                      ▼
                         ┌────────────────────────┐
                         │ Find container by name │
                         │ or type in room        │
                         └───────────┬────────────┘
                                     │
                         ┌───────────▼────────────┐
                         │ Container found?       │
                         └───────────┬────────────┘
                              Yes    │    No
                         ┌───────────┴───────────┐
                         ▼                       ▼
              ┌──────────────────┐    ┌──────────────────┐
              │ Check IsVisible  │    │ "There is no     │
              │                  │    │ chest here."     │
              └────────┬─────────┘    └──────────────────┘
                       │
              ┌────────▼─────────┐
              │ Check State      │
              └────────┬─────────┘
                       │
         ┌─────────────┼─────────────┐
         │             │             │
         ▼             ▼             ▼
    ┌─────────┐   ┌─────────┐   ┌─────────┐
    │ Locked  │   │Open/Disc│   │ Looted  │
    │         │   │         │   │         │
    │"It's    │   │Generate │   │"Already │
    │locked." │   │loot via │   │empty."  │
    └─────────┘   │service  │   └─────────┘
                  └────┬────┘
                       │
                       ▼
              ┌──────────────────┐
              │ Display contents │
              │ "Found: ..."     │
              └──────────────────┘
```

---

## 4. Feature Section: ContainerInfo Value Object

### 4.1 Purpose

The `ContainerInfo` value object provides a lightweight reference to a container for use in room descriptions and listings, without containing the full loot data.

### 4.2 Implementation

**File:** `src/Core/RuneAndRust.Domain/ValueObjects/ContainerInfo.cs`

```csharp
using RuneAndRust.Domain.Enums;

namespace RuneAndRust.Domain.ValueObjects;

/// <summary>
/// Represents container information for room-level display and interaction.
/// </summary>
/// <remarks>
/// This value object provides a lightweight view of a container for use in room
/// descriptions and listings. It does not contain actual loot data; that is
/// managed by the ContainerLootTable entity.
/// </remarks>
/// <param name="ContainerId">The unique identifier of the container.</param>
/// <param name="Type">The type of container.</param>
/// <param name="State">The current state of the container.</param>
/// <param name="DisplayName">The display name for the container.</param>
/// <param name="IsHidden">Whether the container requires discovery.</param>
/// <param name="DiscoveryDC">The difficulty class to discover, if hidden.</param>
public readonly record struct ContainerInfo(
    Guid ContainerId,
    ContainerType Type,
    ContainerState State,
    string DisplayName,
    bool IsHidden,
    int? DiscoveryDC)
{
    /// <summary>
    /// Gets whether this container is visible to the player.
    /// </summary>
    /// <remarks>
    /// A container is visible if it's not hidden, or if it was hidden but
    /// has already been discovered (state is not Undiscovered).
    /// </remarks>
    public bool IsVisible => !IsHidden || State != ContainerState.Undiscovered;

    /// <summary>
    /// Gets whether the player can interact with this container.
    /// </summary>
    /// <remarks>
    /// A container can be interacted with if it's visible and not already looted.
    /// </remarks>
    public bool CanInteract => IsVisible && State != ContainerState.Looted;

    /// <summary>
    /// Gets whether this container is empty (looted).
    /// </summary>
    public bool IsEmpty => State == ContainerState.Looted;

    /// <summary>
    /// Gets whether this container is locked.
    /// </summary>
    public bool IsLocked => State == ContainerState.Locked;

    /// <summary>
    /// Gets whether this container is open.
    /// </summary>
    public bool IsOpen => State == ContainerState.Open;

    /// <summary>
    /// Creates a new ContainerInfo with the container revealed.
    /// </summary>
    /// <returns>A new ContainerInfo with IsHidden = false and State = Discovered.</returns>
    public ContainerInfo Reveal() => this with
    {
        IsHidden = false,
        State = ContainerState.Discovered
    };

    /// <summary>
    /// Creates a new ContainerInfo with an updated state.
    /// </summary>
    /// <param name="newState">The new container state.</param>
    /// <returns>A new ContainerInfo with the updated state.</returns>
    public ContainerInfo UpdateState(ContainerState newState) => this with
    {
        State = newState
    };

    /// <summary>
    /// Creates a ContainerInfo from a ContainerLootTable entity.
    /// </summary>
    /// <param name="container">The container entity.</param>
    /// <param name="displayName">The display name for the container.</param>
    /// <param name="isHidden">Whether the container is hidden.</param>
    /// <param name="discoveryDC">The discovery DC if hidden.</param>
    /// <returns>A new ContainerInfo representing the container.</returns>
    public static ContainerInfo FromEntity(
        ContainerLootTable container,
        string displayName,
        bool isHidden = false,
        int? discoveryDC = null)
    {
        ArgumentNullException.ThrowIfNull(container);
        ArgumentException.ThrowIfNullOrWhiteSpace(displayName);

        return new ContainerInfo(
            container.Id,
            container.Type,
            container.State,
            displayName,
            isHidden,
            discoveryDC);
    }

    /// <summary>
    /// Creates a ContainerInfo with validation.
    /// </summary>
    public static ContainerInfo Create(
        Guid containerId,
        ContainerType type,
        ContainerState state,
        string displayName,
        bool isHidden = false,
        int? discoveryDC = null)
    {
        ArgumentException.ThrowIfNullOrWhiteSpace(displayName);

        if (isHidden && !discoveryDC.HasValue)
        {
            throw new ArgumentException(
                "Hidden containers must have a discovery DC.",
                nameof(discoveryDC));
        }

        return new ContainerInfo(
            containerId,
            type,
            state,
            displayName,
            isHidden,
            discoveryDC);
    }

    /// <inheritdoc />
    public override string ToString() =>
        $"{DisplayName} ({Type}, {State})" +
        (IsHidden ? $" [Hidden, DC {DiscoveryDC}]" : "");
}
```

### 4.3 Design Decisions

| Decision                         | Rationale                                            |
| -------------------------------- | ---------------------------------------------------- |
| `readonly record struct`         | Immutable value semantics, efficient for collections |
| Separate from ContainerLootTable | Room doesn't need full loot data                     |
| `with` expressions for updates   | Immutable state transitions                          |
| Factory from entity              | Easy conversion from full entity                     |
| Hidden requires DC               | Validation ensures hidden containers are searchable  |

---

## 5. Feature Section: Room Entity Extensions

### 5.1 Purpose

Extensions to the Room entity enable container management, including listing, discovery, and state synchronization.

### 5.2 Implementation

**File:** `src/Core/RuneAndRust.Domain/Entities/Room.cs` (partial, additions only)

```csharp
using RuneAndRust.Domain.Enums;
using RuneAndRust.Domain.ValueObjects;

namespace RuneAndRust.Domain.Entities;

// Existing Room entity with container extensions
public partial class Room
{
    private readonly List<ContainerInfo> _containers = new();

    /// <summary>
    /// Gets all containers in this room.
    /// </summary>
    public IReadOnlyList<ContainerInfo> Containers => _containers.AsReadOnly();

    /// <summary>
    /// Gets whether this room has any containers.
    /// </summary>
    public bool HasContainers => _containers.Count > 0;

    /// <summary>
    /// Gets whether this room has any visible containers.
    /// </summary>
    public bool HasVisibleContainers => _containers.Any(c => c.IsVisible);

    /// <summary>
    /// Gets whether this room has any hidden containers.
    /// </summary>
    public bool HasHiddenContainers => _containers.Any(c => c.IsHidden && !c.IsVisible);

    /// <summary>
    /// Gets all visible containers in this room.
    /// </summary>
    /// <returns>Containers that are not hidden or have been discovered.</returns>
    public IReadOnlyList<ContainerInfo> GetContainers()
    {
        return _containers
            .Where(c => c.IsVisible)
            .ToList()
            .AsReadOnly();
    }

    /// <summary>
    /// Gets all hidden (undiscovered) containers in this room.
    /// </summary>
    /// <returns>Containers that are hidden and not yet discovered.</returns>
    public IReadOnlyList<ContainerInfo> GetHiddenContainers()
    {
        return _containers
            .Where(c => c.IsHidden && !c.IsVisible)
            .ToList()
            .AsReadOnly();
    }

    /// <summary>
    /// Gets all containers regardless of visibility.
    /// </summary>
    /// <returns>All containers in this room.</returns>
    public IReadOnlyList<ContainerInfo> GetAllContainers()
    {
        return _containers.AsReadOnly();
    }

    /// <summary>
    /// Gets a specific container by ID.
    /// </summary>
    /// <param name="containerId">The container ID to find.</param>
    /// <returns>The container info, or null if not found.</returns>
    public ContainerInfo? GetContainer(Guid containerId)
    {
        var index = _containers.FindIndex(c => c.ContainerId == containerId);
        return index >= 0 ? _containers[index] : null;
    }

    /// <summary>
    /// Adds a container to this room.
    /// </summary>
    /// <param name="container">The container info to add.</param>
    /// <exception cref="InvalidOperationException">
    /// Thrown if a container with the same ID already exists.
    /// </exception>
    public void AddContainer(ContainerInfo container)
    {
        if (_containers.Any(c => c.ContainerId == container.ContainerId))
        {
            throw new InvalidOperationException(
                $"Container {container.ContainerId} already exists in this room.");
        }

        _containers.Add(container);
    }

    /// <summary>
    /// Removes a container from this room.
    /// </summary>
    /// <param name="containerId">The container ID to remove.</param>
    /// <returns>True if the container was removed, false if not found.</returns>
    public bool RemoveContainer(Guid containerId)
    {
        var index = _containers.FindIndex(c => c.ContainerId == containerId);
        if (index < 0)
        {
            return false;
        }

        _containers.RemoveAt(index);
        return true;
    }

    /// <summary>
    /// Reveals a hidden container, making it visible.
    /// </summary>
    /// <param name="containerId">The container ID to reveal.</param>
    /// <returns>True if the container was revealed, false if not found or already visible.</returns>
    public bool RevealContainer(Guid containerId)
    {
        var index = _containers.FindIndex(c => c.ContainerId == containerId);
        if (index < 0)
        {
            return false;
        }

        var container = _containers[index];
        if (container.IsVisible)
        {
            return false; // Already visible
        }

        _containers[index] = container.Reveal();
        return true;
    }

    /// <summary>
    /// Updates a container's state.
    /// </summary>
    /// <param name="containerId">The container ID to update.</param>
    /// <param name="newState">The new state.</param>
    /// <returns>True if updated, false if not found.</returns>
    public bool UpdateContainerState(Guid containerId, ContainerState newState)
    {
        var index = _containers.FindIndex(c => c.ContainerId == containerId);
        if (index < 0)
        {
            return false;
        }

        _containers[index] = _containers[index].UpdateState(newState);
        return true;
    }

    /// <summary>
    /// Gets containers that can be interacted with.
    /// </summary>
    /// <returns>Visible containers that are not looted.</returns>
    public IReadOnlyList<ContainerInfo> GetInteractableContainers()
    {
        return _containers
            .Where(c => c.CanInteract)
            .ToList()
            .AsReadOnly();
    }

    /// <summary>
    /// Finds a container by display name (case-insensitive partial match).
    /// </summary>
    /// <param name="name">The name or partial name to search.</param>
    /// <returns>The first matching visible container, or null.</returns>
    public ContainerInfo? FindContainerByName(string name)
    {
        if (string.IsNullOrWhiteSpace(name))
        {
            return null;
        }

        return _containers
            .Where(c => c.IsVisible)
            .FirstOrDefault(c =>
                c.DisplayName.Contains(name, StringComparison.OrdinalIgnoreCase) ||
                c.Type.ToString().Contains(name, StringComparison.OrdinalIgnoreCase));
    }
}
```

### 5.3 Design Decisions

| Decision             | Rationale                                  |
| -------------------- | ------------------------------------------ |
| Private mutable list | Encapsulates container management          |
| ReadOnly returns     | Prevents external modification             |
| Index-based updates  | Value objects require in-place replacement |
| Name search          | Supports natural language commands         |
| Partial class        | Extensions to existing Room entity         |

---

## 6. Command Examples

### 6.1 Search Command

```
> search
You search the room carefully...

Perception check: 16 vs DC 14 - Success!

You discover a hidden cache concealed behind loose stones!
```

### 6.2 Open Command

```
> open chest
You open the small chest...

Found:
  • Iron Sword (Scavenged)
  • 23 gold pieces
```

### 6.3 Open Empty Container

```
> open chest
The chest is empty. It has already been looted.
```

### 6.4 Look Command (with containers)

```
> look
The dusty storage room contains forgotten supplies.

You see:
  • A small chest (closed)
  • A supply crate (closed)
  • An armor stand (empty)

Exits: north, east
```

---

## 7. Data Model Changes

### 7.1 New Value Objects

| Value Object    | File Path                                                   | Purpose                  |
| --------------- | ----------------------------------------------------------- | ------------------------ |
| `ContainerInfo` | `src/Core/RuneAndRust.Domain/ValueObjects/ContainerInfo.cs` | Room container reference |

### 7.2 Modified Entities

| Entity | File Path                                      | Changes                          |
| ------ | ---------------------------------------------- | -------------------------------- |
| `Room` | `src/Core/RuneAndRust.Domain/Entities/Room.cs` | Add container collection/methods |

---

## 8. Logging Specifications

| Component       | Level       | Event                                                |
| --------------- | ----------- | ---------------------------------------------------- |
| Room            | Debug       | "Added container {ContainerId} to room {RoomId}"     |
| Room            | Debug       | "Removed container {ContainerId} from room {RoomId}" |
| Room            | Information | "Container {ContainerId} revealed in room {RoomId}"  |
| Room            | Debug       | "Container {ContainerId} state updated to {State}"   |
| Command Handler | Information | "Player searching room {RoomId}"                     |
| Command Handler | Information | "Player discovered hidden container {ContainerId}"   |
| Command Handler | Information | "Player looted container {ContainerId}"              |

---

## 9. Unit Testing Requirements

### 9.1 Test Summary

| Test Class           | Test Count | Focus Area                |
| -------------------- | ---------- | ------------------------- |
| `ContainerInfoTests` | ~1         | Value object behavior     |
| `RoomContainerTests` | ~1         | Room container operations |

### 9.2 Test Specifications

**File:** `tests/RuneAndRust.Domain.UnitTests/ValueObjects/ContainerInfoTests.cs`

```csharp
using FluentAssertions;
using NUnit.Framework;
using RuneAndRust.Domain.Enums;
using RuneAndRust.Domain.ValueObjects;

namespace RuneAndRust.Domain.UnitTests.ValueObjects;

[TestFixture]
public class ContainerInfoTests
{
    [Test]
    public void IsVisible_WhenHiddenAndUndiscovered_ReturnsFalse()
    {
        // Arrange
        var container = ContainerInfo.Create(
            Guid.NewGuid(),
            ContainerType.HiddenCache,
            ContainerState.Undiscovered,
            "Hidden Cache",
            isHidden: true,
            discoveryDC: 14);

        // Act & Assert
        container.IsVisible.Should().BeFalse();
        container.CanInteract.Should().BeFalse();
    }

    [Test]
    public void Reveal_ChangesStateToDiscovered()
    {
        // Arrange
        var container = ContainerInfo.Create(
            Guid.NewGuid(),
            ContainerType.HiddenCache,
            ContainerState.Undiscovered,
            "Hidden Cache",
            isHidden: true,
            discoveryDC: 14);

        // Act
        var revealed = container.Reveal();

        // Assert
        revealed.IsHidden.Should().BeFalse();
        revealed.State.Should().Be(ContainerState.Discovered);
        revealed.IsVisible.Should().BeTrue();
    }
}
```

**File:** `tests/RuneAndRust.Domain.UnitTests/Entities/RoomContainerTests.cs`

```csharp
using FluentAssertions;
using NUnit.Framework;
using RuneAndRust.Domain.Entities;
using RuneAndRust.Domain.Enums;
using RuneAndRust.Domain.ValueObjects;

namespace RuneAndRust.Domain.UnitTests.Entities;

[TestFixture]
public class RoomContainerTests
{
    [Test]
    public void GetContainers_ReturnsOnlyVisibleContainers()
    {
        // Arrange
        var room = CreateTestRoom();

        var visibleContainer = ContainerInfo.Create(
            Guid.NewGuid(),
            ContainerType.SmallChest,
            ContainerState.Discovered,
            "Small Chest",
            isHidden: false,
            discoveryDC: null);

        var hiddenContainer = ContainerInfo.Create(
            Guid.NewGuid(),
            ContainerType.HiddenCache,
            ContainerState.Undiscovered,
            "Hidden Cache",
            isHidden: true,
            discoveryDC: 14);

        room.AddContainer(visibleContainer);
        room.AddContainer(hiddenContainer);

        // Act
        var visible = room.GetContainers();
        var hidden = room.GetHiddenContainers();

        // Assert
        visible.Should().HaveCount(1);
        visible[0].ContainerId.Should().Be(visibleContainer.ContainerId);

        hidden.Should().HaveCount(1);
        hidden[0].ContainerId.Should().Be(hiddenContainer.ContainerId);
    }

    [Test]
    public void RevealContainer_MakesHiddenContainerVisible()
    {
        // Arrange
        var room = CreateTestRoom();

        var hiddenContainer = ContainerInfo.Create(
            Guid.NewGuid(),
            ContainerType.HiddenCache,
            ContainerState.Undiscovered,
            "Hidden Cache",
            isHidden: true,
            discoveryDC: 14);

        room.AddContainer(hiddenContainer);

        // Act
        var result = room.RevealContainer(hiddenContainer.ContainerId);

        // Assert
        result.Should().BeTrue();
        room.GetContainers().Should().HaveCount(1);
        room.GetHiddenContainers().Should().BeEmpty();
    }

    private static Room CreateTestRoom()
    {
        // Create a test room (implementation depends on existing Room factory)
        return Room.Create("Test Room", "A test room.", BiomeType.TheRoots);
    }
}
```

---

## 10. Use Cases

### UC-001: List Room Containers

| Field   | Value                                                                                                                                       |
| ------- | ------------------------------------------------------------------------------------------------------------------------------------------- |
| Actor   | Player                                                                                                                                      |
| Trigger | Player uses "look" command                                                                                                                  |
| Flow    | 1. Get room's visible containers via GetContainers()<br>2. Display container list in room description<br>3. Show container types and states |
| Outcome | Player sees list of available containers                                                                                                    |

### UC-002: Discover Hidden Container

| Field   | Value                                                                                                                                                                                |
| ------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ |
| Actor   | Player                                                                                                                                                                               |
| Trigger | Player uses "search" command                                                                                                                                                         |
| Flow    | 1. Get hidden containers via GetHiddenContainers()<br>2. For each hidden container, roll perception vs DC<br>3. On success, call RevealContainer(id)<br>4. Display discovery message |
| Outcome | Hidden container becomes visible for interaction                                                                                                                                     |

### UC-003: Open Container

| Field   | Value                                                                                                                                                                                        |
| ------- | -------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| Actor   | Player                                                                                                                                                                                       |
| Trigger | Player uses "open [container]" command                                                                                                                                                       |
| Flow    | 1. Find container by name via FindContainerByName()<br>2. Check CanInteract<br>3. Generate loot via IContainerLootService<br>4. Update container state to Open/Looted<br>5. Display contents |
| Outcome | Player receives container contents                                                                                                                                                           |

---

## 11. Deliverable Checklist

### 11.1 Domain Layer

- [ ] `ContainerInfo` value object (`src/Core/RuneAndRust.Domain/ValueObjects/ContainerInfo.cs`)
- [ ] Room entity container extensions (`src/Core/RuneAndRust.Domain/Entities/Room.cs`)

### 11.2 Tests

- [ ] `ContainerInfoTests` (`tests/RuneAndRust.Domain.UnitTests/ValueObjects/ContainerInfoTests.cs`)
- [ ] `RoomContainerTests` (`tests/RuneAndRust.Domain.UnitTests/Entities/RoomContainerTests.cs`)

---

## 12. Acceptance Criteria

### 12.1 Functional Criteria

| ID    | Criterion                                      | Verification |
| ----- | ---------------------------------------------- | ------------ |
| AC-01 | Room lists all visible containers              | Unit test    |
| AC-02 | Hidden containers require discovery            | Unit test    |
| AC-03 | RevealContainer makes hidden container visible | Unit test    |
| AC-04 | FindContainerByName returns matching container | Unit test    |
| AC-05 | Container state updates correctly              | Unit test    |

### 12.2 Quality Criteria

| ID    | Criterion                      | Verification    |
| ----- | ------------------------------ | --------------- |
| QC-01 | All code has XML documentation | Code inspection |
| QC-02 | ~1 unit test passes            | Test execution  |
| QC-03 | Value object is immutable      | Code review     |

---

## 13. Dependencies

### 13.1 Prerequisites

| Dependency | Description                               | Status   |
| ---------- | ----------------------------------------- | -------- |
| v0.16.4a   | ContainerType enum                        | Complete |
| v0.16.4b   | ContainerState enum, ContainerLootTable   | Complete |
| v0.16.4d   | IContainerLootService for loot generation | Complete |
| v0.16.4e   | IContainerStateRepository for persistence | Complete |
| Existing   | Room entity exists                        | Complete |

### 13.2 Provides To

| Consumer | Description                    |
| -------- | ------------------------------ |
| v0.16.5  | Corpse loot integration        |
| Commands | Search, open, look commands    |
| UI       | Container display in room view |

---

## 14. Future Considerations

### 14.1 Deferred to Future Versions

- **UI Rendering**: Visual representation of containers in GUI
- **Command Handlers**: Full implementation of search/open commands
- **Container Placement**: Procedural container generation in rooms
- **Trap Integration**: Trapped containers requiring disarm checks

### 14.2 Potential Future Enhancements

- Container highlight in room description
- Container weight and inventory limits
- Lock complexity and lockpicking minigame
- Container mimic enemies
- Interactive container inspection
