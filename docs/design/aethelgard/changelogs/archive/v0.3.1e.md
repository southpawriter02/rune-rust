> **Archived** - This changelog has been consolidated. See the complete version at [v0.3.1](../v0.3.x/v0.3.1.md).

# v0.3.1e Changelog: PostgreSQL Integration Tests

**Release Date:** December 20, 2025
**Total Tests:** 1733 (all passing)

---

## Summary

Version 0.3.1e adds **PostgreSQL-specific integration tests** that validate database behavior beyond what the InMemory provider can test. These tests run against a real PostgreSQL instance (via Docker) and verify JSONB column persistence, constraint enforcement, transaction handling, and cascade delete behavior.

Key additions:
- **PostgreSQL Test Fixture**: Isolated test database per test run with automatic cleanup
- **JSONB Query Tests**: Validates complex dictionary/object serialization
- **Constraint Validation Tests**: Verifies unique indexes, foreign keys, and cascade deletes
- **Transaction Tests**: Tests commit, rollback, savepoints, and concurrent access

---

## New Test Categories

### PostgreSQL Test Fixture

The `PostgreSqlTestFixture` class provides isolated PostgreSQL testing:

- Creates a unique database for each test run (`RuneAndRust_Test_{GUID}`)
- Automatically applies EF Core migrations
- Terminates connections and drops database on cleanup
- Each test uses `CreateContext()` for proper isolation

```csharp
public class PostgreSqlTestFixture : IAsyncLifetime
{
    public async Task InitializeAsync()
    {
        // Create unique test database
        await masterContext.Database.ExecuteSqlRawAsync($"CREATE DATABASE \"{_testDatabaseName}\"");

        // Apply migrations
        using var migrationContext = CreateContext();
        await migrationContext.Database.MigrateAsync();
    }

    public async Task DisposeAsync()
    {
        // Terminate connections and drop database
        await masterContext.Database.ExecuteSqlRawAsync($"DROP DATABASE IF EXISTS \"{_testDatabaseName}\"");
    }
}
```

### JSONB Query Tests (9 tests)

Validates PostgreSQL JSONB column persistence for complex data types:

| Test | Entity | JSONB Column |
|------|--------|--------------|
| `Room_Exits_PersistsJsonbDictionary` | Room | Exits (Direction -> Guid) |
| `Room_Exits_UpdatesJsonbDictionary` | Room | Exits update behavior |
| `Room_Exits_EmptyDictionaryPersists` | Room | Empty dictionary handling |
| `Character_EquipmentBonuses_PersistsJsonbDictionary` | Character | EquipmentBonuses |
| `Equipment_AttributeBonuses_PersistsJsonbDictionary` | Equipment | AttributeBonuses, Requirements |
| `ItemProperty_StatModifiers_PersistsJsonbDictionary` | ItemProperty | StatModifiers |
| `ItemProperty_MultipleProperties_PersistIndependently` | Item/ItemProperty | Multiple properties |
| `CodexEntry_UnlockThresholds_PersistsJsonbDictionary` | CodexEntry | UnlockThresholds |
| `SaveGame_SerializedState_PersistsLargeJsonb` | SaveGame | SerializedState (large JSON) |

### Constraint Validation Tests (13 tests)

Verifies PostgreSQL constraint enforcement:

**Unique Constraints (SqlState 23505):**
| Test | Entity | Constraint |
|------|--------|------------|
| `Character_Name_UniqueConstraintEnforced` | Character | IX_Characters_Name |
| `SaveGame_SlotNumber_UniqueConstraintEnforced` | SaveGame | IX_SaveGames_SlotNumber |
| `CodexEntry_Title_UniqueConstraintEnforced` | CodexEntry | IX_CodexEntries_Title |
| `ActiveAbility_Name_UniqueConstraintEnforced` | ActiveAbility | IX_ActiveAbilities_Name |

**Foreign Key Constraints (SqlState 23503):**
| Test | Validates |
|------|-----------|
| `InventoryItem_RequiresValidCharacter` | InventoryItem.CharacterId FK |
| `InventoryItem_RequiresValidItem` | InventoryItem.ItemId FK |
| `DataCapture_CodexEntryId_AllowsNull` | Nullable FK behavior |

**Cascade Deletes:**
| Test | Validates |
|------|-----------|
| `Character_Delete_CascadesInventoryItems` | Character -> InventoryItems cascade |
| `Item_Delete_CascadesItemProperties` | Item -> ItemProperties cascade |

**Required Fields:**
| Test | Validates |
|------|-----------|
| `Room_Name_Required` | Room.Name NOT NULL |
| `Item_Description_Required` | Item.Description NOT NULL |

**TPH Inheritance:**
| Test | Validates |
|------|-----------|
| `TPH_Equipment_LoadsCorrectType` | Equipment loads as Equipment type |
| `TPH_Item_LoadsCorrectType` | Item loads as Item type (not Equipment) |

### Transaction Tests (7 tests)

Validates PostgreSQL transaction behavior:

| Test | Validates |
|------|-----------|
| `Transaction_Commit_PersistsAllChanges` | Explicit commit persists data |
| `Transaction_Rollback_DiscardsAllChanges` | Explicit rollback discards data |
| `Transaction_Dispose_WithoutCommit_RollsBack` | Implicit rollback on dispose |
| `Transaction_PartialFailure_RollsBackAll` | Constraint violation rolls back all changes |
| `Transaction_Savepoint_AllowsPartialRollback` | Savepoints enable partial rollback |
| `Transaction_ConcurrentReads_SeeCommittedData` | Read committed isolation level |
| `Transaction_BulkInsert_HandlesLargeDataset` | 100 items in single transaction |

---

## Files Created

| File | Purpose |
|------|---------|
| `RuneAndRust.Tests/Integration/PostgreSQL/PostgreSqlTestFixture.cs` | Test fixture with database lifecycle |
| `RuneAndRust.Tests/Integration/PostgreSQL/JsonbQueryTests.cs` | JSONB persistence tests |
| `RuneAndRust.Tests/Integration/PostgreSQL/ConstraintValidationTests.cs` | Constraint enforcement tests |
| `RuneAndRust.Tests/Integration/PostgreSQL/TransactionTests.cs` | Transaction behavior tests |
| `docs/changelogs/v0.3.1e.md` | This changelog |

---

## Key Implementation Details

### Test Isolation Pattern

Each test creates its own DbContext to prevent state pollution:

```csharp
[Fact]
public async Task SomeTest()
{
    // Arrange - Create context for setup
    using var context = _fixture.CreateContext();

    // ... create entities ...
    await context.SaveChangesAsync();

    // Assert - Fresh context for verification
    using var freshContext = _fixture.CreateContext();
    var loaded = await freshContext.Entities.FindAsync(id);
    loaded.Should().NotBeNull();
}
```

### JSONB Change Detection

EF Core's value conversion doesn't track in-place dictionary modifications. Tests demonstrate the correct pattern:

```csharp
// WRONG - Changes not detected
room.Exits[Direction.West] = newId;

// CORRECT - Create new dictionary to trigger change detection
var updatedExits = new Dictionary<Direction, Guid>(room.Exits);
updatedExits[Direction.West] = newId;
room.Exits = updatedExits;
```

### PostgresException SqlState Codes

| Code | Meaning |
|------|---------|
| 23505 | Unique constraint violation |
| 23503 | Foreign key violation |
| 23502 | NOT NULL violation |

---

## Test Execution

### Prerequisites

1. Docker container running:
   ```bash
   docker-compose up -d
   ```

2. Database initialized:
   ```bash
   dotnet ef database update --project RuneAndRust.Persistence --startup-project RuneAndRust.Persistence
   ```

### Running PostgreSQL Tests Only

```bash
dotnet test RuneAndRust.Tests --filter "Category=PostgreSQL" -v n
```

### Running All Tests

```bash
dotnet test RuneAndRust.Tests
```

---

## Test Architecture Summary

| Test Type | Count | Database |
|-----------|-------|----------|
| Unit Tests | 1567 | Mocked dependencies |
| Integration Tests (InMemory) | 137 | EF Core InMemory provider |
| Integration Tests (PostgreSQL) | 29 | Real PostgreSQL via Docker |
| **Total** | **1733** | All passing |

---

## Build Verification

```
Build succeeded.
    0 Error(s)

Test Results:
  Passed: 1733
  Failed: 0
  Skipped: 0

PostgreSQL Container:
  Status: Running (healthy)
  Port: 5433
  Test Database: Created/Dropped per test run
```

---

## Directory Structure After v0.3.1e

```
RuneAndRust/
├── RuneAndRust.Tests/
│   └── Integration/
│       └── PostgreSQL/
│           ├── PostgreSqlTestFixture.cs           [NEW]
│           ├── JsonbQueryTests.cs                 [NEW]
│           ├── ConstraintValidationTests.cs       [NEW]
│           └── TransactionTests.cs                [NEW]
└── docs/
    └── changelogs/
        ├── v0.3.1a.md
        ├── v0.3.1b.md
        ├── v0.3.1c.md
        ├── v0.3.1d.md
        └── v0.3.1e.md                             [NEW]
```

---

## Why PostgreSQL-Specific Tests?

The InMemory provider has limitations that PostgreSQL-specific tests address:

| Feature | InMemory | PostgreSQL |
|---------|----------|------------|
| JSONB serialization | Stores in memory | Tests actual JSONB column type |
| Unique constraints | Not enforced | Fully enforced (SqlState 23505) |
| Foreign key constraints | Not enforced | Fully enforced (SqlState 23503) |
| Transactions | Limited support | Full ACID compliance |
| Savepoints | Not supported | Fully supported |
| Concurrent access | Single-threaded | Multi-connection isolation |

---

## Dependencies

| Package | Version | Purpose |
|---------|---------|---------|
| Npgsql.EntityFrameworkCore.PostgreSQL | 9.0.4 | PostgreSQL EF Core provider |
| Npgsql | (transitive) | PostgresException for SqlState checking |
| FluentAssertions | 8.x | Test assertions |
| xUnit | 2.9.x | Test framework |

---

## Next Steps (v0.3.2)

Potential features for the next release:
- Database seeding with starter content
- Save/Load game functionality
- Connection pooling configuration
- Query performance tests with EXPLAIN ANALYZE
