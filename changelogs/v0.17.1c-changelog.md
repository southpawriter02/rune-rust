# Changelog: v0.17.1c - Background Equipment Grants

**Release Date:** 2026-01-29
**Phase:** Background System (3/5)
**Status:** Complete

---

## Overview

Implements equipment grants for the Background system. Each background now grants profession-appropriate starting equipment that may be auto-equipped to specific slots or placed in the character's inventory. This adds the `BackgroundEquipmentGrant` value object and extends `BackgroundDefinition` with equipment grant properties and helper methods.

Equipment grants support three categories: auto-equipped items (weapons, armor, shields placed into equipment slots), inventory-only items (tools, utility items), and consumables (stackable items like bandages and rations with quantity greater than 1).

---

## Added

### Domain Layer

#### Value Objects

- **`BackgroundEquipmentGrant`** (`ValueObjects/BackgroundEquipmentGrant.cs`)
    - `readonly record struct` with `ItemId`, `Quantity`, `IsEquipped`, `Slot` (`EquipmentSlot?`)
    - Factory method `Create(...)` with full validation:
        - Null/whitespace itemId throws `ArgumentException`
        - Quantity less than 1 throws `ArgumentOutOfRangeException`
        - IsEquipped true without Slot throws `ArgumentException`
        - Normalizes itemId to lowercase via `ToLowerInvariant()`
    - Convenience factory methods:
        - `Equipped(itemId, slot)`: Creates an auto-equip grant (quantity 1)
        - `Inventory(itemId, quantity)`: Creates an inventory-only grant
        - `Consumable(itemId, quantity)`: Creates a consumable inventory grant
    - Computed properties:
        - `HasAutoEquip`: True if IsEquipped and Slot has a value
        - `IsStackable`: True if Quantity is greater than 1
        - `IsInventoryOnly`: True if IsEquipped is false
    - `ToString()` formats as "itemId", "itemId xN" (stackable), or "itemId (SlotName)" (equipped)
    - Structured logging at Debug, Warning, and Information levels during creation

### Entity Extensions

- **`BackgroundDefinition`** (`Entities/BackgroundDefinition.cs`) — Extended
    - Added `EquipmentGrants` property (`IReadOnlyList<BackgroundEquipmentGrant>`)
    - Updated private constructor with default: `EquipmentGrants = Array.Empty<BackgroundEquipmentGrant>()`
    - Updated `Create()` factory: added `equipmentGrants` optional parameter
    - Added equipment grant helper methods:
        - `HasEquipmentGrants()`: Returns true if any equipment grants exist
        - `GetEquippedItems()`: Returns grants with IsEquipped true (for auto-equip at creation)
        - `GetInventoryItems()`: Returns grants with IsEquipped false (inventory-only items)
        - `GetTotalItemCount()`: Sum of all quantities across all grants
        - `GetEquipmentGrantSummary()`: Comma-separated display string (e.g., "shield (Shield), spear (Weapon)")
    - Updated `ToString()` to include `Equipment={count}`
    - Updated logging to include EquipmentGrantCount
    - Version header bumped to 0.17.1c

### Configuration Files

- **`config/backgrounds.json`** — Updated
    - Added `equipmentGrants` array to all 6 backgrounds:
        - Village Smith: smiths-hammer (Weapon, equipped), leather-apron (Armor, equipped)
        - Traveling Healer: healers-kit (inventory), bandages x5 (inventory)
        - Ruin Delver: lantern (inventory), rope (inventory), lockpicks (inventory)
        - Clan Guard: shield (Shield, equipped), spear (Weapon, equipped)
        - Wandering Skald: instrument (inventory), journal (inventory)
        - Outcast Scavenger: rations x3 (inventory), travel-cloak (Armor, equipped)

- **`config/schemas/backgrounds.schema.json`** — Updated
    - Added `equipmentGrant` definition to `$defs` with:
        - `itemId`: pattern `^[a-z][a-z0-9-]*$`, maxLength 50
        - `quantity`: integer, minimum 1, maximum 99
        - `isEquipped`: boolean (required)
        - `slot`: nullable string enum matching `EquipmentSlot` values (Weapon, Armor, Shield, Helmet, Boots, Ring, Amulet)
    - Added `equipmentGrants` array property to `backgroundDefinition` (maxItems: 10)

### Unit Tests

- **`BackgroundEquipmentGrantTests`** (`ValueObjects/BackgroundEquipmentGrantTests.cs`) — 16 tests
    - `Create_WithValidParameters_CreatesGrant`: Full creation with all properties
    - `Create_WithNullItemId_ThrowsArgumentException`: Null validation
    - `Create_WithEmptyItemId_ThrowsArgumentException`: Empty string validation
    - `Create_WithWhitespaceItemId_ThrowsArgumentException`: Whitespace validation
    - `Create_WithZeroQuantity_ThrowsArgumentOutOfRangeException`: Zero quantity validation
    - `Create_WithNegativeQuantity_ThrowsArgumentOutOfRangeException`: Negative quantity validation
    - `Create_WithEquippedButNoSlot_ThrowsArgumentException`: Equipped without slot validation
    - `Create_NormalizesItemIdToLowercase`: Case normalization
    - `Equipped_CreatesAutoEquipGrant`: Convenience factory
    - `Inventory_CreatesInventoryOnlyGrant`: Convenience factory
    - `Consumable_CreatesConsumableGrant`: Convenience factory
    - `HasAutoEquip_WithEquippedAndSlot_ReturnsTrue`: Computed property
    - `IsStackable_WithQuantityGreaterThan1_ReturnsTrue`: Computed property
    - `IsInventoryOnly_WithNonEquippedItem_ReturnsTrue`: Computed property
    - `ToString_FormatsCorrectlyWithSlot`: Equipped format
    - `ToString_FormatsCorrectlyWithQuantity`: Stackable format

- **`BackgroundDefinitionEquipmentTests`** (`Entities/BackgroundDefinitionEquipmentTests.cs`) — 12 tests
    - `Create_WithEquipmentGrants_StoresGrants`: Property storage
    - `Create_WithoutEquipmentGrants_DefaultsToEmptyList`: Optional parameter default
    - `HasEquipmentGrants_WithGrants_ReturnsTrue`: Helper method
    - `HasEquipmentGrants_WithoutGrants_ReturnsFalse`: Helper method
    - `GetEquippedItems_ReturnsOnlyEquippedGrants`: Filter verification
    - `GetInventoryItems_ReturnsOnlyNonEquippedGrants`: Filter verification
    - `GetTotalItemCount_SumsAllQuantities`: Total calculation (e.g., 1 kit + 5 bandages = 6)
    - `GetEquipmentGrantSummary_FormatsCorrectly`: Display formatting
    - `GetEquipmentGrantSummary_WithNoGrants_ReturnsFallbackText`: Fallback text
    - `ClanGuard_GrantsShieldAndSpearEquipped`: Background-specific verification
    - `TravelingHealer_GrantsBandagesx5`: Consumable/stackable verification
    - `ToString_IncludesEquipmentGrantCount`: Debug representation

---

## Design Decisions

### EquipmentSlot Mapping

The design specification used idealized slot names (`MainHand`, `OffHand`, `Chest`) that differ from the existing `EquipmentSlot` enum in the codebase. Equipment grants use the existing enum values:

| Design Spec | Existing Enum | Used For |
| ----------- | ------------- | -------- |
| MainHand | `Weapon` | Spear, Smith's Hammer |
| OffHand | `Shield` | Shield |
| Chest | `Armor` | Leather Apron, Travel Cloak |

This decision avoids modifying the existing enum and maintains consistency with the rest of the codebase.

### Item ID Convention

Item IDs use kebab-case lowercase strings (e.g., `smiths-hammer`, `healers-kit`, `travel-cloak`) rather than the design specification's underscore format (`smiths_hammer`). This follows the convention established by the schema pattern `^[a-z][a-z0-9-]*$` and maintains consistency with skill IDs.

### Three Factory Methods

Three convenience factory methods (`Equipped`, `Inventory`, `Consumable`) cover the three common equipment grant patterns:
- `Equipped`: Single auto-equip item with a specific slot (weapons, armor, shields)
- `Inventory`: Single non-equipped item (tools, utility items)
- `Consumable`: Multiple non-equipped items (bandages x5, rations x3)

Note that `Consumable` and `Inventory` produce identical grant structures — the distinction is semantic, making code intent clearer at the call site.

### Slot as Nullable

The `Slot` property uses `EquipmentSlot?` (nullable) because inventory-only items don't have a target slot. Validation ensures that `IsEquipped = true` always has a non-null `Slot`.

---

## Dependencies

### Prerequisites

- v0.17.1a (Background Enum & Definition) — Complete
- v0.17.1b (Skill Grants) — Complete
- `EquipmentSlot` enum from Domain layer (pre-existing)

### Provides to v0.17.1d

| Type | Usage |
| ---- | ----- |
| `BackgroundEquipmentGrant` | Loaded from configuration by BackgroundProvider |
| Extended `BackgroundDefinition` | Complete entity with all grant types |

### Provides to v0.17.1e

| Type | Usage |
| ---- | ----- |
| `BackgroundEquipmentGrant` | Applied during character creation by IBackgroundApplicationService |
| `GetEquippedItems()` | Used to auto-equip items to character slots |
| `GetInventoryItems()` | Used to add items to character inventory |
