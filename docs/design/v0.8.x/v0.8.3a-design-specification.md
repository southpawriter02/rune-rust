# v0.8.3a Design Specification: Combat Visual Feedback

**Version:** 0.8.3a
**Parent:** v0.8.3 (Combat Enhancement)
**Prerequisites:** v0.8.2c Complete (Puzzle Window)
**Status:** Design Complete
**Estimated Unit Tests:** ~10

---

## 1. Overview

### Purpose

Implement visual feedback for combat actions: floating damage/healing numbers, critical hit styling, miss/block indicators, turn start glow effects, and status effect notifications. These enhancements make combat visually engaging and provide clear feedback on outcomes.

### Key Deliverables

| Category | Items |
|----------|-------|
| **Controls** | `DamagePopupControl` |
| **Services** | `IAttackAnimationService`, `AttackAnimationService` |
| **Enums** | `DamagePopupType` |
| **Animations** | Pop-up rise/fade, glow pulse, shake |
| **Styles** | `CombatFeedbackStyles.axaml` |
| **Tests** | ~10 unit tests |

---

## 2. Feature Overview

```
v0.8.3a Features
├── DamagePopupControl
│   ├── Damage display (-12, -24)
│   ├── Critical styling (★ CRIT! ★, gold, larger)
│   ├── Healing display (+15, green)
│   ├── Miss indicator (MISS, gray)
│   ├── Block indicator (BLOCKED, blue)
│   └── Float-and-fade animation
│
├── AttackAnimationService
│   ├── ShowDamagePopupAsync()
│   ├── ShowHealingPopupAsync()
│   ├── ShowMissPopupAsync()
│   ├── ShowBlockPopupAsync()
│   ├── HighlightTurnStartAsync()
│   ├── ShowStatusAppliedAsync()
│   └── ShowStatusExpiredAsync()
│
├── Turn Start Effects
│   ├── Glow border on active entity
│   ├── Pulse animation (3x)
│   └── "★ YOUR TURN ★" indicator
│
├── Status Effect Indicators
│   ├── Applied: Icon + brief text
│   └── Expired: Fade-out notification
│
└── Animation Timings
    ├── Pop-up duration: 800ms
    ├── Glow pulse: 500ms × 3
    └── Status indicator: 600ms
```

---

## 3. Architecture

```
┌─────────────────────────────────────────────────────────────────────────┐
│                       PRESENTATION LAYER                                │
├─────────────────────────────────────────────────────────────────────────┤
│  Controls                                                               │
│  └── DamagePopupControl : Control                                      │
│       ├── int Value                                                    │
│       ├── DamagePopupType PopupType                                    │
│       ├── bool IsCritical                                              │
│       ├── string DisplayText (computed)                                │
│       ├── IBrush TextColor (computed)                                  │
│       └── double FontSize (computed)                                   │
│                                                                         │
│  Services                                                               │
│  └── AttackAnimationService : IAttackAnimationService                  │
│       ├── ICombatGridOverlay _overlay                                  │
│       └── ILogger _logger                                              │
│                                                                         │
│  Enums                                                                  │
│  └── DamagePopupType: Damage, Healing, Miss, Block                     │
└─────────────────────────────────────────────────────────────────────────┘
```

---

## 4. DamagePopupControl

**File:** `src/Presentation/RuneAndRust.Avalonia/Controls/DamagePopupControl.cs`

```csharp
namespace RuneAndRust.Avalonia.Controls;

/// <summary>
/// Displays floating damage/healing numbers with animation.
/// </summary>
public class DamagePopupControl : Control
{
    public static readonly StyledProperty<int> ValueProperty =
        AvaloniaProperty.Register<DamagePopupControl, int>(nameof(Value));
    public static readonly StyledProperty<DamagePopupType> PopupTypeProperty =
        AvaloniaProperty.Register<DamagePopupControl, DamagePopupType>(nameof(PopupType));
    public static readonly StyledProperty<bool> IsCriticalProperty =
        AvaloniaProperty.Register<DamagePopupControl, bool>(nameof(IsCritical));

    public int Value { get => GetValue(ValueProperty); set => SetValue(ValueProperty, value); }
    public DamagePopupType PopupType { get => GetValue(PopupTypeProperty); set => SetValue(PopupTypeProperty, value); }
    public bool IsCritical { get => GetValue(IsCriticalProperty); set => SetValue(IsCriticalProperty, value); }

    public string DisplayText => PopupType switch
    {
        DamagePopupType.Damage when IsCritical => $"★ {Value} ★",
        DamagePopupType.Damage => $"-{Value}",
        DamagePopupType.Healing => $"+{Value}",
        DamagePopupType.Miss => "MISS",
        DamagePopupType.Block => "BLOCKED",
        _ => Value.ToString()
    };

    public IBrush TextColor => PopupType switch
    {
        DamagePopupType.Damage when IsCritical => Brushes.Gold,
        DamagePopupType.Damage => Brushes.White,
        DamagePopupType.Healing => Brushes.LimeGreen,
        DamagePopupType.Miss => Brushes.Gray,
        DamagePopupType.Block => Brushes.SteelBlue,
        _ => Brushes.White
    };

    public double FontSize => IsCritical ? 24 : 18;

    public override void Render(DrawingContext context)
    {
        var ft = new FormattedText(DisplayText, CultureInfo.CurrentCulture, FlowDirection.LeftToRight,
            new Typeface("Segoe UI", FontStyle.Normal, IsCritical ? FontWeight.Bold : FontWeight.SemiBold),
            FontSize, TextColor);
        context.DrawText(ft, new Point(-ft.Width / 2, -ft.Height / 2));
    }
}

public enum DamagePopupType { Damage, Healing, Miss, Block }
```

---

## 5. AttackAnimationService

**File:** `src/Presentation/RuneAndRust.Avalonia/Services/AttackAnimationService.cs`

```csharp
namespace RuneAndRust.Avalonia.Services;

public interface IAttackAnimationService
{
    Task ShowDamagePopupAsync(GridPosition position, int damage, bool isCritical);
    Task ShowHealingPopupAsync(GridPosition position, int healing);
    Task ShowMissPopupAsync(GridPosition position);
    Task ShowBlockPopupAsync(GridPosition position);
    Task HighlightTurnStartAsync(Combatant combatant);
    Task ShowStatusAppliedAsync(GridPosition position, StatusEffect effect);
    Task ShowStatusExpiredAsync(GridPosition position, StatusEffect effect);
}

public class AttackAnimationService : IAttackAnimationService
{
    private readonly ICombatGridOverlay _overlay;
    private readonly ILogger<AttackAnimationService> _logger;
    private const int PopupDurationMs = 800;
    private const int GlowDurationMs = 500;

    public AttackAnimationService(ICombatGridOverlay overlay, ILogger<AttackAnimationService> logger)
    {
        _overlay = overlay;
        _logger = logger;
    }

    public async Task ShowDamagePopupAsync(GridPosition position, int damage, bool isCritical)
    {
        var popup = new DamagePopupControl { Value = damage, PopupType = DamagePopupType.Damage, IsCritical = isCritical };
        await AnimatePopup(popup, position);
        _logger.LogDebug("Damage popup: {Damage}{Crit} at {Pos}", damage, isCritical ? " (CRIT)" : "", position);
    }

    public async Task ShowHealingPopupAsync(GridPosition position, int healing)
    {
        var popup = new DamagePopupControl { Value = healing, PopupType = DamagePopupType.Healing };
        await AnimatePopup(popup, position);
        _logger.LogDebug("Healing popup: +{Healing} at {Pos}", healing, position);
    }

    public async Task ShowMissPopupAsync(GridPosition position)
    {
        var popup = new DamagePopupControl { PopupType = DamagePopupType.Miss };
        await AnimatePopup(popup, position);
        _logger.LogDebug("Miss popup at {Pos}", position);
    }

    public async Task ShowBlockPopupAsync(GridPosition position)
    {
        var popup = new DamagePopupControl { PopupType = DamagePopupType.Block };
        await AnimatePopup(popup, position);
        _logger.LogDebug("Block popup at {Pos}", position);
    }

    public async Task HighlightTurnStartAsync(Combatant combatant)
    {
        var token = _overlay.GetToken(combatant.Id);
        if (token is null) return;

        token.ShowGlowEffect = true;
        for (int i = 0; i < 3; i++)
        {
            token.GlowOpacity = 1.0;
            await Task.Delay(GlowDurationMs / 2);
            token.GlowOpacity = 0.4;
            await Task.Delay(GlowDurationMs / 2);
        }
        token.ShowGlowEffect = false;
        _logger.LogDebug("Turn highlight for {Combatant}", combatant.Name);
    }

    public async Task ShowStatusAppliedAsync(GridPosition position, StatusEffect effect)
    {
        // Show status icon with brief text popup
        _overlay.ShowStatusIndicator(position, effect.Icon, $"+{effect.Name}");
        await Task.Delay(600);
        _overlay.HideStatusIndicator(position);
        _logger.LogDebug("Status applied: {Effect} at {Pos}", effect.Name, position);
    }

    public async Task ShowStatusExpiredAsync(GridPosition position, StatusEffect effect)
    {
        _overlay.ShowStatusIndicator(position, effect.Icon, $"-{effect.Name}", fadeOut: true);
        await Task.Delay(600);
        _overlay.HideStatusIndicator(position);
        _logger.LogDebug("Status expired: {Effect} at {Pos}", effect.Name, position);
    }

    private async Task AnimatePopup(DamagePopupControl popup, GridPosition position)
    {
        var screenPos = _overlay.GridToScreen(position);
        _overlay.AddPopup(popup, screenPos);

        // Rise up and fade: 0ms→200ms (rise), 200ms→800ms (fade)
        var startTime = DateTime.UtcNow;
        while ((DateTime.UtcNow - startTime).TotalMilliseconds < PopupDurationMs)
        {
            var t = (DateTime.UtcNow - startTime).TotalMilliseconds / PopupDurationMs;
            popup.RenderTransform = new TranslateTransform(0, -50 * t);
            popup.Opacity = t < 0.5 ? 1.0 : 1.0 - (t - 0.5) * 2;
            await Task.Delay(16); // ~60fps
        }
        _overlay.RemovePopup(popup);
    }
}
```

---

## 6. Visual Feedback Designs

```
DAMAGE POP-UP ANIMATION (800ms):
   Frame 1 (0ms)    Frame 2 (200ms)    Frame 3 (400ms)    Frame 4 (800ms)
                         -12               -12              (gone)
       [@]               [@]               [@]               [@]
                        ↑ rise            ↑ fading

CRITICAL HIT:
                      ★ CRIT! ★          ★-24★            (gone)
       [@]               [@]               [@]              [@]
                      (gold, 24px)       (fading)

MISS:                    MISS             MISS            (gone)
       [@]               [@]               [@]              [@]
                        (gray)           (fading)

HEALING:                 +15              +15             (gone)
       [@]               [@]               [@]              [@]
                       (green)          (fading)

TURN START GLOW (pulses 3x):
    ╔═══╗    ╔═══╗    ╔═══╗    ╔═══╗
    ║ @ ║ →  ║   ║ →  ║ @ ║ →  ║   ║  ...
    ╚═══╝    ╚═══╝    ╚═══╝    ╚═══╝
     glow     dim      glow     dim
```

---

## 7. Styles

**File:** `src/Presentation/RuneAndRust.Avalonia/Styles/CombatFeedbackStyles.axaml`

```xml
<Styles xmlns="https://github.com/avaloniaui" xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:controls="using:RuneAndRust.Avalonia.Controls">
    
    <!-- Damage Text -->
    <Style Selector="controls|DamagePopupControl">
        <Setter Property="FontWeight" Value="SemiBold" />
    </Style>
    <Style Selector="controls|DamagePopupControl.critical">
        <Setter Property="FontWeight" Value="Bold" />
        <Setter Property="FontSize" Value="24" />
    </Style>
    
    <!-- Turn Glow Effect -->
    <Style Selector="controls|EntityTokenControl.turn-active">
        <Setter Property="Effect">
            <DropShadowEffect BlurRadius="15" Color="Gold" Opacity="0.8" OffsetX="0" OffsetY="0" />
        </Setter>
    </Style>
    
    <!-- Status Indicator -->
    <Style Selector="Border.status-indicator">
        <Setter Property="Background" Value="{StaticResource SurfaceDarkBrush}" />
        <Setter Property="Padding" Value="4,2" />
        <Setter Property="CornerRadius" Value="4" />
    </Style>
</Styles>
```

---

## 8. Combat Event Integration

```csharp
// In CombatService or CombatViewModel - subscribe to combat events
_combatEvents.OnDamageDealt += async (attacker, target, damage, isCrit) =>
{
    await _animationService.ShowDamagePopupAsync(target.Position, damage, isCrit);
};

_combatEvents.OnAttackMissed += async (attacker, target) =>
{
    await _animationService.ShowMissPopupAsync(target.Position);
};

_combatEvents.OnHealingReceived += async (target, healing) =>
{
    await _animationService.ShowHealingPopupAsync(target.Position, healing);
};

_combatEvents.OnTurnStarted += async (combatant) =>
{
    await _animationService.HighlightTurnStartAsync(combatant);
};

_combatEvents.OnStatusApplied += async (target, effect) =>
{
    await _animationService.ShowStatusAppliedAsync(target.Position, effect);
};
```

---

## 9. Unit Testing Requirements (~10 tests)

| Feature | Tests |
|---------|-------|
| DamagePopupControl display text | 2 |
| DamagePopupControl colors | 2 |
| ShowDamagePopupAsync triggers | 1 |
| ShowHealingPopupAsync triggers | 1 |
| ShowMissPopupAsync triggers | 1 |
| HighlightTurnStartAsync glow | 1 |
| Status applied indicator | 1 |
| Status expired indicator | 1 |

---

## 10. Acceptance Criteria

- [ ] Damage numbers appear on hit
- [ ] Numbers float upward and fade (800ms)
- [ ] Critical hits show larger gold text with stars
- [ ] Miss shows "MISS" in gray
- [ ] Block shows "BLOCKED" in blue
- [ ] Healing shows green positive numbers
- [ ] Turn start shows glow border on entity
- [ ] Glow pulses 3 times then fades
- [ ] Status applied shows icon + name briefly
- [ ] Status expired shows fade-out indicator
- [ ] Animations don't block gameplay
- [ ] ~10 unit tests pass

---

## 11. Dependencies

| From | Required |
|------|----------|
| v0.7.4 | `CombatGridPanel`, `EntityTokenControl`, `GridInteractionService` |
| Domain | `GridPosition`, `Combatant`, `StatusEffect` |
| Infrastructure | Combat event system |

---

## 12. Future Considerations

**Deferred:** Particle effects, screen shake on heavy hits, combo indicators, spell effect visuals, sound integration.

---

*Document Version: 1.0 | Last Updated: 2026-01-10*
