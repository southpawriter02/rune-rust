# v0.2.0d Design Specification: Companions

## Overview

**Version:** 0.2.0d
**Status:** Planning
**Focus:** NPC recruitment, companion management, and combat integration
**Prerequisites:** v0.2.0a (NPC Foundation), v0.2.0b (Dialogue System), v0.2.0c (Reputation & Memory), Combat System
**Estimated Unit Tests:** ~25

---

## Table of Contents

1. [Executive Summary](#1-executive-summary)
2. [Feature Overview](#2-feature-overview)
3. [Architecture Diagrams](#3-architecture-diagrams)
4. [User Stories](#4-user-stories)
5. [Data Models](#5-data-models)
6. [Configuration Schemas](#6-configuration-schemas)
7. [Service Specifications](#7-service-specifications)
8. [Companion Command Flow](#8-companion-command-flow)
9. [User-Facing Changes](#9-user-facing-changes)
10. [Logging Requirements](#10-logging-requirements)
11. [Unit Test Specifications](#11-unit-test-specifications)
12. [Use Cases](#12-use-cases)
13. [Acceptance Criteria](#13-acceptance-criteria)
14. [Deliverable Checklist](#14-deliverable-checklist)
15. [Dependencies](#15-dependencies)
16. [Future Considerations](#16-future-considerations)

---

## 1. Executive Summary

This version introduces the companion system, allowing players to recruit NPCs as party members who fight alongside them in combat. Companions extend the NPC foundation from v0.2.0a and integrate with the dialogue outcome system from v0.2.0b to enable recruitment through conversation. The companion system adds a significant layer of tactical depth to combat while maintaining the single-companion design for simplicity.

### Key Deliverables

| Category | Items |
|----------|-------|
| **Entities** | Companion |
| **Value Objects** | CompanionStats, CompanionOrder |
| **Enums** | CompanionState, CompanionOrderType |
| **Services** | CompanionService (ICompanionService) |
| **Commands** | `party`, `order`, `equip companion`, `dismiss` |
| **Combat Updates** | CombatEncounter companion integration |
| **Dialogue Updates** | OutcomeType.RecruitCompanion implementation |
| **Tests** | ~25 new unit tests |

### Architectural Significance

This version establishes the **companion pattern** that enables party-based gameplay:
- Companion entity extending NPC with combat capabilities
- Order system for tactical companion control
- Combat integration with companion as AI-controlled combatant
- Equipment system reusing existing EquipmentService
- Dialogue-driven recruitment through OutcomeType.RecruitCompanion

---

## 2. Feature Overview

```
v0.2.0d Features
├── Companion Entity
│   ├── Extends NPC for recruited allies
│   ├── Combat stats (CompanionStats)
│   ├── Health tracking and damage
│   ├── Equipment slots
│   ├── State management (Following, Waiting, Unconscious, Dismissed)
│   └── IEffectTarget implementation
├── Companion Management
│   ├── Recruitment through dialogue outcomes
│   ├── One companion limit per player
│   ├── Dismissal and return to NPC state
│   └── Companion equipment system
├── Order System
│   ├── CompanionOrder value object
│   ├── Order types (Attack, Defend, Focus, UseAbilities, StayBack)
│   └── Order command for tactical control
├── Combat Integration
│   ├── Companion as AI-controlled combatant
│   ├── Order-based action selection
│   ├── Unconscious state on defeat
│   └── Recovery after combat
└── Display
    ├── Party status command
    ├── Companion in combat display
    └── Companion turns in combat log
```

---

## 3. Architecture Diagrams

### 3.1 Layer Diagram

```
┌─────────────────────────────────────────────────────────────────────────┐
│                         PRESENTATION LAYER                              │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  ┌─────────────────────┐  ┌─────────────────────┐  ┌────────────────┐  │
│  │   PartyHandler      │  │   OrderHandler      │  │ DismissHandler │  │
│  │                     │  │                     │  │                │  │
│  │ - HandleParty()     │  │ - HandleOrder()     │  │ - HandleDism() │  │
│  │ - ShowPartyStatus() │  │ - ParseOrderType()  │  │                │  │
│  └─────────┬───────────┘  └─────────┬───────────┘  └───────┬────────┘  │
│            │                        │                      │           │
│  ┌─────────────────────┐  ┌─────────────────────┐                      │
│  │EquipCompanionHandler│  │ CombatHandler       │                      │
│  │                     │  │ (updated)           │                      │
│  │ - HandleEquip()     │  │ - ShowCompanionTurn │                      │
│  └─────────┬───────────┘  └─────────┬───────────┘                      │
│            │                        │                                  │
└────────────┼────────────────────────┼──────────────────────────────────┘
             │                        │
             ▼                        ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                         APPLICATION LAYER                               │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │                      CompanionService                            │   │
│  ├─────────────────────────────────────────────────────────────────┤   │
│  │ + RecruitCompanion(npc, player) : Companion?                    │   │
│  │ + DismissCompanion(companion) : void                            │   │
│  │ + GetActiveCompanion(playerId) : Companion?                     │   │
│  │ + IssueOrder(companion, order) : void                           │   │
│  │ + EquipCompanion(companion, item, slot) : EquipResult           │   │
│  │ + GetCompanionAction(companion, context) : AIDecision           │   │
│  │ + ProcessCombatEnd(companion, victory) : void                   │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │                    DialogueService (updated)                     │   │
│  ├─────────────────────────────────────────────────────────────────┤   │
│  │ + ApplyOutcome() - RecruitCompanion now implemented             │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │                    CombatService (updated)                       │   │
│  ├─────────────────────────────────────────────────────────────────┤   │
│  │ + ProcessCompanionTurn(encounter, companion) : CombatAction     │   │
│  │ + AddCompanionToEncounter(encounter, companion) : void          │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │                    GameSessionService (updated)                  │   │
│  ├─────────────────────────────────────────────────────────────────┤   │
│  │ + GetPartyStatus() : PartyStatusDto                             │   │
│  │ + IssueCompanionOrder(orderType, targetId?) : OrderResult       │   │
│  │ + EquipCompanionItem(itemName, slot) : EquipResult              │   │
│  │ + DismissCompanion() : DismissResult                            │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                           DOMAIN LAYER                                  │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  ENTITIES                                                               │
│  ┌────────────────────────────────────────────────────────────────────┐│
│  │                          Companion                                  ││
│  ├────────────────────────────────────────────────────────────────────┤│
│  │ + Id: Guid                          + CurrentHealth: int           ││
│  │ + NPC: NPC                          + MaxHealth: int (from Stats)  ││
│  │ + PlayerId: Guid                    + Equipment: IReadOnlyDict     ││
│  │ + State: CompanionState             + CurrentOrder: CompanionOrder ││
│  │ + Stats: CompanionStats             + Level: int                   ││
│  │ + StatusEffects: IReadOnlyList      + IsAlive: bool                ││
│  │                                     + IsActive: bool               ││
│  ├────────────────────────────────────────────────────────────────────┤│
│  │ + Recruit(npc, playerId, baseStats) : Companion [static]           ││
│  │ + TakeDamage(amount) : int          + Heal(amount) : int           ││
│  │ + SetOrder(order) : void            + SetState(state) : void       ││
│  │ + Equip(item, slot) : EquipResult   + Unequip(slot) : Item?        ││
│  │ + Dismiss() : void                                                 ││
│  └────────────────────────────────────────────────────────────────────┘│
│                                                                         │
│  ENUMS                                                                  │
│  ┌────────────────────────┐  ┌────────────────────────┐                │
│  │    CompanionState      │  │   CompanionOrderType   │                │
│  ├────────────────────────┤  ├────────────────────────┤                │
│  │ Following              │  │ AttackTarget           │                │
│  │ Waiting                │  │ Defend                 │                │
│  │ Unconscious            │  │ FocusTarget            │                │
│  │ Dismissed              │  │ UseAbilities           │                │
│  └────────────────────────┘  │ StayBack               │                │
│                              └────────────────────────┘                │
│                                                                         │
│  VALUE OBJECTS                                                          │
│  ┌────────────────────────────────────────────────────────────────────┐│
│  │                       CompanionStats                                ││
│  ├────────────────────────────────────────────────────────────────────┤│
│  │ + MaxHealth: int            + Initiative: int                      ││
│  │ + Attack: int               + Accuracy: int                        ││
│  │ + Defense: int                                                     ││
│  ├────────────────────────────────────────────────────────────────────┤│
│  │ + Default : CompanionStats [static]                                ││
│  │ + ScaleToLevel(level) : CompanionStats                             ││
│  └────────────────────────────────────────────────────────────────────┘│
│                                                                         │
│  ┌────────────────────────────────────────────────────────────────────┐│
│  │                       CompanionOrder                                ││
│  ├────────────────────────────────────────────────────────────────────┤│
│  │ + Type: CompanionOrderType                                         ││
│  │ + TargetId: Guid?                                                  ││
│  │ + Parameters: string?                                              ││
│  ├────────────────────────────────────────────────────────────────────┤│
│  │ + Default : CompanionOrder [static]                                ││
│  │ + Defend() : CompanionOrder [static]                               ││
│  │ + Focus(targetId) : CompanionOrder [static]                        ││
│  └────────────────────────────────────────────────────────────────────┘│
│                                                                         │
│  COMBAT ENTITY UPDATES                                                  │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │                      CombatEncounter                             │   │
│  ├─────────────────────────────────────────────────────────────────┤   │
│  │ + CompanionCombatants: IReadOnlyList<Combatant>     // NEW       │   │
│  │ + AddCompanion(Companion companion): void           // NEW       │   │
│  │ + IsCompanionTurn(): bool                           // NEW       │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
│  INTERFACE IMPLEMENTATION                                               │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │  Companion : IEntity, IEffectTarget                              │   │
│  │  ├── IEntity: Id property                                        │   │
│  │  └── IEffectTarget: StatusEffects, TakeDamage, Heal              │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                        INFRASTRUCTURE LAYER                             │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │                IConfigurationProvider (updated)                  │   │
│  ├─────────────────────────────────────────────────────────────────┤   │
│  │ + LoadCompanionStats(npcDefinitionId) : CompanionStats?         │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
│  Configuration Files:                                                   │
│  ├── config/npcs.json (updated with companion stats)                   │
│  └── config/schemas/npcs.schema.json (updated)                         │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

### 3.2 Companion Recruitment Flow

```
┌───────────────────┐
│  Dialogue Choice  │
│  with Outcome:    │
│  RecruitCompanion │
└─────────┬─────────┘
          │
          ▼
┌───────────────────┐      ┌───────────────────┐
│  DialogueService  │─────▶│ CompanionService  │
│ ApplyOutcome()    │      │ RecruitCompanion()│
└───────────────────┘      └─────────┬─────────┘
                                     │
                    ┌────────────────┼────────────────┐
                    │                │                │
                    ▼                ▼                ▼
           ┌─────────────┐  ┌─────────────┐  ┌─────────────┐
           │  Player Has │  │  NPC Type   │  │  NPC Not    │
           │  Companion  │  │ Compatible  │  │  Available  │
           └──────┬──────┘  └──────┬──────┘  └──────┬──────┘
                  │                │                │
                  ▼                ▼                ▼
           ┌─────────────┐  ┌─────────────┐  ┌─────────────┐
           │   Return    │  │   Create    │  │   Return    │
           │    null     │  │  Companion  │  │    null     │
           │ (has comp.) │  │   Entity    │  │ (unavail.)  │
           └─────────────┘  └──────┬──────┘  └─────────────┘
                                   │
                                   ▼
                           ┌───────────────────┐
                           │ Set NPC as        │
                           │ Unavailable       │
                           └─────────┬─────────┘
                                     │
                                     ▼
                           ┌───────────────────┐
                           │ Initialize Stats  │
                           │ from Definition   │
                           └─────────┬─────────┘
                                     │
                                     ▼
                           ┌───────────────────┐
                           │ Scale Stats to    │
                           │ Player Level      │
                           └─────────┬─────────┘
                                     │
                                     ▼
                           ┌───────────────────┐
                           │ Return Companion  │
                           │ in Following state│
                           └───────────────────┘
```

### 3.3 Combat Integration Flow

```
┌───────────────────┐
│  Combat Starts    │
│  (Player has      │
│   Companion)      │
└─────────┬─────────┘
          │
          ▼
┌───────────────────┐
│ CombatService     │
│ AddCompanionTo    │
│ Encounter()       │
└─────────┬─────────┘
          │
          ▼
┌───────────────────────────────────────────────────────────────────┐
│                      COMBAT LOOP                                   │
├───────────────────────────────────────────────────────────────────┤
│                                                                    │
│   ┌─────────────┐     ┌─────────────┐     ┌─────────────┐        │
│   │ Player Turn │────▶│ Companion   │────▶│ Enemy Turn  │        │
│   │             │     │    Turn     │     │             │        │
│   └─────────────┘     └──────┬──────┘     └─────────────┘        │
│                              │                                    │
│                              ▼                                    │
│                     ┌─────────────────┐                          │
│                     │ GetCompanion    │                          │
│                     │ Action()        │                          │
│                     └────────┬────────┘                          │
│                              │                                    │
│              ┌───────────────┼───────────────┐                   │
│              │               │               │                    │
│              ▼               ▼               ▼                    │
│     ┌─────────────┐ ┌─────────────┐ ┌─────────────┐              │
│     │ AttackTarget│ │   Defend    │ │  FocusTarget│              │
│     │ Order       │ │   Order     │ │   Order     │              │
│     └──────┬──────┘ └──────┬──────┘ └──────┬──────┘              │
│            │               │               │                      │
│            ▼               ▼               ▼                      │
│     ┌─────────────┐ ┌─────────────┐ ┌─────────────┐              │
│     │ Attack      │ │ Guard action│ │ Attack      │              │
│     │ nearest foe │ │ (+defense)  │ │ specific    │              │
│     │             │ │             │ │ target      │              │
│     └─────────────┘ └─────────────┘ └─────────────┘              │
│                                                                    │
│   If Companion health reaches 0:                                   │
│   ┌─────────────────────────────────────────────────────────────┐ │
│   │ Set State = Unconscious                                      │ │
│   │ Companion removed from turn order                            │ │
│   │ Display "Companion falls unconscious!"                       │ │
│   └─────────────────────────────────────────────────────────────┘ │
│                                                                    │
└───────────────────────────────────────────────────────────────────┘
          │
          ▼
┌───────────────────┐
│   Combat Ends     │
└─────────┬─────────┘
          │
          ▼
┌───────────────────┐
│ CompanionService  │
│ ProcessCombatEnd()│
└─────────┬─────────┘
          │
          ▼
┌───────────────────────────────────────────────────────────────────┐
│                                                                    │
│   ┌─────────────────────────────────────────────────────────────┐ │
│   │ If Victory:                                                  │ │
│   │ - Heal unconscious companion to 1 HP                         │ │
│   │ - Set state to Following                                     │ │
│   │ - Display "Companion recovers consciousness"                 │ │
│   └─────────────────────────────────────────────────────────────┘ │
│                                                                    │
│   ┌─────────────────────────────────────────────────────────────┐ │
│   │ If Defeat (Player dies):                                     │ │
│   │ - Companion remains unconscious                              │ │
│   │ - Game over screen shows companion status                    │ │
│   └─────────────────────────────────────────────────────────────┘ │
│                                                                    │
└───────────────────────────────────────────────────────────────────┘
```

### 3.4 Companion-Player Relationship

```
┌─────────────────────────────────────────────────────────────────────────┐
│                              PLAYER                                     │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  Existing Properties:                                                   │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐                  │
│  │  Inventory   │  │   Stats      │  │   Level      │                  │
│  └──────────────┘  └──────────────┘  └──────────────┘                  │
│                                                                         │
│  Companion Reference (via CompanionService):                            │
│  ┌──────────────────────────────────────────────────────────────────┐  │
│  │                     Active Companion                              │  │
│  │           GetActiveCompanion(playerId) → Companion?               │  │
│  ├──────────────────────────────────────────────────────────────────┤  │
│  │                                                                   │  │
│  │  ┌─────────────────────────────────────────────────────────────┐ │  │
│  │  │                    COMPANION                                 │ │  │
│  │  ├─────────────────────────────────────────────────────────────┤ │  │
│  │  │  Identity                                                    │ │  │
│  │  │  ├── Id: Guid                                               │ │  │
│  │  │  ├── NPC: NPC (underlying character)                        │ │  │
│  │  │  └── PlayerId: Guid (owner reference)                       │ │  │
│  │  │                                                              │ │  │
│  │  │  State                                                       │ │  │
│  │  │  ├── State: CompanionState (Following/Waiting/etc.)         │ │  │
│  │  │  └── CurrentOrder: CompanionOrder                           │ │  │
│  │  │                                                              │ │  │
│  │  │  Combat Stats                                                │ │  │
│  │  │  ├── Stats: CompanionStats                                  │ │  │
│  │  │  ├── CurrentHealth: int                                     │ │  │
│  │  │  ├── MaxHealth: int                                         │ │  │
│  │  │  └── Level: int (scales with player)                        │ │  │
│  │  │                                                              │ │  │
│  │  │  Equipment                                                   │ │  │
│  │  │  └── Equipment: Dict<EquipmentSlot, Item>                   │ │  │
│  │  │                                                              │ │  │
│  │  └─────────────────────────────────────────────────────────────┘ │  │
│  │                                                                   │  │
│  └──────────────────────────────────────────────────────────────────┘  │
│                                                                         │
│  Constraints:                                                           │
│  ├── Maximum 1 active companion per player                             │
│  ├── Companion follows player between rooms                            │
│  └── Companion state persists across sessions                          │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

---

## 4. User Stories

### US-2.0d-1: Recruit Companion through Dialogue
**As a** player talking to an NPC
**I want to** recruit them as a companion through dialogue choices
**So that** I can have an ally who fights alongside me

**Acceptance Criteria:**
- Dialogue outcomes can trigger recruitment
- Recruitment only succeeds if player has no companion
- NPC becomes unavailable after recruitment
- Companion starts in Following state

### US-2.0d-2: View Party Status
**As a** player with a companion
**I want to** use `party` to see my companion's status
**So that** I can monitor their health and state

**Acceptance Criteria:**
- Party command shows player and companion info
- Companion health, state, and order are displayed
- Companion equipment is listed
- Command works in and out of combat

### US-2.0d-3: Give Companion Orders
**As a** player in combat with a companion
**I want to** give orders to control companion behavior
**So that** I can coordinate tactics

**Acceptance Criteria:**
- `order attack` makes companion target nearest enemy
- `order defend` makes companion protect player
- `order attack <target>` focuses on specific enemy
- Order changes take effect on companion's next turn

### US-2.0d-4: Equip Companion
**As a** player with a companion
**I want to** equip items on my companion
**So that** I can improve their combat effectiveness

**Acceptance Criteria:**
- `equip companion <item>` equips item from inventory
- Previous item is returned to inventory
- Only equippable items can be equipped
- Companion stats reflect equipment

### US-2.0d-5: Companion Fights in Combat
**As a** player entering combat
**I want to** have my companion automatically participate
**So that** I have an advantage in battle

**Acceptance Criteria:**
- Companion is added to combat as an ally
- Companion takes turns based on initiative
- Companion actions follow current order
- Companion damage/health is tracked

### US-2.0d-6: Companion Recovery
**As a** player whose companion was knocked unconscious
**I want to** have them recover after victorious combat
**So that** I don't permanently lose my companion

**Acceptance Criteria:**
- Unconscious companions recover to 1 HP after victory
- State changes from Unconscious to Following
- Recovery message is displayed
- Companion can participate in next combat

### US-2.0d-7: Dismiss Companion
**As a** player with a companion
**I want to** use `dismiss` to release them
**So that** I can recruit a different companion

**Acceptance Criteria:**
- Dismiss command releases current companion
- NPC returns to available state
- Dismissed state is permanent for that recruitment
- Player can recruit new companion after dismissal

---

## 5. Data Models

### 5.1 Companion Entity

```csharp
namespace RuneAndRust.Domain.Entities;

/// <summary>
/// Represents a recruited NPC companion.
/// </summary>
/// <remarks>
/// Companions are NPCs that have joined the player's party and can
/// participate in combat. They maintain a reference to their underlying
/// NPC and add combat-specific functionality including health, equipment,
/// and order following.
/// </remarks>
public class Companion : IEntity, IEffectTarget
{
    /// <summary>
    /// Gets the unique identifier for this companion instance.
    /// </summary>
    public Guid Id { get; private set; }

    /// <summary>
    /// Gets the underlying NPC entity.
    /// </summary>
    /// <remarks>
    /// Contains the NPC's identity, appearance, dialogue references, etc.
    /// The NPC's IsAvailable flag is set to false while recruited.
    /// </remarks>
    public NPC NPC { get; private set; } = null!;

    /// <summary>
    /// Gets the owning player's ID.
    /// </summary>
    /// <remarks>
    /// Used to associate companion with player for lookups.
    /// One player can have at most one active companion.
    /// </remarks>
    public Guid PlayerId { get; private set; }

    /// <summary>
    /// Gets the companion's current state.
    /// </summary>
    /// <remarks>
    /// Determines whether companion is active and how they behave.
    /// Following = active with player, Waiting = stationary,
    /// Unconscious = defeated in combat, Dismissed = permanently released.
    /// </remarks>
    public CompanionState State { get; private set; }

    /// <summary>
    /// Gets the companion's combat statistics.
    /// </summary>
    /// <remarks>
    /// Base stats from NPC definition, scaled by level.
    /// Includes MaxHealth, Attack, Defense, Initiative, Accuracy.
    /// </remarks>
    public CompanionStats Stats { get; private set; } = null!;

    /// <summary>
    /// Gets the companion's current health.
    /// </summary>
    /// <remarks>
    /// Reduced by damage, restored by healing.
    /// At 0, companion becomes Unconscious.
    /// </remarks>
    public int CurrentHealth { get; private set; }

    /// <summary>
    /// Gets the companion's maximum health.
    /// </summary>
    /// <remarks>
    /// Derived from Stats.MaxHealth.
    /// </remarks>
    public int MaxHealth => Stats.MaxHealth;

    /// <summary>
    /// Gets the companion's equipped items.
    /// </summary>
    /// <remarks>
    /// Equipment affects combat stats and is displayed in party status.
    /// Uses existing EquipmentSlot enum for slot types.
    /// </remarks>
    public IReadOnlyDictionary<EquipmentSlot, Item> Equipment { get; private set; }
        = new Dictionary<EquipmentSlot, Item>();

    /// <summary>
    /// Gets the current order given to this companion.
    /// </summary>
    /// <remarks>
    /// Determines companion's behavior in combat.
    /// Default is AttackTarget (attack nearest enemy).
    /// </remarks>
    public CompanionOrder CurrentOrder { get; private set; }

    /// <summary>
    /// Gets the companion's level.
    /// </summary>
    /// <remarks>
    /// Typically matches player level at recruitment.
    /// Used for stat scaling.
    /// </remarks>
    public int Level { get; private set; }

    /// <summary>
    /// Gets active status effects on this companion.
    /// </summary>
    /// <remarks>
    /// Implements IEffectTarget for status effect compatibility.
    /// Effects like poison, buffs, etc. apply to companions.
    /// </remarks>
    public IReadOnlyList<ActiveStatusEffect> StatusEffects { get; private set; }
        = Array.Empty<ActiveStatusEffect>();

    /// <summary>
    /// Private constructor for EF Core.
    /// </summary>
    private Companion() { }

    /// <summary>
    /// Recruits an NPC as a companion.
    /// </summary>
    /// <param name="npc">The NPC to recruit.</param>
    /// <param name="playerId">The recruiting player's ID.</param>
    /// <param name="baseStats">Base companion stats from definition.</param>
    /// <returns>A new Companion instance.</returns>
    /// <exception cref="ArgumentNullException">Thrown if npc is null.</exception>
    /// <remarks>
    /// Sets the NPC as unavailable and initializes the companion
    /// in Following state with full health.
    /// </remarks>
    public static Companion Recruit(NPC npc, Guid playerId, CompanionStats baseStats)
    {
        ArgumentNullException.ThrowIfNull(npc);

        var companion = new Companion
        {
            Id = Guid.NewGuid(),
            NPC = npc,
            PlayerId = playerId,
            State = CompanionState.Following,
            Stats = baseStats,
            Level = 1,
            CurrentOrder = CompanionOrder.Default
        };

        companion.CurrentHealth = companion.MaxHealth;
        npc.SetAvailability(false);

        return companion;
    }

    /// <summary>
    /// Takes damage, reducing health.
    /// </summary>
    /// <param name="amount">Amount of damage to take.</param>
    /// <returns>Actual damage taken (may be less if health insufficient).</returns>
    /// <remarks>
    /// Does not automatically set Unconscious state - caller should check
    /// IsAlive and update state if needed.
    /// </remarks>
    public int TakeDamage(int amount)
    {
        var actual = Math.Min(amount, CurrentHealth);
        CurrentHealth -= actual;
        return actual;
    }

    /// <summary>
    /// Heals the companion.
    /// </summary>
    /// <param name="amount">Amount to heal.</param>
    /// <returns>Actual amount healed (cannot exceed max health).</returns>
    public int Heal(int amount)
    {
        var actual = Math.Min(amount, MaxHealth - CurrentHealth);
        CurrentHealth += actual;
        return actual;
    }

    /// <summary>
    /// Sets the companion's current order.
    /// </summary>
    /// <param name="order">The order to follow.</param>
    /// <remarks>
    /// Takes effect on the companion's next combat turn.
    /// </remarks>
    public void SetOrder(CompanionOrder order)
    {
        CurrentOrder = order;
    }

    /// <summary>
    /// Sets the companion's state.
    /// </summary>
    /// <param name="state">The new state.</param>
    public void SetState(CompanionState state)
    {
        State = state;
    }

    /// <summary>
    /// Equips an item to the companion.
    /// </summary>
    /// <param name="item">The item to equip.</param>
    /// <param name="slot">The equipment slot.</param>
    /// <returns>Result containing success status and any unequipped item.</returns>
    public EquipResult Equip(Item item, EquipmentSlot slot)
    {
        if (!item.IsEquippable)
            return EquipResult.Failure("Item cannot be equipped.");

        var equipment = new Dictionary<EquipmentSlot, Item>(Equipment);
        Item? previousItem = null;

        if (equipment.TryGetValue(slot, out var existing))
        {
            previousItem = existing;
        }

        equipment[slot] = item;
        Equipment = equipment;

        return EquipResult.Success(item, previousItem);
    }

    /// <summary>
    /// Unequips an item from a slot.
    /// </summary>
    /// <param name="slot">The slot to unequip.</param>
    /// <returns>The unequipped item, or null if slot was empty.</returns>
    public Item? Unequip(EquipmentSlot slot)
    {
        var equipment = new Dictionary<EquipmentSlot, Item>(Equipment);

        if (!equipment.TryGetValue(slot, out var item))
            return null;

        equipment.Remove(slot);
        Equipment = equipment;

        return item;
    }

    /// <summary>
    /// Dismisses the companion, returning them to NPC state.
    /// </summary>
    /// <remarks>
    /// Sets state to Dismissed and makes the underlying NPC available again.
    /// The companion entity should be removed from tracking after dismissal.
    /// </remarks>
    public void Dismiss()
    {
        State = CompanionState.Dismissed;
        NPC.SetAvailability(true);
    }

    /// <summary>
    /// Gets whether the companion is alive.
    /// </summary>
    /// <remarks>
    /// False when CurrentHealth is 0 or below.
    /// </remarks>
    public bool IsAlive => CurrentHealth > 0;

    /// <summary>
    /// Gets whether the companion is active and following.
    /// </summary>
    /// <remarks>
    /// True only when Following state AND alive.
    /// Determines if companion participates in combat.
    /// </remarks>
    public bool IsActive => State == CompanionState.Following && IsAlive;
}
```

### 5.2 CompanionState Enum

```csharp
namespace RuneAndRust.Domain.Enums;

/// <summary>
/// Represents the current state of a companion.
/// </summary>
/// <remarks>
/// State determines companion behavior and availability.
/// Only Following companions participate in combat.
/// </remarks>
public enum CompanionState
{
    /// <summary>
    /// Following and active with the player.
    /// </summary>
    /// <remarks>
    /// Default state after recruitment. Companion moves with player
    /// and participates in combat.
    /// </remarks>
    Following,

    /// <summary>
    /// Waiting at a location.
    /// </summary>
    /// <remarks>
    /// Companion stays in current room and does not follow.
    /// Can be commanded to resume following.
    /// </remarks>
    Waiting,

    /// <summary>
    /// Knocked out in combat.
    /// </summary>
    /// <remarks>
    /// Set when health reaches 0. Companion cannot act.
    /// Recovers to 1 HP after victorious combat.
    /// </remarks>
    Unconscious,

    /// <summary>
    /// Permanently dismissed.
    /// </summary>
    /// <remarks>
    /// Set when player dismisses companion. NPC becomes available
    /// again for potential re-recruitment.
    /// </remarks>
    Dismissed
}
```

### 5.3 CompanionStats Value Object

```csharp
namespace RuneAndRust.Domain.ValueObjects;

/// <summary>
/// Combat statistics for a companion.
/// </summary>
/// <remarks>
/// Immutable value object containing base combat stats.
/// Can be scaled by level for progression.
/// </remarks>
public readonly record struct CompanionStats
{
    /// <summary>
    /// Gets the maximum health.
    /// </summary>
    /// <remarks>
    /// Determines companion survivability. Typical range: 20-60.
    /// </remarks>
    public int MaxHealth { get; init; }

    /// <summary>
    /// Gets the base attack damage.
    /// </summary>
    /// <remarks>
    /// Added to weapon damage for attack calculations.
    /// </remarks>
    public int Attack { get; init; }

    /// <summary>
    /// Gets the base defense.
    /// </summary>
    /// <remarks>
    /// Reduces incoming damage from attacks.
    /// </remarks>
    public int Defense { get; init; }

    /// <summary>
    /// Gets the initiative modifier.
    /// </summary>
    /// <remarks>
    /// Added to initiative roll for turn order. Can be negative.
    /// </remarks>
    public int Initiative { get; init; }

    /// <summary>
    /// Gets the accuracy modifier.
    /// </summary>
    /// <remarks>
    /// Added to attack rolls. Higher values mean more hits.
    /// </remarks>
    public int Accuracy { get; init; }

    /// <summary>
    /// Gets default companion stats.
    /// </summary>
    /// <remarks>
    /// Used when NPC definition doesn't specify companion stats.
    /// Represents a basic, balanced companion.
    /// </remarks>
    public static CompanionStats Default => new()
    {
        MaxHealth = 30,
        Attack = 5,
        Defense = 3,
        Initiative = 0,
        Accuracy = 0
    };

    /// <summary>
    /// Scales stats by level.
    /// </summary>
    /// <param name="level">The level to scale to.</param>
    /// <returns>New stats scaled for the specified level.</returns>
    /// <remarks>
    /// Applies 10% increase per level above 1.
    /// Initiative and Accuracy don't scale (flat bonuses).
    /// </remarks>
    public CompanionStats ScaleToLevel(int level)
    {
        var multiplier = 1 + ((level - 1) * 0.1);
        return new CompanionStats
        {
            MaxHealth = (int)(MaxHealth * multiplier),
            Attack = (int)(Attack * multiplier),
            Defense = (int)(Defense * multiplier),
            Initiative = Initiative,
            Accuracy = Accuracy
        };
    }
}
```

### 5.4 CompanionOrder Value Object

```csharp
namespace RuneAndRust.Domain.ValueObjects;

/// <summary>
/// Represents an order given to a companion.
/// </summary>
/// <remarks>
/// Orders determine companion behavior in combat.
/// Changed via the `order` command.
/// </remarks>
public readonly record struct CompanionOrder
{
    /// <summary>
    /// Gets the order type.
    /// </summary>
    /// <remarks>
    /// Determines the general behavior pattern.
    /// </remarks>
    public CompanionOrderType Type { get; init; }

    /// <summary>
    /// Gets the target ID if applicable.
    /// </summary>
    /// <remarks>
    /// Used by FocusTarget to specify which enemy to prioritize.
    /// Null for orders without specific targets.
    /// </remarks>
    public Guid? TargetId { get; init; }

    /// <summary>
    /// Gets additional parameters.
    /// </summary>
    /// <remarks>
    /// Reserved for future order types that need string data.
    /// </remarks>
    public string? Parameters { get; init; }

    /// <summary>
    /// Gets the default order (attack enemies).
    /// </summary>
    /// <remarks>
    /// Companion attacks nearest enemy each turn.
    /// </remarks>
    public static CompanionOrder Default => new()
    {
        Type = CompanionOrderType.AttackTarget
    };

    /// <summary>
    /// Creates a defend order.
    /// </summary>
    /// <returns>Order that makes companion prioritize protecting player.</returns>
    /// <remarks>
    /// Companion gains defense bonus and may intercept attacks.
    /// </remarks>
    public static CompanionOrder Defend() => new()
    {
        Type = CompanionOrderType.Defend
    };

    /// <summary>
    /// Creates a focus target order.
    /// </summary>
    /// <param name="targetId">The enemy to focus.</param>
    /// <returns>Order that makes companion attack specific enemy.</returns>
    public static CompanionOrder Focus(Guid targetId) => new()
    {
        Type = CompanionOrderType.FocusTarget,
        TargetId = targetId
    };

    /// <summary>
    /// Creates a use abilities order.
    /// </summary>
    /// <returns>Order that allows companion to use special abilities.</returns>
    /// <remarks>
    /// Companion may use abilities instead of basic attacks.
    /// </remarks>
    public static CompanionOrder UseAbilities() => new()
    {
        Type = CompanionOrderType.UseAbilities
    };

    /// <summary>
    /// Creates a stay back order.
    /// </summary>
    /// <returns>Order that makes companion avoid combat.</returns>
    /// <remarks>
    /// Companion takes defensive actions and avoids attacking.
    /// Useful for protecting low-health companions.
    /// </remarks>
    public static CompanionOrder StayBack() => new()
    {
        Type = CompanionOrderType.StayBack
    };
}
```

### 5.5 CompanionOrderType Enum

```csharp
namespace RuneAndRust.Domain.Enums;

/// <summary>
/// Types of orders companions can follow.
/// </summary>
/// <remarks>
/// Each order type produces different AI behavior in combat.
/// </remarks>
public enum CompanionOrderType
{
    /// <summary>
    /// Attack the nearest enemy.
    /// </summary>
    /// <remarks>
    /// Default behavior. Companion attacks closest hostile target.
    /// </remarks>
    AttackTarget,

    /// <summary>
    /// Focus on defending the player.
    /// </summary>
    /// <remarks>
    /// Companion gains +2 defense and may intercept attacks
    /// targeting the player.
    /// </remarks>
    Defend,

    /// <summary>
    /// Focus attacks on a specific target.
    /// </summary>
    /// <remarks>
    /// Companion prioritizes the specified enemy until defeated,
    /// then reverts to nearest target behavior.
    /// </remarks>
    FocusTarget,

    /// <summary>
    /// Use abilities freely.
    /// </summary>
    /// <remarks>
    /// Companion may use special abilities if available.
    /// Falls back to attacks if no abilities ready.
    /// </remarks>
    UseAbilities,

    /// <summary>
    /// Stay back and avoid combat.
    /// </summary>
    /// <remarks>
    /// Companion takes dodge action and doesn't attack.
    /// Useful for protecting wounded companions.
    /// </remarks>
    StayBack
}
```

### 5.6 Result Types

```csharp
namespace RuneAndRust.Domain.ValueObjects;

/// <summary>
/// Result of issuing an order to a companion.
/// </summary>
public readonly record struct OrderResult
{
    /// <summary>
    /// Gets whether the order was accepted.
    /// </summary>
    public bool Success { get; init; }

    /// <summary>
    /// Gets the message describing the result.
    /// </summary>
    public string Message { get; init; }

    /// <summary>
    /// Gets the order that was issued.
    /// </summary>
    public CompanionOrder? Order { get; init; }

    /// <summary>
    /// Creates a successful order result.
    /// </summary>
    public static OrderResult Successful(CompanionOrder order, string message) => new()
    {
        Success = true,
        Message = message,
        Order = order
    };

    /// <summary>
    /// Creates a failed order result.
    /// </summary>
    public static OrderResult Failed(string message) => new()
    {
        Success = false,
        Message = message,
        Order = null
    };
}

/// <summary>
/// Result of dismissing a companion.
/// </summary>
public readonly record struct DismissResult
{
    /// <summary>
    /// Gets whether the dismissal succeeded.
    /// </summary>
    public bool Success { get; init; }

    /// <summary>
    /// Gets the message describing the result.
    /// </summary>
    public string Message { get; init; }

    /// <summary>
    /// Gets the name of the dismissed companion.
    /// </summary>
    public string? CompanionName { get; init; }

    /// <summary>
    /// Creates a successful dismissal result.
    /// </summary>
    public static DismissResult Successful(string companionName) => new()
    {
        Success = true,
        Message = $"{companionName} has been dismissed from your party.",
        CompanionName = companionName
    };

    /// <summary>
    /// Creates a failed dismissal result.
    /// </summary>
    public static DismissResult Failed(string message) => new()
    {
        Success = false,
        Message = message,
        CompanionName = null
    };
}
```

### 5.7 PartyStatusDto

```csharp
namespace RuneAndRust.Application.DTOs;

/// <summary>
/// Data transfer object for party status display.
/// </summary>
public record PartyStatusDto
{
    /// <summary>
    /// Gets the player information.
    /// </summary>
    public required PlayerSummaryDto Player { get; init; }

    /// <summary>
    /// Gets the companion information, if any.
    /// </summary>
    public CompanionSummaryDto? Companion { get; init; }

    /// <summary>
    /// Gets whether the player has an active companion.
    /// </summary>
    public bool HasCompanion => Companion is not null;
}

/// <summary>
/// Summary information for player in party display.
/// </summary>
public record PlayerSummaryDto
{
    /// <summary>
    /// Gets the player's name.
    /// </summary>
    public required string Name { get; init; }

    /// <summary>
    /// Gets the player's level.
    /// </summary>
    public int Level { get; init; }

    /// <summary>
    /// Gets the player's class.
    /// </summary>
    public required string Class { get; init; }

    /// <summary>
    /// Gets the player's current health.
    /// </summary>
    public int CurrentHealth { get; init; }

    /// <summary>
    /// Gets the player's maximum health.
    /// </summary>
    public int MaxHealth { get; init; }

    /// <summary>
    /// Gets the player's current stamina.
    /// </summary>
    public int CurrentStamina { get; init; }

    /// <summary>
    /// Gets the player's maximum stamina.
    /// </summary>
    public int MaxStamina { get; init; }
}

/// <summary>
/// Summary information for companion in party display.
/// </summary>
public record CompanionSummaryDto
{
    /// <summary>
    /// Gets the companion's name.
    /// </summary>
    public required string Name { get; init; }

    /// <summary>
    /// Gets the companion's current health.
    /// </summary>
    public int CurrentHealth { get; init; }

    /// <summary>
    /// Gets the companion's maximum health.
    /// </summary>
    public int MaxHealth { get; init; }

    /// <summary>
    /// Gets the companion's current state.
    /// </summary>
    public required string State { get; init; }

    /// <summary>
    /// Gets the companion's current order.
    /// </summary>
    public required string Order { get; init; }

    /// <summary>
    /// Gets equipped item names.
    /// </summary>
    public required IReadOnlyList<string> Equipment { get; init; }

    /// <summary>
    /// Gets the companion's level.
    /// </summary>
    public int Level { get; init; }
}
```

---

## 6. Configuration Schemas

### 6.1 NPCs Configuration Update (npcs.json)

NPCDefinitions are extended with optional companion stats:

```json
{
  "npcs": [
    {
      "id": "torvin-guard",
      "name": "Torvin the Guard",
      "description": "A sturdy dwarf with a scarred face and watchful eyes.",
      "type": "Companion",
      "defaultAttitude": "Neutral",
      "greeting": "Aye, what do you want? I don't have time for idle chatter.",
      "appearance": {
        "race": "Dwarf",
        "features": "scarred face, braided beard",
        "attire": "worn chainmail armor"
      },
      "rootDialogueId": "torvin-main",
      "factionId": "dungeon-guards",
      "companionStats": {
        "maxHealth": 40,
        "attack": 7,
        "defense": 5,
        "initiative": -1,
        "accuracy": 2
      }
    },
    {
      "id": "lyra-scout",
      "name": "Lyra",
      "description": "A quick-footed elf with keen eyes and a ready bow.",
      "type": "Companion",
      "defaultAttitude": "Wary",
      "greeting": "You move loudly. That will get you killed in these halls.",
      "appearance": {
        "race": "Elf",
        "features": "sharp green eyes, pointed ears",
        "attire": "leather traveling clothes"
      },
      "rootDialogueId": "lyra-main",
      "companionStats": {
        "maxHealth": 25,
        "attack": 6,
        "defense": 2,
        "initiative": 3,
        "accuracy": 4
      }
    }
  ]
}
```

### 6.2 Updated NPC Schema (npcs.schema.json)

```json
{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "npcs.schema.json",
  "title": "NPC Definitions",
  "description": "Schema for NPC configuration including companion stats",
  "type": "object",
  "required": ["npcs"],
  "properties": {
    "npcs": {
      "type": "array",
      "items": {
        "$ref": "#/$defs/npcDefinition"
      }
    }
  },
  "$defs": {
    "npcDefinition": {
      "type": "object",
      "required": ["id", "name", "type", "defaultAttitude", "greeting"],
      "properties": {
        "id": {
          "type": "string",
          "pattern": "^[a-z0-9-]+$",
          "description": "Unique identifier (lowercase, hyphens only)"
        },
        "name": {
          "type": "string",
          "minLength": 1,
          "description": "Display name"
        },
        "description": {
          "type": "string",
          "description": "Visual/narrative description"
        },
        "type": {
          "type": "string",
          "enum": ["Merchant", "QuestGiver", "Informant", "Companion", "Wanderer"],
          "description": "NPC role type"
        },
        "defaultAttitude": {
          "type": "string",
          "enum": ["Friendly", "Neutral", "Wary", "Hostile"],
          "description": "Starting attitude toward players"
        },
        "greeting": {
          "type": "string",
          "description": "Initial dialogue text"
        },
        "appearance": {
          "$ref": "#/$defs/appearance"
        },
        "rootDialogueId": {
          "type": "string",
          "description": "Entry point for dialogue tree"
        },
        "factionId": {
          "type": "string",
          "description": "Faction membership for reputation"
        },
        "companionStats": {
          "$ref": "#/$defs/companionStats",
          "description": "Combat stats if recruitable as companion"
        }
      }
    },
    "appearance": {
      "type": "object",
      "properties": {
        "race": {
          "type": "string",
          "default": "Human"
        },
        "features": {
          "type": "string",
          "default": "unremarkable features"
        },
        "attire": {
          "type": "string",
          "default": "simple clothes"
        }
      }
    },
    "companionStats": {
      "type": "object",
      "description": "Combat statistics for companion recruitment",
      "properties": {
        "maxHealth": {
          "type": "integer",
          "minimum": 1,
          "default": 30,
          "description": "Maximum health points"
        },
        "attack": {
          "type": "integer",
          "minimum": 0,
          "default": 5,
          "description": "Base attack power"
        },
        "defense": {
          "type": "integer",
          "minimum": 0,
          "default": 3,
          "description": "Base defense"
        },
        "initiative": {
          "type": "integer",
          "default": 0,
          "description": "Initiative modifier (can be negative)"
        },
        "accuracy": {
          "type": "integer",
          "default": 0,
          "description": "Accuracy modifier"
        }
      }
    }
  }
}
```

### 6.3 Dialogue with Recruitment Outcome

Example dialogue configuration from dialogues.json:

```json
{
  "nodes": [
    {
      "id": "torvin-join",
      "speaker": "Torvin",
      "text": "You've proven yourself. I'll watch your back if you'll have me.",
      "options": [
        {
          "text": "Welcome to the party, Torvin.",
          "targetNodeId": "torvin-recruited",
          "outcomes": [
            {
              "type": "RecruitCompanion",
              "targetId": "torvin-guard"
            }
          ]
        },
        {
          "text": "I appreciate the offer, but I work alone.",
          "targetNodeId": "torvin-declined"
        }
      ]
    },
    {
      "id": "torvin-recruited",
      "speaker": "",
      "text": "Torvin nods firmly and takes position at your side.",
      "isTerminal": true
    }
  ]
}
```

---

## 7. Service Specifications

### 7.1 ICompanionService Interface

```csharp
namespace RuneAndRust.Application.Interfaces;

/// <summary>
/// Service for managing companion recruitment, orders, and integration.
/// </summary>
public interface ICompanionService
{
    /// <summary>
    /// Recruits an NPC as a companion.
    /// </summary>
    /// <param name="npc">The NPC to recruit.</param>
    /// <param name="player">The recruiting player.</param>
    /// <returns>The created companion, or null if recruitment failed.</returns>
    /// <remarks>
    /// Fails if player already has a companion or NPC is unavailable.
    /// </remarks>
    Companion? RecruitCompanion(NPC npc, Player player);

    /// <summary>
    /// Dismisses a companion.
    /// </summary>
    /// <param name="companion">The companion to dismiss.</param>
    void DismissCompanion(Companion companion);

    /// <summary>
    /// Gets the player's active companion.
    /// </summary>
    /// <param name="playerId">The player's ID.</param>
    /// <returns>The active companion, or null if none.</returns>
    Companion? GetActiveCompanion(Guid playerId);

    /// <summary>
    /// Issues an order to a companion.
    /// </summary>
    /// <param name="companion">The companion to order.</param>
    /// <param name="order">The order to issue.</param>
    void IssueOrder(Companion companion, CompanionOrder order);

    /// <summary>
    /// Equips an item on a companion.
    /// </summary>
    /// <param name="companion">The companion to equip.</param>
    /// <param name="item">The item to equip.</param>
    /// <param name="slot">The equipment slot.</param>
    /// <returns>Result of the equip operation.</returns>
    EquipResult EquipCompanion(Companion companion, Item item, EquipmentSlot slot);

    /// <summary>
    /// Gets the companion's combat action based on current order.
    /// </summary>
    /// <param name="companion">The companion.</param>
    /// <param name="context">Combat context for decision making.</param>
    /// <returns>The AI decision for this turn.</returns>
    AIDecision GetCompanionAction(Companion companion, AIContext context);

    /// <summary>
    /// Processes end-of-combat for companion.
    /// </summary>
    /// <param name="companion">The companion.</param>
    /// <param name="victory">Whether combat was won.</param>
    void ProcessCombatEnd(Companion companion, bool victory);
}
```

### 7.2 CompanionService Implementation

```csharp
namespace RuneAndRust.Application.Services;

/// <summary>
/// Implementation of companion management service.
/// </summary>
public class CompanionService : ICompanionService
{
    private readonly IConfigurationProvider _configProvider;
    private readonly ILogger<CompanionService> _logger;
    private readonly Dictionary<Guid, Companion> _activeCompanions = new();

    /// <summary>
    /// Initializes a new instance of the CompanionService.
    /// </summary>
    /// <param name="configProvider">Configuration provider for companion stats.</param>
    /// <param name="logger">Logger for service operations.</param>
    public CompanionService(
        IConfigurationProvider configProvider,
        ILogger<CompanionService> logger)
    {
        _configProvider = configProvider;
        _logger = logger;

        _logger.LogInformation("CompanionService initialized");
    }

    /// <inheritdoc />
    public Companion? RecruitCompanion(NPC npc, Player player)
    {
        _logger.LogDebug(
            "Attempting to recruit NPC {NPCName} for player {PlayerId}",
            npc.Name, player.Id);

        // Check if player already has a companion
        if (_activeCompanions.ContainsKey(player.Id))
        {
            _logger.LogDebug("Player already has an active companion");
            return null;
        }

        // Check if NPC is available
        if (!npc.IsAvailable)
        {
            _logger.LogDebug("NPC {NPCName} is not available", npc.Name);
            return null;
        }

        // Check if NPC type supports companionship
        if (npc.Type != NPCType.Companion)
        {
            _logger.LogDebug("NPC {NPCName} is not a companion type", npc.Name);
            return null;
        }

        // Get companion stats from configuration or use defaults
        var stats = _configProvider.LoadCompanionStats(npc.DefinitionId)
            ?? CompanionStats.Default;

        // Scale stats to player level
        var scaledStats = stats.ScaleToLevel(player.Level);

        // Create companion
        var companion = Companion.Recruit(npc, player.Id, scaledStats);

        // Track active companion
        _activeCompanions[player.Id] = companion;

        _logger.LogInformation(
            "Recruited companion {CompanionName} for player {PlayerId}",
            companion.NPC.Name, player.Id);

        return companion;
    }

    /// <inheritdoc />
    public void DismissCompanion(Companion companion)
    {
        _logger.LogDebug(
            "Dismissing companion {CompanionName} for player {PlayerId}",
            companion.NPC.Name, companion.PlayerId);

        companion.Dismiss();
        _activeCompanions.Remove(companion.PlayerId);

        _logger.LogInformation(
            "Dismissed companion {CompanionName}",
            companion.NPC.Name);
    }

    /// <inheritdoc />
    public Companion? GetActiveCompanion(Guid playerId)
    {
        _activeCompanions.TryGetValue(playerId, out var companion);

        if (companion?.State == CompanionState.Dismissed)
        {
            _activeCompanions.Remove(playerId);
            return null;
        }

        return companion;
    }

    /// <inheritdoc />
    public void IssueOrder(Companion companion, CompanionOrder order)
    {
        _logger.LogDebug(
            "Issuing order {OrderType} to companion {CompanionName}",
            order.Type, companion.NPC.Name);

        companion.SetOrder(order);

        _logger.LogInformation(
            "Companion {CompanionName} received order: {OrderType}",
            companion.NPC.Name, order.Type);
    }

    /// <inheritdoc />
    public EquipResult EquipCompanion(Companion companion, Item item, EquipmentSlot slot)
    {
        _logger.LogDebug(
            "Equipping {ItemName} on companion {CompanionName} to slot {Slot}",
            item.Name, companion.NPC.Name, slot);

        var result = companion.Equip(item, slot);

        if (result.Success)
        {
            _logger.LogInformation(
                "Equipped {ItemName} on {CompanionName}",
                item.Name, companion.NPC.Name);
        }
        else
        {
            _logger.LogDebug(
                "Failed to equip {ItemName}: {Message}",
                item.Name, result.Message);
        }

        return result;
    }

    /// <inheritdoc />
    public AIDecision GetCompanionAction(Companion companion, AIContext context)
    {
        _logger.LogDebug(
            "Getting action for companion {CompanionName} with order {OrderType}",
            companion.NPC.Name, companion.CurrentOrder.Type);

        return companion.CurrentOrder.Type switch
        {
            CompanionOrderType.AttackTarget => GetAttackNearestAction(companion, context),
            CompanionOrderType.Defend => GetDefendAction(companion, context),
            CompanionOrderType.FocusTarget => GetFocusTargetAction(companion, context),
            CompanionOrderType.UseAbilities => GetUseAbilitiesAction(companion, context),
            CompanionOrderType.StayBack => GetStayBackAction(companion, context),
            _ => GetAttackNearestAction(companion, context)
        };
    }

    /// <inheritdoc />
    public void ProcessCombatEnd(Companion companion, bool victory)
    {
        _logger.LogDebug(
            "Processing combat end for companion {CompanionName}, victory: {Victory}",
            companion.NPC.Name, victory);

        if (!companion.IsAlive && victory)
        {
            // Recover unconscious companion after victory
            companion.Heal(1);
            companion.SetState(CompanionState.Following);

            _logger.LogInformation(
                "Companion {CompanionName} recovered from unconsciousness",
                companion.NPC.Name);
        }
        else if (!companion.IsAlive)
        {
            companion.SetState(CompanionState.Unconscious);
        }
    }

    private AIDecision GetAttackNearestAction(Companion companion, AIContext context)
    {
        var nearestEnemy = context.GetNearestEnemy();
        if (nearestEnemy is null)
        {
            return AIDecision.Defend();
        }

        return AIDecision.Attack(nearestEnemy.Id);
    }

    private AIDecision GetDefendAction(Companion companion, AIContext context)
    {
        return AIDecision.Defend();
    }

    private AIDecision GetFocusTargetAction(Companion companion, AIContext context)
    {
        var targetId = companion.CurrentOrder.TargetId;

        if (targetId.HasValue && context.IsTargetAlive(targetId.Value))
        {
            return AIDecision.Attack(targetId.Value);
        }

        // Fall back to nearest enemy
        return GetAttackNearestAction(companion, context);
    }

    private AIDecision GetUseAbilitiesAction(Companion companion, AIContext context)
    {
        // Future: Check for available abilities
        // For now, fall back to attack
        return GetAttackNearestAction(companion, context);
    }

    private AIDecision GetStayBackAction(Companion companion, AIContext context)
    {
        return AIDecision.Dodge();
    }
}
```

### 7.3 DialogueService Update

Update to implement OutcomeType.RecruitCompanion:

```csharp
// In DialogueService.ApplyOutcome method

case OutcomeType.RecruitCompanion:
    _logger.LogDebug("Applying RecruitCompanion outcome for NPC {NPCId}", outcome.TargetId);

    var npc = _npcService.GetNPCByDefinitionId(outcome.TargetId, context.Room);
    if (npc is not null)
    {
        var companion = _companionService.RecruitCompanion(npc, context.Player);
        if (companion is not null)
        {
            _logger.LogInformation(
                "Player {PlayerId} recruited companion {CompanionName}",
                context.Player.Id, companion.NPC.Name);
        }
    }
    break;
```

### 7.4 CombatEncounter Updates

```csharp
// In CombatEncounter entity

/// <summary>
/// Gets companion combatants in this encounter.
/// </summary>
public IReadOnlyList<Combatant> CompanionCombatants { get; private set; }
    = Array.Empty<Combatant>();

/// <summary>
/// Adds a companion to the combat encounter.
/// </summary>
/// <param name="companion">The companion to add.</param>
public void AddCompanion(Companion companion)
{
    if (!companion.IsActive)
        return;

    var combatant = Combatant.FromCompanion(companion);
    var combatants = new List<Combatant>(CompanionCombatants) { combatant };
    CompanionCombatants = combatants;
}

/// <summary>
/// Checks if it's currently a companion's turn.
/// </summary>
/// <returns>True if the current turn belongs to a companion.</returns>
public bool IsCompanionTurn()
{
    var currentCombatant = GetCurrentCombatant();
    return CompanionCombatants.Any(c => c.Id == currentCombatant?.Id);
}
```

---

## 8. Companion Command Flow

### 8.1 Party Command

```
┌───────────────────┐
│   Player Input    │
│     "party"       │
└─────────┬─────────┘
          │
          ▼
┌───────────────────┐      ┌───────────────────┐
│   PartyHandler    │─────▶│ GameSessionService│
│   HandleParty()   │      │ GetPartyStatus()  │
└───────────────────┘      └─────────┬─────────┘
                                     │
                                     ▼
                           ┌───────────────────┐
                           │ CompanionService  │
                           │ GetActiveCompanion│
                           └─────────┬─────────┘
                                     │
                           ┌─────────┴─────────┐
                           │                   │
                           ▼                   ▼
                    ┌─────────────┐     ┌─────────────┐
                    │ Has Comp.   │     │ No Comp.    │
                    │ Include info│     │ Player only │
                    └──────┬──────┘     └──────┬──────┘
                           │                   │
                           └─────────┬─────────┘
                                     │
                                     ▼
                           ┌───────────────────┐
                           │ Build PartyStatus │
                           │       DTO         │
                           └─────────┬─────────┘
                                     │
                                     ▼
                           ┌───────────────────┐
                           │  IGameRenderer    │
                           │ RenderPartyStatus │
                           └───────────────────┘
```

### 8.2 Order Command

```
┌───────────────────┐
│   Player Input    │
│ "order defend" or │
│ "order attack     │
│       goblin"     │
└─────────┬─────────┘
          │
          ▼
┌───────────────────┐
│   OrderHandler    │
│ ParseOrderCommand │
└─────────┬─────────┘
          │
          ├───────────────────────────────────────────────┐
          │                                               │
          ▼                                               ▼
┌───────────────────┐                           ┌───────────────────┐
│ No Companion      │                           │ Has Companion     │
│ Return error      │                           │ Continue...       │
└───────────────────┘                           └─────────┬─────────┘
                                                          │
                                                          ▼
                                                ┌───────────────────┐
                                                │ Parse Order Type  │
                                                └─────────┬─────────┘
                                                          │
                    ┌─────────────────────────────────────┼─────────────────────────────────────┐
                    │                 │                   │                   │                 │
                    ▼                 ▼                   ▼                   ▼                 ▼
             ┌──────────┐      ┌──────────┐        ┌──────────┐        ┌──────────┐      ┌──────────┐
             │ "attack" │      │ "defend" │        │ "focus"  │        │"abilities│      │ "back"   │
             │ (default)│      │          │        │ + target │        │          │      │          │
             └────┬─────┘      └────┬─────┘        └────┬─────┘        └────┬─────┘      └────┬─────┘
                  │                 │                   │                   │                 │
                  ▼                 ▼                   ▼                   ▼                 ▼
             ┌──────────────────────────────────────────────────────────────────────────────────────┐
             │                          CompanionService.IssueOrder()                               │
             └──────────────────────────────────────────┬───────────────────────────────────────────┘
                                                        │
                                                        ▼
                                              ┌───────────────────┐
                                              │  Return OrderResult│
                                              │  Display message   │
                                              └───────────────────┘
```

---

## 9. User-Facing Changes

### 9.1 New Commands

| Command | Description | Example |
|---------|-------------|---------|
| `party` | View party status | `party` |
| `order <type>` | Give companion order | `order defend` |
| `order attack <target>` | Focus companion on target | `order attack goblin` |
| `equip companion <item>` | Equip item on companion | `equip companion iron sword` |
| `dismiss` | Dismiss current companion | `dismiss` |

### 9.2 Output Examples

**Party Status:**
```
> party

Your Party:

[You] Level 5 Warrior
Health: 45/50  Stamina: 8/10

[Companion] Torvin the Guard
Health: 38/40  State: Following
Order: Attack Target
Equipment: Iron Sword, Leather Armor
```

**Giving Orders:**
```
> order defend
You signal Torvin to focus on defense.

> order attack goblin archer
You signal Torvin to focus on the Goblin Archer.
```

**Combat with Companion:**
```
=== COMBAT ===
Round 3

Your Party:
- You (45/50 HP)
- Torvin (38/40 HP)

Enemies:
- Goblin Warrior (12/20 HP)
- Goblin Archer (8/15 HP)

> attack warrior
You strike the Goblin Warrior for 6 damage!

Torvin's Turn:
Torvin attacks the Goblin Archer for 8 damage!
The Goblin Archer has 0 HP remaining and is defeated!
```

**Companion Recruitment:**
```
[Torvin]
"You've proven yourself. I'll watch your back if you'll have me."

1. "Welcome to the party, Torvin."
2. "I appreciate the offer, but I work alone."

> 1

Torvin nods firmly and takes position at your side.
Torvin has joined your party!
```

**Companion Defeat:**
```
The Goblin Warrior strikes Torvin for 15 damage!
Torvin falls unconscious!
```

**Companion Recovery:**
```
=== VICTORY ===

You defeated 2 enemies and gained 50 XP.
Torvin regains consciousness and struggles to their feet.
```

**Dismissing Companion:**
```
> dismiss
You thank Torvin for their service.
Torvin has been dismissed from your party.
```

---

## 10. Logging Requirements

### 10.1 Service Initialization

```
[Information] CompanionService initialized
```

### 10.2 Recruitment Operations

```
[Debug] Attempting to recruit NPC {NPCName} for player {PlayerId}
[Debug] Player already has an active companion
[Debug] NPC {NPCName} is not available
[Debug] NPC {NPCName} is not a companion type
[Information] Recruited companion {CompanionName} for player {PlayerId}
```

### 10.3 Order Operations

```
[Debug] Issuing order {OrderType} to companion {CompanionName}
[Information] Companion {CompanionName} received order: {OrderType}
```

### 10.4 Equipment Operations

```
[Debug] Equipping {ItemName} on companion {CompanionName} to slot {Slot}
[Information] Equipped {ItemName} on {CompanionName}
[Debug] Failed to equip {ItemName}: {Message}
```

### 10.5 Combat Operations

```
[Debug] Getting action for companion {CompanionName} with order {OrderType}
[Debug] Processing combat end for companion {CompanionName}, victory: {Victory}
[Information] Companion {CompanionName} recovered from unconsciousness
```

### 10.6 Dismissal Operations

```
[Debug] Dismissing companion {CompanionName} for player {PlayerId}
[Information] Dismissed companion {CompanionName}
```

---

## 11. Unit Test Specifications

### 11.1 Companion Entity Tests (~8 tests)

```csharp
[TestFixture]
public class CompanionTests
{
    private NPC _testNPC;
    private Guid _playerId;
    private CompanionStats _testStats;

    [SetUp]
    public void Setup()
    {
        var definition = NPCDefinition.Create(
            "test", "Test NPC", NPCType.Companion, NPCAttitude.Neutral, "Hi", "Desc");
        _testNPC = NPC.Create(definition);
        _playerId = Guid.NewGuid();
        _testStats = new CompanionStats
        {
            MaxHealth = 30,
            Attack = 5,
            Defense = 3,
            Initiative = 0,
            Accuracy = 0
        };
    }

    [Test]
    public void Recruit_WithValidNPC_CreatesCompanion()
    {
        var companion = Companion.Recruit(_testNPC, _playerId, _testStats);

        companion.Should().NotBeNull();
        companion.NPC.Should().Be(_testNPC);
        companion.PlayerId.Should().Be(_playerId);
        companion.State.Should().Be(CompanionState.Following);
    }

    [Test]
    public void Recruit_SetsNPCUnavailable()
    {
        var companion = Companion.Recruit(_testNPC, _playerId, _testStats);

        _testNPC.IsAvailable.Should().BeFalse();
    }

    [Test]
    public void Recruit_InitializesFullHealth()
    {
        var companion = Companion.Recruit(_testNPC, _playerId, _testStats);

        companion.CurrentHealth.Should().Be(companion.MaxHealth);
    }

    [Test]
    public void TakeDamage_ReducesHealth()
    {
        var companion = Companion.Recruit(_testNPC, _playerId, _testStats);
        var initialHealth = companion.CurrentHealth;

        var damage = companion.TakeDamage(10);

        damage.Should().Be(10);
        companion.CurrentHealth.Should().Be(initialHealth - 10);
    }

    [Test]
    public void TakeDamage_CannotExceedCurrentHealth()
    {
        var companion = Companion.Recruit(_testNPC, _playerId, _testStats);
        companion.TakeDamage(companion.MaxHealth - 5);

        var damage = companion.TakeDamage(10);

        damage.Should().Be(5);
        companion.CurrentHealth.Should().Be(0);
    }

    [Test]
    public void Heal_RestoresHealth()
    {
        var companion = Companion.Recruit(_testNPC, _playerId, _testStats);
        companion.TakeDamage(20);

        var healed = companion.Heal(10);

        healed.Should().Be(10);
        companion.CurrentHealth.Should().Be(companion.MaxHealth - 10);
    }

    [Test]
    public void Dismiss_SetsStateAndMakesNPCAvailable()
    {
        var companion = Companion.Recruit(_testNPC, _playerId, _testStats);

        companion.Dismiss();

        companion.State.Should().Be(CompanionState.Dismissed);
        _testNPC.IsAvailable.Should().BeTrue();
    }

    [Test]
    public void IsActive_TrueWhenFollowingAndAlive()
    {
        var companion = Companion.Recruit(_testNPC, _playerId, _testStats);

        companion.IsActive.Should().BeTrue();
    }
}
```

### 11.2 CompanionStats Tests (~4 tests)

```csharp
[TestFixture]
public class CompanionStatsTests
{
    [Test]
    public void Default_ReturnsBalancedStats()
    {
        var stats = CompanionStats.Default;

        stats.MaxHealth.Should().Be(30);
        stats.Attack.Should().Be(5);
        stats.Defense.Should().Be(3);
    }

    [Test]
    public void ScaleToLevel_Level1_ReturnsUnchanged()
    {
        var stats = CompanionStats.Default;

        var scaled = stats.ScaleToLevel(1);

        scaled.MaxHealth.Should().Be(stats.MaxHealth);
        scaled.Attack.Should().Be(stats.Attack);
    }

    [Test]
    public void ScaleToLevel_Level5_Increases40Percent()
    {
        var stats = CompanionStats.Default;

        var scaled = stats.ScaleToLevel(5);

        scaled.MaxHealth.Should().Be(42); // 30 * 1.4 = 42
        scaled.Attack.Should().Be(7);     // 5 * 1.4 = 7
    }

    [Test]
    public void ScaleToLevel_InitiativeDoesNotScale()
    {
        var stats = new CompanionStats { Initiative = 2, MaxHealth = 30 };

        var scaled = stats.ScaleToLevel(5);

        scaled.Initiative.Should().Be(2);
    }
}
```

### 11.3 CompanionOrder Tests (~3 tests)

```csharp
[TestFixture]
public class CompanionOrderTests
{
    [Test]
    public void Default_ReturnsAttackTarget()
    {
        var order = CompanionOrder.Default;

        order.Type.Should().Be(CompanionOrderType.AttackTarget);
        order.TargetId.Should().BeNull();
    }

    [Test]
    public void Defend_ReturnsDefendOrder()
    {
        var order = CompanionOrder.Defend();

        order.Type.Should().Be(CompanionOrderType.Defend);
    }

    [Test]
    public void Focus_ReturnsOrderWithTarget()
    {
        var targetId = Guid.NewGuid();

        var order = CompanionOrder.Focus(targetId);

        order.Type.Should().Be(CompanionOrderType.FocusTarget);
        order.TargetId.Should().Be(targetId);
    }
}
```

### 11.4 CompanionService Tests (~10 tests)

```csharp
[TestFixture]
public class CompanionServiceTests
{
    private Mock<IConfigurationProvider> _configMock;
    private Mock<ILogger<CompanionService>> _loggerMock;
    private CompanionService _service;
    private NPC _testNPC;
    private Player _testPlayer;

    [SetUp]
    public void Setup()
    {
        _configMock = new Mock<IConfigurationProvider>();
        _configMock.Setup(x => x.LoadCompanionStats(It.IsAny<string>()))
            .Returns(CompanionStats.Default);

        _loggerMock = new Mock<ILogger<CompanionService>>();
        _service = new CompanionService(_configMock.Object, _loggerMock.Object);

        var definition = NPCDefinition.Create(
            "test", "Test", NPCType.Companion, NPCAttitude.Neutral, "Hi", "Desc");
        _testNPC = NPC.Create(definition);
        _testPlayer = Player.Create("Test Player");
    }

    [Test]
    public void RecruitCompanion_WithValidNPC_ReturnsCompanion()
    {
        var companion = _service.RecruitCompanion(_testNPC, _testPlayer);

        companion.Should().NotBeNull();
        companion!.NPC.Should().Be(_testNPC);
    }

    [Test]
    public void RecruitCompanion_PlayerAlreadyHasCompanion_ReturnsNull()
    {
        _service.RecruitCompanion(_testNPC, _testPlayer);
        var npc2 = NPC.Create(NPCDefinition.Create(
            "test2", "Test2", NPCType.Companion, NPCAttitude.Neutral, "Hi", "Desc"));

        var result = _service.RecruitCompanion(npc2, _testPlayer);

        result.Should().BeNull();
    }

    [Test]
    public void RecruitCompanion_NPCNotAvailable_ReturnsNull()
    {
        _testNPC.SetAvailability(false);

        var result = _service.RecruitCompanion(_testNPC, _testPlayer);

        result.Should().BeNull();
    }

    [Test]
    public void RecruitCompanion_NPCNotCompanionType_ReturnsNull()
    {
        var merchantDef = NPCDefinition.Create(
            "merchant", "Merchant", NPCType.Merchant, NPCAttitude.Neutral, "Hi", "Desc");
        var merchant = NPC.Create(merchantDef);

        var result = _service.RecruitCompanion(merchant, _testPlayer);

        result.Should().BeNull();
    }

    [Test]
    public void GetActiveCompanion_WithActiveCompanion_ReturnsCompanion()
    {
        var companion = _service.RecruitCompanion(_testNPC, _testPlayer);

        var result = _service.GetActiveCompanion(_testPlayer.Id);

        result.Should().Be(companion);
    }

    [Test]
    public void GetActiveCompanion_NoCompanion_ReturnsNull()
    {
        var result = _service.GetActiveCompanion(_testPlayer.Id);

        result.Should().BeNull();
    }

    [Test]
    public void DismissCompanion_RemovesFromActiveCompanions()
    {
        var companion = _service.RecruitCompanion(_testNPC, _testPlayer)!;

        _service.DismissCompanion(companion);

        _service.GetActiveCompanion(_testPlayer.Id).Should().BeNull();
    }

    [Test]
    public void IssueOrder_SetsCompanionOrder()
    {
        var companion = _service.RecruitCompanion(_testNPC, _testPlayer)!;
        var order = CompanionOrder.Defend();

        _service.IssueOrder(companion, order);

        companion.CurrentOrder.Type.Should().Be(CompanionOrderType.Defend);
    }

    [Test]
    public void ProcessCombatEnd_VictoryWithUnconsciousCompanion_Recovers()
    {
        var companion = _service.RecruitCompanion(_testNPC, _testPlayer)!;
        companion.TakeDamage(companion.MaxHealth);
        companion.SetState(CompanionState.Unconscious);

        _service.ProcessCombatEnd(companion, victory: true);

        companion.IsAlive.Should().BeTrue();
        companion.State.Should().Be(CompanionState.Following);
    }

    [Test]
    public void ProcessCombatEnd_DefeatWithUnconsciousCompanion_StaysUnconscious()
    {
        var companion = _service.RecruitCompanion(_testNPC, _testPlayer)!;
        companion.TakeDamage(companion.MaxHealth);

        _service.ProcessCombatEnd(companion, victory: false);

        companion.State.Should().Be(CompanionState.Unconscious);
    }
}
```

---

## 12. Use Cases

### UC-001: Recruit Companion
**Actor:** Player
**Flow:** Talk to NPC → Select recruitment dialogue option → NPC joins party → Confirmation displayed

### UC-002: View Party Status
**Actor:** Player
**Flow:** Enter `party` command → See player info → See companion info (if any) → Return to prompt

### UC-003: Give Combat Order
**Actor:** Player (in combat)
**Flow:** Enter `order <type>` → Order validated → Companion behavior updated → Confirmation displayed

### UC-004: Focus Companion on Target
**Actor:** Player (in combat)
**Flow:** Enter `order attack <target>` → Target validated → Companion focuses target → Confirmation displayed

### UC-005: Equip Companion
**Actor:** Player
**Flow:** Enter `equip companion <item>` → Item from inventory → Companion equipped → Previous item to inventory

### UC-006: Companion Combat Turn
**Actor:** Combat System
**Flow:** Companion's initiative → Get action from order → Execute action → Display result

### UC-007: Companion Defeats Enemy
**Actor:** Combat System
**Flow:** Companion attacks → Enemy HP reaches 0 → Enemy defeated → Display defeat message

### UC-008: Companion Falls Unconscious
**Actor:** Combat System
**Flow:** Companion takes damage → HP reaches 0 → State = Unconscious → Display message

### UC-009: Companion Recovers
**Actor:** Combat System
**Flow:** Combat victory → Check unconscious companion → Heal to 1 HP → State = Following

### UC-010: Dismiss Companion
**Actor:** Player
**Flow:** Enter `dismiss` → Confirm if companion exists → NPC becomes available → Confirmation displayed

---

## 13. Acceptance Criteria

### AC-2.0d-1: Companion Entity
- [ ] Companion entity can be created from NPC and player
- [ ] Companion stores reference to underlying NPC
- [ ] Companion tracks health, equipment, state, and order
- [ ] Companion implements IEffectTarget interface
- [ ] Companion.IsActive correctly reflects Following + alive state

### AC-2.0d-2: CompanionState Enum
- [ ] CompanionState has 4 values: Following, Waiting, Unconscious, Dismissed
- [ ] All values have XML documentation

### AC-2.0d-3: CompanionStats Value Object
- [ ] CompanionStats contains MaxHealth, Attack, Defense, Initiative, Accuracy
- [ ] Default property returns balanced starter stats
- [ ] ScaleToLevel correctly scales stats by level

### AC-2.0d-4: CompanionOrder System
- [ ] CompanionOrder contains Type, TargetId, Parameters
- [ ] CompanionOrderType has 5 values: AttackTarget, Defend, FocusTarget, UseAbilities, StayBack
- [ ] Order factory methods create correct order types

### AC-2.0d-5: Recruitment
- [ ] Companion can be recruited through dialogue outcome (RecruitCompanion)
- [ ] Only one companion allowed at a time
- [ ] Recruitment fails if player already has companion
- [ ] Recruitment fails if NPC is unavailable
- [ ] NPC becomes unavailable after recruitment

### AC-2.0d-6: Party Command
- [ ] `party` command shows player status
- [ ] `party` command shows companion status if present
- [ ] Companion health, state, and order displayed
- [ ] Companion equipment listed

### AC-2.0d-7: Order Command
- [ ] `order attack` sets AttackTarget order
- [ ] `order defend` sets Defend order
- [ ] `order attack <target>` sets FocusTarget order
- [ ] Order changes display confirmation

### AC-2.0d-8: Equip Command
- [ ] `equip companion <item>` equips item from player inventory
- [ ] Previous item returns to inventory
- [ ] Non-equippable items show error

### AC-2.0d-9: Combat Integration
- [ ] Companion added to combat encounter when present
- [ ] Companion takes turns based on initiative
- [ ] Companion actions follow current order
- [ ] Companion damage tracked separately

### AC-2.0d-10: Combat States
- [ ] Companion becomes Unconscious when HP reaches 0
- [ ] Unconscious companions don't take turns
- [ ] Victory heals unconscious companion to 1 HP
- [ ] Companion returns to Following after recovery

### AC-2.0d-11: Dismiss Command
- [ ] `dismiss` releases current companion
- [ ] Dismissed companion's NPC becomes available
- [ ] Player can recruit new companion after dismissal

### AC-2.0d-12: Logging
- [ ] Service initialization logged
- [ ] Recruitment attempts logged with outcome
- [ ] Order changes logged
- [ ] Equipment changes logged
- [ ] Combat events logged

### AC-2.0d-13: Unit Tests
- [ ] ~25 unit tests implemented
- [ ] All tests pass
- [ ] Tests cover happy path and error cases

---

## 14. Deliverable Checklist

### Domain Layer
- [ ] `Entities/Companion.cs`
- [ ] `Enums/CompanionState.cs`
- [ ] `Enums/CompanionOrderType.cs`
- [ ] `ValueObjects/CompanionStats.cs`
- [ ] `ValueObjects/CompanionOrder.cs`
- [ ] `ValueObjects/OrderResult.cs`
- [ ] `ValueObjects/DismissResult.cs`
- [ ] `Entities/CombatEncounter.cs` updates (companion support)

### Application Layer
- [ ] `Interfaces/ICompanionService.cs`
- [ ] `Services/CompanionService.cs`
- [ ] `Services/DialogueService.cs` updates (RecruitCompanion outcome)
- [ ] `Services/CombatService.cs` updates (companion turns)
- [ ] `Services/GameSessionService.cs` updates (party methods)
- [ ] `DTOs/PartyStatusDto.cs`
- [ ] `DTOs/CompanionSummaryDto.cs`

### Infrastructure Layer
- [ ] `Configuration/JsonConfigurationProvider.cs` updates (LoadCompanionStats)

### Configuration Files
- [ ] `config/npcs.json` updates (companion stats)
- [ ] `config/schemas/npcs.schema.json` updates (companion stats schema)

### Presentation Layer
- [ ] Party command handler
- [ ] Order command handler
- [ ] Equip companion command handler
- [ ] Dismiss command handler
- [ ] Combat handler updates (companion turns)
- [ ] IGameRenderer updates (RenderPartyStatus, RenderCompanionTurn)

### Tests
- [ ] `Domain.Tests/Entities/CompanionTests.cs`
- [ ] `Domain.Tests/ValueObjects/CompanionStatsTests.cs`
- [ ] `Domain.Tests/ValueObjects/CompanionOrderTests.cs`
- [ ] `Application.Tests/Services/CompanionServiceTests.cs`

### Documentation
- [ ] XML documentation on all public members
- [ ] JSON schema documentation updates

---

## 15. Dependencies

### Required from Previous Versions

**From v0.2.0a (NPC Foundation):**
- NPC entity with IsAvailable property
- NPCDefinition with Type property
- NPCType.Companion enum value
- NPC.SetAvailability() method

**From v0.2.0b (Dialogue System):**
- OutcomeType.RecruitCompanion (defined but not implemented)
- DialogueOutcome value object
- DialogueService for outcome processing

**From v0.2.0c (Reputation & Memory):**
- NPC memory for companion relationship tracking
- Faction relationships affecting recruitment options

**From Combat System:**
- CombatEncounter entity
- Combatant entity
- AIContext for decision making
- AIDecision for action selection
- Turn order management

**From Equipment System:**
- EquipmentSlot enum
- EquipResult value object
- Item entity with IsEquippable

**From Core:**
- IEntity interface
- IEffectTarget interface
- ActiveStatusEffect
- IConfigurationProvider
- IGameRenderer

### Provided to Future Versions

**To v0.3.0 (Quests):**
- Companion entity for quest objectives
- CompanionService for quest-related recruitment

**To v0.2.1 (Codex & Lore):**
- Companion unlocking codex entries
- Companion dialogue revealing lore

---

## 16. Future Considerations

### Deferred to Future Versions

**Multiple Companions (v0.3.x or later):**
- Party size expansion beyond one companion
- Party formation and positioning
- Inter-companion interactions

**Companion Abilities (v0.3.x or later):**
- Special abilities for companions
- Ability cooldowns and resources
- Order: UseAbilities full implementation

**Companion Leveling (v0.3.x or later):**
- Experience gain for companions
- Stat growth on level up
- Ability unlocks

**Companion Equipment Sets (v0.3.x or later):**
- Multiple equipment loadouts
- Quick-swap between sets
- Equipment restrictions by companion type

**Companion Personalities (v0.3.x or later):**
- Personality traits affecting combat behavior
- Companion morale system
- Dialogue reflecting personality

### Out of Scope

- **Companion Breeding/Summoning**: Not planned
- **Companion Housing**: Not planned
- **Companion Trading**: Not planned
- **Pet System**: Different from companions, not in scope
- **Mount System**: Not relevant to dungeon crawler

---

*Document Version: 1.0*
*Last Updated: 2025-01-09*
*Author: Claude Code*
