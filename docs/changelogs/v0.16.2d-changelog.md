# v0.16.2d Changelog: Penalty Calculation Service

**Version:** 0.16.2d
**Date:** 2026-01-29
**Status:** Implemented

---

## Summary

Implements the Armor Penalty Calculation Service, providing centralized penalty computation based on armor category and proficiency level. Supports tier reduction for Expert/Master proficiency and penalty doubling for NonProficient characters.

---

## Added

### Domain Layer

- **EffectiveArmorPenalties** value object (`RuneAndRust.Domain.ValueObjects`)
    - Encapsulates base penalties, effective penalties, modifiers, and calculation metadata
    - Static factory methods: `Create`, `None`
    - Metadata properties: `WasMultiplied`, `WasTierReduced`, `OriginalTier`, `EffectiveTier`
    - Convenience properties: `HasAnyPenalty`, `HasAttackPenalty`, `HasDefenseBonus`, `IsNonProficient`, `IsMaster`
    - Formatting methods: `FormatSummary`, `GetModificationNotes`, `ToString`, `ToDebugString`

### Application Layer

- **IArmorPenaltyCalculator** interface (`RuneAndRust.Application.Interfaces`)
    - `CalculatePenalties`: Core calculation method combining category and proficiency
    - `CalculateForArchetype`: Convenience method using archetype's starting proficiency
    - `GetEffectiveTier`: Tier calculation after proficiency reduction
    - `GetPenaltiesForTier`: Penalty lookup by tier number
    - `WouldDoublePenalties`: UI preview helper for penalty doubling
    - `WouldReduceTier`: UI preview helper for tier reduction benefits

- **ArmorPenaltyCalculator** implementation (`RuneAndRust.Application.Services`)
    - Injects `IArmorCategoryProvider`, `IArmorProficiencyEffectProvider`, `IArchetypeArmorProficiencyProvider`
    - Structured logging at Debug level for calculation pipeline
    - Information-level logging for final penalty results

### Unit Tests

- **ArmorPenaltyCalculatorTests** (12 tests)
    - NonProficient penalty doubling test (Heavy armor)
    - Expert tier reduction test (Heavy â†’ Medium penalties)
    - Master tier reduction with defense bonus test
    - Archetype-based calculation test (Mystic + Medium)
    - `WouldDoublePenalties` parameterized tests (4 cases)
    - `WouldReduceTier` parameterized tests (4 cases)

---

## Dependencies

- v0.16.2a: `ArmorCategory`, `ArmorProficiencyLevel`
- v0.16.2b: `ArmorPenalties`, `ArmorProficiencyEffect`, `ArmorCategoryDefinition`
- v0.16.2b: `IArmorCategoryProvider`, `IArmorProficiencyEffectProvider`
- v0.16.2c: `IArchetypeArmorProficiencyProvider`

---

## Penalty Calculation Pipeline

```csharp
// Calculate penalties for a character wearing Heavy armor
var result = _penaltyCalculator.CalculatePenalties(
    ArmorCategory.Heavy,
    ArmorProficiencyLevel.Expert);

// Expert reduces Heavy (Tier 2) to Medium (Tier 1) penalties
result.OriginalTier;       // 2
result.EffectiveTier;      // 1
result.WasTierReduced;     // true

// Access effective penalties
result.EffectivePenalties.AgilityDicePenalty;    // -1 (Medium)
result.EffectivePenalties.StaminaCostModifier;   // +2 (Medium)
result.EffectivePenalties.MovementPenalty;       // -5ft (Medium)
```

---

## NonProficient Penalty Example

```csharp
// NonProficient character wearing Medium armor
var result = _penaltyCalculator.CalculatePenalties(
    ArmorCategory.Medium,
    ArmorProficiencyLevel.NonProficient);

// Penalties are doubled
result.WasMultiplied;      // true
result.AttackModifier;     // -2

// Base Medium: -1d10 Agi, +2 Stam, -5ft Move
// Doubled:     -2d10 Agi, +4 Stam, -10ft Move
result.EffectivePenalties.AgilityDicePenalty;    // -2
result.EffectivePenalties.StaminaCostModifier;   // +4
result.EffectivePenalties.MovementPenalty;       // -10ft
```
