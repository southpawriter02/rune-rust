# v0.13.1a Design Specification: Boss Health Bar

**Version:** 0.13.1a
**Parent:** v0.13.1 (Boss & Monster UI)
**Prerequisites:** v0.13.0d Complete (Combat UI), v0.10.4b Complete (Boss Encounter Runtime)
**Status:** Design Complete
**Estimated Unit Tests:** ~6

---

## Table of Contents

1. [Executive Summary](#1-executive-summary)
2. [Feature Overview](#2-feature-overview)
3. [Architecture Diagrams](#3-architecture-diagrams)
4. [Boss Health Bar Component](#4-boss-health-bar-component)
   - 4.1 [BossHealthBar Class](#41-bosshealthbar-class)
   - 4.2 [Phase Marker Rendering](#42-phase-marker-rendering)
   - 4.3 [Damage Animation](#43-damage-animation)
   - 4.4 [Health Color Thresholds](#44-health-color-thresholds)
5. [Boss Health Bar Renderer](#5-boss-health-bar-renderer)
   - 5.1 [BossHealthBarRenderer Class](#51-bosshealthbarrenderer-class)
   - 5.2 [Health Text Formatting](#52-health-text-formatting)
   - 5.3 [Phase Marker Formatting](#53-phase-marker-formatting)
6. [Data Model Changes](#6-data-model-changes)
7. [Configuration File Schemas](#7-configuration-file-schemas)
8. [CombatView Integration](#8-combatview-integration)
9. [Logging Specifications](#9-logging-specifications)
10. [Unit Testing Requirements](#10-unit-testing-requirements)
11. [Use Cases](#11-use-cases)
12. [Deliverable Checklist](#12-deliverable-checklist)
13. [Acceptance Criteria](#13-acceptance-criteria)
14. [Dependencies](#14-dependencies)
15. [Future Considerations](#15-future-considerations)

---

## 1. Executive Summary

This version implements the boss health bar UI component with phase markers and damage animation. The boss health bar provides a prominent display during boss encounters showing current health, maximum health, percentage, and visual markers indicating phase transition thresholds. When a boss takes damage, the health bar animates the change with a flash effect and displays the damage delta.

### Key Deliverables

| Category | Items |
|----------|-------|
| **UI Components** | `BossHealthBar` |
| **Renderers** | `BossHealthBarRenderer` |
| **DTOs** | `BossHealthDisplayDto`, `PhaseMarkerDto`, `DamageAnimationDto` |
| **View Updates** | `CombatView` integration |
| **Configuration** | `boss-health-display.json` |
| **Tests** | ~6 unit tests |

### Architectural Significance

This version continues the **Combat UI Component Pattern** established in v0.13.0a:
- UI Components receive data from services via DTOs
- Renderers handle symbol/color mapping and terminal output
- Components integrate with existing `CombatView` via defined integration points
- Configuration drives visual appearance (colors, symbols, formats)
- Event-driven animation triggers for boss damage events

---

## 2. Feature Overview

```
v0.13.1a Features
├── BossHealthBar (UI Component)
│   ├── RenderBar(BossHealthDisplayDto)
│   ├── ShowPhaseMarkers(IEnumerable<PhaseMarkerDto>)
│   ├── AnimateDamage(DamageAnimationDto)
│   └── UpdateHealth(int, int)
│
├── BossHealthBarRenderer (Renderer)
│   ├── FormatHealthText(int, int)
│   ├── GetHealthColor(double)
│   ├── RenderPhaseMarker(double, int)
│   ├── GetDamageFlashColor()
│   └── FormatDamageDelta(int)
│
├── Phase Marker Display
│   ├── Threshold Position Calculation
│   ├── Phase Label Rendering
│   └── Phase Number Display
│
├── Damage Animation
│   ├── Flash Effect
│   ├── Delta Display
│   └── Smooth Transition
│
└── CombatView Integration
    ├── Boss Encounter Detection
    ├── Header Panel Placement
    └── Event Subscription
```

### Scope Verification

| Feature | Source | Included |
|---------|--------|----------|
| Boss health bar with percentage | v0.13.1-scope-breakdown.md | Yes |
| Health text current/max HP | v0.13.1-scope-breakdown.md | Yes |
| Phase markers at thresholds | v0.13.1-scope-breakdown.md | Yes |
| Damage animation | v0.13.1-scope-breakdown.md | Yes |
| Health bar color changes | v0.13.1-scope-breakdown.md | Yes |
| Boss name header display | v0.13.1-scope-breakdown.md | Yes |
| Phase transition effects | v0.13.1-scope-breakdown.md | No (v0.13.1b) |
| Enrage timer display | v0.13.1-scope-breakdown.md | No (v0.13.1b) |
| Vulnerability window | v0.13.1-scope-breakdown.md | No (v0.13.1b) |

---

## 3. Architecture Diagrams

### 3.1 Layer Diagram

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                          PRESENTATION LAYER                                  │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  ┌─────────────────────────┐      ┌─────────────────────────┐               │
│  │     CombatView          │      │    BossHealthBar        │               │
│  │     (existing)          │◄────▶│    (NEW)                │               │
│  ├─────────────────────────┤      ├─────────────────────────┤               │
│  │ - RenderCombatState()   │      │ - RenderBar()           │               │
│  │ - HandleBossEncounter() │      │ - ShowPhaseMarkers()    │               │
│  │ - IntegrateComponents() │      │ - AnimateDamage()       │               │
│  └─────────────────────────┘      │ - UpdateHealth()        │               │
│                                    └───────────┬─────────────┘               │
│                                                │                             │
│  ┌─────────────────────────┐                   │                             │
│  │  BossHealthBarRenderer  │◄──────────────────┘                             │
│  │  (NEW)                  │                                                 │
│  ├─────────────────────────┤                                                 │
│  │ - FormatHealthText()    │                                                 │
│  │ - GetHealthColor()      │                                                 │
│  │ - RenderPhaseMarker()   │                                                 │
│  │ - GetDamageFlashColor() │                                                 │
│  │ - FormatDamageDelta()   │                                                 │
│  └─────────────────────────┘                                                 │
│                                                                              │
└──────────────────────────────────────────────────────────────────────────────┘
                                        │
                                        ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                          APPLICATION LAYER                                   │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │                    IBossMechanicsService (existing v0.10.4b)        │    │
│  ├─────────────────────────────────────────────────────────────────────┤    │
│  │ + GetBossState(boss) : ActiveBossState?                             │    │
│  │ + GetCurrentPhase(boss) : BossPhase?                                │    │
│  │ + IsBoss(monster) : bool                                            │    │
│  │ + GetActiveBosses() : IReadOnlyList<Monster>                        │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
│                                                                              │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │                    IBossDefinitionProvider (existing v0.10.4a)      │    │
│  ├─────────────────────────────────────────────────────────────────────┤    │
│  │ + GetBossDefinition(bossId) : BossDefinition?                       │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
│                                                                              │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │                    IEventBus (existing)                             │    │
│  ├─────────────────────────────────────────────────────────────────────┤    │
│  │ + Subscribe<BossPhaseChangedEvent>(handler) : IDisposable           │    │
│  │ + Subscribe<EntityDamagedEvent>(handler) : IDisposable              │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
│                                                                              │
└──────────────────────────────────────────────────────────────────────────────┘
                                        │
                                        ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                            DOMAIN LAYER                                      │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  ┌─────────────────────────┐      ┌─────────────────────────┐               │
│  │   BossDefinition        │      │   ActiveBossState       │               │
│  │   (existing v0.10.4a)   │◄─────│   (existing v0.10.4b)   │               │
│  ├─────────────────────────┤      ├─────────────────────────┤               │
│  │ + BossId: string        │      │ + BossId: string        │               │
│  │ + Name: string          │      │ + CurrentPhaseNumber:int│               │
│  │ + TitleText: string?    │      │ + VulnerableTurns: int  │               │
│  │ + Phases: IReadOnly...  │      │ + EnrageStacks: int     │               │
│  │ + GetPhaseForHealth()   │      │ + IsVulnerable: bool    │               │
│  │ + GetStartingPhase()    │      └─────────────────────────┘               │
│  │ + PhaseCount: int       │                                                 │
│  └─────────────────────────┘                                                 │
│                                                                              │
│  ┌─────────────────────────┐      ┌─────────────────────────┐               │
│  │      BossPhase          │      │      Monster            │               │
│  │   (existing v0.10.4a)   │      │   (existing)            │               │
│  ├─────────────────────────┤      ├─────────────────────────┤               │
│  │ + PhaseNumber: int      │      │ + Id: Guid              │               │
│  │ + Name: string          │      │ + Name: string          │               │
│  │ + HealthThreshold: int  │      │ + Health: int           │               │
│  │ + TransitionText: str?  │      │ + MaxHealth: int        │               │
│  │ + HasTransition: bool   │      │ + IsAlive: bool         │               │
│  └─────────────────────────┘      └─────────────────────────┘               │
│                                                                              │
└──────────────────────────────────────────────────────────────────────────────┘
```

### 3.2 Data Flow Diagram

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                    BOSS HEALTH BAR DATA FLOW                                 │
└─────────────────────────────────────────────────────────────────────────────┘

    Boss Encounter Started / Combat Turn Update
           │
           ▼
┌─────────────────────────┐
│      CombatView         │
│  HandleBossEncounter()  │
└───────────┬─────────────┘
            │
            │ 1. Check for active boss
            ▼
┌─────────────────────────┐
│  IBossMechanicsService  │
│  GetActiveBosses()      │
│  GetBossState(boss)     │
└───────────┬─────────────┘
            │
            │ 2. Get boss definition for phase info
            ▼
┌─────────────────────────┐
│ IBossDefinitionProvider │
│ GetBossDefinition(id)   │
└───────────┬─────────────┘
            │
            │ 3. Returns BossDefinition with phases
            ▼
┌─────────────────────────┐
│    BossHealthBar        │
│                         │
│  ┌───────────────────┐  │
│  │ CreateHealthDto() │  │ 4. Build BossHealthDisplayDto
│  └─────────┬─────────┘  │
│            │            │
│            ▼            │
│  ┌───────────────────┐  │
│  │ CreatePhaseMarker │  │ 5. Build PhaseMarkerDto list
│  │ Dtos()            │  │
│  └─────────┬─────────┘  │
│            │            │
│            ▼            │
│  ┌───────────────────┐  │
│  │ RenderBar()       │  │ 6. Render health bar
│  │ ShowPhaseMarkers()│  │    Render phase markers
│  └─────────┬─────────┘  │
└────────────┼────────────┘
             │
             │ 7. Call renderer for formatting
             ▼
┌─────────────────────────┐
│ BossHealthBarRenderer   │
│                         │
│ - FormatHealthText()    │ 8. Format "2,847 / 5,000"
│ - GetHealthColor()      │ 9. Get color for percentage
│ - RenderPhaseMarker()   │ 10. Position markers on bar
│ - RenderBar()           │ 11. Build bar string
└───────────┬─────────────┘
            │
            │ 12. Return formatted strings
            ▼
┌─────────────────────────┐
│   ITerminalService      │
│   WriteAt(x, y, text)   │
│   WriteColoredAt(...)   │
└─────────────────────────┘
```

### 3.3 Event Flow Diagram - Damage Animation

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                    DAMAGE ANIMATION EVENT FLOW                               │
└─────────────────────────────────────────────────────────────────────────────┘

    Boss Takes Damage (Combat System)
           │
           ▼
┌─────────────────────────┐
│  Combat System          │
│  ApplyDamage(boss, dmg) │
└───────────┬─────────────┘
            │
            │ 1. Publishes EntityDamagedEvent
            ▼
┌─────────────────────────┐
│      IEventBus          │
│  Publish(event)         │
└───────────┬─────────────┘
            │
            │ 2. Event delivered to subscribers
            ▼
┌─────────────────────────┐
│    BossHealthBar        │
│  OnEntityDamaged(event) │
└───────────┬─────────────┘
            │
            │ 3. Check if entity is tracked boss
            ▼
     ┌──────┴──────┐
     │ Is Boss?    │
     └──────┬──────┘
            │
      Yes   │   No (ignore)
            ▼
┌─────────────────────────┐
│  Create Animation Dto   │
│                         │
│  previousHealth: 2,997  │
│  currentHealth: 2,847   │
│  damageAmount: 150      │
└───────────┬─────────────┘
            │
            │ 4. Trigger animation
            ▼
┌─────────────────────────┐
│  AnimateDamage(dto)     │
│                         │
│  1. Flash bar red       │
│  2. Show delta [-150]   │
│  3. Update bar fill     │
│  4. Clear flash         │
└─────────────────────────┘
```

---

## 4. Boss Health Bar Component

### 4.1 BossHealthBar Class

**Purpose:** Renders the boss health bar with name header, health text, fill bar, and phase markers.

**File:** `src/Presentation/RuneAndRust.Presentation.Tui/UI/BossHealthBar.cs`

```csharp
using RuneAndRust.Application.Interfaces;
using RuneAndRust.Application.Events;
using RuneAndRust.Presentation.Tui.Renderers;
using RuneAndRust.Presentation.Tui.Services;
using RuneAndRust.Presentation.Tui.DTOs;

namespace RuneAndRust.Presentation.Tui.UI;

/// <summary>
/// Renders a prominent health bar for boss encounters with phase markers
/// and damage animation support.
/// </summary>
/// <remarks>
/// The boss health bar is displayed at the top of the combat view during
/// boss encounters. It shows the boss name, current/max HP, a visual bar
/// with phase threshold markers, and animates damage changes.
/// </remarks>
public class BossHealthBar
{
    private readonly BossHealthBarRenderer _renderer;
    private readonly ITerminalService _terminalService;
    private readonly BossHealthDisplayConfig _config;
    private readonly ILogger<BossHealthBar> _logger;

    private BossHealthDisplayDto? _currentState;
    private IReadOnlyList<PhaseMarkerDto> _phaseMarkers = Array.Empty<PhaseMarkerDto>();
    private bool _isAnimating;

    /// <summary>
    /// Creates a new instance of the BossHealthBar.
    /// </summary>
    /// <param name="renderer">The renderer for formatting health bar elements.</param>
    /// <param name="terminalService">The terminal output service.</param>
    /// <param name="config">Configuration for display settings.</param>
    /// <param name="logger">Logger for diagnostic output.</param>
    public BossHealthBar(
        BossHealthBarRenderer renderer,
        ITerminalService terminalService,
        BossHealthDisplayConfig config,
        ILogger<BossHealthBar> logger)
    {
        _renderer = renderer ?? throw new ArgumentNullException(nameof(renderer));
        _terminalService = terminalService ?? throw new ArgumentNullException(nameof(terminalService));
        _config = config ?? throw new ArgumentNullException(nameof(config));
        _logger = logger ?? throw new ArgumentNullException(nameof(logger));
    }

    /// <summary>
    /// Renders the complete boss health bar display.
    /// </summary>
    /// <param name="healthDto">The current boss health state.</param>
    public void RenderBar(BossHealthDisplayDto healthDto)
    {
        _currentState = healthDto ?? throw new ArgumentNullException(nameof(healthDto));

        _logger.LogDebug(
            "Rendering boss health bar for {BossName}: {Current}/{Max} ({Percent}%)",
            healthDto.BossName,
            healthDto.CurrentHealth,
            healthDto.MaxHealth,
            healthDto.HealthPercent);

        // Render boss name header
        RenderBossNameHeader(healthDto.BossName);

        // Render health text
        RenderHealthText(healthDto.CurrentHealth, healthDto.MaxHealth);

        // Render the health bar with fill
        RenderHealthBarFill(healthDto.HealthPercent);

        // Render phase markers below bar
        if (_phaseMarkers.Count > 0)
        {
            RenderPhaseMarkerLabels();
        }
    }

    /// <summary>
    /// Sets the phase markers to display on the health bar.
    /// </summary>
    /// <param name="phases">The phase marker DTOs with threshold positions.</param>
    public void ShowPhaseMarkers(IEnumerable<PhaseMarkerDto> phases)
    {
        _phaseMarkers = phases?.ToList().AsReadOnly()
            ?? throw new ArgumentNullException(nameof(phases));

        _logger.LogDebug(
            "Set {Count} phase markers for boss health bar",
            _phaseMarkers.Count);
    }

    /// <summary>
    /// Animates damage taken by the boss with flash effect and delta display.
    /// </summary>
    /// <param name="animationDto">The damage animation data.</param>
    public void AnimateDamage(DamageAnimationDto animationDto)
    {
        if (_isAnimating)
        {
            _logger.LogDebug("Skipping animation - already animating");
            return;
        }

        _isAnimating = true;

        try
        {
            _logger.LogDebug(
                "Animating damage: {Previous} -> {Current} ({Delta})",
                animationDto.PreviousHealth,
                animationDto.CurrentHealth,
                animationDto.DamageAmount);

            // Flash the bar with damage color
            FlashDamageEffect();

            // Show the damage delta
            ShowDamageDelta(animationDto.DamageAmount);

            // Update to new health value
            if (_currentState != null)
            {
                var updatedDto = _currentState with
                {
                    CurrentHealth = animationDto.CurrentHealth,
                    HealthPercent = CalculatePercent(
                        animationDto.CurrentHealth,
                        _currentState.MaxHealth)
                };
                RenderBar(updatedDto);
            }

            // Clear flash after brief delay (handled by terminal service timing)
            ClearDamageEffect();
        }
        finally
        {
            _isAnimating = false;
        }
    }

    /// <summary>
    /// Updates the health bar to reflect new health values without animation.
    /// </summary>
    /// <param name="currentHealth">The current health value.</param>
    /// <param name="maxHealth">The maximum health value.</param>
    public void UpdateHealth(int currentHealth, int maxHealth)
    {
        if (_currentState == null)
        {
            _logger.LogWarning("Cannot update health - no current state");
            return;
        }

        var updatedDto = _currentState with
        {
            CurrentHealth = currentHealth,
            MaxHealth = maxHealth,
            HealthPercent = CalculatePercent(currentHealth, maxHealth)
        };

        RenderBar(updatedDto);
    }

    /// <summary>
    /// Clears the boss health bar display from the terminal.
    /// </summary>
    public void Clear()
    {
        _currentState = null;
        _phaseMarkers = Array.Empty<PhaseMarkerDto>();

        // Clear the display area
        var clearLine = new string(' ', _config.TotalWidth);
        for (var row = 0; row < _config.TotalHeight; row++)
        {
            _terminalService.WriteAt(_config.StartX, _config.StartY + row, clearLine);
        }

        _logger.LogDebug("Cleared boss health bar display");
    }

    #region Private Rendering Methods

    private void RenderBossNameHeader(string bossName)
    {
        var header = _renderer.FormatBossNameHeader(bossName, _config.BarWidth);
        var headerColor = _config.Colors.HeaderColor;

        _terminalService.WriteColoredAt(
            _config.StartX,
            _config.StartY,
            header,
            headerColor);
    }

    private void RenderHealthText(int current, int max)
    {
        var healthText = _renderer.FormatHealthText(current, max);
        var textY = _config.StartY + 1;

        _terminalService.WriteAt(
            _config.StartX + _config.TextIndent,
            textY,
            healthText);
    }

    private void RenderHealthBarFill(int healthPercent)
    {
        var barY = _config.StartY + 2;
        var healthColor = _renderer.GetHealthColor(healthPercent);

        // Render bar border
        var barBorder = _renderer.FormatBarBorder(_config.BarWidth);
        _terminalService.WriteAt(_config.StartX + _config.TextIndent, barY, barBorder);

        // Render filled portion
        var fillWidth = (int)(_config.BarWidth * (healthPercent / 100.0));
        var emptyWidth = _config.BarWidth - fillWidth;

        var fillChars = new string(_config.Symbols.FilledChar, fillWidth);
        var emptyChars = new string(_config.Symbols.EmptyChar, emptyWidth);

        // Write filled portion with health color
        _terminalService.WriteColoredAt(
            _config.StartX + _config.TextIndent + 1,
            barY,
            fillChars,
            healthColor);

        // Write empty portion
        _terminalService.WriteAt(
            _config.StartX + _config.TextIndent + 1 + fillWidth,
            barY,
            emptyChars);

        // Render phase markers on the bar
        foreach (var marker in _phaseMarkers)
        {
            if (marker.ThresholdPercent < 100) // Don't show 100% marker
            {
                var markerX = CalculateMarkerPosition(marker.ThresholdPercent);
                _terminalService.WriteColoredAt(
                    markerX,
                    barY,
                    _config.Symbols.PhaseMarkerChar.ToString(),
                    _config.Colors.PhaseMarkerColor);
            }
        }
    }

    private void RenderPhaseMarkerLabels()
    {
        var labelY = _config.StartY + 3;

        foreach (var marker in _phaseMarkers)
        {
            if (marker.ThresholdPercent < 100) // Don't label 100% marker
            {
                var markerX = CalculateMarkerPosition(marker.ThresholdPercent);
                var label = _renderer.FormatPhaseLabel(marker.PhaseNumber, marker.ThresholdPercent);

                // Center the label under the marker
                var labelOffset = label.Length / 2;
                var labelX = Math.Max(_config.StartX, markerX - labelOffset);

                _terminalService.WriteAt(labelX, labelY, label);
            }
        }
    }

    private void FlashDamageEffect()
    {
        if (_currentState == null) return;

        var barY = _config.StartY + 2;
        var flashColor = _renderer.GetDamageFlashColor();

        // Briefly flash the entire bar with damage color
        var fillWidth = (int)(_config.BarWidth * (_currentState.HealthPercent / 100.0));
        var fillChars = new string(_config.Symbols.FilledChar, fillWidth);

        _terminalService.WriteColoredAt(
            _config.StartX + _config.TextIndent + 1,
            barY,
            fillChars,
            flashColor);

        // Terminal service handles timing delay
        _terminalService.FlashDelay(_config.Animation.FlashDurationMs);
    }

    private void ShowDamageDelta(int damageAmount)
    {
        var deltaText = _renderer.FormatDamageDelta(damageAmount);
        var deltaY = _config.StartY + 1;
        var deltaX = _config.StartX + _config.BarWidth - deltaText.Length;

        _terminalService.WriteColoredAt(
            deltaX,
            deltaY,
            deltaText,
            _config.Colors.DamageColor);

        // Brief display before clearing
        _terminalService.FlashDelay(_config.Animation.DeltaDisplayMs);
    }

    private void ClearDamageEffect()
    {
        // Clear the delta text area
        var deltaY = _config.StartY + 1;
        var clearText = new string(' ', 15); // Max delta text width

        _terminalService.WriteAt(
            _config.StartX + _config.BarWidth - 15,
            deltaY,
            clearText);
    }

    private int CalculateMarkerPosition(int thresholdPercent)
    {
        var barStartX = _config.StartX + _config.TextIndent + 1;
        var position = barStartX + (int)(_config.BarWidth * (thresholdPercent / 100.0));
        return position;
    }

    private static int CalculatePercent(int current, int max)
    {
        if (max <= 0) return 0;
        return (int)Math.Ceiling((current / (float)max) * 100);
    }

    #endregion
}
```

### 4.2 Phase Marker Rendering

**Purpose:** Display visual markers on the health bar indicating phase transition thresholds.

Phase markers appear as vertical pipe characters (`|`) on the health bar at positions corresponding to health percentage thresholds. Below each marker, a label shows the phase number and threshold percentage.

**Phase Marker Positioning Algorithm:**

```csharp
/// <summary>
/// Calculates the X position for a phase marker on the health bar.
/// </summary>
/// <param name="thresholdPercent">The health percentage threshold (0-100).</param>
/// <param name="barStartX">The starting X coordinate of the bar fill area.</param>
/// <param name="barWidth">The total width of the bar fill area.</param>
/// <returns>The X coordinate for the phase marker.</returns>
/// <remarks>
/// Example: For a 60-character bar with threshold at 75%:
/// Position = barStartX + (60 * 0.75) = barStartX + 45
/// </remarks>
private static int CalculateMarkerPosition(int thresholdPercent, int barStartX, int barWidth)
{
    var normalizedPercent = Math.Clamp(thresholdPercent, 0, 100) / 100.0;
    return barStartX + (int)(barWidth * normalizedPercent);
}
```

**Phase Marker Display:**

```
HP: 2,847 / 5,000
+============================================================+
|############################|...............|...............|
+============================================================+
                          Phase 2          Phase 3          Phase 4
                           (75%)            (50%)            (25%)
```

### 4.3 Damage Animation

**Purpose:** Provide visual feedback when the boss takes damage.

The damage animation consists of three steps:
1. **Flash Effect:** The health bar briefly flashes red (damage color)
2. **Delta Display:** Shows the damage amount (e.g., "[-150]") next to the health text
3. **Bar Update:** The health bar fill updates to reflect the new health value

**Animation Timing:**
- Flash duration: 100ms (configurable)
- Delta display: 500ms (configurable)
- Total animation: ~600ms

**Animation States:**

```
Normal State:
HP: 2,997 / 5,000
|█████████████████████████████................|

Flash State (100ms):
HP: 2,997 / 5,000
|░░░░░░░░░░░░░░░░░░░░░░░░░░░░░................|  ← Red flash

Delta Display (500ms):
HP: 2,847 / 5,000                       [-150]
|████████████████████████████.................|

Final State:
HP: 2,847 / 5,000
|████████████████████████████.................|
```

### 4.4 Health Color Thresholds

**Purpose:** Indicate boss health status through color changes.

| Health Percentage | Color | ConsoleColor |
|-------------------|-------|--------------|
| 76-100% | Green | ConsoleColor.Green |
| 51-75% | Yellow | ConsoleColor.Yellow |
| 26-50% | Orange | ConsoleColor.DarkYellow |
| 1-25% | Red | ConsoleColor.Red |
| 0% | Dark Red | ConsoleColor.DarkRed |

**Color Selection Logic:**

```csharp
/// <summary>
/// Determines the health bar color based on current health percentage.
/// </summary>
/// <param name="healthPercent">The current health percentage (0-100).</param>
/// <returns>The console color for the health bar fill.</returns>
public ConsoleColor GetHealthColor(int healthPercent)
{
    return healthPercent switch
    {
        > 75 => ConsoleColor.Green,
        > 50 => ConsoleColor.Yellow,
        > 25 => ConsoleColor.DarkYellow,
        > 0 => ConsoleColor.Red,
        _ => ConsoleColor.DarkRed
    };
}
```

---

## 5. Boss Health Bar Renderer

### 5.1 BossHealthBarRenderer Class

**Purpose:** Handles all text formatting and color selection for boss health bar elements.

**File:** `src/Presentation/RuneAndRust.Presentation.Tui/Renderers/BossHealthBarRenderer.cs`

```csharp
using RuneAndRust.Presentation.Tui.DTOs;

namespace RuneAndRust.Presentation.Tui.Renderers;

/// <summary>
/// Handles text formatting and color selection for boss health bar elements.
/// </summary>
/// <remarks>
/// This renderer is stateless and handles all string formatting operations
/// for the boss health bar UI component. It reads configuration for symbols
/// and color thresholds.
/// </remarks>
public class BossHealthBarRenderer
{
    private readonly BossHealthDisplayConfig _config;

    /// <summary>
    /// Creates a new instance of the BossHealthBarRenderer.
    /// </summary>
    /// <param name="config">Configuration for display settings.</param>
    public BossHealthBarRenderer(BossHealthDisplayConfig config)
    {
        _config = config ?? throw new ArgumentNullException(nameof(config));
    }

    /// <summary>
    /// Formats the boss name as a centered header.
    /// </summary>
    /// <param name="bossName">The boss display name.</param>
    /// <param name="totalWidth">The total width of the display area.</param>
    /// <returns>A centered, decorated boss name header.</returns>
    /// <example>
    /// FormatBossNameHeader("SKELETON KING", 60)
    /// returns: "                    <<  SKELETON KING  >>                    "
    /// </example>
    public string FormatBossNameHeader(string bossName, int totalWidth)
    {
        var decoratedName = $"{_config.Symbols.HeaderPrefix}  {bossName.ToUpperInvariant()}  {_config.Symbols.HeaderSuffix}";
        var padding = (totalWidth - decoratedName.Length) / 2;

        if (padding < 0) padding = 0;

        return decoratedName.PadLeft(padding + decoratedName.Length).PadRight(totalWidth);
    }

    /// <summary>
    /// Formats the health text showing current and maximum values.
    /// </summary>
    /// <param name="current">Current health value.</param>
    /// <param name="max">Maximum health value.</param>
    /// <returns>Formatted health text with thousands separators.</returns>
    /// <example>
    /// FormatHealthText(2847, 5000) returns: "HP: 2,847 / 5,000"
    /// </example>
    public string FormatHealthText(int current, int max)
    {
        return $"HP: {current:N0} / {max:N0}";
    }

    /// <summary>
    /// Determines the health bar color based on current health percentage.
    /// </summary>
    /// <param name="healthPercent">The current health percentage (0-100).</param>
    /// <returns>The console color for the health bar fill.</returns>
    public ConsoleColor GetHealthColor(int healthPercent)
    {
        foreach (var threshold in _config.ColorThresholds.OrderByDescending(t => t.Percent))
        {
            if (healthPercent > threshold.Percent)
            {
                return threshold.Color;
            }
        }

        return _config.Colors.CriticalColor;
    }

    /// <summary>
    /// Formats the bar border characters.
    /// </summary>
    /// <param name="barWidth">The width of the bar interior.</param>
    /// <returns>The bar border string.</returns>
    /// <example>
    /// FormatBarBorder(10) returns: "+============+"
    /// </example>
    public string FormatBarBorder(int barWidth)
    {
        var borderChars = new string(_config.Symbols.BorderChar, barWidth);
        return $"{_config.Symbols.CornerChar}{borderChars}{_config.Symbols.CornerChar}";
    }

    /// <summary>
    /// Formats a phase label for display below the health bar.
    /// </summary>
    /// <param name="phaseNumber">The phase number (1-based).</param>
    /// <param name="thresholdPercent">The health threshold percentage.</param>
    /// <returns>A formatted phase label string.</returns>
    /// <example>
    /// FormatPhaseLabel(2, 75) returns: "Phase 2\n (75%)"
    /// </example>
    public string FormatPhaseLabel(int phaseNumber, int thresholdPercent)
    {
        return $"Phase {phaseNumber}\n ({thresholdPercent}%)";
    }

    /// <summary>
    /// Renders a phase marker character for the health bar.
    /// </summary>
    /// <param name="thresholdPercent">The health threshold percentage.</param>
    /// <param name="phaseNumber">The phase number for tooltip.</param>
    /// <returns>The phase marker character.</returns>
    public string RenderPhaseMarker(int thresholdPercent, int phaseNumber)
    {
        return _config.Symbols.PhaseMarkerChar.ToString();
    }

    /// <summary>
    /// Gets the color used for damage flash effect.
    /// </summary>
    /// <returns>The flash color for damage animation.</returns>
    public ConsoleColor GetDamageFlashColor()
    {
        return _config.Colors.DamageFlashColor;
    }

    /// <summary>
    /// Formats the damage delta display text.
    /// </summary>
    /// <param name="damageAmount">The amount of damage dealt.</param>
    /// <returns>Formatted damage delta string.</returns>
    /// <example>
    /// FormatDamageDelta(150) returns: "[-150]"
    /// FormatDamageDelta(-50) returns: "[+50]" (healing)
    /// </example>
    public string FormatDamageDelta(int damageAmount)
    {
        if (damageAmount > 0)
        {
            return $"[-{damageAmount:N0}]";
        }
        else if (damageAmount < 0)
        {
            return $"[+{Math.Abs(damageAmount):N0}]";
        }

        return string.Empty;
    }

    /// <summary>
    /// Calculates the bar fill width for a given health percentage.
    /// </summary>
    /// <param name="healthPercent">The current health percentage (0-100).</param>
    /// <param name="barWidth">The total bar width in characters.</param>
    /// <returns>The number of filled characters.</returns>
    public int CalculateFillWidth(int healthPercent, int barWidth)
    {
        var normalizedPercent = Math.Clamp(healthPercent, 0, 100) / 100.0;
        return (int)(barWidth * normalizedPercent);
    }
}
```

### 5.2 Health Text Formatting

The health text displays current and maximum HP values with thousands separators for readability:

| Current | Max | Output |
|---------|-----|--------|
| 2847 | 5000 | "HP: 2,847 / 5,000" |
| 100 | 100 | "HP: 100 / 100" |
| 12500 | 25000 | "HP: 12,500 / 25,000" |
| 0 | 5000 | "HP: 0 / 5,000" |

### 5.3 Phase Marker Formatting

Phase markers display:
- A vertical bar (`|`) on the health bar at the threshold position
- A label below showing phase number and percentage

**Visual Layout:**

```
+============================================================+
|█████████████████████████████|██████████████|██████████████░|
+============================================================+
                           |              |              |
                        Phase 2        Phase 3        Phase 4
                         (75%)          (50%)          (25%)
```

---

## 6. Data Model Changes

### 6.1 New DTOs

**File:** `src/Presentation/RuneAndRust.Presentation.Tui/DTOs/BossHealthDtos.cs`

```csharp
namespace RuneAndRust.Presentation.Tui.DTOs;

/// <summary>
/// Data transfer object containing boss health display information.
/// </summary>
/// <param name="BossId">The unique identifier for the boss definition.</param>
/// <param name="BossName">The display name of the boss.</param>
/// <param name="CurrentHealth">The current health value.</param>
/// <param name="MaxHealth">The maximum health value.</param>
/// <param name="HealthPercent">The calculated health percentage (0-100).</param>
/// <param name="CurrentPhaseNumber">The current phase number (1-based).</param>
public record BossHealthDisplayDto(
    string BossId,
    string BossName,
    int CurrentHealth,
    int MaxHealth,
    int HealthPercent,
    int CurrentPhaseNumber);

/// <summary>
/// Data transfer object for phase marker display information.
/// </summary>
/// <param name="PhaseNumber">The phase number (1-based).</param>
/// <param name="PhaseName">The display name of the phase.</param>
/// <param name="ThresholdPercent">The health percentage threshold (0-100).</param>
public record PhaseMarkerDto(
    int PhaseNumber,
    string PhaseName,
    int ThresholdPercent);

/// <summary>
/// Data transfer object for damage animation information.
/// </summary>
/// <param name="PreviousHealth">The health value before damage.</param>
/// <param name="CurrentHealth">The health value after damage.</param>
/// <param name="DamageAmount">The amount of damage dealt (positive) or healed (negative).</param>
public record DamageAnimationDto(
    int PreviousHealth,
    int CurrentHealth,
    int DamageAmount);
```

### 6.2 Configuration Classes

**File:** `src/Presentation/RuneAndRust.Presentation.Tui/Configuration/BossHealthDisplayConfig.cs`

```csharp
namespace RuneAndRust.Presentation.Tui.Configuration;

/// <summary>
/// Configuration for boss health bar display settings.
/// </summary>
public class BossHealthDisplayConfig
{
    /// <summary>
    /// The width of the health bar fill area in characters.
    /// </summary>
    public int BarWidth { get; set; } = 60;

    /// <summary>
    /// The total width of the display area.
    /// </summary>
    public int TotalWidth { get; set; } = 72;

    /// <summary>
    /// The total height of the display area in rows.
    /// </summary>
    public int TotalHeight { get; set; } = 6;

    /// <summary>
    /// Starting X coordinate for the display.
    /// </summary>
    public int StartX { get; set; } = 0;

    /// <summary>
    /// Starting Y coordinate for the display.
    /// </summary>
    public int StartY { get; set; } = 0;

    /// <summary>
    /// Indentation for text elements.
    /// </summary>
    public int TextIndent { get; set; } = 3;

    /// <summary>
    /// Symbol configuration for the health bar.
    /// </summary>
    public BossHealthBarSymbols Symbols { get; set; } = new();

    /// <summary>
    /// Color configuration for the health bar.
    /// </summary>
    public BossHealthBarColors Colors { get; set; } = new();

    /// <summary>
    /// Color thresholds for health percentage display.
    /// </summary>
    public List<HealthColorThreshold> ColorThresholds { get; set; } = new()
    {
        new HealthColorThreshold { Percent = 75, Color = ConsoleColor.Green },
        new HealthColorThreshold { Percent = 50, Color = ConsoleColor.Yellow },
        new HealthColorThreshold { Percent = 25, Color = ConsoleColor.DarkYellow },
        new HealthColorThreshold { Percent = 0, Color = ConsoleColor.Red }
    };

    /// <summary>
    /// Animation timing configuration.
    /// </summary>
    public DamageAnimationConfig Animation { get; set; } = new();
}

/// <summary>
/// Symbol characters for boss health bar rendering.
/// </summary>
public class BossHealthBarSymbols
{
    /// <summary>Character for filled health bar portion.</summary>
    public char FilledChar { get; set; } = '#';

    /// <summary>Character for empty health bar portion.</summary>
    public char EmptyChar { get; set; } = '.';

    /// <summary>Character for bar border.</summary>
    public char BorderChar { get; set; } = '=';

    /// <summary>Character for bar corners.</summary>
    public char CornerChar { get; set; } = '+';

    /// <summary>Character for phase marker on bar.</summary>
    public char PhaseMarkerChar { get; set; } = '|';

    /// <summary>Prefix for boss name header.</summary>
    public string HeaderPrefix { get; set; } = "<<";

    /// <summary>Suffix for boss name header.</summary>
    public string HeaderSuffix { get; set; } = ">>";
}

/// <summary>
/// Color configuration for boss health bar elements.
/// </summary>
public class BossHealthBarColors
{
    /// <summary>Color for the boss name header.</summary>
    public ConsoleColor HeaderColor { get; set; } = ConsoleColor.Magenta;

    /// <summary>Color for phase markers.</summary>
    public ConsoleColor PhaseMarkerColor { get; set; } = ConsoleColor.White;

    /// <summary>Color for damage flash effect.</summary>
    public ConsoleColor DamageFlashColor { get; set; } = ConsoleColor.Red;

    /// <summary>Color for damage delta text.</summary>
    public ConsoleColor DamageColor { get; set; } = ConsoleColor.Red;

    /// <summary>Color for critical health (0%).</summary>
    public ConsoleColor CriticalColor { get; set; } = ConsoleColor.DarkRed;
}

/// <summary>
/// Health color threshold configuration.
/// </summary>
public class HealthColorThreshold
{
    /// <summary>The minimum health percentage for this color.</summary>
    public int Percent { get; set; }

    /// <summary>The color to use above this percentage.</summary>
    public ConsoleColor Color { get; set; }
}

/// <summary>
/// Damage animation timing configuration.
/// </summary>
public class DamageAnimationConfig
{
    /// <summary>Duration of the damage flash effect in milliseconds.</summary>
    public int FlashDurationMs { get; set; } = 100;

    /// <summary>Duration to display the damage delta in milliseconds.</summary>
    public int DeltaDisplayMs { get; set; } = 500;
}
```

---

## 7. Configuration File Schemas

### 7.1 boss-health-display.json

**File:** `config/boss-health-display.json`

```json
{
  "$schema": "./schemas/boss-health-display.schema.json",
  "barWidth": 60,
  "totalWidth": 72,
  "totalHeight": 6,
  "startX": 0,
  "startY": 0,
  "textIndent": 3,
  "symbols": {
    "filledChar": "#",
    "emptyChar": ".",
    "borderChar": "=",
    "cornerChar": "+",
    "phaseMarkerChar": "|",
    "headerPrefix": "<<",
    "headerSuffix": ">>"
  },
  "colors": {
    "headerColor": "Magenta",
    "phaseMarkerColor": "White",
    "damageFlashColor": "Red",
    "damageColor": "Red",
    "criticalColor": "DarkRed"
  },
  "colorThresholds": [
    { "percent": 75, "color": "Green" },
    { "percent": 50, "color": "Yellow" },
    { "percent": 25, "color": "DarkYellow" },
    { "percent": 0, "color": "Red" }
  ],
  "animation": {
    "flashDurationMs": 100,
    "deltaDisplayMs": 500
  }
}
```

### 7.2 boss-health-display.schema.json

**File:** `config/schemas/boss-health-display.schema.json`

```json
{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "boss-health-display.schema.json",
  "title": "Boss Health Display Configuration",
  "description": "Configuration for boss health bar display in combat UI",
  "type": "object",
  "properties": {
    "barWidth": {
      "type": "integer",
      "description": "Width of the health bar fill area in characters",
      "minimum": 20,
      "maximum": 120,
      "default": 60
    },
    "totalWidth": {
      "type": "integer",
      "description": "Total width of the display area",
      "minimum": 30,
      "maximum": 150,
      "default": 72
    },
    "totalHeight": {
      "type": "integer",
      "description": "Total height of the display area in rows",
      "minimum": 4,
      "maximum": 10,
      "default": 6
    },
    "startX": {
      "type": "integer",
      "description": "Starting X coordinate for the display",
      "minimum": 0,
      "default": 0
    },
    "startY": {
      "type": "integer",
      "description": "Starting Y coordinate for the display",
      "minimum": 0,
      "default": 0
    },
    "textIndent": {
      "type": "integer",
      "description": "Indentation for text elements",
      "minimum": 0,
      "maximum": 10,
      "default": 3
    },
    "symbols": {
      "type": "object",
      "description": "Symbol characters for health bar rendering",
      "properties": {
        "filledChar": {
          "type": "string",
          "maxLength": 1,
          "default": "#"
        },
        "emptyChar": {
          "type": "string",
          "maxLength": 1,
          "default": "."
        },
        "borderChar": {
          "type": "string",
          "maxLength": 1,
          "default": "="
        },
        "cornerChar": {
          "type": "string",
          "maxLength": 1,
          "default": "+"
        },
        "phaseMarkerChar": {
          "type": "string",
          "maxLength": 1,
          "default": "|"
        },
        "headerPrefix": {
          "type": "string",
          "maxLength": 4,
          "default": "<<"
        },
        "headerSuffix": {
          "type": "string",
          "maxLength": 4,
          "default": ">>"
        }
      },
      "additionalProperties": false
    },
    "colors": {
      "type": "object",
      "description": "Color configuration for health bar elements",
      "properties": {
        "headerColor": {
          "$ref": "#/$defs/consoleColor",
          "default": "Magenta"
        },
        "phaseMarkerColor": {
          "$ref": "#/$defs/consoleColor",
          "default": "White"
        },
        "damageFlashColor": {
          "$ref": "#/$defs/consoleColor",
          "default": "Red"
        },
        "damageColor": {
          "$ref": "#/$defs/consoleColor",
          "default": "Red"
        },
        "criticalColor": {
          "$ref": "#/$defs/consoleColor",
          "default": "DarkRed"
        }
      },
      "additionalProperties": false
    },
    "colorThresholds": {
      "type": "array",
      "description": "Health percentage color thresholds",
      "items": {
        "type": "object",
        "properties": {
          "percent": {
            "type": "integer",
            "minimum": 0,
            "maximum": 100
          },
          "color": {
            "$ref": "#/$defs/consoleColor"
          }
        },
        "required": ["percent", "color"],
        "additionalProperties": false
      },
      "minItems": 1
    },
    "animation": {
      "type": "object",
      "description": "Damage animation timing configuration",
      "properties": {
        "flashDurationMs": {
          "type": "integer",
          "description": "Duration of damage flash in milliseconds",
          "minimum": 0,
          "maximum": 500,
          "default": 100
        },
        "deltaDisplayMs": {
          "type": "integer",
          "description": "Duration to display damage delta in milliseconds",
          "minimum": 0,
          "maximum": 2000,
          "default": 500
        }
      },
      "additionalProperties": false
    }
  },
  "$defs": {
    "consoleColor": {
      "type": "string",
      "enum": [
        "Black", "DarkBlue", "DarkGreen", "DarkCyan",
        "DarkRed", "DarkMagenta", "DarkYellow", "Gray",
        "DarkGray", "Blue", "Green", "Cyan",
        "Red", "Magenta", "Yellow", "White"
      ]
    }
  },
  "additionalProperties": false
}
```

---

## 8. CombatView Integration

### 8.1 Integration Points

**File:** `src/Presentation/RuneAndRust.Presentation.Tui/Views/CombatView.cs` (modifications)

```csharp
// Add to CombatView class

private readonly BossHealthBar _bossHealthBar;
private readonly IBossMechanicsService _bossMechanicsService;
private readonly IBossDefinitionProvider _bossDefinitionProvider;
private IDisposable? _damageEventSubscription;

/// <summary>
/// Initializes boss encounter UI components when a boss is detected.
/// </summary>
private void InitializeBossEncounterUI()
{
    var activeBosses = _bossMechanicsService.GetActiveBosses();
    if (activeBosses.Count == 0)
    {
        _bossHealthBar.Clear();
        return;
    }

    // Display primary boss (first active boss)
    var boss = activeBosses[0];
    var bossState = _bossMechanicsService.GetBossState(boss);
    if (bossState == null) return;

    var definition = _bossDefinitionProvider.GetBossDefinition(bossState.BossId);
    if (definition == null) return;

    // Create health display DTO
    var healthDto = new BossHealthDisplayDto(
        BossId: definition.BossId,
        BossName: definition.Name,
        CurrentHealth: boss.Health,
        MaxHealth: boss.MaxHealth,
        HealthPercent: CalculateHealthPercent(boss),
        CurrentPhaseNumber: bossState.CurrentPhaseNumber);

    // Create phase marker DTOs
    var phaseMarkers = definition.Phases
        .Where(p => p.HealthThreshold < 100) // Exclude starting phase marker
        .Select(p => new PhaseMarkerDto(
            PhaseNumber: p.PhaseNumber,
            PhaseName: p.Name,
            ThresholdPercent: p.HealthThreshold))
        .ToList();

    // Configure and render boss health bar
    _bossHealthBar.ShowPhaseMarkers(phaseMarkers);
    _bossHealthBar.RenderBar(healthDto);

    // Subscribe to damage events for animation
    SubscribeToBossDamageEvents(boss.Id);
}

/// <summary>
/// Subscribes to damage events for boss animation.
/// </summary>
private void SubscribeToBossDamageEvents(Guid bossId)
{
    _damageEventSubscription?.Dispose();
    _damageEventSubscription = _eventBus.Subscribe<EntityDamagedEvent>(evt =>
    {
        if (evt.EntityId == bossId)
        {
            var animationDto = new DamageAnimationDto(
                PreviousHealth: evt.PreviousHealth,
                CurrentHealth: evt.CurrentHealth,
                DamageAmount: evt.DamageAmount);

            _bossHealthBar.AnimateDamage(animationDto);
        }
    });
}

/// <summary>
/// Calculates health percentage using ceiling for threshold accuracy.
/// </summary>
private static int CalculateHealthPercent(Monster boss)
{
    if (boss.MaxHealth <= 0) return 0;
    return (int)Math.Ceiling((boss.Health / (float)boss.MaxHealth) * 100);
}
```

### 8.2 Layout Position

The boss health bar is positioned at the top of the combat view:

```
┌─────────────────────────────────────────────────────────────────────┐
│                    <<  SKELETON KING  >>                            │  ← Row 0: Boss Name Header
├─────────────────────────────────────────────────────────────────────┤
│   HP: 2,847 / 5,000                                                 │  ← Row 1: Health Text
│   +============================================================+   │  ← Row 2: Health Bar
│   |############################................................|   │
│   +============================================================+   │
│                 |              |              |                      │  ← Row 3: Phase Markers
│              Phase 2        Phase 3        Phase 4                  │  ← Row 4-5: Phase Labels
│               (75%)          (50%)          (25%)                   │
├─────────────────────────────────────────────────────────────────────┤
│                        [Rest of Combat UI]                          │
└─────────────────────────────────────────────────────────────────────┘
```

---

## 9. Logging Specifications

### 9.1 Log Levels by Component

| Component | Level | Events |
|-----------|-------|--------|
| `BossHealthBar` | Information | Boss health bar initialized for encounter |
| `BossHealthBar` | Debug | Rendering health bar, updating health values |
| `BossHealthBar` | Debug | Phase markers configured, animation triggered |
| `BossHealthBar` | Warning | Cannot update health - no current state |
| `BossHealthBarRenderer` | Debug | Color threshold selection, position calculations |
| `CombatView` | Information | Boss encounter detected, UI initialized |
| `CombatView` | Debug | Subscribing to boss damage events |

### 9.2 Log Message Examples

```
[INF] BossHealthBar: Initialized boss health bar for "Skeleton King" encounter
[DBG] BossHealthBar: Rendering boss health bar for Skeleton King: 2847/5000 (57%)
[DBG] BossHealthBar: Set 3 phase markers for boss health bar
[DBG] BossHealthBar: Animating damage: 2997 -> 2847 (150)
[WRN] BossHealthBar: Cannot update health - no current state
[INF] CombatView: Boss encounter detected - initializing boss UI
[DBG] CombatView: Subscribing to damage events for boss 7a3f2b1c-...
```

---

## 10. Unit Testing Requirements

### 10.1 Test Count by Feature

| Feature | Test Count |
|---------|------------|
| BossHealthBarRenderer | ~3 |
| BossHealthBar | ~2 |
| Phase Marker Positioning | ~1 |
| **Total** | **~6** |

### 10.2 Test Specifications

**File:** `tests/RuneAndRust.Presentation.Tui.Tests/Renderers/BossHealthBarRendererTests.cs`

```csharp
[TestFixture]
public class BossHealthBarRendererTests
{
    private BossHealthBarRenderer _renderer;
    private BossHealthDisplayConfig _config;

    [SetUp]
    public void Setup()
    {
        _config = new BossHealthDisplayConfig();
        _renderer = new BossHealthBarRenderer(_config);
    }

    [Test]
    public void FormatHealthText_WithValidValues_ReturnsFormattedString()
    {
        // Arrange
        var current = 2847;
        var max = 5000;

        // Act
        var result = _renderer.FormatHealthText(current, max);

        // Assert
        Assert.That(result, Is.EqualTo("HP: 2,847 / 5,000"));
    }

    [Test]
    [TestCase(100, ExpectedResult = ConsoleColor.Green)]
    [TestCase(76, ExpectedResult = ConsoleColor.Green)]
    [TestCase(75, ExpectedResult = ConsoleColor.Yellow)]
    [TestCase(51, ExpectedResult = ConsoleColor.Yellow)]
    [TestCase(50, ExpectedResult = ConsoleColor.DarkYellow)]
    [TestCase(26, ExpectedResult = ConsoleColor.DarkYellow)]
    [TestCase(25, ExpectedResult = ConsoleColor.Red)]
    [TestCase(1, ExpectedResult = ConsoleColor.Red)]
    [TestCase(0, ExpectedResult = ConsoleColor.DarkRed)]
    public ConsoleColor GetHealthColor_WithHealthPercent_ReturnsCorrectColor(int healthPercent)
    {
        return _renderer.GetHealthColor(healthPercent);
    }

    [Test]
    public void FormatBossNameHeader_WithName_ReturnsCenteredDecoratedHeader()
    {
        // Arrange
        var bossName = "SKELETON KING";
        var totalWidth = 60;

        // Act
        var result = _renderer.FormatBossNameHeader(bossName, totalWidth);

        // Assert
        Assert.That(result, Does.Contain("<<  SKELETON KING  >>"));
        Assert.That(result.Length, Is.EqualTo(totalWidth));
    }
}
```

**File:** `tests/RuneAndRust.Presentation.Tui.Tests/UI/BossHealthBarTests.cs`

```csharp
[TestFixture]
public class BossHealthBarTests
{
    private Mock<BossHealthBarRenderer> _mockRenderer;
    private Mock<ITerminalService> _mockTerminal;
    private Mock<ILogger<BossHealthBar>> _mockLogger;
    private BossHealthDisplayConfig _config;
    private BossHealthBar _healthBar;

    [SetUp]
    public void Setup()
    {
        _config = new BossHealthDisplayConfig();
        _mockRenderer = new Mock<BossHealthBarRenderer>(_config);
        _mockTerminal = new Mock<ITerminalService>();
        _mockLogger = new Mock<ILogger<BossHealthBar>>();

        _healthBar = new BossHealthBar(
            _mockRenderer.Object,
            _mockTerminal.Object,
            _config,
            _mockLogger.Object);
    }

    [Test]
    public void RenderBar_WithValidDto_RendersAllElements()
    {
        // Arrange
        var dto = new BossHealthDisplayDto(
            BossId: "skeleton-king",
            BossName: "Skeleton King",
            CurrentHealth: 2847,
            MaxHealth: 5000,
            HealthPercent: 57,
            CurrentPhaseNumber: 2);

        _mockRenderer.Setup(r => r.FormatBossNameHeader(It.IsAny<string>(), It.IsAny<int>()))
            .Returns("<<  SKELETON KING  >>");
        _mockRenderer.Setup(r => r.FormatHealthText(It.IsAny<int>(), It.IsAny<int>()))
            .Returns("HP: 2,847 / 5,000");
        _mockRenderer.Setup(r => r.GetHealthColor(It.IsAny<int>()))
            .Returns(ConsoleColor.Yellow);

        // Act
        _healthBar.RenderBar(dto);

        // Assert
        _mockTerminal.Verify(t => t.WriteColoredAt(
            It.IsAny<int>(), It.IsAny<int>(),
            It.Is<string>(s => s.Contains("SKELETON KING")),
            It.IsAny<ConsoleColor>()), Times.Once);

        _mockTerminal.Verify(t => t.WriteAt(
            It.IsAny<int>(), It.IsAny<int>(),
            It.Is<string>(s => s.Contains("HP:"))), Times.Once);
    }

    [Test]
    public void ShowPhaseMarkers_WithPhases_StoresMarkers()
    {
        // Arrange
        var markers = new List<PhaseMarkerDto>
        {
            new(2, "Empowered", 75),
            new(3, "Enraged", 50),
            new(4, "Desperate", 25)
        };

        // Act & Assert (no exception)
        Assert.DoesNotThrow(() => _healthBar.ShowPhaseMarkers(markers));
    }
}
```

**File:** `tests/RuneAndRust.Presentation.Tui.Tests/UI/PhaseMarkerPositionTests.cs`

```csharp
[TestFixture]
public class PhaseMarkerPositionTests
{
    [Test]
    [TestCase(75, 60, 45)]  // 75% of 60 = 45
    [TestCase(50, 60, 30)]  // 50% of 60 = 30
    [TestCase(25, 60, 15)]  // 25% of 60 = 15
    [TestCase(66, 60, 39)]  // 66% of 60 = 39.6 → 39
    [TestCase(33, 60, 19)]  // 33% of 60 = 19.8 → 19
    public void CalculateMarkerPosition_WithThreshold_ReturnsCorrectPosition(
        int thresholdPercent, int barWidth, int expectedPosition)
    {
        // Arrange
        var config = new BossHealthDisplayConfig { BarWidth = barWidth };
        var renderer = new BossHealthBarRenderer(config);

        // Act
        var result = renderer.CalculateFillWidth(thresholdPercent, barWidth);

        // Assert
        Assert.That(result, Is.EqualTo(expectedPosition));
    }
}
```

---

## 11. Use Cases

### UC-001: View Boss Health During Encounter

**Actor:** Player
**Flow:** Enter boss encounter → Boss health bar appears → View current HP, max HP, percentage → See phase markers indicating transition thresholds → Continue combat

### UC-002: Observe Damage Animation

**Actor:** Player
**Flow:** Attack boss → Boss takes damage → Health bar flashes red → Damage delta appears "[-150]" → Bar fill updates to new health → Delta fades → Normal display resumes

### UC-003: Track Phase Progress

**Actor:** Player
**Flow:** View boss health bar → See phase markers at 75%, 50%, 25% → Deal damage reducing boss to 74% → Bar fill passes Phase 2 marker → Phase transition triggers (v0.13.1b) → Continue tracking toward next phase marker

### UC-004: Monitor Health Color Changes

**Actor:** Player
**Flow:** Boss at 80% health (green bar) → Deal damage → Boss at 60% (yellow bar) → Deal more damage → Boss at 40% (orange bar) → Deal damage → Boss at 20% (red bar) → Boss defeated

---

## 12. Deliverable Checklist

### UI Components
- [ ] `BossHealthBar` class implemented
- [ ] `RenderBar()` method renders complete health bar
- [ ] `ShowPhaseMarkers()` method configures phase markers
- [ ] `AnimateDamage()` method provides damage feedback
- [ ] `UpdateHealth()` method updates display without animation
- [ ] `Clear()` method removes display

### Renderers
- [ ] `BossHealthBarRenderer` class implemented
- [ ] `FormatHealthText()` formats HP values
- [ ] `GetHealthColor()` returns correct color for percentage
- [ ] `FormatBossNameHeader()` creates centered header
- [ ] `RenderPhaseMarker()` positions markers correctly
- [ ] `FormatDamageDelta()` formats damage text

### DTOs
- [ ] `BossHealthDisplayDto` record created
- [ ] `PhaseMarkerDto` record created
- [ ] `DamageAnimationDto` record created

### Configuration
- [ ] `BossHealthDisplayConfig` class created
- [ ] `BossHealthBarSymbols` class created
- [ ] `BossHealthBarColors` class created
- [ ] `HealthColorThreshold` class created
- [ ] `DamageAnimationConfig` class created
- [ ] `config/boss-health-display.json` created
- [ ] `config/schemas/boss-health-display.schema.json` created

### View Integration
- [ ] `CombatView` boss encounter detection implemented
- [ ] `CombatView` damage event subscription implemented
- [ ] Boss health bar positioned correctly in layout

### Testing
- [ ] ~6 unit tests implemented
- [ ] All tests passing

---

## 13. Acceptance Criteria

### Functional
- [ ] Boss health bar displays with correct percentage
- [ ] Health text shows current/max HP with thousands separators
- [ ] Phase markers appear at correct threshold positions
- [ ] Phase labels show phase number and percentage below bar
- [ ] Damage animation triggers on boss taking damage
- [ ] Damage delta displays briefly after damage
- [ ] Health bar color changes based on health percentage
- [ ] Boss name displays in decorated header
- [ ] Health bar clears when boss encounter ends

### Quality
- [ ] Build succeeds with 0 errors/warnings
- [ ] All ~6 unit tests pass
- [ ] Configuration file validates against schema
- [ ] XML documentation complete on all public members
- [ ] No hardcoded values (all configurable)

---

## 14. Dependencies

### Required from v0.10.4x

| Type | Location | Usage in v0.13.1a |
|------|----------|-------------------|
| `IBossMechanicsService` | `Application/Interfaces/` | Get boss state, check if boss |
| `IBossDefinitionProvider` | `Application/Interfaces/` | Get boss definition with phases |
| `BossDefinition` | `Domain/Definitions/` | Boss template with phase list |
| `BossPhase` | `Domain/Definitions/` | Phase threshold and name |
| `ActiveBossState` | `Application/Tracking/` | Current phase number |
| `Monster` | `Domain/Entities/` | Current/max health values |
| `EntityDamagedEvent` | `Application/Events/` | Trigger damage animation |

### Required from v0.13.0

| Type | Location | Usage in v0.13.1a |
|------|----------|-------------------|
| `CombatView` | `Presentation.Tui/Views/` | Integration point |
| `ITerminalService` | `Presentation.Tui/Services/` | Terminal output |

### Provides to v0.13.1b

| Type | Usage |
|------|-------|
| `BossHealthBar` | Phase transition effects displayed alongside |
| `BossHealthDisplayConfig` | Shared configuration patterns |
| `BossHealthBarRenderer` | Reusable rendering utilities |

---

## 15. Future Considerations

### Deferred to v0.13.1b
- **Phase Transition Effects**: Visual effects when crossing phase thresholds
- **Enrage Timer Display**: Countdown timer for boss enrage mechanic
- **Vulnerability Window Indicator**: Display when boss is vulnerable

### Out of Scope
- **Multiple Boss Display**: Displaying health bars for multiple bosses simultaneously (future consideration)
- **Boss Shield/Barrier**: Additional bar for shield mechanics (not in v0.10.4x)
- **Healing Animation**: Green flash for boss healing (inverse of damage animation)

---

*Document Version: 1.0*
*Last Updated: 2026-01-16*
*Author: Claude (AI Assistant)*
