# v0.16.1e Design Specification: Proficiency Acquisition Service

**Version:** 0.16.1e  
**Phase Name:** Proficiency Acquisition Service  
**Parent Version:** v0.16.1 (Weapon Proficiency System)  
**Prerequisites:** v0.16.1a Complete (Proficiency Level Enum), v0.16.1b Complete (Weapon Category System), v0.16.1c Complete (Archetype Proficiency Matrix), v0.16.1d Complete (Character Proficiency Tracking)  
**Estimated Tests:** ~4 unit tests

---

## Table of Contents

1. [Executive Summary](#1-executive-summary)
2. [Feature Overview](#2-feature-overview)
3. [Architecture Diagrams](#3-architecture-diagrams)
4. [IProficiencyAcquisitionService Interface](#4-iproficiencyacquisitionservice-interface)
5. [ProficiencyGainResult Value Object](#5-proficiencygainresult-value-object)
6. [TrainingResult Value Object](#6-trainingresult-value-object)
7. [Data Model Changes](#7-data-model-changes)
8. [Configuration File Schemas](#8-configuration-file-schemas)
9. [Logging Specifications](#9-logging-specifications)
10. [Unit Testing Requirements](#10-unit-testing-requirements)
11. [Use Cases](#11-use-cases)
12. [Deliverable Checklist](#12-deliverable-checklist)
13. [Acceptance Criteria](#13-acceptance-criteria)
14. [Dependencies](#14-dependencies)
15. [Future Considerations](#15-future-considerations)

---

## 1. Executive Summary

### 1.1 Purpose

This specification defines the proficiency acquisition service, which handles all methods of gaining and advancing weapon category proficiencies. Characters can acquire proficiency through five distinct methods, each with different costs, time requirements, and prerequisites.

The five acquisition methods are:

- **Archetype**: Free, instant proficiencies based on character creation choice
- **Specialization**: Free, instant proficiencies from archetype specializations
- **NPC Training**: 50-200 PS cost, 1-4 weeks training time
- **Combat Experience**: Free, requires 10/25/50 combats per level
- **Progression Point (PP) Purchase**: 2 PP cost, instant advancement

### 1.2 Key Deliverables

| Category          | Items                                     |
| ----------------- | ----------------------------------------- |
| **Interfaces**    | `IProficiencyAcquisitionService`          |
| **Value Objects** | `ProficiencyGainResult`, `TrainingResult` |
| **Configuration** | `proficiency-acquisition.json`            |
| **Tests**         | ~4 unit tests                             |

### 1.3 Architectural Significance

This version establishes the **Proficiency Acquisition Pattern**:

- **Centralized Acquisition Logic**: All proficiency changes go through `IProficiencyAcquisitionService`
- **Method-Specific Validation**: Each acquisition method has unique prerequisites and costs
- **Result Objects**: Acquisition attempts return structured results with success/failure reasons
- **State Management**: Service updates `CharacterProficiencies` entity and enforces advancement rules

---

## 2. Feature Overview

```
v0.16.1e Proficiency Acquisition Service
├── IProficiencyAcquisitionService Interface
│   ├── InitializeFromArchetype(character, archetypeId)
│   ├── RecordCombatExperience(character, category)
│   ├── PurchaseWithProgressionPoints(character, category)
│   ├── TrainWithNPC(character, category, trainerId)
│   └── GrantFromSpecialization(character, categories)
├── ProficiencyGainResult Value Object
│   ├── Success: bool
│   ├── Category: WeaponCategory
│   ├── OldLevel: WeaponProficiencyLevel
│   ├── NewLevel: WeaponProficiencyLevel
│   ├── Method: AcquisitionMethod
│   ├── FailureReason: string?
│   └── CostPaid: AcquisitionCost?
├── TrainingResult Value Object
│   ├── Success: bool
│   ├── Category: WeaponCategory
│   ├── PsCost: int
│   ├── TrainingWeeks: int
│   ├── TrainerId: string
│   └── FailureReason: string?
└── Acquisition Methods
    ├── Method 1: Archetype (Free, instant)
    ├── Method 2: Specialization (Free, instant)
    ├── Method 3: NPC Training (50-200 PS, 1-4 weeks)
    ├── Method 4: Combat Experience (10/25/50 combats)
    └── Method 5: PP Purchase (2 PP, instant)
```

### 2.1 Scope Alignment

**In Scope:**

- `IProficiencyAcquisitionService` application interface
- `ProficiencyGainResult` domain value object
- `TrainingResult` domain value object
- `AcquisitionMethod` enum
- `AcquisitionCost` value object
- Archetype initialization logic
- Specialization proficiency grants
- Combat experience tracking and advancement
- PP purchase validation and deduction
- NPC training cost/time calculation
- `proficiency-acquisition.json` configuration

**Out of Scope:**

- Combat integration and automatic experience awarding (v0.16.1f)
- NPC trainer entity definitions (future version)
- Specialization system definitions (future version)
- Advanced technique unlocking (future version)

---

## 3. Architecture Diagrams

### 3.1 Proficiency Acquisition System Overview

```
┌─────────────────────────────────────────────────────────────────────┐
│           PROFICIENCY ACQUISITION SYSTEM OVERVIEW                    │
└─────────────────────────────────────────────────────────────────────┘

    Character wants to gain/advance proficiency
         │
         ▼
┌─────────────────────────────────────────────────────────────────────┐
│            IProficiencyAcquisitionService                            │
├─────────────────────────────────────────────────────────────────────┤
│  Method Selection:                                                   │
│  ├─ InitializeFromArchetype() → Character creation                  │
│  ├─ RecordCombatExperience() → Post-combat                          │
│  ├─ PurchaseWithProgressionPoints() → Player choice                 │
│  ├─ TrainWithNPC() → Interact with trainer                          │
│  └─ GrantFromSpecialization() → Archetype advancement               │
└─────────────────────────────────────────────────────────────────────┘
         │
         │  Validate prerequisites & costs
         ▼
┌─────────────────────────────────────────────────────────────────────┐
│                   VALIDATION LOGIC                                   │
├─────────────────────────────────────────────────────────────────────┤
│  Archetype:       No validation needed (free)                       │
│  Specialization:  No validation needed (free)                       │
│  Combat Exp:      Check if threshold reached                        │
│  PP Purchase:     Check if character has 2 PP available             │
│  NPC Training:    Check PS balance, calculate cost/time             │
└─────────────────────────────────────────────────────────────────────┘
         │
         │  If valid
         ▼
┌─────────────────────────────────────────────────────────────────────┐
│                  UPDATE CHARACTER STATE                              │
├─────────────────────────────────────────────────────────────────────┤
│  1. Get CharacterProficiencies entity                                │
│  2. Get current ProficiencyProgress for category                     │
│  3. Apply advancement (increment exp OR level up)                    │
│  4. Deduct costs if applicable (PP or PS)                            │
│  5. Update CharacterProficiencies entity                             │
└─────────────────────────────────────────────────────────────────────┘
         │
         │  Return result
         ▼
┌─────────────────────────────────────────────────────────────────────┐
│                ProficiencyGainResult / TrainingResult                │
├─────────────────────────────────────────────────────────────────────┤
│  Success: true/false                                                 │
│  Category: WeaponCategory                                            │
│  OldLevel → NewLevel (e.g., Proficient → Expert)                    │
│  Method: AcquisitionMethod (e.g., CombatExperience)                 │
│  CostPaid: { PP: 2 } or { PS: 100, Weeks: 2 }                       │
│  FailureReason: "Insufficient PP" (if failed)                       │
└─────────────────────────────────────────────────────────────────────┘
```

### 3.2 Acquisition Method Decision Tree

```
┌─────────────────────────────────────────────────────────────────────┐
│              PROFICIENCY ACQUISITION DECISION TREE                   │
└─────────────────────────────────────────────────────────────────────┘

    Character wants proficiency in category X
         │
         ▼
    ┌──────────────────────────────────────────────────────────────────┐
    │  DECISION: Which acquisition method?                              │
    └──────────────────────────────────────────────────────────────────┘
         │
         ├─────────────────────────────────────────────────────────────┐
         │                                                              │
         ▼                                                              ▼
    ┌─────────────────┐                                    ┌─────────────────┐
    │  CHARACTER      │                                    │   IMMEDIATE     │
    │  CREATION?      │                                    │   NEED?         │
    └────────┬────────┘                                    └────────┬────────┘
         YES │                                                  YES │
             ▼                                                      ▼
    ┌─────────────────────────────────────────┐        ┌─────────────────────┐
    │  METHOD 1: ARCHETYPE                    │        │  HAS 2 PP?          │
    ├─────────────────────────────────────────┤        └────────┬────────────┘
    │  Cost: Free                             │             YES │
    │  Time: Instant                          │                 ▼
    │  Prerequisites: Character creation      │        ┌─────────────────────────────┐
    │  Result: Proficient in archetype cats   │        │  METHOD 5: PP PURCHASE      │
    └─────────────────────────────────────────┘        ├─────────────────────────────┤
                                                        │  Cost: 2 PP                 │
                                                        │  Time: Instant              │
                                                        │  Prerequisites: 2 PP avail  │
                                                        │  Result: Advance 1 level    │
                                                        └─────────────────────────────┘
         │                                                      │
         │                                                  NO  │
         ▼                                                      ▼
    ┌─────────────────────────────────────────┐        ┌─────────────────────────────┐
    │  NO ARCHETYPE PROFICIENCY?              │        │  HAS PS & TIME?             │
    │  USE CATEGORY REGULARLY?                │        └────────┬────────────────────┘
    └────────┬────────────────────────────────┘             YES │
         YES │                                                  ▼
             ▼                                        ┌─────────────────────────────┐
    ┌─────────────────────────────────────────┐      │  METHOD 3: NPC TRAINING     │
    │  METHOD 4: COMBAT EXPERIENCE            │      ├─────────────────────────────┤
    ├─────────────────────────────────────────┤      │  Cost: 50-200 PS            │
    │  Cost: Free                             │      │  Time: 1-4 weeks            │
    │  Time: 10/25/50 combats                 │      │  Prerequisites: PS, trainer │
    │  Prerequisites: Use weapon in combat    │      │  Result: Advance 1 level    │
    │  Result: Track experience, auto-advance │      └─────────────────────────────┘
    └─────────────────────────────────────────┘
         │
         ▼
    ┌─────────────────────────────────────────┐
    │  METHOD 2: SPECIALIZATION (FUTURE)      │
    ├─────────────────────────────────────────┤
    │  Cost: Free                             │
    │  Time: Instant                          │
    │  Prerequisites: Archetype specialization│
    │  Result: Proficient in spec categories  │
    └─────────────────────────────────────────┘
```

### 3.3 Combat Experience Advancement Flow

```
┌─────────────────────────────────────────────────────────────────────┐
│              COMBAT EXPERIENCE ADVANCEMENT FLOW                      │
└─────────────────────────────────────────────────────────────────────┘

    Combat ends, character used weapon (category: Swords)
         │
         ▼
    ┌──────────────────────────────────────────────────────────────────┐
    │  1. CALL ACQUISITION SERVICE                                      │
    ├──────────────────────────────────────────────────────────────────┤
    │  acquisitionService.RecordCombatExperience(character, Swords)    │
    └──────────────────────────────────────────────────────────────────┘
         │
         ▼
    ┌──────────────────────────────────────────────────────────────────┐
    │  2. GET CURRENT PROGRESS                                          │
    ├──────────────────────────────────────────────────────────────────┤
    │  progress = character.Proficiencies.GetProgress(Swords)          │
    │    CurrentLevel = Proficient                                     │
    │    CombatExperience = 24                                         │
    │    ThresholdForNextLevel = 25 (Proficient → Expert)              │
    └──────────────────────────────────────────────────────────────────┘
         │
         ▼
    ┌──────────────────────────────────────────────────────────────────┐
    │  3. INCREMENT EXPERIENCE                                          │
    ├──────────────────────────────────────────────────────────────────┤
    │  newProgress = progress.AddExperience(1)                         │
    │    CombatExperience = 25                                         │
    └──────────────────────────────────────────────────────────────────┘
         │
         ▼
    ┌──────────────────────────────────────────────────────────────────┐
    │  4. CHECK THRESHOLD                                               │
    ├──────────────────────────────────────────────────────────────────┤
    │  IF newProgress.HasReachedNextThreshold                          │
    │    25 >= 25? → TRUE                                              │
    │    → ADVANCE TO NEXT LEVEL                                       │
    └──────────────────────────────────────────────────────────────────┘
         │
         ▼
    ┌──────────────────────────────────────────────────────────────────┐
    │  5. ADVANCE LEVEL                                                 │
    ├──────────────────────────────────────────────────────────────────┤
    │  advancedProgress = newProgress.AdvanceToNextLevel()             │
    │    CurrentLevel = Expert                                         │
    │    CombatExperience = 0 (reset)                                  │
    │    ThresholdForNextLevel = 50 (Expert → Master)                  │
    └──────────────────────────────────────────────────────────────────┘
         │
         ▼
    ┌──────────────────────────────────────────────────────────────────┐
    │  6. UPDATE CHARACTER STATE                                        │
    ├──────────────────────────────────────────────────────────────────┤
    │  character.Proficiencies.UpdateProgress(Swords, advancedProgress)│
    └──────────────────────────────────────────────────────────────────┘
         │
         ▼
    ┌──────────────────────────────────────────────────────────────────┐
    │  7. RETURN RESULT                                                 │
    ├──────────────────────────────────────────────────────────────────┤
    │  ProficiencyGainResult(                                          │
    │    Success = true,                                               │
    │    Category = Swords,                                            │
    │    OldLevel = Proficient,                                        │
    │    NewLevel = Expert,                                            │
    │    Method = CombatExperience,                                    │
    │    CostPaid = null                                               │
    │  )                                                               │
    └──────────────────────────────────────────────────────────────────┘
```

### 3.4 Acquisition Method Cost Comparison

```
┌─────────────────────────────────────────────────────────────────────┐
│              ACQUISITION METHOD COST COMPARISON                      │
└─────────────────────────────────────────────────────────────────────┘

Method              │ PP Cost │ PS Cost │ Time Required │ Availability
────────────────────┼─────────┼─────────┼───────────────┼──────────────
Archetype           │   —     │   —     │   Instant     │ Creation only
Specialization      │   —     │   —     │   Instant     │ Spec unlock
NPC Training        │   —     │ 50-200  │   1-4 weeks   │ Town/city
Combat Experience   │   —     │   —     │   10-85 fights│ Anytime
PP Purchase         │   2     │   —     │   Instant     │ Anytime*

* Requires sufficient PP balance

COST NOTES:
- Archetype: Free, grants all archetype proficiencies at Proficient
- Specialization: Free, grants additional category at Proficient
- NPC Training:
  └─ NonProficient → Proficient: 50 PS, 1 week
  └─ Proficient → Expert: 100 PS, 2 weeks
  └─ Expert → Master: 200 PS, 4 weeks
- Combat Experience: Free but requires actual combat participation
  └─ NonProficient → Proficient: 10 combats
  └─ Proficient → Expert: 25 combats
  └─ Expert → Master: 50 combats
- PP Purchase: 2 PP per level advancement (any level)

TYPICAL PLAYER PATHS:
1. Warrior (all weapons proficient) → Use combat exp for Expert/Master
2. Mystic (3 weapons proficient) → Use PP to quickly gain Proficient in
   other categories, then combat exp for advancement
3. Skirmisher (5 weapons proficient) → Mix of NPC training (if PS-rich)
   and combat experience for non-archetype weapons
```

### 3.5 Layer Diagram

```
┌─────────────────────────────────────────────────────────────────────┐
│                       APPLICATION LAYER                              │
├─────────────────────────────────────────────────────────────────────┤
│  ┌───────────────────────────────────────────────────────────────┐  │
│  │          ProficiencyAcquisitionService                         │  │
│  │      (implements IProficiencyAcquisitionService)               │  │
│  ├───────────────────────────────────────────────────────────────┤  │
│  │  + InitializeFromArchetype(char, archetypeId): Result         │  │
│  │  + RecordCombatExperience(char, category): GainResult         │  │
│  │  + PurchaseWithProgressionPoints(char, cat): GainResult       │  │
│  │  + TrainWithNPC(char, cat, trainerId): TrainingResult         │  │
│  │  + GrantFromSpecialization(char, cats): List<GainResult>      │  │
│  │                                                               │  │
│  │  - ValidatePPPurchase(char, category): ValidationResult      │  │
│  │  - ValidateTraining(char, category): ValidationResult        │  │
│  │  - CalculateTrainingCost(currentLevel): (PS, weeks)          │  │
│  │  - AdvanceLevel(progress): ProficiencyProgress               │  │
│  └───────────────────────────────────────────────────────────────┘  │
│                                                                      │
│  Dependencies:                                                       │
│  ├─ IArchetypeProficiencyProvider (v0.16.1c)                        │
│  ├─ IProficiencyEffectProvider (v0.16.1a)                           │
│  └─ ILogger<ProficiencyAcquisitionService>                          │
└───────┬─────────────────────────────────────────────────────────────┘
        │
        ▼
┌─────────────────────────────────────────────────────────────────────┐
│                         DOMAIN LAYER                                 │
├─────────────────────────────────────────────────────────────────────┤
│  ┌───────────────────────────────────────────────────────────────┐  │
│  │             ProficiencyGainResult                              │  │
│  │              (Value Object)                                    │  │
│  ├───────────────────────────────────────────────────────────────┤  │
│  │  Success: bool                                                 │  │
│  │  Category: WeaponCategory                                      │  │
│  │  OldLevel: WeaponProficiencyLevel                              │  │
│  │  NewLevel: WeaponProficiencyLevel                              │  │
│  │  Method: AcquisitionMethod                                     │  │
│  │  CostPaid: AcquisitionCost?                                    │  │
│  │  FailureReason: string?                                        │  │
│  └───────────────────────────────────────────────────────────────┘  │
│                                                                      │
│  ┌───────────────────────────────────────────────────────────────┐  │
│  │               TrainingResult                                   │  │
│  │              (Value Object)                                    │  │
│  ├───────────────────────────────────────────────────────────────┤  │
│  │  Success: bool                                                 │  │
│  │  Category: WeaponCategory                                      │  │
│  │  PsCost: int                                                   │  │
│  │  TrainingWeeks: int                                            │  │
│  │  TrainerId: string                                             │  │
│  │  OldLevel: WeaponProficiencyLevel                              │  │
│  │  NewLevel: WeaponProficiencyLevel                              │  │
│  │  FailureReason: string?                                        │  │
│  └───────────────────────────────────────────────────────────────┘  │
│                                                                      │
│  ┌────────────────────┐  ┌────────────────────┐                     │
│  │ AcquisitionMethod  │  │  AcquisitionCost   │                     │
│  │      (Enum)        │  │  (Value Object)    │                     │
│  ├────────────────────┤  ├────────────────────┤                     │
│  │ Archetype          │  │ ProgressionPoints  │                     │
│  │ Specialization     │  │ PiecesSilver       │                     │
│  │ NpcTraining        │  │ TrainingWeeks      │                     │
│  │ CombatExperience   │  └────────────────────┘                     │
│  │ PPPurchase         │                                              │
│  └────────────────────┘                                              │
└─────────────────────────────────────────────────────────────────────┘
```

---

## 4. IProficiencyAcquisitionService Interface

### 4.1 Purpose

The `IProficiencyAcquisitionService` interface defines all methods for acquiring and advancing weapon category proficiencies. It centralizes validation, cost management, and state updates.

### 4.2 Implementation

**File:** `src/Core/RuneAndRust.Application/Interfaces/IProficiencyAcquisitionService.cs`

```csharp
namespace RuneAndRust.Application.Interfaces;

using RuneAndRust.Domain.Entities;
using RuneAndRust.Domain.Enums;
using RuneAndRust.Domain.ValueObjects;

/// <summary>
/// Manages proficiency acquisition through all available methods.
/// </summary>
/// <remarks>
/// <para>
/// This service handles the five methods of acquiring proficiency:
/// 1. Archetype (character creation)
/// 2. Specialization (archetype advancement)
/// 3. NPC Training (PS cost + time)
/// 4. Combat Experience (free, time-based)
/// 5. Progression Point Purchase (2 PP per level)
/// </para>
/// </remarks>
public interface IProficiencyAcquisitionService
{
    /// <summary>
    /// Initializes character proficiencies from archetype matrix.
    /// </summary>
    /// <param name="character">The character to initialize.</param>
    /// <param name="archetypeId">The archetype identifier.</param>
    /// <returns>List of proficiencies granted.</returns>
    /// <remarks>
    /// Called during character creation. Grants Proficient level in all
    /// archetype categories, NonProficient in all others.
    /// </remarks>
    Task<IReadOnlyList<ProficiencyGainResult>> InitializeFromArchetypeAsync(
        Character character,
        string archetypeId,
        CancellationToken ct = default);

    /// <summary>
    /// Records combat experience and advances level if threshold reached.
    /// </summary>
    /// <param name="character">The character who used the weapon.</param>
    /// <param name="category">The weapon category used.</param>
    /// <returns>Gain result indicating if level advanced.</returns>
    /// <remarks>
    /// Called after each combat where the character used a weapon.
    /// Increments experience and automatically advances if threshold met.
    /// </remarks>
    Task<ProficiencyGainResult> RecordCombatExperienceAsync(
        Character character,
        WeaponCategory category,
        CancellationToken ct = default);

    /// <summary>
    /// Purchases proficiency advancement with Progression Points.
    /// </summary>
    /// <param name="character">The character spending PP.</param>
    /// <param name="category">The category to advance.</param>
    /// <returns>Gain result with success and cost paid.</returns>
    /// <remarks>
    /// Costs 2 PP per level advancement. Validates PP balance before advancing.
    /// Fails if already at Master level or insufficient PP.
    /// </remarks>
    Task<ProficiencyGainResult> PurchaseWithProgressionPointsAsync(
        Character character,
        WeaponCategory category,
        CancellationToken ct = default);

    /// <summary>
    /// Trains weapon proficiency with an NPC trainer.
    /// </summary>
    /// <param name="character">The character training.</param>
    /// <param name="category">The category to train.</param>
    /// <param name="trainerId">The NPC trainer identifier.</param>
    /// <returns>Training result with cost and time.</returns>
    /// <remarks>
    /// Cost and time vary by current level:
    /// - NonProficient → Proficient: 50 PS, 1 week
    /// - Proficient → Expert: 100 PS, 2 weeks
    /// - Expert → Master: 200 PS, 4 weeks
    /// </remarks>
    Task<TrainingResult> TrainWithNPCAsync(
        Character character,
        WeaponCategory category,
        string trainerId,
        CancellationToken ct = default);

    /// <summary>
    /// Grants proficiencies from archetype specialization.
    /// </summary>
    /// <param name="character">The character specializing.</param>
    /// <param name="categories">Categories granted by specialization.</param>
    /// <returns>List of proficiencies granted.</returns>
    /// <remarks>
    /// Called when character gains archetype specialization.
    /// Grants Proficient level in all specified categories.
    /// </remarks>
    Task<IReadOnlyList<ProficiencyGainResult>> GrantFromSpecializationAsync(
        Character character,
        IEnumerable<WeaponCategory> categories,
        CancellationToken ct = default);

    /// <summary>
    /// Gets the cost and time for NPC training at current level.
    /// </summary>
    /// <param name="character">The character.</param>
    /// <param name="category">The category to train.</param>
    /// <returns>Training cost and time information.</returns>
    Task<(int PsCost, int TrainingWeeks)> GetTrainingCostAsync(
        Character character,
        WeaponCategory category,
        CancellationToken ct = default);

    /// <summary>
    /// Checks if a character can afford PP purchase for a category.
    /// </summary>
    /// <param name="character">The character.</param>
    /// <param name="category">The category to check.</param>
    /// <returns>True if character has 2 PP and not at Master level.</returns>
    Task<bool> CanAffordPPPurchaseAsync(
        Character character,
        WeaponCategory category,
        CancellationToken ct = default);

    /// <summary>
    /// Checks if a character can afford NPC training for a category.
    /// </summary>
    /// <param name="character">The character.</param>
    /// <param name="category">The category to check.</param>
    /// <returns>True if character has sufficient PS and not at Master level.</returns>
    Task<bool> CanAffordTrainingAsync(
        Character character,
        WeaponCategory category,
        CancellationToken ct = default);
}
```

---

## 5. ProficiencyGainResult Value Object

### 5.1 Purpose

The `ProficiencyGainResult` value object represents the outcome of a proficiency acquisition attempt. It contains success status, level changes, method used, and costs paid.

### 5.2 Implementation

**File:** `src/Core/RuneAndRust.Domain/ValueObjects/ProficiencyGainResult.cs`

```csharp
namespace RuneAndRust.Domain.ValueObjects;

using RuneAndRust.Domain.Enums;

/// <summary>
/// Result of a proficiency acquisition attempt.
/// </summary>
/// <param name="Success">Whether the acquisition succeeded.</param>
/// <param name="Category">The weapon category affected.</param>
/// <param name="OldLevel">Proficiency level before acquisition.</param>
/// <param name="NewLevel">Proficiency level after acquisition.</param>
/// <param name="Method">The acquisition method used.</param>
/// <param name="CostPaid">Costs paid (PP, PS, weeks), null if free.</param>
/// <param name="FailureReason">Reason for failure, null if successful.</param>
public readonly record struct ProficiencyGainResult(
    bool Success,
    WeaponCategory Category,
    WeaponProficiencyLevel OldLevel,
    WeaponProficiencyLevel NewLevel,
    AcquisitionMethod Method,
    AcquisitionCost? CostPaid,
    string? FailureReason)
{
    /// <summary>
    /// Gets whether the proficiency level changed.
    /// </summary>
    public bool LevelChanged => OldLevel != NewLevel;

    /// <summary>
    /// Gets whether this was a free acquisition.
    /// </summary>
    public bool WasFree => CostPaid == null || CostPaid.Value.IsFree;

    /// <summary>
    /// Gets whether this was the final advancement to Master.
    /// </summary>
    public bool ReachedMaster => NewLevel == WeaponProficiencyLevel.Master;

    /// <summary>
    /// Creates a successful result.
    /// </summary>
    public static ProficiencyGainResult CreateSuccess(
        WeaponCategory category,
        WeaponProficiencyLevel oldLevel,
        WeaponProficiencyLevel newLevel,
        AcquisitionMethod method,
        AcquisitionCost? costPaid = null)
    {
        return new ProficiencyGainResult(
            Success: true,
            Category: category,
            OldLevel: oldLevel,
            NewLevel: newLevel,
            Method: method,
            CostPaid: costPaid,
            FailureReason: null);
    }

    /// <summary>
    /// Creates a failed result.
    /// </summary>
    public static ProficiencyGainResult CreateFailure(
        WeaponCategory category,
        WeaponProficiencyLevel currentLevel,
        AcquisitionMethod method,
        string failureReason)
    {
        ArgumentException.ThrowIfNullOrWhiteSpace(failureReason);

        return new ProficiencyGainResult(
            Success: false,
            Category: category,
            OldLevel: currentLevel,
            NewLevel: currentLevel,
            Method: method,
            CostPaid: null,
            FailureReason: failureReason);
    }

    /// <summary>
    /// Formats the result for display.
    /// </summary>
    public string FormatResult()
    {
        if (!Success)
        {
            return $"Failed: {FailureReason}";
        }

        if (!LevelChanged)
        {
            return $"{Category}: Already at {NewLevel}";
        }

        var costText = CostPaid.HasValue && !CostPaid.Value.IsFree
            ? $" (Cost: {CostPaid.Value})"
            : "";

        return $"{Category}: {OldLevel} → {NewLevel} via {Method}{costText}";
    }

    /// <summary>
    /// Creates a display string for debug/logging purposes.
    /// </summary>
    public override string ToString() => FormatResult();
}
```

### 5.3 Supporting Enums and Value Objects

**File:** `src/Core/RuneAndRust.Domain/Enums/AcquisitionMethod.cs`

```csharp
namespace RuneAndRust.Domain.Enums;

/// <summary>
/// Methods of acquiring weapon proficiency.
/// </summary>
public enum AcquisitionMethod
{
    /// <summary>
    /// Granted by character archetype at creation.
    /// </summary>
    Archetype = 0,

    /// <summary>
    /// Granted by archetype specialization.
    /// </summary>
    Specialization = 1,

    /// <summary>
    /// Trained by NPC for PS cost and time.
    /// </summary>
    NpcTraining = 2,

    /// <summary>
    /// Acquired through repeated combat usage.
    /// </summary>
    CombatExperience = 3,

    /// <summary>
    /// Purchased with Progression Points.
    /// </summary>
    ProgressionPointPurchase = 4
}
```

**File:** `src/Core/RuneAndRust.Domain/ValueObjects/AcquisitionCost.cs`

```csharp
namespace RuneAndRust.Domain.ValueObjects;

/// <summary>
/// Represents costs paid for proficiency acquisition.
/// </summary>
/// <param name="ProgressionPoints">PP spent (0 if none).</param>
/// <param name="PiecesSilver">PS spent (0 if none).</param>
/// <param name="TrainingWeeks">Weeks spent training (0 if none).</param>
public readonly record struct AcquisitionCost(
    int ProgressionPoints,
    int PiecesSilver,
    int TrainingWeeks)
{
    /// <summary>
    /// Gets whether this cost is free (no PP, PS, or time).
    /// </summary>
    public bool IsFree => ProgressionPoints == 0 && PiecesSilver == 0 && TrainingWeeks == 0;

    /// <summary>
    /// Gets whether PP was spent.
    /// </summary>
    public bool SpentPP => ProgressionPoints > 0;

    /// <summary>
    /// Gets whether PS was spent.
    /// </summary>
    public bool SpentPS => PiecesSilver > 0;

    /// <summary>
    /// Gets whether time was spent.
    /// </summary>
    public bool SpentTime => TrainingWeeks > 0;

    /// <summary>
    /// Creates an acquisition cost from PP purchase.
    /// </summary>
    public static AcquisitionCost FromPP(int ppAmount) =>
        new(ProgressionPoints: ppAmount, PiecesSilver: 0, TrainingWeeks: 0);

    /// <summary>
    /// Creates an acquisition cost from NPC training.
    /// </summary>
    public static AcquisitionCost FromTraining(int psCost, int weeks) =>
        new(ProgressionPoints: 0, PiecesSilver: psCost, TrainingWeeks: weeks);

    /// <summary>
    /// Represents no cost (free).
    /// </summary>
    public static AcquisitionCost None =>
        new(ProgressionPoints: 0, PiecesSilver: 0, TrainingWeeks: 0);

    /// <summary>
    /// Formats the cost for display.
    /// </summary>
    public override string ToString()
    {
        if (IsFree) return "Free";

        var costs = new List<string>();
        if (SpentPP) costs.Add($"{ProgressionPoints} PP");
        if (SpentPS) costs.Add($"{PiecesSilver} PS");
        if (SpentTime) costs.Add($"{TrainingWeeks} week{(TrainingWeeks > 1 ? "s" : "")}");

        return string.Join(", ", costs);
    }
}
```

---

## 6. TrainingResult Value Object

### 6.1 Purpose

The `TrainingResult` value object represents the outcome of NPC training attempts, including cost, time, and trainer information.

### 6.2 Implementation

**File:** `src/Core/RuneAndRust.Domain/ValueObjects/TrainingResult.cs`

```csharp
namespace RuneAndRust.Domain.ValueObjects;

using RuneAndRust.Domain.Enums;

/// <summary>
/// Result of an NPC training attempt.
/// </summary>
/// <param name="Success">Whether training succeeded.</param>
/// <param name="Category">The weapon category trained.</param>
/// <param name="PsCost">Pieces of silver cost.</param>
/// <param name="TrainingWeeks">Training duration in weeks.</param>
/// <param name="TrainerId">The NPC trainer identifier.</param>
/// <param name="OldLevel">Proficiency level before training.</param>
/// <param name="NewLevel">Proficiency level after training.</param>
/// <param name="FailureReason">Reason for failure, null if successful.</param>
public readonly record struct TrainingResult(
    bool Success,
    WeaponCategory Category,
    int PsCost,
    int TrainingWeeks,
    string TrainerId,
    WeaponProficiencyLevel OldLevel,
    WeaponProficiencyLevel NewLevel,
    string? FailureReason)
{
    /// <summary>
    /// Gets whether the proficiency level changed.
    /// </summary>
    public bool LevelChanged => OldLevel != NewLevel;

    /// <summary>
    /// Gets the total cost as an AcquisitionCost.
    /// </summary>
    public AcquisitionCost TotalCost =>
        AcquisitionCost.FromTraining(PsCost, TrainingWeeks);

    /// <summary>
    /// Creates a successful training result.
    /// </summary>
    public static TrainingResult CreateSuccess(
        WeaponCategory category,
        int psCost,
        int trainingWeeks,
        string trainerId,
        WeaponProficiencyLevel oldLevel,
        WeaponProficiencyLevel newLevel)
    {
        ArgumentException.ThrowIfNullOrWhiteSpace(trainerId);
        ArgumentOutOfRangeException.ThrowIfNegativeOrZero(psCost);
        ArgumentOutOfRangeException.ThrowIfNegativeOrZero(trainingWeeks);

        return new TrainingResult(
            Success: true,
            Category: category,
            PsCost: psCost,
            TrainingWeeks: trainingWeeks,
            TrainerId: trainerId,
            OldLevel: oldLevel,
            NewLevel: newLevel,
            FailureReason: null);
    }

    /// <summary>
    /// Creates a failed training result.
    /// </summary>
    public static TrainingResult CreateFailure(
        WeaponCategory category,
        WeaponProficiencyLevel currentLevel,
        string trainerId,
        string failureReason)
    {
        ArgumentException.ThrowIfNullOrWhiteSpace(trainerId);
        ArgumentException.ThrowIfNullOrWhiteSpace(failureReason);

        return new TrainingResult(
            Success: false,
            Category: category,
            PsCost: 0,
            TrainingWeeks: 0,
            TrainerId: trainerId,
            OldLevel: currentLevel,
            NewLevel: currentLevel,
            FailureReason: failureReason);
    }

    /// <summary>
    /// Formats the result for display.
    /// </summary>
    public string FormatResult()
    {
        if (!Success)
        {
            return $"Training failed: {FailureReason}";
        }

        return $"{Category} training complete: {OldLevel} → {NewLevel} " +
               $"(Trainer: {TrainerId}, Cost: {PsCost} PS, Time: {TrainingWeeks} week" +
               $"{(TrainingWeeks > 1 ? "s" : "")})";
    }

    /// <summary>
    /// Creates a display string for debug/logging purposes.
    /// </summary>
    public override string ToString() => FormatResult();
}
```

---

## 7. Data Model Changes

### 7.1 New Types Summary

| Type                             | Layer       | Category     | Description                     |
| -------------------------------- | ----------- | ------------ | ------------------------------- |
| `IProficiencyAcquisitionService` | Application | Interface    | Proficiency acquisition methods |
| `ProficiencyGainResult`          | Domain      | Value Object | Acquisition outcome             |
| `TrainingResult`                 | Domain      | Value Object | NPC training outcome            |
| `AcquisitionMethod`              | Domain      | Enum         | Method of acquisition           |
| `AcquisitionCost`                | Domain      | Value Object | Costs paid for acquisition      |

### 7.2 File Locations

```
src/Core/RuneAndRust.Application/
└── Interfaces/
    └── IProficiencyAcquisitionService.cs    ← NEW

src/Core/RuneAndRust.Domain/
├── Enums/
│   └── AcquisitionMethod.cs                 ← NEW
└── ValueObjects/
    ├── ProficiencyGainResult.cs             ← NEW
    ├── TrainingResult.cs                    ← NEW
    └── AcquisitionCost.cs                   ← NEW

config/
├── proficiency-acquisition.json             ← NEW
└── schemas/
    └── proficiency-acquisition.schema.json  ← NEW
```

---

## 8. Configuration File Schemas

### 8.1 proficiency-acquisition.json

**File:** `config/proficiency-acquisition.json`

```json
{
    "$schema": "./schemas/proficiency-acquisition.schema.json",
    "acquisitionMethods": {
        "ppPurchase": {
            "enabled": true,
            "costPerLevel": 2,
            "description": "Purchase proficiency advancement with Progression Points"
        },
        "npcTraining": {
            "enabled": true,
            "costs": [
                {
                    "transitionFrom": "NonProficient",
                    "transitionTo": "Proficient",
                    "psCost": 50,
                    "trainingWeeks": 1
                },
                {
                    "transitionFrom": "Proficient",
                    "transitionTo": "Expert",
                    "psCost": 100,
                    "trainingWeeks": 2
                },
                {
                    "transitionFrom": "Expert",
                    "transitionTo": "Master",
                    "psCost": 200,
                    "trainingWeeks": 4
                }
            ]
        },
        "combatExperience": {
            "enabled": true,
            "note": "Thresholds defined in proficiency-thresholds.json"
        },
        "archetype": {
            "enabled": true,
            "note": "Based on archetype-proficiencies.json"
        },
        "specialization": {
            "enabled": false,
            "note": "Not yet implemented"
        }
    }
}
```

### 8.2 proficiency-acquisition.schema.json

**File:** `config/schemas/proficiency-acquisition.schema.json`

```json
{
    "$schema": "http://json-schema.org/draft-07/schema#",
    "$id": "proficiency-acquisition.schema.json",
    "title": "Proficiency Acquisition Configuration",
    "description": "Defines costs and availability for proficiency acquisition methods",
    "type": "object",
    "required": ["acquisitionMethods"],
    "properties": {
        "$schema": { "type": "string" },
        "acquisitionMethods": {
            "type": "object",
            "required": [
                "ppPurchase",
                "npcTraining",
                "combatExperience",
                "archetype"
            ],
            "properties": {
                "ppPurchase": {
                    "type": "object",
                    "required": ["enabled", "costPerLevel"],
                    "properties": {
                        "enabled": { "type": "boolean" },
                        "costPerLevel": {
                            "type": "integer",
                            "minimum": 1,
                            "maximum": 10
                        },
                        "description": { "type": "string" }
                    }
                },
                "npcTraining": {
                    "type": "object",
                    "required": ["enabled", "costs"],
                    "properties": {
                        "enabled": { "type": "boolean" },
                        "costs": {
                            "type": "array",
                            "minItems": 3,
                            "maxItems": 3,
                            "items": { "$ref": "#/$defs/trainingCost" }
                        }
                    }
                },
                "combatExperience": {
                    "type": "object",
                    "required": ["enabled"],
                    "properties": {
                        "enabled": { "type": "boolean" },
                        "note": { "type": "string" }
                    }
                },
                "archetype": {
                    "type": "object",
                    "required": ["enabled"],
                    "properties": {
                        "enabled": { "type": "boolean" },
                        "note": { "type": "string" }
                    }
                },
                "specialization": {
                    "type": "object",
                    "required": ["enabled"],
                    "properties": {
                        "enabled": { "type": "boolean" },
                        "note": { "type": "string" }
                    }
                }
            }
        }
    },
    "$defs": {
        "trainingCost": {
            "type": "object",
            "required": [
                "transitionFrom",
                "transitionTo",
                "psCost",
                "trainingWeeks"
            ],
            "properties": {
                "transitionFrom": {
                    "type": "string",
                    "enum": ["NonProficient", "Proficient", "Expert"]
                },
                "transitionTo": {
                    "type": "string",
                    "enum": ["Proficient", "Expert", "Master"]
                },
                "psCost": { "type": "integer", "minimum": 1, "maximum": 1000 },
                "trainingWeeks": {
                    "type": "integer",
                    "minimum": 1,
                    "maximum": 52
                }
            }
        }
    }
}
```

---

## 9. Logging Specifications

### 9.1 Log Levels by Component

| Component                       | Level       | Events                                      |
| ------------------------------- | ----------- | ------------------------------------------- |
| `ProficiencyAcquisitionService` | Information | Level advancement, archetype initialization |
| `ProficiencyAcquisitionService` | Debug       | Experience increments, validation checks    |
| `ProficiencyAcquisitionService` | Warning     | Insufficient PP/PS, already at max level    |
| `ProficiencyAcquisitionService` | Error       | Invalid acquisition attempts, state errors  |

### 9.2 Structured Logging Templates

```csharp
// Information - Proficiency gained
_logger.LogInformation(
    "Proficiency advanced. CharacterId={CharacterId}, Category={Category}, " +
    "OldLevel={OldLevel}, NewLevel={NewLevel}, Method={Method}, Cost={Cost}",
    character.Id,
    category,
    oldLevel,
    newLevel,
    method,
    cost);

// Information - Archetype initialization
_logger.LogInformation(
    "Character proficiencies initialized from archetype. CharacterId={CharacterId}, " +
    "ArchetypeId={ArchetypeId}, ProficienciesGranted={Count}",
    character.Id,
    archetypeId,
    grantedCount);

// Debug - Combat experience added
_logger.LogDebug(
    "Combat experience recorded. CharacterId={CharacterId}, Category={Category}, " +
    "NewExperience={NewExp}, ThresholdReached={ThresholdReached}",
    character.Id,
    category,
    newExperience,
    thresholdReached);

// Warning - Insufficient resources
_logger.LogWarning(
    "Proficiency purchase failed: insufficient resources. CharacterId={CharacterId}, " +
    "Category={Category}, Method={Method}, Required={Required}, Available={Available}",
    character.Id,
    category,
    method,
    required,
    available);

// Error - Invalid advancement
_logger.LogError(
    "Invalid proficiency advancement attempt. CharacterId={CharacterId}, " +
    "Category={Category}, CurrentLevel={CurrentLevel}, Reason={Reason}",
    character.Id,
    category,
    currentLevel,
    reason);
```

---

## 10. Unit Testing Requirements

### 10.1 Test Count by Feature

| Feature                                | Test Count |
| -------------------------------------- | ---------- |
| IProficiencyAcquisitionService methods | ~2         |
| ProficiencyGainResult value object     | ~1         |
| TrainingResult value object            | ~1         |
| **Total**                              | **~4**     |

### 10.2 Test Specifications

**File:** `tests/RuneAndRust.Application.UnitTests/Services/ProficiencyAcquisitionServiceTests.cs`

```csharp
[TestFixture]
public class ProficiencyAcquisitionServiceTests
{
    [Test]
    public async Task InitializeFromArchetype_ForWarrior_GrantsAll11Proficiencies();

    [Test]
    public async Task InitializeFromArchetype_ForMystic_Grants3Proficiencies();

    [Test]
    public async Task RecordCombatExperience_At24Of25_AdvancesToExpert();

    [Test]
    public async Task RecordCombatExperience_At9Of10_DoesNotAdvanceYet();

    [Test]
    public async Task RecordCombatExperience_AtMasterLevel_ReturnsNoChange();

    [Test]
    public async Task PurchaseWithProgressionPoints_WithSufficientPP_AdvancesLevel();

    [Test]
    public async Task PurchaseWithProgressionPoints_WithInsufficientPP_ReturnsFailed();

    [Test]
    public async Task PurchaseWithProgressionPoints_AtMasterLevel_ReturnsFailed();

    [Test]
    public async Task TrainWithNPC_FromNonProficient_Costs50PS1Week();

    [Test]
    public async Task TrainWithNPC_FromProficient_Costs100PS2Weeks();

    [Test]
    public async Task TrainWithNPC_FromExpert_Costs200PS4Weeks();

    [Test]
    public async Task TrainWithNPC_InsufficientPS_ReturnsFailed();

    [Test]
    public async Task GrantFromSpecialization_GrantsMultipleCategories();

    [Test]
    public async Task GetTrainingCost_ReturnsCorrectCostForLevel();

    [Test]
    public async Task CanAffordPPPurchase_With2PP_ReturnsTrue();

    [Test]
    public async Task CanAffordPPPurchase_With1PP_ReturnsFalse();
}
```

**File:** `tests/RuneAndRust.Domain.UnitTests/ValueObjects/ProficiencyGainResultTests.cs`

```csharp
[TestFixture]
public class ProficiencyGainResultTests
{
    [Test]
    public void CreateSuccess_WithLevelChange_SetsPropertiesCorrectly();

    [Test]
    public void CreateSuccess_WithoutCost_WasFreReturnsTrue();

    [Test]
    public void CreateFailure_SetSuccessToFalseAndKeepsSameLevel();

    [Test]
    public void LevelChanged_WhenOldDiffersFromNew_ReturnsTrue();

    [Test]
    public void ReachedMaster_WhenNewLevelIsMaster_ReturnsTrue();

    [Test]
    public void FormatResult_ReturnsReadableString();
}
```

---

## 11. Use Cases

### UC-001: Initialize Character Proficiencies

**Actor:** Character Creation Service  
**Flow:** Create character → Select archetype → Call `InitializeFromArchetypeAsync()` → Archetype proficiencies granted → Store in character

### UC-002: Award Combat Experience

**Actor:** Combat Service (v0.16.1f)  
**Flow:** Combat ends → Get weapon category used → Call `RecordCombatExperienceAsync()` → Increment experience → Auto-advance if threshold met → Return result

### UC-003: Purchase Proficiency with PP

**Actor:** Character Advancement UI  
**Flow:** Player selects category → Check `CanAffordPPPurchaseAsync()` → Call `PurchaseWithProgressionPointsAsync()` → Deduct 2 PP → Advance level → Display result

### UC-004: Train with NPC

**Actor:** NPC Interaction Service  
**Flow:** Player talks to trainer → Get training cost with `GetTrainingCostAsync()` → Player confirms → Call `TrainWithNPCAsync()` → Deduct PS → Mark time passage → Advance level

---

## 12. Deliverable Checklist

### Application Layer

- [ ] `IProficiencyAcquisitionService.cs` interface created
- [ ] Interface has complete XML documentation

### Domain Layer

- [ ] `ProficiencyGainResult.cs` value object created
- [ ] `TrainingResult.cs` value object created
- [ ] `AcquisitionMethod.cs` enum created
- [ ] `AcquisitionCost.cs` value object created

### Configuration Files

- [ ] `config/proficiency-acquisition.json` created
- [ ] `config/schemas/proficiency-acquisition.schema.json` created

### Testing

- [ ] `ProficiencyAcquisitionServiceTests.cs` created
- [ ] `ProficiencyGainResultTests.cs` created
- [ ] ~4 unit tests passing

### Documentation

- [ ] `v0.16.1e-changelog.md` created

---

## 13. Acceptance Criteria

### Functional

- [ ] `InitializeFromArchetypeAsync()` grants correct proficiencies for each archetype
- [ ] Warrior initialization grants Proficient in all 11 categories
- [ ] Mystic initialization grants Proficient in 3 categories
- [ ] `RecordCombatExperienceAsync()` increments experience by 1
- [ ] Combat experience auto-advances when threshold reached (10/25/50)
- [ ] Combat experience returns no-change result when at Master
- [ ] `PurchaseWithProgressionPointsAsync()` costs exactly 2 PP
- [ ] PP purchase fails when character has < 2 PP
- [ ] PP purchase fails when already at Master level
- [ ] `TrainWithNPCAsync()` charges correct cost per level (50/100/200 PS)
- [ ] NPC training takes correct time per level (1/2/4 weeks)
- [ ] Training fails when insufficient PS
- [ ] `GrantFromSpecializationAsync()` grants multiple categories at once
- [ ] All results include success status and descriptive failure reasons

### Quality

- [ ] Build succeeds with 0 errors
- [ ] Build succeeds with 0 warnings
- [ ] ~4 unit tests pass
- [ ] Configuration validates against JSON schema
- [ ] All public types have XML documentation

---

## 14. Dependencies

### Required from v0.16.1a

| Type                         | Usage                         |
| ---------------------------- | ----------------------------- |
| `WeaponProficiencyLevel`     | Used in gain results          |
| `IProficiencyEffectProvider` | Referenced for effect lookups |

### Required from v0.16.1b

| Type             | Usage                             |
| ---------------- | --------------------------------- |
| `WeaponCategory` | Parameter for all service methods |

### Required from v0.16.1c

| Type                            | Usage                             |
| ------------------------------- | --------------------------------- |
| `IArchetypeProficiencyProvider` | Used to initialize from archetype |

### Required from v0.16.1d

| Type                     | Usage                               |
| ------------------------ | ----------------------------------- |
| `CharacterProficiencies` | Updated by acquisition service      |
| `ProficiencyProgress`    | Queried and advanced                |
| `ProficiencyThresholds`  | Used for combat experience tracking |

### Provides to v0.16.1f

| Type                             | Usage                                        |
| -------------------------------- | -------------------------------------------- |
| `IProficiencyAcquisitionService` | Combat calls `RecordCombatExperienceAsync()` |
| `ProficiencyGainResult`          | Combat displays advancement messages         |

---

## 15. Future Considerations

### Deferred to v0.16.1f

- **Combat integration**: Automatic experience awarding after each combat
- **Attack/damage modifier application**: Using proficiency effects in combat calculations

### Deferred to Future Versions

- **Specialization system**: Archetype specializations that grant bonus proficiencies
- **NPC trainer entities**: Full trainer system with locations and availability
- **Training interruption**: Ability to cancel training early
- **Group training discounts**: Reduced costs when training with party members
- **Proficiency decay**: Optional system for unused proficiencies degrading over time (very unlikely)

### Out of Scope

- **Retroactive experience**: Cannot backfill experience for weapons used before proficiency system
- **Experience transfer**: Cannot transfer exp from one category to another
- **Partial PP purchases**: Must spend full 2 PP, cannot save partial progress

---

_Document Version: 1.0_  
_Last Updated: 2026-01-27_  
_Author: AI Assistant_
