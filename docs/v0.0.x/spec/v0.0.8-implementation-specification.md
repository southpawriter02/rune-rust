# v0.0.8 Implementation Specification: Experience & Leveling

**Version:** 0.0.8
**Implementation Date:** 2026-01-08
**Design Specification:** [v0.0.8-scope-breakdown.md](../v0.0.8-scope-breakdown.md)
**Changelogs:** [v0.0.8a](../../changelogs/v0.0.8a-changelog.md), [v0.0.8b](../../changelogs/v0.0.8b-changelog.md), [v0.0.8c](../../changelogs/v0.0.8c-changelog.md)

---

## 1. Overview

### 1.1 Summary

v0.0.8 implements a complete experience and leveling system. Players earn XP from defeating monsters, track progress toward the next level, and gain stat increases when leveling up. The system is fully configurable via JSON, supporting custom XP curves, terminology, milestone titles, and custom rewards.

### 1.2 Key Features

- **XP Tracking**: Earn XP from monster defeats
- **Level Progression**: Configurable XP thresholds
- **Stat Gains**: Class-based stat increases per level
- **Milestone Titles**: Special titles at key levels
- **Custom Rewards**: Level-specific unlocks
- **Configurable Curves**: Linear, Exponential, or Custom
- **Terminology**: Customizable XP/Level naming

### 1.3 Deviations from Design

None significant; implementation matches design specification.

---

## 2. Architecture

### 2.1 Layer Interactions

```
┌─────────────────────────────────────────────────────────────┐
│                    Presentation Layer                        │
│  GameView → XP display, level up celebration                │
│  SpectreGameRenderer → RenderExperienceGain, RenderLevelUp  │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                    Application Layer                         │
│  GameSessionService → AwardXP, ProcessLevelUp               │
│  ExperienceGainDto, LevelUpDto with terminology             │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                      Domain Layer                            │
│  ProgressionDefinition, LevelDefinition                     │
│  ProgressionService, Player.Experience                      │
│  ProgressionCurve enum                                      │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                   Infrastructure Layer                       │
│  JsonConfigurationProvider → progression.json               │
│  GetProgressionConfiguration()                              │
└─────────────────────────────────────────────────────────────┘
```

### 2.2 Key Patterns

- **Configuration Pattern**: Data-driven progression via JSON
- **Factory Pattern**: ProgressionDefinition with curve calculations
- **Observer Pattern**: Level-up triggers stat recalculation
- **Strategy Pattern**: Different XP curve implementations

### 2.3 Dependencies

- v0.0.4: Class growth rates for stat gains
- Monster definitions: Base XP values

---

## 3. Data Model

### 3.1 Definitions

| Definition | Key Properties |
|------------|----------------|
| `ProgressionDefinition` | CurveType, BaseXpRequirement, XpMultiplier, MaxLevel, DefaultStatBonuses, LevelOverrides |
| `LevelDefinition` | Level, XpRequired, StatBonuses, CustomRewards, Title |
| `StatBonusConfig` | MaxHealth, Attack, Defense |

### 3.2 Enums

| Enum | Values |
|------|--------|
| `ProgressionCurve` | Linear, Exponential, Custom |

### 3.3 ProgressionDefinition Methods

```csharp
GetExperienceForLevel(int level) → int
GetLevelForExperience(int totalXp) → int
GetStatBonusesForLevel(int level, GrowthRates? classRates = null) → StatModifiers
GetCustomRewardsForLevel(int level) → IReadOnlyList<string>
GetTitleForLevel(int level) → string?
```

---

## 4. Services

### 4.1 ProgressionService

```csharp
// Level Calculations
CheckForLevelUp(player, classGrowthRates) → LevelUpResult?
GetStatIncreasesForLevels(from, to, classGrowthRates) → StatModifiers
GetExperienceForNextLevel(currentLevel) → int
GetExperienceUntilNextLevel(player) → int
GetCustomRewardsForLevel(level) → IReadOnlyList<string>
GetTitleForLevel(level) → string?
```

### 4.2 GameSessionService

```csharp
// XP Integration
AwardExperience(player, amount) → ExperienceGainDto
ProcessCombatVictory(monsters) → (xp, levelUp?)
```

### 4.3 Player Extensions

```csharp
Experience { get; set; }
Level { get; set; }
GetExperienceToNextLevel(ProgressionDefinition?) → int
```

---

## 5. Configuration

### 5.1 JSON Structure

```json
{
  "experienceTerminology": "XP",
  "levelTerminology": "Level",
  "maxLevel": 20,
  "curveType": "Linear",
  "baseXpRequirement": 100,
  "xpMultiplier": 1.5,
  "healOnLevelUp": true,
  "defaultStatBonuses": {
    "maxHealth": 5,
    "attack": 1,
    "defense": 1
  },
  "levels": [
    {
      "level": 5,
      "title": "Veteran",
      "customRewards": ["Unlock: Advanced Training"]
    },
    {
      "level": 10,
      "title": "Elite",
      "customRewards": ["Unlock: Elite Skills", "Bonus: +10 Max HP"]
    }
  ]
}
```

### 5.2 XP Curve Formulas

| Curve | Formula | Example (Base 100) |
|-------|---------|-------------------|
| Linear | Level × BaseXP | L2=200, L3=300 |
| Exponential | Cumulative × Multiplier | L2=100, L3=250 |
| Custom | Per-level overrides | As specified |

### 5.3 Terminology Examples

| Setting | UI Display |
|---------|------------|
| "XP" / "Level" | "You gained 25 XP! Level 5 reached!" |
| "Glory" / "Rank" | "You gained 25 Glory! Rank 5 reached!" |

---

## 6. Commands & Rendering

### 6.1 Display Elements

- XP bar in player status
- XP gain messages after combat
- Level-up celebration panel
- Milestone titles and rewards

### 6.2 Level-Up Display

```
╔══════════════════════════════════════════╗
║           ★ LEVEL UP! ★                  ║
╠══════════════════════════════════════════╣
║         ★ Veteran ★                      ║
║                                          ║
║ You have reached Level 5!                ║
║                                          ║
║ Stat Increases:                          ║
║   Max Health: 120 → 125 (+5)             ║
║   Attack: 14 → 15 (+1)                   ║
║   Defense: 9 → 10 (+1)                   ║
║                                          ║
║ Rewards:                                 ║
║   • Unlock: Advanced Training            ║
║                                          ║
║ Next Level: 600 XP needed (Level 6)      ║
╚══════════════════════════════════════════╝
```

---

## 7. Use Cases

### 7.1 Primary Use Cases

- [UC-010: Level Up](../../use-cases/player/UC-010-level-up.md)
- [UC-109: Award Experience](../../use-cases/system/UC-109-award-experience.md)

### 7.2 Edge Cases

- Multiple level-ups from single XP award
- Max level reached
- Custom rewards at non-milestone levels
- Missing progression.json (defaults used)

---

## 8. Testing

### 8.1 Test Coverage

| Phase | Tests | Areas |
|-------|-------|-------|
| v0.0.8a | ~25 | XP tracking, monster XP values |
| v0.0.8b | ~30 | Level detection, stat increases |
| v0.0.8c | 40 | Progression configuration |
| **Total** | **619** | +137 from v0.0.7 |

### 8.2 Key Test Scenarios

- Linear curve XP calculations
- Exponential curve calculations
- Custom level overrides
- Multi-level-up processing
- Terminology substitution
- Class growth rate integration
- Max level capping

---

## 9. Known Limitations

### 9.1 Current Limitations

- No prestige/rebirth system
- No XP bonuses from equipment
- No party XP sharing
- No XP loss on death

### 9.2 Future Improvements

- XP multipliers from consumables
- Rest bonus XP
- Achievement-based XP bonuses

---

## 10. Related Documentation

- **ADRs**: [ADR-002](../../architecture/ADR-002-json-configuration.md) (progression config)
- **Use Cases**: UC-010, UC-109
- **Integration**: v0.0.4 (class growth rates), Monster definitions (XP values)
