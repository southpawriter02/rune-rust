# v0.18.4e Changelog — Resource Service Implementations & Test Fixes

**Release Date:** 2026-02-02  
**Version:** 0.18.4e

## Summary

Implements the concrete **Application Layer Services** for the three Specialization resource systems and fixes all associated unit tests. This completes the v0.18.4 service layer with `RageService`, `MomentumService`, and `CoherenceService`.

---

## Added

### Application Layer — Services

- **RageService.cs** — Berserker rage management service:
    - 8 interface methods implemented (query + command)
    - Threshold-based bonus calculations (damage, soak)
    - Rage gain/decay with threshold transition tracking
    - Special effects: fear immunity, forced targeting, party stress reduction

- **MomentumService.cs** — Storm Blade momentum management service:
    - 10 interface methods implemented (query + command)
    - Chain hit tracking with consecutive hit bonuses
    - Momentum gain/decay with chain break detection
    - Bonus attack calculations at higher thresholds

- **CoherenceService.cs** — Arcanist coherence management service:
    - 9 interface methods implemented (query + command)
    - Cascade risk checks with 1d100 dice integration
    - Apotheosis state management with stress cost application
    - Meditation recovery mechanics

### Tests

- **RageServiceTests.cs** — 30+ tests covering:
    - Constructor validation
    - Rage state retrieval
    - Gain/decay with result object assertions
    - Threshold-based bonus calculations
    - Special state flags

- **MomentumServiceTests.cs** — 35+ tests covering:
    - Constructor validation
    - Momentum state retrieval
    - Gain/decay/reset with result object assertions
    - Hit/miss chain tracking
    - Bonus calculations by threshold

- **CoherenceServiceTests.cs** — 35+ tests covering:
    - Constructor validation
    - Coherence state retrieval
    - Gain/lose coherence (bool returns)
    - Cascade check mechanics
    - Apotheosis updates and meditation
    - Spell power and critical cast bonuses

---

## Fixed

### Test Corrections

| Issue                                 | Resolution                                                           |
| ------------------------------------- | -------------------------------------------------------------------- |
| `SaveResult.Success()` method call    | Changed to `SaveResult.Succeeded(id)` factory method                 |
| Bool assertions on result objects     | Changed to `RageGainResult`/`MomentumGainResult` property assertions |
| `IDiceService.RollTotal` 4-param mock | Changed to `RollTotal(string)` signature                             |
| `GetCriticalCastBonus` method         | Changed to `GetCriticalCastChance`                                   |
| Flowing threshold bonus attacks       | Changed expectation from 0 to 1                                      |
| Threshold crossing test               | Adjusted initial rage to boundary value (20)                         |

---

## Verification

```
dotnet build → 0 errors, 0 warnings
dotnet test (service tests) → 126/126 passed
```

---

## Files Added/Modified

| Path                                                            | Description                      |
| --------------------------------------------------------------- | -------------------------------- |
| `src/Core/RuneAndRust.Application/Services/RageService.cs`      | Rage service implementation      |
| `src/Core/RuneAndRust.Application/Services/MomentumService.cs`  | Momentum service implementation  |
| `src/Core/RuneAndRust.Application/Services/CoherenceService.cs` | Coherence service implementation |
| `tests/.../Services/RageServiceTests.cs`                        | Rage service unit tests          |
| `tests/.../Services/MomentumServiceTests.cs`                    | Momentum service unit tests      |
| `tests/.../Services/CoherenceServiceTests.cs`                   | Coherence service unit tests     |

---

## Dependencies

- **Prerequisites:** v0.18.4a-d (Domain entities, value objects, service interfaces)
- **Next Phase:** v0.18.5 (DI registration and integration)
