## v0.16.0 - Quality Tier System

**Focus:** Five-tier quality system with stat scaling and drop probability tables

**Source Specification:** [loot-generation.md](../../aethelgard/design/04-systems/loot-generation.md)

### Overview

This version establishes the foundational quality tier system that all equipment uses. Items are classified into five tiers from Jury-Rigged (trash) to Myth-Forged (legendary), with each tier providing progressively better stats. Drop tables determine which tiers enemies can drop based on their classification.

---

### Deliverables Summary

| Category | Items | Estimated Tests |
|----------|-------|-----------------|
| Enums | 2 | 3 |
| Value Objects | 4 | 6 |
| Entities | 1 | 2 |
| Services | 2 | 4 |
| **Total** | **9** | **~15** |

---

### v0.16.0a - Quality Tier Enum

#### QualityTier Enum
```
QualityTier
├── JuryRigged (0) - Trash/Starter gear
├── Scavenged (1) - Standard equipment
├── ClanForged (2) - Enhanced quality
├── Optimized (3) - Superior craftsmanship
├── MythForged (4) - Legendary artifacts
```

#### TierMetadata Value Object
```
TierMetadata
├── Tier: QualityTier
├── DisplayName: string
├── ColorHex: string
├── ColorName: string
├── DropRarity: string (Common, Uncommon, Rare, Epic, Legendary)
```

**Color Coding:**
| Tier | Color | Hex | Rarity |
|------|-------|-----|--------|
| JuryRigged | Gray | #808080 | Common |
| Scavenged | White | #FFFFFF | Common |
| ClanForged | Green | #00FF00 | Uncommon |
| Optimized | Purple | #800080 | Rare |
| MythForged | Gold | #FFD700 | Legendary |

**Configuration (`quality-tiers.json`):**
```json
{
  "tiers": [
    {
      "tier": 0,
      "name": "Jury-Rigged",
      "colorHex": "#808080",
      "colorName": "Gray",
      "rarity": "Common",
      "dropWeight": 100
    },
    {
      "tier": 4,
      "name": "Myth-Forged",
      "colorHex": "#FFD700",
      "colorName": "Gold",
      "rarity": "Legendary",
      "dropWeight": 5
    }
  ]
}
```

**Unit Tests (~3):**
- [ ] QualityTier enum has 5 values
- [ ] TierMetadata maps correctly from config
- [ ] Color hex values are valid

---

### v0.16.0b - Stat Scaling System

#### WeaponTierScaling Value Object
```
WeaponTierScaling
├── Tier: QualityTier
├── DamageDice: string (e.g., "1d6", "2d6+4")
├── AccuracyModifier: int
├── AttributeBonus: int?
├── BonusAttribute: string? (MIGHT, FINESSE, etc.)
```

#### ArmorTierScaling Value Object
```
ArmorTierScaling
├── Tier: QualityTier
├── HpBonus: int
├── DefenseBonus: int
├── AttributeBonus: int?
├── BonusAttribute: string?
├── PenaltyReduction: int (for Expert/Master proficiency)
```

**Weapon Scaling Table:**
| Tier | Damage | Accuracy | Attr Bonus |
|------|--------|----------|------------|
| 0 | 1d6 | -1 | None |
| 1 | 1d6+1 | 0 | None |
| 2 | 1d6+3 | 0 | +1 |
| 3 | 2d6 | +1 | +1 to +2 |
| 4 | 2d6+4 | +2 | +2 to +4 |

**Armor Scaling Table:**
| Tier | HP | Defense | Attr Bonus |
|------|-----|---------|------------|
| 0 | +5 | +1 | None |
| 1 | +10 | +1 | None |
| 2 | +15 | +2 | +1 |
| 3 | +20 | +2 | +1 to +2 |
| 4 | +30 | +3 | +2 to +4 |

#### ITierScalingService Interface
```csharp
public interface ITierScalingService
{
    /// <summary>
    /// Gets weapon stats for a quality tier.
    /// </summary>
    WeaponTierScaling GetWeaponScaling(QualityTier tier);

    /// <summary>
    /// Gets armor stats for a quality tier.
    /// </summary>
    ArmorTierScaling GetArmorScaling(QualityTier tier);

    /// <summary>
    /// Calculates attribute bonus (rolls range for Tier 3-4).
    /// </summary>
    int RollAttributeBonus(QualityTier tier, Random rng);
}
```

**Attribute Bonus Rolling:**
```
Tier 0-1: No bonus (return 0)
Tier 2: Always +1
Tier 3: Roll 1d2 → +1 or +2
Tier 4: Roll 1d3 → +2, +3, or +4
```

**Unit Tests (~3):**
- [ ] Weapon scaling matches tier correctly
- [ ] Armor scaling matches tier correctly
- [ ] Attribute bonus rolling within expected range

---

### v0.16.0c - Drop Probability Tables

#### EnemyDropClass Enum
```
EnemyDropClass
├── Trash (Servitor) - Low tier drops
├── Standard (Drone) - Mid tier drops
├── Elite (Warden) - Higher tier drops
├── Boss - Guaranteed high tier
├── MiniBoss - Between Elite and Boss
```

#### DropProbabilityEntry Value Object
```
DropProbabilityEntry
├── EnemyClass: EnemyDropClass
├── TierProbabilities: Dictionary<QualityTier, float>
├── NoDropChance: float
```

**Probability Matrix:**
| Enemy Class | T0 | T1 | T2 | T3 | T4 | None |
|-------------|-----|-----|-----|-----|-----|------|
| Trash | 60% | 30% | 0% | 0% | 0% | 10% |
| Standard | 0% | 40% | 40% | 20% | 0% | 0% |
| Elite | 0% | 0% | 40% | 50% | 10% | 0% |
| MiniBoss | 0% | 0% | 20% | 50% | 30% | 0% |
| Boss | 0% | 0% | 0% | 30% | 70% | 0% |

#### DropTableProvider
```csharp
public interface IDropTableProvider
{
    /// <summary>
    /// Gets drop probabilities for an enemy class.
    /// </summary>
    DropProbabilityEntry GetDropTable(EnemyDropClass enemyClass);

    /// <summary>
    /// Rolls for quality tier based on enemy class.
    /// </summary>
    QualityTier? RollQualityTier(EnemyDropClass enemyClass, Random rng);
}
```

**Drop Roll Logic:**
```
RollQualityTier(enemyClass, rng):
  1. Get probability entry for enemy class
  2. Roll 0-99
  3. Accumulate probabilities until roll < cumulative
  4. Return tier (or null for no drop)
```

**Configuration (`drop-tables.json`):**
```json
{
  "dropTables": [
    {
      "enemyClass": "Trash",
      "probabilities": {
        "JuryRigged": 0.60,
        "Scavenged": 0.30
      },
      "noDropChance": 0.10
    },
    {
      "enemyClass": "Boss",
      "probabilities": {
        "Optimized": 0.30,
        "MythForged": 0.70
      },
      "noDropChance": 0.0
    }
  ]
}
```

**Unit Tests (~4):**
- [ ] Trash enemies never drop Tier 2+
- [ ] Boss enemies always drop something
- [ ] Boss enemies have 70% Myth-Forged chance
- [ ] Probability roll distributes correctly over many runs

---

### v0.16.0d - Loot Service Integration

#### Enhanced ILootService Interface
```csharp
public interface ILootService
{
    /// <summary>
    /// Generates loot for a defeated monster using quality tiers.
    /// </summary>
    LootDrop GenerateLoot(Monster monster);

    /// <summary>
    /// Generates loot with specific quality tier.
    /// </summary>
    LootDrop GenerateLootOfTier(QualityTier tier, string? itemCategory = null);

    /// <summary>
    /// Gets the drop class for a monster definition.
    /// </summary>
    EnemyDropClass GetEnemyDropClass(MonsterDefinition definition);
}
```

#### LootDrop Enhancement
```
LootDrop (updated)
├── Items: List<DroppedItem>
├── Currency: Dictionary<string, int>
├── QualityTier: QualityTier? (highest tier in drop)
├── HasMythForged: bool
```

#### DroppedItem Enhancement
```
DroppedItem (updated)
├── ItemId: string
├── Quantity: int
├── QualityTier: QualityTier
├── AttributeBonus: int?
├── BonusAttribute: string?
```

**Monster to Drop Class Mapping:**
```csharp
EnemyDropClass GetEnemyDropClass(MonsterDefinition def)
{
    return def.MonsterType switch
    {
        "Servitor" => EnemyDropClass.Trash,
        "Drone" => EnemyDropClass.Standard,
        "Warden" => EnemyDropClass.Elite,
        "Boss" => EnemyDropClass.Boss,
        _ => EnemyDropClass.Standard
    };
}
```

**Unit Tests (~5):**
- [ ] GenerateLoot uses quality tier system
- [ ] Monster type maps to correct drop class
- [ ] Generated items have tier-appropriate stats
- [ ] LootDrop tracks highest tier correctly
- [ ] HasMythForged flag set when applicable

---

### Configuration Files

| File | Purpose |
|------|---------|
| `quality-tiers.json` | Tier definitions, colors, rarity labels |
| `tier-scaling.json` | Weapon and armor stat scaling by tier |
| `drop-tables.json` | Enemy class probability matrices |

---

### Dependencies

**Requires:**
- Existing `LootService` implementation
- `Monster` and `MonsterDefinition` entities
- `DroppedItem` value object

**Provides to:**
- v0.16.1-v0.16.5: Quality tier foundation
- Combat system: Tier-based damage calculation
- UI: Color coding infrastructure

---

### Acceptance Criteria

- [ ] QualityTier enum has 5 distinct values
- [ ] Each tier has defined color and rarity
- [ ] Weapon scaling provides tier-appropriate stats
- [ ] Armor scaling provides tier-appropriate stats
- [ ] Attribute bonuses roll correctly for Tier 3-4
- [ ] Drop tables map enemy classes to probabilities
- [ ] Probability rolls distribute correctly
- [ ] Trash enemies never drop Tier 2+ items
- [ ] Boss enemies have 70% Myth-Forged chance
- [ ] LootService integrates tier system
- [ ] ~15 unit tests pass
