# v0.14.5d Design Specification: Vendor Schema

**Version:** 0.14.5d
**Parent:** v0.14.5 (Economy Configuration Schemas)
**Prerequisites:** v0.14.5a Complete (Currency Schema), items.schema.json available
**Status:** Design Complete

---

## Table of Contents

1. [Executive Summary](#1-executive-summary)
2. [Feature Overview](#2-feature-overview)
3. [Architecture Diagrams](#3-architecture-diagrams)
4. [Vendor Schema Root Definition](#4-vendor-schema-root-definition)
   - 4.1 [Root Configuration Properties](#41-root-configuration-properties)
   - 4.2 [VendorDefinition Schema](#42-vendordefinition-schema)
5. [Vendor Specialty Configuration](#5-vendor-specialty-configuration)
   - 5.1 [Specialty Enumeration](#51-specialty-enumeration)
   - 5.2 [Specialty-Based Defaults](#52-specialty-based-defaults)
6. [Inventory Item Configuration](#6-inventory-item-configuration)
   - 6.1 [InventoryItem Definition](#61-inventoryitem-definition)
   - 6.2 [Stock Quantity Rules](#62-stock-quantity-rules)
   - 6.3 [Price Overrides](#63-price-overrides)
   - 6.4 [Availability Gates](#64-availability-gates)
7. [Price Modifiers Configuration](#7-price-modifiers-configuration)
   - 7.1 [PriceModifiers Definition](#71-pricemodifiers-definition)
   - 7.2 [Base Multipliers](#72-base-multipliers)
   - 7.3 [Discount Effects](#73-discount-effects)
   - 7.4 [Price Calculation Formula](#74-price-calculation-formula)
8. [Restock Rule Configuration](#8-restock-rule-configuration)
   - 8.1 [RestockRule Definition](#81-restockrile-definition)
   - 8.2 [Restock Type Enumeration](#82-restock-type-enumeration)
   - 8.3 [Restock Behavior](#83-restock-behavior)
9. [Operating Hours Configuration](#9-operating-hours-configuration)
   - 9.1 [OperatingHours Definition](#91-operatinghours-definition)
   - 9.2 [Day-of-Week Scheduling](#92-day-of-week-scheduling)
10. [Validation Rules](#10-validation-rules)
    - 10.1 [ID Pattern Validation](#101-id-pattern-validation)
    - 10.2 [Range Validation](#102-range-validation)
    - 10.3 [Required Fields](#103-required-fields)
    - 10.4 [Enum Validation](#104-enum-validation)
    - 10.5 [Cross-Reference Validation](#105-cross-reference-validation)
11. [Configuration Schema](#11-configuration-schema)
12. [Configuration File Updates](#12-configuration-file-updates)
13. [Data Model Changes](#13-data-model-changes)
14. [Logging Specifications](#14-logging-specifications)
15. [Unit Testing Requirements](#15-unit-testing-requirements)
16. [Use Cases](#16-use-cases)
17. [Deliverable Checklist](#17-deliverable-checklist)
18. [Acceptance Criteria](#18-acceptance-criteria)
19. [Dependencies](#19-dependencies)
20. [Future Considerations](#20-future-considerations)

---

## 1. Executive Summary

Version 0.14.5d introduces the **Vendor Schema** (`vendors.schema.json`), which validates vendor NPC definitions including inventory listings, price modifiers, restock rules, operating hours, and specialty categories. This schema enables full customization of merchant NPCs without code changes, supporting modding scenarios such as wandering traders, specialty shops, black market dealers, or faction-exclusive vendors.

The Vendor Schema establishes patterns for complex NPC configurations that reference items, currencies, reputations, and dialogues. It completes the v0.14.5 Economy Configuration Schemas series alongside currency (v0.14.5a), resources (v0.14.5b), and recipes (v0.14.5c).

### Key Deliverables

| Category | Items |
|----------|-------|
| **Schema Files** | `vendors.schema.json` |
| **Schema Definitions** | `VendorDefinition`, `InventoryItem`, `PriceModifiers`, `RestockRule`, `OperatingHours` |
| **Configuration Files** | Create `vendors.json` with example vendors |
| **Tests** | ~5 new unit tests |

### Architectural Significance

This version provides:
- **Vendor specialty system** - 10 specialty categories with typical inventory types
- **Dynamic inventory** - Stock quantities, infinite stock, rare items
- **Price modifier system** - Base multipliers, charisma/reputation effects, discount caps
- **Restock mechanics** - Timer-based, event-triggered, or fixed inventory
- **Operating schedules** - Time-based vendor availability
- **Currency acceptance** - Support for multiple payment methods
- **Reference integration** - Links to items, currencies, reputations, dialogues

### Relationship to Other Schemas

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                  v0.14.5 ECONOMY CONFIGURATION SCHEMAS                       │
└─────────────────────────────────────────────────────────────────────────────┘

  ┌─────────────────────────────────────────────────────────────────────────┐
  │  v0.14.5a: currency.schema.json                                        │
  │  v0.14.5b: resources.schema.json                                       │
  │  v0.14.5c: recipes.schema.json                                         │
  │  v0.14.5d: vendors.schema.json ◀── THIS VERSION                        │
  └─────────────────────────────────────────────────────────────────────────┘

  Cross-references:
  • vendors.json → acceptedCurrencies references currency.json (v0.14.5a)
  • vendors.json → inventory[].itemId references items.json
  • vendors.json → reputationFactionId references factions.json (future)
  • vendors.json → dialogueStartId references dialogues.json (future)
  • vendors.json → locationId references locations.json (future)

  Shared definitions:
  • ID pattern: ^[a-z][a-z0-9-]*$ (lowercase kebab-case)
  • Schema location: config/schemas/
  • Vendors structure: Array of vendor definitions
```

---

## 2. Feature Overview

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                       VENDOR SCHEMA FEATURE TREE                            │
└─────────────────────────────────────────────────────────────────────────────┘

vendors.schema.json
├── Root Configuration
│   ├── $schema reference
│   ├── version (optional)
│   └── vendors array
│
├── VendorDefinition
│   ├── Identity
│   │   ├── id (kebab-case unique identifier)
│   │   ├── name (display name)
│   │   ├── title (optional honorific)
│   │   └── description (flavor text)
│   │
│   ├── Classification
│   │   ├── specialty (10 types)
│   │   └── sortOrder (optional)
│   │
│   ├── Inventory
│   │   └── items[] → InventoryItem
│   │
│   ├── Pricing
│   │   ├── priceModifiers → PriceModifiers
│   │   └── acceptedCurrencies[]
│   │
│   ├── Restocking
│   │   └── restockRule → RestockRule (optional)
│   │
│   ├── Availability
│   │   ├── operatingHours → OperatingHours (optional)
│   │   └── locationId (optional)
│   │
│   └── References
│       ├── reputationFactionId (optional)
│       └── dialogueStartId (optional)
│
├── InventoryItem
│   ├── Item Reference
│   │   ├── itemId (required)
│   │   └── itemType (Item/Weapon/Armor)
│   │
│   ├── Stock
│   │   ├── stockQuantity (-1 = infinite)
│   │   └── isRare (limited availability)
│   │
│   ├── Pricing
│   │   ├── priceOverride (fixed price)
│   │   ├── buyPriceMultiplier (override)
│   │   └── sellPriceMultiplier (override)
│   │
│   └── Requirements
│       ├── requiredLevel (player level)
│       └── requiredReputationLevel (faction standing)
│
├── PriceModifiers
│   ├── Base Rates
│   │   ├── baseBuyMultiplier (default: 1.0)
│   │   └── baseSellMultiplier (default: 0.5)
│   │
│   ├── Discount Effects
│   │   ├── charismaEffect (per-point)
│   │   ├── persuasionEffect (per-skill-level)
│   │   └── reputationEffect (per-rep-level)
│   │
│   └── Limits
│       └── maxDiscount (cap: 0.9)
│
├── RestockRule
│   ├── type (Timer/OnRest/OnLevelUp/Manual/Never)
│   ├── timerTurns (for Timer type)
│   ├── restockPercentage (0-1)
│   └── restockRareItems (boolean)
│
└── OperatingHours
    ├── startHour (0-23)
    ├── endHour (0-23)
    └── closedDays[] (day names)
```

---

## 3. Architecture Diagrams

### 3.1 Vendor Definition Architecture

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                         VENDOR DEFINITION STRUCTURE                          │
└─────────────────────────────────────────────────────────────────────────────┘

                              VendorDefinition
                    ┌──────────────────────────────────┐
                    │  id: "blacksmith-ironforge"      │
                    │  name: "Gromm Ironhand"          │
                    │  title: "Master Blacksmith"      │
                    │  description: "A gruff..."       │
                    │  specialty: "Blacksmith"         │
                    │  sortOrder: 1                    │
                    └──────────┬───────────────────────┘
                               │
       ┌───────────────────────┼───────────────────────────┐
       │                       │                           │
       ▼                       ▼                           ▼
┌──────────────┐     ┌─────────────────┐         ┌───────────────┐
│  inventory[] │     │ priceModifiers  │         │  restockRule  │
│──────────────│     │─────────────────│         │───────────────│
│ InventoryItem│     │ baseBuyMult:1.0 │         │ type: Timer   │
│ InventoryItem│     │ baseSellMult:0.5│         │ timerTurns:50 │
│ InventoryItem│     │ charismaEffect  │         │ restockPct:1.0│
│     ...      │     │ maxDiscount:0.5 │         │ restockRare:F │
└──────────────┘     └─────────────────┘         └───────────────┘
       │
       ▼
┌─────────────────────────────────────────────────────────────────┐
│                        InventoryItem                             │
│─────────────────────────────────────────────────────────────────│
│  itemId: "iron-sword"      │ stockQuantity: 5                   │
│  itemType: "Weapon"        │ isRare: false                      │
│  priceOverride: null       │ requiredLevel: null                │
│  buyPriceMultiplier: null  │ requiredReputationLevel: null      │
│  sellPriceMultiplier: null │                                    │
└─────────────────────────────────────────────────────────────────┘
```

### 3.2 Price Calculation Flow

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                         PRICE CALCULATION FLOW                               │
└─────────────────────────────────────────────────────────────────────────────┘

BUYING FROM VENDOR:
═══════════════════

  Item Base Price
        │
        ▼
  ┌─────────────────┐
  │ × baseBuyMult   │  (vendor's base markup, e.g., 1.0)
  └────────┬────────┘
           │
           ▼
  ┌─────────────────┐
  │ × buyPriceMult  │  (item-specific override, optional)
  └────────┬────────┘
           │
           ▼
  ┌─────────────────────────────────────────┐
  │ Calculate Total Discount:               │
  │   charismaDiscount = CHA × charismaEff  │
  │   persuasionDiscount = SKL × persuasEff │
  │   repDiscount = REP × repEffect         │
  │                                         │
  │   totalDiscount = MIN(sum, maxDiscount) │
  └────────────────────┬────────────────────┘
                       │
                       ▼
  ┌─────────────────────────────────────────┐
  │ × (1 - totalDiscount)                   │
  └────────────────────┬────────────────────┘
                       │
                       ▼
              ┌────────────────┐
              │ FINAL BUY PRICE│
              └────────────────┘


SELLING TO VENDOR:
══════════════════

  Item Base Price
        │
        ▼
  ┌─────────────────┐
  │ × baseSellMult  │  (vendor's base rate, e.g., 0.5)
  └────────┬────────┘
           │
           ▼
  ┌─────────────────┐
  │ × sellPriceMult │  (item-specific override, optional)
  └────────┬────────┘
           │
           ▼
  ┌─────────────────────────────────────────┐
  │ Calculate Total Bonus:                  │
  │   charismaBonus = CHA × charismaEff     │
  │   persuasionBonus = SKL × persuasEff    │
  │   repBonus = REP × repEffect            │
  │                                         │
  │   totalBonus = MIN(sum, maxDiscount)    │
  └────────────────────┬────────────────────┘
                       │
                       ▼
  ┌─────────────────────────────────────────┐
  │ × (1 + totalBonus)                      │
  └────────────────────┬────────────────────┘
                       │
                       ▼
              ┌─────────────────┐
              │ FINAL SELL PRICE│
              └─────────────────┘
```

### 3.3 Restock Behavior Flow

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                          RESTOCK BEHAVIOR FLOW                               │
└─────────────────────────────────────────────────────────────────────────────┘

                        ┌─────────────────┐
                        │ Trigger Event   │
                        └────────┬────────┘
                                 │
           ┌─────────────────────┼─────────────────────┐
           │                     │                     │
           ▼                     ▼                     ▼
    ┌──────────────┐     ┌──────────────┐     ┌──────────────┐
    │    Timer     │     │    OnRest    │     │  OnLevelUp   │
    │──────────────│     │──────────────│     │──────────────│
    │ After X turns│     │ Player rests │     │ Player levels│
    │ configured   │     │ at inn/camp  │     │ up in game   │
    └──────┬───────┘     └──────┬───────┘     └──────┬───────┘
           │                    │                    │
           └────────────────────┼────────────────────┘
                                │
                                ▼
                    ┌───────────────────────┐
                    │  Check restockRule    │
                    └───────────┬───────────┘
                                │
                    ┌───────────┴───────────┐
                    │                       │
                    ▼                       ▼
            ┌───────────────┐       ┌───────────────┐
            │ type: "Never" │       │ type: other   │
            │───────────────│       │───────────────│
            │ Skip restock  │       │ Proceed       │
            └───────────────┘       └───────┬───────┘
                                            │
                                            ▼
                              ┌────────────────────────┐
                              │ For each inventory item│
                              └───────────┬────────────┘
                                          │
                    ┌─────────────────────┼─────────────────────┐
                    │                     │                     │
                    ▼                     ▼                     ▼
            ┌───────────────┐     ┌───────────────┐     ┌───────────────┐
            │ stockQty = -1 │     │   isRare &&   │     │   Standard    │
            │───────────────│     │ !restockRare  │     │───────────────│
            │ Infinite:skip │     │───────────────│     │ Restore qty   │
            └───────────────┘     │ Skip restock  │     │ × restockPct  │
                                  └───────────────┘     └───────────────┘
```

### 3.4 Schema Layer Diagram

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           SCHEMA LAYER DIAGRAM                               │
└─────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────┐
│                              PRESENTATION                                    │
│                                                                              │
│  UI displays vendor shop interface using vendor definitions                  │
│  • Show vendor name, title, description                                      │
│  • Display inventory with current stock and prices                           │
│  • Indicate availability based on operating hours                            │
│  • Show player's applicable discounts                                        │
└─────────────────────────────────────────────────────────────────────────────┘
                                     │
                                     ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                              APPLICATION                                     │
│                                                                              │
│  VendorService loads and provides vendor data                                │
│  • GetAllVendors() → IEnumerable<VendorDefinition>                           │
│  • GetVendorById(id) → VendorDefinition?                                     │
│  • GetVendorsBySpecialty(specialty) → IEnumerable<VendorDefinition>          │
│  • GetVendorsByLocation(locationId) → IEnumerable<VendorDefinition>          │
│  • IsVendorOpen(vendorId, currentHour, currentDay) → bool                    │
└─────────────────────────────────────────────────────────────────────────────┘
                                     │
                                     ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                             DOMAIN LAYER                                     │
│                                                                              │
│  VendorDefinition entity with nested value objects                           │
│  • VendorDefinition (id, name, title, specialty, inventory, etc.)            │
│  • InventoryItem (itemId, stockQuantity, priceOverride, etc.)                │
│  • PriceModifiers (baseBuyMult, baseSellMult, effects, maxDiscount)          │
│  • RestockRule (type, timerTurns, restockPercentage, restockRareItems)       │
│  • OperatingHours (startHour, endHour, closedDays)                           │
└─────────────────────────────────────────────────────────────────────────────┘
                                     │
                                     ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                           INFRASTRUCTURE                                     │
│                                                                              │
│  VendorProvider loads from JSON with schema validation                       │
│  • LoadVendors() → reads config/vendors.json                                 │
│  • Validates against config/schemas/vendors.schema.json                      │
│  • Caches loaded definitions for performance                                 │
│  • Logs warnings for invalid entries                                         │
└─────────────────────────────────────────────────────────────────────────────┘
                                     │
                                     ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                            CONFIGURATION                                     │
│                                                                              │
│  config/schemas/vendors.schema.json                                          │
│  config/vendors.json                                                         │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 4. Vendor Schema Root Definition

### 4.1 Root Configuration Properties

The root schema defines the top-level structure of the `vendors.json` configuration file.

| Property | Type | Required | Default | Description |
|----------|------|----------|---------|-------------|
| `$schema` | string | No | - | Reference to the JSON schema for validation |
| `version` | string | No | - | Configuration file version for compatibility |
| `vendors` | array | **Yes** | - | Array of `VendorDefinition` objects |

### 4.2 VendorDefinition Schema

Each vendor is defined with identity, classification, inventory, pricing, restocking, and availability configurations.

| Property | Type | Required | Default | Description |
|----------|------|----------|---------|-------------|
| `id` | string | **Yes** | - | Unique identifier (kebab-case pattern) |
| `name` | string | **Yes** | - | Display name shown to player |
| `title` | string | No | - | Honorific or profession title (e.g., "Master Blacksmith") |
| `description` | string | **Yes** | - | Flavor text describing the vendor |
| `specialty` | string | **Yes** | - | Vendor specialty category (enum of 10 types) |
| `inventory` | array | **Yes** | - | Array of `InventoryItem` objects |
| `priceModifiers` | object | **Yes** | - | `PriceModifiers` object |
| `restockRule` | object | No | - | `RestockRule` object (null = never restocks) |
| `acceptedCurrencies` | array | No | `["gold"]` | Array of currency IDs accepted by vendor |
| `reputationFactionId` | string | No | - | Faction ID for reputation-based pricing |
| `dialogueStartId` | string | No | - | Dialogue node ID for conversation start |
| `locationId` | string | No | - | Location ID where vendor is found |
| `operatingHours` | object | No | - | `OperatingHours` object (null = always open) |
| `sortOrder` | integer | No | 0 | Display order in vendor lists |

---

## 5. Vendor Specialty Configuration

### 5.1 Specialty Enumeration

Vendors are classified by specialty, which indicates their typical inventory focus and may affect default pricing.

| Specialty | Description | Typical Inventory | Suggested Buy Multiplier |
|-----------|-------------|-------------------|--------------------------|
| `General` | Mixed goods merchant | Varied items | 1.0× |
| `Blacksmith` | Weapons and tools | Swords, axes, hammers, tools | 1.0× |
| `Armorer` | Protective gear | Armor, shields, helmets | 1.0× |
| `Alchemist` | Magical consumables | Potions, ingredients, reagents | 1.1× |
| `Enchanter` | Magical items | Scrolls, enchanted gear, runes | 1.2× |
| `Jeweler` | Precious accessories | Rings, amulets, gems | 1.2× |
| `Tailor` | Cloth and leather goods | Cloth armor, bags, cloaks | 0.9× |
| `Innkeeper` | Food and lodging | Food, drink, rooms, rumors | 0.8× |
| `Provisioner` | Travel supplies | Rations, rope, torches, camping | 0.9× |
| `Exotic` | Rare and unique items | Legendary items, one-of-a-kind | 1.5× |

### 5.2 Specialty-Based Defaults

The specialty classification provides semantic information but does not enforce inventory contents. Game designers may configure any vendor to sell any items. The suggested buy multipliers are guidance for realistic pricing but are overridden by the vendor's explicit `priceModifiers`.

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                        SPECIALTY PRICE GUIDANCE                              │
└─────────────────────────────────────────────────────────────────────────────┘

  LOW MARKUP                  STANDARD                    HIGH MARKUP
  (0.8× - 0.9×)              (1.0×)                      (1.1× - 1.5×)
       │                        │                             │
       ▼                        ▼                             ▼
  ┌──────────┐            ┌──────────┐                  ┌──────────┐
  │Innkeeper │            │Blacksmith│                  │Alchemist │
  │Tailor    │            │Armorer   │                  │Enchanter │
  │Provision │            │General   │                  │Jeweler   │
  └──────────┘            └──────────┘                  │Exotic    │
                                                        └──────────┘
  Common goods             Crafted goods                Specialty/rare
  High competition         Standard trade               Expert services
```

---

## 6. Inventory Item Configuration

### 6.1 InventoryItem Definition

Each item in a vendor's inventory is configured with stock, pricing, and availability constraints.

| Property | Type | Required | Default | Description |
|----------|------|----------|---------|-------------|
| `itemId` | string | **Yes** | - | Reference to item definition (kebab-case) |
| `itemType` | string | No | `"Item"` | Type hint: `Item`, `Weapon`, or `Armor` |
| `stockQuantity` | integer | **Yes** | - | Available quantity (-1 = infinite) |
| `priceOverride` | integer | No | - | Fixed price ignoring base price |
| `buyPriceMultiplier` | number | No | - | Multiplier when player buys (overrides base) |
| `sellPriceMultiplier` | number | No | - | Multiplier when player sells (overrides base) |
| `requiredLevel` | integer | No | - | Minimum player level to purchase |
| `requiredReputationLevel` | integer | No | - | Minimum reputation tier to purchase |
| `isRare` | boolean | No | `false` | Whether item has limited availability |

### 6.2 Stock Quantity Rules

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                          STOCK QUANTITY RULES                                │
└─────────────────────────────────────────────────────────────────────────────┘

  stockQuantity Value        Behavior
  ═══════════════════        ════════

       -1                    INFINITE STOCK
       ───                   • Never depletes
                            • Always available
                            • Common consumables
                            • Basic supplies

        0                    OUT OF STOCK
       ───                   • Currently unavailable
                            • May restock later
                            • Display as "Sold Out"

       >0                    LIMITED STOCK
       ───                   • Depletes on purchase
                            • Quantity shown to player
                            • May restock based on rules
```

### 6.3 Price Overrides

Price overrides allow per-item customization independent of the vendor's base modifiers.

| Override | Effect | Use Case |
|----------|--------|----------|
| `priceOverride` | Sets exact price, ignoring all calculations | Quest rewards, special deals |
| `buyPriceMultiplier` | Multiplies buy price for this item only | Rare items cost more |
| `sellPriceMultiplier` | Multiplies sell price for this item only | Vendor wants specific items |

### 6.4 Availability Gates

Items can be gated behind player progression requirements.

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                         AVAILABILITY GATE FLOW                               │
└─────────────────────────────────────────────────────────────────────────────┘

                    Player Attempts Purchase
                              │
                              ▼
                  ┌───────────────────────┐
                  │ requiredLevel set?    │
                  └───────────┬───────────┘
                              │
              ┌───────────────┴───────────────┐
              │ Yes                           │ No
              ▼                               │
    ┌─────────────────────┐                   │
    │ Player Level >= req │                   │
    └──────────┬──────────┘                   │
               │                              │
    ┌──────────┴──────────┐                   │
    │ Yes           │ No  │                   │
    ▼               ▼     │                   │
  Continue       "Level   │                   │
    │            too low" │                   │
    │               │     │                   │
    └───────────────┼─────┘                   │
                    │                         │
                    └────────────┬────────────┘
                                 │
                                 ▼
                  ┌───────────────────────┐
                  │ requiredRepLevel set? │
                  └───────────┬───────────┘
                              │
              ┌───────────────┴───────────────┐
              │ Yes                           │ No
              ▼                               │
    ┌─────────────────────┐                   │
    │ Rep Level >= req    │                   │
    └──────────┬──────────┘                   │
               │                              │
    ┌──────────┴──────────┐                   │
    │ Yes           │ No  │                   │
    ▼               ▼     │                   │
  Continue    "Reputation │                   │
    │         too low"    │                   │
    │               │     │                   │
    └───────────────┴─────┘                   │
                                              │
                    └────────────┬────────────┘
                                 │
                                 ▼
                         PURCHASE ALLOWED
```

---

## 7. Price Modifiers Configuration

### 7.1 PriceModifiers Definition

The `PriceModifiers` object configures how prices are calculated for all transactions with the vendor.

| Property | Type | Required | Default | Range | Description |
|----------|------|----------|---------|-------|-------------|
| `baseBuyMultiplier` | number | No | 1.0 | ≥0.1 | Base markup when player buys |
| `baseSellMultiplier` | number | No | 0.5 | ≥0.1 | Base rate when player sells |
| `charismaEffect` | number | No | 0 | ≥0 | Discount per charisma point |
| `persuasionEffect` | number | No | 0 | ≥0 | Discount per persuasion skill level |
| `reputationEffect` | number | No | 0 | ≥0 | Discount per reputation level |
| `maxDiscount` | number | No | 0.5 | 0-0.9 | Maximum total discount allowed |

### 7.2 Base Multipliers

The base multipliers establish the vendor's standard pricing before any player-based adjustments.

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                         BASE MULTIPLIER EXAMPLES                             │
└─────────────────────────────────────────────────────────────────────────────┘

  Vendor Type          baseBuyMult    baseSellMult    Player Experience
  ═══════════          ═══════════    ════════════    ═════════════════

  Friendly Merchant       0.9            0.6          Good prices both ways
  Standard Vendor         1.0            0.5          Normal trade rates
  Specialty Shop          1.2            0.4          Premium buy, low sell
  Black Market            1.5            0.7          High cost, fair sell
  Pawn Shop               0.8            0.3          Cheap buy, terrible sell
```

### 7.3 Discount Effects

Discount effects allow player stats and reputation to influence pricing dynamically.

| Effect | Calculation | Example |
|--------|-------------|---------|
| `charismaEffect` | CHA stat × effect value | CHA 16, effect 0.01 = 16% discount |
| `persuasionEffect` | Skill level × effect value | Persuasion 5, effect 0.02 = 10% discount |
| `reputationEffect` | Rep level × effect value | Honored (3), effect 0.05 = 15% discount |

### 7.4 Price Calculation Formula

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                        PRICE CALCULATION FORMULAS                            │
└─────────────────────────────────────────────────────────────────────────────┘

BUYING FROM VENDOR:
═══════════════════

  charismaDiscount   = characterCHA × charismaEffect
  persuasionDiscount = persuasionLevel × persuasionEffect
  reputationDiscount = reputationLevel × reputationEffect

  totalDiscount = MIN(charismaDiscount + persuasionDiscount + reputationDiscount,
                      maxDiscount)

  finalBuyPrice = basePrice
                  × baseBuyMultiplier
                  × (item.buyPriceMultiplier OR 1.0)
                  × (1 - totalDiscount)

  OR if item.priceOverride is set:
  finalBuyPrice = item.priceOverride


SELLING TO VENDOR:
══════════════════

  charismaBonus   = characterCHA × charismaEffect
  persuasionBonus = persuasionLevel × persuasionEffect
  reputationBonus = reputationLevel × reputationEffect

  totalBonus = MIN(charismaBonus + persuasionBonus + reputationBonus,
                   maxDiscount)

  finalSellPrice = basePrice
                   × baseSellMultiplier
                   × (item.sellPriceMultiplier OR 1.0)
                   × (1 + totalBonus)


EXAMPLE CALCULATION:
════════════════════

  Item: Iron Sword (base price: 100 gold)
  Vendor: baseBuyMult=1.0, charismaEffect=0.01, maxDiscount=0.5
  Player: CHA 14, Persuasion 3 (persuasionEffect=0.02), Reputation 2 (repEffect=0.05)

  charismaDiscount   = 14 × 0.01 = 0.14 (14%)
  persuasionDiscount = 3 × 0.02  = 0.06 (6%)
  reputationDiscount = 2 × 0.05  = 0.10 (10%)
  totalDiscount      = MIN(0.30, 0.50) = 0.30 (30%)

  finalBuyPrice = 100 × 1.0 × (1 - 0.30) = 70 gold
```

---

## 8. Restock Rule Configuration

### 8.1 RestockRule Definition

The `RestockRule` object configures when and how a vendor's inventory replenishes.

| Property | Type | Required | Default | Range | Description |
|----------|------|----------|---------|-------|-------------|
| `type` | string | **Yes** | - | enum | Restock trigger type |
| `timerTurns` | integer | No* | - | >0 | Turns until restock (Timer type only) |
| `restockPercentage` | number | No | 1.0 | 0-1 | Fraction of max stock to restore |
| `restockRareItems` | boolean | No | `false` | - | Whether to restock rare items |

*Required when `type` is `Timer`.

### 8.2 Restock Type Enumeration

| Type | Trigger | Use Case |
|------|---------|----------|
| `Timer` | After `timerTurns` game turns | Regular merchants with periodic restocking |
| `OnRest` | When player rests at inn/camp | Innkeepers, camp provisioners |
| `OnLevelUp` | When player gains a level | Progression-tied inventory expansion |
| `Manual` | Triggered by game events/quests | Story-driven vendor changes |
| `Never` | Inventory never restocks | Unique item vendors, one-time sellers |

### 8.3 Restock Behavior

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                          RESTOCK BEHAVIOR MATRIX                             │
└─────────────────────────────────────────────────────────────────────────────┘

                           restockRareItems
                        │  false    │  true
  ══════════════════════╪═══════════╪═══════════
  Standard Item         │  Restock  │  Restock
  (isRare: false)       │           │
  ──────────────────────┼───────────┼───────────
  Rare Item             │  Skip     │  Restock
  (isRare: true)        │           │
  ──────────────────────┼───────────┼───────────
  Infinite Stock        │  Skip     │  Skip
  (stockQuantity: -1)   │           │
  ══════════════════════╧═══════════╧═══════════

  Partial Restock Example (restockPercentage: 0.5):
  ─────────────────────────────────────────────────

  Initial stock: 10
  After purchase: 2 remaining
  Restock amount: (10 - 2) × 0.5 = 4
  Final stock: 2 + 4 = 6
```

---

## 9. Operating Hours Configuration

### 9.1 OperatingHours Definition

The `OperatingHours` object configures when the vendor is available for transactions.

| Property | Type | Required | Default | Range | Description |
|----------|------|----------|---------|-------|-------------|
| `startHour` | integer | **Yes** | - | 0-23 | Hour when vendor opens |
| `endHour` | integer | **Yes** | - | 0-23 | Hour when vendor closes |
| `closedDays` | array | No | `[]` | - | Days when vendor is closed |

### 9.2 Day-of-Week Scheduling

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                        OPERATING HOURS EXAMPLES                              │
└─────────────────────────────────────────────────────────────────────────────┘

  Standard Shop (9 AM - 6 PM, weekdays):
  ───────────────────────────────────────
  {
    "startHour": 9,
    "endHour": 18,
    "closedDays": ["Saturday", "Sunday"]
  }


  Nighttime Vendor (8 PM - 4 AM):
  ────────────────────────────────
  {
    "startHour": 20,
    "endHour": 4,
    "closedDays": []
  }
  Note: When endHour < startHour, vendor operates overnight.


  Always Open (24/7):
  ───────────────────
  Omit operatingHours entirely, or:
  {
    "startHour": 0,
    "endHour": 23,
    "closedDays": []
  }


  Day Enumeration Values:
  ═══════════════════════
  "Monday", "Tuesday", "Wednesday", "Thursday",
  "Friday", "Saturday", "Sunday"
```

---

## 10. Validation Rules

### 10.1 ID Pattern Validation

All identifiers must follow the kebab-case pattern for consistency across configurations.

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                          ID PATTERN VALIDATION                               │
└─────────────────────────────────────────────────────────────────────────────┘

  Pattern: ^[a-z][a-z0-9-]*$

  ✓ Valid Examples:
    • blacksmith-ironforge
    • general-store
    • alchemist-master-1
    • tavern

  ✗ Invalid Examples:
    • Blacksmith-Ironforge    (uppercase)
    • 1st-vendor              (starts with number)
    • vendor_shop             (underscore)
    • vendor shop             (space)
    • -vendor                 (starts with hyphen)
```

### 10.2 Range Validation

| Field | Minimum | Maximum | Notes |
|-------|---------|---------|-------|
| `stockQuantity` | -1 | - | -1 = infinite |
| `baseBuyMultiplier` | 0.1 | - | No upper limit |
| `baseSellMultiplier` | 0.1 | - | No upper limit |
| `charismaEffect` | 0 | - | Per-point discount |
| `persuasionEffect` | 0 | - | Per-level discount |
| `reputationEffect` | 0 | - | Per-level discount |
| `maxDiscount` | 0 | 0.9 | Cannot exceed 90% |
| `restockPercentage` | 0 | 1 | Fraction of max |
| `timerTurns` | 1 | - | Must be positive |
| `startHour` | 0 | 23 | 24-hour format |
| `endHour` | 0 | 23 | 24-hour format |
| `sortOrder` | 0 | - | Display ordering |
| `requiredLevel` | 1 | - | Player level gate |
| `requiredReputationLevel` | 0 | - | Rep tier gate |

### 10.3 Required Fields

| Level | Required Fields |
|-------|-----------------|
| Root | `vendors` |
| VendorDefinition | `id`, `name`, `description`, `specialty`, `inventory`, `priceModifiers` |
| InventoryItem | `itemId`, `stockQuantity` |
| PriceModifiers | (none - all have defaults) |
| RestockRule | `type` |
| OperatingHours | `startHour`, `endHour` |

### 10.4 Enum Validation

| Enum | Valid Values |
|------|--------------|
| `specialty` | `General`, `Blacksmith`, `Armorer`, `Alchemist`, `Enchanter`, `Jeweler`, `Tailor`, `Innkeeper`, `Provisioner`, `Exotic` |
| `itemType` | `Item`, `Weapon`, `Armor` |
| `restockRule.type` | `Timer`, `OnRest`, `OnLevelUp`, `Manual`, `Never` |
| `closedDays` | `Monday`, `Tuesday`, `Wednesday`, `Thursday`, `Friday`, `Saturday`, `Sunday` |

### 10.5 Cross-Reference Validation

The schema validates format but not existence of referenced entities. Runtime validation should verify:

| Reference | Source | Target |
|-----------|--------|--------|
| `inventory[].itemId` | VendorDefinition | items.json, weapons.json, or armor.json |
| `acceptedCurrencies[]` | VendorDefinition | currency.json |
| `reputationFactionId` | VendorDefinition | factions.json (future) |
| `dialogueStartId` | VendorDefinition | dialogues.json (future) |
| `locationId` | VendorDefinition | locations.json (future) |

---

## 11. Configuration Schema

### Complete `vendors.schema.json`

```json
{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "https://rune-game.com/schemas/vendors.schema.json",
  "title": "Vendor Configuration",
  "description": "Schema for vendor NPC definitions including inventory, pricing, and restock rules",
  "type": "object",
  "properties": {
    "$schema": {
      "type": "string",
      "description": "Reference to this schema for validation"
    },
    "version": {
      "type": "string",
      "description": "Configuration file version for compatibility tracking"
    },
    "vendors": {
      "type": "array",
      "description": "Array of vendor definitions",
      "items": {
        "$ref": "#/definitions/VendorDefinition"
      },
      "minItems": 0
    }
  },
  "required": ["vendors"],
  "additionalProperties": false,
  "definitions": {
    "VendorDefinition": {
      "type": "object",
      "description": "Complete definition for a vendor NPC",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the vendor (kebab-case)",
          "pattern": "^[a-z][a-z0-9-]*$",
          "minLength": 1
        },
        "name": {
          "type": "string",
          "description": "Display name shown to the player",
          "minLength": 1
        },
        "title": {
          "type": "string",
          "description": "Optional honorific or profession title (e.g., 'Master Blacksmith')"
        },
        "description": {
          "type": "string",
          "description": "Flavor text describing the vendor"
        },
        "specialty": {
          "type": "string",
          "description": "Vendor specialty category",
          "enum": [
            "General",
            "Blacksmith",
            "Armorer",
            "Alchemist",
            "Enchanter",
            "Jeweler",
            "Tailor",
            "Innkeeper",
            "Provisioner",
            "Exotic"
          ]
        },
        "inventory": {
          "type": "array",
          "description": "Array of items available for purchase",
          "items": {
            "$ref": "#/definitions/InventoryItem"
          },
          "minItems": 0
        },
        "priceModifiers": {
          "$ref": "#/definitions/PriceModifiers",
          "description": "Price calculation modifiers for this vendor"
        },
        "restockRule": {
          "$ref": "#/definitions/RestockRule",
          "description": "Optional restock behavior configuration"
        },
        "acceptedCurrencies": {
          "type": "array",
          "description": "Currency IDs accepted by this vendor",
          "items": {
            "type": "string",
            "pattern": "^[a-z][a-z0-9-]*$"
          },
          "default": ["gold"],
          "minItems": 1
        },
        "reputationFactionId": {
          "type": "string",
          "description": "Faction ID for reputation-based pricing effects",
          "pattern": "^[a-z][a-z0-9-]*$"
        },
        "dialogueStartId": {
          "type": "string",
          "description": "Dialogue node ID for conversation start",
          "pattern": "^[a-z][a-z0-9-]*$"
        },
        "locationId": {
          "type": "string",
          "description": "Location ID where the vendor is found",
          "pattern": "^[a-z][a-z0-9-]*$"
        },
        "operatingHours": {
          "$ref": "#/definitions/OperatingHours",
          "description": "Optional schedule for vendor availability"
        },
        "sortOrder": {
          "type": "integer",
          "description": "Display order in vendor lists",
          "minimum": 0,
          "default": 0
        }
      },
      "required": ["id", "name", "description", "specialty", "inventory", "priceModifiers"],
      "additionalProperties": false
    },
    "InventoryItem": {
      "type": "object",
      "description": "A single item in a vendor's inventory",
      "properties": {
        "itemId": {
          "type": "string",
          "description": "Reference to item, weapon, or armor definition",
          "pattern": "^[a-z][a-z0-9-]*$",
          "minLength": 1
        },
        "itemType": {
          "type": "string",
          "description": "Type hint for item lookup",
          "enum": ["Item", "Weapon", "Armor"],
          "default": "Item"
        },
        "stockQuantity": {
          "type": "integer",
          "description": "Available quantity (-1 for infinite stock)",
          "minimum": -1
        },
        "priceOverride": {
          "type": "integer",
          "description": "Fixed price ignoring all calculations",
          "minimum": 0
        },
        "buyPriceMultiplier": {
          "type": "number",
          "description": "Multiplier when player buys this item",
          "minimum": 0.1
        },
        "sellPriceMultiplier": {
          "type": "number",
          "description": "Multiplier when player sells this item",
          "minimum": 0.1
        },
        "requiredLevel": {
          "type": "integer",
          "description": "Minimum player level to purchase",
          "minimum": 1
        },
        "requiredReputationLevel": {
          "type": "integer",
          "description": "Minimum reputation tier to purchase",
          "minimum": 0
        },
        "isRare": {
          "type": "boolean",
          "description": "Whether item has limited availability",
          "default": false
        }
      },
      "required": ["itemId", "stockQuantity"],
      "additionalProperties": false
    },
    "PriceModifiers": {
      "type": "object",
      "description": "Price calculation configuration for a vendor",
      "properties": {
        "baseBuyMultiplier": {
          "type": "number",
          "description": "Base markup when player buys from vendor",
          "minimum": 0.1,
          "default": 1.0
        },
        "baseSellMultiplier": {
          "type": "number",
          "description": "Base rate when player sells to vendor",
          "minimum": 0.1,
          "default": 0.5
        },
        "charismaEffect": {
          "type": "number",
          "description": "Discount per charisma point",
          "minimum": 0,
          "default": 0
        },
        "persuasionEffect": {
          "type": "number",
          "description": "Discount per persuasion skill level",
          "minimum": 0,
          "default": 0
        },
        "reputationEffect": {
          "type": "number",
          "description": "Discount per reputation level with faction",
          "minimum": 0,
          "default": 0
        },
        "maxDiscount": {
          "type": "number",
          "description": "Maximum total discount allowed",
          "minimum": 0,
          "maximum": 0.9,
          "default": 0.5
        }
      },
      "additionalProperties": false
    },
    "RestockRule": {
      "type": "object",
      "description": "Configuration for vendor inventory restocking",
      "properties": {
        "type": {
          "type": "string",
          "description": "Type of restock trigger",
          "enum": ["Timer", "OnRest", "OnLevelUp", "Manual", "Never"]
        },
        "timerTurns": {
          "type": "integer",
          "description": "Number of turns until restock (Timer type only)",
          "minimum": 1
        },
        "restockPercentage": {
          "type": "number",
          "description": "Fraction of depleted stock to restore",
          "minimum": 0,
          "maximum": 1,
          "default": 1.0
        },
        "restockRareItems": {
          "type": "boolean",
          "description": "Whether to restock items marked as rare",
          "default": false
        }
      },
      "required": ["type"],
      "allOf": [
        {
          "if": {
            "properties": {
              "type": { "const": "Timer" }
            }
          },
          "then": {
            "required": ["timerTurns"]
          }
        }
      ],
      "additionalProperties": false
    },
    "OperatingHours": {
      "type": "object",
      "description": "Schedule configuration for vendor availability",
      "properties": {
        "startHour": {
          "type": "integer",
          "description": "Hour when vendor opens (24-hour format)",
          "minimum": 0,
          "maximum": 23
        },
        "endHour": {
          "type": "integer",
          "description": "Hour when vendor closes (24-hour format)",
          "minimum": 0,
          "maximum": 23
        },
        "closedDays": {
          "type": "array",
          "description": "Days when vendor is closed",
          "items": {
            "type": "string",
            "enum": ["Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday", "Sunday"]
          },
          "uniqueItems": true
        }
      },
      "required": ["startHour", "endHour"],
      "additionalProperties": false
    }
  }
}
```

---

## 12. Configuration File Updates

### Example `vendors.json`

```json
{
  "$schema": "./schemas/vendors.schema.json",
  "version": "1.0.0",
  "vendors": [
    {
      "id": "blacksmith-ironforge",
      "name": "Gromm Ironhand",
      "title": "Master Blacksmith",
      "description": "A gruff but fair dwarf who has been forging weapons for over a century. His work is renowned throughout the realm.",
      "specialty": "Blacksmith",
      "inventory": [
        {
          "itemId": "iron-sword",
          "itemType": "Weapon",
          "stockQuantity": 5,
          "isRare": false
        },
        {
          "itemId": "steel-sword",
          "itemType": "Weapon",
          "stockQuantity": 3,
          "requiredLevel": 5
        },
        {
          "itemId": "iron-shield",
          "itemType": "Armor",
          "stockQuantity": 4
        },
        {
          "itemId": "repair-kit",
          "stockQuantity": -1
        },
        {
          "itemId": "masterwork-blade",
          "itemType": "Weapon",
          "stockQuantity": 1,
          "isRare": true,
          "requiredReputationLevel": 3,
          "buyPriceMultiplier": 1.5
        }
      ],
      "priceModifiers": {
        "baseBuyMultiplier": 1.0,
        "baseSellMultiplier": 0.5,
        "charismaEffect": 0.01,
        "reputationEffect": 0.05,
        "maxDiscount": 0.3
      },
      "restockRule": {
        "type": "Timer",
        "timerTurns": 50,
        "restockPercentage": 1.0,
        "restockRareItems": false
      },
      "acceptedCurrencies": ["gold"],
      "reputationFactionId": "ironforge-guild",
      "locationId": "ironforge-market",
      "operatingHours": {
        "startHour": 8,
        "endHour": 18,
        "closedDays": ["Sunday"]
      },
      "sortOrder": 1
    },
    {
      "id": "alchemist-mystic",
      "name": "Sylara Moonshadow",
      "title": "Mystic Alchemist",
      "description": "An elven alchemist who specializes in rare and exotic potions. Her prices are high, but her quality is unmatched.",
      "specialty": "Alchemist",
      "inventory": [
        {
          "itemId": "health-potion-minor",
          "stockQuantity": -1
        },
        {
          "itemId": "health-potion-major",
          "stockQuantity": 5
        },
        {
          "itemId": "mana-potion-minor",
          "stockQuantity": -1
        },
        {
          "itemId": "antidote",
          "stockQuantity": 10
        },
        {
          "itemId": "elixir-of-fortitude",
          "stockQuantity": 2,
          "isRare": true,
          "requiredLevel": 10
        }
      ],
      "priceModifiers": {
        "baseBuyMultiplier": 1.1,
        "baseSellMultiplier": 0.4,
        "charismaEffect": 0.005,
        "persuasionEffect": 0.02,
        "maxDiscount": 0.25
      },
      "restockRule": {
        "type": "OnRest",
        "restockPercentage": 0.5,
        "restockRareItems": false
      },
      "acceptedCurrencies": ["gold", "arcane-tokens"],
      "sortOrder": 2
    },
    {
      "id": "innkeeper-crossroads",
      "name": "Hilda Brightbarrel",
      "title": "Innkeeper",
      "description": "A cheerful halfling who runs the Crossroads Inn. Always has a warm meal and cold drink ready for weary travelers.",
      "specialty": "Innkeeper",
      "inventory": [
        {
          "itemId": "bread-loaf",
          "stockQuantity": -1,
          "priceOverride": 2
        },
        {
          "itemId": "cheese-wheel",
          "stockQuantity": -1,
          "priceOverride": 5
        },
        {
          "itemId": "ale-mug",
          "stockQuantity": -1,
          "priceOverride": 3
        },
        {
          "itemId": "roasted-meat",
          "stockQuantity": 10,
          "priceOverride": 8
        },
        {
          "itemId": "travelers-ration",
          "stockQuantity": 20
        }
      ],
      "priceModifiers": {
        "baseBuyMultiplier": 0.8,
        "baseSellMultiplier": 0.3,
        "charismaEffect": 0.02,
        "maxDiscount": 0.4
      },
      "acceptedCurrencies": ["gold", "copper"],
      "dialogueStartId": "innkeeper-greeting",
      "locationId": "crossroads-inn",
      "sortOrder": 3
    },
    {
      "id": "exotic-trader-wandering",
      "name": "Zephyr the Wanderer",
      "description": "A mysterious merchant who appears at random, carrying items from distant lands. No one knows where he comes from or where he goes.",
      "specialty": "Exotic",
      "inventory": [
        {
          "itemId": "desert-silk-cloak",
          "itemType": "Armor",
          "stockQuantity": 1,
          "isRare": true
        },
        {
          "itemId": "eastern-spice-bundle",
          "stockQuantity": 3
        },
        {
          "itemId": "ancient-map-fragment",
          "stockQuantity": 1,
          "isRare": true,
          "buyPriceMultiplier": 2.0
        },
        {
          "itemId": "foreign-coin-collection",
          "stockQuantity": 1,
          "isRare": true
        }
      ],
      "priceModifiers": {
        "baseBuyMultiplier": 1.5,
        "baseSellMultiplier": 0.7,
        "charismaEffect": 0.015,
        "persuasionEffect": 0.03,
        "maxDiscount": 0.35
      },
      "restockRule": {
        "type": "Never"
      },
      "acceptedCurrencies": ["gold", "silver", "trade-goods"],
      "sortOrder": 10
    },
    {
      "id": "general-store-village",
      "name": "Merchant's Corner",
      "description": "A modest shop in the village square selling everyday supplies and basic adventuring gear.",
      "specialty": "General",
      "inventory": [
        {
          "itemId": "torch",
          "stockQuantity": -1
        },
        {
          "itemId": "rope-50ft",
          "stockQuantity": 10
        },
        {
          "itemId": "backpack",
          "stockQuantity": 5
        },
        {
          "itemId": "waterskin",
          "stockQuantity": -1
        },
        {
          "itemId": "bedroll",
          "stockQuantity": 5
        },
        {
          "itemId": "flint-and-steel",
          "stockQuantity": -1
        }
      ],
      "priceModifiers": {
        "baseBuyMultiplier": 1.0,
        "baseSellMultiplier": 0.5,
        "charismaEffect": 0.01,
        "maxDiscount": 0.2
      },
      "restockRule": {
        "type": "Timer",
        "timerTurns": 25,
        "restockPercentage": 1.0,
        "restockRareItems": true
      },
      "acceptedCurrencies": ["gold"],
      "locationId": "village-square",
      "operatingHours": {
        "startHour": 7,
        "endHour": 19,
        "closedDays": []
      },
      "sortOrder": 0
    }
  ]
}
```

---

## 13. Data Model Changes

### Domain Layer Additions

This version introduces no new domain entities—only JSON Schema validation. Future runtime implementation would include:

| Component | Type | Purpose |
|-----------|------|---------|
| `VendorDefinition` | Entity | Immutable vendor template loaded from JSON |
| `InventoryItem` | Value Object | Item listing within a vendor |
| `PriceModifiers` | Value Object | Pricing configuration |
| `RestockRule` | Value Object | Restock behavior configuration |
| `OperatingHours` | Value Object | Availability schedule |
| `VendorSpecialty` | Enum | 10 vendor categories |
| `RestockType` | Enum | 5 restock trigger types |
| `ItemType` | Enum | Item, Weapon, Armor |
| `DayOfWeek` | Enum | 7 days for scheduling |

### Cross-Reference Summary

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                       VENDOR CROSS-REFERENCES                                │
└─────────────────────────────────────────────────────────────────────────────┘

  vendors.json                    Referenced Configuration
  ════════════                    ════════════════════════

  inventory[].itemId        ──►   items.json
                            ──►   weapons.json
                            ──►   armor.json

  acceptedCurrencies[]      ──►   currency.json (v0.14.5a)

  reputationFactionId       ──►   factions.json (future)

  dialogueStartId           ──►   dialogues.json (future)

  locationId                ──►   locations.json (future)
```

---

## 14. Logging Specifications

### Schema Validation Logging

| Event | Level | Message Format |
|-------|-------|----------------|
| Schema loaded | INFO | `Vendor schema loaded from {path}` |
| Validation success | DEBUG | `Vendor configuration validated successfully ({count} vendors)` |
| Validation failure | ERROR | `Vendor configuration validation failed: {errors}` |
| Missing required | WARN | `Vendor {id}: missing required field {field}` |
| Invalid enum | WARN | `Vendor {id}: invalid specialty '{value}'` |
| Invalid pattern | WARN | `Vendor {id}: invalid ID pattern '{value}'` |
| Range violation | WARN | `Vendor {id}: {field} value {value} outside valid range` |

### Runtime Logging (Future)

| Event | Level | Message Format |
|-------|-------|----------------|
| Vendor loaded | DEBUG | `Loaded vendor {id} with {count} items` |
| Item reference invalid | WARN | `Vendor {vendorId}: item reference {itemId} not found` |
| Currency reference invalid | WARN | `Vendor {vendorId}: currency {currencyId} not found` |
| Vendor closed | DEBUG | `Vendor {id} is closed (current hour: {hour})` |
| Restock triggered | DEBUG | `Vendor {id} restocked: {restockedCount} items` |
| Purchase gated | DEBUG | `Item {itemId} requires level {level} (player: {playerLevel})` |

---

## 15. Unit Testing Requirements

### Test Summary

| Test ID | Test Name | Description |
|---------|-----------|-------------|
| VND-001 | ValidVendorConfiguration | Validates a complete vendor configuration with all fields |
| VND-002 | SpecialtyEnumValidation | Validates all 10 specialty types are accepted |
| VND-003 | RestockTypeEnumValidation | Validates all 5 restock types with conditional requirements |
| VND-004 | PriceModifierRangeValidation | Validates multiplier and discount ranges |
| VND-005 | OperatingHoursValidation | Validates hour ranges and day enumeration |

### Test Specifications

#### VND-001: ValidVendorConfiguration

```
Test: Valid complete vendor configuration passes schema validation
Given: A vendors.json with all required and optional fields populated correctly
When: Schema validation is performed
Then: Validation passes with no errors
And: All vendor properties are accessible
```

#### VND-002: SpecialtyEnumValidation

```
Test: Specialty enum accepts all valid types and rejects invalid
Given: Vendor definitions with each specialty type
When: Schema validation is performed with specialty values:
  - "General" → passes
  - "Blacksmith" → passes
  - "Armorer" → passes
  - "Alchemist" → passes
  - "Enchanter" → passes
  - "Jeweler" → passes
  - "Tailor" → passes
  - "Innkeeper" → passes
  - "Provisioner" → passes
  - "Exotic" → passes
  - "InvalidType" → fails
Then: Valid types pass, invalid types fail with enum error
```

#### VND-003: RestockTypeEnumValidation

```
Test: Restock types validate correctly with conditional requirements
Given: RestockRule definitions with various types
When: Schema validation is performed:
  - { "type": "Timer", "timerTurns": 50 } → passes
  - { "type": "Timer" } → fails (missing timerTurns)
  - { "type": "OnRest" } → passes
  - { "type": "OnLevelUp" } → passes
  - { "type": "Manual" } → passes
  - { "type": "Never" } → passes
  - { "type": "Unknown" } → fails
Then: Conditional requirements enforced correctly
```

#### VND-004: PriceModifierRangeValidation

```
Test: Price modifiers validate within acceptable ranges
Given: PriceModifiers with various values
When: Schema validation is performed:
  - baseBuyMultiplier: 0.1 → passes (minimum)
  - baseBuyMultiplier: 0.05 → fails (below minimum)
  - baseSellMultiplier: 0.1 → passes (minimum)
  - maxDiscount: 0 → passes (minimum)
  - maxDiscount: 0.9 → passes (maximum)
  - maxDiscount: 0.95 → fails (above maximum)
  - charismaEffect: 0 → passes
  - charismaEffect: -0.1 → fails (negative)
Then: Range violations produce validation errors
```

#### VND-005: OperatingHoursValidation

```
Test: Operating hours validate correctly
Given: OperatingHours definitions
When: Schema validation is performed:
  - { "startHour": 0, "endHour": 23 } → passes
  - { "startHour": 9, "endHour": 17 } → passes
  - { "startHour": 20, "endHour": 4 } → passes (overnight)
  - { "startHour": -1, "endHour": 17 } → fails
  - { "startHour": 9, "endHour": 24 } → fails
  - { "closedDays": ["Monday", "Sunday"] } → passes
  - { "closedDays": ["Funday"] } → fails
Then: Hour ranges and day enums validated correctly
```

---

## 16. Use Cases

### UC-001: Load Vendor Configuration

```
┌─────────────────────────────────────────────────────────────────────────────┐
│ UC-001: Load Vendor Configuration                                            │
├─────────────────────────────────────────────────────────────────────────────┤
│ Actors: Game System                                                          │
│ Trigger: Game startup or configuration reload                                │
│ Preconditions: vendors.json exists in config directory                       │
├─────────────────────────────────────────────────────────────────────────────┤
│ Flow:                                                                        │
│ 1. System loads vendors.schema.json                                          │
│ 2. System loads vendors.json                                                 │
│ 3. System validates vendors.json against schema                              │
│ 4. System parses vendor definitions into memory                              │
│ 5. System logs successful load with vendor count                             │
├─────────────────────────────────────────────────────────────────────────────┤
│ Postconditions: Vendor definitions available for queries                     │
│ Exceptions: Invalid JSON → log error, use defaults                           │
└─────────────────────────────────────────────────────────────────────────────┘
```

### UC-002: Retrieve Vendor by ID

```
┌─────────────────────────────────────────────────────────────────────────────┐
│ UC-002: Retrieve Vendor by ID                                                │
├─────────────────────────────────────────────────────────────────────────────┤
│ Actors: Game System, UI                                                      │
│ Trigger: Player interacts with vendor NPC                                    │
│ Preconditions: Vendor configuration loaded                                   │
├─────────────────────────────────────────────────────────────────────────────┤
│ Flow:                                                                        │
│ 1. System receives vendor ID from NPC interaction                            │
│ 2. System queries vendor definitions by ID                                   │
│ 3. System returns matching VendorDefinition                                  │
│ 4. UI displays vendor shop interface                                         │
├─────────────────────────────────────────────────────────────────────────────┤
│ Postconditions: Vendor data available for transaction processing             │
│ Exceptions: Vendor not found → log warning, show error to player             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### UC-003: Calculate Item Price

```
┌─────────────────────────────────────────────────────────────────────────────┐
│ UC-003: Calculate Item Price                                                 │
├─────────────────────────────────────────────────────────────────────────────┤
│ Actors: Game System                                                          │
│ Trigger: Player views item in vendor shop or initiates transaction           │
│ Preconditions: Vendor and item data loaded, player stats available           │
├─────────────────────────────────────────────────────────────────────────────┤
│ Flow:                                                                        │
│ 1. System retrieves item base price                                          │
│ 2. System retrieves vendor price modifiers                                   │
│ 3. System calculates charisma discount (if effect > 0)                       │
│ 4. System calculates persuasion discount (if effect > 0)                     │
│ 5. System calculates reputation discount (if faction linked)                 │
│ 6. System caps total discount at maxDiscount                                 │
│ 7. System applies base multiplier and discount to get final price            │
├─────────────────────────────────────────────────────────────────────────────┤
│ Postconditions: Final price displayed to player                              │
│ Exceptions: Item has priceOverride → use override directly                   │
└─────────────────────────────────────────────────────────────────────────────┘
```

### UC-004: Check Vendor Availability

```
┌─────────────────────────────────────────────────────────────────────────────┐
│ UC-004: Check Vendor Availability                                            │
├─────────────────────────────────────────────────────────────────────────────┤
│ Actors: Game System                                                          │
│ Trigger: Player approaches vendor or time changes                            │
│ Preconditions: Vendor definition loaded, game time available                 │
├─────────────────────────────────────────────────────────────────────────────┤
│ Flow:                                                                        │
│ 1. System retrieves vendor's operatingHours (if defined)                     │
│ 2. If no operatingHours, vendor is always open → return true                 │
│ 3. System gets current game hour and day                                     │
│ 4. System checks if current day is in closedDays → return false              │
│ 5. System checks if current hour is within startHour-endHour                 │
│    (handles overnight wrapping if endHour < startHour)                       │
│ 6. System returns availability status                                        │
├─────────────────────────────────────────────────────────────────────────────┤
│ Postconditions: UI shows vendor as open or closed                            │
│ Exceptions: None                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### UC-005: Trigger Vendor Restock

```
┌─────────────────────────────────────────────────────────────────────────────┐
│ UC-005: Trigger Vendor Restock                                               │
├─────────────────────────────────────────────────────────────────────────────┤
│ Actors: Game System                                                          │
│ Trigger: Timer elapsed, player rests, level up, or manual event              │
│ Preconditions: Vendor has restockRule defined (not "Never")                  │
├─────────────────────────────────────────────────────────────────────────────┤
│ Flow:                                                                        │
│ 1. System identifies vendors matching trigger type                           │
│ 2. For each matching vendor:                                                 │
│    a. Iterate through inventory items                                        │
│    b. Skip items with stockQuantity = -1 (infinite)                          │
│    c. Skip rare items if restockRareItems = false                            │
│    d. Calculate restock amount: (maxStock - current) × restockPercentage     │
│    e. Add restock amount to current stock                                    │
│ 3. System logs restock completion                                            │
├─────────────────────────────────────────────────────────────────────────────┤
│ Postconditions: Vendor inventory quantities restored                         │
│ Exceptions: restockRule type = "Never" → skip vendor entirely                │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 17. Deliverable Checklist

### Configuration Files

| Status | File | Description |
|--------|------|-------------|
| ☐ | `config/schemas/vendors.schema.json` | Complete JSON Schema for vendor validation |
| ☐ | `config/vendors.json` | Example vendor configuration with 5 vendors |

### Unit Tests

| Status | Test | Description |
|--------|------|-------------|
| ☐ | VND-001 | Valid complete vendor configuration |
| ☐ | VND-002 | Specialty enum validation |
| ☐ | VND-003 | Restock type enum with conditionals |
| ☐ | VND-004 | Price modifier range validation |
| ☐ | VND-005 | Operating hours validation |

### Documentation

| Status | Document | Description |
|--------|----------|-------------|
| ☑ | Design Specification | This document |
| ☐ | Schema Documentation | Inline in schema file |

---

## 18. Acceptance Criteria

### Functional Criteria

- [ ] `vendors.schema.json` created in `config/schemas/`
- [ ] Schema validates with sample vendors
- [ ] Specialty enum validated (10 specialties)
- [ ] Inventory items validated with item references
- [ ] Stock quantity validated (-1 for infinite)
- [ ] Price modifiers validated with multipliers
- [ ] Restock rule validated with type enum
- [ ] Accepted currencies validated as array
- [ ] Reputation and dialogue references validated
- [ ] Operating hours validated
- [ ] ~5 unit tests pass

### Quality Criteria

- [ ] Schema follows JSON Schema Draft-07 specification
- [ ] All IDs follow kebab-case pattern `^[a-z][a-z0-9-]*$`
- [ ] All enums explicitly documented
- [ ] Example vendors.json validates against schema
- [ ] Schema includes descriptive comments
- [ ] Conditional validation works (timerTurns required for Timer type)

### Integration Criteria

- [ ] Schema references currency IDs from v0.14.5a
- [ ] Schema follows patterns from previous v0.14.5 schemas
- [ ] Configuration structure consistent with existing files

---

## 19. Dependencies

### Required From

| Version | Dependency | Usage |
|---------|------------|-------|
| v0.14.4 | Environment Configuration Schemas | Schema infrastructure |
| v0.14.5a | `currency.schema.json` | Currency ID references |
| Existing | `items.json` | Item ID references |

### Provides To

| Version | Consumer | Usage |
|---------|----------|-------|
| Future | VendorService | Vendor data loading |
| Future | ShopUI | Vendor display data |
| Future | TransactionService | Price calculations |
| Future | RestockService | Inventory refresh |

---

## 20. Future Considerations

### Deferred to Later Versions

| Feature | Rationale |
|---------|-----------|
| Transaction execution logic | Runtime concern, not configuration |
| Dynamic pricing events | Requires event system integration |
| Vendor relationship tracking | Player state, not static configuration |
| Haggling mini-game support | Gameplay feature beyond configuration |
| Vendor quest integration | Requires quest system |
| Stolen goods fence mechanics | Specialized vendor type |
| Auction house vendors | Different transaction model |

### Potential Enhancements

| Enhancement | Description |
|-------------|-------------|
| Seasonal inventory | Items available only during certain seasons |
| Weather-dependent pricing | Prices affected by in-game weather |
| Supply and demand | Prices affected by player trading patterns |
| Vendor mood/disposition | Transient state affecting prices |
| Bulk discount tiers | Price breaks for large purchases |
| Loyalty programs | Returning customer discounts |

---

## Appendix A: Schema Validation Examples

### Valid Vendor (Minimal)

```json
{
  "id": "simple-vendor",
  "name": "Simple Shop",
  "description": "A basic vendor.",
  "specialty": "General",
  "inventory": [],
  "priceModifiers": {}
}
```

### Valid Vendor (Complete)

```json
{
  "id": "complete-vendor",
  "name": "Complete Shop",
  "title": "Master Merchant",
  "description": "A fully configured vendor.",
  "specialty": "Exotic",
  "inventory": [
    {
      "itemId": "rare-item",
      "itemType": "Item",
      "stockQuantity": 1,
      "priceOverride": 1000,
      "buyPriceMultiplier": 1.5,
      "sellPriceMultiplier": 0.8,
      "requiredLevel": 20,
      "requiredReputationLevel": 5,
      "isRare": true
    }
  ],
  "priceModifiers": {
    "baseBuyMultiplier": 1.5,
    "baseSellMultiplier": 0.7,
    "charismaEffect": 0.01,
    "persuasionEffect": 0.02,
    "reputationEffect": 0.05,
    "maxDiscount": 0.35
  },
  "restockRule": {
    "type": "Timer",
    "timerTurns": 100,
    "restockPercentage": 0.5,
    "restockRareItems": true
  },
  "acceptedCurrencies": ["gold", "silver", "gems"],
  "reputationFactionId": "merchants-guild",
  "dialogueStartId": "exotic-merchant-greeting",
  "locationId": "hidden-market",
  "operatingHours": {
    "startHour": 22,
    "endHour": 4,
    "closedDays": ["Sunday"]
  },
  "sortOrder": 99
}
```

### Invalid Examples

```json
// Invalid: Missing required field
{
  "id": "missing-name",
  "description": "No name provided.",
  "specialty": "General",
  "inventory": [],
  "priceModifiers": {}
}
// Error: Missing required property 'name'

// Invalid: Bad ID pattern
{
  "id": "Invalid-ID",
  "name": "Bad ID",
  "description": "Uppercase in ID.",
  "specialty": "General",
  "inventory": [],
  "priceModifiers": {}
}
// Error: 'id' does not match pattern '^[a-z][a-z0-9-]*$'

// Invalid: maxDiscount too high
{
  "id": "bad-discount",
  "name": "Discount Vendor",
  "description": "Invalid discount.",
  "specialty": "General",
  "inventory": [],
  "priceModifiers": {
    "maxDiscount": 0.95
  }
}
// Error: 'maxDiscount' must be <= 0.9

// Invalid: Timer without timerTurns
{
  "id": "bad-timer",
  "name": "Timer Vendor",
  "description": "Missing timer turns.",
  "specialty": "General",
  "inventory": [],
  "priceModifiers": {},
  "restockRule": {
    "type": "Timer"
  }
}
// Error: 'timerTurns' is required when type is 'Timer'
```

---

*End of v0.14.5d Design Specification*
