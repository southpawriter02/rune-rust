# v0.15.4c Design Specification: ICE Countermeasures

**Version:** 0.15.4c
**Theme:** ICE Countermeasures (Intrusion Countermeasures Electronics)
**Author:** Claude
**Created:** 2026-01-17
**Status:** Draft
**Prerequisites:** v0.15.0 Complete (Dice Pool Refactor), v0.15.1 Complete (Skill Infrastructure), v0.15.4a Complete (Lockpicking System), v0.15.4b Complete (Terminal Hacking System)

---

## Table of Contents

1. [Executive Summary](#1-executive-summary)
2. [Feature Overview](#2-feature-overview)
3. [Architecture Diagrams](#3-architecture-diagrams)
4. [IceType Enum](#4-icetype-enum)
5. [IceEncounter Value Object](#5-iceencounter-value-object)
6. [IceResolutionResult Value Object](#6-iceresolutionresult-value-object)
7. [IceCountermeasureService](#7-icecountermeasureservice-implementation)
8. [Integration with Terminal Hacking](#8-integration-with-terminal-hacking)
9. [Data Model Changes](#9-data-model-changes)
10. [Configuration Files](#10-configuration-files)
11. [Logging Specifications](#11-logging-specifications)
12. [Unit Testing Requirements](#12-unit-testing-requirements)
13. [Use Cases](#13-use-cases)
14. [Deliverable Checklist](#14-deliverable-checklist)
15. [Acceptance Criteria](#15-acceptance-criteria)
16. [Dependencies](#16-dependencies)
17. [Future Considerations](#17-future-considerations)
18. [Document Metadata](#18-document-metadata)

---

## 1. Executive Summary

### 1.1 Purpose

This document provides a comprehensive design specification for v0.15.4c, the ICE Countermeasures system. This phase implements the defensive AI programs that protect secured terminals in Aethelgard, creating hostile digital encounters during terminal hacking attempts.

ICE (Intrusion Countermeasures Electronics) in Aethelgard represents ancient automated defense systems that the cargo cult inhabitants neither understand nor control. These programs are remnants of Old World security—terrifying, incomprehensible entities that characters must evade, defeat, or endure. The system supports:

1. **ICE Classification**: Three ICE types—Passive (Trace), Active (Attack), and Lethal (Neural)
2. **Terminal-Based ICE Ratings**: ICE strength (12-24) scales with terminal security level
3. **Contested Resolution**: Bypass skill vs. ICE rating for Passive and Active ICE
4. **Lethal Consequences**: Neural ICE inflicts psychic damage and stress on failure
5. **Layer 2 Trigger**: ICE primarily activates on Layer 2 (Authentication) failures

### 1.2 Key Deliverables

| Category | Items |
|----------|-------|
| **Enums** | `IceType`, `IceResolutionOutcome` |
| **Value Objects** | `IceEncounter`, `IceResolutionResult` |
| **Services** | `IIceCountermeasureService`, `IceCountermeasureService` |
| **Configuration** | `ice-types.json` |
| **Tests** | ~3 new unit tests |

### 1.3 Architectural Significance

This version establishes the **hostile encounter pattern** for digital threats:

- **Contested checks**: ICE vs. character's System Bypass skill
- **Damage/stress integration**: Lethal ICE connects to the psychic damage and stress systems
- **Cascading consequences**: ICE outcomes affect the parent terminal hacking state
- **Thematic horror**: Ancient, incomprehensible digital entities reinforce Aethelgard's cargo cult atmosphere

---

## 2. Feature Overview

```
v0.15.4c ICE Countermeasures
├── ICE Classification
│   ├── IceType enum (3 types)
│   ├── ICE ratings by terminal security (12-24)
│   └── ICE activation triggers
├── ICE Encounter Tracking
│   ├── IceEncounter value object
│   ├── Encounter state (triggered, resolved)
│   └── Integration with TerminalInfiltrationState
├── ICE Resolution
│   ├── Contested Bypass vs. ICE Rating
│   ├── WILL save for Lethal ICE
│   └── IceResolutionResult value object
├── ICE Consequences
│   ├── Passive: Location revealed
│   ├── Active: Forced disconnect
│   └── Lethal: Psychic damage + stress
└── Service Integration
    ├── IceCountermeasureService
    ├── Hooks into TerminalHackingService
    └── Damage/stress application
```

---

## 3. Architecture Diagrams

### 3.1 ICE Activation Flow

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                          ICE ACTIVATION FLOW                                 │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  Layer 2 Authentication Failure Detected                                    │
│           │                                                                  │
│           ▼                                                                  │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │                    1. CHECK FOR ICE PRESENCE                         │    │
│  ├─────────────────────────────────────────────────────────────────────┤    │
│  │                                                                      │    │
│  │  Terminal Type       │ ICE Present? │ ICE Type       │ ICE Rating   │    │
│  │  ────────────────────┼──────────────┼────────────────┼──────────────│    │
│  │  CivilianDataPort    │ No           │ —              │ —            │    │
│  │  CorporateMainframe  │ Yes          │ Passive        │ 12           │    │
│  │  SecurityHub         │ Yes          │ Active         │ 16           │    │
│  │  MilitaryServer      │ Yes          │ Active+Lethal  │ 20           │    │
│  │  JotunArchive        │ Yes          │ Lethal         │ 24           │    │
│  │  GlitchedManifold    │ Maybe        │ Varies         │ Unpredictable│    │
│  │                                                                      │    │
│  │  This terminal: SecurityHub → Active ICE, Rating 16                 │    │
│  │                                                                      │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
│           │ (ICE present)                                                    │
│           ▼                                                                  │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │                    2. CREATE ICE ENCOUNTER                           │    │
│  ├─────────────────────────────────────────────────────────────────────┤    │
│  │                                                                      │    │
│  │  IceEncounter                                                        │    │
│  │  ├── EncounterId: "ice-enc-001"                                     │    │
│  │  ├── IceType: Active                                                │    │
│  │  ├── IceRating: 16                                                  │    │
│  │  ├── Triggered: true                                                │    │
│  │  └── EncounterResult: Pending                                       │    │
│  │                                                                      │    │
│  │  Add to TerminalInfiltrationState.IceEncounters                     │    │
│  │                                                                      │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
│           │                                                                  │
│           ▼                                                                  │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │                    3. DISPLAY ICE ACTIVATION                         │    │
│  ├─────────────────────────────────────────────────────────────────────┤    │
│  │                                                                      │    │
│  │  "The terminal screen fractures into static. Something stirs in the │    │
│  │   data-stream—an ancient guardian program, coiling with malevolent  │    │
│  │   purpose. Active ICE detected. It's hunting you."                  │    │
│  │                                                                      │    │
│  │   [Active ICE Activated - Rating 16]                                │    │
│  │                                                                      │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
│           │                                                                  │
│           ▼                                                                  │
│       PROCEED TO ICE RESOLUTION (see 3.2)                                   │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 3.2 ICE Resolution Flow - Passive (Trace)

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                    PASSIVE ICE RESOLUTION (TRACE)                            │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  ICE Type: Passive (Trace)                                                  │
│  Purpose: Reveal hacker's physical location                                 │
│           │                                                                  │
│           ▼                                                                  │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │                    1. CONTESTED CHECK                                │    │
│  ├─────────────────────────────────────────────────────────────────────┤    │
│  │                                                                      │    │
│  │  Character's System Bypass Check:                                   │    │
│  │  ├── Dice Pool: Attribute + Skill Rank + Modifiers                 │    │
│  │  ├── Roll: Count successes (8-10 = success, 1 = botch)             │    │
│  │  └── Net Successes: Successes - Botches                            │    │
│  │                                                                      │    │
│  │  ICE Rating Check:                                                  │    │
│  │  ├── Convert Rating to success-counting DC                          │    │
│  │  │   (Rating 12 → DC 2, Rating 16 → DC 2-3, etc.)                  │    │
│  │  └── ICE "rolls" a static value based on rating                    │    │
│  │                                                                      │    │
│  │  Resolution: Character Net Successes vs. ICE DC                    │    │
│  │                                                                      │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
│           │                                                                  │
│           ├──── Character Wins (Net Successes ≥ ICE DC) ────────────────┐   │
│           │                                                              │   │
│           ▼                                                              ▼   │
│  ┌─────────────────────────────┐     ┌─────────────────────────────────┐    │
│  │     ICE LOSES               │     │     CHARACTER EVADES            │    │
│  ├─────────────────────────────┤     ├─────────────────────────────────┤    │
│  │                             │     │                                  │    │
│  │  Location Revealed:         │     │  Trace Evaded:                  │    │
│  │  ├── Physical location      │     │  ├── ICE loses tracking        │    │
│  │  │   broadcast to security  │     │  ├── Continue infiltration     │    │
│  │  ├── Alert level +2         │     │  └── No consequence            │    │
│  │  └── Nearby guards alerted  │     │                                  │    │
│  │                             │     │  "You slip through the trace    │    │
│  │  "The ICE locks onto your   │     │   like smoke through fingers.   │    │
│  │   neural signature. Your    │     │   The guardian program spins    │    │
│  │   location pulses on        │     │   in confusion, losing your     │    │
│  │   security displays."       │     │   trail."                       │    │
│  │                             │     │                                  │    │
│  └─────────────────────────────┘     └─────────────────────────────────┘    │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 3.3 ICE Resolution Flow - Active (Attack)

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                    ACTIVE ICE RESOLUTION (ATTACK)                            │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  ICE Type: Active (Attack)                                                  │
│  Purpose: Force disconnect from terminal                                    │
│           │                                                                  │
│           ▼                                                                  │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │                    1. CONTESTED CHECK                                │    │
│  ├─────────────────────────────────────────────────────────────────────┤    │
│  │                                                                      │    │
│  │  Same contested check as Passive ICE:                               │    │
│  │  Character's System Bypass vs. ICE Rating                           │    │
│  │                                                                      │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
│           │                                                                  │
│           ├──── Character Wins ───────────────────────────────────────┐     │
│           │                                                            │     │
│           ▼                                                            ▼     │
│  ┌─────────────────────────────┐     ┌─────────────────────────────────┐    │
│  │     ICE LOSES               │     │     CHARACTER WINS              │    │
│  ├─────────────────────────────┤     ├─────────────────────────────────┤    │
│  │                             │     │                                  │    │
│  │  Forced Disconnect:         │     │  ICE Disabled:                  │    │
│  │  ├── Connection severed     │     │  ├── ICE program crashes       │    │
│  │  ├── Terminal locked out    │     │  ├── Continue infiltration     │    │
│  │  │   for 1 minute           │     │  ├── ICE won't reactivate      │    │
│  │  ├── Alert level +1         │     │  └── Gain +1d10 on next layer  │    │
│  │  └── Must start from        │     │                                  │    │
│  │      Layer 1 again          │     │  "The ICE lunges—but you're     │    │
│  │                             │     │   faster. Your countermeasures  │    │
│  │  "The ICE strikes like a    │     │   fragment the program into     │    │
│  │   viper. Your connection    │     │   harmless data streams. The    │    │
│  │   shatters—you're thrown    │     │   path is clear."               │    │
│  │   back to reality, neural   │     │                                  │    │
│  │   interfaces screaming."    │     │                                  │    │
│  │                             │     │                                  │    │
│  └─────────────────────────────┘     └─────────────────────────────────┘    │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 3.4 ICE Resolution Flow - Lethal (Neural)

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                    LETHAL ICE RESOLUTION (NEURAL)                            │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  ICE Type: Lethal (Neural)                                                  │
│  Purpose: Inflict psychic damage and stress through neural interface        │
│           │                                                                  │
│           ▼                                                                  │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │                    1. WILL SAVE (NOT CONTESTED)                      │    │
│  ├─────────────────────────────────────────────────────────────────────┤    │
│  │                                                                      │    │
│  │  Lethal ICE bypasses skill contests—it attacks the mind directly    │    │
│  │                                                                      │    │
│  │  WILL Save:                                                          │    │
│  │  ├── Attribute: WILL (Willpower)                                    │    │
│  │  ├── DC: 16 (fixed for all Lethal ICE)                              │    │
│  │  └── Standard success-counting rules                                │    │
│  │                                                                      │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
│           │                                                                  │
│           ├──── Save Succeeds ────────────────────────────────────────┐     │
│           │                                                            │     │
│           ▼                                                            ▼     │
│  ┌─────────────────────────────┐     ┌─────────────────────────────────┐    │
│  │     SAVE FAILED             │     │     SAVE SUCCEEDED              │    │
│  ├─────────────────────────────┤     ├─────────────────────────────────┤    │
│  │                             │     │                                  │    │
│  │  Full Neural Strike:        │     │  Partial Escape:                │    │
│  │  ├── 3d10 psychic damage    │     │  ├── Auto-disconnect           │    │
│  │  ├── 2d6 stress             │     │  ├── 1d6 stress                 │    │
│  │  ├── Auto-disconnect        │     │  ├── Terminal locked 1 minute  │    │
│  │  ├── Terminal locked out    │     │  └── May retry after lockout   │    │
│  │  │   permanently            │     │                                  │    │
│  │  └── Possible conditions:   │     │  "You feel the neural strike   │    │
│  │      [Disoriented],         │     │   incoming—ancient malice       │    │
│  │      [Bleeding Eyes]        │     │   reaching for your mind. You   │    │
│  │                             │     │   tear yourself free just in    │    │
│  │  "The Lethal ICE bypasses   │     │   time, gasping, shaking. The   │    │
│  │   every defense. Ancient    │     │   connection severs."           │    │
│  │   code burns through your   │     │                                  │    │
│  │   neural pathways like      │     │   [1d6 Stress gained]           │    │
│  │   acid. You scream as your  │     │                                  │    │
│  │   vision fills with static  │     │                                  │    │
│  │   and blood."               │     │                                  │    │
│  │                             │     │                                  │    │
│  │   [3d10 Psychic Damage]     │     │                                  │    │
│  │   [2d6 Stress]              │     │                                  │    │
│  │                             │     │                                  │    │
│  └─────────────────────────────┘     └─────────────────────────────────┘    │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 3.5 Layer Architecture

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           LAYER ARCHITECTURE                                 │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │                      DOMAIN LAYER                                    │    │
│  ├─────────────────────────────────────────────────────────────────────┤    │
│  │                                                                      │    │
│  │  Enums/                                                              │    │
│  │  ├── IceType.cs              ←── NEW (ICE classification)           │    │
│  │  └── IceResolutionOutcome.cs ←── NEW (encounter result)             │    │
│  │                                                                      │    │
│  │  ValueObjects/                                                       │    │
│  │  ├── IceEncounter.cs         ←── NEW (encounter tracking)           │    │
│  │  └── IceResolutionResult.cs  ←── NEW (resolution outcome)           │    │
│  │                                                                      │    │
│  │  Entities/                                                           │    │
│  │  └── TerminalInfiltrationState.cs  ←── MODIFIED (add IceEncounters) │    │
│  │                                                                      │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
│                                                                              │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │                      SERVICE LAYER                                   │    │
│  ├─────────────────────────────────────────────────────────────────────┤    │
│  │                                                                      │    │
│  │  Interfaces/                                                         │    │
│  │  └── IIceCountermeasureService.cs  ←── NEW                          │    │
│  │                                                                      │    │
│  │  Services/                                                           │    │
│  │  ├── IceCountermeasureService.cs   ←── NEW (ICE resolution)         │    │
│  │  └── TerminalHackingService.cs     ←── MODIFIED (integrate ICE)     │    │
│  │                                                                      │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
│                                                                              │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │                      CONFIGURATION                                   │    │
│  ├─────────────────────────────────────────────────────────────────────┤    │
│  │                                                                      │    │
│  │  Configuration/                                                      │    │
│  │  └── ice-types.json          ←── NEW (ICE definitions)              │    │
│  │                                                                      │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 4. IceType Enum

### 4.1 Specification

```csharp
/// <summary>
/// Defines the three categories of ICE (Intrusion Countermeasures Electronics)
/// that protect secured terminals in Aethelgard.
/// </summary>
/// <remarks>
/// ICE types represent increasingly hostile automated defense systems:
/// - Passive ICE observes and reports
/// - Active ICE directly interferes with intrusion attempts
/// - Lethal ICE attacks the intruder's mind through neural interfaces
///
/// Higher-security terminals may have multiple ICE types active simultaneously
/// (e.g., Military Servers have both Active and Lethal ICE).
/// </remarks>
public enum IceType
{
    /// <summary>
    /// Trace ICE that attempts to reveal the hacker's physical location.
    /// Resolution: Contested System Bypass vs. ICE Rating.
    /// Failure: Location broadcast to security systems.
    /// </summary>
    Passive = 0,

    /// <summary>
    /// Attack ICE that attempts to force disconnect the intruder.
    /// Resolution: Contested System Bypass vs. ICE Rating.
    /// Failure: Connection severed, terminal locked out temporarily.
    /// </summary>
    Active = 1,

    /// <summary>
    /// Neural ICE that attacks the intruder's mind through their interface.
    /// Resolution: WILL save DC 16 (not a contested check).
    /// Failure: 3d10 psychic damage + 2d6 stress, permanent lockout.
    /// Success: Auto-disconnect + 1d6 stress, temporary lockout.
    /// </summary>
    Lethal = 2
}
```

### 4.2 ICE Type Summary Table

| Type | Resolution | On Win | On Lose |
|------|------------|--------|---------|
| **Passive** | Contested Bypass vs. ICE Rating | Evade detection | Location revealed, Alert +2 |
| **Active** | Contested Bypass vs. ICE Rating | ICE disabled, +1d10 next layer | Forced disconnect, 1 min lockout |
| **Lethal** | WILL save DC 16 | Auto-disconnect, 1d6 stress | 3d10 psychic, 2d6 stress, permanent lockout |

---

## 5. IceEncounter Value Object

### 5.1 Specification

```csharp
/// <summary>
/// Represents an ICE encounter during terminal hacking, tracking the state
/// from activation through resolution.
/// </summary>
/// <param name="EncounterId">Unique identifier for this ICE encounter.</param>
/// <param name="IceType">The type of ICE encountered (Passive, Active, Lethal).</param>
/// <param name="IceRating">The difficulty rating of the ICE (12-24).</param>
/// <param name="Triggered">Whether the ICE has been activated.</param>
/// <param name="EncounterResult">The outcome of the encounter (Pending, Won, Lost, Evaded).</param>
public readonly record struct IceEncounter(
    string EncounterId,
    IceType IceType,
    int IceRating,
    bool Triggered,
    IceResolutionOutcome EncounterResult)
{
    /// <summary>
    /// Creates a new triggered ICE encounter with pending resolution.
    /// </summary>
    /// <param name="iceType">The type of ICE.</param>
    /// <param name="iceRating">The ICE's difficulty rating.</param>
    /// <returns>A new IceEncounter in triggered, pending state.</returns>
    public static IceEncounter CreateTriggered(IceType iceType, int iceRating)
    {
        return new IceEncounter(
            EncounterId: Guid.NewGuid().ToString(),
            IceType: iceType,
            IceRating: iceRating,
            Triggered: true,
            EncounterResult: IceResolutionOutcome.Pending
        );
    }

    /// <summary>
    /// Creates a copy of this encounter with an updated resolution outcome.
    /// </summary>
    /// <param name="outcome">The resolution outcome.</param>
    /// <returns>A new IceEncounter with the specified outcome.</returns>
    public IceEncounter WithOutcome(IceResolutionOutcome outcome)
    {
        return this with { EncounterResult = outcome };
    }

    /// <summary>
    /// Whether this encounter is still awaiting resolution.
    /// </summary>
    public bool IsPending => EncounterResult == IceResolutionOutcome.Pending;

    /// <summary>
    /// Whether the character successfully dealt with this ICE.
    /// </summary>
    public bool WasSuccessful => EncounterResult is IceResolutionOutcome.CharacterWon
                                                  or IceResolutionOutcome.Evaded;

    /// <summary>
    /// Converts the ICE rating to a success-counting DC.
    /// </summary>
    public int GetDc()
    {
        // Standard conversion: Rating / 6, rounded up, minimum 1
        return Math.Max(1, (int)Math.Ceiling(IceRating / 6.0));
    }

    /// <summary>
    /// Returns a display string for the ICE encounter.
    /// </summary>
    public string ToDisplayString()
    {
        var typeStr = IceType switch
        {
            IceType.Passive => "Passive (Trace)",
            IceType.Active => "Active (Attack)",
            IceType.Lethal => "Lethal (Neural)",
            _ => IceType.ToString()
        };
        return $"{typeStr} ICE - Rating {IceRating}";
    }
}
```

### 5.2 IceResolutionOutcome Enum

```csharp
/// <summary>
/// The possible outcomes of an ICE encounter resolution.
/// </summary>
public enum IceResolutionOutcome
{
    /// <summary>
    /// Encounter has not yet been resolved.
    /// </summary>
    Pending = 0,

    /// <summary>
    /// Character won the contested check or save.
    /// ICE is disabled or evaded.
    /// </summary>
    CharacterWon = 1,

    /// <summary>
    /// Character lost the contested check or failed the save.
    /// ICE consequences apply.
    /// </summary>
    IceWon = 2,

    /// <summary>
    /// Character successfully evaded the ICE (Passive only).
    /// No consequences, ICE may re-trigger.
    /// </summary>
    Evaded = 3
}
```

---

## 6. IceResolutionResult Value Object

### 6.1 Specification

```csharp
/// <summary>
/// The complete result of resolving an ICE encounter, including all
/// mechanical consequences.
/// </summary>
/// <param name="Encounter">The ICE encounter that was resolved.</param>
/// <param name="Outcome">The outcome of the resolution (CharacterWon, IceWon, Evaded).</param>
/// <param name="CharacterRoll">The character's roll result (successes - botches).</param>
/// <param name="IceDc">The ICE's effective DC (for contested) or save DC (for Lethal).</param>
/// <param name="PsychicDamage">Psychic damage dealt (Lethal ICE only).</param>
/// <param name="StressGained">Stress points gained.</param>
/// <param name="LocationRevealed">Whether the character's location was revealed (Passive ICE).</param>
/// <param name="ForcedDisconnect">Whether the character was disconnected (Active/Lethal).</param>
/// <param name="LockoutDuration">Lockout duration in minutes (0 = no lockout, -1 = permanent).</param>
/// <param name="AlertLevelChange">Change to terminal alert level.</param>
/// <param name="BonusDiceGranted">Bonus dice for next layer check (on Active ICE victory).</param>
/// <param name="NarrativeDescription">Flavor text describing the encounter outcome.</param>
public readonly record struct IceResolutionResult(
    IceEncounter Encounter,
    IceResolutionOutcome Outcome,
    int CharacterRoll,
    int IceDc,
    int PsychicDamage,
    int StressGained,
    bool LocationRevealed,
    bool ForcedDisconnect,
    int LockoutDuration,
    int AlertLevelChange,
    int BonusDiceGranted,
    string NarrativeDescription)
{
    /// <summary>
    /// Whether the character won this encounter.
    /// </summary>
    public bool CharacterWon => Outcome is IceResolutionOutcome.CharacterWon
                                        or IceResolutionOutcome.Evaded;

    /// <summary>
    /// Whether this result includes damage that must be applied.
    /// </summary>
    public bool HasDamage => PsychicDamage > 0;

    /// <summary>
    /// Whether this result includes stress that must be applied.
    /// </summary>
    public bool HasStress => StressGained > 0;

    /// <summary>
    /// Whether the terminal is permanently locked out.
    /// </summary>
    public bool IsPermanentLockout => LockoutDuration == -1;

    /// <summary>
    /// Creates a successful resolution for Passive ICE (evaded trace).
    /// </summary>
    public static IceResolutionResult PassiveEvaded(IceEncounter encounter, int characterRoll, int iceDc)
    {
        return new IceResolutionResult(
            Encounter: encounter.WithOutcome(IceResolutionOutcome.Evaded),
            Outcome: IceResolutionOutcome.Evaded,
            CharacterRoll: characterRoll,
            IceDc: iceDc,
            PsychicDamage: 0,
            StressGained: 0,
            LocationRevealed: false,
            ForcedDisconnect: false,
            LockoutDuration: 0,
            AlertLevelChange: 0,
            BonusDiceGranted: 0,
            NarrativeDescription: "You slip through the trace like smoke through fingers. " +
                                  "The guardian program spins in confusion, losing your trail."
        );
    }

    /// <summary>
    /// Creates a failed resolution for Passive ICE (location revealed).
    /// </summary>
    public static IceResolutionResult PassiveFailed(IceEncounter encounter, int characterRoll, int iceDc)
    {
        return new IceResolutionResult(
            Encounter: encounter.WithOutcome(IceResolutionOutcome.IceWon),
            Outcome: IceResolutionOutcome.IceWon,
            CharacterRoll: characterRoll,
            IceDc: iceDc,
            PsychicDamage: 0,
            StressGained: 0,
            LocationRevealed: true,
            ForcedDisconnect: false,
            LockoutDuration: 0,
            AlertLevelChange: 2,
            BonusDiceGranted: 0,
            NarrativeDescription: "The ICE locks onto your neural signature. Your location " +
                                  "pulses on security displays. They know where you are."
        );
    }

    /// <summary>
    /// Creates a successful resolution for Active ICE (ICE disabled).
    /// </summary>
    public static IceResolutionResult ActiveDefeated(IceEncounter encounter, int characterRoll, int iceDc)
    {
        return new IceResolutionResult(
            Encounter: encounter.WithOutcome(IceResolutionOutcome.CharacterWon),
            Outcome: IceResolutionOutcome.CharacterWon,
            CharacterRoll: characterRoll,
            IceDc: iceDc,
            PsychicDamage: 0,
            StressGained: 0,
            LocationRevealed: false,
            ForcedDisconnect: false,
            LockoutDuration: 0,
            AlertLevelChange: 0,
            BonusDiceGranted: 1,
            NarrativeDescription: "The ICE lunges—but you're faster. Your countermeasures " +
                                  "fragment the program into harmless data streams. The path is clear."
        );
    }

    /// <summary>
    /// Creates a failed resolution for Active ICE (forced disconnect).
    /// </summary>
    public static IceResolutionResult ActiveFailed(IceEncounter encounter, int characterRoll, int iceDc)
    {
        return new IceResolutionResult(
            Encounter: encounter.WithOutcome(IceResolutionOutcome.IceWon),
            Outcome: IceResolutionOutcome.IceWon,
            CharacterRoll: characterRoll,
            IceDc: iceDc,
            PsychicDamage: 0,
            StressGained: 0,
            LocationRevealed: false,
            ForcedDisconnect: true,
            LockoutDuration: 1,
            AlertLevelChange: 1,
            BonusDiceGranted: 0,
            NarrativeDescription: "The ICE strikes like a viper. Your connection shatters—you're " +
                                  "thrown back to reality, neural interfaces screaming."
        );
    }

    /// <summary>
    /// Creates a successful save resolution for Lethal ICE (partial escape).
    /// </summary>
    public static IceResolutionResult LethalSaved(IceEncounter encounter, int characterRoll, int stressRoll)
    {
        return new IceResolutionResult(
            Encounter: encounter.WithOutcome(IceResolutionOutcome.CharacterWon),
            Outcome: IceResolutionOutcome.CharacterWon,
            CharacterRoll: characterRoll,
            IceDc: 16, // Fixed DC for Lethal ICE
            PsychicDamage: 0,
            StressGained: stressRoll, // 1d6
            LocationRevealed: false,
            ForcedDisconnect: true,
            LockoutDuration: 1,
            AlertLevelChange: 0,
            BonusDiceGranted: 0,
            NarrativeDescription: "You feel the neural strike incoming—ancient malice reaching for your mind. " +
                                  "You tear yourself free just in time, gasping, shaking. The connection severs."
        );
    }

    /// <summary>
    /// Creates a failed save resolution for Lethal ICE (full neural strike).
    /// </summary>
    public static IceResolutionResult LethalFailed(IceEncounter encounter, int characterRoll, int damageRoll, int stressRoll)
    {
        return new IceResolutionResult(
            Encounter: encounter.WithOutcome(IceResolutionOutcome.IceWon),
            Outcome: IceResolutionOutcome.IceWon,
            CharacterRoll: characterRoll,
            IceDc: 16, // Fixed DC for Lethal ICE
            PsychicDamage: damageRoll, // 3d10
            StressGained: stressRoll, // 2d6
            LocationRevealed: false,
            ForcedDisconnect: true,
            LockoutDuration: -1, // Permanent
            AlertLevelChange: 2,
            BonusDiceGranted: 0,
            NarrativeDescription: "The Lethal ICE bypasses every defense. Ancient code burns through your neural " +
                                  "pathways like acid. You scream as your vision fills with static and blood."
        );
    }
}
```

---

## 7. IceCountermeasureService Implementation

### 7.1 Interface

```csharp
/// <summary>
/// Service for handling ICE (Intrusion Countermeasures Electronics) encounters
/// during terminal hacking attempts.
/// </summary>
public interface IIceCountermeasureService
{
    /// <summary>
    /// Determines what ICE, if any, protects a terminal based on its type.
    /// </summary>
    /// <param name="terminalType">The type of terminal being accessed.</param>
    /// <returns>List of ICE types present on this terminal (empty if none).</returns>
    IReadOnlyList<IceType> GetIceForTerminal(TerminalType terminalType);

    /// <summary>
    /// Gets the ICE rating for a terminal type.
    /// </summary>
    /// <param name="terminalType">The type of terminal.</param>
    /// <returns>The ICE rating (difficulty) for this terminal's ICE.</returns>
    int GetIceRating(TerminalType terminalType);

    /// <summary>
    /// Triggers an ICE encounter, creating the encounter record.
    /// </summary>
    /// <param name="iceType">The type of ICE activating.</param>
    /// <param name="iceRating">The ICE's difficulty rating.</param>
    /// <returns>A new triggered IceEncounter.</returns>
    IceEncounter TriggerIce(IceType iceType, int iceRating);

    /// <summary>
    /// Resolves an ICE encounter using the appropriate resolution method.
    /// </summary>
    /// <param name="encounter">The ICE encounter to resolve.</param>
    /// <param name="character">The character facing the ICE.</param>
    /// <param name="diceRoller">Dice rolling service for checks.</param>
    /// <returns>The complete resolution result with all consequences.</returns>
    IceResolutionResult ResolveIce(
        IceEncounter encounter,
        Character character,
        IDiceRollerService diceRoller);

    /// <summary>
    /// Applies the consequences of an ICE resolution to the character and terminal state.
    /// </summary>
    /// <param name="result">The resolution result to apply.</param>
    /// <param name="character">The character to apply damage/stress to.</param>
    /// <param name="infiltrationState">The terminal hacking state to update.</param>
    void ApplyIceConsequences(
        IceResolutionResult result,
        Character character,
        TerminalInfiltrationState infiltrationState);
}
```

### 7.2 Implementation

```csharp
/// <summary>
/// Implementation of ICE countermeasure handling for terminal hacking.
/// </summary>
public class IceCountermeasureService : IIceCountermeasureService
{
    private readonly ILogger<IceCountermeasureService> _logger;
    private readonly ISkillCheckService _skillCheckService;
    private readonly IStressService _stressService;
    private readonly IDamageService _damageService;
    private readonly IceConfiguration _config;

    // ICE rating by terminal type (from scope breakdown)
    private static readonly Dictionary<TerminalType, int> IceRatings = new()
    {
        { TerminalType.CivilianDataPort, 0 },    // No ICE
        { TerminalType.CorporateMainframe, 12 },
        { TerminalType.SecurityHub, 16 },
        { TerminalType.MilitaryServer, 20 },
        { TerminalType.JotunArchive, 24 },
        { TerminalType.GlitchedManifold, 0 }      // Variable, handled separately
    };

    // ICE types by terminal type (from scope breakdown)
    private static readonly Dictionary<TerminalType, IceType[]> IceTypes = new()
    {
        { TerminalType.CivilianDataPort, Array.Empty<IceType>() },
        { TerminalType.CorporateMainframe, new[] { IceType.Passive } },
        { TerminalType.SecurityHub, new[] { IceType.Active } },
        { TerminalType.MilitaryServer, new[] { IceType.Active, IceType.Lethal } },
        { TerminalType.JotunArchive, new[] { IceType.Lethal } },
        { TerminalType.GlitchedManifold, Array.Empty<IceType>() } // Unpredictable
    };

    public IceCountermeasureService(
        ILogger<IceCountermeasureService> logger,
        ISkillCheckService skillCheckService,
        IStressService stressService,
        IDamageService damageService,
        IOptions<IceConfiguration> config)
    {
        _logger = logger;
        _skillCheckService = skillCheckService;
        _stressService = stressService;
        _damageService = damageService;
        _config = config.Value;
    }

    /// <inheritdoc />
    public IReadOnlyList<IceType> GetIceForTerminal(TerminalType terminalType)
    {
        if (IceTypes.TryGetValue(terminalType, out var types))
        {
            return types;
        }
        return Array.Empty<IceType>();
    }

    /// <inheritdoc />
    public int GetIceRating(TerminalType terminalType)
    {
        return IceRatings.GetValueOrDefault(terminalType, 0);
    }

    /// <inheritdoc />
    public IceEncounter TriggerIce(IceType iceType, int iceRating)
    {
        var encounter = IceEncounter.CreateTriggered(iceType, iceRating);

        _logger.LogInformation(
            "ICE triggered: Type={IceType}, Rating={Rating}, EncounterId={EncounterId}",
            iceType, iceRating, encounter.EncounterId);

        return encounter;
    }

    /// <inheritdoc />
    public IceResolutionResult ResolveIce(
        IceEncounter encounter,
        Character character,
        IDiceRollerService diceRoller)
    {
        _logger.LogInformation(
            "Resolving ICE encounter: EncounterId={EncounterId}, Type={IceType}",
            encounter.EncounterId, encounter.IceType);

        return encounter.IceType switch
        {
            IceType.Passive => ResolvePassiveIce(encounter, character, diceRoller),
            IceType.Active => ResolveActiveIce(encounter, character, diceRoller),
            IceType.Lethal => ResolveLethalIce(encounter, character, diceRoller),
            _ => throw new ArgumentOutOfRangeException(nameof(encounter.IceType))
        };
    }

    private IceResolutionResult ResolvePassiveIce(
        IceEncounter encounter,
        Character character,
        IDiceRollerService diceRoller)
    {
        // Contested System Bypass vs. ICE Rating
        var skillContext = SkillContext.Create("system-bypass", character.Id);
        var checkResult = _skillCheckService.PerformCheck(
            character,
            skillContext,
            encounter.GetDc());

        if (checkResult.IsSuccess)
        {
            _logger.LogInformation(
                "Passive ICE evaded: CharacterId={CharacterId}, Roll={Roll}, DC={Dc}",
                character.Id, checkResult.NetSuccesses, encounter.GetDc());
            return IceResolutionResult.PassiveEvaded(encounter, checkResult.NetSuccesses, encounter.GetDc());
        }
        else
        {
            _logger.LogWarning(
                "Passive ICE succeeded: CharacterId={CharacterId} location revealed",
                character.Id);
            return IceResolutionResult.PassiveFailed(encounter, checkResult.NetSuccesses, encounter.GetDc());
        }
    }

    private IceResolutionResult ResolveActiveIce(
        IceEncounter encounter,
        Character character,
        IDiceRollerService diceRoller)
    {
        // Contested System Bypass vs. ICE Rating
        var skillContext = SkillContext.Create("system-bypass", character.Id);
        var checkResult = _skillCheckService.PerformCheck(
            character,
            skillContext,
            encounter.GetDc());

        if (checkResult.IsSuccess)
        {
            _logger.LogInformation(
                "Active ICE disabled: CharacterId={CharacterId}",
                character.Id);
            return IceResolutionResult.ActiveDefeated(encounter, checkResult.NetSuccesses, encounter.GetDc());
        }
        else
        {
            _logger.LogWarning(
                "Active ICE succeeded: CharacterId={CharacterId} disconnected",
                character.Id);
            return IceResolutionResult.ActiveFailed(encounter, checkResult.NetSuccesses, encounter.GetDc());
        }
    }

    private IceResolutionResult ResolveLethalIce(
        IceEncounter encounter,
        Character character,
        IDiceRollerService diceRoller)
    {
        // WILL save DC 16 (not a contested check)
        const int LethalIceDc = 16;
        var saveContext = SaveContext.Create("will", character.Id);
        var saveResult = _skillCheckService.PerformSave(
            character,
            saveContext,
            LethalIceDc);

        if (saveResult.IsSuccess)
        {
            // Success: Auto-disconnect + 1d6 stress
            var stressRoll = diceRoller.Roll(1, 6).Total;

            _logger.LogInformation(
                "Lethal ICE save succeeded: CharacterId={CharacterId}, Stress={Stress}",
                character.Id, stressRoll);

            return IceResolutionResult.LethalSaved(encounter, saveResult.NetSuccesses, stressRoll);
        }
        else
        {
            // Failure: 3d10 psychic damage + 2d6 stress
            var damageRoll = diceRoller.Roll(3, 10).Total;
            var stressRoll = diceRoller.Roll(2, 6).Total;

            _logger.LogWarning(
                "Lethal ICE save failed: CharacterId={CharacterId}, Damage={Damage}, Stress={Stress}",
                character.Id, damageRoll, stressRoll);

            return IceResolutionResult.LethalFailed(encounter, saveResult.NetSuccesses, damageRoll, stressRoll);
        }
    }

    /// <inheritdoc />
    public void ApplyIceConsequences(
        IceResolutionResult result,
        Character character,
        TerminalInfiltrationState infiltrationState)
    {
        // Apply psychic damage if any
        if (result.HasDamage)
        {
            _damageService.ApplyDamage(character, result.PsychicDamage, DamageType.Psychic);
            _logger.LogInformation(
                "Applied psychic damage: CharacterId={CharacterId}, Amount={Damage}",
                character.Id, result.PsychicDamage);
        }

        // Apply stress if any
        if (result.HasStress)
        {
            _stressService.AddStress(character, result.StressGained);
            _logger.LogInformation(
                "Applied stress: CharacterId={CharacterId}, Amount={Stress}",
                character.Id, result.StressGained);
        }

        // Update infiltration state
        if (result.ForcedDisconnect)
        {
            infiltrationState.SetDisconnected(result.LockoutDuration);
        }

        if (result.AlertLevelChange > 0)
        {
            infiltrationState.IncreaseAlertLevel(result.AlertLevelChange);
        }

        if (result.IsPermanentLockout)
        {
            infiltrationState.MarkAsLockedOut();
        }

        // Add the resolved encounter to the state
        infiltrationState.AddIceEncounter(result.Encounter);
    }
}
```

---

## 8. Integration with Terminal Hacking

### 8.1 TerminalHackingService Modifications

```csharp
// Add to existing TerminalHackingService from v0.15.4b:

/// <summary>
/// Modified ProcessLayer2Failure to trigger ICE when authentication fails.
/// </summary>
private async Task<LayerResult> ProcessLayer2Failure(
    TerminalInfiltrationState state,
    Character character,
    SkillCheckResult checkResult)
{
    // Get ICE for this terminal type
    var iceTypes = _iceCountermeasureService.GetIceForTerminal(state.TerminalType);

    if (iceTypes.Count == 0)
    {
        // No ICE present, standard failure handling
        return CreateLayer2FailureResult(state, checkResult);
    }

    // Trigger ICE encounters for each ICE type
    var iceRating = _iceCountermeasureService.GetIceRating(state.TerminalType);
    var iceResults = new List<IceResolutionResult>();

    foreach (var iceType in iceTypes)
    {
        var encounter = _iceCountermeasureService.TriggerIce(iceType, iceRating);
        var result = _iceCountermeasureService.ResolveIce(encounter, character, _diceRoller);

        _iceCountermeasureService.ApplyIceConsequences(result, character, state);
        iceResults.Add(result);

        // If disconnected by ICE, stop processing
        if (result.ForcedDisconnect)
        {
            break;
        }
    }

    return CreateLayer2FailureWithIceResult(state, checkResult, iceResults);
}
```

### 8.2 TerminalInfiltrationState Entity Modifications

```csharp
// Add to existing TerminalInfiltrationState from v0.15.4b:

/// <summary>
/// Collection of ICE encounters during this infiltration attempt.
/// </summary>
public List<IceEncounter> IceEncounters { get; private set; } = new();

/// <summary>
/// Adds a resolved ICE encounter to the state.
/// </summary>
/// <param name="encounter">The resolved encounter to add.</param>
public void AddIceEncounter(IceEncounter encounter)
{
    IceEncounters.Add(encounter);
}

/// <summary>
/// Whether any ICE encounter resulted in the character's location being revealed.
/// </summary>
public bool IsLocationRevealed => IceEncounters.Any(e =>
    e.IceType == IceType.Passive &&
    e.EncounterResult == IceResolutionOutcome.IceWon);

/// <summary>
/// Whether the character was disconnected by ICE.
/// </summary>
public bool WasDisconnectedByIce => IceEncounters.Any(e =>
    e.EncounterResult == IceResolutionOutcome.IceWon &&
    e.IceType is IceType.Active or IceType.Lethal);

/// <summary>
/// Sets the terminal to a disconnected state with a lockout duration.
/// </summary>
/// <param name="lockoutMinutes">Minutes until reconnection allowed (-1 for permanent).</param>
public void SetDisconnected(int lockoutMinutes)
{
    Status = InfiltrationStatus.Disconnected;
    LockoutUntil = lockoutMinutes == -1
        ? DateTime.MaxValue
        : DateTime.UtcNow.AddMinutes(lockoutMinutes);
}

/// <summary>
/// The time until the terminal lockout expires.
/// </summary>
public DateTime? LockoutUntil { get; private set; }
```

---

## 9. Data Model Changes

### 9.1 Summary of Changes

| Entity/VO | Change Type | Description |
|-----------|-------------|-------------|
| `IceType` | New Enum | Passive, Active, Lethal classification |
| `IceResolutionOutcome` | New Enum | Pending, CharacterWon, IceWon, Evaded |
| `IceEncounter` | New Value Object | Tracks individual ICE encounters |
| `IceResolutionResult` | New Value Object | Complete resolution with consequences |
| `TerminalInfiltrationState` | Modified Entity | Added IceEncounters collection |

### 9.2 Database Schema (if applicable)

```sql
-- No new tables required; ICE encounters are stored within TerminalInfiltrationState
-- as a JSON collection for simplicity.

-- If separate table needed in future:
CREATE TABLE IceEncounters (
    EncounterId VARCHAR(36) PRIMARY KEY,
    InfiltrationId VARCHAR(36) NOT NULL,
    IceType INT NOT NULL,
    IceRating INT NOT NULL,
    Triggered BIT NOT NULL,
    EncounterResult INT NOT NULL,
    FOREIGN KEY (InfiltrationId) REFERENCES TerminalInfiltrationStates(InfiltrationId)
);
```

---

## 10. Configuration Files

### 10.1 ice-types.json

```json
{
  "iceTypes": {
    "passive": {
      "id": "passive",
      "displayName": "Passive ICE (Trace)",
      "description": "Attempts to reveal the hacker's physical location",
      "resolutionMethod": "contested",
      "contestedSkill": "system-bypass",
      "onWin": {
        "effect": "evade",
        "description": "You slip through the trace like smoke through fingers."
      },
      "onLose": {
        "effect": "locationRevealed",
        "alertLevelChange": 2,
        "description": "The ICE locks onto your neural signature. Your location pulses on security displays."
      }
    },
    "active": {
      "id": "active",
      "displayName": "Active ICE (Attack)",
      "description": "Attempts to force disconnect the intruder",
      "resolutionMethod": "contested",
      "contestedSkill": "system-bypass",
      "onWin": {
        "effect": "iceDisabled",
        "bonusDice": 1,
        "description": "The ICE lunges—but you're faster. Your countermeasures fragment the program."
      },
      "onLose": {
        "effect": "forcedDisconnect",
        "lockoutMinutes": 1,
        "alertLevelChange": 1,
        "description": "The ICE strikes like a viper. Your connection shatters."
      }
    },
    "lethal": {
      "id": "lethal",
      "displayName": "Lethal ICE (Neural)",
      "description": "Attacks the intruder's mind through neural interface",
      "resolutionMethod": "save",
      "saveAttribute": "will",
      "saveDc": 16,
      "onSaveSuccess": {
        "effect": "autoDisconnect",
        "stressDice": "1d6",
        "lockoutMinutes": 1,
        "description": "You tear yourself free just in time, gasping, shaking."
      },
      "onSaveFail": {
        "effect": "neuralStrike",
        "damageDice": "3d10",
        "damageType": "psychic",
        "stressDice": "2d6",
        "lockoutMinutes": -1,
        "alertLevelChange": 2,
        "description": "Ancient code burns through your neural pathways like acid."
      }
    }
  },
  "terminalIce": {
    "civilianDataPort": {
      "iceTypes": [],
      "iceRating": 0
    },
    "corporateMainframe": {
      "iceTypes": ["passive"],
      "iceRating": 12
    },
    "securityHub": {
      "iceTypes": ["active"],
      "iceRating": 16
    },
    "militaryServer": {
      "iceTypes": ["active", "lethal"],
      "iceRating": 20
    },
    "jotunArchive": {
      "iceTypes": ["lethal"],
      "iceRating": 24
    },
    "glitchedManifold": {
      "iceTypes": [],
      "iceRating": 0,
      "note": "Unpredictable - determined at runtime"
    }
  }
}
```

### 10.2 ICE Descriptors (ice-descriptors.json)

```json
{
  "activationDescriptions": {
    "passive": [
      "The terminal screen fractures into static. Something stirs in the data-stream—an ancient guardian program, sensing your presence.",
      "A cold presence unfolds in the digital space. Trace protocols spin up, hunting for your signature."
    ],
    "active": [
      "The terminal screen fractures into static. Something stirs in the data-stream—an ancient guardian program, coiling with malevolent purpose.",
      "Warning glyphs cascade across the display. Attack ICE awakens—a predator in the machine."
    ],
    "lethal": [
      "The terminal emits a subsonic hum. Neural ICE activates—ancient, hungry, designed to kill.",
      "Reality wavers at the edges. Lethal ICE rises from the code like a wraith, reaching for your mind."
    ]
  },
  "resolutionDescriptions": {
    "passiveEvaded": [
      "You slip through the trace like smoke through fingers. The guardian program spins in confusion, losing your trail.",
      "The trace program grasps at shadows where you used to be. Your digital footprint fades to nothing."
    ],
    "passiveFailed": [
      "The ICE locks onto your neural signature. Your location pulses on security displays. They know where you are.",
      "Your position broadcasts across the security network—a beacon of failure."
    ],
    "activeDefeated": [
      "The ICE lunges—but you're faster. Your countermeasures fragment the program into harmless data streams.",
      "You dance through the attack, leaving corrupted code in your wake. The ICE dissolves."
    ],
    "activeFailed": [
      "The ICE strikes like a viper. Your connection shatters—you're thrown back to reality, neural interfaces screaming.",
      "The attack program hits hard. The world goes white, then black. You're out."
    ],
    "lethalSaved": [
      "You feel the neural strike incoming—ancient malice reaching for your mind. You tear yourself free just in time, gasping, shaking.",
      "The Lethal ICE grazes your consciousness. Pain—but not death. You disconnect before it can finish the job."
    ],
    "lethalFailed": [
      "The Lethal ICE bypasses every defense. Ancient code burns through your neural pathways like acid. You scream as your vision fills with static and blood.",
      "The neural strike hits full force. Your world explodes into pain and alien symbols. Something breaks inside your mind."
    ]
  }
}
```

---

## 11. Logging Specifications

### 11.1 Log Events

| Event | Level | Format |
|-------|-------|--------|
| ICE Triggered | Information | `ICE triggered: Type={IceType}, Rating={Rating}, EncounterId={EncounterId}` |
| ICE Resolution Started | Information | `Resolving ICE encounter: EncounterId={EncounterId}, Type={IceType}` |
| Passive ICE Evaded | Information | `Passive ICE evaded: CharacterId={CharacterId}, Roll={Roll}, DC={Dc}` |
| Passive ICE Succeeded | Warning | `Passive ICE succeeded: CharacterId={CharacterId} location revealed` |
| Active ICE Disabled | Information | `Active ICE disabled: CharacterId={CharacterId}` |
| Active ICE Succeeded | Warning | `Active ICE succeeded: CharacterId={CharacterId} disconnected` |
| Lethal ICE Save Success | Information | `Lethal ICE save succeeded: CharacterId={CharacterId}, Stress={Stress}` |
| Lethal ICE Save Failed | Warning | `Lethal ICE save failed: CharacterId={CharacterId}, Damage={Damage}, Stress={Stress}` |
| Psychic Damage Applied | Information | `Applied psychic damage: CharacterId={CharacterId}, Amount={Damage}` |
| Stress Applied | Information | `Applied stress: CharacterId={CharacterId}, Amount={Stress}` |

### 11.2 Structured Log Properties

```csharp
public static class IceLogProperties
{
    public const string EncounterId = "EncounterId";
    public const string IceType = "IceType";
    public const string IceRating = "IceRating";
    public const string CharacterId = "CharacterId";
    public const string Roll = "Roll";
    public const string Dc = "Dc";
    public const string Damage = "Damage";
    public const string Stress = "Stress";
    public const string Outcome = "Outcome";
}
```

---

## 12. Unit Testing Requirements

### 12.1 Test Summary (~3 tests)

| Test Class | Test Count | Purpose |
|------------|------------|---------|
| `IceCountermeasureServiceTests` | 3 | Core ICE resolution mechanics |

### 12.2 Test Specifications

#### IceCountermeasureServiceTests.cs

```csharp
[TestFixture]
public class IceCountermeasureServiceTests
{
    private IceCountermeasureService _service;
    private Mock<ISkillCheckService> _skillCheckServiceMock;
    private Mock<IStressService> _stressServiceMock;
    private Mock<IDamageService> _damageServiceMock;
    private Mock<IDiceRollerService> _diceRollerMock;
    private Mock<ILogger<IceCountermeasureService>> _loggerMock;

    [SetUp]
    public void SetUp()
    {
        _skillCheckServiceMock = new Mock<ISkillCheckService>();
        _stressServiceMock = new Mock<IStressService>();
        _damageServiceMock = new Mock<IDamageService>();
        _diceRollerMock = new Mock<IDiceRollerService>();
        _loggerMock = new Mock<ILogger<IceCountermeasureService>>();

        _service = new IceCountermeasureService(
            _loggerMock.Object,
            _skillCheckServiceMock.Object,
            _stressServiceMock.Object,
            _damageServiceMock.Object,
            Options.Create(new IceConfiguration()));
    }

    /// <summary>
    /// Verifies that ICE triggers on Layer 2 authentication failure
    /// for terminals that have ICE protection.
    /// </summary>
    [Test]
    public void TriggerIce_OnLayer2Failure_CreatesEncounter()
    {
        // Arrange
        var iceType = IceType.Active;
        var iceRating = 16;

        // Act
        var encounter = _service.TriggerIce(iceType, iceRating);

        // Assert
        Assert.That(encounter.IceType, Is.EqualTo(IceType.Active));
        Assert.That(encounter.IceRating, Is.EqualTo(16));
        Assert.That(encounter.Triggered, Is.True);
        Assert.That(encounter.EncounterResult, Is.EqualTo(IceResolutionOutcome.Pending));
        Assert.That(encounter.EncounterId, Is.Not.Null.And.Not.Empty);
    }

    /// <summary>
    /// Verifies that contested check resolution works correctly for
    /// Passive and Active ICE types.
    /// </summary>
    [Test]
    public void ResolveIce_ContestedCheck_ResolvesCorrectly()
    {
        // Arrange
        var encounter = IceEncounter.CreateTriggered(IceType.Active, 16);
        var character = TestHelpers.CreateTestCharacter();

        // Set up skill check to succeed (net successes >= DC)
        var successResult = new SkillCheckResult(
            NetSuccesses: 3,
            IsSuccess: true,
            IsCritical: false,
            IsFumble: false);

        _skillCheckServiceMock
            .Setup(s => s.PerformCheck(
                It.IsAny<Character>(),
                It.IsAny<SkillContext>(),
                It.IsAny<int>()))
            .Returns(successResult);

        // Act
        var result = _service.ResolveIce(encounter, character, _diceRollerMock.Object);

        // Assert
        Assert.That(result.Outcome, Is.EqualTo(IceResolutionOutcome.CharacterWon));
        Assert.That(result.ForcedDisconnect, Is.False);
        Assert.That(result.BonusDiceGranted, Is.EqualTo(1)); // Active ICE grants +1d10
    }

    /// <summary>
    /// Verifies that Lethal ICE applies psychic damage and stress
    /// when the WILL save fails.
    /// </summary>
    [Test]
    public void ResolveIce_LethalIceFailed_AppliesDamageAndStress()
    {
        // Arrange
        var encounter = IceEncounter.CreateTriggered(IceType.Lethal, 24);
        var character = TestHelpers.CreateTestCharacter();

        // Set up save to fail
        var failedSave = new SkillCheckResult(
            NetSuccesses: 1,
            IsSuccess: false,
            IsCritical: false,
            IsFumble: false);

        _skillCheckServiceMock
            .Setup(s => s.PerformSave(
                It.IsAny<Character>(),
                It.IsAny<SaveContext>(),
                16)) // Lethal ICE DC
            .Returns(failedSave);

        // Set up damage and stress rolls
        _diceRollerMock
            .Setup(d => d.Roll(3, 10))
            .Returns(new DiceResult(Total: 18)); // 3d10 psychic damage

        _diceRollerMock
            .Setup(d => d.Roll(2, 6))
            .Returns(new DiceResult(Total: 7)); // 2d6 stress

        // Act
        var result = _service.ResolveIce(encounter, character, _diceRollerMock.Object);

        // Assert
        Assert.That(result.Outcome, Is.EqualTo(IceResolutionOutcome.IceWon));
        Assert.That(result.PsychicDamage, Is.EqualTo(18));
        Assert.That(result.StressGained, Is.EqualTo(7));
        Assert.That(result.ForcedDisconnect, Is.True);
        Assert.That(result.IsPermanentLockout, Is.True);
    }
}
```

---

## 13. Use Cases

### 13.1 Use Case: Evading Passive ICE

```
SCENARIO: Player evades Passive (Trace) ICE on a Corporate Mainframe

GIVEN:
  - Player is hacking a Corporate Mainframe (Rating 12 Passive ICE)
  - Player fails Layer 2 Authentication check
  - ICE triggers

WHEN:
  - Contested System Bypass check vs. ICE DC
  - Player rolls 4d10: [2, 8, 9, 10] = 3 successes
  - ICE DC: 12 / 6 = 2

THEN:
  - Player wins (3 >= 2)
  - No location revealed
  - No alert level change
  - Player may retry Layer 2
  - Display: "You slip through the trace like smoke through fingers."
```

### 13.2 Use Case: Defeated by Active ICE

```
SCENARIO: Player is disconnected by Active ICE on a Security Hub

GIVEN:
  - Player is hacking a Security Hub (Rating 16 Active ICE)
  - Player fails Layer 2 Authentication check
  - ICE triggers

WHEN:
  - Contested System Bypass check vs. ICE DC
  - Player rolls 3d10: [1, 4, 6] = 0 successes, 1 botch = -1 net
  - ICE DC: 16 / 6 = 3 (rounded up)

THEN:
  - ICE wins (-1 < 3)
  - Forced disconnect
  - 1 minute lockout
  - Alert level +1
  - Must restart from Layer 1 after lockout
  - Display: "The ICE strikes like a viper. Your connection shatters."
```

### 13.3 Use Case: Surviving Lethal ICE

```
SCENARIO: Player survives Lethal ICE on a Jötun Archive

GIVEN:
  - Player is hacking a Jötun Archive (Rating 24 Lethal ICE)
  - Player fails Layer 2 Authentication check
  - Lethal ICE triggers

WHEN:
  - WILL save DC 16
  - Player WILL attribute: 3
  - Player rolls 3d10: [8, 9, 10] = 3 successes
  - Save DC: 16 / 6 = 3 (rounded up)

THEN:
  - Save succeeds (3 >= 3)
  - Auto-disconnect
  - 1d6 stress rolled: 4 stress gained
  - 1 minute lockout
  - May retry after lockout
  - Display: "You tear yourself free just in time, gasping, shaking."
```

### 13.4 Use Case: Neural Strike from Lethal ICE

```
SCENARIO: Player is hit by neural strike from Military Server

GIVEN:
  - Player is hacking a Military Server (Rating 20, Active + Lethal ICE)
  - Player successfully defeats Active ICE
  - Lethal ICE triggers

WHEN:
  - WILL save DC 16
  - Player rolls 2d10: [3, 5] = 0 successes
  - Save fails

THEN:
  - 3d10 psychic damage rolled: 22 damage
  - 2d6 stress rolled: 8 stress
  - Forced disconnect
  - Permanent lockout (terminal bricked)
  - Alert level +2
  - Display: "The Lethal ICE bypasses every defense. Ancient code burns through your neural pathways."
```

---

## 14. Deliverable Checklist

### 14.1 New Files

| File | Purpose | Status |
|------|---------|--------|
| `Enums/IceType.cs` | ICE classification enum | ⬜ Pending |
| `Enums/IceResolutionOutcome.cs` | Resolution outcome enum | ⬜ Pending |
| `ValueObjects/IceEncounter.cs` | ICE encounter tracking | ⬜ Pending |
| `ValueObjects/IceResolutionResult.cs` | Resolution result with consequences | ⬜ Pending |
| `Interfaces/IIceCountermeasureService.cs` | Service interface | ⬜ Pending |
| `Services/IceCountermeasureService.cs` | Service implementation | ⬜ Pending |
| `Configuration/ice-types.json` | ICE definitions | ⬜ Pending |
| `Configuration/ice-descriptors.json` | Narrative text | ⬜ Pending |
| `Tests/IceCountermeasureServiceTests.cs` | Unit tests | ⬜ Pending |

### 14.2 Modified Files

| File | Modification | Status |
|------|--------------|--------|
| `Entities/TerminalInfiltrationState.cs` | Add IceEncounters collection | ⬜ Pending |
| `Services/TerminalHackingService.cs` | Integrate ICE triggering | ⬜ Pending |

---

## 15. Acceptance Criteria

### 15.1 ICE Triggering
- [ ] ICE triggers on Layer 2 authentication failure
- [ ] No ICE triggers on Civilian Data Port terminals
- [ ] Correct ICE type triggers based on terminal type
- [ ] ICE rating matches terminal security level

### 15.2 Contested Resolution
- [ ] Passive ICE uses contested System Bypass vs. ICE Rating
- [ ] Active ICE uses contested System Bypass vs. ICE Rating
- [ ] Character wins when net successes >= ICE DC
- [ ] ICE wins when net successes < ICE DC

### 15.3 Lethal ICE Resolution
- [ ] Lethal ICE uses WILL save DC 16
- [ ] Successful save results in auto-disconnect + 1d6 stress
- [ ] Failed save results in 3d10 psychic damage + 2d6 stress
- [ ] Lethal ICE failure causes permanent terminal lockout

### 15.4 Consequence Application
- [ ] Passive ICE failure reveals location (alert +2)
- [ ] Active ICE failure forces disconnect (1 min lockout, alert +1)
- [ ] Active ICE success grants +1d10 on next layer check
- [ ] All ICE consequences update TerminalInfiltrationState

### 15.5 Testing
- [ ] ~3 unit tests pass
- [ ] All tests verify core mechanics from scope breakdown
- [ ] Build completes with 0 errors
- [ ] Build completes with 0 warnings

---

## 16. Dependencies

### 16.1 Required from Previous Versions

| Type | Source | Usage |
|------|--------|-------|
| `TerminalType` | v0.15.4b | Terminal classification for ICE lookup |
| `TerminalInfiltrationState` | v0.15.4b | State tracking for ICE encounters |
| `SkillContext` | v0.15.1a | Context for bypass checks |
| `SkillCheckResult` | v0.15.1a | Check result structure |
| `DiceRollerService` | v0.15.0 | Dice rolling for damage/stress |
| `StressService` | v0.10.x | Stress application |
| `DamageService` | Core | Damage application |

### 16.2 Provides to Future Phases

| Type | Usage in Future |
|------|-----------------|
| `IceType` | Glitch exploitation in v0.15.4f may interact with ICE |
| `IceEncounter` | Specialization abilities (Jötun-Reader) in v0.15.4i |
| `IceCountermeasureService` | Terminal hacking integration complete |

---

## 17. Future Considerations

### 17.1 Potential Enhancements (Not In Scope)

1. **ICE Evolution**: ICE that learns from previous encounters, increasing difficulty
2. **ICE Variants**: Named/unique ICE programs with special behaviors
3. **ICE Combat**: Extended back-and-forth digital combat rather than single check
4. **ICE Allies**: Friendly ICE that can be awakened or bargained with
5. **Physical Manifestation**: High-rating ICE that can project into reality

### 17.2 Integration Points for v0.15.4i (Specializations)

| Specialization | ICE Interaction |
|----------------|-----------------|
| Jötun-Reader | Gain [Admin-Level] on successful ICE bypass |
| Jötun-Reader | Reduce [Glitched] ICE penalty by 2 |
| Gantry-Runner | No penalty for ICE encounters under fire |

---

## 18. Document Metadata

| Property | Value |
|----------|-------|
| **Version** | 0.15.4c |
| **Author** | Claude |
| **Created** | 2026-01-17 |
| **Last Updated** | 2026-01-17 |
| **Status** | Draft |
| **Review Status** | Pending |
| **Word Count** | ~4,500 |
| **Estimated Tests** | ~3 |

---

*This design specification provides the detailed blueprint for implementing v0.15.4c ICE Countermeasures. The ICE system integrates with the Terminal Hacking System from v0.15.4b, adding hostile digital encounters that create risk and tension during terminal infiltration attempts.*
