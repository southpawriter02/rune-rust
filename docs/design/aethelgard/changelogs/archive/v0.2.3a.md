> **Archived** - This changelog has been consolidated. See the complete version at [v0.2.3](../v0.2.x/v0.2.3.md).

# v0.2.3a Changelog: The Fuel (Resource Management)

**Release Date:** 2025-12-20
**Milestone:** v0.2.3 – The Hero's Toolkit (1 of 3)
**Test Count:** 1470 tests (34 new)

---

## Summary

This release implements the **ResourceService** to manage combat resources (Stamina and Aether). Players now regenerate stamina at the start of each turn, and Mystics can use the **Overcast** mechanic to spend HP when their Aether pool is depleted.

---

## New Features

### Resource Management System (ResourceService)

The core of v0.2.3a is a resource economy that governs ability costs:

| Resource | Regeneration | Special Rules |
|----------|--------------|---------------|
| Stamina  | 5 + (Finesse / 2) per turn | Blocked while Stunned |
| Aether   | None in combat | Mystic Overcast: spend HP at 2:1 ratio |
| Health   | N/A | Spent via Overcast or direct damage |

### Overcast Mechanic (Mystic Archetype)

Mystics can channel abilities beyond their Aether reserves at the cost of their life force:

- When Aether is insufficient, missing AP is converted from HP at **2:1 ratio**
- Overcast is only available if the Mystic would survive the HP cost
- Example: 25 AP ability with 10 current AP → spends 10 AP + 30 HP

### Stamina Regeneration

Combat now features dynamic stamina recovery each turn:

- **Base Regeneration:** 5 stamina per turn
- **Finesse Bonus:** Additional (Finesse / 2) stamina
- **Blocked States:** Stunned combatants do not regenerate
- **Clamping:** Cannot exceed MaxStamina

### Aether Pool (New Character Stat)

Characters now track Aether Points for magical abilities:

- **MaxAp:** 10 + (Will × 5) for Mystics, 0 for non-Mystics
- **CurrentAp:** Does not regenerate during combat
- **Combat Snapshot:** Copied to Combatant at combat start

---

## New Files

| File | Purpose |
|------|---------|
| `RuneAndRust.Core/Enums/ResourceType.cs` | Enum for resource types (Health, Stamina, Aether) |
| `RuneAndRust.Core/Interfaces/IResourceService.cs` | Interface for resource management |
| `RuneAndRust.Engine/Services/ResourceService.cs` | Resource management implementation |
| `RuneAndRust.Tests/Engine/ResourceServiceTests.cs` | 34 unit tests for resource mechanics |

---

## Modified Files

| File | Changes |
|------|---------|
| `RuneAndRust.Core/Entities/Character.cs` | Added `CurrentAp`, `MaxAp` properties |
| `RuneAndRust.Core/Models/Combat/Combatant.cs` | Added `CurrentAp`, `MaxAp` properties; updated `FromCharacter()` |
| `RuneAndRust.Engine/Services/CombatService.cs` | Added `IResourceService` dependency; stamina regen in `NextTurn()` |
| `RuneAndRust.Terminal/Program.cs` | Registered `IResourceService` in DI container |
| `RuneAndRust.Tests/Engine/CombatServiceTests.cs` | Added `IResourceService` mock |

---

## API Changes

### IResourceService Interface

New service contract for resource management:

```csharp
public interface IResourceService
{
    bool CanAfford(Combatant combatant, ResourceType type, int cost);
    bool Deduct(Combatant combatant, ResourceType type, int cost);
    int RegenerateStamina(Combatant combatant);
    int GetCurrent(Combatant combatant, ResourceType type);
    int GetMax(Combatant combatant, ResourceType type);
    bool IsMystic(Combatant combatant);
}
```

### CombatService Constructor (Breaking Change)

The constructor now requires `IResourceService`:

```csharp
// Before (v0.2.2c)
public CombatService(..., ICreatureTraitService traitService, ILogger)

// After
public CombatService(..., ICreatureTraitService traitService, IResourceService resourceService, ILogger)
```

### Character Entity

New properties for Aether management:

```csharp
public int MaxAp { get; set; } = 0;
public int CurrentAp { get; set; } = 0;
```

### Combatant Model

New properties and updated factory method:

```csharp
public int CurrentAp { get; set; }
public int MaxAp { get; set; }

public static Combatant FromCharacter(CharacterEntity c)
{
    // ... now includes CurrentAp and MaxAp
}
```

---

## Test Coverage

### New Tests (34 total)

**CanAfford Tests:**
- `CanAfford_ZeroCost_ReturnsTrue`
- `CanAfford_NegativeCost_ReturnsTrue`
- `CanAfford_Stamina_SufficientStamina_ReturnsTrue`
- `CanAfford_Stamina_InsufficientStamina_ReturnsFalse`
- `CanAfford_Health_SufficientHp_ReturnsTrue`
- `CanAfford_Health_InsufficientHp_ReturnsFalse`
- `CanAfford_Aether_NonMystic_ReturnsFalse`
- `CanAfford_Aether_Mystic_SufficientAp_ReturnsTrue`
- `CanAfford_Aether_Mystic_InsufficientAp_CanOvercast_ReturnsTrue`
- `CanAfford_Aether_Mystic_InsufficientAp_CannotOvercast_ReturnsFalse`
- `CanAfford_Aether_Mystic_ZeroAp_CanOvercast_ReturnsTrue`

**Deduct Tests:**
- `Deduct_ZeroCost_ReturnsTrue`
- `Deduct_Stamina_DeductsCorrectAmount`
- `Deduct_Stamina_InsufficientStamina_ReturnsFalse`
- `Deduct_Health_DeductsCorrectAmount`
- `Deduct_Aether_NormalDeduction`
- `Deduct_Aether_Overcast_SpendsHpAt2To1Ratio`
- `Deduct_Aether_Overcast_FullHpCost`
- `Deduct_Aether_NonMystic_ReturnsFalse`
- `Deduct_SyncsToCharacterSource`

**RegenerateStamina Tests:**
- `RegenerateStamina_AppliesBaseRegen`
- `RegenerateStamina_ClampsToMaxStamina`
- `RegenerateStamina_AtMaxStamina_ReturnsZero`
- `RegenerateStamina_Stunned_ReturnsZero`
- `RegenerateStamina_HighFinesse_IncreaseRegen`
- `RegenerateStamina_SyncsToCharacterSource`

**GetCurrent / GetMax Tests:**
- `GetCurrent_ReturnsCorrectValues`
- `GetMax_ReturnsCorrectValues`

**IsMystic Tests:**
- `IsMystic_MysticArchetype_ReturnsTrue`
- `IsMystic_WarriorArchetype_ReturnsFalse`
- `IsMystic_EnemyCombatant_ReturnsFalse`

**Edge Case Tests:**
- `Deduct_Aether_CanAffordButJustBarely_Succeeds`
- `Deduct_Aether_WouldDieFromOvercast_Fails`
- `Deduct_Stamina_EnemyCombatant_DoesNotSyncToSource`

---

## Logging Matrix

| Event | Level | Template |
|-------|-------|----------|
| Service Init | Information | `"ResourceService initialized"` |
| Affordability Check | Trace | `"[Resource] {Name} checking affordability: {Type} cost {Cost}"` |
| Free Action | Trace | `"[Resource] {Name} checked cost {Cost} for {Type}: free action"` |
| Cannot Afford | Warning | `"[Resource] {Name} cannot afford {Cost} {Type}. Current: {Current}"` |
| Deduction Start | Debug | `"[Resource] {Name} deducting {Cost} {Type}. Before: {Before}"` |
| Deduction Success | Information | `"[Resource] {Name} spent {Cost} {Type}. After: {After}"` |
| Overcast Check | Debug | `"[Resource] {Name} Overcast check: Need {ApCost} AP, have {CurrentAp}..."` |
| Overcast Execution | Warning | `"[Resource] {Name} OVERCASTS! Spent {ApSpent} AP + {HpCost} HP..."` |
| Stamina Regen | Information | `"[Resource] {Name} regenerates {Amount} stamina..."` |
| Stunned Block | Debug | `"[Resource] {Name} is Stunned - no stamina regeneration"` |
| Source Sync | Trace | `"[Resource] Synced {Type} to CharacterSource: {Current}"` |
| Non-Mystic Aether | Debug | `"[Resource] {Name} is not a Mystic - cannot use Aether abilities"` |

---

## Architecture

```
┌─────────────────────┐     ┌──────────────────────┐     ┌─────────────────────┐
│  CombatService      │────▶│   ResourceService    │────▶│   Combatant         │
│  (NextTurn)         │     │   (RegenerateStamina)│     │   - CurrentStamina  │
└─────────────────────┘     └──────────────────────┘     │   - CurrentAp       │
         │                           │                   │   - CurrentHp       │
         │                           ▼                   └─────────────────────┘
         │                  ┌──────────────────────┐              │
         │                  │   Resource Checks:   │              │
         │                  │   - CanAfford()      │              │
         │                  │   - Deduct()         │              │
         │                  │   - IsMystic()       │              │
         │                  └──────────────────────┘              │
         │                                                        │
         ▼                                                        ▼
┌─────────────────────┐                               ┌─────────────────────┐
│  Ability System     │◀──────────────────────────────│   Character Source  │
│  (v0.2.3b - Future) │                               │   (Sync on change)  │
└─────────────────────┘                               └─────────────────────┘
```

### Resource Flow

```
Turn Start
    │
    ▼
┌─────────────────────────────────────────────────────────────────┐
│  RegenerateStamina(combatant)                                   │
│  ├─ Check: IsStunned? → No regen                                │
│  ├─ Calculate: 5 + (Finesse / 2)                                │
│  ├─ Clamp: min(regen, MaxStamina - CurrentStamina)              │
│  └─ Apply + Sync to CharacterSource                             │
└─────────────────────────────────────────────────────────────────┘
    │
    ▼
Player/Enemy Action
    │
    ▼
┌─────────────────────────────────────────────────────────────────┐
│  CanAfford(combatant, ResourceType, cost)                       │
│  ├─ Stamina: CurrentStamina >= cost                             │
│  ├─ Health:  CurrentHp >= cost                                  │
│  └─ Aether:  IsMystic? Can Overcast if HP > (cost-AP)*2        │
└─────────────────────────────────────────────────────────────────┘
    │
    ▼
┌─────────────────────────────────────────────────────────────────┐
│  Deduct(combatant, ResourceType, cost)                          │
│  ├─ Stamina: CurrentStamina -= cost                             │
│  ├─ Health:  CurrentHp -= cost                                  │
│  └─ Aether:  Spend AP first, then HP at 2:1 (Overcast)         │
└─────────────────────────────────────────────────────────────────┘
```

---

## Known Limitations

1. **Aether Initialization**: MaxAp/CurrentAp defaults to 0. Character creation must set these for Mystic archetype.
2. **No Exhausted Status**: Only Stunned blocks stamina regen. Exhausted effect not yet implemented.
3. **Enemy Aether**: Enemies currently have no Aether Pool. Caster enemies use stamina-based attacks.
4. **No UI Display**: Resource values are tracked but not yet displayed in combat UI.

---

## Migration Notes

### For Developers

If you have custom CombatService instantiations, you must now provide an `IResourceService`:

```csharp
// Update your DI registration
services.AddSingleton<IResourceService, ResourceService>();
```

### For Tests

Existing CombatService tests need to mock `IResourceService`:

```csharp
private readonly Mock<IResourceService> _mockResourceService = new Mock<IResourceService>();

// Add to constructor
_mockResourceService.Setup(r => r.RegenerateStamina(It.IsAny<Combatant>())).Returns(0);

_sut = new CombatService(
    _gameState,
    _mockInitiative.Object,
    _mockAttackResolution.Object,
    _mockLootService.Object,
    _mockStatusEffects.Object,
    _mockAIService.Object,
    _mockTraitService.Object,
    _mockResourceService.Object,  // NEW
    _mockLogger.Object);
```

### Character Migration

Existing characters will have MaxAp = 0 and CurrentAp = 0. For Mystic characters, these should be initialized:

```csharp
if (character.Archetype == ArchetypeType.Mystic)
{
    character.MaxAp = 10 + (character.Will * 5);
    character.CurrentAp = character.MaxAp;
}
```

---

## Next Steps (v0.2.3b)

- Implement `IAbilityService` for active ability execution
- Create `Ability` entity with cost definitions
- Integrate ability costs with ResourceService
- Add ability cooldown tracking

---

## Contributors

- Implementation: Claude Opus 4.5
