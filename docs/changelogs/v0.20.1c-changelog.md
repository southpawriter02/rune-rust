# v0.20.1c Changelog: Skjaldmær Tier 3 & Capstone Abilities

**Version:** 0.20.1c
**Phase:** Skjaldmær Mastery & Capstone Abilities
**Date:** 2026-02-09
**Status:** ✅ Complete

---

## Summary

Implements the Skjaldmær specialization's Tier 3 (Mastery) and Capstone abilities: Unbreakable (passive damage reduction), Guardian's Sacrifice (ally damage absorption), and The Wall Lives (invulnerability capstone). Includes the damage pipeline integration, Block Charge resource system prerequisite, and Player entity specialization extensions.

---

## Added

### Domain Layer - Enums

| Enum | Values | Description |
|------|--------|-------------|
| `SkjaldmaerAbilityId` | ShieldWall, Intercept, Bulwark, HoldTheLine, CounterShield, Rally, Unbreakable, GuardiansSacrifice, TheWallLives | All 9 Skjaldmær abilities (T1–Capstone) |

### Domain Layer - Value Objects

| Value Object | Description |
|--------------|-------------|
| `TheWallLivesState` | Manages capstone invulnerability state (3-turn duration, lethal damage prevention) |
| `BlockChargeResource` | Manages Skjaldmær's Block Charge resource (max 3, atomic spend, Bulwark HP bonus) |

#### TheWallLivesState Properties

| Property | Type | Description |
|----------|------|-------------|
| `IsActive` | `bool` | Whether the invulnerability effect is active |
| `TurnsRemaining` | `int` | Turns remaining (starts at 3) |
| `ActivatedAt` | `DateTime` | UTC timestamp of activation |

#### TheWallLivesState Methods

| Method | Description |
|--------|-------------|
| `Activate()` | Enables invulnerability for 3 turns |
| `Tick()` | Decrements turn counter, deactivates at 0 |
| `PreventLethalDamage(currentHp, incomingDamage)` | Caps damage to preserve 1 HP minimum |
| `Deactivate()` | Manually ends the effect |
| `IsExpired()` | Checks if effect has ended |
| `GetRemainingDuration()` | Returns turns remaining |

#### BlockChargeResource Properties

| Property | Type | Description |
|----------|------|-------------|
| `CurrentCharges` | `int` | Current charge count |
| `MaxCharges` | `int` | Maximum charges (default 3) |
| `LastRestoredAt` | `DateTime?` | Last restoration timestamp |

#### BlockChargeResource Methods

| Method | Description |
|--------|-------------|
| `CreateFull(maxCharges)` | Factory for full charges |
| `Spend(amount)` | Atomic charge spend (false if insufficient) |
| `Restore(amount)` | Add charges capped at max |
| `RestoreAll()` | Reset to maximum |
| `GetBulwarkHpBonus()` | Returns `CurrentCharges * 5` |
| `IsModified()` | True if charges below max |

### Domain Layer - Entity Extensions (Player)

| Property/Method | Type | Description |
|-----------------|------|-------------|
| `SpecializationId` | `string?` | Active specialization (e.g., "skjaldmaer") |
| `BlockCharges` | `BlockChargeResource?` | Block Charge resource instance |
| `TheWallLivesState` | `TheWallLivesState?` | Active capstone state |
| `HasUsedCapstoneThisCombat` | `bool` | Once-per-combat capstone flag |
| `CurrentAP` | `int` | Action Points for ability activation |
| `SetSpecialization(id)` | `void` | Sets specialization ID |
| `InitializeBlockCharges()` | `void` | Creates full BlockChargeResource |
| `UnlockAbility(abilityId)` | `void` | Marks ability as learned |
| `HasAbilityUnlocked(abilityId)` | `bool` | Checks if ability is unlocked |
| `GetPPInvested()` | `int` | Calculates total PP invested in tree |
| `UnlockedSkjaldmaerAbilities` | `IReadOnlySet` | Read-only view of unlocked abilities |

### Application Layer - Interfaces

| Interface | Description |
|-----------|-------------|
| `IDamageService` | Damage pipeline with Unbreakable + The Wall Lives integration |
| `ISkjaldmaerAbilityService` | Tier 3 & Capstone ability operations |
| `IBlockChargeService` | Block Charge resource management |

#### IDamageService Methods

| Method | Description |
|--------|-------------|
| `ApplyDamage(target, incomingDamage)` | Full pipeline: reduce → protect → apply |
| `CalculateFinalDamage(target, incomingDamage)` | Preview damage without applying |
| `CheckLethalDamageProtection(player, damageAmount)` | Check Wall Lives protection |

#### ISkjaldmaerAbilityService Methods

| Method | Description |
|--------|-------------|
| `GetDamageReduction(player)` | Returns 3 if Unbreakable unlocked, else 0 |
| `TryGuardiansSacrifice(skjaldmaer, ally, damage)` | Spend 2 charges, absorb ally damage |
| `ActivateTheWallLives(player)` | Activate capstone (4 AP, once per combat) |
| `CanUseCapstone(player)` | Check once-per-combat availability |
| `CanUnlockTier3(player)` | Check 16+ PP invested |
| `CanUnlockCapstone(player)` | Check 24+ PP invested |
| `GetPPInvested(player)` | Delegate to Player.GetPPInvested() |

#### IBlockChargeService Methods

| Method | Description |
|--------|-------------|
| `SpendCharges(player, amount)` | Spend charges atomically |
| `RestoreCharges(player, amount)` | Restore charges |
| `RestoreAllCharges(player)` | Full restore |
| `CanSpend(player, amount)` | Check availability |
| `GetCurrentValue(player)` | Current charge count |
| `GetMaxValue(player)` | Max charge count |

### Application Layer - Services

| Service | Description |
|---------|-------------|
| `DamageService` | Implements two-step damage pipeline (Unbreakable → The Wall Lives) with structured logging |
| `SkjaldmaerAbilityService` | Implements ability logic with prerequisite validation and structured logging |
| `BlockChargeService` | Logging-wrapped operations on BlockChargeResource |

---

## Damage Pipeline

```
Incoming Damage
    │
    ▼
┌──────────────────────┐
│ Step 1: Unbreakable   │  - If unlocked: reduce by 3 (min 1)
│ (Passive Reduction)   │  - If not: pass through
└──────────┬───────────┘
           │
           ▼
┌──────────────────────┐
│ Step 2: The Wall Lives│  - If active: cap damage to preserve 1 HP
│ (Lethal Protection)  │  - If not: pass through
└──────────┬───────────┘
           │
           ▼
    Final Damage Applied
```

---

## PP Investment Costs

| Tier | Abilities | PP Cost Each | PP Subtotal |
|------|-----------|-------------|-------------|
| Tier 1 | ShieldWall, Intercept, Bulwark | 0 (free) | 0 |
| Tier 2 | HoldTheLine, CounterShield, Rally | 4 | 12 |
| Tier 3 | Unbreakable, GuardiansSacrifice | 5 | 10 |
| Capstone | TheWallLives | 6 | 6 |
| **Total** | | | **28** |

Unlock requirements: Tier 3 needs 16+ PP invested, Capstone needs 24+ PP invested.

---

## Unit Tests

### TheWallLivesStateTests (12 tests)

- Activation sets active state and 3-turn duration
- Tick decrements and expires after 3 ticks
- Tick when inactive does nothing
- Lethal damage prevention caps damage to preserve 1 HP
- Non-lethal damage passes through
- Inactive state returns full damage
- At 1 HP, returns zero damage
- Deactivation clears state
- IsExpired checks
- GetRemainingDuration checks

### BlockChargeResourceTests (11 tests)

- CreateFull initializes at max
- Custom max initialization
- Spend with sufficient/insufficient/invalid charges
- Restore normal/capped/full
- Bulwark HP bonus calculation
- IsModified tracking

### DamageServiceTests (8 tests)

- Unbreakable reduction (-3)
- Minimum 1 damage enforcement
- No reduction passthrough
- Wall Lives lethal protection
- Inactive protection passthrough
- Zero/negative damage handling
- HP reduction verification

### SkjaldmaerAbilityServiceTests (15 tests)

- GetDamageReduction with/without Unbreakable
- Non-Skjaldmær returns 0
- ActivateTheWallLives valid/AP/already-used/not-unlocked
- CanUseCapstone 3 cases
- TryGuardiansSacrifice valid/charges/not-unlocked
- PP investment calculation

---

## Files Created

| Path | Description |
|------|-------------|
| `src/Core/RuneAndRust.Domain/ValueObjects/TheWallLivesState.cs` | Capstone state value object |
| `src/Core/RuneAndRust.Domain/ValueObjects/BlockChargeResource.cs` | Block Charge resource value object |
| `src/Core/RuneAndRust.Domain/Enums/SkjaldmaerAbilityId.cs` | Ability ID enum |
| `src/Core/RuneAndRust.Application/Interfaces/IDamageService.cs` | Damage service interface |
| `src/Core/RuneAndRust.Application/Interfaces/ISkjaldmaerAbilityService.cs` | Ability service interface |
| `src/Core/RuneAndRust.Application/Interfaces/IBlockChargeService.cs` | Block charge service interface |
| `src/Core/RuneAndRust.Application/Services/DamageService.cs` | Damage pipeline implementation |
| `src/Core/RuneAndRust.Application/Services/SkjaldmaerAbilityService.cs` | Ability service implementation |
| `src/Core/RuneAndRust.Application/Services/BlockChargeService.cs` | Block charge service implementation |
| `tests/.../ValueObjects/TheWallLivesStateTests.cs` | Capstone state tests |
| `tests/.../ValueObjects/BlockChargeResourceTests.cs` | Block charge tests |
| `tests/.../Services/DamageServiceTests.cs` | Damage pipeline tests |
| `tests/.../Services/SkjaldmaerAbilityServiceTests.cs` | Ability service tests |

## Files Modified

| Path | Description |
|------|-------------|
| `src/Core/RuneAndRust.Domain/Entities/Player.cs` | Added specialization properties and methods |

---

## Dependencies

- Builds on v0.20.1a (Block Charge resource concept) and v0.20.1b (Tier 2 abilities)
- `Player` entity extended in place of design spec's `Character` entity
- Services use synchronous operations on `Player` instances (caller handles persistence)

---

## Notes

- Design spec referenced `Character` entity; adapted to existing `Player` entity throughout
- Design spec used async `ICharacterRepository`; adapted to synchronous operations since `IGameRepository` operates at `GameSession` level
- `GetPPInvested()` placed in `Player` domain entity rather than application service for domain logic encapsulation
- Constants (reduction amounts, AP costs, PP thresholds) extracted as named constants in `SkjaldmaerAbilityService`
