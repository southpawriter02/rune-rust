# v0.17.2d Changelog: Derived Stat Calculation

**Version:** 0.17.2d
**Phase:** Derived Stat Calculation
**Date:** 2026-01-30
**Status:** Complete

---

## Summary

Implements the `DerivedStats` and `DerivedStatFormula` value objects that calculate secondary character statistics from core attributes, archetype bonuses, lineage bonuses, and lineage multipliers. The system defines seven derived stats (Max HP, Max Stamina, Max Aether Pool, Initiative, Soak, Movement Speed, Carrying Capacity) using configurable formulas loaded from JSON configuration.

This version provides the formula and stat value objects used by the derived stat calculator service (v0.17.2g) and attribute provider (v0.17.2e) for preview and final stat calculation during character creation.

---

## Added

### Domain Layer - Value Objects

| Value Object | Description |
|--------------|-------------|
| `DerivedStats` | Holds all 7 calculated secondary statistics for a character |
| `DerivedStatFormula` | Defines a configurable formula for calculating one derived stat |

#### DerivedStats Properties

| Property | Type | Description |
|----------|------|-------------|
| `MaxHp` | `int` | Maximum hit points (must be > 0) |
| `MaxStamina` | `int` | Maximum stamina pool (must be >= 0) |
| `MaxAetherPool` | `int` | Maximum Aether capacity (must be >= 0) |
| `Initiative` | `int` | Combat turn order bonus |
| `Soak` | `int` | Passive damage reduction (must be >= 0) |
| `MovementSpeed` | `int` | Tiles per turn (must be > 0) |
| `CarryingCapacity` | `int` | Max weight capacity (must be >= 0) |
| `HasCombatStats` | `bool` | Whether Initiative or Soak is positive |
| `HasResourceStats` | `bool` | Whether any resource pool is positive |
| `TotalResourcePool` | `int` | Sum of HP + Stamina + Aether Pool |

#### DerivedStats Methods

| Method | Returns | Description |
|--------|---------|-------------|
| `Create(...)` | `DerivedStats` | Factory with validation |
| `GetSummary()` | `string` | Formatted display string |

#### DerivedStatFormula Properties

| Property | Type | Description |
|----------|------|-------------|
| `StatName` | `string` | Name of the derived stat |
| `BaseValue` | `int` | Flat base before scaling |
| `AttributeScaling` | `IReadOnlyDictionary<CoreAttribute, float>` | Attribute multipliers |
| `ArchetypeBonuses` | `IReadOnlyDictionary<string, int>` | Flat archetype bonuses |
| `LineageBonuses` | `IReadOnlyDictionary<string, int>` | Flat lineage bonuses |
| `LineageMultipliers` | `IReadOnlyDictionary<string, float>` | Post-additive multipliers |
| `HasArchetypeBonuses` | `bool` | Whether archetype bonuses exist |
| `HasLineageBonuses` | `bool` | Whether lineage bonuses exist |
| `HasLineageMultipliers` | `bool` | Whether lineage multipliers exist |
| `ScaledAttributeCount` | `int` | Number of scaling attributes |

#### DerivedStatFormula Methods

| Method | Returns | Description |
|--------|---------|-------------|
| `Create(...)` | `DerivedStatFormula` | Factory with validation |
| `Calculate(attributes, archetypeId, lineageId)` | `int` | Computes the stat value |
| `GetArchetypeBonus(archetypeId)` | `int` | Lookup archetype bonus (0 if absent) |
| `GetLineageBonus(lineageId)` | `int` | Lookup lineage bonus (0 if absent) |
| `GetLineageMultiplier(lineageId)` | `float` | Lookup multiplier (1.0 if absent) |

### Configuration

| File | Change |
|------|--------|
| `config/attributes.json` | Added `derivedStats` section with 7 formula definitions |
| `config/schemas/attributes.schema.json` | Added `derivedStats` property, `derivedStatsConfiguration` and `derivedStatFormula` definitions |
| `config/glossary.json` | Added 7 glossary terms: Derived Stats, Max HP, Max Stamina, Aether Pool, Initiative, Soak, Movement Speed |

### Tests

#### DerivedStatsTests (~15 tests)

- Factory validation (valid params, zero HP, negative HP, zero movement, negative stamina/AP/soak)
- Zero optional stats allowed
- Computed properties (TotalResourcePool, HasCombatStats, HasResourceStats)
- Display methods (GetSummary, ToString)
- Value equality

#### DerivedStatFormulaTests (~30 tests)

- Max HP calculations (Warrior=139, Warrior+Clan-Born=144, Mystic=90)
- Max Aether Pool calculations (Mystic=80, Rune-Marked multiplier=93, Warrior=30)
- Soak calculations (Warrior=2, Iron-Blooded=4)
- Movement Speed (base=5, Vargr-Kin=6)
- Carrying Capacity (Warrior=40, Mystic=20)
- Initiative (Warrior=4, Mystic=5)
- Null archetype/lineage handling
- Unknown archetype graceful handling
- Factory validation (null stat name, whitespace stat name, null attribute scaling)
- Null optional dictionaries default to empty
- Computed properties (HasArchetypeBonuses, HasLineageMultipliers, ScaledAttributeCount)
- Helper methods (GetArchetypeBonus, GetLineageBonus, GetLineageMultiplier)
- Calculate with null attribute values throws
- ToString formatting

#### AttributeDerivedStatsSchemaTests (~4 tests)

- Schema contains derivedStatsConfiguration and derivedStatFormula definitions
- Schema requires derivedStats property
- Existing attributes.json validates against updated schema
- Missing derivedStats section fails validation

---

## Formula Reference

| Stat | Formula | Archetype Bonuses | Lineage Bonuses |
|------|---------|-------------------|-----------------|
| Max HP | (STURDINESS × 10) + 50 | W:+49, Sk:+30, My:+20, Ad:+30 | Clan-Born:+5 |
| Max Stamina | (FINESSE × 5) + (MIGHT × 5) + 20 | W:+5, Sk:+5 | — |
| Max Aether Pool | (WILL × 10) + (WITS × 5) | My:+20 | Rune-Marked:+5, ×1.10 |
| Initiative | FINESSE + (WITS ÷ 2) | — | — |
| Soak | STURDINESS ÷ 2 | — | Iron-Blooded:+2 |
| Movement Speed | 5 (flat) | — | Vargr-Kin:+1 |
| Carrying Capacity | MIGHT × 10 | — | — |

---

## Files Created

| Path | Description |
|------|-------------|
| `src/Core/RuneAndRust.Domain/ValueObjects/DerivedStats.cs` | Derived stats value object |
| `src/Core/RuneAndRust.Domain/ValueObjects/DerivedStatFormula.cs` | Derived stat formula value object |
| `tests/RuneAndRust.Domain.UnitTests/ValueObjects/DerivedStatsTests.cs` | DerivedStats unit tests |
| `tests/RuneAndRust.Domain.UnitTests/ValueObjects/DerivedStatFormulaTests.cs` | DerivedStatFormula unit tests |
| `tests/RuneAndRust.Infrastructure.IntegrationTests/Schemas/AttributeDerivedStatsSchemaTests.cs` | Schema validation tests |

## Files Modified

| Path | Description |
|------|-------------|
| `config/attributes.json` | Added derivedStats section with 7 formula definitions |
| `config/schemas/attributes.schema.json` | Added derivedStats schema definitions |
| `config/glossary.json` | Added 7 derived stat glossary terms |
| `docs/design/v0.17.x/v0.17.2-scope-breakdown.md` | Checked off v0.17.2d deliverables |
| `docs/design/v0.17.x/v0.17.x-overview.md` | Updated v0.17.2 deliverable checkboxes |

---

## Dependencies

### Required From Prior Versions

| Version | Dependency | Usage |
|---------|------------|-------|
| v0.17.2a | `CoreAttribute` | Keys for attribute scaling dictionaries |

### Provides To Future Versions

| Version | Feature | Usage |
|---------|---------|-------|
| v0.17.2g | `DerivedStats` | Result type for calculator service |
| v0.17.2g | `DerivedStatFormula` | Loaded and applied by calculator service |
| v0.17.2e | Formula config | Provider loads formula definitions from JSON |

---

## Key Design Decisions

1. **Formula-Driven Calculation** — All derived stats computed from configurable formulas, enabling balance tuning without code changes
2. **Multi-Source Bonuses** — Attributes, archetypes, and lineages all contribute through distinct channels (scaling, flat bonuses, multipliers)
3. **Ordered Application** — Multipliers applied after all additive bonuses to prevent order-of-operations issues
4. **Integer Truncation** — Float calculations truncated (not rounded) to integer for deterministic results
5. **Immutable Value Objects** — Both types are `readonly record struct` for thread safety and value equality
6. **Null-Safe Lookups** — Missing archetype/lineage keys return 0 (bonus) or 1.0 (multiplier) instead of throwing

---

## Logging Strategy

| Level | When |
|-------|------|
| Debug | Formula creation parameters, validation passes, calculation steps (base, scaling, bonuses, multipliers) |
| Information | Formula created, stat calculated with final result |

---

## Notes

- The Rune-Marked Aether-Tainted trait applies +5 flat bonus THEN ×1.10 multiplier (order matters)
- Initiative uses integer truncation: Wits 3 → 3 × 0.5 = 1.5 → contributes 1 (truncated)
- Movement Speed has no attribute scaling — it is a flat base with optional lineage bonus
- Carrying Capacity has no archetype or lineage bonuses — purely Might-scaled
- Example Warrior (M4, F3, Wi2, Wl2, S4, Clan-Born): HP=144, ST=60, AP=30, Init=4, Soak=2, Move=5, Carry=40
- Example Mystic (M2, F3, Wi4, Wl4, S2, Rune-Marked): HP=90, ST=45, AP=93, Init=5, Soak=1, Move=5, Carry=20
