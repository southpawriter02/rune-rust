# v0.2.0a Design Specification: NPC Foundation

## Overview

**Version:** 0.2.0a
**Status:** Planning
**Focus:** Establish the core NPC system with entity model, attitudes, and basic dialogue
**Prerequisites:** v0.1.5 (Procedural Puzzles & Secrets)
**Estimated Unit Tests:** ~30

---

## Table of Contents

1. [Executive Summary](#1-executive-summary)
2. [Feature Overview](#2-feature-overview)
3. [Architecture Diagrams](#3-architecture-diagrams)
4. [User Stories](#4-user-stories)
5. [Data Models](#5-data-models)
6. [Configuration Schemas](#6-configuration-schemas)
7. [Service Specifications](#7-service-specifications)
8. [Talk Command Flow](#8-talk-command-flow)
9. [User-Facing Changes](#9-user-facing-changes)
10. [Logging Requirements](#10-logging-requirements)
11. [Unit Test Specifications](#11-unit-test-specifications)
12. [Use Cases](#12-use-cases)
13. [Acceptance Criteria](#13-acceptance-criteria)
14. [Deliverable Checklist](#14-deliverable-checklist)
15. [Dependencies](#15-dependencies)
16. [Future Considerations](#16-future-considerations)

---

## 1. Executive Summary

This version introduces the foundational NPC (Non-Player Character) system, transforming dungeons from purely hostile environments into living spaces with friendly characters. Players can encounter NPCs in rooms and initiate basic dialogue through the `talk` command.

### Key Deliverables

| Category | Items |
|----------|-------|
| **Entities** | NPC |
| **Definitions** | NPCDefinition |
| **Value Objects** | NPCAppearance |
| **Enums** | NPCType, NPCAttitude |
| **Commands** | `talk`, `talk <npc>` |
| **Configuration** | npcs.json, npcs.schema.json |
| **Room Updates** | NPCs collection, AddNPC, RemoveNPC, GetNPC |
| **Tests** | ~30 new unit tests |

### Architectural Significance

This version establishes the **NPC interaction pattern** that will be extended throughout future versions:
- NPCs as room-contained entities with attitudes
- Definition-based NPC creation from configuration
- Talk command as the primary interaction mechanism
- Foundation for dialogue trees (v0.2.0b), reputation (v0.2.0c), and companions (v0.2.0d)

---

## 2. Feature Overview

```
v0.2.0a Features
├── NPC Entity
│   ├── Identity (Id, DefinitionId, Name)
│   ├── Type classification (NPCType enum)
│   ├── Attitude tracking (NPCAttitude enum)
│   ├── Appearance details (NPCAppearance value object)
│   └── Room association (CurrentRoomId)
├── NPC Configuration
│   ├── NPCDefinition entity
│   ├── npcs.json configuration file
│   └── npcs.schema.json validation schema
├── Room Integration
│   ├── NPCs collection
│   ├── AddNPC method
│   ├── RemoveNPC method
│   └── GetNPC method
├── Talk Command
│   ├── Basic talk (single NPC in room)
│   ├── Targeted talk (talk <npc-name>)
│   └── Greeting display
└── NPC Display
    ├── Room description shows NPCs
    └── NPC appearance in look output
```

---

## 3. Architecture Diagrams

### 3.1 Layer Diagram

```
┌─────────────────────────────────────────────────────────────────────────┐
│                         PRESENTATION LAYER                              │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  ┌─────────────────────┐  ┌─────────────────────┐  ┌────────────────┐  │
│  │   TalkHandler       │  │   LookHandler       │  │ IGameRenderer  │  │
│  │                     │  │   (updated)         │  │ (updated)      │  │
│  │ - HandleTalk()      │  │ - ShowNPCsInRoom()  │  │ - RenderNPC()  │  │
│  │ - HandleTalkTarget()│  │                     │  │ - RenderGreet  │  │
│  └─────────┬───────────┘  └─────────┬───────────┘  └───────┬────────┘  │
│            │                        │                      │           │
└────────────┼────────────────────────┼──────────────────────┼───────────┘
             │                        │                      │
             ▼                        ▼                      ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                         APPLICATION LAYER                               │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │                         NPCService                               │   │
│  ├─────────────────────────────────────────────────────────────────┤   │
│  │ + GetNPCDefinition(id) : NPCDefinition?                         │   │
│  │ + GetAllNPCDefinitions() : IReadOnlyList<NPCDefinition>         │   │
│  │ + CreateNPC(definitionId, roomId?) : NPC                        │   │
│  │ + TryTalkToNPC(player, room, npcName?) : TalkResult             │   │
│  │ + GetNPCsInRoom(roomId) : IReadOnlyList<NPC>                    │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │                    GameSessionService (updated)                  │   │
│  ├─────────────────────────────────────────────────────────────────┤   │
│  │ + TryTalk(npcName?) : TalkResult                                │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                           DOMAIN LAYER                                  │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  ENTITIES                                                               │
│  ┌────────────────────────┐  ┌────────────────────────┐                │
│  │         NPC            │  │    NPCDefinition       │                │
│  ├────────────────────────┤  ├────────────────────────┤                │
│  │ + Id: Guid             │  │ + Id: string           │                │
│  │ + DefinitionId: string │  │ + Name: string         │                │
│  │ + Name: string         │  │ + Description: string  │                │
│  │ + Type: NPCType        │  │ + Type: NPCType        │                │
│  │ + Attitude: NPCAttitude│  │ + DefaultAttitude: ... │                │
│  │ + BaseAttitude: ...    │  │ + Greeting: string     │                │
│  │ + CurrentRoomId: Guid? │  │ + Appearance: ...      │                │
│  │ + Greeting: string     │  │ + RootDialogueId: str? │                │
│  │ + Description: string  │  │ + FactionId: string?   │                │
│  │ + Appearance: ...      │  └────────────────────────┘                │
│  │ + IsAvailable: bool    │                                            │
│  │ + RootDialogueId: str? │                                            │
│  └────────────────────────┘                                            │
│                                                                         │
│  ENUMS                                                                  │
│  ┌────────────────────────┐  ┌────────────────────────┐                │
│  │       NPCType          │  │     NPCAttitude        │                │
│  ├────────────────────────┤  ├────────────────────────┤                │
│  │ Merchant               │  │ Friendly               │                │
│  │ QuestGiver             │  │ Neutral                │                │
│  │ Informant              │  │ Wary                   │                │
│  │ Companion              │  │ Hostile                │                │
│  │ Wanderer               │  └────────────────────────┘                │
│  └────────────────────────┘                                            │
│                                                                         │
│  VALUE OBJECTS                                                          │
│  ┌────────────────────────┐                                            │
│  │    NPCAppearance       │                                            │
│  ├────────────────────────┤                                            │
│  │ + Race: string         │                                            │
│  │ + Features: string     │                                            │
│  │ + Attire: string       │                                            │
│  └────────────────────────┘                                            │
│                                                                         │
│  ROOM UPDATES                                                           │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │                          Room                                    │   │
│  ├─────────────────────────────────────────────────────────────────┤   │
│  │ + NPCs: IReadOnlyList<NPC>                    // NEW             │   │
│  │ + AddNPC(NPC npc): void                       // NEW             │   │
│  │ + RemoveNPC(Guid npcId): bool                 // NEW             │   │
│  │ + GetNPC(string nameOrId): NPC?               // NEW             │   │
│  │ + HasNPCs: bool                               // NEW             │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                        INFRASTRUCTURE LAYER                             │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │                IConfigurationProvider (updated)                  │   │
│  ├─────────────────────────────────────────────────────────────────┤   │
│  │ + LoadNPCDefinitions() : IReadOnlyList<NPCDefinition>           │   │
│  │ + GetNPCDefinition(string id) : NPCDefinition?                  │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
│  Configuration Files:                                                   │
│  ├── config/npcs.json                                                  │
│  └── config/schemas/npcs.schema.json                                   │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

### 3.2 Talk Command Flow

```
┌───────────────────┐
│   Player Input    │
│    "talk" or      │
│  "talk <name>"    │
└─────────┬─────────┘
          │
          ▼
┌───────────────────┐      ┌───────────────────┐
│   InputHandler    │─────▶│ GameSessionService│
│  ParseTalkCmd()   │      │   TryTalk()       │
└───────────────────┘      └─────────┬─────────┘
                                     │
                                     ▼
                           ┌───────────────────┐
                           │    NPCService     │
                           │ TryTalkToNPC()    │
                           └─────────┬─────────┘
                                     │
                    ┌────────────────┼────────────────┐
                    │                │                │
                    ▼                ▼                ▼
           ┌─────────────┐  ┌─────────────┐  ┌─────────────┐
           │  No NPCs    │  │ One NPC in  │  │ Multiple    │
           │  in Room    │  │    Room     │  │ NPCs, name  │
           └──────┬──────┘  └──────┬──────┘  │ required    │
                  │                │         └──────┬──────┘
                  ▼                ▼                ▼
           ┌─────────────┐  ┌─────────────┐  ┌─────────────┐
           │ TalkResult  │  │ TalkResult  │  │ TalkResult  │
           │  .NoNPCs    │  │  .Success   │  │ .Ambiguous  │
           └──────┬──────┘  └──────┬──────┘  │   or        │
                  │                │         │  .NotFound  │
                  │                │         └──────┬──────┘
                  │                │                │
                  └────────────────┼────────────────┘
                                   │
                                   ▼
                           ┌───────────────────┐
                           │  Check Attitude   │
                           │  WillTalk()?      │
                           └─────────┬─────────┘
                                     │
                    ┌────────────────┴────────────────┐
                    │                                 │
                    ▼                                 ▼
           ┌─────────────┐                   ┌─────────────┐
           │   Hostile   │                   │ Non-Hostile │
           │ WillTalk=   │                   │ WillTalk=   │
           │   false     │                   │   true      │
           └──────┬──────┘                   └──────┬──────┘
                  │                                 │
                  ▼                                 ▼
           ┌─────────────┐                   ┌─────────────┐
           │ TalkResult  │                   │ TalkResult  │
           │ .Refused    │                   │ .Success    │
           │ (hostile    │                   │ (greeting)  │
           │  message)   │                   └──────┬──────┘
           └──────┬──────┘                          │
                  │                                 │
                  └────────────────┬────────────────┘
                                   │
                                   ▼
                           ┌───────────────────┐
                           │   IGameRenderer   │
                           │ RenderTalkResult()│
                           └───────────────────┘
```

### 3.3 Room-NPC Relationship

```
┌─────────────────────────────────────────────────────────────────────────┐
│                              ROOM                                       │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  Existing Collections:                                                  │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐                  │
│  │   Monsters   │  │    Items     │  │    Exits     │                  │
│  │ List<Monster>│  │ List<Item>   │  │Dict<Dir,Exit>│                  │
│  └──────────────┘  └──────────────┘  └──────────────┘                  │
│                                                                         │
│  NEW Collection:                                                        │
│  ┌──────────────────────────────────────────────────────────────────┐  │
│  │                            NPCs                                   │  │
│  │                      List<NPC>                                    │  │
│  ├──────────────────────────────────────────────────────────────────┤  │
│  │  ┌─────────┐  ┌─────────┐  ┌─────────┐                           │  │
│  │  │   NPC   │  │   NPC   │  │   NPC   │                           │  │
│  │  │Grimbold │  │  Elara  │  │  ...    │                           │  │
│  │  │Merchant │  │Informant│  │         │                           │  │
│  │  │Neutral  │  │  Wary   │  │         │                           │  │
│  │  └─────────┘  └─────────┘  └─────────┘                           │  │
│  └──────────────────────────────────────────────────────────────────┘  │
│                                                                         │
│  Methods:                                                               │
│  ├── AddNPC(NPC npc)                                                   │
│  ├── RemoveNPC(Guid npcId) : bool                                      │
│  ├── GetNPC(string nameOrId) : NPC?                                    │
│  └── HasNPCs : bool                                                    │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

---

## 4. User Stories

### US-2.0a-1: See NPCs in Room
**As a** player exploring the dungeon
**I want to** see NPCs listed when I look at a room
**So that** I know who I can interact with

**Acceptance Criteria:**
- NPCs appear in room description after items
- NPCs show their name
- Multiple NPCs are listed separately

### US-2.0a-2: Talk to Single NPC
**As a** player in a room with one NPC
**I want to** use `talk` to initiate dialogue
**So that** I can interact without specifying a name

**Acceptance Criteria:**
- `talk` command works when exactly one NPC is present
- NPC's greeting is displayed
- NPC's name and attitude affect the greeting presentation

### US-2.0a-3: Talk to Specific NPC
**As a** player in a room with multiple NPCs
**I want to** use `talk <npc-name>` to choose who to talk to
**So that** I can interact with a specific character

**Acceptance Criteria:**
- `talk <name>` targets the specified NPC
- Partial name matching works (case-insensitive)
- Clear error if NPC not found

### US-2.0a-4: NPC Refuses Based on Attitude
**As a** player attempting to talk to a hostile NPC
**I want to** receive an appropriate rejection message
**So that** I understand why the NPC won't talk

**Acceptance Criteria:**
- Hostile NPCs refuse dialogue
- Refusal message is displayed
- Player is not stuck in dialogue state

### US-2.0a-5: Configure NPCs via JSON
**As a** game designer
**I want to** define NPCs in configuration files
**So that** I can create and modify NPCs without code changes

**Acceptance Criteria:**
- NPCs can be defined in npcs.json
- All NPC properties are configurable
- Invalid configuration produces clear error messages

---

## 5. Data Models

### 5.1 NPC Entity

```csharp
namespace RuneAndRust.Domain.Entities;

/// <summary>
/// Represents a non-player character in the dungeon.
/// </summary>
/// <remarks>
/// NPCs are friendly or neutral characters that players can interact with
/// through dialogue. They are created from NPCDefinition templates and
/// can have dynamic attitudes that change based on player actions.
/// </remarks>
public class NPC : IEntity
{
    /// <summary>
    /// Gets the unique identifier for this NPC instance.
    /// </summary>
    public Guid Id { get; private set; }

    /// <summary>
    /// Gets the NPC's definition ID for configuration lookup.
    /// </summary>
    /// <example>"grimbold-trader", "elara-wanderer"</example>
    public string DefinitionId { get; private set; } = string.Empty;

    /// <summary>
    /// Gets the NPC's display name.
    /// </summary>
    /// <example>"Grimbold the Trader", "Elara"</example>
    public string Name { get; private set; } = string.Empty;

    /// <summary>
    /// Gets the NPC's type/role.
    /// </summary>
    public NPCType Type { get; private set; }

    /// <summary>
    /// Gets the NPC's current attitude toward the player.
    /// </summary>
    /// <remarks>
    /// This can change based on player actions, reputation, and dialogue choices.
    /// </remarks>
    public NPCAttitude Attitude { get; private set; }

    /// <summary>
    /// Gets the NPC's base attitude (before modifiers).
    /// </summary>
    /// <remarks>
    /// Used when resetting attitude or calculating modified values.
    /// </remarks>
    public NPCAttitude BaseAttitude { get; private set; }

    /// <summary>
    /// Gets the room this NPC is currently in.
    /// </summary>
    /// <remarks>
    /// Null if the NPC is not placed in any room (e.g., in storage or traveling).
    /// </remarks>
    public Guid? CurrentRoomId { get; private set; }

    /// <summary>
    /// Gets the NPC's greeting dialogue.
    /// </summary>
    /// <remarks>
    /// Displayed when the player initiates dialogue with this NPC.
    /// </remarks>
    public string Greeting { get; private set; } = string.Empty;

    /// <summary>
    /// Gets the NPC's description.
    /// </summary>
    /// <remarks>
    /// A visual/narrative description shown when examining the NPC.
    /// </remarks>
    public string Description { get; private set; } = string.Empty;

    /// <summary>
    /// Gets the NPC's appearance details.
    /// </summary>
    public NPCAppearance Appearance { get; private set; } = NPCAppearance.Default;

    /// <summary>
    /// Gets whether this NPC is currently available for interaction.
    /// </summary>
    /// <remarks>
    /// False if the NPC is busy, has been recruited as a companion, or is otherwise unavailable.
    /// </remarks>
    public bool IsAvailable { get; private set; } = true;

    /// <summary>
    /// Gets the root dialogue node ID for this NPC.
    /// </summary>
    /// <remarks>
    /// Used in v0.2.0b for dialogue tree navigation. Null means basic greeting only.
    /// </remarks>
    public string? RootDialogueId { get; private set; }

    /// <summary>
    /// Private constructor for EF Core.
    /// </summary>
    private NPC() { }

    /// <summary>
    /// Creates a new NPC from a definition.
    /// </summary>
    /// <param name="definition">The NPC definition to create from.</param>
    /// <param name="roomId">Optional room ID to place the NPC in.</param>
    /// <returns>A new NPC instance.</returns>
    /// <exception cref="ArgumentNullException">Thrown if definition is null.</exception>
    public static NPC Create(NPCDefinition definition, Guid? roomId = null)
    {
        ArgumentNullException.ThrowIfNull(definition);

        return new NPC
        {
            Id = Guid.NewGuid(),
            DefinitionId = definition.Id,
            Name = definition.Name,
            Type = definition.Type,
            Attitude = definition.DefaultAttitude,
            BaseAttitude = definition.DefaultAttitude,
            CurrentRoomId = roomId,
            Greeting = definition.Greeting,
            Description = definition.Description,
            Appearance = definition.Appearance,
            RootDialogueId = definition.RootDialogueId,
            IsAvailable = true
        };
    }

    /// <summary>
    /// Changes the NPC's current attitude.
    /// </summary>
    /// <param name="attitude">The new attitude.</param>
    public void SetAttitude(NPCAttitude attitude)
    {
        Attitude = attitude;
    }

    /// <summary>
    /// Resets the NPC's attitude to their base attitude.
    /// </summary>
    public void ResetAttitude()
    {
        Attitude = BaseAttitude;
    }

    /// <summary>
    /// Moves the NPC to a different room.
    /// </summary>
    /// <param name="roomId">The ID of the room to move to.</param>
    public void MoveTo(Guid roomId)
    {
        CurrentRoomId = roomId;
    }

    /// <summary>
    /// Removes the NPC from their current room.
    /// </summary>
    public void RemoveFromRoom()
    {
        CurrentRoomId = null;
    }

    /// <summary>
    /// Sets the NPC's availability for interaction.
    /// </summary>
    /// <param name="isAvailable">Whether the NPC is available.</param>
    public void SetAvailability(bool isAvailable)
    {
        IsAvailable = isAvailable;
    }

    /// <summary>
    /// Checks if the NPC is willing to talk based on attitude.
    /// </summary>
    /// <returns>True if the NPC will engage in dialogue.</returns>
    /// <remarks>
    /// Hostile NPCs refuse dialogue. Unavailable NPCs also refuse.
    /// </remarks>
    public bool WillTalk()
    {
        return Attitude != NPCAttitude.Hostile && IsAvailable;
    }

    /// <summary>
    /// Gets the NPC's refusal message when they won't talk.
    /// </summary>
    /// <returns>A message explaining why the NPC refuses to talk.</returns>
    public string GetRefusalMessage()
    {
        if (!IsAvailable)
        {
            return $"{Name} is not available to talk right now.";
        }

        return Attitude switch
        {
            NPCAttitude.Hostile => $"{Name} glares at you with open hostility and refuses to speak.",
            _ => $"{Name} doesn't want to talk."
        };
    }
}
```

### 5.2 NPCType Enum

```csharp
namespace RuneAndRust.Domain.Enums;

/// <summary>
/// Defines the functional role of an NPC.
/// </summary>
/// <remarks>
/// NPC types determine what actions and services an NPC can provide.
/// </remarks>
public enum NPCType
{
    /// <summary>
    /// NPC that buys and sells items.
    /// </summary>
    /// <remarks>
    /// Merchants have inventory and can engage in trade.
    /// Shop mechanics implemented in v0.2.2.
    /// </remarks>
    Merchant,

    /// <summary>
    /// NPC that provides quests or objectives.
    /// </summary>
    /// <remarks>
    /// Quest givers can start, advance, and complete quests.
    /// Quest mechanics implemented in v0.3.0.
    /// </remarks>
    QuestGiver,

    /// <summary>
    /// NPC that provides information and hints.
    /// </summary>
    /// <remarks>
    /// Informants offer lore, hints, and world-building dialogue.
    /// </remarks>
    Informant,

    /// <summary>
    /// NPC that can be recruited as a companion.
    /// </summary>
    /// <remarks>
    /// Companions can join the player's party.
    /// Companion mechanics implemented in v0.2.0d.
    /// </remarks>
    Companion,

    /// <summary>
    /// NPC that wanders with no specific role.
    /// </summary>
    /// <remarks>
    /// Wanderers provide atmosphere and basic dialogue.
    /// </remarks>
    Wanderer
}
```

### 5.3 NPCAttitude Enum

```csharp
namespace RuneAndRust.Domain.Enums;

/// <summary>
/// Represents an NPC's disposition toward the player.
/// </summary>
/// <remarks>
/// Attitude affects dialogue options, prices, and willingness to interact.
/// </remarks>
public enum NPCAttitude
{
    /// <summary>
    /// NPC is helpful and offers good prices/options.
    /// </summary>
    /// <remarks>
    /// Friendly NPCs may offer special dialogue options and better deals.
    /// </remarks>
    Friendly,

    /// <summary>
    /// NPC is indifferent, standard interactions.
    /// </summary>
    /// <remarks>
    /// Neutral is the default starting attitude for most NPCs.
    /// </remarks>
    Neutral,

    /// <summary>
    /// NPC is suspicious, limited dialogue options.
    /// </summary>
    /// <remarks>
    /// Wary NPCs may refuse certain services or dialogue paths.
    /// </remarks>
    Wary,

    /// <summary>
    /// NPC refuses to interact or may attack.
    /// </summary>
    /// <remarks>
    /// Hostile NPCs will not engage in dialogue.
    /// </remarks>
    Hostile
}
```

### 5.4 NPCAppearance Value Object

```csharp
namespace RuneAndRust.Domain.ValueObjects;

/// <summary>
/// Describes an NPC's visual appearance.
/// </summary>
/// <remarks>
/// Used for room descriptions and detailed NPC examination.
/// </remarks>
public readonly record struct NPCAppearance
{
    /// <summary>
    /// Gets the race or species.
    /// </summary>
    /// <example>"Human", "Dwarf", "Elf"</example>
    public string Race { get; init; }

    /// <summary>
    /// Gets notable physical features.
    /// </summary>
    /// <example>"braided gray beard, shrewd eyes"</example>
    public string Features { get; init; }

    /// <summary>
    /// Gets clothing or armor description.
    /// </summary>
    /// <example>"leather apron over chainmail"</example>
    public string Attire { get; init; }

    /// <summary>
    /// Gets a default appearance for NPCs without custom appearance.
    /// </summary>
    public static NPCAppearance Default => new()
    {
        Race = "Human",
        Features = "unremarkable features",
        Attire = "simple clothing"
    };

    /// <summary>
    /// Gets a formatted description of the appearance.
    /// </summary>
    /// <returns>A prose description of the NPC's appearance.</returns>
    public string ToDescription()
    {
        return $"A {Race.ToLowerInvariant()} with {Features}, wearing {Attire}.";
    }
}
```

### 5.5 NPCDefinition Entity

```csharp
namespace RuneAndRust.Domain.Definitions;

/// <summary>
/// Configuration template for creating NPCs.
/// </summary>
/// <remarks>
/// NPCDefinitions are loaded from configuration files and used as templates
/// to create NPC instances. They define the base properties that all NPCs
/// of this type share.
/// </remarks>
public class NPCDefinition
{
    /// <summary>
    /// Gets the unique identifier.
    /// </summary>
    /// <example>"grimbold-trader", "elara-wanderer"</example>
    public string Id { get; private set; } = string.Empty;

    /// <summary>
    /// Gets the NPC's display name.
    /// </summary>
    /// <example>"Grimbold the Trader"</example>
    public string Name { get; private set; } = string.Empty;

    /// <summary>
    /// Gets the NPC's type/role.
    /// </summary>
    public NPCType Type { get; private set; }

    /// <summary>
    /// Gets the NPC's default attitude.
    /// </summary>
    /// <remarks>
    /// NPCs start with this attitude unless modified by reputation or events.
    /// </remarks>
    public NPCAttitude DefaultAttitude { get; private set; }

    /// <summary>
    /// Gets the greeting dialogue text.
    /// </summary>
    /// <remarks>
    /// Displayed when the player first talks to this NPC.
    /// </remarks>
    public string Greeting { get; private set; } = string.Empty;

    /// <summary>
    /// Gets the NPC's description.
    /// </summary>
    /// <remarks>
    /// Narrative description shown in room and when examining.
    /// </remarks>
    public string Description { get; private set; } = string.Empty;

    /// <summary>
    /// Gets the NPC's appearance.
    /// </summary>
    public NPCAppearance Appearance { get; private set; }

    /// <summary>
    /// Gets the root dialogue node ID.
    /// </summary>
    /// <remarks>
    /// Entry point for dialogue tree in v0.2.0b. Null for greeting-only NPCs.
    /// </remarks>
    public string? RootDialogueId { get; private set; }

    /// <summary>
    /// Gets the faction this NPC belongs to.
    /// </summary>
    /// <remarks>
    /// Used for reputation calculations in v0.2.0c. Null for unaffiliated NPCs.
    /// </remarks>
    public string? FactionId { get; private set; }

    /// <summary>
    /// Private constructor for EF Core and deserialization.
    /// </summary>
    private NPCDefinition() { }

    /// <summary>
    /// Creates an NPC definition from configuration.
    /// </summary>
    /// <param name="id">Unique identifier.</param>
    /// <param name="name">Display name.</param>
    /// <param name="type">NPC type/role.</param>
    /// <param name="defaultAttitude">Starting attitude.</param>
    /// <param name="greeting">Greeting dialogue.</param>
    /// <param name="description">NPC description.</param>
    /// <param name="appearance">Visual appearance (optional).</param>
    /// <param name="rootDialogueId">Dialogue tree root (optional).</param>
    /// <param name="factionId">Faction affiliation (optional).</param>
    /// <returns>A new NPCDefinition instance.</returns>
    /// <exception cref="ArgumentException">Thrown if required fields are null or empty.</exception>
    public static NPCDefinition Create(
        string id,
        string name,
        NPCType type,
        NPCAttitude defaultAttitude,
        string greeting,
        string description,
        NPCAppearance? appearance = null,
        string? rootDialogueId = null,
        string? factionId = null)
    {
        ArgumentException.ThrowIfNullOrWhiteSpace(id);
        ArgumentException.ThrowIfNullOrWhiteSpace(name);
        ArgumentException.ThrowIfNullOrWhiteSpace(greeting);
        ArgumentException.ThrowIfNullOrWhiteSpace(description);

        return new NPCDefinition
        {
            Id = id.ToLowerInvariant(),
            Name = name,
            Type = type,
            DefaultAttitude = defaultAttitude,
            Greeting = greeting,
            Description = description,
            Appearance = appearance ?? NPCAppearance.Default,
            RootDialogueId = rootDialogueId,
            FactionId = factionId?.ToLowerInvariant()
        };
    }
}
```

### 5.6 Room Entity Updates

```csharp
// Additions to existing Room class in RuneAndRust.Domain.Entities

/// <summary>
/// Backing field for NPCs collection.
/// </summary>
private readonly List<NPC> _npcs = [];

/// <summary>
/// Gets the NPCs currently in this room.
/// </summary>
public IReadOnlyList<NPC> NPCs => _npcs.AsReadOnly();

/// <summary>
/// Gets whether this room contains any NPCs.
/// </summary>
public bool HasNPCs => _npcs.Count > 0;

/// <summary>
/// Gets NPCs that are available for interaction.
/// </summary>
public IEnumerable<NPC> GetAvailableNPCs()
{
    return _npcs.Where(n => n.IsAvailable);
}

/// <summary>
/// Adds an NPC to this room.
/// </summary>
/// <param name="npc">The NPC to add.</param>
/// <exception cref="ArgumentNullException">Thrown if npc is null.</exception>
/// <exception cref="InvalidOperationException">Thrown if NPC is already in this room.</exception>
public void AddNPC(NPC npc)
{
    ArgumentNullException.ThrowIfNull(npc);

    if (_npcs.Any(n => n.Id == npc.Id))
    {
        throw new InvalidOperationException($"NPC {npc.Name} is already in this room.");
    }

    _npcs.Add(npc);
    npc.MoveTo(Id);
}

/// <summary>
/// Removes an NPC from this room.
/// </summary>
/// <param name="npcId">The ID of the NPC to remove.</param>
/// <returns>True if the NPC was removed, false if not found.</returns>
public bool RemoveNPC(Guid npcId)
{
    var npc = _npcs.FirstOrDefault(n => n.Id == npcId);
    if (npc == null)
    {
        return false;
    }

    _npcs.Remove(npc);
    npc.RemoveFromRoom();
    return true;
}

/// <summary>
/// Gets an NPC by name or ID.
/// </summary>
/// <param name="nameOrId">The name or ID to search for.</param>
/// <returns>The matching NPC, or null if not found.</returns>
/// <remarks>
/// Name matching is case-insensitive and supports partial matching.
/// </remarks>
public NPC? GetNPC(string nameOrId)
{
    if (string.IsNullOrWhiteSpace(nameOrId))
    {
        return null;
    }

    // Try exact ID match first
    if (Guid.TryParse(nameOrId, out var guid))
    {
        return _npcs.FirstOrDefault(n => n.Id == guid);
    }

    // Try exact name match (case-insensitive)
    var exactMatch = _npcs.FirstOrDefault(n =>
        n.Name.Equals(nameOrId, StringComparison.OrdinalIgnoreCase));

    if (exactMatch != null)
    {
        return exactMatch;
    }

    // Try partial name match (case-insensitive)
    return _npcs.FirstOrDefault(n =>
        n.Name.Contains(nameOrId, StringComparison.OrdinalIgnoreCase));
}
```

### 5.7 TalkResult Value Object

```csharp
namespace RuneAndRust.Domain.ValueObjects;

/// <summary>
/// Result of attempting to talk to an NPC.
/// </summary>
public readonly record struct TalkResult
{
    /// <summary>
    /// Gets whether the talk was successful.
    /// </summary>
    public bool Success { get; init; }

    /// <summary>
    /// Gets the result type.
    /// </summary>
    public TalkResultType Type { get; init; }

    /// <summary>
    /// Gets the NPC that was talked to (if successful).
    /// </summary>
    public NPC? NPC { get; init; }

    /// <summary>
    /// Gets the greeting or message to display.
    /// </summary>
    public string Message { get; init; }

    /// <summary>
    /// Gets available NPCs when disambiguation is needed.
    /// </summary>
    public IReadOnlyList<NPC>? AvailableNPCs { get; init; }

    /// <summary>
    /// Creates a successful talk result.
    /// </summary>
    public static TalkResult Succeeded(NPC npc)
    {
        return new TalkResult
        {
            Success = true,
            Type = TalkResultType.Success,
            NPC = npc,
            Message = npc.Greeting
        };
    }

    /// <summary>
    /// Creates a result for no NPCs in the room.
    /// </summary>
    public static TalkResult NoNPCs()
    {
        return new TalkResult
        {
            Success = false,
            Type = TalkResultType.NoNPCs,
            Message = "There's no one here to talk to."
        };
    }

    /// <summary>
    /// Creates a result for NPC refusing to talk.
    /// </summary>
    public static TalkResult Refused(NPC npc)
    {
        return new TalkResult
        {
            Success = false,
            Type = TalkResultType.Refused,
            NPC = npc,
            Message = npc.GetRefusalMessage()
        };
    }

    /// <summary>
    /// Creates a result when target NPC was not found.
    /// </summary>
    public static TalkResult NotFound(string npcName)
    {
        return new TalkResult
        {
            Success = false,
            Type = TalkResultType.NotFound,
            Message = $"You don't see anyone named '{npcName}' here."
        };
    }

    /// <summary>
    /// Creates a result when multiple NPCs match and clarification is needed.
    /// </summary>
    public static TalkResult Ambiguous(IReadOnlyList<NPC> npcs)
    {
        var names = string.Join(", ", npcs.Select(n => n.Name));
        return new TalkResult
        {
            Success = false,
            Type = TalkResultType.Ambiguous,
            AvailableNPCs = npcs,
            Message = $"Who do you want to talk to? You see: {names}"
        };
    }
}

/// <summary>
/// Types of talk command results.
/// </summary>
public enum TalkResultType
{
    /// <summary>Successfully started dialogue.</summary>
    Success,

    /// <summary>No NPCs in the room.</summary>
    NoNPCs,

    /// <summary>NPC refused to talk (hostile/unavailable).</summary>
    Refused,

    /// <summary>Specified NPC not found.</summary>
    NotFound,

    /// <summary>Multiple NPCs, need clarification.</summary>
    Ambiguous
}
```

---

## 6. Configuration Schemas

### 6.1 npcs.json

```json
{
  "$schema": "../schemas/npcs.schema.json",
  "npcs": [
    {
      "id": "grimbold-trader",
      "name": "Grimbold the Trader",
      "type": "Merchant",
      "defaultAttitude": "Neutral",
      "greeting": "Ah, a customer! Welcome, welcome. What brings you to my humble shop in these dangerous depths?",
      "description": "A stout dwarf with a braided beard sits behind a worn counter, eyeing you shrewdly.",
      "appearance": {
        "race": "Dwarf",
        "features": "braided gray beard, shrewd eyes",
        "attire": "leather apron over chainmail"
      },
      "rootDialogueId": "grimbold-main",
      "factionId": "merchant-guild"
    },
    {
      "id": "elara-wanderer",
      "name": "Elara",
      "type": "Informant",
      "defaultAttitude": "Wary",
      "greeting": "Keep your voice down. These walls have ears, and not all of them are friendly.",
      "description": "A cloaked figure leans against the wall, watching you carefully from the shadows.",
      "appearance": {
        "race": "Elf",
        "features": "sharp features, alert eyes",
        "attire": "dark traveling cloak"
      },
      "rootDialogueId": "elara-secrets",
      "factionId": null
    },
    {
      "id": "torvin-guard",
      "name": "Torvin",
      "type": "Companion",
      "defaultAttitude": "Neutral",
      "greeting": "Hail, traveler. These halls are treacherous. You look like you could use a sword arm at your side.",
      "description": "A battle-scarred warrior rests against his shield, watching the corridor with practiced vigilance.",
      "appearance": {
        "race": "Human",
        "features": "scarred face, weathered skin",
        "attire": "dented plate armor, worn tabard"
      },
      "rootDialogueId": "torvin-recruitment",
      "factionId": "adventurers-league"
    },
    {
      "id": "old-sage",
      "name": "The Old Sage",
      "type": "QuestGiver",
      "defaultAttitude": "Friendly",
      "greeting": "Ah, young one. The stars foretold your arrival. There is much I must tell you...",
      "description": "An ancient figure in faded robes sits cross-legged, surrounded by scattered scrolls and strange artifacts.",
      "appearance": {
        "race": "Human",
        "features": "long white beard, clouded eyes",
        "attire": "faded blue robes covered in arcane symbols"
      },
      "rootDialogueId": "sage-prophecy",
      "factionId": "seekers-of-knowledge"
    },
    {
      "id": "drunk-wanderer",
      "name": "Finn",
      "type": "Wanderer",
      "defaultAttitude": "Friendly",
      "greeting": "*hic* Hey there, friend! Pull up a rock, have a drink! No? More for me then!",
      "description": "A disheveled figure sits on a boulder, clutching a flask and humming an off-key tune.",
      "appearance": {
        "race": "Halfling",
        "features": "ruddy cheeks, perpetual grin",
        "attire": "stained traveling clothes, mismatched boots"
      },
      "rootDialogueId": null,
      "factionId": null
    }
  ]
}
```

### 6.2 npcs.schema.json

```json
{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "title": "NPC Configuration",
  "description": "Defines non-player characters for the game",
  "type": "object",
  "required": ["npcs"],
  "properties": {
    "npcs": {
      "type": "array",
      "description": "List of NPC definitions",
      "items": {
        "$ref": "#/definitions/npcDefinition"
      }
    }
  },
  "definitions": {
    "npcDefinition": {
      "type": "object",
      "required": ["id", "name", "type", "defaultAttitude", "greeting", "description"],
      "properties": {
        "id": {
          "type": "string",
          "pattern": "^[a-z][a-z0-9-]*$",
          "description": "Unique identifier (lowercase, alphanumeric with hyphens)"
        },
        "name": {
          "type": "string",
          "minLength": 1,
          "maxLength": 100,
          "description": "Display name of the NPC"
        },
        "type": {
          "type": "string",
          "enum": ["Merchant", "QuestGiver", "Informant", "Companion", "Wanderer"],
          "description": "Functional role of the NPC"
        },
        "defaultAttitude": {
          "type": "string",
          "enum": ["Friendly", "Neutral", "Wary", "Hostile"],
          "description": "Starting attitude toward players"
        },
        "greeting": {
          "type": "string",
          "minLength": 1,
          "maxLength": 500,
          "description": "Initial dialogue when player talks to NPC"
        },
        "description": {
          "type": "string",
          "minLength": 10,
          "maxLength": 500,
          "description": "Visual/narrative description of the NPC"
        },
        "appearance": {
          "$ref": "#/definitions/npcAppearance"
        },
        "rootDialogueId": {
          "type": ["string", "null"],
          "pattern": "^[a-z][a-z0-9-]*$",
          "description": "ID of root dialogue node (null for greeting-only)"
        },
        "factionId": {
          "type": ["string", "null"],
          "pattern": "^[a-z][a-z0-9-]*$",
          "description": "Faction this NPC belongs to (null for unaffiliated)"
        }
      }
    },
    "npcAppearance": {
      "type": "object",
      "properties": {
        "race": {
          "type": "string",
          "minLength": 1,
          "description": "Race or species of the NPC"
        },
        "features": {
          "type": "string",
          "minLength": 1,
          "description": "Notable physical features"
        },
        "attire": {
          "type": "string",
          "minLength": 1,
          "description": "Clothing or armor description"
        }
      },
      "required": ["race", "features", "attire"]
    }
  }
}
```

---

## 7. Service Specifications

### 7.1 NPCService

```csharp
namespace RuneAndRust.Application.Services;

/// <summary>
/// Provides operations for NPC management and interaction.
/// </summary>
public class NPCService
{
    private readonly IReadOnlyList<NPCDefinition> _definitions;
    private readonly ILogger<NPCService> _logger;

    /// <summary>
    /// Initializes a new instance of NPCService.
    /// </summary>
    /// <param name="configProvider">Configuration provider for loading NPC definitions.</param>
    /// <param name="logger">Logger instance.</param>
    public NPCService(
        IConfigurationProvider configProvider,
        ILogger<NPCService> logger)
    {
        _logger = logger;
        _definitions = configProvider.LoadNPCDefinitions();

        _logger.LogInformation(
            "NPCService initialized with {NPCCount} NPC definitions",
            _definitions.Count);
    }

    /// <summary>
    /// Gets all NPC definitions.
    /// </summary>
    /// <returns>List of all NPC definitions.</returns>
    public IReadOnlyList<NPCDefinition> GetAllNPCDefinitions()
    {
        _logger.LogDebug("GetAllNPCDefinitions called");
        return _definitions;
    }

    /// <summary>
    /// Gets an NPC definition by ID.
    /// </summary>
    /// <param name="id">The definition ID.</param>
    /// <returns>The definition, or null if not found.</returns>
    public NPCDefinition? GetNPCDefinition(string id)
    {
        _logger.LogDebug("GetNPCDefinition called for ID: {DefinitionId}", id);
        return _definitions.FirstOrDefault(d =>
            d.Id.Equals(id, StringComparison.OrdinalIgnoreCase));
    }

    /// <summary>
    /// Creates an NPC instance from a definition.
    /// </summary>
    /// <param name="definitionId">The definition ID.</param>
    /// <param name="roomId">Optional room to place the NPC in.</param>
    /// <returns>A new NPC instance.</returns>
    /// <exception cref="ArgumentException">Thrown if definition not found.</exception>
    public NPC CreateNPC(string definitionId, Guid? roomId = null)
    {
        _logger.LogDebug("CreateNPC called for definition: {DefinitionId}", definitionId);

        var definition = GetNPCDefinition(definitionId)
            ?? throw new ArgumentException($"NPC definition not found: {definitionId}", nameof(definitionId));

        var npc = NPC.Create(definition, roomId);

        _logger.LogInformation(
            "Created NPC {NPCName} ({NPCId}) from definition {DefinitionId}",
            npc.Name, npc.Id, definitionId);

        return npc;
    }

    /// <summary>
    /// Attempts to talk to an NPC in the given room.
    /// </summary>
    /// <param name="player">The player initiating dialogue.</param>
    /// <param name="room">The current room.</param>
    /// <param name="npcName">Optional NPC name to target.</param>
    /// <returns>The result of the talk attempt.</returns>
    public TalkResult TryTalkToNPC(Player player, Room room, string? npcName = null)
    {
        ArgumentNullException.ThrowIfNull(player);
        ArgumentNullException.ThrowIfNull(room);

        _logger.LogDebug(
            "TryTalkToNPC called by {PlayerName} in room {RoomId}, target: {NPCName}",
            player.Name, room.Id, npcName ?? "(any)");

        var availableNPCs = room.GetAvailableNPCs().ToList();

        if (availableNPCs.Count == 0)
        {
            _logger.LogDebug("No NPCs available in room");
            return TalkResult.NoNPCs();
        }

        NPC? targetNPC;

        if (string.IsNullOrWhiteSpace(npcName))
        {
            // No name specified - need exactly one NPC or ambiguous
            if (availableNPCs.Count > 1)
            {
                _logger.LogDebug("Multiple NPCs in room, disambiguation needed");
                return TalkResult.Ambiguous(availableNPCs);
            }

            targetNPC = availableNPCs[0];
        }
        else
        {
            // Name specified - find matching NPC
            targetNPC = room.GetNPC(npcName);

            if (targetNPC == null)
            {
                _logger.LogDebug("NPC not found: {NPCName}", npcName);
                return TalkResult.NotFound(npcName);
            }
        }

        // Check if NPC will talk
        if (!targetNPC.WillTalk())
        {
            _logger.LogInformation(
                "NPC {NPCName} refused to talk (Attitude: {Attitude}, Available: {Available})",
                targetNPC.Name, targetNPC.Attitude, targetNPC.IsAvailable);
            return TalkResult.Refused(targetNPC);
        }

        _logger.LogInformation(
            "Player {PlayerName} started dialogue with {NPCName}",
            player.Name, targetNPC.Name);

        return TalkResult.Succeeded(targetNPC);
    }
}
```

### 7.2 GameSessionService Updates

```csharp
// Additions to existing GameSessionService

/// <summary>
/// Attempts to talk to an NPC in the current room.
/// </summary>
/// <param name="npcName">Optional NPC name to target.</param>
/// <returns>The result of the talk attempt.</returns>
public TalkResult TryTalk(string? npcName = null)
{
    EnsureGameStarted();

    _logger.LogDebug("TryTalk called with target: {NPCName}", npcName ?? "(any)");

    var result = _npcService.TryTalkToNPC(_player!, _currentRoom!, npcName);

    return result;
}
```

### 7.3 IConfigurationProvider Updates

```csharp
// Additions to IConfigurationProvider interface

/// <summary>
/// Loads all NPC definitions from configuration.
/// </summary>
/// <returns>List of NPC definitions.</returns>
IReadOnlyList<NPCDefinition> LoadNPCDefinitions();

/// <summary>
/// Gets a specific NPC definition by ID.
/// </summary>
/// <param name="id">The definition ID.</param>
/// <returns>The definition, or null if not found.</returns>
NPCDefinition? GetNPCDefinition(string id);
```

---

## 8. Talk Command Flow

### 8.1 Input Handling

```csharp
// In InputHandler or CommandParser

/// <summary>
/// Parses a talk command.
/// </summary>
/// <param name="input">The raw input string.</param>
/// <returns>Parsed command information.</returns>
public CommandInfo ParseTalkCommand(string input)
{
    var parts = input.Trim().Split(' ', 2, StringSplitOptions.RemoveEmptyEntries);

    if (parts.Length == 0 || !parts[0].Equals("talk", StringComparison.OrdinalIgnoreCase))
    {
        return CommandInfo.Invalid("Invalid command");
    }

    var targetName = parts.Length > 1 ? parts[1].Trim() : null;

    return new CommandInfo
    {
        Command = CommandType.Talk,
        TargetName = targetName
    };
}
```

### 8.2 Command Execution

```
User Input: "talk" or "talk grimbold"
    │
    ▼
┌─────────────────┐
│  InputHandler   │
│ ParseTalkCmd()  │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│GameSessionSvc   │
│   TryTalk()     │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│   NPCService    │
│ TryTalkToNPC()  │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│   TalkResult    │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│ IGameRenderer   │
│RenderTalkResult │
└─────────────────┘
```

---

## 9. User-Facing Changes

### 9.1 Commands

```
> talk                    # Talk to the only NPC in the room
> talk <npc>              # Talk to a specific NPC by name
> look                    # Room description now shows NPCs
```

### 9.2 Output Examples

#### Room with NPC

```
╔════════════════════════════════════════════════════════════════════════╗
║                    DUSTY MERCHANT'S ALCOVE                             ║
╠════════════════════════════════════════════════════════════════════════╣
║                                                                        ║
║  Wooden shelves line the walls of this cramped space, filled with     ║
║  various wares and trinkets. A faint smell of pipe smoke lingers.     ║
║                                                                        ║
║  ─────────────────────────────────────────────────────────────────     ║
║                                                                        ║
║  Items:                                                                ║
║  - Dusty Lantern                                                       ║
║  - Empty Crate                                                         ║
║                                                                        ║
║  NPCs:                                                                 ║
║  - Grimbold the Trader (Merchant)                                      ║
║                                                                        ║
║  Exits: north, south                                                   ║
║                                                                        ║
╚════════════════════════════════════════════════════════════════════════╝
```

#### Successful Talk

```
> talk

╔════════════════════════════════════════════════════════════════════════╗
║                         GRIMBOLD THE TRADER                            ║
╠════════════════════════════════════════════════════════════════════════╣
║                                                                        ║
║  A stout dwarf with a braided beard sits behind a worn counter,       ║
║  eyeing you shrewdly.                                                  ║
║                                                                        ║
║  "Ah, a customer! Welcome, welcome. What brings you to my humble      ║
║  shop in these dangerous depths?"                                      ║
║                                                                        ║
║  [Dialogue options will be available in a future update]               ║
║                                                                        ║
╚════════════════════════════════════════════════════════════════════════╝
```

#### Multiple NPCs (Ambiguous)

```
> talk

Who do you want to talk to? You see: Grimbold the Trader, Elara

Use 'talk <name>' to specify who you want to talk to.
```

#### Hostile NPC

```
> talk

Elara glares at you with open hostility and refuses to speak.
```

#### NPC Not Found

```
> talk bob

You don't see anyone named 'bob' here.
```

#### No NPCs

```
> talk

There's no one here to talk to.
```

---

## 10. Logging Requirements

### 10.1 Log Events

| Event | Level | Message Template | Properties |
|-------|-------|------------------|------------|
| Service Init | Information | "NPCService initialized with {NPCCount} NPC definitions" | NPCCount |
| Definition Loaded | Debug | "Loaded NPC definition: {DefinitionId} ({NPCName})" | DefinitionId, NPCName |
| NPC Created | Information | "Created NPC {NPCName} ({NPCId}) from definition {DefinitionId}" | NPCName, NPCId, DefinitionId |
| Talk Attempted | Debug | "TryTalkToNPC called by {PlayerName} in room {RoomId}, target: {NPCName}" | PlayerName, RoomId, NPCName |
| Talk Success | Information | "Player {PlayerName} started dialogue with {NPCName}" | PlayerName, NPCName |
| Talk Refused | Information | "NPC {NPCName} refused to talk (Attitude: {Attitude}, Available: {Available})" | NPCName, Attitude, Available |
| NPC Not Found | Debug | "NPC not found: {NPCName}" | NPCName |
| NPC Added to Room | Debug | "NPC {NPCName} added to room {RoomId}" | NPCName, RoomId |
| NPC Removed | Debug | "NPC {NPCName} removed from room {RoomId}" | NPCName, RoomId |
| Config Load Error | Error | "Failed to load NPC definitions: {ErrorMessage}" | ErrorMessage |
| Invalid Definition | Warning | "Invalid NPC definition: {DefinitionId} - {ErrorMessage}" | DefinitionId, ErrorMessage |

### 10.2 Example Log Output

```
[2024-01-15 10:30:15 INF] NPCService initialized with 5 NPC definitions
[2024-01-15 10:30:15 DBG] Loaded NPC definition: grimbold-trader (Grimbold the Trader)
[2024-01-15 10:30:15 DBG] Loaded NPC definition: elara-wanderer (Elara)
[2024-01-15 10:30:15 DBG] Loaded NPC definition: torvin-guard (Torvin)
[2024-01-15 10:30:15 DBG] Loaded NPC definition: old-sage (The Old Sage)
[2024-01-15 10:30:15 DBG] Loaded NPC definition: drunk-wanderer (Finn)
[2024-01-15 10:32:45 INF] Created NPC Grimbold the Trader (a1b2c3d4-...) from definition grimbold-trader
[2024-01-15 10:32:45 DBG] NPC Grimbold the Trader added to room e5f6g7h8-...
[2024-01-15 10:35:12 DBG] TryTalkToNPC called by Astrid in room e5f6g7h8-..., target: (any)
[2024-01-15 10:35:12 INF] Player Astrid started dialogue with Grimbold the Trader
```

---

## 11. Unit Test Specifications

### 11.1 NPC Entity Tests (~8 tests)

```csharp
namespace RuneAndRust.Domain.Tests.Entities;

[TestFixture]
public class NPCTests
{
    private NPCDefinition _testDefinition;

    [SetUp]
    public void Setup()
    {
        _testDefinition = NPCDefinition.Create(
            "test-npc",
            "Test NPC",
            NPCType.Merchant,
            NPCAttitude.Neutral,
            "Hello, traveler!",
            "A test NPC for unit testing.",
            new NPCAppearance { Race = "Human", Features = "plain", Attire = "simple clothes" });
    }

    [Test]
    public void Create_WithValidDefinition_ReturnsNPC()
    {
        var npc = NPC.Create(_testDefinition);

        npc.Should().NotBeNull();
        npc.Id.Should().NotBe(Guid.Empty);
        npc.Name.Should().Be("Test NPC");
        npc.Type.Should().Be(NPCType.Merchant);
        npc.Attitude.Should().Be(NPCAttitude.Neutral);
    }

    [Test]
    public void Create_WithNullDefinition_ThrowsArgumentNullException()
    {
        var act = () => NPC.Create(null!);

        act.Should().Throw<ArgumentNullException>();
    }

    [Test]
    public void Create_WithRoomId_SetsCurrentRoomId()
    {
        var roomId = Guid.NewGuid();
        var npc = NPC.Create(_testDefinition, roomId);

        npc.CurrentRoomId.Should().Be(roomId);
    }

    [Test]
    public void WillTalk_WithNeutralAttitude_ReturnsTrue()
    {
        var npc = NPC.Create(_testDefinition);

        npc.WillTalk().Should().BeTrue();
    }

    [Test]
    public void WillTalk_WithHostileAttitude_ReturnsFalse()
    {
        var npc = NPC.Create(_testDefinition);
        npc.SetAttitude(NPCAttitude.Hostile);

        npc.WillTalk().Should().BeFalse();
    }

    [Test]
    public void WillTalk_WhenUnavailable_ReturnsFalse()
    {
        var npc = NPC.Create(_testDefinition);
        npc.SetAvailability(false);

        npc.WillTalk().Should().BeFalse();
    }

    [Test]
    public void SetAttitude_ChangesCurrentAttitude()
    {
        var npc = NPC.Create(_testDefinition);
        npc.SetAttitude(NPCAttitude.Friendly);

        npc.Attitude.Should().Be(NPCAttitude.Friendly);
        npc.BaseAttitude.Should().Be(NPCAttitude.Neutral);
    }

    [Test]
    public void ResetAttitude_RestoresToBaseAttitude()
    {
        var npc = NPC.Create(_testDefinition);
        npc.SetAttitude(NPCAttitude.Hostile);
        npc.ResetAttitude();

        npc.Attitude.Should().Be(NPCAttitude.Neutral);
    }
}
```

### 11.2 NPCDefinition Tests (~5 tests)

```csharp
[TestFixture]
public class NPCDefinitionTests
{
    [Test]
    public void Create_WithValidParameters_ReturnsDefinition()
    {
        var definition = NPCDefinition.Create(
            "test-merchant",
            "Test Merchant",
            NPCType.Merchant,
            NPCAttitude.Neutral,
            "Welcome!",
            "A test merchant.");

        definition.Id.Should().Be("test-merchant");
        definition.Name.Should().Be("Test Merchant");
        definition.Type.Should().Be(NPCType.Merchant);
    }

    [Test]
    public void Create_WithNullId_ThrowsArgumentException()
    {
        var act = () => NPCDefinition.Create(
            null!, "Name", NPCType.Merchant, NPCAttitude.Neutral, "Hi", "Desc");

        act.Should().Throw<ArgumentException>();
    }

    [Test]
    public void Create_WithEmptyGreeting_ThrowsArgumentException()
    {
        var act = () => NPCDefinition.Create(
            "id", "Name", NPCType.Merchant, NPCAttitude.Neutral, "", "Desc");

        act.Should().Throw<ArgumentException>();
    }

    [Test]
    public void Create_NormalizesIdToLowercase()
    {
        var definition = NPCDefinition.Create(
            "TEST-NPC", "Test", NPCType.Wanderer, NPCAttitude.Neutral, "Hi", "Desc");

        definition.Id.Should().Be("test-npc");
    }

    [Test]
    public void Create_WithOptionalAppearance_UsesDefaultWhenNull()
    {
        var definition = NPCDefinition.Create(
            "test", "Test", NPCType.Wanderer, NPCAttitude.Neutral, "Hi", "Desc",
            appearance: null);

        definition.Appearance.Race.Should().Be("Human");
    }
}
```

### 11.3 NPCAppearance Tests (~3 tests)

```csharp
[TestFixture]
public class NPCAppearanceTests
{
    [Test]
    public void Default_ReturnsHumanAppearance()
    {
        var appearance = NPCAppearance.Default;

        appearance.Race.Should().Be("Human");
        appearance.Features.Should().NotBeEmpty();
        appearance.Attire.Should().NotBeEmpty();
    }

    [Test]
    public void ToDescription_FormatsCorrectly()
    {
        var appearance = new NPCAppearance
        {
            Race = "Dwarf",
            Features = "braided beard",
            Attire = "leather apron"
        };

        var description = appearance.ToDescription();

        description.Should().Contain("dwarf");
        description.Should().Contain("braided beard");
        description.Should().Contain("leather apron");
    }

    [Test]
    public void RecordEquality_WorksCorrectly()
    {
        var a = new NPCAppearance { Race = "Elf", Features = "sharp", Attire = "cloak" };
        var b = new NPCAppearance { Race = "Elf", Features = "sharp", Attire = "cloak" };

        a.Should().Be(b);
    }
}
```

### 11.4 Room NPC Methods Tests (~7 tests)

```csharp
[TestFixture]
public class RoomNPCTests
{
    private Room _room;
    private NPC _testNPC;

    [SetUp]
    public void Setup()
    {
        _room = Room.Create("Test Room", "A test room.");
        var definition = NPCDefinition.Create(
            "test", "Test NPC", NPCType.Wanderer, NPCAttitude.Neutral, "Hi", "Desc");
        _testNPC = NPC.Create(definition);
    }

    [Test]
    public void AddNPC_AddsNPCToCollection()
    {
        _room.AddNPC(_testNPC);

        _room.NPCs.Should().Contain(_testNPC);
        _room.HasNPCs.Should().BeTrue();
    }

    [Test]
    public void AddNPC_SetsNPCRoomId()
    {
        _room.AddNPC(_testNPC);

        _testNPC.CurrentRoomId.Should().Be(_room.Id);
    }

    [Test]
    public void AddNPC_WithNullNPC_ThrowsArgumentNullException()
    {
        var act = () => _room.AddNPC(null!);

        act.Should().Throw<ArgumentNullException>();
    }

    [Test]
    public void AddNPC_WhenAlreadyInRoom_ThrowsInvalidOperationException()
    {
        _room.AddNPC(_testNPC);
        var act = () => _room.AddNPC(_testNPC);

        act.Should().Throw<InvalidOperationException>();
    }

    [Test]
    public void RemoveNPC_RemovesNPCFromCollection()
    {
        _room.AddNPC(_testNPC);
        var result = _room.RemoveNPC(_testNPC.Id);

        result.Should().BeTrue();
        _room.NPCs.Should().NotContain(_testNPC);
    }

    [Test]
    public void GetNPC_ByName_ReturnsNPC()
    {
        _room.AddNPC(_testNPC);

        var found = _room.GetNPC("Test NPC");

        found.Should().Be(_testNPC);
    }

    [Test]
    public void GetNPC_ByPartialName_ReturnsNPC()
    {
        _room.AddNPC(_testNPC);

        var found = _room.GetNPC("test");

        found.Should().Be(_testNPC);
    }
}
```

### 11.5 NPCService Tests (~7 tests)

```csharp
[TestFixture]
public class NPCServiceTests
{
    private Mock<IConfigurationProvider> _configProviderMock;
    private Mock<ILogger<NPCService>> _loggerMock;
    private NPCService _service;
    private List<NPCDefinition> _definitions;

    [SetUp]
    public void Setup()
    {
        _definitions = new List<NPCDefinition>
        {
            NPCDefinition.Create("merchant", "Merchant", NPCType.Merchant,
                NPCAttitude.Neutral, "Hello!", "A merchant."),
            NPCDefinition.Create("guard", "Guard", NPCType.Companion,
                NPCAttitude.Wary, "Halt!", "A guard.")
        };

        _configProviderMock = new Mock<IConfigurationProvider>();
        _configProviderMock.Setup(x => x.LoadNPCDefinitions()).Returns(_definitions);

        _loggerMock = new Mock<ILogger<NPCService>>();

        _service = new NPCService(_configProviderMock.Object, _loggerMock.Object);
    }

    [Test]
    public void GetAllNPCDefinitions_ReturnsAllDefinitions()
    {
        var result = _service.GetAllNPCDefinitions();

        result.Should().HaveCount(2);
    }

    [Test]
    public void GetNPCDefinition_WithValidId_ReturnsDefinition()
    {
        var result = _service.GetNPCDefinition("merchant");

        result.Should().NotBeNull();
        result!.Name.Should().Be("Merchant");
    }

    [Test]
    public void GetNPCDefinition_WithInvalidId_ReturnsNull()
    {
        var result = _service.GetNPCDefinition("nonexistent");

        result.Should().BeNull();
    }

    [Test]
    public void CreateNPC_WithValidDefinitionId_ReturnsNPC()
    {
        var npc = _service.CreateNPC("merchant");

        npc.Should().NotBeNull();
        npc.Name.Should().Be("Merchant");
    }

    [Test]
    public void CreateNPC_WithInvalidDefinitionId_ThrowsArgumentException()
    {
        var act = () => _service.CreateNPC("nonexistent");

        act.Should().Throw<ArgumentException>();
    }

    [Test]
    public void TryTalkToNPC_WithSingleNPC_ReturnsSuccess()
    {
        var player = CreateTestPlayer();
        var room = Room.Create("Test", "Test room");
        var npc = _service.CreateNPC("merchant");
        room.AddNPC(npc);

        var result = _service.TryTalkToNPC(player, room);

        result.Success.Should().BeTrue();
        result.NPC.Should().Be(npc);
    }

    [Test]
    public void TryTalkToNPC_WithNoNPCs_ReturnsNoNPCs()
    {
        var player = CreateTestPlayer();
        var room = Room.Create("Test", "Test room");

        var result = _service.TryTalkToNPC(player, room);

        result.Success.Should().BeFalse();
        result.Type.Should().Be(TalkResultType.NoNPCs);
    }

    private Player CreateTestPlayer() => Player.Create("Test Player");
}
```

---

## 12. Use Cases

### UC-001: View NPCs in Room
**Actor:** Player
**Flow:** Enter room → Look command → See NPC list → See NPC names and types

### UC-002: Talk to Single NPC
**Actor:** Player
**Flow:** Enter room with one NPC → Talk command → See greeting → [Dialogue ends]

### UC-003: Talk to Specific NPC
**Actor:** Player
**Flow:** Enter room with multiple NPCs → Talk <name> → See greeting → [Dialogue ends]

### UC-004: Disambiguate Multiple NPCs
**Actor:** Player
**Flow:** Enter room with multiple NPCs → Talk command → See list of NPCs → Talk <name> → See greeting

### UC-005: Handle Hostile NPC
**Actor:** Player
**Flow:** Enter room with hostile NPC → Talk command → See refusal message

### UC-006: Handle Missing NPC
**Actor:** Player
**Flow:** Room with NPC → Talk <wrong-name> → See "not found" message

### UC-007: Configure New NPC
**Actor:** Game Designer
**Flow:** Edit npcs.json → Add NPC definition → Start game → NPC spawnable

---

## 13. Acceptance Criteria

### AC-2.0a-1: NPC Entity
- [ ] NPC entity can be created from NPCDefinition
- [ ] NPC stores Id, DefinitionId, Name, Type, Attitude, Description
- [ ] NPC tracks CurrentRoomId
- [ ] NPC.WillTalk() returns false for Hostile attitude
- [ ] NPC.WillTalk() returns false when unavailable

### AC-2.0a-2: NPCType Enum
- [ ] NPCType has 5 values: Merchant, QuestGiver, Informant, Companion, Wanderer
- [ ] All values have XML documentation

### AC-2.0a-3: NPCAttitude Enum
- [ ] NPCAttitude has 4 values: Friendly, Neutral, Wary, Hostile
- [ ] All values have XML documentation

### AC-2.0a-4: Room NPCs Collection
- [ ] Room.NPCs returns readonly list of NPCs
- [ ] Room.AddNPC() adds NPC and sets CurrentRoomId
- [ ] Room.RemoveNPC() removes NPC by ID
- [ ] Room.GetNPC() finds NPC by name (case-insensitive, partial match)
- [ ] Room.HasNPCs returns true when NPCs present

### AC-2.0a-5: Talk Command
- [ ] `talk` command initiates dialogue with single NPC
- [ ] `talk <name>` targets specific NPC
- [ ] Multiple NPCs without target shows disambiguation
- [ ] Hostile NPC shows refusal message
- [ ] Missing NPC shows "not found" message
- [ ] No NPCs shows "no one here" message

### AC-2.0a-6: NPC Display
- [ ] Room description shows NPC names
- [ ] NPCs appear after items in look output
- [ ] Successful talk shows NPC description and greeting

### AC-2.0a-7: Configuration
- [ ] NPCs can be defined in npcs.json
- [ ] npcs.schema.json validates configuration
- [ ] Invalid configuration produces clear error messages
- [ ] All NPC properties are configurable

### AC-2.0a-8: Logging
- [ ] Service initialization logs NPC definition count
- [ ] NPC creation logs name, ID, and definition ID
- [ ] Talk attempts log player, room, and target
- [ ] Successful talks log player and NPC names

### AC-2.0a-9: Unit Tests
- [ ] ~30 unit tests implemented
- [ ] All tests pass
- [ ] Tests cover happy path and error cases

---

## 14. Deliverable Checklist

### Domain Layer
- [ ] `Entities/NPC.cs`
- [ ] `Definitions/NPCDefinition.cs`
- [ ] `Enums/NPCType.cs`
- [ ] `Enums/NPCAttitude.cs`
- [ ] `ValueObjects/NPCAppearance.cs`
- [ ] `ValueObjects/TalkResult.cs`
- [ ] `Entities/Room.cs` updates (NPCs collection, AddNPC, RemoveNPC, GetNPC)

### Application Layer
- [ ] `Services/NPCService.cs`
- [ ] `Services/GameSessionService.cs` updates (TryTalk method)
- [ ] `DTOs/NPCDto.cs`
- [ ] `DTOs/TalkResultDto.cs`
- [ ] `Interfaces/IConfigurationProvider.cs` updates

### Infrastructure Layer
- [ ] `Configuration/JsonConfigurationProvider.cs` updates (LoadNPCDefinitions)

### Configuration Files
- [ ] `config/npcs.json`
- [ ] `config/schemas/npcs.schema.json`

### Presentation Layer
- [ ] Talk command handler
- [ ] Look handler updates (show NPCs)
- [ ] IGameRenderer updates (RenderTalkResult, RenderNPC)

### Tests
- [ ] `Domain.Tests/Entities/NPCTests.cs`
- [ ] `Domain.Tests/Definitions/NPCDefinitionTests.cs`
- [ ] `Domain.Tests/ValueObjects/NPCAppearanceTests.cs`
- [ ] `Domain.Tests/Entities/RoomNPCTests.cs`
- [ ] `Application.Tests/Services/NPCServiceTests.cs`

### Documentation
- [ ] XML documentation on all public members
- [ ] JSON schema documentation

---

## 15. Dependencies

### Required from Previous Versions
- Room entity (from early version)
- Player entity (from v0.0.3)
- IConfigurationProvider interface (from v0.0.4a)
- IGameRenderer interface (from early version)
- GameSessionService (from early version)

### Provided to v0.2.0b (Dialogue System)
- NPC entity with RootDialogueId
- NPCAttitude for dialogue conditions
- TalkResult as dialogue entry point
- NPCService for NPC lookup

### Provided to v0.2.0c (Reputation & Memory)
- NPCDefinition.FactionId for reputation tracking
- NPC.SetAttitude() for reputation-based attitude changes
- NPC entity for memory storage

### Provided to v0.2.0d (Companions)
- NPC entity as companion base
- NPCType.Companion for recruitability
- NPC.SetAvailability() for companion status

---

## 16. Future Considerations

### Deferred to v0.2.0b
- **Dialogue Trees**: Branching conversations with multiple nodes
- **Dialogue Conditions**: Requirements to show dialogue options
- **Dialogue Outcomes**: Results of dialogue choices
- **Persuasion Checks**: Dice rolls to influence NPC responses

### Deferred to v0.2.0c
- **Faction System**: NPC faction membership affecting interactions
- **Reputation Tracking**: Player standing with factions
- **NPC Memory**: NPCs remembering previous interactions
- **Attitude Changes**: Reputation-based attitude modifications

### Deferred to v0.2.0d
- **Companion Recruitment**: NPCs joining player party
- **Companion Combat**: Companions fighting alongside player
- **Companion Equipment**: Equipping items on companions
- **Companion Orders**: Commanding companions in combat

### Out of Scope
- **NPC AI/Movement**: NPCs moving between rooms autonomously
- **NPC Schedules**: Time-based NPC behavior
- **NPC Combat**: NPCs as enemies (use Monster entity instead)
- **Shop System**: Buying/selling items (deferred to v0.2.2)

---

*Document Version: 1.0*
*Last Updated: 2024-01-15*
*Author: Claude Code*
