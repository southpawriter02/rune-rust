# v0.10.3c Changelog: Zone Control

**Version:** 0.10.3c
**Phase:** Zone Control - Persistent Area Effects
**Date:** 2026-01-19
**Status:** Complete

---

## Summary

Implements the zone control system for persistent area effects during combat. Zones are area-of-effect abilities that remain on the combat grid for multiple turns, applying damage, healing, buffs, debuffs, or terrain effects to entities within their area each round. Includes zone shape calculations (Circle, Square, Line, Cone, Ring), tick-based effect processing, duration management, and friendly/enemy targeting rules. Provides `IZoneEffectService` with full lifecycle management, `IZoneProvider` for definition access, and comprehensive event logging for combat integration. Includes 11 unit tests covering all major functionality.

---

## Added

### Domain Layer - Enums

| Enum | Values | Description |
|------|--------|-------------|
| `ZoneEffectType` | Damage, Healing, Buff, Debuff, Terrain, Mixed | Type of effect a zone applies |
| `ZoneShape` | Circle, Square, Line, Cone, Ring | Shape of zone area on grid |

**ZoneEffectType Enum:**
- `Damage` - Deals damage to entities each tick
- `Healing` - Restores health to entities each tick
- `Buff` - Applies positive status effects
- `Debuff` - Applies negative status effects
- `Terrain` - Modifies terrain (difficult, blocking, obscured)
- `Mixed` - Combines multiple effect types

**ZoneShape Enum:**
- `Circle` - Euclidean distance from center
- `Square` - Manhattan distance (axis-aligned box)
- `Line` - Linear cells in a direction
- `Cone` - Expanding cells in a direction
- `Ring` - Hollow circle (outer edge only)

### Domain Layer - Definitions

| Class | Properties | Description |
|-------|------------|-------------|
| `ZoneDefinition` | ZoneId, Name, Description, EffectType, Shape, Radius, Duration, DamageValue, DamageType, HealValue, StatusEffectId, TerrainModifier, AffectsFriendly, AffectsEnemy, MonsterTypes | Zone template from configuration |

**ZoneDefinition Features:**
- Private constructor with static `Create()` factory method
- Fluent configuration via `WithDamage()`, `WithHealing()`, `WithStatusEffect()`, `WithTerrainModifier()`, `WithMonsterTypes()`, `WithIcon()`
- Query methods: `DealsDamage()`, `ProvidesHealing()`, `AppliesStatusEffect()`, `ModifiesTerrain()`, `HasMonsterTypeRestriction()`, `AffectsMonsterType()`, `RequiresDirection()`
- Implements `IEntity` interface

### Domain Layer - Entities

| Class | Properties | Description |
|-------|------------|-------------|
| `ZoneEffect` | Id, ZoneId, Name, EffectType, Shape, Center, Radius, RemainingDuration, CasterId, DamageValue, DamageType, HealValue, StatusEffectId, TerrainModifier, AffectsFriendly, AffectsEnemy, AffectedCells, CreatedAt | Active zone instance on grid |

**ZoneEffect Features:**
- Private constructor with static `Create()` factory method
- Creates from `ZoneDefinition` with pre-calculated affected cells
- Computed properties: `IsExpired`, `CellCount`, `DealsDamage`, `ProvidesHealing`, `AppliesStatusEffect`
- Methods: `Tick()` (decrements duration), `ContainsPosition()`, `ExtendDuration()`
- Implements `IEntity` interface

### Application Layer - Interfaces

| Interface | Methods |
|-----------|---------|
| `IZoneProvider` | GetZone, GetAllZones, GetZonesByType, GetZonesByShape, GetZoneCount, ZoneExists |
| `IZoneEffectService` | CreateZone, RemoveZone, RemoveZonesByCaster, ClearAllZones, GetZonesAt, GetAllActiveZones, GetZonesByCaster, GetZonesByType, GetActiveZoneCount, GetZoneCountByCaster, TickZones, OnEntityEntered, OnEntityExited, IsPositionInZone, IsPositionInDamageZone, IsPositionInHealingZone |

**IZoneProvider Methods:**
- `GetZone(zoneId)` - Get zone definition by ID (case-insensitive)
- `GetAllZones()` - Get all configured zone definitions
- `GetZonesByType(effectType)` - Filter by effect type
- `GetZonesByShape(shape)` - Filter by shape
- `GetZoneCount()` - Total count of definitions
- `ZoneExists(zoneId)` - Check if zone definition exists

**IZoneEffectService Methods:**
- `CreateZone(zoneId, center, caster)` - Create zone at position
- `CreateZone(zoneId, center, direction, caster)` - Create with explicit direction
- `RemoveZone(zoneEffectId)` - Remove specific zone
- `RemoveZonesByCaster(casterId)` - Remove all zones by caster
- `ClearAllZones()` - Clear all zones (combat end)
- `GetZonesAt(position)` - Get zones affecting position
- `GetAllActiveZones()` - Get all active zones
- `GetZonesByCaster(casterId)` - Filter by caster
- `GetZonesByType(effectType)` - Filter by effect type
- `GetActiveZoneCount()` - Total active zone count
- `GetZoneCountByCaster(casterId)` - Count by caster
- `TickZones(combatants)` - Apply effects and decrement durations
- `OnEntityEntered(combatant, position)` - Handle zone entry
- `OnEntityExited(combatant, position)` - Handle zone exit
- `IsPositionInZone(position)` - Check if in any zone
- `IsPositionInDamageZone(position)` - Check if in damage zone
- `IsPositionInHealingZone(position)` - Check if in healing zone

### Application Layer - DTOs

| Class | Properties | Description |
|-------|------------|-------------|
| `ZoneTickResult` | TotalDamageDealt, TotalHealingDone, EntitiesDamaged, EntitiesHealed, ExpiredZones | Result of ticking all zones |

**ZoneTickResult Features:**
- Immutable record type
- Factory method: `Empty()` creates zero-value result
- Builder methods: `WithDamage()`, `WithHealing()`, `WithExpiredZone()`
- Computed: `HasEffects` - True if any effects applied

### Application Layer - Events

| Event Record | Parameters | Description |
|--------------|------------|-------------|
| `ZoneCreatedEvent` | ZoneEffectId, ZoneId, Name, Center, CasterId, CellCount, Duration | Zone created on grid |
| `ZoneExpiredEvent` | ZoneEffectId, ZoneId, Name, Reason | Zone expired/removed |
| `ZoneDamageEvent` | ZoneEffectId, ZoneId, TargetId, TargetName, Damage, DamageType | Zone dealt damage |
| `ZoneHealEvent` | ZoneEffectId, ZoneId, TargetId, TargetName, HealAmount | Zone provided healing |
| `ZoneStatusAppliedEvent` | ZoneEffectId, ZoneId, TargetId, TargetName, StatusEffectId | Zone applied status |
| `ZoneEnteredEvent` | ZoneEffectId, ZoneId, CombatantId, CombatantName, Position | Entity entered zone |
| `ZoneExitedEvent` | ZoneEffectId, ZoneId, CombatantId, CombatantName, Position | Entity exited zone |

**Expiration Reasons:**
- `"Duration"` - Duration reached zero
- `"Removed"` - Manually removed
- `"Combat Ended"` - All zones cleared

### Application Layer - Services

| Service | Dependencies | Description |
|---------|--------------|-------------|
| `ZoneEffectService` | IZoneProvider, ICombatGridService, IDiceService, IBuffDebuffService, IGameEventLogger, ILogger | Full zone lifecycle management |

**ZoneEffectService Features:**
- Transient service lifetime
- State management via `List<ZoneEffect>` for active zones
- Comprehensive logging with `ILogger<ZoneEffectService>`
- Combat event logging with `IGameEventLogger.Log()`
- Region separators following codebase conventions
- XML documentation on all public and private members

**ZoneEffectService Processing Flow:**
1. `CreateZone()` validates definition and caster limit
2. `CalculateAffectedCells()` computes shape-based cells
3. `ZoneEffect.Create()` instantiates active zone
4. `TickZones()` processes all zones:
   - Find combatants in zone cells
   - Check friendly/enemy targeting rules
   - Apply effects via `ApplyZoneEffect()`
   - Decrement duration
   - Remove expired zones

**Shape Calculation Methods:**
- `CalculateCircleCells()` - x² + y² ≤ r²
- `CalculateSquareCells()` - |x| ≤ r and |y| ≤ r
- `CalculateLineCells()` - Extend in direction from center
- `CalculateConeCells()` - Expanding width in direction
- `CalculateRingCells()` - (r-1)² ≤ x² + y² ≤ r²

**Direction Offset Mapping:**
- North → (0, -1)
- South → (0, 1)
- East → (1, 0)
- West → (-1, 0)
- Up/Down → (0, 0) - Not applicable to 2D zones

### Configuration

| File | Description |
|------|-------------|
| `config/zones.json` | Zone definitions (12 zones) |
| `config/schemas/zones.schema.json` | JSON schema for validation |

**Included Zone Definitions:**
- `wall-of-fire` - Line damage zone (fire, 2d6)
- `healing-circle` - Circle healing zone (1d6+2)
- `slow-field` - Circle debuff zone (slowed)
- `web` - Circle terrain zone (entangled, DifficultTerrain)
- `consecration` - Circle mixed zone (radiant damage + healing)
- `blizzard` - Circle mixed zone (cold damage + frostbite)
- `acid-pool` - Circle damage zone (acid, 2d4)
- `blessing-aura` - Circle buff zone (blessed)
- `lightning-storm` - Square damage zone (lightning, 1d10)
- `fire-cone` - Cone damage zone (fire, 2d8)
- `necrotic-ring` - Ring damage zone (necrotic, 1d8)
- `fog-cloud` - Circle debuff zone (blinded, ObscuredTerrain)

### Tests

| Test File | Test Count | Description |
|-----------|------------|-------------|
| `ZoneEffectServiceTests.cs` | 11 | Zone creation, shapes, and tick tests |

**Test Coverage:**
- `CreateZone_CreatesZoneAtPosition` - Zone creation
- `CreateZone_CircleShape_CalculatesCellsCorrectly` - Circle calculation
- `CreateZone_SquareShape_CalculatesCellsCorrectly` - Square calculation
- `CreateZone_LineShape_CalculatesCellsCorrectly` - Line calculation
- `TickZones_AppliesDamageToEnemies` - Damage application
- `TickZones_AppliesHealingToAllies` - Healing application
- `TickZones_AppliesStatusEffects` - Status effect application
- `TickZones_DecrementsDuration` - Duration management
- `TickZones_RemovesExpiredZones` - Expiration handling
- `GetZonesAt_ReturnsAffectingZones` - Position query
- `TickZones_RespectsTargetingRules` - Friendly/enemy rules

---

## Architecture

### Zone Lifecycle

```
1. Zone Creation
   ├── IZoneProvider.GetZone() retrieves definition
   ├── Check caster zone limit (max 10)
   ├── CalculateAffectedCells() based on shape
   └── ZoneEffect.Create() instantiates zone
   ↓
2. Tick Processing (each round)
   ├── For each active zone:
   │   ├── Find combatants in affected cells
   │   ├── Check AffectsFriendly/AffectsEnemy
   │   ├── Apply damage/healing/status
   │   └── Tick() decrements duration
   ├── Remove expired zones
   └── Return ZoneTickResult
   ↓
3. Zone Removal
   ├── Manual: RemoveZone()
   ├── Expiration: RemainingDuration <= 0
   └── Combat End: ClearAllZones()
```

### Friendly/Enemy Determination

```
IsFriendlyToCaster(combatant, casterId, allCombatants)
├── Same entity → Friendly
├── Both players → Friendly
├── Both monsters → Friendly
└── Mixed (player/monster) → Enemy
```

### Shape Cell Calculations

```
CIRCLE (radius 2)          SQUARE (radius 2)
     ● ●                  ■ ■ ■ ■ ■
   ● ● ● ●                ■ ■ ■ ■ ■
   ● ● C ● ●              ■ ■ C ■ ■
   ● ● ● ●                ■ ■ ■ ■ ■
     ● ●                  ■ ■ ■ ■ ■
   13 cells               25 cells

LINE (radius 4, East)     CONE (radius 3, East)
C ═ ═ ═ ═                     ▶ ▶ ▶
                            ▶ ▶ ▶ ▶
5 cells                   C ▶ ▶ ▶ ▶
                            ▶ ▶ ▶ ▶
                              ▶ ▶ ▶
                          18 cells

RING (radius 2)
    ○
  ○   ○
  ○ C ○
  ○   ○
    ○
8 cells (hollow)
```

---

## Dependencies

| Dependency | Usage |
|------------|-------|
| ICombatGridService | Get active grid, entity positions |
| IDiceService | Roll damage and healing dice |
| IBuffDebuffService | Apply status effects |
| IGameEventLogger | Log combat events |
| Microsoft.Extensions.Logging | Diagnostic logging |

---

## Breaking Changes

None. This version adds new types without modifying existing APIs.

---

## Migration Notes

No migration required. The zone control system is additive and integrates with existing combat systems.

**Integration Points:**
- Call `IZoneEffectService.CreateZone()` when abilities create zones
- Call `IZoneEffectService.TickZones()` during round processing
- Call `IZoneEffectService.OnEntityEntered/Exited()` during movement
- Call `IZoneEffectService.ClearAllZones()` at combat end
- Use `IZoneEffectService.IsPositionInDamageZone()` for AI decision making

---

## Next Steps

- **v0.10.4a:** Zone UI Integration - Display zones on combat grid
- **v0.10.4b:** Zone Movement Interaction - Trigger effects on movement through zones
- **v0.10.4c:** Zone Ability Integration - Connect zone creation to abilities

---

*Document Version: 1.0 | Last Updated: 2026-01-19*
