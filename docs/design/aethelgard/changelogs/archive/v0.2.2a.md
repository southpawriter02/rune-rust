> **Archived** - This changelog has been consolidated. See the complete version at [v0.2.2](../v0.2.x/v0.2.2.md).

# Changelog: v0.2.2a - The Bestiary (Data & Definitions)

**Release Date:** 2025-12-20
**Codename:** The Bestiary
**Test Coverage:** 1386 tests passing (+43 from v0.2.1c)
**Build Status:** SUCCESS

---

## Summary

This release establishes the data foundation for the Adversary system by implementing EnemyTemplate records, the EnemyFactory for instantiating scalable enemies, and seeding the initial roster of canonical Aethelgardian threats. This transitions from hardcoded "Training Dummies" to a data-driven factory system using the Prototype pattern.

### Key Features
- **EnemyTemplate System**: Immutable blueprints defining base stats for enemy species
- **EnemyFactory**: Factory for creating scaled Enemy entities with +/- 5% variance
- **ThreatTier Enum**: Minion (0.6x), Standard (1.0x), Elite (1.5x), Boss (2.5x fixed)
- **EnemyArchetype Enum**: Tank, DPS, GlassCannon, Support, Swarm, Caster, Boss (for AI in v0.2.2b)
- **Tags System**: List<string> for status effect interactions (e.g., "Mechanical" = Bleed immune)
- **5 Seed Templates**: Rusted Draugr, Haugbui Laborer, Utility Servitor, Ash-Vargr, Rust-Clan Scav

### Architectural Overview

```
┌─────────────────────┐     ┌──────────────────────┐     ┌─────────────────────┐
│  EncounterService   │────▶│    EnemyFactory      │────▶│      Enemy          │
│  (Request enemy)    │     │  (Create from temp)  │     │   (Live entity)     │
└─────────────────────┘     └──────────────────────┘     └─────────────────────┘
                                     │
                                     ▼
                            ┌──────────────────────┐
                            │   EnemyTemplate      │
                            │  (Static blueprint)  │
                            └──────────────────────┘
```

---

## Files Created

| File Path | Description |
|-----------|-------------|
| `RuneAndRust.Core/Enums/ThreatTier.cs` | Threat classification enum for scaling (Minion, Standard, Elite, Boss) |
| `RuneAndRust.Core/Enums/EnemyArchetype.cs` | Combat role archetype enum for AI behavior (Tank, DPS, GlassCannon, etc.) |
| `RuneAndRust.Core/Models/Combat/EnemyTemplate.cs` | Immutable record defining enemy species blueprints |
| `RuneAndRust.Core/Interfaces/IEnemyFactory.cs` | Interface for enemy creation from templates |
| `RuneAndRust.Engine/Factories/EnemyFactory.cs` | Factory implementation with 5 seeded templates |
| `RuneAndRust.Tests/Engine/EnemyFactoryTests.cs` | 43 unit tests for factory behavior |

---

## Files Modified

| File Path | Changes |
|-----------|---------|
| `RuneAndRust.Core/Entities/Enemy.cs` | Added `TemplateId`, `Archetype`, and `Tags` properties |
| `RuneAndRust.Core/Models/Combat/Combatant.cs` | Added `Archetype` and `Tags` properties; updated `FromEnemy()` |
| `RuneAndRust.Terminal/Program.cs` | Registered `IEnemyFactory` in DI container |

---

## Code Implementation Details

### ThreatTier Enum

```csharp
public enum ThreatTier
{
    Minion = 0,    // 0.6x stat multiplier
    Standard = 1,  // 1.0x stat multiplier (baseline)
    Elite = 2,     // 1.5x stat multiplier
    Boss = 3       // 2.5x fixed multiplier (no level scaling)
}
```

### EnemyArchetype Enum

```csharp
public enum EnemyArchetype
{
    Tank,        // High HP/Soak, Low Damage
    DPS,         // Balanced offense/defense
    GlassCannon, // High Damage, Low HP
    Support,     // Buffs/Debuffs
    Swarm,       // Low stats, group tactics
    Caster,      // Ranged/AoE attacks
    Boss         // Multi-phase encounters
}
```

### EnemyTemplate Record

```csharp
public record EnemyTemplate(
    string Id,                                      // e.g., "und_draugr_01"
    string Name,                                    // Display name
    string Description,                             // AAM-VOICE compliant flavor
    EnemyArchetype Archetype,                       // AI behavior key
    ThreatTier Tier,                                // Scaling category
    int BaseHp,
    int BaseStamina,
    int BaseSoak,
    Dictionary<CharacterAttribute, int> Attributes,
    int WeaponDamageDie,                            // d4, d6, d8, etc.
    string WeaponName,
    List<string> Tags,                              // "Mechanical", "Undying"
    string? LootTableId = null                      // Links to loot system
);
```

### IEnemyFactory Interface

```csharp
public interface IEnemyFactory
{
    Enemy CreateFromTemplate(EnemyTemplate template, int partyLevel = 1);
    Enemy CreateById(string templateId, int partyLevel = 1);
    IReadOnlyList<string> GetTemplateIds();
    EnemyTemplate? GetTemplate(string templateId);
}
```

### EnemyFactory Scaling Logic

```csharp
private static float CalculateScaler(ThreatTier tier, int partyLevel)
{
    // Base scaling: 10% increase per level above 1
    var levelScale = 1.0f + ((partyLevel - 1) * 0.1f);

    return tier switch
    {
        ThreatTier.Minion => 0.6f * levelScale,    // Weak fodder
        ThreatTier.Standard => 1.0f * levelScale,  // Normal enemies
        ThreatTier.Elite => 1.5f * levelScale,     // Enhanced threats
        ThreatTier.Boss => 2.5f,                    // Fixed high (no level scaling)
        _ => 1.0f * levelScale
    };
}
```

### Enemy Entity Updates

```csharp
#region Template and AI Properties

/// <summary>
/// The template ID this enemy was created from.
/// </summary>
public string? TemplateId { get; set; }

/// <summary>
/// Combat archetype for AI behavior selection in v0.2.2b.
/// </summary>
public EnemyArchetype Archetype { get; set; } = EnemyArchetype.DPS;

/// <summary>
/// Tags for status effect interactions and special handling.
/// Examples: "Mechanical" = Bleed immune, "Undying" = Poison immune.
/// </summary>
public List<string> Tags { get; set; } = new();

#endregion
```

### Combatant.FromEnemy() Update

```csharp
public static Combatant FromEnemy(Enemy e) => new()
{
    Name = e.Name,
    IsPlayer = false,
    EnemySource = e,
    CurrentHp = e.CurrentHp,
    MaxHp = e.MaxHp,
    CurrentStamina = e.CurrentStamina,
    MaxStamina = e.MaxStamina,
    // Enemy equipment stats
    WeaponDamageDie = e.WeaponDamageDie,
    WeaponAccuracyBonus = e.WeaponAccuracyBonus,
    ArmorSoak = e.ArmorSoak,
    WeaponName = e.WeaponName,
    // Template/AI properties (v0.2.2a)
    Archetype = e.Archetype,
    Tags = new List<string>(e.Tags)
};
```

---

## Bestiary Seed Data

| ID | Name | Archetype | Tier | Base HP | Tags | Description |
|---|---|---|---|---|---|---|
| `und_draugr_01` | Rusted Draugr | DPS | Standard | 60 | Undying, IronHeart, Construct | Corroded security automaton |
| `und_haug_01` | Haugbui Laborer | Tank | Standard | 90 | Undying, IronHeart, Construct | Towering construction unit |
| `mec_serv_01` | Utility Servitor | Swarm | Minion | 25 | Mechanical, Construct | Janitorial drone |
| `bst_vargr_01` | Ash-Vargr | GlassCannon | Standard | 45 | Beast, Blighted | Corrupted predator |
| `hum_raider_01` | Rust-Clan Scav | Support | Standard | 50 | Humanoid | Desperate scavenger |

---

## Logging Matrix

| Event | Level | Template |
|-------|-------|----------|
| Factory initialized | Information | `"EnemyFactory initialized with {Count} templates"` |
| Enemy creation start | Information | `"Creating enemy from template: {Id} (Tier: {Tier}, PartyLevel: {Level})"` |
| Scaling calculation | Debug | `"Scaling: Base HP {Base} x Scaler {Scaler:F2} x Variance {Variance:F2} = {Final}"` |
| Enemy created | Trace | `"Created {Name}: HP={Hp}, Stamina={Stam}, Archetype={Archetype}, Tags=[{Tags}]"` |
| Template not found | Warning | `"Template not found: {Id}, using fallback template {Fallback}"` |

---

## Test Coverage

### EnemyFactoryTests.cs (43 tests)

#### CreateFromTemplate Tests
- `CreateFromTemplate_ReturnsValidEnemy`
- `CreateFromTemplate_CopiesTemplateId`
- `CreateFromTemplate_CopiesArchetype`
- `CreateFromTemplate_CopiesTags`
- `CreateFromTemplate_TagsAreIndependentCopy`
- `CreateFromTemplate_CopiesAllAttributes`
- `CreateFromTemplate_CopiesWeaponStats`
- `CreateFromTemplate_CopiesArmorSoak`

#### Variance Tests
- `CreateFromTemplate_AppliesVariance_MinRoll`
- `CreateFromTemplate_AppliesVariance_MaxRoll`
- `CreateFromTemplate_AppliesVariance_MiddleRoll`
- `CreateFromTemplate_CurrentHpEqualsMaxHp`
- `CreateFromTemplate_CurrentStaminaEqualsMaxStamina`

#### Tier Scaling Tests
- `CreateFromTemplate_MinionTier_ReducesStats`
- `CreateFromTemplate_StandardTier_NormalStats`
- `CreateFromTemplate_EliteTier_IncreasesStats`
- `CreateFromTemplate_BossTier_FixedHighStats`

#### Party Level Scaling Tests
- `CreateFromTemplate_PartyLevel1_NoScaling`
- `CreateFromTemplate_PartyLevel5_ScalesUp`
- `CreateFromTemplate_BossTier_IgnoresPartyLevelScaling`

#### CreateById Tests
- `CreateById_ValidId_ReturnsEnemy`
- `CreateById_InvalidId_ReturnsFallback`
- `CreateById_WithPartyLevel_ScalesCorrectly`

#### Template Registry Tests
- `GetTemplateIds_ReturnsAllTemplates`
- `GetTemplate_ValidId_ReturnsTemplate`
- `GetTemplate_InvalidId_ReturnsNull`

#### Built-in Template Validation Tests
- `BuiltInTemplate_RustedDraugr_HasCorrectStats`
- `BuiltInTemplate_HaugbuiLaborer_HasCorrectStats`
- `BuiltInTemplate_UtilityServitor_IsMinion`
- `BuiltInTemplate_AshVargr_IsGlassCannon`
- `BuiltInTemplate_RustClanScav_IsSupport`
- `BuiltInTemplates_AllHaveRequiredAttributes` (Theory with 5 cases)
- `BuiltInTemplates_AllCreateValidEnemies` (Theory with 5 cases)

#### Edge Case Tests
- `CreateFromTemplate_MinimumHpIsOne`
- `CreateFromTemplate_EachCallCreatesUniqueEnemy`

---

## DI Registration

```csharp
// Register Enemy Factory
services.AddScoped<IEnemyFactory, EnemyFactory>();
```

---

## Directory Structure Changes

```
RuneAndRust.Core/Enums/
├── ThreatTier.cs                   [NEW]
├── EnemyArchetype.cs               [NEW]
├── DangerLevel.cs
└── ...

RuneAndRust.Core/Models/Combat/
├── EnemyTemplate.cs                [NEW]
├── Combatant.cs                    [MODIFIED]
├── CombatResult.cs
└── ...

RuneAndRust.Core/Interfaces/
├── IEnemyFactory.cs                [NEW]
├── ICombatService.cs
└── ...

RuneAndRust.Core/Entities/
├── Enemy.cs                        [MODIFIED]
├── Character.cs
└── ...

RuneAndRust.Engine/Factories/
├── EnemyFactory.cs                 [NEW]
├── CharacterFactory.cs
└── ...

RuneAndRust.Tests/Engine/
├── EnemyFactoryTests.cs            [NEW - 43 tests]
├── CharacterFactoryTests.cs
└── ...
```

---

## Build Verification

```bash
$ dotnet build
Build succeeded.
63 Warning(s) - Pre-existing xUnit async warnings
0 Error(s)

$ dotnet test
Passed!  - Failed: 0, Passed: 1386, Skipped: 0, Total: 1386, Duration: 564 ms
```

---

## Upgrade Notes

1. **Enemy Entity**: New optional properties added. Existing code continues to work - defaults are DPS archetype and empty tags.

2. **Combatant Adapter**: `FromEnemy()` now copies Archetype and Tags. Combat systems can access these for future AI and status effect logic.

3. **DI Container**: `IEnemyFactory` is registered as scoped. Inject via constructor to create enemies from templates.

4. **Usage Example**:
   ```csharp
   // Inject IEnemyFactory
   var enemy = _enemyFactory.CreateById("und_draugr_01", partyLevel: 3);
   // Creates a Rusted Draugr scaled for level 3 party with +/- 5% HP variance
   ```

---

## Related Releases

- **v0.2.1a** (The Armory): Equipment and Loot systems
- **v0.2.1b** (The Affliction): Status Effect system
- **v0.2.1c** (The Visuals): Combat UI updates
- **v0.2.2a** (The Bestiary): Enemy templates and factory (this release)
- **v0.2.2b** (The Adversary's Mind): Enemy AI behaviors [PLANNED]
- **v0.2.2c** (The Elite Traits): Elite enemy enhancements [PLANNED]

---

**v0.2.2a Codename: The Bestiary**
*"From blueprints, darkness rises. The Undying await their awakening."*
