# v0.15.2c Changelog - Fall Damage System

## Release Date: 2026-01-22

## Summary

Implements the Fall Damage System for calculating and applying damage from falls. This system integrates with the Climbing (v0.15.2a) and Leaping (v0.15.2b) systems to process `FallResult` objects and determine final damage. Includes the Crash Landing mechanic for damage reduction via Acrobatics checks.

---

## Added

### Domain Layer

#### Value Objects

- **`FallDamage.cs`** - Represents calculated fall damage parameters
  - Height-to-dice conversion (1d10 per 10ft, max 10d10)
  - Crash Landing DC calculation (`DC = 2 + Height/10`)
  - Bonus damage dice support for fumble effects
  - Factory methods: `FromHeight()`, `FromFallResult()`, `TheLongFall()`, `TheSlip()`
  - `WithDiceReduction()` for applying Crash Landing reduction
  - Properties: `TotalDamageDice`, `CausesDamage`, `AverageDamage`, `MaximumDamage`
  - Constants: `MaxDamageDice = 10`, `MinDamageHeight = 10`, `CrashLandingBaseDc = 2`

- **`CrashLandingResult.cs`** - Represents Crash Landing attempt outcomes
  - Margin-based damage dice reduction (each success above DC = -1d10)
  - Properties: `Succeeded`, `ReducedDamage`, `NegatedAllDamage`, `ReductionPercentage`
  - Factory methods: `FromRoll()`, `NoAttempt()`, `Featherfall()`
  - Integrates with `SkillOutcome` enum for outcome classification

- **`FallDamageResult.cs`** - Aggregated fall damage processing result
  - Combines `FallDamage`, `CrashLandingResult`, and rolled damage
  - Properties: `TookDamage`, `CrashLandingHelped`, `EstimatedDamageAvoided`
  - Factory methods: `NoDamage()`, `Create()`
  - Multi-line description formatting via `ToDescription()`

### Application Layer

#### Interfaces

- **`IFallDamageService.cs`** - Contract for fall damage operations
  - `CalculateFallDamage(int, FallSource, int)`: Calculate damage from height
  - `CalculateFallDamage(FallResult)`: Calculate from existing FallResult
  - `AttemptCrashLanding(string, FallDamage, int, SkillContext?)`: Perform Crash Landing
  - `RollDamage(int)`: Roll and sum damage dice
  - `ProcessFall(string, FallResult, int, bool, SkillContext?)`: Complete workflow
  - `GetCrashLandingDc(int)`: Get DC for a given height
  - `GetDamageDice(int)`: Get dice count for height

#### Services

- **`FallDamageService.cs`** - Full fall damage implementation
  - Height-based damage calculation with 10d10 cap
  - Crash Landing Acrobatics checks with success-counting mechanics
  - Margin-based damage reduction (each excess success = -1d10)
  - Skill outcome determination (Critical, Exceptional, Full, Marginal, Failure)
  - Integration with `IDiceService` for all rolls
  - Exhaustive structured logging for all operations

### Configuration

- **`config/fall-damage.json`** - Fall damage configuration
  - Damage calculation parameters (dice per 10ft, max dice, damage type)
  - Crash Landing mechanics (base DC, DC scaling, linked skill/attribute)
  - Severity thresholds (minor/moderate/severe/extreme)
  - Outcome descriptions for each skill outcome tier
  - Special fall sources with fumble consequences
  - Display configuration with warning thresholds

- **`config/schemas/fall-damage.schema.json`** - JSON Schema validation
  - Definitions for `DamageCalculation`, `CrashLanding`, `SeverityThresholds`
  - Definitions for `OutcomeDescriptions`, `SpecialSources`, `DisplayConfig`
  - Pattern validation for IDs and damage types
  - Range constraints for DC values and thresholds

### Testing

- **`FallDamageServiceTests.cs`** - 48 comprehensive unit tests
  - FallDamage value object: height-to-dice calculation, cap enforcement
  - CrashLandingResult: margin calculation, damage reduction, boundary cases
  - FallDamageService: DC calculation, damage rolling, complete workflow

---

## Mechanics Summary

### Fall Damage Formula
```
Damage Dice = Height / 10 (rounded down, max 10d10)
Falls < 10 feet = No damage
Damage Type = Bludgeoning
```

### Crash Landing
```
DC = 2 + (Height / 10) successes needed
Each success above DC = -1d10 damage
Skill: Acrobatics (linked to Finesse)
Available for falls ≥ 10 feet
```

### Skill Outcomes
| Margin | Outcome | Effect |
|--------|---------|--------|
| ≥ 5 | Critical Success | Major damage reduction |
| ≥ 3 | Exceptional Success | Good damage reduction |
| ≥ 1 | Full Success | Moderate damage reduction |
| 0 | Marginal Success | No reduction, safe landing |
| < 0 | Failure | Full damage |
| Fumble | Critical Failure | Full damage + complications |

### Special Fall Sources
- **Climbing** (`[The Slip]`): Standard fall damage
- **Leaping** (`[The Long Fall]`): +1d10 bonus damage, +2 Stress, Disoriented 2 rounds
- **Balance/Pushed/Environmental**: Standard fall damage

---

## Files Created

| File | Location | Type |
|------|----------|------|
| `FallDamage.cs` | `src/Core/RuneAndRust.Domain/ValueObjects/` | Value Object |
| `CrashLandingResult.cs` | `src/Core/RuneAndRust.Domain/ValueObjects/` | Value Object |
| `FallDamageResult.cs` | `src/Core/RuneAndRust.Domain/ValueObjects/` | Value Object |
| `IFallDamageService.cs` | `src/Core/RuneAndRust.Application/Interfaces/` | Interface |
| `FallDamageService.cs` | `src/Core/RuneAndRust.Application/Services/` | Service |
| `fall-damage.json` | `config/` | Configuration |
| `fall-damage.schema.json` | `config/schemas/` | JSON Schema |
| `FallDamageServiceTests.cs` | `tests/RuneAndRust.Application.UnitTests/Services/` | Unit Tests |

---

## Integration Points

### FallResult Consumption
- Consumes `FallResult` from both Climbing (`v0.15.2a`) and Leaping (`v0.15.2b`)
- `FallDamage.FromFallResult()` converts any `FallResult` to damage calculation
- Preserves `FallSource` for narrative and logging purposes

### Dependencies
- `IDiceService`: Required for Crash Landing checks and damage rolls
- `ILogger<FallDamageService>`: Required for structured logging

### Related Systems
- **v0.15.2a Climbing**: Generates `FallResult` via `[The Slip]` fumble
- **v0.15.2b Leaping**: Generates `FallResult` via `[The Long Fall]` fumble
- **v0.15.2d Balance**: Will generate `FallResult` on balance failures

---

## Test Coverage

| Test Category | Test Count |
|---------------|------------|
| FallDamage height-to-dice | 7 |
| FallDamage cap enforcement | 4 |
| FallDamage threshold | 3 |
| FallDamage eligibility | 4 |
| FallDamage bonus dice | 2 |
| FallDamage reduction | 2 |
| CrashLandingResult margin | 4 |
| FallDamageService DC | 6 |
| FallDamageService dice | 4 |
| FallDamageService workflow | 3 |
| ProcessFall integration | 3 |
| **Total** | **48** |

---

## Build Status

- ✅ Build succeeds with 0 errors
- ✅ Build succeeds with 0 warnings
- ✅ All 48 new tests pass
