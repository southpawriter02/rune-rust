## v0.17.0 - Lineage System

**Focus:** Lineage definitions, unique traits, attribute modifiers, and Trauma Economy baseline integration

**Source Specification:** [character-creation.md](../../aethelgard/design/01-core/character-creation.md), legacy lineage specifications

### Overview

This version implements the Lineage system that represents a character's bloodline heritage from before the Great Silence. Lineage is the first choice in character creation and provides permanent bonuses, a unique trait, and determines the character's baseline interaction with the Trauma Economy. Each lineage reflects how the character's ancestors were scarred by the Runic Blight.

---

### Deliverables Summary

| Category | Items | Estimated Tests |
|----------|-------|-----------------|
| Enums | 1 | 2 |
| Value Objects | 3 | 4 |
| Entities | 1 | 3 |
| Services | 2 | 6 |
| **Total** | **7** | **~15** |

---

### v0.17.0a - Lineage Enum & Definition

#### Lineage Enum
```
Lineage
├── ClanBorn - The Stable Code
├── RuneMarked - The Tainted Aether
├── IronBlooded - The Corrupted Earth
├── VargrKin - The Uncorrupted Echo
```

#### LineageDefinition Entity
```
LineageDefinition
├── LineageId: Lineage enum
├── DisplayName: string
├── Description: string
├── SelectionText: string (flavor text for creation UI)
├── AttributeModifiers: LineageAttributeModifiers
├── PassiveBonuses: LineagePassiveBonuses
├── UniqueTrait: LineageTrait
├── TraumaBaseline: LineageTraumaBaseline
├── AppearanceNotes: string
├── SocialRole: string
```

#### LineageAttributeModifiers Value Object
```
LineageAttributeModifiers
├── MightModifier: int
├── FinesseModifier: int
├── WitsModifier: int
├── WillModifier: int
├── SturdnessModifier: int
├── HasFlexibleBonus: bool (Clan-Born can choose +1 to any)
├── FlexibleBonusAmount: int
```

**Attribute Modifiers by Lineage:**
| Lineage | MIGHT | FINESSE | WITS | WILL | STURDINESS | Flexible |
|---------|-------|---------|------|------|------------|----------|
| Clan-Born | 0 | 0 | 0 | 0 | 0 | +1 to any |
| Rune-Marked | 0 | 0 | 0 | +2 | -1 | — |
| Iron-Blooded | 0 | 0 | 0 | -1 | +2 | — |
| Vargr-Kin | +1 | +1 | 0 | -1 | 0 | — |

**Configuration (`lineages.json` - Attribute Section):**
```json
{
  "lineages": [
    {
      "lineageId": "ClanBorn",
      "displayName": "Clan-Born",
      "attributeModifiers": {
        "mightModifier": 0,
        "finesseModifier": 0,
        "witsModifier": 0,
        "willModifier": 0,
        "sturdinessModifier": 0,
        "hasFlexibleBonus": true,
        "flexibleBonusAmount": 1
      }
    },
    {
      "lineageId": "RuneMarked",
      "displayName": "Rune-Marked",
      "attributeModifiers": {
        "mightModifier": 0,
        "finesseModifier": 0,
        "witsModifier": 0,
        "willModifier": 2,
        "sturdinessModifier": -1,
        "hasFlexibleBonus": false,
        "flexibleBonusAmount": 0
      }
    }
  ]
}
```

**Unit Tests (~2):**
- [ ] Lineage enum has 4 values
- [ ] LineageDefinition loads from configuration

---

### v0.17.0b - Passive Bonuses

#### LineagePassiveBonuses Value Object
```
LineagePassiveBonuses
├── MaxHpBonus: int
├── MaxApBonus: int
├── SoakBonus: int
├── MovementBonus: int
├── SkillBonuses: List<SkillBonus>
```

#### SkillBonus Value Object
```
SkillBonus
├── SkillId: string
├── BonusAmount: int
```

**Passive Bonuses by Lineage:**
| Lineage | HP | AP | Soak | Movement | Skill |
|---------|-----|-----|------|----------|-------|
| Clan-Born | +5 | 0 | 0 | 0 | Social +1 |
| Rune-Marked | 0 | +5 | 0 | 0 | Lore +1 |
| Iron-Blooded | 0 | 0 | +2 | 0 | Craft +1 |
| Vargr-Kin | 0 | 0 | 0 | +1 | Survival +1 |

**Configuration (`lineages.json` - Bonus Section):**
```json
{
  "lineages": [
    {
      "lineageId": "ClanBorn",
      "passiveBonuses": {
        "maxHpBonus": 5,
        "maxApBonus": 0,
        "soakBonus": 0,
        "movementBonus": 0,
        "skillBonuses": [
          { "skillId": "social", "bonusAmount": 1 }
        ]
      }
    },
    {
      "lineageId": "VargrKin",
      "passiveBonuses": {
        "maxHpBonus": 0,
        "maxApBonus": 0,
        "soakBonus": 0,
        "movementBonus": 1,
        "skillBonuses": [
          { "skillId": "survival", "bonusAmount": 1 }
        ]
      }
    }
  ]
}
```

**Unit Tests (~2):**
- [ ] Clan-Born grants +5 Max HP
- [ ] Vargr-Kin grants +1 Movement

---

### v0.17.0c - Unique Traits

#### LineageTrait Value Object
```
LineageTrait
├── TraitId: string
├── TraitName: string
├── Description: string
├── EffectType: LineageTraitEffectType enum
├── TriggerCondition: string?
├── BonusDice: int? (for dice pool traits)
├── PercentModifier: float? (for percentage traits)
├── TargetCheck: string? (skill or resolve check type)
├── TargetCondition: string? (e.g., "NPC is Clan-Born")
```

#### LineageTraitEffectType Enum
```
LineageTraitEffectType
├── BonusDiceToSkill - Adds dice to specific skill checks
├── PercentageModifier - Modifies incoming/outgoing values
├── BonusDiceToResolve - Adds dice to resolve checks
├── PassiveAuraBonus - Percentage bonus to a pool
```

**Traits by Lineage:**
| Lineage | Trait Name | Effect |
|---------|------------|--------|
| Clan-Born | `[Survivor's Resolve]` | +1d10 to Rhetoric checks with Clan-Born NPCs |
| Rune-Marked | `[Aether-Tainted]` | +10% Maximum Aether Pool |
| Iron-Blooded | `[Hazard Acclimation]` | +1d10 to Sturdiness Resolve vs environmental hazards |
| Vargr-Kin | `[Primal Clarity]` | -10% Psychic Stress from all sources |

**Trait Implementation Details:**
```
Survivor's Resolve:
  Trigger: Rhetoric skill check initiated
  Condition: Target NPC has Lineage == ClanBorn
  Effect: Add 1 die to dice pool

Aether-Tainted:
  Trigger: Max AP calculation
  Effect: Multiply final AP by 1.10

Hazard Acclimation:
  Trigger: Sturdiness Resolve check
  Condition: Source is environmental hazard
  Effect: Add 1 die to dice pool

Primal Clarity:
  Trigger: Psychic Stress gain
  Effect: Multiply stress amount by 0.90
```

**Configuration (`lineages.json` - Trait Section):**
```json
{
  "lineages": [
    {
      "lineageId": "ClanBorn",
      "uniqueTrait": {
        "traitId": "survivors_resolve",
        "traitName": "Survivor's Resolve",
        "description": "Gain +1d10 to Rhetoric checks when interacting with Clan-Born NPCs",
        "effectType": "BonusDiceToSkill",
        "targetCheck": "rhetoric",
        "targetCondition": "npc.lineage == ClanBorn",
        "bonusDice": 1
      }
    },
    {
      "lineageId": "VargrKin",
      "uniqueTrait": {
        "traitId": "primal_clarity",
        "traitName": "Primal Clarity",
        "description": "Take 10% less Psychic Stress from all sources",
        "effectType": "PercentageModifier",
        "triggerCondition": "psychic_stress_gain",
        "percentModifier": -0.10
      }
    }
  ]
}
```

**Unit Tests (~3):**
- [ ] Survivor's Resolve adds 1 die when target is Clan-Born
- [ ] Aether-Tainted increases Max AP by 10%
- [ ] Primal Clarity reduces Psychic Stress by 10%

---

### v0.17.0d - Trauma Economy Baseline

#### LineageTraumaBaseline Value Object
```
LineageTraumaBaseline
├── StartingCorruption: int
├── StartingStress: int
├── IsCorruptionPermanent: bool
├── CorruptionResistModifier: int
├── StressResistModifier: int
├── SpecialVulnerability: string?
```

**Trauma Baselines by Lineage:**
| Lineage | Start Corruption | Start Stress | Corruption Resist | Stress Resist |
|---------|------------------|--------------|-------------------|---------------|
| Clan-Born | 0 | 0 | 0 | 0 |
| Rune-Marked | 5 (permanent) | 0 | -1 | 0 |
| Iron-Blooded | 0 | 0 | 0 | -1 |
| Vargr-Kin | 0 | 0 | 0 | 0 |

**Trauma Interaction Logic:**
```
On Resolve Check to Resist Corruption:
  1. Get base dice pool from WILL
  2. If character.Lineage == RuneMarked:
     - Apply -1 penalty to roll result
  3. Roll and compare to DC

On Resolve Check to Resist Psychic Stress:
  1. Get base dice pool from WILL
  2. If character.Lineage == IronBlooded:
     - Apply -1 penalty to roll result
  3. If character.Lineage == VargrKin:
     - Apply Primal Clarity (-10% to stress gained)
  4. Roll and compare to DC
```

**Configuration (`lineages.json` - Trauma Section):**
```json
{
  "lineages": [
    {
      "lineageId": "RuneMarked",
      "traumaBaseline": {
        "startingCorruption": 5,
        "startingStress": 0,
        "isCorruptionPermanent": true,
        "corruptionResistModifier": -1,
        "stressResistModifier": 0,
        "specialVulnerability": "Soul is permanently tainted by the All-Rune"
      }
    },
    {
      "lineageId": "IronBlooded",
      "traumaBaseline": {
        "startingCorruption": 0,
        "startingStress": 0,
        "isCorruptionPermanent": false,
        "corruptionResistModifier": 0,
        "stressResistModifier": -1,
        "specialVulnerability": "Mind less fortified against psychic assault"
      }
    }
  ]
}
```

**Unit Tests (~3):**
- [ ] Rune-Marked starts with 5 permanent Corruption
- [ ] Rune-Marked has -1 to Corruption resistance
- [ ] Iron-Blooded has -1 to Stress resistance

---

### v0.17.0e - Lineage Provider Service

#### ILineageProvider Interface
```csharp
public interface ILineageProvider
{
    /// <summary>
    /// Gets all available lineage definitions.
    /// </summary>
    IReadOnlyList<LineageDefinition> GetAllLineages();

    /// <summary>
    /// Gets a specific lineage by ID.
    /// </summary>
    LineageDefinition? GetLineage(Lineage lineageId);

    /// <summary>
    /// Gets the display text for lineage selection UI.
    /// </summary>
    string GetSelectionText(Lineage lineageId);

    /// <summary>
    /// Gets attribute modifiers for a lineage.
    /// </summary>
    LineageAttributeModifiers GetAttributeModifiers(Lineage lineageId);

    /// <summary>
    /// Gets the unique trait for a lineage.
    /// </summary>
    LineageTrait GetUniqueTrait(Lineage lineageId);

    /// <summary>
    /// Gets trauma baseline for a lineage.
    /// </summary>
    LineageTraumaBaseline GetTraumaBaseline(Lineage lineageId);
}
```

**Provider Implementation:**
```csharp
public class LineageProvider : ILineageProvider
{
    private readonly Dictionary<Lineage, LineageDefinition> _lineages;

    public LineageProvider(IConfiguration configuration)
    {
        _lineages = LoadFromConfiguration(configuration);
    }

    public IReadOnlyList<LineageDefinition> GetAllLineages()
        => _lineages.Values.ToList();

    public LineageDefinition? GetLineage(Lineage lineageId)
        => _lineages.TryGetValue(lineageId, out var def) ? def : null;
}
```

**Unit Tests (~2):**
- [ ] GetAllLineages returns 4 lineages
- [ ] GetLineage returns correct definition

---

### v0.17.0f - Lineage Application Service

#### ILineageApplicationService Interface
```csharp
public interface ILineageApplicationService
{
    /// <summary>
    /// Applies lineage modifiers to a character during creation.
    /// </summary>
    void ApplyLineageToCharacter(
        PlayerCharacter character,
        Lineage lineage,
        CoreAttribute? flexibleBonusAttribute = null);

    /// <summary>
    /// Validates flexible bonus selection for Clan-Born.
    /// </summary>
    bool ValidateFlexibleBonus(
        Lineage lineage,
        CoreAttribute? selectedAttribute);

    /// <summary>
    /// Calculates the attribute modifier from lineage.
    /// </summary>
    int GetAttributeModifier(
        Lineage lineage,
        CoreAttribute attribute,
        CoreAttribute? flexibleBonusTarget = null);

    /// <summary>
    /// Registers lineage trait with the trait system.
    /// </summary>
    void RegisterLineageTrait(
        string characterId,
        LineageTrait trait);
}
```

**Application Logic:**
```
ApplyLineageToCharacter(character, lineage, flexibleBonusAttribute):
  1. Get lineage definition
  2. Apply attribute modifiers:
     - If hasFlexibleBonus and flexibleBonusAttribute provided:
       - Add flexibleBonusAmount to selected attribute
     - Apply fixed modifiers to all attributes
  3. Apply passive bonuses:
     - Add HP bonus to MaxHp calculation
     - Add AP bonus to MaxAp calculation
     - Add Soak bonus
     - Add Movement bonus
     - Grant skill bonuses
  4. Apply trauma baseline:
     - Set starting Corruption
     - Set starting Stress
     - Register resistance modifiers
  5. Register unique trait with trait system
```

**Unit Tests (~3):**
- [x] ApplyLineageToCharacter applies all modifiers correctly
- [x] Clan-Born flexible bonus applies to selected attribute
- [x] Lineage trait is registered with trait system

---

### Configuration Files

| File | Purpose |
|------|---------|
| `lineages.json` | Complete lineage definitions |

**Complete Configuration Example:**
```json
{
  "lineages": [
    {
      "lineageId": "ClanBorn",
      "displayName": "Clan-Born",
      "description": "The Stable Code - descendants of survivors with stable bloodlines",
      "selectionText": "Your ancestors were the survivors. While others were twisted by the Blight or driven mad by the Echoes, your people endured.",
      "attributeModifiers": {
        "mightModifier": 0,
        "finesseModifier": 0,
        "witsModifier": 0,
        "willModifier": 0,
        "sturdinessModifier": 0,
        "hasFlexibleBonus": true,
        "flexibleBonusAmount": 1
      },
      "passiveBonuses": {
        "maxHpBonus": 5,
        "maxApBonus": 0,
        "soakBonus": 0,
        "movementBonus": 0,
        "skillBonuses": [
          { "skillId": "social", "bonusAmount": 1 }
        ]
      },
      "uniqueTrait": {
        "traitId": "survivors_resolve",
        "traitName": "Survivor's Resolve",
        "description": "Gain +1d10 to Rhetoric checks when interacting with Clan-Born NPCs",
        "effectType": "BonusDiceToSkill",
        "targetCheck": "rhetoric",
        "targetCondition": "npc.lineage == ClanBorn",
        "bonusDice": 1
      },
      "traumaBaseline": {
        "startingCorruption": 0,
        "startingStress": 0,
        "isCorruptionPermanent": false,
        "corruptionResistModifier": 0,
        "stressResistModifier": 0,
        "specialVulnerability": null
      },
      "appearanceNotes": "Diverse and varied, reflecting the broad spectrum of humanity",
      "socialRole": "Most common lineage, often in leadership positions"
    }
  ]
}
```

---

### Dependencies

**Requires:**
- v0.10.x: Status effect system (for trait implementation)
- v0.15.x: Dice pool system (for bonus dice)
- Trauma Economy system (for Corruption/Stress integration)

**Provides to:**
- v0.17.2: Attribute modifiers for point-buy
- v0.17.5: Lineage selection step in workflow
- Combat system: Trait triggers
- Dialogue system: NPC lineage checks

---

### Acceptance Criteria

- [x] Lineage enum has 4 values
- [x] Each lineage has unique attribute modifiers
- [x] Clan-Born allows +1 to any attribute (player choice)
- [x] Rune-Marked grants +2 WILL, -1 STURDINESS
- [x] Iron-Blooded grants +2 STURDINESS, -1 WILL
- [x] Vargr-Kin grants +1 MIGHT, +1 FINESSE, -1 WILL
- [x] Each lineage has passive bonuses (HP, AP, Soak, Movement, Skill)
- [x] Each lineage has a unique trait
- [x] Survivor's Resolve adds dice to Rhetoric with Clan-Born NPCs
- [x] Aether-Tainted increases Max AP by 10%
- [x] Hazard Acclimation adds dice vs environmental hazards
- [x] Primal Clarity reduces Psychic Stress by 10%
- [x] Rune-Marked starts with 5 permanent Corruption
- [x] Rune-Marked has -1 to Corruption resistance
- [x] Iron-Blooded has -1 to Stress resistance
- [x] ~15 unit tests pass
