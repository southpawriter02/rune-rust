# v0.1.5b Design Specification: Secret Room Generation

**Version:** 0.1.5b
**Phase Name:** Secret Room Generation
**Parent Version:** v0.1.5 (Procedural Puzzles & Secrets)
**Prerequisites:** v0.1.5a Complete (Puzzle Placement System)
**Estimated Tests:** ~20 unit tests

---

## Table of Contents

1. [Executive Summary](#1-executive-summary)
2. [Feature Overview](#2-feature-overview)
3. [Architecture Diagrams](#3-architecture-diagrams)
4. [SecretRoomTemplate Entity](#4-secretroomtemplate-entity)
5. [HiddenPassage Entity](#5-hiddenpassage-entity)
6. [SecretPlacementRules Value Object](#6-secretplacementrules-value-object)
7. [SecretPlacementContext Record](#7-secretplacementcontext-record)
8. [SecretPlacementResult Record](#8-secretplacementresult-record)
9. [SecretPlacementService](#9-secretplacementservice)
10. [Configuration File Schemas](#10-configuration-file-schemas)
11. [Logging Specifications](#11-logging-specifications)
12. [Unit Testing Requirements](#12-unit-testing-requirements)
13. [Use Cases](#13-use-cases)
14. [Deliverable Checklist](#14-deliverable-checklist)
15. [Acceptance Criteria](#15-acceptance-criteria)
16. [Dependencies](#16-dependencies)
17. [Future Considerations](#17-future-considerations)

---

## 1. Executive Summary

### 1.1 Purpose

Implement hidden passage placement and secret room generation for procedural dungeon creation. This phase determines where secret rooms are placed, configures their discovery difficulty, and assigns loot tables. This is **generation-only**—the actual player interaction mechanics (search commands, perception checks, discovery state tracking, reveal mechanics) are deferred to v0.4.0 (Interactive Environment & Puzzles).

### 1.2 Current State

| Area | Current State (v0.1.5a) | Target State (v0.1.5b) |
|------|-------------------------|------------------------|
| Secret room types | Not defined | JSON-configurable templates with themes |
| Hidden passages | None | HiddenPassage entity with direction and DC |
| Placement rules | N/A | Probability-based placement by biome/style |
| Discovery difficulty | N/A | Depth-scaled discovery DC (Difficulty Class) |
| Loot linking | N/A | Loot table ID assignment |
| Discovery hints | None | Hint templates for subtle clues |

### 1.3 Key Deliverables

| Category | Items |
|----------|-------|
| **Entities** | `SecretRoomTemplate` (definition), `HiddenPassage` |
| **Value Objects** | `SecretPlacementRules` |
| **Records** | `SecretPlacementContext`, `SecretPlacementResult` |
| **Services** | `SecretPlacementService` (with `ISecretPlacementService` interface) |
| **Configuration** | `secrets.json`, `secrets.schema.json` |
| **Tests** | ~20 new unit tests |

### 1.4 Architectural Significance

This version extends the **procedural content generation pattern** established in v0.1.5a:
- Template-based content definition loaded from JSON
- Probability-based placement with biome/style preference bonuses
- Depth-scaled difficulty (discovery DC)
- Separation of generation from interaction (generation vs. gameplay)
- Foundation for trap placement (v0.1.5c) and treasure vaults (v0.1.5d)

### 1.5 Scope Boundaries

| In Scope (v0.1.5b - Generation) | Out of Scope (Deferred to v0.4.0 - Interaction) |
|--------------------------------|------------------------------------------------|
| SecretRoomTemplate definitions | `search` command |
| HiddenPassage placement | Perception skill checks |
| Discovery DC assignment | Discovery state tracking |
| Spawn probability rules | Reveal mechanics |
| Loot table linking | Player-facing search UI |
| Hint text generation | Hint discovery triggers |

---

## 2. Feature Overview

```
v0.1.5b Secret Room Generation
├── SecretRoomTemplate Entity (IDefinition)
│   ├── Unique ID and display name
│   ├── Description template
│   ├── Base discovery DC (difficulty class)
│   ├── Depth range (min/max)
│   ├── Base spawn probability (0-1)
│   ├── Preferred biomes (bonus probability)
│   ├── Preferred styles (bonus probability)
│   ├── Loot table ID reference
│   ├── Passage description templates
│   ├── Discovery hint templates
│   ├── Can contain traps flag
│   └── Can contain guardian flag
├── HiddenPassage Entity (IEntity)
│   ├── Unique passage ID
│   ├── Source room reference
│   ├── Destination (secret) room reference
│   ├── Template ID reference
│   ├── Direction (North/South/East/West)
│   ├── Discovery DC (scaled by depth)
│   ├── Hidden description (pre-discovery)
│   ├── Revealed description (post-discovery)
│   └── Hint texts
├── SecretPlacementRules Value Object
│   ├── Base probability
│   ├── Biome bonus multiplier
│   └── Style bonus multiplier
├── SecretPlacementContext Record
│   ├── Dungeon ID
│   ├── Dungeon depth
│   ├── Biome ID and name
│   ├── Architectural style ID
│   ├── World seed
│   └── Maximum secrets per level
├── SecretPlacementResult Record
│   ├── Secret room (Room entity)
│   ├── Hidden passage
│   └── Template reference
├── SecretPlacementService
│   ├── GenerateSecrets(context, rooms) - generates secrets for level
│   ├── TryPlaceSecret(room, templates, context) - placement attempt
│   ├── CreateSecretRoom(template, sourceRoom, context) - room creation
│   ├── CreateHiddenPassage(...) - passage creation
│   ├── FindAvailableDirection(room) - finds unused direction
│   └── SelectDescription(options, fallback) - random description
└── Configuration
    ├── secrets.json (template definitions)
    └── secrets.schema.json (validation)
```

---

## 3. Architecture Diagrams

### 3.1 Layer Diagram

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           PRESENTATION LAYER                                 │
├─────────────────────────────────────────────────────────────────────────────┤
│  Room descriptions include hint text (v0.4.0 adds search interaction)        │
│  ├── GameView displays room descriptions                                    │
│  ├── Hints may appear in source room descriptions                           │
│  └── Secret rooms hidden until discovered (v0.4.0)                          │
└─────────────────────────────────────────────────────────────────────────────┘
                                      │
                                      ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                           APPLICATION LAYER                                  │
├─────────────────────────────────────────────────────────────────────────────┤
│  SecretPlacementService                                                      │
│  ├── GenerateSecrets(context, rooms)  ├── CreateSecretRoom(...)            │
│  ├── TryPlaceSecret(...)              ├── CreateHiddenPassage(...)         │
│  ├── FindAvailableDirection(...)      └── SelectDescription(...)           │
│                                                                              │
│  Interfaces:                        Consumed By:                             │
│  └── ISecretPlacementService        ├── DungeonGeneratorService             │
│                                     └── VaultGenerationService (v0.1.5d)    │
│                                                                              │
│  Records:                           Dependencies:                            │
│  ├── SecretPlacementContext         ├── IConfigurationProvider              │
│  └── SecretPlacementResult          ├── ISeededRandomService                │
│                                     └── ILogger<SecretPlacementService>     │
└─────────────────────────────────────────────────────────────────────────────┘
                                      │
                                      ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                             DOMAIN LAYER                                     │
├─────────────────────────────────────────────────────────────────────────────┤
│  Definitions (IDefinition):       Value Objects:                             │
│  ┌─────────────────────────┐    ┌─────────────────────────┐                 │
│  │ SecretRoomTemplate      │    │ SecretPlacementRules    │                 │
│  │ ├── Id: string          │    │ ├── BaseProbability     │                 │
│  │ ├── Name: string        │    │ ├── BiomeBonusMultiplier│                 │
│  │ ├── DescriptionTemplate │    │ └── StyleBonusMultiplier│                 │
│  │ ├── BaseDiscoveryDC     │    └─────────────────────────┘                 │
│  │ ├── MinDepth: int       │                                                │
│  │ ├── MaxDepth: int       │                                                │
│  │ ├── SpawnProbability    │                                                │
│  │ ├── PreferredBiomes     │                                                │
│  │ ├── PreferredStyles     │                                                │
│  │ ├── LootTableId         │                                                │
│  │ ├── PassageDescriptions │                                                │
│  │ ├── DiscoveryHints      │                                                │
│  │ ├── CanContainTraps     │                                                │
│  │ └── CanContainGuardian  │                                                │
│  └─────────────────────────┘                                                │
│                                                                              │
│  Entities (IEntity):                                                         │
│  ┌─────────────────────────┐                                                │
│  │ HiddenPassage           │                                                │
│  │ ├── Id: Guid            │                                                │
│  │ ├── SourceRoomId: Guid  │                                                │
│  │ ├── DestinationRoomId   │                                                │
│  │ ├── TemplateId: string  │                                                │
│  │ ├── Direction           │                                                │
│  │ ├── DiscoveryDC: int    │                                                │
│  │ ├── HiddenDescription   │                                                │
│  │ ├── RevealedDescription │                                                │
│  │ └── Hints: List<string> │                                                │
│  └─────────────────────────┘                                                │
└─────────────────────────────────────────────────────────────────────────────┘
                                      │
                                      ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                         INFRASTRUCTURE LAYER                                 │
├─────────────────────────────────────────────────────────────────────────────┤
│  JsonConfigurationProvider                                                   │
│  ├── GetSecretRoomTemplates(): IReadOnlyList<SecretRoomTemplate>            │
│  └── Loads and deserializes config/secrets.json                             │
│                                                                              │
│  Configuration Files:                                                        │
│  ├── config/secrets.json                                                    │
│  └── config/schemas/secrets.schema.json                                     │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 3.2 Secret Room Generation Flow

```
┌───────────────────────────────────────────────────────────────┐
│ DungeonGeneratorService completes room generation             │
│ Calls ISecretPlacementService.GenerateSecrets(context, rooms) │
└───────────────┬───────────────────────────────────────────────┘
                │
                ▼
┌───────────────────────────────────────────────────────────────┐
│ Step 1: Filter templates by depth                             │
├───────────────────────────────────────────────────────────────┤
│ _configurationProvider.GetSecretRoomTemplates()               │
│     .Where(t => t.IsValidFor(context.Depth))                  │
│                                                               │
│ IsValidFor checks:                                            │
│ ├── depth >= MinDepth                                         │
│ └── depth <= MaxDepth (if MaxDepth > 0)                       │
└───────────────┬───────────────────────────────────────────────┘
                │
                ▼
┌───────────────────────────────────────────────────────────────┐
│ Step 2: Iterate through eligible source rooms                 │
├───────────────────────────────────────────────────────────────┤
│ foreach (var room in rooms)                                   │
│ {                                                             │
│     if (room.Type == RoomType.Secret) continue; // skip       │
│     var result = TryPlaceSecret(room, templates, context);    │
│     if (result != null) yield return result;                  │
│ }                                                             │
└───────────────┬───────────────────────────────────────────────┘
                │
                ▼
┌───────────────────────────────────────────────────────────────┐
│ Step 3: Calculate adjusted probability for each template      │
├───────────────────────────────────────────────────────────────┤
│ template.GetAdjustedProbability(biomeId, styleId)             │
│ ├── Start with SpawnProbability                               │
│ ├── If biomeId in PreferredBiomes: multiply by 1.5            │
│ ├── If styleId in PreferredStyles: multiply by 1.3            │
│ └── Cap at 1.0                                                │
└───────────────┬───────────────────────────────────────────────┘
                │
                ▼
┌───────────────────────────────────────────────────────────────┐
│ Step 4: Roll for secret placement                             │
├───────────────────────────────────────────────────────────────┤
│ if (_randomService.NextDouble() >= probability)               │
│     continue; // no secret placed                             │
└───────────────┬───────────────────────────────────────────────┘
                │ (if roll < probability)
                ▼
┌───────────────────────────────────────────────────────────────┐
│ Step 5: Find available direction                              │
├───────────────────────────────────────────────────────────────┤
│ FindAvailableDirection(sourceRoom)                            │
│ ├── Get used directions from room.Exits                       │
│ ├── Find unused directions (N/S/E/W)                          │
│ └── Return random available direction (or null if none)       │
└───────────────┬───────────────────────────────────────────────┘
                │ (if direction found)
                ▼
┌───────────────────────────────────────────────────────────────┐
│ Step 6: Create secret room                                    │
├───────────────────────────────────────────────────────────────┤
│ CreateSecretRoom(template, sourceRoom, context)               │
│ ├── Room.Create with RoomType.Secret                          │
│ ├── Name from template                                        │
│ └── Description from template.DescriptionTemplate             │
└───────────────┬───────────────────────────────────────────────┘
                │
                ▼
┌───────────────────────────────────────────────────────────────┐
│ Step 7: Create hidden passage                                 │
├───────────────────────────────────────────────────────────────┤
│ CreateHiddenPassage(template, sourceRoom, secretRoom,         │
│                     direction, context)                       │
│ ├── Select hidden description from template.PassageDescriptions│
│ ├── Generate revealed description                             │
│ ├── Select hints from template.DiscoveryHints                 │
│ └── Calculate scaled DC: template.GetScaledDC(depth)          │
│     └── DiscoveryDC = BaseDiscoveryDC + (depth / 2)           │
└───────────────┬───────────────────────────────────────────────┘
                │
                ▼
┌───────────────────────────────────────────────────────────────┐
│ Step 8: Return SecretPlacementResult                          │
├───────────────────────────────────────────────────────────────┤
│ SecretPlacementResult                                         │
│ {                                                             │
│     SecretRoom = createdRoom,                                 │
│     Passage = hiddenPassage,                                  │
│     Template = selectedTemplate                               │
│ }                                                             │
└───────────────────────────────────────────────────────────────┘
```

### 3.3 Probability Calculation Flow

```
┌───────────────────────────────────────────────────────────────┐
│ Context: Depth=4, BiomeId="natural-caves", StyleId="carved"   │
└───────────────┬───────────────────────────────────────────────┘
                │
                ▼
┌───────────────────────────────────────────────────────────────┐
│ Template: "hidden-cache"                                      │
├───────────────────────────────────────────────────────────────┤
│ ├── SpawnProbability: 0.15                                   │
│ ├── PreferredBiomes: ["natural-caves", "ruined-structures"]  │
│ ├── PreferredStyles: []                                      │
│ └── MinDepth: 1, MaxDepth: 0 (no limit)                      │
│                                                               │
│ GetAdjustedProbability("natural-caves", "carved"):            │
│ ├── Base: 0.15                                               │
│ ├── Biome match! 0.15 × 1.5 = 0.225                          │
│ ├── No style match                                           │
│ └── Final: 0.225 (22.5% chance)                              │
└───────────────────────────────────────────────────────────────┘
                │
                ▼
┌───────────────────────────────────────────────────────────────┐
│ Template: "ancient-vault"                                     │
├───────────────────────────────────────────────────────────────┤
│ ├── SpawnProbability: 0.05                                   │
│ ├── PreferredBiomes: []                                      │
│ ├── PreferredStyles: ["ancient-temple", "carved-halls"]      │
│ └── MinDepth: 4, MaxDepth: 0                                 │
│                                                               │
│ GetAdjustedProbability("natural-caves", "carved"):            │
│ ├── Base: 0.05                                               │
│ ├── No biome match                                           │
│ ├── No style match (carved ≠ carved-halls)                   │
│ └── Final: 0.05 (5% chance)                                  │
└───────────────────────────────────────────────────────────────┘
                │
                ▼
┌───────────────────────────────────────────────────────────────┐
│ Template: "smugglers-den"                                     │
├───────────────────────────────────────────────────────────────┤
│ ├── SpawnProbability: 0.10                                   │
│ ├── PreferredBiomes: ["natural-caves"]                       │
│ ├── PreferredStyles: ["natural-caves"]                       │
│ └── MinDepth: 2, MaxDepth: 6                                 │
│                                                               │
│ GetAdjustedProbability("natural-caves", "carved"):            │
│ ├── Base: 0.10                                               │
│ ├── Biome match! 0.10 × 1.5 = 0.15                           │
│ ├── No style match                                           │
│ └── Final: 0.15 (15% chance)                                 │
└───────────────────────────────────────────────────────────────┘
```

---

## 4. SecretRoomTemplate Entity

### 4.1 Purpose

The `SecretRoomTemplate` entity defines a template for secret room generation loaded from JSON configuration. It specifies the secret room's characteristics, spawn probability, and associated loot and content.

### 4.2 File Location

**File:** `src/Core/RuneAndRust.Domain/Definitions/SecretRoomTemplate.cs`

### 4.3 Implementation

```csharp
namespace RuneAndRust.Domain.Definitions;

/// <summary>
/// Defines a template for secret room generation.
/// </summary>
/// <remarks>
/// Templates specify secret room characteristics including discovery difficulty,
/// spawn probability, and loot tables. Loaded from secrets.json.
/// Discovery mechanics implemented in v0.4.0.
/// </remarks>
public class SecretRoomTemplate : IDefinition
{
    /// <summary>
    /// Gets the unique identifier (e.g., "hidden-treasury").
    /// </summary>
    public string Id { get; private set; } = string.Empty;

    /// <summary>
    /// Gets the display name.
    /// </summary>
    public string Name { get; private set; } = string.Empty;

    /// <summary>
    /// Gets the description template for the secret room.
    /// </summary>
    /// <remarks>
    /// Supports placeholders like {biome} for dynamic text.
    /// </remarks>
    public string DescriptionTemplate { get; private set; } = string.Empty;

    /// <summary>
    /// Gets the base discovery difficulty (DC).
    /// </summary>
    /// <remarks>
    /// Scaled by depth during placement. Final DC is
    /// BaseDiscoveryDC + (depth / 2).
    /// </remarks>
    public int BaseDiscoveryDC { get; private set; }

    /// <summary>
    /// Gets the minimum dungeon depth for this secret type.
    /// </summary>
    /// <remarks>
    /// Secret will not appear above this depth.
    /// </remarks>
    public int MinDepth { get; private set; }

    /// <summary>
    /// Gets the maximum dungeon depth (0 = no limit).
    /// </summary>
    /// <remarks>
    /// Secret will not appear below this depth.
    /// Value of 0 means no maximum limit.
    /// </remarks>
    public int MaxDepth { get; private set; }

    /// <summary>
    /// Gets the base spawn probability (0-1).
    /// </summary>
    /// <remarks>
    /// Adjusted by biome and style preferences during placement.
    /// </remarks>
    public float SpawnProbability { get; private set; }

    /// <summary>
    /// Gets biome IDs where this secret appears more often.
    /// </summary>
    /// <remarks>
    /// Probability multiplied by 1.5 when biome matches.
    /// Empty list means no biome bonus.
    /// </remarks>
    public IReadOnlyList<string> PreferredBiomes { get; private set; } = Array.Empty<string>();

    /// <summary>
    /// Gets architectural style IDs with higher spawn chance.
    /// </summary>
    /// <remarks>
    /// Probability multiplied by 1.3 when style matches.
    /// Empty list means no style bonus.
    /// </remarks>
    public IReadOnlyList<string> PreferredStyles { get; private set; } = Array.Empty<string>();

    /// <summary>
    /// Gets the loot table ID for rewards.
    /// </summary>
    /// <remarks>
    /// References a loot table definition for secret room contents.
    /// </remarks>
    public string LootTableId { get; private set; } = string.Empty;

    /// <summary>
    /// Gets passage description templates shown before discovery.
    /// </summary>
    /// <remarks>
    /// One is randomly selected when creating a hidden passage.
    /// Describes how the passage appears when hidden.
    /// </remarks>
    public IReadOnlyList<string> PassageDescriptions { get; private set; } = Array.Empty<string>();

    /// <summary>
    /// Gets discovery hint templates.
    /// </summary>
    /// <remarks>
    /// Hints that may appear in room descriptions to suggest
    /// a secret is nearby. Used by v0.4.0 perception mechanics.
    /// </remarks>
    public IReadOnlyList<string> DiscoveryHints { get; private set; } = Array.Empty<string>();

    /// <summary>
    /// Gets whether this secret room can contain traps.
    /// </summary>
    /// <remarks>
    /// Used by TrapPlacementService (v0.1.5c) to determine
    /// if traps can be placed in this secret room.
    /// </remarks>
    public bool CanContainTraps { get; private set; }

    /// <summary>
    /// Gets whether this secret room can contain a guardian.
    /// </summary>
    /// <remarks>
    /// Used by VaultGenerationService (v0.1.5d) to determine
    /// if a guardian can be assigned to this secret room.
    /// </remarks>
    public bool CanContainGuardian { get; private set; }

    private SecretRoomTemplate() { /* JSON deserialization */ }

    /// <summary>
    /// Creates a secret room template.
    /// </summary>
    /// <param name="id">Unique identifier.</param>
    /// <param name="name">Display name.</param>
    /// <param name="descriptionTemplate">Description template text.</param>
    /// <param name="baseDiscoveryDC">Base discovery difficulty class.</param>
    /// <param name="spawnProbability">Base spawn probability (0-1).</param>
    /// <param name="lootTableId">Loot table identifier.</param>
    /// <returns>A new SecretRoomTemplate instance.</returns>
    /// <exception cref="ArgumentException">If id or name is null/empty.</exception>
    /// <exception cref="ArgumentOutOfRangeException">If baseDiscoveryDC is negative.</exception>
    public static SecretRoomTemplate Create(
        string id,
        string name,
        string descriptionTemplate,
        int baseDiscoveryDC,
        float spawnProbability,
        string lootTableId)
    {
        ArgumentException.ThrowIfNullOrWhiteSpace(id);
        ArgumentException.ThrowIfNullOrWhiteSpace(name);
        ArgumentOutOfRangeException.ThrowIfNegative(baseDiscoveryDC);

        return new SecretRoomTemplate
        {
            Id = id,
            Name = name,
            DescriptionTemplate = descriptionTemplate,
            BaseDiscoveryDC = baseDiscoveryDC,
            SpawnProbability = Math.Clamp(spawnProbability, 0f, 1f),
            LootTableId = lootTableId
        };
    }

    /// <summary>
    /// Sets depth constraints for the template.
    /// </summary>
    /// <param name="minDepth">Minimum depth (inclusive).</param>
    /// <param name="maxDepth">Maximum depth (0 = no limit).</param>
    /// <returns>This instance for method chaining.</returns>
    public SecretRoomTemplate WithDepthConstraints(int minDepth, int maxDepth = 0)
    {
        MinDepth = Math.Max(0, minDepth);
        MaxDepth = Math.Max(0, maxDepth);
        return this;
    }

    /// <summary>
    /// Sets preferred biomes for higher spawn chance.
    /// </summary>
    /// <param name="biomes">Biome IDs.</param>
    /// <returns>This instance for method chaining.</returns>
    public SecretRoomTemplate WithPreferredBiomes(params string[] biomes)
    {
        PreferredBiomes = biomes.ToList();
        return this;
    }

    /// <summary>
    /// Sets preferred architectural styles for higher spawn chance.
    /// </summary>
    /// <param name="styles">Style IDs.</param>
    /// <returns>This instance for method chaining.</returns>
    public SecretRoomTemplate WithPreferredStyles(params string[] styles)
    {
        PreferredStyles = styles.ToList();
        return this;
    }

    /// <summary>
    /// Sets passage descriptions for hidden passage creation.
    /// </summary>
    /// <param name="descriptions">Passage description templates.</param>
    /// <returns>This instance for method chaining.</returns>
    public SecretRoomTemplate WithPassageDescriptions(params string[] descriptions)
    {
        PassageDescriptions = descriptions.ToList();
        return this;
    }

    /// <summary>
    /// Sets discovery hints.
    /// </summary>
    /// <param name="hints">Hint text templates.</param>
    /// <returns>This instance for method chaining.</returns>
    public SecretRoomTemplate WithDiscoveryHints(params string[] hints)
    {
        DiscoveryHints = hints.ToList();
        return this;
    }

    /// <summary>
    /// Sets content flags for trap and guardian placement.
    /// </summary>
    /// <param name="canContainTraps">Whether traps can be placed.</param>
    /// <param name="canContainGuardian">Whether a guardian can be assigned.</param>
    /// <returns>This instance for method chaining.</returns>
    public SecretRoomTemplate WithContentFlags(bool canContainTraps, bool canContainGuardian)
    {
        CanContainTraps = canContainTraps;
        CanContainGuardian = canContainGuardian;
        return this;
    }

    /// <summary>
    /// Gets the scaled discovery DC for a given depth.
    /// </summary>
    /// <param name="depth">Current dungeon depth.</param>
    /// <returns>Scaled DC value.</returns>
    /// <remarks>
    /// Formula: BaseDiscoveryDC + (depth / 2)
    /// Deeper secrets are harder to find.
    /// </remarks>
    public int GetScaledDC(int depth)
    {
        var depthBonus = depth / 2;
        return BaseDiscoveryDC + depthBonus;
    }

    /// <summary>
    /// Gets the adjusted spawn probability for the given context.
    /// </summary>
    /// <param name="biomeId">Current biome ID (null if unknown).</param>
    /// <param name="styleId">Current architectural style ID (null if unknown).</param>
    /// <returns>Adjusted probability (0-1).</returns>
    /// <remarks>
    /// Applies biome bonus (×1.5) and style bonus (×1.3) if matching.
    /// Final probability is capped at 1.0.
    /// </remarks>
    public float GetAdjustedProbability(string? biomeId, string? styleId)
    {
        var probability = SpawnProbability;

        if (biomeId != null && PreferredBiomes.Contains(biomeId))
            probability *= 1.5f;

        if (styleId != null && PreferredStyles.Contains(styleId))
            probability *= 1.3f;

        return Math.Min(probability, 1f);
    }

    /// <summary>
    /// Checks if this template is valid for the given depth.
    /// </summary>
    /// <param name="depth">Current dungeon depth.</param>
    /// <returns>True if depth is within valid range.</returns>
    public bool IsValidFor(int depth)
    {
        if (depth < MinDepth) return false;
        if (MaxDepth > 0 && depth > MaxDepth) return false;
        return true;
    }
}
```

### 4.4 Property Summary

| Property | Type | Description |
|----------|------|-------------|
| `Id` | `string` | Unique identifier (e.g., "hidden-cache") |
| `Name` | `string` | Display name (e.g., "Hidden Cache") |
| `DescriptionTemplate` | `string` | Room description with placeholders |
| `BaseDiscoveryDC` | `int` | Base difficulty class for discovery |
| `MinDepth` | `int` | Minimum depth for appearance |
| `MaxDepth` | `int` | Maximum depth (0 = no limit) |
| `SpawnProbability` | `float` | Base spawn chance (0-1) |
| `PreferredBiomes` | `IReadOnlyList<string>` | Biomes with bonus probability |
| `PreferredStyles` | `IReadOnlyList<string>` | Styles with bonus probability |
| `LootTableId` | `string` | Reference to loot table |
| `PassageDescriptions` | `IReadOnlyList<string>` | Hidden passage descriptions |
| `DiscoveryHints` | `IReadOnlyList<string>` | Hints for nearby secrets |
| `CanContainTraps` | `bool` | Whether traps allowed |
| `CanContainGuardian` | `bool` | Whether guardian allowed |

---

## 5. HiddenPassage Entity

### 5.1 Purpose

The `HiddenPassage` entity represents a hidden passage connecting a normal room to a secret room. It stores discovery difficulty, descriptions, and hints used by v0.4.0 search mechanics.

### 5.2 File Location

**File:** `src/Core/RuneAndRust.Domain/Entities/HiddenPassage.cs`

### 5.3 Implementation

```csharp
namespace RuneAndRust.Domain.Entities;

using RuneAndRust.Domain.Definitions;
using RuneAndRust.Domain.Enums;

/// <summary>
/// A hidden passage connecting a room to a secret room.
/// </summary>
/// <remarks>
/// Generated during dungeon creation. Discovery state and
/// interaction mechanics are implemented in v0.4.0.
/// </remarks>
public class HiddenPassage : IEntity
{
    /// <summary>
    /// Gets the unique identifier for this passage.
    /// </summary>
    public Guid Id { get; private set; }

    /// <summary>
    /// Gets the ID of the room containing this hidden passage.
    /// </summary>
    /// <remarks>
    /// The passage is hidden in this room's wall/floor/etc.
    /// </remarks>
    public Guid SourceRoomId { get; private set; }

    /// <summary>
    /// Gets the ID of the secret room this passage leads to.
    /// </summary>
    public Guid DestinationRoomId { get; private set; }

    /// <summary>
    /// Gets the template ID used to generate this passage.
    /// </summary>
    /// <remarks>
    /// References a SecretRoomTemplate.Id.
    /// </remarks>
    public string TemplateId { get; private set; } = string.Empty;

    /// <summary>
    /// Gets the direction of the hidden passage.
    /// </summary>
    /// <remarks>
    /// The direction from the source room to the secret room.
    /// </remarks>
    public Direction Direction { get; private set; }

    /// <summary>
    /// Gets the difficulty class to discover this passage.
    /// </summary>
    /// <remarks>
    /// Used by v0.4.0 perception checks. Scaled by dungeon depth.
    /// </remarks>
    public int DiscoveryDC { get; private set; }

    /// <summary>
    /// Gets the description shown before the passage is discovered.
    /// </summary>
    /// <remarks>
    /// A subtle description that hints at something unusual
    /// but doesn't reveal the passage directly.
    /// </remarks>
    public string HiddenDescription { get; private set; } = string.Empty;

    /// <summary>
    /// Gets the description shown after the passage is discovered.
    /// </summary>
    /// <remarks>
    /// Clearly describes the passage and where it leads.
    /// </remarks>
    public string RevealedDescription { get; private set; } = string.Empty;

    /// <summary>
    /// Gets hints that may appear in the source room description.
    /// </summary>
    /// <remarks>
    /// Subtle clues that suggest a secret is nearby.
    /// Used by v0.4.0 to provide perception-based hints.
    /// </remarks>
    public IReadOnlyList<string> Hints { get; private set; } = Array.Empty<string>();

    private HiddenPassage() { /* EF Core / JSON deserialization */ }

    /// <summary>
    /// Creates a hidden passage between rooms.
    /// </summary>
    /// <param name="sourceRoomId">Room containing the passage.</param>
    /// <param name="destinationRoomId">Secret room the passage leads to.</param>
    /// <param name="template">Template used for generation.</param>
    /// <param name="direction">Direction of the passage.</param>
    /// <param name="discoveryDC">Difficulty class for discovery.</param>
    /// <param name="hiddenDescription">Pre-discovery description.</param>
    /// <param name="revealedDescription">Post-discovery description.</param>
    /// <param name="hints">Hint texts.</param>
    /// <returns>A new HiddenPassage instance.</returns>
    public static HiddenPassage Create(
        Guid sourceRoomId,
        Guid destinationRoomId,
        SecretRoomTemplate template,
        Direction direction,
        int discoveryDC,
        string hiddenDescription,
        string revealedDescription,
        IEnumerable<string> hints)
    {
        return new HiddenPassage
        {
            Id = Guid.NewGuid(),
            SourceRoomId = sourceRoomId,
            DestinationRoomId = destinationRoomId,
            TemplateId = template.Id,
            Direction = direction,
            DiscoveryDC = discoveryDC,
            HiddenDescription = hiddenDescription,
            RevealedDescription = revealedDescription,
            Hints = hints.ToList()
        };
    }

    /// <summary>
    /// Creates a hidden passage with explicit template ID.
    /// </summary>
    /// <param name="sourceRoomId">Room containing the passage.</param>
    /// <param name="destinationRoomId">Secret room the passage leads to.</param>
    /// <param name="templateId">Template ID reference.</param>
    /// <param name="direction">Direction of the passage.</param>
    /// <param name="discoveryDC">Difficulty class for discovery.</param>
    /// <param name="hiddenDescription">Pre-discovery description.</param>
    /// <param name="revealedDescription">Post-discovery description.</param>
    /// <param name="hints">Hint texts.</param>
    /// <returns>A new HiddenPassage instance.</returns>
    public static HiddenPassage Create(
        Guid sourceRoomId,
        Guid destinationRoomId,
        string templateId,
        Direction direction,
        int discoveryDC,
        string hiddenDescription,
        string revealedDescription,
        IEnumerable<string> hints)
    {
        ArgumentException.ThrowIfNullOrWhiteSpace(templateId);

        return new HiddenPassage
        {
            Id = Guid.NewGuid(),
            SourceRoomId = sourceRoomId,
            DestinationRoomId = destinationRoomId,
            TemplateId = templateId,
            Direction = direction,
            DiscoveryDC = discoveryDC,
            HiddenDescription = hiddenDescription,
            RevealedDescription = revealedDescription,
            Hints = hints.ToList()
        };
    }

    /// <summary>
    /// Gets the opposite direction (for the reverse passage).
    /// </summary>
    /// <returns>The opposite direction.</returns>
    public Direction GetReverseDirection()
    {
        return Direction switch
        {
            Direction.North => Direction.South,
            Direction.South => Direction.North,
            Direction.East => Direction.West,
            Direction.West => Direction.East,
            Direction.Up => Direction.Down,
            Direction.Down => Direction.Up,
            _ => Direction
        };
    }
}
```

### 5.4 Property Summary

| Property | Type | Description |
|----------|------|-------------|
| `Id` | `Guid` | Unique passage identifier |
| `SourceRoomId` | `Guid` | Room containing the hidden passage |
| `DestinationRoomId` | `Guid` | Secret room the passage leads to |
| `TemplateId` | `string` | Reference to SecretRoomTemplate |
| `Direction` | `Direction` | Direction of the passage |
| `DiscoveryDC` | `int` | Difficulty class for discovery |
| `HiddenDescription` | `string` | Description before discovery |
| `RevealedDescription` | `string` | Description after discovery |
| `Hints` | `IReadOnlyList<string>` | Subtle hint texts |

---

## 6. SecretPlacementRules Value Object

### 6.1 Purpose

The `SecretPlacementRules` value object encapsulates probability calculation rules for secret room placement, including base probability and bonus multipliers.

### 6.2 File Location

**File:** `src/Core/RuneAndRust.Domain/ValueObjects/SecretPlacementRules.cs`

### 6.3 Implementation

```csharp
namespace RuneAndRust.Domain.ValueObjects;

/// <summary>
/// Rules for secret room placement probability.
/// </summary>
/// <remarks>
/// Encapsulates the probability calculation logic for secret placement.
/// </remarks>
public readonly record struct SecretPlacementRules
{
    /// <summary>
    /// Gets the base spawn probability (0-1).
    /// </summary>
    public float BaseProbability { get; }

    /// <summary>
    /// Gets the biome match bonus multiplier.
    /// </summary>
    /// <remarks>
    /// Applied when the current biome matches a preferred biome.
    /// Default is 1.5 (50% bonus).
    /// </remarks>
    public float BiomeBonusMultiplier { get; }

    /// <summary>
    /// Gets the style match bonus multiplier.
    /// </summary>
    /// <remarks>
    /// Applied when the current style matches a preferred style.
    /// Default is 1.3 (30% bonus).
    /// </remarks>
    public float StyleBonusMultiplier { get; }

    /// <summary>
    /// Creates placement rules with default multipliers.
    /// </summary>
    /// <param name="baseProbability">Base spawn probability (0-1).</param>
    public SecretPlacementRules(float baseProbability)
        : this(baseProbability, 1.5f, 1.3f)
    {
    }

    /// <summary>
    /// Creates placement rules with custom multipliers.
    /// </summary>
    /// <param name="baseProbability">Base spawn probability (0-1).</param>
    /// <param name="biomeBonusMultiplier">Biome match multiplier.</param>
    /// <param name="styleBonusMultiplier">Style match multiplier.</param>
    public SecretPlacementRules(
        float baseProbability,
        float biomeBonusMultiplier,
        float styleBonusMultiplier)
    {
        BaseProbability = Math.Clamp(baseProbability, 0f, 1f);
        BiomeBonusMultiplier = Math.Max(1f, biomeBonusMultiplier);
        StyleBonusMultiplier = Math.Max(1f, styleBonusMultiplier);
    }

    /// <summary>
    /// Calculates adjusted probability based on context matches.
    /// </summary>
    /// <param name="biomeMatches">Whether the biome matches a preferred biome.</param>
    /// <param name="styleMatches">Whether the style matches a preferred style.</param>
    /// <returns>Adjusted probability (0-1).</returns>
    public float CalculateProbability(bool biomeMatches, bool styleMatches)
    {
        var probability = BaseProbability;

        if (biomeMatches)
            probability *= BiomeBonusMultiplier;

        if (styleMatches)
            probability *= StyleBonusMultiplier;

        return Math.Min(probability, 1f);
    }

    /// <summary>
    /// Gets the default placement rules.
    /// </summary>
    public static SecretPlacementRules Default => new(0.1f);
}
```

---

## 7. SecretPlacementContext Record

### 7.1 Purpose

The `SecretPlacementContext` record provides context information needed by `SecretPlacementService` to generate secrets for a dungeon level.

### 7.2 File Location

**File:** `src/Core/RuneAndRust.Application/Records/SecretPlacementContext.cs`

### 7.3 Implementation

```csharp
namespace RuneAndRust.Application.Records;

/// <summary>
/// Context for secret room generation.
/// </summary>
/// <remarks>
/// Provides all information needed to generate secrets for a dungeon level.
/// </remarks>
public sealed record SecretPlacementContext
{
    /// <summary>
    /// Gets the dungeon ID.
    /// </summary>
    public Guid DungeonId { get; init; }

    /// <summary>
    /// Gets the current dungeon depth (floor number).
    /// </summary>
    /// <remarks>
    /// Used for depth-based template filtering and DC scaling.
    /// </remarks>
    public int Depth { get; init; }

    /// <summary>
    /// Gets the biome ID for this level.
    /// </summary>
    /// <remarks>
    /// Used for biome preference matching.
    /// </remarks>
    public string? BiomeId { get; init; }

    /// <summary>
    /// Gets the biome display name.
    /// </summary>
    public string? BiomeName { get; init; }

    /// <summary>
    /// Gets the architectural style ID for this level.
    /// </summary>
    /// <remarks>
    /// Used for style preference matching.
    /// </remarks>
    public string? ArchitecturalStyleId { get; init; }

    /// <summary>
    /// Gets the world seed for reproducible generation.
    /// </summary>
    public int WorldSeed { get; init; }

    /// <summary>
    /// Gets the maximum number of secrets to place on this level.
    /// </summary>
    /// <remarks>
    /// Limits the total secrets per level. Default is 3.
    /// </remarks>
    public int MaxSecretsPerLevel { get; init; } = 3;

    /// <summary>
    /// Creates a context for secret placement.
    /// </summary>
    public static SecretPlacementContext Create(
        Guid dungeonId,
        int depth,
        string? biomeId,
        string? biomeName,
        string? architecturalStyleId,
        int worldSeed,
        int maxSecretsPerLevel = 3)
    {
        return new SecretPlacementContext
        {
            DungeonId = dungeonId,
            Depth = depth,
            BiomeId = biomeId,
            BiomeName = biomeName,
            ArchitecturalStyleId = architecturalStyleId,
            WorldSeed = worldSeed,
            MaxSecretsPerLevel = maxSecretsPerLevel
        };
    }
}
```

---

## 8. SecretPlacementResult Record

### 8.1 Purpose

The `SecretPlacementResult` record contains the results of a successful secret room placement.

### 8.2 File Location

**File:** `src/Core/RuneAndRust.Application/Records/SecretPlacementResult.cs`

### 8.3 Implementation

```csharp
namespace RuneAndRust.Application.Records;

using RuneAndRust.Domain.Definitions;
using RuneAndRust.Domain.Entities;

/// <summary>
/// Result of a successful secret room placement.
/// </summary>
/// <remarks>
/// Contains the created secret room, hidden passage, and template reference.
/// </remarks>
public sealed record SecretPlacementResult
{
    /// <summary>
    /// Gets the created secret room.
    /// </summary>
    public required Room SecretRoom { get; init; }

    /// <summary>
    /// Gets the hidden passage connecting to the secret room.
    /// </summary>
    public required HiddenPassage Passage { get; init; }

    /// <summary>
    /// Gets the template used for generation.
    /// </summary>
    public required SecretRoomTemplate Template { get; init; }
}
```

---

## 9. SecretPlacementService

### 9.1 Purpose

The `SecretPlacementService` generates and places secret rooms during dungeon generation. It handles template selection, probability calculation, and passage creation.

### 9.2 File Location

**File:** `src/Core/RuneAndRust.Application/Services/SecretPlacementService.cs`

### 9.3 Interface

**File:** `src/Core/RuneAndRust.Application/Interfaces/ISecretPlacementService.cs`

```csharp
namespace RuneAndRust.Application.Interfaces;

using RuneAndRust.Application.Records;
using RuneAndRust.Domain.Entities;

/// <summary>
/// Service for generating and placing secret rooms.
/// </summary>
public interface ISecretPlacementService
{
    /// <summary>
    /// Generates secret rooms for a dungeon level.
    /// </summary>
    /// <param name="context">Placement context.</param>
    /// <param name="rooms">Available source rooms.</param>
    /// <returns>Collection of placement results.</returns>
    IEnumerable<SecretPlacementResult> GenerateSecrets(
        SecretPlacementContext context,
        IEnumerable<Room> rooms);
}
```

### 9.4 Implementation

```csharp
namespace RuneAndRust.Application.Services;

using Microsoft.Extensions.Logging;
using RuneAndRust.Application.Interfaces;
using RuneAndRust.Application.Records;
using RuneAndRust.Domain.Definitions;
using RuneAndRust.Domain.Entities;
using RuneAndRust.Domain.Enums;

/// <summary>
/// Generates and places secret rooms during dungeon generation.
/// </summary>
/// <remarks>
/// Handles template selection, probability calculation, and passage creation.
/// Discovery mechanics are implemented in v0.4.0.
/// </remarks>
public class SecretPlacementService : ISecretPlacementService
{
    private readonly IConfigurationProvider _configurationProvider;
    private readonly ISeededRandomService _randomService;
    private readonly ILogger<SecretPlacementService> _logger;

    /// <summary>
    /// Creates a new instance of the secret placement service.
    /// </summary>
    /// <param name="configurationProvider">Configuration provider for templates.</param>
    /// <param name="randomService">Seeded random service.</param>
    /// <param name="logger">Logger instance.</param>
    public SecretPlacementService(
        IConfigurationProvider configurationProvider,
        ISeededRandomService randomService,
        ILogger<SecretPlacementService> logger)
    {
        _configurationProvider = configurationProvider;
        _randomService = randomService;
        _logger = logger;
    }

    /// <inheritdoc/>
    public IEnumerable<SecretPlacementResult> GenerateSecrets(
        SecretPlacementContext context,
        IEnumerable<Room> rooms)
    {
        var templates = _configurationProvider.GetSecretRoomTemplates()
            .Where(t => t.IsValidFor(context.Depth))
            .ToList();

        if (templates.Count == 0)
        {
            _logger.LogDebug(
                "No valid secret templates for depth {Depth}",
                context.Depth);
            yield break;
        }

        _logger.LogDebug(
            "Found {Count} valid secret templates for depth {Depth}",
            templates.Count, context.Depth);

        var secretsPlaced = 0;
        var roomList = rooms.ToList();

        foreach (var room in roomList)
        {
            if (secretsPlaced >= context.MaxSecretsPerLevel)
            {
                _logger.LogDebug(
                    "Reached maximum secrets per level ({Max})",
                    context.MaxSecretsPerLevel);
                break;
            }

            // Skip rooms that are already secret rooms
            if (room.Type == RoomType.Secret) continue;

            var result = TryPlaceSecret(room, templates, context);
            if (result != null)
            {
                secretsPlaced++;
                yield return result;
            }
        }

        _logger.LogInformation(
            "Placed {Count} secret rooms on level {Depth}",
            secretsPlaced, context.Depth);
    }

    /// <summary>
    /// Attempts to place a secret room adjacent to the given room.
    /// </summary>
    private SecretPlacementResult? TryPlaceSecret(
        Room sourceRoom,
        IList<SecretRoomTemplate> templates,
        SecretPlacementContext context)
    {
        foreach (var template in templates)
        {
            var probability = template.GetAdjustedProbability(
                context.BiomeId,
                context.ArchitecturalStyleId);

            _logger.LogDebug(
                "Template '{Template}' probability: {Probability:P1} (base: {Base:P1})",
                template.Id, probability, template.SpawnProbability);

            var roll = _randomService.NextDouble();
            if (roll >= probability)
            {
                _logger.LogDebug(
                    "Roll {Roll:F3} >= {Probability:F3}, skipping template '{Template}'",
                    roll, probability, template.Id);
                continue;
            }

            var direction = FindAvailableDirection(sourceRoom);
            if (direction == null)
            {
                _logger.LogDebug(
                    "No available direction for secret in room {RoomId}",
                    sourceRoom.Id);
                continue;
            }

            var secretRoom = CreateSecretRoom(template, sourceRoom, context);
            var passage = CreateHiddenPassage(
                template, sourceRoom, secretRoom, direction.Value, context);

            _logger.LogInformation(
                "Placed secret '{Template}' ({Name}) adjacent to room {RoomId} ({Direction}), DC={DC}",
                template.Id, template.Name, sourceRoom.Id, direction.Value, passage.DiscoveryDC);

            return new SecretPlacementResult
            {
                SecretRoom = secretRoom,
                Passage = passage,
                Template = template
            };
        }

        return null;
    }

    /// <summary>
    /// Creates a secret room based on the template.
    /// </summary>
    private Room CreateSecretRoom(
        SecretRoomTemplate template,
        Room sourceRoom,
        SecretPlacementContext context)
    {
        var description = GenerateDescription(template, context);

        return Room.Create(
            context.DungeonId,
            template.Name,
            description,
            sourceRoom.Position, // Position adjusted by dungeon generator
            RoomType.Secret);
    }

    /// <summary>
    /// Creates a hidden passage connecting rooms.
    /// </summary>
    private HiddenPassage CreateHiddenPassage(
        SecretRoomTemplate template,
        Room sourceRoom,
        Room secretRoom,
        Direction direction,
        SecretPlacementContext context)
    {
        var hiddenDescription = SelectDescription(
            template.PassageDescriptions,
            "The wall here looks slightly different...");

        var revealedDescription = GenerateRevealedDescription(direction);

        var hints = SelectHints(template.DiscoveryHints, 3);

        var discoveryDC = template.GetScaledDC(context.Depth);

        return HiddenPassage.Create(
            sourceRoom.Id,
            secretRoom.Id,
            template,
            direction,
            discoveryDC,
            hiddenDescription,
            revealedDescription,
            hints);
    }

    /// <summary>
    /// Generates the room description from the template.
    /// </summary>
    private string GenerateDescription(
        SecretRoomTemplate template,
        SecretPlacementContext context)
    {
        var description = template.DescriptionTemplate;

        if (context.BiomeName != null)
        {
            description = description.Replace("{biome}", context.BiomeName);
        }

        return description;
    }

    /// <summary>
    /// Generates the revealed passage description.
    /// </summary>
    private static string GenerateRevealedDescription(Direction direction)
    {
        return $"A hidden passage leads {direction.ToString().ToLowerInvariant()}.";
    }

    /// <summary>
    /// Finds an available direction for a hidden passage.
    /// </summary>
    private Direction? FindAvailableDirection(Room room)
    {
        var usedDirections = room.Exits
            .Select(e => e.Direction)
            .ToHashSet();

        var availableDirections = new[]
            {
                Direction.North,
                Direction.South,
                Direction.East,
                Direction.West
            }
            .Where(d => !usedDirections.Contains(d))
            .ToList();

        if (availableDirections.Count == 0)
        {
            return null;
        }

        var index = _randomService.Next(0, availableDirections.Count);
        return availableDirections[index];
    }

    /// <summary>
    /// Selects a random description from options.
    /// </summary>
    private string SelectDescription(
        IReadOnlyList<string> options,
        string fallback)
    {
        if (options.Count == 0)
        {
            return fallback;
        }

        var index = _randomService.Next(0, options.Count);
        return options[index];
    }

    /// <summary>
    /// Selects random hints from options.
    /// </summary>
    private IEnumerable<string> SelectHints(
        IReadOnlyList<string> options,
        int maxHints)
    {
        if (options.Count == 0)
        {
            yield break;
        }

        var count = Math.Min(options.Count, maxHints);
        var indices = Enumerable.Range(0, options.Count)
            .OrderBy(_ => _randomService.Next())
            .Take(count);

        foreach (var index in indices)
        {
            yield return options[index];
        }
    }
}
```

---

## 10. Configuration File Schemas

### 10.1 secrets.json

**File:** `config/secrets.json`

```json
{
  "$schema": "../schemas/secrets.schema.json",
  "secretRoomTemplates": [
    {
      "id": "hidden-cache",
      "name": "Hidden Cache",
      "descriptionTemplate": "A small alcove concealed behind loose stones. Dusty crates and forgotten supplies fill the cramped space.",
      "baseDiscoveryDC": 12,
      "minDepth": 1,
      "maxDepth": 0,
      "spawnProbability": 0.15,
      "preferredBiomes": ["natural-caves", "ruined-structures"],
      "preferredStyles": [],
      "lootTableId": "secret-cache-common",
      "passageDescriptions": [
        "A section of wall swings inward",
        "Loose stones reveal an opening",
        "A hidden panel slides aside"
      ],
      "discoveryHints": [
        "The stonework here seems slightly uneven",
        "A faint draft comes from somewhere nearby",
        "You notice scratches around certain stones"
      ],
      "canContainTraps": false,
      "canContainGuardian": false
    },
    {
      "id": "ancient-vault",
      "name": "Ancient Vault",
      "descriptionTemplate": "An intact vault from a forgotten age. Magical wards still shimmer faintly on the walls.",
      "baseDiscoveryDC": 18,
      "minDepth": 4,
      "maxDepth": 0,
      "spawnProbability": 0.05,
      "preferredBiomes": [],
      "preferredStyles": ["ancient-temple", "carved-halls"],
      "lootTableId": "secret-vault-rare",
      "passageDescriptions": [
        "An illusory wall fades away",
        "Ancient runes reveal a doorway",
        "A magical seal dissolves"
      ],
      "discoveryHints": [
        "Magic tingles at your fingertips here",
        "The air feels different near this wall",
        "You sense something hidden by arcane means"
      ],
      "canContainTraps": true,
      "canContainGuardian": true
    },
    {
      "id": "smugglers-den",
      "name": "Smuggler's Den",
      "descriptionTemplate": "A cramped hideout once used by smugglers. Maps and contraband remain scattered about.",
      "baseDiscoveryDC": 14,
      "minDepth": 2,
      "maxDepth": 6,
      "spawnProbability": 0.10,
      "preferredBiomes": ["natural-caves"],
      "preferredStyles": ["natural-caves"],
      "lootTableId": "secret-smuggler",
      "passageDescriptions": [
        "A hidden lever reveals an opening",
        "A false rock wall pivots inward",
        "A concealed trapdoor opens"
      ],
      "discoveryHints": [
        "Boot prints disappear near this wall",
        "You notice well-worn handholds",
        "The floor is scuffed in an odd pattern"
      ],
      "canContainTraps": true,
      "canContainGuardian": false
    },
    {
      "id": "forgotten-shrine",
      "name": "Forgotten Shrine",
      "descriptionTemplate": "A small shrine dedicated to a forgotten deity. Faded offerings lie at the base of a cracked altar.",
      "baseDiscoveryDC": 15,
      "minDepth": 3,
      "maxDepth": 0,
      "spawnProbability": 0.08,
      "preferredBiomes": [],
      "preferredStyles": ["ancient-temple", "ruined-structures"],
      "lootTableId": "secret-shrine",
      "passageDescriptions": [
        "A religious symbol rotates to reveal passage",
        "The altar slides aside",
        "A prayer unlocks the hidden way"
      ],
      "discoveryHints": [
        "You feel a strange presence nearby",
        "The air carries a faint incense smell",
        "Religious symbols are carved into the wall"
      ],
      "canContainTraps": false,
      "canContainGuardian": true
    },
    {
      "id": "escaped-prisoner-cell",
      "name": "Escaped Prisoner's Cell",
      "descriptionTemplate": "A hidden cell where a prisoner once hid. Scratched tally marks cover the walls.",
      "baseDiscoveryDC": 13,
      "minDepth": 2,
      "maxDepth": 5,
      "spawnProbability": 0.07,
      "preferredBiomes": ["dungeon-depths"],
      "preferredStyles": ["carved-halls", "ruined-structures"],
      "lootTableId": "secret-prisoner",
      "passageDescriptions": [
        "A loose floor tile reveals stairs",
        "A gap behind the bed leads deeper",
        "Broken bars reveal an escape route"
      ],
      "discoveryHints": [
        "Scratches mark the stone here",
        "The mortar between stones is loose",
        "Something rattles beneath the floor"
      ],
      "canContainTraps": false,
      "canContainGuardian": false
    }
  ]
}
```

### 10.2 secrets.schema.json

**File:** `config/schemas/secrets.schema.json`

```json
{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "secrets.schema.json",
  "title": "Secret Room Configuration",
  "description": "Schema for secret room template definitions",
  "type": "object",
  "required": ["secretRoomTemplates"],
  "properties": {
    "$schema": {
      "type": "string",
      "description": "JSON Schema reference"
    },
    "secretRoomTemplates": {
      "type": "array",
      "description": "Collection of secret room templates",
      "items": {
        "$ref": "#/$defs/secretRoomTemplate"
      },
      "minItems": 1
    }
  },
  "$defs": {
    "secretRoomTemplate": {
      "type": "object",
      "description": "A template for secret room generation",
      "required": [
        "id",
        "name",
        "descriptionTemplate",
        "baseDiscoveryDC",
        "spawnProbability",
        "lootTableId"
      ],
      "properties": {
        "id": {
          "type": "string",
          "pattern": "^[a-z][a-z0-9-]*$",
          "description": "Unique identifier (kebab-case)"
        },
        "name": {
          "type": "string",
          "minLength": 1,
          "description": "Display name"
        },
        "descriptionTemplate": {
          "type": "string",
          "minLength": 1,
          "description": "Description with {biome} placeholder support"
        },
        "baseDiscoveryDC": {
          "type": "integer",
          "minimum": 1,
          "maximum": 30,
          "description": "Base difficulty class for discovery (1-30)"
        },
        "minDepth": {
          "type": "integer",
          "minimum": 0,
          "default": 0,
          "description": "Minimum dungeon depth"
        },
        "maxDepth": {
          "type": "integer",
          "minimum": 0,
          "default": 0,
          "description": "Maximum dungeon depth (0 = no limit)"
        },
        "spawnProbability": {
          "type": "number",
          "minimum": 0,
          "maximum": 1,
          "description": "Base spawn probability (0-1)"
        },
        "preferredBiomes": {
          "type": "array",
          "items": { "type": "string" },
          "default": [],
          "description": "Biome IDs with bonus spawn chance"
        },
        "preferredStyles": {
          "type": "array",
          "items": { "type": "string" },
          "default": [],
          "description": "Architectural style IDs with bonus spawn chance"
        },
        "lootTableId": {
          "type": "string",
          "minLength": 1,
          "description": "Reference to loot table for contents"
        },
        "passageDescriptions": {
          "type": "array",
          "items": { "type": "string" },
          "default": [],
          "description": "Hidden passage description templates"
        },
        "discoveryHints": {
          "type": "array",
          "items": { "type": "string" },
          "default": [],
          "description": "Hint text templates for discovery"
        },
        "canContainTraps": {
          "type": "boolean",
          "default": false,
          "description": "Whether traps can be placed in this secret"
        },
        "canContainGuardian": {
          "type": "boolean",
          "default": false,
          "description": "Whether a guardian can be assigned"
        }
      }
    }
  }
}
```

---

## 11. Logging Specifications

### 11.1 Log Levels by Component

| Component | Level | Events |
|-----------|-------|--------|
| `SecretPlacementService` | Information | Secret placed, generation complete |
| `SecretPlacementService` | Debug | Template filtering, probability calculation, roll results, direction finding |
| `SecretPlacementService` | Warning | No valid templates, maximum secrets reached |
| `SecretRoomTemplate` | Debug | Validation checks, DC scaling, probability calculation |

### 11.2 Log Message Examples

```csharp
// Information
_logger.LogInformation(
    "Placed secret '{Template}' ({Name}) adjacent to room {RoomId} ({Direction}), DC={DC}",
    template.Id, template.Name, sourceRoom.Id, direction, passage.DiscoveryDC);

_logger.LogInformation(
    "Placed {Count} secret rooms on level {Depth}",
    secretsPlaced, context.Depth);

// Debug
_logger.LogDebug(
    "No valid secret templates for depth {Depth}",
    context.Depth);

_logger.LogDebug(
    "Found {Count} valid secret templates for depth {Depth}",
    templates.Count, context.Depth);

_logger.LogDebug(
    "Template '{Template}' probability: {Probability:P1} (base: {Base:P1})",
    template.Id, probability, template.SpawnProbability);

_logger.LogDebug(
    "Roll {Roll:F3} >= {Probability:F3}, skipping template '{Template}'",
    roll, probability, template.Id);

_logger.LogDebug(
    "No available direction for secret in room {RoomId}",
    sourceRoom.Id);

// Warning
_logger.LogWarning(
    "Reached maximum secrets per level ({Max})",
    context.MaxSecretsPerLevel);
```

---

## 12. Unit Testing Requirements

### 12.1 Test Count by Feature

| Feature | Test Count |
|---------|------------|
| SecretRoomTemplate entity | ~5 |
| HiddenPassage entity | ~4 |
| SecretPlacementRules value object | ~3 |
| SecretPlacementService | ~6 |
| Configuration loading | ~2 |
| **Total** | **~20** |

### 12.2 Test Files

| File | Tests | Coverage |
|------|-------|----------|
| `SecretRoomTemplateTests.cs` | ~5 | Create, IsValidFor, GetScaledDC, GetAdjustedProbability, validation |
| `HiddenPassageTests.cs` | ~4 | Create (both overloads), GetReverseDirection, properties |
| `SecretPlacementRulesTests.cs` | ~3 | Constructor, CalculateProbability, Default |
| `SecretPlacementServiceTests.cs` | ~6 | GenerateSecrets, probability calculation, direction finding, max limit |
| `SecretConfigurationTests.cs` | ~2 | JSON loading, schema validation |

### 12.3 Test Categories

**SecretRoomTemplate Tests:**
```csharp
[Test]
public void Create_WithValidParameters_CreatesSecretRoomTemplate()

[Test]
public void Create_WithInvalidId_ThrowsArgumentException()

[Test]
public void IsValidFor_WhenDepthBelowMinimum_ReturnsFalse()

[Test]
public void IsValidFor_WhenDepthAboveMaximum_ReturnsFalse()

[Test]
public void GetScaledDC_ScalesWithDepth()

[Test]
public void GetAdjustedProbability_AppliesBiomeBonus()

[Test]
public void GetAdjustedProbability_AppliesStyleBonus()

[Test]
public void GetAdjustedProbability_CapsAtOne()
```

**HiddenPassage Tests:**
```csharp
[Test]
public void Create_WithTemplate_CreatesHiddenPassage()

[Test]
public void Create_WithTemplateId_CreatesHiddenPassage()

[Test]
public void GetReverseDirection_ReturnsOpposite()

[Test]
public void Create_SetsAllPropertiesCorrectly()
```

**SecretPlacementService Tests:**
```csharp
[Test]
public void GenerateSecrets_WithValidContext_ReturnsSecrets()

[Test]
public void GenerateSecrets_WithNoValidTemplates_ReturnsEmpty()

[Test]
public void GenerateSecrets_RespectsMaxSecretsPerLevel()

[Test]
public void GenerateSecrets_SkipsSecretRooms()

[Test]
public void TryPlaceSecret_WithNoAvailableDirection_ReturnsNull()

[Test]
public void TryPlaceSecret_AppliesBiomeBonus_ToProbability()
```

---

## 13. Use Cases

### UC-001: Generate Secrets for Dungeon Level

**Actor:** DungeonGeneratorService
**Flow:** Level generation complete → DungeonGenerator creates SecretPlacementContext → Calls ISecretPlacementService.GenerateSecrets(context, rooms) → SecretPlacementResults returned and integrated with dungeon

### UC-002: Place Secret Adjacent to Normal Room

**Actor:** SecretPlacementService
**Flow:** Room iterated → Template probability calculated → Roll succeeds → Available direction found → Secret room created → Hidden passage created → Result returned

### UC-003: Filter Templates by Depth

**Actor:** SecretPlacementService
**Flow:** Context has Depth=5 → GetSecretRoomTemplates() returns all templates → IsValidFor filters to depth-compatible templates → "ancient-vault" included (minDepth=4), "escaped-prisoner-cell" excluded (maxDepth=5)

### UC-004: Calculate Adjusted Probability

**Actor:** SecretPlacementService
**Flow:** Template has SpawnProbability=0.10, PreferredBiomes=["natural-caves"] → Context.BiomeId="natural-caves" → GetAdjustedProbability multiplies by 1.5 → Final probability 0.15

### UC-005: Scale Discovery DC by Depth

**Actor:** SecretPlacementService
**Flow:** Template has BaseDiscoveryDC=12, Context.Depth=6 → GetScaledDC(6) calculates 12 + (6/2) = 15 → HiddenPassage created with DiscoveryDC=15

### UC-006: Respect Maximum Secrets Per Level

**Actor:** SecretPlacementService
**Flow:** Context.MaxSecretsPerLevel=3 → First 3 secrets placed → Fourth room evaluated but skipped → Log message "Reached maximum secrets per level"

---

## 14. Deliverable Checklist

### Domain Layer

- [ ] `SecretRoomTemplate.cs` created with IDefinition
- [ ] `HiddenPassage.cs` created with IEntity
- [ ] `SecretPlacementRules.cs` created as value object

### Application Layer

- [ ] `ISecretPlacementService.cs` created
- [ ] `SecretPlacementService.cs` created
- [ ] `SecretPlacementContext.cs` created as record
- [ ] `SecretPlacementResult.cs` created as record

### Infrastructure Layer

- [ ] `IConfigurationProvider.cs` updated with GetSecretRoomTemplates()
- [ ] `JsonConfigurationProvider.cs` updated to load secret templates

### Configuration Files

- [ ] `config/secrets.json` created with 5 template definitions
- [ ] `config/schemas/secrets.schema.json` created

### Testing

- [ ] `SecretRoomTemplateTests.cs` created (~5 tests)
- [ ] `HiddenPassageTests.cs` created (~4 tests)
- [ ] `SecretPlacementRulesTests.cs` created (~3 tests)
- [ ] `SecretPlacementServiceTests.cs` created (~6 tests)
- [ ] `SecretConfigurationTests.cs` created (~2 tests)
- [ ] All ~20 tests passing

### Documentation

- [ ] XML documentation on all public members
- [ ] Code follows .editorconfig conventions

---

## 15. Acceptance Criteria

### Functional

- [ ] SecretRoomTemplate loads from `secrets.json` configuration
- [ ] SecretRoomTemplate.IsValidFor correctly filters by depth (min and max)
- [ ] SecretRoomTemplate.GetScaledDC returns BaseDiscoveryDC + (depth/2)
- [ ] SecretRoomTemplate.GetAdjustedProbability applies biome bonus (×1.5)
- [ ] SecretRoomTemplate.GetAdjustedProbability applies style bonus (×1.3)
- [ ] SecretRoomTemplate.GetAdjustedProbability caps probability at 1.0
- [ ] HiddenPassage.Create correctly sets all properties
- [ ] HiddenPassage.GetReverseDirection returns opposite direction
- [ ] SecretPlacementRules.CalculateProbability applies correct multipliers
- [ ] SecretPlacementService.GenerateSecrets filters templates by depth
- [ ] SecretPlacementService.GenerateSecrets respects MaxSecretsPerLevel
- [ ] SecretPlacementService.GenerateSecrets skips RoomType.Secret rooms
- [ ] SecretPlacementService finds available directions for passages
- [ ] SecretPlacementService generates descriptions from templates
- [ ] SecretPlacementService assigns scaled discovery DC
- [ ] Hints are correctly assigned from template DiscoveryHints

### Quality

- [ ] Build succeeds with 0 errors/warnings
- [ ] All ~20 unit tests pass
- [ ] Configuration files validate against schemas
- [ ] XML documentation complete on public members
- [ ] Code follows .editorconfig conventions
- [ ] No hardcoded secret data outside configuration

---

## 16. Dependencies

### 16.1 Prerequisites (v0.1.5a)

| Component | Purpose for v0.1.5b |
|-----------|---------------------|
| `Room` entity | Source rooms for secret placement |
| `RoomType` enum | Includes RoomType.Secret |
| `Direction` enum | For hidden passage direction |
| `BiomeDefinition` | Biome ID for preference matching |
| `ArchitecturalStyle` | Style ID for preference matching |
| `IConfigurationProvider` | Pattern for loading templates |
| `ISeededRandomService` | Reproducible random for placement |
| `IDefinition` interface | Implemented by SecretRoomTemplate |
| `IEntity` interface | Implemented by HiddenPassage |

### 16.2 Provides to Future Phases

| Component | Used By |
|-----------|---------|
| `SecretRoomTemplate` | v0.1.5c (TrapPlacementService checks CanContainTraps) |
| `HiddenPassage` | v0.1.5c (trap placement in passages), v0.4.0 (discovery) |
| `SecretPlacementService` | v0.1.5d (VaultGenerationService) |
| `ISecretPlacementService` | v0.1.5d, v0.4.0 |
| `SecretPlacementContext` | Pattern reused by v0.1.5c, v0.1.5d |
| `SecretPlacementResult` | Pattern reused by v0.1.5c, v0.1.5d |

### 16.3 Dependency Diagram

```
v0.1.5a (Puzzle Placement System)
    │
    ├── PuzzleTemplate ──────────────────────────────────────────────┐
    ├── PuzzleInstance ──────────────────────────────────────────────┤
    ├── IPuzzlePlacementService ─────────────────────────────────────┤
    ├── Room entity ─────────────────────────────────────────────────┤
    ├── RoomType enum ───────────────────────────────────────────────┤
    ├── Direction enum ──────────────────────────────────────────────┤
    ├── IConfigurationProvider ──────────────────────────────────────┤
    └── ISeededRandomService ────────────────────────────────────────┘
                                                                     │
                                                                     ▼
v0.1.5b (Secret Room Generation)
    │
    ├── SecretRoomTemplate ──────────────────────────────────────────┐
    ├── HiddenPassage ───────────────────────────────────────────────┤
    ├── SecretPlacementRules ────────────────────────────────────────┤
    ├── SecretPlacementContext ──────────────────────────────────────┤
    ├── SecretPlacementResult ───────────────────────────────────────┤
    └── ISecretPlacementService ─────────────────────────────────────┘
                                                                     │
                    ┌────────────────────────────────────────────────┤
                    │                                                │
                    ▼                                                ▼
        v0.1.5c (Trap Placement System)              v0.1.5d (Treasure Vault Generation)
            │                                                │
            │   Uses:                                        │   Uses:
            │   - SecretRoomTemplate.CanContainTraps         │   - SecretRoomTemplate.CanContainGuardian
            │   - HiddenPassage (trap placement)             │   - SecretPlacementService pattern
            │                                                │
            └────────────────────┬───────────────────────────┘
                                 │
                                 ▼
        v0.4.0 (Interactive Environment & Puzzles)
            │
            └── Implements: search command, perception checks,
                discovery state tracking, reveal mechanics,
                hint triggers
```

---

## 17. Future Considerations

### 17.1 Deferred to v0.1.5c

- **TrapDefinition** — Trap type configurations
- **TrapInstance** — Placed trap configuration
- **TrapPlacementService** — Trap placement logic (uses SecretRoomTemplate.CanContainTraps)

### 17.2 Deferred to v0.1.5d

- **TreasureRoomTemplate** — Vault designs
- **GuardianAssignment** — Guardian configuration (uses SecretRoomTemplate.CanContainGuardian)
- **VaultGenerationService** — Integration with SecretPlacementService

### 17.3 Deferred to v0.4.0 (Interaction)

- **Search command** — Player-facing secret searching
- **Perception checks** — Skill checks against DiscoveryDC
- **Discovery state tracking** — Remembering which secrets are discovered
- **Reveal mechanics** — Transition from hidden to revealed state
- **Hint display logic** — When and how hints appear to players
- **Passage navigation** — Moving through discovered hidden passages

### 17.4 Out of Scope (Future Versions)

- **Multi-room secrets** — Secret areas spanning multiple rooms
- **Timed secrets** — Secrets that only appear at certain times
- **Conditional secrets** — Secrets requiring specific items to discover
- **Secret chains** — Secrets leading to other secrets
- **Dynamic hint generation** — Hints based on player skills

---

*Document Version: 1.0*
*Last Updated: 2026-01-09*
*Author: Claude*
