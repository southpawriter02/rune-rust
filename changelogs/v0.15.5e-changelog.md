# v0.15.5e Changelog - Hazard Detection System

## Summary

Implements the **Hazard Detection System** for the Wasteland Survival skill. This subsystem allows characters to detect and identify environmental hazards through passive perception (automatic hints for high-WITS characters) or active investigation (formal skill checks). Features 5 hazard types with DCs from 8-20, passive detection using WITS ÷ 2, active investigation with critical success at net ≥ 5, Glitch Effect Table for Glitch Pocket hazards, and comprehensive consequence application including damage, status effects, and combat triggers.

## Added

### Domain Layer - Enums (2 files)

| File | Description |
|------|-------------|
| `DetectableHazardType.cs` | 5-value enum for detectable hazards: ObviousDanger (DC 8), HiddenPit (DC 12), ToxicZone (DC 16), AmbushSite (DC 16), GlitchPocket (DC 20). Extension methods: `GetDetectionDc()`, `GetDisplayName()`, `GetDescription()`, `GetConsequenceDescription()`, `GetDamageDice()`, `DealsImmediateDamage()`, `AppliesStatusEffect()`, `MayTriggerCombat()`, `HasUnpredictableEffects()`, `MayRequireAssistance()`, `GetStatusEffectName()`, `GetStatusEffectDuration()`. |
| `DetectionMethod.cs` | 4-value enum for detection methods: None, PassivePerception, ActiveInvestigation, AreaSweep. Extension methods: `GetDisplayName()`, `GetDescription()`, `RequiresDiceRoll()`, `IsAutomatic()`, `RevealsHazardType()`, `ProvidesHintOnly()`, `CanDetectMultipleHazards()`, `WasSuccessful()`. |

### Domain Layer - Value Objects (2 files)

| File | Description |
|------|-------------|
| `HazardDetectionResult.cs` | `readonly record struct` for detection outcomes. Properties: HazardDetected, HazardType, AvoidanceOptions, ConsequenceIfMissed, DetectionMethod, NetSuccesses, TargetDc, RollDetails. Computed: FullyIdentified, IsCritical, IsHintOnly, HasAwareness, Margin. Factory methods: `PassiveHint()`, `ActiveSuccess()`, `AreaSweepSuccess()`, `NotDetected()`, `Empty()`. Methods: `ToDisplayString()`, `ToDetailedString()`. |
| `HazardTriggerResult.cs` | `readonly record struct` for trigger consequences. Properties: HazardType, DamageDealt, DamageType, StatusApplied, StatusDuration, SpecialEffect, RequiresAssistance, TriggersSurpriseRound, GlitchEffectRoll, RollDetails. Computed: DealtDamage, AppliedStatus, HasSpecialEffect, TriggersCombat, IsGlitchEffect, Severity, SeverityLabel. Factory methods: `ObviousDanger()`, `HiddenPit()`, `ToxicZone()`, `GlitchPocket()`, `AmbushSite()`, `Empty()`. Static helpers: `GetGlitchEffectDescription()`, `GetGlitchEffectName()`, `GlitchEffectCausesDamage()`. |

### Application Layer - Interface (1 file)

| File | Description |
|------|-------------|
| `IHazardDetectionService.cs` | Service interface with methods: `CheckPassiveDetection()`, `GetPassivePerception()`, `InvestigateArea()`, `InvestigateSpecific()`, `GetDetectionDc()`, `GetHazardDescription()`, `GetHazardConsequence()`, `GetAvoidanceOptions()`, `ApplyHazardConsequence()`, `RollGlitchEffect()`, `GetGlitchEffectDescription()`, `CanInvestigate()`, `GetInvestigationBlockedReason()`. Full XML documentation with examples. |

### Application Layer - Service (1 file)

| File | Description |
|------|-------------|
| `HazardDetectionService.cs` | Full implementation of IHazardDetectionService. Dependencies: SkillCheckService, DiceService, ILogger. Constants for hazard DCs (8-20), damage dice (1d6, 2d10), status durations (Poisoned 3 rounds, Disoriented 2 rounds), critical threshold (5), passive perception divisor (2). Implements passive detection (WITS ÷ 2), active investigation, area sweep, consequence application, and Glitch Effect Table. Comprehensive logging at Information, Debug, and Warning levels. |

### Configuration (2 files)

| File | Description |
|------|-------------|
| `config/hazard-types.json` | Configuration for hazard types (DCs, consequences, avoidance options), Glitch Effect Table (6 entries), detection methods (passive formula, active skill), critical detection threshold, status effects (Poisoned, Disoriented), and balance notes. |
| `config/schemas/hazard-types.schema.json` | JSON Schema 2020-12 for hazard-types.json validation. Defines hazardTypeDefinition, hazardConsequenceDefinition, hazardCharacteristicsDefinition, glitchEffectDefinition, detectionMethodDefinition, criticalDetectionDefinition, statusEffectDefinition. |

### Unit Tests (1 file, 50+ tests)

| File | Tests |
|------|-------|
| `HazardDetectionServiceTests.cs` | Hazard DC tests (5 parameterized cases), Hazard description tests (3 types), Hazard consequence tests (5 types), Passive perception tests (5 cases: calculation, various WITS values, detection within range, high WITS, low WITS), Avoidance options tests (5 cases), Glitch Effect Table tests (7 cases), Investigation prerequisite tests (2 cases), HazardDetectionResult tests (8 cases), HazardTriggerResult tests (11 cases), DetectableHazardType extension tests (6 cases), DetectionMethod extension tests (8 cases). |

## Key Features

### Hazard Types

| Hazard | DC | Damage | Status | Special |
|--------|----|---------|---------|---------
| Obvious Danger | 8 | 1d6 Physical | None | None |
| Hidden Pit | 12 | 2d10 Physical | None | May require assistance |
| Toxic Zone | 16 | None | Poisoned (3 rounds) | 1d6/round, DC 14 END save |
| Glitch Pocket | 20 | Varies | Disoriented (2 rounds) | Glitch Effect Table |
| Ambush Site | 16 | None | None | Enemies gain surprise round |

### Detection Methods

| Method | Trigger | Reveals Type | Dice Roll |
|--------|---------|--------------|-----------|
| Passive Perception | Automatic | No (hint only) | No (WITS ÷ 2) |
| Active Investigation | `investigate` command | Yes | Yes |
| Area Sweep | `investigate area`/`sweep` | Yes | Yes (per hazard) |

### Detection Outcomes

| Outcome | Condition | Information Revealed |
|---------|-----------|---------------------|
| Passive Hint | WITS ÷ 2 >= DC | Vague sense of danger |
| Active Success | Net successes >= DC | Hazard type, avoidance options, consequence |
| Critical Success | Net successes >= 5 | Additional context on disabling/exploiting |
| Failure | Net successes < DC | No information |

### Glitch Effect Table (d6)

| Roll | Effect | Consequence |
|------|--------|-------------|
| 1 | Teleport | Move 2d6 rooms in random direction |
| 2 | Psychic Feedback | Take 2d10 psychic damage |
| 3 | Equipment Malfunction | Random item disabled until repaired |
| 4 | Time Skip | Lose 1d4 hours |
| 5 | Memory Echo | Vivid flashback (narrative) |
| 6 | Reality Anchor | Cannot leave room for 1d6 rounds |

### Status Effects

| Effect | Duration | Trigger | Recovery |
|--------|----------|---------|----------|
| Poisoned | 3 rounds | Toxic Zone | DC 14 ENDURANCE save (end of turn) or Antidote |
| Disoriented | 2 rounds | Glitch Pocket | Automatic after duration |

## Files Changed

### Added (10 files)
- `src/Core/RuneAndRust.Domain/Enums/DetectableHazardType.cs`
- `src/Core/RuneAndRust.Domain/Enums/DetectionMethod.cs`
- `src/Core/RuneAndRust.Domain/ValueObjects/HazardDetectionResult.cs`
- `src/Core/RuneAndRust.Domain/ValueObjects/HazardTriggerResult.cs`
- `src/Core/RuneAndRust.Application/Interfaces/IHazardDetectionService.cs`
- `src/Core/RuneAndRust.Application/Services/HazardDetectionService.cs`
- `config/hazard-types.json`
- `config/schemas/hazard-types.schema.json`
- `tests/RuneAndRust.Application.UnitTests/Services/HazardDetectionServiceTests.cs`
- `changelogs/v0.15.5e-changelog.md`

## Dependencies

- `SkillCheckService.cs` - For performing Wasteland Survival investigation checks
- `DiceService.cs` - For rolling damage dice and Glitch Effect Table
- `Player.cs` entity - For player identification and WITS attribute access
- `ILogger<HazardDetectionService>` - For comprehensive logging

## Integration Points

- **SkillCheckService**: Uses `PerformCheckWithDC()` for active investigation checks
- **DiceService**: Uses `RollTotal()` for damage rolls and Glitch Effect Table
- **Player.Attributes.Wits**: Used for passive perception calculation (WITS ÷ 2)

## Notes

- Created `DetectableHazardType` enum to avoid collision with existing `HazardType` enum (used for combat hazards)
- Passive detection provides awareness but does NOT reveal hazard type (hint only)
- Active detection reveals full information including avoidance options
- Critical detection (net >= 5) provides additional context for exploiting hazards
- Glitch Pocket always applies [Disoriented] in addition to Glitch Effect Table roll
- Glitch Effect roll of 2 is the only effect that deals immediate damage
- AmbushSite is unique in triggering combat with surprise round
- Status effect durations: Poisoned = 3 rounds, Disoriented = 2 rounds
- This builds upon v0.15.5d (Navigation System) and provides foundation for v0.15.5f (Shelter Assessment)
