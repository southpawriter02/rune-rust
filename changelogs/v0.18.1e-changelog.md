# Changelog: v0.18.1e - Configuration & Persistence

**Release Date:** 2026-02-01
**Phase:** Runic Blight Corruption (5/5)
**Status:** Complete

---

## Overview

Implements the configuration infrastructure and persistence layer for the Runic Blight Corruption system — the final phase of v0.18.1. This includes JSON Schema validation for corruption source configuration, a production configuration file defining all corruption sources across four categories, EF Core entity type configurations for database persistence, an in-memory repository implementation, the `CorruptionHistoryEntry` domain entity for audit logging, and application-layer DTOs for configuration deserialization and API responses.

This phase establishes the **data-driven foundation** that allows game designers to define corruption costs without code changes, enables persistence of corruption tracker state and history across sessions, and provides comprehensive schema validation ensuring configuration integrity.

---

## Added

### Configuration Layer

- **`config/schemas/corruption-sources.schema.json`** — JSON Schema Draft-07 for corruption source configuration validation
    - Definitions: `CorruptionSourceDefinition`, `ThresholdEffect`, `PenaltyFormula`
    - Enforces kebab-case IDs via pattern `^[a-z][a-z0-9-]*$`
    - Validates corruption ranges: minCorruption 0-100, maxCorruption 1-100, corruptionPerHp 1-10
    - Requires all threshold levels (25, 50, 75, 100) and all penalty formulas (maxHpPercent, maxApPercent, resolveDice)
    - `additionalProperties: false` at all levels for strict validation

- **`config/corruption-sources.json`** — Production configuration with 11 corruption sources across 4 categories
    - `mysticMagic` (3 sources): standard-spell (0-2), powerful-spell (3-5), overcasting (10-15)
    - `hereticalAbility` (4 sources): berserker-rage (2-5), blot-priest-hp-cast (1/HP), blot-priest-siphon (fixed 1), seidkona-divination (3-8)
    - `environmental` (2 sources): blight-zone (1-3 per-exposure), forlorn-contact (5-10)
    - `items` (2 sources): glitched-artifact (1-5), corrupted-consumable (2-5)
    - Threshold effects at 25 (UI warning), 50 (faction lock), 75 (machine-affinity trauma), 100 (terminal error)
    - Three penalty formulas: HP/AP percent and Resolve dice

### Domain Layer

- **`CorruptionHistoryEntry`** (`Domain/Entities/CorruptionHistoryEntry.cs`)
    - Box comment header with `═══` separators (Version: 0.18.1e)
    - Class implementing `IEntity` with private setters, private parameterless EF Core constructor
    - Properties: Id, CharacterId, Amount, Source (CorruptionSource), NewTotal, ThresholdCrossed (int?), IsTransfer, TransferTargetId (Guid?), CreatedAt
    - Factory methods:
        - `Create(characterId, amount, source, newTotal, thresholdCrossed, isTransfer, transferTargetId)` — general-purpose factory
        - `FromAddResult(characterId, CorruptionAddResult)` — convenience factory from AddCorruption result
    - Comprehensive XML documentation with `<summary>`, `<remarks>`, `<param>`, `<returns>`, `<example>`, `<seealso>`
    - `ToString()` override for debugging

### Application Layer — DTOs

- **`CorruptionSourceDefinitionDto`** (`Application/DTOs/CorruptionSourceDefinitionDto.cs`)
    - Sealed record with `[JsonPropertyName]` attributes
    - Properties: Id (required), Name (required), MinCorruption?, MaxCorruption?, FixedCorruption?, CorruptionPerHp?, PerExposure (bool)

- **`ThresholdEffectDto`** (`Application/DTOs/ThresholdEffectDto.cs`)
    - Sealed record with `[JsonPropertyName]` attributes
    - Properties: Description (required), UiWarning (bool), FactionLock (bool), TraumaId (string?), TerminalError (bool)

- **`CorruptionConfigurationDto`** (`Application/DTOs/CorruptionConfigurationDto.cs`)
    - Root DTO: `CorruptionConfigurationDto` with Version, CorruptionSources, ThresholdEffects (Dictionary<string, ThresholdEffectDto>), Penalties
    - `CorruptionSourceCategoriesDto`: MysticMagic[], HereticalAbility[], Environmental[], Items[]
    - `PenaltyFormulasDto`: MaxHpPercent, MaxApPercent, ResolveDice
    - `FormulaDto`: Formula string

- **`CorruptionHistoryEntryDto`** (`Application/DTOs/CorruptionHistoryEntryDto.cs`)
    - Sealed record mapping all CorruptionHistoryEntry properties with `[JsonPropertyName]` attributes

### Infrastructure Layer — EF Core Configurations

- **`CorruptionTrackerConfiguration`** (`Infrastructure/Persistence/Configurations/CorruptionTrackerConfiguration.cs`)
    - Maps `CorruptionTracker` to `CorruptionTrackers` database table
    - Guid PK with `ValueGeneratedNever()` (application-managed)
    - Unique index on CharacterId
    - Check constraint for corruption 0-100 range
    - Default values for threshold flags (false) and CurrentCorruption (0)
    - Cascade delete FK to Player entity
    - Ignores all computed properties: Stage, MaxHpPenaltyPercent, MaxApPenaltyPercent, ResolveDicePenalty, TechBonus, SocialPenalty, IsFactionLocked, IsTerminalError

- **`CorruptionHistoryEntryConfiguration`** (`Infrastructure/Persistence/Configurations/CorruptionHistoryEntryConfiguration.cs`)
    - Maps `CorruptionHistoryEntry` to `CorruptionHistory` database table
    - Guid PK with `ValueGeneratedNever()` (application-managed)
    - CorruptionSource enum stored as string (MaxLength 50)
    - Composite index on (CharacterId, CreatedAt) for efficient per-character history queries
    - Index on IsTransfer for efficient transfer event filtering
    - Cascade delete FK to Player entity

### Infrastructure Layer — Repository

- **`InMemoryCorruptionRepository`** (`Infrastructure/Repositories/InMemoryCorruptionRepository.cs`)
    - Thread-safe implementation using `ConcurrentDictionary<Guid, CorruptionTracker>` for trackers and `ConcurrentDictionary<Guid, List<CorruptionHistoryEntry>>` for history
    - Lock-based thread safety on history list write operations
    - Implements all 6 `ICorruptionRepository` methods (original 3 + 3 new)
    - Optional `ILogger` with `NullLogger` fallback
    - Comprehensive structured logging at Debug/Information levels

### Integration Tests

- **`CorruptionSourcesSchemaTests`** (`Infrastructure.IntegrationTests/Schemas/CorruptionSourcesSchemaTests.cs`) — 18 test methods across 11 sections

| Section | Test Count | Key Cases |
|---------|------------|-----------|
| CSS-001 | 1 | Schema loads and contains expected definitions (CorruptionSourceDefinition, ThresholdEffect, PenaltyFormula) |
| CSS-002 | 1 | Production corruption-sources.json passes validation |
| CSS-003 | 3 | Rejects minCorruption > 100, maxCorruption < 1, corruptionPerHp > 10 |
| CSS-004 | 2 | Rejects uppercase IDs, number-start IDs |
| CSS-005 | 2 | Rejects missing version, missing corruptionSources |
| CSS-006 | 2 | Rejects missing thresholdEffects, missing threshold 100 key |
| CSS-007 | 1 | Rejects invalid version format (1.0.0 → not MAJOR.MINOR) |
| CSS-008 | 2 | Rejects unknown root properties, unknown source properties |
| CSS-009 | 2 | Rejects missing penalties section, missing resolveDice formula |
| CSS-010 | 1 | DTO deserialization: verifies category counts, thresholds, formulas |
| CSS-011 | 1 | Individual source property spot-checks (standard-spell, blot-priest, blight-zone) |

### Glossary

- **`config/glossary.json`** — Added 4 glossary entries (sortOrder 101-104)
    - `corruption-history-entry`: Domain entity for corruption change audit records
    - `corruption-configuration`: Root DTO for corruption-sources.json deserialization
    - `corruption-sources-schema`: JSON Schema for corruption source configuration validation
    - `in-memory-corruption-repository`: Thread-safe in-memory ICorruptionRepository implementation

---

## Changed

### Application Layer — Repository Interface

- **`ICorruptionRepository`** (`Application/Interfaces/ICorruptionRepository.cs`) — Extended with 3 new async methods
    - Version bumped from 0.18.1d to 0.18.1e
    - `DeleteAsync(Guid characterId, CancellationToken ct)` — removes tracker and associated data
    - `AddHistoryEntryAsync(CorruptionHistoryEntry entry, CancellationToken ct)` — persists audit record
    - `GetHistoryAsync(Guid characterId, int? limit, CancellationToken ct)` — retrieves history entries ordered by newest first

### Documentation

- **`docs/design/v0.18.x/v0.18.1-scope-breakdown.md`** — Checked off v0.18.1e acceptance criteria
- **`docs/design/v0.18.x/v0.18.1e-design-specification.md`** — Checked off all deliverable and acceptance criteria items

---

## Design Decisions

### NJsonSchema Instead of Newtonsoft.Json.Schema

The design specification's test code uses `Newtonsoft.Json.Schema` (`JSchema`, `JObject.IsValid`). The codebase uses **NJsonSchema** (`JsonSchema.FromFileAsync`, `schema.Validate`). All schema validation tests follow the `StressSourcesSchemaTests` pattern using NJsonSchema for consistency.

### IntegrationTests Instead of UnitTests

The design specification places schema tests in `RuneAndRust.Infrastructure.UnitTests`. The codebase's existing schema tests live in `RuneAndRust.Infrastructure.IntegrationTests/Schemas/`. Tests are placed in the correct existing project.

### InMemoryCorruptionRepository Instead of EF Core Repository

The design specification specifies an EF Core `CorruptionRepository` as the primary implementation. The codebase pattern uses in-memory repositories (`InMemoryStressHistoryRepository`) as the primary implementation with EF Core configurations for database mapping. Both are created: `InMemoryCorruptionRepository` for runtime use and EF Core configurations for database schema.

### Async Repository Methods (Extended Existing Interface)

The design specification defines 6 sync methods on `ICorruptionRepository`. The existing v0.18.1d interface already has 3 async methods. Rather than replacing the interface, 3 new async methods were added: `DeleteAsync`, `AddHistoryEntryAsync`, and `GetHistoryAsync`.

### Sealed Record DTOs with [JsonPropertyName]

The design specification uses plain `record` types without serialization attributes. The codebase convention uses `sealed record` types with `[JsonPropertyName]` attributes for explicit JSON property name mapping, matching `StressConfigurationDto` and related types.

### CorruptionHistoryEntry as Domain Entity (Not VO)

The design specification classifies `CorruptionHistoryEntry` as a value object. Following the `StressHistoryEntry` pattern, it is implemented as a domain entity implementing `IEntity` with a Guid primary key, private setters, and factory methods — consistent with the persistence requirements.

### Two EF Core Configurations (Tracker + History)

The design specification mentions a single database migration. The implementation provides two separate `IEntityTypeConfiguration` classes — one for `CorruptionTracker` and one for `CorruptionHistoryEntry` — following the codebase pattern of separate configuration files per entity.

### Test Count Exceeds Estimate

The design specification estimated ~3 tests for v0.18.1e. The implementation includes 18 test methods across 11 sections covering schema validation, rejection of invalid configs, DTO deserialization verification, and individual source property spot-checks.

---

## Files Created

| Path | Description |
|------|-------------|
| `config/schemas/corruption-sources.schema.json` | JSON Schema Draft-07 for corruption source configuration |
| `config/corruption-sources.json` | Production config with 11 sources across 4 categories |
| `src/Core/RuneAndRust.Domain/Entities/CorruptionHistoryEntry.cs` | Domain entity for corruption history audit records |
| `src/Core/RuneAndRust.Application/DTOs/CorruptionSourceDefinitionDto.cs` | DTO for individual corruption source definitions |
| `src/Core/RuneAndRust.Application/DTOs/ThresholdEffectDto.cs` | DTO for threshold effect configuration |
| `src/Core/RuneAndRust.Application/DTOs/CorruptionConfigurationDto.cs` | Root DTO with nested types for full config deserialization |
| `src/Core/RuneAndRust.Application/DTOs/CorruptionHistoryEntryDto.cs` | DTO for corruption history entries (API responses) |
| `src/Infrastructure/RuneAndRust.Infrastructure/Repositories/InMemoryCorruptionRepository.cs` | Thread-safe in-memory ICorruptionRepository implementation |
| `src/Infrastructure/RuneAndRust.Infrastructure/Persistence/Configurations/CorruptionTrackerConfiguration.cs` | EF Core config for CorruptionTracker entity |
| `src/Infrastructure/RuneAndRust.Infrastructure/Persistence/Configurations/CorruptionHistoryEntryConfiguration.cs` | EF Core config for CorruptionHistoryEntry entity |
| `tests/RuneAndRust.Infrastructure.IntegrationTests/Schemas/CorruptionSourcesSchemaTests.cs` | Schema validation tests (18 methods) |
| `changelogs/v0.18.1e-changelog.md` | This changelog |

## Files Modified

| Path | Description |
|------|-------------|
| `src/Core/RuneAndRust.Application/Interfaces/ICorruptionRepository.cs` | Extended with 3 new async methods (Delete, AddHistory, GetHistory) |
| `config/glossary.json` | Added 4 glossary entries (sortOrder 101-104) |
| `docs/design/v0.18.x/v0.18.1-scope-breakdown.md` | Checked off v0.18.1e acceptance criteria |
| `docs/design/v0.18.x/v0.18.1e-design-specification.md` | Checked off all deliverable and acceptance criteria items |

---

## Notes

- Total tests for v0.18.1e: 18 test methods across 1 test file (far exceeding the ~3 estimate due to comprehensive schema validation and rejection coverage)
- All 18 new tests pass; all existing tests unaffected (0 regressions)
- Build succeeds with 0 errors, 0 warnings
- All new files follow established codebase patterns: `═══════` box comment headers and section separators, file-scoped namespaces, comprehensive XML documentation with `<summary>`, `<remarks>`, `<para>`, `<list>`, `<example>`, `<seealso>`, and `<value>` tags
- Pre-existing glossary schema validation failure at term #88 remains (unrelated to v0.18.1e changes)
- This completes v0.18.1 (Runic Blight Corruption) — all 5 sub-phases (a through e) are now implemented
- Key design spec deviations documented: NJsonSchema (not Newtonsoft), IntegrationTests (not UnitTests), InMemory repository (not EF Core as primary), async extension (not sync replacement), sealed record DTOs (not plain records), entity (not VO) for history entries
