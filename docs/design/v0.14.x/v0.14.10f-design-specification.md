# v0.14.10f Design Specification: Combat Stance Schema

## Document Information

| Field | Value |
|-------|-------|
| **Version** | v0.14.10f |
| **Feature** | Combat Stance Schema |
| **Status** | Draft |
| **Created** | 2026-01-17 |
| **Depends On** | v0.14.1 (Combat Schema), abilities.schema.json |
| **Provides To** | v0.15.x (Stance System), Combat AI, Combat UI |

---

## 1. Executive Summary

### 1.1 Overview

This specification defines the Combat Stance Schema for configuring combat stance definitions in Aethelgard. The schema enables definition of stance configurations including stat modifiers, ability restrictions/grants, switching rules, AI behavior patterns, and visual/audio feedback references.

The schema enables:
- **Stance Identity**: Name, description, icon, and visual styling
- **Stat Modifiers**: Bonuses and penalties to combat statistics
- **Ability Management**: Restrictions and grants per stance
- **Switching Rules**: Action costs, cooldowns, and conditions for stance changes
- **AI Behavior**: When and how AI-controlled entities use stances
- **Feedback References**: Visual and audio effect links

### 1.2 Deliverables

| Deliverable | Layer | Description |
|-------------|-------|-------------|
| `stances.schema.json` | Configuration | JSON Schema Draft-07 validation schema |
| `stances.json` | Configuration | Stance definitions |
| `CombatStance` | Schema Definition | Core stance configuration |
| `StatModifier` | Schema Definition | Stat bonus/penalty with type |
| `AbilityRestriction` | Schema Definition | Ability limitation rules |
| `SwitchingRule` | Schema Definition | Stance transition configuration |
| `AIBehavior` | Schema Definition | AI decision-making patterns |
| ~6 Unit Tests | Testing | Schema validation and loading tests |

### 1.3 Architectural Significance

The Combat Stance Schema integrates with the combat system:

```
┌─────────────────────────────────────────────────────────────────────────┐
│                    COMBAT STANCE SCHEMA INTEGRATION                      │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                          │
│  ┌──────────────────┐     ┌──────────────────┐     ┌─────────────────┐  │
│  │   Combat UI      │     │   Stance Schema  │     │   Combat AI     │  │
│  │                  │────▶│   (v0.14.10f)    │◀────│                 │  │
│  │  Stance selector │     │                  │     │  Stance choice  │  │
│  │  Stat display    │     │  - CombatStance  │     │  Priority eval  │  │
│  │  Ability buttons │     │  - StatModifiers │     │  Condition match│  │
│  └──────────────────┘     │  - Restrictions  │     └─────────────────┘  │
│                           │  - SwitchingRule │                          │
│  ┌──────────────────┐     │  - AIBehavior    │     ┌─────────────────┐  │
│  │  Ability System  │────▶│                  │◀────│  Combat System  │  │
│  │                  │     └────────┬─────────┘     │                 │  │
│  │  Grant/restrict  │              │               │  Stat calc      │  │
│  │  ability access  │              │               │  Turn order     │  │
│  └──────────────────┘              │               └─────────────────┘  │
│                           ┌────────▼─────────┐                          │
│                           │  Effect System   │                          │
│                           │                  │                          │
│                           │  Visual/Audio    │                          │
│                           │  feedback        │                          │
│                           └──────────────────┘                          │
│                                                                          │
└─────────────────────────────────────────────────────────────────────────┘
```

---

## 2. Feature Overview

```
v0.14.10f Combat Stance Schema
├── Schema Definitions
│   ├── CombatStance
│   │   ├── id (kebab-case identifier)
│   │   ├── name (display name)
│   │   ├── description (stance explanation)
│   │   ├── iconId (UI icon reference)
│   │   ├── color (UI highlight color)
│   │   ├── statModifiers[] (stat changes)
│   │   ├── abilityRestrictions[] (disabled abilities)
│   │   ├── abilityGrants[] (enabled abilities)
│   │   ├── switchingRule (transition config)
│   │   ├── incompatibleStances[] (mutual exclusions)
│   │   ├── aiBehavior (AI decision rules)
│   │   ├── visualEffectId (stance visual)
│   │   ├── soundEffectId (stance audio)
│   │   ├── isDefault (starting stance)
│   │   ├── requiresUnlock (progression gate)
│   │   └── tags[] (searchable tags)
│   │
│   ├── StatModifier
│   │   ├── stat (8 modifiable stats)
│   │   ├── value (positive or negative)
│   │   ├── type (flat or percentage)
│   │   └── description (tooltip text)
│   │
│   ├── AbilityRestriction
│   │   ├── type (Category, Specific, Tag)
│   │   ├── target (ability ID, category, or tag)
│   │   └── description (restriction reason)
│   │
│   ├── SwitchingRule
│   │   ├── actionCost (4 action types)
│   │   ├── cooldown (turns between switches)
│   │   ├── conditions[] (switch requirements)
│   │   ├── canSwitchDuringEnemyTurn
│   │   └── triggerEffects[] (on-switch effects)
│   │
│   └── AIBehavior
│       ├── priority (stance preference)
│       ├── useWhen[] (activation conditions)
│       ├── avoidWhen[] (avoid conditions)
│       └── stickiness (change resistance)
│
├── Configuration Files
│   ├── stances.schema.json (validation schema)
│   └── stances.json (stance definitions)
│
└── Unit Tests (~6 tests)
    ├── STN-001: Valid schema loads successfully
    ├── STN-002: Invalid stance ID rejected
    ├── STN-003: Stat modifier validation
    ├── STN-004: Switching rule validation
    ├── STN-005: AI behavior validation
    └── STN-006: Default stance requirement
```

---

## 3. Architecture Diagrams

### 3.1 Stance Data Structure

```
┌─────────────────────────────────────────────────────────────────────────┐
│                        STANCE SCHEMA STRUCTURE                           │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                          │
│  stances.json                                                            │
│  ┌───────────────────────────────────────────────────────────────────┐  │
│  │                                                                    │  │
│  │  defaultStance: "balanced"                                        │  │
│  │                                                                    │  │
│  │  stances[]                                                        │  │
│  │  ┌─────────────────────────────────────────────────────────────┐  │  │
│  │  │ CombatStance                                                 │  │  │
│  │  │                                                              │  │  │
│  │  │ ├─ id: "balanced"                                            │  │  │
│  │  │ ├─ name: "Balanced"                                          │  │  │
│  │  │ ├─ isDefault: true                                           │  │  │
│  │  │ ├─ statModifiers: []  (no modifiers)                         │  │  │
│  │  │ └─ switchingRule: { actionCost: "Free", ... }                │  │  │
│  │  └─────────────────────────────────────────────────────────────┘  │  │
│  │                                                                    │  │
│  │  ┌─────────────────────────────────────────────────────────────┐  │  │
│  │  │ CombatStance                                                 │  │  │
│  │  │                                                              │  │  │
│  │  │ ├─ id: "aggressive"                                          │  │  │
│  │  │ ├─ name: "Aggressive"                                        │  │  │
│  │  │ ├─ statModifiers:                                            │  │  │
│  │  │ │   ├─ { stat: "attack", value: 20, type: "percentage" }     │  │  │
│  │  │ │   └─ { stat: "defense", value: -20, type: "percentage" }   │  │  │
│  │  │ ├─ abilityGrants: ["power-attack"]                           │  │  │
│  │  │ ├─ incompatibleStances: ["defensive"]                        │  │  │
│  │  │ └─ aiBehavior: { priority: 2, useWhen: [...] }               │  │  │
│  │  └─────────────────────────────────────────────────────────────┘  │  │
│  │                                                                    │  │
│  │  ... (6 standard stances)                                         │  │
│  │                                                                    │  │
│  └───────────────────────────────────────────────────────────────────┘  │
│                                                                          │
└─────────────────────────────────────────────────────────────────────────┘
```

### 3.2 Stance Switching Flow

```
┌─────────────────────────────────────────────────────────────────────────┐
│                        STANCE SWITCHING FLOW                             │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                          │
│  Player/AI Requests Stance Change                                        │
│         │                                                                │
│         ▼                                                                │
│  ┌──────────────────┐                                                   │
│  │ 1. Check         │  Is target stance incompatible with current?      │
│  │    Compatibility │  → If incompatible, deny switch                   │
│  └────────┬─────────┘                                                   │
│           │                                                              │
│           ▼                                                              │
│  ┌──────────────────┐                                                   │
│  │ 2. Check         │  Is switching on cooldown?                        │
│  │    Cooldown      │  → If on cooldown, deny switch                    │
│  └────────┬─────────┘                                                   │
│           │                                                              │
│           ▼                                                              │
│  ┌──────────────────┐    ┌─────────────────────────────────────────┐   │
│  │ 3. Check         │───▶│ SwitchingRule.conditions[]              │   │
│  │    Conditions    │    │                                         │   │
│  │                  │    │ Example conditions:                     │   │
│  │                  │    │ - "HealthAbove": HP >= 50%              │   │
│  │                  │    │ - "NotStunned": No stun debuff          │   │
│  └────────┬─────────┘    │ - "InCombat": Combat is active          │   │
│           │              └─────────────────────────────────────────┘   │
│           ▼                                                              │
│  ┌──────────────────┐                                                   │
│  │ 4. Pay Action    │  Free / Swift / Standard / Full                   │
│  │    Cost          │  → Consume appropriate action                     │
│  └────────┬─────────┘                                                   │
│           │                                                              │
│           ▼                                                              │
│  ┌──────────────────┐                                                   │
│  │ 5. Apply Stance  │  • Remove old stat modifiers                      │
│  │                  │  • Apply new stat modifiers                       │
│  │                  │  • Update ability access                          │
│  │                  │  • Start cooldown timer                           │
│  └────────┬─────────┘                                                   │
│           │                                                              │
│           ▼                                                              │
│  ┌──────────────────┐                                                   │
│  │ 6. Trigger       │  • Play visual effect                             │
│  │    Effects       │  • Play sound effect                              │
│  │                  │  • Execute triggerEffects[]                       │
│  └──────────────────┘                                                   │
│                                                                          │
└─────────────────────────────────────────────────────────────────────────┘
```

### 3.3 Stat Modifier Application

```
┌─────────────────────────────────────────────────────────────────────────┐
│                      STAT MODIFIER APPLICATION                           │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                          │
│  ┌─────────────────────────────────────────────────────────────────┐    │
│  │                    MODIFIABLE STATS (8)                          │    │
│  │                                                                  │    │
│  │  ┌─────────────┐   ┌─────────────┐   ┌─────────────┐            │    │
│  │  │   Attack    │   │   Defense   │   │    Speed    │            │    │
│  │  │             │   │             │   │             │            │    │
│  │  │ Damage out  │   │ Damage in   │   │ Turn order  │            │    │
│  │  │ ±10-30%     │   │ ±10-30%     │   │ ±10-20%     │            │    │
│  │  └─────────────┘   └─────────────┘   └─────────────┘            │    │
│  │                                                                  │    │
│  │  ┌─────────────┐   ┌─────────────┐   ┌─────────────┐            │    │
│  │  │  Accuracy   │   │   Evasion   │   │ CritChance  │            │    │
│  │  │             │   │             │   │             │            │    │
│  │  │ Hit chance  │   │ Dodge rate  │   │ Crit rate   │            │    │
│  │  │ ±10-25%     │   │ ±10-25%     │   │ ±5-20%      │            │    │
│  │  └─────────────┘   └─────────────┘   └─────────────┘            │    │
│  │                                                                  │    │
│  │  ┌─────────────┐   ┌─────────────────────────────────────────┐  │    │
│  │  │ CritDamage  │   │            DamageReduction              │  │    │
│  │  │             │   │                                         │  │    │
│  │  │ Crit multi  │   │ Flat damage absorbed before reduction   │  │    │
│  │  │ ±10-50%     │   │ ±2 to ±10 (flat only)                   │  │    │
│  │  └─────────────┘   └─────────────────────────────────────────┘  │    │
│  │                                                                  │    │
│  └─────────────────────────────────────────────────────────────────┘    │
│                                                                          │
│  Modifier Types:                                                         │
│  ┌──────────────────────────────────────────────────────────────────┐   │
│  │  FLAT:        finalStat = baseStat + modifier                    │   │
│  │  PERCENTAGE:  finalStat = baseStat * (1 + modifier/100)          │   │
│  │                                                                   │   │
│  │  Application Order: Base → Flat → Percentage                     │   │
│  └──────────────────────────────────────────────────────────────────┘   │
│                                                                          │
└─────────────────────────────────────────────────────────────────────────┘
```

### 3.4 AI Behavior System

```
┌─────────────────────────────────────────────────────────────────────────┐
│                         AI BEHAVIOR SYSTEM                               │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                          │
│  AI Turn Start                                                           │
│         │                                                                │
│         ▼                                                                │
│  ┌──────────────────┐                                                   │
│  │ Evaluate Current │  Should we stay in current stance?                │
│  │ Stance Stickiness│  stickiness: 0.0-1.0                              │
│  └────────┬─────────┘  (higher = less likely to switch)                 │
│           │                                                              │
│           ▼                                                              │
│  ┌──────────────────┐                                                   │
│  │ Check All Stance │  For each available stance:                       │
│  │ Conditions       │                                                   │
│  └────────┬─────────┘                                                   │
│           │                                                              │
│           ▼                                                              │
│  ┌────────────────────────────────────────────────────────────────┐    │
│  │                    AI CONDITIONS (7)                            │    │
│  │                                                                 │    │
│  │  useWhen Conditions:                                            │    │
│  │  ┌────────────────────────────────────────────────────────────┐│    │
│  │  │ HealthBelow(50)  - HP < 50%    → switch to Defensive       ││    │
│  │  │ HealthAbove(80)  - HP > 80%    → can use Aggressive        ││    │
│  │  │ EnemyCount(3)    - 3+ enemies  → switch to Evasive         ││    │
│  │  │ AllyCount(2)     - 2+ allies   → can use Reckless          ││    │
│  │  │ StatusActive("burning") - On fire → switch to Defensive    ││    │
│  │  │ TargetWeak("fire") - Target vulnerable → use Aggressive    ││    │
│  │  │ OutNumbered       - enemies > allies → Defensive/Evasive   ││    │
│  │  └────────────────────────────────────────────────────────────┘│    │
│  │                                                                 │    │
│  │  avoidWhen Conditions:                                          │    │
│  │  ┌────────────────────────────────────────────────────────────┐│    │
│  │  │ HealthBelow(30)  - Don't use Reckless when low HP          ││    │
│  │  │ StatusActive("weakened") - Avoid Aggressive when debuffed  ││    │
│  │  └────────────────────────────────────────────────────────────┘│    │
│  │                                                                 │    │
│  └────────────────────────────────────────────────────────────────┘    │
│           │                                                              │
│           ▼                                                              │
│  ┌──────────────────┐                                                   │
│  │ Select Highest   │  Priority determines preference when              │
│  │ Priority Stance  │  multiple conditions are met                      │
│  └──────────────────┘                                                   │
│                                                                          │
└─────────────────────────────────────────────────────────────────────────┘
```

### 3.5 Configuration Layer Architecture

```
┌─────────────────────────────────────────────────────────────────────────┐
│                      CONFIGURATION LAYER PLACEMENT                       │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                          │
│  ┌───────────────────────────────────────────────────────────────────┐  │
│  │ PRESENTATION LAYER                                                 │  │
│  │                                                                    │  │
│  │  Combat UI ──────────────────────────────────────────────────────▶│  │
│  │    │ Displays current stance and available stances                │  │
│  │    │ Shows stat modifiers and ability access                      │  │
│  └────┼──────────────────────────────────────────────────────────────┘  │
│       │                                                                  │
│  ┌────▼──────────────────────────────────────────────────────────────┐  │
│  │ APPLICATION LAYER (v0.15.x - Future)                              │  │
│  │                                                                    │  │
│  │  IStanceService                                                    │  │
│  │    │ ├─ GetCurrentStance(entityId) → CombatStance                 │  │
│  │    │ ├─ SwitchStance(entityId, stanceId) → SwitchResult           │  │
│  │    │ ├─ GetAvailableStances(entityId) → CombatStance[]            │  │
│  │    │ ├─ CanSwitchTo(entityId, stanceId) → bool                    │  │
│  │    │ └─ GetStanceModifiers(stanceId) → StatModifier[]             │  │
│  │                                                                    │  │
│  │  ICombatAI                                                         │  │
│  │    │ └─ EvaluateStanceChoice(entityId) → string?                  │  │
│  └────┼──────────────────────────────────────────────────────────────┘  │
│       │                                                                  │
│  ┌────▼──────────────────────────────────────────────────────────────┐  │
│  │ INFRASTRUCTURE LAYER                                               │  │
│  │                                                                    │  │
│  │  StanceProvider (v0.15.x - Future)                                │  │
│  │    │ ├─ LoadFromJson(path)                                        │  │
│  │    │ ├─ ValidateAgainstSchema()                                   │  │
│  │    │ └─ GetStanceById(id) → CombatStance                          │  │
│  └────┼──────────────────────────────────────────────────────────────┘  │
│       │                                                                  │
│  ┌────▼──────────────────────────────────────────────────────────────┐  │
│  │ CONFIGURATION LAYER ◀─────────────────── v0.14.10f (This Version) │  │
│  │                                                                    │  │
│  │  stances.schema.json                                              │  │
│  │    │ JSON Schema Draft-07 validation                              │  │
│  │    │                                                              │  │
│  │  stances.json                                                     │  │
│  │    ├─ defaultStance ─── Default stance ID                         │  │
│  │    └─ stances[] ─────── CombatStance definitions                  │  │
│  └───────────────────────────────────────────────────────────────────┘  │
│                                                                          │
└─────────────────────────────────────────────────────────────────────────┘
```

---

## 4. Schema Root Definition

### 4.1 Root Object

The root object defines the stances configuration file structure.

```json
{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "stances.schema.json",
  "title": "Combat Stance Configuration Schema",
  "description": "Defines combat stance configurations including modifiers, abilities, and AI behavior",
  "type": "object",
  "required": ["version", "stances", "defaultStance"],
  "additionalProperties": false,
  "properties": {
    "$schema": {
      "type": "string",
      "description": "JSON Schema reference"
    },
    "version": {
      "type": "string",
      "pattern": "^\\d+\\.\\d+\\.\\d+$",
      "description": "Schema version (semver format)",
      "examples": ["1.0.0"]
    },
    "defaultStance": {
      "type": "string",
      "pattern": "^[a-z][a-z0-9-]*$",
      "description": "ID of the default starting stance"
    },
    "stances": {
      "type": "array",
      "description": "Combat stance definitions",
      "minItems": 1,
      "items": { "$ref": "#/definitions/CombatStance" }
    },
    "globalSwitchingRules": {
      "$ref": "#/definitions/SwitchingRule",
      "description": "Default switching rules applied to all stances"
    }
  }
}
```

### 4.2 Root Properties

| Property | Type | Required | Description |
|----------|------|----------|-------------|
| `version` | string | Yes | Schema version in semver format |
| `defaultStance` | string | Yes | ID of default starting stance |
| `stances` | array | Yes | Stance definitions (min 1) |
| `globalSwitchingRules` | object | No | Default switching rules |

---

## 5. CombatStance Definition

### 5.1 Stance Schema

```json
{
  "CombatStance": {
    "type": "object",
    "description": "A combat stance configuration",
    "required": ["id", "name", "description"],
    "additionalProperties": false,
    "properties": {
      "id": {
        "type": "string",
        "pattern": "^[a-z][a-z0-9-]*$",
        "description": "Unique stance identifier",
        "examples": ["balanced", "aggressive", "defensive"]
      },
      "name": {
        "type": "string",
        "minLength": 1,
        "maxLength": 30,
        "description": "Display name for the stance"
      },
      "description": {
        "type": "string",
        "minLength": 1,
        "maxLength": 200,
        "description": "Stance explanation for tooltips"
      },
      "iconId": {
        "type": "string",
        "description": "Icon asset reference for UI"
      },
      "color": {
        "type": "string",
        "pattern": "^#[0-9A-Fa-f]{6}$",
        "description": "UI highlight color"
      },
      "statModifiers": {
        "type": "array",
        "description": "Stat bonuses and penalties",
        "items": { "$ref": "#/definitions/StatModifier" }
      },
      "abilityRestrictions": {
        "type": "array",
        "description": "Abilities disabled in this stance",
        "items": { "$ref": "#/definitions/AbilityRestriction" }
      },
      "abilityGrants": {
        "type": "array",
        "description": "Ability IDs enabled by this stance",
        "items": {
          "type": "string",
          "pattern": "^[a-z][a-z0-9-]*$"
        }
      },
      "switchingRule": {
        "$ref": "#/definitions/SwitchingRule",
        "description": "Stance-specific switching configuration"
      },
      "incompatibleStances": {
        "type": "array",
        "description": "Stance IDs that cannot be active simultaneously",
        "items": {
          "type": "string",
          "pattern": "^[a-z][a-z0-9-]*$"
        }
      },
      "aiBehavior": {
        "$ref": "#/definitions/AIBehavior",
        "description": "AI decision-making configuration"
      },
      "visualEffectId": {
        "type": "string",
        "description": "Visual effect played when entering stance"
      },
      "soundEffectId": {
        "type": "string",
        "description": "Sound effect played when entering stance"
      },
      "isDefault": {
        "type": "boolean",
        "default": false,
        "description": "If true, this is a starting stance option"
      },
      "requiresUnlock": {
        "type": "boolean",
        "default": false,
        "description": "If true, stance must be unlocked before use"
      },
      "unlockCondition": {
        "$ref": "#/definitions/UnlockCondition",
        "description": "Condition for unlocking this stance"
      },
      "tags": {
        "type": "array",
        "description": "Searchable tags",
        "items": { "type": "string" }
      },
      "sortOrder": {
        "type": "integer",
        "default": 0,
        "description": "Display order in UI"
      }
    }
  }
}
```

### 5.2 Stance Properties Reference

| Property | Type | Required | Default | Description |
|----------|------|----------|---------|-------------|
| `id` | string | Yes | - | Unique identifier (kebab-case) |
| `name` | string | Yes | - | Display name (1-30 chars) |
| `description` | string | Yes | - | Tooltip explanation (1-200 chars) |
| `iconId` | string | No | - | Icon asset reference |
| `color` | string | No | - | UI highlight color (#RRGGBB) |
| `statModifiers` | array | No | - | Stat bonuses/penalties |
| `abilityRestrictions` | array | No | - | Disabled abilities |
| `abilityGrants` | array | No | - | Enabled ability IDs |
| `switchingRule` | object | No | - | Switching configuration |
| `incompatibleStances` | array | No | - | Mutually exclusive stances |
| `aiBehavior` | object | No | - | AI decision rules |
| `visualEffectId` | string | No | - | Visual effect on enter |
| `soundEffectId` | string | No | - | Sound effect on enter |
| `isDefault` | boolean | No | `false` | Starting stance option |
| `requiresUnlock` | boolean | No | `false` | Needs unlock |
| `unlockCondition` | object | No | - | Unlock requirements |
| `tags` | array | No | - | Searchable tags |
| `sortOrder` | integer | No | `0` | UI display order |

---

## 6. StatModifier Definition

### 6.1 Modifier Schema

```json
{
  "StatModifier": {
    "type": "object",
    "description": "A stat modification applied by a stance",
    "required": ["stat", "value", "type"],
    "additionalProperties": false,
    "properties": {
      "stat": {
        "type": "string",
        "enum": [
          "attack",
          "defense",
          "speed",
          "accuracy",
          "evasion",
          "criticalChance",
          "criticalDamage",
          "damageReduction"
        ],
        "description": "The stat to modify"
      },
      "value": {
        "type": "number",
        "description": "Modifier value (positive or negative)"
      },
      "type": {
        "type": "string",
        "enum": ["flat", "percentage"],
        "description": "How the modifier is applied"
      },
      "description": {
        "type": "string",
        "maxLength": 100,
        "description": "Optional tooltip description"
      }
    }
  }
}
```

### 6.2 Stat Reference

| Stat | Description | Typical Range | Type |
|------|-------------|---------------|------|
| `attack` | Damage dealt | ±10% to ±30% | percentage |
| `defense` | Damage resistance | ±10% to ±30% | percentage |
| `speed` | Turn order / movement | ±10% to ±20% | percentage |
| `accuracy` | Hit chance | ±10% to ±25% | percentage |
| `evasion` | Dodge chance | ±10% to ±25% | percentage |
| `criticalChance` | Crit probability | ±5% to ±20% | percentage |
| `criticalDamage` | Crit multiplier | ±10% to ±50% | percentage |
| `damageReduction` | Flat damage absorbed | ±2 to ±10 | flat |

### 6.3 Modifier Application Order

```
Final Stat = (Base Stat + Flat Modifiers) × (1 + Sum of Percentage Modifiers / 100)
```

Example:
- Base Attack: 100
- Flat modifier: +10
- Percentage modifier: +20%
- Final: (100 + 10) × 1.20 = 132

---

## 7. AbilityRestriction Definition

### 7.1 Restriction Schema

```json
{
  "AbilityRestriction": {
    "type": "object",
    "description": "A restriction on ability use within a stance",
    "required": ["type", "target"],
    "additionalProperties": false,
    "properties": {
      "type": {
        "type": "string",
        "enum": ["Category", "Specific", "Tag"],
        "description": "Type of restriction"
      },
      "target": {
        "type": "string",
        "description": "Ability category, ID, or tag to restrict"
      },
      "description": {
        "type": "string",
        "maxLength": 100,
        "description": "Reason for restriction (shown to player)"
      }
    }
  }
}
```

### 7.2 Restriction Types

| Type | Target | Description |
|------|--------|-------------|
| `Category` | Ability category name | Restricts all abilities in category |
| `Specific` | Ability ID | Restricts one specific ability |
| `Tag` | Ability tag | Restricts all abilities with tag |

### 7.3 Examples

```json
[
  {
    "type": "Category",
    "target": "defensive",
    "description": "Defensive abilities are disabled in aggressive stance"
  },
  {
    "type": "Specific",
    "target": "power-attack",
    "description": "Power Attack requires aggressive stance"
  },
  {
    "type": "Tag",
    "target": "heavy",
    "description": "Heavy attacks are too slow in evasive stance"
  }
]
```

---

## 8. SwitchingRule Definition

### 8.1 Switching Rule Schema

```json
{
  "SwitchingRule": {
    "type": "object",
    "description": "Configuration for stance switching",
    "required": ["actionCost"],
    "additionalProperties": false,
    "properties": {
      "actionCost": {
        "type": "string",
        "enum": ["Free", "Swift", "Standard", "Full"],
        "description": "Action required to switch to this stance"
      },
      "cooldown": {
        "type": "integer",
        "minimum": 0,
        "default": 0,
        "description": "Turns before can switch again"
      },
      "conditions": {
        "type": "array",
        "description": "Conditions required to switch",
        "items": { "$ref": "#/definitions/SwitchCondition" }
      },
      "canSwitchDuringEnemyTurn": {
        "type": "boolean",
        "default": false,
        "description": "If true, can switch as a reaction"
      },
      "triggerEffects": {
        "type": "array",
        "description": "Effects triggered when switching to this stance",
        "items": { "$ref": "#/definitions/TriggerEffect" }
      }
    }
  }
}
```

### 8.2 Action Cost Reference

| Action Cost | Description | Turn Impact |
|-------------|-------------|-------------|
| `Free` | No action required | No turn spent |
| `Swift` | Minor/bonus action | Uses bonus action |
| `Standard` | Main action | Uses main action |
| `Full` | Entire turn | Ends turn immediately |

### 8.3 SwitchCondition Schema

```json
{
  "SwitchCondition": {
    "type": "object",
    "description": "A condition required to switch stances",
    "required": ["type"],
    "additionalProperties": false,
    "properties": {
      "type": {
        "type": "string",
        "enum": [
          "HealthAbove",
          "HealthBelow",
          "HasStatus",
          "NotHasStatus",
          "InCombat",
          "OutOfCombat",
          "TurnNumber"
        ],
        "description": "Condition type"
      },
      "value": {
        "type": ["number", "string"],
        "description": "Condition parameter (percentage, status ID, etc.)"
      }
    }
  }
}
```

### 8.4 TriggerEffect Schema

```json
{
  "TriggerEffect": {
    "type": "object",
    "description": "An effect triggered when switching stances",
    "required": ["type"],
    "additionalProperties": false,
    "properties": {
      "type": {
        "type": "string",
        "enum": ["Heal", "Damage", "ApplyStatus", "RemoveStatus", "Buff", "Debuff"],
        "description": "Effect type"
      },
      "target": {
        "type": "string",
        "enum": ["Self", "NearbyAllies", "NearbyEnemies"],
        "default": "Self",
        "description": "Who is affected"
      },
      "value": {
        "type": ["number", "string"],
        "description": "Effect value or reference ID"
      },
      "duration": {
        "type": "integer",
        "minimum": 0,
        "description": "Duration in turns (for buffs/debuffs)"
      }
    }
  }
}
```

---

## 9. AIBehavior Definition

### 9.1 AI Behavior Schema

```json
{
  "AIBehavior": {
    "type": "object",
    "description": "AI decision-making configuration for stance selection",
    "required": ["priority", "useWhen"],
    "additionalProperties": false,
    "properties": {
      "priority": {
        "type": "integer",
        "minimum": 0,
        "maximum": 100,
        "description": "Preference priority (higher = more preferred)"
      },
      "useWhen": {
        "type": "array",
        "description": "Conditions that trigger this stance",
        "minItems": 1,
        "items": { "$ref": "#/definitions/AICondition" }
      },
      "avoidWhen": {
        "type": "array",
        "description": "Conditions that prevent this stance",
        "items": { "$ref": "#/definitions/AICondition" }
      },
      "stickiness": {
        "type": "number",
        "minimum": 0.0,
        "maximum": 1.0,
        "default": 0.5,
        "description": "Likelihood to stay in stance (0=always change, 1=never change)"
      }
    }
  }
}
```

### 9.2 AICondition Schema

```json
{
  "AICondition": {
    "type": "object",
    "description": "A condition for AI stance evaluation",
    "required": ["type"],
    "additionalProperties": false,
    "properties": {
      "type": {
        "type": "string",
        "enum": [
          "HealthBelow",
          "HealthAbove",
          "EnemyCount",
          "AllyCount",
          "StatusActive",
          "TargetWeak",
          "OutNumbered"
        ],
        "description": "Condition type"
      },
      "value": {
        "type": ["number", "string"],
        "description": "Condition parameter"
      },
      "weight": {
        "type": "number",
        "minimum": 0.0,
        "maximum": 10.0,
        "default": 1.0,
        "description": "Importance weight for this condition"
      }
    }
  }
}
```

### 9.3 AI Condition Types

| Condition | Value Type | Description |
|-----------|------------|-------------|
| `HealthBelow` | number (0-100) | HP percentage threshold |
| `HealthAbove` | number (0-100) | HP percentage threshold |
| `EnemyCount` | number | Minimum number of enemies |
| `AllyCount` | number | Minimum number of allies |
| `StatusActive` | string | Status effect ID to check |
| `TargetWeak` | string | Damage type target is weak to |
| `OutNumbered` | - | Enemies > allies |

---

## 10. UnlockCondition Definition

### 10.1 Unlock Condition Schema

```json
{
  "UnlockCondition": {
    "type": "object",
    "description": "Condition for unlocking a stance",
    "required": ["type"],
    "additionalProperties": false,
    "properties": {
      "type": {
        "type": "string",
        "enum": ["Level", "Quest", "Skill", "Item", "Achievement"],
        "description": "Unlock condition type"
      },
      "value": {
        "type": ["number", "string"],
        "description": "Required value (level number, quest ID, etc.)"
      },
      "description": {
        "type": "string",
        "description": "Human-readable unlock requirement"
      }
    }
  }
}
```

---

## 11. Configuration Schema

### 11.1 Complete JSON Schema (stances.schema.json)

```json
{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "stances.schema.json",
  "title": "Combat Stance Configuration Schema",
  "description": "Defines combat stance configurations for Aethelgard",
  "type": "object",
  "required": ["version", "stances", "defaultStance"],
  "additionalProperties": false,
  "properties": {
    "$schema": { "type": "string" },
    "version": {
      "type": "string",
      "pattern": "^\\d+\\.\\d+\\.\\d+$"
    },
    "defaultStance": {
      "type": "string",
      "pattern": "^[a-z][a-z0-9-]*$"
    },
    "stances": {
      "type": "array",
      "minItems": 1,
      "items": { "$ref": "#/definitions/CombatStance" }
    },
    "globalSwitchingRules": {
      "$ref": "#/definitions/SwitchingRule"
    }
  },
  "definitions": {
    "CombatStance": {
      "type": "object",
      "required": ["id", "name", "description"],
      "additionalProperties": false,
      "properties": {
        "id": { "type": "string", "pattern": "^[a-z][a-z0-9-]*$" },
        "name": { "type": "string", "minLength": 1, "maxLength": 30 },
        "description": { "type": "string", "minLength": 1, "maxLength": 200 },
        "iconId": { "type": "string" },
        "color": { "type": "string", "pattern": "^#[0-9A-Fa-f]{6}$" },
        "statModifiers": {
          "type": "array",
          "items": { "$ref": "#/definitions/StatModifier" }
        },
        "abilityRestrictions": {
          "type": "array",
          "items": { "$ref": "#/definitions/AbilityRestriction" }
        },
        "abilityGrants": {
          "type": "array",
          "items": { "type": "string", "pattern": "^[a-z][a-z0-9-]*$" }
        },
        "switchingRule": { "$ref": "#/definitions/SwitchingRule" },
        "incompatibleStances": {
          "type": "array",
          "items": { "type": "string", "pattern": "^[a-z][a-z0-9-]*$" }
        },
        "aiBehavior": { "$ref": "#/definitions/AIBehavior" },
        "visualEffectId": { "type": "string" },
        "soundEffectId": { "type": "string" },
        "isDefault": { "type": "boolean", "default": false },
        "requiresUnlock": { "type": "boolean", "default": false },
        "unlockCondition": { "$ref": "#/definitions/UnlockCondition" },
        "tags": { "type": "array", "items": { "type": "string" } },
        "sortOrder": { "type": "integer", "default": 0 }
      }
    },
    "StatModifier": {
      "type": "object",
      "required": ["stat", "value", "type"],
      "additionalProperties": false,
      "properties": {
        "stat": {
          "type": "string",
          "enum": ["attack", "defense", "speed", "accuracy", "evasion", "criticalChance", "criticalDamage", "damageReduction"]
        },
        "value": { "type": "number" },
        "type": { "type": "string", "enum": ["flat", "percentage"] },
        "description": { "type": "string", "maxLength": 100 }
      }
    },
    "AbilityRestriction": {
      "type": "object",
      "required": ["type", "target"],
      "additionalProperties": false,
      "properties": {
        "type": { "type": "string", "enum": ["Category", "Specific", "Tag"] },
        "target": { "type": "string" },
        "description": { "type": "string", "maxLength": 100 }
      }
    },
    "SwitchingRule": {
      "type": "object",
      "required": ["actionCost"],
      "additionalProperties": false,
      "properties": {
        "actionCost": { "type": "string", "enum": ["Free", "Swift", "Standard", "Full"] },
        "cooldown": { "type": "integer", "minimum": 0, "default": 0 },
        "conditions": {
          "type": "array",
          "items": { "$ref": "#/definitions/SwitchCondition" }
        },
        "canSwitchDuringEnemyTurn": { "type": "boolean", "default": false },
        "triggerEffects": {
          "type": "array",
          "items": { "$ref": "#/definitions/TriggerEffect" }
        }
      }
    },
    "SwitchCondition": {
      "type": "object",
      "required": ["type"],
      "additionalProperties": false,
      "properties": {
        "type": {
          "type": "string",
          "enum": ["HealthAbove", "HealthBelow", "HasStatus", "NotHasStatus", "InCombat", "OutOfCombat", "TurnNumber"]
        },
        "value": { "type": ["number", "string"] }
      }
    },
    "TriggerEffect": {
      "type": "object",
      "required": ["type"],
      "additionalProperties": false,
      "properties": {
        "type": { "type": "string", "enum": ["Heal", "Damage", "ApplyStatus", "RemoveStatus", "Buff", "Debuff"] },
        "target": { "type": "string", "enum": ["Self", "NearbyAllies", "NearbyEnemies"], "default": "Self" },
        "value": { "type": ["number", "string"] },
        "duration": { "type": "integer", "minimum": 0 }
      }
    },
    "AIBehavior": {
      "type": "object",
      "required": ["priority", "useWhen"],
      "additionalProperties": false,
      "properties": {
        "priority": { "type": "integer", "minimum": 0, "maximum": 100 },
        "useWhen": {
          "type": "array",
          "minItems": 1,
          "items": { "$ref": "#/definitions/AICondition" }
        },
        "avoidWhen": {
          "type": "array",
          "items": { "$ref": "#/definitions/AICondition" }
        },
        "stickiness": { "type": "number", "minimum": 0.0, "maximum": 1.0, "default": 0.5 }
      }
    },
    "AICondition": {
      "type": "object",
      "required": ["type"],
      "additionalProperties": false,
      "properties": {
        "type": {
          "type": "string",
          "enum": ["HealthBelow", "HealthAbove", "EnemyCount", "AllyCount", "StatusActive", "TargetWeak", "OutNumbered"]
        },
        "value": { "type": ["number", "string"] },
        "weight": { "type": "number", "minimum": 0.0, "maximum": 10.0, "default": 1.0 }
      }
    },
    "UnlockCondition": {
      "type": "object",
      "required": ["type"],
      "additionalProperties": false,
      "properties": {
        "type": { "type": "string", "enum": ["Level", "Quest", "Skill", "Item", "Achievement"] },
        "value": { "type": ["number", "string"] },
        "description": { "type": "string" }
      }
    }
  }
}
```

---

## 12. Example Configuration File

### 12.1 stances.json Example

```json
{
  "$schema": "./stances.schema.json",
  "version": "1.0.0",
  "defaultStance": "balanced",
  "globalSwitchingRules": {
    "actionCost": "Swift",
    "cooldown": 1
  },
  "stances": [
    {
      "id": "balanced",
      "name": "Balanced",
      "description": "A neutral combat stance with no bonuses or penalties. Provides flexibility in any situation.",
      "iconId": "icon-stance-balanced",
      "color": "#AAAAAA",
      "isDefault": true,
      "switchingRule": {
        "actionCost": "Free",
        "cooldown": 0
      },
      "aiBehavior": {
        "priority": 1,
        "useWhen": [
          { "type": "HealthAbove", "value": 30 },
          { "type": "HealthBelow", "value": 80 }
        ],
        "stickiness": 0.3
      },
      "tags": ["default", "neutral", "flexible"],
      "sortOrder": 1
    },
    {
      "id": "aggressive",
      "name": "Aggressive",
      "description": "An offensive stance that increases damage output at the cost of defense. Best when you need to end fights quickly.",
      "iconId": "icon-stance-aggressive",
      "color": "#CC3333",
      "statModifiers": [
        { "stat": "attack", "value": 20, "type": "percentage", "description": "+20% damage" },
        { "stat": "defense", "value": -20, "type": "percentage", "description": "-20% defense" }
      ],
      "abilityGrants": ["power-attack", "reckless-strike"],
      "abilityRestrictions": [
        { "type": "Category", "target": "defensive", "description": "Cannot use defensive abilities" }
      ],
      "incompatibleStances": ["defensive"],
      "switchingRule": {
        "actionCost": "Swift",
        "cooldown": 1,
        "conditions": [
          { "type": "NotHasStatus", "value": "stunned" }
        ]
      },
      "aiBehavior": {
        "priority": 3,
        "useWhen": [
          { "type": "HealthAbove", "value": 60, "weight": 1.5 },
          { "type": "EnemyCount", "value": 1, "weight": 1.0 }
        ],
        "avoidWhen": [
          { "type": "HealthBelow", "value": 30 },
          { "type": "OutNumbered" }
        ],
        "stickiness": 0.6
      },
      "visualEffectId": "vfx-stance-aggressive",
      "soundEffectId": "sfx-stance-aggressive",
      "tags": ["offensive", "damage", "risky"],
      "sortOrder": 2
    },
    {
      "id": "defensive",
      "name": "Defensive",
      "description": "A protective stance that reduces incoming damage at the cost of offense. Ideal when outnumbered or low on health.",
      "iconId": "icon-stance-defensive",
      "color": "#3366CC",
      "statModifiers": [
        { "stat": "defense", "value": 20, "type": "percentage", "description": "+20% defense" },
        { "stat": "attack", "value": -20, "type": "percentage", "description": "-20% damage" },
        { "stat": "damageReduction", "value": 3, "type": "flat", "description": "+3 damage reduction" }
      ],
      "abilityGrants": ["shield-wall", "parry"],
      "abilityRestrictions": [
        { "type": "Tag", "target": "aggressive", "description": "Cannot use aggressive abilities" }
      ],
      "incompatibleStances": ["aggressive", "reckless"],
      "switchingRule": {
        "actionCost": "Swift",
        "cooldown": 1
      },
      "aiBehavior": {
        "priority": 4,
        "useWhen": [
          { "type": "HealthBelow", "value": 40, "weight": 2.0 },
          { "type": "OutNumbered", "weight": 1.5 }
        ],
        "stickiness": 0.7
      },
      "visualEffectId": "vfx-stance-defensive",
      "soundEffectId": "sfx-stance-defensive",
      "tags": ["protective", "survival", "safe"],
      "sortOrder": 3
    },
    {
      "id": "evasive",
      "name": "Evasive",
      "description": "A mobile stance focusing on dodging attacks. Sacrifices raw power for the ability to avoid damage entirely.",
      "iconId": "icon-stance-evasive",
      "color": "#33CC66",
      "statModifiers": [
        { "stat": "evasion", "value": 20, "type": "percentage", "description": "+20% evasion" },
        { "stat": "speed", "value": 10, "type": "percentage", "description": "+10% speed" },
        { "stat": "attack", "value": -10, "type": "percentage", "description": "-10% damage" }
      ],
      "abilityGrants": ["dodge-roll", "quick-step"],
      "abilityRestrictions": [
        { "type": "Tag", "target": "heavy", "description": "Cannot use heavy attacks" }
      ],
      "switchingRule": {
        "actionCost": "Swift",
        "cooldown": 1
      },
      "aiBehavior": {
        "priority": 2,
        "useWhen": [
          { "type": "EnemyCount", "value": 3, "weight": 1.5 },
          { "type": "StatusActive", "value": "slowed", "weight": 2.0 }
        ],
        "avoidWhen": [
          { "type": "AllyCount", "value": 3 }
        ],
        "stickiness": 0.5
      },
      "visualEffectId": "vfx-stance-evasive",
      "soundEffectId": "sfx-stance-evasive",
      "tags": ["mobility", "dodge", "agile"],
      "sortOrder": 4
    },
    {
      "id": "reckless",
      "name": "Reckless",
      "description": "A high-risk, high-reward stance that greatly increases damage and critical chance at severe cost to defense.",
      "iconId": "icon-stance-reckless",
      "color": "#FF6600",
      "statModifiers": [
        { "stat": "attack", "value": 30, "type": "percentage", "description": "+30% damage" },
        { "stat": "criticalChance", "value": 20, "type": "percentage", "description": "+20% crit chance" },
        { "stat": "defense", "value": -30, "type": "percentage", "description": "-30% defense" }
      ],
      "abilityGrants": ["berserker-rage", "all-in-strike"],
      "incompatibleStances": ["defensive", "balanced"],
      "switchingRule": {
        "actionCost": "Swift",
        "cooldown": 2,
        "conditions": [
          { "type": "HealthAbove", "value": 50 }
        ],
        "triggerEffects": [
          { "type": "ApplyStatus", "target": "Self", "value": "adrenaline", "duration": 2 }
        ]
      },
      "aiBehavior": {
        "priority": 2,
        "useWhen": [
          { "type": "HealthAbove", "value": 80, "weight": 1.0 },
          { "type": "AllyCount", "value": 2, "weight": 1.5 },
          { "type": "EnemyCount", "value": 1, "weight": 2.0 }
        ],
        "avoidWhen": [
          { "type": "HealthBelow", "value": 50 },
          { "type": "OutNumbered" }
        ],
        "stickiness": 0.4
      },
      "visualEffectId": "vfx-stance-reckless",
      "soundEffectId": "sfx-stance-reckless",
      "tags": ["risky", "berserker", "glass-cannon"],
      "sortOrder": 5
    },
    {
      "id": "focused",
      "name": "Focused",
      "description": "A precision stance that enhances accuracy and critical hits at the cost of speed. Perfect for landing decisive blows.",
      "iconId": "icon-stance-focused",
      "color": "#9933CC",
      "statModifiers": [
        { "stat": "accuracy", "value": 25, "type": "percentage", "description": "+25% accuracy" },
        { "stat": "criticalChance", "value": 15, "type": "percentage", "description": "+15% crit chance" },
        { "stat": "speed", "value": -10, "type": "percentage", "description": "-10% speed" }
      ],
      "abilityGrants": ["precise-strike", "aim"],
      "switchingRule": {
        "actionCost": "Swift",
        "cooldown": 1
      },
      "aiBehavior": {
        "priority": 2,
        "useWhen": [
          { "type": "TargetWeak", "value": "precision", "weight": 2.0 },
          { "type": "EnemyCount", "value": 1, "weight": 1.0 }
        ],
        "stickiness": 0.6
      },
      "visualEffectId": "vfx-stance-focused",
      "soundEffectId": "sfx-stance-focused",
      "requiresUnlock": true,
      "unlockCondition": {
        "type": "Level",
        "value": 5,
        "description": "Reach level 5"
      },
      "tags": ["precision", "critical", "calculated"],
      "sortOrder": 6
    }
  ]
}
```

---

## 13. Logging Specifications

### 13.1 Log Categories

| Category | Level | Description |
|----------|-------|-------------|
| `Stance.Load` | Info | Schema loading and parsing events |
| `Stance.Switch` | Info | Stance switching events |
| `Stance.Validate` | Warning/Error | Validation failures |
| `Stance.AI` | Debug | AI stance evaluation |
| `Stance.Modifier` | Debug | Stat modifier application |

### 13.2 Log Message Formats

```
[INFO] Stance.Load: Loaded {count} stances, default: {defaultStance}
[INFO] Stance.Switch: {entityId} switched from {oldStance} to {newStance}
[WARN] Stance.Switch: {entityId} cannot switch to {stanceId}: {reason}
[ERROR] Stance.Validate: Stance {stanceId} references unknown incompatible stance {refId}
[DEBUG] Stance.AI: {entityId} evaluating stances: {stanceScores}
[DEBUG] Stance.AI: {entityId} selected {stanceId} with priority {priority}
[DEBUG] Stance.Modifier: Applied {stanceId} modifiers to {entityId}: {modifiers}
```

---

## 14. Unit Testing Requirements

### 14.1 Test Matrix

| Test ID | Test Name | Description | Expected Result |
|---------|-----------|-------------|-----------------|
| STN-001 | ValidSchemaLoads | Load valid stances.json against schema | Loads without errors |
| STN-002 | InvalidStanceIdRejected | Stance ID not matching pattern | Validation error |
| STN-003 | StatModifierValidation | All 8 stat types with both modifier types | Types recognized |
| STN-004 | SwitchingRuleValidation | Action costs and conditions validated | Rules parsed correctly |
| STN-005 | AIBehaviorValidation | AI conditions and priorities validated | Behavior parsed correctly |
| STN-006 | DefaultStanceRequired | defaultStance must exist in stances array | Validation error if missing |

### 14.2 Test Specifications

#### STN-001: ValidSchemaLoads

```
GIVEN a valid stances.json file
WHEN validated against stances.schema.json
THEN validation succeeds
AND all stances are parsed
AND default stance is identified
AND stat modifiers are indexed
```

#### STN-002: InvalidStanceIdRejected

```
GIVEN a stance with id "Invalid_Stance"
WHEN validated against schema
THEN validation fails
AND error message indicates pattern mismatch
AND error specifies the invalid ID
```

#### STN-003: StatModifierValidation

```
GIVEN stances with each of the 8 stat types
AND both flat and percentage modifier types
WHEN parsed and validated
THEN each stat type is recognized
AND modifier application type is correct
AND values are within expected ranges
```

#### STN-004: SwitchingRuleValidation

```
GIVEN stances with each action cost type
AND various switching conditions
WHEN parsed and validated
THEN action costs are recognized (Free/Swift/Standard/Full)
AND conditions are parsed with type and value
AND cooldowns are non-negative integers
```

#### STN-005: AIBehaviorValidation

```
GIVEN stances with AI behavior configurations
WHEN parsed and validated
THEN priority values are 0-100
AND useWhen has at least one condition
AND stickiness is 0.0-1.0
AND condition types are from enum
```

#### STN-006: DefaultStanceRequired

```
GIVEN a stances.json with defaultStance "nonexistent"
WHEN validated
THEN validation fails
AND error indicates default stance not found in stances array
```

---

## 15. Use Cases

### 15.1 Load Stance Configuration

```
┌─────────────────────────────────────────────────────────────────────────┐
│ USE CASE: Load Stance Configuration                                      │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                          │
│ Actors: StanceProvider, Configuration System                            │
│ Trigger: Game initialization or configuration reload                     │
│                                                                          │
│ Main Flow:                                                               │
│   1. StanceProvider locates stances.json and stances.schema.json        │
│   2. JSON content is parsed                                              │
│   3. Content is validated against schema                                 │
│   4. Default stance verified to exist                                    │
│   5. Stances indexed by ID                                               │
│   6. Incompatible stance references validated                            │
│   7. Configuration cached for runtime access                             │
│                                                                          │
│ Alternate Flow (Validation Failure):                                     │
│   3a. Schema validation fails                                            │
│   3b. Error logged with specific validation failure                      │
│   3c. System falls back to hardcoded "balanced" stance                  │
│                                                                          │
│ Postconditions:                                                          │
│   - All stances accessible by ID                                         │
│   - Default stance identified                                            │
│   - Modifier calculations ready                                          │
│                                                                          │
└─────────────────────────────────────────────────────────────────────────┘
```

### 15.2 Switch Combat Stance

```
┌─────────────────────────────────────────────────────────────────────────┐
│ USE CASE: Switch Combat Stance                                           │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                          │
│ Actors: Player/AI, StanceService, Combat System                         │
│ Trigger: Entity requests stance change                                   │
│                                                                          │
│ Main Flow:                                                               │
│   1. Request received: entity wants to switch to {targetStance}         │
│   2. Validate target stance exists                                       │
│   3. Check incompatible stances (current not in target.incompatible)    │
│   4. Check cooldown (time since last switch >= cooldown)                │
│   5. Evaluate switch conditions (health, status, combat state)          │
│   6. Deduct action cost (Free/Swift/Standard/Full)                      │
│   7. Remove current stance modifiers                                     │
│   8. Apply new stance modifiers                                          │
│   9. Update ability access (grants/restrictions)                         │
│   10. Start cooldown timer                                               │
│   11. Execute trigger effects                                            │
│   12. Play visual/sound effects                                          │
│                                                                          │
│ Alternate Flow (Switch Denied):                                          │
│   3a. Target stance incompatible with current                            │
│   3b. Return error: "Cannot switch from {current} to {target}"          │
│                                                                          │
│   5a. Condition not met (e.g., HP too low)                              │
│   5b. Return error: "Condition not met: {condition}"                    │
│                                                                          │
│ Postconditions:                                                          │
│   - Entity now in new stance                                             │
│   - Stats reflect new modifiers                                          │
│   - Abilities updated                                                    │
│   - UI reflects change                                                   │
│                                                                          │
└─────────────────────────────────────────────────────────────────────────┘
```

### 15.3 AI Stance Evaluation

```
┌─────────────────────────────────────────────────────────────────────────┐
│ USE CASE: AI Stance Evaluation                                           │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                          │
│ Actors: Combat AI, StanceService                                        │
│ Trigger: AI entity's turn begins                                         │
│                                                                          │
│ Main Flow:                                                               │
│   1. Get current stance and its stickiness value                        │
│   2. Roll against stickiness (random < stickiness = don't evaluate)     │
│   3. For each available stance:                                         │
│      a. Check if any avoidWhen conditions are true → skip stance        │
│      b. Evaluate useWhen conditions                                      │
│      c. Calculate score: sum(condition.weight if true)                  │
│      d. Apply priority multiplier                                        │
│   4. Select highest-scoring stance                                       │
│   5. If different from current, attempt switch                          │
│   6. If switch successful, proceed with turn                            │
│                                                                          │
│ Scoring Example:                                                         │
│   Aggressive stance:                                                     │
│   - HealthAbove(60) = true × 1.5 = 1.5                                  │
│   - EnemyCount(1) = true × 1.0 = 1.0                                    │
│   - Priority: 3                                                          │
│   - Final score: (1.5 + 1.0) × 3 = 7.5                                  │
│                                                                          │
│   Defensive stance:                                                      │
│   - HealthBelow(40) = false × 2.0 = 0                                   │
│   - Priority: 4                                                          │
│   - Final score: 0 × 4 = 0                                              │
│                                                                          │
│   → AI selects Aggressive                                                │
│                                                                          │
└─────────────────────────────────────────────────────────────────────────┘
```

### 15.4 Display Stance UI

```
┌─────────────────────────────────────────────────────────────────────────┐
│ USE CASE: Display Stance UI                                              │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                          │
│ Actors: Player, Combat UI, StanceService                                │
│ Trigger: Combat begins or stance selector opened                         │
│                                                                          │
│ Main Flow:                                                               │
│   1. Get current stance                                                  │
│   2. Get all available stances (unlocked, not incompatible)             │
│   3. For each stance, display:                                          │
│      a. Icon with stance color                                           │
│      b. Name                                                             │
│      c. Current active indicator (if current)                           │
│      d. Cooldown indicator (if on cooldown)                             │
│      e. Lock icon (if not unlocked)                                     │
│   4. On hover, show tooltip with:                                       │
│      a. Description                                                      │
│      b. Stat modifiers (green for bonus, red for penalty)               │
│      c. Ability grants/restrictions                                      │
│      d. Switching cost and conditions                                    │
│                                                                          │
│ Stance Panel Example:                                                    │
│   ┌────────────────────────────────────────────────────────────────┐   │
│   │  [⚔] Aggressive    [●] Balanced (Active)    [🛡] Defensive    │   │
│   │  [🏃] Evasive      [💀] Reckless            [🔒] Focused      │   │
│   └────────────────────────────────────────────────────────────────┘   │
│                                                                          │
│ Tooltip Example:                                                         │
│   ┌────────────────────────────────────────────────────────────────┐   │
│   │ AGGRESSIVE                                                      │   │
│   │ An offensive stance that increases damage at the cost of       │   │
│   │ defense.                                                        │   │
│   │                                                                 │   │
│   │ +20% Attack    -20% Defense                                    │   │
│   │                                                                 │   │
│   │ Grants: Power Attack, Reckless Strike                          │   │
│   │ Restricts: Defensive abilities                                 │   │
│   │                                                                 │   │
│   │ Switch: Swift Action (1 turn cooldown)                         │   │
│   └────────────────────────────────────────────────────────────────┘   │
│                                                                          │
└─────────────────────────────────────────────────────────────────────────┘
```

### 15.5 Apply Stance Modifiers

```
┌─────────────────────────────────────────────────────────────────────────┐
│ USE CASE: Apply Stance Modifiers to Combat Calculation                   │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                          │
│ Actors: Combat System, StanceService                                    │
│ Trigger: Any stat calculation during combat                              │
│                                                                          │
│ Main Flow:                                                               │
│   1. Get entity's current stance                                        │
│   2. Get base stat value                                                 │
│   3. Get stance's stat modifiers for that stat                          │
│   4. Apply modifiers in order:                                          │
│      a. Add flat modifiers to base                                       │
│      b. Multiply by (1 + percentage/100)                                │
│   5. Return modified value                                               │
│                                                                          │
│ Calculation Example:                                                     │
│   Entity in Aggressive stance                                            │
│   Base Attack: 100                                                       │
│   Stance modifier: +20% attack (percentage)                              │
│                                                                          │
│   Step 1: Flat modifiers = 0 → 100 + 0 = 100                            │
│   Step 2: Percentage = 100 × (1 + 20/100) = 100 × 1.2 = 120             │
│                                                                          │
│   Final Attack: 120                                                      │
│                                                                          │
│   Entity in Defensive stance                                             │
│   Base Defense: 50                                                       │
│   Stance modifiers: +20% defense, +3 damage reduction                   │
│                                                                          │
│   Defense: 50 × 1.2 = 60                                                │
│   Damage Reduction: 0 + 3 = 3                                           │
│                                                                          │
└─────────────────────────────────────────────────────────────────────────┘
```

---

## 16. Deliverable Checklist

### Configuration Files

| Item | Status | Notes |
|------|--------|-------|
| `stances.schema.json` | Pending | JSON Schema Draft-07 validation |
| `stances.json` | Pending | Stance definitions |

### Schema Definitions

| Item | Status | Notes |
|------|--------|-------|
| `CombatStance` | Defined | Section 5 |
| `StatModifier` | Defined | Section 6 |
| `AbilityRestriction` | Defined | Section 7 |
| `SwitchingRule` | Defined | Section 8 |
| `AIBehavior` | Defined | Section 9 |

### Unit Tests

| Item | Status | Notes |
|------|--------|-------|
| STN-001: ValidSchemaLoads | Pending | Schema validation |
| STN-002: InvalidStanceIdRejected | Pending | ID pattern enforcement |
| STN-003: StatModifierValidation | Pending | All 8 stats, both types |
| STN-004: SwitchingRuleValidation | Pending | Action costs, conditions |
| STN-005: AIBehaviorValidation | Pending | AI conditions, priorities |
| STN-006: DefaultStanceRequired | Pending | Default existence check |

---

## 17. Acceptance Criteria

### Functional Criteria

| ID | Criterion | Verification |
|----|-----------|--------------|
| AC-01 | Schema validates CombatStance definitions | Run test STN-001 |
| AC-02 | Stance IDs follow kebab-case pattern | Run test STN-002 |
| AC-03 | All 8 stat modifier types supported | Run test STN-003 |
| AC-04 | Both flat and percentage modifier types work | Run test STN-003 |
| AC-05 | All 4 action costs defined | Run test STN-004 |
| AC-06 | AI behavior conditions validated | Run test STN-005 |
| AC-07 | Default stance must exist in array | Run test STN-006 |
| AC-08 | 6 standard stances defined | Inspect configuration |
| AC-09 | Incompatible stances validated | Inspect configuration |
| AC-10 | Unlock conditions supported | Inspect schema |

### Quality Criteria

| ID | Criterion | Verification |
|----|-----------|--------------|
| QC-01 | Schema follows JSON Schema Draft-07 | Schema linter validation |
| QC-02 | All properties have descriptions | Manual inspection |
| QC-03 | Examples provided for modifiers | Manual inspection |
| QC-04 | Default values documented | Manual inspection |
| QC-05 | Color values are valid hex | Pattern validation |

---

## 18. Dependencies

### Required From

| Version | Component | Usage |
|---------|-----------|-------|
| v0.14.1 | Combat Schema | Combat stat definitions |
| v0.10.x | Status Effect Schema | Status conditions for AI |
| (Future) | abilities.schema.json | Ability references for grants/restrictions |

### Provides To

| Version | Component | Usage |
|---------|-----------|-------|
| v0.15.x | Stance Service | Runtime stance management |
| v0.15.x | Combat AI | Stance selection decisions |
| v0.15.x | Combat UI | Stance display and selection |
| v0.15.x | Stat Calculator | Modifier application |

---

## 19. Future Considerations

### Deferred to Future Versions

| Feature | Rationale |
|---------|-----------|
| Stance combos | Runtime complexity beyond schema scope |
| Dynamic modifiers | Calculation logic is runtime concern |
| Stance leveling | Progression system not yet defined |
| Stance synergies | Party system beyond current scope |
| Custom player stances | Character customization deferred |

### Extension Points

| Extension | Mechanism |
|-----------|-----------|
| Additional stats | Extend stat enum in StatModifier |
| New action costs | Extend actionCost enum |
| Custom AI conditions | Extend AICondition type enum |
| Unlock condition types | Extend UnlockCondition type enum |
| Trigger effect types | Extend TriggerEffect type enum |

---

## 20. Appendix

### A. ID Pattern Reference

| Entity | Pattern | Example |
|--------|---------|---------|
| Stance ID | `[a-z][a-z0-9-]*` | `balanced`, `aggressive` |
| Ability ID (ref) | `[a-z][a-z0-9-]*` | `power-attack`, `shield-wall` |
| Effect ID | `[a-z][a-z0-9-]*` | `vfx-stance-aggressive` |
| Status ID (ref) | `[a-z][a-z0-9-]*` | `stunned`, `burning` |

### B. Standard Stances

| Stance | Attack | Defense | Other |
|--------|--------|---------|-------|
| Balanced | 0% | 0% | No modifiers |
| Aggressive | +20% | -20% | - |
| Defensive | -20% | +20% | +3 DR |
| Evasive | -10% | - | +20% evasion, +10% speed |
| Reckless | +30% | -30% | +20% crit chance |
| Focused | - | - | +25% accuracy, +15% crit, -10% speed |

### C. Action Cost Comparison

| Cost | Turn Impact | Use Case |
|------|-------------|----------|
| Free | No impact | Default/balanced stance |
| Swift | Bonus action | Most offensive/defensive stances |
| Standard | Main action | High-impact stances |
| Full | Ends turn | Transformation stances |

### D. AI Priority Guidelines

| Priority | Description | Example |
|----------|-------------|---------|
| 1 | Fallback | Balanced (always valid) |
| 2 | Situational | Focused, Evasive |
| 3 | Preferred | Aggressive |
| 4 | High priority | Defensive (survival) |
| 5+ | Critical | Emergency stances |

---

*End of v0.14.10f Design Specification*
