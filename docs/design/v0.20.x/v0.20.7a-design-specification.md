# Design Specification: v0.20.7a - Veiðimaðr Framework & Tier 1 Abilities

**Version:** v0.20.7a
**Status:** Design Phase
**Last Updated:** 2026-01-28
**Target Tests:** ~10 unit and integration tests
**Specialization:** Veiðimaðr (Hunter)
**Path Type:** Coherent (NO Corruption Risk)
**Archetype:** Skirmisher

---

## Table of Contents

1. [Executive Summary](#1-executive-summary)
2. [Specialization Overview](#2-specialization-overview)
3. [Architecture Diagrams](#3-architecture-diagrams)
4. [Domain Model Specifications](#4-domain-model-specifications)
5. [Quarry Marks Resource System](#5-quarry-marks-resource-system)
6. [Tier 1 Abilities Specification](#6-tier-1-abilities-specification)
7. [User Stories](#7-user-stories)
8. [Application Service Layer](#8-application-service-layer)
9. [Configuration Specifications](#9-configuration-specifications)
10. [Code Examples & Implementation](#10-code-examples--implementation)
11. [State Machine Diagrams](#11-state-machine-diagrams)
12. [Coherent Path Safety](#12-coherent-path-safety)
13. [Logging Specifications](#13-logging-specifications)
14. [Unit Testing Requirements](#14-unit-testing-requirements)
15. [Deliverable Checklist](#15-deliverable-checklist)
16. [Acceptance Criteria](#16-acceptance-criteria)
17. [Dependencies & Prerequisites](#17-dependencies--prerequisites)
18. [Design Decisions & Rationale](#18-design-decisions--rationale)

---

## 1. Executive Summary

Version 0.20.7a introduces the **Veiðimaðr (Hunter)** specialization framework, establishing the **first Coherent path** in the Skirmisher archetype for v0.20.x. This represents a deliberate contrast to the Heretical Myrk-gengr (v0.20.4), demonstrating that multiple philosophical approaches exist within the same archetype.

### Key Deliverables

| Category | Count | Details |
|----------|-------|---------|
| **Domain Value Objects** | 4 | QuarryMarksResource, QuarryMark, MarkQuarryResult, ReadTheSignsResult |
| **Domain Enums** | 3 | VeiðimaðrAbilityId, QuarryStatus, CreatureTrackType |
| **Application Services** | 2 | QuarryMarksService, VeiðimaðrAbilityService |
| **Ability Implementations** | 3 | Mark Quarry, Keen Senses, Read the Signs |
| **Configuration Files** | 2 | specializations.json (Veiðimaðr entry), abilities.json (Tier 1) |
| **Unit Tests** | ~10 | Comprehensive coverage of services and abilities |

### Specialization Profile

| Attribute | Value |
|-----------|-------|
| **Display Name** | Veiðimaðr |
| **Pronunciation** | VAY-thee-math-ur |
| **Translation** | Hunter / Huntsman (Old Norse) |
| **Archetype** | Skirmisher |
| **Path Type** | Coherent |
| **Role** | Hunter / Tracker / Ranged Combat |
| **Special Resource** | Quarry Marks (Max 3) |
| **Tagline** | "Master of the Hunt" |
| **Unlock Cost** | 0 PP (immediately available after Skirmisher selection) |

---

## 2. Specialization Overview

### 2.1 Thematic Foundation

The Veiðimaðr represents the patient, methodical predator in Aethelgard. While the Myrk-gengr draws power from corrupted shadows, the Veiðimaðr relies on skill, patience, and intimate knowledge of prey. In a world filled with dangers from the Blight, corrupted machines, and hostile survivors, the Veiðimaðr is the one who tracks, studies, and eliminates threats with calculated precision.

**Design Principles:**

1. **Coherent Safety:** No Corruption risk — hunting through skill and wisdom, not dark power
2. **Quarry Focus:** Most abilities center on designated targets (Quarry Marks)
3. **Ranged Superiority:** Specializes in ranged attacks with significant positioning bonuses
4. **Patience Rewarded:** Bonuses for restraint and tactical positioning
5. **Tracking Mastery:** Excels at finding, following, and exploiting prey weaknesses

### 2.2 Tier 1 Identity

**Tier 1 Abilities (Immediately Available):**

| Ability | Type | AP Cost | Resource Cost | Range |
|---------|------|---------|---------------|-------|
| Mark Quarry | Active | 1 AP | 1 Quarry Mark slot | 12 spaces |
| Keen Senses | Passive | — | — | — |
| Read the Signs | Active | 1 AP | — | Touch |

**Mechanical Focus:** Foundation abilities establish core hunter identity through target tracking and environmental awareness. No corruption mechanics — pure skill and expertise.

### 2.3 Coherent Path — No Corruption

As a Coherent path specialization, Veiðimaðr has **zero Corruption risk**:

| Trigger | Corruption Risk |
|---------|-----------------|
| Any ability use | None |
| Marking Quarry | None |
| Hunting Heretical creatures | None |
| Tier 2 and Tier 3 abilities | None |
| Capstone activation | None |

---

## 3. Architecture Diagrams

### 3.1 Domain Layer Architecture

```
┌────────────────────────────────────────────────────────────┐
│        v0.20.7a - Veiðimaðr Domain Layer                   │
├────────────────────────────────────────────────────────────┤
│                                                              │
│  ┌──────────────────────┐  ┌──────────────────────────┐    │
│  │ QuarryMarksResource  │  │ QuarryMark               │    │
│  │ (Value Object)       │  │ (Value Object)           │    │
│  ├──────────────────────┤  ├──────────────────────────┤    │
│  │ + ActiveMarks: List  │  │ + MarkId: Guid           │    │
│  │ + MaxMarks: int (3)  │  │ + TargetId: Guid         │    │
│  │ + CurrentMarkCount   │  │ + TargetName: string     │    │
│  │ + LastMarkGainedAt   │  │ + MarkedAt: DateTime     │    │
│  │ + EncounterId: Guid? │  │ + Status: QuarryStatus   │    │
│  ├──────────────────────┤  │ + HitBonus: int (+2)     │    │
│  │ + AddMark()          │  │ + TurnsActive: int       │    │
│  │ + RemoveMark()       │  │ + AdditionalBonuses      │    │
│  │ + HasMark()          │  ├──────────────────────────┤    │
│  │ + GetMark()          │  │ + GetTotalHitBonus()     │    │
│  │ + GetOldestMark()    │  │ + GetDescription()       │    │
│  │ + CanAddMark()       │  │ + IsExpired()            │    │
│  │ + ClearAllMarks()    │  │ + IncrementTurn()        │    │
│  │ + ClearExpiredMarks()│  └──────────────────────────┘    │
│  └──────────────────────┘                                   │
│                                                              │
│  ┌──────────────────────┐  ┌──────────────────────────┐    │
│  │ MarkQuarryResult     │  │ ReadTheSignsResult       │    │
│  │ (Value Object)       │  │ (Value Object)           │    │
│  ├──────────────────────┤  ├──────────────────────────┤    │
│  │ + HunterId: Guid     │  │ + InvestigatorId: Guid   │    │
│  │ + TargetId: Guid     │  │ + LocationDescription    │    │
│  │ + MarkCreated: Mark  │  │ + CreatureType: string?  │    │
│  │ + PreviousCount: int │  │ + CreatureCount: int?    │    │
│  │ + CurrentCount: int  │  │ + TimePassedEstimate     │    │
│  │ + ReplacedMark: Mark?│  │ + DirectionOfTravel      │    │
│  │ + MarkedAt: DateTime │  │ + CreatureCondition      │    │
│  ├──────────────────────┤  │ + TrackQuality: enum     │    │
│  │ + GetDescription()   │  │ + BonusApplied: int      │    │
│  │ + WasReplacement()   │  │ + SkillCheckRoll: int    │    │
│  │ + GetHitBonus()      │  │ + SkillCheckDc: int      │    │
│  └──────────────────────┘  │ + Success: bool          │    │
│                             │ + InformationRevealed    │    │
│                             ├──────────────────────────┤    │
│                             │ + GetDescription()       │    │
│                             │ + GetInformationList()   │    │
│                             └──────────────────────────┘    │
│                                                              │
│  ┌──────────────────────┐  ┌──────────────────────────┐    │
│  │ VeiðimaðrAbilityId   │  │ QuarryStatus             │    │
│  │ (Enum)               │  │ (Enum)                   │    │
│  ├──────────────────────┤  ├──────────────────────────┤    │
│  │ - MarkQuarry         │  │ - Active                 │    │
│  │ - KeenSenses         │  │ - Defeated               │    │
│  │ - ReadTheSigns       │  │ - Escaped                │    │
│  │ - HuntersEye         │  │ - Expired                │    │
│  │ - TrapMastery        │  │ - Unmarked               │    │
│  │ - PredatorsPatience  │  │                          │    │
│  │ - ApexPredator       │  │                          │    │
│  │ - CripplingShot      │  │                          │    │
│  │ - ThePerfectHunt     │  │                          │    │
│  └──────────────────────┘  └──────────────────────────┘    │
│                                                              │
│  ┌──────────────────────────────────────────────────────┐   │
│  │ CreatureTrackType (Enum)                             │   │
│  ├──────────────────────────────────────────────────────┤   │
│  │ - Fresh (0-1 hours old)                              │   │
│  │ - Recent (1-6 hours old)                             │   │
│  │ - Worn (6-24 hours old)                              │   │
│  │ - Ancient (24+ hours old)                            │   │
│  │ - Unclear (indecipherable)                           │   │
│  └──────────────────────────────────────────────────────┘   │
│                                                              │
└────────────────────────────────────────────────────────────┘
```

### 3.2 Application Service Layer Architecture

```
┌───────────────────────────────────────────────────────────────┐
│      v0.20.7a - Application Services Layer                    │
├───────────────────────────────────────────────────────────────┤
│                                                                 │
│  ┌────────────────────────────┐  ┌───────────────────────────┐ │
│  │ IQuarryMarksService        │  │ IVeiðimaðrAbilityService  │ │
│  │ (Interface)                │  │ (Interface)               │ │
│  ├────────────────────────────┤  ├───────────────────────────┤ │
│  │ + GetCurrentMarks()        │  │ + ExecuteMarkQuarry()     │ │
│  │ + AddMark()                │  │ + ApplyKeenSenses()       │ │
│  │ + RemoveMark()             │  │ + ExecuteReadTheSignsResult  │
│  │ + HasActiveMark()          │  │ + ValidateAbilityUsage()  │ │
│  │ + GetMarkFor()             │  │ + CalculateResourceCost() │ │
│  │ + GetOldestMark()          │  │ + GetAbilityDescription() │ │
│  │ + CanAddMark()             │  │ + ResolveMarkBonus()      │ │
│  │ + ClearAllMarks()          │  │ + ResolvePerceptionBonus()│ │
│  │ + ClearExpiredMarks()      │  │ + InvestigateTarget()     │ │
│  │ + GetMarkCount()           │  └───────────────────────────┘ │
│  │ + RefreshMarks()           │                                 │
│  └────────────────────────────┘                                 │
│             │                                                   │
│             └─────────────┬──────────────────────────────────┐  │
│                           │                                  │  │
│  ┌────────────────────────────────────────────────────────┐  │  │
│  │ VeiðimaðrSpecializationManager                         │  │  │
│  │ (Orchestrates services for specialization)             │  │  │
│  ├────────────────────────────────────────────────────────┤  │  │
│  │ - _quarryMarksService: IQuarryMarksService             │  │  │
│  │ - _abilityService: IVeiðimaðrAbilityService            │  │  │
│  │ - _encounterService: IEncounterService (dependency)    │  │  │
│  ├────────────────────────────────────────────────────────┤  │  │
│  │ + InitializeVeiðimaðr(): void                          │  │  │
│  │ + OnEncounterStart(): void                             │  │  │
│  │ + OnEncounterEnd(): void                               │  │  │
│  │ + OnTargetDefeated(): void                             │  │  │
│  └────────────────────────────────────────────────────────┘  │  │
│                                                                 │  │
└───────────────────────────────────────────────────────────────┘
```

### 3.3 Quarry Mark Lifecycle Diagram

```
┌─────────────┐
│   Target    │
│  Selected   │
└────────┬────┘
         │
         │ Mark Quarry (1 AP)
         ▼
┌──────────────────┐
│ Quarry Mark      │
│ CREATED          │
├──────────────────┤
│ + Status: Active │
│ + TurnsActive: 0 │
│ + HitBonus: +2   │
└────────┬─────────┘
         │
    ┌────┴──────────┬──────────┬──────────────┐
    │               │          │              │
    ▼               ▼          ▼              ▼
┌────────┐  ┌─────────────┐ ┌──────┐  ┌────────────┐
│Target  │  │Turn Passes  │ │ Mark │  │Encounter  │
│Defeated│  │(+1 Turn)    │ │Gets  │  │ Ends      │
│        │  │             │ │Used  │  │(+Tier 2)  │
└────┬───┘  └──────┬──────┘ │      │  └─────┬──────┘
     │             │        │      │        │
     │             ▼        │      │        │
     │      ┌────────────┐  │      │        │
     │      │Increments  │  │      │        │
     │      │TurnsActive │  │      │        │
     │      └──────┬─────┘  │      │        │
     │             │        │      │        │
     │      Max    │        │      │        │
     │      reached│        │      │        │
     │             ▼        │      │        │
     │      ┌────────────┐  │      │        │
     │      │Expires     │  │      │        │
     │      │(Auto-clear)│  │      │        │
     │      └────┬───────┘  │      │        │
     │           │          │      │        │
     └───────────┴──────────┴──────┴────────┘
                 │
                 ▼
         ┌──────────────────┐
         │ Quarry Mark      │
         │ CLEARED          │
         │ Mark Slot Freed  │
         └──────────────────┘
```

---

## 4. Domain Model Specifications

### 4.1 QuarryMarksResource (Value Object)

**Purpose:** Encapsulates the special resource system unique to Veiðimaðr specialization, managing up to 3 active Quarry Marks.

**Properties:**

```csharp
/// <summary>
/// Represents the Quarry Marks tracking resource for Veiðimaðr specialization.
/// Maintains up to 3 active marks on targets with FIFO replacement when exceeded.
/// </summary>
public sealed record QuarryMarksResource
{
    /// <summary>
    /// Collection of currently active Quarry Marks (0-3 marks).
    /// Maintained in order of creation (oldest first).
    /// </summary>
    public IReadOnlyList<QuarryMark> ActiveMarks { get; private set; } = new List<QuarryMark>();

    /// <summary>Maximum number of simultaneous Quarry Marks (always 3).</summary>
    public int MaxMarks { get; init; } = 3;

    /// <summary>Current number of active marks (0-3).</summary>
    public int CurrentMarkCount => ActiveMarks.Count;

    /// <summary>Whether a mark was gained this turn (for UI/feedback).</summary>
    public bool MarkGainedThisTurn { get; private set; }

    /// <summary>When the most recent mark was created.</summary>
    public DateTime? LastMarkGainedAt { get; private set; }

    /// <summary>Encounter ID if marks were created during an encounter; null if out of combat.</summary>
    public Guid? EncounterId { get; private set; }

    /// <summary>Timestamp of last resource update.</summary>
    public DateTime LastUpdatedAt { get; private set; } = DateTime.UtcNow;
}
```

**Methods:**

| Method | Signature | Returns | Purpose |
|--------|-----------|---------|---------|
| AddMark | `(QuarryMark mark)` | `bool` | Adds mark; returns false if max reached without replacement |
| RemoveMark | `(Guid targetId)` | `bool` | Removes specific mark by target; returns success |
| HasMark | `(Guid targetId)` | `bool` | Checks if target is marked |
| GetMark | `(Guid targetId)` | `QuarryMark?` | Retrieves specific mark |
| GetOldestMark | `()` | `QuarryMark?` | Gets mark that will be replaced next (FIFO) |
| CanAddMark | `()` | `bool` | True if below max marks |
| ClearAllMarks | `()` | `void` | Removes all marks (e.g., encounter end) |
| ClearExpiredMarks | `()` | `int` | Removes expired marks; returns count |

**Invariants:**

- `ActiveMarks.Count` must be 0-3
- `MaxMarks` is always 3
- `ActiveMarks` maintains creation order (oldest first)
- No duplicate target IDs in `ActiveMarks`
- When `AddMark()` is called and count >= 3, oldest mark is replaced

### 4.2 QuarryMark (Value Object)

**Purpose:** Represents a single Quarry Mark on a target, containing all metadata about the mark.

**Properties:**

```csharp
/// <summary>
/// Represents a single Quarry Mark placed on a target.
/// Contains all data about the mark, bonuses, and duration.
/// </summary>
public sealed record QuarryMark
{
    /// <summary>Unique identifier for this mark.</summary>
    public Guid MarkId { get; init; } = Guid.NewGuid();

    /// <summary>ID of the marked target.</summary>
    public Guid TargetId { get; init; }

    /// <summary>Name/display of marked target (for UI).</summary>
    public string TargetName { get; init; } = string.Empty;

    /// <summary>When this mark was created (UTC).</summary>
    public DateTime MarkedAt { get; init; }

    /// <summary>ID of the hunter who placed this mark.</summary>
    public Guid MarkedBy { get; init; }

    /// <summary>Current status of the mark (Active, Defeated, Escaped, etc).</summary>
    public QuarryStatus Status { get; private set; } = QuarryStatus.Active;

    /// <summary>Hit bonus this mark provides to the hunter (+2 base).</summary>
    public int HitBonus { get; init; } = 2;

    /// <summary>Encounter ID if mark was created during combat; null if out of combat.</summary>
    public Guid? EncounterId { get; init; }

    /// <summary>Number of turns this mark has been active.</summary>
    public int TurnsActive { get; private set; }

    /// <summary>
    /// Additional bonuses from other sources (e.g., Tier 2 abilities).
    /// Key format: "ability_name" or "condition_name", Value is bonus amount.
    /// </summary>
    public IReadOnlyDictionary<string, int> AdditionalBonuses { get; private set; } =
        new Dictionary<string, int>();
}
```

**Methods:**

| Method | Signature | Returns | Purpose |
|--------|-----------|---------|---------|
| GetTotalHitBonus | `()` | `int` | Sum of HitBonus + all AdditionalBonuses |
| GetDescription | `()` | `string` | Human-readable description (e.g., "Marked: Corrupted Wolf (+2 to hit)") |
| IsExpired | `()` | `bool` | True if mark should auto-clear (determined by Tier 2 abilities) |
| IncrementTurn | `()` | `void` | Increments TurnsActive by 1 |
| AddBonus | `(string source, int value)` | `void` | Adds bonus from source (e.g., Tier 2 ability) |

**Invariants:**

- `TargetId` must not be `Guid.Empty`
- `HitBonus` >= 2
- `TurnsActive` >= 0
- `MarkedAt` must be valid DateTime (not default)
- `Status` must be a valid `QuarryStatus` enum value

### 4.3 MarkQuarryResult (Value Object)

**Purpose:** Encapsulates the result of successfully marking a target with Mark Quarry ability.

**Properties:**

```csharp
/// <summary>
/// Result of a Mark Quarry action, indicating success and what occurred.
/// </summary>
public sealed record MarkQuarryResult
{
    /// <summary>ID of the hunter who performed the mark.</summary>
    public Guid HunterId { get; init; }

    /// <summary>Display name of the hunter (for UI).</summary>
    public string HunterName { get; init; } = string.Empty;

    /// <summary>ID of the target being marked.</summary>
    public Guid TargetId { get; init; }

    /// <summary>Display name of the target (for UI).</summary>
    public string TargetName { get; init; } = string.Empty;

    /// <summary>The mark that was created.</summary>
    public QuarryMark MarkCreated { get; init; }

    /// <summary>Number of marks before this action (0-3).</summary>
    public int PreviousMarksCount { get; init; }

    /// <summary>Number of marks after this action (1-3).</summary>
    public int CurrentMarksCount { get; init; }

    /// <summary>If current > 3, this is the mark that was replaced; otherwise null.</summary>
    public QuarryMark? ReplacedMark { get; init; }

    /// <summary>When the mark was placed (UTC).</summary>
    public DateTime MarkedAt { get; init; }
}
```

**Methods:**

| Method | Signature | Returns | Purpose |
|--------|-----------|---------|---------|
| GetDescription | `()` | `string` | Human-readable result message |
| WasReplacement | `()` | `bool` | True if oldest mark was replaced |
| GetHitBonus | `()` | `int` | Hit bonus of the created mark |

**Example Output:**

```
Hunter: "You mark the Corrupted Wolf as your quarry. +2 to hit."
// Or with replacement:
"Your oldest mark on the Corrupted Raven is replaced by your new mark on the Frostbite Spider."
```

### 4.4 ReadTheSignsResult (Value Object)

**Purpose:** Encapsulates the detailed results of the Read the Signs investigation ability.

**Properties:**

```csharp
/// <summary>
/// Result of Read the Signs investigation, containing discovered information about tracks/remains.
/// </summary>
public sealed record ReadTheSignsResult
{
    /// <summary>ID of the character performing investigation.</summary>
    public Guid InvestigatorId { get; init; }

    /// <summary>Description of the location being investigated (for context).</summary>
    public string LocationDescription { get; init; } = string.Empty;

    /// <summary>Type of creature (if identified); null if unknown.</summary>
    public string? CreatureType { get; init; }

    /// <summary>Estimated number of creatures; null if not determinable.</summary>
    public int? CreatureCount { get; init; }

    /// <summary>Estimated time passed since creature was here (e.g., "1-2 hours ago").</summary>
    public string? TimePassedEstimate { get; init; }

    /// <summary>Direction creature was heading (e.g., "northeast").</summary>
    public string? DirectionOfTravel { get; init; }

    /// <summary>Condition of creature (e.g., "bleeding", "dragging left limb").</summary>
    public string? CreatureCondition { get; init; }

    /// <summary>Quality of the tracks (fresh, recent, worn, ancient, unclear).</summary>
    public CreatureTrackType TrackQuality { get; init; }

    /// <summary>Bonus applied to skill check (+4 from Keen Senses if applicable).</summary>
    public int BonusApplied { get; init; }

    /// <summary>The skill check roll result (d20 + bonuses).</summary>
    public int SkillCheckRoll { get; init; }

    /// <summary>Difficulty class that was compared against.</summary>
    public int SkillCheckDc { get; init; }

    /// <summary>Whether the investigation succeeded (roll >= DC).</summary>
    public bool Success { get; init; }

    /// <summary>
    /// List of specific information revealed by the investigation.
    /// E.g., ["Creature size: Large", "Tracks show dragging", "Recently passed through"]
    /// </summary>
    public IReadOnlyList<string> InformationRevealed { get; init; } = new List<string>();
}
```

**Methods:**

| Method | Signature | Returns | Purpose |
|--------|-----------|---------|---------|
| GetDescription | `()` | `string` | Narrative description of findings |
| GetInformationList | `()` | `IReadOnlyList<string>` | Bulleted list of discovered facts |

---

## 5. Quarry Marks Resource System

### 5.1 Mark Lifecycle

**Mark Creation (Mark Quarry Ability):**
- Hunter targets enemy (must be within 12 spaces)
- Costs 1 AP and 1 Quarry Mark slot
- Instant resolution (no save/check)
- If at max marks (3), oldest mark is automatically replaced (FIFO)
- Mark gains +2 to hit bonus immediately

**Mark Persistence:**
- Marks persist for entire encounter duration
- Marks clear at end of encounter
- Marks clear if target is defeated/escapes
- Tier 2+ abilities may extend or modify marks

**Mark Expiration:**
- Marks do NOT auto-expire by turn count in v0.20.7a
- Tier 2 abilities (Predator's Patience, Trap Mastery) add expiration mechanics
- Encounter end: all marks cleared

### 5.2 Max Marks (3) Behavior

**Below Capacity:**
- Mark added immediately
- No replacement occurs
- All existing marks remain valid

**At Capacity (3 marks):**
- New mark triggers replacement
- **FIFO (First In, First Out):** Oldest mark removed
- New mark added to end of list
- Notification: "Your oldest mark on [target] is replaced by [new target]."

**Implementation Note:**
```csharp
public bool AddMark(QuarryMark newMark)
{
    if (CurrentMarkCount >= MaxMarks)
    {
        // Oldest mark is at index 0
        var oldestMark = ActiveMarks[0];
        RemoveMark(oldestMark.TargetId);
        // Now add the new mark
    }

    ActiveMarks.Add(newMark);
    LastMarkGainedAt = DateTime.UtcNow;
    MarkGainedThisTurn = true;
    return true;
}
```

---

## 6. Tier 1 Abilities Specification

### 6.1 Mark Quarry (Active)

**Ability ID:** `VeiðimaðrAbilityId.MarkQuarry`

**Action Economy:**
- **Cost:** 1 AP
- **Resource:** 1 Quarry Mark slot
- **Range:** 12 spaces (ranged attack range)
- **Target:** Single enemy
- **Resolution:** Instant (no attack roll required)

**Mechanical Effects:**

```
Effect: Creates a Quarry Mark on target enemy
• Hit Bonus: +2 to all attacks against marked target
• Duration: Entire encounter
• Max Active: 3 marks per hunter
• Replacement: FIFO when exceeding max

No Cost Refund: If mark is immediately replaced, no AP/slot refund
```

**Targeting Rules:**
- Target must be visible and within 12 spaces
- Target must be hostile (combatant status)
- Cannot mark allies
- Cannot mark same target twice (refreshes existing mark instead)

**Resolution Logic:**

```
1. Verify 1 AP available
2. Verify target is valid (hostile, in range, visible)
3. Check if mark slot available
4. Create new QuarryMark
5. Call IQuarryMarksService.AddMark(quarryMark)
   - If at capacity, oldest mark replaced (silent to target)
6. Return MarkQuarryResult
7. Apply +2 hit bonus to future attacks
```

**User-Facing Message:**

Success:
```
> You mark the Corrupted Wolf as your quarry.
> [Your attacks against Corrupted Wolf gain +2 to hit.]
```

At capacity with replacement:
```
> Your oldest mark on the Skeletal Archer is replaced by your new mark on the Frostbite Spider.
> [Your attacks against Frostbite Spider gain +2 to hit.]
```

### 6.2 Keen Senses (Passive)

**Ability ID:** `VeiðimaðrAbilityId.KeenSenses`

**Action Economy:**
- **Cost:** Passive (always active, no AP)
- **Range:** Self
- **Duration:** Permanent

**Mechanical Effects:**

```
Effect: Always active passive bonus
• Perception Checks: +1 to all Perception checks
• Investigation Checks: +1 to all Investigation checks
• Track Detection: +1 to detect tracks/remains
• Bonus Type: Passive (no action required)

Stack Behavior:
• Stacks with other bonuses (armor, spells, etc.)
• Applied before roll resolution
• Always active (even when incapacitated)
```

**Application Rules:**
- Applied to any skill check involving perception/investigation
- Applied during Read the Signs ability (cumulative with ability's own bonus)
- Applied to spot hidden enemies/traps
- Applied to Search actions

**Implementation:**

```csharp
public class KeenSensesAbility : IAbility
{
    public int GetPerceptionBonus(Character hunter)
    {
        return 1; // Always +1
    }

    public int GetInvestigationBonus(Character hunter)
    {
        return 1; // Always +1
    }
}
```

**Examples:**

```
Scenario 1 - Perception Check:
Hunter finds: 1d20 + [Wisdom mod +2] + [Keen Senses +1]
Result uses total modifier

Scenario 2 - Read the Signs (stacks):
Skill Check: 1d20 + [Tracking skill +3] + [Keen Senses +1] + [Ability bonus +4]
Total bonus: +8 before roll
```

### 6.3 Read the Signs (Active)

**Ability ID:** `VeiðimaðrAbilityId.ReadTheSigns`

**Action Economy:**
- **Cost:** 1 AP
- **Range:** Touch (must be adjacent to tracks/remains)
- **Duration:** Instant resolution
- **Target:** Creature tracks, remains, blood, spoor, etc.

**Mechanical Effects:**

```
Effect: Investigate creature signs to gain knowledge
• Skill Check: 1d20 + [Tracking/Survival skill] + [Keen Senses +1] + [Ability bonus +4]
• DC: Determined by track age and clarity (see below)
• Base Bonus: +4 (independent of Keen Senses)
• Total Bonus to Check: +1 (Keen Senses) + 4 (ability) = +5 total from Veiðimaðr abilities

Success reveals:
✓ Creature type (if success)
✓ Approximate number (if success)
✓ Time passed since creature was here
✓ Direction creature was heading
✓ Creature's condition (injured, carrying prey, etc.)

Failure reveals:
✗ None of the above (vague impressions only)
```

**DC Scaling by Track Quality:**

| Track Quality | Age | DC | Success % (avg d20 + 5) |
|---------------|-----|----|-----------------------|
| Fresh | 0-1 hour | 10 | 75% |
| Recent | 1-6 hours | 12 | 65% |
| Worn | 6-24 hours | 15 | 50% |
| Ancient | 24+ hours | 18 | 35% |
| Unclear | Degraded | 20 | 25% |

**Information Revealed on Success:**

The ability returns a `ReadTheSignsResult` with discovered facts:

```csharp
var result = new ReadTheSignsResult
{
    CreatureType = "Corrupted Wolf", // If fresh enough
    CreatureCount = 2,                // If clear prints
    TimePassedEstimate = "1-2 hours ago",
    DirectionOfTravel = "Northeast toward the highlands",
    CreatureCondition = "Healthy, large specimen",
    TrackQuality = CreatureTrackType.Recent,
    Success = true,
    InformationRevealed = new[]
    {
        "Two wolves passed through here",
        "Tracks are 1-2 hours old",
        "One is significantly larger than the other",
        "Heading: northeast",
        "No signs of blood or injury"
    }
};
```

**Information Revealed on Failure:**

```csharp
var result = new ReadTheSignsResult
{
    CreatureType = null,
    CreatureCount = null,
    TimePassedEstimate = null,
    DirectionOfTravel = null,
    CreatureCondition = null,
    TrackQuality = CreatureTrackType.Unclear,
    Success = false,
    InformationRevealed = new[]
    {
        "There are definitely tracks here...",
        "But you cannot determine what made them."
    }
};
```

**Usage Example:**

```
> read the signs at tracks
> [Making tracking check: 1d20 + 5]
> [Roll: 14 + 5 = 19 vs DC 12 for Recent tracks]
>
> You kneel beside the spoor and study it carefully.
> [Discovered]
> - Two wolves passed through here
> - Tracks are 1-2 hours old
> - One is significantly larger than the other
> - Heading: northeast
> - No signs of blood or injury
```

---

## 7. User Stories

### User Story 1: Marking the Quarry

**As a** Veiðimaðr player,
**I want to** quickly designate an enemy as my quarry,
**So that** I can gain tactical advantage against priority targets.

**Acceptance Criteria:**
- [ ] Mark Quarry ability costs 1 AP
- [ ] Ability targets single enemy within 12 spaces
- [ ] Marked target gains +2 to hit bonus
- [ ] Can mark up to 3 enemies simultaneously
- [ ] Oldest mark is automatically replaced when exceeding 3
- [ ] Player receives clear feedback about mark placement/replacement

### User Story 2: Enhanced Perception from Keen Senses

**As a** Veiðimaðr player,
**I want to** receive passive +1 bonus to perception checks,
**So that** I can spot threats and track prey more effectively.

**Acceptance Criteria:**
- [ ] Keen Senses provides +1 to Perception checks
- [ ] Keen Senses provides +1 to Investigation checks
- [ ] Bonus applies automatically (no action required)
- [ ] Bonus is visible in character sheet
- [ ] Bonus stacks with other modifiers

### User Story 3: Reading Environmental Signs

**As a** Veiðimaðr player,
**I want to** investigate tracks and remains to learn about creatures,
**So that** I can make informed decisions about pursuing or avoiding prey.

**Acceptance Criteria:**
- [ ] Read the Signs costs 1 AP
- [ ] Requires touch range to target (adjacent)
- [ ] Makes skill check (1d20 + bonuses vs DC)
- [ ] Success reveals creature type, count, direction, condition, time passed
- [ ] Failure reveals no useful information
- [ ] DC scales with track age/quality

---

## 8. Application Service Layer

### 8.1 IQuarryMarksService Interface

**Purpose:** Manages creation, removal, and querying of Quarry Marks.

```csharp
/// <summary>
/// Service for managing Quarry Marks resource for Veiðimaðr specialization.
/// Handles mark creation, removal, querying, and lifecycle.
/// </summary>
public interface IQuarryMarksService
{
    /// <summary>
    /// Gets the current quarry marks resource for a character.
    /// </summary>
    Task<QuarryMarksResource> GetCurrentMarksAsync(Guid characterId);

    /// <summary>
    /// Adds a new mark to the hunter's quarry marks collection.
    /// If at capacity, replaces oldest mark (FIFO).
    /// </summary>
    Task<MarkQuarryResult> AddMarkAsync(
        Guid hunterId,
        Guid targetId,
        string targetName,
        Guid? encounterId = null);

    /// <summary>
    /// Removes a specific mark by target ID.
    /// </summary>
    Task<bool> RemoveMarkAsync(Guid characterId, Guid targetId);

    /// <summary>
    /// Checks if a target is currently marked.
    /// </summary>
    Task<bool> HasActiveMark(Guid characterId, Guid targetId);

    /// <summary>
    /// Gets a specific mark for a target, or null if not marked.
    /// </summary>
    Task<QuarryMark?> GetMarkForAsync(Guid characterId, Guid targetId);

    /// <summary>
    /// Gets the oldest mark (next to be replaced).
    /// </summary>
    Task<QuarryMark?> GetOldestMarkAsync(Guid characterId);

    /// <summary>
    /// Checks if hunter can add another mark (below capacity).
    /// </summary>
    Task<bool> CanAddMarkAsync(Guid characterId);

    /// <summary>
    /// Removes all marks (e.g., encounter end).
    /// </summary>
    Task<int> ClearAllMarksAsync(Guid characterId);

    /// <summary>
    /// Removes marks that have expired (Tier 2+ feature).
    /// Returns count of marks removed.
    /// </summary>
    Task<int> ClearExpiredMarksAsync(Guid characterId);

    /// <summary>
    /// Gets total number of active marks.
    /// </summary>
    Task<int> GetMarkCountAsync(Guid characterId);

    /// <summary>
    /// Called at end of turn to increment TurnsActive on all marks.
    /// </summary>
    Task RefreshMarksAsync(Guid characterId);
}
```

### 8.2 IVeiðimaðrAbilityService Interface

**Purpose:** Executes Veiðimaðr abilities and validates usage.

```csharp
/// <summary>
/// Service for executing Veiðimaðr abilities.
/// Handles ability resolution, validation, and result generation.
/// </summary>
public interface IVeiðimaðrAbilityService
{
    /// <summary>
    /// Executes Mark Quarry ability.
    /// </summary>
    Task<MarkQuarryResult> ExecuteMarkQuarryAsync(
        Guid hunterId,
        Guid targetId,
        Guid? encounterId = null);

    /// <summary>
    /// Applies Keen Senses passive bonus.
    /// Returns the +1 bonus value.
    /// </summary>
    int ApplyKeenSenses(Guid hunterId);

    /// <summary>
    /// Executes Read the Signs investigation ability.
    /// </summary>
    Task<ReadTheSignsResult> ExecuteReadTheSignsAsync(
        Guid investigatorId,
        string trackLocation,
        CreatureTrackType trackQuality);

    /// <summary>
    /// Validates ability can be executed (AP, range, target validity).
    /// </summary>
    Task<(bool IsValid, string? ErrorMessage)> ValidateAbilityUsageAsync(
        Guid hunterId,
        VeiðimaðrAbilityId abilityId,
        Guid? targetId = null,
        int? distance = null);

    /// <summary>
    /// Gets AP cost for ability.
    /// </summary>
    int GetAbilityCost(VeiðimaðrAbilityId abilityId);

    /// <summary>
    /// Gets resource cost for ability (e.g., mark slots, etc).
    /// </summary>
    int GetResourceCost(VeiðimaðrAbilityId abilityId);

    /// <summary>
    /// Gets human-readable ability description.
    /// </summary>
    string GetAbilityDescription(VeiðimaðrAbilityId abilityId);

    /// <summary>
    /// Resolves the hit bonus for marked target.
    /// </summary>
    int ResolveMarkBonus(Guid hunterId, Guid targetId);

    /// <summary>
    /// Resolves perception/investigation bonus.
    /// </summary>
    int ResolvePerceptionBonus(Guid hunterId);

    /// <summary>
    /// Investigates target for Read the Signs.
    /// </summary>
    Task<ReadTheSignsResult> InvestigateTargetAsync(
        Guid investigatorId,
        string trackLocation,
        CreatureTrackType trackQuality);
}
```

---

## 9. Configuration Specifications

### 9.1 specializations.json Entry

Location: `/rune-rust/src/data/specializations.json`

```json
{
  "id": "veiðimaðr",
  "displayName": "Veiðimaðr",
  "pronunciation": "VAY-thee-math-ur",
  "translation": "Hunter (Old Norse)",
  "archetype": "Skirmisher",
  "pathType": "Coherent",
  "description": "Master of the Hunt. The Veiðimaðr is a tracker and ranged combat specialist who marks quarry and exploits every weakness through patience and precision.",
  "lore": "Every creature leaves a trail. Every trail has an end. The Veiðimaðr are the patient predators of Aethelgard, masters of pursuit and the inevitable taking of prey.",
  "tagline": "Master of the Hunt",
  "role": "Hunter / Tracker / Ranged Combat",
  "specialResource": {
    "name": "Quarry Marks",
    "maxValue": 3,
    "description": "Designated enemies you track with bonuses"
  },
  "unlockCost": 0,
  "unlockRequirement": "Skirmisher",
  "tier1AbilityIds": ["mark-quarry", "keen-senses", "read-the-signs"],
  "tier2AbilityIds": ["hunters-eye", "trap-mastery", "predators-patience"],
  "tier3AbilityIds": ["apex-predator", "crippling-shot"],
  "capstoneAbilityId": "the-perfect-hunt",
  "correlationToMyrk": "Contrast: Coherent vs Heretical | Similar: both Skirmishers",
  "balanceNotes": "No corruption risk; relies on tactical mark placement and skill bonuses rather than resource management."
}
```

### 9.2 abilities.json Entries for Tier 1

Location: `/rune-rust/src/data/abilities.json`

```json
[
  {
    "id": "mark-quarry",
    "displayName": "Mark Quarry",
    "abilityType": "Active",
    "tier": 1,
    "specialization": "veiðimaðr",
    "description": "Designate an enemy within 12 spaces as your quarry, gaining +2 to hit against them.",
    "actionPointCost": 1,
    "resourceCost": {
      "type": "QuarryMarkSlot",
      "amount": 1
    },
    "range": 12,
    "rangeType": "spaces",
    "targetType": "SingleEnemy",
    "resolution": "Instant",
    "effects": [
      {
        "type": "ApplyBuff",
        "target": "MarkedEnemy",
        "buff": "Quarry Mark",
        "duration": "UntilEncounterEnd",
        "bonuses": {
          "hitBonus": 2
        }
      }
    ],
    "corruptionRisk": 0,
    "tags": ["targeting", "buff-application", "mark", "coherent"],
    "prerequisites": []
  },
  {
    "id": "keen-senses",
    "displayName": "Keen Senses",
    "abilityType": "Passive",
    "tier": 1,
    "specialization": "veiðimaðr",
    "description": "Always active. Gain +1 to Perception and Investigation checks.",
    "actionPointCost": 0,
    "resourceCost": null,
    "range": 0,
    "rangeType": "Self",
    "targetType": "Self",
    "resolution": "Passive",
    "effects": [
      {
        "type": "PassiveBonus",
        "skill": "Perception",
        "bonus": 1
      },
      {
        "type": "PassiveBonus",
        "skill": "Investigation",
        "bonus": 1
      }
    ],
    "corruptionRisk": 0,
    "tags": ["passive", "perception", "investigation", "coherent"],
    "prerequisites": []
  },
  {
    "id": "read-the-signs",
    "displayName": "Read the Signs",
    "abilityType": "Active",
    "tier": 1,
    "specialization": "veiðimaðr",
    "description": "Investigate tracks or remains to learn about creatures. Costs 1 AP, requires touch range. Makes skill check with +4 bonus.",
    "actionPointCost": 1,
    "resourceCost": null,
    "range": 1,
    "rangeType": "touch",
    "targetType": "Tracks/Remains",
    "resolution": "SkillCheckResolvedByDC",
    "skillCheckBonus": 4,
    "dcScaling": [
      {
        "condition": "Fresh (0-1 hour)",
        "dc": 10
      },
      {
        "condition": "Recent (1-6 hours)",
        "dc": 12
      },
      {
        "condition": "Worn (6-24 hours)",
        "dc": 15
      },
      {
        "condition": "Ancient (24+ hours)",
        "dc": 18
      },
      {
        "condition": "Unclear/Degraded",
        "dc": 20
      }
    ],
    "successOutcome": [
      "Creature type (if determinable)",
      "Approximate number of creatures",
      "Time passed since creature was here",
      "Direction of travel",
      "Creature's condition (injured, carrying prey, etc.)"
    ],
    "failureOutcome": [
      "No useful information revealed"
    ],
    "corruptionRisk": 0,
    "tags": ["investigation", "skill-check", "information-gathering", "coherent"],
    "prerequisites": []
  }
]
```

---

## 10. Code Examples & Implementation

### 10.1 QuarryMarksResource Implementation

```csharp
/// <summary>
/// Complete implementation of QuarryMarksResource value object.
/// </summary>
public sealed record QuarryMarksResource
{
    private readonly List<QuarryMark> _activeMarks = new();

    public IReadOnlyList<QuarryMark> ActiveMarks => _activeMarks.AsReadOnly();
    public int MaxMarks { get; init; } = 3;
    public int CurrentMarkCount => _activeMarks.Count;
    public bool MarkGainedThisTurn { get; private set; }
    public DateTime? LastMarkGainedAt { get; private set; }
    public Guid? EncounterId { get; private set; }
    public DateTime LastUpdatedAt { get; private set; } = DateTime.UtcNow;

    /// <summary>
    /// Adds a new mark; replaces oldest if at capacity.
    /// </summary>
    public bool AddMark(QuarryMark mark)
    {
        if (mark == null)
            throw new ArgumentNullException(nameof(mark));

        // If at capacity, remove oldest
        if (_activeMarks.Count >= MaxMarks)
        {
            _activeMarks.RemoveAt(0); // FIFO: oldest is at index 0
        }

        _activeMarks.Add(mark);
        LastMarkGainedAt = DateTime.UtcNow;
        MarkGainedThisTurn = true;
        LastUpdatedAt = DateTime.UtcNow;

        return true;
    }

    /// <summary>
    /// Removes a specific mark by target ID.
    /// </summary>
    public bool RemoveMark(Guid targetId)
    {
        var markToRemove = _activeMarks.FirstOrDefault(m => m.TargetId == targetId);
        if (markToRemove == null)
            return false;

        _activeMarks.Remove(markToRemove);
        LastUpdatedAt = DateTime.UtcNow;
        return true;
    }

    /// <summary>
    /// Checks if a target is currently marked.
    /// </summary>
    public bool HasMark(Guid targetId) =>
        _activeMarks.Any(m => m.TargetId == targetId && m.Status == QuarryStatus.Active);

    /// <summary>
    /// Gets a specific mark for a target.
    /// </summary>
    public QuarryMark? GetMark(Guid targetId) =>
        _activeMarks.FirstOrDefault(m => m.TargetId == targetId);

    /// <summary>
    /// Gets the oldest mark (first in FIFO queue).
    /// </summary>
    public QuarryMark? GetOldestMark() =>
        _activeMarks.FirstOrDefault();

    /// <summary>
    /// Checks if another mark can be added without replacement.
    /// </summary>
    public bool CanAddMark() =>
        _activeMarks.Count < MaxMarks;

    /// <summary>
    /// Clears all marks.
    /// </summary>
    public void ClearAllMarks()
    {
        _activeMarks.Clear();
        LastUpdatedAt = DateTime.UtcNow;
    }

    /// <summary>
    /// Clears expired marks and returns count removed.
    /// </summary>
    public int ClearExpiredMarks()
    {
        var expiredCount = _activeMarks.Count(m => m.IsExpired());
        _activeMarks.RemoveAll(m => m.IsExpired());
        if (expiredCount > 0)
            LastUpdatedAt = DateTime.UtcNow;
        return expiredCount;
    }

    /// <summary>
    /// Increments turn counter on all marks.
    /// </summary>
    public void RefreshMarksForNewTurn()
    {
        foreach (var mark in _activeMarks)
        {
            mark.IncrementTurn();
        }
        MarkGainedThisTurn = false;
        LastUpdatedAt = DateTime.UtcNow;
    }
}
```

### 10.2 QuarryMarksService Implementation

```csharp
/// <summary>
/// Service for managing Quarry Marks resource.
/// </summary>
public class QuarryMarksService : IQuarryMarksService
{
    private readonly ICharacterRepository _characterRepository;
    private readonly ILogger<QuarryMarksService> _logger;

    public QuarryMarksService(
        ICharacterRepository characterRepository,
        ILogger<QuarryMarksService> logger)
    {
        _characterRepository = characterRepository ?? throw new ArgumentNullException(nameof(characterRepository));
        _logger = logger ?? throw new ArgumentNullException(nameof(logger));
    }

    public async Task<QuarryMarksResource> GetCurrentMarksAsync(Guid characterId)
    {
        var character = await _characterRepository.GetByIdAsync(characterId)
            ?? throw new InvalidOperationException($"Character {characterId} not found");

        // Retrieve or initialize quarry marks resource
        var specialization = character.GetSpecialization() as VeiðimaðrSpecialization;
        return specialization?.QuarryMarksResource ?? new QuarryMarksResource();
    }

    public async Task<MarkQuarryResult> AddMarkAsync(
        Guid hunterId,
        Guid targetId,
        string targetName,
        Guid? encounterId = null)
    {
        var hunter = await _characterRepository.GetByIdAsync(hunterId)
            ?? throw new InvalidOperationException($"Hunter {hunterId} not found");

        var quarryResource = await GetCurrentMarksAsync(hunterId);

        // Check current state before adding
        int previousCount = quarryResource.CurrentMarkCount;
        QuarryMark? replacedMark = null;

        if (previousCount >= quarryResource.MaxMarks)
        {
            replacedMark = quarryResource.GetOldestMark();
        }

        // Create new mark
        var newMark = new QuarryMark
        {
            MarkId = Guid.NewGuid(),
            TargetId = targetId,
            TargetName = targetName,
            MarkedAt = DateTime.UtcNow,
            MarkedBy = hunterId,
            Status = QuarryStatus.Active,
            HitBonus = 2,
            EncounterId = encounterId,
            TurnsActive = 0,
            AdditionalBonuses = new Dictionary<string, int>()
        };

        // Add mark (will auto-replace if necessary)
        quarryResource.AddMark(newMark);

        // Log action
        _logger.LogInformation(
            "Hunter {HunterId} marked target {TargetId} ({TargetName})",
            hunterId, targetId, targetName);

        // Create result
        return new MarkQuarryResult
        {
            HunterId = hunterId,
            HunterName = hunter.Name,
            TargetId = targetId,
            TargetName = targetName,
            MarkCreated = newMark,
            PreviousMarksCount = previousCount,
            CurrentMarksCount = quarryResource.CurrentMarkCount,
            ReplacedMark = replacedMark,
            MarkedAt = DateTime.UtcNow
        };
    }

    public async Task<bool> RemoveMarkAsync(Guid characterId, Guid targetId)
    {
        var quarryResource = await GetCurrentMarksAsync(characterId);
        return quarryResource.RemoveMark(targetId);
    }

    public async Task<bool> HasActiveMark(Guid characterId, Guid targetId)
    {
        var quarryResource = await GetCurrentMarksAsync(characterId);
        return quarryResource.HasMark(targetId);
    }

    public async Task<QuarryMark?> GetMarkForAsync(Guid characterId, Guid targetId)
    {
        var quarryResource = await GetCurrentMarksAsync(characterId);
        return quarryResource.GetMark(targetId);
    }

    public async Task<QuarryMark?> GetOldestMarkAsync(Guid characterId)
    {
        var quarryResource = await GetCurrentMarksAsync(characterId);
        return quarryResource.GetOldestMark();
    }

    public async Task<bool> CanAddMarkAsync(Guid characterId)
    {
        var quarryResource = await GetCurrentMarksAsync(characterId);
        return quarryResource.CanAddMark();
    }

    public async Task<int> ClearAllMarksAsync(Guid characterId)
    {
        var quarryResource = await GetCurrentMarksAsync(characterId);
        int count = quarryResource.CurrentMarkCount;
        quarryResource.ClearAllMarks();
        return count;
    }

    public async Task<int> ClearExpiredMarksAsync(Guid characterId)
    {
        var quarryResource = await GetCurrentMarksAsync(characterId);
        return quarryResource.ClearExpiredMarks();
    }

    public async Task<int> GetMarkCountAsync(Guid characterId)
    {
        var quarryResource = await GetCurrentMarksAsync(characterId);
        return quarryResource.CurrentMarkCount;
    }

    public async Task RefreshMarksAsync(Guid characterId)
    {
        var quarryResource = await GetCurrentMarksAsync(characterId);
        quarryResource.RefreshMarksForNewTurn();
    }
}
```

---

## 11. State Machine Diagrams

### 11.1 Mark Status State Machine

```
         ┌──────────────────┐
         │   UNEXECUTED     │
         │  (No mark yet)   │
         └────────┬─────────┘
                  │
                  │ Mark Quarry ability
                  │
                  ▼
         ┌──────────────────┐
         │    ACTIVE        │
         │  (+2 hit bonus)  │
         └────────┬─────────┘
                  │
      ┌───────────┼───────────┬─────────────┐
      │           │           │             │
      ▼           ▼           ▼             ▼
   ┌──────┐  ┌──────────┐ ┌──────────┐ ┌─────────┐
   │      │  │          │ │          │ │         │
   │DEFEATED│ │ESCAPED  │ │EXPIRED   │ │REPLACED │
   │        │ │         │ │(Turn max)│ │ (Max 3) │
   │        │ │         │ │          │ │         │
   └──┬─────┘ └────┬────┘ └────┬─────┘ └────┬────┘
      │             │          │            │
      └─────────────┼──────────┴────────────┘
                    │
                    ▼
         ┌──────────────────┐
         │   CLEARED        │
         │ (Mark removed)   │
         │ (Slot freed)     │
         └──────────────────┘
```

---

## 12. Coherent Path Safety

### 12.1 Corruption Risk: Zero

As a Coherent specialization, Veiðimaðr abilities carry **NO corruption risk**:

| Scenario | Corruption Triggered | Reason |
|----------|---------------------|--------|
| Mark an enemy | NO | Skill-based action, no dark pact |
| Hunting Heretical creatures | NO | Coherent hunters oppose corruption |
| Using Keen Senses on Glitched areas | NO | Observation, not power-drawing |
| Executing trapped prey | NO | Practical hunting, not desecration |
| Marking allies by mistake | NO | No corruption mechanics anywhere |

**Design Rationale:**

The Veiðimaðr represents a philosophically opposed approach to the Myrk-gengr. Where Myrk-gengr draws power from corrupted shadow (creating Corruption risk), the Veiðimaðr relies purely on:

- Learned tracking skills
- Tactical observation
- Patience and positioning
- Practical hunting knowledge

Therefore, **all Veiðimaðr abilities are explicitly excluded from ANY corruption evaluation**.

---

## 13. Logging Specifications

### 13.1 Log Levels and Messages

```csharp
// INFO: Ability execution
_logger.LogInformation(
    "Veiðimaðr {HunterId} executed Mark Quarry on target {TargetId} ({TargetName}). " +
    "Marks: {PreviousCount}/{MaxMarks} → {CurrentCount}/{MaxMarks}",
    hunterId, targetId, targetName, previousCount, maxMarks, currentCount);

// INFO: Mark replacement
_logger.LogInformation(
    "Veiðimaðr {HunterId} mark on {OldTargetId} ({OldTargetName}) replaced by new mark on {NewTargetId} ({NewTargetName})",
    hunterId, oldTargetId, oldTargetName, newTargetId, newTargetName);

// DEBUG: Keen Senses application
_logger.LogDebug(
    "Keen Senses (+1) applied to perception check for {HunterId}",
    hunterId);

// INFO: Read the Signs investigation
_logger.LogInformation(
    "Veiðimaðr {InvestigatorId} read signs at {Location}. " +
    "Roll: {Roll} vs DC {DC}. Success: {Success}. Revealed: {InformationCount} facts.",
    investigatorId, location, roll, dc, success, informationCount);

// DEBUG: Mark lifecycle
_logger.LogDebug(
    "Mark {MarkId} on target {TargetId}: Status={Status}, TurnsActive={TurnsActive}",
    markId, targetId, status, turnsActive);
```

---

## 14. Unit Testing Requirements

### 14.1 Test Classes and Method Signatures

```csharp
public class QuarryMarksResourceTests
{
    [Fact]
    public void AddMark_BelowCapacity_AddsMarkSuccessfully()

    [Fact]
    public void AddMark_AtCapacity_ReplacesFIFOMark()

    [Fact]
    public void RemoveMark_ValidTarget_RemovesAndFreesSlot()

    [Fact]
    public void RemoveMark_InvalidTarget_ReturnsFalse()

    [Fact]
    public void HasMark_ActiveMark_ReturnsTrue()

    [Fact]
    public void HasMark_NoActiveMark_ReturnsFalse()

    [Fact]
    public void GetOldestMark_WithMarks_ReturnsFirstMark()

    [Fact]
    public void ClearAllMarks_RemovesAllMarks()
}

public class QuarryMarksServiceTests
{
    [Fact]
    public async Task AddMarkAsync_ValidTarget_CreatesMarkAndReturnsResult()

    [Fact]
    public async Task AddMarkAsync_ExceedingCapacity_ReplacesOldestAndReturnsReplacement()

    [Fact]
    public async Task HasActiveMark_MarkedTarget_ReturnsTrue()

    [Fact]
    public async Task GetMarkCountAsync_WithMarks_ReturnsCorrectCount()
}

public class MarkQuarryAbilityTests
{
    [Fact]
    public async Task ExecuteMarkQuarry_ValidTarget_AppliesHitBonus()

    [Fact]
    public async Task ExecuteMarkQuarry_OutOfRange_FailsValidation()

    [Fact]
    public async Task ExecuteMarkQuarry_NoAPAvailable_FailsValidation()
}

public class KeenSensesAbilityTests
{
    [Fact]
    public void ApplyKeenSenses_PerceptionCheck_Adds1Bonus()

    [Fact]
    public void ApplyKeenSenses_InvestigationCheck_Adds1Bonus()

    [Fact]
    public void ApplyKeenSenses_StacksWithOtherBonuses()
}

public class ReadTheSignsAbilityTests
{
    [Fact]
    public async Task ExecuteReadTheSigns_FreshTracks_SucceedsAtDC10()

    [Fact]
    public async Task ExecuteReadTheSigns_AncientTracks_FailsAtDC18()

    [Fact]
    public async Task ExecuteReadTheSigns_Success_RevealsInformation()

    [Fact]
    public async Task ExecuteReadTheSigns_Failure_RevealsNothing()

    [Fact]
    public async Task ExecuteReadTheSigns_IncludesKeenSensesBonus()
}
```

---

## 15. Deliverable Checklist

- [ ] **Domain Value Objects**
  - [ ] QuarryMarksResource implemented with all methods
  - [ ] QuarryMark implemented with all properties
  - [ ] MarkQuarryResult implemented
  - [ ] ReadTheSignsResult implemented

- [ ] **Domain Enums**
  - [ ] VeiðimaðrAbilityId with all 9 ability IDs
  - [ ] QuarryStatus with all states
  - [ ] CreatureTrackType with all track qualities

- [ ] **Application Services**
  - [ ] IQuarryMarksService interface
  - [ ] QuarryMarksService implementation
  - [ ] IVeiðimaðrAbilityService interface
  - [ ] VeiðimaðrAbilityService implementation

- [ ] **Ability Implementations**
  - [ ] Mark Quarry ability (active, 1 AP, +2 hit)
  - [ ] Keen Senses ability (passive, +1 perception/investigation)
  - [ ] Read the Signs ability (active, 1 AP, skill check)

- [ ] **Configuration**
  - [ ] specializations.json entry for Veiðimaðr
  - [ ] abilities.json entries for all 3 Tier 1 abilities

- [ ] **Tests**
  - [ ] ~10 unit tests covering services and abilities
  - [ ] QuarryMarksResource tests (mark creation, replacement, removal)
  - [ ] QuarryMarksService tests (async operations)
  - [ ] Ability execution tests (Mark Quarry, Keen Senses, Read the Signs)
  - [ ] Integration tests (ability → service → resource)

---

## 16. Acceptance Criteria

### General Criteria

- [ ] All code follows established patterns from Myrk-gengr (v0.20.4a)
- [ ] All classes have XML documentation with `/// <summary>` tags
- [ ] All public methods documented with parameters and return values
- [ ] No corruption checks anywhere in Veiðimaðr code
- [ ] Coherent path explicitly verified in configuration

### Mark Quarry Ability Criteria

- [ ] Costs 1 AP per execution
- [ ] Targets single enemy within 12 spaces
- [ ] Applies +2 hit bonus to marked target
- [ ] Maintains max 3 marks simultaneously
- [ ] Replaces oldest mark (FIFO) when exceeding max
- [ ] Player receives clear feedback on marking/replacement
- [ ] Mark persists until encounter end

### Keen Senses Ability Criteria

- [ ] Applies +1 to all Perception checks
- [ ] Applies +1 to all Investigation checks
- [ ] Passive (always active, no AP cost)
- [ ] Stacks with other bonuses
- [ ] Visible in character sheet

### Read the Signs Ability Criteria

- [ ] Costs 1 AP per execution
- [ ] Requires touch range (adjacent to tracks)
- [ ] Makes 1d20 + [skill] + 1 (Keen Senses) + 4 (ability) skill check
- [ ] DC scales by track age/quality (10-20 range)
- [ ] Success reveals creature type, count, direction, condition, time
- [ ] Failure reveals no information
- [ ] Results formatted clearly for player

### Unit Test Criteria

- [ ] Minimum 10 tests (targeting 10-12 for v0.20.7a)
- [ ] All service methods covered
- [ ] All ability execution paths tested
- [ ] Edge cases handled (at capacity, out of range, failed checks)
- [ ] Async operations properly awaited
- [ ] Mocking/dependency injection properly used

---

## 17. Dependencies & Prerequisites

### Prerequisites (Must be completed first)

1. **v0.17.4 Specialization Framework** - Core specialization registration system
2. **v0.18.x Corruption Framework** - Even though Veiðimaðr has zero corruption, the framework must exist for contrast
3. **v0.19.x Character Sheet Updates** - To display Quarry Marks resource
4. **Encounter System** - To track encounter context for marks
5. **Combat System** - To apply +2 hit bonus to attack rolls

### External Dependencies

| Dependency | Type | Purpose |
|-----------|------|---------|
| `ICharacterRepository` | Service | Retrieve/persist character data |
| `IEncounterService` | Service | Determine encounter context |
| `ICombatService` | Service | Apply hit bonuses to attacks |
| `ILogger<T>` | Framework | Logging |
| `IAbilityService` (v0.17.4) | Service | Base ability execution |

### Internal Dependencies

| Module | Used By | Purpose |
|--------|---------|---------|
| Domain Value Objects | Services | Resource representation |
| QuarryMarksService | VeiðimaðrAbilityService | Mark management |
| VeiðimaðrAbilityService | Combat/Encounter systems | Ability resolution |

---

## 18. Design Decisions & Rationale

### Decision 1: Coherent Path vs Heretical Path

**Decision:** Veiðimaðr is Coherent (no corruption); Myrk-gengr is Heretical (with corruption).

**Rationale:** The v0.20.x series needs both philosophical approaches within Skirmisher archetype to provide player choice. Coherent path represents skill-based hunting; Heretical represents power-drawing from shadow. Both are valid but have different risk profiles.

**Alternatives Considered:**
- Both Coherent (boring, no contrast)
- Both Heretical (misses design goal of philosophical diversity)

### Decision 2: Mark Replacement (FIFO)

**Decision:** When exceeding 3 marks, replace oldest automatically (FIFO queue, not player choice).

**Rationale:** FIFO is simpler for players to understand and predict. The oldest mark being least relevant is game-design sound.

**Alternatives Considered:**
- Let player choose which mark to replace (too complex for UI)
- Prevent marking when at capacity (too restrictive)

### Decision 3: +2 Hit Bonus (not stacking)

**Decision:** Each mark provides flat +2 hit bonus; does not stack with additional marks on same target.

**Rationale:** Prevents exploitation of marking same target multiple times. Tier 2 abilities add more complex stacking.

**Alternatives Considered:**
- Allow stacking (e.g., +2 per mark) - breaks balance
- Allow targeting marked targets for additional marks (confusing)

### Decision 4: Quarry Marks as Slot-Based Resource

**Decision:** Quarry Marks implemented as numbered slots (1/3 active), not regenerating resource like Shadow Essence.

**Rationale:** Thematically, hunters can only track so many prey simultaneously. Operationally, limits mark spam and encourages tactical decision-making.

**Alternatives Considered:**
- Time-based regeneration (like Shadow Essence) - doesn't fit hunting theme
- Unlimited marks (broken balance)

---

## 19. Risk Assessment

| Risk | Severity | Likelihood | Mitigation |
|------|----------|-----------|-----------|
| **Hit bonus stacking with other buffs breaks balance** | High | Medium | Cap total hit bonus to +5 max in combat system; test extensively |
| **Read the Signs DC scaling too harsh** | Medium | Low | Playtest with varying skill values; adjust DC if needed |
| **Mark replacement confuses players** | Medium | Medium | Clear UI feedback when replacement occurs; include in tutorial |
| **Marks persist too long, become mandatory** | Medium | Low | Tier 2 adds expiration mechanics; monitor playtime data |
| **Keen Senses +1 bonus irrelevant in late game** | Low | Medium | Tier 2/3 abilities scale perception bonuses; by design |
| **Service async operations deadlock** | High | Low | Thorough testing with concurrent marks; proper async/await |

---

## 20. Implementation Notes

### 20.1 Priority Order

1. Create value objects (QuarryMarksResource, QuarryMark, etc.)
2. Create enums (VeiðimaðrAbilityId, QuarryStatus, CreatureTrackType)
3. Implement IQuarryMarksService and QuarryMarksService
4. Implement IVeiðimaðrAbilityService and VeiðimaðrAbilityService
5. Create ability implementations (Mark Quarry, Keen Senses, Read the Signs)
6. Add configuration entries
7. Write unit tests

### 20.2 Testing Strategy

1. **Unit Tests First** - Test value objects in isolation
2. **Service Tests** - Test service methods with mocked dependencies
3. **Ability Tests** - Test ability execution end-to-end
4. **Integration Tests** - Test ability → service → combat system flow

---

**End of v0.20.7a Design Specification**
