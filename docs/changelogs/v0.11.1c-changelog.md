# v0.11.1c Changelog: Recipe Discovery

**Version:** 0.11.1c
**Phase:** Recipe Discovery (Recipe Scrolls & Loot Integration)
**Date:** 2026-01-19
**Status:** ✅ Complete

---

## Summary

Implements the Recipe Discovery system enabling players to find recipe scrolls as loot throughout the dungeon. When used, scrolls teach new crafting recipes to players, expanding their crafting capabilities. The system integrates with the loot service to generate scrolls based on dungeon level and loot source.

This version connects recipe knowledge (v0.11.1b) to the loot system, enabling organic recipe discovery through gameplay exploration.

---

## Added

### Domain Layer - Enums

| Enum | Description |
|------|-------------|
| `LootSourceType` | Types of loot sources (Chest, Boss, Monster, Quest, Shop, Crafting) |
| `DiscoverySource` | How recipes are discovered (Scroll, Trainer, Quest, Experimentation, Default) |
| `ItemEffect.LearnRecipe` | New effect type for recipe scroll items |

#### LootSourceType Values

| Value | Description |
|-------|-------------|
| `Chest` | Treasure chests found in rooms |
| `Boss` | Boss monster drops |
| `Monster` | Regular monster drops |
| `Quest` | Quest completion rewards |
| `Shop` | Purchased from vendors |
| `Crafting` | Created through crafting |

#### DiscoverySource Values

| Value | Description |
|-------|-------------|
| `Scroll` | Learned from a recipe scroll |
| `Trainer` | Taught by an NPC trainer |
| `Quest` | Rewarded by quest completion |
| `Experimentation` | Discovered through experimentation |
| `Default` | Known from character creation |

### Domain Layer - Item Extension

| Change | Description |
|--------|-------------|
| `Item.RecipeId` | Property for recipe scroll items (nullable) |
| `Item.IsRecipeScroll` | Computed property (LearnRecipe effect + non-null RecipeId) |
| `Item.CreateRecipeScroll()` | Factory method for creating recipe scrolls |

#### CreateRecipeScroll Parameters

| Parameter | Type | Description |
|-----------|------|-------------|
| `recipeId` | `string` | Recipe identifier (normalized to lowercase) |
| `recipeName` | `string` | Display name for scroll title/description |
| `baseValue` | `int` | Gold value of scroll (default: 100) |

### Domain Layer - Value Objects

| Value Object | Description |
|--------------|-------------|
| `RecipeScrollConfig` | Configuration for recipe scroll drop behavior |

#### RecipeScrollConfig Properties

| Property | Type | Description |
|----------|------|-------------|
| `RecipeId` | `string` | Recipe this scroll teaches |
| `DropWeight` | `int` | Relative weight for selection (higher = more common) |
| `MinDungeonLevel` | `int` | Minimum level required to drop |
| `MaxDungeonLevel` | `int?` | Maximum level (null = no limit) |
| `LootSources` | `IReadOnlyList<LootSourceType>` | Valid drop sources |
| `BaseValue` | `int` | Scroll gold value |

#### RecipeScrollConfig Methods

| Method | Returns | Description |
|--------|---------|-------------|
| `CanDropAtLevel(level)` | `bool` | Check if scroll can drop at level |
| `CanDropFromSource(source)` | `bool` | Check if scroll can drop from source |
| `CanDrop(level, source)` | `bool` | Combined level + source check |
| `Create(...)` | `RecipeScrollConfig` | Factory method with validation |

### Application Layer - Events

| Event | Description |
|-------|-------------|
| `RecipeDiscoveredEvent` | Published when a player discovers a recipe through exploration |

#### RecipeDiscoveredEvent Properties

| Property | Type | Description |
|----------|------|-------------|
| `PlayerId` | `Guid` | Player who discovered the recipe |
| `RecipeId` | `string` | Discovered recipe identifier |
| `RecipeName` | `string` | Display name of the recipe |
| `DiscoverySource` | `DiscoverySource` | How recipe was discovered |
| `Timestamp` | `DateTimeOffset` | When discovery occurred |

### Application Layer - DTOs

| DTO | Description |
|-----|-------------|
| `ItemUseResult` | Result of using an item |
| `LootContext` | Context for loot generation operations |

#### ItemUseResultType Enum

| Value | Description |
|-------|-------------|
| `Consumed` | Item was used and should be removed |
| `Preserved` | Item was used but kept (e.g., already knew recipe) |
| `Failed` | Item use failed |

#### ItemUseResult Properties

| Property | Type | Description |
|----------|------|-------------|
| `IsSuccess` | `bool` | True for Consumed and Preserved |
| `WasConsumed` | `bool` | True only for Consumed |
| `Message` | `string` | Human-readable result message |
| `ResultType` | `ItemUseResultType` | Outcome category |

#### ItemUseResult Factory Methods

| Method | Description |
|--------|-------------|
| `ConsumedWithMessage(msg)` | Success, item consumed |
| `Preserved(msg)` | Success, item kept |
| `Failed(msg)` | Failure, item kept |

#### LootContext Properties

| Property | Type | Description |
|----------|------|-------------|
| `Source` | `LootSourceType` | Type of loot source |
| `DungeonLevel` | `int` | Current dungeon level |
| `Player` | `Player?` | Optional player for filtering |
| `ExcludeKnownRecipes` | `bool` | Filter out known recipes |

#### LootContext Factory Methods

| Method | Description |
|--------|-------------|
| `Chest(level, player?, excludeKnown?)` | Chest loot context |
| `Boss(level, player?, excludeKnown?)` | Boss loot context |
| `Monster(level, player?, excludeKnown?)` | Monster loot context |
| `Quest(level, player?, excludeKnown?)` | Quest reward context |
| `Create(source, level, player?, excludeKnown?)` | Custom context |

### Application Layer - Interfaces

| Interface | Description |
|-----------|-------------|
| `IItemUseHandler` | Strategy pattern handler for item use actions |
| `IRecipeScrollProvider` | Provider for recipe scroll configurations |

#### IItemUseHandler Members

| Member | Type | Description |
|--------|------|-------------|
| `HandledEffect` | `ItemEffect` | Which effect this handler processes |
| `Handle(player, item)` | `ItemUseResult` | Process the item use |

#### IRecipeScrollProvider Methods

| Method | Returns | Description |
|--------|---------|-------------|
| `GetScrollConfig(recipeId)` | `RecipeScrollConfig?` | Get config by recipe ID |
| `GetAllScrollConfigs()` | `IReadOnlyList<RecipeScrollConfig>` | All scroll configs |
| `GetScrollsForLevel(level)` | `IReadOnlyList<RecipeScrollConfig>` | Scrolls eligible at level |
| `GetScrollsForSource(source)` | `IReadOnlyList<RecipeScrollConfig>` | Scrolls from source |
| `GetEligibleScrolls(level, source)` | `IReadOnlyList<RecipeScrollConfig>` | Combined filtering |
| `GetDropChance(source)` | `decimal` | Drop chance for source (0-1) |
| `HasScrollConfig(recipeId)` | `bool` | Check if config exists |
| `GetScrollCount()` | `int` | Total scroll configs |

### Application Layer - Handlers

| Handler | Description |
|---------|-------------|
| `RecipeScrollUseHandler` | Handles LearnRecipe effect items |

#### RecipeScrollUseHandler Dependencies

| Dependency | Purpose |
|------------|---------|
| `IRecipeService` | Learn recipes, check known |
| `IRecipeProvider` | Validate recipe existence |
| `IGameEventLogger` | Publish discovery events |
| `ILogger<RecipeScrollUseHandler>` | Diagnostic logging |

### Application Layer - Service Extension

| Change | Description |
|--------|-------------|
| `ILootService.TryGenerateRecipeScroll()` | Generate scroll based on context |
| `ILootService.GetScrollDropChance()` | Get drop chance for source |
| `LootService` | Extended with scroll generation |

#### LootService New Dependencies (Optional)

| Dependency | Purpose |
|------------|---------|
| `IRecipeScrollProvider` | Scroll configurations |
| `IRecipeProvider` | Recipe name lookups |
| `IRecipeService` | Known recipe filtering |

### Infrastructure Layer - Provider

| Provider | Description |
|----------|-------------|
| `RecipeScrollProvider` | Loads scroll configs from JSON |

#### RecipeScrollProvider Features

- Case-insensitive recipe ID lookups
- Lazy loading with double-checked locking
- Multi-index for efficient filtering (by level, source)
- Configurable drop chances per source
- Validation of config entries

### Infrastructure Layer - Configuration

| Class | Description |
|-------|-------------|
| `RecipeScrollSettings` | Configuration DTO for JSON binding |
| `RecipeScrollConfigDto` | DTO for individual scroll config |

#### RecipeScrollSettings Properties

| Property | Type | Description |
|----------|------|-------------|
| `RecipeScrolls` | `List<RecipeScrollConfigDto>` | Scroll configurations |
| `ScrollDropChances` | `Dictionary<string, decimal>` | Drop chances by source |

### Infrastructure Layer - DI Registration

| Registration | Lifetime | Description |
|--------------|----------|-------------|
| `IRecipeScrollProvider` | Singleton | Scroll configuration provider |
| `IItemUseHandler` | Scoped | Recipe scroll use handler |
| `RecipeScrollSettings` | Configuration | Bound from config section |

### Configuration Files

| File | Description |
|------|-------------|
| `config/schemas/recipe-scrolls.schema.json` | JSON Schema for validation |
| `config/recipe-scrolls.json` | Scroll configurations |

#### Default Recipe Scroll Configurations

| Recipe | Weight | Min Level | Sources | Value |
|--------|--------|-----------|---------|-------|
| steel-sword | 10 | 3 | Chest, Boss | 100 |
| steel-armor | 8 | 4 | Chest, Boss | 150 |
| mithril-blade | 2 | 8 | Boss, Quest | 500 |
| fire-resistance-potion | 8 | 5 | Chest, Monster, Boss | 75 |
| greater-healing-potion | 12 | 4 | Chest, Monster, Boss | 80 |
| silver-ring | 5 | 6 | Boss, Quest | 200 |

#### Default Drop Chances

| Source | Chance |
|--------|--------|
| Chest | 15% |
| Boss | 30% |
| Monster | 2% |
| Quest | 50% |

---

## Unit Tests

### ItemRecipeScrollTests (~10 tests)

- CreateRecipeScroll with valid parameters
- Recipe ID normalization to lowercase
- Default base value when not specified
- Parameter validation (null, empty, whitespace)
- IsRecipeScroll property behavior
- RecipeId property for non-scroll items

### RecipeScrollUseHandlerTests (~12 tests)

- Constructor null validation
- HandledEffect returns LearnRecipe
- Valid scroll learns recipe and returns Consumed
- Already-known recipe preserves scroll
- Non-existent recipe returns Failed
- Wrong effect type returns Failed
- Missing RecipeId returns Failed
- Null player/item throws ArgumentNullException
- Case-insensitive recipe ID handling
- Event logging verification

### RecipeScrollProviderTests (~15 tests)

- Constructor null validation
- GetScrollsForLevel filters correctly
- Max dungeon level respected
- GetScrollsForSource returns correct scrolls
- GetEligibleScrolls combines filters
- GetDropChance returns configured values
- GetScrollConfig case-insensitive
- HasScrollConfig returns correct values
- Empty configuration handling

### LootServiceScrollTests (~10 tests)

- TryGenerateRecipeScroll with eligible scrolls
- Weighted selection with multiple scrolls
- Drop check failure returns null
- No eligible scrolls returns null
- No scroll provider returns null
- Known recipe exclusion filtering
- GetScrollDropChance returns configured chance
- Event logging on scroll generation

---

## Files Created

| Path | Description |
|------|-------------|
| `src/Core/RuneAndRust.Domain/Enums/LootSourceType.cs` | Loot source enum |
| `src/Core/RuneAndRust.Domain/Enums/DiscoverySource.cs` | Discovery source enum |
| `src/Core/RuneAndRust.Domain/ValueObjects/RecipeScrollConfig.cs` | Scroll config value object |
| `src/Core/RuneAndRust.Application/DTOs/ItemUseResult.cs` | Item use result DTO |
| `src/Core/RuneAndRust.Application/DTOs/LootContext.cs` | Loot context DTO |
| `src/Core/RuneAndRust.Application/Interfaces/IItemUseHandler.cs` | Handler interface |
| `src/Core/RuneAndRust.Application/Interfaces/IRecipeScrollProvider.cs` | Provider interface |
| `src/Core/RuneAndRust.Application/Handlers/RecipeScrollUseHandler.cs` | Scroll handler |
| `src/Infrastructure/RuneAndRust.Infrastructure/Configuration/RecipeScrollSettings.cs` | Settings class |
| `src/Infrastructure/RuneAndRust.Infrastructure/Providers/RecipeScrollProvider.cs` | Provider implementation |
| `config/schemas/recipe-scrolls.schema.json` | JSON Schema |
| `config/recipe-scrolls.json` | Scroll configurations |
| `tests/.../Entities/ItemRecipeScrollTests.cs` | Item tests |
| `tests/.../Handlers/RecipeScrollUseHandlerTests.cs` | Handler tests |
| `tests/.../Providers/RecipeScrollProviderTests.cs` | Provider tests |
| `tests/.../Services/LootServiceScrollTests.cs` | LootService scroll tests |

## Files Modified

| Path | Description |
|------|-------------|
| `src/Core/RuneAndRust.Domain/Enums/ItemEffect.cs` | Added LearnRecipe value |
| `src/Core/RuneAndRust.Domain/Entities/Item.cs` | Added RecipeId, IsRecipeScroll, CreateRecipeScroll |
| `src/Core/RuneAndRust.Application/Events/RecipeEvents.cs` | Added RecipeDiscoveredEvent |
| `src/Core/RuneAndRust.Application/Interfaces/ILootService.cs` | Added scroll methods |
| `src/Core/RuneAndRust.Application/Services/LootService.cs` | Extended with scroll generation |
| `src/Infrastructure/RuneAndRust.Infrastructure/DependencyInjection.cs` | Added registrations |

---

## API Examples

### Creating Recipe Scrolls

```csharp
// Create a recipe scroll item
var scroll = Item.CreateRecipeScroll(
    recipeId: "steel-sword",
    recipeName: "Steel Sword",
    baseValue: 150);

Console.WriteLine(scroll.Name);  // "Recipe Scroll: Steel Sword"
Console.WriteLine(scroll.IsRecipeScroll);  // true
Console.WriteLine(scroll.RecipeId);  // "steel-sword"
```

### Using Recipe Scrolls

```csharp
// Find the appropriate handler
var handler = handlers.FirstOrDefault(h => h.HandledEffect == item.Effect);
if (handler != null)
{
    var result = handler.Handle(player, scroll);

    switch (result.ResultType)
    {
        case ItemUseResultType.Consumed:
            player.Inventory.RemoveItem(scroll);
            Console.WriteLine(result.Message);
            // "You carefully study the scroll and learn how to craft Steel Sword!"
            break;

        case ItemUseResultType.Preserved:
            Console.WriteLine(result.Message);
            // "You already know how to craft Steel Sword. The scroll has been preserved."
            break;

        case ItemUseResultType.Failed:
            Console.WriteLine(result.Message);
            // "The recipe on this scroll has faded beyond recognition."
            break;
    }
}
```

### Generating Recipe Scrolls as Loot

```csharp
// Generate scroll from chest at level 5
var context = LootContext.Chest(dungeonLevel: 5, player: currentPlayer);
var scroll = lootService.TryGenerateRecipeScroll(context);

if (scroll != null)
{
    Console.WriteLine($"Found: {scroll.Name}");
    room.AddLoot(scroll);
}

// Generate scroll from boss, excluding known recipes
var bossContext = LootContext.Boss(
    level: 10,
    player: currentPlayer,
    excludeKnown: true);
var bossScroll = lootService.TryGenerateRecipeScroll(bossContext);
```

### Querying Scroll Configurations

```csharp
// Get all scrolls eligible at level 5 from chests
var eligibleScrolls = scrollProvider.GetEligibleScrolls(5, LootSourceType.Chest);
foreach (var config in eligibleScrolls)
{
    Console.WriteLine($"- {config.RecipeId} (weight: {config.DropWeight})");
}

// Check drop chance
var chestChance = scrollProvider.GetDropChance(LootSourceType.Chest);
Console.WriteLine($"Chest scroll drop chance: {chestChance:P0}");  // "15%"

// Check if specific scroll exists
if (scrollProvider.HasScrollConfig("mithril-blade"))
{
    var config = scrollProvider.GetScrollConfig("mithril-blade");
    Console.WriteLine($"Mithril Blade scroll drops at level {config!.MinDungeonLevel}+");
}
```

---

## Scroll Generation Flow

```
TryGenerateRecipeScroll(context)
    │
    ├─ Check scroll provider available
    │
    ├─ Get drop chance for source
    │   └─ If 0, return null
    │
    ├─ Roll against drop chance
    │   └─ If fails, return null
    │
    ├─ Get eligible scrolls (level + source filter)
    │   └─ If ExcludeKnownRecipes, filter out known
    │       └─ If none eligible, return null
    │
    ├─ Weighted random selection
    │   └─ Higher DropWeight = more likely
    │
    ├─ Look up recipe definition
    │   └─ If not found, return null (warning logged)
    │
    └─ Create scroll item via Item.CreateRecipeScroll()
```

---

## v0.11.x Progress

| Version | Feature | Status |
|---------|---------|--------|
| v0.11.0a | Resource Definitions | ✅ Complete |
| v0.11.0b | Harvestable Features | ✅ Complete |
| v0.11.0c | Gathering Service | ✅ Complete |
| v0.11.1a | Recipe Definitions | ✅ Complete |
| v0.11.1b | Recipe Book | ✅ Complete |
| v0.11.1c | Recipe Discovery | ✅ Complete |
| v0.11.2 | Crafting System | Pending |

---

## Dependencies

### Required From Prior Versions

| Version | Dependency | Usage |
|---------|------------|-------|
| v0.11.1b | RecipeBook | Recipe knowledge tracking |
| v0.11.1b | IRecipeService | Learn recipes, check known |
| v0.11.1b | LearnRecipeResult | Learn operation result |
| v0.11.1a | RecipeDefinition | Recipe templates |
| v0.11.1a | IRecipeProvider | Get recipe details |
| v0.0.x | Item | Base item entity |
| v0.0.x | Player | Player entity |
| v0.0.x | IGameEventLogger | Event publishing |
| v0.0.x | LootService | Loot generation |

### Provides To Future Versions

| Version | Feature | Usage |
|---------|---------|-------|
| v0.11.2 | Recipe scroll items | Crafting UI integration |
| v0.11.2 | RecipeDiscoveredEvent | Statistics and achievements |
| v0.11.2 | LootContext | Extended loot generation |
| v0.11.2 | IItemUseHandler | Item use handler pattern |

---

## Key Design Decisions

1. **Factory Method Pattern** - Item.CreateRecipeScroll instead of inheritance
2. **ItemEffect.LearnRecipe** - Extended existing enum instead of new ItemUseAction
3. **IGameEventLogger** - Used existing pattern instead of IEventBus
4. **Optional Dependencies** - LootService scroll methods gracefully degrade without providers
5. **Case-Insensitive** - Recipe IDs normalized to lowercase, lookups case-insensitive
6. **Lazy Loading** - RecipeScrollProvider loads on first access
7. **Weighted Selection** - Higher DropWeight = more common drops
8. **Preserved Result** - Scrolls kept when player already knows recipe

---

## Logging Strategy

| Level | Component | When |
|-------|-----------|------|
| Information | RecipeScrollUseHandler | Recipe learned from scroll |
| Information | RecipeScrollProvider | Configuration loaded |
| Information | LootService | Recipe scroll generated |
| Debug | RecipeScrollUseHandler | Use attempt started, validation steps |
| Debug | RecipeScrollProvider | Lookup operations |
| Debug | LootService | Drop check result, eligible scroll count |
| Warning | RecipeScrollUseHandler | Invalid item, unknown recipe |
| Warning | RecipeScrollProvider | Invalid config entries |
| Warning | LootService | Scroll config references missing recipe |
| Error | RecipeScrollUseHandler | Learn failed after validation passed |

---

## Configuration Schema

```json
{
  "recipeScrolls": [
    {
      "recipeId": "steel-sword",
      "dropWeight": 10,
      "minDungeonLevel": 3,
      "maxDungeonLevel": null,
      "lootSources": ["Chest", "Boss"],
      "baseValue": 100
    }
  ],
  "scrollDropChances": {
    "Chest": 0.15,
    "Boss": 0.30,
    "Monster": 0.02,
    "Quest": 0.50
  }
}
```

---

## Notes

- Recipe scrolls are Consumable items with LearnRecipe effect
- RecipeId stored in lowercase for case-insensitive matching
- Scrolls only drop for non-default recipes (isDefault: false in recipe config)
- Known recipe exclusion requires Player and IRecipeService
- Drop chances are per-source base chances, not per-scroll
- Weighted selection uses DropWeight across all eligible scrolls
- MaxDungeonLevel allows phasing out low-level scroll drops
- IItemUseHandler pattern established for future item handlers (potions, buffs, etc.)
