# v0.16.5a Design Specification: Unique Item Definition

## Document Information

| Field               | Value                                           |
| ------------------- | ----------------------------------------------- |
| **Version**         | v0.16.5a                                        |
| **Feature**         | Unique Item Definition                          |
| **Status**          | Draft                                           |
| **Dependencies**    | v0.16.4 (Container Loot), v0.16.0 (QualityTier) |
| **Estimated Tests** | 20                                              |

---

## 1. Executive Summary

Version 0.16.5a introduces the foundational data structures for Myth-Forged (unique) items - legendary equipment with fixed stats, special effects, and rich lore. This phase establishes the `UniqueItem` entity, supporting value objects (`ItemStats`, `DropSource`), the `DropSourceType` enum, and the configuration-driven `unique-items.json` schema.

### 1.1 Feature Overview

```
v0.16.5a: Unique Item Definition
├── Domain Layer
│   ├── UniqueItem Entity
│   │   ├── Fixed identity (itemId, name, flavor text)
│   │   ├── ItemStats value object (stat bonuses)
│   │   ├── DropSource value object (where it drops)
│   │   └── Quality tier integration
│   ├── ItemStats Value Object
│   │   └── Stat bonus collection (might, agility, etc.)
│   ├── DropSource Value Object
│   │   └── Source type + identifier + drop chance
│   └── DropSourceType Enum
│       └── Monster, Container, Boss, Vendor, Quest
└── Configuration
    ├── unique-items.json
    └── unique-items.schema.json
```

### 1.2 Goals

1. Define immutable `UniqueItem` entity with fixed stats and lore
2. Create `ItemStats` value object for stat bonus representation
3. Create `DropSource` value object for drop location specification
4. Define `DropSourceType` enum for categorizing drop sources
5. Establish JSON configuration schema for unique item definitions

### 1.3 Non-Goals (Deferred)

- Special effect processing (v0.16.5b)
- Duplicate prevention registry (v0.16.5c)
- Integration with loot generation (v0.16.5d)
- Visual presentation (v0.16.5e)
- Achievement hooks (v0.16.5f)

---

## 2. Architecture

### 2.1 Layer Diagram

```
┌─────────────────────────────────────────────────────────────────┐
│                    CONFIGURATION LAYER                          │
│  ┌─────────────────────────────────────────────────────────────┐│
│  │                  unique-items.json                          ││
│  │  ┌─────────────────┐  ┌─────────────────┐                   ││
│  │  │ shadowfang-blade│  │ phoenixheart    │  ...              ││
│  │  │ - stats         │  │ - stats         │                   ││
│  │  │ - dropSources   │  │ - dropSources   │                   ││
│  │  │ - flavorText    │  │ - flavorText    │                   ││
│  │  └─────────────────┘  └─────────────────┘                   ││
│  └─────────────────────────────────────────────────────────────┘│
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│                      DOMAIN LAYER                               │
│  ┌──────────────────────────────────────────────────────────┐   │
│  │                    UniqueItem Entity                      │   │
│  │  ┌────────────────────────────────────────────────────┐  │   │
│  │  │ Id: Guid                                           │  │   │
│  │  │ ItemId: string ("shadowfang-blade")                │  │   │
│  │  │ Name: string ("Shadowfang Blade")                  │  │   │
│  │  │ Description: string                                │  │   │
│  │  │ FlavorText: string                                 │  │   │
│  │  │ ItemCategory: ItemCategory                         │  │   │
│  │  │ QualityTier: QualityTier (always Legendary)        │  │   │
│  │  │ Stats: ItemStats                                   │  │   │
│  │  │ DropSources: IReadOnlyList<DropSource>             │  │   │
│  │  │ ClassAffinities: IReadOnlyList<string>             │  │   │
│  │  │ RequiredLevel: int                                 │  │   │
│  │  │ SpecialEffectIds: IReadOnlyList<string>            │  │   │
│  │  └────────────────────────────────────────────────────┘  │   │
│  └──────────────────────────────────────────────────────────┘   │
│                                                                 │
│  ┌─────────────────────────┐  ┌─────────────────────────────┐   │
│  │  ItemStats (VO)         │  │  DropSource (VO)            │   │
│  │  ┌───────────────────┐  │  │  ┌───────────────────────┐  │   │
│  │  │ Might: int        │  │  │  │ SourceType: enum      │  │   │
│  │  │ Agility: int      │  │  │  │ SourceId: string      │  │   │
│  │  │ Will: int         │  │  │  │ DropChance: decimal   │  │   │
│  │  │ Fortitude: int    │  │  │  └───────────────────────┘  │   │
│  │  │ Arcana: int       │  │  └─────────────────────────────┘   │
│  │  │ BonusHealth: int  │  │                                    │
│  │  │ BonusDamage: int  │  │  ┌─────────────────────────────┐   │
│  │  │ BonusDefense: int │  │  │  DropSourceType (Enum)      │   │
│  │  └───────────────────┘  │  │  ┌───────────────────────┐  │   │
│  └─────────────────────────┘  │  │ Monster = 0           │  │   │
│                               │  │ Container = 1         │  │   │
│                               │  │ Boss = 2              │  │   │
│                               │  │ Vendor = 3            │  │   │
│                               │  │ Quest = 4             │  │   │
│                               │  └───────────────────────┘  │   │
│                               └─────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────┘
```

### 2.2 Component Integration

```
┌─────────────────────────────────────────────────────────────────┐
│                   INTEGRATION CONTEXT                           │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ┌──────────────┐     references     ┌──────────────────────┐   │
│  │ QualityTier  │◄──────────────────│    UniqueItem        │   │
│  │ (v0.16.0)    │                   │    Entity            │   │
│  └──────────────┘                   └──────────────────────┘   │
│                                              │                  │
│  ┌──────────────┐     references             │                  │
│  │ ItemCategory │◄───────────────────────────┤                  │
│  │ (existing)   │                            │                  │
│  └──────────────┘                            │                  │
│                                              │                  │
│                           ┌──────────────────┴───────────────┐  │
│                           │                                  │  │
│                           ▼                                  ▼  │
│                    ┌─────────────┐              ┌────────────┐  │
│                    │ ItemStats   │              │ DropSource │  │
│                    │ (VO)        │              │ (VO)       │  │
│                    └─────────────┘              └────────────┘  │
│                                                       │         │
│                                                       ▼         │
│                                            ┌──────────────────┐ │
│                                            │ DropSourceType   │ │
│                                            │ (Enum)           │ │
│                                            └──────────────────┘ │
│                                                                 │
│  FUTURE INTEGRATION (v0.16.5b-f):                               │
│  ┌──────────────────┐  ┌──────────────────┐  ┌───────────────┐  │
│  │ SpecialEffect    │  │ UniqueItemReg.   │  │ MythForged    │  │
│  │ System           │  │ (duplicate prev) │  │ Service       │  │
│  └──────────────────┘  └──────────────────┘  └───────────────┘  │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

---

## 3. Data Model

### 3.1 DropSourceType Enum

**Location:** `src/Core/RuneAndRust.Domain/Enums/DropSourceType.cs`

```csharp
namespace RuneAndRust.Domain.Enums;

/// <summary>
/// Defines the types of sources from which unique items can drop.
/// </summary>
public enum DropSourceType
{
    /// <summary>Standard monster drops.</summary>
    Monster = 0,

    /// <summary>Container loot (chests, crates, etc.).</summary>
    Container = 1,

    /// <summary>Boss-specific drops with higher rates.</summary>
    Boss = 2,

    /// <summary>Purchasable from vendors.</summary>
    Vendor = 3,

    /// <summary>Quest reward items.</summary>
    Quest = 4
}
```

### 3.2 ItemStats Value Object

**Location:** `src/Core/RuneAndRust.Domain/ValueObjects/ItemStats.cs`

```csharp
namespace RuneAndRust.Domain.ValueObjects;

/// <summary>
/// Immutable value object representing stat bonuses provided by an item.
/// </summary>
public readonly record struct ItemStats
{
    /// <summary>Bonus to Might stat.</summary>
    public int Might { get; }

    /// <summary>Bonus to Agility stat.</summary>
    public int Agility { get; }

    /// <summary>Bonus to Will stat.</summary>
    public int Will { get; }

    /// <summary>Bonus to Fortitude stat.</summary>
    public int Fortitude { get; }

    /// <summary>Bonus to Arcana stat.</summary>
    public int Arcana { get; }

    /// <summary>Flat bonus to maximum health.</summary>
    public int BonusHealth { get; }

    /// <summary>Flat bonus to damage dealt.</summary>
    public int BonusDamage { get; }

    /// <summary>Flat bonus to defense.</summary>
    public int BonusDefense { get; }

    /// <summary>Empty stats with all values at zero.</summary>
    public static ItemStats Empty => new(0, 0, 0, 0, 0, 0, 0, 0);

    private ItemStats(
        int might, int agility, int will, int fortitude, int arcana,
        int bonusHealth, int bonusDamage, int bonusDefense)
    {
        Might = might;
        Agility = agility;
        Will = will;
        Fortitude = fortitude;
        Arcana = arcana;
        BonusHealth = bonusHealth;
        BonusDamage = bonusDamage;
        BonusDefense = bonusDefense;
    }

    /// <summary>
    /// Creates a new ItemStats instance with validation.
    /// </summary>
    public static ItemStats Create(
        int might = 0, int agility = 0, int will = 0,
        int fortitude = 0, int arcana = 0,
        int bonusHealth = 0, int bonusDamage = 0, int bonusDefense = 0)
    {
        // All stats can be negative (cursed items) or positive
        // No upper bound validation - configuration controls limits

        return new ItemStats(
            might, agility, will, fortitude, arcana,
            bonusHealth, bonusDamage, bonusDefense);
    }

    /// <summary>
    /// Returns true if all stats are zero.
    /// </summary>
    public bool IsEmpty =>
        Might == 0 && Agility == 0 && Will == 0 && Fortitude == 0 &&
        Arcana == 0 && BonusHealth == 0 && BonusDamage == 0 && BonusDefense == 0;

    public override string ToString() =>
        $"Stats[M:{Might} A:{Agility} W:{Will} F:{Fortitude} Arc:{Arcana} " +
        $"HP:{BonusHealth} DMG:{BonusDamage} DEF:{BonusDefense}]";
}
```

### 3.3 DropSource Value Object

**Location:** `src/Core/RuneAndRust.Domain/ValueObjects/DropSource.cs`

```csharp
namespace RuneAndRust.Domain.ValueObjects;

using RuneAndRust.Domain.Enums;

/// <summary>
/// Immutable value object representing a source from which a unique item can drop.
/// </summary>
public readonly record struct DropSource
{
    /// <summary>The type of drop source.</summary>
    public DropSourceType SourceType { get; }

    /// <summary>Identifier for the specific source (monster ID, container type, etc.).</summary>
    public string SourceId { get; }

    /// <summary>Base drop chance as a percentage (0.0 to 100.0).</summary>
    public decimal DropChance { get; }

    private DropSource(DropSourceType sourceType, string sourceId, decimal dropChance)
    {
        SourceType = sourceType;
        SourceId = sourceId;
        DropChance = dropChance;
    }

    /// <summary>
    /// Creates a new DropSource with validation.
    /// </summary>
    public static DropSource Create(DropSourceType sourceType, string sourceId, decimal dropChance)
    {
        ArgumentException.ThrowIfNullOrWhiteSpace(sourceId, nameof(sourceId));
        ArgumentOutOfRangeException.ThrowIfNegative(dropChance, nameof(dropChance));
        ArgumentOutOfRangeException.ThrowIfGreaterThan(dropChance, 100m, nameof(dropChance));

        return new DropSource(sourceType, sourceId.ToLowerInvariant(), dropChance);
    }

    public override string ToString() =>
        $"DropSource[{SourceType}:{SourceId} @ {DropChance:F2}%]";
}
```

### 3.4 UniqueItem Entity

**Location:** `src/Core/RuneAndRust.Domain/Entities/UniqueItem.cs`

```csharp
namespace RuneAndRust.Domain.Entities;

using RuneAndRust.Domain.Enums;
using RuneAndRust.Domain.Interfaces;
using RuneAndRust.Domain.ValueObjects;

/// <summary>
/// Represents a Myth-Forged (unique/legendary) item with fixed stats and special properties.
/// Unique items are configuration-defined and immutable after creation.
/// </summary>
public class UniqueItem : IEntity
{
    /// <summary>Database identifier.</summary>
    public Guid Id { get; private set; }

    /// <summary>Configuration identifier (e.g., "shadowfang-blade").</summary>
    public string ItemId { get; private set; }

    /// <summary>Display name for the item.</summary>
    public string Name { get; private set; }

    /// <summary>Functional description of the item.</summary>
    public string Description { get; private set; }

    /// <summary>Lore/flavor text for atmosphere.</summary>
    public string FlavorText { get; private set; }

    /// <summary>Item category (weapon, armor, accessory).</summary>
    public ItemCategory Category { get; private set; }

    /// <summary>Quality tier - always Legendary for unique items.</summary>
    public QualityTier QualityTier { get; private set; }

    /// <summary>Stat bonuses provided by this item.</summary>
    public ItemStats Stats { get; private set; }

    /// <summary>Sources from which this item can drop.</summary>
    public IReadOnlyList<DropSource> DropSources { get; private set; }

    /// <summary>Class IDs that have affinity for this item (empty = all classes).</summary>
    public IReadOnlyList<string> ClassAffinities { get; private set; }

    /// <summary>Minimum level required to equip.</summary>
    public int RequiredLevel { get; private set; }

    /// <summary>IDs of special effects granted by this item (processed in v0.16.5b).</summary>
    public IReadOnlyList<string> SpecialEffectIds { get; private set; }

    /// <summary>Whether this item is part of a set (future feature).</summary>
    public string? SetId { get; private set; }

    // Private constructor for EF Core
    private UniqueItem()
    {
        ItemId = null!;
        Name = null!;
        Description = null!;
        FlavorText = null!;
        Stats = ItemStats.Empty;
        DropSources = Array.Empty<DropSource>();
        ClassAffinities = Array.Empty<string>();
        SpecialEffectIds = Array.Empty<string>();
    }

    /// <summary>
    /// Creates a new UniqueItem with validation.
    /// </summary>
    public static UniqueItem Create(
        string itemId,
        string name,
        string description,
        string flavorText,
        ItemCategory category,
        ItemStats stats,
        IReadOnlyList<DropSource> dropSources,
        IReadOnlyList<string>? classAffinities = null,
        int requiredLevel = 1,
        IReadOnlyList<string>? specialEffectIds = null,
        string? setId = null)
    {
        ArgumentException.ThrowIfNullOrWhiteSpace(itemId, nameof(itemId));
        ArgumentException.ThrowIfNullOrWhiteSpace(name, nameof(name));
        ArgumentException.ThrowIfNullOrWhiteSpace(description, nameof(description));
        ArgumentNullException.ThrowIfNull(dropSources, nameof(dropSources));
        ArgumentOutOfRangeException.ThrowIfLessThan(requiredLevel, 1, nameof(requiredLevel));

        if (dropSources.Count == 0)
        {
            throw new ArgumentException("At least one drop source is required.", nameof(dropSources));
        }

        return new UniqueItem
        {
            Id = Guid.NewGuid(),
            ItemId = itemId.ToLowerInvariant(),
            Name = name,
            Description = description,
            FlavorText = flavorText ?? string.Empty,
            Category = category,
            QualityTier = QualityTier.Legendary, // Always legendary
            Stats = stats,
            DropSources = dropSources.ToList().AsReadOnly(),
            ClassAffinities = (classAffinities ?? Array.Empty<string>())
                .Select(c => c.ToLowerInvariant()).ToList().AsReadOnly(),
            RequiredLevel = requiredLevel,
            SpecialEffectIds = (specialEffectIds ?? Array.Empty<string>())
                .Select(e => e.ToLowerInvariant()).ToList().AsReadOnly(),
            SetId = setId?.ToLowerInvariant()
        };
    }

    /// <summary>
    /// Checks if this item has affinity for a specific class.
    /// Returns true if no class restrictions exist or if the class is in the affinity list.
    /// </summary>
    public bool HasAffinityFor(string classId)
    {
        if (ClassAffinities.Count == 0)
            return true;

        return ClassAffinities.Contains(classId.ToLowerInvariant());
    }

    /// <summary>
    /// Gets drop sources of a specific type.
    /// </summary>
    public IEnumerable<DropSource> GetDropSourcesByType(DropSourceType sourceType) =>
        DropSources.Where(ds => ds.SourceType == sourceType);

    /// <summary>
    /// Checks if this item can drop from a specific source.
    /// </summary>
    public bool CanDropFrom(DropSourceType sourceType, string sourceId) =>
        DropSources.Any(ds =>
            ds.SourceType == sourceType &&
            ds.SourceId.Equals(sourceId.ToLowerInvariant(), StringComparison.Ordinal));
}
```

---

## 4. Configuration

### 4.1 unique-items.json

**Location:** `config/unique-items.json`

```json
{
    "$schema": "./unique-items.schema.json",
    "uniqueItems": [
        {
            "itemId": "shadowfang-blade",
            "name": "Shadowfang Blade",
            "description": "A blade forged in eternal darkness that drains life from foes.",
            "flavorText": "\"The shadows remember what the light forgets.\" - Unknown",
            "category": "weapon",
            "requiredLevel": 10,
            "stats": {
                "might": 5,
                "agility": 2,
                "bonusDamage": 15
            },
            "dropSources": [
                {
                    "sourceType": "boss",
                    "sourceId": "shadow-lord",
                    "dropChance": 5.0
                },
                {
                    "sourceType": "container",
                    "sourceId": "legendary-chest",
                    "dropChance": 0.5
                }
            ],
            "classAffinities": ["warrior", "rogue"],
            "specialEffectIds": ["life-drain", "shadow-damage"]
        },
        {
            "itemId": "phoenixheart-amulet",
            "name": "Phoenixheart Amulet",
            "description": "An amulet containing the essence of a phoenix, granting renewal.",
            "flavorText": "Born from ash, destined for glory.",
            "category": "accessory",
            "requiredLevel": 15,
            "stats": {
                "will": 4,
                "fortitude": 3,
                "bonusHealth": 50
            },
            "dropSources": [
                {
                    "sourceType": "boss",
                    "sourceId": "phoenix-guardian",
                    "dropChance": 3.0
                }
            ],
            "classAffinities": [],
            "specialEffectIds": ["phoenix-rebirth"]
        },
        {
            "itemId": "dread-knights-plate",
            "name": "Dread Knight's Plate",
            "description": "Armor worn by the legendary Dread Knight, inspiring fear in enemies.",
            "flavorText": "Those who wore it were feared. Those who faced it despaired.",
            "category": "armor",
            "requiredLevel": 20,
            "stats": {
                "fortitude": 6,
                "might": 3,
                "bonusDefense": 25,
                "bonusHealth": 30
            },
            "dropSources": [
                {
                    "sourceType": "boss",
                    "sourceId": "dread-knight",
                    "dropChance": 2.0
                },
                {
                    "sourceType": "quest",
                    "sourceId": "fallen-order",
                    "dropChance": 100.0
                }
            ],
            "classAffinities": ["warrior", "paladin"],
            "specialEffectIds": ["fear-aura", "damage-reduction"],
            "setId": "dread-knight-set"
        }
    ]
}
```

### 4.2 unique-items.schema.json

**Location:** `config/unique-items.schema.json`

```json
{
    "$schema": "http://json-schema.org/draft-07/schema#",
    "$id": "unique-items.schema.json",
    "title": "Unique Items Configuration",
    "description": "Schema for Myth-Forged unique item definitions",
    "type": "object",
    "required": ["uniqueItems"],
    "properties": {
        "$schema": { "type": "string" },
        "uniqueItems": {
            "type": "array",
            "items": { "$ref": "#/definitions/uniqueItem" },
            "minItems": 1
        }
    },
    "definitions": {
        "uniqueItem": {
            "type": "object",
            "required": [
                "itemId",
                "name",
                "description",
                "category",
                "stats",
                "dropSources"
            ],
            "properties": {
                "itemId": {
                    "type": "string",
                    "pattern": "^[a-z][a-z0-9-]*$",
                    "description": "Unique identifier in kebab-case"
                },
                "name": { "type": "string", "minLength": 1 },
                "description": { "type": "string", "minLength": 1 },
                "flavorText": { "type": "string" },
                "category": {
                    "type": "string",
                    "enum": ["weapon", "armor", "accessory"]
                },
                "requiredLevel": {
                    "type": "integer",
                    "minimum": 1,
                    "default": 1
                },
                "stats": { "$ref": "#/definitions/itemStats" },
                "dropSources": {
                    "type": "array",
                    "items": { "$ref": "#/definitions/dropSource" },
                    "minItems": 1
                },
                "classAffinities": {
                    "type": "array",
                    "items": {
                        "type": "string",
                        "pattern": "^[a-z][a-z0-9-]*$"
                    }
                },
                "specialEffectIds": {
                    "type": "array",
                    "items": {
                        "type": "string",
                        "pattern": "^[a-z][a-z0-9-]*$"
                    }
                },
                "setId": { "type": "string", "pattern": "^[a-z][a-z0-9-]*$" }
            }
        },
        "itemStats": {
            "type": "object",
            "properties": {
                "might": { "type": "integer" },
                "agility": { "type": "integer" },
                "will": { "type": "integer" },
                "fortitude": { "type": "integer" },
                "arcana": { "type": "integer" },
                "bonusHealth": { "type": "integer" },
                "bonusDamage": { "type": "integer" },
                "bonusDefense": { "type": "integer" }
            },
            "additionalProperties": false
        },
        "dropSource": {
            "type": "object",
            "required": ["sourceType", "sourceId", "dropChance"],
            "properties": {
                "sourceType": {
                    "type": "string",
                    "enum": ["monster", "container", "boss", "vendor", "quest"]
                },
                "sourceId": {
                    "type": "string",
                    "pattern": "^[a-z][a-z0-9-]*$"
                },
                "dropChance": { "type": "number", "minimum": 0, "maximum": 100 }
            }
        }
    }
}
```

---

## 5. Logging Specification

### 5.1 Log Events

| Event                 | Level   | Template                                                            |
| --------------------- | ------- | ------------------------------------------------------------------- |
| UniqueItem created    | Debug   | `"Created UniqueItem {ItemId} with {DropSourceCount} drop sources"` |
| ItemStats created     | Debug   | `"Created ItemStats with {NonZeroStatCount} non-zero stats"`        |
| DropSource created    | Debug   | `"Created DropSource {SourceType}:{SourceId} @ {DropChance}%"`      |
| Affinity check        | Debug   | `"UniqueItem {ItemId} affinity check for {ClassId}: {HasAffinity}"` |
| Invalid configuration | Warning | `"Invalid unique item configuration: {ValidationError}"`            |

---

## 6. Unit Testing

### 6.1 Test Classes

| Test Class            | Location                         | Tests |
| --------------------- | -------------------------------- | ----- |
| `DropSourceTypeTests` | `Domain.UnitTests/Enums/`        | 2     |
| `ItemStatsTests`      | `Domain.UnitTests/ValueObjects/` | 6     |
| `DropSourceTests`     | `Domain.UnitTests/ValueObjects/` | 5     |
| `UniqueItemTests`     | `Domain.UnitTests/Entities/`     | 7     |

### 6.2 ItemStatsTests

```csharp
[TestFixture]
public class ItemStatsTests
{
    [Test]
    public void Create_WithDefaults_ReturnsEmptyStats()
    {
        // Arrange & Act
        var stats = ItemStats.Create();

        // Assert
        stats.IsEmpty.Should().BeTrue();
    }

    [Test]
    public void Create_WithAllStats_SetsAllValues()
    {
        // Arrange & Act
        var stats = ItemStats.Create(
            might: 5, agility: 3, will: 2, fortitude: 4, arcana: 1,
            bonusHealth: 50, bonusDamage: 10, bonusDefense: 15);

        // Assert
        stats.Might.Should().Be(5);
        stats.Agility.Should().Be(3);
        stats.Will.Should().Be(2);
        stats.Fortitude.Should().Be(4);
        stats.Arcana.Should().Be(1);
        stats.BonusHealth.Should().Be(50);
        stats.BonusDamage.Should().Be(10);
        stats.BonusDefense.Should().Be(15);
        stats.IsEmpty.Should().BeFalse();
    }

    [Test]
    public void Create_WithNegativeStats_AllowsCursedItems()
    {
        // Arrange & Act
        var stats = ItemStats.Create(might: -2, bonusHealth: -10);

        // Assert
        stats.Might.Should().Be(-2);
        stats.BonusHealth.Should().Be(-10);
    }

    [Test]
    public void Empty_ReturnsAllZeroStats()
    {
        // Arrange & Act
        var stats = ItemStats.Empty;

        // Assert
        stats.Might.Should().Be(0);
        stats.BonusDamage.Should().Be(0);
        stats.IsEmpty.Should().BeTrue();
    }

    [Test]
    public void ToString_FormatsCorrectly()
    {
        // Arrange
        var stats = ItemStats.Create(might: 5, bonusDamage: 10);

        // Act
        var result = stats.ToString();

        // Assert
        result.Should().Contain("M:5");
        result.Should().Contain("DMG:10");
    }

    [Test]
    public void Equality_WithSameValues_AreEqual()
    {
        // Arrange
        var stats1 = ItemStats.Create(might: 5);
        var stats2 = ItemStats.Create(might: 5);

        // Assert
        stats1.Should().Be(stats2);
    }
}
```

### 6.3 DropSourceTests

```csharp
[TestFixture]
public class DropSourceTests
{
    [Test]
    public void Create_WithValidData_CreatesDropSource()
    {
        // Arrange & Act
        var source = DropSource.Create(DropSourceType.Boss, "shadow-lord", 5.0m);

        // Assert
        source.SourceType.Should().Be(DropSourceType.Boss);
        source.SourceId.Should().Be("shadow-lord");
        source.DropChance.Should().Be(5.0m);
    }

    [Test]
    public void Create_NormalizesSourceId()
    {
        // Arrange & Act
        var source = DropSource.Create(DropSourceType.Monster, "GOBLIN-CHIEF", 2.5m);

        // Assert
        source.SourceId.Should().Be("goblin-chief");
    }

    [Test]
    public void Create_WithNullSourceId_ThrowsArgumentException()
    {
        // Arrange & Act
        var act = () => DropSource.Create(DropSourceType.Monster, null!, 1.0m);

        // Assert
        act.Should().Throw<ArgumentException>();
    }

    [Test]
    public void Create_WithNegativeDropChance_ThrowsArgumentOutOfRangeException()
    {
        // Arrange & Act
        var act = () => DropSource.Create(DropSourceType.Monster, "goblin", -1.0m);

        // Assert
        act.Should().Throw<ArgumentOutOfRangeException>();
    }

    [Test]
    public void Create_WithDropChanceOver100_ThrowsArgumentOutOfRangeException()
    {
        // Arrange & Act
        var act = () => DropSource.Create(DropSourceType.Quest, "main-quest", 150.0m);

        // Assert
        act.Should().Throw<ArgumentOutOfRangeException>();
    }
}
```

### 6.4 UniqueItemTests

```csharp
[TestFixture]
public class UniqueItemTests
{
    private static DropSource CreateTestDropSource() =>
        DropSource.Create(DropSourceType.Boss, "test-boss", 5.0m);

    [Test]
    public void Create_WithValidData_CreatesUniqueItem()
    {
        // Arrange
        var stats = ItemStats.Create(might: 5, bonusDamage: 10);
        var sources = new[] { CreateTestDropSource() };

        // Act
        var item = UniqueItem.Create(
            "test-blade", "Test Blade", "A test weapon.", "Lore text.",
            ItemCategory.Weapon, stats, sources);

        // Assert
        item.ItemId.Should().Be("test-blade");
        item.Name.Should().Be("Test Blade");
        item.QualityTier.Should().Be(QualityTier.Legendary);
        item.Stats.Might.Should().Be(5);
    }

    [Test]
    public void Create_AlwaysSetsLegendaryQuality()
    {
        // Arrange & Act
        var item = UniqueItem.Create(
            "test-item", "Test", "Desc", "",
            ItemCategory.Accessory, ItemStats.Empty, new[] { CreateTestDropSource() });

        // Assert
        item.QualityTier.Should().Be(QualityTier.Legendary);
    }

    [Test]
    public void Create_WithEmptyDropSources_ThrowsArgumentException()
    {
        // Arrange & Act
        var act = () => UniqueItem.Create(
            "test", "Test", "Desc", "",
            ItemCategory.Weapon, ItemStats.Empty, Array.Empty<DropSource>());

        // Assert
        act.Should().Throw<ArgumentException>()
            .WithMessage("*drop source*");
    }

    [Test]
    public void HasAffinityFor_WithNoRestrictions_ReturnsTrue()
    {
        // Arrange
        var item = UniqueItem.Create(
            "test", "Test", "Desc", "",
            ItemCategory.Weapon, ItemStats.Empty, new[] { CreateTestDropSource() },
            classAffinities: null);

        // Act & Assert
        item.HasAffinityFor("warrior").Should().BeTrue();
        item.HasAffinityFor("mage").Should().BeTrue();
    }

    [Test]
    public void HasAffinityFor_WithRestrictions_ChecksCorrectly()
    {
        // Arrange
        var item = UniqueItem.Create(
            "test", "Test", "Desc", "",
            ItemCategory.Weapon, ItemStats.Empty, new[] { CreateTestDropSource() },
            classAffinities: new[] { "warrior", "rogue" });

        // Act & Assert
        item.HasAffinityFor("warrior").Should().BeTrue();
        item.HasAffinityFor("mage").Should().BeFalse();
    }

    [Test]
    public void CanDropFrom_WithMatchingSource_ReturnsTrue()
    {
        // Arrange
        var source = DropSource.Create(DropSourceType.Boss, "shadow-lord", 5.0m);
        var item = UniqueItem.Create(
            "test", "Test", "Desc", "",
            ItemCategory.Weapon, ItemStats.Empty, new[] { source });

        // Act & Assert
        item.CanDropFrom(DropSourceType.Boss, "shadow-lord").Should().BeTrue();
        item.CanDropFrom(DropSourceType.Monster, "goblin").Should().BeFalse();
    }

    [Test]
    public void Create_NormalizesAllIds()
    {
        // Arrange
        var source = DropSource.Create(DropSourceType.Boss, "Test-Boss", 5.0m);

        // Act
        var item = UniqueItem.Create(
            "TEST-ITEM", "Test", "Desc", "",
            ItemCategory.Weapon, ItemStats.Empty, new[] { source },
            classAffinities: new[] { "WARRIOR" },
            specialEffectIds: new[] { "FIRE-DAMAGE" });

        // Assert
        item.ItemId.Should().Be("test-item");
        item.ClassAffinities.Should().Contain("warrior");
        item.SpecialEffectIds.Should().Contain("fire-damage");
    }
}
```

---

## 7. Acceptance Criteria

| #   | Criterion                                                   | Verification       |
| --- | ----------------------------------------------------------- | ------------------ |
| 1   | `DropSourceType` enum defines all 5 source types            | Unit test          |
| 2   | `ItemStats` supports all 8 stat bonuses                     | Unit test          |
| 3   | `DropSource` validates drop chance range (0-100)            | Unit test          |
| 4   | `UniqueItem` always has `Legendary` quality tier            | Unit test          |
| 5   | `UniqueItem` requires at least one drop source              | Unit test          |
| 6   | Class affinity checking works with empty list (all classes) | Unit test          |
| 7   | All IDs are normalized to lowercase                         | Unit test          |
| 8   | JSON configuration loads 3+ example items                   | Manual/Integration |
| 9   | JSON schema validates configuration structure               | Schema validation  |

---

## 8. Deliverable Checklist

### 8.1 Domain Layer

- [ ] `DropSourceType.cs` - Enum with 5 source types
- [ ] `ItemStats.cs` - Value object with 8 stat properties
- [ ] `DropSource.cs` - Value object with type, ID, and drop chance
- [ ] `UniqueItem.cs` - Entity with full property set

### 8.2 Configuration

- [ ] `config/unique-items.json` - 3 example unique items
- [ ] `config/unique-items.schema.json` - JSON Schema

### 8.3 Tests

- [ ] `DropSourceTypeTests.cs` - Enum validation
- [ ] `ItemStatsTests.cs` - Value object tests
- [ ] `DropSourceTests.cs` - Value object tests
- [ ] `UniqueItemTests.cs` - Entity tests

---

## 9. Dependencies

### 9.1 Required

| Dependency        | Version  | Purpose                |
| ----------------- | -------- | ---------------------- |
| QualityTier enum  | v0.16.0  | Always Legendary tier  |
| ItemCategory enum | Existing | Weapon/Armor/Accessory |

### 9.2 Dependents

| Feature          | Version  | Relationship            |
| ---------------- | -------- | ----------------------- |
| Special Effects  | v0.16.5b | Uses SpecialEffectIds   |
| Unique Registry  | v0.16.5c | Tracks UniqueItem drops |
| Drop Integration | v0.16.5d | Generates UniqueItems   |

---

## 10. Future Considerations

### 10.1 Deferred to v0.16.5b

- `SpecialEffect` value object
- `SpecialEffectType` enum
- Effect processing logic

### 10.2 Deferred to Later Versions

- Item set bonuses (`setId` prepared but not processed)
- Cursed item visuals
- Unique item upgrading/enhancement
