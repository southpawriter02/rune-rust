> **Archived** - This plan has been consolidated. See the complete version at [v0.3.21](../v0.3.x/v0.3.21.md).

# v0.3.21b: The Vault (Rolling Backups)
This sub-version introduces a safety net for the player's progress. By implementing a rolling backup system for autosaves, we ensure that a single bad decision, a glitch, or a corrupted save does not erase an entire playthrough.

Goal: Implement the logic to rotate autosaves through a queue of slots (0 -> -1 -> -2) transactionally, and update the UI to expose these backups to the player.

1. Architecture & Data Flow
	•	Slot Strategy:
	◦	Slot 0: The "Live" Autosave (Most recent).
	◦	Slot -1: Backup Autosave (Previous).
	◦	Slot -2: Archive Autosave (Oldest).
	◦	Slots 1-3: Manual User Saves (Unaffected).
	•	Transaction Safety: The rotation must be atomic. We cannot delete the old backup until we are sure the new rotation succeeds to prevent data loss during a crash.
	•	Access Pattern: The SaveManager orchestrates the rotation before writing the new state.
Data Flow: The Rotation Pipeline
	1	Trigger: GameLoop triggers Autosave (Phase Change or Timer).
	2	Orchestration: SaveManager.SaveGameAsync(0) is called.
	3	Rotation (Atomic):
	◦	Delete Slot -2.
	◦	Update Slot -1 → -2.
	◦	Update Slot 0 → -1.
	◦	Commit Transaction.
	4	Write: Create new SaveGame entity for Slot 0.
	5	View: Load Menu aggregates Slots 0, -1, and -2 under an "Autosaves" header.

2. Logic Decision Trees
A. Autosave Rotation Logic Input: None (Context is DB)
	1	Start Transaction.
	2	Fetch Existing: Query SaveGames where SlotNumber <= 0.
	3	Process -2 (Oldest):
	◦	Does Slot -2 exist? -> Delete.
	4	Process -1 (Middle):
	◦	Does Slot -1 exist? -> Update SlotNumber = -2.
	5	Process 0 (Current):
	◦	Does Slot 0 exist? -> Update SlotNumber = -1.
	6	Commit: Save Changes.
B. Load Menu Display Logic Input: List
	1	Group Saves:
	◦	Manual = Slots > 0.
	◦	Auto = Slots <= 0.
	2	Render Manual: Show normally.
	3	Render Auto:
	◦	Sort by SlotNumber descending (0, -1, -2).
	◦	Slot 0: Label "Autosave (Latest)".
	◦	Slot -1: Label "Autosave (Backup)".
	◦	Slot -2: Label "Autosave (Oldest)".

3. Code Implementation
A. Repository Rotation Implementation File: RuneAndRust.Persistence/Repositories/SaveGameRepository.cs
public async Task RotateAutosavesAsync()
{
    // Execute as a single transaction to prevent partial rotation
    using var transaction = _context.Database.BeginTransaction();
    try
    {
        // 1. Delete the oldest backup (-2)
        var oldest = await _dbSet.FirstOrDefaultAsync(s => s.SlotNumber == -2);
        if (oldest != null)
        {
            _dbSet.Remove(oldest);
        }

        // 2. Shift Backup 1 to Backup 2 (-1 -> -2)
        var backup = await _dbSet.FirstOrDefaultAsync(s => s.SlotNumber == -1);
        if (backup != null)
        {
            backup.SlotNumber = -2;
        }

        // 3. Shift Current to Backup 1 (0 -> -1)
        var current = await _dbSet.FirstOrDefaultAsync(s => s.SlotNumber == 0);
        if (current != null)
        {
            current.SlotNumber = -1;
        }

        await _context.SaveChangesAsync();
        await transaction.CommitAsync();
    }
    catch (Exception ex)
    {
        await transaction.RollbackAsync();
        // Log handled by caller, but ensure we don't leave DB in bad state
        throw;
    }
}
B. SaveManager Orchestration File: RuneAndRust.Engine/Services/SaveManager.cs
public async Task SaveGameAsync(int slot, GameState state)
{
    // If saving to the primary autosave slot, rotate previous saves first
    if (slot == 0)
    {
        _logger.LogDebug("[Save] Rotating autosave slots before write.");
        await _repository.RotateAutosavesAsync();
    }

    // ... Standard save logic (create entity, populate metadata, save) ...
}
C. Load Menu Renderer Update File: RuneAndRust.Terminal/Services/TitleScreenService.cs (or LoadScreenRenderer)
private string GetSlotLabel(int slotNumber)
{
    return slotNumber switch
    {
        > 0 => $"[Slot {slotNumber}]",
        0   => "[cyan]Autosave (Latest)[/]",
        -1  => "[grey]Autosave (Backup)[/]",
        -2  => "[grey]Autosave (Oldest)[/]",
        _   => "[red]Corrupted Slot[/]"
    };
}

4. Deliverable Checklist (v0.3.21b)
	•	Persistence:
	◦	[ ] Add RotateAutosavesAsync to ISaveGameRepository.
	◦	[ ] Implement transactional rotation logic in SaveGameRepository.
	•	Engine:
	◦	[ ] Update SaveManager to call rotation when slot == 0.
	◦	[ ] Ensure GameState.Reset doesn't accidentally wipe backups.
	•	Terminal:
	◦	[ ] Update LoadGame command to display negative slots.
	◦	[ ] Format backup slots with dim styling to distinguish from the "Live" save.
	•	Tests:
	◦	[ ] Test rotation logic preserves data integrity.

5. Logging Requirements
Reference: logging.md
System
Event
Level
Message Template
Properties
Persistence
Rotation Start
Trace
"[DB] Starting autosave rotation."
-
Persistence
Shift
Debug
"[DB] Shifted Slot {Old} to {New} (ID: {Id})."
Old, New, Id
Persistence
Prune
Info
"[DB] Pruned oldest backup (Slot -2)."
-
Persistence
Rollback
Error
"[DB] Rotation failed. Rolled back transaction. Error: {Error}"
Error

6. Testing Strategy
Unit Tests (SaveManagerTests.cs):
	•	Save_SlotZero_TriggersRotation:
	◦	Call SaveGameAsync(0, state).
	◦	Verify mockRepository.RotateAutosavesAsync() was called once.
	•	Save_SlotOne_DoesNotRotate:
	◦	Call SaveGameAsync(1, state).
	◦	Verify RotateAutosavesAsync was never called.
Integration Tests (PersistenceTests.cs):
	•	Rotation_PreservesHistory:
	1	Save "State A" to Slot 0.
	2	Save "State B" to Slot 0.
	3	Save "State C" to Slot 0.
	4	Verify DB:
	▪	Slot 0 contains "State C".
	▪	Slot -1 contains "State B".
	▪	Slot -2 contains "State A".
	•	Rotation_DropsOldest:
	1	Perform 4 saves.
	2	Verify the 1st save is gone (deleted from Slot -2).

7. Draft Changelog (v0.3.21b)
# Changelog: v0.3.21b - The Vault

**Release Date:** 2026-02-XX

## Summary
The second phase of "The Steward" update introduces the Rolling Backup system. The game now automatically maintains a history of the last three autosaves, ensuring that a single fatal error or corrupted state does not destroy an entire playthrough.

## Changes
- **Persistence:** Implemented transactional autosave rotation. New autosaves push existing ones to backup slots (-1 and -2).
- **Engine:** Updated SaveManager to trigger rotation automatically when saving to the primary autosave slot.
- **UI:** The Load Game menu now displays backup saves with distinct labels, allowing players to revert to a previous state if needed.