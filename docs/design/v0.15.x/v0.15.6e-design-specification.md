# v0.15.6e Design Specification: Puzzle Hint Integration

**Version:** 0.15.6e
**Parent:** v0.15.6 (Advanced Perception System)
**Prerequisites:** v0.15.6d Complete (Flora & Fauna Observation)
**Status:** Design Complete

---

## Table of Contents

1. [Overview](#1-overview)
2. [Scope](#2-scope)
3. [Data Model](#3-data-model)
4. [Services](#4-services)
5. [Command Changes](#5-command-changes)
6. [Rendering Changes](#6-rendering-changes)
7. [Configuration](#7-configuration)
8. [Integration with Existing Systems](#8-integration-with-existing-systems)
9. [Acceptance Criteria](#9-acceptance-criteria)
10. [Test Specifications](#10-test-specifications)
11. [Dependencies](#11-dependencies)
12. [Implementation Notes](#12-implementation-notes)
13. [Design Decisions](#13-design-decisions)
14. [Future Considerations](#14-future-considerations)
15. [Appendix A: Puzzle Hint Examples](#appendix-a-puzzle-hint-examples)
16. [Appendix B: Interaction Unlock Reference](#appendix-b-interaction-unlock-reference)

---

## 1. Overview

### 1.1 Purpose

This phase integrates puzzle hints into the examination system, enabling expert-level examination (Layer 3) to reveal puzzle-related information and unlock new interactions. When players achieve DC 18 success on examination checks, they may discover hints that provide clues to nearby puzzles, unlock new commands, or reveal solution approaches. This creates a meaningful reward for high Wits investment and encourages thorough environmental exploration.

### 1.2 Key Changes

| Area | Current State (v0.15.6d) | Target State (v0.15.6e) |
|------|--------------------------|------------------------|
| Expert Examination | Reveals alchemical uses, harvest info | Also reveals puzzle hints and unlocks interactions |
| Object Linking | Objects standalone | Objects can link to puzzles via ExaminationHintLink |
| Player Knowledge | Discovery tracking for species | Discovery tracking for hints and puzzle progress |
| Commands | Static command set | Dynamic command unlocks from hint reveals |
| Puzzle Progress | Not tracked | Hint discovery contributes to puzzle state |

### 1.3 Design Principles

1. **Skill Reward**: Expert examination (DC 18) provides meaningful gameplay advantages
2. **Progressive Discovery**: Hints build toward puzzle solutions without giving answers directly
3. **Interaction Expansion**: Discovering hints can unlock new commands and interactions
4. **Conditional Reveals**: Some hints require prerequisites (items, prior discoveries)
5. **Non-Blocking Design**: Puzzles remain solvable through other means; hints provide shortcuts

---

## 2. Scope

### 2.1 In Scope

- PuzzleHint value object with hint levels and unlock data
- ExaminationHintLink value object connecting objects to puzzle hints
- IPuzzleHintService interface for hint discovery and tracking
- Hint reveal on expert examination (Layer 3)
- Interaction unlocking from hint discovery
- Player hint discovery tracking
- Configuration file: puzzle-hints.json
- Integration with IExaminationService for hint reveals

### 2.2 Out of Scope (Future Phases)

- Search command enhancement (v0.15.6f)
- Investigation command for clue deduction (v0.15.6g)
- Specialization bonuses for perception (v0.15.6h)
- Room entry integration flow (v0.15.6i)
- Full puzzle system implementation (future version)
- Puzzle state persistence (future version)
- Multi-step puzzle chains (future version)

---

## 3. Data Model

### 3.1 PuzzleHint Value Object

```csharp
/// <summary>
/// Represents a hint that can be discovered through expert examination,
/// providing clues to puzzle solutions and optionally unlocking new interactions.
/// </summary>
/// <remarks>
/// <para>
/// Puzzle hints are discovered when players achieve Layer 3 (Expert) examination
/// results on objects that have linked hints. Hints vary in subtlety from
/// Level 1 (cryptic) to Level 3 (obvious), allowing puzzle designers to
/// provide graduated assistance.
/// </para>
/// <para>
/// Some hints unlock new commands that weren't previously available, enabling
/// players to interact with the environment in new ways after demonstrating
/// their observational skills.
/// </para>
/// </remarks>
/// <param name="HintId">Unique identifier for this hint (e.g., "hint-env-console-override-01").</param>
/// <param name="PuzzleId">The puzzle this hint relates to (e.g., "puzzle-level7-door").</param>
/// <param name="HintLevel">Subtlety level: 1 = subtle/cryptic, 2 = moderate, 3 = obvious/direct.</param>
/// <param name="RevealedBy">How this hint is discovered: "examination", "perception", or "dialogue".</param>
/// <param name="HintText">The hint text shown to the player upon discovery.</param>
/// <param name="UnlocksInteraction">Optional new command unlocked by this hint (e.g., "override console").</param>
public readonly record struct PuzzleHint(
    string HintId,
    string PuzzleId,
    int HintLevel,
    string RevealedBy,
    string HintText,
    string? UnlocksInteraction)
{
    /// <summary>
    /// Gets whether this hint unlocks a new interaction/command.
    /// </summary>
    public bool HasInteractionUnlock => !string.IsNullOrEmpty(UnlocksInteraction);

    /// <summary>
    /// Gets whether this is a subtle hint (Level 1).
    /// </summary>
    public bool IsSubtle => HintLevel == 1;

    /// <summary>
    /// Gets whether this is an obvious hint (Level 3).
    /// </summary>
    public bool IsObvious => HintLevel == 3;

    /// <summary>
    /// Gets whether this hint is revealed through examination.
    /// </summary>
    public bool IsExaminationHint => RevealedBy.Equals("examination", StringComparison.OrdinalIgnoreCase);

    /// <summary>
    /// Creates a display string for hint revelation.
    /// </summary>
    /// <returns>A formatted string for displaying the hint discovery.</returns>
    public string ToRevealString()
    {
        var interactionNote = HasInteractionUnlock
            ? $"\n[New command available: {UnlocksInteraction}]"
            : "";
        return $"[Hint revealed: {HintText}]{interactionNote}";
    }

    /// <summary>
    /// Gets the hint level description for display.
    /// </summary>
    /// <returns>A description of the hint's subtlety level.</returns>
    public string GetLevelDescription()
    {
        return HintLevel switch
        {
            1 => "Cryptic",
            2 => "Moderate",
            3 => "Direct",
            _ => "Unknown"
        };
    }
}
```

### 3.2 ExaminationHintLink Value Object

```csharp
/// <summary>
/// Links an examinable object to a puzzle hint, defining when and how
/// the hint is revealed through the examination system.
/// </summary>
/// <remarks>
/// <para>
/// ExaminationHintLink creates the connection between objects in the game
/// world and puzzle hints. When a player examines an object and achieves
/// the required layer, the linked hint is revealed if all conditions are met.
/// </para>
/// <para>
/// Optional reveal conditions allow for prerequisite-based hints that only
/// appear after certain items are obtained or other hints are discovered.
/// </para>
/// </remarks>
/// <param name="ObjectId">The examinable object ID that can reveal this hint.</param>
/// <param name="RequiredLayer">The examination layer required (typically 3 for Expert).</param>
/// <param name="PuzzleId">The puzzle this link relates to.</param>
/// <param name="HintId">The specific hint to reveal.</param>
/// <param name="RevealCondition">Optional prerequisite condition (item ID, prior hint ID, or null).</param>
public readonly record struct ExaminationHintLink(
    string ObjectId,
    int RequiredLayer,
    string PuzzleId,
    string HintId,
    string? RevealCondition)
{
    /// <summary>
    /// Gets whether this link has a prerequisite condition.
    /// </summary>
    public bool HasCondition => !string.IsNullOrEmpty(RevealCondition);

    /// <summary>
    /// Gets whether this link requires expert examination (Layer 3).
    /// </summary>
    public bool RequiresExpertExamination => RequiredLayer >= 3;

    /// <summary>
    /// Checks if the required layer has been achieved.
    /// </summary>
    /// <param name="achievedLayer">The layer achieved by the examination.</param>
    /// <returns>True if the achieved layer meets or exceeds the requirement.</returns>
    public bool IsLayerSatisfied(int achievedLayer)
    {
        return achievedLayer >= RequiredLayer;
    }
}
```

### 3.3 HintRevealResult Value Object

```csharp
/// <summary>
/// Contains the result of checking for and revealing puzzle hints
/// during an examination, including any newly unlocked interactions.
/// </summary>
/// <remarks>
/// This result is returned by IPuzzleHintService.CheckForHints() and
/// integrated into the ExaminationResult to provide complete feedback
/// to the player about their discovery.
/// </remarks>
/// <param name="ObjectId">The examined object.</param>
/// <param name="HintsRevealed">List of hints discovered during this examination.</param>
/// <param name="InteractionsUnlocked">List of new commands now available.</param>
/// <param name="ConditionsNotMet">List of hints that exist but weren't revealed due to unmet conditions.</param>
public readonly record struct HintRevealResult(
    string ObjectId,
    IReadOnlyList<PuzzleHint> HintsRevealed,
    IReadOnlyList<string> InteractionsUnlocked,
    int ConditionsNotMet)
{
    /// <summary>
    /// Gets whether any hints were revealed.
    /// </summary>
    public bool HasRevealedHints => HintsRevealed.Count > 0;

    /// <summary>
    /// Gets whether any new interactions were unlocked.
    /// </summary>
    public bool HasUnlockedInteractions => InteractionsUnlocked.Count > 0;

    /// <summary>
    /// Gets whether there are hints the player couldn't access due to conditions.
    /// </summary>
    public bool HasHiddenHints => ConditionsNotMet > 0;

    /// <summary>
    /// Gets the total number of hints revealed.
    /// </summary>
    public int TotalHintsRevealed => HintsRevealed.Count;

    /// <summary>
    /// Creates a display-ready summary of the reveal result.
    /// </summary>
    /// <returns>A formatted string summarizing what was discovered.</returns>
    public string ToSummaryString()
    {
        if (!HasRevealedHints)
        {
            return string.Empty;
        }

        var parts = new List<string>();
        foreach (var hint in HintsRevealed)
        {
            parts.Add(hint.ToRevealString());
        }

        return string.Join("\n", parts);
    }
}
```

### 3.4 DiscoveredHint Value Object

```csharp
/// <summary>
/// Tracks a hint that has been discovered by the player, including
/// when and where it was found for puzzle progress tracking.
/// </summary>
/// <remarks>
/// Discovery tracking enables the game to:
/// 1. Prevent re-displaying already-discovered hints
/// 2. Track puzzle progress based on hints found
/// 3. Satisfy reveal conditions for dependent hints
/// 4. Maintain unlocked interactions across sessions
/// </remarks>
/// <param name="HintId">The discovered hint ID.</param>
/// <param name="PuzzleId">The puzzle this hint relates to.</param>
/// <param name="DiscoveredAt">When the hint was discovered.</param>
/// <param name="DiscoveredInRoom">The room where discovery occurred.</param>
/// <param name="DiscoveredFromObject">The object examined to reveal this hint.</param>
public readonly record struct DiscoveredHint(
    string HintId,
    string PuzzleId,
    DateTime DiscoveredAt,
    string DiscoveredInRoom,
    string DiscoveredFromObject)
{
    /// <summary>
    /// Gets how long ago this hint was discovered.
    /// </summary>
    public TimeSpan TimeSinceDiscovery => DateTime.UtcNow - DiscoveredAt;

    /// <summary>
    /// Creates a journal-style entry for this discovery.
    /// </summary>
    /// <returns>A formatted string for display in hint logs.</returns>
    public string ToJournalEntry()
    {
        return $"[{DiscoveredAt:HH:mm}] Discovered in {DiscoveredInRoom} (from {DiscoveredFromObject})";
    }
}
```

### 3.5 UnlockedInteraction Value Object

```csharp
/// <summary>
/// Represents a command/interaction that has been unlocked through hint discovery,
/// enabling the player to perform actions that weren't previously available.
/// </summary>
/// <remarks>
/// Unlocked interactions persist across the session and are checked when
/// parsing player commands. Commands that haven't been unlocked will not
/// be recognized until the appropriate hint is discovered.
/// </remarks>
/// <param name="InteractionId">Unique identifier for this interaction.</param>
/// <param name="CommandText">The command text to type (e.g., "override console").</param>
/// <param name="TargetObjectId">The object this interaction targets.</param>
/// <param name="UnlockedByHintId">The hint that unlocked this interaction.</param>
/// <param name="Description">A brief description of what this command does.</param>
public readonly record struct UnlockedInteraction(
    string InteractionId,
    string CommandText,
    string TargetObjectId,
    string UnlockedByHintId,
    string Description)
{
    /// <summary>
    /// Checks if this interaction matches the given command input.
    /// </summary>
    /// <param name="input">The player's command input.</param>
    /// <returns>True if the input matches this interaction's command.</returns>
    public bool MatchesCommand(string input)
    {
        return CommandText.Equals(input.Trim(), StringComparison.OrdinalIgnoreCase);
    }

    /// <summary>
    /// Creates a help-style display string for this interaction.
    /// </summary>
    /// <returns>A formatted string showing the command and its description.</returns>
    public string ToHelpString()
    {
        return $"{CommandText} - {Description}";
    }
}
```

---

## 4. Services

### 4.1 IPuzzleHintService Interface

```csharp
/// <summary>
/// Service interface for puzzle hint discovery, tracking, and interaction
/// unlocking within the examination system.
/// </summary>
/// <remarks>
/// <para>
/// This service manages the relationship between examination results and
/// puzzle hints, checking for applicable hints when expert examination
/// succeeds and tracking what the player has discovered.
/// </para>
/// <para>
/// The service also manages unlocked interactions, which are commands
/// that become available only after specific hints are discovered.
/// </para>
/// </remarks>
public interface IPuzzleHintService
{
    /// <summary>
    /// Checks for puzzle hints that can be revealed from an examination result.
    /// </summary>
    /// <remarks>
    /// <para>
    /// This method is called after an examination check succeeds at Layer 3
    /// (Expert). It looks up any ExaminationHintLinks for the object and
    /// checks if their conditions are met.
    /// </para>
    /// <para>
    /// Hints are only revealed once per player; subsequent examinations of
    /// the same object will not re-reveal already-discovered hints.
    /// </para>
    /// </remarks>
    /// <param name="objectId">The examined object ID.</param>
    /// <param name="achievedLayer">The examination layer achieved (1, 2, or 3).</param>
    /// <param name="characterId">The examining character's ID.</param>
    /// <returns>A result containing any revealed hints and unlocked interactions.</returns>
    HintRevealResult CheckForHints(string objectId, int achievedLayer, string characterId);

    /// <summary>
    /// Gets all hints the player has discovered for a specific puzzle.
    /// </summary>
    /// <param name="puzzleId">The puzzle ID to check.</param>
    /// <param name="characterId">The character ID.</param>
    /// <returns>List of discovered hints for this puzzle.</returns>
    IReadOnlyList<DiscoveredHint> GetDiscoveredHintsForPuzzle(string puzzleId, string characterId);

    /// <summary>
    /// Gets all hints the player has discovered across all puzzles.
    /// </summary>
    /// <param name="characterId">The character ID.</param>
    /// <returns>List of all discovered hints.</returns>
    IReadOnlyList<DiscoveredHint> GetAllDiscoveredHints(string characterId);

    /// <summary>
    /// Checks if a specific hint has been discovered.
    /// </summary>
    /// <param name="hintId">The hint ID to check.</param>
    /// <param name="characterId">The character ID.</param>
    /// <returns>True if the hint has been discovered.</returns>
    bool IsHintDiscovered(string hintId, string characterId);

    /// <summary>
    /// Gets all interactions the player has unlocked through hint discovery.
    /// </summary>
    /// <param name="characterId">The character ID.</param>
    /// <returns>List of unlocked interactions.</returns>
    IReadOnlyList<UnlockedInteraction> GetUnlockedInteractions(string characterId);

    /// <summary>
    /// Checks if a specific interaction has been unlocked.
    /// </summary>
    /// <param name="commandText">The command text to check.</param>
    /// <param name="characterId">The character ID.</param>
    /// <returns>True if the interaction is available.</returns>
    bool IsInteractionUnlocked(string commandText, string characterId);

    /// <summary>
    /// Gets the puzzle hint by ID.
    /// </summary>
    /// <param name="hintId">The hint ID.</param>
    /// <returns>The puzzle hint, or null if not found.</returns>
    PuzzleHint? GetHintById(string hintId);

    /// <summary>
    /// Gets all hints for a specific puzzle (regardless of discovery state).
    /// </summary>
    /// <param name="puzzleId">The puzzle ID.</param>
    /// <returns>All hints associated with this puzzle.</returns>
    IReadOnlyList<PuzzleHint> GetHintsForPuzzle(string puzzleId);
}
```

### 4.2 PuzzleHintService Implementation

```csharp
/// <summary>
/// Implementation of IPuzzleHintService providing puzzle hint discovery,
/// tracking, and interaction management.
/// </summary>
/// <remarks>
/// <para>
/// This service loads hint data from puzzle-hints.json and manages
/// player discovery state. It integrates with the examination system
/// to reveal hints when expert examination succeeds.
/// </para>
/// <para>
/// Reveal conditions are evaluated against the player's current state,
/// including inventory items and previously discovered hints.
/// </para>
/// </remarks>
public class PuzzleHintService : IPuzzleHintService
{
    private readonly IPuzzleHintRepository _hintRepository;
    private readonly IExaminationHintLinkRepository _linkRepository;
    private readonly IPlayerHintTracker _hintTracker;
    private readonly IInventoryService _inventoryService;
    private readonly ILogger<PuzzleHintService> _logger;

    public PuzzleHintService(
        IPuzzleHintRepository hintRepository,
        IExaminationHintLinkRepository linkRepository,
        IPlayerHintTracker hintTracker,
        IInventoryService inventoryService,
        ILogger<PuzzleHintService> logger)
    {
        _hintRepository = hintRepository ?? throw new ArgumentNullException(nameof(hintRepository));
        _linkRepository = linkRepository ?? throw new ArgumentNullException(nameof(linkRepository));
        _hintTracker = hintTracker ?? throw new ArgumentNullException(nameof(hintTracker));
        _inventoryService = inventoryService ?? throw new ArgumentNullException(nameof(inventoryService));
        _logger = logger ?? throw new ArgumentNullException(nameof(logger));
    }

    /// <inheritdoc />
    public HintRevealResult CheckForHints(string objectId, int achievedLayer, string characterId)
    {
        _logger.LogDebug(
            "Checking for hints on object {ObjectId} at layer {Layer} for character {CharacterId}",
            objectId, achievedLayer, characterId);

        // Get all links for this object
        var links = _linkRepository.GetLinksForObject(objectId);

        if (links.Count == 0)
        {
            _logger.LogDebug("No hint links found for object {ObjectId}", objectId);
            return new HintRevealResult(objectId, Array.Empty<PuzzleHint>(), Array.Empty<string>(), 0);
        }

        var revealedHints = new List<PuzzleHint>();
        var unlockedInteractions = new List<string>();
        var conditionsNotMet = 0;

        foreach (var link in links)
        {
            // Check if layer requirement is met
            if (!link.IsLayerSatisfied(achievedLayer))
            {
                _logger.LogDebug(
                    "Layer {Achieved} does not satisfy requirement {Required} for link to hint {HintId}",
                    achievedLayer, link.RequiredLayer, link.HintId);
                continue;
            }

            // Check if already discovered
            if (_hintTracker.IsHintDiscovered(link.HintId, characterId))
            {
                _logger.LogDebug("Hint {HintId} already discovered by {CharacterId}", link.HintId, characterId);
                continue;
            }

            // Check reveal condition if present
            if (link.HasCondition && !EvaluateCondition(link.RevealCondition!, characterId))
            {
                _logger.LogDebug(
                    "Condition '{Condition}' not met for hint {HintId}",
                    link.RevealCondition, link.HintId);
                conditionsNotMet++;
                continue;
            }

            // Get and reveal the hint
            var hint = _hintRepository.GetById(link.HintId);
            if (hint == null)
            {
                _logger.LogWarning("Hint {HintId} not found in repository", link.HintId);
                continue;
            }

            // Mark as discovered
            _hintTracker.MarkHintDiscovered(
                link.HintId,
                link.PuzzleId,
                characterId,
                objectId);

            revealedHints.Add(hint.Value);

            // Check for interaction unlock
            if (hint.Value.HasInteractionUnlock)
            {
                _hintTracker.UnlockInteraction(hint.Value.UnlocksInteraction!, characterId, link.HintId);
                unlockedInteractions.Add(hint.Value.UnlocksInteraction!);
                _logger.LogInformation(
                    "Unlocked interaction '{Interaction}' for character {CharacterId}",
                    hint.Value.UnlocksInteraction, characterId);
            }
        }

        _logger.LogDebug(
            "Hint check complete: {Revealed} hints revealed, {Unlocked} interactions unlocked, {NotMet} conditions not met",
            revealedHints.Count, unlockedInteractions.Count, conditionsNotMet);

        return new HintRevealResult(objectId, revealedHints, unlockedInteractions, conditionsNotMet);
    }

    /// <inheritdoc />
    public IReadOnlyList<DiscoveredHint> GetDiscoveredHintsForPuzzle(string puzzleId, string characterId)
    {
        return _hintTracker.GetDiscoveredHintsForPuzzle(puzzleId, characterId);
    }

    /// <inheritdoc />
    public IReadOnlyList<DiscoveredHint> GetAllDiscoveredHints(string characterId)
    {
        return _hintTracker.GetAllDiscoveredHints(characterId);
    }

    /// <inheritdoc />
    public bool IsHintDiscovered(string hintId, string characterId)
    {
        return _hintTracker.IsHintDiscovered(hintId, characterId);
    }

    /// <inheritdoc />
    public IReadOnlyList<UnlockedInteraction> GetUnlockedInteractions(string characterId)
    {
        return _hintTracker.GetUnlockedInteractions(characterId);
    }

    /// <inheritdoc />
    public bool IsInteractionUnlocked(string commandText, string characterId)
    {
        var interactions = _hintTracker.GetUnlockedInteractions(characterId);
        return interactions.Any(i => i.MatchesCommand(commandText));
    }

    /// <inheritdoc />
    public PuzzleHint? GetHintById(string hintId)
    {
        return _hintRepository.GetById(hintId);
    }

    /// <inheritdoc />
    public IReadOnlyList<PuzzleHint> GetHintsForPuzzle(string puzzleId)
    {
        return _hintRepository.GetByPuzzleId(puzzleId);
    }

    /// <summary>
    /// Evaluates a reveal condition to determine if it's satisfied.
    /// </summary>
    /// <param name="condition">The condition string (item ID or hint ID).</param>
    /// <param name="characterId">The character to check.</param>
    /// <returns>True if the condition is satisfied.</returns>
    private bool EvaluateCondition(string condition, string characterId)
    {
        // Check if condition is a hint ID (starts with "hint-")
        if (condition.StartsWith("hint-", StringComparison.OrdinalIgnoreCase))
        {
            return _hintTracker.IsHintDiscovered(condition, characterId);
        }

        // Check if condition is an item ID (starts with "item-")
        if (condition.StartsWith("item-", StringComparison.OrdinalIgnoreCase))
        {
            return _inventoryService.HasItem(characterId, condition);
        }

        // Unknown condition type - log warning and fail safely
        _logger.LogWarning("Unknown condition type: {Condition}", condition);
        return false;
    }
}
```

### 4.3 IPlayerHintTracker Interface

```csharp
/// <summary>
/// Tracks player hint discoveries and unlocked interactions for
/// puzzle progression and command availability.
/// </summary>
/// <remarks>
/// This tracker maintains the player's discovery state across the session,
/// enabling the puzzle hint system to avoid re-revealing hints and to
/// validate that unlocked interactions are available.
/// </remarks>
public interface IPlayerHintTracker
{
    /// <summary>
    /// Marks a hint as discovered by the player.
    /// </summary>
    /// <param name="hintId">The discovered hint ID.</param>
    /// <param name="puzzleId">The puzzle this hint relates to.</param>
    /// <param name="characterId">The discovering character.</param>
    /// <param name="objectId">The object examined to reveal the hint.</param>
    void MarkHintDiscovered(string hintId, string puzzleId, string characterId, string objectId);

    /// <summary>
    /// Checks if a hint has been discovered.
    /// </summary>
    /// <param name="hintId">The hint ID to check.</param>
    /// <param name="characterId">The character ID.</param>
    /// <returns>True if discovered.</returns>
    bool IsHintDiscovered(string hintId, string characterId);

    /// <summary>
    /// Gets all discovered hints for a puzzle.
    /// </summary>
    /// <param name="puzzleId">The puzzle ID.</param>
    /// <param name="characterId">The character ID.</param>
    /// <returns>List of discovered hints.</returns>
    IReadOnlyList<DiscoveredHint> GetDiscoveredHintsForPuzzle(string puzzleId, string characterId);

    /// <summary>
    /// Gets all discovered hints.
    /// </summary>
    /// <param name="characterId">The character ID.</param>
    /// <returns>List of all discovered hints.</returns>
    IReadOnlyList<DiscoveredHint> GetAllDiscoveredHints(string characterId);

    /// <summary>
    /// Unlocks an interaction for the player.
    /// </summary>
    /// <param name="commandText">The command text to unlock.</param>
    /// <param name="characterId">The character ID.</param>
    /// <param name="unlockedByHintId">The hint that unlocked this.</param>
    void UnlockInteraction(string commandText, string characterId, string unlockedByHintId);

    /// <summary>
    /// Gets all unlocked interactions.
    /// </summary>
    /// <param name="characterId">The character ID.</param>
    /// <returns>List of unlocked interactions.</returns>
    IReadOnlyList<UnlockedInteraction> GetUnlockedInteractions(string characterId);
}
```

### 4.4 Repository Interfaces

```csharp
/// <summary>
/// Repository interface for loading puzzle hints from configuration.
/// </summary>
public interface IPuzzleHintRepository
{
    /// <summary>
    /// Gets a hint by its unique ID.
    /// </summary>
    /// <param name="hintId">The hint ID.</param>
    /// <returns>The hint, or null if not found.</returns>
    PuzzleHint? GetById(string hintId);

    /// <summary>
    /// Gets all hints for a specific puzzle.
    /// </summary>
    /// <param name="puzzleId">The puzzle ID.</param>
    /// <returns>All hints for this puzzle.</returns>
    IReadOnlyList<PuzzleHint> GetByPuzzleId(string puzzleId);

    /// <summary>
    /// Gets all hints in the system.
    /// </summary>
    /// <returns>All configured hints.</returns>
    IReadOnlyList<PuzzleHint> GetAll();
}

/// <summary>
/// Repository interface for loading examination-hint links from configuration.
/// </summary>
public interface IExaminationHintLinkRepository
{
    /// <summary>
    /// Gets all hint links for a specific object.
    /// </summary>
    /// <param name="objectId">The object ID.</param>
    /// <returns>All links for this object.</returns>
    IReadOnlyList<ExaminationHintLink> GetLinksForObject(string objectId);

    /// <summary>
    /// Gets all links for a specific puzzle.
    /// </summary>
    /// <param name="puzzleId">The puzzle ID.</param>
    /// <returns>All links for this puzzle.</returns>
    IReadOnlyList<ExaminationHintLink> GetLinksForPuzzle(string puzzleId);

    /// <summary>
    /// Gets all configured links.
    /// </summary>
    /// <returns>All examination-hint links.</returns>
    IReadOnlyList<ExaminationHintLink> GetAll();
}
```

### 4.5 Service Flow Diagram

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                     PUZZLE HINT INTEGRATION FLOW                             │
└─────────────────────────────────────────────────────────────────────────────┘

    Player uses 'examine <object>' command
                        │
                        ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                    EXAMINATION SERVICE (v0.15.6b)                            │
├─────────────────────────────────────────────────────────────────────────────┤
│  1. Roll Wits pool using success-counting                                   │
│  2. Determine highest layer achieved (1, 2, or 3)                           │
│  3. Build composite description from unlocked layers                        │
└─────────────────────────────────────────────────────────────────────────────┘
                        │
                        │ If Layer 3 (Expert) achieved
                        ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                    PUZZLE HINT SERVICE (v0.15.6e)                            │
├─────────────────────────────────────────────────────────────────────────────┤
│  1. Look up ExaminationHintLinks for this object                            │
│  2. For each link where RequiredLayer <= AchievedLayer:                     │
│     a. Check if hint already discovered → skip if true                      │
│     b. Evaluate RevealCondition (if present):                               │
│        - "hint-xxx": Check if prior hint discovered                         │
│        - "item-xxx": Check if item in inventory                             │
│     c. If conditions met:                                                   │
│        - Mark hint as discovered                                            │
│        - If hint has UnlocksInteraction:                                    │
│          - Add to player's unlocked interactions                            │
│  3. Return HintRevealResult with hints and interactions                     │
└─────────────────────────────────────────────────────────────────────────────┘
                        │
                        ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                    EXAMINATION RESULT COMPOSITION                            │
├─────────────────────────────────────────────────────────────────────────────┤
│  ExaminationResult now includes:                                            │
│  - CompositeDescription (layers 1-3 as appropriate)                         │
│  - RevealedHints (list of PuzzleHint)                                       │
│  - UnlockedInteractions (list of new commands)                              │
│  - RevealedSolutionId (if hint provides direct solution)                    │
└─────────────────────────────────────────────────────────────────────────────┘
                        │
                        ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                    RENDERER OUTPUT                                           │
├─────────────────────────────────────────────────────────────────────────────┤
│  1. Display examination header and layers                                   │
│  2. If hints revealed:                                                      │
│     - Show "[Hint revealed: <hint text>]"                                   │
│     - If interaction unlocked:                                              │
│       - Show "[New command available: <command>]"                           │
└─────────────────────────────────────────────────────────────────────────────┘


    Player uses unlocked command (e.g., 'override console')
                        │
                        ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                    COMMAND PARSING                                           │
├─────────────────────────────────────────────────────────────────────────────┤
│  1. Check if command matches standard commands → handle normally            │
│  2. Check if command matches unlocked interaction:                          │
│     - Query IPuzzleHintService.IsInteractionUnlocked()                      │
│     - If unlocked: route to interaction handler                             │
│     - If not unlocked: "You don't know how to do that."                     │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 5. Command Changes

### 5.1 Dynamic Command Recognition

The command parser is updated to recognize unlocked interactions in addition to standard commands.

```csharp
// In ConsoleInputHandler.ParseCommand():

private GameCommand ParseCommand(string input, string characterId)
{
    var parts = input.Trim().Split(' ', 2);
    var command = parts[0].ToLowerInvariant();
    var argument = parts.Length > 1 ? parts[1] : null;

    // First, check standard commands
    var standardCommand = ParseStandardCommand(command, argument);
    if (standardCommand != null)
    {
        return standardCommand;
    }

    // Then, check for unlocked interactions
    if (_puzzleHintService.IsInteractionUnlocked(input, characterId))
    {
        return new UnlockedInteractionCommand(input);
    }

    // Unknown command
    return new UnknownCommand(input);
}
```

### 5.2 UnlockedInteractionCommand

```csharp
/// <summary>
/// Command representing an interaction that was unlocked through hint discovery.
/// </summary>
/// <param name="CommandText">The full command text entered by the player.</param>
public record UnlockedInteractionCommand(string CommandText) : GameCommand;
```

### 5.3 HintsCommand (New)

```csharp
/// <summary>
/// Command to display discovered hints, optionally filtered by puzzle.
/// </summary>
/// <param name="PuzzleFilter">Optional puzzle ID to filter hints.</param>
public record HintsCommand(string? PuzzleFilter = null) : GameCommand;

// In ConsoleInputHandler.ParseCommand():

"hints" or "clues" => ParseHintsCommand(argument),

private GameCommand ParseHintsCommand(string? argument)
{
    return new HintsCommand(argument?.Trim());
}
```

### 5.4 User Commands

| Command | Description | Example |
|---------|-------------|---------|
| `examine <object>` | Examines object; may reveal hints at Layer 3 | `examine console` |
| `hints` | Lists all discovered hints | `hints` |
| `hints <puzzle>` | Lists hints for a specific puzzle | `hints level7-door` |
| `clues` | Alias for hints command | `clues` |
| `<unlocked>` | Uses an unlocked interaction | `override console` |

---

## 6. Rendering Changes

### 6.1 IGameRenderer Additions

```csharp
/// <summary>
/// Renders puzzle hint discovery during examination.
/// </summary>
/// <param name="hints">The revealed hints.</param>
/// <param name="ct">Cancellation token.</param>
Task RenderHintRevealAsync(IReadOnlyList<PuzzleHint> hints, CancellationToken ct = default);

/// <summary>
/// Renders interaction unlock notification.
/// </summary>
/// <param name="interactions">The newly unlocked interactions.</param>
/// <param name="ct">Cancellation token.</param>
Task RenderInteractionUnlockAsync(IReadOnlyList<string> interactions, CancellationToken ct = default);

/// <summary>
/// Renders the player's discovered hints list.
/// </summary>
/// <param name="hints">All discovered hints.</param>
/// <param name="puzzleFilter">Optional puzzle filter applied.</param>
/// <param name="ct">Cancellation token.</param>
Task RenderDiscoveredHintsAsync(
    IReadOnlyList<DiscoveredHint> hints,
    string? puzzleFilter,
    CancellationToken ct = default);
```

### 6.2 Display Examples

#### Expert Examination with Hint Reveal

```
> examine console

[WITS Check vs DC 18]
Rolling... 4 successes

═══════════════════════════════════════════════════════════════════════════════
              JÖTUN ENVIRONMENTAL CONTROL CONSOLE (ENV-4422)
═══════════════════════════════════════════════════════════════════════════════

A massive control console built into the wall, its surface covered with
buttons, levers, and flickering display screens.

The console appears to control environmental systems for this section
of the facility. Several warning lights are active, indicating system
faults in sectors 7 through 12.

A Jötun Environmental Control Console, Designation ENV-4422. Analysis
of the interface reveals it could potentially be used to divert power,
vent atmospheres, or even access locked-down emergency protocols. The
authentication system shows signs of corruption—a skilled operator
might be able to bypass security entirely.

───────────────────────────────────────────────────────────────────────────────
[Hint revealed: Console Override (WITS DC 4)]
[New command available: override console]
───────────────────────────────────────────────────────────────────────────────

> _
```

#### Expert Examination with Conditional Hint (Condition Not Met)

```
> examine sealed door

[WITS Check vs DC 18]
Rolling... 5 successes

═══════════════════════════════════════════════════════════════════════════════
                    LEVEL 7 SECURITY DOOR (SEALED)
═══════════════════════════════════════════════════════════════════════════════

A heavy blast door bearing the markings of Level 7 Security Clearance.
It is firmly sealed and shows no obvious mechanism for manual override.

The door uses a combination of physical interlocks and runic authentication.
The physical mechanism appears damaged, with scorch marks around the frame.

Analysis of the runic patterns reveals this door responds to a specific
command cipher. The cipher appears to be divided—part is etched on the
door itself, but the completion sequence would be found elsewhere.

[You sense there is more to discover here, but something is missing...]

> _
```

#### Expert Examination with Conditional Hint (Condition Met)

```
> examine sealed door

[WITS Check vs DC 18]
Rolling... 4 successes

═══════════════════════════════════════════════════════════════════════════════
                    LEVEL 7 SECURITY DOOR (SEALED)
═══════════════════════════════════════════════════════════════════════════════

A heavy blast door bearing the markings of Level 7 Security Clearance.
It is firmly sealed and shows no obvious mechanism for manual override.

The door uses a combination of physical interlocks and runic authentication.
The physical mechanism appears damaged, with scorch marks around the frame.

Analysis of the runic patterns reveals this door responds to a specific
command cipher. The cipher appears to be divided—part is etched on the
door itself, but the completion sequence would be found elsewhere.

Comparing the cipher fragment on the door with the Command Tablet in your
possession, you recognize the completion sequence. The full cipher would
allow you to speak the command phrase that unseals the door.

───────────────────────────────────────────────────────────────────────────────
[Hint revealed: Door Cipher (speak "Jötun-vaka")]
[New command available: speak jotun-vaka]
───────────────────────────────────────────────────────────────────────────────

> _
```

#### Hints Command Output

```
> hints

═══════════════════════════════════════════════════════════════════════════════
                          DISCOVERED HINTS
═══════════════════════════════════════════════════════════════════════════════

Level 7 Access (puzzle-level7-door):
  ● Console Override (WITS DC 4) - discovered in Control Room
    → Command unlocked: override console

  ● Door Cipher (speak "Jötun-vaka") - discovered in Corridor B
    → Command unlocked: speak jotun-vaka

Power Restoration (puzzle-power-grid):
  ● Generator Location - discovered in Maintenance Bay
    "The backup generator is in the lower level."

───────────────────────────────────────────────────────────────────────────────
3 hints discovered across 2 puzzles
───────────────────────────────────────────────────────────────────────────────

> _
```

#### Using an Unlocked Interaction

```
> override console

You manipulate the corrupted authentication system, exploiting the
security flaw you identified earlier...

[WITS Check vs DC 4]
Rolling... 2 successes

SUCCESS! The console accepts your override. Emergency protocols are
now accessible.

[New interaction available: access protocols]

> _
```

---

## 7. Configuration

### 7.1 puzzle-hints.json

```json
{
  "version": "0.15.6e",
  "hints": [
    {
      "hintId": "hint-console-override-01",
      "puzzleId": "puzzle-level7-door",
      "hintLevel": 2,
      "revealedBy": "examination",
      "hintText": "Console Override (WITS DC 4)",
      "unlocksInteraction": "override console"
    },
    {
      "hintId": "hint-door-cipher-01",
      "puzzleId": "puzzle-level7-door",
      "hintLevel": 3,
      "revealedBy": "examination",
      "hintText": "Door Cipher (speak \"Jötun-vaka\")",
      "unlocksInteraction": "speak jotun-vaka"
    },
    {
      "hintId": "hint-generator-location-01",
      "puzzleId": "puzzle-power-grid",
      "hintLevel": 1,
      "revealedBy": "examination",
      "hintText": "The backup generator is in the lower level.",
      "unlocksInteraction": null
    },
    {
      "hintId": "hint-vent-path-01",
      "puzzleId": "puzzle-security-bypass",
      "hintLevel": 2,
      "revealedBy": "examination",
      "hintText": "The ventilation system connects to the secure area.",
      "unlocksInteraction": "enter vent"
    },
    {
      "hintId": "hint-power-sequence-01",
      "puzzleId": "puzzle-power-grid",
      "hintLevel": 3,
      "revealedBy": "examination",
      "hintText": "Power Sequence: Red → Blue → Green → Yellow",
      "unlocksInteraction": null
    }
  ],
  "links": [
    {
      "objectId": "obj-env-console-4422",
      "requiredLayer": 3,
      "puzzleId": "puzzle-level7-door",
      "hintId": "hint-console-override-01",
      "revealCondition": null
    },
    {
      "objectId": "obj-sealed-door-level7",
      "requiredLayer": 3,
      "puzzleId": "puzzle-level7-door",
      "hintId": "hint-door-cipher-01",
      "revealCondition": "item-command-tablet"
    },
    {
      "objectId": "obj-maintenance-schematic",
      "requiredLayer": 2,
      "puzzleId": "puzzle-power-grid",
      "hintId": "hint-generator-location-01",
      "revealCondition": null
    },
    {
      "objectId": "obj-vent-grate",
      "requiredLayer": 3,
      "puzzleId": "puzzle-security-bypass",
      "hintId": "hint-vent-path-01",
      "revealCondition": null
    },
    {
      "objectId": "obj-control-panel-main",
      "requiredLayer": 3,
      "puzzleId": "puzzle-power-grid",
      "hintId": "hint-power-sequence-01",
      "revealCondition": "hint-generator-location-01"
    }
  ],
  "interactions": [
    {
      "interactionId": "int-override-console",
      "commandText": "override console",
      "targetObjectId": "obj-env-console-4422",
      "description": "Bypass the console's corrupted authentication"
    },
    {
      "interactionId": "int-speak-cipher",
      "commandText": "speak jotun-vaka",
      "targetObjectId": "obj-sealed-door-level7",
      "description": "Speak the Jötun command phrase to unseal the door"
    },
    {
      "interactionId": "int-enter-vent",
      "commandText": "enter vent",
      "targetObjectId": "obj-vent-grate",
      "description": "Crawl through the ventilation system"
    }
  ]
}
```

### 7.2 Configuration Schema

| Property | Type | Required | Description |
|----------|------|----------|-------------|
| `version` | string | Yes | Configuration version |
| `hints` | array | Yes | Array of puzzle hint definitions |
| `hints[].hintId` | string | Yes | Unique hint identifier |
| `hints[].puzzleId` | string | Yes | Associated puzzle identifier |
| `hints[].hintLevel` | int | Yes | Subtlety level (1-3) |
| `hints[].revealedBy` | string | Yes | Discovery method: "examination", "perception", "dialogue" |
| `hints[].hintText` | string | Yes | Text shown when hint is revealed |
| `hints[].unlocksInteraction` | string | No | Command text unlocked by this hint |
| `links` | array | Yes | Array of examination-hint links |
| `links[].objectId` | string | Yes | Examinable object ID |
| `links[].requiredLayer` | int | Yes | Minimum examination layer required |
| `links[].puzzleId` | string | Yes | Associated puzzle ID |
| `links[].hintId` | string | Yes | Hint to reveal |
| `links[].revealCondition` | string | No | Prerequisite (hint ID or item ID) |
| `interactions` | array | Yes | Array of unlockable interactions |
| `interactions[].interactionId` | string | Yes | Unique interaction identifier |
| `interactions[].commandText` | string | Yes | Command player types |
| `interactions[].targetObjectId` | string | Yes | Object this interaction targets |
| `interactions[].description` | string | Yes | Brief description for help text |

---

## 8. Integration with Existing Systems

### 8.1 Integration with v0.15.6b (Three-Layer Examination)

The examination service is enhanced to call the puzzle hint service after achieving expert examination.

```csharp
// In ExaminationService.ExamineObject():
public ExaminationResult ExamineObject(string objectId, string characterId, SkillContext? context = null)
{
    // ... existing examination logic ...

    // After determining highest layer:
    HintRevealResult? hintResult = null;
    if (highestLayerUnlocked >= 3)
    {
        hintResult = _puzzleHintService.CheckForHints(objectId, highestLayerUnlocked, characterId);
    }

    return new ExaminationResult(
        objectId,
        objectName,
        witsCheckResult,
        highestLayerUnlocked,
        compositeDescription,
        layerTexts,
        hintResult?.HasRevealedHints ?? false,
        hintResult?.HintsRevealed.FirstOrDefault()?.PuzzleId,
        hintResult?.InteractionsUnlocked.ToList() ?? new List<string>());
}
```

### 8.2 Integration with v0.15.6d (Flora & Fauna)

Flora and fauna can also have linked puzzle hints for expert examination.

```csharp
// Example: Blight-Moths indicating a puzzle solution
{
  "objectId": "fauna-alf-blight-moth-03",
  "requiredLayer": 3,
  "puzzleId": "puzzle-containment-ward",
  "hintId": "hint-ward-failure-01",
  "revealCondition": null
}
```

### 8.3 Integration with Command Parsing

The command parser checks for unlocked interactions when standard commands don't match.

```csharp
// Integration point in command parsing:
if (_puzzleHintService.IsInteractionUnlocked(input, characterId))
{
    return new UnlockedInteractionCommand(input);
}
```

### 8.4 Integration with v0.15.0 (Dice System)

Unlocked interactions may require their own skill checks.

```csharp
// Example: override console requires WITS check
public async Task<InteractionResult> ExecuteUnlockedInteractionAsync(
    UnlockedInteractionCommand command,
    string characterId)
{
    var interaction = _puzzleHintService.GetUnlockedInteractions(characterId)
        .FirstOrDefault(i => i.MatchesCommand(command.CommandText));

    if (interaction == null)
    {
        return InteractionResult.Failure("You don't know how to do that.");
    }

    // Get the interaction's required check (if any)
    var checkDc = _interactionRepository.GetRequiredDc(interaction.InteractionId);
    if (checkDc > 0)
    {
        var rollResult = _diceService.RollSuccessPool(character.Stats.Wits);
        if (rollResult.NetSuccesses < checkDc / 5) // Convert DC to success threshold
        {
            return InteractionResult.Failure("Your attempt fails.");
        }
    }

    return await _interactionHandler.ExecuteAsync(interaction);
}
```

---

## 9. Acceptance Criteria

### 9.1 Hint Discovery
- [ ] Expert examination (Layer 3) can reveal puzzle hints
- [ ] Hints are only revealed once per character
- [ ] Previously discovered hints are not re-displayed
- [ ] Hint text displays correctly with formatting

### 9.2 Conditional Reveals
- [ ] Hints with item conditions only reveal when item is possessed
- [ ] Hints with hint conditions only reveal when prior hint is discovered
- [ ] Unmet conditions show "something is missing" feedback
- [ ] Conditions are evaluated correctly

### 9.3 Interaction Unlocking
- [ ] Hints with UnlocksInteraction unlock new commands
- [ ] Unlocked commands are recognized by parser
- [ ] Non-unlocked commands show appropriate error
- [ ] Unlocked interactions persist across examinations

### 9.4 Player Tracking
- [ ] Discovered hints are tracked per character
- [ ] `hints` command shows all discovered hints
- [ ] Hints can be filtered by puzzle
- [ ] Discovery location and time are recorded

### 9.5 General
- [ ] All ~2 unit tests pass
- [ ] Build completes with 0 errors
- [ ] Build completes with 0 warnings
- [ ] Configuration loads correctly from puzzle-hints.json

---

## 10. Test Specifications

### 10.1 Unit Tests (~2 tests)

#### PuzzleHintServiceTests.cs

```csharp
[TestFixture]
public class PuzzleHintServiceTests
{
    private Mock<IPuzzleHintRepository> _hintRepositoryMock;
    private Mock<IExaminationHintLinkRepository> _linkRepositoryMock;
    private Mock<IPlayerHintTracker> _trackerMock;
    private Mock<IInventoryService> _inventoryMock;
    private Mock<ILogger<PuzzleHintService>> _loggerMock;
    private PuzzleHintService _service;

    [SetUp]
    public void Setup()
    {
        _hintRepositoryMock = new Mock<IPuzzleHintRepository>();
        _linkRepositoryMock = new Mock<IExaminationHintLinkRepository>();
        _trackerMock = new Mock<IPlayerHintTracker>();
        _inventoryMock = new Mock<IInventoryService>();
        _loggerMock = new Mock<ILogger<PuzzleHintService>>();

        _service = new PuzzleHintService(
            _hintRepositoryMock.Object,
            _linkRepositoryMock.Object,
            _trackerMock.Object,
            _inventoryMock.Object,
            _loggerMock.Object);
    }

    /// <summary>
    /// Test: Expert examination reveals linked puzzle hints
    /// Verifies that CheckForHints returns hints when Layer 3 is achieved
    /// and conditions are met.
    /// </summary>
    [Test]
    public void CheckForHints_WithExpertExamination_RevealsLinkedHints()
    {
        // Arrange
        var link = new ExaminationHintLink(
            "obj-console",
            3, // Required layer
            "puzzle-level7",
            "hint-override-01",
            null); // No condition

        var hint = new PuzzleHint(
            "hint-override-01",
            "puzzle-level7",
            2,
            "examination",
            "Console Override (WITS DC 4)",
            "override console");

        _linkRepositoryMock.Setup(r => r.GetLinksForObject("obj-console"))
            .Returns(new List<ExaminationHintLink> { link });

        _hintRepositoryMock.Setup(r => r.GetById("hint-override-01"))
            .Returns(hint);

        _trackerMock.Setup(t => t.IsHintDiscovered("hint-override-01", "char-01"))
            .Returns(false);

        // Act
        var result = _service.CheckForHints("obj-console", 3, "char-01");

        // Assert
        Assert.That(result.HasRevealedHints, Is.True);
        Assert.That(result.HintsRevealed.Count, Is.EqualTo(1));
        Assert.That(result.HintsRevealed[0].HintId, Is.EqualTo("hint-override-01"));
        Assert.That(result.HasUnlockedInteractions, Is.True);
        Assert.That(result.InteractionsUnlocked, Contains.Item("override console"));

        _trackerMock.Verify(t => t.MarkHintDiscovered(
            "hint-override-01", "puzzle-level7", "char-01", "obj-console"), Times.Once);
        _trackerMock.Verify(t => t.UnlockInteraction(
            "override console", "char-01", "hint-override-01"), Times.Once);
    }

    /// <summary>
    /// Test: New interactions unlock on hint reveal
    /// Verifies that interactions are properly unlocked and tracked
    /// when hints with UnlocksInteraction are discovered.
    /// </summary>
    [Test]
    public void CheckForHints_WithInteractionUnlock_UnlocksNewCommand()
    {
        // Arrange
        var link = new ExaminationHintLink(
            "obj-vent",
            3,
            "puzzle-bypass",
            "hint-vent-01",
            null);

        var hint = new PuzzleHint(
            "hint-vent-01",
            "puzzle-bypass",
            2,
            "examination",
            "The vent connects to the secure area.",
            "enter vent");

        _linkRepositoryMock.Setup(r => r.GetLinksForObject("obj-vent"))
            .Returns(new List<ExaminationHintLink> { link });

        _hintRepositoryMock.Setup(r => r.GetById("hint-vent-01"))
            .Returns(hint);

        _trackerMock.Setup(t => t.IsHintDiscovered("hint-vent-01", "char-01"))
            .Returns(false);

        // Act
        var result = _service.CheckForHints("obj-vent", 3, "char-01");

        // Assert
        Assert.That(result.InteractionsUnlocked.Count, Is.EqualTo(1));
        Assert.That(result.InteractionsUnlocked[0], Is.EqualTo("enter vent"));

        _trackerMock.Verify(t => t.UnlockInteraction(
            "enter vent", "char-01", "hint-vent-01"), Times.Once);
    }
}
```

---

## 11. Dependencies

### 11.1 Required from v0.15.6d

| Type | Location | Usage in this phase |
|------|----------|---------------------|
| `FloraFaunaDescriptor` | Domain/ValueObjects/ | Flora/fauna can link to puzzle hints |
| `IFloraFaunaService` | Application/Interfaces/ | Species examination can reveal hints |
| Discovery tracking pattern | Services/ | Model for hint discovery tracking |

### 11.2 Required from v0.15.6b

| Type | Location | Usage in this phase |
|------|----------|---------------------|
| `ExaminationResult` | Domain/ValueObjects/ | Enhanced to include hint reveals |
| `IExaminationService` | Application/Interfaces/ | Integration point for hint checking |
| Three-layer DC system | Services/ | Layer 3 triggers hint checks |

### 11.3 Required from v0.15.0

| Type | Location | Usage in this phase |
|------|----------|---------------------|
| `IDiceService` | Application/Interfaces/ | Unlocked interactions may require checks |
| Success-counting mechanics | Services/ | Skill checks for interactions |

### 11.4 Provides to v0.15.6f

| Type | Usage |
|------|-------|
| `IPuzzleHintService` | Search command can also reveal hints |
| `IPlayerHintTracker` | Tracks discoveries from search |
| Hint reveal pattern | Model for search-based discovery |

---

## 12. Implementation Notes

### 12.1 File Structure

```
src/
├── Domain/
│   └── ValueObjects/
│       ├── PuzzleHint.cs              # Hint definition
│       ├── ExaminationHintLink.cs     # Object-hint link
│       ├── HintRevealResult.cs        # Check result
│       ├── DiscoveredHint.cs          # Discovery record
│       └── UnlockedInteraction.cs     # Unlocked command
├── Application/
│   ├── Interfaces/
│   │   ├── IPuzzleHintService.cs      # Service interface
│   │   ├── IPlayerHintTracker.cs      # Tracking interface
│   │   ├── IPuzzleHintRepository.cs   # Hint repository
│   │   └── IExaminationHintLinkRepository.cs  # Link repository
│   └── Services/
│       └── PuzzleHintService.cs       # Service implementation
├── Infrastructure/
│   ├── Configuration/
│   │   └── puzzle-hints.json          # Hint/link configuration
│   └── Repositories/
│       ├── PuzzleHintRepository.cs    # JSON loading
│       └── ExaminationHintLinkRepository.cs  # Link loading
└── Presentation/
    ├── Commands/
    │   ├── HintsCommand.cs            # Hints listing
    │   └── UnlockedInteractionCommand.cs  # Dynamic commands
    └── Rendering/
        └── HintRenderer.cs            # Hint display

tests/
└── Unit/
    └── Application/
        └── PuzzleHintServiceTests.cs  # ~2 unit tests
```

### 12.2 Implementation Order

1. **Domain Layer**
   - PuzzleHint value object
   - ExaminationHintLink value object
   - HintRevealResult value object
   - DiscoveredHint value object
   - UnlockedInteraction value object

2. **Application Layer**
   - IPuzzleHintService interface
   - IPlayerHintTracker interface
   - Repository interfaces
   - PuzzleHintService implementation

3. **Infrastructure Layer**
   - puzzle-hints.json configuration
   - PuzzleHintRepository implementation
   - ExaminationHintLinkRepository implementation
   - PlayerHintTracker implementation

4. **Presentation Layer**
   - HintsCommand and parsing
   - UnlockedInteractionCommand
   - Renderer updates for hint display
   - ExaminationService integration

5. **Testing**
   - PuzzleHintServiceTests (~2 tests)

---

## 13. Design Decisions

### 13.1 Separation from Puzzle System

**Decision:** Implement hints as a perception system feature, not a full puzzle system.

**Rationale:**
- Keeps v0.15.6e focused on perception and discovery
- Full puzzle state management is a larger system for future versions
- Hints provide value even without complete puzzle implementation
- Players can discover hints and use unlocked interactions immediately

### 13.2 Conditional Reveals

**Decision:** Support both item-based and hint-based prerequisites for reveals.

**Rationale:**
- Item conditions create inventory-based gating (need to find an item first)
- Hint conditions create discovery chains (find hint A before hint B)
- Enables graduated puzzle difficulty through information gating
- Prevents overwhelming players with too much information at once

### 13.3 Interaction Unlocking

**Decision:** Make unlocked interactions dynamic commands rather than static.

**Rationale:**
- Rewards thorough exploration and high Wits investment
- Creates sense of discovery when new actions become available
- Prevents players from attempting actions they shouldn't know about
- Naturally gates content behind perception checks

### 13.4 Hint Levels

**Decision:** Support three subtlety levels for hints.

**Rationale:**
- Level 1 (Cryptic): Rewards clever players who interpret subtle clues
- Level 2 (Moderate): Balances challenge with accessibility
- Level 3 (Direct): Provides clear guidance for stuck players
- Enables puzzle designers to provide graduated assistance

---

## 14. Future Considerations

### 14.1 Planned Enhancements (v0.15.6f+)

- **Search Enhancement:** Active searching can reveal additional hints
- **Investigation System:** Combining clues to form deductions
- **Specialization Bonuses:** Thul auto-succeeds historical object hints

### 14.2 Post-v0.15.6 Potential Features

- **Full Puzzle System:** Complete puzzle state tracking and solving
- **Hint Journal:** Persistent log of all discovered hints
- **Puzzle Progress UI:** Visual indication of puzzle completion
- **Cooperative Hints:** Party members sharing discovered hints
- **Time-Sensitive Hints:** Hints that expire or change over time
- **Red Herrings:** False hints that mislead players

---

## Appendix A: Puzzle Hint Examples

### A.1 Complete Hint Reference

| Hint ID | Puzzle | Level | Unlocks | Condition |
|---------|--------|-------|---------|-----------|
| hint-console-override-01 | puzzle-level7-door | 2 | override console | None |
| hint-door-cipher-01 | puzzle-level7-door | 3 | speak jotun-vaka | item-command-tablet |
| hint-generator-location-01 | puzzle-power-grid | 1 | None | None |
| hint-power-sequence-01 | puzzle-power-grid | 3 | None | hint-generator-location-01 |
| hint-vent-path-01 | puzzle-security-bypass | 2 | enter vent | None |

### A.2 Hint Level Guidelines

**Level 1 (Cryptic):**
- Vague references that require interpretation
- "Something about this pattern seems significant..."
- Rewards players who pay attention

**Level 2 (Moderate):**
- Clear direction without explicit solution
- "The console could bypass the door's security."
- Guides players toward the right approach

**Level 3 (Direct):**
- Explicit instructions or solutions
- "Speak 'Jötun-vaka' to unseal the door."
- Helps stuck players progress

---

## Appendix B: Interaction Unlock Reference

### B.1 Unlockable Interactions

| Interaction | Command | Target | Unlocked By |
|-------------|---------|--------|-------------|
| int-override-console | override console | obj-env-console-4422 | hint-console-override-01 |
| int-speak-cipher | speak jotun-vaka | obj-sealed-door-level7 | hint-door-cipher-01 |
| int-enter-vent | enter vent | obj-vent-grate | hint-vent-path-01 |

### B.2 Interaction Design Guidelines

1. **Clear Naming:** Command text should be intuitive once hint is known
2. **Target Specificity:** Interactions target specific objects
3. **Skill Requirements:** Interactions may require their own skill checks
4. **Feedback:** Success and failure should provide clear feedback
5. **Progression:** Interactions should advance puzzle or story state

---

*This design specification provides the detailed blueprint for implementing v0.15.6e Puzzle Hint Integration. See the scope breakdown for integration context with other v0.15.6 sub-phases.*
