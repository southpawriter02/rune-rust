> **Archived** - This changelog has been consolidated. See the complete version at [v0.3.5](../v0.3.x/v0.3.5.md).

# Changelog: v0.3.5a - The Dashboard (Layout & Status)

**Release Date:** 2025-12-21

## Summary

This release implements the first part of the Exploration HUD system - a persistent, three-pane terminal interface that replaces the scrolling text log with a fixed "windowed" TUI. The ExplorationScreenRenderer uses Spectre.Console Layout to compose Header (status bars), Body (room view + minimap placeholder), and Footer (turn counter) panels. StatusWidget provides color-coded resource bars using Unicode block characters, with 4-tier HP coloring, 2-tier Stamina coloring, and 5-tier Stress coloring. GameService is updated to render the exploration HUD before each input prompt during the Exploration phase. This release includes 18 unit tests for color threshold logic and bar rendering.

---

## New Files Created

### Core Layer
| File | Purpose |
|------|---------|
| `RuneAndRust.Core/Interfaces/IExplorationScreenRenderer.cs` | Interface for exploration HUD rendering |
| `RuneAndRust.Core/ViewModels/ExplorationViewModel.cs` | Immutable record for exploration display data |

### Terminal Layer
| File | Purpose |
|------|---------|
| `RuneAndRust.Terminal/Rendering/StatusWidget.cs` | Static helper for colored resource bars (HP/Stamina/Stress) |
| `RuneAndRust.Terminal/Rendering/ExplorationScreenRenderer.cs` | Layout engine with 3-pane interface using Spectre.Console |

### Test Layer
| File | Purpose |
|------|---------|
| `RuneAndRust.Tests/Terminal/StatusWidgetTests.cs` | 18 unit tests for color logic and bar rendering |

---

## Files Modified

| File | Change |
|------|--------|
| `RuneAndRust.Engine/Services/GameService.cs` | Added IExplorationScreenRenderer + IServiceScopeFactory injection, render call in exploration phase, BuildExplorationViewModelAsync() helper method |
| `RuneAndRust.Terminal/Program.cs` | Registered IExplorationScreenRenderer in DI, updated version to v0.3.5a |
| `RuneAndRust.Tests/Engine/GameServiceTests.cs` | Added Mock<IServiceScopeFactory> for updated constructor |
| `RuneAndRust.Tests/Engine/GameLoopTests.cs` | Added Mock<IServiceScopeFactory> for updated constructor |

---

## Code Implementation Details

### IExplorationScreenRenderer Interface

```csharp
namespace RuneAndRust.Core.Interfaces;

/// <summary>
/// Defines the contract for rendering the exploration HUD (v0.3.5a).
/// Implementations use Spectre.Console Layout for a persistent, three-pane interface.
/// </summary>
public interface IExplorationScreenRenderer
{
    /// <summary>
    /// Renders the complete exploration screen with status bar, room view, and minimap.
    /// Clears the screen before rendering for a clean display.
    /// </summary>
    /// <param name="viewModel">The exploration view model containing all display data.</param>
    void Render(ExplorationViewModel viewModel);
}
```

### ExplorationViewModel Record

```csharp
namespace RuneAndRust.Core.ViewModels;

/// <summary>
/// Immutable view model for the exploration screen HUD (v0.3.5a).
/// Contains all display data for the persistent three-pane interface.
/// </summary>
public record ExplorationViewModel(
    string CharacterName,
    int CurrentHp,
    int MaxHp,
    int CurrentStamina,
    int MaxStamina,
    int CurrentStress,
    int MaxStress,
    int CurrentCorruption,
    int MaxCorruption,
    string RoomName,
    string RoomDescription,
    int TurnCount
);
```

### StatusWidget Color Logic

```csharp
namespace RuneAndRust.Terminal.Rendering;

public static class StatusWidget
{
    /// <summary>
    /// Gets the color for HP based on percentage thresholds (4-tier).
    /// </summary>
    public static Color GetHpColor(int current, int max)
    {
        if (max == 0) return Color.Grey;

        var pct = (double)current / max * 100;
        return pct switch
        {
            <= 25 => Color.Red1,     // Critical
            <= 50 => Color.Orange1,  // Danger
            <= 75 => Color.Yellow,   // Wounded
            _ => Color.Green         // Healthy
        };
    }

    /// <summary>
    /// Gets the color for Stamina based on percentage thresholds (2-tier).
    /// </summary>
    public static Color GetStaminaColor(int current, int max)
    {
        if (max == 0) return Color.Grey;
        var pct = (double)current / max * 100;
        return pct < 20 ? Color.Grey : Color.Cyan1;
    }

    /// <summary>
    /// Gets the color for Stress based on absolute value thresholds (5-tier).
    /// </summary>
    public static Color GetStressColor(int stress)
    {
        return stress switch
        {
            >= 80 => Color.Purple,   // Fractured
            >= 60 => Color.Magenta1, // Distressed
            >= 40 => Color.Yellow,   // Shaken
            >= 20 => Color.Cyan1,    // Unsettled
            _ => Color.Grey          // Stable
        };
    }

    /// <summary>
    /// Renders a text-based progress bar using Unicode block characters.
    /// </summary>
    public static string RenderBar(int current, int max, int width = 20)
    {
        if (max == 0) return new string('░', width);
        var pct = Math.Clamp((double)current / max, 0, 1);
        var filled = (int)(pct * width);
        var empty = width - filled;
        return new string('█', filled) + new string('░', empty);
    }

    /// <summary>
    /// Converts a Spectre.Console Color to its markup string representation.
    /// </summary>
    public static string ToMarkup(this Color color) => color.ToString().ToLowerInvariant();
}
```

### ExplorationScreenRenderer Layout

```csharp
namespace RuneAndRust.Terminal.Rendering;

public class ExplorationScreenRenderer : IExplorationScreenRenderer
{
    private readonly ILogger<ExplorationScreenRenderer> _logger;

    public ExplorationScreenRenderer(ILogger<ExplorationScreenRenderer> logger)
    {
        _logger = logger;
    }

    public void Render(ExplorationViewModel vm)
    {
        _logger.LogTrace("[HUD] Rendering exploration screen. HP: {HP}/{MaxHP}, Room: {Room}",
            vm.CurrentHp, vm.MaxHp, vm.RoomName);

        // Build fresh layout each render (Layout is mutable, safer to rebuild)
        var rootLayout = new Layout("Root")
            .SplitRows(
                new Layout("Header").Size(3),
                new Layout("Body").SplitColumns(
                    new Layout("Main").Ratio(7),
                    new Layout("Sidebar").Ratio(3)
                ),
                new Layout("Footer").Size(1)
            );

        // 1. Update Header (Status Bar)
        rootLayout["Header"].Update(CreateStatusBar(vm));

        // 2. Update Main Content (Room View - placeholder for v0.3.5c)
        var roomPanel = new Panel(Markup.Escape(vm.RoomDescription))
            .Header($"[bold orange1]{Markup.Escape(vm.RoomName)}[/]")
            .Border(BoxBorder.Rounded)
            .Expand();
        rootLayout["Main"].Update(roomPanel);

        // 3. Update Sidebar (Minimap - placeholder for v0.3.5b)
        var minimapPlaceholder = new Panel("[grey]Minimap coming in v0.3.5b[/]")
            .Header("[yellow]Map[/]")
            .Border(BoxBorder.Rounded);
        rootLayout["Sidebar"].Update(minimapPlaceholder);

        // 4. Update Footer (Turn counter)
        rootLayout["Footer"].Update(new Markup($"[grey]Turn {vm.TurnCount}[/]"));

        // 5. Clear and render complete layout
        AnsiConsole.Clear();
        AnsiConsole.Write(rootLayout);

        _logger.LogTrace("[HUD] Render complete");
    }

    private Panel CreateStatusBar(ExplorationViewModel vm)
    {
        var hpColor = StatusWidget.GetHpColor(vm.CurrentHp, vm.MaxHp);
        var stamColor = StatusWidget.GetStaminaColor(vm.CurrentStamina, vm.MaxStamina);
        var stressColor = StatusWidget.GetStressColor(vm.CurrentStress);

        var grid = new Grid();
        grid.AddColumn(new GridColumn().NoWrap().PadRight(2));  // Name
        grid.AddColumn(new GridColumn().Width(30));              // HP
        grid.AddColumn(new GridColumn().Width(30));              // Stamina
        grid.AddColumn(new GridColumn().Width(18));              // Stress

        var hpBar = StatusWidget.RenderBar(vm.CurrentHp, vm.MaxHp);
        var stamBar = StatusWidget.RenderBar(vm.CurrentStamina, vm.MaxStamina);

        grid.AddRow(
            new Markup($"[bold gold1]{Markup.Escape(vm.CharacterName)}[/]"),
            new Markup($"[bold]HP:[/] [{hpColor.ToMarkup()}]{hpBar}[/] [grey]{vm.CurrentHp}/{vm.MaxHp}[/]"),
            new Markup($"[bold]STA:[/] [{stamColor.ToMarkup()}]{stamBar}[/] [grey]{vm.CurrentStamina}/{vm.MaxStamina}[/]"),
            new Markup($"[{stressColor.ToMarkup()}]Stress: {vm.CurrentStress}%[/]")
        );

        return new Panel(grid).Border(BoxBorder.None);
    }
}
```

### GameService Integration

```csharp
// Added to GameService constructor
private readonly IExplorationScreenRenderer? _explorationRenderer;
private readonly IServiceScopeFactory _scopeFactory;

// In the game loop, before GetInput():
while (_state.Phase != GamePhase.Quit)
{
    // 1. Render phase-specific UI
    if (_state.Phase == GamePhase.Combat && _combatRenderer != null)
    {
        var viewModel = _combatService.GetViewModel();
        if (viewModel != null) _combatRenderer.Render(viewModel);
    }
    else if (_state.Phase == GamePhase.Exploration && _explorationRenderer != null)
    {
        var viewModel = await BuildExplorationViewModelAsync();
        if (viewModel != null) _explorationRenderer.Render(viewModel);
    }
    // ... rest of loop
}

// Helper method to build ViewModel
private async Task<ExplorationViewModel?> BuildExplorationViewModelAsync()
{
    if (_state.CurrentCharacter == null)
    {
        _logger.LogWarning("[HUD] Cannot build exploration ViewModel: No current character");
        return null;
    }

    string roomName = "Unknown";
    string roomDescription = "You are in an unknown location.";

    if (_state.CurrentRoomId.HasValue)
    {
        using var scope = _scopeFactory.CreateScope();
        var roomRepo = scope.ServiceProvider.GetRequiredService<IRoomRepository>();
        var room = await roomRepo.GetByIdAsync(_state.CurrentRoomId.Value);
        if (room != null)
        {
            roomName = room.Name;
            roomDescription = room.Description;
        }
    }

    var character = _state.CurrentCharacter;
    return new ExplorationViewModel(
        CharacterName: character.Name,
        CurrentHp: character.CurrentHP,
        MaxHp: character.MaxHP,
        CurrentStamina: character.CurrentStamina,
        MaxStamina: character.MaxStamina,
        CurrentStress: character.PsychicStress,
        MaxStress: character.MaxPsychicStress,
        CurrentCorruption: character.Corruption,
        MaxCorruption: character.MaxCorruption,
        RoomName: roomName,
        RoomDescription: roomDescription,
        TurnCount: _state.TurnCount
    );
}
```

---

## Status Bar Color Thresholds

### HP Bar (4-tier)
| Threshold | Color | State | Example |
|-----------|-------|-------|---------|
| > 75% | Green | Healthy | `████████████████████ 90/100` |
| 50-75% | Yellow | Wounded | `████████████░░░░░░░░ 60/100` |
| 25-49% | Orange | Danger | `███████░░░░░░░░░░░░░ 35/100` |
| <= 25% | Red | Critical | `██░░░░░░░░░░░░░░░░░░ 10/100` |

### Stamina Bar (2-tier)
| Threshold | Color | State |
|-----------|-------|-------|
| >= 20% | Cyan | Active |
| < 20% | Grey | Exhausted |

### Stress Display (5-tier)
| Value | Color | State |
|-------|-------|-------|
| < 20 | Grey | Stable |
| 20-39 | Cyan | Unsettled |
| 40-59 | Yellow | Shaken |
| 60-79 | Magenta | Distressed |
| >= 80 | Purple | Fractured |

---

## User Interface

### Exploration HUD Layout (v0.3.5a)

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                                                                             │
│  Ragnar     HP: ██████████████░░░░░░ 70/100  STA: ████████████████████ 50/50│
│                                                         Stress: 15%        │
│                                                                             │
├──────────────────────────────────────────────────────┬──────────────────────┤
│ Entry Hall                                           │ Map                  │
│ ──────────────────────────────────────────────────── │ ──────────────────── │
│                                                      │                      │
│ A vast chamber of corroded iron and crumbling        │ Minimap coming in    │
│ stone. The air is thick with the scent of ozone      │ v0.3.5b              │
│ and ancient dust. Shadows pool in the corners,       │                      │
│ and the faint hum of dormant machinery echoes        │                      │
│ from somewhere below.                                │                      │
│                                                      │                      │
│                                                      │                      │
│                                                      │                      │
├──────────────────────────────────────────────────────┴──────────────────────┤
│ Turn 1                                                                      │
└─────────────────────────────────────────────────────────────────────────────┘
```

### Layout Structure

```
Root
├── Header (Size: 3 rows)
│   └── StatusBar Grid [Name | HP Bar | Stamina Bar | Stress]
├── Body (Flexible)
│   ├── Main (Ratio: 7)
│   │   └── Room Panel [Room Name Header, Room Description]
│   └── Sidebar (Ratio: 3)
│       └── Minimap Panel [Placeholder for v0.3.5b]
└── Footer (Size: 1 row)
    └── Turn Counter Markup
```

### Progress Bar Rendering

```
Full HP:    ████████████████████ 100/100  (20 filled blocks)
75% HP:     ███████████████░░░░░ 75/100   (15 filled, 5 empty)
50% HP:     ██████████░░░░░░░░░░ 50/100   (10 filled, 10 empty)
25% HP:     █████░░░░░░░░░░░░░░░ 25/100   (5 filled, 15 empty)
Empty HP:   ░░░░░░░░░░░░░░░░░░░░ 0/100    (20 empty blocks)
```

---

## Test Coverage

### StatusWidgetTests (18 tests)

| Test Name | Description |
|-----------|-------------|
| `GetHpColor_Critical_ReturnsRed` | HP at 10/100 returns Red1 |
| `GetHpColor_Danger_ReturnsOrange` | HP at 35/100 returns Orange1 |
| `GetHpColor_Wounded_ReturnsYellow` | HP at 60/100 returns Yellow |
| `GetHpColor_Healthy_ReturnsGreen` | HP at 90/100 returns Green |
| `GetHpColor_ZeroMax_ReturnsGrey` | Edge case: max HP is 0 |
| `GetStaminaColor_Exhausted_ReturnsGrey` | Stamina at 10% returns Grey |
| `GetStaminaColor_Active_ReturnsCyan` | Stamina at 60% returns Cyan1 |
| `GetStaminaColor_ExactlyTwentyPercent_ReturnsCyan` | Boundary test at 20% |
| `GetStressColor_Stable_ReturnsGrey` | Stress at 10 returns Grey |
| `GetStressColor_Unsettled_ReturnsCyan` | Stress at 25 returns Cyan1 |
| `GetStressColor_Shaken_ReturnsYellow` | Stress at 45 returns Yellow |
| `GetStressColor_Distressed_ReturnsMagenta` | Stress at 70 returns Magenta1 |
| `GetStressColor_Fractured_ReturnsPurple` | Stress at 85 returns Purple |
| `RenderBar_FullHealth_AllFilled` | 100/100 returns 20 filled blocks |
| `RenderBar_HalfHealth_HalfFilled` | 50/100 returns 10 filled, 10 empty |
| `RenderBar_Empty_AllEmpty` | 0/100 returns 20 empty blocks |
| `RenderBar_ZeroMax_AllEmpty` | Edge case: max is 0 |
| `RenderBar_OverMax_ClampedToFull` | 150/100 clamped to full bar |

---

## Logging Matrix

| Context | Level | Template |
|---------|-------|----------|
| Render Start | Trace | `"[HUD] Rendering exploration screen. HP: {HP}/{MaxHP}, Room: {Room}"` |
| Render Complete | Trace | `"[HUD] Render complete"` |
| ViewModel Build | Debug | `"[HUD] Building exploration ViewModel for {Character} in {Room}"` |
| No Character | Warning | `"[HUD] Cannot build exploration ViewModel: No current character"` |

---

## DI Registration

Added to `Program.cs`:

```csharp
// Register Exploration HUD (v0.3.5a)
services.AddSingleton<IExplorationScreenRenderer, ExplorationScreenRenderer>();

// Version update
AnsiConsole.MarkupLine("[green]Rune & Rust v0.3.5a Booting...[/]");
```

---

## Architecture Notes

### Service Lifetime Considerations

- `IExplorationScreenRenderer` is registered as **Singleton** (same as CombatScreenRenderer)
- `IRoomRepository` is **Scoped**, so GameService uses `IServiceScopeFactory` to create a scope for room lookup
- ViewModel is built fresh each render cycle to reflect current game state

### Layout Rendering Pattern

1. Build fresh Layout each render (Layout is mutable)
2. Update all layout regions with current data
3. AnsiConsole.Clear() before Write()
4. Single AnsiConsole.Write(rootLayout) call renders complete HUD

### Placeholder Panels

- **Sidebar (Minimap)**: Displays "Minimap coming in v0.3.5b" - will be implemented next
- **Main (Room View)**: Currently shows room description; v0.3.5c will add object lists, exits, etc.

---

## Build Verification

```
Build succeeded.
    0 Error(s)
    (Existing warnings only)

Test run:
  Passed: 1962 (non-PostgreSQL)
  Failed: 0
  Skipped: 0
```

---

## Directory Structure Changes

```
RuneAndRust/
├── RuneAndRust.Core/
│   ├── Interfaces/
│   │   ├── IExplorationScreenRenderer.cs     [NEW]
│   │   └── ... (existing interfaces)
│   └── ViewModels/
│       ├── CombatViewModel.cs
│       └── ExplorationViewModel.cs           [NEW]
├── RuneAndRust.Engine/
│   └── Services/
│       └── GameService.cs                    [MODIFIED]
├── RuneAndRust.Terminal/
│   ├── Program.cs                            [MODIFIED]
│   └── Rendering/
│       ├── StatPreviewRenderer.cs
│       ├── TypewriterRenderer.cs
│       ├── StatusWidget.cs                   [NEW]
│       └── ExplorationScreenRenderer.cs      [NEW]
└── RuneAndRust.Tests/
    ├── Engine/
    │   ├── GameServiceTests.cs               [MODIFIED]
    │   └── GameLoopTests.cs                  [MODIFIED]
    └── Terminal/
        ├── TitleScreenServiceTests.cs
        ├── VictoryScreenRendererTests.cs
        └── StatusWidgetTests.cs              [NEW]
```

---

## Next Steps (v0.3.5b: The Minimap)

Planned features for the next sub-release:
- ASCII minimap generation from room graph
- Player position indicator
- Visited/unvisited room markers
- Exit direction indicators
- Real-time minimap updates on navigation

---

## Notes

- Unicode block characters (█, ░) used for text-based progress bars work in all modern terminals
- Color.ToMarkup() extension converts Spectre Color enum to lowercase string for markup
- Layout uses fixed sizes for Header (3 rows) and Footer (1 row), with flexible Body split 70/30
- IServiceScopeFactory pattern allows Singleton service to access Scoped dependencies safely
- Version string updated to v0.3.5a in Program.cs boot message
