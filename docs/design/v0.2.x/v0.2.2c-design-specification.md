# v0.2.2c Design Specification: Shop UI & Specialty Merchants

## Overview

**Version:** 0.2.2c
**Status:** Planning
**Focus:** Implement TUI shop interface for browsing and comparing items, specialty merchant types with themed inventories, and inventory refresh mechanics
**Prerequisites:** v0.2.2b (Dynamic Pricing & Haggling)
**Estimated Unit Tests:** ~25

---

## Table of Contents

1. [Executive Summary](#1-executive-summary)
2. [Feature Overview](#2-feature-overview)
3. [Architecture Diagrams](#3-architecture-diagrams)
4. [User Stories](#4-user-stories)
5. [Data Models](#5-data-models)
6. [Configuration Schemas](#6-configuration-schemas)
7. [Service Specifications](#7-service-specifications)
8. [Shop UI Flow](#8-shop-ui-flow)
9. [User-Facing Changes](#9-user-facing-changes)
10. [Logging Requirements](#10-logging-requirements)
11. [Unit Test Specifications](#11-unit-test-specifications)
12. [Use Cases](#12-use-cases)
13. [Acceptance Criteria](#13-acceptance-criteria)
14. [Deliverable Checklist](#14-deliverable-checklist)
15. [Dependencies](#15-dependencies)
16. [Future Considerations](#16-future-considerations)

---

## 1. Executive Summary

This version introduces the TUI shop interface for an enhanced shopping experience, specialty merchant types with themed inventories, and inventory refresh mechanics. Players can browse items with visual comparison indicators, appraise items for detailed value breakdowns, and interact with specialized merchants who stock category-specific goods.

### Key Deliverables

| Category | Items |
|----------|-------|
| **Enums** | MerchantType |
| **Value Objects** | ItemComparison |
| **Services** | InventoryRefreshService (IInventoryRefreshService) |
| **Commands** | `shop`, `appraise <item>` |
| **TUI Components** | ShopView |
| **Configuration** | merchant-types.json, merchant-types.schema.json |
| **Entity Updates** | Merchant (MerchantType, refresh tracking) |
| **Tests** | ~25 new unit tests |

### Architectural Significance

This version establishes the **shop UI and merchant specialization pattern** that completes the merchant system:
- MerchantType enum for categorizing merchant specializations
- ItemComparison value object for equipment comparison logic
- TUI-based shop interface using existing renderer patterns
- Inventory refresh mechanics for dynamic merchant stock
- Foundation for future merchant customization and player shops

---

## 2. Feature Overview

```
v0.2.2c Features
├── Merchant Type System
│   ├── MerchantType enum (8 specialty types)
│   ├── Specialty inventory generation
│   ├── Type-specific pricing modifiers
│   └── Category-based stock filtering
├── Item Comparison System
│   ├── ItemComparison value object
│   ├── Stat difference calculation
│   ├── Upgrade/downgrade determination
│   └── Visual comparison indicators
├── Inventory Refresh Mechanics
│   ├── IInventoryRefreshService interface
│   ├── Time-based refresh triggers
│   ├── Stock generation by merchant type
│   └── Rarity-weighted item selection
├── Shop TUI Interface
│   ├── ShopView component
│   ├── Item listing with prices
│   ├── Comparison column display
│   ├── Buy/sell within interface
│   └── Navigation and commands
├── Appraise Command
│   ├── Detailed value breakdown
│   ├── Condition modifiers display
│   ├── Merchant-specific pricing
│   └── Comparison with equipped item
└── Configuration
    ├── merchant-types.json
    ├── Stock categories per type
    ├── Refresh intervals
    └── Rarity weights
```

---

## 3. Architecture Diagrams

### 3.1 Layer Diagram

```
┌─────────────────────────────────────────────────────────────────────────┐
│                         PRESENTATION LAYER                              │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  ┌─────────────────────┐  ┌─────────────────────┐  ┌────────────────┐  │
│  │      ShopView       │  │   ShopHandler       │  │ IGameRenderer  │  │
│  │                     │  │   (new)             │  │ (updated)      │  │
│  │ - RenderShopUI()    │  │ - HandleShop()      │  │ - RenderShop() │  │
│  │ - RenderItems()     │  │ - HandleAppraise()  │  │ - RenderComp() │  │
│  │ - RenderComparison()│  │ - HandleShopInput() │  │                │  │
│  │ - RenderSellables() │  │                     │  │                │  │
│  └─────────┬───────────┘  └─────────┬───────────┘  └───────┬────────┘  │
│            │                        │                      │           │
└────────────┼────────────────────────┼──────────────────────┼───────────┘
             │                        │                      │
             ▼                        ▼                      ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                         APPLICATION LAYER                               │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │                   InventoryRefreshService                        │   │
│  ├─────────────────────────────────────────────────────────────────┤   │
│  │ + ShouldRefresh(merchant) : bool                                 │   │
│  │ + RefreshInventory(merchant) : void                              │   │
│  │ + GetTimeUntilRefresh(merchant) : TimeSpan                       │   │
│  │ + GenerateStock(type, level) : IEnumerable<ShopItem>             │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │                     ShopService (updated)                        │   │
│  ├─────────────────────────────────────────────────────────────────┤   │
│  │ + GetMerchantInventory(merchant) : IEnumerable<ShopItem>         │   │
│  │ + GetItemComparison(shopItem, player) : ItemComparison           │   │
│  │ + AppraiseItem(item, merchant, player) : ItemAppraisal           │   │
│  │ + GetSellableItems(player) : IEnumerable<SellableItem>           │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │                 GameSessionService (updated)                     │   │
│  ├─────────────────────────────────────────────────────────────────┤   │
│  │ + OpenShop(merchantName?) : ShopViewDto                          │   │
│  │ + AppraiseItem(itemName) : ItemAppraisalDto                      │   │
│  │ + CompareItem(shopItemIndex) : ItemComparisonDto                 │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                           DOMAIN LAYER                                  │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  ENUMS (New)                                                            │
│  ┌────────────────────────────────────────────────────────────────┐    │
│  │                       MerchantType                              │    │
│  ├────────────────────────────────────────────────────────────────┤    │
│  │ GeneralStore     // General goods, varied inventory            │    │
│  │ Weaponsmith      // Specializes in weapons                     │    │
│  │ Armorer          // Specializes in armor and shields           │    │
│  │ Alchemist        // Sells potions and magical consumables      │    │
│  │ Enchanter        // Sells scrolls and magical items            │    │
│  │ Jeweler          // Buys and sells gems and jewelry            │    │
│  │ Provisioner      // Sells food and supplies                    │    │
│  │ CurioDealer      // Deals in rare and exotic goods             │    │
│  └────────────────────────────────────────────────────────────────┘    │
│                                                                         │
│  ENTITIES (Updated)                                                     │
│  ┌────────────────────────────────────────────────────────────────┐    │
│  │                    Merchant (updated)                           │    │
│  ├────────────────────────────────────────────────────────────────┤    │
│  │ + MerchantType: MerchantType  // NEW                           │    │
│  │ + StockRefreshHours: int  // NEW (default 24)                  │    │
│  │ + LastStockRefresh: DateTime?  // NEW                          │    │
│  │ + MerchantLevel: int  // NEW (affects stock quality)           │    │
│  │ + ShouldRefreshStock(): bool  // NEW                           │    │
│  │ + RefreshStock(items): void  // NEW                            │    │
│  └────────────────────────────────────────────────────────────────┘    │
│                                                                         │
│  VALUE OBJECTS (New)                                                    │
│  ┌────────────────────────────────────────────────────────────────┐    │
│  │                      ItemComparison                             │    │
│  ├────────────────────────────────────────────────────────────────┤    │
│  │ + ShopItem: Item                                                │    │
│  │ + EquippedItem: Item?                                           │    │
│  │ + StatDifferences: IReadOnlyDictionary<string, int>             │    │
│  │ + IsUpgrade: bool                                               │    │
│  │ + IsDowngrade: bool                                             │    │
│  │ + IsEquivalent: bool (computed)                                 │    │
│  │ + Create(shopItem, equippedItem): ItemComparison                │    │
│  │ + GetComparisonIndicator(): string                              │    │
│  └────────────────────────────────────────────────────────────────┘    │
│                                                                         │
│  ┌────────────────────────────────────────────────────────────────┐    │
│  │                      ItemAppraisal                              │    │
│  ├────────────────────────────────────────────────────────────────┤    │
│  │ + Item: Item                                                    │    │
│  │ + BaseValue: int                                                │    │
│  │ + ConditionModifier: decimal                                    │    │
│  │ + FinalValue: int                                               │    │
│  │ + MerchantOffer: int                                            │    │
│  │ + ModifierBreakdown: IReadOnlyList<PriceModifierDetail>         │    │
│  └────────────────────────────────────────────────────────────────┘    │
│                                                                         │
│  DEFINITIONS (New)                                                      │
│  ┌────────────────────────────────────────────────────────────────┐    │
│  │                   MerchantTypeDefinition                        │    │
│  ├────────────────────────────────────────────────────────────────┤    │
│  │ + Type: MerchantType                                            │    │
│  │ + StockCategories: IReadOnlyList<string>                        │    │
│  │ + ExcludeCategories: IReadOnlyList<string>                      │    │
│  │ + PriceModifier: decimal                                        │    │
│  │ + StockRefreshHours: int                                        │    │
│  │ + MinStock: int                                                 │    │
│  │ + MaxStock: int                                                 │    │
│  │ + RarityWeights: IReadOnlyDictionary<string, int>               │    │
│  └────────────────────────────────────────────────────────────────┘    │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                        INFRASTRUCTURE LAYER                             │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │                IConfigurationProvider (updated)                  │   │
│  ├─────────────────────────────────────────────────────────────────┤   │
│  │ + LoadMerchantTypeDefinitions() : IReadOnlyList<MerchantTypeDef>│   │
│  │ + GetMerchantTypeDefinition(type) : MerchantTypeDefinition?     │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
│  Configuration Files:                                                   │
│  ├── config/merchant-types.json                                        │
│  └── config/schemas/merchant-types.schema.json                         │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

### 3.2 Shop UI Flow Diagram

```
┌───────────────────┐
│   Player Input    │
│ "shop" or         │
│ "shop <merchant>" │
└─────────┬─────────┘
          │
          ▼
┌───────────────────────────────────────────────────────────────┐
│                      VALIDATIONS                              │
├───────────────────────────────────────────────────────────────┤
│                                                               │
│  ┌───────────────────┐                                        │
│  │ Merchant in room? │──NO──▶ "No merchant here to trade with"│
│  └─────────┬─────────┘                                        │
│           YES                                                 │
│            │                                                  │
│            ▼                                                  │
│  ┌───────────────────┐                                        │
│  │ Merchant open?    │──NO──▶ "The shop is closed"            │
│  └─────────┬─────────┘                                        │
│           YES                                                 │
│            │                                                  │
│            ▼                                                  │
│  ┌───────────────────┐                                        │
│  │ Check refresh     │                                        │
│  │ needed?           │                                        │
│  └─────────┬─────────┘                                        │
│            │                                                  │
│  ┌─────────▼─────────┐                                        │
│  │ RefreshInventory()│ (if needed)                            │
│  └─────────┬─────────┘                                        │
│            │                                                  │
└────────────┼──────────────────────────────────────────────────┘
             │
             ▼
┌───────────────────────────────────────────────────────────────┐
│                    BUILD SHOP VIEW                            │
├───────────────────────────────────────────────────────────────┤
│                                                               │
│  ┌───────────────────┐                                        │
│  │ Get inventory     │                                        │
│  │ with prices       │                                        │
│  └─────────┬─────────┘                                        │
│            │                                                  │
│            ▼                                                  │
│  ┌───────────────────┐                                        │
│  │ Calculate item    │                                        │
│  │ comparisons       │                                        │
│  └─────────┬─────────┘                                        │
│            │                                                  │
│            ▼                                                  │
│  ┌───────────────────┐                                        │
│  │ Get player's      │                                        │
│  │ sellable items    │                                        │
│  └─────────┬─────────┘                                        │
│            │                                                  │
│            ▼                                                  │
│  ┌───────────────────┐                                        │
│  │ Build ShopViewDto │                                        │
│  └─────────┬─────────┘                                        │
│            │                                                  │
└────────────┼──────────────────────────────────────────────────┘
             │
             ▼
┌───────────────────────────────────────────────────────────────┐
│                    RENDER SHOP UI                             │
├───────────────────────────────────────────────────────────────┤
│                                                               │
│  ┌─────────────────────────────────────────────────────────┐  │
│  │                 GRIMBOLD'S TRADING POST                  │  │
│  │                     General Store                         │  │
│  ├─────────────────────────────────────────────────────────┤  │
│  │  Your Gold: 127        Reputation: Friendly (+5% off)   │  │
│  │  Haggle Discount: 10%                                    │  │
│  ├─────────────────────────────────────────────────────────┤  │
│  │  FOR SALE                      PRICE   STOCK   COMP     │  │
│  │  ──────────────────────────────────────────────────     │  │
│  │  [1] Iron Sword                45g     3       ▲+2      │  │
│  │  [2] Leather Armor             32g     2       ▲+3      │  │
│  │  [3] Health Potion             14g     10      ──       │  │
│  ├─────────────────────────────────────────────────────────┤  │
│  │  YOUR ITEMS (Sellable)         VALUE                    │  │
│  │  ──────────────────────────────────────────────────     │  │
│  │  [a] Rusty Dagger              3g                       │  │
│  │  [b] Goblin Ear x5             10g                      │  │
│  ├─────────────────────────────────────────────────────────┤  │
│  │  Commands: [#] Buy  [letter] Sell  [h]aggle  [q]uit    │  │
│  └─────────────────────────────────────────────────────────┘  │
│                                                               │
└───────────────────────────────────────────────────────────────┘
             │
             ▼
┌───────────────────────────────────────────────────────────────┐
│                    SHOP INPUT LOOP                            │
├───────────────────────────────────────────────────────────────┤
│                                                               │
│  Input                 Action                                 │
│  ─────                 ──────                                 │
│  [1-9]                 Buy item at index                      │
│  [a-z]                 Sell item at index                     │
│  h                     Attempt haggle                         │
│  c [#]                 Compare item at index                  │
│  i                     View full inventory                    │
│  q                     Exit shop                              │
│                                                               │
└───────────────────────────────────────────────────────────────┘
```

### 3.3 Inventory Refresh Flow

```
┌───────────────────────────────────────────────────────────────┐
│                  INVENTORY REFRESH CHECK                      │
└───────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌───────────────────────────────────────────────────────────────┐
│ InventoryRefreshService.ShouldRefresh(merchant)               │
│                                                               │
│ - Get LastStockRefresh from merchant                          │
│ - Get StockRefreshHours from merchant type                    │
│ - Check if current time > LastRefresh + RefreshHours          │
│                                                               │
│ Returns: true/false                                           │
└───────────────────────────────────────────────────────────────┘
                              │
                              ▼ (if true)
┌───────────────────────────────────────────────────────────────┐
│ InventoryRefreshService.RefreshInventory(merchant)            │
│                                                               │
│ 1. Get MerchantTypeDefinition for merchant.MerchantType       │
│                                                               │
│ 2. Determine stock count:                                     │
│    stockCount = Random(MinStock, MaxStock)                    │
│                                                               │
│ 3. For each stock slot:                                       │
│    ┌──────────────────────────────────────────────────────┐  │
│    │ a. Roll for rarity (weighted by RarityWeights)        │  │
│    │ b. Filter items by StockCategories                    │  │
│    │ c. Exclude items in ExcludeCategories                 │  │
│    │ d. Filter by merchant level (rarity gates)            │  │
│    │ e. Random select from filtered pool                   │  │
│    │ f. Generate quantity (1-5 for common, 1-2 for rare)   │  │
│    └──────────────────────────────────────────────────────┘  │
│                                                               │
│ 4. Create ShopInventory from generated items                  │
│                                                               │
│ 5. Call merchant.RefreshStock(newInventory)                   │
│    - Updates Inventory                                        │
│    - Sets LastStockRefresh = DateTime.UtcNow                  │
│                                                               │
└───────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌───────────────────────────────────────────────────────────────┐
│ Merchant now has fresh inventory                              │
│                                                               │
│ Example for Weaponsmith (Level 2):                            │
│ ├── Iron Sword x2 (common)                                    │
│ ├── Steel Dagger x3 (common)                                  │
│ ├── Longsword x1 (uncommon)                                   │
│ ├── Mace x2 (common)                                          │
│ └── Whetstone x5 (common, unlimited)                          │
│                                                               │
└───────────────────────────────────────────────────────────────┘
```

---

## 4. User Stories

### US-2.2c-1: Open Shop Interface
**As a** player near a merchant
**I want to** open an interactive shop interface
**So that** I can browse items and make purchases easily

**Acceptance Criteria:**
- `shop` command opens TUI interface
- `shop <name>` opens specific merchant's shop
- Shop displays merchant name and type
- Player's gold and discounts shown
- Interface updates after transactions

### US-2.2c-2: View Item Comparisons
**As a** player browsing shop items
**I want to** see how items compare to my equipped gear
**So that** I can make informed purchase decisions

**Acceptance Criteria:**
- Comparison column shows upgrade/downgrade indicators
- `▲` indicates upgrade, `▼` indicates downgrade
- Stat differences shown numerically
- Compare command shows detailed breakdown
- Comparison considers relevant item slot

### US-2.2c-3: Appraise Items
**As a** player with items to sell
**I want to** see detailed value breakdowns
**So that** I understand what affects item prices

**Acceptance Criteria:**
- `appraise <item>` shows value breakdown
- Base value and modifiers displayed
- Current merchant's offer shown
- Haggle discount reflected in offer
- Comparison to equipped item if applicable

### US-2.2c-4: Specialty Merchants
**As a** player seeking specific items
**I want to** find specialty merchants
**So that** I can access better selection in that category

**Acceptance Criteria:**
- Merchant types clearly labeled
- Specialty merchants stock type-appropriate items
- Specialty items may have better prices
- Each type has unique inventory pool
- Merchant type shown in shop header

### US-2.2c-5: Inventory Refresh
**As a** player returning to a merchant
**I want to** see new stock periodically
**So that** I have reasons to revisit merchants

**Acceptance Criteria:**
- Inventory refreshes after configured time
- Refresh time varies by merchant type
- New items generated based on merchant level
- Rarity distribution follows configuration
- Time until refresh shown if near

### US-2.2c-6: Buy/Sell in Shop Interface
**As a** player using the shop interface
**I want to** buy and sell items directly
**So that** I don't need to exit the interface

**Acceptance Criteria:**
- Number keys buy from shop inventory
- Letter keys sell from player inventory
- Immediate feedback on transaction
- Interface updates to reflect changes
- Gold total updates immediately

---

## 5. Data Models

### 5.1 MerchantType Enum

```csharp
namespace RuneAndRust.Domain.Enums;

/// <summary>
/// Types of specialty merchants.
/// </summary>
/// <remarks>
/// Each merchant type specializes in specific item categories
/// and has unique inventory generation parameters.
/// </remarks>
public enum MerchantType
{
    /// <summary>
    /// General goods merchant with varied inventory.
    /// </summary>
    /// <remarks>
    /// Stocks items from multiple categories but rarely
    /// has rare or legendary items.
    /// </remarks>
    GeneralStore,

    /// <summary>
    /// Specializes in weapons of all types.
    /// </summary>
    /// <remarks>
    /// Best place to find swords, axes, bows, and
    /// weapon accessories like whetstones.
    /// </remarks>
    Weaponsmith,

    /// <summary>
    /// Specializes in armor and shields.
    /// </summary>
    /// <remarks>
    /// Stocks all armor types from cloth to plate,
    /// plus shields and armor repair supplies.
    /// </remarks>
    Armorer,

    /// <summary>
    /// Sells potions and magical consumables.
    /// </summary>
    /// <remarks>
    /// Primary source for health potions, mana potions,
    /// and alchemical reagents.
    /// </remarks>
    Alchemist,

    /// <summary>
    /// Sells scrolls and magical items.
    /// </summary>
    /// <remarks>
    /// Stocks spell scrolls, enchanted accessories,
    /// and magical curiosities.
    /// </remarks>
    Enchanter,

    /// <summary>
    /// Buys and sells gems and jewelry.
    /// </summary>
    /// <remarks>
    /// Specializes in rings, amulets, gems, and
    /// pays premium prices for jewelry items.
    /// </remarks>
    Jeweler,

    /// <summary>
    /// Sells food and adventuring supplies.
    /// </summary>
    /// <remarks>
    /// Stocks rations, torches, rope, and other
    /// essential adventuring equipment.
    /// </remarks>
    Provisioner,

    /// <summary>
    /// Deals in rare and exotic goods.
    /// </summary>
    /// <remarks>
    /// May have unusual or unique items not found
    /// elsewhere. Stock is unpredictable.
    /// </remarks>
    CurioDealer
}
```

### 5.2 ItemComparison Value Object

```csharp
namespace RuneAndRust.Domain.ValueObjects;

/// <summary>
/// Comparison between a shop item and player's equipped item.
/// </summary>
/// <remarks>
/// Used to display upgrade/downgrade indicators in the shop UI
/// and provide detailed comparison breakdowns.
/// </remarks>
public readonly record struct ItemComparison
{
    /// <summary>
    /// Gets the shop item being compared.
    /// </summary>
    public Item ShopItem { get; init; }

    /// <summary>
    /// Gets the currently equipped item in the same slot.
    /// </summary>
    /// <remarks>
    /// Null if no item is equipped in the corresponding slot.
    /// </remarks>
    public Item? EquippedItem { get; init; }

    /// <summary>
    /// Gets stat differences (positive = shop item better).
    /// </summary>
    /// <remarks>
    /// Keys are stat names like "Attack", "Defense", "Speed".
    /// Values are the difference (shop - equipped).
    /// </remarks>
    public IReadOnlyDictionary<string, int> StatDifferences { get; init; }

    /// <summary>
    /// Gets whether the shop item is an upgrade.
    /// </summary>
    /// <remarks>
    /// True if total stat difference is positive.
    /// </remarks>
    public bool IsUpgrade { get; init; }

    /// <summary>
    /// Gets whether the shop item is a downgrade.
    /// </summary>
    /// <remarks>
    /// True if total stat difference is negative.
    /// </remarks>
    public bool IsDowngrade { get; init; }

    /// <summary>
    /// Gets whether items are equivalent in stats.
    /// </summary>
    public bool IsEquivalent => !IsUpgrade && !IsDowngrade;

    /// <summary>
    /// Gets the total stat difference value.
    /// </summary>
    public int TotalDifference => StatDifferences.Values.Sum();

    /// <summary>
    /// Creates a comparison between two items.
    /// </summary>
    /// <param name="shopItem">The item in the shop.</param>
    /// <param name="equippedItem">The currently equipped item (if any).</param>
    /// <returns>An ItemComparison instance.</returns>
    public static ItemComparison Create(Item shopItem, Item? equippedItem)
    {
        if (equippedItem == null)
        {
            return new ItemComparison
            {
                ShopItem = shopItem,
                EquippedItem = null,
                StatDifferences = new Dictionary<string, int>(),
                IsUpgrade = true,
                IsDowngrade = false
            };
        }

        var differences = new Dictionary<string, int>();

        // Compare attack bonus
        var shopAttack = shopItem.WeaponBonuses?.AttackBonus ?? 0;
        var equippedAttack = equippedItem.WeaponBonuses?.AttackBonus ?? 0;
        var attackDiff = shopAttack - equippedAttack;
        if (attackDiff != 0) differences["Attack"] = attackDiff;

        // Compare damage bonus
        var shopDamage = shopItem.WeaponBonuses?.DamageBonus ?? 0;
        var equippedDamage = equippedItem.WeaponBonuses?.DamageBonus ?? 0;
        var damageDiff = shopDamage - equippedDamage;
        if (damageDiff != 0) differences["Damage"] = damageDiff;

        // Compare defense/armor
        var shopDefense = shopItem.ArmorValue ?? 0;
        var equippedDefense = equippedItem.ArmorValue ?? 0;
        var defenseDiff = shopDefense - equippedDefense;
        if (defenseDiff != 0) differences["Defense"] = defenseDiff;

        // Determine upgrade/downgrade based on total
        var totalDiff = differences.Values.Sum();

        return new ItemComparison
        {
            ShopItem = shopItem,
            EquippedItem = equippedItem,
            StatDifferences = differences,
            IsUpgrade = totalDiff > 0,
            IsDowngrade = totalDiff < 0
        };
    }

    /// <summary>
    /// Gets a display indicator for the comparison result.
    /// </summary>
    /// <returns>String indicator like "▲+3", "▼-2", or "──".</returns>
    public string GetComparisonIndicator()
    {
        if (EquippedItem == null)
        {
            return "NEW";
        }

        if (IsEquivalent)
        {
            return "──";
        }

        var total = TotalDifference;
        if (IsUpgrade)
        {
            return $"▲+{total}";
        }
        else
        {
            return $"▼{total}";
        }
    }
}
```

### 5.3 ItemAppraisal Value Object

```csharp
namespace RuneAndRust.Domain.ValueObjects;

/// <summary>
/// Detailed appraisal information for an item.
/// </summary>
/// <remarks>
/// Provides breakdown of how item value is calculated
/// including all modifiers and merchant-specific pricing.
/// </remarks>
public readonly record struct ItemAppraisal
{
    /// <summary>
    /// Gets the item being appraised.
    /// </summary>
    public Item Item { get; init; }

    /// <summary>
    /// Gets the item's base value before modifiers.
    /// </summary>
    public int BaseValue { get; init; }

    /// <summary>
    /// Gets the condition modifier (0.0 to 1.0+).
    /// </summary>
    /// <remarks>
    /// Poor condition reduces value, excellent increases it.
    /// </remarks>
    public decimal ConditionModifier { get; init; }

    /// <summary>
    /// Gets the final calculated value.
    /// </summary>
    public int FinalValue { get; init; }

    /// <summary>
    /// Gets what the current merchant would pay.
    /// </summary>
    /// <remarks>
    /// Reflects merchant's sell multiplier and any haggle discounts.
    /// </remarks>
    public int MerchantOffer { get; init; }

    /// <summary>
    /// Gets the breakdown of price modifiers.
    /// </summary>
    public IReadOnlyList<PriceModifierDetail> ModifierBreakdown { get; init; }

    /// <summary>
    /// Gets comparison to equipped item if applicable.
    /// </summary>
    public ItemComparison? Comparison { get; init; }

    /// <summary>
    /// Creates an appraisal for an item.
    /// </summary>
    /// <param name="item">The item to appraise.</param>
    /// <param name="merchant">The merchant providing the offer.</param>
    /// <param name="player">The player for modifier calculations.</param>
    /// <param name="equippedItem">Currently equipped item for comparison.</param>
    /// <returns>An ItemAppraisal instance.</returns>
    public static ItemAppraisal Create(
        Item item,
        Merchant merchant,
        Player player,
        Item? equippedItem = null)
    {
        var baseValue = item.BasePrice;
        var conditionModifier = GetConditionModifier(item);
        var adjustedBase = (int)(baseValue * conditionModifier);

        // Get merchant's sell price (what they'll pay)
        var merchantSellMultiplier = merchant.SellMultiplier;
        var merchantOffer = (int)Math.Floor(adjustedBase * merchantSellMultiplier);

        // Build modifier breakdown
        var breakdown = new List<PriceModifierDetail>
        {
            new() { Name = "Base Price", Value = baseValue, Modifier = 1.0m },
            new() { Name = "Condition", Value = adjustedBase, Modifier = conditionModifier }
        };

        // Check for haggle discount (improves sell price for player)
        if (player.HasHaggleDiscount(merchant.Id))
        {
            var discount = player.GetHaggleDiscount(merchant.Id);
            // Haggle bonus improves what player gets
            var haggleBonus = 1.0m + discount;
            merchantOffer = (int)Math.Floor(merchantOffer * haggleBonus);
            breakdown.Add(new PriceModifierDetail
            {
                Name = "Haggle Bonus",
                Value = merchantOffer,
                Modifier = haggleBonus
            });
        }

        ItemComparison? comparison = null;
        if (equippedItem != null || IsEquipment(item))
        {
            comparison = ItemComparison.Create(item, equippedItem);
        }

        return new ItemAppraisal
        {
            Item = item,
            BaseValue = baseValue,
            ConditionModifier = conditionModifier,
            FinalValue = adjustedBase,
            MerchantOffer = merchantOffer,
            ModifierBreakdown = breakdown,
            Comparison = comparison
        };
    }

    private static decimal GetConditionModifier(Item item)
    {
        // TODO: Implement condition system in future version
        // For now, return 1.0 (normal condition)
        return 1.0m;
    }

    private static bool IsEquipment(Item item)
    {
        return item.ItemType == ItemType.Weapon ||
               item.ItemType == ItemType.Armor ||
               item.ItemType == ItemType.Accessory;
    }
}

/// <summary>
/// Detail of a single price modifier.
/// </summary>
public readonly record struct PriceModifierDetail
{
    /// <summary>
    /// Gets the modifier name.
    /// </summary>
    public string Name { get; init; }

    /// <summary>
    /// Gets the value after this modifier.
    /// </summary>
    public int Value { get; init; }

    /// <summary>
    /// Gets the modifier multiplier.
    /// </summary>
    public decimal Modifier { get; init; }
}
```

### 5.4 MerchantTypeDefinition

```csharp
namespace RuneAndRust.Domain.Definitions;

/// <summary>
/// Configuration for a merchant type's inventory generation.
/// </summary>
/// <remarks>
/// Loaded from merchant-types.json configuration file.
/// Defines what items a merchant type can stock and
/// how inventory refresh works.
/// </remarks>
public class MerchantTypeDefinition
{
    /// <summary>
    /// Gets the merchant type this definition applies to.
    /// </summary>
    public MerchantType Type { get; init; }

    /// <summary>
    /// Gets the item categories this type stocks.
    /// </summary>
    /// <remarks>
    /// Examples: "weapons", "armor", "potions", "all".
    /// "all" means any category is allowed.
    /// </remarks>
    public IReadOnlyList<string> StockCategories { get; init; } = [];

    /// <summary>
    /// Gets categories explicitly excluded from stock.
    /// </summary>
    /// <remarks>
    /// Takes precedence over StockCategories.
    /// Examples: "legendary", "quest-items".
    /// </remarks>
    public IReadOnlyList<string> ExcludeCategories { get; init; } = [];

    /// <summary>
    /// Gets the price modifier for this merchant type.
    /// </summary>
    /// <remarks>
    /// Applied to specialty items. 0.95 = 5% discount.
    /// </remarks>
    public decimal PriceModifier { get; init; } = 1.0m;

    /// <summary>
    /// Gets hours between inventory refreshes.
    /// </summary>
    public int StockRefreshHours { get; init; } = 24;

    /// <summary>
    /// Gets minimum number of unique items in stock.
    /// </summary>
    public int MinStock { get; init; } = 5;

    /// <summary>
    /// Gets maximum number of unique items in stock.
    /// </summary>
    public int MaxStock { get; init; } = 15;

    /// <summary>
    /// Gets rarity weights for stock generation.
    /// </summary>
    /// <remarks>
    /// Keys are rarity names, values are weights.
    /// Higher weight = more likely to appear.
    /// Example: { "common": 60, "uncommon": 30, "rare": 10 }
    /// </remarks>
    public IReadOnlyDictionary<string, int> RarityWeights { get; init; } =
        new Dictionary<string, int>
        {
            ["common"] = 60,
            ["uncommon"] = 30,
            ["rare"] = 10
        };
}
```

### 5.5 Merchant Entity Updates

```csharp
// Additions to Merchant.cs

/// <summary>
/// Gets the merchant's specialty type.
/// </summary>
/// <remarks>
/// Determines what categories of items the merchant stocks
/// and applies specialty pricing.
/// </remarks>
public MerchantType MerchantType { get; private set; } = MerchantType.GeneralStore;

/// <summary>
/// Gets hours between inventory refreshes.
/// </summary>
/// <remarks>
/// Overrides the default from MerchantTypeDefinition if set.
/// </remarks>
public int StockRefreshHours { get; private set; } = 24;

/// <summary>
/// Gets the last time stock was refreshed.
/// </summary>
/// <remarks>
/// Used to determine when next refresh should occur.
/// </remarks>
public DateTime? LastStockRefresh { get; private set; }

/// <summary>
/// Gets the merchant's level for stock generation.
/// </summary>
/// <remarks>
/// Higher levels can stock rarer items.
/// Level 1: Common only
/// Level 2: Common + Uncommon
/// Level 3+: All rarities available
/// </remarks>
public int MerchantLevel { get; private set; } = 1;

/// <summary>
/// Checks if inventory should be refreshed.
/// </summary>
/// <returns>True if refresh is needed.</returns>
public bool ShouldRefreshStock()
{
    if (LastStockRefresh == null)
    {
        return true;
    }

    var nextRefresh = LastStockRefresh.Value.AddHours(StockRefreshHours);
    return DateTime.UtcNow >= nextRefresh;
}

/// <summary>
/// Gets time remaining until next stock refresh.
/// </summary>
/// <returns>TimeSpan until refresh, or Zero if refresh is due.</returns>
public TimeSpan GetTimeUntilRefresh()
{
    if (LastStockRefresh == null || ShouldRefreshStock())
    {
        return TimeSpan.Zero;
    }

    var nextRefresh = LastStockRefresh.Value.AddHours(StockRefreshHours);
    return nextRefresh - DateTime.UtcNow;
}

/// <summary>
/// Refreshes the merchant's stock with new items.
/// </summary>
/// <param name="newInventory">The new inventory to set.</param>
public void RefreshStock(ShopInventory newInventory)
{
    Inventory = newInventory;
    LastStockRefresh = DateTime.UtcNow;
}

/// <summary>
/// Sets the merchant type.
/// </summary>
/// <param name="type">The merchant type.</param>
public void SetMerchantType(MerchantType type)
{
    MerchantType = type;
}

/// <summary>
/// Sets the merchant level.
/// </summary>
/// <param name="level">The level (1+).</param>
public void SetLevel(int level)
{
    MerchantLevel = Math.Max(1, level);
}
```

### 5.6 SellableItem DTO

```csharp
namespace RuneAndRust.Application.DTOs;

/// <summary>
/// Represents an item the player can sell to a merchant.
/// </summary>
public readonly record struct SellableItem
{
    /// <summary>
    /// Gets the item.
    /// </summary>
    public Item Item { get; init; }

    /// <summary>
    /// Gets the quantity the player has.
    /// </summary>
    public int Quantity { get; init; }

    /// <summary>
    /// Gets what the merchant will pay (per item).
    /// </summary>
    public int SellPrice { get; init; }

    /// <summary>
    /// Gets the total value if all sold.
    /// </summary>
    public int TotalValue => SellPrice * Quantity;

    /// <summary>
    /// Gets the display key for this item (a-z).
    /// </summary>
    public char DisplayKey { get; init; }
}
```

---

## 6. Configuration Schemas

### 6.1 merchant-types.json

```json
{
  "$schema": "./schemas/merchant-types.schema.json",
  "merchantTypes": {
    "GeneralStore": {
      "stockCategories": ["all"],
      "excludeCategories": ["rare", "legendary", "quest-items"],
      "priceModifier": 1.05,
      "stockRefreshHours": 48,
      "minStock": 15,
      "maxStock": 30,
      "rarityWeights": {
        "common": 70,
        "uncommon": 25,
        "rare": 5
      }
    },
    "Weaponsmith": {
      "stockCategories": ["weapons", "weapon-accessories"],
      "excludeCategories": ["armor", "potions", "scrolls"],
      "priceModifier": 0.95,
      "stockRefreshHours": 24,
      "minStock": 8,
      "maxStock": 20,
      "rarityWeights": {
        "common": 55,
        "uncommon": 35,
        "rare": 10
      }
    },
    "Armorer": {
      "stockCategories": ["armor", "shields", "armor-accessories"],
      "excludeCategories": ["weapons", "potions"],
      "priceModifier": 0.95,
      "stockRefreshHours": 24,
      "minStock": 8,
      "maxStock": 18,
      "rarityWeights": {
        "common": 55,
        "uncommon": 35,
        "rare": 10
      }
    },
    "Alchemist": {
      "stockCategories": ["potions", "reagents", "poisons"],
      "excludeCategories": ["weapons", "armor"],
      "priceModifier": 1.0,
      "stockRefreshHours": 12,
      "minStock": 10,
      "maxStock": 25,
      "rarityWeights": {
        "common": 50,
        "uncommon": 35,
        "rare": 15
      }
    },
    "Enchanter": {
      "stockCategories": ["scrolls", "enchanted-items", "magical-accessories"],
      "excludeCategories": ["mundane-weapons", "mundane-armor"],
      "priceModifier": 1.1,
      "stockRefreshHours": 48,
      "minStock": 5,
      "maxStock": 12,
      "rarityWeights": {
        "common": 40,
        "uncommon": 40,
        "rare": 20
      }
    },
    "Jeweler": {
      "stockCategories": ["rings", "amulets", "gems", "jewelry"],
      "excludeCategories": ["weapons", "armor", "potions"],
      "priceModifier": 1.0,
      "stockRefreshHours": 36,
      "minStock": 6,
      "maxStock": 15,
      "rarityWeights": {
        "common": 45,
        "uncommon": 40,
        "rare": 15
      }
    },
    "Provisioner": {
      "stockCategories": ["food", "supplies", "tools", "containers"],
      "excludeCategories": ["weapons", "armor", "magical"],
      "priceModifier": 0.90,
      "stockRefreshHours": 24,
      "minStock": 12,
      "maxStock": 30,
      "rarityWeights": {
        "common": 80,
        "uncommon": 18,
        "rare": 2
      }
    },
    "CurioDealer": {
      "stockCategories": ["rare", "exotic", "artifacts", "curiosities"],
      "excludeCategories": ["common-supplies"],
      "priceModifier": 1.15,
      "stockRefreshHours": 72,
      "minStock": 3,
      "maxStock": 8,
      "rarityWeights": {
        "common": 20,
        "uncommon": 45,
        "rare": 35
      }
    }
  }
}
```

### 6.2 merchant-types.schema.json

```json
{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "title": "Merchant Types Configuration",
  "description": "Defines merchant type specializations and inventory parameters",
  "type": "object",
  "required": ["merchantTypes"],
  "properties": {
    "merchantTypes": {
      "type": "object",
      "additionalProperties": {
        "$ref": "#/definitions/merchantTypeDefinition"
      },
      "description": "Map of merchant type name to definition"
    }
  },
  "definitions": {
    "merchantTypeDefinition": {
      "type": "object",
      "required": ["stockCategories", "stockRefreshHours", "minStock", "maxStock"],
      "properties": {
        "stockCategories": {
          "type": "array",
          "items": { "type": "string" },
          "minItems": 1,
          "description": "Item categories this merchant stocks"
        },
        "excludeCategories": {
          "type": "array",
          "items": { "type": "string" },
          "default": [],
          "description": "Item categories to exclude from stock"
        },
        "priceModifier": {
          "type": "number",
          "minimum": 0.5,
          "maximum": 2.0,
          "default": 1.0,
          "description": "Price modifier for specialty items (0.95 = 5% discount)"
        },
        "stockRefreshHours": {
          "type": "integer",
          "minimum": 1,
          "maximum": 168,
          "description": "Hours between inventory refreshes"
        },
        "minStock": {
          "type": "integer",
          "minimum": 1,
          "maximum": 50,
          "description": "Minimum unique items in stock"
        },
        "maxStock": {
          "type": "integer",
          "minimum": 1,
          "maximum": 100,
          "description": "Maximum unique items in stock"
        },
        "rarityWeights": {
          "type": "object",
          "properties": {
            "common": { "type": "integer", "minimum": 0 },
            "uncommon": { "type": "integer", "minimum": 0 },
            "rare": { "type": "integer", "minimum": 0 },
            "legendary": { "type": "integer", "minimum": 0 }
          },
          "additionalProperties": { "type": "integer", "minimum": 0 },
          "description": "Rarity weights for stock generation"
        }
      }
    }
  }
}
```

---

## 7. Service Specifications

### 7.1 IInventoryRefreshService Interface

```csharp
namespace RuneAndRust.Application.Interfaces;

/// <summary>
/// Manages merchant inventory refresh and stock generation.
/// </summary>
public interface IInventoryRefreshService
{
    /// <summary>
    /// Checks if a merchant's inventory should refresh.
    /// </summary>
    /// <param name="merchant">The merchant to check.</param>
    /// <returns>True if refresh is needed.</returns>
    bool ShouldRefresh(Merchant merchant);

    /// <summary>
    /// Refreshes a merchant's inventory with new stock.
    /// </summary>
    /// <param name="merchant">The merchant to refresh.</param>
    void RefreshInventory(Merchant merchant);

    /// <summary>
    /// Gets the time until next refresh for a merchant.
    /// </summary>
    /// <param name="merchant">The merchant.</param>
    /// <returns>TimeSpan until refresh.</returns>
    TimeSpan GetTimeUntilRefresh(Merchant merchant);

    /// <summary>
    /// Generates stock items for a merchant type.
    /// </summary>
    /// <param name="type">The merchant type.</param>
    /// <param name="merchantLevel">The merchant's level for rarity gates.</param>
    /// <returns>Generated shop items.</returns>
    IEnumerable<ShopItem> GenerateStock(MerchantType type, int merchantLevel);
}
```

### 7.2 InventoryRefreshService Implementation

```csharp
namespace RuneAndRust.Application.Services;

/// <summary>
/// Implementation of merchant inventory refresh logic.
/// </summary>
public class InventoryRefreshService : IInventoryRefreshService
{
    private readonly IConfigurationProvider _configProvider;
    private readonly IItemService _itemService;
    private readonly ILogger<InventoryRefreshService> _logger;
    private readonly Random _random;

    /// <summary>
    /// Initializes a new instance of InventoryRefreshService.
    /// </summary>
    /// <param name="configProvider">Configuration provider for merchant types.</param>
    /// <param name="itemService">Item service for item lookup.</param>
    /// <param name="logger">Logger instance.</param>
    public InventoryRefreshService(
        IConfigurationProvider configProvider,
        IItemService itemService,
        ILogger<InventoryRefreshService> logger)
    {
        _configProvider = configProvider;
        _itemService = itemService;
        _logger = logger;
        _random = new Random();
    }

    /// <inheritdoc />
    public bool ShouldRefresh(Merchant merchant)
    {
        return merchant.ShouldRefreshStock();
    }

    /// <inheritdoc />
    public void RefreshInventory(Merchant merchant)
    {
        _logger.LogInformation(
            "RefreshInventory: Refreshing stock for {MerchantName} ({MerchantType})",
            merchant.Name, merchant.MerchantType);

        var newStock = GenerateStock(merchant.MerchantType, merchant.MerchantLevel);
        var newInventory = ShopInventory.Create(newStock);

        merchant.RefreshStock(newInventory);

        _logger.LogInformation(
            "RefreshInventory: Generated {ItemCount} items for {MerchantName}",
            newInventory.UniqueItemCount, merchant.Name);
    }

    /// <inheritdoc />
    public TimeSpan GetTimeUntilRefresh(Merchant merchant)
    {
        return merchant.GetTimeUntilRefresh();
    }

    /// <inheritdoc />
    public IEnumerable<ShopItem> GenerateStock(MerchantType type, int merchantLevel)
    {
        var typeDefinition = _configProvider.GetMerchantTypeDefinition(type);
        if (typeDefinition == null)
        {
            _logger.LogWarning(
                "GenerateStock: No definition found for {MerchantType}, using defaults",
                type);
            typeDefinition = GetDefaultDefinition(type);
        }

        var stockCount = _random.Next(typeDefinition.MinStock, typeDefinition.MaxStock + 1);
        var generatedItems = new List<ShopItem>();
        var usedItemIds = new HashSet<string>();

        _logger.LogDebug(
            "GenerateStock: Generating {Count} items for {Type} (level {Level})",
            stockCount, type, merchantLevel);

        for (int i = 0; i < stockCount; i++)
        {
            var item = GenerateSingleItem(
                typeDefinition,
                merchantLevel,
                usedItemIds);

            if (item != null)
            {
                generatedItems.Add(item.Value);
                usedItemIds.Add(item.Value.ItemId);
            }
        }

        return generatedItems;
    }

    private ShopItem? GenerateSingleItem(
        MerchantTypeDefinition typeDefinition,
        int merchantLevel,
        HashSet<string> excludeIds)
    {
        // Roll for rarity
        var rarity = RollForRarity(typeDefinition.RarityWeights, merchantLevel);

        // Get available items matching criteria
        var availableItems = _itemService.GetItemsByCategory(typeDefinition.StockCategories)
            .Where(item => !typeDefinition.ExcludeCategories.Contains(item.Category))
            .Where(item => item.Rarity == rarity || rarity == "any")
            .Where(item => !excludeIds.Contains(item.Id.ToString()))
            .ToList();

        if (availableItems.Count == 0)
        {
            // Fallback to any item in categories
            availableItems = _itemService.GetItemsByCategory(typeDefinition.StockCategories)
                .Where(item => !typeDefinition.ExcludeCategories.Contains(item.Category))
                .Where(item => !excludeIds.Contains(item.Id.ToString()))
                .ToList();
        }

        if (availableItems.Count == 0)
        {
            return null;
        }

        var selectedItem = availableItems[_random.Next(availableItems.Count)];
        var quantity = GenerateQuantity(selectedItem.Rarity);

        return new ShopItem
        {
            ItemId = selectedItem.Id.ToString(),
            Item = selectedItem,
            Quantity = quantity,
            IsUnlimited = IsUnlimitedStock(selectedItem)
        };
    }

    private string RollForRarity(
        IReadOnlyDictionary<string, int> rarityWeights,
        int merchantLevel)
    {
        // Filter rarities by merchant level
        var availableRarities = rarityWeights
            .Where(kv => IsRarityAvailable(kv.Key, merchantLevel))
            .ToList();

        if (availableRarities.Count == 0)
        {
            return "common";
        }

        var totalWeight = availableRarities.Sum(kv => kv.Value);
        var roll = _random.Next(totalWeight);

        var cumulative = 0;
        foreach (var kv in availableRarities)
        {
            cumulative += kv.Value;
            if (roll < cumulative)
            {
                return kv.Key;
            }
        }

        return "common";
    }

    private bool IsRarityAvailable(string rarity, int merchantLevel)
    {
        return rarity switch
        {
            "common" => true,
            "uncommon" => merchantLevel >= 2,
            "rare" => merchantLevel >= 3,
            "legendary" => merchantLevel >= 5,
            _ => merchantLevel >= 2
        };
    }

    private int GenerateQuantity(string rarity)
    {
        return rarity switch
        {
            "common" => _random.Next(2, 6),      // 2-5
            "uncommon" => _random.Next(1, 4),    // 1-3
            "rare" => _random.Next(1, 3),        // 1-2
            "legendary" => 1,
            _ => _random.Next(1, 4)
        };
    }

    private bool IsUnlimitedStock(Item item)
    {
        // Basic consumables like torches have unlimited stock
        return item.Category == "supplies" &&
               item.Rarity == "common" &&
               item.BasePrice <= 10;
    }

    private MerchantTypeDefinition GetDefaultDefinition(MerchantType type)
    {
        return new MerchantTypeDefinition
        {
            Type = type,
            StockCategories = new[] { "all" },
            ExcludeCategories = Array.Empty<string>(),
            PriceModifier = 1.0m,
            StockRefreshHours = 24,
            MinStock = 5,
            MaxStock = 15,
            RarityWeights = new Dictionary<string, int>
            {
                ["common"] = 60,
                ["uncommon"] = 30,
                ["rare"] = 10
            }
        };
    }
}
```

### 7.3 ShopService Updates

```csharp
// Additions to ShopService.cs

/// <summary>
/// Gets an item comparison for a shop item vs equipped item.
/// </summary>
/// <param name="shopItem">The shop item to compare.</param>
/// <param name="player">The player for equipment lookup.</param>
/// <returns>The item comparison.</returns>
public ItemComparison GetItemComparison(ShopItem shopItem, Player player)
{
    var equippedItem = GetEquippedItemInSlot(player, shopItem.Item);
    return ItemComparison.Create(shopItem.Item, equippedItem);
}

/// <summary>
/// Gets all comparisons for a merchant's inventory.
/// </summary>
/// <param name="merchant">The merchant.</param>
/// <param name="player">The player.</param>
/// <returns>Dictionary of item ID to comparison.</returns>
public IReadOnlyDictionary<string, ItemComparison> GetAllComparisons(
    Merchant merchant,
    Player player)
{
    var comparisons = new Dictionary<string, ItemComparison>();

    foreach (var shopItem in merchant.Inventory.Items)
    {
        var comparison = GetItemComparison(shopItem, player);
        comparisons[shopItem.ItemId] = comparison;
    }

    return comparisons;
}

/// <summary>
/// Creates an appraisal for an item.
/// </summary>
/// <param name="item">The item to appraise.</param>
/// <param name="merchant">The merchant providing the offer.</param>
/// <param name="player">The player.</param>
/// <returns>The item appraisal.</returns>
public ItemAppraisal AppraiseItem(Item item, Merchant merchant, Player player)
{
    var equippedItem = GetEquippedItemInSlot(player, item);
    return ItemAppraisal.Create(item, merchant, player, equippedItem);
}

/// <summary>
/// Gets all sellable items from a player's inventory.
/// </summary>
/// <param name="player">The player.</param>
/// <param name="merchant">The merchant for pricing.</param>
/// <returns>List of sellable items with prices.</returns>
public IEnumerable<SellableItem> GetSellableItems(Player player, Merchant merchant)
{
    var sellableItems = new List<SellableItem>();
    char currentKey = 'a';

    foreach (var invItem in player.Inventory.Items)
    {
        if (!invItem.Item.CanBeSold || invItem.Item.IsQuestItem)
        {
            continue;
        }

        var price = GetSellPrice(merchant, invItem.Item, player);

        sellableItems.Add(new SellableItem
        {
            Item = invItem.Item,
            Quantity = invItem.Quantity,
            SellPrice = price,
            DisplayKey = currentKey
        });

        currentKey++;
        if (currentKey > 'z') break; // Max 26 sellable items displayed
    }

    return sellableItems;
}

private Item? GetEquippedItemInSlot(Player player, Item shopItem)
{
    // Get the slot this item would be equipped in
    var slot = GetEquipmentSlot(shopItem);
    if (slot == null)
    {
        return null;
    }

    return player.Equipment.GetItemInSlot(slot.Value);
}

private EquipmentSlot? GetEquipmentSlot(Item item)
{
    return item.ItemType switch
    {
        ItemType.Weapon => EquipmentSlot.MainHand,
        ItemType.Armor => GetArmorSlot(item),
        ItemType.Accessory => GetAccessorySlot(item),
        _ => null
    };
}

private EquipmentSlot GetArmorSlot(Item item)
{
    // Determine based on armor category
    return item.ArmorSlot ?? EquipmentSlot.Body;
}

private EquipmentSlot GetAccessorySlot(Item item)
{
    return item.AccessorySlot ?? EquipmentSlot.Ring1;
}
```

---

## 8. Shop UI Flow

### 8.1 Shop Command Flow

```
Player Input: "shop" or "shop grimbold"
        │
        ▼
┌───────────────────────────────────────────────────────┐
│ InputHandler.ParseCommand()                           │
│ - Identifies "shop" command                           │
│ - Extracts optional merchant name                     │
└───────────────────────────────────────────────────────┘
        │
        ▼
┌───────────────────────────────────────────────────────┐
│ GameSessionService.OpenShop(merchantName?)            │
│ - Gets current room                                   │
│ - Finds merchant (by name or first available)         │
│ - Validates merchant is open                          │
└───────────────────────────────────────────────────────┘
        │
        ▼
┌───────────────────────────────────────────────────────┐
│ Check and Refresh Inventory if Needed                 │
│                                                       │
│ if (inventoryRefreshService.ShouldRefresh(merchant))  │
│     inventoryRefreshService.RefreshInventory(merchant)│
└───────────────────────────────────────────────────────┘
        │
        ▼
┌───────────────────────────────────────────────────────┐
│ Build ShopViewDto                                     │
│                                                       │
│ - Get merchant inventory with prices                  │
│ - Calculate item comparisons                          │
│ - Get player's sellable items                         │
│ - Include player gold and modifiers                   │
└───────────────────────────────────────────────────────┘
        │
        ▼
┌───────────────────────────────────────────────────────┐
│ ShopView.Render(shopViewDto)                          │
│ - Display shop header                                 │
│ - Show player gold and discounts                      │
│ - List items for sale with comparisons                │
│ - List sellable items                                 │
│ - Show command help                                   │
└───────────────────────────────────────────────────────┘
        │
        ▼
┌───────────────────────────────────────────────────────┐
│                 SHOP INPUT LOOP                       │
└───────────────────────────────────────────────────────┘
```

### 8.2 Shop Interface Layout

```
┌─────────────────────────────────────────────────────────────┐
│                    GRIMBOLD'S TRADING POST                  │
│                        General Store                        │
├─────────────────────────────────────────────────────────────┤
│  Your Gold: 127            Reputation: Friendly (+5% off)  │
│  Haggle Discount: 10%      Time to restock: 4h 32m         │
├─────────────────────────────────────────────────────────────┤
│  FOR SALE                           PRICE    STOCK   COMP  │
│  ─────────────────────────────────────────────────────────  │
│  [1] Iron Sword                     45g      3       ▲+2   │
│      +5 Attack, 1d8 damage                                  │
│  [2] Leather Armor                  32g      2       ▲+3   │
│      +3 Defense                                             │
│  [3] Health Potion                  14g      10      ──    │
│      Restores 25 HP                                         │
│  [4] Torch                          5g       ∞       ──    │
│      Light source, 1 hour                                   │
│  [5] Rope (50ft)                    8g       5       ──    │
│                                                             │
├─────────────────────────────────────────────────────────────┤
│  YOUR ITEMS (Sellable)              VALUE                  │
│  ─────────────────────────────────────────────────────────  │
│  [a] Rusty Dagger                   3g                     │
│  [b] Goblin Ear x5                  10g (2g each)          │
│  [c] Minor Health Potion            5g                     │
│                                                             │
├─────────────────────────────────────────────────────────────┤
│  Commands:                                                  │
│  [#] Buy item     [letter] Sell item     [h] Haggle        │
│  [c #] Compare    [a #] Appraise         [i] Inventory     │
│  [q] Quit shop                                              │
└─────────────────────────────────────────────────────────────┘
```

### 8.3 Appraise Command Flow

```
Player Input: "appraise rusty dagger" (or "a 1" in shop)
        │
        ▼
┌───────────────────────────────────────────────────────┐
│ GameSessionService.AppraiseItem("rusty dagger")       │
│ - Find item in player inventory or shop               │
│ - Find merchant in room                               │
└───────────────────────────────────────────────────────┘
        │
        ▼
┌───────────────────────────────────────────────────────┐
│ ShopService.AppraiseItem(item, merchant, player)      │
│ - Calculate base value                                │
│ - Apply condition modifier                            │
│ - Calculate merchant offer                            │
│ - Apply haggle bonuses                                │
│ - Build comparison if equipment                       │
└───────────────────────────────────────────────────────┘
        │
        ▼
┌───────────────────────────────────────────────────────┐
│ Render Appraisal Output:                              │
│                                                       │
│ === ITEM APPRAISAL ===                                │
│                                                       │
│ Rusty Dagger                                          │
│ Type: Weapon (Dagger)                                 │
│ Condition: Poor                                       │
│                                                       │
│ Base Value: 5 gold                                    │
│ Condition Modifier: -40%                              │
│ ─────────────────────                                 │
│ Estimated Value: 3 gold                               │
│                                                       │
│ Grimbold would pay: 3 gold                            │
│ (Includes your 10% haggle bonus)                      │
│                                                       │
│ vs. Equipped: Iron Dagger                             │
│   Attack: +2 vs +4  (▼-2)                             │
│   Damage: 1d4 vs 1d4 (──)                             │
│                                                       │
└───────────────────────────────────────────────────────┘
```

---

## 9. User-Facing Changes

### 9.1 New Commands

| Command | Description | Example |
|---------|-------------|---------|
| `shop` | Open shop interface with merchant in room | `shop` |
| `shop <name>` | Open specific merchant's shop | `shop grimbold` |
| `appraise <item>` | See detailed value breakdown | `appraise "Rusty Dagger"` |

### 9.2 Shop Interface Commands

| Key | Action | Notes |
|-----|--------|-------|
| `1-9` | Buy item at index | Uses number shown in shop |
| `a-z` | Sell item at index | Uses letter shown in shop |
| `h` | Attempt to haggle | If not already haggled |
| `c <#>` | Compare shop item to equipped | Shows stat differences |
| `a <#>` | Appraise shop item | Shows value breakdown |
| `i` | View full inventory | Lists all player items |
| `q` | Quit shop interface | Returns to normal mode |

### 9.3 Command Output Examples

**Opening Shop:**
```
> shop
Opening shop with Grimbold...

┌─────────────────────────────────────────────────────────────┐
│                    GRIMBOLD'S TRADING POST                  │
│                        General Store                        │
...
```

**Buying Item:**
```
> 1
You purchase the Iron Sword for 45 gold.

[Gold: 127 → 82]
[Iron Sword added to inventory]

FOR SALE                           PRICE    STOCK   COMP
─────────────────────────────────────────────────────────
[1] Iron Sword                     45g      2       ▲+2
                                            ↑ decreased
```

**Selling Item:**
```
> a
Grimbold examines the Rusty Dagger.
"I'll give you 3 gold for it."

You sell the Rusty Dagger for 3 gold.

[Gold: 82 → 85]
[Rusty Dagger removed from inventory]
```

**Comparing Items:**
```
> c 1
=== ITEM COMPARISON ===

Iron Sword vs. Your: Rusty Dagger

                    Iron Sword    Rusty Dagger    Diff
Attack Bonus:       +5            +2              ▲ +3
Damage:             1d8           1d4             ▲ better
Weight:             3 lbs         1 lb            ▼ heavier

VERDICT: Significant Upgrade
Price: 45 gold (with your discounts)
```

**Appraising Item:**
```
> appraise "Health Potion"
=== ITEM APPRAISAL ===

Health Potion
Type: Consumable (Potion)
Condition: Good

Base Value: 15 gold

Current Modifiers:
  Base Price .............. 15 gold
  Charisma (-8%) .......... 14 gold
  Friendly Rep (-5%) ...... 14 gold
  Haggle Bonus (+10%) ..... 14 gold
  ─────────────────────────────────
  Your Buy Price: 14 gold

Sell Value:
  Grimbold would pay: 8 gold
```

**No Merchant:**
```
> shop
There's no merchant here to trade with.
```

**Merchant Closed:**
```
> shop grimbold
Grimbold's shop is closed right now.
The shop opens again in 2 hours.
```

---

## 10. Logging Requirements

### 10.1 Log Events

| Event | Level | Format |
|-------|-------|--------|
| Shop opened | Information | `OpenShop: Player {PlayerId} opened shop with {MerchantName}` |
| Inventory refresh triggered | Information | `RefreshInventory: Refreshing stock for {MerchantName} ({MerchantType})` |
| Inventory generated | Information | `RefreshInventory: Generated {ItemCount} items for {MerchantName}` |
| Item comparison | Debug | `GetItemComparison: {ShopItem} vs {EquippedItem}: {IsUpgrade}` |
| Appraise item | Debug | `AppraiseItem: {ItemName} base {BaseValue}, offer {MerchantOffer}` |
| Stock generation | Debug | `GenerateStock: Generating {Count} items for {Type} (level {Level})` |
| Rarity rolled | Debug | `RollForRarity: Rolled {Rarity} from weights` |
| Shop command | Debug | `HandleShopInput: Player input '{Input}'` |

### 10.2 Structured Logging Fields

```csharp
// Shop opened log
_logger.LogInformation(
    "OpenShop: Player {PlayerId} opened shop with {MerchantName} ({MerchantType})",
    player.Id,           // Guid
    merchant.Name,       // string
    merchant.MerchantType // MerchantType
);

// Inventory refresh log
_logger.LogInformation(
    "RefreshInventory: Generated {ItemCount} items for {MerchantName}",
    inventory.UniqueItemCount, // int
    merchant.Name              // string
);

// Item comparison log
_logger.LogDebug(
    "GetItemComparison: {ShopItem} vs {EquippedItem}: IsUpgrade={IsUpgrade}, Diff={Diff}",
    shopItem.Name,             // string
    equippedItem?.Name ?? "none", // string
    comparison.IsUpgrade,      // bool
    comparison.TotalDifference // int
);

// Appraisal log
_logger.LogDebug(
    "AppraiseItem: {ItemName} base={BaseValue}, offer={MerchantOffer}, modifiers={ModifierCount}",
    item.Name,                         // string
    appraisal.BaseValue,               // int
    appraisal.MerchantOffer,           // int
    appraisal.ModifierBreakdown.Count  // int
);
```

---

## 11. Unit Test Specifications

### 11.1 MerchantType Tests (~4 tests)

```csharp
namespace RuneAndRust.Tests.Domain.Enums;

[TestFixture]
public class MerchantTypeTests
{
    [Test]
    public void MerchantType_ContainsAllExpectedValues()
    {
        // Assert: All 8 types exist
        Assert.That(Enum.GetValues<MerchantType>(), Has.Length.EqualTo(8));
    }

    [Test]
    [TestCase(MerchantType.GeneralStore)]
    [TestCase(MerchantType.Weaponsmith)]
    [TestCase(MerchantType.Armorer)]
    [TestCase(MerchantType.Alchemist)]
    public void MerchantType_CanBeConvertedToString(MerchantType type)
    {
        // Act: Convert to string
        // Assert: Not null or empty
    }

    [Test]
    public void MerchantType_DefaultIsGeneralStore()
    {
        // Arrange: Create merchant without type
        // Assert: Default type is GeneralStore
    }

    [Test]
    public void MerchantType_CanBeParsedFromString()
    {
        // Arrange: String "Weaponsmith"
        // Act: Parse to MerchantType
        // Assert: Returns MerchantType.Weaponsmith
    }
}
```

### 11.2 ItemComparison Tests (~6 tests)

```csharp
namespace RuneAndRust.Tests.Domain.ValueObjects;

[TestFixture]
public class ItemComparisonTests
{
    [Test]
    public void Create_WithNoEquippedItem_ReturnsUpgrade()
    {
        // Arrange: Shop item, null equipped
        // Act: Call Create()
        // Assert: IsUpgrade is true, EquippedItem is null
    }

    [Test]
    public void Create_WithBetterShopItem_ReturnsUpgrade()
    {
        // Arrange: Shop item with higher stats
        // Act: Call Create()
        // Assert: IsUpgrade is true, StatDifferences positive
    }

    [Test]
    public void Create_WithWorseShopItem_ReturnsDowngrade()
    {
        // Arrange: Shop item with lower stats
        // Act: Call Create()
        // Assert: IsDowngrade is true, StatDifferences negative
    }

    [Test]
    public void Create_WithEqualStats_ReturnsEquivalent()
    {
        // Arrange: Items with same stats
        // Act: Call Create()
        // Assert: IsEquivalent is true
    }

    [Test]
    public void GetComparisonIndicator_ForUpgrade_ReturnsArrowUp()
    {
        // Arrange: Upgrade comparison with +3 difference
        // Act: Call GetComparisonIndicator()
        // Assert: Returns "▲+3"
    }

    [Test]
    public void GetComparisonIndicator_ForNoEquipped_ReturnsNEW()
    {
        // Arrange: Comparison with null equipped
        // Act: Call GetComparisonIndicator()
        // Assert: Returns "NEW"
    }
}
```

### 11.3 InventoryRefreshService Tests (~8 tests)

```csharp
namespace RuneAndRust.Tests.Application.Services;

[TestFixture]
public class InventoryRefreshServiceTests
{
    [Test]
    public void ShouldRefresh_WhenNeverRefreshed_ReturnsTrue()
    {
        // Arrange: Merchant with null LastStockRefresh
        // Act: Call ShouldRefresh()
        // Assert: Returns true
    }

    [Test]
    public void ShouldRefresh_WhenRefreshTimeNotPassed_ReturnsFalse()
    {
        // Arrange: Merchant refreshed 1 hour ago, refresh interval 24 hours
        // Act: Call ShouldRefresh()
        // Assert: Returns false
    }

    [Test]
    public void ShouldRefresh_WhenRefreshTimePassed_ReturnsTrue()
    {
        // Arrange: Merchant refreshed 25 hours ago, refresh interval 24 hours
        // Act: Call ShouldRefresh()
        // Assert: Returns true
    }

    [Test]
    public void RefreshInventory_UpdatesLastRefreshTime()
    {
        // Arrange: Merchant
        // Act: Call RefreshInventory()
        // Assert: LastStockRefresh is updated
    }

    [Test]
    public void GenerateStock_RespectsMinMaxStock()
    {
        // Arrange: Type with min 5, max 10
        // Act: Call GenerateStock()
        // Assert: Item count between 5 and 10
    }

    [Test]
    public void GenerateStock_RespectsRarityWeights()
    {
        // Arrange: Type with 90% common
        // Act: Generate many items
        // Assert: Most items are common
    }

    [Test]
    public void GenerateStock_RespectsStockCategories()
    {
        // Arrange: Weaponsmith type
        // Act: Call GenerateStock()
        // Assert: All items are weapons or weapon accessories
    }

    [Test]
    public void GenerateStock_RespectsExcludeCategories()
    {
        // Arrange: Type with "legendary" excluded
        // Act: Call GenerateStock()
        // Assert: No legendary items
    }
}
```

### 11.4 ShopService Comparison Tests (~4 tests)

```csharp
namespace RuneAndRust.Tests.Application.Services;

[TestFixture]
public class ShopServiceComparisonTests
{
    [Test]
    public void GetItemComparison_ReturnsValidComparison()
    {
        // Arrange: Shop item and player with equipped item
        // Act: Call GetItemComparison()
        // Assert: Returns ItemComparison with correct values
    }

    [Test]
    public void GetAllComparisons_ReturnsComparisonForEachItem()
    {
        // Arrange: Merchant with 5 items
        // Act: Call GetAllComparisons()
        // Assert: Returns 5 comparisons
    }

    [Test]
    public void GetSellableItems_ExcludesQuestItems()
    {
        // Arrange: Player with quest item
        // Act: Call GetSellableItems()
        // Assert: Quest item not included
    }

    [Test]
    public void GetSellableItems_IncludesPrices()
    {
        // Arrange: Player with items, merchant
        // Act: Call GetSellableItems()
        // Assert: Each item has SellPrice > 0
    }
}
```

### 11.5 Merchant Entity Update Tests (~3 tests)

```csharp
namespace RuneAndRust.Tests.Domain.Entities;

[TestFixture]
public class MerchantTypeTests
{
    [Test]
    public void ShouldRefreshStock_WhenNeverRefreshed_ReturnsTrue()
    {
        // Arrange: Merchant with null LastStockRefresh
        // Act: Call ShouldRefreshStock()
        // Assert: Returns true
    }

    [Test]
    public void RefreshStock_UpdatesInventoryAndTimestamp()
    {
        // Arrange: Merchant, new inventory
        // Act: Call RefreshStock()
        // Assert: Inventory updated, LastStockRefresh set
    }

    [Test]
    public void GetTimeUntilRefresh_ReturnsCorrectTime()
    {
        // Arrange: Merchant refreshed 12 hours ago, 24 hour refresh
        // Act: Call GetTimeUntilRefresh()
        // Assert: Returns approximately 12 hours
    }
}
```

---

## 12. Use Cases

### UC-2.2c-1: Player Opens Shop Interface

**Primary Actor:** Player
**Preconditions:** Player is in room with open merchant
**Postconditions:** Shop interface displayed, inventory may be refreshed

**Main Flow:**
1. Player enters `shop` command
2. System finds merchant in current room
3. System checks if inventory refresh needed
4. If refresh needed, system generates new stock
5. System builds shop view with items and comparisons
6. System displays shop interface
7. Player can browse, buy, sell, or quit

**Alternative Flows:**
- 2a. No merchant in room → Display error message
- 2b. Multiple merchants → Use first or ask player
- 3a. Merchant is closed → Display closed message

### UC-2.2c-2: Player Compares Item

**Primary Actor:** Player
**Preconditions:** Player is in shop interface
**Postconditions:** Detailed comparison displayed

**Main Flow:**
1. Player enters `c <#>` in shop interface
2. System retrieves shop item at index
3. System finds player's equipped item in same slot
4. System calculates stat differences
5. System displays comparison with upgrade/downgrade verdict

**Alternative Flows:**
- 2a. Invalid index → Display error
- 3a. No equipped item → Show as "NEW" item

### UC-2.2c-3: Player Appraises Item

**Primary Actor:** Player
**Preconditions:** Player near merchant, has item in inventory
**Postconditions:** Detailed appraisal displayed

**Main Flow:**
1. Player enters `appraise <item>` command
2. System finds item in player inventory
3. System calculates base value
4. System applies all modifiers (condition, charisma, rep, haggle)
5. System calculates merchant's offer
6. System displays breakdown

**Alternative Flows:**
- 2a. Item not in inventory → Check shop items
- 2b. Item not found → Display error
- 3a. No merchant nearby → Show base value only

### UC-2.2c-4: Specialty Merchant Stock Generation

**Primary Actor:** System (automatic)
**Preconditions:** Merchant needs stock refresh
**Postconditions:** New inventory generated based on type

**Main Flow:**
1. System detects refresh needed
2. System loads merchant type definition
3. System determines stock count (between min and max)
4. For each stock slot:
   - System rolls for rarity
   - System filters items by categories
   - System excludes forbidden categories
   - System selects random item
   - System generates quantity
5. System creates new ShopInventory
6. System updates merchant with new stock

---

## 13. Acceptance Criteria

### AC-2.2c-1: MerchantType Enum
- [ ] MerchantType enum includes all 8 specialty types
- [ ] GeneralStore, Weaponsmith, Armorer, Alchemist defined
- [ ] Enchanter, Jeweler, Provisioner, CurioDealer defined
- [ ] Merchant entity has MerchantType property
- [ ] Default type is GeneralStore

### AC-2.2c-2: Item Comparison
- [ ] ItemComparison calculates stat differences
- [ ] IsUpgrade true when shop item is better
- [ ] IsDowngrade true when shop item is worse
- [ ] GetComparisonIndicator returns visual indicators
- [ ] Comparison handles null equipped item

### AC-2.2c-3: Shop TUI Interface
- [ ] `shop` command opens interactive interface
- [ ] Shop header shows merchant name and type
- [ ] Player gold and discounts displayed
- [ ] Items listed with prices and comparison indicators
- [ ] Sellable items listed with values
- [ ] Command help shown at bottom

### AC-2.2c-4: Shop Interface Commands
- [ ] Number keys (1-9) buy corresponding item
- [ ] Letter keys (a-z) sell corresponding item
- [ ] `h` initiates haggle
- [ ] `c <#>` shows detailed comparison
- [ ] `q` exits shop interface
- [ ] Interface updates after transactions

### AC-2.2c-5: Appraise Command
- [ ] `appraise <item>` shows value breakdown
- [ ] Base value and modifiers displayed
- [ ] Merchant offer calculated correctly
- [ ] Haggle bonus reflected in offer
- [ ] Comparison shown for equipment

### AC-2.2c-6: Inventory Refresh
- [ ] ShouldRefresh returns true after configured hours
- [ ] RefreshInventory generates new stock
- [ ] Stock count between min and max
- [ ] Items match merchant type categories
- [ ] Excluded categories not included
- [ ] Rarity distribution follows weights

### AC-2.2c-7: Specialty Merchants
- [ ] Each type has unique stock categories
- [ ] Specialty merchants get appropriate items
- [ ] Price modifiers apply correctly
- [ ] Refresh intervals vary by type
- [ ] Merchant level affects rarity availability

### AC-2.2c-8: Tests
- [ ] ~25 unit tests implemented and passing
- [ ] ItemComparison tests cover all scenarios
- [ ] InventoryRefreshService tests pass
- [ ] ShopService comparison tests pass
- [ ] Merchant entity update tests pass

---

## 14. Deliverable Checklist

### Domain Layer
- [ ] `MerchantType.cs` - Merchant type enum
- [ ] `ItemComparison.cs` - Item comparison value object
- [ ] `ItemAppraisal.cs` - Item appraisal value object
- [ ] `MerchantTypeDefinition.cs` - Merchant type configuration
- [ ] Update `Merchant.cs` - Add MerchantType, refresh tracking

### Application Layer
- [ ] `IInventoryRefreshService.cs` - Inventory refresh interface
- [ ] `InventoryRefreshService.cs` - Inventory refresh implementation
- [ ] Update `IShopService.cs` - Add comparison/appraise methods
- [ ] Update `ShopService.cs` - Implement comparison/appraise/sellables
- [ ] Update `GameSessionService.cs` - Add shop UI methods
- [ ] `SellableItem.cs` - DTO for sellable items

### Infrastructure Layer
- [ ] Update `IConfigurationProvider.cs` - Add merchant type loading
- [ ] Update `ConfigurationProvider.cs` - Implement merchant type loading

### Presentation Layer
- [ ] `ShopView.cs` - Shop TUI component
- [ ] `ShopHandler.cs` - Shop and appraise command handlers
- [ ] Update `InputHandler.cs` - Parse shop commands
- [ ] Update renderer for shop display

### Configuration
- [ ] `config/merchant-types.json` - Merchant type definitions
- [ ] `config/schemas/merchant-types.schema.json` - JSON schema

### Tests
- [ ] `MerchantTypeTests.cs` - Enum tests (~4)
- [ ] `ItemComparisonTests.cs` - Comparison tests (~6)
- [ ] `InventoryRefreshServiceTests.cs` - Refresh tests (~8)
- [ ] `ShopServiceComparisonTests.cs` - Service tests (~4)
- [ ] `MerchantEntityUpdateTests.cs` - Entity tests (~3)

---

## 15. Dependencies

### Internal Dependencies (from v0.2.2b)

| Dependency | Location | Usage |
|------------|----------|-------|
| Merchant entity | `Domain/Entities/Merchant.cs` | Extends with type and refresh |
| ShopService | `Application/Services/ShopService.cs` | Adds comparison methods |
| PriceModifier | `Domain/ValueObjects/PriceModifier.cs` | Used in appraisal |
| HaggleService | `Application/Services/HaggleService.cs` | Haggle from shop UI |
| Player.Charisma | `Domain/Entities/Player.cs` | For price display |
| Player.HaggleDiscount | `Domain/Entities/Player.cs` | For appraisal |

### Internal Dependencies (from v0.2.2a)

| Dependency | Location | Usage |
|------------|----------|-------|
| ShopInventory | `Domain/ValueObjects/ShopInventory.cs` | Stock management |
| ShopItem | `Domain/ValueObjects/ShopItem.cs` | Inventory entries |
| TransactionResult | `Domain/ValueObjects/TransactionResult.cs` | Buy/sell results |
| IShopService | `Application/Interfaces/IShopService.cs` | Shop operations |

### Internal Dependencies (from earlier versions)

| Dependency | Location | Usage |
|------------|----------|-------|
| Item entity | `Domain/Entities/Item.cs` | Stock items |
| Player entity | `Domain/Entities/Player.cs` | Gold, inventory |
| IGameRenderer | `Presentation/Interfaces/IGameRenderer.cs` | TUI rendering |
| IConfigurationProvider | `Infrastructure/Interfaces/IConfigurationProvider.cs` | Config loading |
| IItemService | `Application/Interfaces/IItemService.cs` | Item lookup |

### External Dependencies

| Package | Version | Purpose |
|---------|---------|---------|
| Microsoft.Extensions.Logging | 8.0.0+ | Logging |
| System.Text.Json | 8.0.0+ | Configuration loading |

---

## 16. Future Considerations

### v0.3.0: Quest System Integration
- Quest merchants with special dialogue
- Quest items unavailable for purchase
- Reputation rewards from quest completion

### v0.4.0: Character Advancement
- Merchant level progression based on player level
- Unlockable merchant types in different regions
- Specialty discounts from skill points

### v0.11.0: Crafting Integration
- Specialty merchants for crafting materials
- Sell crafted items at premium
- Crafting recipes for sale

### Deferred Features (Not in v0.2.2c Scope)
- **GUI shop interface**: Graphical shopping (future version)
- **Merchant restocking from sources**: Merchants buy from caravans
- **Player-owned shops**: Players become merchants
- **Auction house**: Multi-player trading
- **Item condition system**: Wear affects value
- **Bulk buy/sell**: Purchase multiples at once

---

*This design specification provides the complete Shop UI & Specialty Merchants system (v0.2.2c). It builds upon the Shop Foundation (v0.2.2a) and Dynamic Pricing & Haggling (v0.2.2b) by adding an interactive TUI shop interface, specialty merchant types with themed inventories, and automatic inventory refresh mechanics.*
