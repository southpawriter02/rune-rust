# Changelog: v0.2.2 - The Adversary: Complete Enemy System (Data, AI, and Traits)

**Versions:** v0.2.2a through v0.2.2c
**Release Dates:** 2025-12-20
**Total Test Count:** 1436 tests (+93 from v0.2.1c)
**Build Status:** SUCCESS

## Table of Contents

- [Overview](#overview)
- [Part A: The Bestiary (Data & Definitions)](#part-a-the-bestiary-data--definitions)
  - [Summary](#summary)
  - [Files Created](#files-created)
  - [Files Modified](#files-modified)
  - [Code Implementation Details](#code-implementation-details)
  - [Bestiary Seed Data](#bestiary-seed-data)
  - [Logging Matrix](#logging-matrix)
  - [Test Coverage](#test-coverage)
  - [DI Registration](#di-registration)
  - [Directory Structure Changes](#directory-structure-changes)
  - [Build Verification](#build-verification)
  - [Upgrade Notes](#upgrade-notes)
  - [Related Releases](#related-releases)
- [Part B: The Mind (AI Behaviors)](#part-b-the-mind-ai-behaviors)
  - [Summary](#summary-1)
  - [New Features](#new-features)
  - [New Files](#new-files)
  - [Modified Files](#modified-files)
  - [API Changes](#api-changes)
  - [Test Coverage](#test-coverage-1)
  - [Logging Matrix](#logging-matrix-1)
  - [Architecture](#architecture)
  - [Known Limitations](#known-limitations)
  - [Migration Notes](#migration-notes)
  - [Next Steps (v0.2.2c)](#next-steps-v022c)
  - [Contributors](#contributors)
- [Part C: The Elite (Traits & Affixes)](#part-c-the-elite-traits--affixes)
  - [Summary](#summary-2)
  - [New Features](#new-features-1)
  - [New Files](#new-files-1)
  - [Modified Files](#modified-files-1)
  - [API Changes](#api-changes-1)
  - [Test Coverage](#test-coverage-2)
  - [Logging Matrix](#logging-matrix-2)
  - [Architecture](#architecture-1)
  - [Known Limitations](#known-limitations-1)
  - [Migration Notes](#migration-notes-1)
  - [Next Steps (v0.2.3+)](#next-steps-v023)
  - [Contributors](#contributors-1)

---

## Overview

The v0.2.2 release trilogy establishes a complete, data-driven enemy system for Rune & Rust, transforming enemies from hardcoded stat-blocks into dynamic adversaries with archetype-based AI behaviors and procedural trait enhancements. This three-part release implements:

1. **v0.2.2a (The Bestiary)**: EnemyTemplate system, EnemyFactory with scaling logic, and 5 canonical enemy species
2. **v0.2.2b (The Mind)**: EnemyAIService with archetype-based decision matrices and tactical behaviors
3. **v0.2.2c (The Elite)**: CreatureTraitService for procedurally enhancing Elite+ enemies with reactive combat traits

Together, these releases create a combat ecosystem where enemies exhibit species-specific behaviors, make tactical decisions based on HP/stamina resources, and gain unique abilities through elite traits. The system uses the Prototype pattern for templates, factory-based instantiation with level scaling, and service-based AI/trait processing integrated into the combat loop.

**Key Architectural Achievements:**
- Factory pattern for enemy creation with +/- 5% stat variance
- Archetype-based AI with 7 distinct behavioral profiles
- Procedural trait system with 8 trait types across 4 trigger points
- Full integration with existing combat, status effect, and loot systems
- 93 new unit tests ensuring system reliability

---

## Part A: The Bestiary (Data & Definitions)

**Release Date:** 2025-12-20
**Codename:** The Bestiary
**Test Coverage:** 1386 tests passing (+43 from v0.2.1c)
**Build Status:** SUCCESS

---

## Summary

This release establishes the data foundation for the Adversary system by implementing EnemyTemplate records, the EnemyFactory for instantiating scalable enemies, and seeding the initial roster of canonical Aethelgardian threats. This transitions from hardcoded "Training Dummies" to a data-driven factory system using the Prototype pattern.

### Key Features
- **EnemyTemplate System**: Immutable blueprints defining base stats for enemy species
- **EnemyFactory**: Factory for creating scaled Enemy entities with +/- 5% variance
- **ThreatTier Enum**: Minion (0.6x), Standard (1.0x), Elite (1.5x), Boss (2.5x fixed)
- **EnemyArchetype Enum**: Tank, DPS, GlassCannon, Support, Swarm, Caster, Boss (for AI in v0.2.2b)
- **Tags System**: List<string> for status effect interactions (e.g., "Mechanical" = Bleed immune)
- **5 Seed Templates**: Rusted Draugr, Haugbui Laborer, Utility Servitor, Ash-Vargr, Rust-Clan Scav

### Architectural Overview

```
┌─────────────────────┐     ┌──────────────────────┐     ┌─────────────────────┐
│  EncounterService   │────▶│    EnemyFactory      │────▶│      Enemy          │
│  (Request enemy)    │     │  (Create from temp)  │     │   (Live entity)     │
└─────────────────────┘     └──────────────────────┘     └─────────────────────┘
                                     │
                                     ▼
                            ┌──────────────────────┐
                            │   EnemyTemplate      │
                            │  (Static blueprint)  │
                            └──────────────────────┘
```

---

## Files Created

| File Path | Description |
|-----------|-------------|
| `RuneAndRust.Core/Enums/ThreatTier.cs` | Threat classification enum for scaling (Minion, Standard, Elite, Boss) |
| `RuneAndRust.Core/Enums/EnemyArchetype.cs` | Combat role archetype enum for AI behavior (Tank, DPS, GlassCannon, etc.) |
| `RuneAndRust.Core/Models/Combat/EnemyTemplate.cs` | Immutable record defining enemy species blueprints |
| `RuneAndRust.Core/Interfaces/IEnemyFactory.cs` | Interface for enemy creation from templates |
| `RuneAndRust.Engine/Factories/EnemyFactory.cs` | Factory implementation with 5 seeded templates |
| `RuneAndRust.Tests/Engine/EnemyFactoryTests.cs` | 43 unit tests for factory behavior |

---

## Files Modified

| File Path | Changes |
|-----------|---------|
| `RuneAndRust.Core/Entities/Enemy.cs` | Added `TemplateId`, `Archetype`, and `Tags` properties |
| `RuneAndRust.Core/Models/Combat/Combatant.cs` | Added `Archetype` and `Tags` properties; updated `FromEnemy()` |
| `RuneAndRust.Terminal/Program.cs` | Registered `IEnemyFactory` in DI container |

---

## Code Implementation Details

### ThreatTier Enum

```csharp
public enum ThreatTier
{
    Minion = 0,    // 0.6x stat multiplier
    Standard = 1,  // 1.0x stat multiplier (baseline)
    Elite = 2,     // 1.5x stat multiplier
    Boss = 3       // 2.5x fixed multiplier (no level scaling)
}
```

### EnemyArchetype Enum

```csharp
public enum EnemyArchetype
{
    Tank,        // High HP/Soak, Low Damage
    DPS,         // Balanced offense/defense
    GlassCannon, // High Damage, Low HP
    Support,     // Buffs/Debuffs
    Swarm,       // Low stats, group tactics
    Caster,      // Ranged/AoE attacks
    Boss         // Multi-phase encounters
}
```

### EnemyTemplate Record

```csharp
public record EnemyTemplate(
    string Id,                                      // e.g., "und_draugr_01"
    string Name,                                    // Display name
    string Description,                             // AAM-VOICE compliant flavor
    EnemyArchetype Archetype,                       // AI behavior key
    ThreatTier Tier,                                // Scaling category
    int BaseHp,
    int BaseStamina,
    int BaseSoak,
    Dictionary<CharacterAttribute, int> Attributes,
    int WeaponDamageDie,                            // d4, d6, d8, etc.
    string WeaponName,
    List<string> Tags,                              // "Mechanical", "Undying"
    string? LootTableId = null                      // Links to loot system
);
```

### IEnemyFactory Interface

```csharp
public interface IEnemyFactory
{
    Enemy CreateFromTemplate(EnemyTemplate template, int partyLevel = 1);
    Enemy CreateById(string templateId, int partyLevel = 1);
    IReadOnlyList<string> GetTemplateIds();
    EnemyTemplate? GetTemplate(string templateId);
}
```

### EnemyFactory Scaling Logic

```csharp
private static float CalculateScaler(ThreatTier tier, int partyLevel)
{
    // Base scaling: 10% increase per level above 1
    var levelScale = 1.0f + ((partyLevel - 1) * 0.1f);

    return tier switch
    {
        ThreatTier.Minion => 0.6f * levelScale,    // Weak fodder
        ThreatTier.Standard => 1.0f * levelScale,  // Normal enemies
        ThreatTier.Elite => 1.5f * levelScale,     // Enhanced threats
        ThreatTier.Boss => 2.5f,                    // Fixed high (no level scaling)
        _ => 1.0f * levelScale
    };
}
```

### Enemy Entity Updates

```csharp
#region Template and AI Properties

/// <summary>
/// The template ID this enemy was created from.
/// </summary>
public string? TemplateId { get; set; }

/// <summary>
/// Combat archetype for AI behavior selection in v0.2.2b.
/// </summary>
public EnemyArchetype Archetype { get; set; } = EnemyArchetype.DPS;

/// <summary>
/// Tags for status effect interactions and special handling.
/// Examples: "Mechanical" = Bleed immune, "Undying" = Poison immune.
/// </summary>
public List<string> Tags { get; set; } = new();

#endregion
```

### Combatant.FromEnemy() Update

```csharp
public static Combatant FromEnemy(Enemy e) => new()
{
    Name = e.Name,
    IsPlayer = false,
    EnemySource = e,
    CurrentHp = e.CurrentHp,
    MaxHp = e.MaxHp,
    CurrentStamina = e.CurrentStamina,
    MaxStamina = e.MaxStamina,
    // Enemy equipment stats
    WeaponDamageDie = e.WeaponDamageDie,
    WeaponAccuracyBonus = e.WeaponAccuracyBonus,
    ArmorSoak = e.ArmorSoak,
    WeaponName = e.WeaponName,
    // Template/AI properties (v0.2.2a)
    Archetype = e.Archetype,
    Tags = new List<string>(e.Tags)
};
```

---

## Bestiary Seed Data

| ID | Name | Archetype | Tier | Base HP | Tags | Description |
|---|---|---|---|---|---|---|
| `und_draugr_01` | Rusted Draugr | DPS | Standard | 60 | Undying, IronHeart, Construct | Corroded security automaton |
| `und_haug_01` | Haugbui Laborer | Tank | Standard | 90 | Undying, IronHeart, Construct | Towering construction unit |
| `mec_serv_01` | Utility Servitor | Swarm | Minion | 25 | Mechanical, Construct | Janitorial drone |
| `bst_vargr_01` | Ash-Vargr | GlassCannon | Standard | 45 | Beast, Blighted | Corrupted predator |
| `hum_raider_01` | Rust-Clan Scav | Support | Standard | 50 | Humanoid | Desperate scavenger |

---

## Logging Matrix

| Event | Level | Template |
|-------|-------|----------|
| Factory initialized | Information | `"EnemyFactory initialized with {Count} templates"` |
| Enemy creation start | Information | `"Creating enemy from template: {Id} (Tier: {Tier}, PartyLevel: {Level})"` |
| Scaling calculation | Debug | `"Scaling: Base HP {Base} x Scaler {Scaler:F2} x Variance {Variance:F2} = {Final}"` |
| Enemy created | Trace | `"Created {Name}: HP={Hp}, Stamina={Stam}, Archetype={Archetype}, Tags=[{Tags}]"` |
| Template not found | Warning | `"Template not found: {Id}, using fallback template {Fallback}"` |

---

## Test Coverage

### EnemyFactoryTests.cs (43 tests)

#### CreateFromTemplate Tests
- `CreateFromTemplate_ReturnsValidEnemy`
- `CreateFromTemplate_CopiesTemplateId`
- `CreateFromTemplate_CopiesArchetype`
- `CreateFromTemplate_CopiesTags`
- `CreateFromTemplate_TagsAreIndependentCopy`
- `CreateFromTemplate_CopiesAllAttributes`
- `CreateFromTemplate_CopiesWeaponStats`
- `CreateFromTemplate_CopiesArmorSoak`

#### Variance Tests
- `CreateFromTemplate_AppliesVariance_MinRoll`
- `CreateFromTemplate_AppliesVariance_MaxRoll`
- `CreateFromTemplate_AppliesVariance_MiddleRoll`
- `CreateFromTemplate_CurrentHpEqualsMaxHp`
- `CreateFromTemplate_CurrentStaminaEqualsMaxStamina`

#### Tier Scaling Tests
- `CreateFromTemplate_MinionTier_ReducesStats`
- `CreateFromTemplate_StandardTier_NormalStats`
- `CreateFromTemplate_EliteTier_IncreasesStats`
- `CreateFromTemplate_BossTier_FixedHighStats`

#### Party Level Scaling Tests
- `CreateFromTemplate_PartyLevel1_NoScaling`
- `CreateFromTemplate_PartyLevel5_ScalesUp`
- `CreateFromTemplate_BossTier_IgnoresPartyLevelScaling`

#### CreateById Tests
- `CreateById_ValidId_ReturnsEnemy`
- `CreateById_InvalidId_ReturnsFallback`
- `CreateById_WithPartyLevel_ScalesCorrectly`

#### Template Registry Tests
- `GetTemplateIds_ReturnsAllTemplates`
- `GetTemplate_ValidId_ReturnsTemplate`
- `GetTemplate_InvalidId_ReturnsNull`

#### Built-in Template Validation Tests
- `BuiltInTemplate_RustedDraugr_HasCorrectStats`
- `BuiltInTemplate_HaugbuiLaborer_HasCorrectStats`
- `BuiltInTemplate_UtilityServitor_IsMinion`
- `BuiltInTemplate_AshVargr_IsGlassCannon`
- `BuiltInTemplate_RustClanScav_IsSupport`
- `BuiltInTemplates_AllHaveRequiredAttributes` (Theory with 5 cases)
- `BuiltInTemplates_AllCreateValidEnemies` (Theory with 5 cases)

#### Edge Case Tests
- `CreateFromTemplate_MinimumHpIsOne`
- `CreateFromTemplate_EachCallCreatesUniqueEnemy`

---

## DI Registration

```csharp
// Register Enemy Factory
services.AddScoped<IEnemyFactory, EnemyFactory>();
```

---

## Directory Structure Changes

```
RuneAndRust.Core/Enums/
├── ThreatTier.cs                   [NEW]
├── EnemyArchetype.cs               [NEW]
├── DangerLevel.cs
└── ...

RuneAndRust.Core/Models/Combat/
├── EnemyTemplate.cs                [NEW]
├── Combatant.cs                    [MODIFIED]
├── CombatResult.cs
└── ...

RuneAndRust.Core/Interfaces/
├── IEnemyFactory.cs                [NEW]
├── ICombatService.cs
└── ...

RuneAndRust.Core/Entities/
├── Enemy.cs                        [MODIFIED]
├── Character.cs
└── ...

RuneAndRust.Engine/Factories/
├── EnemyFactory.cs                 [NEW]
├── CharacterFactory.cs
└── ...

RuneAndRust.Tests/Engine/
├── EnemyFactoryTests.cs            [NEW - 43 tests]
├── CharacterFactoryTests.cs
└── ...
```

---

## Build Verification

```bash
$ dotnet build
Build succeeded.
63 Warning(s) - Pre-existing xUnit async warnings
0 Error(s)

$ dotnet test
Passed!  - Failed: 0, Passed: 1386, Skipped: 0, Total: 1386, Duration: 564 ms
```

---

## Upgrade Notes

1. **Enemy Entity**: New optional properties added. Existing code continues to work - defaults are DPS archetype and empty tags.

2. **Combatant Adapter**: `FromEnemy()` now copies Archetype and Tags. Combat systems can access these for future AI and status effect logic.

3. **DI Container**: `IEnemyFactory` is registered as scoped. Inject via constructor to create enemies from templates.

4. **Usage Example**:
   ```csharp
   // Inject IEnemyFactory
   var enemy = _enemyFactory.CreateById("und_draugr_01", partyLevel: 3);
   // Creates a Rusted Draugr scaled for level 3 party with +/- 5% HP variance
   ```

---

## Related Releases

- **v0.2.1a** (The Armory): Equipment and Loot systems
- **v0.2.1b** (The Affliction): Status Effect system
- **v0.2.1c** (The Visuals): Combat UI updates
- **v0.2.2a** (The Bestiary): Enemy templates and factory (this release)
- **v0.2.2b** (The Adversary's Mind): Enemy AI behaviors [PLANNED]
- **v0.2.2c** (The Elite Traits): Elite enemy enhancements [PLANNED]

---

**v0.2.2a Codename: The Bestiary**
*"From blueprints, darkness rises. The Undying await their awakening."*

---

## Part B: The Mind (AI Behaviors)

**Release Date:** 2025-12-20
**Milestone:** v0.2.2 – The Adversary (2 of 3)
**Test Count:** 1414 tests (28 new)

---

## Summary

This release implements the **EnemyAIService** to drive enemy turns using archetype-based decision logic. Enemies are no longer passive stat-blocks—they now make tactical decisions based on their Archetype, HP thresholds, and stamina resources.

---

## New Features

### Enemy AI System (EnemyAIService)

The core of v0.2.2b is a probability-based decision matrix that determines enemy actions:

| Archetype    | HP Trigger            | Default Behavior         | Heavy Attack Chance |
|--------------|----------------------|--------------------------|---------------------|
| DPS          | < 25% + Cowardly = Flee | Standard Attack          | 20% (roll >= 80)    |
| Tank         | < 40% = Defend       | 60% Attack / 40% Defend  | 0%                  |
| GlassCannon  | < 25% + Cowardly = Flee | Standard Attack          | 20% (roll >= 80)    |
| Swarm        | None                 | Light Attack (always)    | 0%                  |
| Support      | None                 | 70% Light / 30% Standard | 0%                  |
| Caster       | None                 | Standard Attack (ranged) | 0%                  |
| Boss         | None                 | 50% Heavy / 50% Standard | 50%                 |

### State Triggers

- **Cowardly Tag + Low HP (< 25%)**: Triggers flee action
- **Tank + Wounded (< 40% HP)**: Triggers defensive stance
- **Stamina Exhaustion**: Falls back to cheaper attacks or passes turn

### UX Pacing

- 750ms delay before enemy actions for readability
- AAM-VOICE compliant flavor text for all actions
- Combat log integration with Spectre markup formatting

---

## New Files

| File | Purpose |
|------|---------|
| `RuneAndRust.Core/Enums/ActionType.cs` | Enum for AI action types (Attack, Defend, Flee, Pass) |
| `RuneAndRust.Core/Models/Combat/CombatAction.cs` | Record representing an enemy's intended action |
| `RuneAndRust.Core/Interfaces/IEnemyAIService.cs` | Interface for enemy AI decision-making |
| `RuneAndRust.Engine/Services/EnemyAIService.cs` | Archetype-based AI implementation |
| `RuneAndRust.Tests/Engine/EnemyAIServiceTests.cs` | 28 unit tests for AI behaviors |

---

## Modified Files

| File | Changes |
|------|---------|
| `RuneAndRust.Core/Interfaces/ICombatService.cs` | Added `ExecuteEnemyAttack`, `ProcessDefend`, `ProcessFlee`, `ProcessEnemyTurnAsync` |
| `RuneAndRust.Core/Models/Combat/Combatant.cs` | Added `IsDefending` property for defensive stance tracking |
| `RuneAndRust.Engine/Services/CombatService.cs` | Added `IEnemyAIService` dependency, implemented enemy turn processing |
| `RuneAndRust.Terminal/Program.cs` | Registered `IEnemyAIService` in DI container |
| `RuneAndRust.Tests/Engine/CombatServiceTests.cs` | Added `IEnemyAIService` mock to test setup |

---

## API Changes

### ICombatService Interface

New methods added:

```csharp
string ExecuteEnemyAttack(Combatant attacker, Combatant target, AttackType attackType);
void ProcessDefend(Combatant combatant);
void ProcessFlee(Combatant combatant);
Task ProcessEnemyTurnAsync(Combatant enemy);
```

### CombatService Constructor (Breaking Change)

The constructor now requires `IEnemyAIService`:

```csharp
// Before
public CombatService(GameState, IInitiativeService, IAttackResolutionService,
                     ILootService, IStatusEffectService, ILogger)

// After
public CombatService(GameState, IInitiativeService, IAttackResolutionService,
                     ILootService, IStatusEffectService, IEnemyAIService, ILogger)
```

Existing tests updated to mock this new dependency.

---

## Test Coverage

### New Tests (28 total)

**Archetype Behavior Tests:**
- `DetermineAction_DPS_AttacksByDefault`
- `DetermineAction_DPS_HeavyAttackOnHighRoll`
- `DetermineAction_GlassCannon_BehavesLikeDPS`
- `DetermineAction_Tank_DefendsWhenWounded`
- `DetermineAction_Tank_AttacksWhenHealthy_LowRoll`
- `DetermineAction_Tank_DefendsWhenHealthy_HighRoll`
- `DetermineAction_Swarm_AlwaysLightAttack`
- `DetermineAction_Swarm_PassesWhenNoStamina`
- `DetermineAction_Support_PrefersLightAttack_LowRoll`
- `DetermineAction_Support_UsesStandardAttack_HighRoll`
- `DetermineAction_Caster_UsesStandardAttack`
- `DetermineAction_Caster_PassesWhenNoStamina`
- `DetermineAction_Boss_PrefersHeavyAttack`
- `DetermineAction_Boss_UsesStandardOnLowRoll`
- `DetermineAction_Boss_DefendsWhenNoStamina`

**State Trigger Tests:**
- `DetermineAction_CowardlyTag_FleesAtLowHp`
- `DetermineAction_CowardlyTag_DoesNotFleeWhenHealthy`
- `DetermineAction_NoCowardlyTag_DoesNotFlee`
- `DetermineAction_GlassCannon_FleesWhenCowardlyAndLowHp`

**Resource Management Tests:**
- `DetermineAction_LowStamina_FallsBackToLightAttack`
- `DetermineAction_NoStamina_PassesTurn`
- `DetermineAction_CannotAffordHeavy_FallsBackToStandard`

**Target Selection Tests:**
- `DetermineAction_NoPlayer_PassesTurn`
- `DetermineAction_FindsPlayerTarget`

**Edge Cases:**
- `DetermineAction_ZeroMaxHp_DoesNotCrash`
- `DetermineAction_DefaultArchetype_UsesAggressiveLogic`
- `DetermineAction_CombatActionContainsSourceId`
- `DetermineAction_AttackAction_HasFlavorText`

---

## Logging Matrix

| Event | Level | Template |
|-------|-------|----------|
| AI Start | Trace | `"[AI] {Name} (Arch:{Archetype}) thinking. HP: {Hp}% Stm: {Stamina}"` |
| Trigger Matched | Debug | `"[AI] Trigger matched: {Trigger} (Val: {Value})"` |
| Behavior Roll | Debug | `"[AI] Behavior roll: {Roll}"` |
| Decision Made | Information | `"[AI] {Name} chose {Action} vs {Target}. Roll: {Roll}"` |
| Resource Fallback | Warning | `"[AI] Wanted {Action} but insufficient Stamina. Fallback: {Fallback}"` |
| Enemy Attack | Information | `"{Attacker} attacks {Target} ({AttackType}): {Outcome}"` |
| Enemy Fled | Information | `"{Name} fled from combat"` |
| Processing Turn | Debug | `"Processing enemy turn for {Name}"` |

---

## Architecture

```
┌─────────────────────┐     ┌──────────────────────┐     ┌─────────────────────┐
│  CombatService      │────▶│    EnemyAIService    │────▶│   CombatAction      │
│  (NextTurn)         │     │   (DetermineAction)  │     │   (What to do)      │
└─────────────────────┘     └──────────────────────┘     └─────────────────────┘
         │                           │                            │
         │                           ▼                            │
         │                  ┌──────────────────────┐              │
         │                  │   Combatant          │              │
         │                  │   - Archetype        │              │
         │                  │   - CurrentHp/Max    │              │
         │                  │   - Tags             │              │
         │                  └──────────────────────┘              │
         │                                                        │
         ▼                                                        ▼
┌─────────────────────┐                               ┌─────────────────────┐
│  ExecuteEnemyAttack │◀──────────────────────────────│   AttackResolution  │
│  (Apply action)     │                               │   Service           │
└─────────────────────┘                               └─────────────────────┘
```

---

## Known Limitations

1. **Defend Soak Bonus**: The `IsDefending` property is set but the soak bonus is not yet applied. Full implementation in v0.2.2c.
2. **Single Target**: AI always targets the player. Multi-target selection for party combat in future releases.
3. **No Abilities**: Caster and Support archetypes use basic attacks. Special abilities coming in v0.2.2c.

---

## Migration Notes

### For Developers

If you have custom CombatService instantiations, you must now provide an `IEnemyAIService`:

```csharp
// Update your DI registration
services.AddSingleton<IEnemyAIService, EnemyAIService>();
```

### For Tests

Existing CombatService tests need to mock `IEnemyAIService`:

```csharp
private readonly Mock<IEnemyAIService> _mockAIService = new Mock<IEnemyAIService>();

_sut = new CombatService(
    _gameState,
    _mockInitiative.Object,
    _mockAttackResolution.Object,
    _mockLootService.Object,
    _mockStatusEffects.Object,
    _mockAIService.Object,  // NEW
    _mockLogger.Object);
```

---

## Next Steps (v0.2.2c)

- Implement defend soak bonus application
- Add special abilities for Caster and Support archetypes
- Phase 2 triggers for Boss enemies
- Multi-combatant targeting

---

## Contributors

- AI Implementation: Claude Opus 4.5

---

## Part C: The Elite (Traits & Affixes)

**Release Date:** 2025-12-20
**Milestone:** v0.2.2 – The Adversary (3 of 3)
**Test Count:** 1436 tests (22 new)

---

## Summary

This release implements the **CreatureTraitService** to procedurally generate Elite enemies with unique behaviors (Affixes). Enemies are no longer uniform stat-blocks—Elite and higher tier enemies now gain traits that provide stat modifiers and reactive combat behaviors.

---

## New Features

### Creature Trait System (CreatureTraitService)

The core of v0.2.2c is a procedural trait assignment system that enhances Elite, Champion, and Boss tier enemies:

| Tier     | Trait Count | Stat Scaling |
|----------|-------------|--------------|
| Standard | 0           | 1.0x         |
| Elite    | 1           | 1.5x         |
| Champion | 2           | 1.5x         |
| Boss     | 3           | 2.5x         |

### Trait Types

| Trait        | Category    | Effect                              | Name Prefix    |
|--------------|-------------|-------------------------------------|----------------|
| Armored      | Stat        | +3 ArmorSoak                        | "Armored"      |
| Relentless   | Stat        | +50% HP, Stun Immune                | "Relentless"   |
| Berserker    | Stat        | +25% damage dealt/received (future) | "Berserk"      |
| Vampiric     | On-Hit      | Heal 25% of damage dealt            | "Vampiric"     |
| Corrosive    | On-Hit      | Apply Vulnerable on hit (future)    | "Corrosive"    |
| Explosive    | On-Death    | 15 AoE damage to all combatants     | "Volatile"     |
| Regenerating | Turn-Start  | Heal 10% MaxHP per turn             | "Regenerating" |
| Thorns       | On-Hit-Recv | Reflect 25% damage to attacker      | "Thorned"      |

### Trait Trigger Locations

| Trigger Point     | Location                          | Traits Active   |
|-------------------|-----------------------------------|-----------------|
| OnTurnStart       | CombatService.NextTurn()          | Regenerating    |
| OnDeath           | CombatService.RemoveDefeatedCombatant() | Explosive  |
| OnDamageDealt     | CombatService.ExecuteEnemyAttack()| Vampiric        |
| OnDamageReceived  | CombatService.ExecutePlayerAttack()| Thorns         |

### Trait Exclusion Rules

- **Mechanical/Construct** enemies cannot roll Vampiric (no blood to drain)

---

## New Files

| File | Purpose |
|------|---------|
| `RuneAndRust.Core/Enums/CreatureTraitType.cs` | Enum for trait types with numeric groupings |
| `RuneAndRust.Core/Interfaces/ICreatureTraitService.cs` | Interface for trait generation and runtime effects |
| `RuneAndRust.Engine/Services/CreatureTraitService.cs` | Trait assignment and effect processing |
| `RuneAndRust.Tests/Engine/CreatureTraitServiceTests.cs` | 22 unit tests for trait behaviors |

---

## Modified Files

| File | Changes |
|------|---------|
| `RuneAndRust.Core/Entities/Enemy.cs` | Added `ActiveTraits` property and `IsElite` computed property |
| `RuneAndRust.Core/Models/Combat/Combatant.cs` | Added `ActiveTraits` property, updated `FromEnemy()` to copy traits |
| `RuneAndRust.Engine/Factories/EnemyFactory.cs` | Added `ICreatureTraitService` dependency, calls `EnhanceEnemy()` for Elite+ |
| `RuneAndRust.Engine/Services/CombatService.cs` | Added `ICreatureTraitService` dependency, integrated 4 trait triggers |
| `RuneAndRust.Terminal/Program.cs` | Registered `ICreatureTraitService` in DI container |
| `RuneAndRust.Tests/Engine/EnemyFactoryTests.cs` | Added `ICreatureTraitService` mock to test setup |
| `RuneAndRust.Tests/Engine/CombatServiceTests.cs` | Added `ICreatureTraitService` mock with default returns |

---

## API Changes

### Enemy Entity

New properties added:

```csharp
public List<CreatureTraitType> ActiveTraits { get; set; } = new();
public bool IsElite => ActiveTraits.Count > 0;
```

### Combatant Model

New property added:

```csharp
public List<CreatureTraitType> ActiveTraits { get; set; } = new();
```

### EnemyFactory Constructor (Breaking Change)

The constructor now requires `ICreatureTraitService`:

```csharp
// Before
public EnemyFactory(ILogger<EnemyFactory>, IDiceService)

// After
public EnemyFactory(ILogger<EnemyFactory>, IDiceService, ICreatureTraitService)
```

### CombatService Constructor (Breaking Change)

The constructor now requires `ICreatureTraitService`:

```csharp
// Before (v0.2.2b)
public CombatService(..., IEnemyAIService, ILogger)

// After
public CombatService(..., IEnemyAIService, ICreatureTraitService, ILogger)
```

---

## Test Coverage

### New Tests (22 total)

**Enhancement Tests:**
- `EnhanceEnemy_EliteTier_AddsOneTrait`
- `EnhanceEnemy_ChampionTier_AddsTwoTraits`
- `EnhanceEnemy_BossTier_AddsThreeTraits`
- `EnhanceEnemy_StandardTier_NoTraits`
- `EnhanceEnemy_Armored_IncreasesArmorSoak`
- `EnhanceEnemy_Relentless_IncreasesHpAndAddsImmunity`
- `EnhanceEnemy_PrefixesName`
- `EnhanceEnemy_MechanicalEnemy_CannotBeVampiric`

**Turn Start Tests:**
- `ProcessTraitTurnStart_Regenerating_HealsEnemy`
- `ProcessTraitTurnStart_NoTrait_ReturnsZero`
- `ProcessTraitTurnStart_AtMaxHp_DoesNotOverheal`

**On Death Tests:**
- `ProcessTraitOnDeath_Explosive_DamagesAllCombatants`
- `ProcessTraitOnDeath_Explosive_DoesNotDamageSelf`
- `ProcessTraitOnDeath_NoTrait_ReturnsEmpty`

**On Damage Tests:**
- `ProcessTraitOnDamageDealt_Vampiric_HealsAttacker`
- `ProcessTraitOnDamageDealt_NoTrait_ReturnsZero`
- `ProcessTraitOnDamageDealt_Vampiric_DoesNotOverheal`
- `ProcessTraitOnDamageReceived_Thorns_ReturnsDamage`
- `ProcessTraitOnDamageReceived_NoTrait_ReturnsZero`

**Immunity Tests:**
- `IsImmuneToEffect_Relentless_ImmuneToStun`
- `IsImmuneToEffect_Relentless_NotImmuneToOtherEffects`
- `IsImmuneToEffect_NoTrait_NotImmune`

---

## Logging Matrix

| Event | Level | Template |
|-------|-------|----------|
| Enhancement Start | Information | `"Enhancing {Name} (Tier: {Tier}) with {Count} trait(s)"` |
| Trait Applied | Information | `"Trait {Trait} applied to {Name}. ActiveTraits: [{Traits}]"` |
| Trait Effect | Debug | `"Applied {Trait}: {Details}"` |
| Regeneration | Information | `"[Trait] {Name} regenerates {Amount} HP. HP: {Current}/{Max}"` |
| Explosion | Warning | `"[Trait] {Name} EXPLODES on death! Dealing {Damage} damage to all."` |
| Vampiric | Information | `"[Trait] {Name} drains {Amount} HP from the wound."` |
| Thorns | Information | `"[Trait] {Defender}'s thorns reflect {Damage} damage to {Attacker}!"` |
| Immunity | Debug | `"[Trait] {Name} is immune to {Effect} ({Trait})"` |

---

## Architecture

```
┌─────────────────────┐     ┌──────────────────────┐     ┌─────────────────────┐
│  EnemyFactory       │────▶│  CreatureTraitService│────▶│   Enemy Entity      │
│  (CreateFromTemplate)│     │  (EnhanceEnemy)      │     │   + ActiveTraits    │
└─────────────────────┘     └──────────────────────┘     └─────────────────────┘
         │                           │                            │
         │                           ▼                            │
         │                  ┌──────────────────────┐              │
         │                  │   Trait Effects:     │              │
         │                  │   - Stat Modifiers   │              │
         │                  │   - Name Prefixes    │              │
         │                  │   - Runtime Tags     │              │
         │                  └──────────────────────┘              │
         │                                                        │
         ▼                                                        ▼
┌─────────────────────┐                               ┌─────────────────────┐
│  CombatService      │◀──────────────────────────────│   Combatant         │
│  (Trait Triggers)   │                               │   + ActiveTraits    │
└─────────────────────┘                               └─────────────────────┘
```

---

## Known Limitations

1. **Berserker Damage Modifier**: +25% damage not yet integrated into AttackResolutionService
2. **Corrosive Vulnerable**: Status effect application not yet implemented
3. **Elite Spawn Chance**: Manual tag-based detection, no RNG promotion
4. **Single Tier Check**: Uses tag-based detection instead of proper tier property

---

## Migration Notes

### For Developers

If you have custom EnemyFactory or CombatService instantiations, you must now provide an `ICreatureTraitService`:

```csharp
// Update your DI registration
services.AddSingleton<ICreatureTraitService, CreatureTraitService>();
```

### For Tests

Existing EnemyFactory tests need to mock `ICreatureTraitService`:

```csharp
private readonly Mock<ICreatureTraitService> _mockTraitService = new Mock<ICreatureTraitService>();

_factory = new EnemyFactory(
    _mockLogger.Object,
    _mockDice.Object,
    _mockTraitService.Object);  // NEW
```

Existing CombatService tests need to mock `ICreatureTraitService` with default returns:

```csharp
private readonly Mock<ICreatureTraitService> _mockTraitService = new Mock<ICreatureTraitService>();

// Default setup for trait service
_mockTraitService.Setup(t => t.ProcessTraitTurnStart(It.IsAny<Combatant>())).Returns(0);
_mockTraitService.Setup(t => t.ProcessTraitOnDeath(It.IsAny<Combatant>(), It.IsAny<IEnumerable<Combatant>>()))
    .Returns(new List<(Combatant, int)>());
_mockTraitService.Setup(t => t.ProcessTraitOnDamageDealt(It.IsAny<Combatant>(), It.IsAny<int>())).Returns(0);
_mockTraitService.Setup(t => t.ProcessTraitOnDamageReceived(It.IsAny<Combatant>(), It.IsAny<Combatant>(), It.IsAny<int>())).Returns(0);
```

---

## Next Steps (v0.2.3+)

- Implement Berserker damage modifier in AttackResolutionService
- Implement Corrosive Vulnerable application via StatusEffectService
- Add RNG-based Elite promotion chance (15% + DangerLevel * 5%)
- Add trait exclusion rules (Fast incompatible with Stationary, etc.)
- Visual trait indicators in CombatScreenRenderer
- Add `ThreatTier` property to Enemy for proper tier tracking

---

## Contributors

- Implementation: Claude Opus 4.5
