# Changelog v0.15.0b - Seeded Random Provider

**Version**: 0.15.0b  
**Phase**: Seeded Random Provider  
**Date**: 2026-01-22

## Summary

Implements testable, deterministic random number generation with context-aware seeding for different gameplay scenarios. This enables reproducible dice rolls for testing, debugging, and specific gameplay scenarios (e.g., locked seeds during combat to prevent save-scumming).

## Added

### Domain Layer
- **`IRandomProvider.cs`** - Interface for random number generation with seeding and state management
  - `Next(minInclusive, maxExclusive)` - Single random value
  - `NextMany(count, minInclusive, maxExclusive)` - Batch generation
  - `SetSeed(seed)` / `GetCurrentSeed()` - Seed management
  - `SaveState()` / `RestoreState()` - State persistence

- **`IRngContextService.cs`** - Interface for context-aware RNG management
  - `EnterContext()` / `ExitContext()` - Context stack management
  - `LockSeedForContext()` / `ReleaseSeedLock()` - Seed locking
  - `GetCurrentContext()` / `IsContextSeedLocked()` / `GetLockedSeed()`

- **`RngContext.cs`** - Enum defining gameplay contexts:
  - `Combat` - Locked seed per encounter (prevents save-scumming)
  - `Exploration` - Fresh seed on load (allows retry)
  - `Crafting` - Locked seed per session
  - `Dialogue` - Fresh seed on load
  - `Default` - Fallback context

### Application Layer
- **`SeededRandomProvider.cs`** - Implementation of `IRandomProvider`
  - Wraps `System.Random` with seed tracking
  - Save/restore saves seed value (recreates sequence from beginning)
  - Exhaustive logging on all operations

- **`RngContextService.cs`** - Implementation of `IRngContextService`
  - Context stack for nested contexts (e.g., dialogue during combat)
  - Dictionary for locked seeds
  - Fresh seed generation for Exploration/Dialogue
  - Locked seed application for Combat/Crafting

- **`RandomAdapter`** - Internal class for backward compatibility
  - Wraps `System.Random` in `IRandomProvider` interface
  - State management methods are no-ops

### Unit Tests
- **`SeededRandomProviderTests.cs`** - 13 tests
  - Deterministic sequence generation
  - Save/restore state
  - Batch generation
  - Seed management

- **`RngContextServiceTests.cs`** - 15 tests
  - Context stack management
  - Seed locking/unlocking
  - Context transitions

## Changed

### DiceService
- Primary constructor now takes `IRandomProvider`
- Old `Random` constructor marked `[Obsolete]` (backward compat via `RandomAdapter`)
- `RollSingleDie()` uses `_randomProvider.Next()` instead of `_random.Next()`
- Logs current seed on initialization

## Breaking Changes

- `DiceService` primary constructor signature changed (now requires `IRandomProvider`)
- Old `Random` constructor still works but is marked obsolete

## Files Created

| File | Layer | Description |
|------|-------|-------------|
| `IRandomProvider.cs` | Domain | Random generation interface |
| `IRngContextService.cs` | Domain | Context management interface |
| `RngContext.cs` | Domain | Context enum |
| `SeededRandomProvider.cs` | Application | Seeded RNG implementation |
| `RngContextService.cs` | Application | Context service implementation |
| `SeededRandomProviderTests.cs` | Tests | 13 unit tests |
| `RngContextServiceTests.cs` | Tests | 15 unit tests |

## Files Modified

| File | Layer | Changes |
|------|-------|---------|
| `DiceService.cs` | Application | Added `IRandomProvider` constructor, `RandomAdapter` internal class |

## Test Results

- **SeededRandomProviderTests**: 13/13 passed ✅
- **RngContextServiceTests**: 15/15 passed ✅
- **Dice backward compatibility**: 47/49 passed ✅ (2 pre-existing failures unrelated to v0.15.0b)
