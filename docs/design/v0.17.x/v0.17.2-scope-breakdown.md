## v0.17.2 - Attribute System

**Focus:** Core attributes, point-buy allocation, cost scaling, derived stat calculation, and simple/advanced modes

**Source Specification:** [character-creation.md](../../aethelgard/design/01-core/character-creation.md)

### Overview

This version implements the attribute allocation system that determines a character's base capabilities. The system supports two modes: Simple (archetype-recommended builds for new players) and Advanced (point-buy for experienced players). Attributes directly influence derived stats like HP, Stamina, and Aether Pool.

---

### Deliverables Summary

| Category | Items | Estimated Tests |
|----------|-------|-----------------|
| Enums | 2 | 3 |
| Value Objects | 4 | 6 |
| Entities | 1 | 3 |
| Services | 3 | 6 |
| **Total** | **10** | **~18** |

---

### v0.17.2a - Core Attribute Enum

#### CoreAttribute Enum
```
CoreAttribute
├── Might - Physical power, melee damage, carrying capacity
├── Finesse - Agility, precision, ranged accuracy, initiative
├── Wits - Perception, knowledge, crafting, puzzle-solving
├── Will - Mental fortitude, Aether channeling, resistance
├── Sturdiness - Endurance, HP, physical resilience
```

#### AttributeDescription Value Object
```
AttributeDescription
├── Attribute: CoreAttribute
├── DisplayName: string
├── ShortDescription: string
├── DetailedDescription: string
├── AffectedStats: List<string>
├── AffectedSkills: List<string>
```

**Attribute Descriptions:**
| Attribute | Affects Stats | Affects Skills |
|-----------|---------------|----------------|
| MIGHT | Melee Damage, Carrying Capacity | Combat, Athletics, Intimidation |
| FINESSE | Ranged Accuracy, Initiative, Stamina | Stealth, Acrobatics, Lockpicking |
| WITS | Aether Pool, Perception | Lore, Craft, Investigation |
| WILL | Aether Pool, Resolve | Rhetoric, Concentration, Willpower |
| STURDINESS | HP, Soak | Endurance, Survival, Fortitude |

**Configuration (`attributes.json` - Descriptions):**
```json
{
  "attributes": [
    {
      "attribute": "Might",
      "displayName": "MIGHT",
      "shortDescription": "Physical power and raw strength",
      "detailedDescription": "Might represents your character's physical power. It affects melee damage, carrying capacity, and physical feats of strength.",
      "affectedStats": ["Melee Damage", "Carrying Capacity", "Stamina (partial)"],
      "affectedSkills": ["Combat", "Athletics", "Intimidation"]
    },
    {
      "attribute": "Sturdiness",
      "displayName": "STURDINESS",
      "shortDescription": "Endurance and physical resilience",
      "detailedDescription": "Sturdiness represents your character's toughness and endurance. It is the primary determinant of your maximum HP and affects your ability to resist physical punishment.",
      "affectedStats": ["Max HP", "Soak"],
      "affectedSkills": ["Endurance", "Survival", "Fortitude"]
    }
  ]
}
```

**Unit Tests (~2):**
- [x] CoreAttribute enum has 5 values
- [x] Attribute descriptions load correctly

---

### v0.17.2b - Allocation Mode System

#### AttributeAllocationMode Enum
```
AttributeAllocationMode
├── Simple - Use archetype-recommended builds
├── Advanced - Point-buy customization
```

#### AttributeAllocationState Value Object
```
AttributeAllocationState
├── Mode: AttributeAllocationMode
├── CurrentMight: int
├── CurrentFinesse: int
├── CurrentWits: int
├── CurrentWill: int
├── CurrentSturdiness: int
├── PointsSpent: int
├── PointsRemaining: int
├── TotalPoints: int
├── SelectedArchetype: Archetype? (for simple mode)
```

**Mode Behavior:**
```
Simple Mode:
  1. Player selects archetype first
  2. Attributes auto-set to recommended values
  3. No manual adjustment allowed
  4. Fastest path for new players

Advanced Mode:
  1. Player has full control
  2. Point-buy system with cost scaling
  3. All attributes start at 1
  4. Can switch to Simple mode at any time
```

**Simple Mode Recommended Builds:**
| Archetype | MIGHT | FINESSE | WITS | WILL | STURDINESS | Total Points |
|-----------|-------|---------|------|------|------------|--------------|
| Warrior | 4 | 3 | 2 | 2 | 4 | 15 |
| Skirmisher | 3 | 4 | 3 | 2 | 3 | 15 |
| Mystic | 2 | 3 | 4 | 4 | 2 | 15 |
| Adept | 3 | 3 | 3 | 2 | 3 | 14 |

**Unit Tests (~2):**
- [x] Simple mode applies correct recommended build
- [x] Mode switching preserves/resets state correctly

---

### v0.17.2c - Point-Buy Cost System

#### PointBuyCost Value Object
```
PointBuyCost
├── TargetValue: int
├── IndividualCost: int
├── CumulativeCost: int
```

#### PointBuyConfiguration Value Object
```
PointBuyConfiguration
├── StartingPoints: int (default 15, 14 for Adept)
├── MinAttributeValue: int (1)
├── MaxAttributeValue: int (10)
├── CostTable: List<PointBuyCost>
```

**Point Cost Table:**
| Target Value | Individual Cost | Cumulative Cost |
|--------------|-----------------|-----------------|
| 1 (base) | 0 | 0 |
| 2 | 1 | 1 |
| 3 | 1 | 2 |
| 4 | 1 | 3 |
| 5 | 1 | 4 |
| 6 | 1 | 5 |
| 7 | 1 | 6 |
| 8 | 1 | 7 |
| 9 | 2 | 9 |
| 10 | 2 | 11 |

**Point-Buy Rules:**
```
Starting Pool: 15 Points (14 for Adept)
All Attributes Start at: 1
Maximum per Attribute: 10
Minimum per Attribute: 1

Cost Scaling:
  - Values 2-8: 1 point each
  - Values 9-10: 2 points each
```

**Cost Calculation Logic:**
```
CalculateCost(fromValue, toValue):
  If fromValue == toValue: Return 0
  If toValue < fromValue:
    Return -CalculateCost(toValue, fromValue)  // Refund

  cost = 0
  For value = fromValue + 1 to toValue:
    If value <= 8:
      cost += 1
    Else:
      cost += 2
  Return cost
```

**Configuration (`attributes.json` - Point Buy):**
```json
{
  "pointBuy": {
    "startingPoints": 15,
    "adeptStartingPoints": 14,
    "minAttributeValue": 1,
    "maxAttributeValue": 10,
    "costTable": [
      { "targetValue": 2, "individualCost": 1, "cumulativeCost": 1 },
      { "targetValue": 3, "individualCost": 1, "cumulativeCost": 2 },
      { "targetValue": 4, "individualCost": 1, "cumulativeCost": 3 },
      { "targetValue": 5, "individualCost": 1, "cumulativeCost": 4 },
      { "targetValue": 6, "individualCost": 1, "cumulativeCost": 5 },
      { "targetValue": 7, "individualCost": 1, "cumulativeCost": 6 },
      { "targetValue": 8, "individualCost": 1, "cumulativeCost": 7 },
      { "targetValue": 9, "individualCost": 2, "cumulativeCost": 9 },
      { "targetValue": 10, "individualCost": 2, "cumulativeCost": 11 }
    ]
  }
}
```

**Unit Tests (~3):**
- [x] Cost from 1 to 8 is 7 points
- [x] Cost from 8 to 10 is 4 points (2 + 2)
- [x] Decreasing attribute refunds correct amount

---

### v0.17.2d - Derived Stat Calculation

#### DerivedStats Value Object
```
DerivedStats
├── MaxHp: int
├── MaxStamina: int
├── MaxAetherPool: int
├── Initiative: int
├── Soak: int
├── MovementSpeed: int
├── CarryingCapacity: int
```

#### DerivedStatFormula Value Object
```
DerivedStatFormula
├── StatName: string
├── BaseValue: int
├── AttributeScaling: Dictionary<CoreAttribute, float>
├── ArchetypeBonus: int?
├── LineageBonus: int?
```

**Derived Stat Formulas:**
```
Max HP = (STURDINESS × 10) + 50 + ArchetypeBonus + LineageBonus
  - Warrior Bonus: +49
  - Skirmisher Bonus: +30
  - Mystic Bonus: +20
  - Adept Bonus: +30
  - Clan-Born Bonus: +5

Max Stamina = (FINESSE × 5) + (MIGHT × 5) + 20 + ArchetypeBonus
  - Warrior Bonus: +5
  - Skirmisher Bonus: +5
  - Mystic Bonus: 0
  - Adept Bonus: 0

Max Aether Pool = (WILL × 10) + (WITS × 5) + ArchetypeBonus + LineageBonus
  - Warrior Bonus: 0
  - Skirmisher Bonus: 0
  - Mystic Bonus: +20
  - Adept Bonus: 0
  - Rune-Marked Bonus: +5, then ×1.10 (Aether-Tainted)

Initiative = FINESSE + (WITS ÷ 2)

Soak = (STURDINESS ÷ 2) + LineageBonus
  - Iron-Blooded Bonus: +2

Movement Speed = 5 + LineageBonus
  - Vargr-Kin Bonus: +1
```

**Example Calculations:**
```
Warrior with MIGHT 4, FINESSE 3, WITS 2, WILL 2, STURDINESS 4:
  Max HP = (4 × 10) + 50 + 49 = 40 + 50 + 49 = 139
  Max Stamina = (3 × 5) + (4 × 5) + 20 + 5 = 15 + 20 + 20 + 5 = 60
  Max AP = (2 × 10) + (2 × 5) + 0 = 20 + 10 = 30

Mystic with MIGHT 2, FINESSE 3, WITS 4, WILL 4, STURDINESS 2:
  Max HP = (2 × 10) + 50 + 20 = 20 + 50 + 20 = 90
  Max Stamina = (3 × 5) + (2 × 5) + 20 + 0 = 15 + 10 + 20 = 45
  Max AP = (4 × 10) + (4 × 5) + 20 = 40 + 20 + 20 = 80
```

**Configuration (`attributes.json` - Derived Stats):**
```json
{
  "derivedStats": {
    "maxHp": {
      "baseValue": 50,
      "attributeScaling": {
        "Sturdiness": 10
      },
      "archetypeBonus": {
        "Warrior": 49,
        "Skirmisher": 30,
        "Mystic": 20,
        "Adept": 30
      }
    },
    "maxStamina": {
      "baseValue": 20,
      "attributeScaling": {
        "Finesse": 5,
        "Might": 5
      },
      "archetypeBonus": {
        "Warrior": 5,
        "Skirmisher": 5,
        "Mystic": 0,
        "Adept": 0
      }
    },
    "maxAetherPool": {
      "baseValue": 0,
      "attributeScaling": {
        "Will": 10,
        "Wits": 5
      },
      "archetypeBonus": {
        "Warrior": 0,
        "Skirmisher": 0,
        "Mystic": 20,
        "Adept": 0
      }
    }
  }
}
```

**Unit Tests (~3):**
- [x] Warrior HP calculation correct (139 with standard build)
- [x] Mystic AP calculation correct (80 with standard build)
- [x] Lineage bonuses apply to derived stats

---

### v0.17.2e - Attribute Provider Service

#### IAttributeProvider Interface
```csharp
public interface IAttributeProvider
{
    /// <summary>
    /// Gets description for an attribute.
    /// </summary>
    AttributeDescription GetAttributeDescription(CoreAttribute attribute);

    /// <summary>
    /// Gets recommended attributes for an archetype.
    /// </summary>
    AttributeSet GetRecommendedBuild(Archetype archetype);

    /// <summary>
    /// Gets point-buy configuration.
    /// </summary>
    PointBuyConfiguration GetPointBuyConfiguration();

    /// <summary>
    /// Gets starting points for an archetype.
    /// </summary>
    int GetStartingPoints(Archetype? archetype);

    /// <summary>
    /// Gets all attribute descriptions.
    /// </summary>
    IReadOnlyList<AttributeDescription> GetAllAttributeDescriptions();
}
```

**Unit Tests (~2):**
- [ ] GetRecommendedBuild returns correct values for each archetype
- [ ] GetStartingPoints returns 14 for Adept, 15 for others

---

### v0.17.2f - Attribute Allocation Service

#### IAttributeAllocationService Interface
```csharp
public interface IAttributeAllocationService
{
    /// <summary>
    /// Creates initial allocation state for a mode.
    /// </summary>
    AttributeAllocationState CreateAllocationState(
        AttributeAllocationMode mode,
        Archetype? archetype = null);

    /// <summary>
    /// Attempts to modify an attribute value.
    /// </summary>
    AttributeModificationResult TryModifyAttribute(
        AttributeAllocationState state,
        CoreAttribute attribute,
        int newValue);

    /// <summary>
    /// Calculates the cost to change an attribute.
    /// </summary>
    int CalculateCost(int fromValue, int toValue);

    /// <summary>
    /// Validates that allocation is complete and valid.
    /// </summary>
    ValidationResult ValidateAllocation(AttributeAllocationState state);

    /// <summary>
    /// Switches allocation mode.
    /// </summary>
    AttributeAllocationState SwitchMode(
        AttributeAllocationState currentState,
        AttributeAllocationMode newMode,
        Archetype? archetype = null);

    /// <summary>
    /// Resets allocation to defaults.
    /// </summary>
    AttributeAllocationState ResetAllocation(
        AttributeAllocationMode mode,
        Archetype? archetype = null);
}
```

#### AttributeModificationResult Value Object
```
AttributeModificationResult
├── Success: bool
├── NewState: AttributeAllocationState?
├── PointsSpent: int
├── PointsRemaining: int
├── ErrorMessage: string?
```

**Modification Logic:**
```
TryModifyAttribute(state, attribute, newValue):
  1. Validate newValue is within [1, 10]
  2. Calculate cost difference from current to new
  3. Check if enough points remaining (for increase)
  4. If valid:
     a. Update attribute value
     b. Update points spent/remaining
     c. Return success with new state
  5. If invalid:
     a. Return failure with error message
```

**Unit Tests (~3):**
- [ ] TryModifyAttribute succeeds with enough points
- [ ] TryModifyAttribute fails when insufficient points
- [ ] SwitchMode resets to recommended build in Simple mode

---

### v0.17.2g - Derived Stat Calculator Service

#### IDerivedStatCalculator Interface
```csharp
public interface IDerivedStatCalculator
{
    /// <summary>
    /// Calculates all derived stats from attributes.
    /// </summary>
    DerivedStats CalculateDerivedStats(
        AttributeSet attributes,
        Archetype archetype,
        Lineage lineage);

    /// <summary>
    /// Calculates a single derived stat.
    /// </summary>
    int CalculateStat(
        string statName,
        AttributeSet attributes,
        Archetype archetype,
        Lineage lineage);

    /// <summary>
    /// Gets preview of derived stats during allocation.
    /// </summary>
    DerivedStats GetPreview(
        AttributeAllocationState state,
        Archetype archetype,
        Lineage lineage);
}
```

**Preview Logic:**
```
GetPreview(state, archetype, lineage):
  1. Build AttributeSet from state
  2. Apply lineage attribute modifiers
  3. Calculate all derived stats
  4. Return preview (used during allocation for live feedback)
```

**Unit Tests (~3):**
- [ ] CalculateDerivedStats produces correct HP
- [ ] Lineage modifiers affect calculation
- [ ] Preview updates in real-time during allocation

---

### Configuration Files

| File | Purpose |
|------|---------|
| `attributes.json` | Attribute descriptions, point-buy costs, derived stat formulas |

**Complete Configuration Example:**
```json
{
  "attributes": [
    {
      "attribute": "Might",
      "displayName": "MIGHT",
      "shortDescription": "Physical power and raw strength",
      "detailedDescription": "Might represents your character's physical power...",
      "affectedStats": ["Melee Damage", "Carrying Capacity", "Stamina"],
      "affectedSkills": ["Combat", "Athletics", "Intimidation"]
    },
    {
      "attribute": "Finesse",
      "displayName": "FINESSE",
      "shortDescription": "Agility and precision",
      "detailedDescription": "Finesse represents your character's agility...",
      "affectedStats": ["Ranged Accuracy", "Initiative", "Stamina"],
      "affectedSkills": ["Stealth", "Acrobatics", "Lockpicking"]
    },
    {
      "attribute": "Wits",
      "displayName": "WITS",
      "shortDescription": "Perception and knowledge",
      "detailedDescription": "Wits represents your character's mental acuity...",
      "affectedStats": ["Aether Pool", "Perception"],
      "affectedSkills": ["Lore", "Craft", "Investigation"]
    },
    {
      "attribute": "Will",
      "displayName": "WILL",
      "shortDescription": "Mental fortitude and magical affinity",
      "detailedDescription": "Will represents your character's mental fortitude...",
      "affectedStats": ["Aether Pool", "Resolve"],
      "affectedSkills": ["Rhetoric", "Concentration", "Willpower"]
    },
    {
      "attribute": "Sturdiness",
      "displayName": "STURDINESS",
      "shortDescription": "Endurance and physical resilience",
      "detailedDescription": "Sturdiness represents your character's toughness...",
      "affectedStats": ["Max HP", "Soak"],
      "affectedSkills": ["Endurance", "Survival", "Fortitude"]
    }
  ],
  "pointBuy": {
    "startingPoints": 15,
    "adeptStartingPoints": 14,
    "minAttributeValue": 1,
    "maxAttributeValue": 10,
    "costTable": [
      { "targetValue": 2, "individualCost": 1, "cumulativeCost": 1 },
      { "targetValue": 3, "individualCost": 1, "cumulativeCost": 2 },
      { "targetValue": 4, "individualCost": 1, "cumulativeCost": 3 },
      { "targetValue": 5, "individualCost": 1, "cumulativeCost": 4 },
      { "targetValue": 6, "individualCost": 1, "cumulativeCost": 5 },
      { "targetValue": 7, "individualCost": 1, "cumulativeCost": 6 },
      { "targetValue": 8, "individualCost": 1, "cumulativeCost": 7 },
      { "targetValue": 9, "individualCost": 2, "cumulativeCost": 9 },
      { "targetValue": 10, "individualCost": 2, "cumulativeCost": 11 }
    ]
  },
  "recommendedBuilds": {
    "Warrior": { "might": 4, "finesse": 3, "wits": 2, "will": 2, "sturdiness": 4 },
    "Skirmisher": { "might": 3, "finesse": 4, "wits": 3, "will": 2, "sturdiness": 3 },
    "Mystic": { "might": 2, "finesse": 3, "wits": 4, "will": 4, "sturdiness": 2 },
    "Adept": { "might": 3, "finesse": 3, "wits": 3, "will": 2, "sturdiness": 3 }
  },
  "derivedStats": {
    "maxHp": {
      "baseValue": 50,
      "attributeScaling": { "Sturdiness": 10 },
      "archetypeBonus": { "Warrior": 49, "Skirmisher": 30, "Mystic": 20, "Adept": 30 }
    },
    "maxStamina": {
      "baseValue": 20,
      "attributeScaling": { "Finesse": 5, "Might": 5 },
      "archetypeBonus": { "Warrior": 5, "Skirmisher": 5, "Mystic": 0, "Adept": 0 }
    },
    "maxAetherPool": {
      "baseValue": 0,
      "attributeScaling": { "Will": 10, "Wits": 5 },
      "archetypeBonus": { "Warrior": 0, "Skirmisher": 0, "Mystic": 20, "Adept": 0 }
    }
  }
}
```

---

### Dependencies

**Requires:**
- v0.17.0: Lineage system (for attribute modifiers and derived stat bonuses)
- v0.17.3: Archetype system (for recommended builds and archetype bonuses)

**Provides to:**
- v0.17.5: Attribute step in creation workflow
- Combat system: Attribute-based rolls
- All stat checks: Attribute values

---

### Acceptance Criteria

- [ ] CoreAttribute enum has 5 values
- [ ] AttributeAllocationMode enum has 2 values (Simple, Advanced)
- [ ] Simple mode applies archetype-recommended builds
- [ ] Advanced mode allows point-buy with 15 points (14 for Adept)
- [ ] All attributes start at 1 in Advanced mode
- [ ] Cost for values 2-8 is 1 point each
- [ ] Cost for values 9-10 is 2 points each
- [ ] Maximum attribute value is 10
- [ ] Minimum attribute value is 1
- [ ] Derived stats calculate correctly from attributes
- [ ] Archetype bonuses apply to derived stats
- [ ] Lineage bonuses apply to derived stats
- [ ] Mode switching resets state appropriately
- [ ] Live preview updates during allocation
- [ ] Validation prevents invalid final states
- [ ] ~18 unit tests pass
