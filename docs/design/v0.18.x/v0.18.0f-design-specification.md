# v0.18.0f Design Specification: Database Persistence

**Version:** 0.18.0f
**Parent:** v0.18.0 (Psychic Stress System)
**Prerequisites:** v0.18.0d (StressService Implementation)
**Status:** Design Complete
**Estimated Unit Tests:** ~2

---

## Table of Contents

1. [Executive Summary](#1-executive-summary)
2. [Feature Overview](#2-feature-overview)
3. [Architecture Diagrams](#3-architecture-diagrams)
4. [User Stories](#4-user-stories)
5. [Database Schema Changes](#5-database-schema-changes)
6. [Domain Entity](#6-domain-entity)
7. [Repository Integration](#7-repository-integration)
8. [Logging Specifications](#8-logging-specifications)
9. [Unit Testing Requirements](#9-unit-testing-requirements)
10. [Use Cases](#10-use-cases)
11. [Deliverable Checklist](#11-deliverable-checklist)
12. [Acceptance Criteria](#12-acceptance-criteria)
13. [Dependencies](#13-dependencies)
14. [Future Considerations](#14-future-considerations)

---

## 1. Executive Summary

This design specification defines the database persistence layer for the Psychic Stress system, including schema extensions for character stress storage and a comprehensive history tracking table for analytics.

v0.18.0f completes the stress system by adding:

- `psychic_stress` column to character resources with validation constraints
- `stress_history` table for tracking all stress events
- `StressHistoryEntry` domain entity for history records

### Key Deliverables

| Category                | Items                |
| ----------------------- | -------------------- |
| **Database Migrations** | 1 migration file     |
| **Domain Entities**     | `StressHistoryEntry` |
| **Tests**               | ~2 unit tests        |

### Database Changes Summary

| Change     | Table                 | Details                           |
| ---------- | --------------------- | --------------------------------- |
| Add Column | `character_resources` | `psychic_stress INT (0-100)`      |
| New Table  | `stress_history`      | Full event audit log              |
| New Index  | `stress_history`      | `idx_stress_history_character_id` |

---

## 2. Feature Overview

```
v0.18.0f Features
└── Database Persistence Layer
    │
    ├── SCHEMA CHANGES
    │   ├── character_resources.psychic_stress — Current stress value
    │   └── stress_history table — Complete event audit
    │
    ├── DOMAIN ENTITY
    │   └── StressHistoryEntry
    │       ├── Id (Guid)
    │       ├── CharacterId (Guid)
    │       ├── Amount (int)
    │       ├── Source (StressSource)
    │       ├── ResistDc (int?)
    │       ├── Resisted (bool)
    │       ├── FinalAmount (int)
    │       ├── PreviousStress (int)
    │       ├── NewStress (int)
    │       ├── ThresholdCrossed (StressThreshold?)
    │       └── CreatedAt (DateTime)
    │
    └── REPOSITORY INTEGRATION
        ├── IStressHistoryRepository
        │   ├── Add(StressHistoryEntry)
        │   ├── GetByCharacterId(characterId)
        │   └── GetByCharacterId(characterId, limit)
        │
        └── StressService Integration
            └── Records history on ApplyStress
```

---

## 3. Architecture Diagrams

### 3.1 Layer Diagram

```
┌─────────────────────────────────────────────────────────────────────────┐
│                       DOMAIN LAYER                                      │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │                     StressHistoryEntry                           │   │
│  ├─────────────────────────────────────────────────────────────────┤   │
│  │  Id: Guid                                                        │   │
│  │  CharacterId: Guid                                               │   │
│  │  Amount: int                                                     │   │
│  │  Source: StressSource                                            │   │
│  │  ResistDc: int?                                                  │   │
│  │  Resisted: bool                                                  │   │
│  │  FinalAmount: int                                                │   │
│  │  PreviousStress: int                                             │   │
│  │  NewStress: int                                                  │   │
│  │  ThresholdCrossed: StressThreshold?                              │   │
│  │  CreatedAt: DateTime                                             │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
                               │
                               │ persisted by
                               ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                    INFRASTRUCTURE LAYER                                 │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │                 IStressHistoryRepository                         │   │
│  ├─────────────────────────────────────────────────────────────────┤   │
│  │  + Add(StressHistoryEntry): void                                │   │
│  │  + GetByCharacterId(Guid): IReadOnlyList<StressHistoryEntry>    │   │
│  │  + GetByCharacterId(Guid, int limit):                           │   │
│  │        IReadOnlyList<StressHistoryEntry>                        │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                               │                                         │
│                               │ implements                              │
│                               ▼                                         │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │                 StressHistoryRepository                          │   │
│  │                 (EF Core Implementation)                         │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

### 3.2 Database Schema Diagram

```
┌─────────────────────────────────────────────────────────────────────────┐
│                         DATABASE SCHEMA                                 │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  ┌─────────────────────────────────────┐                               │
│  │         character_resources          │                               │
│  ├─────────────────────────────────────┤                               │
│  │  character_id    UUID PK FK         │                               │
│  │  health          INT                │                               │
│  │  max_health      INT                │                               │
│  │  ...             ...                │                               │
│  │  psychic_stress  INT (0-100) ◄─────────── NEW COLUMN                │
│  └─────────────────────────────────────┘                               │
│              │                                                          │
│              │ 1                                                        │
│              │                                                          │
│              │                                                          │
│              │ *                                                        │
│              ▼                                                          │
│  ┌─────────────────────────────────────┐                               │
│  │           stress_history            │ ◄─────────────── NEW TABLE    │
│  ├─────────────────────────────────────┤                               │
│  │  id               UUID PK           │                               │
│  │  character_id     UUID FK NOT NULL  │                               │
│  │  amount           INT NOT NULL      │                               │
│  │  source           VARCHAR(50) NN    │                               │
│  │  resist_dc        INT               │                               │
│  │  resisted         BOOLEAN DEFAULT   │                               │
│  │                   false             │                               │
│  │  final_amount     INT NOT NULL      │                               │
│  │  previous_stress  INT NOT NULL      │                               │
│  │  new_stress       INT NOT NULL      │                               │
│  │  threshold_crossed VARCHAR(20)      │                               │
│  │  created_at       TIMESTAMP DEFAULT │                               │
│  │                   CURRENT_TIMESTAMP │                               │
│  └─────────────────────────────────────┘                               │
│              │                                                          │
│              │ INDEX                                                    │
│              ▼                                                          │
│  ┌─────────────────────────────────────┐                               │
│  │  idx_stress_history_character_id    │                               │
│  │  (character_id, created_at DESC)    │                               │
│  └─────────────────────────────────────┘                               │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

### 3.3 Data Flow Diagram

```
┌────────────────────────────────────────────────────────────────────────┐
│                     ApplyStress Data Flow                               │
└────────────────────────────────────────────────────────────────────────┘

            ApplyStress(characterId, amount, source, resistDc)
                                    │
                                    ▼
                    ┌───────────────────────────────┐
                    │  1. StressService processes   │
                    │     stress application        │
                    └───────────────┬───────────────┘
                                    │
                          ┌─────────┴─────────┐
                          │                   │
                          ▼                   ▼
            ┌────────────────────┐   ┌───────────────────┐
            │ 2a. Update Char    │   │ 2b. Create History│
            │    Stress Value    │   │    Entry          │
            │                    │   │                   │
            │ UPDATE character_  │   │ StressHistoryEntry│
            │   resources        │   │  .Create(...)     │
            │ SET psychic_stress │   │                   │
            │   = {newStress}    │   │                   │
            └────────┬───────────┘   └─────────┬─────────┘
                     │                         │
                     │                         │
                     ▼                         ▼
            ┌────────────────────────────────────────────┐
            │  3. Repository.Update(character)           │
            │     Repository.Add(historyEntry)           │
            └────────────────────┬───────────────────────┘
                                 │
                                 ▼
            ┌────────────────────────────────────────────┐
            │  4. Database Transaction Completes         │
            │     - character_resources updated          │
            │     - stress_history row inserted          │
            └────────────────────────────────────────────┘
```

---

## 4. User Stories

### US-18f-1: Persist Stress State

**As a** player
**I want to** have my stress level saved
**So that** it persists between game sessions

**Acceptance Criteria:**

- Stress stored in character resources
- Value restored on character load
- Constraint prevents invalid values

### US-18f-2: Track Stress History

**As a** game designer
**I want to** see a history of stress events
**So that** I can analyze game balance

**Acceptance Criteria:**

- All stress applications logged
- Resistance attempts recorded
- Threshold crossings tracked

### US-18f-3: Query Recent Stress Events

**As a** developer
**I want to** query recent stress events
**So that** I can display stress activity UI

**Acceptance Criteria:**

- Query by character ID
- Support limit parameter
- Ordered by most recent first

---

## 5. Database Schema Changes

### 5.1 Migration File

**File:** `src/Infrastructure/RuneAndRust.Infrastructure/Migrations/YYYYMMDD_AddPsychicStress.cs`

```csharp
namespace RuneAndRust.Infrastructure.Migrations;

using Microsoft.EntityFrameworkCore.Migrations;

/// <summary>
/// Adds Psychic Stress column and history tracking table.
/// </summary>
public partial class AddPsychicStress : Migration
{
    /// <inheritdoc/>
    protected override void Up(MigrationBuilder migrationBuilder)
    {
        // Add psychic_stress column to character_resources
        migrationBuilder.AddColumn<int>(
            name: "psychic_stress",
            table: "character_resources",
            type: "integer",
            nullable: false,
            defaultValue: 0);

        // Add CHECK constraint for valid stress range
        migrationBuilder.Sql(@"
            ALTER TABLE character_resources
            ADD CONSTRAINT chk_psychic_stress
            CHECK (psychic_stress >= 0 AND psychic_stress <= 100);
        ");

        // Create stress_history table
        migrationBuilder.CreateTable(
            name: "stress_history",
            columns: table => new
            {
                id = table.Column<Guid>(type: "uuid", nullable: false),
                character_id = table.Column<Guid>(type: "uuid", nullable: false),
                amount = table.Column<int>(type: "integer", nullable: false),
                source = table.Column<string>(type: "varchar(50)", maxLength: 50, nullable: false),
                resist_dc = table.Column<int>(type: "integer", nullable: true),
                resisted = table.Column<bool>(type: "boolean", nullable: false, defaultValue: false),
                final_amount = table.Column<int>(type: "integer", nullable: false),
                previous_stress = table.Column<int>(type: "integer", nullable: false),
                new_stress = table.Column<int>(type: "integer", nullable: false),
                threshold_crossed = table.Column<string>(type: "varchar(20)", maxLength: 20, nullable: true),
                created_at = table.Column<DateTime>(type: "timestamp", nullable: false, defaultValueSql: "CURRENT_TIMESTAMP")
            },
            constraints: table =>
            {
                table.PrimaryKey("pk_stress_history", x => x.id);
                table.ForeignKey(
                    name: "fk_stress_history_characters",
                    column: x => x.character_id,
                    principalTable: "characters",
                    principalColumn: "id",
                    onDelete: ReferentialAction.Cascade);
            });

        // Create index for efficient queries by character
        migrationBuilder.CreateIndex(
            name: "idx_stress_history_character_id",
            table: "stress_history",
            columns: new[] { "character_id", "created_at" });
    }

    /// <inheritdoc/>
    protected override void Down(MigrationBuilder migrationBuilder)
    {
        // Drop stress_history table
        migrationBuilder.DropTable(name: "stress_history");

        // Drop CHECK constraint
        migrationBuilder.Sql(@"
            ALTER TABLE character_resources
            DROP CONSTRAINT IF EXISTS chk_psychic_stress;
        ");

        // Remove psychic_stress column
        migrationBuilder.DropColumn(
            name: "psychic_stress",
            table: "character_resources");
    }
}
```

### 5.2 SQL Equivalent

```sql
-- Add psychic_stress column to character_resources
ALTER TABLE character_resources
ADD COLUMN psychic_stress INT NOT NULL DEFAULT 0
CONSTRAINT chk_psychic_stress CHECK (psychic_stress >= 0 AND psychic_stress <= 100);

-- Create stress_history table
CREATE TABLE stress_history (
    id UUID PRIMARY KEY,
    character_id UUID NOT NULL REFERENCES characters(id) ON DELETE CASCADE,
    amount INT NOT NULL,
    source VARCHAR(50) NOT NULL,
    resist_dc INT,
    resisted BOOLEAN NOT NULL DEFAULT false,
    final_amount INT NOT NULL,
    previous_stress INT NOT NULL,
    new_stress INT NOT NULL,
    threshold_crossed VARCHAR(20),
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP
);

-- Create index for efficient queries
CREATE INDEX idx_stress_history_character_id
ON stress_history (character_id, created_at DESC);
```

---

## 6. Domain Entity

### 6.1 StressHistoryEntry

**File:** `src/Core/RuneAndRust.Domain/Entities/StressHistoryEntry.cs`

```csharp
namespace RuneAndRust.Domain.Entities;

using RuneAndRust.Domain.Enums;
using RuneAndRust.Domain.Interfaces;

/// <summary>
/// Entity representing a single stress event in the character's history.
/// </summary>
/// <remarks>
/// <para>
/// Records all stress applications for analytics and debugging.
/// Each entry captures:
/// <list type="bullet">
/// <item>Original stress amount and source</item>
/// <item>Resistance check details (if any)</item>
/// <item>Before/after stress values</item>
/// <item>Threshold crossings</item>
/// </list>
/// </para>
/// </remarks>
public class StressHistoryEntry : IEntity
{
    #region Properties

    /// <summary>
    /// Gets the unique identifier for this history entry.
    /// </summary>
    public Guid Id { get; private set; }

    /// <summary>
    /// Gets the character this stress event applies to.
    /// </summary>
    public Guid CharacterId { get; private set; }

    /// <summary>
    /// Gets the original stress amount before resistance.
    /// </summary>
    public int Amount { get; private set; }

    /// <summary>
    /// Gets the source category of the stress.
    /// </summary>
    public StressSource Source { get; private set; }

    /// <summary>
    /// Gets the resistance DC if a check was attempted.
    /// </summary>
    /// <remarks>
    /// Null if no resistance check was allowed.
    /// </remarks>
    public int? ResistDc { get; private set; }

    /// <summary>
    /// Gets whether any stress was resisted.
    /// </summary>
    public bool Resisted { get; private set; }

    /// <summary>
    /// Gets the final stress amount after resistance reduction.
    /// </summary>
    public int FinalAmount { get; private set; }

    /// <summary>
    /// Gets the character's stress before this event.
    /// </summary>
    public int PreviousStress { get; private set; }

    /// <summary>
    /// Gets the character's stress after this event.
    /// </summary>
    public int NewStress { get; private set; }

    /// <summary>
    /// Gets the threshold crossed, if any.
    /// </summary>
    /// <remarks>
    /// Null if no threshold was crossed.
    /// </remarks>
    public StressThreshold? ThresholdCrossed { get; private set; }

    /// <summary>
    /// Gets when this stress event occurred.
    /// </summary>
    public DateTime CreatedAt { get; private set; }

    #endregion

    #region Constructors

    /// <summary>
    /// Private constructor for EF Core.
    /// </summary>
    private StressHistoryEntry()
    {
    }

    #endregion

    #region Factory Methods

    /// <summary>
    /// Creates a new stress history entry from an application result.
    /// </summary>
    /// <param name="characterId">The character ID.</param>
    /// <param name="result">The stress application result.</param>
    /// <returns>A new <see cref="StressHistoryEntry"/>.</returns>
    public static StressHistoryEntry FromApplicationResult(
        Guid characterId,
        StressApplicationResult result)
    {
        ArgumentNullException.ThrowIfNull(result);

        return new StressHistoryEntry
        {
            Id = Guid.NewGuid(),
            CharacterId = characterId,
            Amount = result.ResistanceResult?.BaseStress ?? result.StressGained,
            Source = result.Source,
            ResistDc = result.ResistanceResult?.Successes > 0
                ? (int?)result.ResistanceResult?.Successes
                : null,
            Resisted = result.ResistanceResult?.ReductionPercent > 0,
            FinalAmount = result.StressGained,
            PreviousStress = result.PreviousStress,
            NewStress = result.NewStress,
            ThresholdCrossed = result.ThresholdCrossed
                ? result.NewThreshold
                : null,
            CreatedAt = DateTime.UtcNow
        };
    }

    /// <summary>
    /// Creates a new stress history entry manually.
    /// </summary>
    /// <param name="characterId">The character ID.</param>
    /// <param name="amount">Original stress amount.</param>
    /// <param name="source">Stress source category.</param>
    /// <param name="resistDc">Optional resistance DC.</param>
    /// <param name="resisted">Whether any stress was resisted.</param>
    /// <param name="finalAmount">Final stress after resistance.</param>
    /// <param name="previousStress">Stress before event.</param>
    /// <param name="newStress">Stress after event.</param>
    /// <param name="thresholdCrossed">Optional crossed threshold.</param>
    /// <returns>A new <see cref="StressHistoryEntry"/>.</returns>
    public static StressHistoryEntry Create(
        Guid characterId,
        int amount,
        StressSource source,
        int? resistDc,
        bool resisted,
        int finalAmount,
        int previousStress,
        int newStress,
        StressThreshold? thresholdCrossed = null)
    {
        return new StressHistoryEntry
        {
            Id = Guid.NewGuid(),
            CharacterId = characterId,
            Amount = amount,
            Source = source,
            ResistDc = resistDc,
            Resisted = resisted,
            FinalAmount = finalAmount,
            PreviousStress = previousStress,
            NewStress = newStress,
            ThresholdCrossed = thresholdCrossed,
            CreatedAt = DateTime.UtcNow
        };
    }

    #endregion
}
```

---

## 7. Repository Integration

### 7.1 IStressHistoryRepository Interface

**File:** `src/Core/RuneAndRust.Application/Interfaces/IStressHistoryRepository.cs`

```csharp
namespace RuneAndRust.Application.Interfaces;

using RuneAndRust.Domain.Entities;

/// <summary>
/// Repository interface for stress history operations.
/// </summary>
public interface IStressHistoryRepository
{
    /// <summary>
    /// Adds a new stress history entry.
    /// </summary>
    /// <param name="entry">The history entry to add.</param>
    void Add(StressHistoryEntry entry);

    /// <summary>
    /// Gets all stress history entries for a character.
    /// </summary>
    /// <param name="characterId">The character's unique identifier.</param>
    /// <returns>
    /// All history entries for the character, ordered by most recent first.
    /// </returns>
    IReadOnlyList<StressHistoryEntry> GetByCharacterId(Guid characterId);

    /// <summary>
    /// Gets the most recent stress history entries for a character.
    /// </summary>
    /// <param name="characterId">The character's unique identifier.</param>
    /// <param name="limit">Maximum number of entries to return.</param>
    /// <returns>
    /// The most recent history entries, up to the specified limit.
    /// </returns>
    IReadOnlyList<StressHistoryEntry> GetByCharacterId(Guid characterId, int limit);
}
```

### 7.2 EF Core Configuration

**File:** `src/Infrastructure/RuneAndRust.Infrastructure/Data/Configurations/StressHistoryEntryConfiguration.cs`

```csharp
namespace RuneAndRust.Infrastructure.Data.Configurations;

using Microsoft.EntityFrameworkCore;
using Microsoft.EntityFrameworkCore.Metadata.Builders;
using RuneAndRust.Domain.Entities;
using RuneAndRust.Domain.Enums;

/// <summary>
/// EF Core configuration for <see cref="StressHistoryEntry"/>.
/// </summary>
public class StressHistoryEntryConfiguration : IEntityTypeConfiguration<StressHistoryEntry>
{
    /// <inheritdoc/>
    public void Configure(EntityTypeBuilder<StressHistoryEntry> builder)
    {
        builder.ToTable("stress_history");

        builder.HasKey(e => e.Id);

        builder.Property(e => e.Id)
            .HasColumnName("id");

        builder.Property(e => e.CharacterId)
            .HasColumnName("character_id")
            .IsRequired();

        builder.Property(e => e.Amount)
            .HasColumnName("amount")
            .IsRequired();

        builder.Property(e => e.Source)
            .HasColumnName("source")
            .HasMaxLength(50)
            .HasConversion(
                v => v.ToString(),
                v => Enum.Parse<StressSource>(v))
            .IsRequired();

        builder.Property(e => e.ResistDc)
            .HasColumnName("resist_dc");

        builder.Property(e => e.Resisted)
            .HasColumnName("resisted")
            .HasDefaultValue(false);

        builder.Property(e => e.FinalAmount)
            .HasColumnName("final_amount")
            .IsRequired();

        builder.Property(e => e.PreviousStress)
            .HasColumnName("previous_stress")
            .IsRequired();

        builder.Property(e => e.NewStress)
            .HasColumnName("new_stress")
            .IsRequired();

        builder.Property(e => e.ThresholdCrossed)
            .HasColumnName("threshold_crossed")
            .HasMaxLength(20)
            .HasConversion(
                v => v.HasValue ? v.Value.ToString() : null,
                v => v != null ? Enum.Parse<StressThreshold>(v) : null);

        builder.Property(e => e.CreatedAt)
            .HasColumnName("created_at")
            .HasDefaultValueSql("CURRENT_TIMESTAMP")
            .IsRequired();

        // Index for efficient queries
        builder.HasIndex(e => new { e.CharacterId, e.CreatedAt })
            .HasDatabaseName("idx_stress_history_character_id");

        // Foreign key
        builder.HasOne<Character>()
            .WithMany()
            .HasForeignKey(e => e.CharacterId)
            .OnDelete(DeleteBehavior.Cascade);
    }
}
```

---

## 8. Logging Specifications

### 8.1 Log Events

| Event                 | Level       | Template                                                                |
| --------------------- | ----------- | ----------------------------------------------------------------------- |
| History Entry Created | Debug       | `"Stress history entry created: {EntryId} for character {CharacterId}"` |
| History Entry Saved   | Debug       | `"Stress history saved: {Source} {Amount} → {FinalAmount}"`             |
| History Query         | Debug       | `"Querying stress history for {CharacterId}, limit: {Limit}"`           |
| History Retrieved     | Debug       | `"Retrieved {Count} stress history entries for {CharacterId}"`          |
| Migration Applied     | Information | `"Applied migration: AddPsychicStress"`                                 |

### 8.2 Example Log Output

```
[10:30:15 DBG] Stress history entry created: a1b2c3d4 for character e5f6g7h8
[10:30:15 DBG] Stress history saved: Combat 20 → 5
[10:35:00 DBG] Querying stress history for e5f6g7h8, limit: 10
[10:35:00 DBG] Retrieved 5 stress history entries for e5f6g7h8
```

---

## 9. Unit Testing Requirements

### 9.1 Test Count by Feature

| Feature                     | Test Count |
| --------------------------- | ---------- |
| StressHistoryEntry Creation | ~1         |
| Repository Integration      | ~1         |
| **Total**                   | **~2**     |

### 9.2 StressHistoryEntryTests

**File:** `tests/RuneAndRust.Domain.UnitTests/Entities/StressHistoryEntryTests.cs`

```csharp
namespace RuneAndRust.Domain.UnitTests.Entities;

using FluentAssertions;
using NUnit.Framework;
using RuneAndRust.Domain.Entities;
using RuneAndRust.Domain.Enums;
using RuneAndRust.Domain.ValueObjects;

[TestFixture]
public class StressHistoryEntryTests
{
    [Test]
    public void FromApplicationResult_CreatesCorrectEntry()
    {
        // Arrange
        var characterId = Guid.NewGuid();
        var result = StressApplicationResult.Create(
            previousStress: 35,
            newStress: 55,
            source: StressSource.Combat,
            resistanceResult: null);

        // Act
        var entry = StressHistoryEntry.FromApplicationResult(characterId, result);

        // Assert
        entry.CharacterId.Should().Be(characterId);
        entry.Amount.Should().Be(20);
        entry.Source.Should().Be(StressSource.Combat);
        entry.PreviousStress.Should().Be(35);
        entry.NewStress.Should().Be(55);
        entry.FinalAmount.Should().Be(20);
        entry.Resisted.Should().BeFalse();
        entry.CreatedAt.Should().BeCloseTo(DateTime.UtcNow, TimeSpan.FromSeconds(1));
    }

    [Test]
    public void Create_WithThresholdCrossed_RecordsThreshold()
    {
        // Arrange
        var characterId = Guid.NewGuid();

        // Act
        var entry = StressHistoryEntry.Create(
            characterId,
            amount: 25,
            source: StressSource.Heretical,
            resistDc: 3,
            resisted: true,
            finalAmount: 6,
            previousStress: 75,
            newStress: 81,
            thresholdCrossed: StressThreshold.Breaking);

        // Assert
        entry.ThresholdCrossed.Should().Be(StressThreshold.Breaking);
        entry.Resisted.Should().BeTrue();
        entry.ResistDc.Should().Be(3);
    }
}
```

---

## 10. Use Cases

### UC-001: Persist Stress on Application

**Actor:** StressService
**Flow:** Apply stress → Create history entry → Save to database
**Precondition:** Character exists in database
**Postcondition:** Character stress updated, history entry created

### UC-002: Load Character with Stress

**Actor:** GameSession
**Flow:** Load character → Retrieve psychic_stress → Create StressState
**Precondition:** Character saved with stress value
**Postcondition:** Stress state restored correctly

### UC-003: Query Stress Activity

**Actor:** UI/Analytics
**Flow:** Request history → Query by character ID → Return entries
**Precondition:** History entries exist
**Postcondition:** Recent history returned ordered by date

---

## 11. Deliverable Checklist

### Database

- [x] Migration file: `YYYYMMDD_AddPsychicStress.cs` (deferred — no migration infrastructure exists in codebase)

### Domain Layer

- [x] `src/Core/RuneAndRust.Domain/Entities/StressHistoryEntry.cs`

### Application Layer

- [x] `src/Core/RuneAndRust.Application/Interfaces/IStressHistoryRepository.cs`

### Infrastructure Layer

- [x] `src/Infrastructure/RuneAndRust.Infrastructure/Persistence/Configurations/StressHistoryEntryConfiguration.cs` (codebase convention path)
- [x] `src/Infrastructure/RuneAndRust.Infrastructure/Repositories/InMemoryStressHistoryRepository.cs` (in-memory implementation per codebase convention)

### Unit Tests

- [x] `tests/RuneAndRust.Domain.UnitTests/Entities/StressHistoryEntryTests.cs` (30 tests)

---

## 12. Acceptance Criteria

### Functional Criteria

- [x] `psychic_stress` column added to `character_resources` (deferred — Player.PsychicStress already persisted via InMemoryPlayerRepository)
- [x] CHECK constraint enforces 0-100 range (deferred — Player.SetPsychicStress() clamps to [0, 100])
- [x] `stress_history` table created with all columns (EF Core configuration created; migration deferred)
- [x] Index on `(character_id, created_at)` created (EF Core configuration: IX_StressHistory_CharacterCreatedAt)
- [x] `StressHistoryEntry` records stress applications (entity with FromApplicationResult and Create factories)
- [x] History entries include resistance check details (ResistDc, Resisted, Amount vs FinalAmount)
- [x] Threshold crossings recorded in history (ThresholdCrossed nullable property)
- [x] History queryable by character ID (IStressHistoryRepository.GetByCharacterIdAsync with optional limit)

### Quality Criteria

- [x] Build succeeds with 0 errors
- [x] Build succeeds with 0 warnings
- [x] All ~2 unit tests pass (30 actual)
- [x] Migration applies successfully (deferred — no migration infrastructure exists)
- [x] Migration rollback works correctly (deferred — no migration infrastructure exists)
- [x] XML documentation complete

---

## 13. Dependencies

### Required from v0.18.0a

| Type              | Usage                              |
| ----------------- | ---------------------------------- |
| `StressSource`    | Column value for source            |
| `StressThreshold` | Column value for threshold_crossed |

### Required from v0.18.0b

| Type                      | Usage                                    |
| ------------------------- | ---------------------------------------- |
| `StressApplicationResult` | Input to `FromApplicationResult` factory |

### Required from v0.18.0d

| Type            | Usage                                   |
| --------------- | --------------------------------------- |
| `StressService` | Integration point for history recording |

### Required Infrastructure

| Type         | Usage             |
| ------------ | ----------------- |
| `EF Core`    | Migration and ORM |
| `PostgreSQL` | Database engine   |

### Provides to Consumers

| Consumer  | Usage                        |
| --------- | ---------------------------- |
| Analytics | Query historical stress data |
| UI        | Display stress activity feed |
| Debugging | Trace stress changes         |

---

## 14. Future Considerations

### Deferred to Later Versions

- Analytics dashboard for stress patterns
- Stress event aggregation (daily/session totals)
- Stress prediction based on history
- History cleanup/archival for old characters

### Out of Scope

- Real-time analytics
- Cross-character stress comparisons
- Machine learning on stress patterns

---

_Document Version: 1.0_
_Last Updated: 2026-01-27_
