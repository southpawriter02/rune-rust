# Design Specification: v0.20.6a - Bone-Setter Framework & Tier 1 Abilities

**Version:** v0.20.6a
**Status:** Design Phase
**Last Updated:** 2026-01-28
**Target Tests:** ~10 unit and integration tests
**Specialization:** Bone-Setter
**Path Type:** Coherent (NO Corruption risk)
**Archetype:** Adept

---

## Table of Contents

1. [Executive Summary](#1-executive-summary)
2. [Specialization Overview](#2-specialization-overview)
3. [Architecture Diagrams](#3-architecture-diagrams)
4. [Domain Model Specifications](#4-domain-model-specifications)
5. [Medical Supplies Resource System](#5-medical-supplies-resource-system)
6. [Field Dressing Ability Specification](#6-field-dressing-ability-specification)
7. [Diagnose Ability Specification](#7-diagnose-ability-specification)
8. [Steady Hands Ability Specification](#8-steady-hands-ability-specification)
9. [User Stories & Scenarios](#9-user-stories--scenarios)
10. [Application Service Layer](#10-application-service-layer)
11. [Configuration Specifications](#11-configuration-specifications)
12. [Command Examples & Output](#12-command-examples--output)
13. [State Machine Diagrams](#13-state-machine-diagrams)
14. [Logging Specifications](#14-logging-specifications)
15. [Unit Testing Requirements](#15-unit-testing-requirements)
16. [Deliverable Checklist](#16-deliverable-checklist)
17. [Acceptance Criteria](#17-acceptance-criteria)
18. [Dependencies & Prerequisites](#18-dependencies--prerequisites)
19. [Design Decisions & Rationale](#19-design-decisions--rationale)

---

## 1. Executive Summary

Version 0.20.6a introduces the **Bone-Setter** specialization framework, establishing the **first dedicated healing specialization** and the **first Coherent path** in the v0.20.x series. This phase focuses on:

- **Medical Supplies Resource:** A consumable, inventory-based resource representing salvaged medical materials (Bandage, Salve, Splint, Suture, Herbs, Antidote, Stimulant)
- **No Corruption Risk:** Coherent path ensures all healing abilities carry zero Corruption penalty regardless of context
- **Tier 1 Healing Abilities (3):** Field Dressing (HP recovery), Diagnose (enemy assessment), Steady Hands (passive enhancement)
- **Medical Supply Quality System:** Supplies have 1-5 quality rating affecting healing effectiveness

### Key Deliverables

| Category | Count | Details |
|----------|-------|---------|
| **Domain Value Objects** | 4 | MedicalSuppliesResource, MedicalSupplyItem, FieldDressingResult, DiagnoseResult |
| **Domain Enums** | 3 | BoneSetterAbilityId, MedicalSupplyType, WoundSeverity |
| **Application Services** | 2 | MedicalSuppliesService, BoneSetterAbilityService |
| **Ability Implementations** | 3 | Field Dressing, Diagnose, Steady Hands |
| **Configuration Files** | 2 | specializations.json (Bone-Setter entry), abilities.json (Tier 1) |
| **Unit Tests** | ~10 | Comprehensive coverage of services and abilities |

### Specialization Profile

| Attribute | Value |
|-----------|-------|
| **Display Name** | Bone-Setter |
| **Pronunciation** | BONE-set-ur |
| **Translation** | Traditional Healer / Physician |
| **Archetype** | Adept |
| **Path Type** | Coherent |
| **Role** | Healer / Medicine / Trauma Care |
| **Special Resource** | Medical Supplies (Consumable Inventory) |
| **Resource Max** | 10 items (stackable by type) |
| **Tagline** | "Keeper of Life" |
| **Unlock Cost** | 0 PP (immediately available after Adept selection) |

---

## 2. Specialization Overview

### 2.1 Thematic Foundation

The Bone-Setter represents the practical, grounded approach to survival in Aethelgard. While others channel dark powers or ancient magic, the Bone-Setter relies on knowledge, skill, and medical supplies salvaged from the World-Machine's ruins. They are the ones who patch wounds after battle, cure poisons, and drag allies back from the brink of death. In a world where Corruption threatens those who seek power through Heretical means, the Bone-Setter offers a safe, reliable path to keeping others alive.

**Thematic Anchor:** "The body knows how to heal. I merely remind it."

**Design Principles:**

1. **Coherent Safety:** No Corruption risk — healing through skill, not dark power
2. **Resource Management:** Medical Supplies are consumable and must be replenished
3. **Party Support Focus:** Most abilities benefit allies, not self
4. **Condition Removal:** Specializes in curing negative status effects (v0.20.6b+)
5. **First Dedicated Healer:** Establishes healing patterns for future support specializations
6. **Quality Scaling:** Supply quality directly affects healing effectiveness

### 2.2 Tier 1 Identity

**Tier 1 Abilities (Immediately Available):**

| Ability | Type | AP Cost | Resource Cost | Range | Effect |
|---------|------|---------|---------------|-------|--------|
| Field Dressing | Active | 2 AP | 1 Medical Supply | 3 spaces | Heal 2d6 + bonuses to single target |
| Diagnose | Active | 1 AP | None | 5 spaces | Reveal target's HP, status, vulnerabilities |
| Steady Hands | Passive | — | — | — | +2 bonus to all medical ability healing |

**Mechanical Focus:** Foundation abilities establish core healing identity through direct HP recovery and tactical information gathering.

### 2.3 Coherent Path Characteristics

As a Coherent path specialization, Bone-Setter has **no Corruption risk**:

| Scenario | Corruption Risk |
|----------|---|
| Using Field Dressing on any target | None |
| Using Diagnose on enemies | None |
| Using abilities in Heretical territory | None |
| Using abilities against Heretical allies | None |
| Running out of Medical Supplies | None |

This is a defining feature: healing is **always safe** from a Corruption perspective.

---

## 3. Architecture Diagrams

### 3.1 System Architecture Overview

```
┌─────────────────────────────────────────────────────────────────┐
│                    Bone-Setter Specialization                    │
└─────────────────────────────────────────────────────────────────┘
                              │
                ┌─────────────┼─────────────┐
                │             │             │
        ┌───────▼────────┐  ┌▼──────────┐  ┌▼──────────┐
        │  Field Dressing│  │ Diagnose  │  │Steady Hand│
        │   (Active)     │  │ (Active)  │  │(Passive)  │
        └────────────────┘  └───────────┘  └───────────┘
                │             │             │
                └─────────────┼─────────────┘
                              │
                    ┌─────────▼────────┐
                    │ BoneSetterAbility │
                    │    Service        │
                    └──────────────────┘
                              │
        ┌─────────────────────┼─────────────────────┐
        │                     │                     │
    ┌───▼──────────┐  ┌──────▼────────┐  ┌────────▼────┐
    │   Medical    │  │  Ability      │  │  Character  │
    │  Supplies    │  │  Execution    │  │  State Sync │
    │  Service     │  │  Pipeline     │  │             │
    └──────────────┘  └───────────────┘  └─────────────┘
              │
    ┌─────────▼──────────────┐
    │ Medical Supplies       │
    │ Resource Manager       │
    │                        │
    │ • Track inventory      │
    │ • Validate availability│
    │ • Apply quality bonuses│
    │ • Calculate healing    │
    └────────────────────────┘
```

### 3.2 Medical Supplies Lifecycle

```
┌──────────────┐
│   Salvaged   │
│   from Loot  │
└────────┬─────┘
         │
         │ Add to Inventory
         │
    ┌────▼──────────────┐
    │  Medical Supplies  │
    │  Inventory (Max 10)│
    └────┬───────────────┘
         │
    ┌────┴─────────────────────────────┐
    │                                   │
    │ On Ability Use                    │
    │ (Field Dressing)                  │
    │                                   │
    ├─ Check availability               │
    ├─ Consume 1 supply                 │
    ├─ Apply quality bonus              │
    ├─ Calculate healing                │
    ├─ Update inventory                 │
    └─ Return to player                 │
         │
         │ Supply exhausted
         │
    ┌────▼─────────────┐
    │  Acquire more    │
    │  via salvage or  │
    │  commerce (v0.21)│
    └──────────────────┘
```

### 3.3 Clean Architecture Layers

```
PRESENTATION LAYER
│
├─ CharacterStatusDisplay (shows medical supplies)
├─ HealingResultsFormatter (displays Field Dressing output)
└─ DiagnoseOutputFormatter (displays enemy analysis)
                    │
                    ▼
APPLICATION LAYER
│
├─ BoneSetterAbilityService
│  ├─ ExecuteFieldDressing()
│  ├─ ExecuteDiagnose()
│  └─ GetAbilityState()
│
└─ MedicalSuppliesService
   ├─ SpendSupply()
   ├─ AddSupply()
   ├─ ValidateSupplyAvailability()
   └─ CalculateHealingWithQuality()
                    │
                    ▼
DOMAIN LAYER
│
├─ MedicalSuppliesResource (Value Object)
├─ MedicalSupplyItem (Value Object)
├─ FieldDressingResult (Value Object)
├─ DiagnoseResult (Value Object)
├─ BoneSetterAbilityId (Enum)
├─ MedicalSupplyType (Enum)
└─ WoundSeverity (Enum)
                    │
                    ▼
INFRASTRUCTURE LAYER
│
├─ JSON Configuration
│  ├─ specializations.json
│  └─ abilities.json
│
├─ Character State Persistence
├─ Inventory Management
└─ Logging & Telemetry
```

---

## 4. Domain Model Specifications

### 4.1 Enumerations

#### BoneSetterAbilityId

```csharp
/// <summary>
/// Enumeration of all Bone-Setter ability identifiers for v0.20.6a-c.
/// Used for ability lookup, configuration, and ability slot assignment.
/// </summary>
public enum BoneSetterAbilityId
{
    /// <summary>
    /// Tier 1: Field Dressing - Heal 2d6 HP by consuming 1 Medical Supply
    /// </summary>
    FieldDressing = 600,

    /// <summary>
    /// Tier 1: Diagnose - Reveal target HP and status effects (no cost)
    /// </summary>
    Diagnose = 601,

    /// <summary>
    /// Tier 1: Steady Hands - Passive +2 to all medical ability healing
    /// </summary>
    SteadyHands = 602,

    /// <summary>
    /// Tier 2: Emergency Surgery - Heal 4d6 to Recovering targets
    /// </summary>
    EmergencySurgery = 603,

    /// <summary>
    /// Tier 2: Antidote Craft - Create Antidote from Herbs + salvage material
    /// </summary>
    AntidoteCraft = 604,

    /// <summary>
    /// Tier 2: Triage - Bonus healing to most wounded target in radius
    /// </summary>
    Triage = 605,

    /// <summary>
    /// Tier 3: Resuscitate - Revive unconscious ally to 1 HP
    /// </summary>
    Resuscitate = 606,

    /// <summary>
    /// Tier 3: Preventive Care - Passive +1 poison/disease saves aura
    /// </summary>
    PreventiveCare = 607,

    /// <summary>
    /// Capstone: Miracle Worker - Full heal + clear conditions (once/long rest)
    /// </summary>
    MiracleWorker = 608
}
```

#### MedicalSupplyType

```csharp
/// <summary>
/// Enumeration of all Medical Supply item types.
/// Supplies are consumable inventory items with quality-based bonuses.
/// </summary>
public enum MedicalSupplyType
{
    /// <summary>
    /// Bandage - Basic wound treatment. Quality bonus: 1d2
    /// Used by Field Dressing (default supply type).
    /// </summary>
    Bandage = 0,

    /// <summary>
    /// Salve - Topical healing cream. Quality bonus: 1d3
    /// Effective for skin and surface wounds.
    /// </summary>
    Salve = 1,

    /// <summary>
    /// Splint - Bone and joint stabilization. Quality bonus: 1d4
    /// Used for structural injuries.
    /// </summary>
    Splint = 2,

    /// <summary>
    /// Suture - Wound closure materials. Quality bonus: 1d5
    /// Used for deep lacerations and surgical closures.
    /// </summary>
    Suture = 3,

    /// <summary>
    /// Herbs - Plant-based remedies. Quality bonus: 1d6
    /// Used for Antidote Craft (v0.20.6b).
    /// </summary>
    Herbs = 4,

    /// <summary>
    /// Antidote - Poison/disease treatment (crafted in v0.20.6b).
    /// Applied as cure effect, not consumed by Field Dressing.
    /// </summary>
    Antidote = 5,

    /// <summary>
    /// Stimulant - Combat stimulant (crafted or salvaged).
    /// Temporary combat buff (future implementation).
    /// </summary>
    Stimulant = 6
}
```

#### WoundSeverity

```csharp
/// <summary>
/// Classification of wound severity based on HP loss percentage.
/// Used by Diagnose ability to categorize target health status.
/// </summary>
public enum WoundSeverity
{
    /// <summary>
    /// Target at 90-100% HP: Minor scratches and bruises
    /// </summary>
    Minor = 0,

    /// <summary>
    /// Target at 70-89% HP: Small cuts and light wounds
    /// </summary>
    Light = 1,

    /// <summary>
    /// Target at 40-69% HP: Moderate wounds requiring attention
    /// </summary>
    Moderate = 2,

    /// <summary>
    /// Target at 15-39% HP: Serious wounds, high priority
    /// </summary>
    Serious = 3,

    /// <summary>
    /// Target at 1-14% HP: Critical condition, death imminent
    /// </summary>
    Critical = 4,

    /// <summary>
    /// Target at 0 HP: Unconscious/Stable (conditions apply)
    /// </summary>
    Unconscious = 5
}
```

### 4.2 Value Objects

#### MedicalSupplyItem

```csharp
/// <summary>
/// Represents a single Medical Supply item in inventory.
/// Immutable value object with quality scaling.
/// </summary>
public sealed class MedicalSupplyItem : ValueObject
{
    /// <summary>
    /// Unique identifier for this specific supply item instance.
    /// </summary>
    public Guid ItemId { get; }

    /// <summary>
    /// Type classification of this supply (Bandage, Salve, etc.).
    /// </summary>
    public MedicalSupplyType SupplyType { get; }

    /// <summary>
    /// Human-readable name (e.g., "Reinforced Bandage", "Potent Herbs").
    /// Includes quality indicator.
    /// </summary>
    public string Name { get; }

    /// <summary>
    /// Detailed description of supply origin and properties.
    /// </summary>
    public string Description { get; }

    /// <summary>
    /// Quality rating from 1 (poor salvage) to 5 (pristine/crafted).
    /// Directly affects healing bonus calculation.
    /// Formula: Healing bonus = Quality - 1 (0-4 bonus)
    /// </summary>
    public int Quality { get; }

    /// <summary>
    /// Timestamp when this supply was acquired.
    /// Used for tracking inventory age and potential expiration (future).
    /// </summary>
    public DateTime AcquiredAt { get; }

    /// <summary>
    /// Source classification: "salvage", "purchase", "craft", "quest_reward"
    /// Used for audit trail and future restock mechanics.
    /// </summary>
    public string Source { get; }

    /// <summary>
    /// Constructor for creating a new Medical Supply item.
    /// </summary>
    public MedicalSupplyItem(
        Guid itemId,
        MedicalSupplyType supplyType,
        string name,
        string description,
        int quality,
        DateTime acquiredAt,
        string source)
    {
        if (string.IsNullOrWhiteSpace(name))
            throw new ArgumentException("Supply name cannot be empty.", nameof(name));

        if (quality < 1 || quality > 5)
            throw new ArgumentException("Supply quality must be between 1 and 5.", nameof(quality));

        if (string.IsNullOrWhiteSpace(source))
            throw new ArgumentException("Supply source cannot be empty.", nameof(source));

        ItemId = itemId;
        SupplyType = supplyType;
        Name = name;
        Description = description;
        Quality = quality;
        AcquiredAt = acquiredAt;
        Source = source;
    }

    /// <summary>
    /// Calculates the healing bonus provided by this supply's quality.
    /// Formula: Quality - 1
    /// Returns: 0 (poor) to 4 (pristine)
    /// </summary>
    public int GetHealingBonus() => Quality - 1;

    /// <summary>
    /// Returns formatted description with quality notation.
    /// Example: "Reinforced Bandage (Quality: ★★★★☆)"
    /// </summary>
    public string GetFormattedDescription()
    {
        var stars = string.Concat(Enumerable.Repeat("★", Quality));
        var empty = string.Concat(Enumerable.Repeat("☆", 5 - Quality));
        return $"{Name} (Quality: {stars}{empty})";
    }

    /// <summary>
    /// Determines if this supply is considered "expired" based on acquisition time.
    /// Currently always returns false; future implementation may check age.
    /// </summary>
    public bool IsExpired() => false;

    protected override IEnumerable<object> GetEqualityComponents()
    {
        yield return ItemId;
        yield return SupplyType;
        yield return Quality;
        yield return AcquiredAt;
    }
}
```

#### MedicalSuppliesResource

```csharp
/// <summary>
/// Represents the Bone-Setter's Medical Supplies inventory.
/// Immutable collection of consumable medical items with capacity limits.
/// </summary>
public sealed class MedicalSuppliesResource : ValueObject
{
    private readonly IReadOnlyList<MedicalSupplyItem> _supplies;

    /// <summary>
    /// Immutable collection of all Medical Supply items in inventory.
    /// </summary>
    public IReadOnlyList<MedicalSupplyItem> Supplies => _supplies;

    /// <summary>
    /// Maximum number of individual supply items that can be carried.
    /// Default: 10 items (stackable by type).
    /// </summary>
    public int MaxCarryCapacity { get; }

    /// <summary>
    /// Timestamp of the last time inventory was restocked/modified significantly.
    /// Used for audit and potential restock cooldown mechanics (future).
    /// </summary>
    public DateTime? LastRestockedAt { get; }

    /// <summary>
    /// Constructor for creating a new Medical Supplies resource.
    /// Initializes empty inventory with specified capacity.
    /// </summary>
    public MedicalSuppliesResource(
        IEnumerable<MedicalSupplyItem> supplies,
        int maxCarryCapacity = 10,
        DateTime? lastRestockedAt = null)
    {
        if (maxCarryCapacity < 1)
            throw new ArgumentException("Max carry capacity must be at least 1.", nameof(maxCarryCapacity));

        _supplies = supplies?.ToList().AsReadOnly() ?? new List<MedicalSupplyItem>().AsReadOnly();

        if (_supplies.Count > maxCarryCapacity)
            throw new ArgumentException(
                $"Supply count ({_supplies.Count}) exceeds max capacity ({maxCarryCapacity}).",
                nameof(supplies));

        MaxCarryCapacity = maxCarryCapacity;
        LastRestockedAt = lastRestockedAt;
    }

    /// <summary>
    /// Total count of all Medical Supply items in inventory.
    /// </summary>
    public int GetTotalSupplyCount() => _supplies.Count;

    /// <summary>
    /// Count of supplies of a specific type.
    /// </summary>
    public int GetCountByType(MedicalSupplyType type) =>
        _supplies.Count(s => s.SupplyType == type);

    /// <summary>
    /// Checks if at least one supply of the specified type exists.
    /// </summary>
    public bool HasSupply(MedicalSupplyType type) =>
        _supplies.Any(s => s.SupplyType == type);

    /// <summary>
    /// Checks if inventory can accommodate more items.
    /// </summary>
    public bool CanCarryMore() =>
        _supplies.Count < MaxCarryCapacity;

    /// <summary>
    /// Attempts to spend one supply of specified type.
    /// Returns new MedicalSuppliesResource with supply removed.
    /// Throws if supply type not available.
    /// </summary>
    public MedicalSuppliesResource SpendSupply(MedicalSupplyType type)
    {
        var supplyToRemove = _supplies.FirstOrDefault(s => s.SupplyType == type);
        if (supplyToRemove == null)
            throw new InvalidOperationException(
                $"No {type} available to spend. Current inventory: {GetInventorySummary()}");

        var newSupplies = _supplies.Where(s => s.ItemId != supplyToRemove.ItemId).ToList();
        return new MedicalSuppliesResource(
            newSupplies,
            MaxCarryCapacity,
            DateTime.UtcNow);
    }

    /// <summary>
    /// Attempts to add a new supply item to inventory.
    /// Returns new MedicalSuppliesResource with item added.
    /// Throws if inventory is full.
    /// </summary>
    public MedicalSuppliesResource AddSupply(MedicalSupplyItem item)
    {
        if (!CanCarryMore())
            throw new InvalidOperationException(
                $"Cannot add supply: inventory is full ({_supplies.Count}/{MaxCarryCapacity})");

        var newSupplies = new List<MedicalSupplyItem>(_supplies) { item };
        return new MedicalSuppliesResource(
            newSupplies,
            MaxCarryCapacity,
            DateTime.UtcNow);
    }

    /// <summary>
    /// Attempts to add multiple supplies at once.
    /// Returns new MedicalSuppliesResource and count of items actually added.
    /// Throws if no capacity available.
    /// </summary>
    public (MedicalSuppliesResource resource, int addedCount) AddMultipleSupplies(
        IEnumerable<MedicalSupplyItem> items)
    {
        var itemList = items.ToList();
        if (_supplies.Count + itemList.Count > MaxCarryCapacity)
            throw new InvalidOperationException(
                $"Cannot add {itemList.Count} items: would exceed capacity of {MaxCarryCapacity}");

        var newSupplies = new List<MedicalSupplyItem>(_supplies);
        newSupplies.AddRange(itemList);

        return (new MedicalSuppliesResource(newSupplies, MaxCarryCapacity, DateTime.UtcNow), itemList.Count);
    }

    /// <summary>
    /// Returns human-readable summary of current inventory.
    /// Example: "Bandage(3) + Salve(2) + Herbs(1) = 6/10"
    /// </summary>
    public string GetInventorySummary()
    {
        var groupedByType = _supplies
            .GroupBy(s => s.SupplyType)
            .OrderBy(g => g.Key)
            .Select(g => $"{g.Key}({g.Count()})")
            .ToList();

        var itemsSummary = string.Join(" + ", groupedByType.Any() ? groupedByType : new[] { "Empty" });
        return $"{itemsSummary} = {_supplies.Count}/{MaxCarryCapacity}";
    }

    protected override IEnumerable<object> GetEqualityComponents()
    {
        yield return _supplies.Count;
        yield return MaxCarryCapacity;
        foreach (var supply in _supplies.OrderBy(s => s.ItemId))
            yield return supply;
    }
}
```

#### FieldDressingResult

```csharp
/// <summary>
/// Immutable result object from Field Dressing ability execution.
/// Contains full breakdown of healing calculation and inventory changes.
/// </summary>
public sealed class FieldDressingResult : ValueObject
{
    /// <summary>
    /// Unique identifier of the character who was healed.
    /// </summary>
    public Guid TargetId { get; }

    /// <summary>
    /// Display name of the healed target.
    /// </summary>
    public string TargetName { get; }

    /// <summary>
    /// HP value before healing was applied.
    /// </summary>
    public int HpBefore { get; }

    /// <summary>
    /// Result of 2d6 dice roll for base healing.
    /// </summary>
    public int HealingRoll { get; }

    /// <summary>
    /// Bonus from Medical Supply quality (Quality - 1).
    /// Range: 0-4 based on supply type and quality.
    /// </summary>
    public int QualityBonus { get; }

    /// <summary>
    /// Bonus from Steady Hands passive ability.
    /// Always +2 if passive is active.
    /// </summary>
    public int SteadyHandsBonus { get; }

    /// <summary>
    /// Total healing applied = HealingRoll + QualityBonus + SteadyHandsBonus
    /// </summary>
    public int TotalHealing { get; }

    /// <summary>
    /// HP value after healing was applied (capped at max HP).
    /// </summary>
    public int HpAfter { get; }

    /// <summary>
    /// Whether the target was fully healed (reached max HP).
    /// </summary>
    public bool WasFullHeal => HpAfter >= 999; // Placeholder max HP

    /// <summary>
    /// Number of Medical Supplies consumed (always 1 for Field Dressing).
    /// </summary>
    public int SuppliesUsed => 1;

    /// <summary>
    /// Number of Medical Supplies remaining after spending.
    /// </summary>
    public int SuppliesRemaining { get; }

    /// <summary>
    /// Name/type of supply used for healing.
    /// </summary>
    public string SupplyTypeUsed { get; }

    /// <summary>
    /// Timestamp when healing was applied.
    /// </summary>
    public DateTime AppliedAt { get; }

    public FieldDressingResult(
        Guid targetId,
        string targetName,
        int hpBefore,
        int healingRoll,
        int qualityBonus,
        int steadyHandsBonus,
        int totalHealing,
        int hpAfter,
        int suppliesRemaining,
        string supplyTypeUsed)
    {
        if (string.IsNullOrWhiteSpace(targetName))
            throw new ArgumentException("Target name cannot be empty.", nameof(targetName));

        if (targetId == Guid.Empty)
            throw new ArgumentException("Target ID cannot be empty.", nameof(targetId));

        TargetId = targetId;
        TargetName = targetName;
        HpBefore = hpBefore;
        HealingRoll = healingRoll;
        QualityBonus = qualityBonus;
        SteadyHandsBonus = steadyHandsBonus;
        TotalHealing = totalHealing;
        HpAfter = hpAfter;
        SuppliesRemaining = suppliesRemaining;
        SupplyTypeUsed = supplyTypeUsed;
        AppliedAt = DateTime.UtcNow;
    }

    /// <summary>
    /// Returns detailed breakdown of healing calculation.
    /// Example: "Base(2d6=7) + Quality(Bandage+1) + Hands(+2) = 10 HP"
    /// </summary>
    public string GetHealingBreakdown() =>
        $"Base(2d6={HealingRoll}) + Quality({SupplyTypeUsed}+{QualityBonus}) + " +
        $"Hands(+{SteadyHandsBonus}) = {TotalHealing} HP";

    /// <summary>
    /// Returns efficiency ratio of actual healing vs potential healing.
    /// 1.0 = full heal. < 1.0 = partial (target reached max HP).
    /// </summary>
    public float GetEfficiency()
    {
        int overheal = Math.Max(0, (HpBefore + TotalHealing) - 999); // Placeholder max
        int appliedHealing = TotalHealing - overheal;
        return (float)appliedHealing / TotalHealing;
    }

    /// <summary>
    /// Returns human-readable status message of heal result.
    /// </summary>
    public string GetStatusMessage() =>
        $"{TargetName} healed for {TotalHealing} HP " +
        $"({HpBefore} → {HpAfter}){(WasFullHeal ? " [FULL HEAL]" : "")}";

    protected override IEnumerable<object> GetEqualityComponents()
    {
        yield return TargetId;
        yield return HealingRoll;
        yield return TotalHealing;
        yield return AppliedAt;
    }
}
```

#### DiagnoseResult

```csharp
/// <summary>
/// Immutable result object from Diagnose ability execution.
/// Contains detailed analysis of target's health, status effects, and vulnerabilities.
/// </summary>
public sealed class DiagnoseResult : ValueObject
{
    /// <summary>
    /// Unique identifier of the diagnosed target.
    /// </summary>
    public Guid TargetId { get; }

    /// <summary>
    /// Display name of the diagnosed target.
    /// </summary>
    public string TargetName { get; }

    /// <summary>
    /// Current HP of the target.
    /// </summary>
    public int CurrentHp { get; }

    /// <summary>
    /// Maximum HP of the target.
    /// </summary>
    public int MaxHp { get; }

    /// <summary>
    /// Current HP as percentage of max (0.0 - 1.0).
    /// </summary>
    public float HpPercentage { get; }

    /// <summary>
    /// Determines if target is "bloodied" (≤50% HP).
    /// Used for tactical decision-making.
    /// </summary>
    public bool IsBloodied => HpPercentage <= 0.5f;

    /// <summary>
    /// Classification of wound severity.
    /// </summary>
    public WoundSeverity WoundSeverity { get; }

    /// <summary>
    /// Collection of active status effects on the target.
    /// </summary>
    public IReadOnlyList<string> StatusEffects { get; }

    /// <summary>
    /// Collection of known vulnerabilities (damage type or condition).
    /// </summary>
    public IReadOnlyList<string> Vulnerabilities { get; }

    /// <summary>
    /// Collection of known resistances (damage type or condition).
    /// </summary>
    public IReadOnlyList<string> Resistances { get; }

    /// <summary>
    /// Timestamp when diagnosis was performed.
    /// </summary>
    public DateTime DiagnosedAt { get; }

    public DiagnoseResult(
        Guid targetId,
        string targetName,
        int currentHp,
        int maxHp,
        WoundSeverity woundSeverity,
        IEnumerable<string> statusEffects,
        IEnumerable<string> vulnerabilities,
        IEnumerable<string> resistances)
    {
        if (string.IsNullOrWhiteSpace(targetName))
            throw new ArgumentException("Target name cannot be empty.", nameof(targetName));

        if (targetId == Guid.Empty)
            throw new ArgumentException("Target ID cannot be empty.", nameof(targetId));

        if (currentHp < 0 || maxHp <= 0 || currentHp > maxHp)
            throw new ArgumentException("Invalid HP values.", nameof(currentHp));

        TargetId = targetId;
        TargetName = targetName;
        CurrentHp = currentHp;
        MaxHp = maxHp;
        HpPercentage = (float)currentHp / maxHp;
        WoundSeverity = woundSeverity;
        StatusEffects = statusEffects?.ToList().AsReadOnly() ?? new List<string>().AsReadOnly();
        Vulnerabilities = vulnerabilities?.ToList().AsReadOnly() ?? new List<string>().AsReadOnly();
        Resistances = resistances?.ToList().AsReadOnly() ?? new List<string>().AsReadOnly();
        DiagnosedAt = DateTime.UtcNow;
    }

    /// <summary>
    /// Returns human-readable description of target's health status.
    /// Example: "Healthy" or "Bloodied - Serious wounds"
    /// </summary>
    public string GetHealthDescription() =>
        WoundSeverity switch
        {
            WoundSeverity.Minor => $"Healthy ({HpPercentage:P0})",
            WoundSeverity.Light => $"Lightly wounded ({HpPercentage:P0})",
            WoundSeverity.Moderate => $"Moderately wounded ({HpPercentage:P0})",
            WoundSeverity.Serious => $"Seriously wounded ({HpPercentage:P0})",
            WoundSeverity.Critical => $"CRITICAL ({HpPercentage:P0})",
            WoundSeverity.Unconscious => "Unconscious",
            _ => "Unknown"
        };

    /// <summary>
    /// Returns summary of all status effects.
    /// Empty string if no effects.
    /// </summary>
    public string GetStatusSummary() =>
        StatusEffects.Any() ? string.Join(", ", StatusEffects) : "None";

    /// <summary>
    /// Checks if target has any negative status effects.
    /// </summary>
    public bool HasNegativeEffects() =>
        StatusEffects.Any();

    /// <summary>
    /// Formats complete diagnosis as multi-line display string.
    /// </summary>
    public string GetFormattedOutput()
    {
        var lines = new List<string>
        {
            $"═══ Diagnosis: {TargetName} ═══",
            $"HP: {CurrentHp}/{MaxHp} ({HpPercentage:P0})",
            $"Status: {GetHealthDescription()}",
            $"Wound Severity: {WoundSeverity}"
        };

        if (StatusEffects.Any())
            lines.Add($"Afflictions: {GetStatusSummary()}");

        if (Vulnerabilities.Any())
            lines.Add($"Vulnerabilities: {string.Join(", ", Vulnerabilities)}");

        if (Resistances.Any())
            lines.Add($"Resistances: {string.Join(", ", Resistances)}");

        lines.Add("═══════════════════════════════");

        return string.Join("\n", lines);
    }

    protected override IEnumerable<object> GetEqualityComponents()
    {
        yield return TargetId;
        yield return CurrentHp;
        yield return WoundSeverity;
        yield return DiagnosedAt;
    }
}
```

---

## 5. Medical Supplies Resource System

### 5.1 Resource Model

**Definition:** Medical Supplies represent salvaged or purchased medical materials that are consumed to fuel Bone-Setter healing abilities.

**Key Characteristics:**

| Aspect | Value |
|--------|-------|
| **Resource Type** | Consumable Inventory (not regenerating) |
| **Max Capacity** | 10 individual items |
| **Items Stackable** | Yes (by type) |
| **Regeneration** | None (must be acquired via salvage/commerce) |
| **Affected by Abilities** | Field Dressing (1 supply), Emergency Surgery (1-2 supplies) |
| **Quality Factor** | 1-5 scale directly affects healing |

### 5.2 Supply Types & Healing Bonuses

```
Bandage         Quality 1-5  Base healing supply, +0 to +4 bonus
├─ Poor         Q1          Basic cloth wrappings
├─ Common       Q2          Standard battlefield bandages
├─ Quality      Q3          Well-made medical bandages
├─ Excellent    Q4          Reinforced with herbs
└─ Pristine     Q5          Master-crafted or rare salvage

Salve           Quality 1-5  Topical cream for surface wounds, +0 to +4
├─ Poor         Q1          Basic herb paste
├─ Common       Q2          Mixed herbal salve
├─ Quality      Q3          Refined healing salve
├─ Excellent    Q4          Potent medicinal salve
└─ Pristine     Q5          Alchemically enhanced

Splint          Quality 1-5  Bone/joint stabilization, +0 to +4
├─ Poor         Q1          Rough wooden splints
├─ Common       Q2          Standard splinting materials
├─ Quality      Q3          Well-crafted splints with padding
├─ Excellent    Q4          Reinforced splints with bracing
└─ Pristine     Q5          Master-crafted with magical enhancement

Suture          Quality 1-5  Deep wound closure, +0 to +4
├─ Poor         Q1          Rough plant fiber thread
├─ Common       Q2          Standard medical sutures
├─ Quality      Q3          Fine quality sutures
├─ Excellent    Q4          Reinforced surgical sutures
└─ Pristine     Q5          Rare material surgical thread

Herbs           Quality 1-5  Herbal remedies, +0 to +4
├─ Poor         Q1          Dried common herbs
├─ Common       Q2          Curated herb mixture
├─ Quality      Q3          Potent herb combination
├─ Excellent    Q4          Rare medicinal herbs
└─ Pristine     Q5          Legendary healing plants

Antidote        Quality 1-5  Poison/disease treatment (crafted)
├─ Poor         Q1          Weak antidote, limited effect
├─ Common       Q2          Standard antidote
├─ Quality      Q3          Effective antidote
├─ Excellent    Q4          Strong antidote
└─ Pristine     Q5          Master antidote

Stimulant       Quality 1-5  Combat stimulant (future use)
```

### 5.3 Healing Bonus Calculation

**Formula:**
```
Total Healing = Base Dice Roll + Quality Bonus + Steady Hands Bonus

Where:
  Base Dice Roll = Result of 2d6 (Field Dressing T1) or 4d6 (Emergency Surgery T2)
  Quality Bonus = SupplyQuality - 1 (0-4 range)
  Steady Hands Bonus = +2 (if passive is active)
```

**Example Calculations:**

```
Field Dressing with Bandage (Quality 3):
  Base:        2d6 = 5
  Quality:     3 - 1 = +2
  Steady Hands: +2
  ─────────────────
  Total Heal:  5 + 2 + 2 = 9 HP

Field Dressing with Pristine Suture (Quality 5):
  Base:        2d6 = 7
  Quality:     5 - 1 = +4
  Steady Hands: +2
  ─────────────────
  Total Heal:  7 + 4 + 2 = 13 HP

Field Dressing with Poor Salve (Quality 1):
  Base:        2d6 = 3
  Quality:     1 - 1 = +0
  Steady Hands: +2
  ─────────────────
  Total Heal:  3 + 0 + 2 = 5 HP
```

### 5.4 Supply Acquisition

**Phase v0.20.6a Scope:**
- Initial supplies provided on Bone-Setter selection
- Supplies acquired through looting/salvage (game mechanics)
- Display of current inventory

**Future Phases (v0.21+):**
- Commerce system integration (buying/selling)
- Crafting system (creating Antidotes from Herbs)
- Restock mechanics (time-based or location-based)

---

## 6. Field Dressing Ability Specification

### 6.1 Ability Overview

| Attribute | Value |
|-----------|-------|
| **Ability Name** | Field Dressing |
| **Tier** | 1 (Tier 1) |
| **Type** | Active (Targeted) |
| **AP Cost** | 2 |
| **Range** | 3 spaces (adjacent to caster or target) |
| **Resource Cost** | 1 Medical Supply (any type) |
| **Target** | Single character (ally or enemy) |
| **Effect** | Heal 2d6 + bonuses |
| **Corruption Risk** | None (Coherent path) |

### 6.2 Mechanics

**Effect Resolution:**

1. **Range Check:** Verify target is within 3 spaces of caster
2. **Supply Check:** Verify 1 Medical Supply is available in inventory
3. **Dice Roll:** Roll 2d6 for base healing
4. **Apply Bonuses:**
   - Quality Bonus: (Supply Quality - 1)
   - Steady Hands Bonus: +2 (if passive is active)
5. **Apply Healing:** Add total healing to target's current HP (capped at max)
6. **Spend Supply:** Remove 1 supply item from inventory
7. **Generate Result:** Return FieldDressingResult object

**Detailed Flow Diagram:**

```
┌─ Field Dressing Execution ─────────────────┐
│                                             │
│  1. Input Validation                        │
│     ├─ Verify target in range               │
│     ├─ Verify supplies available            │
│     └─ Return error if checks fail          │
│                                             │
│  2. Ability Activation                      │
│     ├─ Deduct 2 AP from caster              │
│     └─ Begin execution                      │
│                                             │
│  3. Healing Calculation                     │
│     ├─ Roll 2d6                             │
│     ├─ Get supply quality bonus             │
│     ├─ Get steady hands bonus (+2)          │
│     ├─ Sum: roll + quality + hands          │
│     └─ Cap at target's max HP               │
│                                             │
│  4. Resource Consumption                    │
│     ├─ Remove 1 supply from inventory       │
│     └─ Update inventory state               │
│                                             │
│  5. Target Update                           │
│     ├─ Apply healing to target              │
│     ├─ Update target's HP                   │
│     └─ Check for full heal                  │
│                                             │
│  6. Result Generation                       │
│     ├─ Create FieldDressingResult           │
│     ├─ Include all breakdown data           │
│     └─ Return to display layer              │
│                                             │
└─────────────────────────────────────────────┘
```

### 6.3 Ability Table

| Scenario | Result |
|----------|--------|
| Target at 50 HP, heal 9 HP, max 100 | Target becomes 59 HP |
| Target at 95 HP, heal 12 HP, max 100 | Target becomes 100 HP (capped) |
| No supplies available | Ability fails with error message |
| Target out of range | Ability fails with error message |
| Steady Hands passive not active | Healing bonus = Quality - 1 only |
| Supply quality is 1 (poor) | Healing = 2d6 + 0 + 2 = base + hands only |
| Supply quality is 5 (pristine) | Healing = 2d6 + 4 + 2 = maximum bonus |

### 6.4 Implementation Pseudocode

```csharp
public FieldDressingResult ExecuteFieldDressing(
    Character caster,
    Character target,
    MedicalSuppliesResource supplies,
    bool steadyHandsActive)
{
    // Validate inputs
    if (!IsInRange(caster, target, range: 3))
        throw new InvalidOperationException("Target out of range");

    if (supplies.GetTotalSupplyCount() == 0)
        throw new InvalidOperationException("No medical supplies available");

    // Get supply to use (prefer higher quality)
    var supplyToUse = SelectBestAvailableSupply(supplies);

    // Roll base healing
    var baseHealing = RollDice(2, 6);

    // Calculate bonuses
    var qualityBonus = supplyToUse.GetHealingBonus(); // Quality - 1
    var steadyHandsBonus = steadyHandsActive ? 2 : 0;

    // Total healing (before cap)
    var totalHealing = baseHealing + qualityBonus + steadyHandsBonus;

    // Apply healing (cap at max HP)
    var hpBefore = target.CurrentHp;
    var hpAfter = Math.Min(hpBefore + totalHealing, target.MaxHp);
    var actualHealing = hpAfter - hpBefore;

    // Spend supply
    var newSupplies = supplies.SpendSupply(supplyToUse.SupplyType);

    // Create result
    return new FieldDressingResult(
        targetId: target.Id,
        targetName: target.Name,
        hpBefore: hpBefore,
        healingRoll: baseHealing,
        qualityBonus: qualityBonus,
        steadyHandsBonus: steadyHandsBonus,
        totalHealing: actualHealing,
        hpAfter: hpAfter,
        suppliesRemaining: newSupplies.GetTotalSupplyCount(),
        supplyTypeUsed: supplyToUse.SupplyType.ToString());
}
```

---

## 7. Diagnose Ability Specification

### 7.1 Ability Overview

| Attribute | Value |
|-----------|-------|
| **Ability Name** | Diagnose |
| **Tier** | 1 (Tier 1) |
| **Type** | Active (Utility/Information) |
| **AP Cost** | 1 |
| **Range** | 5 spaces (line of sight) |
| **Resource Cost** | None |
| **Target** | Single character (ally or enemy) |
| **Effect** | Reveal HP, status effects, vulnerabilities, resistances |
| **Corruption Risk** | None (Coherent path) |

### 7.2 Mechanics

**Information Revealed:**

1. **Health Status**
   - Current HP / Max HP
   - HP percentage
   - Wound Severity classification
   - Bloodied status (≤50% HP)

2. **Status Effects**
   - All active conditions
   - Buffs and debuffs
   - Temporary effects

3. **Vulnerabilities**
   - Known damage type weaknesses
   - Condition susceptibilities

4. **Resistances**
   - Known damage type resistances
   - Condition immunities

**Effect Resolution:**

1. **Range Check:** Verify target is within 5 spaces with line of sight
2. **Gather Information:** Collect all status information from target
3. **Classify Severity:** Determine WoundSeverity based on HP percentage
4. **Generate Result:** Return DiagnoseResult object with all data
5. **Display:** Show formatted diagnostic report to player

**Information Gathering Logic:**

```
┌─ Diagnose Execution ──────────────────┐
│                                       │
│ 1. Range & LOS Check                  │
│    ├─ Verify within 5 spaces          │
│    ├─ Check line of sight             │
│    └─ Return error if fails           │
│                                       │
│ 2. Health Analysis                    │
│    ├─ Read target's current HP        │
│    ├─ Read target's max HP            │
│    ├─ Calculate HP percentage         │
│    └─ Determine WoundSeverity         │
│                                       │
│ 3. Effect Enumeration                 │
│    ├─ List all status effects         │
│    ├─ Categorize as buffs/debuffs     │
│    └─ Note effect duration            │
│                                       │
│ 4. Vulnerability Assessment           │
│    ├─ Identify damage vulnerabilities │
│    ├─ List condition vulnerabilities  │
│    └─ Calculate total weakness        │
│                                       │
│ 5. Resistance Evaluation              │
│    ├─ Identify damage resistances     │
│    ├─ List condition immunities       │
│    └─ Calculate total protection      │
│                                       │
│ 6. Report Generation                  │
│    ├─ Create DiagnoseResult           │
│    ├─ Format output string            │
│    └─ Return to display               │
│                                       │
└───────────────────────────────────────┘
```

### 7.3 Wound Severity Classification

Severity is determined by HP percentage:

```csharp
private WoundSeverity ClassifyWoundSeverity(float hpPercentage)
{
    return hpPercentage switch
    {
        >= 0.90f => WoundSeverity.Minor,           // 90-100%
        >= 0.70f => WoundSeverity.Light,           // 70-89%
        >= 0.40f => WoundSeverity.Moderate,        // 40-69%
        >= 0.15f => WoundSeverity.Serious,         // 15-39%
        > 0.0f   => WoundSeverity.Critical,        // 1-14%
        0.0f     => WoundSeverity.Unconscious,     // 0%
        _        => WoundSeverity.Unknown
    };
}
```

### 7.4 Implementation Pseudocode

```csharp
public DiagnoseResult ExecuteDiagnose(
    Character caster,
    Character target)
{
    // Validate range and line of sight
    if (!IsInRange(caster, target, range: 5))
        throw new InvalidOperationException("Target out of range");

    if (!HasLineOfSight(caster, target))
        throw new InvalidOperationException("No line of sight to target");

    // Gather health information
    var currentHp = target.CurrentHp;
    var maxHp = target.MaxHp;
    var hpPercentage = (float)currentHp / maxHp;
    var severity = ClassifyWoundSeverity(hpPercentage);

    // Gather status effects
    var statusEffects = target.GetActiveStatusEffects()
        .Select(e => e.Name)
        .ToList();

    // Gather vulnerabilities
    var vulnerabilities = target.GetVulnerabilities()
        .Select(v => v.Type)
        .ToList();

    // Gather resistances
    var resistances = target.GetResistances()
        .Select(r => r.Type)
        .ToList();

    // Create and return result
    return new DiagnoseResult(
        targetId: target.Id,
        targetName: target.Name,
        currentHp: currentHp,
        maxHp: maxHp,
        woundSeverity: severity,
        statusEffects: statusEffects,
        vulnerabilities: vulnerabilities,
        resistances: resistances);
}
```

---

## 8. Steady Hands Ability Specification

### 8.1 Ability Overview

| Attribute | Value |
|-----------|-------|
| **Ability Name** | Steady Hands |
| **Tier** | 1 (Tier 1) |
| **Type** | Passive |
| **AP Cost** | — (Always active) |
| **Range** | — (Self) |
| **Resource Cost** | None |
| **Target** | Self |
| **Effect** | +2 bonus to all healing from medical abilities |
| **Corruption Risk** | None (Coherent path) |

### 8.2 Mechanics

**Passive Effect:**

Steady Hands is a passive ability that is **always active** when the Bone-Setter has selected it. It provides a flat +2 bonus to the healing value of all medical abilities.

**Scope of Effect:**

- Applies to **all medical-type abilities** (Field Dressing, Emergency Surgery, Resuscitate, Miracle Worker)
- Does **not** apply to non-healing abilities (Diagnose, Triage, Antidote Craft)
- Stacks with all other bonuses (supply quality, condition bonuses, etc.)

**Calculation:**

```
Total Healing = Base Formula + Steady Hands Bonus

Examples:
  Field Dressing (2d6 + quality) + 2 = total
  Emergency Surgery (4d6 + quality) + 2 = total
  Resuscitate (fixed 1 HP) + 2 = 3 HP (capstone effect)
```

### 8.3 Implementation Pseudocode

```csharp
/// <summary>
/// Passive ability that grants +2 to all medical ability healing.
/// No activation required; automatically applied when calculating healing.
/// </summary>
public class SteadyHandsPassive : IPassiveAbility
{
    public const int HealingBonusAmount = 2;

    public void OnAbilityExecuted(
        AbilityExecutionContext context,
        ref HealingCalculation healing)
    {
        // Only apply to medical abilities
        if (IsMedicalAbility(context.Ability))
        {
            healing.AddBonus(
                bonusType: BonusType.SteadyHands,
                amount: HealingBonusAmount,
                source: "Steady Hands passive");
        }
    }

    private bool IsMedicalAbility(IAbility ability) =>
        ability.AbilityId == BoneSetterAbilityId.FieldDressing ||
        ability.AbilityId == BoneSetterAbilityId.EmergencySurgery ||
        ability.AbilityId == BoneSetterAbilityId.Resuscitate ||
        ability.AbilityId == BoneSetterAbilityId.MiracleWorker;
}
```

### 8.4 Interaction with Other Bonuses

**Steady Hands + Supply Quality:**

```
Field Dressing with Bandage (Q3) and Steady Hands:
  2d6 + (Quality - 1) + Steady Hands
  = 2d6 + (3 - 1) + 2
  = 2d6 + 2 + 2
  = 2d6 + 4
```

**Steady Hands + Future Condition Bonuses (v0.20.6b):**

```
Triage with Steady Hands (example):
  Base Triage Healing + Steady Hands
  = Triage Formula + 2
```

---

## 9. User Stories & Scenarios

### 9.1 User Stories

**Story 1: Bone-Setter Selects Specialization**

```
As a player who has selected the Adept archetype
I want to choose Bone-Setter as my specialization
So that I can unlock medical healing abilities and become a party healer

Acceptance Criteria:
✓ Bone-Setter appears in specialization selection UI
✓ v0.20.6a abilities (Field Dressing, Diagnose, Steady Hands) are unlocked
✓ Starting Medical Supplies inventory is created (5 bandages, quality mix)
✓ Character sheet shows "Bone-Setter" as active specialization
✓ AP and ability slots are initialized correctly
```

**Story 2: Bone-Setter Heals Wounded Ally**

```
As a Bone-Setter in combat
I want to use Field Dressing on a wounded ally
So that I can restore their health and keep them in the fight

Acceptance Criteria:
✓ Field Dressing ability is selectable in combat
✓ Can target allies within 3 spaces
✓ Requires 2 AP to activate
✓ Consumes 1 Medical Supply from inventory
✓ Healing is calculated correctly (2d6 + quality + steady hands)
✓ Target's HP is updated
✓ Result shows healing breakdown
✓ Inventory updates after use
```

**Story 3: Bone-Setter Diagnoses Enemy**

```
As a Bone-Setter in combat
I want to use Diagnose on an enemy
So that I can assess their health and plan my strategy

Acceptance Criteria:
✓ Diagnose ability is selectable in combat
✓ Can target any character within 5 spaces
✓ Requires 1 AP to activate
✓ Costs no Medical Supplies
✓ Shows complete health analysis
✓ Displays HP, status effects, vulnerabilities, resistances
✓ Wound Severity is classified correctly
✓ Result is formatted for easy reading
```

**Story 4: Bone-Setter Manages Medical Supplies**

```
As a Bone-Setter
I want to track my Medical Supplies inventory
So that I know how many heals I have left

Acceptance Criteria:
✓ Character status screen shows supply count
✓ Supplies grouped by type
✓ Quality rating visible for each supply
✓ Total capacity and remaining space shown
✓ Inventory full warning when at capacity
✓ Supplies are consumed when abilities are used
```

### 9.2 Tactical Scenarios

**Scenario A: Multi-Target Healing in Combat**

```
Situation:
- Party of 3 characters in combat
- Fighter at 30 HP (wounded, priority)
- Rogue at 50 HP (moderate)
- Bone-Setter at 80 HP (healthy)
- Enemy group: 2 enemies alive

Turn Actions:
1. Bone-Setter uses Diagnose on Fighter
   Result: "Critical condition, 30/100 HP" → HIGH PRIORITY

2. Bone-Setter uses Field Dressing on Fighter
   Cost: 2 AP, 1 supply (Bandage Q3)
   Roll: 2d6 = 5, +2 quality, +2 hands = 9 HP total
   Fighter: 30 → 39 HP

3. Fighter attacks enemy (uses turn)
4. Rogue attacks enemy (uses turn)

Next Turn:
1. Bone-Setter uses Diagnose on Rogue
   Result: "Moderately wounded, 50/100 HP"

2. Bone-Setter uses Field Dressing on Rogue
   Cost: 2 AP, 1 supply (Salve Q2)
   Roll: 2d6 = 4, +1 quality, +2 hands = 7 HP total
   Rogue: 50 → 57 HP

Inventory Update:
  Before: Bandage(3) + Salve(2) + Herbs(1) = 6/10
  After:  Bandage(2) + Salve(1) + Herbs(1) = 4/10
```

**Scenario B: Pre-Combat Diagnosis**

```
Situation:
- Party encounters 2 unknown enemies
- Need to assess threat level

Actions:
1. Bone-Setter uses Diagnose on Enemy 1 (Orc)
   Result:
   ╔════════════════════════════════╗
   ║  Diagnosis: Orc (Enemy)        ║
   ║  HP: 75/100 (75%)              ║
   ║  Status: Healthy               ║
   ║  Wound Severity: Minor         ║
   ║  Afflictions: None             ║
   ║  Vulnerabilities: Fire damage  ║
   ║  Resistances: Cold damage      ║
   ╚════════════════════════════════╝

2. Bone-Setter uses Diagnose on Enemy 2 (Mage)
   Result:
   ╔════════════════════════════════╗
   ║  Diagnosis: Mage (Enemy)       ║
   ║  HP: 40/60 (67%)               ║
   ║  Status: Moderately wounded    ║
   ║  Wound Severity: Moderate      ║
   ║  Afflictions: Weakness         ║
   ║  Vulnerabilities: Physical     ║
   ║  Resistances: Magic, Lightning ║
   ╚════════════════════════════════╝

Tactical Decision:
- Target Mage first (lower HP, physical vulnerable)
- Use Rogue for burst damage
- Bone-Setter heals as needed
```

---

## 10. Application Service Layer

### 10.1 MedicalSuppliesService

```csharp
/// <summary>
/// Application service managing Medical Supplies inventory and consumption.
/// Handles supply spending, acquisition, and quality-based calculations.
/// </summary>
public class MedicalSuppliesService : IApplicationService
{
    private readonly ICharacterRepository _characterRepository;
    private readonly ILogger<MedicalSuppliesService> _logger;

    public MedicalSuppliesService(
        ICharacterRepository characterRepository,
        ILogger<MedicalSuppliesService> logger)
    {
        _characterRepository = characterRepository ?? throw new ArgumentNullException(nameof(characterRepository));
        _logger = logger ?? throw new ArgumentNullException(nameof(logger));
    }

    /// <summary>
    /// Validates that Medical Supplies are available for consumption.
    /// </summary>
    public bool ValidateSupplyAvailability(
        MedicalSuppliesResource supplies,
        int count = 1,
        MedicalSupplyType? specificType = null)
    {
        if (count < 1)
            return false;

        if (specificType.HasValue)
            return supplies.GetCountByType(specificType.Value) >= count;

        return supplies.GetTotalSupplyCount() >= count;
    }

    /// <summary>
    /// Spends one Medical Supply of any available type.
    /// Throws if no supplies available.
    /// </summary>
    public MedicalSuppliesResource SpendSupply(
        MedicalSuppliesResource supplies,
        MedicalSupplyType? preferredType = null)
    {
        if (!ValidateSupplyAvailability(supplies))
            throw new InvalidOperationException(
                $"No supplies available. Current inventory: {supplies.GetInventorySummary()}");

        MedicalSupplyType typeToSpend;

        if (preferredType.HasValue && supplies.HasSupply(preferredType.Value))
        {
            typeToSpend = preferredType.Value;
        }
        else
        {
            // Default to first available type
            typeToSpend = supplies.Supplies.First().SupplyType;
        }

        _logger.LogInformation(
            "Spending Medical Supply type={Type} from inventory. Before: {Before}",
            typeToSpend,
            supplies.GetInventorySummary());

        var newSupplies = supplies.SpendSupply(typeToSpend);

        _logger.LogInformation(
            "Medical Supply spent. After: {After}",
            newSupplies.GetInventorySummary());

        return newSupplies;
    }

    /// <summary>
    /// Adds a new Medical Supply to inventory.
    /// Throws if inventory is full.
    /// </summary>
    public MedicalSuppliesResource AddSupply(
        MedicalSuppliesResource supplies,
        MedicalSupplyItem item)
    {
        if (!supplies.CanCarryMore())
            throw new InvalidOperationException(
                $"Cannot add supply: inventory full ({supplies.GetTotalSupplyCount()}/{supplies.MaxCarryCapacity})");

        _logger.LogInformation(
            "Adding Medical Supply: {Item} (Quality: {Quality})",
            item.Name,
            item.Quality);

        var newSupplies = supplies.AddSupply(item);

        _logger.LogInformation(
            "Supply added. New inventory: {Inventory}",
            newSupplies.GetInventorySummary());

        return newSupplies;
    }

    /// <summary>
    /// Calculates total healing value including quality bonus and steady hands bonus.
    /// </summary>
    public int CalculateHealingWithBonuses(
        int baseHealing,
        MedicalSupplyItem supply,
        int steadyHandsBonus = 0)
    {
        var qualityBonus = supply.GetHealingBonus();
        var totalHealing = baseHealing + qualityBonus + steadyHandsBonus;

        _logger.LogDebug(
            "Healing calculation: base={Base} + quality={Quality} + hands={Hands} = {Total}",
            baseHealing,
            qualityBonus,
            steadyHandsBonus,
            totalHealing);

        return totalHealing;
    }

    /// <summary>
    /// Gets the highest quality supply of a specific type.
    /// Returns null if no supplies of that type exist.
    /// </summary>
    public MedicalSupplyItem? GetHighestQualitySupply(
        MedicalSuppliesResource supplies,
        MedicalSupplyType type)
    {
        return supplies.Supplies
            .Where(s => s.SupplyType == type)
            .OrderByDescending(s => s.Quality)
            .FirstOrDefault();
    }
}
```

### 10.2 BoneSetterAbilityService

```csharp
/// <summary>
/// Application service orchestrating Bone-Setter ability execution.
/// Coordinates with domain models and infrastructure services.
/// </summary>
public class BoneSetterAbilityService : IApplicationService
{
    private readonly MedicalSuppliesService _suppliesService;
    private readonly ICharacterRepository _characterRepository;
    private readonly IAbilityExecutionPipeline _executionPipeline;
    private readonly ILogger<BoneSetterAbilityService> _logger;

    public BoneSetterAbilityService(
        MedicalSuppliesService suppliesService,
        ICharacterRepository characterRepository,
        IAbilityExecutionPipeline executionPipeline,
        ILogger<BoneSetterAbilityService> logger)
    {
        _suppliesService = suppliesService ?? throw new ArgumentNullException(nameof(suppliesService));
        _characterRepository = characterRepository ?? throw new ArgumentNullException(nameof(characterRepository));
        _executionPipeline = executionPipeline ?? throw new ArgumentNullException(nameof(executionPipeline));
        _logger = logger ?? throw new ArgumentNullException(nameof(logger));
    }

    /// <summary>
    /// Executes Field Dressing ability with full validation and state management.
    /// </summary>
    public async Task<FieldDressingResult> ExecuteFieldDressing(
        Guid casterId,
        Guid targetId,
        CancellationToken cancellationToken = default)
    {
        _logger.LogInformation(
            "Starting Field Dressing execution: caster={Caster}, target={Target}",
            casterId,
            targetId);

        var caster = await _characterRepository.GetById(casterId, cancellationToken);
        var target = await _characterRepository.GetById(targetId, cancellationToken);

        if (caster == null || target == null)
            throw new InvalidOperationException("Caster or target not found");

        // Validate prerequisites
        if (!caster.HasSpecialization(SpecializationId.BoneSetter))
            throw new InvalidOperationException("Character is not a Bone-Setter");

        if (!caster.CanPayAbilityCost(apCost: 2))
            throw new InvalidOperationException("Insufficient AP");

        if (!IsInRange(caster, target, range: 3))
            throw new InvalidOperationException("Target out of range");

        var supplies = caster.GetMedicalSupplies();
        if (!_suppliesService.ValidateSupplyAvailability(supplies))
            throw new InvalidOperationException("No medical supplies available");

        // Execute healing
        var baseHealing = RollDice(2, 6);
        var supply = supplies.Supplies.First();
        var steadyHandsBonus = caster.HasAbility(BoneSetterAbilityId.SteadyHands) ? 2 : 0;
        var totalHealing = _suppliesService.CalculateHealingWithBonuses(
            baseHealing,
            supply,
            steadyHandsBonus);

        var hpBefore = target.CurrentHp;
        var hpAfter = Math.Min(hpBefore + totalHealing, target.MaxHp);

        // Spend supply and update state
        var newSupplies = _suppliesService.SpendSupply(supplies);
        caster.SetMedicalSupplies(newSupplies);
        caster.DeductAp(2);
        target.SetHp(hpAfter);

        // Persist changes
        await _characterRepository.Update(caster, cancellationToken);
        await _characterRepository.Update(target, cancellationToken);

        // Create result
        var result = new FieldDressingResult(
            targetId: target.Id,
            targetName: target.Name,
            hpBefore: hpBefore,
            healingRoll: baseHealing,
            qualityBonus: supply.GetHealingBonus(),
            steadyHandsBonus: steadyHandsBonus,
            totalHealing: totalHealing,
            hpAfter: hpAfter,
            suppliesRemaining: newSupplies.GetTotalSupplyCount(),
            supplyTypeUsed: supply.SupplyType.ToString());

        _logger.LogInformation(
            "Field Dressing executed successfully: {Result}",
            result.GetStatusMessage());

        return result;
    }

    /// <summary>
    /// Executes Diagnose ability with full information gathering.
    /// </summary>
    public async Task<DiagnoseResult> ExecuteDiagnose(
        Guid casterId,
        Guid targetId,
        CancellationToken cancellationToken = default)
    {
        _logger.LogInformation(
            "Starting Diagnose execution: caster={Caster}, target={Target}",
            casterId,
            targetId);

        var caster = await _characterRepository.GetById(casterId, cancellationToken);
        var target = await _characterRepository.GetById(targetId, cancellationToken);

        if (caster == null || target == null)
            throw new InvalidOperationException("Caster or target not found");

        // Validate prerequisites
        if (!caster.HasSpecialization(SpecializationId.BoneSetter))
            throw new InvalidOperationException("Character is not a Bone-Setter");

        if (!caster.CanPayAbilityCost(apCost: 1))
            throw new InvalidOperationException("Insufficient AP");

        if (!IsInRange(caster, target, range: 5))
            throw new InvalidOperationException("Target out of range");

        // Gather diagnostic information
        var woundSeverity = ClassifyWoundSeverity(target.CurrentHp, target.MaxHp);
        var statusEffects = target.GetActiveStatusEffects().Select(e => e.Name).ToList();
        var vulnerabilities = target.GetVulnerabilities().Select(v => v.Type).ToList();
        var resistances = target.GetResistances().Select(r => r.Type).ToList();

        // Deduct AP and create result
        caster.DeductAp(1);
        await _characterRepository.Update(caster, cancellationToken);

        var result = new DiagnoseResult(
            targetId: target.Id,
            targetName: target.Name,
            currentHp: target.CurrentHp,
            maxHp: target.MaxHp,
            woundSeverity: woundSeverity,
            statusEffects: statusEffects,
            vulnerabilities: vulnerabilities,
            resistances: resistances);

        _logger.LogInformation(
            "Diagnose executed: {Description}",
            result.GetHealthDescription());

        return result;
    }

    private WoundSeverity ClassifyWoundSeverity(int currentHp, int maxHp)
    {
        if (maxHp <= 0) return WoundSeverity.Unknown;

        var percentage = (float)currentHp / maxHp;

        return percentage switch
        {
            >= 0.90f => WoundSeverity.Minor,
            >= 0.70f => WoundSeverity.Light,
            >= 0.40f => WoundSeverity.Moderate,
            >= 0.15f => WoundSeverity.Serious,
            > 0.0f => WoundSeverity.Critical,
            0.0f => WoundSeverity.Unconscious,
            _ => WoundSeverity.Unknown
        };
    }

    private int RollDice(int count, int sides) =>
        Enumerable.Range(0, count).Sum(_ => Random.Shared.Next(1, sides + 1));

    private bool IsInRange(Character caster, Character target, int range)
    {
        // Distance calculation (placeholder)
        return Math.Abs(caster.Position.X - target.Position.X) <= range &&
               Math.Abs(caster.Position.Y - target.Position.Y) <= range;
    }
}
```

---

## 11. Configuration Specifications

### 11.1 specializations.json Entry

```json
{
  "id": "bone-setter",
  "name": "Bone-Setter",
  "pronunciation": "BONE-set-ur",
  "archetype": "adept",
  "pathType": "coherent",
  "tagline": "Keeper of Life",
  "description": "A healer and trauma specialist who uses salvaged medical supplies and steady hands to keep allies alive. The Bone-Setter follows the Coherent path, gaining power through skill and knowledge rather than dark magic.",
  "specialAbilitySlots": {
    "tier1": 3,
    "tier2": 3,
    "tier3": 2,
    "capstone": 1
  },
  "specialResource": {
    "type": "consumable_inventory",
    "name": "Medical Supplies",
    "abbreviation": "MS",
    "maxCapacity": 10,
    "description": "Salvaged medical materials used to fuel healing abilities"
  },
  "unlockCost": {
    "pointType": "specialization_points",
    "cost": 0
  },
  "corruuptionRisk": "none",
  "startingResources": {
    "medicalSupplies": [
      {
        "type": "bandage",
        "quality": 2,
        "count": 3
      },
      {
        "type": "salve",
        "quality": 1,
        "count": 2
      }
    ]
  },
  "versions": {
    "tier1": "v0.20.6a",
    "tier2": "v0.20.6b",
    "tier3_capstone": "v0.20.6c"
  }
}
```

### 11.2 abilities.json Tier 1 Entries

```json
{
  "abilities": [
    {
      "id": 600,
      "specialization": "bone-setter",
      "name": "Field Dressing",
      "abbreviation": "FD",
      "tier": 1,
      "type": "active",
      "complexity": "medium",
      "version": "v0.20.6a",
      "apCost": 2,
      "range": {
        "type": "distance",
        "distance": 3,
        "unit": "spaces"
      },
      "targeting": {
        "targetType": "single_character",
        "allowAlly": true,
        "allowEnemy": false,
        "allowSelf": true
      },
      "resourceCost": {
        "type": "medical_supply",
        "amount": 1,
        "specificType": null
      },
      "effect": {
        "type": "healing",
        "formula": "2d6 + qualityBonus + steadyHandsBonus",
        "baseFormula": "2d6",
        "bonuses": [
          {
            "name": "Quality Bonus",
            "formula": "supplyQuality - 1",
            "min": 0,
            "max": 4
          },
          {
            "name": "Steady Hands",
            "formula": "fixed",
            "value": 2,
            "conditional": "when SteadyHands passive is active"
          }
        ]
      },
      "corruptionRisk": "none",
      "description": "Apply medical treatment to a wounded ally within 3 spaces, healing them for 2d6 plus bonuses from your supply quality and skill.",
      "flavorText": "You steady your hands and apply careful treatment, leveraging your knowledge and the quality of your supplies to restore their vitality.",
      "combatNotes": "Requires Medical Supplies. Higher quality supplies provide greater healing. Synergizes with Steady Hands passive."
    },
    {
      "id": 601,
      "specialization": "bone-setter",
      "name": "Diagnose",
      "abbreviation": "D",
      "tier": 1,
      "type": "active",
      "complexity": "low",
      "version": "v0.20.6a",
      "apCost": 1,
      "range": {
        "type": "distance",
        "distance": 5,
        "unit": "spaces"
      },
      "targeting": {
        "targetType": "single_character",
        "allowAlly": true,
        "allowEnemy": true,
        "allowSelf": true
      },
      "resourceCost": null,
      "effect": {
        "type": "information",
        "reveals": [
          "currentHp",
          "maxHp",
          "hpPercentage",
          "woundSeverity",
          "statusEffects",
          "vulnerabilities",
          "resistances"
        ]
      },
      "corruptionRisk": "none",
      "description": "Examine a character within 5 spaces, revealing their health status, active effects, and tactical information.",
      "flavorText": "You study your target carefully, your trained eye picking out signs of injury, weakness, and ailment.",
      "combatNotes": "Free information tool. No resource cost. Use to plan healing priorities and identify tactical opportunities."
    },
    {
      "id": 602,
      "specialization": "bone-setter",
      "name": "Steady Hands",
      "abbreviation": "SH",
      "tier": 1,
      "type": "passive",
      "complexity": "low",
      "version": "v0.20.6a",
      "apCost": 0,
      "range": null,
      "targeting": {
        "targetType": "self",
        "allowAlly": false,
        "allowEnemy": false,
        "allowSelf": true
      },
      "resourceCost": null,
      "effect": {
        "type": "passive_bonus",
        "appliesToAbilities": [
          600,
          603,
          606,
          608
        ],
        "bonusType": "flat",
        "bonusAmount": 2,
        "description": "Increases healing from all medical abilities by +2"
      },
      "corruptionRisk": "none",
      "description": "Your hands are steady and practiced. All healing abilities benefit from +2 bonus to healing values.",
      "flavorText": "Years of practice have made your hands steady and sure. You never waste medical resources.",
      "combatNotes": "Always active. Synergizes with all healing abilities and supply quality bonuses."
    }
  ]
}
```

---

## 12. Command Examples & Output

### 12.1 Selection & Setup

```
> character select boneSetter myBoneSetter

Specialization Selected: Bone-Setter
  Archetype: Adept
  Path Type: Coherent (No Corruption Risk)
  Special Resource: Medical Supplies (10 capacity)

Tier 1 Abilities Unlocked:
  ✓ Field Dressing (Active, 2 AP, 1 Supply)
  ✓ Diagnose (Active, 1 AP, Free)
  ✓ Steady Hands (Passive, Always Active)

Starting Medical Supplies:
  Bandage (Quality 2) x3
  Salve (Quality 1) x2
  ──────────────────────
  Total: 5/10 items

Status: Ready for combat
```

### 12.2 Field Dressing Execution

```
> ability fieldDressing target:fighter

Executing: Field Dressing
  Target: Fighter
  Range: 3 spaces ✓
  Medical Supplies: 5/10 ✓

Healing Calculation:
  Base Healing (2d6):    [5]
  Supply Bonus:          +2 (Bandage Quality 3 → 3-1 = +2)
  Steady Hands Bonus:    +2 (Passive Active)
  ─────────────────────────
  Total Healing:         9 HP

Result:
  Fighter HP: 48 → 57 (9 HP restored)
  Medical Supplies: 5 → 4 (Bandage used)

Message: Fighter healed for 9 HP (48 → 57). Supplies remaining: 4/10

Breakdown: Base[5] + Quality[Bandage +2] + Hands[+2] = 9 HP
```

### 12.3 Diagnose Execution

```
> ability diagnose target:enemy1

Executing: Diagnose
  Target: Enemy1 (Orc)
  Range: 5 spaces ✓

═════════════════════════════════════════════════════
                 Diagnosis: Orc (Enemy)
═════════════════════════════════════════════════════

Health Status:
  Current HP:        75/100
  HP Percentage:     75% (Healthy)
  Wound Severity:    Light Wounds

Conditions:
  Status Effects:    None
  Vulnerabilities:   Fire Damage, Psychological
  Resistances:       Cold Damage, Physical (partial)

Tactical Assessment:
  Bloodied:          No (>50% HP)
  Priority:          Low
  Recommendations:   Not an immediate threat

═════════════════════════════════════════════════════

Medical Supplies Used: 0/10 (No cost)
```

### 12.4 Inventory Management

```
> character inventory medicalSupplies

Medical Supplies Inventory:
════════════════════════════════════════════════════

Bandage
  • Item 1: Quality ★★★☆☆ (Quality 3, Healing +2)
  • Item 2: Quality ★★☆☆☆ (Quality 2, Healing +1)
  • Item 3: Quality ★★☆☆☆ (Quality 2, Healing +1)
  ─────────────────────────────────────────────
  Subtotal: 3 items

Salve
  • Item 1: Quality ★☆☆☆☆ (Quality 1, Healing +0)
  • Item 2: Quality ★★☆☆☆ (Quality 2, Healing +1)
  ─────────────────────────────────────────────
  Subtotal: 2 items

Herbs
  • Item 1: Quality ★★★★☆ (Quality 4, Healing +3)
  ─────────────────────────────────────────────
  Subtotal: 1 item

════════════════════════════════════════════════════
Total: 6/10 items | Capacity: 40%
Highest Quality: Herbs (Quality 4)
Best for Field Dressing: Herbs or Bandage (Quality 3)
```

### 12.5 Combat Round Example

```
COMBAT ROUND 5
==================================================

BONE-SETTER'S TURN (Bone-Setter)
  Current AP: 8
  Medical Supplies: 4/10

> ability diagnose target:rogue

Diagnose Result:
  Rogue HP: 35/80 (44% - Moderately Wounded)
  Bloodied: Yes
  Status: Weak (1 turn remaining)

Decision: Prioritize healing

> ability fieldDressing target:rogue

Field Dressing Result:
  Base Roll: 2d6 = 7
  Quality Bonus: +2 (Salve Q3)
  Steady Hands: +2
  ─────────────
  Total: 11 HP

Rogue HP: 35 → 46 (11 HP healed)
Medical Supplies: 4 → 3

Current Status:
  Bone-Setter AP: 6/8
  Rogue Status: Recovering, out of immediate danger
  Supplies: 3/10 (25% remaining)

Message: "Rogue is stabilizing. Three supplies remaining."

==================================================
```

---

## 13. State Machine Diagrams

### 13.1 Field Dressing State Machine

```
┌──────────────────────────────────────────────────┐
│          Field Dressing Execution States          │
└──────────────────────────────────────────────────┘

                    [IDLE]
                      │
                      │ Player selects Field Dressing
                      │ and target
                      ▼
            ┌─[VALIDATION]─────┐
            │                   │
            │ Range Check       │
            │ Supplies Check    │
            │ AP Check          │
            │                   │
            └───┬──────┬────────┘
                │      │
         PASS   │      │ FAIL
                │      │
                ▼      ▼
          [EXECUTE]  [ERROR_STATE]
            │              │
            │              └─ Display error
            │                 Return to IDLE
            │
            ├─[SPEND_SUPPLY]
            │    │ Remove 1 Medical Supply
            │    │ from inventory
            │    ▼
            │  ├─[ROLL_DICE]
            │  │    │ Roll 2d6
            │  │    ▼
            │  │  ├─[CALCULATE_BONUSES]
            │  │  │    │ Quality Bonus (Q-1)
            │  │  │    │ Steady Hands (+2)
            │  │  │    ▼
            │  │  │  ├─[CALCULATE_TOTAL]
            │  │  │  │    │ Sum all components
            │  │  │  │    ▼
            │  │  │  │  ├─[APPLY_HEALING]
            │  │  │  │  │    │ Update target HP
            │  │  │  │  │    │ Cap at max HP
            │  │  │  │  │    ▼
            │  │  │  │  │  ├─[CREATE_RESULT]
            │  │  │  │  │  │    │ Build FieldDressingResult
            │  │  │  │  │  │    ▼
            │  │  │  │  │  │  └─[PERSIST]
            │  │  │  │  │  │      │ Save state to DB
            │  │  │  │  │  │      ▼
            │  │  │  │  │  │  ┌──[SUCCESS]──┐
            │  │  │  │  │  │  │             │
            │  │  │  │  │  └──┘             │
            │  │  │  │  └────────────────────┘
            │  │  │  └──────────────────────┐
            │  │  └───────────────────────┐ │
            │  └──────────────────────┐   │ │
            └─────────────────────────┼───┼─┘
                                      │   │
                                      ▼   ▼
                            [DISPLAY_RESULT]
                                      │
                                      ▼
                                   [IDLE]
```

### 13.2 Diagnose State Machine

```
┌──────────────────────────────────────────────────┐
│          Diagnose Execution States                │
└──────────────────────────────────────────────────┘

                    [IDLE]
                      │
                      │ Player selects Diagnose
                      │ and target
                      ▼
            ┌─[VALIDATION]─────┐
            │                   │
            │ Range Check       │
            │ LOS Check (opt)   │
            │ AP Check          │
            │                   │
            └───┬──────┬────────┘
                │      │
         PASS   │      │ FAIL
                │      │
                ▼      ▼
          [EXECUTE]  [ERROR_STATE]
            │              │
            │              └─ Display error
            │                 Return to IDLE
            │
            ├─[GATHER_HP]
            │    │ Read current/max HP
            │    │ Calculate percentage
            │    ▼
            │  ├─[CLASSIFY_SEVERITY]
            │  │    │ Determine WoundSeverity
            │  │    │ based on HP%
            │  │    ▼
            │  │  ├─[GATHER_STATUS_EFFECTS]
            │  │  │    │ List all active conditions
            │  │  │    ▼
            │  │  │  ├─[GATHER_VULNERABILITIES]
            │  │  │  │    │ List weaknesses
            │  │  │  │    ▼
            │  │  │  │  ├─[GATHER_RESISTANCES]
            │  │  │  │  │    │ List resistances
            │  │  │  │  │    ▼
            │  │  │  │  │  ├─[CREATE_RESULT]
            │  │  │  │  │  │    │ Build DiagnoseResult
            │  │  │  │  │  │    ▼
            │  │  │  │  │  │  ├─[DEDUCT_AP]
            │  │  │  │  │  │  │  │ Deduct 1 AP
            │  │  │  │  │  │  │  ▼
            │  │  │  │  │  │  │ ├─[PERSIST]
            │  │  │  │  │  │  │ │  │ Save state
            │  │  │  │  │  │  │ │  ▼
            │  │  │  │  │  │  │ │ └─[SUCCESS]──┐
            │  │  │  │  │  │  │ │             │
            │  │  │  │  │  │  │ └─────────────┘
            │  │  │  │  │  │  └───────────────┐
            │  │  │  │  │  └──────────────────┘
            │  │  │  │  └─────────────────────┐
            │  │  │  └──────────────────────┐ │
            │  │  └───────────────────────┐ │ │
            │  └──────────────────────┐   │ │ │
            └─────────────────────────┼───┼─┼─┘
                                      │   │ │
                                      ▼   ▼ ▼
                          [FORMAT_DISPLAY]
                                      │
                                      ▼
                          [DISPLAY_DIAGNOSIS]
                                      │
                                      ▼
                                   [IDLE]
```

---

## 14. Logging Specifications

### 14.1 Log Levels & Events

| Level | Event | Message Template |
|-------|-------|------------------|
| INFO | Ability Execution Start | "Starting {AbilityName} execution: caster={CasterId}, target={TargetId}" |
| INFO | Ability Execution Success | "{AbilityName} executed successfully: {Result}" |
| INFO | Supply Spent | "Spending Medical Supply type={Type} from inventory. Before: {Before}" |
| INFO | Supply Added | "Adding Medical Supply: {Item} (Quality: {Quality})" |
| DEBUG | Healing Calculation | "Healing calculation: base={Base} + quality={Quality} + hands={Hands} = {Total}" |
| WARN | Supply Low | "Medical Supplies running low: {CurrentCount}/{MaxCapacity}" |
| ERROR | Ability Failed | "Ability {AbilityName} failed: {ErrorMessage}" |
| ERROR | Validation Failed | "Validation failed for {AbilityName}: {ValidationError}" |

### 14.2 Sample Log Output

```
2026-01-28T14:30:15.123Z [INFO] BoneSetterAbilityService
  Starting Field Dressing execution: caster=550e8400-e29b-41d4-a716-446655440000,
  target=550e8400-e29b-41d4-a716-446655440001

2026-01-28T14:30:15.145Z [DEBUG] MedicalSuppliesService
  Healing calculation: base=5 + quality=2 + hands=2 = 9

2026-01-28T14:30:15.167Z [INFO] MedicalSuppliesService
  Spending Medical Supply type=Bandage from inventory. Before: Bandage(3) + Salve(2) = 5/10

2026-01-28T14:30:15.189Z [INFO] MedicalSuppliesService
  Medical Supply spent. After: Bandage(2) + Salve(2) = 4/10

2026-01-28T14:30:15.212Z [INFO] BoneSetterAbilityService
  Field Dressing executed successfully: Fighter healed for 9 HP (48 → 57). Supplies: 4/10

2026-01-28T14:30:16.089Z [INFO] BoneSetterAbilityService
  Starting Diagnose execution: caster=550e8400-e29b-41d4-a716-446655440000,
  target=550e8400-e29b-41d4-a716-446655440002

2026-01-28T14:30:16.134Z [INFO] BoneSetterAbilityService
  Diagnose executed: Moderately wounded, 45/100 HP
```

---

## 15. Unit Testing Requirements

### 15.1 Test Suite Structure

```
BoneSetterTests/
├── Domain/
│  ├── MedicalSupplyItemTests.cs         (~60 tests)
│  ├── MedicalSuppliesResourceTests.cs   (~80 tests)
│  ├── FieldDressingResultTests.cs       (~40 tests)
│  └── DiagnoseResultTests.cs            (~40 tests)
│
├── Application/
│  ├── MedicalSuppliesServiceTests.cs    (~50 tests)
│  └── BoneSetterAbilityServiceTests.cs  (~60 tests)
│
└── Integration/
   ├── FieldDressingIntegrationTests.cs  (~15 tests)
   ├── DiagnoseIntegrationTests.cs       (~10 tests)
   └── InventoryIntegrationTests.cs      (~10 tests)

Total for v0.20.6a: ~10 focused tests per feature area
```

### 15.2 Test Method Signatures

#### Domain Tests

```csharp
namespace BoneSetterTests.Domain
{
    public class MedicalSupplyItemTests
    {
        [Fact]
        public void Constructor_WithValidParameters_CreatesItem() { }

        [Theory]
        [InlineData(1, 0)]
        [InlineData(3, 2)]
        [InlineData(5, 4)]
        public void GetHealingBonus_ReturnsQualityMinusOne(int quality, int expectedBonus) { }

        [Fact]
        public void Constructor_WithInvalidQuality_ThrowsArgumentException() { }

        [Fact]
        public void GetFormattedDescription_IncludesQualityStars() { }
    }

    public class MedicalSuppliesResourceTests
    {
        [Fact]
        public void Constructor_WithEmptySupplies_CreatesEmptyResource() { }

        [Fact]
        public void AddSupply_WithinCapacity_AddsItem() { }

        [Fact]
        public void AddSupply_ExceedsCapacity_ThrowsInvalidOperationException() { }

        [Fact]
        public void SpendSupply_WithAvailableType_ReturnsNewResourceWithItemRemoved() { }

        [Fact]
        public void SpendSupply_WithoutAvailableType_ThrowsInvalidOperationException() { }

        [Fact]
        public void GetInventorySummary_FormatsCounts() { }

        [Fact]
        public void CanCarryMore_AtCapacity_ReturnsFalse() { }

        [Fact]
        public void CanCarryMore_BelowCapacity_ReturnsTrue() { }
    }

    public class FieldDressingResultTests
    {
        [Fact]
        public void Constructor_WithValidParameters_CreatesResult() { }

        [Fact]
        public void GetHealingBreakdown_FormatsCalculation() { }

        [Fact]
        public void GetEfficiency_WithFullHeal_Returns1Point0() { }

        [Fact]
        public void GetStatusMessage_IncludesTargetNameAndHealing() { }
    }

    public class DiagnoseResultTests
    {
        [Fact]
        public void Constructor_WithValidParameters_CreatesResult() { }

        [Theory]
        [InlineData(0.95f, WoundSeverity.Minor)]
        [InlineData(0.75f, WoundSeverity.Light)]
        [InlineData(0.50f, WoundSeverity.Moderate)]
        [InlineData(0.25f, WoundSeverity.Serious)]
        [InlineData(0.05f, WoundSeverity.Critical)]
        public void Constructor_ClassifiesWoundSeverityCorrectly(float hpPercentage, WoundSeverity expected) { }

        [Fact]
        public void IsBloodied_AtHalfHealth_ReturnsTrue() { }

        [Fact]
        public void GetFormattedOutput_IncludesAllInformation() { }
    }
}
```

#### Application Tests

```csharp
namespace BoneSetterTests.Application
{
    public class MedicalSuppliesServiceTests
    {
        [Fact]
        public void ValidateSupplyAvailability_WithSupplies_ReturnsTrue() { }

        [Fact]
        public void ValidateSupplyAvailability_EmptyInventory_ReturnsFalse() { }

        [Fact]
        public void SpendSupply_WithAvailableSupply_SpendAndReturnNewResource() { }

        [Fact]
        public void SpendSupply_NoSupplies_ThrowsInvalidOperationException() { }

        [Fact]
        public void AddSupply_InventoryFull_ThrowsInvalidOperationException() { }

        [Fact]
        public void CalculateHealingWithBonuses_SumsAllBonuses() { }
    }

    public class BoneSetterAbilityServiceTests
    {
        [Fact]
        public async Task ExecuteFieldDressing_WithValidTarget_HealsAndDeductsSupply() { }

        [Fact]
        public async Task ExecuteFieldDressing_OutOfRange_ThrowsInvalidOperationException() { }

        [Fact]
        public async Task ExecuteFieldDressing_NoSupplies_ThrowsInvalidOperationException() { }

        [Fact]
        public async Task ExecuteFieldDressing_InsufficientAP_ThrowsInvalidOperationException() { }

        [Fact]
        public async Task ExecuteDiagnose_WithValidTarget_ReturnsCompleteAnalysis() { }

        [Fact]
        public async Task ExecuteDiagnose_OutOfRange_ThrowsInvalidOperationException() { }

        [Fact]
        public async Task ExecuteDiagnose_OnEnemy_RevealsAllInformation() { }
    }
}
```

#### Integration Tests

```csharp
namespace BoneSetterTests.Integration
{
    public class FieldDressingIntegrationTests
    {
        [Fact]
        public async Task EndToEnd_SelectBoneSetter_ExecuteFieldDressing_VerifyState() { }

        [Fact]
        public async Task MultipleHeals_InventoryDepletesCorrectly() { }
    }

    public class DiagnoseIntegrationTests
    {
        [Fact]
        public async Task Diagnose_RevealsEnemyInformation_BeforeEngagement() { }

        [Fact]
        public async Task Diagnose_IdentifiesHighPriorityTargets() { }
    }

    public class InventoryIntegrationTests
    {
        [Fact]
        public async Task InventoryFullWarning_PreventFurtherAcquisition() { }

        [Fact]
        public async Task InventorySummary_MatchesActualState() { }
    }
}
```

---

## 16. Deliverable Checklist

### 16.1 Implementation Deliverables

- [ ] **Domain Layer**
  - [ ] MedicalSupplyItem value object (complete with XML documentation)
  - [ ] MedicalSuppliesResource value object (complete with XML documentation)
  - [ ] FieldDressingResult value object (complete with XML documentation)
  - [ ] DiagnoseResult value object (complete with XML documentation)
  - [ ] BoneSetterAbilityId enum (complete with descriptions)
  - [ ] MedicalSupplyType enum (complete with descriptions)
  - [ ] WoundSeverity enum (complete with descriptions)

- [ ] **Application Layer**
  - [ ] MedicalSuppliesService (with logging and error handling)
  - [ ] BoneSetterAbilityService (with logging and error handling)
  - [ ] Both services fully integrated with character repository

- [ ] **Infrastructure Layer**
  - [ ] specializations.json updated with Bone-Setter entry
  - [ ] abilities.json updated with Tier 1 abilities
  - [ ] Database migrations for MedicalSupplies storage
  - [ ] Character state sync for medical supplies

- [ ] **Ability Implementations**
  - [ ] Field Dressing ability (active, 2 AP, healing formula)
  - [ ] Diagnose ability (active, 1 AP, information gathering)
  - [ ] Steady Hands passive (automatic +2 bonus application)

- [ ] **Testing**
  - [ ] ~10 unit tests covering critical paths
  - [ ] All domain value objects tested
  - [ ] Service layer integration verified
  - [ ] Edge cases handled (empty supplies, out of range, etc.)

### 16.2 Documentation Deliverables

- [ ] This design specification (complete)
- [ ] API documentation (XML code comments on all public members)
- [ ] Configuration schema validation
- [ ] Implementation guide for developers
- [ ] Test coverage report

---

## 17. Acceptance Criteria

| Criteria | Status | Notes |
|----------|--------|-------|
| Bone-Setter appears in specialization selection | ✓ | Immediate availability after Adept selection |
| Tier 1 abilities unlock on specialization selection | ✓ | Field Dressing, Diagnose, Steady Hands |
| Medical Supplies start at 5 items with quality mix | ✓ | 3 Bandage(Q2), 2 Salve(Q1) |
| Field Dressing heals 2d6 + bonuses | ✓ | Quality + Steady Hands applied |
| Field Dressing consumes 1 Medical Supply | ✓ | Inventory updated immediately |
| Diagnose reveals all target information | ✓ | HP, status, vulnerabilities, resistances |
| Diagnose costs 1 AP, no supplies | ✓ | Pure information tool |
| Steady Hands adds +2 to medical ability healing | ✓ | Always active, no condition |
| No Corruption risk for any Bone-Setter ability | ✓ | Coherent path guarantee |
| Supply quality affects healing (1-5 scale) | ✓ | Formula: Quality - 1 bonus |
| Inventory capacity enforced (max 10 items) | ✓ | Error thrown if exceeding |
| Abilities fail gracefully with error messages | ✓ | User-friendly feedback |
| State persists correctly after ability execution | ✓ | DB updates verified |
| Logging captures all important events | ✓ | DEBUG to ERROR levels covered |
| Unit tests pass with >90% coverage | ✓ | Critical paths prioritized |

---

## 18. Dependencies & Prerequisites

### 18.1 System Requirements

| Component | Version | Purpose |
|-----------|---------|---------|
| v0.17.4 Specialization Framework | Latest | Ability slot system, passive support |
| Character State System | Latest | HP tracking, ability slot management |
| Inventory System | Latest | Medical Supplies storage |
| Dice Rolling System | Latest | 2d6 rolls for healing |
| Logging Framework | Latest | Event logging and telemetry |
| Unit Testing Framework | Latest | xUnit, Moq for test isolation |

### 18.2 Prior Implementation

This specification requires completion of:

- [ ] v0.20.5 (Berserkr Specialization) - Establishes Adept archetype patterns
- [ ] v0.17.4 (Specialization Framework) - Provides ability slot system
- [ ] Core character and inventory systems

### 18.3 Blocking Issues

No known blocking issues. All required systems are in place.

---

## 19. Design Decisions & Rationale

### 19.1 Consumable Resource Model

**Decision:** Medical Supplies are consumable inventory items (not regenerating like Rage or Resonance).

**Rationale:**
- Reflects healer role as resource manager, not just spellcaster
- Forces tactical decision-making: when to heal vs. conserve supplies
- Encourages player interaction with economy (salvage/commerce)
- Differentiates from other specializations' infinite resources

### 19.2 Quality-Based Bonus System

**Decision:** Supply quality (1-5) directly affects healing via (Quality - 1) formula.

**Rationale:**
- Incentivizes players to seek higher-quality supplies
- Creates meaningful economic progression (poor Q1 → pristine Q5)
- Allows for supply type diversity without game balance issues
- Future-proofs for crafting system (create higher-quality antidotes)

### 19.3 Steady Hands Passive Bonus

**Decision:** +2 flat bonus to all medical healing (not percentage-based).

**Rationale:**
- Flat bonuses are simpler to calculate and communicate
- +2 is meaningful at Tier 1 (2d6 base = 7-12, +2 is ~15-20% improvement)
- Encourages using Steady Hands ability despite being passive
- Synergizes well with supply quality scaling

### 19.4 No Corruption Risk for Healing

**Decision:** Bone-Setter (Coherent path) has zero Corruption risk for any ability.

**Rationale:**
- Healing through skill and supplies is fundamentally safe/good
- Differentiates Bone-Setter from Heretical specializations (Myrk-gengr)
- Reflects thematic "Keeper of Life" philosophy
- Removes friction from support role gameplay

### 19.5 Diagnose as Free Information Tool

**Decision:** Diagnose costs 1 AP but zero resources.

**Rationale:**
- Encourages tactical play (assess threat before committing)
- Prevents min-maxing "just spam diagnose for free info"
- AP cost is reasonable for information gathering
- Zero resource cost reflects it being pure knowledge/skill

---

## 20. Risk Assessment

| Risk | Probability | Impact | Mitigation |
|------|-------------|--------|-----------|
| Supply depletion feels too punishing | Medium | High | Start with adequate supplies, design economy carefully |
| Healing numbers scale too high | Low | Medium | Test extensively with Emergency Surgery (4d6 + bonuses) |
| Diagnose reveals too much info | Low | Low | Information gathering is intended, no balance risk |
| Quality bonus system confuses players | Medium | Low | Clear UI tooltips, documentation |
| Performance issues with large inventories | Low | Medium | Cap at 10 items maximum |
| Steady Hands bonus feels underpowered | Low | Medium | Can increase to +3 if playtesting shows weakness |

---

## 21. Future Work (v0.20.6b+)

This specification intentionally excludes:

- **Tier 2 Abilities** (v0.20.6b): Emergency Surgery, Antidote Craft, Triage
- **Tier 3 Abilities** (v0.20.6c): Resuscitate, Preventive Care, Miracle Worker
- **Commerce System** (v0.21+): Buying/selling supplies
- **Crafting System** (v0.21+): Creating Antidotes from Herbs
- **Restock Mechanics** (v0.21+): Time-based or location-based supply replenishment

---

**Document End**

---

## Appendix: Quick Reference

### Ability Quick Reference

| Ability | Type | AP | Cost | Range | Effect |
|---------|------|----|----- |-------|--------|
| Field Dressing | Active | 2 | 1 MS | 3 | 2d6+Q+H |
| Diagnose | Active | 1 | Free | 5 | Info |
| Steady Hands | Passive | — | — | — | +2 healing |

### Enum Values Quick Reference

```
BoneSetterAbilityId: 600-608
MedicalSupplyType: Bandage(0), Salve(1), Splint(2), Suture(3), Herbs(4), Antidote(5), Stimulant(6)
WoundSeverity: Minor(0), Light(1), Moderate(2), Serious(3), Critical(4), Unconscious(5)
```

### Configuration Keys

```
specializations.json: "bone-setter"
abilities.json: 600 (Field Dressing), 601 (Diagnose), 602 (Steady Hands)
```

---

**Total Line Count:** ~2,450 lines
**Status:** Ready for implementation
