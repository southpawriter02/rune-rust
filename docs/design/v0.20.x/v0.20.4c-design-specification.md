# Design Specification: v0.20.4c - Myrk-gengr Tier 3 Abilities & Capstone

**Version:** v0.20.4c
**Status:** Design Phase
**Last Updated:** 2026-01-28
**Target Tests:** ~7 unit and integration tests
**Specialization:** Myrk-gengr (Shadow-Walker)
**Prerequisites:** v0.20.4a & v0.20.4b Complete
**Archetype:** Skirmisher

---

## Table of Contents

1. [Executive Summary](#1-executive-summary)
2. [Tier 3 & Capstone Specialization Overview](#2-tier-3--capstone-specialization-overview)
3. [Architecture Diagrams](#3-architecture-diagrams)
4. [Domain Model Specifications](#4-domain-model-specifications)
5. [Merge with Darkness Ability Specification](#5-merge-with-darkness-ability-specification)
6. [Shadow Snare Ability Specification](#6-shadow-snare-ability-specification)
7. [Eclipse Ability Specification](#7-eclipse-ability-specification)
8. [Tier 3 & Capstone Unlock Mechanics](#8-tier-3--capstone-unlock-mechanics)
9. [User Stories](#9-user-stories)
10. [Application Service Layer](#10-application-service-layer)
11. [Incorporeal State System](#11-incorporeal-state-system)
12. [Shadow Snare Effect System](#12-shadow-snare-effect-system)
13. [Eclipse Zone Mechanics](#13-eclipse-zone-mechanics)
14. [Configuration Specifications](#14-configuration-specifications)
15. [Light Extinguishing System](#15-light-extinguishing-system)
16. [State Machine Diagrams](#16-state-machine-diagrams)
17. [Corruption Mechanics for Tier 3](#17-corruption-mechanics-for-tier-3)
18. [Combat Scenarios & Examples](#18-combat-scenarios--examples)
19. [Logging Specifications](#19-logging-specifications)
20. [Unit Testing Requirements](#20-unit-testing-requirements)
21. [Deliverable Checklist](#21-deliverable-checklist)
22. [Acceptance Criteria](#22-acceptance-criteria)
23. [Design Decisions & Rationale](#23-design-decisions--rationale)

---

## 1. Executive Summary

Version 0.20.4c implements the **final tier and capstone** for the Myrk-gengr specialization, representing the pinnacle of shadow mastery. These powerful abilities enable complete incorporeality, enemy immobilization, and ultimate environmental control through darkness itself.

### Key Deliverables

| Category | Count | Details |
|----------|-------|---------|
| **Tier 3 Abilities** | 2 | Merge with Darkness, Shadow Snare |
| **Capstone Ability** | 1 | Eclipse (Ultimate) |
| **Domain Value Objects** | 3 | IncorporealState, ShadowSnareEffect, EclipseZone |
| **Domain Enums** | 1 | IncorporealRestriction |
| **Application Services** | 3 | Tier3AbilityService, IncorporealStateManager, EclipseZoneManager |
| **Area Effect System** | 1 | Light extinguishing mechanics |
| **Configuration Updates** | 1 | abilities.json Tier 3 & Capstone |
| **Unit Tests** | ~7 | Comprehensive ability testing |

### Tier 3 & Capstone Profile

| Ability | Type | AP Cost | Essence Cost | Range | PP Cost | Notes |
|---------|------|---------|--------------|-------|---------|-------|
| **Merge with Darkness** | Active | 3 AP | 25 | Self | 5 PP | Incorporeal for 1 turn |
| **Shadow Snare** | Active | 2 AP | 20 | 6 spaces | 5 PP | Root enemy for 2 turns |
| **Eclipse** | Ultimate | 5 AP | 40 | 8 radius | 6 PP | Capstone: darkness zone |

**Unlock Requirements:**
- Tier 3: 16 PP invested in Myrk-gengr tree
- Capstone: 24 PP invested (full tree)

---

## 2. Tier 3 & Capstone Specialization Overview

### 2.1 Design Philosophy

**Tier 3 & Capstone represent ultimate shadow mastery:**

- **Merge with Darkness** adds defensive transformation (escape/protection)
- **Shadow Snare** enables crowd control (tactical enemy management)
- **Eclipse** provides ultimate environmental control (game-changing ability)

### 2.2 Combat Role Transformation

**Before Tier 3:** Stealth, offense, magical defense
**With Tier 3:** Stealth + offense + defense + crowd control
**With Capstone:** Master of darkness, reshaper of the battlefield

### 2.3 Power Level & Balance

```
Tier 1 (Foundation):    0 PP cost, always available
Tier 2 (Expansion):     4 PP each, 8 PP gate
Tier 3 (Enhancement):   5 PP each, 16 PP gate
Capstone (Ultimate):    6 PP, 24 PP gate (full tree investment)

Power Scaling:
├─ Tier 1: Baseline abilities
├─ Tier 2: 1.5x power level, new mechanics
├─ Tier 3: 2.5x power level, complex abilities
└─ Capstone: 4x power level, game-changing ultimate
```

---

## 3. Architecture Diagrams

### 3.1 Tier 3 Service Layer Architecture

```
┌──────────────────────────────────────────────────────────────────┐
│         v0.20.4c - Tier 3 Application Services Layer             │
├──────────────────────────────────────────────────────────────────┤
│                                                                   │
│  ┌────────────────────────┐  ┌──────────────────────────────┐   │
│  │ ITier3AbilityService   │  │ IIncorporealStateManager     │   │
│  │ (Interface)            │  │ (Interface)                  │   │
│  ├────────────────────────┤  ├──────────────────────────────┤   │
│  │ + ExecuteMergeWithDarkn│  │ + CreateIncorporealState()   │   │
│  │ + ExecuteShadowSnare() │  │ + EndIncorporealState()      │   │
│  │ + ExecuteEclipse()     │  │ + ExtendIncorporeal()        │   │
│  │ + CanUseAbility()      │  │ + GetActiveIncorporeal()     │   │
│  │ + GetAbilityInfo()     │  │ + TakeDamageWhileIncorp()    │   │
│  │ + CalculateEclipseDmg()│  │ + TickIncorporealState()     │   │
│  └────────┬───────────────┘  │ + ProcessPhasing()           │   │
│           │                   └──────────┬───────────────────┘   │
│           └────────────┬─────────────────┘                       │
│                        │                                         │
│  ┌────────────────────────────────────────────────────────────┐  │
│  │ IEclipseZoneManager                                        │  │
│  │ (Massive Area Effect Management)                          │  │
│  ├────────────────────────────────────────────────────────────┤  │
│  │ + CreateEclipseZone()                                      │  │
│  │ + EndEclipseZone()                                         │  │
│  │ + GetEclipseZones()                                        │  │
│  │ + IsPositionInEclipse()                                    │  │
│  │ + ExtinguishLightInZone()                                  │  │
│  │ + GenerateEssencePerTurn()                                 │  │
│  │ + TickEclipseZone()                                        │  │
│  │ + EvaluateAlliesAndEnemies()                               │  │
│  └────────┬─────────────────────────────────────────────────┘   │
│           │                                                      │
│           ▼                                                      │
│  ┌────────────────────────────────────────────────────────────┐  │
│  │ ILightExtinguishmentService (NEW)                          │  │
│  │ (Magical light save system)                                │  │
│  ├────────────────────────────────────────────────────────────┤  │
│  │ + CalculateLightSaveDc()                                   │  │
│  │ + EvaluateMagicalLight()                                   │  │
│  │ + ExtinguishLight()                                        │  │
│  │ + CreateDarknessZone()                                     │  │
│  └────────────────────────────────────────────────────────────┘  │
│                                                                   │
└──────────────────────────────────────────────────────────────────┘

Tier 3 Dependencies:
├─ v0.20.4a & v0.20.4b (All Tier 1/2 systems)
├─ Light Management System
└─ Area Effect Framework
```

### 3.2 Incorporeal State Entity Diagram

```
┌────────────────────────────────────────────────────┐
│     IncorporealState (Value Object)                │
├────────────────────────────────────────────────────┤
│ • StateId: Guid                                    │
│ • CharacterId: Guid                                │
│ • StartedAt: DateTime                              │
│ • EndsAt: DateTime                                 │
│ • TurnsRemaining: int (1+)                         │
│ • WasExtended: bool                                │
│ • ExtensionCount: int (0+)                         │
│ • CorruptionAccrued: int                           │
│ • CanPassThrough: bool (wall phasing)              │
│ • VulnerableToMagicalLight: bool                   │
└────────────────────────────────────────────────────┘
         │
         ├─► Active (1 turn default)
         │   ├─► Can move through objects
         │   ├─► Cannot be targeted by physical attacks
         │   ├─► Cannot attack or interact
         │   ├─► Vulnerable to magical light (2d6)
         │   └─► Can extend (+1 turn, +25 essence, +1 corruption)
         │
         └─► Ending
             ├─► Return to physical form
             ├─► Appear in original space (or nearest safe)
             └─► Resume normal combat
```

### 3.3 Eclipse Zone Diagram

```
┌──────────────────────────────────────────────┐
│      EclipseZone (Value Object)              │
├──────────────────────────────────────────────┤
│ • ZoneId: Guid                               │
│ • CasterId: Guid                             │
│ • CenterPosition: Position                   │
│ • Radius: int (8 spaces)                     │
│ • TurnsRemaining: int (3)                    │
│ • ExtinguishedLights: List<Guid>             │
│ • EssenceGenerated: int (accumulating)       │
│ • CorruptionGenerated: int (2 minimum)       │
│ • CreatedAt: DateTime                        │
│ • AffectedPositions: List<Position>          │
└──────────────────────────────────────────────┘
         │
         ├─► All light extinguished
         │   ├─► Mundane lights: automatic
         │   ├─► Magical lights: DC 16 save
         │   └─► Divine/Aetheric: may pierce
         │
         ├─► Caster effects
         │   ├─► 50% concealment (miss chance)
         │   ├─► Can see normally within zone
         │   ├─► Generates +10 essence/turn
         │   └─► +2 corruption applied
         │
         └─► Ally/Enemy effects
             ├─► All blinded (no darkvision)
             ├─► Cannot see allies/enemies
             └─► Except caster sees everything
```

---

## 4. Domain Model Specifications

### 4.1 IncorporealState (Value Object)

**Purpose:** Tracks a character's incorporeal (ghost-like) transformation state.

**Properties:**

```csharp
public sealed record IncorporealState
{
    /// <summary>Unique identifier for this incorporeal state.</summary>
    public Guid StateId { get; init; }

    /// <summary>Character ID in incorporeal state.</summary>
    public Guid CharacterId { get; init; }

    /// <summary>When state began.</summary>
    public DateTime StartedAt { get; init; }

    /// <summary>When state ends.</summary>
    public DateTime EndsAt { get; init; }

    /// <summary>Turns remaining in state (1-based).</summary>
    public int TurnsRemaining { get; private set; }

    /// <summary>Was this state extended beyond original duration.</summary>
    public bool WasExtended { get; private set; }

    /// <summary>Number of times extended.</summary>
    public int ExtensionCount { get; private set; }

    /// <summary>Total corruption accrued during state.</summary>
    public int CorruptionAccrued { get; private set; }

    /// <summary>Can character pass through solid objects.</summary>
    public bool CanPassThrough { get; init; } = true;

    /// <summary>Is character vulnerable to magical light damage.</summary>
    public bool VulnerableToMagicalLight { get; init; } = true;

    /// <summary>Original position before incorporation (for ejection safety).</summary>
    public Position OriginalPosition { get; init; }

    /// <summary>Current position as incorporeal.</summary>
    public Position CurrentPosition { get; set; }
}
```

**Factory Method:**

```csharp
public static IncorporealState Create(
    Guid characterId,
    Position originalPosition,
    int durationTurns = 1)
{
    return new IncorporealState
    {
        StateId = Guid.NewGuid(),
        CharacterId = characterId,
        StartedAt = DateTime.UtcNow,
        EndsAt = DateTime.UtcNow.AddSeconds(durationTurns * 6), // 6 sec per turn
        TurnsRemaining = durationTurns,
        WasExtended = false,
        ExtensionCount = 0,
        CorruptionAccrued = 0,
        CanPassThrough = true,
        VulnerableToMagicalLight = true,
        OriginalPosition = originalPosition,
        CurrentPosition = originalPosition
    };
}
```

**Query Methods:**

| Method | Returns | Purpose |
|--------|---------|---------|
| IsActive() | `bool` | Not expired |
| IsExpired() | `bool` | DateTime.UtcNow > EndsAt |
| GetSecondsRemaining() | `int` | Time until expiration |
| CanExtend() | `bool` | Still has extension uses |
| CanPassThroughSolid(pos) | `bool` | Can move to solid object |
| IsPhasedInto(pos) | `bool` | Is character embedded in solid |

### 4.2 ShadowSnareEffect (Value Object)

**Purpose:** Represents a shadow-based root effect on a target.

**Properties:**

```csharp
public sealed record ShadowSnareEffect
{
    /// <summary>Unique identifier for this snare.</summary>
    public Guid EffectId { get; init; }

    /// <summary>Character who cast the snare.</summary>
    public Guid CasterId { get; init; }

    /// <summary>Character affected by snare.</summary>
    public Guid TargetId { get; init; }

    /// <summary>When snare was applied.</summary>
    public DateTime StartedAt { get; init; }

    /// <summary>Turns remaining before auto-release.</summary>
    public int TurnsRemaining { get; private set; }

    /// <summary>DC for escape save (14).</summary>
    public int SaveDc { get; init; } = 14;

    /// <summary>Has target escaped (successful save).</summary>
    public bool HasEscaped { get; private set; }

    /// <summary>How did target escape (if applicable).</summary>
    public string EscapeMethod { get; private set; }

    /// <summary>Shadow that binds the target.</summary>
    public ShadowBinding ShadowBinding { get; init; }

    /// <summary>Conditions that break snare.</summary>
    public IReadOnlyList<BreakCondition> BreakConditions { get; init; }
}

public sealed record ShadowBinding
{
    public Guid TargetShadowId { get; init; }
    public Position ShadowLocation { get; init; }
    public int Strength { get; init; } // Resistance level
}

public enum BreakCondition
{
    SuccessfulSave,
    BrightLight,
    DispelMagic,
    TargetDies,
    CasterDies,
    TargetTeleported
}
```

### 4.3 EclipseZone (Value Object)

**Purpose:** Tracks a massive area of total darkness and concealment.

**Properties:**

```csharp
public sealed record EclipseZone
{
    /// <summary>Unique identifier for this eclipse.</summary>
    public Guid ZoneId { get; init; }

    /// <summary>Character who created the eclipse.</summary>
    public Guid CasterId { get; init; }

    /// <summary>Center position of eclipse.</summary>
    public Position CenterPosition { get; init; }

    /// <summary>Radius of eclipse (8 spaces).</summary>
    public int Radius { get; init; } = 8;

    /// <summary>Turns remaining (3).</summary>
    public int TurnsRemaining { get; private set; }

    /// <summary>Lights extinguished by eclipse.</summary>
    public IReadOnlyList<Guid> ExtinguishedLights { get; private set; }

    /// <summary>Total shadow essence generated (caster only).</summary>
    public int EssenceGenerated { get; private set; }

    /// <summary>Corruption from eclipse (minimum +2).</summary>
    public int CorruptionGenerated { get; init; } = 2;

    /// <summary>When eclipse was created.</summary>
    public DateTime CreatedAt { get; init; }

    /// <summary>All affected positions within radius.</summary>
    public IReadOnlyList<Position> AffectedPositions { get; init; }

    /// <summary>Characters in eclipse (excluding caster).</summary>
    public IReadOnlyList<Guid> AffectedCharacters { get; init; }
}

public enum LightSaveResult
{
    Extinguished,
    SavedButDimmed,
    PartiallyResistent,
    Unaffected
}
```

---

## 5. Merge with Darkness Ability Specification

### 5.1 Core Mechanics

**Type:** Active Transformation Ability
**AP Cost:** 3 AP
**Shadow Essence Cost:** 25
**Range:** Self
**Duration:** 1 turn (6 seconds)
**PP Cost to Unlock:** 5 PP
**Prerequisite:** 16 PP invested in Myrk-gengr tree
**Cooldown:** None (essence is limiter)
**Extension:** Can extend +25 essence, +1 corruption per extension

### 5.2 Transformation Effects

**While Incorporeal:**

```
Passive Effects:
├─ Cannot be targeted by physical attacks
├─ Can move through solid objects (walls, buildings, terrain)
├─ Cannot interact with physical objects
├─ Cannot attack or use physical abilities
├─ Immune to opportunity attacks
├─ Immune to non-magical damage
└─ Must stay above ground (cannot go below sea level, etc.)

Restrictions:
├─ Cannot end turn embedded in solid object
├─ If forced into solid: Take 3d6 damage and ejected to nearest safe space
├─ Cannot use most abilities (Shadow Step only works)
├─ Cannot carry objects through phasing
└─ Cannot affect physical world while incorporeal
```

**Movement & Positioning:**

```
• Full movement speed applies (not hindered by objects)
• Can pass through walls, doors, terrain
• Cannot pass through magical barriers (Aetheric seals, etc.)
• Cannot enter or pass through areas of bright light
• Can move into darkness or shadow normally
```

**Combat Interactions:**

```
Attacks against you:
• Physical attacks: Automatic miss
• Magical attacks: Can target and affect you
• Light-based magic: Deals 2d6 vulnerability damage
• Shadow/darkness magic: Ignores incorporeal (full effect)

You against enemies:
• Cannot attack physically
• Cannot use Umbral Strike (requires physical form)
• Shadow Step: Can use (remains shadow magic)
• Cloak of Night: Cannot use (requires physical form)
```

### 5.3 Extension Mechanic

**Extending Duration:**

```
Before turn ends (while still incorporeal):
├─ Spend additional 25 Shadow Essence
├─ +1 Corruption applied
├─ Duration extends +1 turn
├─ Can extend multiple times (no limit on extensions)
└─ Each extension costs another 25 + 1 corruption

Example:
Turn 1: Merge (3 AP, 25 essence) → Incorporeal 1 turn
Turn 2: Still incorporeal, extend (0 AP, 25 essence, +1 corr) → 1 more turn
Turn 3: Still incorporeal, extend (0 AP, 25 essence, +1 corr) → 1 more turn
Total: 3 turns incorporeal, 75 essence, +2 corruption
```

**Extension Restrictions:**

```
Cannot extend if:
• Shadow Essence < 25 (insufficient to extend)
• Already extended 3 times (diminishing returns)
• Caster is incapacitated
• Current turn ends (extensions only during turn)
```

### 5.4 Exiting Incorporeal Form

**Automatic Ending:**

```
At end of turn (after extensions chosen):
├─ If 0 turns remaining: Exit incorporeal, return to physical
├─ Appear at current position
└─ If position is solid: Ejected to nearest safe space

Forced Ejection:
├─ Take 3d6 damage
├─ Exit incorporeal form immediately
├─ Appear adjacent to solid object
└─ Use remaining movement to escape
```

**Light-Based Ejection:**

```
If target encounters bright light while incorporeal:
├─ Light-based spell damage: 2d6 vulnerability
├─ If damage >= current HP: Forced to exit incorporeal
└─ May choose to exit early to avoid bright light
```

### 5.5 Tactical Applications

**Escape Use:**

```
Scenario: Character surrounded, need to escape
├─ Use Merge with Darkness (3 AP, 25 essence)
├─ Phase through walls/obstacles
├─ Move 30+ feet (full movement through terrain)
├─ Exit incorporeal at safe location
└─ Result: Escape combat or reposition
```

**Reconnaissance Use:**

```
Scenario: Need to scout fortified location
├─ Use Merge with Darkness
├─ Phasing allows viewing interior without entry
├─ Move through walls to observe enemy positions
├─ Exit at safe distance
└─ Return to party with intelligence
```

**Survival Use:**

```
Scenario: Taking massive damage, desperate survival
├─ Use Merge with Darkness (3 AP, 25 essence)
├─ Incorporeal makes you unkillable by physical attacks
├─ Extend duration if enemy attacks with physical weapons
├─ Exit and heal when safe
└─ Result: Time to recover without death
```

---

## 6. Shadow Snare Ability Specification

### 6.1 Core Mechanics

**Type:** Active Control Ability
**AP Cost:** 2 AP
**Shadow Essence Cost:** 20
**Range:** 6 spaces (line of effect)
**Duration:** 2 turns (auto-escapes if save succeeds)
**PP Cost to Unlock:** 5 PP
**Prerequisite:** 16 PP invested in Myrk-gengr tree
**Save DC:** 14 (DEX or STR save, target's choice)

### 6.2 Snare Application

**Execution:**

```
1. Target creature within 6 spaces
2. Target must have visible shadow
3. Caster spends 2 AP and 20 Shadow Essence
4. Animate target's shadow
5. Shadow grasps and roots target
6. Target is Rooted (cannot move)
7. Snare lasts 2 turns

Failure Conditions:
├─ Target has no shadow (shadowless creature)
├─ Target is incorporeal
├─ Target is already rooted
├─ Insufficient essence (< 20)
└─ Target is in total darkness (no visible shadow)
```

**Root Effect:**

```
While Rooted:
├─ Cannot move from current space
├─ Cannot use movement
├─ Can still attack normally
├─ Can use ranged abilities
├─ Can use ranged weapons
├─ Cannot be forcibly moved
└─ Cannot dash/run

Perception:
├─ Visible shadow grasping at feet
├─ Dark tendrils holding legs
├─ Distinctive visual indicator
└─ All nearby creatures see effect
```

### 6.3 Save Mechanics

**Initial Application:**

```
When snare applied: No immediate save
Instead: At end of target's next turn
├─ Target rolls save vs DC 14
├─ Choice of DEX or STR modifier
├─ On success: Escapes snare
└─ On failure: Remains rooted
```

**Subsequent Saves:**

```
Turn 1 (Snare applied): No save
Turn 2: Target saves (DC 14)
├─ Success: Escapes, snare ends
├─ Failure: Rooted continues
└─ Snare has 1 turn remaining

Turn 3: If still active, snare auto-expires
├─ Snare automatically ends
└─ Target is free
```

**Save Modifiers:**

| Condition | Modifier | Notes |
|-----------|----------|-------|
| Target in Dim Light | +0 | Normal save |
| Target in Normal Light | -2 to DC | Lighter makes shadow weaker |
| Target in Darkness | +0 | No bonus (shadow obvious) |
| Shadow Resistance | Advantage | Roll twice, use higher |
| Undead (no shadow) | Immune | Cannot snare |

### 6.4 Escape Conditions

**Automatic Break:**

```
Snare breaks immediately if:
├─ Target enters bright light (shadow dispelled)
├─ Caster dies (shadow returns to normal)
├─ Successful dispel magic against snare
├─ Teleportation out of snare area
└─ Shadow is destroyed (magical darkness breaks)

Natural Expiration:
├─ End of Turn 3: Snare auto-expires
└─ Maximum 2 turns of root effect
```

**Save Escape:**

```
Target's Turn 2:
├─ Roll save vs DC 14 (DEX or STR)
├─ Success: Free immediately, snare ends
├─ Failure: Remain rooted, snare continues
└─ Turn 3: Snare auto-expires regardless
```

### 6.5 Corruption Risk

**Triggers:**

```
Target is Coherent-aligned: +1 Corruption
Target is innocent: +1 Corruption
Total: 0-2 Corruption per use
```

---

## 7. Eclipse Ability Specification

### 7.1 Core Mechanics

**Type:** Ultimate Ability (Capstone)
**AP Cost:** 5 AP (requires full action)
**Shadow Essence Cost:** 40 (nearly entire pool)
**Range:** Self (8-space radius zone)
**Duration:** 3 turns
**Cooldown:** Once per combat
**PP Cost to Unlock:** 6 PP
**Prerequisite:** 24 PP invested (full tree)
**Corruption:** Always +2 (mandatory)

### 7.2 Zone Effects

**Darkness Creation:**

```
All light in 8-space radius extinguished:

Mundane Light (torches, lanterns):
├─ Automatically extinguished
└─ Cannot reignite while Eclipse active

Magical Light (seiðr, enchanted):
├─ Save DC 16 (DEX/STR modifier)
├─ Success: Light reduced to dim (not extinguished)
├─ Failure: Light extinguished
└─ Reroll each round if powerful source

Divine/Aetheric Light (divine spells):
├─ GM discretion
├─ May pierce Eclipse with save DC 18+
└─ Powerful sources may resist
```

**Caster Benefits:**

```
Within Eclipse zone:
├─ 50% concealment (enemies miss 50% of attacks)
├─ Can see normally (no vision penalties)
├─ Generate +10 Shadow Essence per turn
├─ Enemies cannot see beyond darkness
└─ Gain advantage on stealth checks
```

**Ally/Enemy Effects:**

```
All others in Eclipse:
├─ Total darkness (blinded)
├─ Cannot see allies/enemies/terrain clearly
├─ Cannot see more than 5 feet
├─ Attack rolls suffer -4 penalty (darkness)
├─ Skill checks have disadvantage
└─ Navigation extremely difficult

Caster sees:
├─ Everything clearly within zone
├─ Can see allies/enemies/terrain
├─ Can coordinate movements
└─ Perfect information advantage
```

### 7.3 Duration & Regeneration

**3-Turn Duration:**

```
Turn 1: Eclipse created
├─ All light extinguished
├─ Caster gains +10 essence
├─ Caster gains +2 corruption
└─ Affects 8 spaces

Turn 2: Eclipse continues
├─ Lights remain extinguished
├─ Caster generates +10 essence
├─ Enemies remain blinded
└─ Zone remains active

Turn 3: Eclipse final turn
├─ Same effects apply
├─ +10 essence generation
├─ After turn ends: Eclipse dissipates
└─ Light gradually returns
```

**Essence Generation:**

```
Each turn in Eclipse zone:
├─ Caster: +10 Shadow Essence
├─ Total over 3 turns: +30 essence
├─ Can exceed max (50 + 30 = 80 potential)
├─ Essence cap removed during Eclipse
└─ Return to 50 cap after Eclipse ends
```

**Corruption Application:**

```
Corruption happens at Eclipse creation:
├─ Immediately apply +2 Corruption
└─ No save, no mitigation

Potential additional:
├─ Using against innocent: +1 (subject to GM)
└─ Total: 2-3 per Eclipse
```

### 7.4 Dispelling & Resistance

**Dispel Magic vs Eclipse:**

```
Dispel Magic (DC 18):
├─ Success: Eclipse ends immediately
├─ Failure: Eclipse continues
└─ Can be attempted once per round

Anti-Magic Field:
├─ Suppresses Eclipse within field
├─ Eclipse continues outside field
├─ Returns when field ends
└─ No essence generation while suppressed
```

**Natural Resistance:**

```
Creatures with Shadow/Dark affinity:
├─ Partially see through Eclipse (disadvantage on blindness)
├─ Movement not penalized in darkness
└─ Regain some offensive capability

Creatures with Light affinity:
├─ Suffer additional -2 to attacks
├─ Cannot cast light-based spells
└─ Desperate disadvantage
```

### 7.5 Strategic Applications

**Offensive Use:**

```
Scenario: Entire enemy group caught in Eclipse
├─ Create Eclipse zone in middle of enemies
├─ All enemies blinded and confused
├─ Caster can see and attack freely
├─ Enemies attack each other or blindly
├─ Result: Tactical advantage for 3 turns
```

**Defensive Use:**

```
Scenario: Outnumbered or need retreat
├─ Create Eclipse to cover escape
├─ Enemies cannot see to pursue
├─ Caster can move freely within darkness
├─ Navigate out of zone while enemies fumble
├─ Result: Guaranteed escape
```

**Environmental Use:**

```
Scenario: Need to hide during daylight
├─ Create Eclipse over fortified position
├─ Provides 3-turn cover in bright environment
├─ Rest/heal/plan within darkness
├─ Return to daylight after zone expires
└─ Result: Daylight advantage reversed
```

### 7.6 Once Per Combat Limitation

**Cooldown Mechanics:**

```
Can use Eclipse:
├─ Once at start of combat
├─ Cannot use again in same encounter
├─ Resets after combat ends (short rest minimum)
└─ Prevents spam/stacking

Purpose:
├─ Prevents dominating entire battle
├─ Forces tactical decision on WHEN to use
├─ Encourages meaningful choices
└─ Maintains challenge for other abilities
```

---

## 8. Tier 3 & Capstone Unlock Mechanics

### 8.1 PP Requirement System

**Tier 3 Unlocking:**

```
Current System:
├─ Tier 1: 0 PP invested (available immediately)
├─ Tier 2: 8 PP invested required
├─ Tier 3: 16 PP invested required
│  ├─ Merge with Darkness: 5 PP
│  └─ Shadow Snare: 5 PP
├─ Capstone: 24 PP invested required
│  └─ Eclipse: 6 PP
└─ Total cost: 32 PP (0 + 4+4+4 + 5+5 + 6)
```

**Lock Validation:**

```
Before Tier 3 unlocked:
1. Check character's total PP in Myrk-gengr: Need 16+
2. Display: "Tier 3 Requires 16 PP"
3. Show progress: (current/16 PP)

Before Capstone unlocked:
1. Check character's total PP in Myrk-gengr: Need 24+
2. Display: "Capstone Requires Full Tree (24 PP)"
3. Show progress: (current/24 PP)
```

**Unlock UI Display:**

```
Tier 3 Abilities (Requires 16 PP):

[LOCKED] Merge with Darkness (5 PP)
├─ Transform into shadow, pass through objects
└─ Status: Unlocked at 16 PP total (current: 10/16 PP)

[LOCKED] Shadow Snare (5 PP)
├─ Root enemy in their own shadow
└─ Status: Unlocked at 16 PP total (current: 10/16 PP)

Capstone (Requires Full Tree - 24 PP):

[LOCKED] Eclipse (6 PP)
├─ Ultimate darkness zone, complete control
└─ Status: Unlocked at 24 PP total (current: 16/24 PP)
```

### 8.2 PP Cost Enforcement

**Per Ability Spending:**

```
Each Tier 3 ability costs 5 PP:
• Total cost for both: 10 PP (16 baseline + 5+5)
• Can selectively purchase (don't need both)

Capstone costs 6 PP:
• Total cost: 6 PP (24 baseline + 6)
• Must have 24 PP already invested to unlock

Full Tree Cost: 32 PP total
├─ Tier 1: 0 PP (free at specialization)
├─ Tier 2: 4+4+4 = 12 PP (8 gate + 3x4)
├─ Tier 3: 5+5 = 10 PP (16 gate + 2x5)
└─ Capstone: 6 PP (24 gate + 6)
```

---

## 9. User Stories

### User Story 1: Emergency Escape via Incorporation

**As a** Myrk-gengr surrounded by enemies
**I want to** become incorporeal and phase through walls
**So that** I can escape certain death

**Acceptance Criteria:**

- [ ] Merge with Darkness costs 3 AP and 25 Shadow Essence
- [ ] Character becomes incorporeal (phased)
- [ ] Physical attacks automatically miss incorporeal character
- [ ] Character can move through solid objects
- [ ] Duration is 1 turn (can be extended)
- [ ] Extension costs 25 essence + 1 corruption
- [ ] Cannot attack while incorporeal
- [ ] Vulnerable to magical light (2d6)
- [ ] Character must exit before turn ends or auto-exits

### User Story 2: Crowd Control with Shadow Snare

**As a** Myrk-gengr controlling the battlefield
**I want to** root an enemy in place using their shadow
**So that** I can prevent them from reaching allies

**Acceptance Criteria:**

- [ ] Shadow Snare costs 2 AP and 20 Shadow Essence
- [ ] Target within 6 spaces with visible shadow
- [ ] Target is Rooted (cannot move)
- [ ] Target can still attack and use abilities
- [ ] Snare lasts 2 turns (or until save succeeds)
- [ ] Target makes save at end of each turn (DC 14)
- [ ] Snare breaks if target enters bright light
- [ ] Coherent-aligned targets trigger +1 Corruption
- [ ] Snare auto-expires after 2 turns maximum

### User Story 3: Ultimate Environmental Control

**As a** fully trained Myrk-gengr using Eclipse capstone
**I want to** reshape the entire battlefield in darkness
**So that** I have complete advantage over all enemies

**Acceptance Criteria:**

- [ ] Eclipse costs 5 AP and 40 Shadow Essence
- [ ] Creates 8-space radius darkness zone
- [ ] All light extinguished (magical lights save DC 16)
- [ ] Caster gains 50% concealment
- [ ] Caster generates +10 essence per turn (3 turns = +30)
- [ ] Enemies blinded and helpless
- [ ] Lasts 3 turns (approximately)
- [ ] Always applies +2 Corruption
- [ ] Once per combat limitation enforced
- [ ] Narrative feedback shows complete dominance

### User Story 4: Unlocking Full Tree

**As a** character specializing in Myrk-gengr
**I want to** invest all 24 PP to unlock the Capstone
**So that** I can access Eclipse and become shadow master

**Acceptance Criteria:**

- [ ] Tier 3 locked until 16 PP invested
- [ ] Each Tier 3 ability costs 5 PP
- [ ] Capstone locked until 24 PP invested
- [ ] Capstone costs 6 PP
- [ ] UI shows clear progression gates
- [ ] Cannot use higher tier abilities until gate met
- [ ] Once unlocked, abilities remain available
- [ ] All 9 abilities available at 24 PP investment

---

## 10. Application Service Layer

### 10.1 ITier3AbilityService Implementation

```csharp
/// <summary>
/// Service for executing Myrk-gengr Tier 3 and Capstone abilities.
/// </summary>
public interface ITier3AbilityService
{
    /// <summary>
    /// Execute Merge with Darkness transformation.
    /// </summary>
    Task<IncorporealState> ExecuteMergeWithDarknessAsync(Guid characterId);

    /// <summary>
    /// Extend current incorporeal state duration.
    /// </summary>
    Task<IncorporealState> ExtendIncorporealAsync(Guid characterId);

    /// <summary>
    /// Execute Shadow Snare root effect.
    /// </summary>
    Task<ShadowSnareEffect> ExecuteShadowSnareAsync(Guid casterId, Guid targetId);

    /// <summary>
    /// Execute Eclipse ultimate ability.
    /// </summary>
    Task<EclipseZone> ExecuteEclipseAsync(Guid characterId, Position centerPosition);

    /// <summary>
    /// Validate if ability can be used.
    /// </summary>
    Task<(bool CanUse, string Reason)> CanUseAbilityAsync(
        Guid characterId,
        MyrkgengrAbilityId abilityId);

    /// <summary>
    /// Get detailed ability information.
    /// </summary>
    Task<AbilityInfo> GetAbilityInfoAsync(
        Guid characterId,
        MyrkgengrAbilityId abilityId);
}

/// <summary>
/// Implementation of Tier 3 ability service.
/// </summary>
public class Tier3AbilityService : ITier3AbilityService
{
    private readonly IShadowEssenceService _essenceService;
    private readonly ICharacterRepository _characterRepository;
    private readonly IIncorporealStateManager _incorporealManager;
    private readonly IEclipseZoneManager _eclipseManager;
    private readonly IShadowCorruptionService _corruptionService;
    private readonly ILogger<Tier3AbilityService> _logger;

    public async Task<IncorporealState> ExecuteMergeWithDarknessAsync(Guid characterId)
    {
        var character = await _characterRepository.GetByIdAsync(characterId);
        if (character?.ShadowEssence == null)
            throw new InvalidOperationException("Character not Myrk-gengr");

        // Validate essence
        if (!await _essenceService.TrySpendEssenceAsync(characterId, 25, "merge-with-darkness"))
            throw new InvalidOperationException("Insufficient Shadow Essence (need 25)");

        // Create incorporeal state
        var incorporeal = IncorporealState.Create(
            characterId,
            character.Position,
            durationTurns: 1);

        await _incorporealManager.AddIncorporealStateAsync(incorporeal);

        _logger.LogInformation(
            "Merge with Darkness: {CharId} transformed, incorporeal for 1 turn",
            characterId);

        return incorporeal;
    }

    public async Task<IncorporealState> ExtendIncorporealAsync(Guid characterId)
    {
        var incorporeal = await _incorporealManager.GetIncorporealStateAsync(characterId);
        if (incorporeal == null || incorporeal.IsExpired())
            throw new InvalidOperationException("No active incorporeal state");

        // Validate essence
        if (!await _essenceService.TrySpendEssenceAsync(characterId, 25, "incorporeal-extension"))
            throw new InvalidOperationException("Insufficient Shadow Essence for extension");

        // Extend
        var extended = incorporeal with
        {
            EndsAt = incorporeal.EndsAt.AddSeconds(6), // +1 turn
            TurnsRemaining = incorporeal.TurnsRemaining + 1,
            WasExtended = true,
            ExtensionCount = incorporeal.ExtensionCount + 1,
            CorruptionAccrued = incorporeal.CorruptionAccrued + 1
        };

        await _incorporealManager.UpdateIncorporealStateAsync(extended);

        _logger.LogInformation(
            "Incorporeal extended: {CharId} | Turns: {Turn} | Corruption: +1",
            characterId, extended.TurnsRemaining);

        return extended;
    }

    public async Task<ShadowSnareEffect> ExecuteShadowSnareAsync(
        Guid casterId,
        Guid targetId)
    {
        var caster = await _characterRepository.GetByIdAsync(casterId);
        var target = await _characterRepository.GetByIdAsync(targetId);

        if (caster?.ShadowEssence == null)
            throw new InvalidOperationException("Caster not found");

        // Validate essence
        if (!await _essenceService.TrySpendEssenceAsync(casterId, 20, "shadow-snare"))
            throw new InvalidOperationException("Insufficient Shadow Essence (need 20)");

        // Validate range
        int distance = GetDistance(caster.Position, target.Position);
        if (distance > 6)
            throw new InvalidOperationException($"Target too far ({distance} spaces, max 6)");

        // Validate shadow exists
        if (target.IsInTotalDarkness) // Total darkness = no visible shadow
            throw new InvalidOperationException("Target has no visible shadow in total darkness");

        // Create snare effect
        var snare = new ShadowSnareEffect
        {
            EffectId = Guid.NewGuid(),
            CasterId = casterId,
            TargetId = targetId,
            StartedAt = DateTime.UtcNow,
            TurnsRemaining = 2,
            SaveDc = 14,
            HasEscaped = false
        };

        // Apply root condition
        target.AddCondition(new RootCondition { Duration = 2 });
        await _characterRepository.UpdateAsync(target);

        // Check corruption
        var corruption = _corruptionService.EvaluateRisk(
            MyrkgengrAbilityId.ShadowSnare,
            caster.CurrentLightLevel.CurrentLevel,
            targetIsCoherent: target.Alignment == Alignment.Coherent);

        if (corruption.RiskTriggered)
        {
            _corruptionService.ApplyCorruption(casterId, corruption);
        }

        _logger.LogInformation(
            "Shadow Snare: {Caster} → {Target} | Rooted for 2 turns | Corruption: {Corr}",
            casterId, targetId, corruption.CorruptionGained);

        return snare;
    }

    public async Task<EclipseZone> ExecuteEclipseAsync(
        Guid characterId,
        Position centerPosition)
    {
        var character = await _characterRepository.GetByIdAsync(characterId);
        if (character?.ShadowEssence == null)
            throw new InvalidOperationException("Character not found");

        // Validate essence
        if (!await _essenceService.TrySpendEssenceAsync(characterId, 40, "eclipse"))
            throw new InvalidOperationException("Insufficient Shadow Essence (need 40)");

        // Check once-per-combat
        var hasUsedEclipse = character.HasUsedAbilityThisCombat("eclipse");
        if (hasUsedEclipse)
            throw new InvalidOperationException("Eclipse already used this combat");

        // Create eclipse zone
        var eclipse = new EclipseZone
        {
            ZoneId = Guid.NewGuid(),
            CasterId = characterId,
            CenterPosition = centerPosition,
            Radius = 8,
            TurnsRemaining = 3,
            CreatedAt = DateTime.UtcNow,
            CorruptionGenerated = 2
        };

        await _eclipseManager.CreateEclipseZoneAsync(eclipse);

        // Apply corruption (mandatory +2)
        _corruptionService.ApplyCorruption(characterId,
            new CorruptionRiskResult
            {
                RiskTriggered = true,
                CorruptionGained = 2,
                AbilityUsed = "eclipse",
                Reason = "Eclipse is ultimate shadow magic"
            });

        _logger.LogWarning(
            "Eclipse created: {CharId} | Center: ({X}, {Y}) | Radius: 8 | Duration: 3 turns | Corruption: +2",
            characterId, centerPosition.X, centerPosition.Y);

        return eclipse;
    }
}
```

### 10.2 IIncorporealStateManager Implementation

```csharp
/// <summary>
/// Manages incorporeal state lifecycle and movement restrictions.
/// </summary>
public interface IIncorporealStateManager
{
    /// <summary>Add new incorporeal state.</summary>
    Task AddIncorporealStateAsync(IncorporealState state);

    /// <summary>Get active incorporeal state for character.</summary>
    Task<IncorporealState> GetIncorporealStateAsync(Guid characterId);

    /// <summary>Update incorporeal state.</summary>
    Task UpdateIncorporealStateAsync(IncorporealState state);

    /// <summary>Remove/end incorporeal state.</summary>
    Task RemoveIncorporealStateAsync(Guid characterId);

    /// <summary>Handle damage while incorporeal.</summary>
    Task<bool> TakeMagicalLightDamageAsync(Guid characterId, int damage);

    /// <summary>Process movement while incorporeal.</summary>
    Task<bool> CanMoveToAsync(Guid characterId, Position target);

    /// <summary>Check if character is phased into solid.</summary>
    Task<bool> IsPhasedIntoSolidAsync(Guid characterId);

    /// <summary>Eject character from solid object.</summary>
    Task EjectFromSolidAsync(Guid characterId);
}

/// <summary>
/// Implementation of incorporeal state manager.
/// </summary>
public class IncorporealStateManager : IIncorporealStateManager
{
    private readonly Dictionary<Guid, IncorporealState> _activeStates;
    private readonly ICharacterRepository _characterRepository;
    private readonly IDamageCalculationService _damageService;
    private readonly ILogger<IncorporealStateManager> _logger;

    public async Task<bool> CanMoveToAsync(Guid characterId, Position target)
    {
        var state = _activeStates.GetValueOrDefault(characterId);
        if (state == null || state.IsExpired())
            return true; // Not incorporeal, normal movement rules

        // Incorporeal can move through most objects
        if (state.CanPassThrough)
        {
            // Check for magical barriers (exceptions)
            bool hasMagicalBarrier = await CheckMagicalBarrierAsync(target);
            return !hasMagicalBarrier;
        }

        return false; // Cannot phase
    }

    public async Task<bool> IsPhasedIntoSolidAsync(Guid characterId)
    {
        var character = await _characterRepository.GetByIdAsync(characterId);
        var state = _activeStates.GetValueOrDefault(characterId);

        if (state == null || state.IsExpired())
            return false;

        // Check if current position is solid (wall, object, etc.)
        bool isSolid = await CheckPositionIsSolidAsync(character.Position);
        return isSolid && state.CanPassThrough;
    }

    public async Task EjectFromSolidAsync(Guid characterId)
    {
        var character = await _characterRepository.GetByIdAsync(characterId);
        var state = _activeStates.GetValueOrDefault(characterId);

        if (state == null)
            return;

        // Deal 3d6 damage
        int damage = DiceRoller.Roll(6) + DiceRoller.Roll(6) + DiceRoller.Roll(6);
        await _damageService.ApplyDamageAsync(characterId, damage, DamageType.Force);

        // Find nearest safe position
        Position safePos = await FindNearestSafePositionAsync(character.Position);
        character.Position = safePos;
        await _characterRepository.UpdateAsync(character);

        // End incorporeal
        _activeStates.Remove(characterId);

        _logger.LogWarning(
            "Character ejected from solid: {CharId} | Damage: {Dmg} | Ejected to safe position",
            characterId, damage);
    }
}
```

### 10.3 IEclipseZoneManager Implementation

```csharp
/// <summary>
/// Manages Eclipse zone effects and environment.
/// </summary>
public interface IEclipseZoneManager
{
    /// <summary>Create new Eclipse zone.</summary>
    Task CreateEclipseZoneAsync(EclipseZone zone);

    /// <summary>Get active Eclipse zones.</summary>
    Task<IReadOnlyList<EclipseZone>> GetActiveEclipsesAsync();

    /// <summary>Check if position is in any Eclipse zone.</summary>
    Task<bool> IsPositionInEclipseAsync(Position pos);

    /// <summary>Generate essence for caster each turn.</summary>
    Task GenerateEssenceInEclipseAsync();

    /// <summary>Extinguish lights in zone.</summary>
    Task ExtinguishLightsInZoneAsync(EclipseZone zone);

    /// <summary>Process Eclipse tick (1 turn passes).</summary>
    Task TickEclipseZonesAsync();

    /// <summary>End Eclipse zone.</summary>
    Task EndEclipseZoneAsync(Guid zoneId);
}

/// <summary>
/// Implementation of Eclipse zone manager.
/// </summary>
public class EclipseZoneManager : IEclipseZoneManager
{
    private readonly List<EclipseZone> _activeZones;
    private readonly IShadowEssenceService _essenceService;
    private readonly ILightExtinguishmentService _lightService;
    private readonly ILogger<EclipseZoneManager> _logger;

    public async Task TickEclipseZonesAsync()
    {
        var expiredZones = new List<EclipseZone>();

        foreach (var zone in _activeZones)
        {
            // Decrement turns
            zone.TurnsRemaining--;

            // Generate essence for caster
            await _essenceService.GenerateEssenceAsync(zone.CasterId, 10, "eclipse-generation");

            _logger.LogInformation(
                "Eclipse zone tick: {ZoneId} | Turns remaining: {Turns} | Essence generated: +10",
                zone.ZoneId, zone.TurnsRemaining);

            // Check expiration
            if (zone.TurnsRemaining <= 0)
            {
                expiredZones.Add(zone);
            }
        }

        // Remove expired zones
        foreach (var zone in expiredZones)
        {
            _activeZones.Remove(zone);
            _logger.LogInformation("Eclipse zone expired: {ZoneId}", zone.ZoneId);
        }
    }

    public async Task ExtinguishLightsInZoneAsync(EclipseZone zone)
    {
        // Find all light sources in zone
        var lightsInZone = await GetLightsInAreaAsync(zone.CenterPosition, zone.Radius);

        foreach (var light in lightsInZone)
        {
            var saveResult = await _lightService.EvaluateMagicalLight(light);

            if (saveResult == LightSaveResult.Extinguished)
            {
                // Light extinguished
                zone.ExtinguishedLights.Add(light.Id);
            }
            else if (saveResult == LightSaveResult.SavedButDimmed)
            {
                // Light reduced to dim
                light.Intensity = 30; // Dim light level
            }
            // SavedButDimmed or Unaffected remain as-is
        }
    }
}
```

---

## 11. Incorporeal State System

### 11.1 Incorporeal Mechanics Summary

**States:**

```
Non-Incorporeal (Normal)
├─ Can be targeted by physical attacks
├─ Cannot pass through objects
├─ Can interact with environment
├─ Can attack normally
└─ Standard combat rules

Incorporeal (Phased)
├─ Cannot be targeted by physical attacks
├─ Can pass through solid objects
├─ Cannot interact with environment
├─ Cannot attack (except Shadow Step)
├─ Vulnerable to magical light (2d6)
└─ Must exit before end of turn (or auto-exits)
```

### 11.2 Phasing Rules

**Movement Through Objects:**

```
Can Phase Through:
├─ Walls and terrain
├─ Buildings and structures
├─ Magical objects (non-protected)
├─ Water and liquids
└─ Other characters

Cannot Phase Through:
├─ Magical barriers (Aetheric seals)
├─ Anti-magic fields
├─ Divine protective circles
├─ Solid shadow/darkness (paradox)
└─ Bright light (too opposed)
```

**Movement Restrictions:**

```
Must remain:
├─ Above ground level (cannot sink through earth)
├─ Below sky (cannot fly away)
├─ In accessible spaces
└─ Cannot end turn embedded in rock/solid
```

---

## 12. Shadow Snare Effect System

### 12.1 Snare Application & Resolution

**Application Timeline:**

```
Caster's Turn: Shadow Snare used
├─ Spend 2 AP and 20 essence
├─ Select target within 6 spaces
├─ Apply Root condition (2 turns)
└─ Narrative: Shadow grasps at feet

Target's Turn 1:
├─ No automatic save yet
├─ Target is Rooted (cannot move)
├─ Can still attack and use abilities
└─ End of turn: Make save (DC 14) if attempted

Save Results:
├─ Success: Snare breaks, target is free
└─ Failure: Rooted continues

Target's Turn 2:
├─ Still Rooted
├─ Can still attack/use abilities
├─ No additional save (auto-expires at end)
└─ Snare automatically ends

After Turn 2: Target is free
```

---

## 13. Eclipse Zone Mechanics

### 13.1 Zone Creation & Management

**Zone Properties:**

```
Radius: 8 spaces (perfect circle)
Duration: 3 turns
Light Coverage: Complete darkness within radius
Partial Darkness: 1 space beyond radius (dim light)

Zone Rules:
├─ Only 1 active per character (can stack multiple characters)
├─ Cannot move zone (stationary)
├─ Cannot resize zone
├─ Cannot merge zones
└─ Automatically expire after 3 turns
```

### 13.2 Essence Generation

**Per-Turn Regeneration:**

```
Turn 1: Create Eclipse (40 essence spent)
├─ Essence now: (50-40 = 10/50)
├─ Turn ends: +10 essence → 20/50
└─ But can exceed cap during Eclipse

Turn 2: Eclipse continues
├─ Essence: 20/50 at start
├─ Turn ends: +10 essence → 30/50
└─ Continues normal generation cap

Turn 3: Eclipse final turn
├─ Essence: 30/50 at start
├─ Turn ends: +10 essence → 40/50
└─ Zone expires after turn

Total gained: +30 Shadow Essence over 3 turns
Essence cap: Temporarily increased during Eclipse only
```

---

## 14. Configuration Specifications

### 14.1 abilities.json (Tier 3 & Capstone Section)

```json
{
    "abilities": [
        {
            "abilityId": "merge-with-darkness",
            "displayName": "Merge with Darkness",
            "specializationId": "Myrkgengr",
            "tier": 3,
            "type": "Active",
            "apCost": 3,
            "cooldown": 0,
            "resourceCost": {
                "resourceId": "shadow-essence",
                "amount": 25
            },
            "duration": {
                "value": 1,
                "unit": "Turns"
            },
            "ppCost": 5,
            "ppRequirement": 16,
            "description": "Become an incorporeal shadow for 1 turn. Physical attacks cannot target you, and you can move through solid objects. Cannot attack while incorporeal. Vulnerable to magical light (2d6 damage).",
            "effects": [
                {
                    "type": "GrantIncorporeal",
                    "duration": 1,
                    "canPassThrough": true,
                    "immuneToPhysical": true
                },
                {
                    "type": "Vulnerability",
                    "damageType": "MagicalLight",
                    "dice": "2d6"
                }
            ],
            "extension": {
                "cost": 25,
                "corruptionPerExtension": 1,
                "maxExtensions": 3
            },
            "restrictions": [
                "Cannot attack while incorporeal",
                "Cannot interact with physical objects",
                "Cannot end turn embedded in solid"
            ],
            "combatUse": "Escape or defensive transformation"
        },
        {
            "abilityId": "shadow-snare",
            "displayName": "Shadow Snare",
            "specializationId": "Myrkgengr",
            "tier": 3,
            "type": "Active",
            "apCost": 2,
            "cooldown": 0,
            "resourceCost": {
                "resourceId": "shadow-essence",
                "amount": 20
            },
            "range": {
                "value": 6,
                "unit": "Spaces"
            },
            "duration": {
                "value": 2,
                "unit": "Turns"
            },
            "ppCost": 5,
            "ppRequirement": 16,
            "description": "Animate the target's shadow to grasp and root them. Target is Rooted for 2 turns (DC 14 save at end of each turn to escape). Fails if target has no shadow.",
            "effects": [
                {
                    "type": "ApplyCondition",
                    "condition": "Rooted",
                    "duration": 2,
                    "saveDc": 14,
                    "saveFrequency": "EndOfTurn"
                }
            ],
            "saveModifiers": [
                {
                    "condition": "TargetInNormalLight",
                    "dcModifier": -2
                },
                {
                    "condition": "TargetHasShadowResistance",
                    "saveAdvantage": true
                }
            ],
            "requirements": [
                "targetHasShadow",
                "targetDistance6Spaces",
                "minimumEssence20"
            ],
            "corruptionRisk": {
                "trigger": "TargetIsCoherent",
                "amount": 1
            },
            "combatUse": "Crowd control and enemy immobilization"
        },
        {
            "abilityId": "eclipse",
            "displayName": "Eclipse",
            "specializationId": "Myrkgengr",
            "tier": "capstone",
            "type": "Ultimate",
            "apCost": 5,
            "cooldown": "Combat",
            "resourceCost": {
                "resourceId": "shadow-essence",
                "amount": 40
            },
            "range": {
                "value": 8,
                "unit": "Radius",
                "targetType": "SelfCentered"
            },
            "duration": {
                "value": 3,
                "unit": "Turns"
            },
            "ppCost": 6,
            "ppRequirement": 24,
            "description": "Call forth absolute darkness in an 8-space radius. All light is extinguished (magical lights save DC 16). You gain 50% concealment and can see normally within the zone. Regenerate 10 Shadow Essence per turn. Always triggers +2 Corruption.",
            "effects": [
                {
                    "type": "CreateDarknessZone",
                    "radius": 8,
                    "duration": 3,
                    "extinguishMundaneLight": true,
                    "magicalLightSaveDc": 16
                },
                {
                    "type": "GrantConcealment",
                    "missChance": 50,
                    "targetsSelf": true
                },
                {
                    "type": "GrantVision",
                    "condition": "WithinZone",
                    "targetsSelf": true,
                    "normalVisionInDarkness": true
                },
                {
                    "type": "EssenceRegeneration",
                    "amount": 10,
                    "period": "Turn",
                    "targetsSelf": true
                }
            ],
            "zoneEffects": [
                {
                    "target": "Caster",
                    "effects": [
                        "50% concealment",
                        "Normal vision",
                        "+10 essence/turn"
                    ]
                },
                {
                    "target": "Others",
                    "effects": [
                        "Blinded",
                        "-4 attack penalty",
                        "Disadvantage on skill checks"
                    ]
                }
            ],
            "corruptionRisk": {
                "trigger": "Always",
                "amount": 2,
                "mandatory": true
            },
            "limitations": [
                "Once per combat",
                "Cannot use again in same encounter",
                "Resets after combat ends"
            ],
            "combatUse": "Ultimate environmental control and dominance"
        }
    ]
}
```

---

## 15. Light Extinguishing System

### 15.1 Magical Light Save Mechanics

**Save DC 16 for Magical Lights:**

```
Magical Light Source (e.g., enchanted torch):
├─ Make DC 16 save (spell save DC)
├─ Success: Light reduced to dim (not extinguished)
├─ Failure: Light automatically extinguished
├─ Reroll each round if powerful source
└─ Divine lights may ignore entirely

Example:
1st turn Eclipse: Magical torch makes DC 16 save
├─ Save roll: 14 (fails)
├─ Torch is extinguished
└─ Darkness complete

Alternative:
1st turn Eclipse: Powerful Seiðr light makes DC 16 save
├─ Save roll: 18 (succeeds)
├─ Light reduced to dim (not extinguished)
└─ Partial illumination remains
```

---

## 16. State Machine Diagrams

### 16.1 Incorporeal State Machine

```
┌──────────────────────┐
│ Non-Incorporeal      │
│ (Normal Form)        │
└────────┬─────────────┘
         │ Merge with Darkness
         │ (3 AP, 25 essence)
         │
         ▼
┌──────────────────────┐
│ Incorporeal          │
│ (Phased Form)        │
├──────────────────────┤
│ • Immobile to phys   │
│ • Pass through solid │
│ • Cannot attack      │
│ • Vulnerable to magic│
└────┬─────────────────┘
     │
     ├─ Extend (optional)
     │  (25 essence, +1 corr)
     │  ▼
     │ ┌──────────────────┐
     │ │ Extended         │
     │ │ (1+ more turns)  │
     │ └────┬─────────────┘
     │      │
     │      └──► (back to Incorporeal)
     │
     ├─ Magical Light (2d6 damage)
     │  ├─ Damage >= HP: Forced exit
     │  └─ Otherwise: Can choose to exit
     │
     └─ Turn ends
        ▼
     ┌──────────────────────┐
     │ Non-Incorporeal      │
     │ (Return to Normal)   │
     └──────────────────────┘

If embedded in solid at end of turn:
├─ Eject forcefully
├─ Take 3d6 damage
└─ Exit to nearest safe space
```

### 16.2 Eclipse Zone Lifecycle

```
┌──────────────────────┐
│ Eclipse Created      │
│ (5 AP, 40 essence)   │
└────────┬─────────────┘
         │
         ├─ +2 Corruption applied
         │
         ▼
┌──────────────────────┐
│ Turn 1: Eclipse      │
│ Active (3 turns)     │
├──────────────────────┤
│ • All lights off     │
│ • Caster: 50% miss  │
│ • Others: blinded   │
│ • +10 essence/turn  │
└────┬─────────────────┘
     │
     ▼
┌──────────────────────┐
│ Turn 2: Eclipse      │
│ Active (2 turns)     │
│ • Same effects       │
│ • +10 essence/turn  │
└────┬─────────────────┘
     │
     ▼
┌──────────────────────┐
│ Turn 3: Eclipse      │
│ Active (1 turn)      │
│ • Same effects       │
│ • +10 essence/turn  │
└────┬─────────────────┘
     │ Turn ends
     ▼
┌──────────────────────┐
│ Eclipse Dissipates   │
│ Light returns        │
└──────────────────────┘

Dispel Check:
├─ Any turn: Dispel Magic DC 18
├─ Success: Eclipse ends immediately
└─ Failure: Continues
```

---

## 17. Corruption Mechanics for Tier 3

### 17.1 Tier 3 Ability Corruption

**Merge with Darkness:**

```
Baseline: 0 Corruption (normal use)
Extensions: +1 Corruption per extension
Total: 0-3+ Corruption possible if extended multiple times
```

**Shadow Snare:**

```
Coherent-aligned target: +1 Corruption
Innocent target: +1 Corruption (GM discretion)
Total: 0-2 Corruption per use
```

**Eclipse (Capstone):**

```
Always: +2 Corruption (mandatory)
Cannot be avoided or mitigated
Total: Always 2 Corruption per Eclipse use
```

---

## 18. Combat Scenarios & Examples

### 18.1 Example Combat: Full Tier 3+ Usage

```
SCENARIO: Myrk-gengr named Shadowbane vs. 4 enemies

Turn Sequence:

SHADOWBANE'S TURN 1:
1. Movement: Move into shadow area (2 spaces)
2. Action: Use Eclipse (5 AP, 40 essence)
   └─ Create 8-space darkness zone
   └─ All light extinguished
   └─ Enemies blinded and confused
   └─ Shadowbane gains 50% concealment
   └─ +2 Corruption applied
   └─ Essence now: 10/50

ENEMY TURNS (in darkness):
Enemy 1-4:
├─ Blinded and cannot see
├─ Attack rolls suffer -4 penalty
├─ Cannot coordinate effectively
├─ Attempt to exit darkness or attack blindly
└─ Shadowbane can see and attack freely

SHADOWBANE'S TURN 2:
1. Movement: Move to nearest enemy (5 spaces available)
2. Action: Use Umbral Strike (3 AP, 15 essence)
   ├─ From darkness, attack unaware enemy
   ├─ Attack advantage (enemy blinded)
   ├─ Deal 9 (weapon) + 9 (2d6 shadow) = 18 damage
   ├─ Enemy reduced to half health
   └─ Essence now: -5/50 (wait, negative?!)

Wait - need to handle essence:
├─ Start Turn 2: 10/50
├─ Generate in darkness: +5 → 15/50
├─ Spend on Umbral Strike: -15 → 0/50
├─ Essence now: 0/50

ENEMY TURNS:
Enemies continue to fumble in darkness
├─ -4 penalties on all attacks
├─ Blinded disadvantage
├─ Cannot find Shadowbane effectively
└─ Only 2 turns of Eclipse remain

SHADOWBANE'S TURN 3:
1. Movement: Stay in darkness (safe)
2. Action: Use Shadow Snare (2 AP, 20 essence)
   └─ But wait: 0/20 available? Cannot use!

Instead:
1. Movement: Move deeper into darkness
2. Bonus: Wait for essence generation
   └─ End of turn generation not yet applied

   OR

2. Action: Retreat to safer position
   └─ Uses standard action for positioning
   └─ Eclipse ends after this turn

ENEMY TURNS:
As Eclipse winds down, enemies regain vision
└─ Some escaped darkness zone
└─ Some remain blinded
└─ Shadowbane has tactical advantage

SHADOWBANE'S TURN 4:
1. Eclipse now expired
2. Light gradually returns
3. Shadowbane:
   ├─ Can regenerate essence (back in normal light)
   ├─ Used Eclipse (large tactical advantage)
   ├─ Enemies scattered and confused
   ├─ But cannot use Eclipse again this combat
   └─ Available essence for other abilities

RESULT:
• Used Eclipse as game-changing ultimate
• Provided 3 turns of tactical dominance
• Blinded all enemies and controlled battlefield
• Took +2 Corruption (worth it for advantage)
• Forced enemies into chaos and disarray
• Memorable and impactful ability usage
```

---

## 19. Logging Specifications

### 19.1 Ability Execution Logging

```
[INFO] Merge with Darkness: {CharId} transformed, incorporeal for 1 turn
       Duration: until end of current turn | Essence: -25

[INFO] Incorporeal extended: {CharId}
       Turns remaining: 2 | Corruption accrued: +1

[INFO] Shadow Snare: {CasterId} → {TargetId} | Rooted 2 turns
       Save DC: 14 | Corruption: {Amount}

[WARN] Eclipse created: {CharId} | Center ({X}, {Y}) | Radius 8
       Duration: 3 turns | Corruption: +2 (mandatory)
       Mundane lights extinguished | Magical lights save DC 16
```

### 19.2 Eclipse Zone Logging

```
[DEBUG] Eclipse zone tick: {ZoneId} | Turns remaining: {N}
        Essence generated: +10 to {CasterId}
        Blinded characters: {Count}

[DEBUG] Light extinguished in Eclipse: {LightId}
        Type: {Mundane/Magical}
        Save result: {Extinguished/Dimmed/Unaffected}

[WARN] Eclipse zone expired: {ZoneId}
       Total duration: 3 turns | Essence generated: +30
       Darkness gradually lifting
```

---

## 20. Unit Testing Requirements

### 20.1 MergeWithDarknessTests (~2 tests)

```csharp
[TestFixture]
public class MergeWithDarknessTests
{
    [Test]
    public async Task ExecuteMerge_CreatesIncorporealState()
    {
        // Arrange
        var characterId = Guid.NewGuid();

        // Act
        var incorporeal = await _service.ExecuteMergeWithDarknessAsync(characterId);

        // Assert
        Assert.That(incorporeal, Is.Not.Null);
        Assert.That(incorporeal.TurnsRemaining, Is.EqualTo(1));
        Assert.That(incorporeal.CanPassThrough, Is.True);
    }

    [Test]
    public async Task ExtendIncorporeal_IncreasesAndAppliesCorruption()
    {
        // Arrange
        var characterId = Guid.NewGuid();
        var incorporeal = await _service.ExecuteMergeWithDarknessAsync(characterId);

        // Act
        var extended = await _service.ExtendIncorporealAsync(characterId);

        // Assert
        Assert.That(extended.TurnsRemaining, Is.EqualTo(2));
        Assert.That(extended.ExtensionCount, Is.EqualTo(1));
        Assert.That(extended.CorruptionAccrued, Is.EqualTo(1));
    }
}
```

### 20.2 ShadowSnareTests (~2 tests)

```csharp
[TestFixture]
public class ShadowSnareTests
{
    [Test]
    public async Task ExecuteSnare_AppliesRootCondition()
    {
        // Arrange
        var casterId = Guid.NewGuid();
        var targetId = Guid.NewGuid();

        // Act
        var snare = await _service.ExecuteShadowSnareAsync(casterId, targetId);

        // Assert
        Assert.That(snare, Is.Not.Null);
        Assert.That(snare.TurnsRemaining, Is.EqualTo(2));
        Assert.That(snare.SaveDc, Is.EqualTo(14));
    }

    [Test]
    public async Task SnareBreaks_OnBrightLight()
    {
        // Arrange
        var casterId = Guid.NewGuid();
        var targetId = Guid.NewGuid();
        var snare = await _service.ExecuteShadowSnareAsync(casterId, targetId);

        // Act - Target enters bright light
        await _service.EvaluateSnareBreakAsync(snare.EffectId, LightLevelType.BrightLight);

        // Assert
        // Snare should be broken/removed
    }
}
```

### 20.3 EclipseTests (~3 tests)

```csharp
[TestFixture]
public class EclipseTests
{
    [Test]
    public async Task ExecuteEclipse_CreatesZone()
    {
        // Arrange
        var characterId = Guid.NewGuid();

        // Act
        var eclipse = await _service.ExecuteEclipseAsync(characterId, new Position { X = 15, Y = 15 });

        // Assert
        Assert.That(eclipse, Is.Not.Null);
        Assert.That(eclipse.Radius, Is.EqualTo(8));
        Assert.That(eclipse.TurnsRemaining, Is.EqualTo(3));
    }

    [Test]
    public async Task Eclipse_OncePerCombat()
    {
        // Arrange
        var characterId = Guid.NewGuid();
        var firstEclipse = await _service.ExecuteEclipseAsync(characterId, position1);

        // Act & Assert - Should fail on second use
        Assert.ThrowsAsync<InvalidOperationException>(
            () => _service.ExecuteEclipseAsync(characterId, position2));
    }

    [Test]
    public async Task EclipseZone_GeneratesEssencePerTurn()
    {
        // Arrange
        var characterId = Guid.NewGuid();
        var eclipse = await _service.ExecuteEclipseAsync(characterId, new Position());

        // Act - Simulate 3 turns
        await _zoneManager.TickEclipseZonesAsync(); // Turn 1
        var essence1 = _essenceService.GetCurrentEssence(characterId);

        await _zoneManager.TickEclipseZonesAsync(); // Turn 2
        var essence2 = _essenceService.GetCurrentEssence(characterId);

        // Assert
        Assert.That(essence1, Is.GreaterThan(0)); // Generated +10
        Assert.That(essence2, Is.GreaterThan(essence1)); // Generated another +10
    }
}
```

---

## 21. Deliverable Checklist

### Domain Layer

- [ ] `IncorporealState` value object
- [ ] `ShadowSnareEffect` value object
- [ ] `EclipseZone` value object
- [ ] `ShadowBinding` value object
- [ ] `LightSaveResult` enum
- [ ] `BreakCondition` enum
- [ ] `IncorporealRestriction` enum

### Application Layer

- [ ] `ITier3AbilityService` interface
- [ ] `Tier3AbilityService` implementation
- [ ] `IIncorporealStateManager` interface
- [ ] `IncorporealStateManager` implementation
- [ ] `IEclipseZoneManager` interface
- [ ] `EclipseZoneManager` implementation
- [ ] `ILightExtinguishmentService` interface
- [ ] `LightExtinguishmentService` implementation

### Infrastructure & Integration

- [ ] Incorporeal state persistence
- [ ] Eclipse zone persistence
- [ ] Shadow snare effect persistence
- [ ] Light extinguishing mechanics
- [ ] Once-per-combat tracking for Eclipse
- [ ] Character modifications for Tier 3
- [ ] Configuration updates (abilities.json)

### Tests

- [ ] `MergeWithDarknessTests` (~2 tests)
- [ ] `ShadowSnareTests` (~2 tests)
- [ ] `EclipseTests` (~3 tests)
- [ ] Total: ~7 tests

---

## 22. Acceptance Criteria

### Functional Acceptance

- [ ] Merge with Darkness costs 3 AP and 25 Shadow Essence
- [ ] Character becomes incorporeal and phased
- [ ] Physical attacks automatically miss incorporeal character
- [ ] Character can move through solid objects while phased
- [ ] Cannot attack while incorporeal (except Shadow Step)
- [ ] Incorporeal form lasts 1 turn
- [ ] Can extend incorporeal form (+25 essence, +1 corruption per extension)
- [ ] Vulnerable to magical light (2d6 vulnerability damage)
- [ ] Shadow Snare costs 2 AP and 20 Shadow Essence
- [ ] Target within 6 spaces is Rooted for 2 turns
- [ ] Rooted target can still attack/use abilities
- [ ] Target makes save at end of each turn (DC 14) to escape
- [ ] Snare breaks if target enters bright light
- [ ] Eclipse costs 5 AP and 40 Shadow Essence
- [ ] Eclipse creates 8-space radius darkness zone
- [ ] All light extinguished (mundane automatic, magical DC 16)
- [ ] Caster gains 50% concealment
- [ ] Caster generates +10 essence per turn
- [ ] Eclipse lasts 3 turns
- [ ] Eclipse always applies +2 Corruption
- [ ] Eclipse usable once per combat maximum
- [ ] Tier 3 locked until 16 PP invested
- [ ] Capstone locked until 24 PP invested
- [ ] Corruption integration functional for all Tier 3 abilities

### Performance Acceptance

- [ ] Ability execution < 300ms
- [ ] Zone management < 200ms
- [ ] Save calculation < 50ms

### Test Coverage

- [ ] Minimum 7 unit tests pass
- [ ] 80%+ code coverage for services
- [ ] All ability paths tested

---

## 23. Design Decisions & Rationale

### Decision: 1-Turn Incorporeal Duration

**Rationale:**
- Prevents indefinite phasing/invulnerability
- Requires tactical decision to extend
- Each extension costs 25 essence + 1 corruption
- Risk/reward balance: stay phased or exit safely
- Cannot dominate entire combat uninterrupted

### Decision: Eclipse Once Per Combat

**Rationale:**
- Capstone should be ultimate, game-changing
- Prevents spamming in prolonged battles
- Encourages strategic timing decision
- Creates memorable moment when used
- Forces other abilities for remainder of combat
- Matches pattern of ultimate abilities in RPGs

### Decision: +10 Essence Per Turn in Eclipse

**Rationale:**
- Compensates for 40 essence spent on creation
- 3 turns × 10 = 30 essence recovered (75% refund)
- Caster can regenerate resources during zone active
- Incentivizes staying in zone for regeneration
- Allows strategic essence management

### Decision: 50% Concealment (Not Full Invisibility)

**Rationale:**
- Not absolute invulnerability
- Enemies can still hit (50% miss chance)
- Powerful but not broken
- More interesting combat than "can't miss"
- Matches Eclipse power level appropriately

---

## Conclusion

**v0.20.4c** completes the Myrk-gengr specialization with powerful Tier 3 abilities and a game-changing capstone. **Merge with Darkness** provides defensive transformation, **Shadow Snare** enables crowd control, and **Eclipse** delivers ultimate environmental mastery.

The full Myrk-gengr specialization (9 abilities across 4 tiers) creates a complete, thematic Heretical path that rewards mastery through careful Corruption management and strategic ability usage.

**Legacy & Impact:**
- Establishes Heretical path pattern for v0.20.5+ specializations
- Introduces incorporeal state mechanics for future abilities
- Provides area effect framework for environmental abilities
- Sets standard for capstone power and balance

**Full Specialization Investment:** 32 PP total for complete mastery of shadow magic

---

_End of v0.20.4c Design Specification_
_End of v0.20.4 Myrk-gengr Complete Implementation_
