# v0.11.0c Design Specification: Gathering Service

**Version:** 0.11.0c
**Parent:** v0.11.0 (Resources & Gathering)
**Prerequisites:** v0.11.0b Complete (Harvestable Features)
**Status:** Design Complete
**Estimated Unit Tests:** ~9

---

## Table of Contents

1. [Executive Summary](#1-executive-summary)
2. [Feature Overview](#2-feature-overview)
3. [Architecture](#3-architecture)
4. [GatherResult Record](#4-gatherresult-record)
5. [GatherValidation Record](#5-gathervalidation-record)
6. [Gathering Events](#6-gathering-events)
7. [IGatheringService Interface](#7-igatheringservice-interface)
8. [GatheringService Implementation](#8-gatheringservice-implementation)
9. [GatherCommand Implementation](#9-gathercommand-implementation)
10. [Logging Specifications](#10-logging-specifications)
11. [Unit Testing Requirements](#11-unit-testing-requirements)
12. [Use Cases](#12-use-cases)
13. [Deliverable Checklist](#13-deliverable-checklist)
14. [Acceptance Criteria](#14-acceptance-criteria)
15. [Dependencies](#15-dependencies)
16. [Future Considerations](#16-future-considerations)

---

## 1. Executive Summary

### Purpose

Implement the gathering service that handles the mechanics of harvesting resources from harvestable features. This includes dice checks against difficulty class, survival skill modifiers, quantity determination, quality upgrade chances, tool requirement validation, resource addition to inventory, and feature depletion. The service completes the v0.11.0 Resources & Gathering feature set.

### Key Deliverables

| Category | Items |
|----------|-------|
| **Result Records** | `GatherResult`, `GatherValidation` |
| **Domain Events** | `GatherAttemptedEvent`, `ResourceGatheredEvent` |
| **Interfaces** | `IGatheringService` |
| **Services** | `GatheringService` |
| **Commands** | `GatherCommand` |
| **Tests** | ~9 unit tests |

### Architectural Significance

This version completes the **Resource Gathering Loop**:
- Player discovers harvestable features in rooms (v0.11.0b)
- Player attempts to gather using the `gather` command
- Service validates tool requirements and feature availability
- Dice roll (d20 + Survival skill) vs. feature's Difficulty Class
- Success yields resources added to inventory
- High rolls may upgrade resource quality
- Feature depletes and optionally sets replenishment timer

---

## 2. Feature Overview

```
v0.11.0c Features
├── GatherResult Record
│   ├── IsSuccess (bool)
│   ├── Roll, Modifier, Total (dice results)
│   ├── DifficultyClass
│   ├── ResourceId, ResourceName, Quantity
│   ├── Quality (ResourceQuality)
│   ├── FeatureDepleted (bool)
│   ├── FailureReason (string?)
│   └── Factory methods (Success, Failed, ValidationFailed)
│
├── GatherValidation Record
│   ├── IsValid (bool)
│   ├── DifficultyClass (int?)
│   ├── FailureReason (string?)
│   └── Factory methods (Success, Failed)
│
├── Gathering Events
│   ├── GatherAttemptedEvent
│   │   ├── PlayerId, FeatureId
│   │   ├── Roll, Modifier, Total, DC
│   │   └── Success (bool)
│   └── ResourceGatheredEvent
│       ├── PlayerId, ResourceId
│       ├── Quantity, Quality
│       └── FeatureDepleted
│
├── IGatheringService Interface
│   ├── GetHarvestableFeatures(room)
│   ├── CanGather(player, feature)
│   ├── Gather(player, feature)
│   ├── GetGatherDC(feature)
│   ├── GetGatherModifier(player)
│   └── ProcessReplenishment(room, turn)
│
├── GatheringService Implementation
│   ├── Tool requirement validation
│   ├── Depletion checking
│   ├── Dice roll execution (d20 + Survival)
│   ├── Quantity determination
│   ├── Quality upgrade logic
│   ├── Inventory addition
│   ├── Feature depletion
│   ├── Replenishment timer setting
│   └── Event publishing
│
└── GatherCommand
    ├── "gather" command
    ├── No args: list features
    ├── With args: gather from feature
    └── Formatted output
```

---

## 3. Architecture

```
┌─────────────────────────────────────────────────────────────────────────┐
│                    GATHERING SERVICE ARCHITECTURE                        │
└─────────────────────────────────────────────────────────────────────────┘

                      ┌───────────────────────────┐
                      │      GatherCommand         │
                      │   > gather ore-vein        │
                      └───────────────┬───────────┘
                                      │
                                      ▼
                      ┌───────────────────────────┐
                      │    IGatheringService       │
                      ├───────────────────────────┤
                      │ + GetHarvestableFeatures() │
                      │ + CanGather(player, feat)  │
                      │ + Gather(player, feature)  │
                      │ + GetGatherDC(feature)     │
                      │ + GetGatherModifier(player)│
                      │ + ProcessReplenishment()   │
                      └───────────────┬───────────┘
                                      │
                      ┌───────────────┴───────────┐
                      │      GatheringService      │
                      ├───────────────────────────┤
                      │ - _resourceProvider        │
                      │ - _featureProvider         │
                      │ - _diceService             │
                      │ - _inventoryService        │
                      │ - _eventBus                │
                      │ - _logger                  │
                      │                            │
                      │ + ValidateToolRequirement  │
                      │ + RollGatherCheck          │
                      │ + DetermineQuantity        │
                      │ + DetermineQuality         │
                      │ + AddToInventory           │
                      │ + DepleteFeature           │
                      └───────────────────────────┘


┌─────────────────────────────────────────────────────────────────────────┐
│                           LAYER DIAGRAM                                  │
└─────────────────────────────────────────────────────────────────────────┘

    ┌─────────────────────────────────────────────────────────────────┐
    │                      PRESENTATION LAYER                          │
    ├─────────────────────────────────────────────────────────────────┤
    │  ┌─────────────────────────────────────────────────────────┐    │
    │  │                   GatherCommand                          │    │
    │  ├─────────────────────────────────────────────────────────┤    │
    │  │ + Name: "gather"                                         │    │
    │  │ + Execute(player, args): CommandResult                   │    │
    │  └─────────────────────────────────────────────────────────┘    │
    └─────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
    ┌─────────────────────────────────────────────────────────────────┐
    │                      APPLICATION LAYER                           │
    ├─────────────────────────────────────────────────────────────────┤
    │  ┌─────────────────────────────────────────────────────────┐    │
    │  │            IGatheringService (Interface)                 │    │
    │  └─────────────────────────────────────────────────────────┘    │
    │                              │                                   │
    │                              ▼                                   │
    │  ┌─────────────────────────────────────────────────────────┐    │
    │  │              GatheringService (Service)                  │    │
    │  └─────────────────────────────────────────────────────────┘    │
    │                              │                                   │
    │  ┌─────────────────┐ ┌─────────────────┐ ┌─────────────────┐    │
    │  │  GatherResult   │ │GatherValidation │ │ Gathering Events│    │
    │  │    (Record)     │ │    (Record)     │ │    (Events)     │    │
    │  └─────────────────┘ └─────────────────┘ └─────────────────┘    │
    └─────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
    ┌─────────────────────────────────────────────────────────────────┐
    │                        DOMAIN LAYER                              │
    ├─────────────────────────────────────────────────────────────────┤
    │  ┌──────────────────────────┐  ┌──────────────────────────┐     │
    │  │   HarvestableFeature     │  │   ResourceDefinition     │     │
    │  │     (from v0.11.0b)      │  │     (from v0.11.0a)      │     │
    │  └──────────────────────────┘  └──────────────────────────┘     │
    │                                                                  │
    │  ┌──────────────────────────┐  ┌──────────────────────────┐     │
    │  │        Player            │  │       Inventory          │     │
    │  │   (existing entity)      │  │   (existing entity)      │     │
    │  └──────────────────────────┘  └──────────────────────────┘     │
    └─────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
    ┌─────────────────────────────────────────────────────────────────┐
    │                    INFRASTRUCTURE LAYER                          │
    ├─────────────────────────────────────────────────────────────────┤
    │  ┌─────────────────┐ ┌─────────────────┐ ┌─────────────────┐    │
    │  │ ResourceProvider│ │FeatureProvider  │ │  DiceService    │    │
    │  │ (from v0.11.0a) │ │ (from v0.11.0b) │ │  (existing)     │    │
    │  └─────────────────┘ └─────────────────┘ └─────────────────┘    │
    └─────────────────────────────────────────────────────────────────┘
```

### Gather Check Flow

```
    GATHER CHECK FLOW
    ─────────────────

    > gather ore-vein
           │
           ▼
    ┌──────────────────────────────────────┐
    │ 1. Validate                          │
    │    • Feature exists in room? ✓       │
    │    • Has required tool? ✓            │
    │    • Feature not depleted? ✓         │
    └──────────────────────────────────────┘
           │
           ├── Validation Failed ─────▶ Return GatherResult.ValidationFailed()
           │
           ▼
    ┌──────────────────────────────────────┐
    │ 2. Roll gather check                 │
    │    Roll: 1d20 = 13                   │
    │    Modifier: +3 (Survival)           │
    │    Total: 16                         │
    │    DC: 12                            │
    └──────────────────────────────────────┘
           │
           ├── Total < DC ─────────────▶ Return GatherResult.Failed()
           │                              (Publish GatherAttemptedEvent)
           ▼
    ┌──────────────────────────────────────┐
    │ 3. Determine quantity                │
    │    Feature Range: 1-5                │
    │    Feature Remaining: 4              │
    │    Max Available: min(5, 4) = 4      │
    │    Roll: 1d4 = 3                     │
    │    Quantity: 3                       │
    └──────────────────────────────────────┘
           │
           ▼
    ┌──────────────────────────────────────┐
    │ 4. Determine quality                 │
    │    Margin: 16 - 12 = 4               │
    │    Margin >= 10? No                  │
    │    Quality: base (Common)            │
    └──────────────────────────────────────┘
           │
           ▼
    ┌──────────────────────────────────────┐
    │ 5. Add to inventory                  │
    │    + Iron Ore x3 (Common)            │
    └──────────────────────────────────────┘
           │
           ▼
    ┌──────────────────────────────────────┐
    │ 6. Update feature                    │
    │    Remaining: 4 - 3 = 1              │
    │    Depleted: No                      │
    └──────────────────────────────────────┘
           │
           ▼
    ┌──────────────────────────────────────┐
    │ 7. Publish events                    │
    │    - GatherAttemptedEvent (success)  │
    │    - ResourceGatheredEvent           │
    └──────────────────────────────────────┘
           │
           ▼
    Return GatherResult.Success()
```

### Quality Upgrade Flow

```
    QUALITY UPGRADE DECISION
    ────────────────────────

    Roll Total = 22
    DC = 12
    Margin = 22 - 12 = 10
           │
           ▼
    ┌──────────────────────────────────────┐
    │ Is Margin >= 10?                     │
    │    • Yes: Upgrade quality by 1 tier  │
    │    • No: Keep base quality           │
    └──────────────────────────────────────┘
           │
           │ Margin = 10 (Yes)
           ▼
    ┌──────────────────────────────────────┐
    │ Base Quality: Common                 │
    │ Upgraded To: Fine                    │
    │                                      │
    │ (Capped at Legendary)                │
    └──────────────────────────────────────┘

    QUALITY PROGRESSION
    ───────────────────
    Common ──▶ Fine ──▶ Rare ──▶ Legendary (max)
```

---

## 4. GatherResult Record

**File:** `src/Core/RuneAndRust.Application/Results/GatherResult.cs`

```csharp
namespace RuneAndRust.Application.Results;

/// <summary>
/// Represents the result of a gathering attempt.
/// </summary>
/// <remarks>
/// <para>
/// GatherResult is an immutable record that captures all information about
/// a gathering attempt, including the dice roll details, success/failure
/// status, resources gathered, and whether the feature was depleted.
/// </para>
/// <para>
/// Use the static factory methods to create instances rather than the
/// constructor directly.
/// </para>
/// </remarks>
/// <example>
/// // Successful gather
/// var result = GatherResult.Success(
///     roll: 15, modifier: 3, total: 18, dc: 12,
///     resourceId: "iron-ore", resourceName: "Iron Ore",
///     quantity: 3, quality: ResourceQuality.Common,
///     featureDepleted: false);
///
/// // Failed gather (dice roll)
/// var result = GatherResult.Failed(roll: 8, modifier: 3, total: 11, dc: 12);
///
/// // Validation failure
/// var result = GatherResult.ValidationFailed("Feature is depleted.");
/// </example>
public record GatherResult(
    bool IsSuccess,
    int Roll,
    int Modifier,
    int Total,
    int DifficultyClass,
    string? ResourceId,
    string? ResourceName,
    int Quantity,
    ResourceQuality? Quality,
    bool FeatureDepleted,
    string? FailureReason)
{
    /// <summary>
    /// Creates a successful gather result.
    /// </summary>
    /// <param name="roll">The raw d20 roll.</param>
    /// <param name="modifier">The skill modifier applied.</param>
    /// <param name="total">The total (roll + modifier).</param>
    /// <param name="dc">The difficulty class that was beaten.</param>
    /// <param name="resourceId">The ID of the resource gathered.</param>
    /// <param name="resourceName">The display name of the resource.</param>
    /// <param name="quantity">The quantity gathered.</param>
    /// <param name="quality">The quality of the gathered resource.</param>
    /// <param name="featureDepleted">Whether the feature is now depleted.</param>
    /// <returns>A successful GatherResult.</returns>
    public static GatherResult Success(
        int roll,
        int modifier,
        int total,
        int dc,
        string resourceId,
        string resourceName,
        int quantity,
        ResourceQuality quality,
        bool featureDepleted)
    {
        return new GatherResult(
            IsSuccess: true,
            Roll: roll,
            Modifier: modifier,
            Total: total,
            DifficultyClass: dc,
            ResourceId: resourceId,
            ResourceName: resourceName,
            Quantity: quantity,
            Quality: quality,
            FeatureDepleted: featureDepleted,
            FailureReason: null);
    }

    /// <summary>
    /// Creates a failed gather result (dice roll failed).
    /// </summary>
    /// <param name="roll">The raw d20 roll.</param>
    /// <param name="modifier">The skill modifier applied.</param>
    /// <param name="total">The total (roll + modifier).</param>
    /// <param name="dc">The difficulty class that was not beaten.</param>
    /// <returns>A failed GatherResult.</returns>
    public static GatherResult Failed(int roll, int modifier, int total, int dc)
    {
        return new GatherResult(
            IsSuccess: false,
            Roll: roll,
            Modifier: modifier,
            Total: total,
            DifficultyClass: dc,
            ResourceId: null,
            ResourceName: null,
            Quantity: 0,
            Quality: null,
            FeatureDepleted: false,
            FailureReason: "Gathering check failed.");
    }

    /// <summary>
    /// Creates a validation failure result (pre-roll validation failed).
    /// </summary>
    /// <param name="reason">The reason for the validation failure.</param>
    /// <returns>A validation-failed GatherResult.</returns>
    public static GatherResult ValidationFailed(string reason)
    {
        return new GatherResult(
            IsSuccess: false,
            Roll: 0,
            Modifier: 0,
            Total: 0,
            DifficultyClass: 0,
            ResourceId: null,
            ResourceName: null,
            Quantity: 0,
            Quality: null,
            FeatureDepleted: false,
            FailureReason: reason);
    }

    /// <summary>
    /// Gets whether this result represents a validation failure (no roll was made).
    /// </summary>
    public bool IsValidationFailure => !IsSuccess && Roll == 0;

    /// <summary>
    /// Gets the roll margin (how much the roll exceeded or fell short of the DC).
    /// </summary>
    /// <remarks>
    /// Positive values indicate success margin, negative values indicate failure margin.
    /// Returns 0 for validation failures.
    /// </remarks>
    public int Margin => Total - DifficultyClass;

    /// <summary>
    /// Gets a formatted string showing the dice roll details.
    /// </summary>
    /// <returns>Formatted string like "1d20 (15) + 3 = 18 vs DC 12".</returns>
    public string GetRollDisplay()
    {
        if (IsValidationFailure)
        {
            return string.Empty;
        }

        var modifierSign = Modifier >= 0 ? "+" : "";
        return $"1d20 ({Roll}) {modifierSign}{Modifier} = {Total} vs DC {DifficultyClass}";
    }

    /// <summary>
    /// Gets a formatted string describing the gathering outcome.
    /// </summary>
    /// <returns>Human-readable outcome description.</returns>
    public string GetOutcomeDisplay()
    {
        if (!IsSuccess)
        {
            return FailureReason ?? "Gathering failed.";
        }

        var qualityDisplay = Quality == ResourceQuality.Common
            ? string.Empty
            : $" ({Quality})";

        var depletedNotice = FeatureDepleted
            ? "\nThe resource has been depleted."
            : string.Empty;

        return $"Gathered {Quantity}x {ResourceName}{qualityDisplay}{depletedNotice}";
    }
}
```

---

## 5. GatherValidation Record

**File:** `src/Core/RuneAndRust.Application/Results/GatherValidation.cs`

```csharp
namespace RuneAndRust.Application.Results;

/// <summary>
/// Represents the result of validating a gathering attempt before rolling.
/// </summary>
/// <remarks>
/// <para>
/// GatherValidation checks pre-roll conditions such as feature availability,
/// tool requirements, and depletion status. If validation passes, it also
/// provides the difficulty class for the upcoming roll.
/// </para>
/// </remarks>
/// <example>
/// // Successful validation
/// var validation = GatherValidation.Success(dc: 12);
/// if (validation.IsValid)
/// {
///     var result = gatheringService.RollGatherCheck(player, feature, validation.DifficultyClass!.Value);
/// }
///
/// // Failed validation
/// var validation = GatherValidation.Failed("You need a pickaxe to gather from this.");
/// </example>
public record GatherValidation(
    bool IsValid,
    int? DifficultyClass,
    string? FailureReason)
{
    /// <summary>
    /// Creates a successful validation result.
    /// </summary>
    /// <param name="dc">The difficulty class for the gathering check.</param>
    /// <returns>A successful GatherValidation.</returns>
    public static GatherValidation Success(int dc)
    {
        return new GatherValidation(
            IsValid: true,
            DifficultyClass: dc,
            FailureReason: null);
    }

    /// <summary>
    /// Creates a failed validation result.
    /// </summary>
    /// <param name="reason">The reason validation failed.</param>
    /// <returns>A failed GatherValidation.</returns>
    public static GatherValidation Failed(string reason)
    {
        return new GatherValidation(
            IsValid: false,
            DifficultyClass: null,
            FailureReason: reason);
    }
}
```

---

## 6. Gathering Events

**File:** `src/Core/RuneAndRust.Application/Events/GatherAttemptedEvent.cs`

```csharp
namespace RuneAndRust.Application.Events;

/// <summary>
/// Event raised when a player attempts to gather from a harvestable feature.
/// </summary>
/// <remarks>
/// This event is raised after the dice roll, regardless of success or failure.
/// It captures all the roll details for statistics and achievement tracking.
/// </remarks>
/// <example>
/// eventBus.Publish(new GatherAttemptedEvent(
///     PlayerId: player.Id,
///     FeatureId: feature.Id,
///     FeatureDefinitionId: feature.DefinitionId,
///     Roll: 15,
///     Modifier: 3,
///     Total: 18,
///     DifficultyClass: 12,
///     Success: true));
/// </example>
public record GatherAttemptedEvent(
    Guid PlayerId,
    Guid FeatureId,
    string FeatureDefinitionId,
    int Roll,
    int Modifier,
    int Total,
    int DifficultyClass,
    bool Success) : IGameEvent
{
    /// <summary>
    /// Gets the timestamp when the event occurred.
    /// </summary>
    public DateTimeOffset Timestamp { get; init; } = DateTimeOffset.UtcNow;

    /// <summary>
    /// Gets the margin by which the roll succeeded or failed.
    /// </summary>
    public int Margin => Total - DifficultyClass;

    /// <summary>
    /// Gets whether this was a critical success (natural 20).
    /// </summary>
    public bool IsCriticalSuccess => Roll == 20;

    /// <summary>
    /// Gets whether this was a critical failure (natural 1).
    /// </summary>
    public bool IsCriticalFailure => Roll == 1;
}
```

**File:** `src/Core/RuneAndRust.Application/Events/ResourceGatheredEvent.cs`

```csharp
namespace RuneAndRust.Application.Events;

/// <summary>
/// Event raised when a player successfully gathers resources from a feature.
/// </summary>
/// <remarks>
/// This event is only raised on successful gathering attempts. It captures
/// the resources added to the player's inventory for statistics, achievements,
/// and UI updates.
/// </remarks>
/// <example>
/// eventBus.Publish(new ResourceGatheredEvent(
///     PlayerId: player.Id,
///     ResourceId: "iron-ore",
///     ResourceName: "Iron Ore",
///     Quantity: 3,
///     Quality: ResourceQuality.Common,
///     FeatureId: feature.Id,
///     FeatureDepleted: false));
/// </example>
public record ResourceGatheredEvent(
    Guid PlayerId,
    string ResourceId,
    string ResourceName,
    int Quantity,
    ResourceQuality Quality,
    Guid FeatureId,
    bool FeatureDepleted) : IGameEvent
{
    /// <summary>
    /// Gets the timestamp when the event occurred.
    /// </summary>
    public DateTimeOffset Timestamp { get; init; } = DateTimeOffset.UtcNow;

    /// <summary>
    /// Gets the total value of the gathered resources.
    /// </summary>
    /// <param name="baseValue">The base value of the resource.</param>
    /// <returns>Total value (baseValue * quantity * quality multiplier).</returns>
    public int GetTotalValue(int baseValue)
    {
        return (int)(baseValue * Quantity * Quality.GetValueMultiplier());
    }
}
```

---

## 7. IGatheringService Interface

**File:** `src/Core/RuneAndRust.Application/Interfaces/IGatheringService.cs`

```csharp
namespace RuneAndRust.Application.Interfaces;

/// <summary>
/// Service for gathering resources from harvestable features.
/// </summary>
/// <remarks>
/// <para>
/// The gathering service handles the complete resource harvesting flow:
/// validation, dice rolling, quantity determination, quality upgrades,
/// inventory updates, and feature depletion.
/// </para>
/// <para>
/// Gathering uses the Survival skill. The player rolls d20 + Survival modifier
/// against the feature's Difficulty Class (DC). Success yields resources,
/// with high rolls potentially upgrading the quality tier.
/// </para>
/// </remarks>
public interface IGatheringService
{
    /// <summary>
    /// Gets all harvestable features in a room that are not depleted.
    /// </summary>
    /// <param name="room">The room to check.</param>
    /// <returns>A read-only list of available harvestable features.</returns>
    /// <example>
    /// var features = gatheringService.GetHarvestableFeatures(currentRoom);
    /// foreach (var feature in features)
    /// {
    ///     Console.WriteLine($"[{feature.Name}] - DC {feature.DifficultyClass}");
    /// }
    /// </example>
    IReadOnlyList<HarvestableFeature> GetHarvestableFeatures(Room room);

    /// <summary>
    /// Validates if a player can gather from a specific feature.
    /// </summary>
    /// <param name="player">The player attempting to gather.</param>
    /// <param name="feature">The feature to gather from.</param>
    /// <returns>A validation result indicating if gathering can proceed.</returns>
    /// <remarks>
    /// Checks:
    /// - Feature is not depleted
    /// - Player has required tool (if any)
    /// - Feature definition exists
    /// </remarks>
    GatherValidation CanGather(Player player, HarvestableFeature feature);

    /// <summary>
    /// Attempts to gather resources from a harvestable feature.
    /// </summary>
    /// <param name="player">The player attempting to gather.</param>
    /// <param name="feature">The feature to gather from.</param>
    /// <returns>A result containing the outcome of the gathering attempt.</returns>
    /// <remarks>
    /// <para>
    /// This method performs the complete gathering flow:
    /// 1. Validates the attempt (CanGather)
    /// 2. Rolls d20 + Survival modifier vs DC
    /// 3. On success: determines quantity and quality
    /// 4. Adds resources to player inventory
    /// 5. Depletes feature and sets replenishment timer
    /// 6. Publishes events
    /// </para>
    /// </remarks>
    GatherResult Gather(Player player, HarvestableFeature feature);

    /// <summary>
    /// Gets the difficulty class for gathering from a feature.
    /// </summary>
    /// <param name="feature">The harvestable feature.</param>
    /// <returns>The DC, or 0 if the feature definition is not found.</returns>
    int GetGatherDC(HarvestableFeature feature);

    /// <summary>
    /// Gets the player's gathering skill modifier.
    /// </summary>
    /// <param name="player">The player.</param>
    /// <returns>The Survival skill modifier.</returns>
    int GetGatherModifier(Player player);

    /// <summary>
    /// Processes replenishment for all harvestable features in a room.
    /// </summary>
    /// <param name="room">The room containing features.</param>
    /// <param name="currentTurn">The current game turn number.</param>
    /// <returns>A list of features that were replenished.</returns>
    /// <remarks>
    /// Call this at the start of each turn to restore depleted features
    /// whose replenishment timers have expired.
    /// </remarks>
    IReadOnlyList<HarvestableFeature> ProcessReplenishment(Room room, int currentTurn);
}
```

---

## 8. GatheringService Implementation

**File:** `src/Core/RuneAndRust.Application/Services/GatheringService.cs`

```csharp
namespace RuneAndRust.Application.Services;

/// <summary>
/// Implements the resource gathering service.
/// </summary>
/// <remarks>
/// <para>
/// The gathering service coordinates between multiple providers and services
/// to execute the gathering flow. It uses the Survival skill for gathering
/// checks and supports quality upgrades on high rolls.
/// </para>
/// </remarks>
public class GatheringService : IGatheringService
{
    private readonly IResourceProvider _resourceProvider;
    private readonly IHarvestableFeatureProvider _featureProvider;
    private readonly IDiceService _diceService;
    private readonly IInventoryService _inventoryService;
    private readonly IEventBus _eventBus;
    private readonly ILogger<GatheringService> _logger;

    /// <summary>
    /// The skill used for gathering checks.
    /// </summary>
    private const string GatherSkill = "survival";

    /// <summary>
    /// The margin required to upgrade resource quality.
    /// </summary>
    private const int QualityUpgradeMargin = 10;

    /// <summary>
    /// Initializes a new instance of the <see cref="GatheringService"/> class.
    /// </summary>
    /// <param name="resourceProvider">Provides resource definitions.</param>
    /// <param name="featureProvider">Provides feature definitions.</param>
    /// <param name="diceService">Handles dice rolling.</param>
    /// <param name="inventoryService">Manages player inventory.</param>
    /// <param name="eventBus">Publishes game events.</param>
    /// <param name="logger">Logger instance.</param>
    public GatheringService(
        IResourceProvider resourceProvider,
        IHarvestableFeatureProvider featureProvider,
        IDiceService diceService,
        IInventoryService inventoryService,
        IEventBus eventBus,
        ILogger<GatheringService> logger)
    {
        _resourceProvider = resourceProvider;
        _featureProvider = featureProvider;
        _diceService = diceService;
        _inventoryService = inventoryService;
        _eventBus = eventBus;
        _logger = logger;
    }

    /// <inheritdoc />
    public IReadOnlyList<HarvestableFeature> GetHarvestableFeatures(Room room)
    {
        ArgumentNullException.ThrowIfNull(room, nameof(room));

        return room.Features
            .OfType<HarvestableFeature>()
            .Where(f => !f.IsDepleted)
            .ToList();
    }

    /// <inheritdoc />
    public GatherValidation CanGather(Player player, HarvestableFeature feature)
    {
        ArgumentNullException.ThrowIfNull(player, nameof(player));
        ArgumentNullException.ThrowIfNull(feature, nameof(feature));

        // Check if feature is depleted
        if (feature.IsDepleted)
        {
            _logger.LogDebug(
                "Gather validation failed: feature '{FeatureId}' is depleted",
                feature.DefinitionId);
            return GatherValidation.Failed("This resource has been depleted.");
        }

        // Get feature definition
        var definition = _featureProvider.GetFeature(feature.DefinitionId);
        if (definition is null)
        {
            _logger.LogWarning(
                "Gather validation failed: unknown feature definition '{FeatureId}'",
                feature.DefinitionId);
            return GatherValidation.Failed("Unknown feature type.");
        }

        // Check for required tool
        if (definition.RequiresTool)
        {
            var hasTool = _inventoryService.HasItem(player.Inventory, definition.RequiredToolId!);
            if (!hasTool)
            {
                var toolName = definition.RequiredToolId;
                _logger.LogDebug(
                    "Gather validation failed: player lacks required tool '{ToolId}'",
                    toolName);
                return GatherValidation.Failed(
                    $"You need a {toolName} to gather this resource.");
            }
        }

        _logger.LogDebug(
            "Gather validation passed for feature '{FeatureId}' (DC: {DC})",
            feature.DefinitionId,
            definition.DifficultyClass);

        return GatherValidation.Success(definition.DifficultyClass);
    }

    /// <inheritdoc />
    public GatherResult Gather(Player player, HarvestableFeature feature)
    {
        ArgumentNullException.ThrowIfNull(player, nameof(player));
        ArgumentNullException.ThrowIfNull(feature, nameof(feature));

        // Validate first
        var validation = CanGather(player, feature);
        if (!validation.IsValid)
        {
            return GatherResult.ValidationFailed(validation.FailureReason!);
        }

        var definition = _featureProvider.GetFeature(feature.DefinitionId)!;
        var resource = _resourceProvider.GetResource(definition.ResourceId);

        if (resource is null)
        {
            _logger.LogError(
                "Resource '{ResourceId}' not found for feature '{FeatureId}'",
                definition.ResourceId,
                feature.DefinitionId);
            return GatherResult.ValidationFailed("Resource definition not found.");
        }

        // Roll gather check
        var modifier = GetGatherModifier(player);
        var roll = _diceService.Roll("1d20");
        var total = roll + modifier;
        var dc = validation.DifficultyClass!.Value;

        _logger.LogDebug(
            "{Player} attempts to gather from '{Feature}': " +
            "1d20 ({Roll}) + {Modifier} = {Total} vs DC {DC}",
            player.Name,
            feature.Name,
            roll,
            modifier,
            total,
            dc);

        // Publish attempt event
        _eventBus.Publish(new GatherAttemptedEvent(
            PlayerId: player.Id,
            FeatureId: feature.Id,
            FeatureDefinitionId: feature.DefinitionId,
            Roll: roll,
            Modifier: modifier,
            Total: total,
            DifficultyClass: dc,
            Success: total >= dc));

        // Check for failure
        if (total < dc)
        {
            _logger.LogDebug(
                "{Player} failed gather check: {Total} vs DC {DC}",
                player.Name,
                total,
                dc);

            return GatherResult.Failed(roll, modifier, total, dc);
        }

        // Determine quantity
        var quantity = DetermineQuantity(feature, definition);

        // Determine quality (potential upgrade on high rolls)
        var quality = DetermineQuality(total, dc, resource.Quality);

        // Add to inventory
        _inventoryService.AddResource(player.Inventory, resource.ResourceId, quantity);

        // Update feature
        feature.Harvest(quantity);

        // Set replenishment timer if feature is depleted and replenishes
        var featureDepleted = feature.IsDepleted;
        if (featureDepleted && definition.Replenishes)
        {
            // Note: currentTurn would come from game state - using 0 as placeholder
            // In actual implementation, this would be injected or passed
            feature.SetReplenishTimer(0, definition.ReplenishTurns);
        }

        _logger.LogInformation(
            "{Player} gathered {Quantity}x {Resource} ({Quality}) from '{Feature}'",
            player.Name,
            quantity,
            resource.Name,
            quality,
            feature.Name);

        // Publish success event
        _eventBus.Publish(new ResourceGatheredEvent(
            PlayerId: player.Id,
            ResourceId: resource.ResourceId,
            ResourceName: resource.Name,
            Quantity: quantity,
            Quality: quality,
            FeatureId: feature.Id,
            FeatureDepleted: featureDepleted));

        return GatherResult.Success(
            roll, modifier, total, dc,
            resource.ResourceId, resource.Name, quantity, quality,
            featureDepleted);
    }

    /// <inheritdoc />
    public int GetGatherDC(HarvestableFeature feature)
    {
        ArgumentNullException.ThrowIfNull(feature, nameof(feature));

        var definition = _featureProvider.GetFeature(feature.DefinitionId);
        return definition?.DifficultyClass ?? 0;
    }

    /// <inheritdoc />
    public int GetGatherModifier(Player player)
    {
        ArgumentNullException.ThrowIfNull(player, nameof(player));

        return player.Skills.GetModifier(GatherSkill);
    }

    /// <inheritdoc />
    public IReadOnlyList<HarvestableFeature> ProcessReplenishment(Room room, int currentTurn)
    {
        ArgumentNullException.ThrowIfNull(room, nameof(room));

        var replenished = new List<HarvestableFeature>();

        foreach (var feature in room.GetHarvestableFeatures())
        {
            if (feature.ShouldReplenish(currentTurn))
            {
                var definition = _featureProvider.GetFeature(feature.DefinitionId);
                if (definition is not null)
                {
                    // Replenish to a random quantity within the definition's range
                    var newQuantity = Random.Shared.Next(
                        definition.MinQuantity,
                        definition.MaxQuantity + 1);

                    feature.Replenish(newQuantity);
                    replenished.Add(feature);

                    _logger.LogDebug(
                        "Feature '{FeatureId}' replenished with {Quantity} resources",
                        feature.DefinitionId,
                        newQuantity);
                }
            }
        }

        if (replenished.Count > 0)
        {
            _logger.LogInformation(
                "Replenished {Count} features in room '{RoomId}'",
                replenished.Count,
                room.Id);
        }

        return replenished;
    }

    /// <summary>
    /// Determines the quantity of resources to gather.
    /// </summary>
    /// <param name="feature">The harvestable feature instance.</param>
    /// <param name="definition">The feature definition.</param>
    /// <returns>The quantity to gather.</returns>
    private int DetermineQuantity(
        HarvestableFeature feature,
        HarvestableFeatureDefinition definition)
    {
        // Calculate the maximum we can take (limited by what remains)
        var maxAvailable = Math.Min(feature.RemainingQuantity, definition.MaxQuantity);
        var minGather = Math.Min(definition.MinQuantity, maxAvailable);

        if (maxAvailable <= minGather)
        {
            return maxAvailable;
        }

        // Roll for quantity within the available range
        var range = maxAvailable - minGather + 1;
        var quantityRoll = _diceService.Roll($"1d{range}");
        var quantity = minGather + quantityRoll - 1;

        return Math.Min(quantity, maxAvailable);
    }

    /// <summary>
    /// Determines the quality of gathered resources, potentially upgrading
    /// based on the roll margin.
    /// </summary>
    /// <param name="total">The total roll result.</param>
    /// <param name="dc">The difficulty class.</param>
    /// <param name="baseQuality">The base quality from the resource definition.</param>
    /// <returns>The final quality tier.</returns>
    private ResourceQuality DetermineQuality(int total, int dc, ResourceQuality baseQuality)
    {
        var margin = total - dc;

        // Upgrade quality if margin is >= QualityUpgradeMargin (10)
        if (margin >= QualityUpgradeMargin)
        {
            var upgraded = (ResourceQuality)Math.Min(
                (int)baseQuality + 1,
                (int)ResourceQuality.Legendary);

            if (upgraded != baseQuality)
            {
                _logger.LogDebug(
                    "Quality upgraded from {Base} to {Upgraded} (margin: {Margin})",
                    baseQuality,
                    upgraded,
                    margin);
            }

            return upgraded;
        }

        return baseQuality;
    }
}
```

---

## 9. GatherCommand Implementation

**File:** `src/Core/RuneAndRust.Application/Commands/GatherCommand.cs`

```csharp
namespace RuneAndRust.Application.Commands;

/// <summary>
/// Command to gather resources from a harvestable feature.
/// </summary>
/// <remarks>
/// <para>
/// Usage:
/// - `gather` - Lists available harvestable features in the current room
/// - `gather &lt;feature-name&gt;` - Attempts to gather from the specified feature
/// </para>
/// <para>
/// The feature name can be a partial match (case-insensitive) of either
/// the feature's display name or its definition ID.
/// </para>
/// </remarks>
/// <example>
/// > gather
/// Harvestable Features:
///   [Iron Ore Vein] - A vein of iron ore in the wall (DC 12)
///   [Herb Patch] - A patch of healing herbs (DC 10)
///
/// > gather ore
/// Gathering Check (DC 12): 1d20 (15) + 3 = 18
/// ✓ Success!
/// You gathered: Iron Ore x3 (Common)
/// </example>
public class GatherCommand : IGameCommand
{
    private readonly IGatheringService _gatheringService;
    private readonly IGameSessionService _sessionService;
    private readonly IHarvestableFeatureProvider _featureProvider;
    private readonly ILogger<GatherCommand> _logger;

    /// <summary>
    /// Gets the command name.
    /// </summary>
    public string Name => "gather";

    /// <summary>
    /// Gets the command description.
    /// </summary>
    public string Description => "Gather resources from a harvestable feature";

    /// <summary>
    /// Gets the command usage.
    /// </summary>
    public string Usage => "gather [<feature-name>]";

    /// <summary>
    /// Gets the command aliases.
    /// </summary>
    public IReadOnlyList<string> Aliases => new[] { "harvest", "collect" };

    /// <summary>
    /// Initializes a new instance of the <see cref="GatherCommand"/> class.
    /// </summary>
    /// <param name="gatheringService">The gathering service.</param>
    /// <param name="sessionService">The game session service.</param>
    /// <param name="featureProvider">The feature provider.</param>
    /// <param name="logger">Logger instance.</param>
    public GatherCommand(
        IGatheringService gatheringService,
        IGameSessionService sessionService,
        IHarvestableFeatureProvider featureProvider,
        ILogger<GatherCommand> logger)
    {
        _gatheringService = gatheringService;
        _sessionService = sessionService;
        _featureProvider = featureProvider;
        _logger = logger;
    }

    /// <summary>
    /// Executes the gather command.
    /// </summary>
    /// <param name="player">The player executing the command.</param>
    /// <param name="args">Command arguments.</param>
    /// <returns>The command result.</returns>
    public CommandResult Execute(Player player, string[] args)
    {
        var room = _sessionService.GetCurrentRoom(player);

        if (args.Length == 0)
        {
            return ListFeatures(room);
        }

        return GatherFromFeature(player, room, args);
    }

    /// <summary>
    /// Lists available harvestable features in the room.
    /// </summary>
    /// <param name="room">The current room.</param>
    /// <returns>A command result with the feature list.</returns>
    private CommandResult ListFeatures(Room room)
    {
        var features = _gatheringService.GetHarvestableFeatures(room);

        if (features.Count == 0)
        {
            return CommandResult.Info("There is nothing to gather here.");
        }

        var lines = new List<string> { "Harvestable Features:" };

        foreach (var feature in features)
        {
            var definition = _featureProvider.GetFeature(feature.DefinitionId);
            var dc = definition?.DifficultyClass ?? 0;
            var toolReq = definition?.RequiresTool == true
                ? $" (requires {definition.RequiredToolId})"
                : "";

            lines.Add($"  [{feature.Name}] - {feature.Description} (DC {dc}){toolReq}");
            lines.Add($"    Remaining: {feature.RemainingQuantity}");
        }

        return CommandResult.List(string.Join("\n", lines));
    }

    /// <summary>
    /// Attempts to gather from a specific feature.
    /// </summary>
    /// <param name="player">The player.</param>
    /// <param name="room">The current room.</param>
    /// <param name="args">The command arguments containing the feature name.</param>
    /// <returns>The command result.</returns>
    private CommandResult GatherFromFeature(Player player, Room room, string[] args)
    {
        var featureName = string.Join(" ", args).ToLowerInvariant();

        // Find the feature by name or ID
        var features = _gatheringService.GetHarvestableFeatures(room);
        var feature = features.FirstOrDefault(f =>
            f.Name.ToLowerInvariant().Contains(featureName) ||
            f.DefinitionId.Contains(featureName));

        if (feature is null)
        {
            // Check if there's a depleted feature with that name
            var depletedFeature = room.GetHarvestableFeatures()
                .FirstOrDefault(f =>
                    f.Name.ToLowerInvariant().Contains(featureName) ||
                    f.DefinitionId.Contains(featureName));

            if (depletedFeature is not null && depletedFeature.IsDepleted)
            {
                return CommandResult.Error(
                    $"The {depletedFeature.Name} has been depleted.");
            }

            return CommandResult.Error(
                $"No harvestable feature '{string.Join(" ", args)}' found here.");
        }

        _logger.LogDebug(
            "{Player} executing gather command for feature '{Feature}'",
            player.Name,
            feature.Name);

        // Attempt to gather
        var result = _gatheringService.Gather(player, feature);

        return FormatResult(result);
    }

    /// <summary>
    /// Formats a gather result into a command result.
    /// </summary>
    /// <param name="result">The gather result.</param>
    /// <returns>The formatted command result.</returns>
    private static CommandResult FormatResult(GatherResult result)
    {
        if (result.IsValidationFailure)
        {
            return CommandResult.Error(result.FailureReason!);
        }

        var lines = new List<string>();

        // Show dice roll
        lines.Add($"Gathering Check (DC {result.DifficultyClass}):");
        lines.Add($"  {result.GetRollDisplay()}");
        lines.Add("");

        if (result.IsSuccess)
        {
            lines.Add("✓ Success!");
            lines.Add("");

            var qualityText = result.Quality == ResourceQuality.Common
                ? ""
                : $" ({result.Quality})";

            lines.Add($"You gathered: {result.ResourceName} x{result.Quantity}{qualityText}");

            if (result.FeatureDepleted)
            {
                lines.Add("");
                lines.Add("The resource has been depleted.");
            }

            return CommandResult.Success(string.Join("\n", lines));
        }
        else
        {
            lines.Add("✗ Failed!");
            lines.Add("");
            lines.Add("You failed to gather any resources.");

            return CommandResult.Failure(string.Join("\n", lines));
        }
    }
}
```

---

## 10. Logging Specifications

### Log Levels by Component

| Component | Level | Events |
|-----------|-------|--------|
| `GatheringService` | Information | Successful gathers, replenishment summary |
| `GatheringService` | Debug | Validation results, roll details, quantity/quality determination |
| `GatheringService` | Warning | Missing feature/resource definitions |
| `GatheringService` | Error | Critical failures (missing resources) |
| `GatherCommand` | Debug | Command execution |

### Logging Decision Tree

```
GatheringService.CanGather()
│
├── Feature depleted?
│   └── [DEBUG] "Gather validation failed: feature '{FeatureId}' is depleted"
│
├── Definition not found?
│   └── [WARN] "Gather validation failed: unknown feature definition '{FeatureId}'"
│
├── Missing required tool?
│   └── [DEBUG] "Gather validation failed: player lacks required tool '{ToolId}'"
│
└── Validation passed?
    └── [DEBUG] "Gather validation passed for feature '{FeatureId}' (DC: {DC})"


GatheringService.Gather()
│
├── [DEBUG] "{Player} attempts to gather from '{Feature}': 1d20 ({Roll}) + {Modifier} = {Total} vs DC {DC}"
│
├── Roll failed (Total < DC)?
│   └── [DEBUG] "{Player} failed gather check: {Total} vs DC {DC}"
│
├── Roll succeeded?
│   │
│   ├── Quality upgraded?
│   │   └── [DEBUG] "Quality upgraded from {Base} to {Upgraded} (margin: {Margin})"
│   │
│   └── [INFO] "{Player} gathered {Quantity}x {Resource} ({Quality}) from '{Feature}'"
│
└── Resource not found?
    └── [ERROR] "Resource '{ResourceId}' not found for feature '{FeatureId}'"


GatheringService.ProcessReplenishment()
│
├── Feature replenished?
│   └── [DEBUG] "Feature '{FeatureId}' replenished with {Quantity} resources"
│
└── Any features replenished?
    └── [INFO] "Replenished {Count} features in room '{RoomId}'"
```

### Sample Log Output

```
[DBG] Gather validation passed for feature 'iron-ore-vein' (DC: 12)
[DBG] Player1 attempts to gather from 'Iron Ore Vein': 1d20 (15) + 3 = 18 vs DC 12
[INF] Player1 gathered 3x Iron Ore (Common) from 'Iron Ore Vein'

[DBG] Gather validation passed for feature 'gem-cluster' (DC: 16)
[DBG] Player1 attempts to gather from 'Gem Cluster': 1d20 (19) + 3 = 22 vs DC 16
[DBG] Quality upgraded from Common to Fine (margin: 6)
[INF] Player1 gathered 2x Ruby (Fine) from 'Gem Cluster'

[DBG] Gather validation failed: feature 'herb-patch' is depleted

[DBG] Gather validation failed: player lacks required tool 'pickaxe'

[DBG] Player2 attempts to gather from 'Copper Ore Vein': 1d20 (6) + 1 = 7 vs DC 10
[DBG] Player2 failed gather check: 7 vs DC 10

[DBG] Feature 'herb-patch' replenished with 4 resources
[INF] Replenished 1 features in room 'room-123'
```

---

## 11. Unit Testing Requirements

### Test Count by Feature

| Feature | Test Count | Description |
|---------|------------|-------------|
| GatherResult factory methods | 2 | Success, Failed, ValidationFailed creation |
| GatherResult properties | 1 | Margin calculation, display methods |
| GatherValidation factory methods | 1 | Success, Failed creation |
| GatheringService.CanGather | 3 | Valid, depleted, missing tool |
| GatheringService.Gather success | 1 | Full gather flow with success |
| GatheringService.Gather failure | 1 | Roll failure case |
| GatheringService.GetGatherModifier | 1 | Returns Survival skill modifier |
| GatheringService.ProcessReplenishment | 1 | Replenishes ready features |
| GatherCommand.Execute | 2 | List features, gather from feature |
| **Total** | **~9** | |

### Test Specifications

**File:** `tests/RuneAndRust.Application.Tests/Results/GatherResultTests.cs`

```csharp
[TestFixture]
public class GatherResultTests
{
    [Test]
    public void Success_CreatesSuccessfulResult()
    {
        // Act
        var result = GatherResult.Success(
            roll: 15, modifier: 3, total: 18, dc: 12,
            resourceId: "iron-ore", resourceName: "Iron Ore",
            quantity: 3, quality: ResourceQuality.Common,
            featureDepleted: false);

        // Assert
        Assert.That(result.IsSuccess, Is.True);
        Assert.That(result.Roll, Is.EqualTo(15));
        Assert.That(result.Modifier, Is.EqualTo(3));
        Assert.That(result.Total, Is.EqualTo(18));
        Assert.That(result.DifficultyClass, Is.EqualTo(12));
        Assert.That(result.ResourceId, Is.EqualTo("iron-ore"));
        Assert.That(result.Quantity, Is.EqualTo(3));
        Assert.That(result.FeatureDepleted, Is.False);
        Assert.That(result.FailureReason, Is.Null);
    }

    [Test]
    public void Failed_CreatesFailedResult()
    {
        // Act
        var result = GatherResult.Failed(roll: 8, modifier: 3, total: 11, dc: 12);

        // Assert
        Assert.That(result.IsSuccess, Is.False);
        Assert.That(result.Roll, Is.EqualTo(8));
        Assert.That(result.Total, Is.EqualTo(11));
        Assert.That(result.DifficultyClass, Is.EqualTo(12));
        Assert.That(result.ResourceId, Is.Null);
        Assert.That(result.Quantity, Is.EqualTo(0));
        Assert.That(result.FailureReason, Is.Not.Null);
    }

    [Test]
    public void ValidationFailed_CreatesValidationFailureResult()
    {
        // Act
        var result = GatherResult.ValidationFailed("Feature is depleted.");

        // Assert
        Assert.That(result.IsSuccess, Is.False);
        Assert.That(result.IsValidationFailure, Is.True);
        Assert.That(result.Roll, Is.EqualTo(0));
        Assert.That(result.FailureReason, Is.EqualTo("Feature is depleted."));
    }

    [Test]
    public void Margin_ReturnsCorrectValue()
    {
        // Arrange
        var success = GatherResult.Success(
            15, 3, 18, 12, "iron-ore", "Iron Ore", 3, ResourceQuality.Common, false);
        var failure = GatherResult.Failed(8, 3, 11, 12);

        // Assert
        Assert.That(success.Margin, Is.EqualTo(6)); // 18 - 12
        Assert.That(failure.Margin, Is.EqualTo(-1)); // 11 - 12
    }
}
```

**File:** `tests/RuneAndRust.Application.Tests/Services/GatheringServiceTests.cs`

```csharp
[TestFixture]
public class GatheringServiceTests
{
    private GatheringService _service = null!;
    private Mock<IResourceProvider> _resourceProviderMock = null!;
    private Mock<IHarvestableFeatureProvider> _featureProviderMock = null!;
    private Mock<IDiceService> _diceServiceMock = null!;
    private Mock<IInventoryService> _inventoryServiceMock = null!;
    private Mock<IEventBus> _eventBusMock = null!;

    [SetUp]
    public void SetUp()
    {
        _resourceProviderMock = new Mock<IResourceProvider>();
        _featureProviderMock = new Mock<IHarvestableFeatureProvider>();
        _diceServiceMock = new Mock<IDiceService>();
        _inventoryServiceMock = new Mock<IInventoryService>();
        _eventBusMock = new Mock<IEventBus>();

        _service = new GatheringService(
            _resourceProviderMock.Object,
            _featureProviderMock.Object,
            _diceServiceMock.Object,
            _inventoryServiceMock.Object,
            _eventBusMock.Object,
            new NullLogger<GatheringService>());
    }

    [Test]
    public void CanGather_WithValidFeature_ReturnsSuccess()
    {
        // Arrange
        var player = CreateTestPlayer();
        var feature = CreateTestFeature(remainingQuantity: 5);
        var definition = CreateTestFeatureDefinition();

        _featureProviderMock
            .Setup(p => p.GetFeature("iron-ore-vein"))
            .Returns(definition);

        // Act
        var result = _service.CanGather(player, feature);

        // Assert
        Assert.That(result.IsValid, Is.True);
        Assert.That(result.DifficultyClass, Is.EqualTo(12));
    }

    [Test]
    public void CanGather_WithDepletedFeature_ReturnsFailed()
    {
        // Arrange
        var player = CreateTestPlayer();
        var feature = CreateTestFeature(remainingQuantity: 0);

        // Act
        var result = _service.CanGather(player, feature);

        // Assert
        Assert.That(result.IsValid, Is.False);
        Assert.That(result.FailureReason, Does.Contain("depleted"));
    }

    [Test]
    public void CanGather_WithMissingTool_ReturnsFailed()
    {
        // Arrange
        var player = CreateTestPlayer();
        var feature = CreateTestFeature(remainingQuantity: 5);
        var definition = CreateTestFeatureDefinition(requiredTool: "pickaxe");

        _featureProviderMock
            .Setup(p => p.GetFeature("iron-ore-vein"))
            .Returns(definition);

        _inventoryServiceMock
            .Setup(i => i.HasItem(It.IsAny<Inventory>(), "pickaxe"))
            .Returns(false);

        // Act
        var result = _service.CanGather(player, feature);

        // Assert
        Assert.That(result.IsValid, Is.False);
        Assert.That(result.FailureReason, Does.Contain("pickaxe"));
    }

    [Test]
    public void Gather_WithSuccessfulRoll_ReturnsSuccess()
    {
        // Arrange
        var player = CreateTestPlayer(survivalModifier: 3);
        var feature = CreateTestFeature(remainingQuantity: 5);
        var definition = CreateTestFeatureDefinition(dc: 12);
        var resource = CreateTestResource();

        SetupProviders(definition, resource);
        _diceServiceMock.Setup(d => d.Roll("1d20")).Returns(15); // 15 + 3 = 18 >= 12
        _diceServiceMock.Setup(d => d.Roll(It.IsRegex("1d\\d+"))).Returns(3);

        // Act
        var result = _service.Gather(player, feature);

        // Assert
        Assert.That(result.IsSuccess, Is.True);
        Assert.That(result.Roll, Is.EqualTo(15));
        Assert.That(result.Total, Is.EqualTo(18));
        Assert.That(result.ResourceId, Is.EqualTo("iron-ore"));
        Assert.That(result.Quantity, Is.GreaterThan(0));
    }

    [Test]
    public void Gather_WithFailedRoll_ReturnsFailed()
    {
        // Arrange
        var player = CreateTestPlayer(survivalModifier: 3);
        var feature = CreateTestFeature(remainingQuantity: 5);
        var definition = CreateTestFeatureDefinition(dc: 12);
        var resource = CreateTestResource();

        SetupProviders(definition, resource);
        _diceServiceMock.Setup(d => d.Roll("1d20")).Returns(5); // 5 + 3 = 8 < 12

        // Act
        var result = _service.Gather(player, feature);

        // Assert
        Assert.That(result.IsSuccess, Is.False);
        Assert.That(result.Roll, Is.EqualTo(5));
        Assert.That(result.Total, Is.EqualTo(8));
        Assert.That(result.FailureReason, Does.Contain("failed"));
    }

    [Test]
    public void GetGatherModifier_ReturnsSurvivalSkill()
    {
        // Arrange
        var player = CreateTestPlayer(survivalModifier: 5);

        // Act
        var modifier = _service.GetGatherModifier(player);

        // Assert
        Assert.That(modifier, Is.EqualTo(5));
    }

    [Test]
    public void ProcessReplenishment_ReplenishesReadyFeatures()
    {
        // Arrange
        var room = CreateTestRoom();
        var feature = CreateTestFeature(remainingQuantity: 0);
        feature.SetReplenishTimer(0, 100);
        room.AddHarvestableFeature(feature);

        var definition = CreateTestFeatureDefinition(replenishTurns: 100);
        _featureProviderMock
            .Setup(p => p.GetFeature("iron-ore-vein"))
            .Returns(definition);

        // Act
        var replenished = _service.ProcessReplenishment(room, currentTurn: 100);

        // Assert
        Assert.That(replenished, Has.Count.EqualTo(1));
        Assert.That(feature.IsDepleted, Is.False);
    }

    // Helper methods
    private static Player CreateTestPlayer(int survivalModifier = 0) { /* ... */ }
    private static HarvestableFeature CreateTestFeature(int remainingQuantity) { /* ... */ }
    private static HarvestableFeatureDefinition CreateTestFeatureDefinition(
        int dc = 12, string? requiredTool = null, int replenishTurns = 0) { /* ... */ }
    private static ResourceDefinition CreateTestResource() { /* ... */ }
    private static Room CreateTestRoom() { /* ... */ }
    private void SetupProviders(
        HarvestableFeatureDefinition definition,
        ResourceDefinition resource) { /* ... */ }
}
```

**File:** `tests/RuneAndRust.Application.Tests/Commands/GatherCommandTests.cs`

```csharp
[TestFixture]
public class GatherCommandTests
{
    private GatherCommand _command = null!;
    private Mock<IGatheringService> _gatheringServiceMock = null!;
    private Mock<IGameSessionService> _sessionServiceMock = null!;
    private Mock<IHarvestableFeatureProvider> _featureProviderMock = null!;

    [SetUp]
    public void SetUp()
    {
        _gatheringServiceMock = new Mock<IGatheringService>();
        _sessionServiceMock = new Mock<IGameSessionService>();
        _featureProviderMock = new Mock<IHarvestableFeatureProvider>();

        _command = new GatherCommand(
            _gatheringServiceMock.Object,
            _sessionServiceMock.Object,
            _featureProviderMock.Object,
            new NullLogger<GatherCommand>());
    }

    [Test]
    public void Execute_WithNoArgs_ListsFeatures()
    {
        // Arrange
        var player = CreateTestPlayer();
        var room = CreateTestRoom();
        var features = new List<HarvestableFeature>
        {
            CreateTestFeature("Iron Ore Vein"),
            CreateTestFeature("Herb Patch")
        };

        _sessionServiceMock.Setup(s => s.GetCurrentRoom(player)).Returns(room);
        _gatheringServiceMock.Setup(g => g.GetHarvestableFeatures(room)).Returns(features);

        // Act
        var result = _command.Execute(player, Array.Empty<string>());

        // Assert
        Assert.That(result.Output, Does.Contain("Iron Ore Vein"));
        Assert.That(result.Output, Does.Contain("Herb Patch"));
    }

    [Test]
    public void Execute_WithFeatureName_AttemptsGather()
    {
        // Arrange
        var player = CreateTestPlayer();
        var room = CreateTestRoom();
        var feature = CreateTestFeature("Iron Ore Vein");
        var features = new List<HarvestableFeature> { feature };

        _sessionServiceMock.Setup(s => s.GetCurrentRoom(player)).Returns(room);
        _gatheringServiceMock.Setup(g => g.GetHarvestableFeatures(room)).Returns(features);
        _gatheringServiceMock.Setup(g => g.Gather(player, feature))
            .Returns(GatherResult.Success(15, 3, 18, 12, "iron-ore", "Iron Ore", 3,
                ResourceQuality.Common, false));

        // Act
        var result = _command.Execute(player, new[] { "iron" });

        // Assert
        Assert.That(result.Output, Does.Contain("Success"));
        Assert.That(result.Output, Does.Contain("Iron Ore"));
    }

    // Helper methods
    private static Player CreateTestPlayer() { /* ... */ }
    private static Room CreateTestRoom() { /* ... */ }
    private static HarvestableFeature CreateTestFeature(string name) { /* ... */ }
}
```

---

## 12. Use Cases

### UC-001: List Harvestable Features

**Actor:** Player
**Flow:** Player enters room → Types "gather" → System lists available features with DC and requirements

```
┌─────────────────────────────────────────────────────────────────────────┐
│                    UC-001: LIST HARVESTABLE FEATURES                     │
└─────────────────────────────────────────────────────────────────────────┘

    Player Input: > gather
           │
           ▼
    ┌──────────────────────────────────────┐
    │ 1. Get current room                  │
    └──────────────────────────────────────┘
           │
           ▼
    ┌──────────────────────────────────────┐
    │ 2. GetHarvestableFeatures(room)      │
    │    Filter: !IsDepleted               │
    └──────────────────────────────────────┘
           │
           ├── No features ────────▶ "There is nothing to gather here."
           │
           ▼
    ┌──────────────────────────────────────┐
    │ 3. For each feature:                 │
    │    - Get definition for DC           │
    │    - Format display string           │
    └──────────────────────────────────────┘
           │
           ▼
    Display:
    Harvestable Features:
      [Iron Ore Vein] - A vein of iron ore (DC 12)
        Remaining: 5
      [Herb Patch] - Healing herbs (DC 10)
        Remaining: 4
```

### UC-002: Gather Resources Successfully

**Actor:** Player
**Flow:** Player types "gather ore" → Validation passes → Roll succeeds → Resources added → Feature depletes

```
┌─────────────────────────────────────────────────────────────────────────┐
│                  UC-002: GATHER RESOURCES SUCCESSFULLY                   │
└─────────────────────────────────────────────────────────────────────────┘

    Player Input: > gather ore
           │
           ▼
    ┌──────────────────────────────────────┐
    │ 1. Find feature matching "ore"       │
    │    Result: Iron Ore Vein             │
    └──────────────────────────────────────┘
           │
           ▼
    ┌──────────────────────────────────────┐
    │ 2. CanGather(player, feature)        │
    │    - Not depleted ✓                  │
    │    - Has tool (none required) ✓      │
    └──────────────────────────────────────┘
           │
           ▼
    ┌──────────────────────────────────────┐
    │ 3. Roll gather check                 │
    │    1d20 (15) + 3 = 18 vs DC 12       │
    │    Success!                          │
    └──────────────────────────────────────┘
           │
           ▼
    ┌──────────────────────────────────────┐
    │ 4. Determine quantity (1d5 = 3)      │
    │ 5. Determine quality (margin 6 < 10) │
    │    Quality: Common                   │
    └──────────────────────────────────────┘
           │
           ▼
    ┌──────────────────────────────────────┐
    │ 6. Add to inventory                  │
    │    + Iron Ore x3                     │
    └──────────────────────────────────────┘
           │
           ▼
    ┌──────────────────────────────────────┐
    │ 7. Update feature                    │
    │    Remaining: 5 - 3 = 2              │
    └──────────────────────────────────────┘
           │
           ▼
    Display:
    Gathering Check (DC 12):
      1d20 (15) + 3 = 18

    ✓ Success!
    You gathered: Iron Ore x3 (Common)
```

### UC-003: Gather Fails Due to Low Roll

**Actor:** Player
**Flow:** Player gathers → Roll fails → No resources, no depletion

### UC-004: Gather Fails Due to Missing Tool

**Actor:** Player
**Flow:** Player tries to gather from feature requiring tool → Validation fails → Error message

### UC-005: Quality Upgrade on High Roll

**Actor:** Player
**Flow:** Player gathers → Roll exceeds DC by 10+ → Quality upgraded by one tier

```
┌─────────────────────────────────────────────────────────────────────────┐
│                 UC-005: QUALITY UPGRADE ON HIGH ROLL                     │
└─────────────────────────────────────────────────────────────────────────┘

    Roll: 1d20 (18) + 5 = 23 vs DC 12
    Margin: 23 - 12 = 11 (>= 10)
           │
           ▼
    ┌──────────────────────────────────────┐
    │ Quality Upgrade Check                │
    │ Base Quality: Common                 │
    │ Margin >= 10: YES                    │
    │ New Quality: Fine                    │
    └──────────────────────────────────────┘
           │
           ▼
    Display:
    Gathering Check (DC 12):
      1d20 (18) + 5 = 23

    ✓ Success!
    You gathered: Iron Ore x3 (Fine)  ← Quality upgraded!
```

---

## 13. Deliverable Checklist

### Application Layer - Results

- [ ] `GatherResult` record with factory methods
- [ ] `GatherResult.Success()` factory method
- [ ] `GatherResult.Failed()` factory method
- [ ] `GatherResult.ValidationFailed()` factory method
- [ ] `GatherResult.IsValidationFailure` property
- [ ] `GatherResult.Margin` property
- [ ] `GatherResult.GetRollDisplay()` method
- [ ] `GatherResult.GetOutcomeDisplay()` method
- [ ] `GatherValidation` record with factory methods
- [ ] `GatherValidation.Success()` factory method
- [ ] `GatherValidation.Failed()` factory method

### Application Layer - Events

- [ ] `GatherAttemptedEvent` record
- [ ] `ResourceGatheredEvent` record

### Application Layer - Interfaces

- [ ] `IGatheringService` interface with 6 methods

### Application Layer - Services

- [ ] `GatheringService` implementation
- [ ] `GatheringService.GetHarvestableFeatures()`
- [ ] `GatheringService.CanGather()`
- [ ] `GatheringService.Gather()`
- [ ] `GatheringService.GetGatherDC()`
- [ ] `GatheringService.GetGatherModifier()`
- [ ] `GatheringService.ProcessReplenishment()`
- [ ] `GatheringService.DetermineQuantity()` (private)
- [ ] `GatheringService.DetermineQuality()` (private)

### Application Layer - Commands

- [ ] `GatherCommand` implementation
- [ ] `GatherCommand.Execute()` method
- [ ] `GatherCommand.ListFeatures()` method
- [ ] `GatherCommand.GatherFromFeature()` method
- [ ] `GatherCommand.FormatResult()` method
- [ ] Command aliases: "harvest", "collect"

### Testing

- [ ] `GatherResultTests.cs` (~4 tests)
- [ ] `GatheringServiceTests.cs` (~6 tests)
- [ ] `GatherCommandTests.cs` (~2 tests)
- [ ] All tests passing

### Documentation

- [ ] XML documentation on all public members
- [ ] Code examples in XML docs for key methods

---

## 14. Acceptance Criteria

### Functional

- [ ] `GatherResult.Success` creates result with all properties set
- [ ] `GatherResult.Failed` creates result with roll details and failure reason
- [ ] `GatherResult.ValidationFailed` creates result with zero roll values
- [ ] `GatherResult.Margin` calculates Total - DC correctly
- [ ] `GatherValidation.Success` includes difficulty class
- [ ] `GatherValidation.Failed` includes failure reason
- [ ] `GatherAttemptedEvent` captures all roll details
- [ ] `ResourceGatheredEvent` captures all gather details
- [ ] `IGatheringService.GetHarvestableFeatures` returns non-depleted features only
- [ ] `IGatheringService.CanGather` validates depletion state
- [ ] `IGatheringService.CanGather` validates tool requirements
- [ ] `IGatheringService.Gather` returns validation failure on invalid attempt
- [ ] `IGatheringService.Gather` rolls d20 + Survival modifier
- [ ] `IGatheringService.Gather` returns failure when roll < DC
- [ ] `IGatheringService.Gather` determines quantity within min/max range
- [ ] `IGatheringService.Gather` upgrades quality when margin >= 10
- [ ] `IGatheringService.Gather` adds resources to inventory
- [ ] `IGatheringService.Gather` depletes feature by gathered quantity
- [ ] `IGatheringService.Gather` sets replenishment timer when feature depletes
- [ ] `IGatheringService.Gather` publishes GatherAttemptedEvent
- [ ] `IGatheringService.Gather` publishes ResourceGatheredEvent on success
- [ ] `IGatheringService.GetGatherModifier` returns Survival skill
- [ ] `IGatheringService.ProcessReplenishment` replenishes ready features
- [ ] `GatherCommand` with no args lists available features
- [ ] `GatherCommand` with feature name attempts to gather
- [ ] `GatherCommand` displays roll details and outcome
- [ ] `GatherCommand` aliases (harvest, collect) work

### Quality

- [ ] Build succeeds with 0 errors
- [ ] Build succeeds with 0 warnings
- [ ] All ~9 unit tests pass
- [ ] XML documentation complete on all public members
- [ ] Events implement IGameEvent interface
- [ ] Quality upgrade capped at Legendary
- [ ] Quantity cannot exceed remaining in feature

---

## 15. Dependencies

### Required From v0.11.0a

| Type | Location | Usage |
|------|----------|-------|
| `ResourceDefinition` | `Domain/Definitions/ResourceDefinition.cs` | Resource data for inventory |
| `IResourceProvider` | `Application/Interfaces/IResourceProvider.cs` | Get resource definitions |
| `ResourceQuality` | `Domain/Enums/ResourceQuality.cs` | Quality tier handling |
| `ResourceQualityExtensions` | `Domain/Enums/ResourceQuality.cs` | GetValueMultiplier() |

### Required From v0.11.0b

| Type | Location | Usage |
|------|----------|-------|
| `HarvestableFeatureDefinition` | `Domain/Definitions/HarvestableFeatureDefinition.cs` | DC, tool, quantity range |
| `HarvestableFeature` | `Domain/Entities/HarvestableFeature.cs` | Room instance to gather from |
| `IHarvestableFeatureProvider` | `Application/Interfaces/IHarvestableFeatureProvider.cs` | Get feature definitions |
| `Room.GetHarvestableFeatures()` | `Domain/Entities/Room.cs` | Room feature access |

### Required From Prior Versions

| Type | Location | Usage |
|------|----------|-------|
| `Player` | `Domain/Entities/Player.cs` | Player entity |
| `Room` | `Domain/Entities/Room.cs` | Room entity |
| `Inventory` | `Domain/Entities/Inventory.cs` | Player inventory |
| `Skills` | `Domain/ValueObjects/Skills.cs` | Survival skill modifier |
| `IDiceService` | `Application/Interfaces/IDiceService.cs` | Dice rolling |
| `IInventoryService` | `Application/Interfaces/IInventoryService.cs` | Add resources |
| `IEventBus` | `Application/Interfaces/IEventBus.cs` | Event publishing |
| `IGameEvent` | `Application/Interfaces/IGameEvent.cs` | Event base interface |
| `IGameCommand` | `Application/Interfaces/IGameCommand.cs` | Command interface |
| `IGameSessionService` | `Application/Interfaces/IGameSessionService.cs` | Get current room |
| `CommandResult` | `Application/Results/CommandResult.cs` | Command output |
| `ILogger<T>` | Microsoft.Extensions.Logging | Logging |

### Provides To v0.11.1+ (Crafting)

| Type | Usage |
|------|-------|
| `IGatheringService` | Crafting may trigger auto-gather |
| `GatherResult` | Crafting recipes may check recent gathers |
| `ResourceGatheredEvent` | Statistics tracking for crafting progress |

### Provides To v0.12.x (Achievements)

| Type | Usage |
|------|-------|
| `GatherAttemptedEvent` | Track gathering attempts for achievements |
| `ResourceGatheredEvent` | Track total resources gathered |

---

## 16. Future Considerations

### Deferred to v0.11.1+ (Crafting)

- **Resource Consumption**: Using gathered resources in recipes
- **Gathering Tools**: Tool durability and quality bonuses
- **Gathering Speed**: Multiple gathers per turn with higher skill

### Deferred to v0.12.x (Achievements & Statistics)

- **Gathering Statistics**: Total gathered by resource type
- **Gathering Achievements**: "Gather 100 Iron Ore", "Find Legendary Resource"
- **Lucky Streak Tracking**: Consecutive successful gathers

### Deferred to v0.13.x (UI Consolidation)

- **Gathering Animation**: Visual feedback during gather
- **Dice Roll Display**: Animated dice roll UI
- **Resource Popup**: Floating text showing gathered resources
- **Feature State UI**: Visual indicators for depleted/available

### Out of Scope

- **Automated Gathering**: NPCs or pets gathering for player
- **Gathering Minigame**: Active participation beyond dice roll
- **Weather Effects**: Environmental modifiers to gathering
- **Time-of-Day Bonuses**: Better yields at certain times

---

## Gathering Mechanics Summary

### Dice Check Formula

```
Roll = 1d20 + Survival Modifier
Success = Roll >= Difficulty Class
```

### Quantity Formula

```
Available = min(Feature.RemainingQuantity, Definition.MaxQuantity)
MinGather = min(Definition.MinQuantity, Available)
Range = Available - MinGather + 1
Quantity = MinGather + (1d{Range} - 1)
```

### Quality Upgrade Rules

| Margin (Roll - DC) | Quality Change |
|-------------------|----------------|
| < 10 | No change (base quality) |
| >= 10 | Upgrade by 1 tier (max Legendary) |

### Skill Used

| Skill | Action |
|-------|--------|
| Survival | All gathering checks |

### Event Sequence

```
1. GatherAttemptedEvent (always, after roll)
2. ResourceGatheredEvent (only on success)
```

---

*Document Version: 1.0*
*Last Updated: 2026-01-16*
*Author: Claude (AI Assistant)*
