> **Archived** - This changelog has been consolidated. See the complete version at [v0.3.14](../v0.3.x/v0.3.14.md).

# Changelog: v0.3.14b - The Flow (Screen Transitions)

**Release Date:** 2025-12-24
**Total Tests:** 13 new tests added (ScreenTransitionServiceTests)
**Terminal Tests:** 411/411 passing
**ScreenTransitionService Tests:** 13/13 passing

## Table of Contents

- [Summary](#summary)
- [New Files Created](#new-files-created)
- [Files Modified](#files-modified)
- [Code Implementation Details](#code-implementation-details)
- [Transition Type Reference](#transition-type-reference)
- [Animation Frame Specifications](#animation-frame-specifications)
- [Architecture & Data Flow](#architecture--data-flow)
- [Phase Transition State Machine](#phase-transition-state-machine)
- [Logging Matrix](#logging-matrix)
- [Test Coverage](#test-coverage)
- [DI Registration](#di-registration)
- [Manual QA Checklist](#manual-qa-checklist)
- [Design Decisions](#design-decisions)
- [Verification Results](#verification-results)
- [Directory Structure](#directory-structure)
- [Next Steps](#next-steps)
- [Credits](#credits)

---

## Summary

Version 0.3.14b implements **Screen Transition Animations** for game phase changes, adding visual "juice" to the Terminal UI. The `ScreenTransitionService` uses `Spectre.Console.Live` to render frame-based ASCII effects during Exploration ↔ Combat transitions, while fully respecting `GameSettings.ReduceMotion` for accessibility compliance.

**Layers Touched:**
- **Core Layer:** New `TransitionType` enum and `IScreenTransitionService` interface
- **Terminal Layer:** `ScreenTransitionService` implementation with 3 animation effects
- **Engine Layer:** `GameService` integration for automatic phase transition detection
- **Test Layer:** 13 new unit tests covering accessibility, logging, and transition handling

**Patterns Introduced:**
- **Accessibility Guard Pattern:** All animations check `GameSettings.ReduceMotion` first and exit immediately if enabled
- **Phase Transition Detection Pattern:** Game loop tracks `_previousPhase` and triggers transitions on state change
- **Semantic Color Animation Pattern:** Transition effects use themed colors from `IThemeService`

**Key Metrics:**
- 3 new files created (enum, interface, service)
- 2 files modified (GameService, Program.cs)
- 1 test file created with 13 tests
- 3 distinct animation effects (Shatter, Dissolve, GlitchDecay)
- 500ms animation duration (skipped instantly with ReduceMotion)
- 0 regressions (411 Terminal tests passing)

---

## New Files Created

### Core Layer (2 files)

| File | Purpose |
|------|---------|
| `RuneAndRust.Core/Enums/TransitionType.cs` | Enum defining screen transition animation types |
| `RuneAndRust.Core/Interfaces/IScreenTransitionService.cs` | Service interface for playing transition animations |

### Terminal Layer (1 file)

| File | Purpose |
|------|---------|
| `RuneAndRust.Terminal/Services/ScreenTransitionService.cs` | ASCII animation service using Spectre.Console.Live |

### Test Layer (1 file)

| File | Purpose |
|------|---------|
| `RuneAndRust.Tests/Terminal/ScreenTransitionServiceTests.cs` | Unit tests for ScreenTransitionService (13 tests) |

---

## Files Modified

### Engine Layer

| File | Change |
|------|--------|
| `RuneAndRust.Engine/Services/GameService.cs` | Added `IScreenTransitionService` injection, phase transition detection, and `HandlePhaseTransitionAsync()` method |

### Terminal Layer

| File | Change |
|------|--------|
| `RuneAndRust.Terminal/Program.cs` | Registered `IScreenTransitionService` as singleton in DI container |

---

## Code Implementation Details

### TransitionType Enum

**Location:** `RuneAndRust.Core/Enums/TransitionType.cs`

**Purpose:** Defines the available screen transition animation types for phase changes.

```csharp
namespace RuneAndRust.Core.Enums;

/// <summary>
/// Defines screen transition animation types (v0.3.14b).
/// Used by IScreenTransitionService to play visual effects between game phases.
/// </summary>
public enum TransitionType
{
    /// <summary>No transition - instant screen clear.</summary>
    None = 0,

    /// <summary>Screen shatters into noise - Combat start.</summary>
    Shatter = 1,

    /// <summary>Screen fades/dissolves out - Combat victory.</summary>
    Dissolve = 2,

    /// <summary>Text decays to garbage then black - Game Over (quit after death).</summary>
    GlitchDecay = 3
}
```

---

### IScreenTransitionService Interface

**Location:** `RuneAndRust.Core/Interfaces/IScreenTransitionService.cs`

**Purpose:** Service contract for playing screen transition animations between game phases.

```csharp
using RuneAndRust.Core.Enums;

namespace RuneAndRust.Core.Interfaces;

/// <summary>
/// Service for playing screen transition animations between game phases (v0.3.14b).
/// Implements ASCII-based visual effects using Spectre.Console.Live rendering.
/// </summary>
public interface IScreenTransitionService
{
    /// <summary>
    /// Plays a transition animation. Blocks until complete.
    /// Respects GameSettings.ReduceMotion - returns immediately if enabled.
    /// </summary>
    /// <param name="type">The transition effect to play.</param>
    /// <returns>A task that completes when the transition finishes.</returns>
    Task PlayAsync(TransitionType type);
}
```

---

### ScreenTransitionService Implementation

**Location:** `RuneAndRust.Terminal/Services/ScreenTransitionService.cs`

**Purpose:** Renders ASCII transition animations using Spectre.Console.Live for frame-based rendering.

**Constructor Dependencies:**
- `ILogger<ScreenTransitionService>` - For traceability logging
- `IThemeService` - For semantic color lookup

**Constants:**

| Constant | Value | Purpose |
|----------|-------|---------|
| `FrameCount` | 10 | Number of animation frames per effect |
| `FrameDelayMs` | 50 | Milliseconds between frames (500ms total) |
| `MaxHeight` | 24 | Maximum terminal height for animations |
| `ShardChars` | `/, \, #, X, %, &, █, ▓, ▒` | Character set for Shatter effect |
| `GlitchChars` | `░, ▒, ▓, █, ▀, ▄, ▌, ▐` | Character set for GlitchDecay effect |

**Core Method:**

```csharp
public async Task PlayAsync(TransitionType type)
{
    // Accessibility guard - skip all animations when ReduceMotion is enabled
    if (GameSettings.ReduceMotion)
    {
        _logger.LogDebug("[VFX] Transition skipped (ReduceMotion: ON)");
        AnsiConsole.Clear();
        return;
    }

    if (type == TransitionType.None)
    {
        AnsiConsole.Clear();
        return;
    }

    _logger.LogTrace("[VFX] Playing transition: {Type}", type);

    switch (type)
    {
        case TransitionType.Shatter:
            await PlayShatterEffectAsync();
            break;
        case TransitionType.Dissolve:
            await PlayDissolveEffectAsync();
            break;
        case TransitionType.GlitchDecay:
            await PlayGlitchDecayEffectAsync();
            break;
        default:
            AnsiConsole.Clear();
            break;
    }

    AnsiConsole.Clear();
    _logger.LogTrace("[VFX] Transition complete");
}
```

---

### GameService Phase Transition Integration

**Location:** `RuneAndRust.Engine/Services/GameService.cs`

**New Fields:**
```csharp
private readonly IScreenTransitionService? _transitionService;
private GamePhase _previousPhase = GamePhase.MainMenu;
```

**Constructor Update:**
```csharp
public GameService(
    ILogger<GameService> logger,
    IInputHandler inputHandler,
    CommandParser parser,
    GameState state,
    ICombatService combatService,
    IServiceScopeFactory scopeFactory,
    ICombatScreenRenderer? combatRenderer = null,
    IExplorationScreenRenderer? explorationRenderer = null,
    IScreenTransitionService? transitionService = null)  // NEW v0.3.14b
{
    // ... existing assignments ...
    _transitionService = transitionService;
}
```

**Game Loop Integration (StartAsync):**
```csharp
public async Task StartAsync()
{
    _logger.LogInformation("Game Loop Initialized.");
    _previousPhase = _state.Phase;

    while (_state.Phase != GamePhase.Quit)
    {
        // Check for phase transition and play animation (v0.3.14b)
        if (_state.Phase != _previousPhase)
        {
            await HandlePhaseTransitionAsync(_previousPhase, _state.Phase);
            _previousPhase = _state.Phase;
        }

        // ... existing render and input logic ...
    }

    // Final transition before quit (v0.3.14b)
    if (_previousPhase == GamePhase.Combat)
    {
        await HandlePhaseTransitionAsync(_previousPhase, GamePhase.Quit);
    }

    _logger.LogInformation("Game Loop Ended. Shutting down.");
}
```

**Phase Transition Handler:**
```csharp
/// <summary>
/// Handles phase transitions by playing appropriate screen animations (v0.3.14b).
/// </summary>
private async Task HandlePhaseTransitionAsync(GamePhase from, GamePhase to)
{
    if (_transitionService == null)
    {
        return;
    }

    var transitionType = (from, to) switch
    {
        (GamePhase.Exploration, GamePhase.Combat) => TransitionType.Shatter,
        (GamePhase.Combat, GamePhase.Exploration) => TransitionType.Dissolve,
        (GamePhase.Combat, GamePhase.Quit) => TransitionType.GlitchDecay,
        _ => TransitionType.None
    };

    _logger.LogDebug("[Game] Phase transition: {From} -> {To}, Effect: {Effect}",
        from, to, transitionType);

    await _transitionService.PlayAsync(transitionType);
}
```

---

## Transition Type Reference

### TransitionType Values (4 values)

| Value | Int | Trigger | Effect | Theme Color |
|-------|-----|---------|--------|-------------|
| `None` | 0 | Default/Other transitions | Instant screen clear | N/A |
| `Shatter` | 1 | Exploration → Combat | Red noise fills screen | `EnemyColor` |
| `Dissolve` | 2 | Combat → Exploration (Victory) | Green dots fade out | `SuccessColor` |
| `GlitchDecay` | 3 | Combat → Quit (Death) | Text decays to garbage then black | `StressHigh` |

### Phase Transition Matrix

| From Phase | To Phase | Transition | Tone |
|------------|----------|------------|------|
| Exploration | Combat | Shatter | Aggressive (red noise) |
| Combat | Exploration | Dissolve | Calming (green fade) |
| Combat | Quit | GlitchDecay | Ominous (garbage then black) |
| MainMenu | Exploration | None | Instant |
| MainMenu | Quit | None | Instant |
| Any Other | Any Other | None | Instant |

---

## Animation Frame Specifications

### Shatter Effect (Combat Start)

**Purpose:** Dramatic entry into combat with aggressive visual tone.

**Algorithm:**
1. Density scales 10% → 100% over 10 frames
2. Random character selection from `ShardChars` per cell
3. Themed color from `EnemyColor` semantic key
4. 50ms frame delay = 500ms total duration

**Frame Progression:**
```
Frame 1:  10% density - sparse noise
Frame 2:  20% density
Frame 3:  30% density
...
Frame 10: 100% density - full screen noise
```

**Character Set:**
```
ShardChars = { '/', '\\', '#', 'X', '%', '&', '█', '▓', '▒' }
```

---

### Dissolve Effect (Combat Victory)

**Purpose:** Calming exit from combat after victory.

**Algorithm:**
1. Density scales 100% → 0% over 10 frames (reverse of Shatter)
2. Uses dot character (`·`) for softer visual
3. Themed color from `SuccessColor` semantic key
4. 50ms frame delay = 500ms total duration

**Frame Progression:**
```
Frame 1:  100% density - full screen dots
Frame 2:   90% density
Frame 3:   80% density
...
Frame 10:  10% density - mostly clear
```

---

### GlitchDecay Effect (Game Over)

**Purpose:** Ominous death screen transition when quitting after death.

**Algorithm:**
1. Frames 1-7: 60% density glitch characters in stress color
2. Frames 8-10: Fade to black (increasing empty space)
3. Themed color from `StressHigh` semantic key
4. 70ms frame delay (slightly slower for dramatic effect) = 700ms total

**Character Set:**
```
GlitchChars = { '░', '▒', '▓', '█', '▀', '▄', '▌', '▐' }
```

**Frame Progression:**
```
Frames 1-7:  Glitch characters at 60% density
Frame 8:     40% empty space overlay
Frame 9:     80% empty space overlay
Frame 10:   120% empty space overlay (full black)
```

---

## Architecture & Data Flow

### Service Injection Pipeline

```
+------------------------------------------------------------------------------+
|                      SCREEN TRANSITION SERVICE PIPELINE                       |
+------------------------------------------------------------------------------+

 DI Container              GameService              ScreenTransitionService
 ------------              -----------              -----------------------

 IScreenTransitionService  _transitionService       PlayAsync(type)
 (Singleton)               |                         |
        |                  | Phase change detected   | 1. Check ReduceMotion
        +----------------->|                         |    - If ON: Clear & return
                           | HandlePhaseTransition   |
                           | Async(from, to)         | 2. Log start
                           |                         |
                           | Determine transition    | 3. Switch on type
                           | type from (from, to)    |    - Shatter
                           |                         |    - Dissolve
                           +------------------------>|    - GlitchDecay
                                                     |
                                                     | 4. AnsiConsole.Live()
                                                     |    - 10 frames
                                                     |    - 50-70ms delay
                                                     |
                                                     | 5. Clear & log complete
```

### Animation Rendering Pipeline

```
+------------------------------------------------------------------------------+
|                       ANIMATION RENDERING PIPELINE                            |
+------------------------------------------------------------------------------+

 ScreenTransitionService      AnsiConsole.Live        Terminal
 -----------------------      ---------------         --------

 PlayShatterEffectAsync()
        |
        | _theme.GetColor("EnemyColor")  -->  "red" (or themed variant)
        |
        | AnsiConsole.Live(new Text(""))
        |     .AutoClear(false)
        |     .StartAsync(async ctx => { ... })
        |
        +--------->  Frame Loop (1 to FrameCount)
                           |
                           | Build StringBuilder with:
                           |   - width × height grid
                           |   - Random characters at density %
                           |   - Markup: [$color]char[/]
                           |
                           | ctx.UpdateTarget(new Markup(sb.ToString()))
                           |
                           | await Task.Delay(FrameDelayMs)
                           |
                           +------------------------------------>  Display
```

---

## Phase Transition State Machine

```
+------------------------------------------------------------------------------+
|                        GAME PHASE STATE MACHINE                               |
+------------------------------------------------------------------------------+

                    +-------------+
                    |  MainMenu   |
                    +------+------+
                           |
                           | (No transition)
                           v
                    +-------------+
              +---->| Exploration |<----+
              |     +------+------+     |
              |            |            |
              |            | SHATTER    | DISSOLVE
              |            | (red noise)| (green fade)
              |            v            |
              |     +-------------+     |
              +-----+   Combat    +-----+
                    +------+------+
                           |
                           | GLITCH_DECAY
                           | (on quit after death)
                           v
                    +-------------+
                    |    Quit     |
                    +-------------+
```

---

## Logging Matrix

### ScreenTransitionService

| Event | Level | Template | Properties |
|-------|-------|----------|------------|
| Skip (ReduceMotion) | Debug | `"[VFX] Transition skipped (ReduceMotion: ON)"` | - |
| Start | Trace | `"[VFX] Playing transition: {Type}"` | Type |
| Shatter Frame | Trace | `"[VFX] Shatter frame {Frame}/{Total}"` | Frame, Total |
| Dissolve Frame | Trace | `"[VFX] Dissolve frame {Frame}/{Total}"` | Frame, Total |
| GlitchDecay Frame | Trace | `"[VFX] GlitchDecay frame {Frame}/{Total}"` | Frame, Total |
| Complete | Trace | `"[VFX] Transition complete"` | - |

### GameService

| Event | Level | Template | Properties |
|-------|-------|----------|------------|
| Phase Transition | Debug | `"[Game] Phase transition: {From} -> {To}, Effect: {Effect}"` | From, To, Effect |

---

## Test Coverage

### ScreenTransitionServiceTests (13 tests)

**ReduceMotion Tests (3 tests):**

| Test | Description |
|------|-------------|
| `PlayAsync_SkipsAnimation_WhenReduceMotionEnabled` | Shatter completes in <100ms with ReduceMotion=true |
| `PlayAsync_SkipsAnimation_WhenReduceMotionEnabled_Dissolve` | Dissolve completes in <100ms with ReduceMotion=true |
| `PlayAsync_SkipsAnimation_WhenReduceMotionEnabled_GlitchDecay` | GlitchDecay completes in <100ms with ReduceMotion=true |

**TransitionType Handling Tests (5 tests):**

| Test | Description |
|------|-------------|
| `PlayAsync_HandlesAllTransitionTypes_WithReduceMotion(None)` | Theory: None type completes without exception |
| `PlayAsync_HandlesAllTransitionTypes_WithReduceMotion(Shatter)` | Theory: Shatter type completes without exception |
| `PlayAsync_HandlesAllTransitionTypes_WithReduceMotion(Dissolve)` | Theory: Dissolve type completes without exception |
| `PlayAsync_HandlesAllTransitionTypes_WithReduceMotion(GlitchDecay)` | Theory: GlitchDecay type completes without exception |
| `PlayAsync_WithNone_CompletesInstantly` | None type completes in <100ms |

**Theme Integration Tests (4 tests):**

| Test | Description |
|------|-------------|
| `Constructor_InjectsThemeService` | Service accepts IThemeService dependency |
| `ThemeService_IsConfiguredForTransitionColors(Shatter, EnemyColor)` | Theory: Shatter uses EnemyColor key |
| `ThemeService_IsConfiguredForTransitionColors(Dissolve, SuccessColor)` | Theory: Dissolve uses SuccessColor key |
| `ThemeService_IsConfiguredForTransitionColors(GlitchDecay, StressHigh)` | Theory: GlitchDecay uses StressHigh key |

**Logging Tests (1 test):**

| Test | Description |
|------|-------------|
| `PlayAsync_LogsDebug_WhenReduceMotionSkips` | Debug log emitted when ReduceMotion skips animation |

---

## DI Registration

**Location:** `RuneAndRust.Terminal/Program.cs` (line ~162)

```csharp
// Visual Effects & Theme Services
services.AddSingleton<IVisualEffectService, VisualEffectService>();
services.AddSingleton<IThemeService, ThemeService>();
services.AddSingleton<IScreenTransitionService, ScreenTransitionService>(); // NEW v0.3.14b
```

**Singleton Justification:** Screen transitions are stateless and can share a single instance across the application lifetime.

---

## Manual QA Checklist

### Animation Playback

- [ ] **Shatter Effect:** Enter combat from exploration → Red/themed noise fills screen over 500ms
- [ ] **Dissolve Effect:** Win combat → Green dots fade out over 500ms
- [ ] **GlitchDecay Effect:** Quit after death in combat → Garbage text fades to black over 700ms
- [ ] **None Transition:** Menu navigation → Instant screen clear, no animation

### Accessibility Compliance

- [ ] **ReduceMotion ON:** Enable `GameSettings.ReduceMotion` → All transitions complete instantly
- [ ] **ReduceMotion Logging:** Check debug log shows `"[VFX] Transition skipped (ReduceMotion: ON)"`

### Theme Integration

- [ ] **Standard Theme:** Shatter=red, Dissolve=green, GlitchDecay=magenta
- [ ] **HighContrast Theme:** Colors update to high visibility variants
- [ ] **Protanopia Theme:** Shatter=orange, Dissolve=blue, GlitchDecay adjusted
- [ ] **Deuteranopia Theme:** Same as Protanopia
- [ ] **Tritanopia Theme:** Colors adjusted for blue-yellow blindness

### Performance

- [ ] **Full-screen terminal:** No visible lag during animation
- [ ] **Terminal resize during animation:** Graceful handling (no crash)
- [ ] **Animation duration:** Approximately 500-700ms per transition

---

## Design Decisions

### Why Optional IScreenTransitionService Injection?

**Problem:** Adding a required constructor parameter to GameService would break existing tests and integrations.

**Analysis:**
- GameService is instantiated in many test files
- Not all test scenarios need transition animations
- Breaking change would require updating all GameService tests

**Decision:** Make `transitionService` an optional parameter with `= null` default. The `HandlePhaseTransitionAsync` method checks for null and returns early if not injected.

### Why Track _previousPhase in Game Loop?

**Problem:** Phase changes happen via direct `state.Phase` assignment in CommandParser, not through a dedicated method.

**Analysis:**
- Modifying all phase assignment points would be invasive
- Phase changes are scattered across multiple command handlers
- Need a non-invasive way to detect transitions

**Decision:** Track `_previousPhase` at the top of the game loop and compare against `_state.Phase` each iteration. This detects any phase change regardless of how it was triggered.

### Why GlitchDecay on Quit After Death (Not Immediate Death)?

**Problem:** Should the death transition play when HP reaches 0, or when the player confirms quit?

**User Input:** User specified "On Quit After Death" during plan approval.

**Rationale:**
- Immediate HP=0 may not mean game over (revival mechanics, multiple lives)
- Player should see their death state before the dramatic fade
- Quit confirmation is the definitive "game over" moment
- Matches the phase transition: `Combat → Quit`

**Decision:** GlitchDecay triggers on `(Combat, Quit)` transition, which occurs when player explicitly quits from a death screen.

### Why 100ms Threshold in Timing Tests?

**Problem:** Original plan specified 50ms threshold, but test environment variability causes failures.

**Analysis:**
- Test runners add overhead
- CI environments may have scheduling delays
- 50ms was too tight for reliable green tests

**Decision:** Use 100ms threshold with documented justification. The key assertion is "nearly instant" (vs 500ms+ for actual animation), not an exact timing guarantee.

### Why Not Test Actual Animation Rendering?

**Problem:** Unit tests fail when running animations because `Console.WindowWidth` returns 0 in test environments.

**Analysis:**
- No real terminal attached during test execution
- Spectre.Console.Live fails with "Sequence contains no elements"
- Animation rendering is inherently a visual/integration concern

**Decision:** Unit tests focus on:
- Accessibility guard (ReduceMotion skipping)
- Exception-free handling of all transition types
- Theme service configuration
- Logging behavior

Actual animation rendering is validated through manual QA testing.

---

## Verification Results

### Build Output

```
Build succeeded.
    0 Warning(s)
    0 Error(s)
```

### Test Results

```
dotnet test --filter "FullyQualifiedName~ScreenTransitionService"

Passed!  - Failed: 0, Passed: 13, Skipped: 0, Total: 13, Duration: 56ms
```

**Terminal Tests (Full Suite):**
```
dotnet test --filter "FullyQualifiedName~Terminal"

Passed!  - Failed: 0, Passed: 411, Skipped: 0, Total: 411, Duration: 2s
```

---

## Directory Structure

```
RuneAndRust.Core/
+-- Enums/
|   +-- TransitionType.cs                  [NEW - v0.3.14b]
+-- Interfaces/
    +-- IScreenTransitionService.cs        [NEW - v0.3.14b]

RuneAndRust.Terminal/
+-- Services/
    +-- ScreenTransitionService.cs         [NEW - v0.3.14b]

RuneAndRust.Engine/
+-- Services/
    +-- GameService.cs                     [MODIFIED - v0.3.14b: transition integration]

RuneAndRust.Terminal/
+-- Program.cs                             [MODIFIED - v0.3.14b: DI registration]

RuneAndRust.Tests/
+-- Terminal/
    +-- ScreenTransitionServiceTests.cs    [NEW - v0.3.14b: 13 tests]
```

---

## Next Steps

- **v0.3.14c (The Polish):** Mark legacy non-themed methods as `[Obsolete]` with migration guidance
- **Future:** Additional transition effects (SlideIn, Wipe, Curtain)
- **Future:** Configurable animation speed multiplier
- **Future:** Sound effect hooks for transitions (when audio system implemented)
- **Future:** Transition preview in Options menu

---

## Credits

**Primary Developer:** The Architect (Claude)
**Test Coverage:** 13 new tests, 411 total Terminal tests passing
**Regression:** Zero regressions
**User Clarification:** GlitchDecay trigger timing (On Quit After Death)
**Documentation:** Follows CHANGELOG_GENERATION_RULES.md Extended Template
