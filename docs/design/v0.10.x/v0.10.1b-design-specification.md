# v0.10.1b Design Specification: Combat Stances

**Version:** 0.10.1b
**Parent:** v0.10.1 (Combat Actions)
**Prerequisites:** v0.10.1a Complete (Defense Actions)
**Status:** Design Complete
**Estimated Unit Tests:** ~12

---

## 1. Overview

### Purpose

Implement combat stances that modify a combatant's stats and behavior. Players can switch between aggressive (offense focus), defensive (survival focus), and balanced (default) stances during combat. Stances apply stat modifiers while active and can be switched once per round as a free action.

### Key Deliverables

| Category | Items |
|----------|-------|
| **Domain Entities** | `StanceDefinition` |
| **Domain Enums** | `CombatStance` |
| **Interfaces** | `IStanceService`, `IStanceProvider` |
| **Services** | `StanceService`, `StanceProvider` |
| **Entity Updates** | `CurrentStance` on `ICombatant` |
| **Events** | `StanceChangedEvent` |
| **Configuration** | `stances.json` |
| **Tests** | ~12 unit tests |

---

## 2. Feature Overview

```
v0.10.1b Features
â”œâ”€â”€ CombatStance Enum
â”‚   â”œâ”€â”€ Balanced (default)
â”‚   â”œâ”€â”€ Aggressive
â”‚   â””â”€â”€ Defensive
â”‚
â”œâ”€â”€ StanceDefinition Entity
â”‚   â”œâ”€â”€ StanceId
â”‚   â”œâ”€â”€ Name, Description
â”‚   â”œâ”€â”€ AttackBonus, DamageBonus
â”‚   â”œâ”€â”€ DefenseBonus, SaveBonus
â”‚   â”œâ”€â”€ IsDefault
â”‚   â””â”€â”€ IconPath
â”‚
â”œâ”€â”€ IStanceService Interface
â”‚   â”œâ”€â”€ GetCurrentStance(combatant)
â”‚   â”œâ”€â”€ GetStanceDefinition(combatant)
â”‚   â”œâ”€â”€ SetStance(combatant, stance)
â”‚   â”œâ”€â”€ CanChangeStance(combatant)
â”‚   â”œâ”€â”€ GetAttackBonus(combatant)
â”‚   â”œâ”€â”€ GetDamageBonus(combatant)
â”‚   â”œâ”€â”€ GetDefenseBonus(combatant)
â”‚   â”œâ”€â”€ GetSaveBonus(combatant)
â”‚   â”œâ”€â”€ ResetStanceChange(combatant)
â”‚   â””â”€â”€ GetAvailableStances()
â”‚
â”œâ”€â”€ StanceService Implementation
â”‚   â”œâ”€â”€ Apply/Remove stance modifiers
â”‚   â”œâ”€â”€ Track stance changes per round
â”‚   â””â”€â”€ Publish StanceChangedEvent
â”‚
â”œâ”€â”€ Stance Definitions
â”‚   â”œâ”€â”€ Aggressive: +2 ATK, +1d4 DMG, -2 DEF, -1 saves
â”‚   â”œâ”€â”€ Balanced: No modifiers (default)
â”‚   â””â”€â”€ Defensive: -2 ATK, -1d4 DMG, +2 DEF, +2 saves
â”‚
â””â”€â”€ Configuration (stances.json)
    â”œâ”€â”€ Aggressive definition
    â”œâ”€â”€ Balanced definition
    â””â”€â”€ Defensive definition
```

---

## 3. Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    COMBAT STANCE ARCHITECTURE                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

                      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                      â”‚      Player / AI           â”‚
                      â”‚   (Combat decisions)       â”‚
                      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                      â”‚ SetStance
                                      â–¼
                      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                      â”‚      IStanceService        â”‚
                      â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
                      â”‚ + GetCurrentStance()      â”‚
                      â”‚ + SetStance(stance)       â”‚
                      â”‚ + CanChangeStance()       â”‚
                      â”‚ + GetStanceModifiers()    â”‚
                      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                      â”‚
                      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                      â”‚       StanceService        â”‚
                      â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
                      â”‚ - ApplyStanceModifiers    â”‚
                      â”‚ - RemoveStanceModifiers   â”‚
                      â”‚ - TrackStanceChange       â”‚
                      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


    AGGRESSIVE               BALANCED                 DEFENSIVE
    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€               â”€â”€â”€â”€â”€â”€â”€â”€                 â”€â”€â”€â”€â”€â”€â”€â”€â”€
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚    âš”âš”     â”‚           â”‚    âš”ğŸ›¡    â”‚           â”‚    ğŸ›¡ğŸ›¡    â”‚
    â”‚ AGGRESSIVEâ”‚           â”‚  BALANCED â”‚           â”‚ DEFENSIVE â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    
    Modifiers:               Modifiers:               Modifiers:
    +2 Attack                No modifiers             -2 Attack
    +1d4 Damage              (Default stance)         +2 Defense
    -2 Defense                                        +2 All saves
    -1 to saves                                       -1d4 Damage
    
    Best for:                Best for:                Best for:
    Finishing enemies        General combat           Survival
    Glass cannons            Balanced play            Tank builds
```

---

## 4. CombatStance Enum

**File:** `src/Core/RuneAndRust.Domain/Enums/CombatStance.cs`

```csharp
namespace RuneAndRust.Domain.Enums;

/// <summary>
/// Combat stance options that modify stats and behavior.
/// </summary>
public enum CombatStance
{
    /// <summary>Default stance with no modifiers.</summary>
    Balanced,

    /// <summary>Offensive stance with attack bonus but defense penalty.</summary>
    Aggressive,

    /// <summary>Defensive stance with defense bonus but attack penalty.</summary>
    Defensive
}
```

---

## 5. StanceDefinition Entity

**File:** `src/Core/RuneAndRust.Domain/Definitions/StanceDefinition.cs`

```csharp
namespace RuneAndRust.Domain.Definitions;

/// <summary>
/// Defines a combat stance with its modifiers.
/// </summary>
public class StanceDefinition : IEntity
{
    public Guid Id { get; private set; }

    /// <summary>Unique identifier for the stance.</summary>
    public string StanceId { get; private set; } = null!;

    /// <summary>Display name.</summary>
    public string Name { get; private set; } = null!;

    /// <summary>Description of the stance.</summary>
    public string Description { get; private set; } = null!;

    /// <summary>Whether this is the default stance.</summary>
    public bool IsDefault { get; private set; }

    /// <summary>Bonus/penalty to attack rolls.</summary>
    public int AttackBonus { get; private set; }

    /// <summary>Dice notation for damage bonus (e.g., "1d4" or "-1d4").</summary>
    public string? DamageBonus { get; private set; }

    /// <summary>Bonus/penalty to defense.</summary>
    public int DefenseBonus { get; private set; }

    /// <summary>Bonus/penalty to all saving throws.</summary>
    public int SaveBonus { get; private set; }

    /// <summary>Path to the stance icon.</summary>
    public string? IconPath { get; private set; }

    // EF Core constructor
    private StanceDefinition() { }

    public static StanceDefinition Create(
        string stanceId,
        string name,
        string description,
        int attackBonus = 0,
        string? damageBonus = null,
        int defenseBonus = 0,
        int saveBonus = 0,
        bool isDefault = false,
        string? iconPath = null)
    {
        ArgumentException.ThrowIfNullOrWhiteSpace(stanceId);
        ArgumentException.ThrowIfNullOrWhiteSpace(name);

        return new StanceDefinition
        {
            Id = Guid.NewGuid(),
            StanceId = stanceId.ToLowerInvariant(),
            Name = name,
            Description = description,
            AttackBonus = attackBonus,
            DamageBonus = damageBonus,
            DefenseBonus = defenseBonus,
            SaveBonus = saveBonus,
            IsDefault = isDefault,
            IconPath = iconPath
        };
    }

    /// <summary>Gets the corresponding CombatStance enum value.</summary>
    public CombatStance ToCombatStance()
    {
        return StanceId switch
        {
            "aggressive" => CombatStance.Aggressive,
            "defensive" => CombatStance.Defensive,
            _ => CombatStance.Balanced
        };
    }

    public override string ToString() => $"{Name} ({StanceId})";
}
```

---

## 6. StanceChangeResult Record

**File:** `src/Core/RuneAndRust.Application/DTOs/StanceChangeResult.cs`

```csharp
namespace RuneAndRust.Application.DTOs;

/// <summary>
/// Result of attempting to change combat stance.
/// </summary>
public record StanceChangeResult
{
    public bool IsSuccess { get; init; }
    public CombatStance? OldStance { get; init; }
    public CombatStance? NewStance { get; init; }
    public string? FailureReason { get; init; }

    public static StanceChangeResult Success(CombatStance oldStance, CombatStance newStance)
        => new() { IsSuccess = true, OldStance = oldStance, NewStance = newStance };

    public static StanceChangeResult AlreadyInStance(CombatStance stance)
        => new() { IsSuccess = true, OldStance = stance, NewStance = stance, FailureReason = "Already in this stance" };

    public static StanceChangeResult Failed(string reason)
        => new() { IsSuccess = false, FailureReason = reason };
}
```

---

## 7. ICombatant Stance Extensions

**Updates to:** `src/Core/RuneAndRust.Domain/Interfaces/ICombatant.cs`

```csharp
namespace RuneAndRust.Domain.Interfaces;

public interface ICombatant
{
    // ... existing members ...

    /// <summary>Gets the current combat stance.</summary>
    CombatStance CurrentStance { get; }

    /// <summary>Sets the combat stance.</summary>
    void SetStance(CombatStance stance);
}
```

---

## 8. IStanceProvider Interface

**File:** `src/Core/RuneAndRust.Application/Interfaces/IStanceProvider.cs`

```csharp
namespace RuneAndRust.Application.Interfaces;

/// <summary>
/// Provides access to stance definitions.
/// </summary>
public interface IStanceProvider
{
    /// <summary>Gets a stance definition by enum value.</summary>
    StanceDefinition? GetStance(CombatStance stance);

    /// <summary>Gets a stance definition by ID.</summary>
    StanceDefinition? GetStance(string stanceId);

    /// <summary>Gets the default stance definition.</summary>
    StanceDefinition GetDefaultStance();

    /// <summary>Gets all available stance definitions.</summary>
    IReadOnlyList<StanceDefinition> GetAllStances();
}
```

---

## 9. IStanceService Interface

**File:** `src/Core/RuneAndRust.Application/Interfaces/IStanceService.cs`

```csharp
namespace RuneAndRust.Application.Interfaces;

/// <summary>
/// Service for managing combat stances.
/// </summary>
public interface IStanceService
{
    /// <summary>Gets the current stance of a combatant.</summary>
    CombatStance GetCurrentStance(ICombatant combatant);

    /// <summary>Gets the stance definition for a combatant.</summary>
    StanceDefinition? GetStanceDefinition(ICombatant combatant);

    /// <summary>Sets a new combat stance.</summary>
    /// <param name="combatant">The combatant changing stance.</param>
    /// <param name="stance">The new stance.</param>
    /// <returns>Result of the stance change.</returns>
    StanceChangeResult SetStance(ICombatant combatant, CombatStance stance);

    /// <summary>Checks if combatant can change stance this round.</summary>
    bool CanChangeStance(ICombatant combatant);

    /// <summary>Gets attack bonus from current stance.</summary>
    int GetAttackBonus(ICombatant combatant);

    /// <summary>Gets damage bonus from current stance (dice notation).</summary>
    string? GetDamageBonus(ICombatant combatant);

    /// <summary>Gets defense bonus from current stance.</summary>
    int GetDefenseBonus(ICombatant combatant);

    /// <summary>Gets save bonus from current stance.</summary>
    int GetSaveBonus(ICombatant combatant);

    /// <summary>Resets stance change availability at round start.</summary>
    void ResetStanceChange(ICombatant combatant);

    /// <summary>Gets all available stances.</summary>
    IReadOnlyList<StanceDefinition> GetAvailableStances();

    /// <summary>Initializes a combatant with the default stance.</summary>
    void InitializeStance(ICombatant combatant);
}
```

---

## 10. StanceService Implementation

**File:** `src/Core/RuneAndRust.Application/Services/StanceService.cs`

```csharp
namespace RuneAndRust.Application.Services;

public class StanceService : IStanceService
{
    private readonly IStanceProvider _stanceProvider;
    private readonly IStatModifierService _statService;
    private readonly IEventBus _eventBus;
    private readonly ILogger<StanceService> _logger;

    // Track which combatants have changed stance this round
    private readonly HashSet<Guid> _stanceChangedThisRound = new();

    public StanceService(
        IStanceProvider stanceProvider,
        IStatModifierService statService,
        IEventBus eventBus,
        ILogger<StanceService> logger)
    {
        _stanceProvider = stanceProvider;
        _statService = statService;
        _eventBus = eventBus;
        _logger = logger;
    }

    public CombatStance GetCurrentStance(ICombatant combatant)
    {
        return combatant.CurrentStance;
    }

    public StanceDefinition? GetStanceDefinition(ICombatant combatant)
    {
        return _stanceProvider.GetStance(combatant.CurrentStance);
    }

    public StanceChangeResult SetStance(ICombatant combatant, CombatStance stance)
    {
        if (!CanChangeStance(combatant))
        {
            _logger.LogWarning("{Combatant} already changed stance this round", combatant.Name);
            return StanceChangeResult.Failed("Already changed stance this round");
        }

        if (combatant.CurrentStance == stance)
        {
            _logger.LogDebug("{Combatant} already in {Stance} stance", combatant.Name, stance);
            return StanceChangeResult.AlreadyInStance(stance);
        }

        var oldStance = combatant.CurrentStance;
        var oldDef = _stanceProvider.GetStance(oldStance);
        var newDef = _stanceProvider.GetStance(stance);

        if (newDef is null)
        {
            _logger.LogError("Unknown stance: {Stance}", stance);
            return StanceChangeResult.Failed($"Unknown stance: {stance}");
        }

        // Remove old stance modifiers
        if (oldDef is not null)
        {
            RemoveStanceModifiers(combatant, oldDef);
        }

        // Set new stance
        combatant.SetStance(stance);
        _stanceChangedThisRound.Add(combatant.Id);

        // Apply new stance modifiers
        ApplyStanceModifiers(combatant, newDef);

        _logger.LogInformation("{Combatant} changed stance from {Old} to {New}",
            combatant.Name, oldStance, stance);

        _eventBus.Publish(new StanceChangedEvent(combatant.Id, oldStance, stance));

        return StanceChangeResult.Success(oldStance, stance);
    }

    public bool CanChangeStance(ICombatant combatant)
    {
        return !_stanceChangedThisRound.Contains(combatant.Id);
    }

    public int GetAttackBonus(ICombatant combatant)
    {
        var stance = _stanceProvider.GetStance(combatant.CurrentStance);
        return stance?.AttackBonus ?? 0;
    }

    public string? GetDamageBonus(ICombatant combatant)
    {
        var stance = _stanceProvider.GetStance(combatant.CurrentStance);
        return stance?.DamageBonus;
    }

    public int GetDefenseBonus(ICombatant combatant)
    {
        var stance = _stanceProvider.GetStance(combatant.CurrentStance);
        return stance?.DefenseBonus ?? 0;
    }

    public int GetSaveBonus(ICombatant combatant)
    {
        var stance = _stanceProvider.GetStance(combatant.CurrentStance);
        return stance?.SaveBonus ?? 0;
    }

    public void ResetStanceChange(ICombatant combatant)
    {
        _stanceChangedThisRound.Remove(combatant.Id);
        _logger.LogDebug("{Combatant} stance change reset", combatant.Name);
    }

    public IReadOnlyList<StanceDefinition> GetAvailableStances()
    {
        return _stanceProvider.GetAllStances();
    }

    public void InitializeStance(ICombatant combatant)
    {
        var defaultStance = _stanceProvider.GetDefaultStance();
        combatant.SetStance(defaultStance.ToCombatStance());
        _logger.LogDebug("{Combatant} initialized with {Stance} stance", combatant.Name, defaultStance.Name);
    }

    private void ApplyStanceModifiers(ICombatant combatant, StanceDefinition stance)
    {
        var source = $"stance:{stance.StanceId}";

        if (stance.AttackBonus != 0)
        {
            _statService.ApplyModifier(combatant, "attack", ModifierOperation.Add, stance.AttackBonus, source);
            _logger.LogDebug("Applied {Bonus} attack from {Stance}", stance.AttackBonus, stance.Name);
        }

        if (stance.DefenseBonus != 0)
        {
            _statService.ApplyModifier(combatant, "defense", ModifierOperation.Add, stance.DefenseBonus, source);
            _logger.LogDebug("Applied {Bonus} defense from {Stance}", stance.DefenseBonus, stance.Name);
        }

        if (stance.SaveBonus != 0)
        {
            _statService.ApplyModifier(combatant, "fortitudeSave", ModifierOperation.Add, stance.SaveBonus, source);
            _statService.ApplyModifier(combatant, "reflexSave", ModifierOperation.Add, stance.SaveBonus, source);
            _statService.ApplyModifier(combatant, "willSave", ModifierOperation.Add, stance.SaveBonus, source);
            _logger.LogDebug("Applied {Bonus} to all saves from {Stance}", stance.SaveBonus, stance.Name);
        }
    }

    private void RemoveStanceModifiers(ICombatant combatant, StanceDefinition stance)
    {
        var source = $"stance:{stance.StanceId}";
        _statService.RemoveModifiersBySource(combatant, source);
        _logger.LogDebug("Removed modifiers from {Stance}", stance.Name);
    }
}
```

---

## 11. StanceProvider Implementation

**File:** `src/Core/RuneAndRust.Infrastructure/Providers/StanceProvider.cs`

```csharp
namespace RuneAndRust.Infrastructure.Providers;

public class StanceProvider : IStanceProvider
{
    private readonly Dictionary<string, StanceDefinition> _stances;
    private readonly ILogger<StanceProvider> _logger;

    public StanceProvider(IConfigurationProvider configProvider, ILogger<StanceProvider> logger)
    {
        _logger = logger;
        _stances = LoadStances(configProvider);
    }

    private Dictionary<string, StanceDefinition> LoadStances(IConfigurationProvider configProvider)
    {
        var stances = new Dictionary<string, StanceDefinition>(StringComparer.OrdinalIgnoreCase);
        var config = configProvider.GetSection<StancesConfig>("stances.json");

        foreach (var stanceData in config.Stances)
        {
            var stance = StanceDefinition.Create(
                stanceData.Id,
                stanceData.Name,
                stanceData.Description,
                stanceData.AttackBonus,
                stanceData.DamageBonus,
                stanceData.DefenseBonus,
                stanceData.SaveBonus,
                stanceData.IsDefault,
                stanceData.Icon
            );

            stances[stance.StanceId] = stance;
            _logger.LogDebug("Loaded stance: {Stance}", stance.Name);
        }

        _logger.LogInformation("Loaded {Count} stance definitions", stances.Count);
        return stances;
    }

    public StanceDefinition? GetStance(CombatStance stance)
    {
        var stanceId = stance.ToString().ToLowerInvariant();
        return _stances.GetValueOrDefault(stanceId);
    }

    public StanceDefinition? GetStance(string stanceId)
    {
        return _stances.GetValueOrDefault(stanceId.ToLowerInvariant());
    }

    public StanceDefinition GetDefaultStance()
    {
        return _stances.Values.FirstOrDefault(s => s.IsDefault)
            ?? _stances.GetValueOrDefault("balanced")
            ?? throw new InvalidOperationException("No default stance configured");
    }

    public IReadOnlyList<StanceDefinition> GetAllStances()
    {
        return _stances.Values.ToList();
    }
}
```

---

## 12. Stance Events

**File:** `src/Core/RuneAndRust.Application/Events/StanceEvents.cs`

```csharp
namespace RuneAndRust.Application.Events;

/// <summary>Published when a combatant changes stance.</summary>
public record StanceChangedEvent(
    Guid CombatantId,
    CombatStance OldStance,
    CombatStance NewStance);

/// <summary>Published when stance change is reset for a new round.</summary>
public record StanceResetEvent(Guid CombatantId);
```

---

## 13. Configuration File

**File:** `config/stances.json`

```json
{
  "$schema": "./schemas/stances.schema.json",
  "stances": [
    {
      "id": "balanced",
      "name": "Balanced Stance",
      "description": "Default combat stance with no modifiers. A well-rounded approach suitable for most combat situations.",
      "attackBonus": 0,
      "damageBonus": null,
      "defenseBonus": 0,
      "saveBonus": 0,
      "isDefault": true,
      "icon": "icons/stances/balanced.png"
    },
    {
      "id": "aggressive",
      "name": "Aggressive Stance",
      "description": "Focus on offense at the cost of defense. Deal more damage but take more in return.",
      "attackBonus": 2,
      "damageBonus": "1d4",
      "defenseBonus": -2,
      "saveBonus": -1,
      "isDefault": false,
      "icon": "icons/stances/aggressive.png"
    },
    {
      "id": "defensive",
      "name": "Defensive Stance",
      "description": "Focus on survival at the cost of offense. Take less damage but deal less as well.",
      "attackBonus": -2,
      "damageBonus": "-1d4",
      "defenseBonus": 2,
      "saveBonus": 2,
      "isDefault": false,
      "icon": "icons/stances/defensive.png"
    }
  ]
}
```

---

## 14. Combat Integration

### Attack Service Integration

```csharp
// In AttackService.MakeAttack():
public AttackResult MakeAttack(ICombatant attacker, ICombatant defender)
{
    // Get stance bonuses
    var stanceAttackBonus = _stanceService.GetAttackBonus(attacker);
    var stanceDamageBonus = _stanceService.GetDamageBonus(attacker);

    // Apply to attack roll
    var attackRoll = _diceService.Roll("1d20") + attacker.GetModifier("attack") + stanceAttackBonus;

    // If hit, apply damage with stance bonus
    if (attackRoll >= defender.ArmorClass)
    {
        var baseDamage = _diceService.Roll(weapon.DamageRoll);

        // Add stance damage bonus (can be negative)
        if (!string.IsNullOrEmpty(stanceDamageBonus))
        {
            var bonusDamage = _diceService.Roll(stanceDamageBonus);
            baseDamage += bonusDamage;
        }

        // Ensure minimum 1 damage
        baseDamage = Math.Max(1, baseDamage);

        // Apply damage
        _damageService.ApplyDamage(defender, baseDamage);
    }
}
```

### Turn Handler Integration

```csharp
// In TurnHandler.OnRoundStart():
public void OnRoundStart(RoundStartedEvent e)
{
    foreach (var combatant in e.Combatants)
    {
        // Reset stance change tracking
        _stanceService.ResetStanceChange(combatant);

        // Reset reactions (from v0.10.1a)
        _defenseActionService.ResetReaction(combatant);
    }
}
```

---

## 15. Stance Flow Visualization

```
STANCE CHANGE FLOW:
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  Player chooses: "Change to Aggressive Stance"
              â”‚
              â–¼
  CanChangeStance(combatant)? â”€â”€â”€â”€â”€â”€â”€â”€â–¶ Check _stanceChangedThisRound
              â”‚                                   â”‚
              â–¼                                   â–¼
      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
      â”‚ Not changed   â”‚              â”‚ Already changed       â”‚
      â”‚ this round    â”‚              â”‚ this round            â”‚
      â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚                                  â”‚
              â–¼                                  â–¼
      Already in stance? â”€â”€â–¶ No          StanceChangeResult.Failed
              â”‚       â”€â”€â–¶ Yes â”€â”€â–¶ AlreadyInStance
              â–¼
      Remove old modifiers
              â”‚
              â”œâ”€â”€ -0 attack (was Balanced)
              â”œâ”€â”€ -0 defense (was Balanced)
              â””â”€â”€ -0 saves (was Balanced)
              â”‚
              â–¼
      combatant.SetStance(Aggressive)
      _stanceChangedThisRound.Add(id)
              â”‚
              â–¼
      Apply new modifiers
              â”‚
              â”œâ”€â”€ +2 attack
              â”œâ”€â”€ -2 defense
              â””â”€â”€ -1 saves
              â”‚
              â–¼
      Publish StanceChangedEvent


MODIFIER SUMMARY:
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚                        STANCE MODIFIERS                         â”‚
  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
  â”‚   Stance    â”‚   Attack    â”‚   Damage    â”‚   Defense   â”‚  Saves  â”‚
  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
  â”‚  Balanced   â”‚     +0      â”‚    None     â”‚     +0      â”‚   +0    â”‚
  â”‚  Aggressive â”‚     +2      â”‚    +1d4     â”‚     -2      â”‚   -1    â”‚
  â”‚  Defensive  â”‚     -2      â”‚    -1d4     â”‚     +2      â”‚   +2    â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

  * Damage bonus is rolled and added to base damage
  * Negative damage bonus reduces damage (min 1 damage)
  * Save bonus applies to all saving throws
```

---

## 16. Unit Testing Requirements (~12 tests)

| Feature | Tests |
|---------|-------|
| GetCurrentStance returns combatant stance | 1 |
| SetStance changes stance successfully | 1 |
| SetStance returns AlreadyInStance | 1 |
| SetStance fails if changed this round | 1 |
| CanChangeStance returns true initially | 1 |
| CanChangeStance returns false after change | 1 |
| GetAttackBonus returns correct value | 1 |
| GetDamageBonus returns dice notation | 1 |
| GetDefenseBonus returns correct value | 1 |
| GetSaveBonus returns correct value | 1 |
| ResetStanceChange allows new change | 1 |
| StanceChangedEvent published on change | 1 |

---

## 17. Acceptance Criteria

- [ ] CombatStance enum with Balanced, Aggressive, Defensive
- [ ] StanceDefinition entity with all modifiers
- [ ] Aggressive stance: +2 ATK, +1d4 DMG, -2 DEF, -1 saves
- [ ] Defensive stance: -2 ATK, -1d4 DMG, +2 DEF, +2 saves
- [ ] Balanced stance: no modifiers (default)
- [ ] SetStance changes and applies modifiers
- [ ] Old modifiers removed on stance change
- [ ] Stance change once per round only
- [ ] CanChangeStance tracks per-round limit
- [ ] ResetStanceChange on round start
- [ ] GetAttackBonus/GetDamageBonus/GetDefenseBonus/GetSaveBonus work
- [ ] StanceChangedEvent published
- [ ] stances.json configuration loaded
- [ ] ~12 unit tests pass

---

## 18. Dependencies

| From | Required |
|------|----------|
| v0.10.1a | `ICombatant` updates, reaction system |
| v0.10.0 | `IStatModifierService`, `ModifierOperation` |
| Application | `IEventBus`, `IConfigurationProvider` |
| Domain | `CombatStance`, `StanceDefinition` |

---

*Document Version: 1.0 | Last Updated: 2026-01-10*
