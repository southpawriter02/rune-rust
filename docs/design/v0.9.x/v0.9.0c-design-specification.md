# v0.9.0c Design Specification: TUI Bell Service

**Version:** 0.9.0c
**Parent:** v0.9.0 (Audio Foundation)
**Prerequisites:** v0.9.0b Complete (Audio Settings Integration)
**Status:** Design Complete
**Estimated Unit Tests:** ~6

---

## 1. Overview

### Purpose

Implement a TUI bell service providing console beep notifications for important events in terminal mode. Different bell patterns indicate event types: info (single beep), warning (double beep), error (long beep), combat (quick triple), level-up (ascending tones), and quest complete (celebratory pattern). Integrates with game events and respects the `TuiBellEnabled` setting.

### Key Deliverables

| Category | Items |
|----------|-------|
| **Interfaces** | `ITuiBellService` |
| **Services** | `TuiBellService` |
| **Enums** | `BellType` |
| **Event Handlers** | `TuiBellEventHandler` |
| **Tests** | ~6 unit tests |

---

## 2. Feature Overview

```
v0.9.0c Features
├── ITuiBellService Interface
│   ├── Bell(BellType type)
│   ├── BellCustom(frequency, duration)
│   ├── IsEnabled (property)
│   └── SetEnabled(bool)
│
├── BellType Patterns
│   ├── Info: Single short beep (800Hz, 100ms)
│   ├── Warning: Double beep (600Hz, 150ms × 2)
│   ├── Error: Long beep (400Hz, 500ms)
│   ├── Combat: Quick triple (1000Hz, 80ms × 3)
│   ├── LevelUp: Ascending tones (600→800→1000Hz)
│   ├── QuestComplete: Celebratory pattern
│   ├── LowHealth: Danger pattern (400Hz × 2)
│   └── Notification: Simple beep (700Hz, 120ms)
│
├── TuiBellService Implementation
│   ├── Console.Beep() wrapper
│   ├── Pattern execution with timing
│   ├── Cross-platform fallback
│   └── Enable/disable toggle
│
├── TuiBellEventHandler
│   ├── Subscribes to EventBus
│   ├── Maps game events → bell types
│   └── Triggers appropriate patterns
│
└── Event Triggers
    ├── CombatStarted → Combat
    ├── LevelUp → LevelUp
    ├── QuestCompleted → QuestComplete
    ├── LowHealth → LowHealth
    ├── ItemAcquired → Notification
    └── Error → Error
```

---

## 3. Architecture

```
┌─────────────────────────────────────────────────────────────────────────┐
│                       GAME EVENTS                                       │
├─────────────────────────────────────────────────────────────────────────┤
│  CombatStarted ────────────┐                                            │
│  LevelUp ──────────────────┼───▶  TuiBellEventHandler                  │
│  QuestCompleted ───────────┤      ├── Maps events to BellType          │
│  LowHealthWarning ─────────┤      └── Calls ITuiBellService.Bell()     │
│  ItemAcquired ─────────────┤                                            │
│  ErrorOccurred ────────────┘                  │                         │
└───────────────────────────────────────────────┼─────────────────────────┘
                                                ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                       TUI BELL SERVICE                                  │
├─────────────────────────────────────────────────────────────────────────┤
│  ITuiBellService                                                        │
│  ├── Bell(BellType type)                                               │
│  ├── BellCustom(int frequency, int durationMs)                         │
│  ├── bool IsEnabled { get; }                                           │
│  └── void SetEnabled(bool enabled)                                     │
│                                                                         │
│  TuiBellService : ITuiBellService                                      │
│  ├── _isEnabled: bool (from AudioSettings.TuiBellEnabled)              │
│  ├── _patterns: Dictionary<BellType, BellPattern>                      │
│  ├── ExecutePattern(BellPattern)                                       │
│  └── TryBeep(frequency, duration) [cross-platform safe]               │
└─────────────────────────────────────────────────────────────────────────┘
                                                │
                                                ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                       CONSOLE OUTPUT                                    │
├─────────────────────────────────────────────────────────────────────────┤
│  Console.Beep(frequency, duration)                                     │
│  └── Windows: Native beep                                              │
│  └── Unix/Mac: Fallback to '\a' or silent                             │
└─────────────────────────────────────────────────────────────────────────┘
```

---

## 4. ITuiBellService Interface

**File:** `src/Core/RuneAndRust.Application/Interfaces/ITuiBellService.cs`

```csharp
namespace RuneAndRust.Application.Interfaces;

/// <summary>
/// Provides console beep notifications for TUI mode.
/// </summary>
public interface ITuiBellService
{
    /// <summary>Plays a bell pattern for the specified type.</summary>
    void Bell(BellType type);

    /// <summary>Plays a custom bell with specific frequency and duration.</summary>
    /// <param name="frequency">Frequency in Hz (37-32767).</param>
    /// <param name="durationMs">Duration in milliseconds.</param>
    void BellCustom(int frequency, int durationMs);

    /// <summary>Gets whether bells are enabled.</summary>
    bool IsEnabled { get; }

    /// <summary>Enables or disables bell sounds.</summary>
    void SetEnabled(bool enabled);
}
```

---

## 5. BellType Enum

**File:** `src/Core/RuneAndRust.Application/Enums/BellType.cs`

```csharp
namespace RuneAndRust.Application.Enums;

/// <summary>
/// Bell pattern types for different events.
/// </summary>
public enum BellType
{
    /// <summary>Single short beep for general info.</summary>
    Info,

    /// <summary>Double beep for warnings.</summary>
    Warning,

    /// <summary>Long beep for errors.</summary>
    Error,

    /// <summary>Quick triple beep for combat start.</summary>
    Combat,

    /// <summary>Ascending tones for level up.</summary>
    LevelUp,

    /// <summary>Celebratory pattern for quest completion.</summary>
    QuestComplete,

    /// <summary>Danger pattern for low health.</summary>
    LowHealth,

    /// <summary>Simple notification beep.</summary>
    Notification
}
```

---

## 6. TuiBellService Implementation

**File:** `src/Infrastructure/RuneAndRust.Infrastructure/Services/TuiBellService.cs`

```csharp
namespace RuneAndRust.Infrastructure.Services;

public class TuiBellService : ITuiBellService
{
    private readonly ILogger<TuiBellService> _logger;
    private readonly Dictionary<BellType, BellPattern> _patterns;
    private bool _isEnabled = true;

    public bool IsEnabled => _isEnabled;

    public TuiBellService(ILogger<TuiBellService> logger)
    {
        _logger = logger;
        _patterns = InitializePatterns();
    }

    public void Bell(BellType type)
    {
        if (!_isEnabled)
        {
            _logger.LogDebug("Bell disabled, skipping: {Type}", type);
            return;
        }

        if (_patterns.TryGetValue(type, out var pattern))
        {
            ExecutePattern(pattern);
            _logger.LogDebug("Played bell: {Type}", type);
        }
    }

    public void BellCustom(int frequency, int durationMs)
    {
        if (!_isEnabled) return;
        TryBeep(frequency, durationMs);
    }

    public void SetEnabled(bool enabled)
    {
        _isEnabled = enabled;
        _logger.LogDebug("TUI bells enabled: {Enabled}", enabled);
    }

    private void ExecutePattern(BellPattern pattern)
    {
        foreach (var note in pattern.Notes)
        {
            TryBeep(note.Frequency, note.DurationMs);
            if (note.PauseAfterMs > 0)
                Thread.Sleep(note.PauseAfterMs);
        }
    }

    private void TryBeep(int frequency, int durationMs)
    {
        try
        {
            if (OperatingSystem.IsWindows())
            {
                Console.Beep(frequency, durationMs);
            }
            else
            {
                // Unix/Mac fallback: terminal bell character
                Console.Write('\a');
            }
        }
        catch (Exception ex)
        {
            _logger.LogWarning(ex, "Console.Beep not supported");
        }
    }

    private Dictionary<BellType, BellPattern> InitializePatterns() => new()
    {
        [BellType.Info] = new BellPattern(new BellNote(800, 100)),
        [BellType.Warning] = new BellPattern(
            new BellNote(600, 150, 100),
            new BellNote(600, 150)),
        [BellType.Error] = new BellPattern(new BellNote(400, 500)),
        [BellType.Combat] = new BellPattern(
            new BellNote(1000, 80, 50),
            new BellNote(1000, 80, 50),
            new BellNote(1000, 80)),
        [BellType.LevelUp] = new BellPattern(
            new BellNote(600, 150, 50),
            new BellNote(800, 150, 50),
            new BellNote(1000, 200)),
        [BellType.QuestComplete] = new BellPattern(
            new BellNote(800, 100, 50),
            new BellNote(1000, 100, 50),
            new BellNote(1200, 100, 50),
            new BellNote(1000, 200)),
        [BellType.LowHealth] = new BellPattern(
            new BellNote(400, 200, 150),
            new BellNote(400, 200)),
        [BellType.Notification] = new BellPattern(new BellNote(700, 120))
    };
}

/// <summary>A sequence of notes forming a bell pattern.</summary>
public record BellPattern(params BellNote[] Notes);

/// <summary>A single note in a bell pattern.</summary>
/// <param name="Frequency">Frequency in Hz.</param>
/// <param name="DurationMs">Duration in milliseconds.</param>
/// <param name="PauseAfterMs">Pause after note in milliseconds.</param>
public record BellNote(int Frequency, int DurationMs, int PauseAfterMs = 0);
```

---

## 7. TuiBellEventHandler

**File:** `src/Infrastructure/RuneAndRust.Infrastructure/Services/TuiBellEventHandler.cs`

```csharp
namespace RuneAndRust.Infrastructure.Services;

/// <summary>
/// Subscribes to game events and triggers appropriate bell sounds.
/// </summary>
public class TuiBellEventHandler : IDisposable
{
    private readonly ITuiBellService _bellService;
    private readonly IEventBus _eventBus;
    private readonly ILogger<TuiBellEventHandler> _logger;
    private readonly List<IDisposable> _subscriptions = new();

    public TuiBellEventHandler(ITuiBellService bellService, IEventBus eventBus,
        ILogger<TuiBellEventHandler> logger)
    {
        _bellService = bellService;
        _eventBus = eventBus;
        _logger = logger;
        SubscribeToEvents();
    }

    private void SubscribeToEvents()
    {
        _subscriptions.Add(_eventBus.Subscribe<CombatStartedEvent>(OnCombatStarted));
        _subscriptions.Add(_eventBus.Subscribe<LevelUpEvent>(OnLevelUp));
        _subscriptions.Add(_eventBus.Subscribe<QuestCompletedEvent>(OnQuestCompleted));
        _subscriptions.Add(_eventBus.Subscribe<LowHealthWarningEvent>(OnLowHealth));
        _subscriptions.Add(_eventBus.Subscribe<ItemAcquiredEvent>(OnItemAcquired));
        _subscriptions.Add(_eventBus.Subscribe<ErrorEvent>(OnError));
        _logger.LogDebug("TUI bell event handler subscribed");
    }

    private void OnCombatStarted(CombatStartedEvent e) => _bellService.Bell(BellType.Combat);
    private void OnLevelUp(LevelUpEvent e) => _bellService.Bell(BellType.LevelUp);
    private void OnQuestCompleted(QuestCompletedEvent e) => _bellService.Bell(BellType.QuestComplete);
    private void OnLowHealth(LowHealthWarningEvent e) => _bellService.Bell(BellType.LowHealth);
    private void OnItemAcquired(ItemAcquiredEvent e) => _bellService.Bell(BellType.Notification);
    private void OnError(ErrorEvent e) => _bellService.Bell(BellType.Error);

    public void Dispose()
    {
        foreach (var sub in _subscriptions) sub.Dispose();
        _subscriptions.Clear();
    }
}
```

---

## 8. Bell Pattern Visualization

```
INFO (single short):
  ♪
  800Hz, 100ms

WARNING (double beep):
  ♪   ♪
  600Hz 150ms, pause 100ms, 600Hz 150ms

ERROR (long beep):
  ♪─────
  400Hz, 500ms

COMBAT (quick triple):
  ♪♪♪
  1000Hz 80ms × 3 (50ms gaps)

LEVEL UP (ascending):
  ♪ ♫ ♬
  600Hz → 800Hz → 1000Hz (50ms gaps)

QUEST COMPLETE (celebratory):
  ♪ ♫ ♬ ♫
  800 → 1000 → 1200 → 1000Hz

LOW HEALTH (danger):
  ♪   ♪
  400Hz 200ms × 2 (150ms gap)

NOTIFICATION (simple):
  ♪
  700Hz, 120ms
```

---

## 9. Unit Testing Requirements (~6 tests)

| Feature | Tests |
|---------|-------|
| Bell executes pattern when enabled | 1 |
| Bell skips when disabled | 1 |
| SetEnabled toggles state | 1 |
| BellCustom with valid frequency | 1 |
| Event handler maps CombatStarted | 1 |
| Event handler maps LevelUp | 1 |

---

## 10. Acceptance Criteria

- [ ] Info bell plays single short beep
- [ ] Warning bell plays double beep
- [ ] Error bell plays long beep
- [ ] Combat bell plays quick triple
- [ ] LevelUp bell plays ascending tones
- [ ] QuestComplete bell plays celebratory pattern
- [ ] LowHealth bell plays danger pattern
- [ ] Notification bell plays simple beep
- [ ] SetEnabled(false) disables all bells
- [ ] Works on Windows with Console.Beep
- [ ] Graceful fallback on Unix/Mac
- [ ] Event handler triggers on CombatStarted
- [ ] Event handler triggers on LevelUp
- [ ] Event handler triggers on QuestCompleted
- [ ] Respects TuiBellEnabled setting
- [ ] ~6 unit tests pass

---

## 11. Dependencies

| From | Required |
|------|----------|
| v0.9.0b | `AudioSettings.TuiBellEnabled` |
| Application | `IEventBus`, game event types |
| System | `Console.Beep` (Windows) |

---

## 12. Cross-Platform Notes

| Platform | Behavior |
|----------|----------|
| **Windows** | `Console.Beep(freq, duration)` works natively |
| **Linux** | Falls back to `'\a'` terminal bell |
| **macOS** | Falls back to `'\a'` terminal bell |

If `Console.Beep` throws, the exception is caught and logged; bell is silently skipped.

---

*Document Version: 1.0 | Last Updated: 2026-01-10*
