# v0.8.2a Design Specification: Shop Window

**Version:** 0.8.2a
**Parent:** v0.8.2 (Interaction Windows)
**Prerequisites:** v0.8.1c Complete (Tooltip Service)
**Status:** Design Complete
**Estimated Unit Tests:** ~12

---

## Table of Contents

1. [Overview](#1-overview)
2. [Feature Overview](#2-feature-overview)
3. [Architecture](#3-architecture)
4. [Shop Window](#4-shop-window)
5. [Shop Item Control](#5-shop-item-control)
6. [Item Comparison](#6-item-comparison)
7. [View Models](#7-view-models)
8. [Transaction Handling](#8-transaction-handling)
9. [Styles](#9-styles)
10. [Data Model Changes](#10-data-model-changes)
11. [Logging Specifications](#11-logging-specifications)
12. [Unit Testing Requirements](#12-unit-testing-requirements)
13. [Use Cases](#13-use-cases)
14. [Deliverable Checklist](#14-deliverable-checklist)
15. [Acceptance Criteria](#15-acceptance-criteria)
16. [Dependencies](#16-dependencies)
17. [Future Considerations](#17-future-considerations)

---

## 1. Overview

### Purpose

Implement a shop window that allows players to buy items from a merchant and sell items from their inventory. Features include dual inventory display (shop items vs. player items), item selection with comparison tooltips against equipped gear, gold tracking, and transaction feedback. The window integrates with the existing ShopService for buy/sell logic.

### Key Deliverables

| Category | Items |
|----------|-------|
| **Windows** | `ShopWindow` |
| **ViewModels** | `ShopWindowViewModel`, `ShopItemViewModel`, `ItemComparisonViewModel` |
| **Controls** | `ShopItemControl` |
| **Models** | `ComparisonLine`, `TransactionResult` |
| **Styles** | `ShopWindowStyles.axaml` |
| **Tests** | ~12 unit tests |

### Design Principles

1. **Dual Inventory**: Side-by-side shop and player inventory
2. **Comparison**: Show stat differences vs. equipped item
3. **Immediate Feedback**: Transaction results shown instantly
4. **Guard Rails**: Prevent invalid transactions (insufficient gold, full inventory)
5. **Clear Pricing**: Distinct buy and sell prices visible

---

## 2. Feature Overview

```
v0.8.2a Features
â”œâ”€â”€ ShopWindow (Modal)
â”‚   â”œâ”€â”€ Merchant name header
â”‚   â”œâ”€â”€ Shop inventory list (left)
â”‚   â”œâ”€â”€ Player inventory list (right)
â”‚   â”œâ”€â”€ Selected item details
â”‚   â”œâ”€â”€ Item comparison panel
â”‚   â”œâ”€â”€ Gold display
â”‚   â”œâ”€â”€ Buy/Sell/Close buttons
â”‚   â””â”€â”€ Transaction feedback
â”‚
â”œâ”€â”€ ShopItemControl
â”‚   â”œâ”€â”€ Item icon
â”‚   â”œâ”€â”€ Item name
â”‚   â”œâ”€â”€ Price (buy or sell)
â”‚   â”œâ”€â”€ Selection state ([â–¶] / [â—€])
â”‚   â””â”€â”€ Tooltip integration
â”‚
â”œâ”€â”€ Item Comparison Panel
â”‚   â”œâ”€â”€ Compared item name
â”‚   â”œâ”€â”€ Stat-by-stat comparison
â”‚   â”œâ”€â”€ Better/Worse/Same indicators
â”‚   â””â”€â”€ Weight comparison
â”‚
â”œâ”€â”€ ShopWindowViewModel
â”‚   â”œâ”€â”€ Shop inventory binding
â”‚   â”œâ”€â”€ Player inventory binding
â”‚   â”œâ”€â”€ Selected item tracking
â”‚   â”œâ”€â”€ Comparison calculation
â”‚   â”œâ”€â”€ Buy/Sell commands
â”‚   â”œâ”€â”€ Gold tracking
â”‚   â””â”€â”€ Transaction validation
â”‚
â”œâ”€â”€ ShopItemViewModel
â”‚   â”œâ”€â”€ Item wrapper
â”‚   â”œâ”€â”€ Buy price / Sell price
â”‚   â”œâ”€â”€ Selection state
â”‚   â””â”€â”€ Tooltip data
â”‚
â”œâ”€â”€ Transaction Handling
â”‚   â”œâ”€â”€ Buy item â†’ Gold deducted
â”‚   â”œâ”€â”€ Sell item â†’ Gold added
â”‚   â”œâ”€â”€ Insufficient gold error
â”‚   â”œâ”€â”€ Inventory full error
â”‚   â””â”€â”€ Success/failure messages
â”‚
â””â”€â”€ Integration Points
    â”œâ”€â”€ IShopService (buy/sell logic)
    â”œâ”€â”€ IGameSessionService (player data)
    â””â”€â”€ ITooltipService (item tooltips)
```

---

## 3. Architecture

### Component Diagram

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                       PRESENTATION LAYER                                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Windows                                                                â”‚
â”‚  â””â”€â”€ ShopWindow : Window                                               â”‚
â”‚       â”œâ”€â”€ Header (Merchant name)                                       â”‚
â”‚       â”œâ”€â”€ Shop Inventory Panel (left)                                  â”‚
â”‚       â”œâ”€â”€ Player Inventory Panel (right)                               â”‚
â”‚       â”œâ”€â”€ Selected Item Details Panel                                  â”‚
â”‚       â”œâ”€â”€ Item Comparison Panel                                        â”‚
â”‚       â”œâ”€â”€ Gold Display                                                 â”‚
â”‚       â””â”€â”€ Action Buttons (Buy, Sell, Close)                            â”‚
â”‚                                                                         â”‚
â”‚  Controls                                                               â”‚
â”‚  â””â”€â”€ ShopItemControl : TemplatedControl                                â”‚
â”‚       â”œâ”€â”€ Icon (styled property)                                       â”‚
â”‚       â”œâ”€â”€ Name (styled property)                                       â”‚
â”‚       â”œâ”€â”€ Price (styled property)                                      â”‚
â”‚       â”œâ”€â”€ IsSelected (styled property)                                 â”‚
â”‚       â””â”€â”€ IsPlayerItem (styled property)                               â”‚
â”‚                                                                         â”‚
â”‚  ViewModels                                                             â”‚
â”‚  â”œâ”€â”€ ShopWindowViewModel : ViewModelBase                               â”‚
â”‚  â”‚    â”œâ”€â”€ Shop Shop                                                    â”‚
â”‚  â”‚    â”œâ”€â”€ string ShopName                                              â”‚
â”‚  â”‚    â”œâ”€â”€ ObservableCollection<ShopItemViewModel> ShopItems            â”‚
â”‚  â”‚    â”œâ”€â”€ ObservableCollection<ShopItemViewModel> PlayerItems          â”‚
â”‚  â”‚    â”œâ”€â”€ ShopItemViewModel? SelectedShopItem                          â”‚
â”‚  â”‚    â”œâ”€â”€ ShopItemViewModel? SelectedPlayerItem                        â”‚
â”‚  â”‚    â”œâ”€â”€ int PlayerGold                                               â”‚
â”‚  â”‚    â”œâ”€â”€ bool CanBuy, CanSell                                         â”‚
â”‚  â”‚    â”œâ”€â”€ string? TransactionMessage                                   â”‚
â”‚  â”‚    â”œâ”€â”€ ItemComparisonViewModel? Comparison                          â”‚
â”‚  â”‚    â”œâ”€â”€ [RelayCommand] SelectShopItem()                              â”‚
â”‚  â”‚    â”œâ”€â”€ [RelayCommand] SelectPlayerItem()                            â”‚
â”‚  â”‚    â”œâ”€â”€ [RelayCommand] Buy()                                         â”‚
â”‚  â”‚    â”œâ”€â”€ [RelayCommand] Sell()                                        â”‚
â”‚  â”‚    â””â”€â”€ [RelayCommand] Close()                                       â”‚
â”‚  â”‚                                                                     â”‚
â”‚  â”œâ”€â”€ ShopItemViewModel : ViewModelBase                                 â”‚
â”‚  â”‚    â”œâ”€â”€ Item Item                                                    â”‚
â”‚  â”‚    â”œâ”€â”€ string Icon, Name                                            â”‚
â”‚  â”‚    â”œâ”€â”€ int BuyPrice, SellPrice                                      â”‚
â”‚  â”‚    â”œâ”€â”€ bool IsSelected                                              â”‚
â”‚  â”‚    â””â”€â”€ bool IsPlayerItem                                            â”‚
â”‚  â”‚                                                                     â”‚
â”‚  â””â”€â”€ ItemComparisonViewModel                                           â”‚
â”‚       â”œâ”€â”€ string ComparedTo                                            â”‚
â”‚       â””â”€â”€ IReadOnlyList<ComparisonLine> Lines                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                     â”‚
                                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                       APPLICATION LAYER                                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Services                                                               â”‚
â”‚  â””â”€â”€ IShopService                                                      â”‚
â”‚       â”œâ”€â”€ BuyItem(Shop, Item): TransactionResult                       â”‚
â”‚       â”œâ”€â”€ SellItem(Shop, Item): TransactionResult                      â”‚
â”‚       â”œâ”€â”€ GetBuyPrice(Shop, Item): int                                 â”‚
â”‚       â””â”€â”€ GetSellPrice(Shop, Item): int                                â”‚
â”‚                                                                         â”‚
â”‚  â””â”€â”€ IGameSessionService                                               â”‚
â”‚       â”œâ”€â”€ Player Player                                                â”‚
â”‚       â”œâ”€â”€ CurrentShop Shop?                                            â”‚
â”‚       â””â”€â”€ UpdatePlayerGold(int amount)                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                     â”‚
                                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         DOMAIN LAYER                                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Entities                                                               â”‚
â”‚  â”œâ”€â”€ Shop                                                               â”‚
â”‚  â”‚    â”œâ”€â”€ Guid Id                                                       â”‚
â”‚  â”‚    â”œâ”€â”€ string Name                                                   â”‚
â”‚  â”‚    â”œâ”€â”€ string MerchantName                                          â”‚
â”‚  â”‚    â”œâ”€â”€ IReadOnlyList<ShopItem> Inventory                            â”‚
â”‚  â”‚    â””â”€â”€ decimal BuyMultiplier, SellMultiplier                        â”‚
â”‚  â”‚                                                                     â”‚
â”‚  â””â”€â”€ ShopItem                                                          â”‚
â”‚       â”œâ”€â”€ Item Item                                                    â”‚
â”‚       â”œâ”€â”€ int Stock                                                    â”‚
â”‚       â””â”€â”€ int? OverridePrice                                           â”‚
â”‚                                                                         â”‚
â”‚  Value Objects                                                          â”‚
â”‚  â””â”€â”€ TransactionResult                                                  â”‚
â”‚       â”œâ”€â”€ bool Success                                                  â”‚
â”‚       â”œâ”€â”€ string? FailureReason                                        â”‚
â”‚       â””â”€â”€ int? GoldChange                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Transaction Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        BUY TRANSACTION FLOW                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

    Player Clicks "BUY" Button
                        â”‚
                        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                ShopWindowViewModel.Buy()                               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  1. Check SelectedShopItem is not null                                 â”‚
â”‚  2. Validate CanBuy conditions                                         â”‚
â”‚     - PlayerGold >= BuyPrice                                           â”‚
â”‚     - Player inventory not full                                        â”‚
â”‚  3. Call IShopService.BuyItem(Shop, Item)                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚
                        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                 IShopService.BuyItem()                                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  1. Deduct gold from player                                            â”‚
â”‚  2. Add item to player inventory                                       â”‚
â”‚  3. Update shop stock (if limited)                                     â”‚
â”‚  4. Return TransactionResult                                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚
                        â”œâ”€â”€â”€â–º Success: "Purchased Iron Sword!"
                        â”‚     - Update PlayerGold display
                        â”‚     - Refresh inventories
                        â”‚
                        â””â”€â”€â”€â–º Failure: "Insufficient gold!" or "Inventory full!"
                              - Display error message
```

---

## 4. Shop Window

### ShopWindow.axaml

**File:** `src/Presentation/RuneAndRust.Avalonia/Views/ShopWindow.axaml`

```xml
<Window xmlns="https://github.com/avaloniaui"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:vm="using:RuneAndRust.Avalonia.ViewModels"
        xmlns:controls="using:RuneAndRust.Avalonia.Controls"
        x:Class="RuneAndRust.Avalonia.Views.ShopWindow"
        x:DataType="vm:ShopWindowViewModel"
        Title="Shop"
        Width="750" Height="600"
        WindowStartupLocation="CenterOwner"
        CanResize="False"
        ShowInTaskbar="False">
    
    <Grid RowDefinitions="Auto,*,Auto,Auto">
        
        <!-- Header -->
        <Border Grid.Row="0" Classes="shop-header" Padding="16,12">
            <TextBlock Text="{Binding ShopName}" Classes="shop-title" />
        </Border>
        
        <!-- Inventory Panels -->
        <Grid Grid.Row="1" ColumnDefinitions="*,*">
            
            <!-- Shop Inventory (Left) -->
            <Border Grid.Column="0" Classes="inventory-panel" Margin="8">
                <Grid RowDefinitions="Auto,*">
                    <TextBlock Grid.Row="0" 
                               Text="SHOP INVENTORY" 
                               Classes="panel-title" 
                               Margin="8" />
                    
                    <ScrollViewer Grid.Row="1">
                        <ItemsControl ItemsSource="{Binding ShopItems}">
                            <ItemsControl.ItemTemplate>
                                <DataTemplate DataType="vm:ShopItemViewModel">
                                    <controls:ShopItemControl
                                        Icon="{Binding Icon}"
                                        Name="{Binding Name}"
                                        Price="{Binding BuyPriceText}"
                                        IsSelected="{Binding IsSelected}"
                                        IsPlayerItem="False"
                                        PointerPressed="OnShopItemPressed"
                                        helpers:TooltipHelper.Item="{Binding Item}" />
                                </DataTemplate>
                            </ItemsControl.ItemTemplate>
                        </ItemsControl>
                    </ScrollViewer>
                </Grid>
            </Border>
            
            <!-- Player Inventory (Right) -->
            <Border Grid.Column="1" Classes="inventory-panel" Margin="8">
                <Grid RowDefinitions="Auto,*">
                    <TextBlock Grid.Row="0" 
                               Text="YOUR INVENTORY" 
                               Classes="panel-title" 
                               Margin="8" />
                    
                    <ScrollViewer Grid.Row="1">
                        <ItemsControl ItemsSource="{Binding PlayerItems}">
                            <ItemsControl.ItemTemplate>
                                <DataTemplate DataType="vm:ShopItemViewModel">
                                    <controls:ShopItemControl
                                        Icon="{Binding Icon}"
                                        Name="{Binding Name}"
                                        Price="{Binding SellPriceText}"
                                        IsSelected="{Binding IsSelected}"
                                        IsPlayerItem="True"
                                        PointerPressed="OnPlayerItemPressed"
                                        helpers:TooltipHelper.Item="{Binding Item}" />
                                </DataTemplate>
                            </ItemsControl.ItemTemplate>
                        </ItemsControl>
                    </ScrollViewer>
                </Grid>
            </Border>
            
        </Grid>
        
        <!-- Selected Item Details + Comparison -->
        <Border Grid.Row="2" Classes="details-panel" Margin="8,0,8,8">
            <Grid ColumnDefinitions="*,Auto" IsVisible="{Binding HasSelectedItem}">
                
                <!-- Item Details -->
                <StackPanel Grid.Column="0" Margin="12">
                    <StackPanel Orientation="Horizontal" Margin="0,0,0,8">
                        <TextBlock Text="SELECTED: " Classes="label" />
                        <TextBlock Text="{Binding SelectedItemName}" Classes="selected-name" />
                    </StackPanel>
                    
                    <Border Classes="separator" Margin="0,0,0,8" />
                    
                    <TextBlock Text="{Binding SelectedItemStats}" 
                               Classes="item-stats" />
                    
                    <TextBlock Text="{Binding SelectedItemDescription}" 
                               TextWrapping="Wrap"
                               Classes="item-description"
                               Margin="0,8,0,0" />
                </StackPanel>
                
                <!-- Comparison Panel -->
                <Border Grid.Column="1" 
                        Classes="comparison-panel"
                        IsVisible="{Binding HasComparison}"
                        Margin="8"
                        Padding="12"
                        Width="300">
                    <StackPanel>
                        <StackPanel Orientation="Horizontal" Margin="0,0,0,8">
                            <TextBlock Text="COMPARISON vs. " Classes="label" />
                            <TextBlock Text="{Binding Comparison.ComparedTo}" Classes="compared-to" />
                        </StackPanel>
                        
                        <ItemsControl ItemsSource="{Binding Comparison.Lines}">
                            <ItemsControl.ItemTemplate>
                                <DataTemplate DataType="vm:ComparisonLine">
                                    <Grid ColumnDefinitions="Auto,*,Auto,Auto" Margin="0,4">
                                        <TextBlock Grid.Column="0" 
                                                   Text="{Binding Stat}" 
                                                   Classes="comparison-label"
                                                   Margin="0,0,12,0" />
                                        <TextBlock Grid.Column="1" 
                                                   Text="{Binding ComparisonText}" 
                                                   Classes="comparison-values" />
                                        <TextBlock Grid.Column="2" 
                                                   Text="{Binding ResultIndicator}"
                                                   Foreground="{Binding ResultColor}"
                                                   Margin="8,0,0,0" />
                                        <TextBlock Grid.Column="3" 
                                                   Text="{Binding ResultText}"
                                                   Foreground="{Binding ResultColor}"
                                                   Margin="4,0,0,0" />
                                    </Grid>
                                </DataTemplate>
                            </ItemsControl.ItemTemplate>
                        </ItemsControl>
                    </StackPanel>
                </Border>
                
            </Grid>
        </Border>
        
        <!-- Footer: Gold + Buttons -->
        <Border Grid.Row="3" Classes="shop-footer" Padding="16,12">
            <Grid ColumnDefinitions="Auto,*,Auto,Auto,Auto">
                
                <!-- Gold Display -->
                <StackPanel Grid.Column="0" Orientation="Horizontal">
                    <TextBlock Text="ğŸ’°" FontSize="18" Margin="0,0,8,0" />
                    <TextBlock Text="Your Gold:" Classes="gold-label" Margin="0,0,8,0" />
                    <TextBlock Text="{Binding PlayerGold}" Classes="gold-amount" />
                </StackPanel>
                
                <!-- Transaction Message -->
                <TextBlock Grid.Column="1" 
                           Text="{Binding TransactionMessage}"
                           Classes="transaction-message"
                           HorizontalAlignment="Center"
                           VerticalAlignment="Center" />
                
                <!-- Buy Button -->
                <Button Grid.Column="2"
                        Content="{Binding BuyButtonText}"
                        Command="{Binding BuyCommand}"
                        IsEnabled="{Binding CanBuy}"
                        Classes="buy-button"
                        Margin="0,0,8,0" />
                
                <!-- Sell Button -->
                <Button Grid.Column="3"
                        Content="{Binding SellButtonText}"
                        Command="{Binding SellCommand}"
                        IsEnabled="{Binding CanSell}"
                        Classes="sell-button"
                        Margin="0,0,8,0" />
                
                <!-- Close Button -->
                <Button Grid.Column="4"
                        Content="CLOSE"
                        Command="{Binding CloseCommand}"
                        Classes="close-button" />
                
            </Grid>
        </Border>
        
    </Grid>
</Window>
```

### ShopWindow Code-Behind

**File:** `src/Presentation/RuneAndRust.Avalonia/Views/ShopWindow.axaml.cs`

```csharp
namespace RuneAndRust.Avalonia.Views;

public partial class ShopWindow : Window
{
    public ShopWindow()
    {
        InitializeComponent();
    }

    private void OnShopItemPressed(object? sender, PointerPressedEventArgs e)
    {
        if (sender is ShopItemControl control && 
            DataContext is ShopWindowViewModel vm &&
            control.DataContext is ShopItemViewModel item)
        {
            vm.SelectShopItemCommand.Execute(item);
        }
    }

    private void OnPlayerItemPressed(object? sender, PointerPressedEventArgs e)
    {
        if (sender is ShopItemControl control && 
            DataContext is ShopWindowViewModel vm &&
            control.DataContext is ShopItemViewModel item)
        {
            vm.SelectPlayerItemCommand.Execute(item);
        }
    }
}
```

---

## 5. Shop Item Control

### ShopItemControl

**File:** `src/Presentation/RuneAndRust.Avalonia/Controls/ShopItemControl.cs`

```csharp
namespace RuneAndRust.Avalonia.Controls;

/// <summary>
/// Displays an item in the shop inventory list.
/// </summary>
/// <remarks>
/// Shows item icon, name, and price. Selection state is indicated
/// with an arrow (â–¶ for shop items, â—€ for player items to sell).
/// </remarks>
public class ShopItemControl : TemplatedControl
{
    public static readonly StyledProperty<string> IconProperty =
        AvaloniaProperty.Register<ShopItemControl, string>(nameof(Icon), "");

    public static readonly StyledProperty<string> NameProperty =
        AvaloniaProperty.Register<ShopItemControl, string>(nameof(Name), "");

    public static readonly StyledProperty<string> PriceProperty =
        AvaloniaProperty.Register<ShopItemControl, string>(nameof(Price), "");

    public static readonly StyledProperty<bool> IsSelectedProperty =
        AvaloniaProperty.Register<ShopItemControl, bool>(nameof(IsSelected), false);

    public static readonly StyledProperty<bool> IsPlayerItemProperty =
        AvaloniaProperty.Register<ShopItemControl, bool>(nameof(IsPlayerItem), false);

    /// <summary>
    /// Gets or sets the item type icon.
    /// </summary>
    public string Icon
    {
        get => GetValue(IconProperty);
        set => SetValue(IconProperty, value);
    }

    /// <summary>
    /// Gets or sets the item name.
    /// </summary>
    public string Name
    {
        get => GetValue(NameProperty);
        set => SetValue(NameProperty, value);
    }

    /// <summary>
    /// Gets or sets the price display text.
    /// </summary>
    public string Price
    {
        get => GetValue(PriceProperty);
        set => SetValue(PriceProperty, value);
    }

    /// <summary>
    /// Gets or sets whether this item is selected.
    /// </summary>
    public bool IsSelected
    {
        get => GetValue(IsSelectedProperty);
        set => SetValue(IsSelectedProperty, value);
    }

    /// <summary>
    /// Gets or sets whether this is a player inventory item (for selling).
    /// </summary>
    public bool IsPlayerItem
    {
        get => GetValue(IsPlayerItemProperty);
        set => SetValue(IsPlayerItemProperty, value);
    }

    /// <summary>
    /// Gets the selection indicator character.
    /// </summary>
    public string SelectionIndicator => IsPlayerItem ? "[â—€]" : "[â–¶]";
}
```

### ShopItemControl Template

**File:** `src/Presentation/RuneAndRust.Avalonia/Controls/ShopItemControl.axaml`

```xml
<ResourceDictionary xmlns="https://github.com/avaloniaui"
                    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
                    xmlns:controls="using:RuneAndRust.Avalonia.Controls">
    
    <ControlTheme x:Key="{x:Type controls:ShopItemControl}" 
                  TargetType="controls:ShopItemControl">
        
        <Setter Property="Cursor" Value="Hand" />
        <Setter Property="Margin" Value="4,2" />
        
        <Setter Property="Template">
            <ControlTemplate>
                <Border x:Name="ItemBorder"
                        Padding="8,6"
                        CornerRadius="4"
                        Background="Transparent"
                        BorderThickness="1"
                        BorderBrush="Transparent">
                    <Grid ColumnDefinitions="Auto,*,Auto,Auto">
                        
                        <!-- Item Icon -->
                        <TextBlock Grid.Column="0"
                                   Text="{TemplateBinding Icon}"
                                   FontSize="16"
                                   Margin="0,0,8,0" />
                        
                        <!-- Item Name -->
                        <TextBlock Grid.Column="1"
                                   Text="{TemplateBinding Name}"
                                   TextTrimming="CharacterEllipsis"
                                   VerticalAlignment="Center" />
                        
                        <!-- Price -->
                        <TextBlock Grid.Column="2"
                                   Text="{TemplateBinding Price}"
                                   Classes="price"
                                   Margin="8,0,0,0"
                                   VerticalAlignment="Center" />
                        
                        <!-- Selection Indicator -->
                        <TextBlock Grid.Column="3"
                                   Text="{TemplateBinding SelectionIndicator}"
                                   Classes="selection-indicator"
                                   IsVisible="{TemplateBinding IsSelected}"
                                   Margin="8,0,0,0"
                                   VerticalAlignment="Center" />
                        
                    </Grid>
                </Border>
            </ControlTemplate>
        </Setter>
        
        <!-- Hover Style -->
        <Style Selector="^:pointerover /template/ Border#ItemBorder">
            <Setter Property="Background" Value="{StaticResource HoverBackgroundBrush}" />
        </Style>
        
        <!-- Selected Style -->
        <Style Selector="^[IsSelected=True] /template/ Border#ItemBorder">
            <Setter Property="Background" Value="{StaticResource SelectedBackgroundBrush}" />
            <Setter Property="BorderBrush" Value="{StaticResource AccentBrush}" />
        </Style>
        
    </ControlTheme>
    
</ResourceDictionary>
```

---

## 6. Item Comparison

### ItemComparisonViewModel

**File:** `src/Presentation/RuneAndRust.Avalonia/ViewModels/ItemComparisonViewModel.cs`

```csharp
namespace RuneAndRust.Avalonia.ViewModels;

/// <summary>
/// ViewModel for item comparison display.
/// </summary>
/// <remarks>
/// Compares a new item against the currently equipped item in the same slot,
/// showing stat-by-stat comparison with better/worse indicators.
/// </remarks>
public class ItemComparisonViewModel
{
    public string ComparedTo { get; }
    public IReadOnlyList<ComparisonLine> Lines { get; }

    public ItemComparisonViewModel(Item newItem, Item currentItem)
    {
        ArgumentNullException.ThrowIfNull(newItem);
        ArgumentNullException.ThrowIfNull(currentItem);

        ComparedTo = currentItem.Name;
        Lines = BuildComparisonLines(newItem, currentItem);
    }

    private static IReadOnlyList<ComparisonLine> BuildComparisonLines(Item newItem, Item currentItem)
    {
        var lines = new List<ComparisonLine>();

        // Compare damage (if applicable)
        if (!string.IsNullOrEmpty(newItem.Damage) || !string.IsNullOrEmpty(currentItem.Damage))
        {
            lines.Add(new ComparisonLine(
                "Damage",
                newItem.Damage ?? "â€”",
                currentItem.Damage ?? "â€”",
                CompareDamage(newItem.Damage, currentItem.Damage)));
        }

        // Compare attack bonus
        if (newItem.AttackBonus != 0 || currentItem.AttackBonus != 0)
        {
            lines.Add(new ComparisonLine(
                "Attack",
                $"+{newItem.AttackBonus}",
                $"+{currentItem.AttackBonus}",
                CompareValues(newItem.AttackBonus, currentItem.AttackBonus)));
        }

        // Compare defense bonus
        if (newItem.DefenseBonus != 0 || currentItem.DefenseBonus != 0)
        {
            lines.Add(new ComparisonLine(
                "Defense",
                $"+{newItem.DefenseBonus}",
                $"+{currentItem.DefenseBonus}",
                CompareValues(newItem.DefenseBonus, currentItem.DefenseBonus)));
        }

        // Compare weight (lower is better)
        lines.Add(new ComparisonLine(
            "Weight",
            $"{newItem.Weight} lbs",
            $"{currentItem.Weight} lbs",
            CompareValues(currentItem.Weight, newItem.Weight))); // Inverted: lower is better

        return lines;
    }

    private static ComparisonResult CompareDamage(string? newDamage, string? currentDamage)
    {
        // Simplified comparison: just check if values exist
        // In production, parse dice notation and calculate averages
        if (string.IsNullOrEmpty(newDamage) && string.IsNullOrEmpty(currentDamage))
            return ComparisonResult.Same;
        if (string.IsNullOrEmpty(currentDamage))
            return ComparisonResult.Better;
        if (string.IsNullOrEmpty(newDamage))
            return ComparisonResult.Worse;

        // Basic string length comparison as proxy (real impl would parse dice)
        return newDamage.Length > currentDamage.Length 
            ? ComparisonResult.Better 
            : newDamage.Length < currentDamage.Length 
                ? ComparisonResult.Worse 
                : ComparisonResult.Same;
    }

    private static ComparisonResult CompareValues(int newValue, int currentValue)
    {
        if (newValue > currentValue) return ComparisonResult.Better;
        if (newValue < currentValue) return ComparisonResult.Worse;
        return ComparisonResult.Same;
    }

    private static ComparisonResult CompareValues(double newValue, double currentValue)
    {
        if (newValue > currentValue) return ComparisonResult.Better;
        if (newValue < currentValue) return ComparisonResult.Worse;
        return ComparisonResult.Same;
    }
}
```

### ComparisonLine Record

**File:** `src/Presentation/RuneAndRust.Avalonia/ViewModels/ComparisonLine.cs`

```csharp
namespace RuneAndRust.Avalonia.ViewModels;

/// <summary>
/// A single line in an item comparison.
/// </summary>
/// <param name="Stat">The stat being compared.</param>
/// <param name="NewValue">The value of the new item.</param>
/// <param name="OldValue">The value of the current item.</param>
/// <param name="Result">The comparison result.</param>
public record ComparisonLine(string Stat, string NewValue, string OldValue, ComparisonResult Result)
{
    /// <summary>
    /// Gets the formatted comparison text "NewValue vs OldValue".
    /// </summary>
    public string ComparisonText => $"{NewValue} vs {OldValue}";

    /// <summary>
    /// Gets the result indicator (â–², â–¼, or â•).
    /// </summary>
    public string ResultIndicator => Result switch
    {
        ComparisonResult.Better => "â–²",
        ComparisonResult.Worse => "â–¼",
        ComparisonResult.Same => "â•",
        _ => ""
    };

    /// <summary>
    /// Gets the result description text.
    /// </summary>
    public string ResultText => Result switch
    {
        ComparisonResult.Better => "Better",
        ComparisonResult.Worse => "Worse",
        ComparisonResult.Same => "Same",
        _ => ""
    };

    /// <summary>
    /// Gets the result color.
    /// </summary>
    public IBrush ResultColor => Result switch
    {
        ComparisonResult.Better => Brushes.LimeGreen,
        ComparisonResult.Worse => Brushes.IndianRed,
        ComparisonResult.Same => Brushes.Gray,
        _ => Brushes.White
    };
}

/// <summary>
/// Result of comparing two item stats.
/// </summary>
public enum ComparisonResult
{
    Better,
    Worse,
    Same
}
```

---

## 7. View Models

### ShopWindowViewModel

**File:** `src/Presentation/RuneAndRust.Avalonia/ViewModels/ShopWindowViewModel.cs`

```csharp
namespace RuneAndRust.Avalonia.ViewModels;

/// <summary>
/// ViewModel for the shop window.
/// </summary>
/// <remarks>
/// Manages the shop inventory display, player inventory, item selection,
/// comparison, and buy/sell transactions.
/// </remarks>
public partial class ShopWindowViewModel : ViewModelBase
{
    private readonly IShopService _shopService;
    private readonly IGameSessionService _gameSession;
    private readonly ILogger<ShopWindowViewModel> _logger;
    private readonly Action? _onClose;

    [ObservableProperty]
    private Shop _shop = null!;

    [ObservableProperty]
    private string _shopName = "";

    [ObservableProperty]
    private ObservableCollection<ShopItemViewModel> _shopItems = new();

    [ObservableProperty]
    private ObservableCollection<ShopItemViewModel> _playerItems = new();

    [ObservableProperty]
    private ShopItemViewModel? _selectedShopItem;

    [ObservableProperty]
    private ShopItemViewModel? _selectedPlayerItem;

    [ObservableProperty]
    private int _playerGold;

    [ObservableProperty]
    private bool _canBuy;

    [ObservableProperty]
    private bool _canSell;

    [ObservableProperty]
    private string? _transactionMessage;

    [ObservableProperty]
    private ItemComparisonViewModel? _comparison;

    public bool HasSelectedItem => SelectedShopItem is not null || SelectedPlayerItem is not null;
    public bool HasComparison => Comparison is not null;

    public string SelectedItemName => SelectedShopItem?.Name ?? SelectedPlayerItem?.Name ?? "";
    
    public string SelectedItemStats => BuildSelectedItemStats();
    
    public string SelectedItemDescription => 
        SelectedShopItem?.Item.Description ?? SelectedPlayerItem?.Item.Description ?? "";

    public string BuyButtonText => SelectedShopItem is not null 
        ? $"BUY ({SelectedShopItem.BuyPrice}g)" 
        : "BUY";

    public string SellButtonText => SelectedPlayerItem is not null 
        ? $"SELL ({SelectedPlayerItem.SellPrice}g)" 
        : "SELL";

    public ShopWindowViewModel(
        IShopService shopService, 
        IGameSessionService gameSession,
        ILogger<ShopWindowViewModel> logger,
        Action? onClose = null)
    {
        _shopService = shopService;
        _gameSession = gameSession;
        _logger = logger;
        _onClose = onClose;

        PlayerGold = _gameSession.Player.Gold;

        if (_gameSession.CurrentShop is not null)
        {
            LoadShop(_gameSession.CurrentShop);
        }

        _logger.LogDebug("ShopWindowViewModel initialized with {Gold}g", PlayerGold);
    }

    /// <summary>
    /// Loads a shop for display.
    /// </summary>
    public void LoadShop(Shop shop)
    {
        Shop = shop;
        ShopName = $"MERCHANT - {shop.MerchantName}";

        RefreshInventories();

        _logger.LogDebug("Loaded shop: {ShopName} with {ItemCount} items", 
            shop.MerchantName, shop.Inventory.Count);
    }

    /// <summary>
    /// Selects a shop item for potential purchase.
    /// </summary>
    [RelayCommand]
    private void SelectShopItem(ShopItemViewModel item)
    {
        // Deselect previous selections
        if (SelectedShopItem is not null) SelectedShopItem.IsSelected = false;
        if (SelectedPlayerItem is not null) SelectedPlayerItem.IsSelected = false;

        SelectedShopItem = item;
        SelectedPlayerItem = null;
        item.IsSelected = true;

        UpdateComparison(item.Item);
        UpdateButtonStates();
        ClearTransactionMessage();

        OnPropertyChanged(nameof(HasSelectedItem));
        OnPropertyChanged(nameof(HasComparison));
        OnPropertyChanged(nameof(SelectedItemName));
        OnPropertyChanged(nameof(SelectedItemStats));
        OnPropertyChanged(nameof(SelectedItemDescription));
        OnPropertyChanged(nameof(BuyButtonText));

        _logger.LogDebug("Selected shop item: {ItemName}", item.Name);
    }

    /// <summary>
    /// Selects a player item for potential sale.
    /// </summary>
    [RelayCommand]
    private void SelectPlayerItem(ShopItemViewModel item)
    {
        // Deselect previous selections
        if (SelectedShopItem is not null) SelectedShopItem.IsSelected = false;
        if (SelectedPlayerItem is not null) SelectedPlayerItem.IsSelected = false;

        SelectedPlayerItem = item;
        SelectedShopItem = null;
        item.IsSelected = true;

        Comparison = null; // No comparison for sell
        UpdateButtonStates();
        ClearTransactionMessage();

        OnPropertyChanged(nameof(HasSelectedItem));
        OnPropertyChanged(nameof(HasComparison));
        OnPropertyChanged(nameof(SelectedItemName));
        OnPropertyChanged(nameof(SelectedItemStats));
        OnPropertyChanged(nameof(SelectedItemDescription));
        OnPropertyChanged(nameof(SellButtonText));

        _logger.LogDebug("Selected player item: {ItemName}", item.Name);
    }

    /// <summary>
    /// Purchases the selected shop item.
    /// </summary>
    [RelayCommand]
    private void Buy()
    {
        if (SelectedShopItem is null) return;

        var result = _shopService.BuyItem(Shop, SelectedShopItem.Item);

        if (result.Success)
        {
            TransactionMessage = $"âœ“ Purchased {SelectedShopItem.Item.Name}!";
            PlayerGold = _gameSession.Player.Gold;
            RefreshInventories();

            _logger.LogInformation("Purchased item: {ItemName} for {Price}g", 
                SelectedShopItem.Item.Name, SelectedShopItem.BuyPrice);
        }
        else
        {
            TransactionMessage = $"âœ— {result.FailureReason}";
            _logger.LogWarning("Purchase failed: {Reason}", result.FailureReason);
        }

        UpdateButtonStates();
    }

    /// <summary>
    /// Sells the selected player item.
    /// </summary>
    [RelayCommand]
    private void Sell()
    {
        if (SelectedPlayerItem is null) return;

        var itemName = SelectedPlayerItem.Item.Name;
        var sellPrice = SelectedPlayerItem.SellPrice;

        var result = _shopService.SellItem(Shop, SelectedPlayerItem.Item);

        if (result.Success)
        {
            TransactionMessage = $"âœ“ Sold {itemName} for {sellPrice}g!";
            PlayerGold = _gameSession.Player.Gold;
            RefreshInventories();
            SelectedPlayerItem = null;

            _logger.LogInformation("Sold item: {ItemName} for {Price}g", itemName, sellPrice);
        }
        else
        {
            TransactionMessage = $"âœ— {result.FailureReason}";
            _logger.LogWarning("Sale failed: {Reason}", result.FailureReason);
        }

        UpdateButtonStates();
    }

    /// <summary>
    /// Closes the shop window.
    /// </summary>
    [RelayCommand]
    private void Close()
    {
        _logger.LogDebug("Shop window closed");
        _onClose?.Invoke();
    }

    private void UpdateComparison(Item shopItem)
    {
        var equippedItem = _gameSession.Player.GetEquippedItem(shopItem.EquipSlot);
        
        if (equippedItem is null)
        {
            Comparison = null;
            return;
        }

        Comparison = new ItemComparisonViewModel(shopItem, equippedItem);
    }

    private void UpdateButtonStates()
    {
        CanBuy = SelectedShopItem is not null 
              && PlayerGold >= SelectedShopItem.BuyPrice
              && !_gameSession.Player.Inventory.IsFull;

        CanSell = SelectedPlayerItem is not null 
               && !SelectedPlayerItem.Item.IsEquipped
               && !SelectedPlayerItem.Item.IsQuestItem;
    }

    private void RefreshInventories()
    {
        ShopItems.Clear();
        foreach (var shopItem in Shop.Inventory)
        {
            var buyPrice = _shopService.GetBuyPrice(Shop, shopItem.Item);
            ShopItems.Add(new ShopItemViewModel(shopItem.Item, buyPrice, 0, isPlayerItem: false));
        }

        PlayerItems.Clear();
        foreach (var item in _gameSession.Player.Inventory.Items)
        {
            if (!item.IsEquipped && !item.IsQuestItem)
            {
                var sellPrice = _shopService.GetSellPrice(Shop, item);
                PlayerItems.Add(new ShopItemViewModel(item, 0, sellPrice, isPlayerItem: true));
            }
        }
    }

    private string BuildSelectedItemStats()
    {
        var item = SelectedShopItem?.Item ?? SelectedPlayerItem?.Item;
        if (item is null) return "";

        var stats = new List<string>();

        if (!string.IsNullOrEmpty(item.Damage))
            stats.Add($"âš” Damage: {item.Damage}");
        if (item.AttackBonus != 0)
            stats.Add($"Attack: +{item.AttackBonus}");
        if (item.DefenseBonus != 0)
            stats.Add($"Defense: +{item.DefenseBonus}");
        
        stats.Add($"Type: {item.ItemType}");

        return string.Join(" | ", stats);
    }

    private void ClearTransactionMessage()
    {
        TransactionMessage = null;
    }
}
```

### ShopItemViewModel

**File:** `src/Presentation/RuneAndRust.Avalonia/ViewModels/ShopItemViewModel.cs`

```csharp
namespace RuneAndRust.Avalonia.ViewModels;

/// <summary>
/// ViewModel for a single item in the shop display.
/// </summary>
public partial class ShopItemViewModel : ViewModelBase
{
    public Item Item { get; }
    public int BuyPrice { get; }
    public int SellPrice { get; }
    public bool IsPlayerItem { get; }

    [ObservableProperty]
    private bool _isSelected;

    public string Icon => GetItemIcon(Item.Category);
    public string Name => Item.Name;
    public string BuyPriceText => $"{BuyPrice}g";
    public string SellPriceText => $"{SellPrice}g";

    public ShopItemViewModel(Item item, int buyPrice, int sellPrice, bool isPlayerItem)
    {
        Item = item;
        BuyPrice = buyPrice;
        SellPrice = sellPrice;
        IsPlayerItem = isPlayerItem;
    }

    private static string GetItemIcon(ItemCategory category) => category switch
    {
        ItemCategory.Weapon => "âš”",
        ItemCategory.Armor => "ğŸ›¡",
        ItemCategory.Accessory => "ğŸ’",
        ItemCategory.Consumable => "ğŸ§ª",
        ItemCategory.Quest => "ğŸ“œ",
        ItemCategory.Misc => "ğŸ“¦",
        _ => "â€¢"
    };
}
```

---

## 8. Transaction Handling

### TransactionResult

**File:** `src/Core/RuneAndRust.Application/DTOs/TransactionResult.cs`

```csharp
namespace RuneAndRust.Application.DTOs;

/// <summary>
/// Result of a shop transaction (buy or sell).
/// </summary>
/// <param name="Success">Whether the transaction succeeded.</param>
/// <param name="FailureReason">The reason for failure, if any.</param>
/// <param name="GoldChange">The change in gold (positive for sell, negative for buy).</param>
public record TransactionResult(
    bool Success,
    string? FailureReason = null,
    int? GoldChange = null
)
{
    /// <summary>
    /// Creates a successful transaction result.
    /// </summary>
    public static TransactionResult Succeeded(int goldChange) => 
        new(true, null, goldChange);

    /// <summary>
    /// Creates a failed transaction result.
    /// </summary>
    public static TransactionResult Failed(string reason) => 
        new(false, reason, null);

    /// <summary>
    /// Common failure: Not enough gold.
    /// </summary>
    public static TransactionResult InsufficientGold() => 
        Failed("Insufficient gold!");

    /// <summary>
    /// Common failure: Inventory is full.
    /// </summary>
    public static TransactionResult InventoryFull() => 
        Failed("Inventory is full!");

    /// <summary>
    /// Common failure: Cannot sell equipped items.
    /// </summary>
    public static TransactionResult CannotSellEquipped() => 
        Failed("Cannot sell equipped items!");

    /// <summary>
    /// Common failure: Cannot sell quest items.
    /// </summary>
    public static TransactionResult CannotSellQuestItem() => 
        Failed("Cannot sell quest items!");
}
```

---

## 9. Styles

**File:** `src/Presentation/RuneAndRust.Avalonia/Styles/ShopWindowStyles.axaml`

```xml
<Styles xmlns="https://github.com/avaloniaui"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml">
    
    <!-- Shop Header -->
    <Style Selector="Border.shop-header">
        <Setter Property="Background" Value="{StaticResource SurfaceDarkBrush}" />
        <Setter Property="BorderThickness" Value="0,0,0,1" />
        <Setter Property="BorderBrush" Value="{StaticResource BorderBrush}" />
    </Style>
    
    <Style Selector="TextBlock.shop-title">
        <Setter Property="FontSize" Value="18" />
        <Setter Property="FontWeight" Value="SemiBold" />
        <Setter Property="HorizontalAlignment" Value="Center" />
    </Style>
    
    <!-- Inventory Panel -->
    <Style Selector="Border.inventory-panel">
        <Setter Property="Background" Value="{StaticResource SurfaceBrush}" />
        <Setter Property="BorderBrush" Value="{StaticResource BorderBrush}" />
        <Setter Property="BorderThickness" Value="1" />
        <Setter Property="CornerRadius" Value="4" />
    </Style>
    
    <Style Selector="TextBlock.panel-title">
        <Setter Property="FontSize" Value="12" />
        <Setter Property="FontWeight" Value="SemiBold" />
        <Setter Property="Foreground" Value="{StaticResource PrimaryBrush}" />
    </Style>
    
    <!-- Details Panel -->
    <Style Selector="Border.details-panel">
        <Setter Property="Background" Value="{StaticResource SurfaceDarkBrush}" />
        <Setter Property="BorderBrush" Value="{StaticResource BorderBrush}" />
        <Setter Property="BorderThickness" Value="1" />
        <Setter Property="CornerRadius" Value="4" />
        <Setter Property="MinHeight" Value="120" />
    </Style>
    
    <Style Selector="TextBlock.selected-name">
        <Setter Property="FontSize" Value="14" />
        <Setter Property="FontWeight" Value="Bold" />
    </Style>
    
    <Style Selector="TextBlock.item-stats">
        <Setter Property="FontSize" Value="12" />
        <Setter Property="Foreground" Value="{StaticResource ForegroundBrush}" />
    </Style>
    
    <Style Selector="TextBlock.item-description">
        <Setter Property="FontSize" Value="12" />
        <Setter Property="Foreground" Value="{StaticResource MutedBrush}" />
        <Setter Property="FontStyle" Value="Italic" />
    </Style>
    
    <!-- Comparison Panel -->
    <Style Selector="Border.comparison-panel">
        <Setter Property="Background" Value="{StaticResource SurfaceBrush}" />
        <Setter Property="BorderBrush" Value="{StaticResource BorderBrush}" />
        <Setter Property="BorderThickness" Value="1" />
        <Setter Property="CornerRadius" Value="4" />
    </Style>
    
    <Style Selector="TextBlock.compared-to">
        <Setter Property="FontWeight" Value="SemiBold" />
    </Style>
    
    <Style Selector="TextBlock.comparison-label">
        <Setter Property="Foreground" Value="{StaticResource MutedBrush}" />
        <Setter Property="Width" Value="60" />
    </Style>
    
    <Style Selector="TextBlock.comparison-values">
        <Setter Property="FontSize" Value="12" />
    </Style>
    
    <!-- Shop Footer -->
    <Style Selector="Border.shop-footer">
        <Setter Property="Background" Value="{StaticResource SurfaceDarkBrush}" />
        <Setter Property="BorderThickness" Value="0,1,0,0" />
        <Setter Property="BorderBrush" Value="{StaticResource BorderBrush}" />
    </Style>
    
    <Style Selector="TextBlock.gold-label">
        <Setter Property="FontSize" Value="14" />
        <Setter Property="VerticalAlignment" Value="Center" />
    </Style>
    
    <Style Selector="TextBlock.gold-amount">
        <Setter Property="FontSize" Value="16" />
        <Setter Property="FontWeight" Value="Bold" />
        <Setter Property="Foreground" Value="Gold" />
        <Setter Property="VerticalAlignment" Value="Center" />
    </Style>
    
    <Style Selector="TextBlock.transaction-message">
        <Setter Property="FontSize" Value="12" />
    </Style>
    
    <!-- Price Text -->
    <Style Selector="TextBlock.price">
        <Setter Property="FontWeight" Value="SemiBold" />
        <Setter Property="Foreground" Value="Gold" />
    </Style>
    
    <!-- Selection Indicator -->
    <Style Selector="TextBlock.selection-indicator">
        <Setter Property="Foreground" Value="{StaticResource AccentBrush}" />
        <Setter Property="FontWeight" Value="Bold" />
    </Style>
    
    <!-- Separator -->
    <Style Selector="Border.separator">
        <Setter Property="Height" Value="1" />
        <Setter Property="Background" Value="{StaticResource BorderBrush}" />
    </Style>
    
    <!-- Buy Button -->
    <Style Selector="Button.buy-button">
        <Setter Property="Background" Value="{StaticResource SuccessBrush}" />
        <Setter Property="Foreground" Value="White" />
        <Setter Property="Padding" Value="16,8" />
        <Setter Property="FontWeight" Value="SemiBold" />
    </Style>
    
    <Style Selector="Button.buy-button:disabled">
        <Setter Property="Opacity" Value="0.5" />
    </Style>
    
    <!-- Sell Button -->
    <Style Selector="Button.sell-button">
        <Setter Property="Background" Value="{StaticResource WarningBrush}" />
        <Setter Property="Foreground" Value="White" />
        <Setter Property="Padding" Value="16,8" />
        <Setter Property="FontWeight" Value="SemiBold" />
    </Style>
    
    <Style Selector="Button.sell-button:disabled">
        <Setter Property="Opacity" Value="0.5" />
    </Style>
    
    <!-- Close Button -->
    <Style Selector="Button.close-button">
        <Setter Property="Padding" Value="16,8" />
    </Style>
    
</Styles>
```

---

## 10. Data Model Changes

### New Types

| Type | Layer | Description |
|------|-------|-------------|
| `ShopWindow` | Presentation | Shop window |
| `ShopItemControl` | Presentation | Item list control |
| `ShopWindowViewModel` | Presentation | Shop logic ViewModel |
| `ShopItemViewModel` | Presentation | Item display ViewModel |
| `ItemComparisonViewModel` | Presentation | Stat comparison ViewModel |
| `ComparisonLine` | Presentation | Comparison line record |
| `ComparisonResult` | Presentation | Comparison result enum |
| `TransactionResult` | Application | Transaction outcome DTO |

### Extended Interfaces

| Interface | New Method | Description |
|-----------|------------|-------------|
| `IShopService` | `GetBuyPrice(Shop, Item)` | Gets buy price for item |
| `IShopService` | `GetSellPrice(Shop, Item)` | Gets sell price for item |
| `IGameSessionService` | `CurrentShop` | Gets current shop context |
| `Player` | `GetEquippedItem(EquipSlot)` | Gets item in slot for comparison |

---

## 11. Logging Specifications

| Component | Level | Events |
|-----------|-------|--------|
| `ShopWindowViewModel` | Debug | Shop loaded, item selected |
| `ShopWindowViewModel` | Information | Item purchased, item sold |
| `ShopWindowViewModel` | Warning | Purchase failed, sale failed |
| `ShopWindowViewModel` | Debug | Window closed |
| `ShopService` | Information | Transaction completed |
| `ShopService` | Warning | Transaction rejected |

### Log Message Examples

```
Debug: ShopWindowViewModel initialized with 150g
Debug: Loaded shop: Old Tom with 7 items
Debug: Selected shop item: Iron Sword
Information: Purchased item: Iron Sword for 50g
Warning: Purchase failed: Insufficient gold!
Information: Sold item: Rusty Dagger for 8g
Warning: Sale failed: Cannot sell equipped items!
Debug: Shop window closed
```

---

## 12. Unit Testing Requirements

| Feature | Tests |
|---------|-------|
| Shop loading | 2 |
| Item selection (shop/player) | 2 |
| Buy transaction success | 1 |
| Buy transaction failures | 2 |
| Sell transaction success | 1 |
| Sell transaction failures | 2 |
| Item comparison generation | 2 |
| **Total** | **~12** |

### Test Specifications

**File:** `tests/RuneAndRust.Avalonia.UnitTests/ViewModels/ShopWindowViewModelTests.cs`

```csharp
[TestFixture]
public class ShopWindowViewModelTests
{
    [Test]
    public void LoadShop_PopulatesShopItems();

    [Test]
    public void LoadShop_PopulatesPlayerItems();

    [Test]
    public void SelectShopItem_UpdatesSelectedShopItem();

    [Test]
    public void SelectPlayerItem_UpdatesSelectedPlayerItem();

    [Test]
    public void Buy_WhenSufficientGold_DeductsGoldAndAddsItem();

    [Test]
    public void Buy_WhenInsufficientGold_ShowsError();

    [Test]
    public void Buy_WhenInventoryFull_ShowsError();

    [Test]
    public void Sell_WhenValid_AddsGoldAndRemovesItem();

    [Test]
    public void Sell_WhenItemEquipped_ShowsError();

    [Test]
    public void Sell_WhenQuestItem_ShowsError();

    [Test]
    public void UpdateComparison_WithEquippedItem_CreatesComparison();

    [Test]
    public void UpdateComparison_WithNoEquipped_ClearsComparison();
}
```

---

## 13. Use Cases

### UC-082a-001: Open Shop
**Actor:** Player
**Precondition:** Player is interacting with a merchant NPC
**Flow:** Player clicks "Shop" dialogue option â†’ Shop window opens â†’ Shop inventory displayed
**Postcondition:** Shop window visible with merchant's items

### UC-082a-002: Browse Shop Inventory
**Actor:** Player
**Flow:** Player clicks item in shop list â†’ Item details shown â†’ Comparison vs equipped shown (if applicable)

### UC-082a-003: Purchase Item
**Actor:** Player
**Precondition:** Player has sufficient gold, inventory not full
**Flow:** Player selects shop item â†’ Clicks "BUY" â†’ Gold deducted â†’ Item added to inventory â†’ Success message shown

### UC-082a-004: Purchase Item - Insufficient Gold
**Actor:** Player
**Precondition:** Player gold < item price
**Flow:** Player selects item â†’ BUY button disabled or shows error â†’ "Insufficient gold!" message

### UC-082a-005: Purchase Item - Full Inventory
**Actor:** Player
**Precondition:** Player inventory at max capacity
**Flow:** Player tries to buy â†’ "Inventory is full!" message

### UC-082a-006: Sell Item
**Actor:** Player
**Precondition:** Player has unequipped, non-quest items
**Flow:** Player selects item from "Your Inventory" â†’ Clicks "SELL" â†’ Item removed â†’ Gold added â†’ Success message

### UC-082a-007: Cannot Sell Equipped Item
**Actor:** Player
**Flow:** (Equipped items not shown in sellable list) â†’ SELL button disabled

### UC-082a-008: Compare Items
**Actor:** Player
**Flow:** Player selects weapon in shop â†’ Comparison shows vs. currently equipped weapon â†’ â–²/â–¼ indicators show better/worse stats

---

## 14. Deliverable Checklist

### Windows
- [ ] `Views/ShopWindow.axaml` created
- [ ] `Views/ShopWindow.axaml.cs` created

### Controls
- [ ] `Controls/ShopItemControl.cs` created
- [ ] `Controls/ShopItemControl.axaml` created

### ViewModels
- [ ] `ViewModels/ShopWindowViewModel.cs` created
- [ ] `ViewModels/ShopItemViewModel.cs` created
- [ ] `ViewModels/ItemComparisonViewModel.cs` created
- [ ] `ViewModels/ComparisonLine.cs` created

### DTOs
- [ ] `DTOs/TransactionResult.cs` created (if not existing)

### Styles
- [ ] `Styles/ShopWindowStyles.axaml` created

### Integration
- [ ] Shop window opened from dialogue [SHOP] action
- [ ] TooltipHelper integration for item tooltips

### Testing
- [ ] ~12 unit tests implemented
- [ ] All tests passing

---

## 15. Acceptance Criteria

### Functional
- [ ] Shop window shows merchant name
- [ ] Shop inventory displays available items
- [ ] Player inventory displays sellable items
- [ ] Selecting shop item shows details
- [ ] Item comparison shows vs equipped
- [ ] Better/worse indicators (â–²/â–¼) display correctly
- [ ] Buy button purchases selected item
- [ ] Gold deducted on purchase
- [ ] Sell button sells selected item
- [ ] Gold added on sale
- [ ] Insufficient gold shows error
- [ ] Full inventory shows error
- [ ] Cannot sell equipped items
- [ ] Cannot sell quest items
- [ ] Transaction messages display

### Quality
- [ ] Build succeeds with 0 errors
- [ ] Build succeeds with 0 warnings
- [ ] ~12 unit tests pass
- [ ] XML documentation on all public types
- [ ] Styles consistent with application theme

---

## 16. Dependencies

### Required from v0.8.1c
- `ITooltipService` for item tooltips
- `TooltipHelper` attached properties

### Required from Domain Layer
- `Shop` entity with inventory
- `ShopItem` with pricing
- `Item` entity with stats
- `ItemCategory` enum

### Required from Application Layer
- `IShopService` with buy/sell logic
- `IGameSessionService` for player data

### Provides to v0.8.2b
- Shop window reference for dialogue [SHOP] action
- Transaction result patterns

---

## 17. Future Considerations

### Deferred to Later Versions
- **Haggling/Bargaining**: Negotiate prices with NPCs
- **Bulk Buy/Sell**: Select multiple items at once
- **Shop Restocking**: Limited stock that replenishes
- **Reputation Discounts**: Prices based on faction standing
- **Item Previews**: Visual preview of equipment on character
- **Buyback**: Repurchase recently sold items

### Out of Scope
- Dynamic pricing based on supply/demand
- Item crafting at shops
- Shop creation/management

---

*Document Version: 1.0*
*Last Updated: 2026-01-10*
