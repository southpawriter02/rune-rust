# Design Specification: v0.20.2b - Tier 2 Abilities (Rúnasmiðr)

**Version:** v0.20.2b
**Status:** Design Phase
**Last Updated:** 2026-01-28
**Target Tests:** ~8 unit and integration tests
**Specialization:** Rúnasmiðr (Runesmith)
**Theme:** Empowered Crafting & Strategic Traps

---

## Table of Contents

1. [Executive Summary](#1-executive-summary)
2. [Feature Overview](#2-feature-overview)
3. [Architecture Diagrams](#3-architecture-diagrams)
4. [User Stories](#4-user-stories)
5. [Domain Layer Specifications](#5-domain-layer-specifications)
6. [Application Layer Specifications](#6-application-layer-specifications)
7. [Infrastructure Layer Specifications](#7-infrastructure-layer-specifications)
8. [Empowered Inscription Ability](#8-empowered-inscription-ability)
9. [Runic Trap Ability](#9-runic-trap-ability)
10. [Dvergr Techniques Ability](#10-dvergr-techniques-ability)
11. [Decision Trees and Flow Diagrams](#11-decision-trees-and-flow-diagrams)
12. [Configuration Files](#12-configuration-files)
13. [Code Examples](#13-code-examples)
14. [Logging Specifications](#14-logging-specifications)
15. [Unit Testing Requirements](#15-unit-testing-requirements)
16. [Deliverable Checklist](#16-deliverable-checklist)
17. [Acceptance Criteria](#17-acceptance-criteria)
18. [Dependencies](#18-dependencies)
19. [Deferrals and Future Considerations](#19-deferrals-and-future-considerations)

---

## 1. Executive Summary

Version 0.20.2b implements the three **Tier 2 Abilities** of the Rúnasmiðr specialization, expanding the runesmith's offensive and crafting-focused capabilities. This phase introduces elemental damage enhancements, tactical trap placement, and significant crafting cost reductions.

### Key Deliverables

| Category | Count | Details |
|----------|-------|---------|
| **Domain Value Objects** | 2 | EmpoweredRune, RunicTrap |
| **Domain Enums** | 1 | TrapTriggerType |
| **Application Services** | 1 | Tier 2 ability handlers (extensions) |
| **Ability Implementations** | 3 | Empowered Inscription, Runic Trap, Dvergr Techniques |
| **Crafting Integration** | 1 | Cost reduction modifier system |
| **Configuration Updates** | 1 | abilities.json Tier 2 entries |
| **Unit Tests** | ~8 | Comprehensive test coverage |

### Tier 2 Identity

| Ability | Cost | Type | Effect |
|---------|------|------|--------|
| **Empowered Inscription** | 4 AP, 2 Charges | Active | +1d6 elemental damage (10 turns) |
| **Runic Trap** | 3 AP, 2 Charges | Active | 3d6 damage when triggered (max 3 active) |
| **Dvergr Techniques** | Passive | Passive | 20% reduction to crafting costs/time |

**Unlock Requirement:** 8 PP invested in Rúnasmiðr tree
**PP Cost per Ability:** 4 PP each

---

## 2. Feature Overview

### 2.1 Empowered Inscription

**Purpose:** Enhanced rune inscription that adds elemental damage to weapons.

**Key Characteristics:**
- Targets weapons only (not armor)
- Adds 1d6 damage of chosen element
- Four element choices: Fire, Cold, Lightning, Aetheric
- Stacks with base Inscribe Rune (+2 damage + 1d6 elemental)
- Lasts 10 turns
- Cost: 4 AP, 2 Rune Charges

**Elemental Options:**
| Element | Damage Type | Visual Effect | Notes |
|---------|-------------|---------------|-------|
| Fire | Fire | Flames flicker along blade | Triggers fire vulnerabilities |
| Cold | Cold | Frost rimes the edge | Slows creatures, weak to heat |
| Lightning | Lightning | Sparks crackle | Can trigger chain effects |
| Aetheric | Aetheric | Purple glow pulses | Disrupts magical defenses |

### 2.2 Runic Trap

**Purpose:** Place triggered traps that deal area damage when enemies enter.

**Key Characteristics:**
- Place in adjacent space
- Invisible to enemies (DC 14 Perception to detect)
- Triggers when enemy enters the space
- Deals 3d6 damage to triggering creature
- Maximum 3 active traps at once
- Lasts 1 hour if not triggered
- Cost: 3 AP, 2 Rune Charges

**Placement Rules:**
- Cannot place on occupied spaces
- Cannot place in water/unstable terrain
- Allies see trap positions (don't trigger)
- Owner sees trap icons on tactical display
- Cannot be moved after placement
- Destroyed when triggered or expires

### 2.3 Dvergr Techniques

**Purpose:** Passive ability reducing crafting costs and time through Dvergr mastery.

**Key Characteristics:**
- Applies to all crafting material costs: -20%
- Applies to crafting time: -20% (20% faster)
- Stacks with other crafting bonuses additively
- Does NOT affect Rune Charge costs
- Affects consumable and equipment crafting
- Always active when ability unlocked
- Cost: 0 AP (Passive)

---

## 3. Architecture Diagrams

### 3.1 Domain Layer - Tier 2 Objects

```
┌──────────────────────────────────────────────────────────────┐
│         v0.20.2b Rúnasmiðr Domain Layer Additions           │
├──────────────────────────────────────────────────────────────┤
│                                                               │
│  ┌────────────────────┐  ┌─────────────────────┐             │
│  │ EmpoweredRune      │  │ TrapTriggerType     │             │
│  ├────────────────────┤  ├─────────────────────┤             │
│  │ -RuneId            │  │ • Movement (entry)  │             │
│  │ -TargetItemId      │  │ • Proximity         │             │
│  │ -ElementalType     │  │ • Timed             │             │
│  │ -BonusDice("1d6")  │  └─────────────────────┘             │
│  │ -Duration          │                                       │
│  │ +GetDamageRoll()   │                                       │
│  │ +IsExpired()       │                                       │
│  │ +GetElementDisplay()                                       │
│  └────────────────────┘                                       │
│                                                               │
│  ┌────────────────────────────────────────┐                  │
│  │ RunicTrap                              │                  │
│  ├────────────────────────────────────────┤                  │
│  │ -TrapId: Guid                          │                  │
│  │ -OwnerId: Guid                         │                  │
│  │ -Position: (X, Y, Z)                   │                  │
│  │ -Damage: "3d6"                         │                  │
│  │ -DetectionDc: 14                       │                  │
│  │ -CreatedAt: DateTime                   │                  │
│  │ -ExpiresAt: DateTime                   │                  │
│  │ -IsTriggered: bool                     │                  │
│  │ +Trigger(targetId): TrapTriggerResult  │                  │
│  │ +IsExpired(): bool                     │                  │
│  │ +IsVisibleTo(characterId): bool        │                  │
│  │ +CanBeDetected(): bool                 │                  │
│  │ +GetRemainingTime(): TimeSpan          │                  │
│  └────────────────────────────────────────┘                  │
│                                                               │
└──────────────────────────────────────────────────────────────┘
```

### 3.2 Application Layer - Tier 2 Services

```
┌──────────────────────────────────────────────────────────────┐
│         v0.20.2b Application Layer Extensions                │
├──────────────────────────────────────────────────────────────┤
│                                                               │
│  IRúnasmiðrAbilityService (extended from v0.20.2a)           │
│  ┌──────────────────────────────────────────────────────┐    │
│  │ + ExecuteEmpoweredInscription(charId, itemId,        │    │
│  │     element): AbilityExecutionResult                 │    │
│  │ + ExecuteRunicTrap(charId, position):                │    │
│  │     AbilityExecutionResult                           │    │
│  │ + GetActiveTraps(charId): IReadOnlyList<RunicTrap>  │    │
│  │ + TriggerTrap(trapId, targetId): TrapTriggerResult  │    │
│  │ + CanPlaceTrap(position): bool                       │    │
│  └──────────────────────────────────────────────────────┘    │
│                              │                                │
│  ICraftingCostService (new integration point)                │
│  ┌──────────────────────────────────────────────────────┐    │
│  │ + ApplyDvergrTechniques(characterId, originalCost):  │    │
│  │     int (reduced cost)                               │    │
│  │ + ApplyDvergrTechniquesTime(originalTime):           │    │
│  │     int (reduced time in minutes)                    │    │
│  │ + GetCostReductionPercentage(): decimal (0.20)       │    │
│  └──────────────────────────────────────────────────────┘    │
│                              │                                │
│  Implementation Classes                                       │
│  ├── EmpoweredInscriptionHandler                             │
│  ├── RunicTrapHandler                                        │
│  ├── TrapTriggerExecutor                                     │
│  └── DvergrTechniquesIntegration                             │
│                                                               │
└──────────────────────────────────────────────────────────────┘
```

### 3.3 Crafting Cost Integration

```
Crafting System Flow (with Dvergr Techniques):

┌────────────────────┐
│ Request Craft      │ Original Cost: 50 materials
└─────────┬──────────┘
          │
          ▼
┌──────────────────────────────┐
│ Check: Character has         │
│ Dvergr Techniques?           │
└──────────┬───────────┬───────┘
    YES    │           │    NO
           │           │
           ▼           ▼
    ┌──────────────┐  ┌────────────────┐
    │ Apply 20%    │  │ Use original   │
    │ reduction    │  │ cost (50)      │
    │ New: 40      │  └────────────────┘
    └──────┬───────┘         │
           │                 │
           └────────┬────────┘
                    │
                    ▼
         ┌──────────────────┐
         │ Begin Crafting   │
         │ (with reduced    │
         │ cost/time)       │
         └──────────────────┘
```

---

## 4. User Stories

### User Story 1: Runesmith Adds Elemental Damage to Weapon

**As a** Rúnasmiðr character in mid-level combat
**I want to** empower my inscribed weapon with elemental damage
**So that** I can trigger elemental vulnerabilities and deal more specialized damage

**Acceptance Criteria:**
- Character must have unlocked Empowered Inscription (4 PP cost)
- Ability costs 4 AP and 2 Rune Charges
- Can choose from 4 elemental types (Fire, Cold, Lightning, Aetheric)
- Adds 1d6 damage of chosen element
- Stacks with base +2 damage from Inscribe Rune
- Effect lasts 10 turns
- Can be reapplied to same or different weapon
- Only one empowered inscription per weapon

### User Story 2: Runesmith Places Tactical Trap

**As a** Rúnasmiðr character preparing for ambush
**I want to** place invisible runic traps in strategic locations
**So that** enemies trigger them and take massive damage

**Acceptance Criteria:**
- Ability costs 3 AP and 2 Rune Charges
- Trap is invisible (DC 14 Perception to detect)
- Trap deals 3d6 damage when triggered
- Maximum 3 active traps at once
- Can place in adjacent spaces only
- Cannot place on occupied/water/unstable terrain
- Allies see traps and don't trigger them
- Traps expire after 1 hour if not triggered
- Destroyed when triggered (one use only)

### User Story 3: Runesmith Reduces Crafting Costs

**As a** Rúnasmiðr character focused on crafting
**I want to** get discounts on all my crafting projects
**So that** I can craft more items with limited resources

**Acceptance Criteria:**
- Passive ability auto-applies when unlocked
- All crafting material costs reduced by 20%
- Crafting time reduced by 20% (20% faster)
- Applies to consumables and equipment equally
- Does NOT apply to Rune Charge costs
- Stacks additively with other crafting bonuses (if any)
- Discount is transparent in crafting UI
- Works retroactively for in-progress crafts when unlocked

### User Story 4: Party Coordinates Trap Placement

**As a** part of a coordinated party
**I want to** place multiple traps while my allies understand their positions
**So that** we can create effective kill zones without friendly fire

**Acceptance Criteria:**
- Owner sees all trap positions clearly on map
- Allies receive notification of trap locations
- Traps don't trigger for allies passing through
- Enemies have no information about trap positions
- Owner can describe trap placement to party
- Traps are distinct and can be referenced by position
- UI shows trap count: "Traps: 2/3 active"

---

## 5. Domain Layer Specifications

### 5.1 EmpoweredRune Value Object

**Purpose:** Represents a weapon rune enhanced with elemental damage.

**Properties:**
- `RuneId: Guid` - Unique identifier
- `TargetItemId: Guid` - ID of the weapon
- `ElementalType: DamageType` - Fire, Cold, Lightning, or Aetheric
- `BonusDice: string` - Always "1d6"
- `Duration: int` - Remaining turns
- `CreatedAt: DateTime` - Creation timestamp
- `OriginalDuration: int` - Base duration (10 turns)

**Methods:**

```csharp
/// <summary>
/// Rolls the elemental damage dice for this rune.
/// </summary>
public DiceRoll GetDamageRoll()
{
    return new DiceRoll(
        diceType: "1d6",
        damageType: ElementalType,
        source: "Empowered Inscription");
}

/// <summary>
/// Advances the rune's countdown by one turn.
/// </summary>
public void Tick()
{
    if (Duration > 0)
        Duration--;
}

/// <summary>
/// Determines if the rune has expired.
/// </summary>
public bool IsExpired() => Duration <= 0;

/// <summary>
/// Gets a human-readable display of the elemental type.
/// </summary>
public string GetElementDisplay() => ElementalType switch
{
    DamageType.Fire => "Fire (flames flicker)",
    DamageType.Cold => "Cold (frost rime)",
    DamageType.Lightning => "Lightning (sparks crackle)",
    DamageType.Aetheric => "Aetheric (purple glow)",
    _ => "Unknown"
};

/// <summary>
/// Gets total bonus damage (1d6 on average, ~3.5 damage).
/// </summary>
public decimal GetAverageDamage() => 3.5m;

/// <summary>
/// Gets combined effect description with base and elemental bonuses.
/// </summary>
public string GetCombinedEffectDisplay() =>
    $"+2 damage + 1d6 {GetElementDisplay()} damage (Fire triggers vulnerability)";
```

### 5.2 RunicTrap Value Object

**Purpose:** Represents a trap placed on the battlefield.

**Properties:**
- `TrapId: Guid` - Unique identifier
- `OwnerId: Guid` - Character who placed trap
- `Position: Position` - X, Y, Z coordinates
- `Damage: string` - Always "3d6"
- `DetectionDc: int` - Always 14
- `CreatedAt: DateTime` - When placed
- `ExpiresAt: DateTime` - When expires (1 hour later)
- `IsTriggered: bool` - Has trap been activated
- `TriggeredBy: Guid?` - Character who triggered it
- `TriggeredAt: DateTime?` - When triggered

**Methods:**

```csharp
/// <summary>
/// Triggers the trap when a creature enters the space.
/// </summary>
/// <param name="targetId">Character triggering the trap</param>
/// <returns>Result including damage dealt</returns>
public TrapTriggerResult Trigger(Guid targetId)
{
    if (IsTriggered || IsExpired())
        return new TrapTriggerResult(success: false, message: "Trap already triggered or expired");

    IsTriggered = true;
    TriggeredBy = targetId;
    TriggeredAt = DateTime.UtcNow;

    var damageRoll = new DiceRoll("3d6");
    var damage = damageRoll.Roll();

    return new TrapTriggerResult(
        success: true,
        damageDealt: damage,
        targetId: targetId);
}

/// <summary>
/// Determines if the trap has expired.
/// </summary>
public bool IsExpired() => DateTime.UtcNow >= ExpiresAt;

/// <summary>
/// Determines if a specific character can see this trap.
/// Only owner and allies can see trap positions.
/// </summary>
public bool IsVisibleTo(Guid characterId) => characterId == OwnerId; // Extended in future for party logic

/// <summary>
/// Determines if trap can be detected via Perception check.
/// </summary>
public bool CanBeDetected()
{
    return !IsTriggered && !IsExpired();
}

/// <summary>
/// Gets remaining time before expiration.
/// </summary>
public TimeSpan GetRemainingTime() => ExpiresAt - DateTime.UtcNow;

/// <summary>
/// Gets remaining time formatted for display.
/// </summary>
public string GetRemainingTimeDisplay()
{
    var remaining = GetRemainingTime();
    if (remaining.TotalMinutes < 1)
        return $"{(int)remaining.TotalSeconds}s";
    if (remaining.TotalHours < 1)
        return $"{(int)remaining.TotalMinutes}m";
    return $"{remaining.Hours}h {remaining.Minutes}m";
}
```

### 5.3 TrapTriggerType Enum

```csharp
/// <summary>
/// Describes how a trap is triggered.
/// </summary>
public enum TrapTriggerType
{
    /// <summary>Triggers when creature enters the space</summary>
    Movement = 1,

    /// <summary>Triggers when creature moves within adjacent space</summary>
    Proximity = 2,

    /// <summary>Triggers after a set delay (future enhancement)</summary>
    Timed = 3
}
```

### 5.4 TrapTriggerResult Value Object

```csharp
/// <summary>
/// Result of attempting to trigger a trap.
/// </summary>
public record TrapTriggerResult
{
    public bool Success { get; init; }
    public string Message { get; init; }
    public int DamageDealt { get; init; }
    public Guid? TargetId { get; init; }
    public TrapId? TrapId { get; init; }
}
```

---

## 6. Application Layer Specifications

### 6.1 EmpoweredInscriptionHandler

```csharp
/// <summary>
/// Handler for Empowered Inscription ability execution.
/// </summary>
public class EmpoweredInscriptionHandler : IAbilityHandler
{
    private readonly ICharacterRepository _characterRepository;
    private readonly IEquipmentRepository _equipmentRepository;
    private readonly IRuneChargeService _runeChargeService;
    private readonly ILogger _logger;

    public EmpoweredInscriptionHandler(
        ICharacterRepository characterRepository,
        IEquipmentRepository equipmentRepository,
        IRuneChargeService runeChargeService,
        ILogger logger)
    {
        _characterRepository = characterRepository;
        _equipmentRepository = equipmentRepository;
        _runeChargeService = runeChargeService;
        _logger = logger;
    }

    /// <summary>
    /// Executes Empowered Inscription ability.
    /// </summary>
    /// <remarks>
    /// XML Documentation for Empowered Inscription:
    /// - Enhanced version of Inscribe Rune for weapons only
    /// - Choose elemental type: Fire, Cold, Lightning, or Aetheric
    /// - Adds 1d6 damage of chosen element to all attacks
    /// - Stacks with base Inscribe Rune bonus (+2 damage + 1d6 elemental)
    /// - Elemental damage can trigger vulnerabilities/resistances
    /// - Duration: 10 turns
    /// - Cost: 4 AP, 2 Rune Charges
    /// - Requires 4 PP to unlock (Tier 2 ability)
    /// </remarks>
    public AbilityExecutionResult Execute(AbilityExecutionContext context)
    {
        if (context == null)
            throw new ArgumentNullException(nameof(context));

        var character = _characterRepository.GetById(context.CharacterId);
        if (character == null)
            return new AbilityExecutionResult(success: false, message: "Character not found");

        // Check Rune Charges (need 2)
        if (!_runeChargeService.CanAfford(context.CharacterId, 2))
        {
            _logger.LogWarning($"Character {context.CharacterId} lacks rune charges for Empowered Inscription");
            return new AbilityExecutionResult(success: false, message: "Insufficient Rune Charges (need 2)");
        }

        // Get target item
        if (!context.Parameters.TryGetValue("targetItemId", out var targetIdObj))
            return new AbilityExecutionResult(success: false, message: "Target item not specified");

        var targetItemId = (Guid)targetIdObj;
        var targetItem = _equipmentRepository.GetById(targetItemId);

        if (targetItem == null)
            return new AbilityExecutionResult(success: false, message: "Target item not found");

        // Validate weapon
        if (targetItem.ItemType != ItemType.Weapon)
            return new AbilityExecutionResult(success: false, message: "Empowered Inscription targets weapons only");

        // Get element choice
        if (!context.Parameters.TryGetValue("element", out var elementObj))
            return new AbilityExecutionResult(success: false, message: "Element type not specified");

        var element = (DamageType)elementObj;
        if (!IsValidElement(element))
            return new AbilityExecutionResult(success: false, message: "Invalid element type");

        // Spend Rune Charges
        if (!_runeChargeService.TrySpend(context.CharacterId, 2))
            return new AbilityExecutionResult(success: false, message: "Failed to spend Rune Charges");

        // Create empowered rune
        var empoweredRune = new EmpoweredRune(
            runeId: Guid.NewGuid(),
            targetItemId: targetItemId,
            elementalType: element,
            bonusDice: "1d6",
            duration: 10,
            createdAt: DateTime.UtcNow);

        // Remove any existing empowered rune on this item
        var existingEmpowered = character.EmpoweredRunes
            .FirstOrDefault(r => r.TargetItemId == targetItemId);

        if (existingEmpowered != null)
        {
            character.EmpoweredRunes.Remove(existingEmpowered);
            _logger.LogInfo($"Replaced existing empowered rune on {targetItem.ItemName}");
        }

        // Add new rune
        character.EmpoweredRunes.Add(empoweredRune);
        _characterRepository.Update(character);

        _logger.LogInfo(
            $"Character {context.CharacterId} empowered rune on {targetItem.ItemName} with {element}. " +
            $"+1d6 {element} damage for 10 turns");

        return new AbilityExecutionResult(
            success: true,
            message: $"Empowered {targetItem.ItemName} with +1d6 {empoweredRune.GetElementDisplay()} damage (10 turns)",
            resourcesSpent: new Dictionary<string, int> { { "rune-charges", 2 } });
    }

    private bool IsValidElement(DamageType element) =>
        element is DamageType.Fire or DamageType.Cold or DamageType.Lightning or DamageType.Aetheric;
}
```

### 6.2 RunicTrapHandler

```csharp
/// <summary>
/// Handler for Runic Trap ability execution.
/// </summary>
public class RunicTrapHandler : IAbilityHandler
{
    private readonly ICharacterRepository _characterRepository;
    private readonly IRuneChargeService _runeChargeService;
    private readonly ITrapRepository _trapRepository;
    private readonly ITerrainService _terrainService;
    private readonly ILogger _logger;

    public RunicTrapHandler(
        ICharacterRepository characterRepository,
        IRuneChargeService runeChargeService,
        ITrapRepository trapRepository,
        ITerrainService terrainService,
        ILogger logger)
    {
        _characterRepository = characterRepository;
        _runeChargeService = runeChargeService;
        _trapRepository = trapRepository;
        _terrainService = terrainService;
        _logger = logger;
    }

    /// <summary>
    /// Executes Runic Trap ability.
    /// </summary>
    /// <remarks>
    /// XML Documentation for Runic Trap:
    /// - Place rune in adjacent space
    /// - Trap is invisible to enemies (Perception DC 14 to detect)
    /// - Triggers when enemy enters space, deals 3d6 damage
    /// - Maximum 3 traps active at once
    /// - Traps expire after 1 hour if not triggered
    /// - Cannot place on occupied spaces
    /// - Cannot place in water or unstable terrain
    /// - Allies can see and avoid traps
    /// - Trap icon visible on tactical display for owner
    /// - Cost: 3 AP, 2 Rune Charges
    /// - Requires 4 PP to unlock (Tier 2 ability)
    /// </remarks>
    public AbilityExecutionResult Execute(AbilityExecutionContext context)
    {
        if (context == null)
            throw new ArgumentNullException(nameof(context));

        var character = _characterRepository.GetById(context.CharacterId);
        if (character == null)
            return new AbilityExecutionResult(success: false, message: "Character not found");

        // Check Rune Charges (need 2)
        if (!_runeChargeService.CanAfford(context.CharacterId, 2))
        {
            _logger.LogWarning($"Character {context.CharacterId} lacks rune charges for Runic Trap");
            return new AbilityExecutionResult(success: false, message: "Insufficient Rune Charges (need 2)");
        }

        // Get trap position
        if (!context.Parameters.TryGetValue("position", out var positionObj))
            return new AbilityExecutionResult(success: false, message: "Target position not specified");

        var trapPosition = (Position)positionObj;
        var characterPosition = character.Position;

        // Validate position is adjacent
        if (!IsAdjacent(characterPosition, trapPosition))
            return new AbilityExecutionResult(success: false, message: "Position must be adjacent (1 space away)");

        // Validate terrain
        if (!_terrainService.CanPlaceTrap(trapPosition))
            return new AbilityExecutionResult(success: false, message: "Cannot place trap on this terrain");

        // Validate space is unoccupied
        if (!_terrainService.IsSpaceEmpty(trapPosition))
            return new AbilityExecutionResult(success: false, message: "Space is occupied");

        // Check max traps
        var activeTraps = _trapRepository.GetByOwner(context.CharacterId)
            .Where(t => !t.IsTriggered && !t.IsExpired())
            .ToList();

        if (activeTraps.Count >= 3)
        {
            _logger.LogWarning($"Character {context.CharacterId} has maximum traps (3) active");
            return new AbilityExecutionResult(success: false, message: "Maximum 3 traps active at once");
        }

        // Spend Rune Charges
        if (!_runeChargeService.TrySpend(context.CharacterId, 2))
            return new AbilityExecutionResult(success: false, message: "Failed to spend Rune Charges");

        // Create trap
        var trap = new RunicTrap(
            trapId: Guid.NewGuid(),
            ownerId: context.CharacterId,
            position: trapPosition,
            damage: "3d6",
            detectionDc: 14,
            createdAt: DateTime.UtcNow,
            expiresAt: DateTime.UtcNow.AddHours(1));

        _trapRepository.Add(trap);
        _logger.LogInfo(
            $"Character {context.CharacterId} placed Runic Trap at {trapPosition}. " +
            $"Active traps: {activeTraps.Count + 1}/3. Expires in 1 hour.");

        return new AbilityExecutionResult(
            success: true,
            message: $"Placed Runic Trap at {trapPosition}. Deals 3d6 damage when triggered. Active: {activeTraps.Count + 1}/3",
            resourcesSpent: new Dictionary<string, int> { { "rune-charges", 2 } });
    }

    private bool IsAdjacent(Position from, Position to)
    {
        var dx = Math.Abs(from.X - to.X);
        var dy = Math.Abs(from.Y - to.Y);
        var dz = Math.Abs(from.Z - to.Z);

        return (dx + dy + dz == 1) || (dx <= 1 && dy <= 1 && dz == 0 && (dx + dy) == 1);
    }
}
```

### 6.3 TrapTriggerExecutor

```csharp
/// <summary>
/// Handles trap triggering mechanics during movement.
/// </summary>
public class TrapTriggerExecutor : IMovementInterceptor
{
    private readonly ITrapRepository _trapRepository;
    private readonly ICombatService _combatService;
    private readonly INotificationService _notificationService;
    private readonly ILogger _logger;

    public void OnCharacterEntersSpace(Guid characterId, Position position)
    {
        var traps = _trapRepository.GetAtPosition(position)
            .Where(t => !t.IsTriggered && !t.IsExpired())
            .ToList();

        if (!traps.Any())
            return;

        foreach (var trap in traps)
        {
            // Check if trap belongs to this character (ally trap)
            if (trap.OwnerId == characterId)
                continue;

            // Attempt detection
            var detectionCheck = PerformDetectionCheck(characterId, trap.DetectionDc);

            if (detectionCheck)
            {
                _logger.LogInfo($"Character {characterId} detected trap at {position} (DC {trap.DetectionDc})");
                _notificationService.Notify(characterId, $"You detect a runic trap at {position}!");
                continue;
            }

            // Trap triggers
            var result = trap.Trigger(characterId);

            if (result.Success)
            {
                _logger.LogInfo(
                    $"Runic Trap triggered by {characterId} at {position}. Damage dealt: {result.DamageDealt}");

                // Deal damage
                _combatService.DealDamage(
                    targetId: characterId,
                    damage: result.DamageDealt,
                    damageType: DamageType.Physical,
                    source: $"Runic Trap by {trap.OwnerId}");

                _notificationService.NotifyAll($"A runic trap explodes at {position}!");
            }
        }
    }

    private bool PerformDetectionCheck(Guid characterId, int dc)
    {
        var character = _characterRepository.GetById(characterId);
        var perceptionBonus = character.GetSkillBonus(SkillType.Perception);
        var roll = DiceRoller.Roll(d20: true);

        return (roll + perceptionBonus) >= dc;
    }
}
```

### 6.4 DvergrTechniquesIntegration

```csharp
/// <summary>
/// Integrates Dvergr Techniques passive ability with crafting system.
/// </summary>
public class DvergrTechniquesIntegration : ICraftingCostModifier
{
    private readonly ICharacterRepository _characterRepository;
    private readonly ILogger _logger;

    public int ModifyMaterialCost(Guid characterId, int baseCost)
    {
        var character = _characterRepository.GetById(characterId);

        // Check if character has unlocked Dvergr Techniques
        if (!HasDvergrTechniques(character))
            return baseCost;

        // Apply 20% reduction
        var reducedCost = (int)(baseCost * 0.8m);

        _logger.LogInfo(
            $"Applied Dvergr Techniques to crafting for {characterId}. " +
            $"Cost reduced from {baseCost} to {reducedCost}");

        return reducedCost;
    }

    public int ModifyCraftingTime(Guid characterId, int baseTimeMinutes)
    {
        var character = _characterRepository.GetById(characterId);

        if (!HasDvergrTechniques(character))
            return baseTimeMinutes;

        // Apply 20% reduction
        var reducedTime = (int)(baseTimeMinutes * 0.8m);

        _logger.LogInfo(
            $"Applied Dvergr Techniques time reduction for {characterId}. " +
            $"Time reduced from {baseTimeMinutes}m to {reducedTime}m");

        return reducedTime;
    }

    public decimal GetCostReductionPercentage() => 0.20m; // 20%

    private bool HasDvergrTechniques(Character character)
    {
        return character?.Specialization?.AbilityTree
            ?.GetUnlockedAbilities()
            ?.Contains(RunasmidrAbilityId.DvergrTechniques) ?? false;
    }
}
```

---

## 7. Infrastructure Layer Specifications

### 7.1 abilities.json Update (Tier 2 Abilities)

```json
{
    "abilities": [
        {
            "abilityId": "empowered-inscription",
            "displayName": "Empowered Inscription",
            "specializationId": "Runasmidr",
            "tier": 2,
            "type": "Active",
            "apCost": 4,
            "resourceCost": {
                "resourceId": "rune-charges",
                "amount": 2
            },
            "duration": 10,
            "durationUnit": "Turns",
            "ppCost": 4,
            "ppPrerequisite": 8,
            "description": "Inscribe a weapon with elemental power, adding +1d6 damage of chosen element (Fire, Cold, Lightning, or Aetheric). Stacks with base Inscribe Rune bonus.",
            "requirements": {
                "targetType": ["Weapon"],
                "specialization": "Runasmidr",
                "resourceAvailable": "rune-charges:2",
                "ppInvested": 8
            },
            "choices": [
                {
                    "choiceId": "element",
                    "displayName": "Element Type",
                    "options": [
                        {
                            "id": "fire",
                            "label": "Fire",
                            "description": "Flames flicker along blade (+1d6 fire damage)"
                        },
                        {
                            "id": "cold",
                            "label": "Cold",
                            "description": "Frost rimes the edge (+1d6 cold damage)"
                        },
                        {
                            "id": "lightning",
                            "label": "Lightning",
                            "description": "Sparks crackle (+1d6 lightning damage)"
                        },
                        {
                            "id": "aetheric",
                            "label": "Aetheric",
                            "description": "Purple glow pulses (+1d6 aetheric damage)"
                        }
                    ]
                }
            ],
            "effects": [
                {
                    "type": "ElementalDamageBonus",
                    "dice": "1d6",
                    "damageType": "$choice:element",
                    "duration": 10,
                    "stackable": false
                }
            ],
            "tags": ["rune", "elemental", "inscription", "tier2"]
        },
        {
            "abilityId": "runic-trap",
            "displayName": "Runic Trap",
            "specializationId": "Runasmidr",
            "tier": 2,
            "type": "Active",
            "apCost": 3,
            "resourceCost": {
                "resourceId": "rune-charges",
                "amount": 2
            },
            "duration": 60,
            "durationUnit": "Minutes",
            "ppCost": 4,
            "ppPrerequisite": 8,
            "description": "Place a hidden runic trap in an adjacent space. When an enemy enters, it deals 3d6 damage. Maximum 3 traps active. Invisible to enemies (DC 14 Perception to detect).",
            "requirements": {
                "targetType": ["AdjcentSpace"],
                "specialization": "Runasmidr",
                "resourceAvailable": "rune-charges:2",
                "ppInvested": 8,
                "maxActive": 3
            },
            "effects": [
                {
                    "type": "CreateTrap",
                    "trigger": "EnemyEnters",
                    "damage": "3d6",
                    "detectionDc": 14,
                    "visibleToAllies": true,
                    "visibleToEnemies": false,
                    "maxActive": 3,
                    "durationMinutes": 60
                }
            ],
            "tags": ["trap", "tactical", "inscription", "tier2"]
        },
        {
            "abilityId": "dvergr-techniques",
            "displayName": "Dvergr Techniques",
            "specializationId": "Runasmidr",
            "tier": 2,
            "type": "Passive",
            "apCost": 0,
            "resourceCost": null,
            "ppCost": 4,
            "ppPrerequisite": 8,
            "description": "Your mastery of Dvergr methods reduces all crafting costs and time by 20%. Does not affect Rune Charge costs.",
            "requirements": {
                "specialization": "Runasmidr",
                "ppInvested": 8
            },
            "effects": [
                {
                    "type": "CraftingCostModifier",
                    "percentage": -20,
                    "appliesTo": ["Materials", "Components"],
                    "excludes": ["RuneCharges", "SpecialResources"]
                },
                {
                    "type": "CraftingTimeModifier",
                    "percentage": -20,
                    "appliesTo": ["All"]
                }
            ],
            "tags": ["passive", "crafting", "efficiency", "tier2"]
        }
    ]
}
```

---

## 8. Empowered Inscription Ability

### 8.1 Mechanics Detail

**Element Selection:**
- Fire: Triggers fire vulnerabilities, can ignite flammable materials
- Cold: Slows creatures, weak against heat sources
- Lightning: Can create chain effects with multiple targets
- Aetheric: Disrupts magical defenses, anti-magic effect

**Damage Calculation:**
- Base damage bonus from Inscribe Rune: +2 (if both active)
- Elemental bonus: +1d6
- Total vs. creature with no resistances: +2 + 1d6 (average ~5.5 damage per hit)

**Stacking Rules:**
- Only one Empowered Inscription per weapon
- Combines with base Inscribe Rune (+2 damage) if both active
- Does NOT stack with multiple casters' buffs on same weapon

---

## 9. Runic Trap Ability

### 9.1 Trap Mechanics Detail

**Detection System:**
- Perception DC: 14 (standard "hard" difficulty)
- Bonus sources: Perception skill, ranger abilities, magical senses
- Success: Trap location revealed, trap not triggered
- Failure: Trap triggers, full damage dealt

**Damage Calculation:**
- Damage dice: 3d6
- Average damage: ~10-11 damage
- No save vs. damage
- Single target (creature entering space)

**Placement Rules:**
- Must be in line-of-sight of caster
- Must be adjacent (1 space away)
- Cannot move trap after placement
- Destroyed after triggering (one use)
- Expires after 1 hour if not triggered

---

## 10. Dvergr Techniques Ability

### 10.1 Crafting Cost Integration

**Cost Reduction:**
- All material costs: 20% reduction
- All crafting time: 20% reduction
- Applies to consumables and equipment equally
- Stacks additively with other modifiers (if any)

**Examples:**
- 50 material craft → 40 materials
- 1 hour crafting time → 48 minutes
- 3 components → 2.4 components (rounds up to 3 in practice)

---

## 11. Decision Trees and Flow Diagrams

### 11.1 Empowered Inscription Decision Tree

```
┌─────────────────────────────────────┐
│ Cast Empowered Inscription          │
└─────────────────┬───────────────────┘
                  │
                  ▼
┌───────────────────────────────────────┐
│ Check: Player has 2+ Rune Charges     │
└──────────┬─────────────────┬──────────┘
    YES    │                 │    NO
           │                 │
           ▼                 ▼
    ┌──────────────┐   ┌─────────────┐
    │ Select       │   │ Ability Fails│
    │ element      │   │ Return Error │
    │ (choice UI)  │   └─────────────┘
    └──────┬───────┘
           │
           ▼
┌────────────────────────────────────┐
│ Validate: Weapon target only       │
└──────────┬────────────────┬────────┘
    YES    │                │    NO
           │                │
           ▼                ▼
    ┌──────────────┐   ┌─────────────┐
    │ Deduct 2     │   │ Ability Fails│
    │ Rune Charges │   │ Return Error │
    └──────┬───────┘   └─────────────┘
           │
           ▼
┌────────────────────────────────────┐
│ Remove existing empowered rune?    │
└──────────┬────────────────┬────────┘
    YES    │                │    NO
           │                │
           ▼                ▼
    ┌──────────────┐   ┌────────────┐
    │ Remove old   │   │ Continue   │
    │ Add new      │   └─────┬──────┘
    └──────┬───────┘         │
           │                 │
           └────────┬────────┘
                    │
                    ▼
         ┌──────────────────────┐
         │ Apply Empowered Rune │
         │ Set duration: 10     │
         │ Store element choice │
         └──────────┬───────────┘
                    │
                    ▼
         ┌──────────────────────┐
         │ Log Action           │
         │ Display: +1d6 element│
         │ Update Character     │
         └──────────────────────┘
```

### 11.2 Runic Trap Placement Flow

```
┌──────────────────────────┐
│ Cast Runic Trap          │
└──────────┬───────────────┘
           │
           ▼
┌─────────────────────────────────┐
│ Check: 2+ Rune Charges          │
└──────────┬────────────┬─────────┘
    YES    │            │    NO
           │            │
           ▼            ▼
    ┌─────────────┐   FAIL
    │ Get target  │
    │ position    │
    └──────┬──────┘
           │
           ▼
┌─────────────────────────────────┐
│ Validate: Adjacent & passable   │
└──────────┬────────────┬─────────┘
    YES    │            │    NO
           │            │
           ▼            ▼
    ┌─────────────┐   FAIL
    │ Check max   │
    │ traps (3?)  │
    └──────┬──────┘
           │
           ▼
┌─────────────────────────────────┐
│ Have <3 active traps?           │
└──────────┬────────────┬─────────┘
    YES    │            │    NO
           │            │
           ▼            ▼
    ┌─────────────┐   FAIL
    │ Deduct 2    │
    │ Charges     │
    └──────┬──────┘
           │
           ▼
┌─────────────────────────────────┐
│ Create trap at position         │
│ Set expiration: now + 1 hour    │
│ Set detection DC: 14            │
└──────────────┬──────────────────┘
               │
               ▼
    ┌──────────────────────┐
    │ Log trap placement   │
    │ Update trap count    │
    │ Notify character     │
    └──────────────────────┘
```

---

## 12. Configuration Files

### 12.1 specializations.json Update

```json
{
    "specializations": [
        {
            "specializationId": "Runasmidr",
            "abilityTiers": [
                {
                    "tier": 1,
                    "ppRequirement": 0,
                    "abilityCost": 0,
                    "abilities": [
                        "inscribe-rune",
                        "read-the-marks",
                        "runestone-ward"
                    ]
                },
                {
                    "tier": 2,
                    "ppRequirement": 8,
                    "abilityCost": 4,
                    "abilities": [
                        "empowered-inscription",
                        "runic-trap",
                        "dvergr-techniques"
                    ]
                }
            ]
        }
    ]
}
```

---

## 13. Code Examples

### 13.1 Complete Empowered Inscription Execution

See section 6.1 for full implementation.

### 13.2 Trap Detection Check Integration

```csharp
/// <summary>
/// Performs Perception check to detect trap.
/// </summary>
private bool AttemptTrapDetection(Guid characterId, int detectionDc)
{
    var character = _characterRepository.GetById(characterId);
    var baseRoll = _diceRoller.RollD20();
    var perceptionModifier = character.Skills.GetModifier(SkillType.Perception);

    var totalRoll = baseRoll + perceptionModifier;

    _logger.LogDebug(
        $"Trap detection check for {characterId}: " +
        $"Rolled {baseRoll} + {perceptionModifier} (Perception) = {totalRoll} vs DC {detectionDc}");

    return totalRoll >= detectionDc;
}
```

---

## 14. Logging Specifications

### Log Events

**Empowered Inscription Applied:**
```
[INFO] Character {characterId} empowered {weaponName} with {element} element.
       Effect: +1d6 {element} damage for 10 turns
```

**Runic Trap Placed:**
```
[INFO] Character {characterId} placed Runic Trap at {position}.
       Active traps: {count}/3. Expires in 1 hour.
```

**Trap Detection Attempt:**
```
[DEBUG] Trap detection check: {characterId} rolled {roll} + {modifier} = {total} vs DC {dc}
        Result: {"success" OR "failed"}
```

**Trap Triggered:**
```
[INFO] Runic Trap {trapId} triggered by {targetId} at {position}.
       Damage dealt: {damage}d6 = {total} damage
```

**Dvergr Techniques Applied:**
```
[INFO] Dvergr Techniques applied to crafting for {characterId}.
       Cost: {originalCost} → {reducedCost} (20% reduction)
       Time: {originalTime}m → {reducedTime}m (20% reduction)
```

---

## 15. Unit Testing Requirements

### 15.1 Tier 2 Ability Tests (~8 tests)

```csharp
[TestFixture]
public class Tier2AbilityTests
{
    [Test]
    public void EmpoweredInscription_AddsElementalDamage()
    {
        // Test that empowered inscription adds 1d6 of chosen element
    }

    [Test]
    public void EmpoweredInscription_AllowsElementChoice()
    {
        // Test all 4 element options available
    }

    [Test]
    public void EmpoweredInscription_WeaponsOnly()
    {
        // Test that armor targets are rejected
    }

    [Test]
    public void RunicTrap_DealsCorrectDamage()
    {
        // Test trap deals 3d6 damage on trigger
    }

    [Test]
    public void RunicTrap_IsInvisibleToEnemies()
    {
        // Test DC 14 detection check
    }

    [Test]
    public void RunicTrap_MaxThreeActive()
    {
        // Test can't place more than 3 traps
    }

    [Test]
    public void DvergrTechniques_ReducesCraftingCost()
    {
        // Test 20% cost reduction
    }

    [Test]
    public void Tier2_LockedUntil8PPInvested()
    {
        // Test abilities unavailable below PP threshold
    }
}
```

---

## 16. Deliverable Checklist

### Domain Layer
- [ ] `EmpoweredRune` value object with GetDamageRoll/IsExpired methods
- [ ] `RunicTrap` value object with Trigger/IsExpired/IsVisibleTo methods
- [ ] `TrapTriggerType` enum (Movement, Proximity, Timed)
- [ ] `TrapTriggerResult` record

### Application Layer
- [ ] `EmpoweredInscriptionHandler` ability handler
- [ ] `RunicTrapHandler` ability handler
- [ ] `TrapTriggerExecutor` movement interceptor
- [ ] `DvergrTechniquesIntegration` crafting modifier
- [ ] Extension methods to IRúnasmiðrAbilityService

### Infrastructure Layer
- [ ] `abilities.json` entries for 3 Tier 2 abilities
- [ ] `specializations.json` Tier 2 tier configuration

### Tests
- [ ] `Tier2AbilityTests.cs` (8 tests)
- [ ] All tests passing with >95% code coverage

---

## 17. Acceptance Criteria

### Empowered Inscription
- [ ] Costs 4 AP and 2 Rune Charges
- [ ] Only targets weapons
- [ ] Adds +1d6 damage of selected element
- [ ] Stacks with base Inscribe Rune (+2 damage)
- [ ] All 4 elements available (Fire, Cold, Lightning, Aetheric)
- [ ] Duration: 10 turns
- [ ] Only one empowered rune per weapon

### Runic Trap
- [ ] Costs 3 AP and 2 Rune Charges
- [ ] Places in adjacent spaces
- [ ] Deals 3d6 damage when triggered
- [ ] DC 14 Perception to detect
- [ ] Maximum 3 active traps per character
- [ ] Expires after 1 hour
- [ ] Visible to allies, invisible to enemies
- [ ] Destroyed after triggering

### Dvergr Techniques
- [ ] Reduces crafting material costs by 20%
- [ ] Reduces crafting time by 20%
- [ ] Does NOT affect Rune Charge costs
- [ ] Applies to all crafting types
- [ ] Passive activation when unlocked
- [ ] Stacks additively with other bonuses

### Tier System
- [ ] Tier 2 abilities locked until 8 PP invested
- [ ] Each ability costs 4 PP to unlock
- [ ] Unlock check enforced at ability execution time

---

## 18. Dependencies

### Hard Dependencies
- **v0.20.2a** - Rúnasmiðr Framework (RuneChargeResource, base abilities)
- **v0.17.x** - Crafting System (cost reduction hooks)
- **v0.20.0** - Combat/Movement System (trap triggering)

### Soft Dependencies
- **Perception System** - Trap detection mechanics
- **Terrain/Position System** - Trap placement validation

---

## 19. Deferrals and Future Considerations

### v0.20.2c Integration
- Tier 3 abilities will interact with traps (Master Scrivener extends duration)
- Word of Unmaking will destroy active traps

### Future Enhancements
- **Cluster Traps** - Place multiple traps as area denial
- **Proximity Triggers** - DC check vs. detection when within 2 spaces
- **Trap Combinations** - Different elemental trap types
- **Advanced Trap Patterns** - Coordinate trap placement with allies

---

_This design specification provides comprehensive documentation for v0.20.2b implementation of Tier 2 Rúnasmiðr abilities. Building on v0.20.2a foundation, these abilities expand the runesmith's combat and crafting capabilities._
