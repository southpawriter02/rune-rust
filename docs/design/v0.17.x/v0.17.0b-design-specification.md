# v0.17.0b Design Specification: Passive Bonuses

**Version:** 0.17.0b  
**Phase Name:** Passive Bonuses  
**Parent Version:** v0.17.0 (Lineage System)  
**Prerequisites:** v0.17.0a Complete (Lineage Enum & Definition)  
**Estimated Tests:** ~6 unit tests

---

## Table of Contents

1. [Executive Summary](#1-executive-summary)
2. [Feature Overview](#2-feature-overview)
3. [Architecture Diagrams](#3-architecture-diagrams)
4. [LineagePassiveBonuses Value Object](#4-lineagepassivebonuses-value-object)
5. [SkillBonus Value Object](#5-skillbonus-value-object)
6. [LineageDefinition Extension](#6-lineagedefinition-extension)
7. [Data Model Changes](#7-data-model-changes)
8. [Configuration File Schema Updates](#8-configuration-file-schema-updates)
9. [Logging Specifications](#9-logging-specifications)
10. [Unit Testing Requirements](#10-unit-testing-requirements)
11. [Use Cases](#11-use-cases)
12. [User Stories](#12-user-stories)
13. [Deliverable Checklist](#13-deliverable-checklist)
14. [Acceptance Criteria](#14-acceptance-criteria)
15. [Dependencies](#15-dependencies)
16. [Future Considerations](#16-future-considerations)

---

## 1. Executive Summary

### 1.1 Purpose

This specification defines the passive bonus system for lineages, extending the `LineageDefinition` entity created in v0.17.0a. Passive bonuses represent inherent advantages granted by a character's bloodline heritage, including stat bonuses (HP, AP, Soak, Movement) and skill bonuses.

Each lineage provides distinct passive bonuses that complement their attribute modifiers:

- **Clan-Born** — +5 Max HP, +1 Social skill (community focus)
- **Rune-Marked** — +5 Max AP, +1 Lore skill (Aether attunement)
- **Iron-Blooded** — +2 Soak, +1 Craft skill (physical resilience)
- **Vargr-Kin** — +1 Movement, +1 Survival skill (primal agility)

This phase establishes the `LineagePassiveBonuses` and `SkillBonus` value objects that define these inherent lineage advantages.

### 1.2 Key Deliverables

| Category          | Items                                                     |
| ----------------- | --------------------------------------------------------- |
| **Value Objects** | `LineagePassiveBonuses`, `SkillBonus`                     |
| **Entity Update** | `LineageDefinition` extended with `PassiveBonuses`        |
| **Configuration** | `lineages.json` extended with passive bonus section       |
| **Schema Update** | `lineages.schema.json` extended with passive bonus schema |
| **Tests**         | ~6 unit tests                                             |

### 1.3 Architectural Significance

This version extends the **Lineage Pattern** established in v0.17.0a:

- **Composite Bonus Structure**: Passive bonuses aggregate multiple stat/skill effects
- **Skill Bonus Pattern**: Reusable `SkillBonus` value object for skill modifications
- **Derived Stat Influence**: Bonuses feed into Max HP, Max AP calculations
- **Movement System Integration**: Movement bonus affects tactical positioning
- **Skill System Hook**: Skill bonuses integrate with existing skill mechanics

---

## 2. Feature Overview

```
v0.17.0b Passive Bonuses
├── LineagePassiveBonuses Value Object
│   ├── MaxHpBonus: int          (+5 for Clan-Born)
│   ├── MaxApBonus: int          (+5 for Rune-Marked)
│   ├── SoakBonus: int           (+2 for Iron-Blooded)
│   ├── MovementBonus: int       (+1 for Vargr-Kin)
│   └── SkillBonuses: List<SkillBonus>
├── SkillBonus Value Object
│   ├── SkillId: string          (kebab-case skill identifier)
│   └── BonusAmount: int         (typically +1)
└── LineageDefinition Extension
    └── PassiveBonuses: LineagePassiveBonuses
```

### 2.1 Scope Alignment

**In Scope:**

- `LineagePassiveBonuses` value object with stat/skill bonuses
- `SkillBonus` value object for individual skill modifiers
- Extension of `LineageDefinition` entity with `PassiveBonuses` property
- Configuration schema updates for passive bonus section
- Passive bonus data for all 4 lineages
- Stat bonus application hooks (HP, AP, Soak, Movement)
- Skill bonus application hooks

**Out of Scope:**

- Unique traits → v0.17.0c
- Trauma baselines (Corruption, Stress) → v0.17.0d
- LineageProvider service → v0.17.0e
- LineageApplicationService → v0.17.0f
- Actual stat calculation implementation → v0.17.2

---

## 3. Architecture Diagrams

### 3.1 Passive Bonus System Overview

```
┌─────────────────────────────────────────────────────────────────────┐
│                   PASSIVE BONUS SYSTEM OVERVIEW                      │
└─────────────────────────────────────────────────────────────────────┘

    LineageDefinition (from v0.17.0a)
           │
           │  Contains passive bonuses
           ▼
┌─────────────────────────────────────────────────────────────────────┐
│                    LineagePassiveBonuses                             │
├─────────────────────────────────────────────────────────────────────┤
│  - MaxHpBonus: int           (added to Max HP calculation)          │
│  - MaxApBonus: int           (added to Max AP calculation)          │
│  - SoakBonus: int            (added to damage reduction)            │
│  - MovementBonus: int        (added to movement range)              │
│  - SkillBonuses: List<SkillBonus>                                   │
└─────────────────────────────────────────────────────────────────────┘
           │
           │  Contains skill modifiers
           ▼
┌─────────────────────────────────────────────────────────────────────┐
│                         SkillBonus                                   │
├─────────────────────────────────────────────────────────────────────┤
│  - SkillId: string           (e.g., "social", "lore", "craft")      │
│  - BonusAmount: int          (typically +1)                          │
└─────────────────────────────────────────────────────────────────────┘
```

### 3.2 Layer Diagram

```
┌─────────────────────────────────────────────────────────────────────┐
│                        PRESENTATION LAYER                            │
├─────────────────────────────────────────────────────────────────────┤
│  CharacterCreationView (v0.17.5)                                     │
│  └── Displays passive bonuses during lineage selection               │
│                                                                      │
│  CharacterSheetView                                                   │
│  └── Shows derived stats including lineage bonuses                   │
└───────┬─────────────────────────────────────────────────────────────┘
        │
        ▼
┌─────────────────────────────────────────────────────────────────────┐
│                       APPLICATION LAYER                              │
├─────────────────────────────────────────────────────────────────────┤
│  DerivedStatCalculator (v0.17.2)                                     │
│  └── Uses LineagePassiveBonuses.MaxHpBonus, MaxApBonus               │
│                                                                      │
│  SkillService                                                        │
│  └── Applies SkillBonus modifiers to skill checks                    │
│                                                                      │
│  ILineageApplicationService (v0.17.0f)                               │
│  └── Applies all passive bonuses to character                        │
└───────┬─────────────────────────────────────────────────────────────┘
        │
        ▼
┌─────────────────────────────────────────────────────────────────────┐
│                         DOMAIN LAYER                                 │
├─────────────────────────────────────────────────────────────────────┤
│  ┌─────────────────────────────────────────────────────────────┐    │
│  │                   LineageDefinition                          │    │
│  │                      (Entity)                                │    │
│  ├─────────────────────────────────────────────────────────────┤    │
│  │ + Id: Guid                                                   │    │
│  │ + LineageId: Lineage                                         │    │
│  │ + DisplayName: string                                        │    │
│  │ + AttributeModifiers: LineageAttributeModifiers (v0.17.0a)   │    │
│  │ + PassiveBonuses: LineagePassiveBonuses         ← NEW        │    │
│  └─────────────────────────────────────────────────────────────┘    │
│                            │                                         │
│                            │ contains                                │
│                            ▼                                         │
│  ┌──────────────────────────────────────────────────────────────┐   │
│  │               LineagePassiveBonuses (Value Object)           │   │
│  ├──────────────────────────────────────────────────────────────┤   │
│  │ MaxHpBonus: int          SoakBonus: int                      │   │
│  │ MaxApBonus: int          MovementBonus: int                  │   │
│  │ SkillBonuses: IReadOnlyList<SkillBonus>                      │   │
│  └──────────────────────────────────────────────────────────────┘   │
│                            │                                         │
│  ┌──────────────────────────┴───────────────────────────────────┐   │
│  │                    SkillBonus (Value Object)                 │   │
│  ├──────────────────────────────────────────────────────────────┤   │
│  │ SkillId: string                  BonusAmount: int            │   │
│  └──────────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────────┘
```

### 3.3 Passive Bonus Application Flow

```
┌─────────────────────────────────────────────────────────────────────┐
│                  PASSIVE BONUS APPLICATION FLOW                      │
└─────────────────────────────────────────────────────────────────────┘

    Character Creation Complete
           │
           ▼
┌─────────────────────────────────────────────────────────────────────┐
│                    GET LINEAGE DEFINITION                            │
├─────────────────────────────────────────────────────────────────────┤
│  LineageDefinition for Clan-Born:                                    │
│    PassiveBonuses:                                                   │
│      MaxHpBonus: +5                                                  │
│      MaxApBonus: 0                                                   │
│      SoakBonus: 0                                                    │
│      MovementBonus: 0                                                │
│      SkillBonuses: [{ SkillId: "social", BonusAmount: 1 }]          │
└─────────────────────────────────────────────────────────────────────┘
           │
           ▼
┌─────────────────────────────────────────────────────────────────────┐
│                    APPLY STAT BONUSES                                │
├─────────────────────────────────────────────────────────────────────┤
│                                                                      │
│  Max HP Calculation:                                                 │
│    Base: (STURDINESS × 10) + 50 + Archetype Bonus                   │
│    + Lineage HP Bonus: +5                                            │
│    = Final Max HP                                                    │
│                                                                      │
│  Max AP Calculation:                                                 │
│    Base: (WILL × 10) + (WITS × 5) + Archetype Bonus                 │
│    + Lineage AP Bonus: +0                                            │
│    = Final Max AP                                                    │
│                                                                      │
│  Soak Calculation:                                                   │
│    Base: Armor Soak + Equipment Soak                                 │
│    + Lineage Soak Bonus: +0                                          │
│    = Final Soak                                                      │
│                                                                      │
│  Movement Calculation:                                               │
│    Base: Archetype Movement                                          │
│    + Lineage Movement Bonus: +0                                      │
│    = Final Movement                                                  │
│                                                                      │
└─────────────────────────────────────────────────────────────────────┘
           │
           ▼
┌─────────────────────────────────────────────────────────────────────┐
│                    APPLY SKILL BONUSES                               │
├─────────────────────────────────────────────────────────────────────┤
│                                                                      │
│  For each SkillBonus in PassiveBonuses.SkillBonuses:                │
│    1. Get skill by SkillId ("social")                               │
│    2. Add BonusAmount (+1) to skill modifier                        │
│    3. Register as lineage source for tooltip display                │
│                                                                      │
│  Result: Social skill checks gain +1 from Clan-Born heritage        │
│                                                                      │
└─────────────────────────────────────────────────────────────────────┘
```

### 3.4 Lineage Bonus Comparison Matrix

```
┌─────────────────────────────────────────────────────────────────────┐
│                  LINEAGE PASSIVE BONUS MATRIX                        │
└─────────────────────────────────────────────────────────────────────┘

    ┌─────────────┬────────┬────────┬────────┬──────────┬────────────┐
    │   Lineage   │ Max HP │ Max AP │  Soak  │ Movement │   Skill    │
    ├─────────────┼────────┼────────┼────────┼──────────┼────────────┤
    │  Clan-Born  │   +5   │   0    │   0    │    0     │ Social +1  │
    ├─────────────┼────────┼────────┼────────┼──────────┼────────────┤
    │ Rune-Marked │   0    │   +5   │   0    │    0     │  Lore +1   │
    ├─────────────┼────────┼────────┼────────┼──────────┼────────────┤
    │ Iron-Blooded│   0    │   0    │   +2   │    0     │  Craft +1  │
    ├─────────────┼────────┼────────┼────────┼──────────┼────────────┤
    │  Vargr-Kin  │   0    │   0    │   0    │    +1    │Survival +1 │
    └─────────────┴────────┴────────┴────────┴──────────┴────────────┘

    Design Notes:
    ┌─────────────────────────────────────────────────────────────────┐
    │ • Each lineage receives exactly ONE stat bonus                  │
    │ • Each lineage receives exactly ONE skill bonus (+1)            │
    │ • Bonuses complement attribute modifiers thematically           │
    │ • Stat bonuses range from +2 to +5                              │
    │ • Movement is most impactful (+1 tile per turn)                 │
    └─────────────────────────────────────────────────────────────────┘
```

### 3.5 Skill Bonus Application Decision Tree

```
┌─────────────────────────────────────────────────────────────────────┐
│                  SKILL BONUS APPLICATION DECISION                    │
└─────────────────────────────────────────────────────────────────────┘

    Skill Check Initiated (e.g., Rhetoric)
           │
           ▼
    ┌──────────────────────┐
    │ Get Character Lineage │
    └──────────┬───────────┘
               │
               ▼
    ┌──────────────────────┐
    │ Get PassiveBonuses   │
    │ from LineageDefinition│
    └──────────┬───────────┘
               │
               ▼
    ┌──────────────────────────────────┐
    │ Any SkillBonus.SkillId matches   │──── No ────▶ No lineage bonus
    │ the skill being checked?         │              applied
    └──────────┬───────────────────────┘
               │
              Yes
               │
               ▼
    ┌──────────────────────────────────┐
    │ Add SkillBonus.BonusAmount       │
    │ to skill check modifier          │
    └──────────┬───────────────────────┘
               │
               ▼
    ┌──────────────────────────────────┐
    │ Record bonus source:             │
    │ "Clan-Born Heritage: +1"         │
    └──────────────────────────────────┘
```

---

## 4. LineagePassiveBonuses Value Object

### 4.1 Purpose

The `LineagePassiveBonuses` value object encapsulates all inherent stat and skill bonuses granted by a lineage. These bonuses are applied during character creation and persist throughout the character's life.

### 4.2 Implementation

**File:** `src/Core/RuneAndRust.Domain/ValueObjects/LineagePassiveBonuses.cs`

```csharp
namespace RuneAndRust.Domain.ValueObjects;

/// <summary>
/// Contains passive stat and skill bonuses granted by a lineage.
/// </summary>
/// <remarks>
/// <para>
/// LineagePassiveBonuses represents the inherent advantages of a bloodline heritage.
/// Unlike attribute modifiers which affect core stats, passive bonuses directly
/// modify derived stats (Max HP, Max AP, Soak, Movement) and skill ranks.
/// </para>
/// <para>
/// Each lineage provides one stat bonus and one skill bonus, creating distinct
/// mechanical identities:
/// - Clan-Born: +5 Max HP, +1 Social (resilient diplomats)
/// - Rune-Marked: +5 Max AP, +1 Lore (mystical scholars)
/// - Iron-Blooded: +2 Soak, +1 Craft (tough artisans)
/// - Vargr-Kin: +1 Movement, +1 Survival (swift hunters)
/// </para>
/// </remarks>
/// <param name="MaxHpBonus">Bonus added to Max HP calculation.</param>
/// <param name="MaxApBonus">Bonus added to Max AP (Aether Pool) calculation.</param>
/// <param name="SoakBonus">Bonus added to damage reduction.</param>
/// <param name="MovementBonus">Bonus added to movement range in tiles.</param>
/// <param name="SkillBonuses">List of skill bonuses granted by this lineage.</param>
public readonly record struct LineagePassiveBonuses(
    int MaxHpBonus,
    int MaxApBonus,
    int SoakBonus,
    int MovementBonus,
    IReadOnlyList<SkillBonus> SkillBonuses)
{
    /// <summary>
    /// Gets whether this lineage grants any HP bonus.
    /// </summary>
    public bool HasHpBonus => MaxHpBonus > 0;

    /// <summary>
    /// Gets whether this lineage grants any AP bonus.
    /// </summary>
    public bool HasApBonus => MaxApBonus > 0;

    /// <summary>
    /// Gets whether this lineage grants any Soak bonus.
    /// </summary>
    public bool HasSoakBonus => SoakBonus > 0;

    /// <summary>
    /// Gets whether this lineage grants any Movement bonus.
    /// </summary>
    public bool HasMovementBonus => MovementBonus > 0;

    /// <summary>
    /// Gets whether this lineage grants any skill bonuses.
    /// </summary>
    public bool HasSkillBonuses => SkillBonuses.Count > 0;

    /// <summary>
    /// Gets the skill bonus for a specific skill, if any.
    /// </summary>
    /// <param name="skillId">The skill identifier to look up.</param>
    /// <returns>The bonus amount, or 0 if no bonus exists for the skill.</returns>
    public int GetSkillBonus(string skillId)
    {
        ArgumentException.ThrowIfNullOrWhiteSpace(skillId);
        var normalizedId = skillId.ToLowerInvariant();
        return SkillBonuses
            .FirstOrDefault(sb => sb.SkillId.Equals(normalizedId, StringComparison.OrdinalIgnoreCase))
            .BonusAmount;
    }

    /// <summary>
    /// Creates a new LineagePassiveBonuses with validation.
    /// </summary>
    /// <param name="maxHpBonus">HP bonus (must be non-negative).</param>
    /// <param name="maxApBonus">AP bonus (must be non-negative).</param>
    /// <param name="soakBonus">Soak bonus (must be non-negative).</param>
    /// <param name="movementBonus">Movement bonus (must be non-negative).</param>
    /// <param name="skillBonuses">Skill bonuses (can be empty).</param>
    /// <returns>A new LineagePassiveBonuses instance.</returns>
    /// <exception cref="ArgumentOutOfRangeException">Thrown when any bonus is negative.</exception>
    public static LineagePassiveBonuses Create(
        int maxHpBonus,
        int maxApBonus,
        int soakBonus,
        int movementBonus,
        IReadOnlyList<SkillBonus>? skillBonuses = null)
    {
        ArgumentOutOfRangeException.ThrowIfNegative(maxHpBonus);
        ArgumentOutOfRangeException.ThrowIfNegative(maxApBonus);
        ArgumentOutOfRangeException.ThrowIfNegative(soakBonus);
        ArgumentOutOfRangeException.ThrowIfNegative(movementBonus);

        return new LineagePassiveBonuses(
            maxHpBonus,
            maxApBonus,
            soakBonus,
            movementBonus,
            skillBonuses ?? Array.Empty<SkillBonus>());
    }

    /// <summary>
    /// Default passive bonuses for Clan-Born lineage.
    /// </summary>
    public static LineagePassiveBonuses ClanBorn => Create(
        maxHpBonus: 5,
        maxApBonus: 0,
        soakBonus: 0,
        movementBonus: 0,
        skillBonuses: new[] { SkillBonus.Create("social", 1) });

    /// <summary>
    /// Default passive bonuses for Rune-Marked lineage.
    /// </summary>
    public static LineagePassiveBonuses RuneMarked => Create(
        maxHpBonus: 0,
        maxApBonus: 5,
        soakBonus: 0,
        movementBonus: 0,
        skillBonuses: new[] { SkillBonus.Create("lore", 1) });

    /// <summary>
    /// Default passive bonuses for Iron-Blooded lineage.
    /// </summary>
    public static LineagePassiveBonuses IronBlooded => Create(
        maxHpBonus: 0,
        maxApBonus: 0,
        soakBonus: 2,
        movementBonus: 0,
        skillBonuses: new[] { SkillBonus.Create("craft", 1) });

    /// <summary>
    /// Default passive bonuses for Vargr-Kin lineage.
    /// </summary>
    public static LineagePassiveBonuses VargrKin => Create(
        maxHpBonus: 0,
        maxApBonus: 0,
        soakBonus: 0,
        movementBonus: 1,
        skillBonuses: new[] { SkillBonus.Create("survival", 1) });

    /// <summary>
    /// Empty passive bonuses (no bonuses).
    /// </summary>
    public static LineagePassiveBonuses None => Create(0, 0, 0, 0);

    /// <inheritdoc />
    public override string ToString()
    {
        var parts = new List<string>();
        if (MaxHpBonus > 0) parts.Add($"+{MaxHpBonus} Max HP");
        if (MaxApBonus > 0) parts.Add($"+{MaxApBonus} Max AP");
        if (SoakBonus > 0) parts.Add($"+{SoakBonus} Soak");
        if (MovementBonus > 0) parts.Add($"+{MovementBonus} Movement");
        foreach (var skill in SkillBonuses)
        {
            parts.Add(skill.ToString());
        }
        return parts.Count > 0 ? string.Join(", ", parts) : "No passive bonuses";
    }
}
```

### 4.3 Passive Bonus Reference Table

| Lineage      | Max HP | Max AP | Soak | Movement | Skill Bonus |
| ------------ | ------ | ------ | ---- | -------- | ----------- |
| Clan-Born    | +5     | 0      | 0    | 0        | Social +1   |
| Rune-Marked  | 0      | +5     | 0    | 0        | Lore +1     |
| Iron-Blooded | 0      | 0      | +2   | 0        | Craft +1    |
| Vargr-Kin    | 0      | 0      | 0    | +1       | Survival +1 |

---

## 5. SkillBonus Value Object

### 5.1 Purpose

The `SkillBonus` value object represents a modifier to a specific skill granted by a lineage (or potentially other sources in the future). It pairs a skill identifier with a bonus amount.

### 5.2 Implementation

**File:** `src/Core/RuneAndRust.Domain/ValueObjects/SkillBonus.cs`

```csharp
namespace RuneAndRust.Domain.ValueObjects;

/// <summary>
/// Represents a bonus to a specific skill.
/// </summary>
/// <remarks>
/// <para>
/// SkillBonus is a simple value object pairing a skill identifier with a bonus amount.
/// Skills are identified by kebab-case string IDs (e.g., "social", "lore", "survival")
/// to allow configuration-driven skill systems.
/// </para>
/// <para>
/// Currently used for lineage passive bonuses, but the design supports reuse for
/// background bonuses, equipment effects, or status effects in future versions.
/// </para>
/// </remarks>
/// <param name="SkillId">The kebab-case skill identifier.</param>
/// <param name="BonusAmount">The bonus amount to add to skill checks.</param>
public readonly record struct SkillBonus(string SkillId, int BonusAmount)
{
    /// <summary>
    /// Gets the skill ID normalized to lowercase.
    /// </summary>
    public string NormalizedSkillId => SkillId.ToLowerInvariant();

    /// <summary>
    /// Gets whether this is a positive bonus.
    /// </summary>
    public bool IsPositive => BonusAmount > 0;

    /// <summary>
    /// Gets whether this is a penalty (negative bonus).
    /// </summary>
    public bool IsPenalty => BonusAmount < 0;

    /// <summary>
    /// Creates a new SkillBonus with validation.
    /// </summary>
    /// <param name="skillId">The skill identifier (kebab-case).</param>
    /// <param name="bonusAmount">The bonus amount.</param>
    /// <returns>A new SkillBonus instance.</returns>
    /// <exception cref="ArgumentException">Thrown when skillId is null or whitespace.</exception>
    public static SkillBonus Create(string skillId, int bonusAmount)
    {
        ArgumentException.ThrowIfNullOrWhiteSpace(skillId);
        return new SkillBonus(skillId.ToLowerInvariant(), bonusAmount);
    }

    /// <summary>
    /// Checks if this bonus applies to the specified skill.
    /// </summary>
    /// <param name="targetSkillId">The skill to check against.</param>
    /// <returns>True if this bonus applies to the target skill.</returns>
    public bool AppliesTo(string targetSkillId)
    {
        if (string.IsNullOrWhiteSpace(targetSkillId)) return false;
        return NormalizedSkillId.Equals(targetSkillId.ToLowerInvariant(), StringComparison.Ordinal);
    }

    /// <inheritdoc />
    public override string ToString() =>
        BonusAmount >= 0
            ? $"{SkillId} +{BonusAmount}"
            : $"{SkillId} {BonusAmount}";
}
```

### 5.3 Skill ID Reference Table

| Lineage      | Skill ID   | Display Name | Bonus |
| ------------ | ---------- | ------------ | ----- |
| Clan-Born    | `social`   | Social       | +1    |
| Rune-Marked  | `lore`     | Lore         | +1    |
| Iron-Blooded | `craft`    | Craft        | +1    |
| Vargr-Kin    | `survival` | Survival     | +1    |

---

## 6. LineageDefinition Extension

### 6.1 Purpose

This section documents the extension of `LineageDefinition` (created in v0.17.0a) to include the `PassiveBonuses` property.

### 6.2 Updated Implementation

**File:** `src/Core/RuneAndRust.Domain/Entities/LineageDefinition.cs`

```csharp
// Add to existing LineageDefinition entity:

/// <summary>
/// Gets the passive stat and skill bonuses granted by this lineage.
/// </summary>
/// <remarks>
/// Passive bonuses are applied during character creation and include:
/// - Stat bonuses: Max HP, Max AP, Soak, Movement
/// - Skill bonuses: One or more skill modifiers
/// </remarks>
public LineagePassiveBonuses PassiveBonuses { get; private set; }

// Update the Create factory method signature:
public static LineageDefinition Create(
    Lineage lineageId,
    string displayName,
    string description,
    string selectionText,
    LineageAttributeModifiers attributeModifiers,
    LineagePassiveBonuses passiveBonuses,  // ← NEW PARAMETER
    string appearanceNotes,
    string socialRole)
{
    // ... existing validation ...

    return new LineageDefinition
    {
        Id = Guid.NewGuid(),
        LineageId = lineageId,
        DisplayName = displayName,
        Description = description,
        SelectionText = selectionText,
        AttributeModifiers = attributeModifiers,
        PassiveBonuses = passiveBonuses,  // ← NEW ASSIGNMENT
        AppearanceNotes = appearanceNotes,
        SocialRole = socialRole
    };
}

// Add helper methods:

/// <summary>
/// Gets the total HP bonus from this lineage (passive bonus only).
/// </summary>
/// <returns>The Max HP bonus.</returns>
public int GetHpBonus() => PassiveBonuses.MaxHpBonus;

/// <summary>
/// Gets the total AP bonus from this lineage (passive bonus only).
/// </summary>
/// <returns>The Max AP bonus.</returns>
public int GetApBonus() => PassiveBonuses.MaxApBonus;

/// <summary>
/// Gets the skill bonus for a specific skill from this lineage.
/// </summary>
/// <param name="skillId">The skill identifier to look up.</param>
/// <returns>The bonus amount, or 0 if no bonus exists.</returns>
public int GetSkillBonus(string skillId) => PassiveBonuses.GetSkillBonus(skillId);

/// <summary>
/// Gets all skill bonuses from this lineage.
/// </summary>
/// <returns>Read-only list of skill bonuses.</returns>
public IReadOnlyList<SkillBonus> GetAllSkillBonuses() => PassiveBonuses.SkillBonuses;
```

### 6.3 Update Summary

| Change Type  | Property/Method           | Description                      |
| ------------ | ------------------------- | -------------------------------- |
| New Property | `PassiveBonuses`          | Contains all passive bonuses     |
| Updated      | `Create()` factory method | Adds `passiveBonuses` parameter  |
| New Method   | `GetHpBonus()`            | Returns Max HP bonus             |
| New Method   | `GetApBonus()`            | Returns Max AP bonus             |
| New Method   | `GetSkillBonus(skillId)`  | Returns bonus for specific skill |
| New Method   | `GetAllSkillBonuses()`    | Returns all skill bonuses        |

---

## 7. Data Model Changes

### 7.1 New Types Summary

| Type                    | Layer  | Category     | Description                          |
| ----------------------- | ------ | ------------ | ------------------------------------ |
| `LineagePassiveBonuses` | Domain | Value Object | Stat and skill bonuses for a lineage |
| `SkillBonus`            | Domain | Value Object | Individual skill modifier            |

### 7.2 Updated Types Summary

| Type                | Layer  | Category | Changes                         |
| ------------------- | ------ | -------- | ------------------------------- |
| `LineageDefinition` | Domain | Entity   | Added `PassiveBonuses` property |

### 7.3 File Locations

```
src/Core/RuneAndRust.Domain/
├── Entities/
│   └── LineageDefinition.cs             ← UPDATED (add PassiveBonuses)
└── ValueObjects/
    ├── LineagePassiveBonuses.cs         ← NEW
    └── SkillBonus.cs                    ← NEW

config/
└── lineages.json                        ← UPDATED (add passiveBonuses section)
```

### 7.4 Entity Relationships

```
┌─────────────────────┐
│  LineageDefinition  │
│      (Entity)       │
├─────────────────────┤
│ AttributeModifiers  │────▶ LineageAttributeModifiers (v0.17.0a)
│ PassiveBonuses      │────▶ LineagePassiveBonuses     ← NEW
└─────────────────────┘
                                    │
                                    │ contains
                                    ▼
                           ┌────────────────┐
                           │   SkillBonus   │
                           │(Value Object)  │
                           └────────────────┘
```

---

## 8. Configuration File Schema Updates

### 8.1 lineages.json (Extended - Passive Bonuses Section)

**File:** `config/lineages.json` (additions only)

```json
{
    "$schema": "./schemas/lineages.schema.json",
    "lineages": [
        {
            "lineageId": "ClanBorn",
            "displayName": "Clan-Born",
            "attributeModifiers": {
                /* ... from v0.17.0a ... */
            },
            "passiveBonuses": {
                "maxHpBonus": 5,
                "maxApBonus": 0,
                "soakBonus": 0,
                "movementBonus": 0,
                "skillBonuses": [{ "skillId": "social", "bonusAmount": 1 }]
            }
        },
        {
            "lineageId": "RuneMarked",
            "displayName": "Rune-Marked",
            "attributeModifiers": {
                /* ... from v0.17.0a ... */
            },
            "passiveBonuses": {
                "maxHpBonus": 0,
                "maxApBonus": 5,
                "soakBonus": 0,
                "movementBonus": 0,
                "skillBonuses": [{ "skillId": "lore", "bonusAmount": 1 }]
            }
        },
        {
            "lineageId": "IronBlooded",
            "displayName": "Iron-Blooded",
            "attributeModifiers": {
                /* ... from v0.17.0a ... */
            },
            "passiveBonuses": {
                "maxHpBonus": 0,
                "maxApBonus": 0,
                "soakBonus": 2,
                "movementBonus": 0,
                "skillBonuses": [{ "skillId": "craft", "bonusAmount": 1 }]
            }
        },
        {
            "lineageId": "VargrKin",
            "displayName": "Vargr-Kin",
            "attributeModifiers": {
                /* ... from v0.17.0a ... */
            },
            "passiveBonuses": {
                "maxHpBonus": 0,
                "maxApBonus": 0,
                "soakBonus": 0,
                "movementBonus": 1,
                "skillBonuses": [{ "skillId": "survival", "bonusAmount": 1 }]
            }
        }
    ]
}
```

### 8.2 lineages.schema.json (Extended)

**File:** `config/schemas/lineages.schema.json` (additions to `$defs`)

```json
{
    "$defs": {
        "lineageDefinition": {
            "required": [
                "lineageId",
                "displayName",
                "description",
                "selectionText",
                "attributeModifiers",
                "passiveBonuses",
                "appearanceNotes",
                "socialRole"
            ],
            "properties": {
                "passiveBonuses": {
                    "$ref": "#/$defs/passiveBonuses"
                }
            }
        },
        "passiveBonuses": {
            "type": "object",
            "description": "Passive stat and skill bonuses for this lineage",
            "required": [
                "maxHpBonus",
                "maxApBonus",
                "soakBonus",
                "movementBonus",
                "skillBonuses"
            ],
            "properties": {
                "maxHpBonus": {
                    "type": "integer",
                    "description": "Bonus to Max HP calculation",
                    "minimum": 0,
                    "maximum": 20
                },
                "maxApBonus": {
                    "type": "integer",
                    "description": "Bonus to Max AP (Aether Pool) calculation",
                    "minimum": 0,
                    "maximum": 20
                },
                "soakBonus": {
                    "type": "integer",
                    "description": "Bonus to damage reduction",
                    "minimum": 0,
                    "maximum": 10
                },
                "movementBonus": {
                    "type": "integer",
                    "description": "Bonus to movement range in tiles",
                    "minimum": 0,
                    "maximum": 3
                },
                "skillBonuses": {
                    "type": "array",
                    "description": "Array of skill bonuses",
                    "items": {
                        "$ref": "#/$defs/skillBonus"
                    }
                }
            },
            "additionalProperties": false
        },
        "skillBonus": {
            "type": "object",
            "description": "A bonus to a specific skill",
            "required": ["skillId", "bonusAmount"],
            "properties": {
                "skillId": {
                    "type": "string",
                    "description": "Kebab-case skill identifier",
                    "minLength": 1,
                    "maxLength": 50,
                    "pattern": "^[a-z][a-z0-9-]*$"
                },
                "bonusAmount": {
                    "type": "integer",
                    "description": "Bonus amount to add to skill checks",
                    "minimum": -5,
                    "maximum": 5
                }
            },
            "additionalProperties": false
        }
    }
}
```

---

## 9. Logging Specifications

### 9.1 Log Levels by Component

| Component               | Level       | Events                                  |
| ----------------------- | ----------- | --------------------------------------- |
| `LineagePassiveBonuses` | Debug       | Bonus created, skill lookup performed   |
| `SkillBonus`            | Debug       | Skill bonus created, applied to check   |
| `LineageDefinition`     | Debug       | Passive bonuses accessed                |
| `LineageProvider`       | Information | Passive bonus configuration loaded      |
| `LineageProvider`       | Warning     | Missing passive bonus section in config |

### 9.2 Structured Logging Templates

```csharp
// Debug - Passive bonuses created
_logger.LogDebug(
    "LineagePassiveBonuses created. HP={HpBonus}, AP={ApBonus}, Soak={SoakBonus}, Move={MoveBonus}, Skills={SkillCount}",
    bonuses.MaxHpBonus,
    bonuses.MaxApBonus,
    bonuses.SoakBonus,
    bonuses.MovementBonus,
    bonuses.SkillBonuses.Count);

// Debug - Skill bonus lookup
_logger.LogDebug(
    "Skill bonus lookup. SkillId={SkillId}, BonusFound={Found}, Amount={Amount}",
    skillId,
    amount > 0,
    amount);

// Information - Bonuses applied to character
_logger.LogInformation(
    "Lineage passive bonuses applied. CharacterId={CharId}, Lineage={Lineage}, HpBonus={Hp}, ApBonus={Ap}",
    characterId,
    lineage,
    hpBonus,
    apBonus);
```

---

## 10. Unit Testing Requirements

### 10.1 Test Count by Feature

| Feature                     | Test Count |
| --------------------------- | ---------- |
| LineagePassiveBonuses       | ~3         |
| SkillBonus                  | ~2         |
| LineageDefinition (updated) | ~1         |
| **Total**                   | **~6**     |

### 10.2 Test Specifications

#### LineagePassiveBonusesTests.cs

**File:** `tests/RuneAndRust.Domain.UnitTests/ValueObjects/LineagePassiveBonusesTests.cs`

```csharp
[TestFixture]
public class LineagePassiveBonusesTests
{
    [Test]
    public void Create_WithValidParameters_CreatesPassiveBonuses();

    [Test]
    public void Create_WithNegativeHpBonus_ThrowsArgumentOutOfRangeException();

    [Test]
    public void ClanBorn_HasCorrectBonuses_ReturnsExpectedValues();

    [Test]
    public void RuneMarked_HasCorrectBonuses_ReturnsExpectedValues();

    [Test]
    public void IronBlooded_HasCorrectBonuses_ReturnsExpectedValues();

    [Test]
    public void VargrKin_HasCorrectBonuses_ReturnsExpectedValues();

    [Test]
    public void GetSkillBonus_ForExistingSkill_ReturnsCorrectAmount();

    [Test]
    public void GetSkillBonus_ForNonExistentSkill_ReturnsZero();

    [Test]
    public void HasHpBonus_WhenBonusIsPositive_ReturnsTrue();

    [Test]
    public void HasHpBonus_WhenBonusIsZero_ReturnsFalse();
}
```

#### SkillBonusTests.cs

**File:** `tests/RuneAndRust.Domain.UnitTests/ValueObjects/SkillBonusTests.cs`

```csharp
[TestFixture]
public class SkillBonusTests
{
    [Test]
    public void Create_WithValidParameters_CreatesSkillBonus();

    [Test]
    public void Create_WithNullSkillId_ThrowsArgumentException();

    [Test]
    public void Create_NormalizesSkillIdToLowercase();

    [Test]
    public void AppliesTo_WithMatchingSkillId_ReturnsTrue();

    [Test]
    public void AppliesTo_WithDifferentSkillId_ReturnsFalse();

    [Test]
    public void AppliesTo_IsCaseInsensitive();

    [Test]
    public void ToString_ReturnsFormattedString();
}
```

---

## 11. Use Cases

### UC-001: Display Lineage Passive Bonuses

**Actor:** Character Creation UI  
**Flow:** Request lineage definition → Get passive bonuses → Display HP/AP/Soak/Movement bonuses → Display skill bonuses

### UC-002: Apply HP Bonus to Character

**Actor:** Character Factory (v0.17.5)  
**Flow:** Calculate base Max HP → Get lineage HP bonus → Add to Max HP → Set character Max HP

### UC-003: Apply Skill Bonus to Check

**Actor:** Skill Service  
**Flow:** Initiate skill check → Get character lineage → Get skill bonus for check type → Add to modifier → Roll skill check

### UC-004: Compare Lineage Bonuses

**Actor:** Player during Character Creation  
**Flow:** View all lineages → Compare passive bonuses → Understand trade-offs → Select preferred lineage

---

## 12. User Stories

### US-001: View Passive Bonuses During Selection

**As a** player creating a new character  
**I want to** see each lineage's passive bonuses clearly displayed  
**So that** I can understand the inherent advantages of each bloodline

**Acceptance Criteria:**

- HP, AP, Soak, and Movement bonuses shown numerically
- Skill bonuses shown with skill name and bonus amount
- Zero bonuses not shown or shown as "—"

### US-002: Understand Bonus Impact

**As a** player selecting a lineage  
**I want to** understand how passive bonuses affect my character  
**So that** I can choose a lineage that complements my intended playstyle

**Acceptance Criteria:**

- Bonus descriptions explain what each bonus does
- Examples show practical impact (e.g., "+5 HP means 5 more damage before death")

### US-003: See Lineage Bonus on Character Sheet

**As a** player viewing my character  
**I want to** see my lineage bonuses reflected in my stats  
**So that** I can verify my bonuses are applied correctly

**Acceptance Criteria:**

- Max HP shows lineage bonus as separate line item
- Skill checks show lineage bonus in modifier breakdown

---

## 13. Deliverable Checklist

### Domain Layer

- [ ] `LineagePassiveBonuses.cs` value object created in `ValueObjects/`
- [ ] `SkillBonus.cs` value object created in `ValueObjects/`
- [ ] `LineageDefinition.cs` updated with `PassiveBonuses` property
- [ ] All types have complete XML documentation

### Configuration Files

- [ ] `config/lineages.json` updated with passiveBonuses for all 4 lineages
- [ ] `config/schemas/lineages.schema.json` updated with passiveBonuses schema
- [ ] Configuration validates against updated schema

### Testing

- [ ] `LineagePassiveBonusesTests.cs` created
- [ ] `SkillBonusTests.cs` created
- [ ] ~6 unit tests passing

### Documentation

- [ ] `v0.17.0b-changelog.md` created
- [ ] Inline code comments complete

---

## 14. Acceptance Criteria

### Functional

- [ ] `LineagePassiveBonuses` stores HP, AP, Soak, Movement bonuses
- [ ] `LineagePassiveBonuses.Create()` validates non-negative bonuses
- [ ] `LineagePassiveBonuses.GetSkillBonus()` returns correct amount for skill
- [ ] `SkillBonus.Create()` validates non-empty skill ID
- [ ] `SkillBonus.AppliesTo()` performs case-insensitive comparison
- [ ] Clan-Born has +5 HP, +1 Social
- [ ] Rune-Marked has +5 AP, +1 Lore
- [ ] Iron-Blooded has +2 Soak, +1 Craft
- [ ] Vargr-Kin has +1 Movement, +1 Survival
- [ ] `LineageDefinition.PassiveBonuses` property accessible

### Quality

- [ ] Build succeeds with 0 errors
- [ ] Build succeeds with 0 warnings
- [ ] ~6 unit tests pass
- [ ] Configuration validates against JSON schema
- [ ] All public types have XML documentation

---

## 15. Dependencies

### Required from v0.17.0a

| Type                        | Location                           | Usage                         |
| --------------------------- | ---------------------------------- | ----------------------------- |
| `Lineage`                   | `RuneAndRust.Domain/Enums/`        | Referenced by definition      |
| `LineageDefinition`         | `RuneAndRust.Domain/Entities/`     | Extended with passive bonuses |
| `LineageAttributeModifiers` | `RuneAndRust.Domain/ValueObjects/` | Sibling data in definition    |

### Provides to v0.17.0c

| Type                    | Usage                            |
| ----------------------- | -------------------------------- |
| `LineagePassiveBonuses` | Component of LineageDefinition   |
| `SkillBonus`            | Reusable for trait skill effects |

### Provides to v0.17.0f

| Type                    | Usage                                |
| ----------------------- | ------------------------------------ |
| `LineagePassiveBonuses` | Applied by LineageApplicationService |
| `SkillBonus`            | Registered with skill system         |

### Provides to v0.17.2

| Type                    | Usage                               |
| ----------------------- | ----------------------------------- |
| `LineagePassiveBonuses` | HP/AP bonuses used in derived stats |

---

## 16. Future Considerations

### Deferred to v0.17.0c

- **LineageTrait Value Object**: Unique trait properties
- **LineageTraitEffectType Enum**: Trait effect categories
- Integration with dice pool system for bonus dice traits

### Deferred to v0.17.0d

- **LineageTraumaBaseline Value Object**: Starting Corruption/Stress
- Integration with Trauma Economy system

### Deferred to v0.17.0e-f

- **ILineageProvider Interface**: Access pattern for lineage data
- **LineageApplicationService**: Actual application of bonuses to character

### Deferred to v0.17.2

- **Derived Stat Calculation**: Actual Max HP/AP formulas using passive bonuses
- Integration with attribute-based calculations

### Out of Scope

- **Negative Passive Bonuses**: Passive bonuses are always advantages
- **Conditional Bonuses**: All passive bonuses are permanent and unconditional
- **Stacking Rules**: Each lineage has unique bonuses with no overlap

---

_Document Version: 1.0_  
_Last Updated: 2026-01-27_  
_Author: AI Assistant_
