# v0.4.1a Changelog: Core Trap System

**Release Date:** 2026-01-12  
**Parent:** v0.4.1 (Traps & Environmental Hazards)  
**Prerequisites:** v0.4.0c (Activation & Destruction)

---

## Summary

v0.4.1a establishes the foundational `Trap` entity with state management, trigger type definitions, and Room integration. This phase creates the base infrastructure for the trap system that subsequent phases (v0.4.1b/c) will extend with detection mechanics, disarm systems, effects, and environmental hazards.

---

## New Features

### TrapState Enum
New enum representing the current state of a trap with 5 states:
- `Hidden` - Trap is hidden and has not been detected
- `Detected` - Trap has been detected but not triggered or disarmed
- `Triggered` - Trap has been triggered and its effect has occurred
- `Disarmed` - Trap has been successfully disarmed
- `Broken` - Trap has been broken or destroyed through force

**State Machine Transitions:**
```
Hidden -> Detected (via detection check)
Hidden -> Triggered (if not detected first)
Detected -> Triggered (failed disarm or stepped on)
Detected -> Disarmed (successful disarm)
Hidden/Detected -> Broken (destroyed by force)
Triggered -> Hidden (if trap resets)
```

### TriggerType Enum
New enum defining how a trap is triggered with 5 types:
- `Step` - Triggered by stepping on (pressure plates, floor tiles)
- `Touch` - Triggered by touching or physically interacting
- `Open` - Triggered by opening a container or door
- `Proximity` - Triggered by entering a proximity radius
- `Tripwire` - Triggered by crossing a tripwire line

### Trap Entity
New domain entity representing hidden dangers that can be triggered by player actions.

**Core Properties:**
- `Id` - Unique identifier (Guid)
- `DefinitionId` - Links to trap definition in configuration
- `Name` - Display name of the trap
- `Description` - Examination description

**State Properties:**
- `State` - Current TrapState
- `TriggerType` - How the trap is triggered

**Detection & Disarm Properties:**
- `DetectionDC` - Difficulty class for Perception checks
- `DisarmDC` - Difficulty class for disarm attempts
- `CanBeDisarmed` - Whether the trap can be disarmed

**Reset Properties:**
- `Resets` - Whether the trap resets after triggering
- `ResetDelay` - Turns until reset trap rearms
- `TurnsUntilReset` - Current countdown to reset

**Attachment Properties:**
- `AttachedObjectId` - ID of object this trap is attached to
- `Keywords` - Keywords for referencing the trap when detected

**Computed Properties:**
- `IsVisible` - Whether trap is visible (detected or triggered)
- `IsActive` - Whether trap can still trigger
- `IsNeutralized` - Whether trap has been neutralized
- `IsPendingReset` - Whether trap is pending a reset

**Methods:**
- `Create()` - Factory method for creating traps
- `FromDefinition()` - Factory method from TrapDefinition
- `Detect()` - Marks the trap as detected
- `Trigger()` - Triggers the trap
- `Disarm()` - Disarms the trap
- `Break()` - Breaks/destroys the trap
- `ProcessTurnTick()` - Handles reset countdown
- `MatchesKeyword()` - Keyword matching for lookups
- `GetStateDescription()` - Human-readable state text

### TrapDefinition
Configuration definition for trap types loaded from JSON.

**Properties:**
- `Id` - Unique identifier (kebab-case)
- `Name` - Display name
- `Description` - Examination description
- `TriggerType` - How trap is triggered
- `DetectionDC` - Default: 10
- `DisarmDC` - Default: 12
- `CanBeDisarmed` - Default: true
- `Resets` - Whether trap resets
- `ResetDelay` - Default: 3 turns
- `AttachedObjectId` - Optional attached object
- `Keywords` - Reference keywords
- `Effect` - Effect configuration (placeholder for v0.4.1b)

### TrapEffectDefinition (Placeholder)
Configuration for trap effects prepared for v0.4.1b implementation:
- `DamageDice` - Damage dice expression (e.g., "2d6")
- `DamageType` - Damage type (e.g., "piercing", "fire")
- `StatusEffects` - Status effects applied
- `SaveDC` - Save DC to reduce/avoid damage
- `SaveType` - Save attribute (e.g., "Agility")
- `TriggerMessage` - Custom trigger message

### TrapTriggerResult Value Object
Result object for trap trigger events:
- `Triggered` - Whether the trap was triggered
- `Message` - Message to display
- `TrapName` - Name of the triggered trap
- `TriggerType` - The trigger type that caused activation
- `WillReset` - Whether the trap will reset

**Factory Methods:**
- `Success()` - Successful trigger result
- `NoTrigger()` - No trap was triggered
- `AlreadyTriggered()` - Trap was already triggered
- `WasDisarmed()` - Trap was disarmed

### TrapDetectionResult Value Object
Result object for trap detection attempts:
- `DetectedAny` - Whether any traps were detected
- `Message` - Message to display
- `DetectedTrapNames` - Names of detected traps
- `HiddenCount` - Number of traps still hidden

**Factory Methods:**
- `Detected()` - Successful detection
- `NoneDetected()` - No traps detected
- `NoHiddenTraps()` - No hidden traps exist

### Room Modifications
New trap collection and management methods added to Room entity:

**Properties:**
- `Traps` - IReadOnlyList<Trap> collection
- `HasTraps` - Whether room has any traps
- `HasActiveTraps` - Whether room has any active traps
- `HasHiddenTraps` - Whether room has any hidden traps

**Methods:**
- `AddTrap(Trap)` - Adds a trap to the room
- `RemoveTrap(Trap)` - Removes a trap from the room
- `GetTrapByKeyword(string)` - Finds trap by keyword
- `GetVisibleTraps()` - Returns visible traps
- `GetHiddenTraps()` - Returns hidden traps
- `GetActiveTraps()` - Returns active traps
- `GetTrapsByTriggerType(TriggerType)` - Filters by trigger type
- `GetTrapAttachedTo(string)` - Gets trap attached to object

### ITrapService Interface
New interface defining trap service operations:
- `GetRoomTrapsDescription(Room)` - Visible traps for room display
- `FindTrap(Room, string)` - Lookup by keyword
- `ExamineTrap(Trap)` - Detailed description
- `DetectTrap(Trap)` - Mark as detected
- `DisarmTrap(Trap)` - Mark as disarmed
- `TriggerTrap(Trap)` - Trigger and return result
- `CheckStepTraps(Room)` - Check for step triggers
- `CheckOpenTrap(Room, string)` - Check for open triggers
- `ProcessRoomTurnTick(Room)` - Handle resets
- `GetRoomTrapSummary(Room)` - Statistics

### TrapService Implementation
Application service implementing ITrapService with:
- Room description generation for visible traps
- Keyword-based trap lookup
- Examination with state and DC display
- Basic state management (detect, disarm, trigger)
- Placeholder methods for step/open trigger checks
- Reset processing via turn tick
- Comprehensive structured logging

### Configuration
- **New file:** `config/traps.json` with sample trap definitions
- **New file:** `config/schemas/traps.schema.json` for validation

---

## Modified Files

### Domain Layer
- `src/Core/RuneAndRust.Domain/Enums/TrapState.cs` [NEW]
- `src/Core/RuneAndRust.Domain/Enums/TriggerType.cs` [NEW]
- `src/Core/RuneAndRust.Domain/Entities/Trap.cs` [NEW]
- `src/Core/RuneAndRust.Domain/Definitions/TrapDefinition.cs` [NEW]
- `src/Core/RuneAndRust.Domain/ValueObjects/TrapTriggerResult.cs` [NEW]
- `src/Core/RuneAndRust.Domain/ValueObjects/TrapDetectionResult.cs` [NEW]
- `src/Core/RuneAndRust.Domain/Entities/Room.cs` [MODIFIED]

### Application Layer
- `src/Core/RuneAndRust.Application/Interfaces/ITrapService.cs` [NEW]
- `src/Core/RuneAndRust.Application/Services/TrapService.cs` [NEW]

### Configuration
- `config/traps.json` [NEW]
- `config/schemas/traps.schema.json` [NEW]

### Tests
- `tests/RuneAndRust.Domain.UnitTests/Enums/TrapStateTests.cs` [NEW]
- `tests/RuneAndRust.Domain.UnitTests/Enums/TriggerTypeTests.cs` [NEW]
- `tests/RuneAndRust.Domain.UnitTests/Entities/TrapTests.cs` [NEW]
- `tests/RuneAndRust.Domain.UnitTests/ValueObjects/TrapTriggerResultTests.cs` [NEW]
- `tests/RuneAndRust.Domain.UnitTests/ValueObjects/TrapDetectionResultTests.cs` [NEW]
- `tests/RuneAndRust.Domain.UnitTests/Entities/RoomTrapTests.cs` [NEW]
- `tests/RuneAndRust.Application.UnitTests/Services/TrapServiceTests.cs` [NEW]

---

## Test Results

```
Passed! - Failed: 0, Passed: 1038, Skipped: 0 - RuneAndRust.Domain.UnitTests.dll
Passed! - Failed: 0, Passed:  454, Skipped: 0 - RuneAndRust.Application.UnitTests.dll
Passed! - Failed: 0, Passed:    8, Skipped: 0 - RuneAndRust.Architecture.Tests.dll

Total: 1500 tests passed
New tests added: ~37
```

---

## Usage Examples

### Creating a Basic Trap
```csharp
var trap = Trap.Create(
    definitionId: "pressure-plate-dart",
    name: "Pressure Plate",
    description: "A hidden pressure plate in the floor tiles.",
    triggerType: TriggerType.Step,
    detectionDC: 12,
    disarmDC: 14,
    canBeDisarmed: true,
    resets: true,
    resetDelay: 3);
```

### Creating from Definition
```csharp
var definition = new TrapDefinition
{
    Id = "poison-needle-trap",
    Name = "Poison Needle Trap",
    Description = "A tiny needle hidden in the lock mechanism.",
    TriggerType = TriggerType.Open,
    DetectionDC = 15,
    DisarmDC = 13,
    CanBeDisarmed = true,
    Resets = false,
    AttachedObjectId = "treasure-chest",
    Keywords = new List<string> { "needle", "poison", "lock" }
};
var trap = Trap.FromDefinition(definition);
```

### Room Integration
```csharp
// Add trap to room
room.AddTrap(trap);

// Check for traps
if (room.HasHiddenTraps)
{
    Console.WriteLine("You sense danger...");
}

// Find trap by keyword
var found = room.GetTrapByKeyword("plate");
if (found != null && found.State == TrapState.Detected)
{
    Console.WriteLine($"You see a {found.Name} here.");
}
```

### Trap State Transitions
```csharp
// Detection
trap.Detect();
// State: Hidden -> Detected

// Trigger
trap.Trigger();
// State: Detected -> Triggered
// If Resets=true, TurnsUntilReset starts countdown

// Reset processing
trap.ProcessTurnTick(); // TurnsUntilReset--
trap.ProcessTurnTick();
trap.ProcessTurnTick(); // State: Triggered -> Hidden

// Disarm
trap.Detect();
trap.Disarm();
// State: Detected -> Disarmed
```

---

## Breaking Changes

None. All changes are additive and backward compatible.

---

## Metrics Summary

| Category | Before | After |
|----------|--------|-------|
| Domain Enums | 15 | 17 |
| Domain Entities | 18 | 19 |
| Value Objects | 24 | 26 |
| Application Interfaces | 12 | 13 |
| Application Services | 11 | 12 |
| Room collection types | 6 | 7 |
| Unit Tests | ~1463 | ~1500 |

---

## v0.4.1 Milestone Progress

| Sub-Version | Focus | Status |
|-------------|-------|--------|
| v0.4.1a | Core Trap System | âœ… Complete |
| v0.4.1b | Trap Mechanics | ðŸ”² Pending |
| v0.4.1c | Environmental Hazards | ðŸ”² Pending |

---

## Future Work

- **v0.4.1b**: Trap detection dice checks, disarm mechanics, trap effects (damage, status effects, alerts), trapped containers integration
- **v0.4.1c**: Environmental hazards, hazard zones, ongoing damage/effects with dice saves
