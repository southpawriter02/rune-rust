# v0.1.1b Design Specification: Seeded Generation

**Version:** 0.1.1b
**Phase Name:** Seeded Generation
**Parent Version:** v0.1.1 (Template-Based Generation)
**Prerequisites:** v0.1.1a Complete (Room Template System)
**Estimated Tests:** ~22 unit tests

---

## Table of Contents

1. [Executive Summary](#1-executive-summary)
2. [Feature Overview](#2-feature-overview)
3. [Architecture Diagrams](#3-architecture-diagrams)
4. [SeededRandom Service](#4-seededrandom-service)
5. [Dungeon Seed Property](#5-dungeon-seed-property)
6. [Position-Based Sub-Seed Derivation](#6-position-based-sub-seed-derivation)
7. [Seed String Format](#7-seed-string-format)
8. [Seed Commands](#8-seed-commands)
9. [Seed Serialization](#9-seed-serialization)
10. [Data Model Changes](#10-data-model-changes)
11. [Configuration File Schemas](#11-configuration-file-schemas)
12. [Logging Specifications](#12-logging-specifications)
13. [Unit Testing Requirements](#13-unit-testing-requirements)
14. [Use Cases](#14-use-cases)
15. [Deliverable Checklist](#15-deliverable-checklist)
16. [Acceptance Criteria](#16-acceptance-criteria)
17. [Dependencies](#17-dependencies)
18. [Future Considerations](#18-future-considerations)

---

## 1. Executive Summary

### 1.1 Purpose

Implement reproducible random generation using seed values, enabling players to share dungeon seeds for identical exploration experiences. The seeded random system ensures deterministic generation where the same seed always produces the same dungeon layout, room content, and encounters at any given position.

### 1.2 Current State

| Area | Current State (v0.1.1a) | Target State (v0.1.1b) |
|------|-------------------------|------------------------|
| Random generation | Non-deterministic `Random` instances | Seeded `SeededRandomService` |
| Dungeon identity | Name and ID only | Includes generation seed |
| Position consistency | Different results each run | Same position + seed = same result |
| Seed sharing | Not possible | Human-readable seed strings |
| New game options | Name only | Name and optional seed |

### 1.3 Key Deliverables

| Category | Items |
|----------|-------|
| **Services** | `SeededRandomService`, `ISeededRandomService` |
| **Entity Updates** | `Dungeon.Seed`, `Dungeon.SeedString` |
| **Commands** | `seed` display, `new game --seed` parameter |
| **Serialization** | Seed in save/load system |
| **Tests** | ~22 new unit tests |

### 1.4 Architectural Significance

This version establishes the **deterministic generation pattern** used throughout procedural content:
- Master seed determines entire dungeon
- Position-based sub-seeds ensure consistency
- Context strings isolate different generation aspects
- Human-readable seed format enables sharing

---

## 2. Feature Overview

```
v0.1.1b Seeded Generation
├── SeededRandom Service
│   ├── Master seed storage
│   ├── Position-based random values
│   ├── Context-isolated sub-generators
│   ├── Weighted selection support
│   └── Float and integer generation
├── Dungeon Seed Property
│   ├── Seed storage on Dungeon entity
│   ├── Human-readable SeedString property
│   ├── Seeded constructor overload
│   └── Integration with CreateStarterDungeon
├── Sub-Seed Derivation
│   ├── Position3D-based hashing
│   ├── Context string isolation
│   ├── Deterministic hash algorithm
│   └── Sub-generator caching
├── Seed String Format
│   ├── 8-character alphanumeric format
│   ├── Ambiguous character exclusion
│   ├── ToSeedString() conversion
│   └── FromSeedString() parsing
├── Seed Commands
│   ├── seed command (display current)
│   └── new game --seed parameter
└── Seed Serialization
    ├── Save game includes seed
    └── Load game restores seed
```

---

## 3. Architecture Diagrams

### 3.1 Layer Diagram

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           PRESENTATION LAYER                                 │
├─────────────────────────────────────────────────────────────────────────────┤
│  Command Handlers:                                                           │
│  ├── SeedCommandHandler          → Displays current dungeon seed            │
│  └── NewGameCommandHandler       → Accepts --seed parameter                 │
│                                                                              │
│  Views:                                                                      │
│  └── MainMenuView                → New Game with optional seed input        │
└─────────────────────────────────────────────────────────────────────────────┘
                                      │
                                      ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                           APPLICATION LAYER                                  │
├─────────────────────────────────────────────────────────────────────────────┤
│  SeededRandomService                GameSessionService                       │
│  ├── MasterSeed                     ├── CreateNewSession(name, seed?)       │
│  ├── NextForPosition()              └── GetCurrentSeed()                    │
│  ├── NextFloatForPosition()                                                 │
│  ├── SelectWeighted()              Interfaces:                              │
│  ├── DeriveSubSeed()               └── ISeededRandomService                 │
│  ├── ToSeedString()                                                         │
│  └── FromSeedString()                                                       │
└─────────────────────────────────────────────────────────────────────────────┘
                                      │
                                      ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                             DOMAIN LAYER                                     │
├─────────────────────────────────────────────────────────────────────────────┤
│  Entities:                                                                   │
│  ┌─────────────────────────────────────────────────────────────────────────┐│
│  │ Dungeon (Updated)                                                        ││
│  │ ├── Seed: int                  ← Generation seed                        ││
│  │ ├── SeedString: string         ← Human-readable format                  ││
│  │ └── Dungeon(name, seed)        ← Seeded constructor                     ││
│  └─────────────────────────────────────────────────────────────────────────┘│
│                                                                              │
│  Value Objects:                                                              │
│  └── Position (X, Y) / Position3D (X, Y, Z) ← Used for sub-seed derivation │
└─────────────────────────────────────────────────────────────────────────────┘
                                      │
                                      ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                         INFRASTRUCTURE LAYER                                 │
├─────────────────────────────────────────────────────────────────────────────┤
│  Serialization:                                                              │
│  └── SaveGameDto                  → Includes dungeon seed                   │
│  └── GameStateSerializer          → Serializes/deserializes seed            │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 3.2 Seeded Random Flow

```
┌───────────────────────────────────────┐
│ New Game Started                       │
│ (with or without seed parameter)       │
└───────────────┬───────────────────────┘
                │
                ▼
┌───────────────────────────────────────────────────────────────┐
│ Determine Master Seed                                         │
├───────────────────────────────────────────────────────────────┤
│ if (seedProvided)                                             │
│     masterSeed = SeededRandomService.FromSeedString(input)    │
│ else                                                          │
│     masterSeed = Environment.TickCount                        │
└───────────────┬───────────────────────────────────────────────┘
                │
                ▼
┌───────────────────────────────────────────────────────────────┐
│ Create Dungeon with Seed                                      │
├───────────────────────────────────────────────────────────────┤
│ var dungeon = new Dungeon("The Forgotten Depths", masterSeed) │
│ var seededRandom = new SeededRandomService(masterSeed)        │
└───────────────┬───────────────────────────────────────────────┘
                │
                ▼
┌───────────────────────────────────────────────────────────────┐
│ Room Generation at Position (X, Y, Z)                         │
├───────────────────────────────────────────────────────────────┤
│ 1. Derive sub-seed: hash(masterSeed, X, Y, Z, context)        │
│ 2. Create/get cached Random instance for sub-seed             │
│ 3. Generate content using seeded random:                      │
│    ├── Template selection                                     │
│    ├── Exit determination                                     │
│    ├── Monster placement                                      │
│    └── Item placement                                         │
│ 4. Same position + seed = identical results                   │
└───────────────────────────────────────────────────────────────┘
```

### 3.3 Sub-Seed Derivation Flow

```
┌───────────────────────────────────────┐
│ Request: Random value for position    │
│ Position: (3, -1, 2)                  │
│ Context: "template_selection"         │
└───────────────┬───────────────────────┘
                │
                ▼
┌───────────────────────────────────────────────────────────────┐
│ DeriveSubSeed(position, context)                              │
├───────────────────────────────────────────────────────────────┤
│ unchecked {                                                   │
│     hash = masterSeed                    // e.g., 12345678    │
│     hash = hash * 31 + position.X        // × 31 + 3          │
│     hash = hash * 31 + position.Y        // × 31 + (-1)       │
│     hash = hash * 31 + position.Z        // × 31 + 2          │
│     hash = hash * 31 + context.GetHashCode()                  │
│     return hash                          // Deterministic!    │
│ }                                                             │
└───────────────┬───────────────────────────────────────────────┘
                │
                ▼
┌───────────────────────────────────────────────────────────────┐
│ GetOrCreateGenerator(subSeed)                                 │
├───────────────────────────────────────────────────────────────┤
│ if (_subGenerators.ContainsKey(subSeed))                      │
│     return cached generator                                   │
│ else                                                          │
│     create new Random(subSeed)                                │
│     cache and return                                          │
└───────────────┬───────────────────────────────────────────────┘
                │
                ▼
┌───────────────────────────────────────────────────────────────┐
│ Return deterministic random value                             │
│ Same inputs = Same output, every time                         │
└───────────────────────────────────────────────────────────────┘
```

### 3.4 Seed String Encoding

```
Integer Seed: 305419896 (0x12345678)

Encoding (base-32 with safe characters):
┌─────────────────────────────────────────────────────────────────┐
│ Characters: ABCDEFGHJKLMNPQRSTUVWXYZ23456789                    │
│ (Excludes: I, O, 0, 1 to avoid ambiguity)                       │
│                                                                 │
│ Process:                                                        │
│ value = 305419896 (as uint)                                     │
│                                                                 │
│ Position 0: value % 32 = 8  → chars[8]  = 'J'                  │
│ value /= 32 → 9544371                                          │
│                                                                 │
│ Position 1: value % 32 = 19 → chars[19] = 'U'                  │
│ value /= 32 → 298261                                           │
│                                                                 │
│ ... (continues for 8 characters)                               │
│                                                                 │
│ Result: "JUXP4MN2" (8 characters)                              │
└─────────────────────────────────────────────────────────────────┘

Decoding:
┌─────────────────────────────────────────────────────────────────┐
│ Input: "JUXP4MN2"                                               │
│                                                                 │
│ For each character, reverse the process:                        │
│ value = 0, multiplier = 1                                       │
│                                                                 │
│ 'J' → index 8,  value += 8 × 1    = 8                          │
│ 'U' → index 19, value += 19 × 32  = 8 + 608 = 616              │
│ ... (continues)                                                │
│                                                                 │
│ Result: 305419896                                               │
└─────────────────────────────────────────────────────────────────┘
```

---

## 4. SeededRandom Service

### 4.1 Purpose

Provide reproducible random number generation from seeds, ensuring that the same seed produces identical results across game sessions and platforms.

### 4.2 Interface

**File:** `src/Core/RuneAndRust.Application/Interfaces/ISeededRandomService.cs`

```csharp
using RuneAndRust.Domain.ValueObjects;

namespace RuneAndRust.Application.Interfaces;

/// <summary>
/// Service for reproducible random number generation from seeds.
/// </summary>
public interface ISeededRandomService
{
    /// <summary>
    /// Gets the master seed for this generator.
    /// </summary>
    int MasterSeed { get; }

    /// <summary>
    /// Gets a deterministic random integer for a position.
    /// </summary>
    /// <param name="position">The position for sub-seed derivation.</param>
    /// <param name="context">Context string for isolation (default: "default").</param>
    /// <returns>A deterministic random integer.</returns>
    int NextForPosition(Position3D position, string context = "default");

    /// <summary>
    /// Gets a deterministic random integer in range for a position.
    /// </summary>
    /// <param name="position">The position for sub-seed derivation.</param>
    /// <param name="minInclusive">Minimum value (inclusive).</param>
    /// <param name="maxExclusive">Maximum value (exclusive).</param>
    /// <param name="context">Context string for isolation.</param>
    /// <returns>A deterministic random integer in the specified range.</returns>
    int NextForPosition(Position3D position, int minInclusive, int maxExclusive, string context = "default");

    /// <summary>
    /// Gets a deterministic float (0.0-1.0) for a position.
    /// </summary>
    /// <param name="position">The position for sub-seed derivation.</param>
    /// <param name="context">Context string for isolation.</param>
    /// <returns>A deterministic float between 0.0 and 1.0.</returns>
    float NextFloatForPosition(Position3D position, string context = "default");

    /// <summary>
    /// Selects a weighted random item for a position.
    /// </summary>
    /// <typeparam name="T">The item type.</typeparam>
    /// <param name="position">The position for sub-seed derivation.</param>
    /// <param name="items">Items with their weights.</param>
    /// <param name="context">Context string for isolation.</param>
    /// <returns>The selected item.</returns>
    T SelectWeighted<T>(Position3D position, IEnumerable<(T item, int weight)> items, string context = "default");

    /// <summary>
    /// Generates a human-readable seed string.
    /// </summary>
    /// <param name="seed">The integer seed to convert.</param>
    /// <returns>An 8-character alphanumeric string.</returns>
    static abstract string ToSeedString(int seed);

    /// <summary>
    /// Parses a seed string back to integer.
    /// </summary>
    /// <param name="seedString">The seed string to parse.</param>
    /// <returns>The integer seed value.</returns>
    /// <exception cref="ArgumentException">Thrown if the seed string contains invalid characters.</exception>
    static abstract int FromSeedString(string seedString);
}
```

### 4.3 Implementation

**File:** `src/Core/RuneAndRust.Application/Services/SeededRandomService.cs`

```csharp
using Microsoft.Extensions.Logging;
using RuneAndRust.Application.Interfaces;
using RuneAndRust.Domain.ValueObjects;

namespace RuneAndRust.Application.Services;

/// <summary>
/// Provides reproducible random number generation from seeds.
/// </summary>
/// <remarks>
/// The SeededRandomService ensures that:
/// - Same master seed produces identical results
/// - Same position + context produces identical sub-results
/// - Different positions/contexts are properly isolated
/// - Results are deterministic across sessions and platforms
/// </remarks>
public class SeededRandomService : ISeededRandomService
{
    private readonly int _masterSeed;
    private readonly Dictionary<int, Random> _subGenerators = new();
    private readonly ILogger<SeededRandomService> _logger;

    /// <inheritdoc/>
    public int MasterSeed => _masterSeed;

    /// <summary>
    /// Creates a new seeded random service with the specified seed.
    /// </summary>
    /// <param name="seed">The master seed for this generator.</param>
    /// <param name="logger">Logger for seed events.</param>
    public SeededRandomService(int seed, ILogger<SeededRandomService> logger)
    {
        _masterSeed = seed;
        _logger = logger ?? throw new ArgumentNullException(nameof(logger));
        _logger.LogInformation("SeededRandomService initialized with seed {Seed} ({SeedString})",
            seed, ToSeedString(seed));
    }

    /// <summary>
    /// Creates a new seeded random service with a random seed.
    /// </summary>
    /// <param name="logger">Logger for seed events.</param>
    public SeededRandomService(ILogger<SeededRandomService> logger)
        : this(Environment.TickCount, logger)
    {
    }

    /// <inheritdoc/>
    public int NextForPosition(Position3D position, string context = "default")
    {
        var subSeed = DeriveSubSeed(position, context);
        var value = GetOrCreateGenerator(subSeed).Next();

        _logger.LogDebug(
            "NextForPosition({Position}, {Context}): subSeed={SubSeed}, value={Value}",
            position, context, subSeed, value);

        return value;
    }

    /// <inheritdoc/>
    public int NextForPosition(Position3D position, int minInclusive, int maxExclusive, string context = "default")
    {
        var subSeed = DeriveSubSeed(position, context);
        var value = GetOrCreateGenerator(subSeed).Next(minInclusive, maxExclusive);

        _logger.LogDebug(
            "NextForPosition({Position}, {Min}-{Max}, {Context}): value={Value}",
            position, minInclusive, maxExclusive, context, value);

        return value;
    }

    /// <inheritdoc/>
    public float NextFloatForPosition(Position3D position, string context = "default")
    {
        var subSeed = DeriveSubSeed(position, context);
        var value = (float)GetOrCreateGenerator(subSeed).NextDouble();

        _logger.LogDebug(
            "NextFloatForPosition({Position}, {Context}): value={Value:F4}",
            position, context, value);

        return value;
    }

    /// <inheritdoc/>
    public T SelectWeighted<T>(Position3D position, IEnumerable<(T item, int weight)> items, string context = "default")
    {
        var list = items.ToList();

        if (list.Count == 0)
            throw new ArgumentException("Items collection cannot be empty.", nameof(items));

        var totalWeight = list.Sum(i => i.weight);

        if (totalWeight <= 0)
            throw new ArgumentException("Total weight must be positive.", nameof(items));

        var roll = NextForPosition(position, 0, totalWeight, context);
        var cumulative = 0;

        foreach (var (item, weight) in list)
        {
            cumulative += weight;
            if (roll < cumulative)
            {
                _logger.LogDebug(
                    "SelectWeighted({Position}, {Context}): roll={Roll}/{Total}, selected index where cumulative={Cumulative}",
                    position, context, roll, totalWeight, cumulative);
                return item;
            }
        }

        // Fallback (should not reach here if weights are correct)
        return list[^1].item;
    }

    /// <summary>
    /// Derives a deterministic sub-seed from position and context.
    /// </summary>
    /// <param name="position">The 3D position.</param>
    /// <param name="context">The context string for isolation.</param>
    /// <returns>A deterministic sub-seed integer.</returns>
    /// <remarks>
    /// The hash algorithm ensures:
    /// - Different positions produce different sub-seeds
    /// - Different contexts produce different sub-seeds
    /// - Same inputs always produce the same sub-seed
    /// </remarks>
    private int DeriveSubSeed(Position3D position, string context)
    {
        unchecked
        {
            var hash = _masterSeed;
            hash = hash * 31 + position.X;
            hash = hash * 31 + position.Y;
            hash = hash * 31 + position.Z;
            hash = hash * 31 + context.GetHashCode(StringComparison.Ordinal);
            return hash;
        }
    }

    /// <summary>
    /// Gets or creates a cached Random generator for a sub-seed.
    /// </summary>
    /// <param name="subSeed">The sub-seed for this generator.</param>
    /// <returns>A Random instance seeded with the sub-seed.</returns>
    private Random GetOrCreateGenerator(int subSeed)
    {
        if (!_subGenerators.TryGetValue(subSeed, out var generator))
        {
            generator = new Random(subSeed);
            _subGenerators[subSeed] = generator;

            _logger.LogDebug("Created new sub-generator for subSeed {SubSeed}", subSeed);
        }

        return generator;
    }

    /// <summary>
    /// Clears cached sub-generators to free memory.
    /// </summary>
    /// <remarks>
    /// Call this when moving to a new dungeon or when memory pressure is high.
    /// Sub-generators will be recreated on demand with the same deterministic results.
    /// </remarks>
    public void ClearSubGenerators()
    {
        var count = _subGenerators.Count;
        _subGenerators.Clear();
        _logger.LogDebug("Cleared {Count} cached sub-generators", count);
    }

    // ===== Static Seed String Methods =====

    /// <summary>
    /// Character set for seed strings (excludes ambiguous characters).
    /// </summary>
    private const string SeedChars = "ABCDEFGHJKLMNPQRSTUVWXYZ23456789";

    /// <inheritdoc/>
    public static string ToSeedString(int seed)
    {
        var result = new char[8];
        var value = (uint)seed;

        for (int i = 0; i < 8; i++)
        {
            result[i] = SeedChars[(int)(value % (uint)SeedChars.Length)];
            value /= (uint)SeedChars.Length;
        }

        return new string(result);
    }

    /// <inheritdoc/>
    public static int FromSeedString(string seedString)
    {
        if (string.IsNullOrWhiteSpace(seedString))
            throw new ArgumentException("Seed string cannot be empty.", nameof(seedString));

        if (seedString.Length != 8)
            throw new ArgumentException($"Seed string must be exactly 8 characters (got {seedString.Length}).", nameof(seedString));

        uint value = 0;
        uint multiplier = 1;

        foreach (char c in seedString.ToUpperInvariant())
        {
            var index = SeedChars.IndexOf(c);
            if (index < 0)
                throw new ArgumentException($"Invalid seed character: '{c}'. Valid characters: {SeedChars}", nameof(seedString));

            value += (uint)index * multiplier;
            multiplier *= (uint)SeedChars.Length;
        }

        return (int)value;
    }

    /// <summary>
    /// Validates a seed string without parsing it.
    /// </summary>
    /// <param name="seedString">The seed string to validate.</param>
    /// <returns>True if the seed string is valid; false otherwise.</returns>
    public static bool IsValidSeedString(string seedString)
    {
        if (string.IsNullOrWhiteSpace(seedString) || seedString.Length != 8)
            return false;

        return seedString.ToUpperInvariant().All(c => SeedChars.Contains(c));
    }
}
```

---

## 5. Dungeon Seed Property

### 5.1 Purpose

Store the generation seed on the Dungeon entity, enabling seed retrieval for display and ensuring reproducibility when loading saved games.

### 5.2 Implementation

**File:** `src/Core/RuneAndRust.Domain/Entities/Dungeon.cs` (modifications)

```csharp
// Add to existing Dungeon class:

/// <summary>
/// Gets the seed used to generate this dungeon.
/// </summary>
/// <remarks>
/// The same seed produces identical dungeon layouts, enabling
/// reproducible exploration and seed sharing between players.
/// A value of 0 indicates an unseeded (legacy) dungeon.
/// </remarks>
public int Seed { get; private set; }

/// <summary>
/// Gets the human-readable seed string.
/// </summary>
/// <remarks>
/// The seed string is an 8-character alphanumeric code that can be
/// easily shared and entered by players. Returns null for unseeded dungeons.
/// </remarks>
public string? SeedString => Seed != 0 ? SeededRandomService.ToSeedString(Seed) : null;

/// <summary>
/// Creates a new dungeon with the specified name and seed.
/// </summary>
/// <param name="name">The display name for the dungeon.</param>
/// <param name="seed">The generation seed for reproducibility.</param>
/// <exception cref="ArgumentNullException">Thrown when name is null.</exception>
public Dungeon(string name, int seed) : this(name)
{
    Seed = seed;
}

/// <summary>
/// Creates a seeded starter dungeon for new games.
/// </summary>
/// <param name="seed">The generation seed.</param>
/// <returns>A new seeded dungeon ready for procedural generation.</returns>
public static Dungeon CreateSeededDungeon(string name, int seed)
{
    return new Dungeon(name, seed);
}
```

### 5.3 Constructor Overload

The new constructor allows creating dungeons with a specific seed:

```csharp
// Without seed (generates random seed)
var dungeon1 = new Dungeon("My Dungeon");

// With seed (reproducible)
var dungeon2 = new Dungeon("My Dungeon", 12345678);

// From seed string
var seedValue = SeededRandomService.FromSeedString("HXKP4MN2");
var dungeon3 = new Dungeon("Shared Dungeon", seedValue);
```

---

## 6. Position-Based Sub-Seed Derivation

### 6.1 Purpose

Ensure that the same position in a seeded dungeon always produces identical content, regardless of exploration order or session.

### 6.2 Algorithm

The sub-seed derivation uses a polynomial rolling hash:

```csharp
unchecked
{
    var hash = masterSeed;
    hash = hash * 31 + position.X;
    hash = hash * 31 + position.Y;
    hash = hash * 31 + position.Z;
    hash = hash * 31 + context.GetHashCode(StringComparison.Ordinal);
    return hash;
}
```

### 6.3 Context Isolation

Context strings ensure different generation aspects don't interfere:

| Context String | Used For |
|---------------|----------|
| `"template_selection"` | Choosing room template |
| `"exit_generation"` | Determining which exits exist |
| `"monster_spawn"` | Monster type and count |
| `"item_spawn"` | Item type and placement |
| `"description"` | Variable description content |

### 6.4 Example Values

```
Master Seed: 305419896
Position: (3, -1, 2)

Context: "template_selection"
Sub-seed: -1847293847
Result: Template "dungeon-corridor-narrow"

Context: "monster_spawn"
Sub-seed: 982374123
Result: 1 goblin, no additional spawns

Context: "item_spawn"
Sub-seed: -47283912
Result: Health potion at 30% chance = no spawn
```

---

## 7. Seed String Format

### 7.1 Design Goals

- **Human-readable**: Easy to read, type, and share
- **Unambiguous**: No confusing characters (I/1, O/0)
- **Compact**: 8 characters fits most UI constraints
- **Full coverage**: Represents all int32 values

### 7.2 Character Set

```
ABCDEFGHJKLMNPQRSTUVWXYZ23456789
```

**Excluded characters:**
- `I` - Looks like `1` or `l`
- `O` - Looks like `0`
- `0` - Looks like `O`
- `1` - Looks like `I` or `l`

### 7.3 Encoding Range

- 32 characters in base
- 8 positions
- Total combinations: 32^8 = 1,099,511,627,776
- Covers full int32 range (4,294,967,296 values)

### 7.4 Example Seeds

| Integer Seed | Seed String |
|-------------|-------------|
| 0 | `AAAAAAAA` |
| 1 | `BAAAAAAA` |
| 31 | `9AAAAAAA` |
| 32 | `ABAAAAAA` |
| 305419896 | `HXKP4MN2` |
| 2147483647 | `VVVVVVVF` |
| -1 | `99999999` |

---

## 8. Seed Commands

### 8.1 Seed Display Command

**Command:** `seed`

**Purpose:** Display the current dungeon's seed for sharing.

**File:** `src/Presentation/RuneAndRust.Presentation.Tui/Commands/SeedCommandHandler.cs`

```csharp
using RuneAndRust.Application.Interfaces;

namespace RuneAndRust.Presentation.Tui.Commands;

/// <summary>
/// Handles the 'seed' command to display the current dungeon seed.
/// </summary>
public class SeedCommandHandler : ICommandHandler
{
    private readonly IGameSessionService _sessionService;
    private readonly IGameRenderer _renderer;

    public string Command => "seed";
    public string Description => "Display the current dungeon seed for sharing";
    public string Usage => "seed";

    public SeedCommandHandler(
        IGameSessionService sessionService,
        IGameRenderer renderer)
    {
        _sessionService = sessionService;
        _renderer = renderer;
    }

    public async Task<bool> HandleAsync(string[] args, CancellationToken ct = default)
    {
        var session = _sessionService.GetCurrentSession();
        if (session == null)
        {
            await _renderer.RenderMessageAsync(
                "No active game session.",
                MessageType.Warning, ct);
            return false;
        }

        var seedString = session.Dungeon.SeedString;
        if (seedString == null)
        {
            await _renderer.RenderMessageAsync(
                "This dungeon was not generated with a seed.",
                MessageType.Info, ct);
            return true;
        }

        await _renderer.RenderMessageAsync(
            $"Current dungeon seed: {seedString}",
            MessageType.Success, ct);

        await _renderer.RenderMessageAsync(
            "Share this seed to let others explore the same dungeon!",
            MessageType.Info, ct);

        return true;
    }
}
```

**Output Example:**
```
> seed
Current dungeon seed: HXKP4MN2
Share this seed to let others explore the same dungeon!
```

### 8.2 New Game with Seed

**Command:** `new game --seed XXXXXXXX`

**Purpose:** Start a new game with a specific seed.

**File:** Updates to `src/Presentation/RuneAndRust.Presentation.Tui/Views/MainMenuView.cs`

```csharp
/// <summary>
/// Prompts for and validates a seed input.
/// </summary>
/// <param name="ct">Cancellation token.</param>
/// <returns>The validated seed, or null for random seed.</returns>
private async Task<int?> PromptForSeedAsync(CancellationToken ct)
{
    await _renderer.RenderMessageAsync(
        "Enter a seed (8 characters) or press Enter for random:",
        MessageType.Info, ct);

    var input = await _inputService.ReadLineAsync(ct);

    if (string.IsNullOrWhiteSpace(input))
    {
        return null; // Use random seed
    }

    input = input.Trim().ToUpperInvariant();

    if (!SeededRandomService.IsValidSeedString(input))
    {
        await _renderer.RenderMessageAsync(
            $"Invalid seed format. Seeds must be 8 characters using: {SeededRandomService.SeedChars}",
            MessageType.Warning, ct);
        return await PromptForSeedAsync(ct); // Retry
    }

    return SeededRandomService.FromSeedString(input);
}

/// <summary>
/// Creates a new game session with optional seed.
/// </summary>
private async Task StartNewGameAsync(string playerName, int? seed, CancellationToken ct)
{
    var actualSeed = seed ?? Environment.TickCount;
    var session = _sessionService.CreateNewSession(playerName, actualSeed);

    await _renderer.RenderMessageAsync(
        $"Starting new game with seed {session.Dungeon.SeedString}...",
        MessageType.Success, ct);

    // Continue to game...
}
```

**Interaction Example:**
```
=== New Game ===
Enter character name: Hero

Enter a seed (8 characters) or press Enter for random: HXKP4MN2

Starting new game with seed HXKP4MN2...
You find yourself in a familiar dungeon...
```

---

## 9. Seed Serialization

### 9.1 Purpose

Ensure seeds are saved and loaded with game state, maintaining reproducibility across sessions.

### 9.2 SaveGameDto Updates

**File:** `src/Infrastructure/RuneAndRust.Infrastructure/Serialization/SaveGameDto.cs`

```csharp
/// <summary>
/// Data transfer object for game save data.
/// </summary>
public class SaveGameDto
{
    /// <summary>
    /// Version of the save format.
    /// </summary>
    public string Version { get; set; } = "1.1";

    /// <summary>
    /// Player data.
    /// </summary>
    public PlayerDto Player { get; set; } = null!;

    /// <summary>
    /// Dungeon data.
    /// </summary>
    public DungeonDto Dungeon { get; set; } = null!;

    /// <summary>
    /// Current session state.
    /// </summary>
    public SessionDto Session { get; set; } = null!;
}

/// <summary>
/// Dungeon data for serialization.
/// </summary>
public class DungeonDto
{
    /// <summary>
    /// Dungeon unique identifier.
    /// </summary>
    public Guid Id { get; set; }

    /// <summary>
    /// Dungeon display name.
    /// </summary>
    public string Name { get; set; } = null!;

    /// <summary>
    /// Generation seed for reproducibility.
    /// </summary>
    public int Seed { get; set; }

    /// <summary>
    /// Rooms that have been generated and explored.
    /// </summary>
    public List<RoomDto> Rooms { get; set; } = [];

    /// <summary>
    /// Starting room identifier.
    /// </summary>
    public Guid StartingRoomId { get; set; }
}
```

### 9.3 Serialization Flow

```
Save Game:
1. Get dungeon.Seed
2. Include in DungeonDto
3. Serialize to JSON

Load Game:
1. Deserialize JSON
2. Create Dungeon with seed
3. Recreate SeededRandomService with same seed
4. Resume exploration with deterministic generation
```

---

## 10. Data Model Changes

### 10.1 Entity Updates

| Entity | Property | Type | Description |
|--------|----------|------|-------------|
| `Dungeon` | `Seed` | `int` | Generation seed (0 = unseeded) |
| `Dungeon` | `SeedString` | `string?` | Human-readable 8-char format |

### 10.2 New Services

| Service | Layer | Description |
|---------|-------|-------------|
| `SeededRandomService` | Application | Reproducible random generation |
| `ISeededRandomService` | Application | Interface for seeded random |

### 10.3 Constructor Changes

**Dungeon Entity:**
- Added `Dungeon(string name, int seed)` constructor
- Added `CreateSeededDungeon(string name, int seed)` factory method

---

## 11. Configuration File Schemas

### 11.1 No New Configuration Files

This version does not introduce new configuration files. The seed system is code-driven and does not require external configuration.

### 11.2 Save Game Schema Update

**File:** `config/schemas/save-game.schema.json` (update)

```json
{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "save-game.schema.json",
  "title": "Save Game Schema",
  "type": "object",
  "required": ["version", "player", "dungeon", "session"],
  "properties": {
    "version": {
      "type": "string",
      "pattern": "^\\d+\\.\\d+$"
    },
    "dungeon": {
      "type": "object",
      "required": ["id", "name", "seed", "rooms", "startingRoomId"],
      "properties": {
        "id": { "type": "string", "format": "uuid" },
        "name": { "type": "string" },
        "seed": {
          "type": "integer",
          "description": "Generation seed for reproducible dungeon generation"
        },
        "rooms": { "type": "array" },
        "startingRoomId": { "type": "string", "format": "uuid" }
      }
    }
  }
}
```

---

## 12. Logging Specifications

### 12.1 Log Levels by Component

| Component | Level | Events |
|-----------|-------|--------|
| `SeededRandomService` | Information | Service initialization with seed |
| `SeededRandomService` | Debug | Sub-seed derivation, value generation |
| `SeededRandomService` | Debug | Sub-generator creation/caching |
| `SeedCommandHandler` | Information | Seed display requests |
| `GameSessionService` | Information | New game creation with seed |

### 12.2 Log Message Examples

```
// Information
[SeededRandomService] SeededRandomService initialized with seed 305419896 (HXKP4MN2)
[GameSessionService] Created new session for 'Hero' with seed HXKP4MN2

// Debug
[SeededRandomService] NextForPosition((3, -1, 2), template_selection): subSeed=-1847293847, value=42
[SeededRandomService] Created new sub-generator for subSeed -1847293847
[SeededRandomService] SelectWeighted((3, -1, 2), monster_spawn): roll=15/100, selected index where cumulative=40
[SeededRandomService] Cleared 127 cached sub-generators
```

---

## 13. Unit Testing Requirements

### 13.1 Test Count by Feature

| Feature | Test Count |
|---------|------------|
| SeededRandomService | 10 |
| Seed string conversion | 5 |
| Dungeon seed property | 3 |
| Reproducibility validation | 4 |
| **Total** | **~22** |

### 13.2 Test Categories

#### SeededRandomService Tests

**File:** `tests/RuneAndRust.Application.UnitTests/Services/SeededRandomServiceTests.cs`

1. `Constructor_WithSeed_StoresMasterSeed`
2. `NextForPosition_SameInputs_ReturnsSameValue`
3. `NextForPosition_DifferentPositions_ReturnsDifferentValues`
4. `NextForPosition_DifferentContexts_ReturnsDifferentValues`
5. `NextForPosition_WithRange_ReturnsValueInRange`
6. `NextFloatForPosition_ReturnsBetweenZeroAndOne`
7. `SelectWeighted_RespectsWeights`
8. `SelectWeighted_SameInputs_ReturnsSameItem`
9. `SelectWeighted_EmptyList_ThrowsArgumentException`
10. `ClearSubGenerators_ClearsCache`

#### Seed String Tests

**File:** `tests/RuneAndRust.Application.UnitTests/Services/SeededRandomServiceSeedStringTests.cs`

1. `ToSeedString_ReturnsEightCharacters`
2. `ToSeedString_UsesOnlyValidCharacters`
3. `FromSeedString_RoundTrips_WithToSeedString`
4. `FromSeedString_InvalidCharacter_ThrowsArgumentException`
5. `IsValidSeedString_ValidString_ReturnsTrue`

#### Dungeon Seed Tests

**File:** `tests/RuneAndRust.Domain.UnitTests/Entities/DungeonSeedTests.cs`

1. `Constructor_WithSeed_StoresSeed`
2. `SeedString_WithValidSeed_ReturnsFormattedString`
3. `SeedString_WithZeroSeed_ReturnsNull`

#### Reproducibility Tests

**File:** `tests/RuneAndRust.Application.IntegrationTests/SeededGenerationTests.cs`

1. `SameSeed_ProducesIdenticalRoomAtPosition`
2. `SameSeed_DifferentOrder_ProducesIdenticalResults`
3. `DifferentSeeds_ProduceDifferentResults`
4. `SaveAndLoad_PreservesSeed`

---

## 14. Use Cases

### UC-001: Display Current Seed
**Actor:** Player
**Flow:** Player types `seed` → System retrieves dungeon seed → Display seed string → Player can share seed

### UC-002: Start New Game with Seed
**Actor:** Player
**Flow:** Select New Game → Enter character name → Enter seed string → System validates seed → Create session with seed → Begin game

### UC-003: Start New Game with Random Seed
**Actor:** Player
**Flow:** Select New Game → Enter character name → Press Enter (no seed) → System generates random seed → Display seed → Begin game

### UC-004: Reproducible Room Generation
**Actor:** System
**Flow:** Player moves to new position → Derive sub-seed from position → Generate room content → Same position + seed always produces same room

### UC-005: Save and Load with Seed
**Actor:** Player
**Flow:** Save game (seed included) → Load game later → Restore seed → Future exploration remains deterministic

---

## 15. Deliverable Checklist

### Application Layer
- [ ] `ISeededRandomService` interface defined
- [ ] `SeededRandomService` implementation complete
- [ ] Static `ToSeedString()` method implemented
- [ ] Static `FromSeedString()` method implemented
- [ ] Static `IsValidSeedString()` method implemented
- [ ] Sub-generator caching implemented
- [ ] `ClearSubGenerators()` method implemented

### Domain Layer
- [ ] `Dungeon.Seed` property added
- [ ] `Dungeon.SeedString` property added
- [ ] `Dungeon(name, seed)` constructor added
- [ ] `CreateSeededDungeon()` factory method added

### Presentation Layer
- [ ] `SeedCommandHandler` implemented
- [ ] Seed display formatting complete
- [ ] New game seed input prompt added
- [ ] Seed validation feedback implemented

### Infrastructure Layer
- [ ] `DungeonDto.Seed` property added
- [ ] Save game serialization includes seed
- [ ] Load game restores seed

### Testing
- [ ] ~22 unit tests implemented
- [ ] All tests passing
- [ ] Reproducibility tests verify determinism

---

## 16. Acceptance Criteria

### Functional
- [ ] SeededRandomService generates reproducible values from seed
- [ ] Same position + seed always produces same result
- [ ] Different positions produce different results
- [ ] Different contexts produce different results
- [ ] Dungeon entity stores seed value
- [ ] Dungeon.SeedString returns 8-character format
- [ ] `seed` command displays current seed
- [ ] New game accepts optional seed parameter
- [ ] Seed string format uses only valid characters
- [ ] ToSeedString/FromSeedString round-trip correctly
- [ ] Save game includes seed
- [ ] Load game restores seed and reproducibility

### Quality
- [ ] Build succeeds with 0 errors and 0 warnings
- [ ] All ~22 unit tests pass
- [ ] XML documentation complete for all public APIs
- [ ] Logging follows specified patterns

---

## 17. Dependencies

### Requires (from prior versions)
- v0.1.1a: `RoomTemplate` entity, `TemplateSelectionService`
- v0.1.0b: `GenerationContext`, `Position3D` (if implemented)
- v0.0.x: `Position` value object, `Dungeon` entity

### Provides (for future versions)
- `SeededRandomService` for v0.1.1c difficulty scaling
- `ISeededRandomService` interface for dependency injection
- Seed infrastructure for v0.1.1d branch generation

---

## 18. Future Considerations

### Deferred to v0.1.1c: Difficulty Scaling
- Integration of seeded random with difficulty calculations
- Seeded monster tier selection
- Seeded loot quality determination

### Deferred to v0.1.1d: Branch Generation
- Seeded branch path determination
- Seeded dead-end placement
- Seeded special room distribution

### Out of Scope
- Seed versioning for format changes
- Seed migration between game versions
- Seed-based leaderboards or challenges
- Multi-dungeon seed coordination

---

*Document Version: 1.0*
*Last Updated: 2026-01-08*
*Author: Claude*
