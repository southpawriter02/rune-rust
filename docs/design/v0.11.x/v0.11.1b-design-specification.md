# v0.11.1b Design Specification: Recipe Book

**Version:** 0.11.1b
**Status:** Planning
**Focus:** Player recipe book tracking and recipe service management
**Prerequisite:** v0.11.1a (Recipe Definitions)

---

## Table of Contents

1. [Executive Summary](#1-executive-summary)
2. [Feature Overview](#2-feature-overview)
3. [Architecture Diagrams](#3-architecture-diagrams)
4. [RecipeBook Entity](#4-recipebook-entity)
5. [Player Integration](#5-player-integration)
6. [LearnRecipeResult Record](#6-learnreciperesult-record)
7. [CraftValidation Record](#7-craftvalidation-record)
8. [RecipeLearnedEvent](#8-recipelearnedevent)
9. [IRecipeService Interface](#9-irecipeservice-interface)
10. [RecipeService Implementation](#10-recipeservice-implementation)
11. [RecipesCommand](#11-recipescommand)
12. [Logging Specifications](#12-logging-specifications)
13. [Unit Testing Requirements](#13-unit-testing-requirements)
14. [Use Cases](#14-use-cases)
15. [Deliverable Checklist](#15-deliverable-checklist)
16. [Acceptance Criteria](#16-acceptance-criteria)
17. [Dependencies](#17-dependencies)
18. [Future Considerations](#18-future-considerations)

---

## 1. Executive Summary

Version 0.11.1b introduces the **Recipe Book** system, enabling players to track which crafting recipes they know. Players start with a set of default recipes and can learn additional recipes through discovery (implemented in v0.11.1c). The recipe service provides methods for querying known recipes, learning new recipes, and validating crafting prerequisites.

This version builds on the recipe definitions from v0.11.1a, adding the player-facing recipe management layer that will be used by the crafting system in v0.11.2.

### Key Deliverables

| Category | Items |
|----------|-------|
| **Domain Entities** | RecipeBook |
| **Domain Events** | RecipeLearnedEvent |
| **Application Records** | LearnRecipeResult, CraftValidation, MissingIngredient |
| **Application Interfaces** | IRecipeService |
| **Application Services** | RecipeService |
| **Player Updates** | RecipeBook property integration |
| **Commands** | RecipesCommand |
| **Tests** | ~8 new unit tests |

### Architectural Significance

This version establishes the **knowledge tracking pattern** that separates what exists (definitions) from what is known (player's recipe book):

- **Separation of Concerns**: Definitions exist independently; players track what they've learned
- **Default Initialization**: New players automatically receive starter recipes
- **Service Layer**: Recipe service mediates between definitions and player knowledge
- **Event-Driven**: Learning triggers events for achievements/statistics

---

## 2. Feature Overview

```
v0.11.1b Features
├── RecipeBook Entity
│   ├── KnownRecipeIds Collection
│   ├── LearnedAt Timestamps
│   ├── IsKnown Check
│   ├── Learn Method
│   ├── GetLearnedDate Query
│   ├── KnownCount Property
│   └── InitializeDefaults Method
├── Player Integration
│   ├── RecipeBook Property
│   └── Initialization on Creation
├── Result Records
│   ├── LearnRecipeResult
│   │   ├── Success Factory
│   │   ├── AlreadyKnown Factory
│   │   └── RecipeNotFound Factory
│   ├── CraftValidation
│   │   ├── Success Factory
│   │   ├── Failed Factory
│   │   └── InsufficientResources Factory
│   └── MissingIngredient Record
├── RecipeLearnedEvent
│   ├── PlayerId
│   ├── RecipeId
│   └── RecipeName
├── IRecipeService Interface
│   ├── GetKnownRecipes
│   ├── GetKnownRecipesByCategory
│   ├── GetCraftableRecipes
│   ├── IsRecipeKnown
│   ├── LearnRecipe
│   ├── InitializeDefaultRecipes
│   ├── GetKnownRecipe
│   └── CanCraft
├── RecipeService Implementation
│   ├── Recipe Queries
│   ├── Learning Logic
│   ├── Validation Logic
│   └── Event Publishing
└── RecipesCommand
    ├── List Known Recipes
    ├── Filter by Category
    └── Display Formatting
```

---

## 3. Architecture Diagrams

### 3.1 Recipe Book Architecture

```
┌─────────────────────────────────────────────────────────────────────────┐
│                       RECIPE BOOK ARCHITECTURE                           │
└─────────────────────────────────────────────────────────────────────────┘

                         ┌───────────────────────────────────────┐
                         │               Player                   │
                         ├───────────────────────────────────────┤
                         │ + Id: Guid                            │
                         │ + Name: string                        │
                         │ + Inventory: Inventory                │
                         │ + RecipeBook: RecipeBook  ◀──── NEW   │
                         └───────────────────┬───────────────────┘
                                             │ contains
                                             ▼
                         ┌───────────────────────────────────────┐
                         │            RecipeBook                  │
                         ├───────────────────────────────────────┤
                         │ + Id: Guid                            │
                         │ + PlayerId: Guid                      │
                         │ - _knownRecipeIds: HashSet<string>    │
                         │ - _learnedAt: Dict<string, DateTime>  │
                         ├───────────────────────────────────────┤
                         │ + KnownRecipeIds: IReadOnlySet        │
                         │ + KnownCount: int                     │
                         │ + IsKnown(recipeId): bool             │
                         │ + Learn(recipeId): bool               │
                         │ + GetLearnedDate(recipeId): DateTime? │
                         │ + InitializeDefaults(ids): void       │
                         └───────────────────────────────────────┘
                                             │
                                             │ queried by
                                             ▼
                         ┌───────────────────────────────────────┐
                         │          IRecipeService                │
                         ├───────────────────────────────────────┤
                         │ + GetKnownRecipes(player)             │
                         │ + GetKnownRecipesByCategory(p, cat)   │
                         │ + GetCraftableRecipes(p, stationId)   │
                         │ + IsRecipeKnown(player, recipeId)     │
                         │ + LearnRecipe(player, recipeId)       │
                         │ + InitializeDefaultRecipes(player)    │
                         │ + GetKnownRecipe(player, recipeId)    │
                         │ + CanCraft(player, recipeId, station) │
                         └───────────────────────────────────────┘
```

### 3.2 Recipe Learning Flow

```
┌─────────────────────────────────────────────────────────────────────────┐
│                        RECIPE LEARNING FLOW                              │
└─────────────────────────────────────────────────────────────────────────┘

    Player learns recipe (scroll, quest, NPC, etc.)
                        │
                        ▼
              ┌─────────────────────┐
              │ LearnRecipe(player, │
              │     recipeId)       │
              └──────────┬──────────┘
                         │
                         ▼
              ┌─────────────────────┐
              │ Recipe exists?      │
              │ _recipeProvider     │
              │   .GetRecipe(id)    │
              └──────────┬──────────┘
                         │
            ┌────────────┴────────────┐
            │                         │
            ▼ null                    ▼ found
   ┌─────────────────┐      ┌─────────────────────┐
   │ Return:         │      │ Already known?      │
   │ RecipeNotFound  │      │ player.RecipeBook   │
   └─────────────────┘      │   .IsKnown(id)      │
                            └──────────┬──────────┘
                                       │
                          ┌────────────┴────────────┐
                          │                         │
                          ▼ true                    ▼ false
                 ┌─────────────────┐      ┌─────────────────────┐
                 │ Return:         │      │ Learn the recipe    │
                 │ AlreadyKnown    │      │ player.RecipeBook   │
                 └─────────────────┘      │   .Learn(id)        │
                                          └──────────┬──────────┘
                                                     │
                                                     ▼
                                          ┌─────────────────────┐
                                          │ Log & publish event │
                                          │ RecipeLearnedEvent  │
                                          └──────────┬──────────┘
                                                     │
                                                     ▼
                                          ┌─────────────────────┐
                                          │ Return: Success     │
                                          │ (recipeId, name)    │
                                          └─────────────────────┘
```

### 3.3 Craft Validation Flow

```
┌─────────────────────────────────────────────────────────────────────────┐
│                       CRAFT VALIDATION FLOW                              │
└─────────────────────────────────────────────────────────────────────────┘

    Player attempts to craft
                │
                ▼
    ┌───────────────────────────┐
    │ CanCraft(player, recipeId,│
    │          stationId)       │
    └─────────────┬─────────────┘
                  │
                  ▼
    ┌───────────────────────────┐
    │ 1. Recipe exists?         │
    │    _recipeProvider        │
    │      .GetRecipe(id)       │
    └─────────────┬─────────────┘
                  │
        ┌─────────┴─────────┐
        │                   │
        ▼ null              ▼ found
  ┌───────────┐    ┌────────────────────┐
  │ Failed:   │    │ 2. Recipe known?   │
  │ "Recipe   │    │    player.RecipeBook│
  │ not found"│    │      .IsKnown(id)  │
  └───────────┘    └─────────┬──────────┘
                             │
                   ┌─────────┴─────────┐
                   │                   │
                   ▼ false             ▼ true
           ┌───────────┐     ┌────────────────────┐
           │ Failed:   │     │ 3. Correct station?│
           │ "Don't    │     │    recipe.Required │
           │ know this │     │    StationId ==    │
           │ recipe"   │     │    stationId       │
           └───────────┘     └─────────┬──────────┘
                                       │
                             ┌─────────┴─────────┐
                             │                   │
                             ▼ false             ▼ true/null
                     ┌───────────┐     ┌────────────────────┐
                     │ Failed:   │     │ 4. Has ingredients?│
                     │ "Requires │     │    recipe          │
                     │ [station]"│     │    .HasIngredients │
                     └───────────┘     │    (inventory)     │
                                       └─────────┬──────────┘
                                                 │
                                       ┌─────────┴─────────┐
                                       │                   │
                                       ▼ false             ▼ true
                               ┌───────────────┐   ┌───────────────┐
                               │ Insufficient  │   │ Success       │
                               │ Resources:    │   │ (recipe)      │
                               │ [missing list]│   └───────────────┘
                               └───────────────┘
```

### 3.4 Layer Diagram

```
┌─────────────────────────────────────────────────────────────────────────┐
│                           LAYER DIAGRAM                                  │
└─────────────────────────────────────────────────────────────────────────┘

    Presentation Layer
    ─────────────────
    ┌─────────────────────────────────────────────────────────────────────┐
    │                        RecipesCommand                                │
    │   > recipes                    > recipes weapon                      │
    │   Lists all known recipes      Lists known weapon recipes            │
    └─────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
    Application Layer
    ─────────────────
    ┌─────────────────────────────────────────────────────────────────────┐
    │                        IRecipeService                                │
    │                              │                                       │
    │                              ▼                                       │
    │                        RecipeService                                 │
    │   ┌───────────────┐  ┌───────────────┐  ┌───────────────────────┐   │
    │   │IRecipeProvider│  │IResourceProvd.│  │     IEventBus         │   │
    │   │   (v0.11.1a)  │  │  (v0.11.0a)   │  │                       │   │
    │   └───────────────┘  └───────────────┘  └───────────────────────┘   │
    └─────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
    Domain Layer
    ────────────
    ┌─────────────────────────────────────────────────────────────────────┐
    │  ┌─────────────┐  ┌─────────────┐  ┌─────────────────────────────┐  │
    │  │   Player    │  │ RecipeBook  │  │    RecipeLearnedEvent       │  │
    │  │  (updated)  │  │   (new)     │  │         (new)               │  │
    │  └─────────────┘  └─────────────┘  └─────────────────────────────┘  │
    └─────────────────────────────────────────────────────────────────────┘
```

### 3.5 Recipe Book UI Mockup

```
┌─────────────────────────────────────────────────────────────────────────┐
│                        RECIPE BOOK UI MOCKUP                             │
└─────────────────────────────────────────────────────────────────────────┘

    > recipes

    ╔═══════════════════════════════════════════════════════════════════════╗
    ║  RECIPE BOOK                                           Known: 9/15    ║
    ╠═══════════════════════════════════════════════════════════════════════╣
    ║                                                                       ║
    ║  WEAPON RECIPES (2)                                                   ║
    ║  ├─ ✓ Iron Sword           [Default]  Station: Anvil       DC: 12    ║
    ║  └─ ✓ Steel Sword          [Learned]  Station: Anvil       DC: 14    ║
    ║                                                                       ║
    ║  ARMOR RECIPES (3)                                                    ║
    ║  ├─ ✓ Iron Helmet          [Default]  Station: Anvil       DC: 12    ║
    ║  ├─ ✓ Iron Chestplate      [Default]  Station: Anvil       DC: 13    ║
    ║  └─ ✓ Leather Armor        [Default]  Station: Workbench   DC: 11    ║
    ║                                                                       ║
    ║  POTION RECIPES (2)                                                   ║
    ║  ├─ ✓ Healing Potion       [Default]  Station: Alchemy     DC: 10    ║
    ║  └─ ✓ Mana Potion          [Default]  Station: Alchemy     DC: 12    ║
    ║                                                                       ║
    ║  TOOL RECIPES (1)                                                     ║
    ║  └─ ✓ Iron Pickaxe         [Default]  Station: Anvil       DC: 11    ║
    ║                                                                       ║
    ║  MATERIAL RECIPES (1)                                                 ║
    ║  └─ ✓ Iron Ingot           [Default]  Station: Anvil       DC: 8     ║
    ║                                                                       ║
    ╚═══════════════════════════════════════════════════════════════════════╝


    > recipes weapon

    ╔═══════════════════════════════════════════════════════════════════════╗
    ║  WEAPON RECIPES                                        Known: 2/4     ║
    ╠═══════════════════════════════════════════════════════════════════════╣
    ║                                                                       ║
    ║  ✓ Iron Sword                                                         ║
    ║    Station: Anvil | DC: 12 | Time: 30s | [Default]                   ║
    ║    Ingredients: Iron Ore x5, Leather x2                              ║
    ║    Output: Iron Sword x1                                             ║
    ║                                                                       ║
    ║  ✓ Steel Sword                                                        ║
    ║    Station: Anvil | DC: 14 | Time: 45s | [Learned 2 days ago]        ║
    ║    Ingredients: Iron Ore x8, Coal x4, Leather x2                     ║
    ║    Output: Steel Sword x1                                            ║
    ║                                                                       ║
    ║  ✗ Mithril Blade (Unknown - find recipe scroll)                      ║
    ║                                                                       ║
    ║  ✗ Steel Armor (Unknown - find recipe scroll)                        ║
    ║                                                                       ║
    ╚═══════════════════════════════════════════════════════════════════════╝
```

---

## 4. RecipeBook Entity

### 4.1 Purpose

The `RecipeBook` entity tracks which recipes a player knows, when they learned them, and provides methods for managing recipe knowledge.

### 4.2 Implementation

**File:** `src/Core/RuneAndRust.Domain/Entities/RecipeBook.cs`

```csharp
namespace RuneAndRust.Domain.Entities;

/// <summary>
/// Tracks recipes known by a player.
/// </summary>
/// <remarks>
/// <para>
/// The recipe book maintains a set of known recipe IDs and timestamps for
/// when each recipe was learned. Players start with default recipes and
/// can learn additional recipes through discovery.
/// </para>
/// <para>
/// Recipe IDs are normalized to lowercase for consistent lookups.
/// </para>
/// </remarks>
public sealed class RecipeBook : IEntity
{
    /// <summary>
    /// Gets the unique entity identifier.
    /// </summary>
    public Guid Id { get; private set; }

    /// <summary>
    /// Gets the ID of the player who owns this recipe book.
    /// </summary>
    public Guid PlayerId { get; private set; }

    /// <summary>
    /// Internal storage for known recipe IDs.
    /// </summary>
    private readonly HashSet<string> _knownRecipeIds = new(StringComparer.OrdinalIgnoreCase);

    /// <summary>
    /// Internal storage for when recipes were learned.
    /// </summary>
    private readonly Dictionary<string, DateTime> _learnedAt = new(StringComparer.OrdinalIgnoreCase);

    /// <summary>
    /// Gets all known recipe IDs.
    /// </summary>
    public IReadOnlySet<string> KnownRecipeIds => _knownRecipeIds;

    /// <summary>
    /// Gets the count of known recipes.
    /// </summary>
    public int KnownCount => _knownRecipeIds.Count;

    /// <summary>
    /// Private constructor for factory pattern.
    /// </summary>
    private RecipeBook() { }

    /// <summary>
    /// Creates a new recipe book for a player.
    /// </summary>
    /// <param name="playerId">The ID of the player who owns this book.</param>
    /// <returns>A new RecipeBook instance.</returns>
    public static RecipeBook Create(Guid playerId)
    {
        return new RecipeBook
        {
            Id = Guid.NewGuid(),
            PlayerId = playerId
        };
    }

    /// <summary>
    /// Checks if a recipe is known.
    /// </summary>
    /// <param name="recipeId">The recipe ID to check.</param>
    /// <returns>True if the recipe is known; otherwise, false.</returns>
    public bool IsKnown(string recipeId)
    {
        if (string.IsNullOrWhiteSpace(recipeId))
        {
            return false;
        }
        return _knownRecipeIds.Contains(recipeId.ToLowerInvariant());
    }

    /// <summary>
    /// Learns a recipe. Returns false if already known.
    /// </summary>
    /// <param name="recipeId">The recipe ID to learn.</param>
    /// <returns>True if the recipe was newly learned; false if already known.</returns>
    public bool Learn(string recipeId)
    {
        ArgumentException.ThrowIfNullOrWhiteSpace(recipeId, nameof(recipeId));

        var normalizedId = recipeId.ToLowerInvariant();
        if (_knownRecipeIds.Contains(normalizedId))
        {
            return false;
        }

        _knownRecipeIds.Add(normalizedId);
        _learnedAt[normalizedId] = DateTime.UtcNow;
        return true;
    }

    /// <summary>
    /// Gets when a recipe was learned.
    /// </summary>
    /// <param name="recipeId">The recipe ID to query.</param>
    /// <returns>The DateTime when learned, or null if not known.</returns>
    public DateTime? GetLearnedDate(string recipeId)
    {
        if (string.IsNullOrWhiteSpace(recipeId))
        {
            return null;
        }
        return _learnedAt.TryGetValue(recipeId.ToLowerInvariant(), out var date) ? date : null;
    }

    /// <summary>
    /// Initializes the recipe book with default recipes.
    /// </summary>
    /// <param name="defaultRecipeIds">The IDs of default recipes to learn.</param>
    /// <remarks>
    /// This method is called during player creation to give new players
    /// access to basic crafting recipes.
    /// </remarks>
    public void InitializeDefaults(IEnumerable<string> defaultRecipeIds)
    {
        ArgumentNullException.ThrowIfNull(defaultRecipeIds, nameof(defaultRecipeIds));

        foreach (var recipeId in defaultRecipeIds)
        {
            if (!string.IsNullOrWhiteSpace(recipeId))
            {
                Learn(recipeId);
            }
        }
    }

    /// <summary>
    /// Gets a summary string for display.
    /// </summary>
    /// <returns>A string describing known recipe count.</returns>
    public override string ToString() => $"RecipeBook ({KnownCount} recipes known)";
}
```

### 4.3 Properties Summary

| Property | Type | Description |
|----------|------|-------------|
| `Id` | `Guid` | Entity identifier |
| `PlayerId` | `Guid` | Owning player's ID |
| `KnownRecipeIds` | `IReadOnlySet<string>` | Set of known recipe IDs |
| `KnownCount` | `int` | Number of known recipes |

### 4.4 Methods Summary

| Method | Return Type | Description |
|--------|-------------|-------------|
| `Create(playerId)` | `RecipeBook` | Factory method |
| `IsKnown(recipeId)` | `bool` | Check if recipe is known |
| `Learn(recipeId)` | `bool` | Learn recipe, returns false if already known |
| `GetLearnedDate(recipeId)` | `DateTime?` | Get when recipe was learned |
| `InitializeDefaults(ids)` | `void` | Initialize with default recipes |

---

## 5. Player Integration

### 5.1 Purpose

The Player entity is updated to include a RecipeBook property, ensuring every player has access to recipe tracking.

### 5.2 Implementation

**File:** `src/Core/RuneAndRust.Domain/Entities/Player.cs` (modifications)

```csharp
namespace RuneAndRust.Domain.Entities;

public partial class Player
{
    // Existing properties...

    /// <summary>
    /// Gets the player's recipe book containing known recipes.
    /// </summary>
    /// <remarks>
    /// The recipe book is created automatically when a player is created
    /// and initialized with default recipes by the RecipeService.
    /// </remarks>
    public RecipeBook RecipeBook { get; private set; } = null!;

    // Update the existing Create method or add initialization:

    /// <summary>
    /// Creates a new player with an empty recipe book.
    /// </summary>
    public static Player Create(string name, /* other params */)
    {
        var player = new Player
        {
            Id = Guid.NewGuid(),
            Name = name,
            // ... other initialization
        };

        // Create recipe book for the player
        player.RecipeBook = RecipeBook.Create(player.Id);

        return player;
    }

    /// <summary>
    /// Ensures the player has a recipe book (for existing players).
    /// </summary>
    internal void EnsureRecipeBook()
    {
        RecipeBook ??= RecipeBook.Create(Id);
    }
}
```

### 5.3 Initialization Flow

```
┌────────────────────────────────────────────────────────────────────────┐
│                    PLAYER RECIPE BOOK INITIALIZATION                    │
└────────────────────────────────────────────────────────────────────────┘

    New Game / Character Creation
                │
                ▼
    ┌───────────────────────────┐
    │ Player.Create(name, ...)  │
    │                           │
    │ player.RecipeBook =       │
    │   RecipeBook.Create(      │
    │     player.Id)            │
    └─────────────┬─────────────┘
                  │
                  ▼
    ┌───────────────────────────┐
    │ RecipeService             │
    │   .InitializeDefault      │
    │   Recipes(player)         │
    └─────────────┬─────────────┘
                  │
                  ▼
    ┌───────────────────────────┐
    │ Get default recipes from  │
    │ IRecipeProvider           │
    │   .GetDefaultRecipes()    │
    └─────────────┬─────────────┘
                  │
                  ▼
    ┌───────────────────────────┐
    │ player.RecipeBook         │
    │   .InitializeDefaults(    │
    │     defaultIds)           │
    └─────────────┬─────────────┘
                  │
                  ▼
    ┌───────────────────────────┐
    │ Player ready with:        │
    │ • Iron Sword              │
    │ • Iron Helmet             │
    │ • Healing Potion          │
    │ • (other defaults...)     │
    └───────────────────────────┘
```

---

## 6. LearnRecipeResult Record

### 6.1 Purpose

The `LearnRecipeResult` record provides a structured result type for recipe learning operations, indicating success or the reason for failure.

### 6.2 Implementation

**File:** `src/Core/RuneAndRust.Application/Results/LearnRecipeResult.cs`

```csharp
namespace RuneAndRust.Application.Results;

/// <summary>
/// The type of result from a learn recipe operation.
/// </summary>
public enum LearnResultType
{
    /// <summary>Recipe was successfully learned.</summary>
    Success,

    /// <summary>Recipe was already known.</summary>
    AlreadyKnown,

    /// <summary>Recipe does not exist.</summary>
    NotFound
}

/// <summary>
/// Result of attempting to learn a recipe.
/// </summary>
/// <param name="IsSuccess">Whether the recipe was learned.</param>
/// <param name="ResultType">The type of result.</param>
/// <param name="RecipeId">The recipe ID that was attempted.</param>
/// <param name="RecipeName">The recipe name if found.</param>
/// <param name="FailureReason">The reason for failure if applicable.</param>
public sealed record LearnRecipeResult(
    bool IsSuccess,
    LearnResultType ResultType,
    string RecipeId,
    string? RecipeName,
    string? FailureReason)
{
    /// <summary>
    /// Creates a successful learn result.
    /// </summary>
    /// <param name="recipeId">The learned recipe ID.</param>
    /// <param name="name">The learned recipe name.</param>
    /// <returns>A success result.</returns>
    public static LearnRecipeResult Success(string recipeId, string name)
        => new(true, LearnResultType.Success, recipeId, name, null);

    /// <summary>
    /// Creates a result indicating the recipe was already known.
    /// </summary>
    /// <param name="recipeId">The recipe ID.</param>
    /// <param name="name">The recipe name.</param>
    /// <returns>An already-known result.</returns>
    public static LearnRecipeResult AlreadyKnown(string recipeId, string name)
        => new(false, LearnResultType.AlreadyKnown, recipeId, name,
            "You already know this recipe.");

    /// <summary>
    /// Creates a result indicating the recipe was not found.
    /// </summary>
    /// <param name="recipeId">The recipe ID that was not found.</param>
    /// <returns>A not-found result.</returns>
    public static LearnRecipeResult RecipeNotFound(string recipeId)
        => new(false, LearnResultType.NotFound, recipeId, null,
            "Recipe not found.");
}
```

---

## 7. CraftValidation Record

### 7.1 Purpose

The `CraftValidation` record provides pre-craft validation results, indicating whether a player can craft a recipe and why not if they can't.

### 7.2 Implementation

**File:** `src/Core/RuneAndRust.Application/Results/CraftValidation.cs`

```csharp
namespace RuneAndRust.Application.Results;

using RuneAndRust.Domain.Definitions;

/// <summary>
/// Represents a missing ingredient for crafting.
/// </summary>
/// <param name="ResourceId">The missing resource ID.</param>
/// <param name="ResourceName">The missing resource name.</param>
/// <param name="QuantityNeeded">How many more are needed.</param>
public sealed record MissingIngredient(
    string ResourceId,
    string ResourceName,
    int QuantityNeeded);

/// <summary>
/// Result of validating whether a player can craft a recipe.
/// </summary>
/// <param name="IsValid">Whether crafting can proceed.</param>
/// <param name="Recipe">The validated recipe if valid.</param>
/// <param name="FailureReason">The reason crafting cannot proceed.</param>
/// <param name="MissingIngredients">List of missing ingredients if applicable.</param>
public sealed record CraftValidation(
    bool IsValid,
    RecipeDefinition? Recipe,
    string? FailureReason,
    IReadOnlyList<MissingIngredient>? MissingIngredients)
{
    /// <summary>
    /// Creates a successful validation result.
    /// </summary>
    /// <param name="recipe">The validated recipe.</param>
    /// <returns>A valid result.</returns>
    public static CraftValidation Success(RecipeDefinition recipe)
        => new(true, recipe, null, null);

    /// <summary>
    /// Creates a failed validation result.
    /// </summary>
    /// <param name="reason">The failure reason.</param>
    /// <returns>A failed result.</returns>
    public static CraftValidation Failed(string reason)
        => new(false, null, reason, null);

    /// <summary>
    /// Creates a failed validation due to insufficient resources.
    /// </summary>
    /// <param name="missing">The list of missing ingredients.</param>
    /// <returns>An insufficient resources result.</returns>
    public static CraftValidation InsufficientResources(IReadOnlyList<MissingIngredient> missing)
        => new(false, null, "Insufficient resources.", missing);

    /// <summary>
    /// Gets whether the failure is due to missing ingredients.
    /// </summary>
    public bool IsMissingIngredients => MissingIngredients is { Count: > 0 };
}
```

---

## 8. RecipeLearnedEvent

### 8.1 Purpose

The `RecipeLearnedEvent` is a domain event fired when a player learns a new recipe, enabling achievements, statistics tracking, and UI notifications.

### 8.2 Implementation

**File:** `src/Core/RuneAndRust.Domain/Events/RecipeLearnedEvent.cs`

```csharp
namespace RuneAndRust.Domain.Events;

/// <summary>
/// Event raised when a player learns a new recipe.
/// </summary>
/// <param name="PlayerId">The ID of the player who learned the recipe.</param>
/// <param name="RecipeId">The ID of the learned recipe.</param>
/// <param name="RecipeName">The name of the learned recipe.</param>
/// <remarks>
/// This event can be used by:
/// <list type="bullet">
/// <item>Achievement system to track recipe discovery progress</item>
/// <item>Statistics system to count recipes learned</item>
/// <item>UI system to show notifications</item>
/// </list>
/// </remarks>
public sealed record RecipeLearnedEvent(
    Guid PlayerId,
    string RecipeId,
    string RecipeName) : IDomainEvent
{
    /// <summary>
    /// Gets the timestamp when this event occurred.
    /// </summary>
    public DateTime OccurredAt { get; } = DateTime.UtcNow;
}
```

---

## 9. IRecipeService Interface

### 9.1 Purpose

The `IRecipeService` interface defines the contract for recipe-related operations, providing a clean API for recipe queries, learning, and validation.

### 9.2 Implementation

**File:** `src/Core/RuneAndRust.Application/Interfaces/IRecipeService.cs`

```csharp
namespace RuneAndRust.Application.Interfaces;

using RuneAndRust.Application.Results;
using RuneAndRust.Domain.Definitions;
using RuneAndRust.Domain.Entities;
using RuneAndRust.Domain.Enums;

/// <summary>
/// Service for managing player recipes.
/// </summary>
/// <remarks>
/// The recipe service mediates between recipe definitions (what exists)
/// and player recipe books (what is known). It provides methods for
/// querying known recipes, learning new recipes, and validating crafting.
/// </remarks>
public interface IRecipeService
{
    /// <summary>
    /// Gets all recipes known by a player.
    /// </summary>
    /// <param name="player">The player to query.</param>
    /// <returns>A list of known recipe definitions.</returns>
    IReadOnlyList<RecipeDefinition> GetKnownRecipes(Player player);

    /// <summary>
    /// Gets known recipes filtered by category.
    /// </summary>
    /// <param name="player">The player to query.</param>
    /// <param name="category">The category to filter by.</param>
    /// <returns>A list of known recipes in the specified category.</returns>
    IReadOnlyList<RecipeDefinition> GetKnownRecipesByCategory(Player player, RecipeCategory category);

    /// <summary>
    /// Gets recipes that can be crafted at a specific station.
    /// </summary>
    /// <param name="player">The player to query.</param>
    /// <param name="stationId">The crafting station ID.</param>
    /// <returns>A list of known recipes for the station.</returns>
    IReadOnlyList<RecipeDefinition> GetCraftableRecipes(Player player, string stationId);

    /// <summary>
    /// Checks if a player knows a specific recipe.
    /// </summary>
    /// <param name="player">The player to check.</param>
    /// <param name="recipeId">The recipe ID to check.</param>
    /// <returns>True if the player knows the recipe.</returns>
    bool IsRecipeKnown(Player player, string recipeId);

    /// <summary>
    /// Teaches a recipe to a player.
    /// </summary>
    /// <param name="player">The player to teach.</param>
    /// <param name="recipeId">The recipe ID to learn.</param>
    /// <returns>The result of the learn attempt.</returns>
    LearnRecipeResult LearnRecipe(Player player, string recipeId);

    /// <summary>
    /// Initializes default recipes for a new player.
    /// </summary>
    /// <param name="player">The player to initialize.</param>
    void InitializeDefaultRecipes(Player player);

    /// <summary>
    /// Gets a specific recipe if the player knows it.
    /// </summary>
    /// <param name="player">The player to query.</param>
    /// <param name="recipeId">The recipe ID to get.</param>
    /// <returns>The recipe definition if known; otherwise, null.</returns>
    RecipeDefinition? GetKnownRecipe(Player player, string recipeId);

    /// <summary>
    /// Validates whether a player can craft a recipe.
    /// </summary>
    /// <param name="player">The player attempting to craft.</param>
    /// <param name="recipeId">The recipe ID to craft.</param>
    /// <param name="stationId">The station being used (null for any).</param>
    /// <returns>A validation result indicating if crafting can proceed.</returns>
    CraftValidation CanCraft(Player player, string recipeId, string? stationId);

    /// <summary>
    /// Gets the total number of recipes known by a player.
    /// </summary>
    /// <param name="player">The player to query.</param>
    /// <returns>The count of known recipes.</returns>
    int GetKnownRecipeCount(Player player);

    /// <summary>
    /// Gets the total number of recipes available in the game.
    /// </summary>
    /// <returns>The total recipe count.</returns>
    int GetTotalRecipeCount();
}
```

### 9.3 Method Summary

| Method | Return Type | Description |
|--------|-------------|-------------|
| `GetKnownRecipes` | `IReadOnlyList<RecipeDefinition>` | All known recipes |
| `GetKnownRecipesByCategory` | `IReadOnlyList<RecipeDefinition>` | Known recipes by category |
| `GetCraftableRecipes` | `IReadOnlyList<RecipeDefinition>` | Known recipes for station |
| `IsRecipeKnown` | `bool` | Check if recipe is known |
| `LearnRecipe` | `LearnRecipeResult` | Learn a recipe |
| `InitializeDefaultRecipes` | `void` | Initialize defaults for new player |
| `GetKnownRecipe` | `RecipeDefinition?` | Get specific known recipe |
| `CanCraft` | `CraftValidation` | Validate crafting prerequisites |
| `GetKnownRecipeCount` | `int` | Count of known recipes |
| `GetTotalRecipeCount` | `int` | Total available recipes |

---

## 10. RecipeService Implementation

### 10.1 Purpose

The `RecipeService` implements the recipe management logic, coordinating between the recipe provider, player recipe book, and inventory system.

### 10.2 Implementation

**File:** `src/Core/RuneAndRust.Application/Services/RecipeService.cs`

```csharp
namespace RuneAndRust.Application.Services;

using Microsoft.Extensions.Logging;
using RuneAndRust.Application.Interfaces;
using RuneAndRust.Application.Results;
using RuneAndRust.Domain.Definitions;
using RuneAndRust.Domain.Entities;
using RuneAndRust.Domain.Enums;
using RuneAndRust.Domain.Events;

/// <summary>
/// Service for managing player recipes.
/// </summary>
/// <remarks>
/// <para>
/// The recipe service acts as the primary interface for recipe-related
/// operations. It queries the recipe provider for definitions and
/// coordinates with player recipe books for knowledge tracking.
/// </para>
/// <para>
/// Learning recipes publishes domain events for achievement and
/// statistics tracking.
/// </para>
/// </remarks>
public sealed class RecipeService : IRecipeService
{
    private readonly IRecipeProvider _recipeProvider;
    private readonly IResourceProvider _resourceProvider;
    private readonly IEventBus _eventBus;
    private readonly ILogger<RecipeService> _logger;

    /// <summary>
    /// Initializes a new instance of the RecipeService.
    /// </summary>
    public RecipeService(
        IRecipeProvider recipeProvider,
        IResourceProvider resourceProvider,
        IEventBus eventBus,
        ILogger<RecipeService> logger)
    {
        _recipeProvider = recipeProvider ?? throw new ArgumentNullException(nameof(recipeProvider));
        _resourceProvider = resourceProvider ?? throw new ArgumentNullException(nameof(resourceProvider));
        _eventBus = eventBus ?? throw new ArgumentNullException(nameof(eventBus));
        _logger = logger ?? throw new ArgumentNullException(nameof(logger));
    }

    /// <inheritdoc/>
    public IReadOnlyList<RecipeDefinition> GetKnownRecipes(Player player)
    {
        ArgumentNullException.ThrowIfNull(player, nameof(player));

        return _recipeProvider.GetAllRecipes()
            .Where(r => player.RecipeBook.IsKnown(r.RecipeId))
            .OrderBy(r => r.Category)
            .ThenBy(r => r.DifficultyClass)
            .ThenBy(r => r.Name)
            .ToList();
    }

    /// <inheritdoc/>
    public IReadOnlyList<RecipeDefinition> GetKnownRecipesByCategory(Player player, RecipeCategory category)
    {
        ArgumentNullException.ThrowIfNull(player, nameof(player));

        return _recipeProvider.GetRecipesByCategory(category)
            .Where(r => player.RecipeBook.IsKnown(r.RecipeId))
            .OrderBy(r => r.DifficultyClass)
            .ThenBy(r => r.Name)
            .ToList();
    }

    /// <inheritdoc/>
    public IReadOnlyList<RecipeDefinition> GetCraftableRecipes(Player player, string stationId)
    {
        ArgumentNullException.ThrowIfNull(player, nameof(player));
        ArgumentException.ThrowIfNullOrWhiteSpace(stationId, nameof(stationId));

        return _recipeProvider.GetRecipesForStation(stationId)
            .Where(r => player.RecipeBook.IsKnown(r.RecipeId))
            .OrderBy(r => r.DifficultyClass)
            .ThenBy(r => r.Name)
            .ToList();
    }

    /// <inheritdoc/>
    public bool IsRecipeKnown(Player player, string recipeId)
    {
        ArgumentNullException.ThrowIfNull(player, nameof(player));

        return player.RecipeBook.IsKnown(recipeId);
    }

    /// <inheritdoc/>
    public LearnRecipeResult LearnRecipe(Player player, string recipeId)
    {
        ArgumentNullException.ThrowIfNull(player, nameof(player));
        ArgumentException.ThrowIfNullOrWhiteSpace(recipeId, nameof(recipeId));

        _logger.LogDebug("Attempting to teach recipe {RecipeId} to {Player}",
            recipeId, player.Name);

        // Check if recipe exists
        var recipe = _recipeProvider.GetRecipe(recipeId);
        if (recipe is null)
        {
            _logger.LogWarning("Attempted to learn non-existent recipe: {RecipeId}", recipeId);
            return LearnRecipeResult.RecipeNotFound(recipeId);
        }

        // Check if already known
        if (player.RecipeBook.IsKnown(recipeId))
        {
            _logger.LogDebug("{Player} already knows recipe: {RecipeId}", player.Name, recipeId);
            return LearnRecipeResult.AlreadyKnown(recipeId, recipe.Name);
        }

        // Learn the recipe
        player.RecipeBook.Learn(recipeId);

        _logger.LogInformation("{Player} learned recipe: {RecipeName} ({RecipeId})",
            player.Name, recipe.Name, recipeId);

        // Publish event
        _eventBus.Publish(new RecipeLearnedEvent(player.Id, recipeId, recipe.Name));

        return LearnRecipeResult.Success(recipeId, recipe.Name);
    }

    /// <inheritdoc/>
    public void InitializeDefaultRecipes(Player player)
    {
        ArgumentNullException.ThrowIfNull(player, nameof(player));

        var defaultRecipes = _recipeProvider.GetDefaultRecipes();
        var recipeIds = defaultRecipes.Select(r => r.RecipeId);

        player.RecipeBook.InitializeDefaults(recipeIds);

        _logger.LogDebug("Initialized {Count} default recipes for {Player}",
            defaultRecipes.Count, player.Name);
    }

    /// <inheritdoc/>
    public RecipeDefinition? GetKnownRecipe(Player player, string recipeId)
    {
        ArgumentNullException.ThrowIfNull(player, nameof(player));

        if (!player.RecipeBook.IsKnown(recipeId))
        {
            return null;
        }

        return _recipeProvider.GetRecipe(recipeId);
    }

    /// <inheritdoc/>
    public CraftValidation CanCraft(Player player, string recipeId, string? stationId)
    {
        ArgumentNullException.ThrowIfNull(player, nameof(player));
        ArgumentException.ThrowIfNullOrWhiteSpace(recipeId, nameof(recipeId));

        _logger.LogDebug("Validating craft for {Player}: {RecipeId} at station {Station}",
            player.Name, recipeId, stationId ?? "any");

        // 1. Check if recipe exists
        var recipe = _recipeProvider.GetRecipe(recipeId);
        if (recipe is null)
        {
            _logger.LogDebug("Craft validation failed: recipe not found");
            return CraftValidation.Failed("Recipe not found.");
        }

        // 2. Check if player knows the recipe
        if (!player.RecipeBook.IsKnown(recipeId))
        {
            _logger.LogDebug("Craft validation failed: player doesn't know recipe");
            return CraftValidation.Failed("You don't know this recipe.");
        }

        // 3. Check station requirement
        if (stationId is not null &&
            !string.Equals(recipe.RequiredStationId, stationId, StringComparison.OrdinalIgnoreCase))
        {
            _logger.LogDebug("Craft validation failed: wrong station");
            return CraftValidation.Failed(
                $"This recipe requires a {recipe.RequiredStationId}.");
        }

        // 4. Check ingredient availability
        var missingIngredients = GetMissingIngredients(player, recipe);
        if (missingIngredients.Count > 0)
        {
            _logger.LogDebug("Craft validation failed: missing {Count} ingredients",
                missingIngredients.Count);
            return CraftValidation.InsufficientResources(missingIngredients);
        }

        _logger.LogDebug("Craft validation succeeded for {RecipeId}", recipeId);
        return CraftValidation.Success(recipe);
    }

    /// <inheritdoc/>
    public int GetKnownRecipeCount(Player player)
    {
        ArgumentNullException.ThrowIfNull(player, nameof(player));
        return player.RecipeBook.KnownCount;
    }

    /// <inheritdoc/>
    public int GetTotalRecipeCount()
    {
        return _recipeProvider.GetRecipeCount();
    }

    /// <summary>
    /// Gets the list of missing ingredients for a recipe.
    /// </summary>
    private List<MissingIngredient> GetMissingIngredients(Player player, RecipeDefinition recipe)
    {
        var missing = new List<MissingIngredient>();

        foreach (var ingredient in recipe.Ingredients)
        {
            var have = player.Inventory.GetResourceCount(ingredient.ResourceId);
            if (have < ingredient.Quantity)
            {
                var resource = _resourceProvider.GetResource(ingredient.ResourceId);
                var resourceName = resource?.Name ?? ingredient.ResourceId;

                missing.Add(new MissingIngredient(
                    ingredient.ResourceId,
                    resourceName,
                    ingredient.Quantity - have));
            }
        }

        return missing;
    }
}
```

### 10.3 Decision Tree: LearnRecipe

```
┌────────────────────────────────────────────────────────────────────────┐
│                    LEARNRECIPE DECISION TREE                            │
└────────────────────────────────────────────────────────────────────────┘

    LearnRecipe(player, recipeId)
                │
                ▼
    ┌───────────────────────────┐
    │ recipe = _recipeProvider  │
    │   .GetRecipe(recipeId)    │
    └─────────────┬─────────────┘
                  │
         ┌────────┴────────┐
         │                 │
         ▼ null            ▼ recipe
    ┌─────────────┐   ┌─────────────────────────────┐
    │ Log warning │   │ player.RecipeBook.IsKnown   │
    │             │   │   (recipeId)                │
    │ Return:     │   └─────────────┬───────────────┘
    │ RecipeNot   │                 │
    │ Found       │        ┌────────┴────────┐
    └─────────────┘        │                 │
                           ▼ true            ▼ false
                    ┌─────────────┐   ┌─────────────────────┐
                    │ Log debug   │   │ player.RecipeBook   │
                    │             │   │   .Learn(recipeId)  │
                    │ Return:     │   └─────────┬───────────┘
                    │ AlreadyKnown│             │
                    └─────────────┘             ▼
                                        ┌─────────────────────┐
                                        │ Log information     │
                                        │ _eventBus.Publish(  │
                                        │   RecipeLearned     │
                                        │   Event)            │
                                        └─────────┬───────────┘
                                                  │
                                                  ▼
                                        ┌─────────────────────┐
                                        │ Return: Success     │
                                        └─────────────────────┘
```

### 10.4 Decision Tree: CanCraft

```
┌────────────────────────────────────────────────────────────────────────┐
│                      CANCRAFT DECISION TREE                             │
└────────────────────────────────────────────────────────────────────────┘

    CanCraft(player, recipeId, stationId)
                │
                ▼
    ┌───────────────────────────┐
    │ recipe = _recipeProvider  │
    │   .GetRecipe(recipeId)    │
    └─────────────┬─────────────┘
                  │
         ┌────────┴────────┐
         │                 │
         ▼ null            ▼ recipe
    ┌─────────────┐   ┌─────────────────────────────┐
    │ Return:     │   │ player.RecipeBook.IsKnown   │
    │ Failed      │   │   (recipeId)                │
    │ "Recipe not │   └─────────────┬───────────────┘
    │  found"     │                 │
    └─────────────┘        ┌────────┴────────┐
                           │                 │
                           ▼ false           ▼ true
                    ┌─────────────┐   ┌─────────────────────┐
                    │ Return:     │   │ stationId != null   │
                    │ Failed      │   │ AND stationId !=    │
                    │ "Don't know │   │ recipe.RequiredSta- │
                    │  recipe"    │   │ tionId              │
                    └─────────────┘   └─────────┬───────────┘
                                               │
                                      ┌────────┴────────┐
                                      │                 │
                                      ▼ true            ▼ false
                               ┌─────────────┐   ┌─────────────────┐
                               │ Return:     │   │ GetMissing      │
                               │ Failed      │   │ Ingredients     │
                               │ "Requires   │   │ (player, recipe)│
                               │  [station]" │   └───────┬─────────┘
                               └─────────────┘           │
                                                ┌────────┴────────┐
                                                │                 │
                                                ▼ any             ▼ empty
                                         ┌─────────────┐   ┌─────────────┐
                                         │ Return:     │   │ Return:     │
                                         │ Insufficient│   │ Success     │
                                         │ Resources   │   │ (recipe)    │
                                         │ (missing)   │   └─────────────┘
                                         └─────────────┘
```

---

## 11. RecipesCommand

### 11.1 Purpose

The `RecipesCommand` allows players to view their known recipes, optionally filtered by category.

### 11.2 Implementation

**File:** `src/Core/RuneAndRust.Application/Commands/RecipesCommand.cs`

```csharp
namespace RuneAndRust.Application.Commands;

using RuneAndRust.Application.Interfaces;
using RuneAndRust.Domain.Entities;
using RuneAndRust.Domain.Enums;
using System.Text;

/// <summary>
/// Command to list known recipes.
/// </summary>
/// <remarks>
/// <para>
/// Usage:
/// <list type="bullet">
/// <item><c>recipes</c> - List all known recipes grouped by category</item>
/// <item><c>recipes weapon</c> - List known weapon recipes with details</item>
/// <item><c>recipes potion</c> - List known potion recipes with details</item>
/// </list>
/// </para>
/// </remarks>
public sealed class RecipesCommand : IGameCommand
{
    private readonly IRecipeService _recipeService;
    private readonly IRecipeProvider _recipeProvider;

    /// <summary>
    /// Gets the command name.
    /// </summary>
    public string Name => "recipes";

    /// <summary>
    /// Gets the command description.
    /// </summary>
    public string Description => "View your known recipes";

    /// <summary>
    /// Gets the command usage.
    /// </summary>
    public string Usage => "recipes [category]";

    /// <summary>
    /// Gets command aliases.
    /// </summary>
    public IReadOnlyList<string> Aliases => ["recipe", "crafts"];

    /// <summary>
    /// Initializes a new instance of the RecipesCommand.
    /// </summary>
    public RecipesCommand(IRecipeService recipeService, IRecipeProvider recipeProvider)
    {
        _recipeService = recipeService ?? throw new ArgumentNullException(nameof(recipeService));
        _recipeProvider = recipeProvider ?? throw new ArgumentNullException(nameof(recipeProvider));
    }

    /// <summary>
    /// Executes the recipes command.
    /// </summary>
    public CommandResult Execute(Player player, string[] args)
    {
        ArgumentNullException.ThrowIfNull(player, nameof(player));

        // Check if category filter specified
        if (args.Length > 0 && TryParseCategory(args[0], out var category))
        {
            return ShowCategoryDetails(player, category);
        }

        return ShowAllRecipes(player);
    }

    /// <summary>
    /// Shows all known recipes grouped by category.
    /// </summary>
    private CommandResult ShowAllRecipes(Player player)
    {
        var recipes = _recipeService.GetKnownRecipes(player);
        var totalRecipes = _recipeService.GetTotalRecipeCount();

        if (recipes.Count == 0)
        {
            return CommandResult.Info("You don't know any recipes yet.");
        }

        var output = new StringBuilder();
        output.AppendLine($"RECIPE BOOK (Known: {recipes.Count}/{totalRecipes})");
        output.AppendLine(new string('─', 60));

        // Group by category
        var byCategory = recipes
            .GroupBy(r => r.Category)
            .OrderBy(g => g.Key);

        foreach (var group in byCategory)
        {
            var categoryName = group.Key.ToString().ToUpperInvariant();
            output.AppendLine();
            output.AppendLine($"{categoryName} RECIPES ({group.Count()})");

            foreach (var recipe in group.OrderBy(r => r.DifficultyClass))
            {
                var marker = recipe.IsDefault ? "[Default]" : "[Learned]";
                output.AppendLine(
                    $"  ✓ {recipe.Name,-22} {marker,-10} " +
                    $"Station: {recipe.RequiredStationId,-12} DC: {recipe.DifficultyClass}");
            }
        }

        output.AppendLine();
        output.AppendLine("Use 'recipes <category>' for detailed view (e.g., 'recipes weapon')");

        return CommandResult.Success(output.ToString());
    }

    /// <summary>
    /// Shows detailed view for a specific category.
    /// </summary>
    private CommandResult ShowCategoryDetails(Player player, RecipeCategory category)
    {
        var knownRecipes = _recipeService.GetKnownRecipesByCategory(player, category);
        var allCategoryRecipes = _recipeProvider.GetRecipesByCategory(category);

        var output = new StringBuilder();
        output.AppendLine($"{category.ToString().ToUpperInvariant()} RECIPES " +
            $"(Known: {knownRecipes.Count}/{allCategoryRecipes.Count})");
        output.AppendLine(new string('─', 60));

        // Show known recipes with details
        foreach (var recipe in knownRecipes)
        {
            output.AppendLine();
            output.AppendLine($"✓ {recipe.Name}");

            var learnedDate = player.RecipeBook.GetLearnedDate(recipe.RecipeId);
            var learnedText = recipe.IsDefault ? "[Default]" :
                learnedDate.HasValue ? $"[Learned {FormatTimeAgo(learnedDate.Value)}]" : "[Learned]";

            output.AppendLine($"  Station: {recipe.RequiredStationId} | " +
                $"DC: {recipe.DifficultyClass} | " +
                $"Time: {recipe.CraftingTimeSeconds}s | {learnedText}");

            // Show ingredients
            var ingredientList = string.Join(", ",
                recipe.Ingredients.Select(i => $"{i.ResourceId} x{i.Quantity}"));
            output.AppendLine($"  Ingredients: {ingredientList}");

            // Show output
            var qualityText = recipe.Output.HasQualityScaling ? " (quality varies)" : "";
            output.AppendLine($"  Output: {recipe.Output.ItemId} x{recipe.Output.Quantity}{qualityText}");
        }

        // Show unknown recipes (just names)
        var unknownRecipes = allCategoryRecipes
            .Where(r => !player.RecipeBook.IsKnown(r.RecipeId))
            .ToList();

        if (unknownRecipes.Count > 0)
        {
            output.AppendLine();
            foreach (var recipe in unknownRecipes)
            {
                output.AppendLine($"✗ {recipe.Name} (Unknown - find recipe scroll)");
            }
        }

        return CommandResult.Success(output.ToString());
    }

    /// <summary>
    /// Tries to parse a category name from input.
    /// </summary>
    private static bool TryParseCategory(string input, out RecipeCategory category)
    {
        return Enum.TryParse(input, ignoreCase: true, out category);
    }

    /// <summary>
    /// Formats a datetime as a relative time string.
    /// </summary>
    private static string FormatTimeAgo(DateTime dateTime)
    {
        var span = DateTime.UtcNow - dateTime;

        return span switch
        {
            { TotalMinutes: < 1 } => "just now",
            { TotalMinutes: < 60 } => $"{(int)span.TotalMinutes}m ago",
            { TotalHours: < 24 } => $"{(int)span.TotalHours}h ago",
            { TotalDays: < 7 } => $"{(int)span.TotalDays}d ago",
            _ => dateTime.ToString("MMM d")
        };
    }
}
```

### 11.3 Command Examples

```
> recipes

RECIPE BOOK (Known: 9/15)
────────────────────────────────────────────────────────

WEAPON RECIPES (1)
  ✓ Iron Sword               [Default]   Station: anvil        DC: 12

ARMOR RECIPES (3)
  ✓ Leather Armor            [Default]   Station: workbench    DC: 11
  ✓ Iron Helmet              [Default]   Station: anvil        DC: 12
  ✓ Iron Chestplate          [Default]   Station: anvil        DC: 13

POTION RECIPES (2)
  ✓ Healing Potion           [Default]   Station: alchemy-table DC: 10
  ✓ Mana Potion              [Default]   Station: alchemy-table DC: 12

CONSUMABLE RECIPES (1)
  ✓ Cooked Meat              [Default]   Station: cooking-fire DC: 8

TOOL RECIPES (1)
  ✓ Iron Pickaxe             [Default]   Station: anvil        DC: 11

MATERIAL RECIPES (1)
  ✓ Iron Ingot               [Default]   Station: anvil        DC: 8

Use 'recipes <category>' for detailed view (e.g., 'recipes weapon')


> recipes weapon

WEAPON RECIPES (Known: 1/4)
────────────────────────────────────────────────────────

✓ Iron Sword
  Station: anvil | DC: 12 | Time: 30s | [Default]
  Ingredients: iron-ore x5, leather x2
  Output: iron-sword x1

✗ Steel Sword (Unknown - find recipe scroll)
✗ Mithril Blade (Unknown - find recipe scroll)
✗ Steel Armor (Unknown - find recipe scroll)
```

---

## 12. Logging Specifications

### 12.1 Log Levels by Component

| Component | Level | Events |
|-----------|-------|--------|
| `RecipeService` | Debug | Learn attempt, craft validation start |
| `RecipeService` | Debug | Already known, validation steps |
| `RecipeService` | Information | Recipe learned |
| `RecipeService` | Warning | Learn non-existent recipe |
| `RecipeBook` | Debug | Recipe added, defaults initialized |

### 12.2 Log Message Templates

```csharp
// RecipeService - Debug
_logger.LogDebug("Attempting to teach recipe {RecipeId} to {Player}",
    recipeId, player.Name);
_logger.LogDebug("{Player} already knows recipe: {RecipeId}",
    player.Name, recipeId);
_logger.LogDebug("Validating craft for {Player}: {RecipeId} at station {Station}",
    player.Name, recipeId, stationId ?? "any");
_logger.LogDebug("Craft validation failed: recipe not found");
_logger.LogDebug("Craft validation failed: player doesn't know recipe");
_logger.LogDebug("Craft validation failed: wrong station");
_logger.LogDebug("Craft validation failed: missing {Count} ingredients",
    missingIngredients.Count);
_logger.LogDebug("Craft validation succeeded for {RecipeId}", recipeId);
_logger.LogDebug("Initialized {Count} default recipes for {Player}",
    defaultRecipes.Count, player.Name);

// RecipeService - Information
_logger.LogInformation("{Player} learned recipe: {RecipeName} ({RecipeId})",
    player.Name, recipe.Name, recipeId);

// RecipeService - Warning
_logger.LogWarning("Attempted to learn non-existent recipe: {RecipeId}", recipeId);
```

---

## 13. Unit Testing Requirements

### 13.1 Test Count by Feature

| Feature | Test Count |
|---------|------------|
| RecipeBook | 4 |
| RecipeService | 3 |
| RecipesCommand | 1 |
| **Total** | **~8** |

### 13.2 Test Specifications

**File:** `tests/RuneAndRust.Domain.Tests/Entities/RecipeBookTests.cs`

```csharp
namespace RuneAndRust.Domain.Tests.Entities;

public class RecipeBookTests
{
    [Fact]
    public void Create_WithPlayerId_CreatesEmptyBook()
    {
        // Arrange
        var playerId = Guid.NewGuid();

        // Act
        var book = RecipeBook.Create(playerId);

        // Assert
        Assert.Equal(playerId, book.PlayerId);
        Assert.Equal(0, book.KnownCount);
        Assert.Empty(book.KnownRecipeIds);
    }

    [Fact]
    public void Learn_NewRecipe_ReturnsTrue()
    {
        // Arrange
        var book = RecipeBook.Create(Guid.NewGuid());

        // Act
        var result = book.Learn("iron-sword");

        // Assert
        Assert.True(result);
        Assert.True(book.IsKnown("iron-sword"));
        Assert.Equal(1, book.KnownCount);
    }

    [Fact]
    public void Learn_AlreadyKnownRecipe_ReturnsFalse()
    {
        // Arrange
        var book = RecipeBook.Create(Guid.NewGuid());
        book.Learn("iron-sword");

        // Act
        var result = book.Learn("iron-sword");

        // Assert
        Assert.False(result);
        Assert.Equal(1, book.KnownCount); // Still 1
    }

    [Fact]
    public void IsKnown_IsCaseInsensitive()
    {
        // Arrange
        var book = RecipeBook.Create(Guid.NewGuid());
        book.Learn("Iron-Sword");

        // Act & Assert
        Assert.True(book.IsKnown("iron-sword"));
        Assert.True(book.IsKnown("IRON-SWORD"));
        Assert.True(book.IsKnown("Iron-Sword"));
    }

    [Fact]
    public void InitializeDefaults_AddsAllRecipes()
    {
        // Arrange
        var book = RecipeBook.Create(Guid.NewGuid());
        var defaults = new[] { "iron-sword", "healing-potion", "iron-helmet" };

        // Act
        book.InitializeDefaults(defaults);

        // Assert
        Assert.Equal(3, book.KnownCount);
        Assert.All(defaults, id => Assert.True(book.IsKnown(id)));
    }

    [Fact]
    public void GetLearnedDate_KnownRecipe_ReturnsDateTime()
    {
        // Arrange
        var book = RecipeBook.Create(Guid.NewGuid());
        var before = DateTime.UtcNow;
        book.Learn("iron-sword");
        var after = DateTime.UtcNow;

        // Act
        var learnedDate = book.GetLearnedDate("iron-sword");

        // Assert
        Assert.NotNull(learnedDate);
        Assert.InRange(learnedDate.Value, before, after);
    }

    [Fact]
    public void GetLearnedDate_UnknownRecipe_ReturnsNull()
    {
        // Arrange
        var book = RecipeBook.Create(Guid.NewGuid());

        // Act
        var learnedDate = book.GetLearnedDate("unknown-recipe");

        // Assert
        Assert.Null(learnedDate);
    }
}
```

**File:** `tests/RuneAndRust.Application.Tests/Services/RecipeServiceTests.cs`

```csharp
namespace RuneAndRust.Application.Tests.Services;

public class RecipeServiceTests
{
    private readonly Mock<IRecipeProvider> _recipeProviderMock;
    private readonly Mock<IResourceProvider> _resourceProviderMock;
    private readonly Mock<IEventBus> _eventBusMock;
    private readonly Mock<ILogger<RecipeService>> _loggerMock;
    private readonly RecipeService _service;

    public RecipeServiceTests()
    {
        _recipeProviderMock = new Mock<IRecipeProvider>();
        _resourceProviderMock = new Mock<IResourceProvider>();
        _eventBusMock = new Mock<IEventBus>();
        _loggerMock = new Mock<ILogger<RecipeService>>();

        _service = new RecipeService(
            _recipeProviderMock.Object,
            _resourceProviderMock.Object,
            _eventBusMock.Object,
            _loggerMock.Object);
    }

    [Fact]
    public void LearnRecipe_ValidRecipe_ReturnsSuccessAndPublishesEvent()
    {
        // Arrange
        var player = CreateTestPlayer();
        var recipe = CreateTestRecipe("iron-sword", "Iron Sword");
        _recipeProviderMock.Setup(p => p.GetRecipe("iron-sword")).Returns(recipe);

        // Act
        var result = _service.LearnRecipe(player, "iron-sword");

        // Assert
        Assert.True(result.IsSuccess);
        Assert.Equal(LearnResultType.Success, result.ResultType);
        Assert.True(player.RecipeBook.IsKnown("iron-sword"));
        _eventBusMock.Verify(e => e.Publish(It.IsAny<RecipeLearnedEvent>()), Times.Once);
    }

    [Fact]
    public void LearnRecipe_AlreadyKnown_ReturnsAlreadyKnown()
    {
        // Arrange
        var player = CreateTestPlayer();
        player.RecipeBook.Learn("iron-sword");
        var recipe = CreateTestRecipe("iron-sword", "Iron Sword");
        _recipeProviderMock.Setup(p => p.GetRecipe("iron-sword")).Returns(recipe);

        // Act
        var result = _service.LearnRecipe(player, "iron-sword");

        // Assert
        Assert.False(result.IsSuccess);
        Assert.Equal(LearnResultType.AlreadyKnown, result.ResultType);
        _eventBusMock.Verify(e => e.Publish(It.IsAny<RecipeLearnedEvent>()), Times.Never);
    }

    [Fact]
    public void LearnRecipe_RecipeNotFound_ReturnsNotFound()
    {
        // Arrange
        var player = CreateTestPlayer();
        _recipeProviderMock.Setup(p => p.GetRecipe("unknown")).Returns((RecipeDefinition?)null);

        // Act
        var result = _service.LearnRecipe(player, "unknown");

        // Assert
        Assert.False(result.IsSuccess);
        Assert.Equal(LearnResultType.NotFound, result.ResultType);
    }

    [Fact]
    public void CanCraft_ValidCraft_ReturnsSuccess()
    {
        // Arrange
        var player = CreateTestPlayer();
        player.RecipeBook.Learn("iron-sword");
        SetupInventoryWithResources(player);

        var recipe = CreateTestRecipe("iron-sword", "Iron Sword");
        _recipeProviderMock.Setup(p => p.GetRecipe("iron-sword")).Returns(recipe);

        // Act
        var result = _service.CanCraft(player, "iron-sword", "anvil");

        // Assert
        Assert.True(result.IsValid);
        Assert.NotNull(result.Recipe);
    }

    [Fact]
    public void CanCraft_UnknownRecipe_ReturnsFailed()
    {
        // Arrange
        var player = CreateTestPlayer();
        // Don't learn recipe
        var recipe = CreateTestRecipe("iron-sword", "Iron Sword");
        _recipeProviderMock.Setup(p => p.GetRecipe("iron-sword")).Returns(recipe);

        // Act
        var result = _service.CanCraft(player, "iron-sword", "anvil");

        // Assert
        Assert.False(result.IsValid);
        Assert.Contains("don't know", result.FailureReason, StringComparison.OrdinalIgnoreCase);
    }

    [Fact]
    public void CanCraft_WrongStation_ReturnsFailed()
    {
        // Arrange
        var player = CreateTestPlayer();
        player.RecipeBook.Learn("iron-sword");
        var recipe = CreateTestRecipe("iron-sword", "Iron Sword", "anvil");
        _recipeProviderMock.Setup(p => p.GetRecipe("iron-sword")).Returns(recipe);

        // Act
        var result = _service.CanCraft(player, "iron-sword", "workbench");

        // Assert
        Assert.False(result.IsValid);
        Assert.Contains("anvil", result.FailureReason, StringComparison.OrdinalIgnoreCase);
    }

    // Helper methods...
    private static Player CreateTestPlayer() { /* ... */ }
    private static RecipeDefinition CreateTestRecipe(string id, string name, string station = "anvil") { /* ... */ }
    private void SetupInventoryWithResources(Player player) { /* ... */ }
}
```

**File:** `tests/RuneAndRust.Application.Tests/Commands/RecipesCommandTests.cs`

```csharp
namespace RuneAndRust.Application.Tests.Commands;

public class RecipesCommandTests
{
    [Fact]
    public void Execute_NoArgs_ShowsAllRecipesGroupedByCategory()
    {
        // Arrange
        var recipeServiceMock = new Mock<IRecipeService>();
        var recipeProviderMock = new Mock<IRecipeProvider>();
        var player = CreateTestPlayer();

        var recipes = new List<RecipeDefinition>
        {
            CreateTestRecipe("iron-sword", "Iron Sword", RecipeCategory.Weapon),
            CreateTestRecipe("healing-potion", "Healing Potion", RecipeCategory.Potion)
        };

        recipeServiceMock.Setup(s => s.GetKnownRecipes(player)).Returns(recipes);
        recipeServiceMock.Setup(s => s.GetTotalRecipeCount()).Returns(10);

        var command = new RecipesCommand(recipeServiceMock.Object, recipeProviderMock.Object);

        // Act
        var result = command.Execute(player, Array.Empty<string>());

        // Assert
        Assert.True(result.Success);
        Assert.Contains("WEAPON", result.Message);
        Assert.Contains("POTION", result.Message);
        Assert.Contains("Known: 2/10", result.Message);
    }
}
```

---

## 14. Use Cases

### UC-001: Initialize Default Recipes

**Actor:** System (on player creation)
**Flow:** Player created → RecipeService.InitializeDefaultRecipes called → Default recipes loaded → Recipes added to RecipeBook

```
Player Creation
      │
      ▼
┌──────────────────────┐
│ Player.Create()      │
│ RecipeBook created   │
└──────────┬───────────┘
           │
           ▼
┌──────────────────────┐
│ RecipeService        │
│ .InitializeDefault   │
│  Recipes(player)     │
└──────────┬───────────┘
           │
           ▼
┌──────────────────────┐
│ _recipeProvider      │
│ .GetDefaultRecipes() │
│ Returns 9 recipes    │
└──────────┬───────────┘
           │
           ▼
┌──────────────────────┐
│ player.RecipeBook    │
│ .InitializeDefaults  │
│ (recipeIds)          │
└──────────┬───────────┘
           │
           ▼
┌──────────────────────┐
│ Player ready with    │
│ 9 default recipes    │
└──────────────────────┘
```

### UC-002: Learn New Recipe

**Actor:** Player (via scroll, quest, NPC)
**Flow:** Player acquires recipe → LearnRecipe called → Recipe validated → Recipe added to book → Event published

```
Player uses recipe scroll
      │
      ▼
┌──────────────────────┐
│ RecipeService        │
│ .LearnRecipe(player, │
│  "steel-sword")      │
└──────────┬───────────┘
           │
           ▼
┌──────────────────────┐
│ Recipe exists? ✓     │
│ Already known? ✗     │
└──────────┬───────────┘
           │
           ▼
┌──────────────────────┐
│ player.RecipeBook    │
│ .Learn("steel-sword")│
└──────────┬───────────┘
           │
           ▼
┌──────────────────────┐
│ _eventBus.Publish    │
│ (RecipeLearnedEvent) │
└──────────┬───────────┘
           │
           ▼
┌──────────────────────┐
│ Return: Success      │
│ "Steel Sword"        │
└──────────────────────┘
```

### UC-003: View Known Recipes

**Actor:** Player
**Flow:** Player types "recipes" → RecipesCommand executes → Known recipes queried → Formatted output displayed

```
> recipes
      │
      ▼
┌──────────────────────┐
│ RecipesCommand       │
│ .Execute(player, []) │
└──────────┬───────────┘
           │
           ▼
┌──────────────────────┐
│ _recipeService       │
│ .GetKnownRecipes     │
│  (player)            │
└──────────┬───────────┘
           │
           ▼
┌──────────────────────┐
│ Group by category    │
│ Format output        │
└──────────┬───────────┘
           │
           ▼
┌──────────────────────┐
│ Display:             │
│ WEAPON RECIPES (1)   │
│   ✓ Iron Sword ...   │
│ POTION RECIPES (2)   │
│   ✓ Healing Potion...│
└──────────────────────┘
```

### UC-004: Validate Crafting Prerequisites

**Actor:** Player (via craft command)
**Flow:** Player attempts craft → CanCraft validates → Returns success or failure reason

```
> craft iron-sword
      │
      ▼
┌──────────────────────┐
│ _recipeService       │
│ .CanCraft(player,    │
│  "iron-sword",       │
│  "anvil")            │
└──────────┬───────────┘
           │
           ▼
┌──────────────────────┐
│ 1. Recipe exists? ✓  │
│ 2. Recipe known? ✓   │
│ 3. Correct station?✓ │
│ 4. Has ingredients?  │
└──────────┬───────────┘
           │
    ┌──────┴──────┐
    │             │
    ▼ missing     ▼ has all
┌────────────┐  ┌────────────────┐
│ Return:    │  │ Return:        │
│ Insufficient│ │ Success        │
│ Resources  │  │ (ready to      │
│ (iron-ore  │  │  craft)        │
│  x3 needed)│  └────────────────┘
└────────────┘
```

### UC-005: Filter Recipes by Category

**Actor:** Player
**Flow:** Player types "recipes weapon" → Category parsed → Filtered recipes displayed with details

```
> recipes weapon
      │
      ▼
┌──────────────────────┐
│ Parse category:      │
│ "weapon" → Weapon    │
└──────────┬───────────┘
           │
           ▼
┌──────────────────────┐
│ _recipeService       │
│ .GetKnownRecipesBy   │
│  Category(player,    │
│   Weapon)            │
└──────────┬───────────┘
           │
           ▼
┌──────────────────────┐
│ Display detailed:    │
│ ✓ Iron Sword         │
│   Station: anvil     │
│   Ingredients: ...   │
│ ✗ Steel Sword        │
│   (Unknown)          │
└──────────────────────┘
```

---

## 15. Deliverable Checklist

### Domain Layer
- [ ] `RecipeBook` entity created in `Domain/Entities/`
- [ ] `RecipeLearnedEvent` event created in `Domain/Events/`
- [ ] `Player.RecipeBook` property added

### Application Layer
- [ ] `IRecipeService` interface created in `Application/Interfaces/`
- [ ] `RecipeService` implementation created in `Application/Services/`
- [ ] `LearnRecipeResult` record created in `Application/Results/`
- [ ] `CraftValidation` record created in `Application/Results/`
- [ ] `MissingIngredient` record created in `Application/Results/`
- [ ] `RecipesCommand` created in `Application/Commands/`

### Service Registration
- [ ] `IRecipeService` registered in DI container
- [ ] `RecipeService` registered as implementation

### Testing
- [ ] `RecipeBookTests` with ~4 tests
- [ ] `RecipeServiceTests` with ~3 tests
- [ ] `RecipesCommandTests` with ~1 test
- [ ] All ~8 unit tests passing

### Documentation
- [ ] XML documentation on all public members
- [ ] Code follows .editorconfig conventions

---

## 16. Acceptance Criteria

### Functional Criteria
- [ ] RecipeBook tracks known recipe IDs
- [ ] Player entity has RecipeBook property
- [ ] IsKnown correctly checks recipe knowledge (case-insensitive)
- [ ] Learn adds new recipes and returns true
- [ ] Learn returns false for already-known recipes
- [ ] GetLearnedDate returns DateTime for known recipes
- [ ] InitializeDefaults adds all default recipe IDs
- [ ] GetKnownRecipes returns player's known recipes
- [ ] GetKnownRecipesByCategory filters correctly
- [ ] GetCraftableRecipes filters by station and knowledge
- [ ] LearnRecipe returns appropriate result types
- [ ] LearnRecipe publishes RecipeLearnedEvent on success
- [ ] CanCraft validates all prerequisites
- [ ] CanCraft returns missing ingredients when applicable
- [ ] RecipesCommand displays grouped recipe list
- [ ] RecipesCommand supports category filtering

### Quality Criteria
- [ ] Build succeeds with 0 errors and 0 warnings
- [ ] All ~8 unit tests pass
- [ ] XML documentation complete on all public members
- [ ] Code follows existing patterns (services, commands)
- [ ] Logging at appropriate levels

---

## 17. Dependencies

### Required From Prior Versions
| Version | Dependency | Usage |
|---------|------------|-------|
| v0.11.1a | RecipeDefinition | Recipe templates |
| v0.11.1a | IRecipeProvider | Recipe queries |
| v0.11.1a | RecipeCategory | Category enum |
| v0.11.0a | IResourceProvider | Ingredient lookups |
| v0.0.x | Player | Player entity |
| v0.0.x | Inventory | Resource checking |
| v0.0.x | IEventBus | Event publishing |
| v0.0.x | IGameCommand | Command pattern |

### Provides To Future Versions
| Version | Feature | Usage |
|---------|---------|-------|
| v0.11.1c | RecipeBook | Scroll learning integration |
| v0.11.1c | IRecipeService | IsRecipeKnown for scroll use |
| v0.11.2 | IRecipeService | CanCraft validation |
| v0.11.2 | RecipeBook | Known recipe verification |

---

## 18. Future Considerations

### Deferred to v0.11.1c (Recipe Discovery)
- **RecipeScrollItem**: Scroll that teaches recipes
- **Recipe scroll use handler**: Consumes scroll, teaches recipe
- **Scroll loot generation**: Recipe scrolls in chests/drops

### Deferred to v0.11.2 (Crafting System)
- **ICraftingService**: Actual crafting execution
- **Craft command**: Execute crafting with dice roll
- **Ingredient consumption**: Remove resources
- **Item creation**: Add crafted items

### Out of Scope (Future Versions)
- **Recipe mastery**: Improving recipes through repeated use
- **Recipe variants**: Alternative crafting paths
- **Recipe sharing**: Trading recipes between players
- **Recipe upgrades**: Enhancing base recipes

---

*Document Version: 1.0*
*Last Updated: 2026-01-16*
*Author: Claude (AI Assistant)*
