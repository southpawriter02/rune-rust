# v0.5.1b Design Specification: Ranged Weapons

**Version:** 0.5.1b
**Phase Name:** Ranged Weapons
**Parent Version:** v0.5.1 (Range & Melee Combat)
**Prerequisites:** v0.5.1a Complete (Range Core)
**Estimated Tests:** ~25 unit tests

---

## Table of Contents

1. [Executive Summary](#1-executive-summary)
2. [Feature Overview](#2-feature-overview)
3. [Architecture Diagrams](#3-architecture-diagrams)
4. [Item Modifications](#4-item-modifications)
5. [AbilityDefinition Modifications](#5-abilitydefinition-modifications)
6. [RangeService Updates](#6-rangeservice-updates)
7. [User-Facing Commands](#7-user-facing-commands)
8. [Data Model Changes](#8-data-model-changes)
9. [Configuration File Schemas](#9-configuration-file-schemas)
10. [Logging Specifications](#10-logging-specifications)
11. [Unit Testing Requirements](#11-unit-testing-requirements)
12. [Use Cases](#12-use-cases)
13. [Deliverable Checklist](#13-deliverable-checklist)
14. [Acceptance Criteria](#14-acceptance-criteria)
15. [Dependencies](#15-dependencies)
16. [Future Considerations](#16-future-considerations)

---

## 1. Executive Summary

### 1.1 Purpose

This specification implements ranged weapon mechanics including minimum range, range penalties for long-distance shots, and specific ranged weapon types. Building on the range foundation from v0.5.1a, this phase introduces bows, crossbows, thrown weapons, and ranged spells with appropriate range configurations.

Key mechanics:
- **Minimum Range**: Bows can't shoot adjacent enemies
- **Optimal Range**: Distance band with no accuracy penalty
- **Long Range Penalty**: Accuracy decreases beyond optimal range
- **Ranged Weapon Types**: Bows, crossbows, thrown weapons
- **Ranged Spells**: Abilities with range configurations

### 1.2 Key Deliverables

| Category | Items |
|----------|-------|
| **Item Updates** | `MinRange`, `OptimalRange`, `RangePenalty` |
| **AbilityDefinition Updates** | `MinRange`, `OptimalRange`, `RangePenalty` |
| **RangeService Updates** | `CheckFullRange`, `GetRangePenalty`, `IsTooClose` |
| **Weapon Definitions** | Shortbow, Longbow, Light Crossbow, Javelin, Throwing Dagger, Handaxe |
| **Ability Updates** | Fireball, Ice Bolt, Shocking Grasp, Thunder Wave |
| **Configuration** | ranged-weapons.json, abilities.json updates |
| **Tests** | ~25 unit tests |

### 1.3 Architectural Significance

This version extends the **Range Combat Pattern** with:

- **Three-Zone Range Model**: Too Close → Optimal → Long Range
- **Graduated Penalties**: Accuracy decreases progressively at distance
- **Versatile Weapons**: Thrown weapons usable in melee and at range
- **Spell Ranges**: Abilities have same range mechanics as weapons

---

## 2. Feature Overview

```
v0.5.1b Ranged Weapons
├── Item Modifications
│   ├── MinRange: int (default: 0)
│   ├── OptimalRange: int? (for penalty calculation)
│   ├── RangePenalty: int (penalty per cell beyond optimal)
│   ├── HasMinRange: bool
│   ├── IsInOptimalRange(distance): bool
│   ├── Thrown: bool (weapon can be thrown)
│   ├── MeleeCapable: bool (thrown weapon usable in melee)
│   └── TwoHanded: bool (for bows/crossbows)
├── AbilityDefinition Modifications
│   ├── MinRange: int (default: 0)
│   ├── OptimalRange: int? (default: null)
│   └── RangePenalty: int (default: 0)
├── RangeService Updates
│   ├── CheckFullRange(attacker, target, weapon)
│   ├── GetRangePenalty(distance, weapon)
│   ├── GetAbilityRangePenalty(distance, ability)
│   └── IsTooClose(attacker, target, weapon)
├── Ranged Weapon Definitions
│   ├── Shortbow (range 8, minRange 2)
│   ├── Longbow (range 12, minRange 2)
│   ├── Light Crossbow (range 10, minRange 1)
│   ├── Javelin (range 4, thrown)
│   ├── Throwing Dagger (range 3, meleeCapable)
│   └── Handaxe (range 3, meleeCapable)
└── Ranged Ability Definitions
    ├── Fireball (range 8)
    ├── Ice Bolt (range 6)
    ├── Shocking Grasp (melee touch)
    └── Thunder Wave (reach 2)
```

### 2.1 Scope Alignment

**In Scope:**
- `Item.MinRange` property for ranged weapons
- Minimum range validation (can't shoot adjacent enemies with bows)
- Range penalty configuration (accuracy at long range)
- Long range accuracy penalty calculation
- Optimal range band (no penalty zone)
- Bow weapon definitions
- Crossbow weapon definitions
- Thrown weapon definitions
- Ranged spell ability definitions
- Update ability configuration with ranges
- Ammunition tracking awareness (for display, not consumption)

**Out of Scope:**
- Ammunition consumption (future version)
- Line of sight (v0.5.1c)
- Cover affecting ranged attacks (v0.5.2)

---

## 3. Architecture Diagrams

### 3.1 Range Zone Model

```
┌─────────────────────────────────────────────────────────────────────┐
│                        RANGE ZONE MODEL                              │
└─────────────────────────────────────────────────────────────────────┘

    Example: Longbow (minRange: 2, optimalRange: 6, range: 12)

    Distance:  0   1   2   3   4   5   6   7   8   9  10  11  12  13+
              ╔═══════╤═══════════════════════╤═══════════════════╤═══╗
              ║  TOO  │     OPTIMAL RANGE     │    LONG RANGE     │OUT║
              ║ CLOSE │     (no penalty)      │    (penalty)      │   ║
              ╚═══════╧═══════════════════════╧═══════════════════╧═══╝
                 ↑           ↑                       ↑              ↑
              Can't      0 penalty              -1 per cell    Can't
              attack                           beyond optimal   attack

    Penalty Calculation:
    ┌────────────────────────────────────────────────────────────┐
    │ distance 5  → penalty = 0 (within optimal)                 │
    │ distance 7  → penalty = (7 - 6) × 1 = -1                   │
    │ distance 10 → penalty = (10 - 6) × 1 = -4                  │
    │ distance 13 → OUT OF RANGE (> 12)                          │
    └────────────────────────────────────────────────────────────┘
```

### 3.2 Weapon Type Comparison

```
┌─────────────────────────────────────────────────────────────────────┐
│                     WEAPON TYPE COMPARISON                           │
└─────────────────────────────────────────────────────────────────────┘

    BOWS (Longbow, Shortbow)
    ┌─────────────────────────────────────────────────────────┐
    │ • Two-handed                                            │
    │ • MinRange: 2 (can't shoot adjacent)                    │
    │ • Long range: 8-12 cells                                │
    │ • Requires ammunition (display only)                    │
    └─────────────────────────────────────────────────────────┘

    CROSSBOWS (Light Crossbow)
    ┌─────────────────────────────────────────────────────────┐
    │ • Two-handed                                            │
    │ • MinRange: 1 (can shoot adjacent)                      │
    │ • Medium range: 10 cells                                │
    │ • Requires ammunition (display only)                    │
    └─────────────────────────────────────────────────────────┘

    THROWN (Javelin, Dagger, Handaxe)
    ┌─────────────────────────────────────────────────────────┐
    │ • One-handed                                            │
    │ • MinRange: 0 (no minimum)                              │
    │ • Short range: 3-4 cells                                │
    │ • Some usable in melee (meleeCapable: true)             │
    │ • Thrown weapon at target location after throw          │
    └─────────────────────────────────────────────────────────┘
```

### 3.3 Range Validation Flow

```
┌─────────────────────────────────────────────────────────────────────┐
│                     FULL RANGE VALIDATION FLOW                       │
└─────────────────────────────────────────────────────────────────────┘

    Attack with Ranged Weapon
              │
              ▼
    ┌───────────────────┐
    │ Get Distance      │
    │ (from v0.5.1a)    │
    └────────┬──────────┘
             │
             ▼
    ┌───────────────────┐
    │ dist < MinRange?  │──Yes──▶ Fail: TooClose
    └────────┬──────────┘          "Target is too close"
             │No
             ▼
    ┌───────────────────┐
    │ dist > MaxRange?  │──Yes──▶ Fail: OutOfRange
    └────────┬──────────┘          "Target is out of range"
             │No
             ▼
    ┌───────────────────┐
    │ dist > Optimal?   │──Yes──▶ Calculate Penalty
    └────────┬──────────┘          penalty = (dist - optimal) × penaltyPerCell
             │No                   │
             ▼                     ▼
    ┌───────────────────┐    ┌───────────────────┐
    │ InRange = true    │    │ InRange = true    │
    │ Penalty = 0       │    │ Penalty = -N      │
    └───────────────────┘    └───────────────────┘
             │                     │
             └──────────┬──────────┘
                        ▼
              Proceed with Attack
              (apply penalty to roll)
```

### 3.4 Layer Diagram Updates

```
┌─────────────────────────────────────────────────────────────────────┐
│                       APPLICATION LAYER                              │
├─────────────────────────────────────────────────────────────────────┤
│  IRangeService (Extended from v0.5.1a)                               │
│  ├── [v0.5.1a] CheckRange(...)                                      │
│  ├── [v0.5.1a] GetValidTargets(...)                                 │
│  ├── [v0.5.1a] GetDistance(...)                                     │
│  ├── [NEW] CheckFullRange(attackerId, targetId, weapon): RangeResult│
│  ├── [NEW] GetRangePenalty(distance, weapon): int                   │
│  ├── [NEW] GetAbilityRangePenalty(distance, ability): int           │
│  └── [NEW] IsTooClose(attackerId, targetId, weapon): bool           │
├─────────────────────────────────────────────────────────────────────┤
│  RangeCheckResult (Extended)                                         │
│  ├── [v0.5.1a] InRange, Distance, WeaponRange, RangeType            │
│  ├── [NEW] Penalty: int (accuracy penalty)                          │
│  ├── [NEW] IsOptimal: bool                                          │
│  └── [NEW] TooClose: bool                                           │
└─────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────┐
│                         DOMAIN LAYER                                 │
├─────────────────────────────────────────────────────────────────────┤
│  ┌──────────────────────────────────────────────────────────────┐  │
│  │                   Item (Extended from v0.5.1a)                │  │
│  ├──────────────────────────────────────────────────────────────┤  │
│  │ [v0.5.1a] Range: int, RangeType: RangeType                   │  │
│  │ [NEW] MinRange: int (default: 0)                             │  │
│  │ [NEW] OptimalRange: int? (default: null → Range / 2)         │  │
│  │ [NEW] RangePenalty: int (default: 1)                         │  │
│  │ [NEW] Thrown: bool (can be thrown)                           │  │
│  │ [NEW] TwoHanded: bool (requires both hands)                  │  │
│  │ [NEW] MeleeCapable: bool (thrown can melee)                  │  │
│  │ [NEW] RequiresAmmunition: bool                               │  │
│  │ [NEW] HasMinRange: bool => MinRange > 0                      │  │
│  │ [NEW] IsInOptimalRange(distance): bool                       │  │
│  │ [NEW] GetPenaltyAtDistance(distance): int                    │  │
│  └──────────────────────────────────────────────────────────────┘  │
│                                                                      │
│  ┌──────────────────────────────────────────────────────────────┐  │
│  │          AbilityDefinition (Extended from v0.5.1a)           │  │
│  ├──────────────────────────────────────────────────────────────┤  │
│  │ [v0.5.1a] Range: int, RangeType: RangeType                   │  │
│  │ [NEW] MinRange: int (default: 0)                             │  │
│  │ [NEW] OptimalRange: int? (default: null)                     │  │
│  │ [NEW] RangePenalty: int (default: 0)                         │  │
│  └──────────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────────┘
```

---

## 4. Item Modifications

**File:** `src/Core/RuneAndRust.Domain/Entities/Item.cs`

```csharp
// Add to Item entity (extends v0.5.1a properties):

#region Extended Range Properties

/// <summary>Gets the minimum attack range (0 = no minimum).</summary>
public int MinRange { get; private set; } = 0;

/// <summary>Gets the optimal range (no penalty zone). Null = Range / 2.</summary>
public int? OptimalRange { get; private set; }

/// <summary>Gets the accuracy penalty per cell beyond optimal range.</summary>
public int RangePenalty { get; private set; } = 1;

/// <summary>Gets whether this weapon can be thrown.</summary>
public bool Thrown { get; private set; }

/// <summary>Gets whether this weapon requires both hands.</summary>
public bool TwoHanded { get; private set; }

/// <summary>Gets whether this thrown weapon can be used in melee.</summary>
public bool MeleeCapable { get; private set; }

/// <summary>Gets whether this weapon requires ammunition.</summary>
public bool RequiresAmmunition { get; private set; }

/// <summary>Returns true if weapon has a minimum range.</summary>
public bool HasMinRange => MinRange > 0;

/// <summary>Gets the effective optimal range.</summary>
public int GetOptimalRange() => OptimalRange ?? Range / 2;

/// <summary>Checks if a distance is within optimal range.</summary>
public bool IsInOptimalRange(int distance) => distance <= GetOptimalRange();

/// <summary>Gets the accuracy penalty at a given distance.</summary>
public int GetPenaltyAtDistance(int distance)
{
    if (RangeType != RangeType.Ranged) return 0;
    if (distance < MinRange) return int.MaxValue;
    if (distance > Range) return int.MaxValue;

    var optimal = GetOptimalRange();
    if (distance <= optimal) return 0;

    return (distance - optimal) * RangePenalty;
}

/// <summary>Sets extended range properties from definition.</summary>
public void SetExtendedRangeProperties(
    int minRange, int? optimalRange, int rangePenalty,
    bool thrown, bool twoHanded, bool meleeCapable, bool requiresAmmunition)
{
    ArgumentOutOfRangeException.ThrowIfNegative(minRange);
    MinRange = minRange;
    OptimalRange = optimalRange;
    RangePenalty = rangePenalty;
    Thrown = thrown;
    TwoHanded = twoHanded;
    MeleeCapable = meleeCapable;
    RequiresAmmunition = requiresAmmunition;
}

#endregion
```

**ItemDefinition Updates:**

```csharp
// Add to ItemDefinition:
public int MinRange { get; private set; } = 0;
public int? OptimalRange { get; private set; }
public int RangePenalty { get; private set; } = 1;
public bool Thrown { get; private set; }
public bool TwoHanded { get; private set; }
public bool MeleeCapable { get; private set; }
public bool RequiresAmmunition { get; private set; }
```

---

## 5. AbilityDefinition Modifications

**File:** `src/Core/RuneAndRust.Domain/Definitions/AbilityDefinition.cs`

```csharp
// Add to AbilityDefinition (extends v0.5.1a properties):

#region Extended Range Properties

/// <summary>Gets the minimum range for this ability.</summary>
public int MinRange { get; private set; } = 0;

/// <summary>Gets the optimal range (no penalty zone).</summary>
public int? OptimalRange { get; private set; }

/// <summary>Gets the accuracy penalty per cell beyond optimal.</summary>
public int RangePenalty { get; private set; } = 0;

/// <summary>Gets the effective optimal range.</summary>
public int GetOptimalRange() => OptimalRange ?? Range;

/// <summary>Gets the accuracy penalty at a given distance.</summary>
public int GetPenaltyAtDistance(int distance)
{
    if (RangePenalty == 0) return 0;
    if (distance < MinRange) return int.MaxValue;
    if (distance > Range) return int.MaxValue;

    var optimal = GetOptimalRange();
    if (distance <= optimal) return 0;

    return (distance - optimal) * RangePenalty;
}

#endregion
```

---

## 6. RangeService Updates

**File:** `src/Core/RuneAndRust.Application/Services/RangeService.cs`

```csharp
// Add to RangeService (extends v0.5.1a implementation):

/// <summary>Checks full range including min range and calculates penalty.</summary>
public RangeCheckResult CheckFullRange(Guid attackerId, Guid targetId, Item weapon)
{
    var grid = _gridService.GetActiveGrid();
    if (grid == null)
        return Fail(RangeFailureReason.NoActiveGrid, "No active combat grid.");

    var distance = GetDistance(attackerId, targetId);
    if (!distance.HasValue)
        return Fail(RangeFailureReason.AttackerNotOnGrid, "Entity not on grid.");

    var dist = distance.Value;

    // Check minimum range
    if (weapon.HasMinRange && dist < weapon.MinRange)
    {
        return new RangeCheckResult
        {
            InRange = false,
            Distance = dist,
            WeaponRange = weapon.Range,
            RangeType = weapon.RangeType,
            FailureReason = RangeFailureReason.TooClose,
            TooClose = true,
            Message = $"Target is too close! Minimum range: {weapon.MinRange} cells."
        };
    }

    // Check maximum range
    if (dist > weapon.Range)
    {
        return new RangeCheckResult
        {
            InRange = false,
            Distance = dist,
            WeaponRange = weapon.Range,
            RangeType = weapon.RangeType,
            FailureReason = RangeFailureReason.OutOfRange,
            Message = $"Target is out of range (distance: {dist}, range: {weapon.Range})."
        };
    }

    // Calculate penalty
    var penalty = weapon.GetPenaltyAtDistance(dist);
    var isOptimal = weapon.IsInOptimalRange(dist);

    _logger.LogDebug(
        "Full range check: dist {Dist}, range {Range}, minRange {Min}, optimal {Opt}, penalty {Pen}",
        dist, weapon.Range, weapon.MinRange, weapon.GetOptimalRange(), penalty);

    return new RangeCheckResult
    {
        InRange = true,
        Distance = dist,
        WeaponRange = weapon.Range,
        RangeType = weapon.RangeType,
        Penalty = penalty,
        IsOptimal = isOptimal,
        Message = isOptimal
            ? "Target is in optimal range."
            : $"Target is at long range (penalty: -{penalty})."
    };
}

/// <summary>Gets the range penalty for a given distance.</summary>
public int GetRangePenalty(int distance, Item weapon) =>
    weapon.GetPenaltyAtDistance(distance);

/// <summary>Gets the range penalty for an ability.</summary>
public int GetAbilityRangePenalty(int distance, AbilityDefinition ability) =>
    ability.GetPenaltyAtDistance(distance);

/// <summary>Checks if target is too close (within min range).</summary>
public bool IsTooClose(Guid attackerId, Guid targetId, Item weapon)
{
    if (!weapon.HasMinRange) return false;
    var distance = GetDistance(attackerId, targetId);
    return distance.HasValue && distance.Value < weapon.MinRange;
}
```

### 6.1 Updated RangeCheckResult

```csharp
public readonly record struct RangeCheckResult
{
    public bool InRange { get; init; }
    public int Distance { get; init; }
    public int WeaponRange { get; init; }
    public RangeType RangeType { get; init; }
    public string Message { get; init; }
    public RangeFailureReason? FailureReason { get; init; }

    // New in v0.5.1b:
    public int Penalty { get; init; }
    public bool IsOptimal { get; init; }
    public bool TooClose { get; init; }
}
```

---

## 7. User-Facing Commands

### 7.1 Ranged Attack (In Optimal Range)

```
> attack goblin

You draw your Longbow and aim at the Goblin at F2...

[Ranged attack - distance: 4 cells]
[Optimal range: 6 cells - no penalty]
[Attack Roll: 2d6 + 3 = 13 vs AC 11]
Hit! 6 damage to Goblin.
```

### 7.2 Ranged Attack (Long Range Penalty)

```
> attack skeleton

You take aim at the distant Skeleton at H1...

[Ranged attack - distance: 7 cells]
[Longbow optimal range: 6]
[Long range penalty: -1]
[Attack Roll: 2d6 + 3 - 1 = 11 vs AC 12]
Miss! Your arrow falls short.
```

### 7.3 Ranged Attack (Too Close)

```
> attack goblin

The Goblin is too close for your Longbow!

[Distance: 1 cell]
[Longbow minimum range: 2 cells]

Switch to a melee weapon or move away.
```

### 7.4 Thrown Weapon

```
> throw javelin skeleton

You hurl your Javelin at the Skeleton at E3...

[Thrown weapon - distance: 2 cells]
[Attack Roll: 2d6 + 2 = 12 vs AC 12]
Hit! 5 damage to Skeleton.

[Javelin is now at E3 - retrieve after combat]
```

### 7.5 Ranged Spell

```
> cast fireball goblin

You hurl a ball of fire at the Goblin at G2...

[Ranged spell - distance: 5 cells]
[Fireball range: 8 cells - in range]
[Spell Attack: 2d6 + 4 = 15 vs AC 11]
Hit! The Goblin takes 12 fire damage!
```

### 7.6 Weapon Info Display

```
> examine longbow

Longbow
═══════════════════════════════════
Damage: 1d8 piercing
Range: 12 cells (Ranged)
Minimum Range: 2 cells
Optimal Range: 6 cells
Long Range Penalty: -1 per cell beyond optimal
Two-Handed: Yes
Requires: Arrows
```

---

## 8. Data Model Changes

| Type | Layer | Description |
|------|-------|-------------|
| `Item` | Domain/Entities | Add MinRange, OptimalRange, RangePenalty, etc. |
| `ItemDefinition` | Domain/Definitions | Add MinRange, OptimalRange, RangePenalty, etc. |
| `AbilityDefinition` | Domain/Definitions | Add MinRange, OptimalRange, RangePenalty |
| `RangeService` | Application/Services | Add CheckFullRange, GetRangePenalty, IsTooClose |
| `RangeCheckResult` | Application/DTOs | Add Penalty, IsOptimal, TooClose |

---

## 9. Configuration File Schemas

### 9.1 Ranged Weapons Config

**File:** `config/items.json` (add to existing)

```json
{
  "items": [
    {
      "id": "shortbow",
      "name": "Shortbow",
      "type": "Weapon",
      "subType": "Bow",
      "damage": "1d6",
      "range": 8,
      "minRange": 2,
      "optimalRange": 5,
      "rangePenalty": 1,
      "rangeType": "Ranged",
      "twoHanded": true,
      "requiresAmmunition": true,
      "ammunitionType": "arrows"
    },
    {
      "id": "longbow",
      "name": "Longbow",
      "type": "Weapon",
      "subType": "Bow",
      "damage": "1d8",
      "range": 12,
      "minRange": 2,
      "optimalRange": 6,
      "rangePenalty": 1,
      "rangeType": "Ranged",
      "twoHanded": true,
      "requiresAmmunition": true,
      "ammunitionType": "arrows"
    },
    {
      "id": "light-crossbow",
      "name": "Light Crossbow",
      "type": "Weapon",
      "subType": "Crossbow",
      "damage": "1d8",
      "range": 10,
      "minRange": 1,
      "optimalRange": 5,
      "rangePenalty": 1,
      "rangeType": "Ranged",
      "twoHanded": true,
      "requiresAmmunition": true,
      "ammunitionType": "bolts"
    },
    {
      "id": "javelin",
      "name": "Javelin",
      "type": "Weapon",
      "subType": "Thrown",
      "damage": "1d6",
      "range": 4,
      "minRange": 0,
      "optimalRange": 3,
      "rangePenalty": 2,
      "rangeType": "Ranged",
      "thrown": true
    },
    {
      "id": "throwing-dagger",
      "name": "Throwing Dagger",
      "type": "Weapon",
      "subType": "Thrown",
      "damage": "1d4",
      "range": 3,
      "minRange": 0,
      "optimalRange": 2,
      "rangePenalty": 1,
      "rangeType": "Ranged",
      "thrown": true,
      "meleeCapable": true,
      "meleeDamage": "1d4"
    },
    {
      "id": "handaxe",
      "name": "Handaxe",
      "type": "Weapon",
      "subType": "Thrown",
      "damage": "1d6",
      "range": 3,
      "minRange": 0,
      "optimalRange": 2,
      "rangePenalty": 2,
      "rangeType": "Ranged",
      "thrown": true,
      "meleeCapable": true,
      "meleeDamage": "1d6"
    }
  ]
}
```

### 9.2 Ranged Abilities Config

**File:** `config/abilities.json` (add/update)

```json
{
  "abilities": [
    {
      "id": "fireball",
      "name": "Fireball",
      "description": "Hurl a ball of fire at an enemy.",
      "damageType": "Fire",
      "damage": "2d6",
      "range": 8,
      "rangeType": "Ranged",
      "manaCost": 5
    },
    {
      "id": "ice-bolt",
      "name": "Ice Bolt",
      "description": "Launch a bolt of freezing ice.",
      "damageType": "Cold",
      "damage": "1d8",
      "range": 6,
      "rangeType": "Ranged",
      "manaCost": 3
    },
    {
      "id": "shocking-grasp",
      "name": "Shocking Grasp",
      "description": "Electrify a touched enemy.",
      "damageType": "Lightning",
      "damage": "2d8",
      "range": 1,
      "rangeType": "Melee",
      "manaCost": 4
    },
    {
      "id": "thunder-wave",
      "name": "Thunder Wave",
      "description": "Release a wave of thunder around you.",
      "damageType": "Thunder",
      "damage": "1d6",
      "range": 2,
      "rangeType": "Reach",
      "manaCost": 4
    }
  ]
}
```

---

## 10. Logging Specifications

| Component | Level | Events |
|-----------|-------|--------|
| `RangeService` | Debug | Full range checks, penalty calculations |
| `RangeService` | Information | Too-close/out-of-range failures |
| `AttackCommand` | Debug | Penalty application to rolls |

---

## 11. Unit Testing Requirements

| Feature | Test Count |
|---------|------------|
| Item Extended Range Properties | ~5 |
| Item.GetPenaltyAtDistance | ~4 |
| AbilityDefinition Range Properties | ~3 |
| RangeService.CheckFullRange | ~6 |
| RangeService.GetRangePenalty | ~4 |
| RangeService.IsTooClose | ~3 |
| **Total** | **~25** |

---

## 12. Use Cases

### UC-001: Attack in Optimal Range
**Flow:** Player at D4, target at F2 (dist 4), Longbow optimal 6 → No penalty → Attack

### UC-002: Attack at Long Range
**Flow:** Player at D4, target at H1 (dist 7), Longbow optimal 6 → Penalty -1 → Attack with -1

### UC-003: Attack Too Close
**Flow:** Player at D4, target at D3 (dist 1), Longbow minRange 2 → Fail: Too close

### UC-004: Throw Weapon
**Flow:** Player throws javelin → Display "Javelin at target location"

### UC-005: Cast Ranged Spell
**Flow:** Cast Fireball at distance 5 → Range 8 → In range → Spell attack

---

## 13. Deliverable Checklist

### Domain Layer
- [ ] Item MinRange, OptimalRange, RangePenalty properties
- [ ] Item Thrown, TwoHanded, MeleeCapable properties
- [ ] Item.GetPenaltyAtDistance()
- [ ] AbilityDefinition extended range properties

### Application Layer
- [ ] RangeService.CheckFullRange()
- [ ] RangeService.GetRangePenalty()
- [ ] RangeService.GetAbilityRangePenalty()
- [ ] RangeService.IsTooClose()
- [ ] Updated RangeCheckResult

### Configuration
- [ ] Ranged weapons in items.json
- [ ] Ranged abilities in abilities.json

### Testing
- [ ] ~25 unit tests
- [ ] All tests passing

---

## 14. Acceptance Criteria

### Functional
- [ ] Item.MinRange prevents attacks on too-close enemies
- [ ] MinRange validation returns clear error message
- [ ] OptimalRange defines no-penalty zone
- [ ] RangePenalty applies beyond optimal range correctly
- [ ] Longbow: minRange 2, optimalRange 6, range 12
- [ ] Shortbow: minRange 2, optimalRange 5, range 8
- [ ] Light Crossbow: minRange 1, optimalRange 5, range 10
- [ ] Thrown weapons: range 3-4, minRange 0
- [ ] Thrown weapons can be used in melee if meleeCapable
- [ ] Ranged spells have appropriate ranges
- [ ] Range penalty shows in attack output
- [ ] Attack fails with helpful message if too close

### Quality
- [ ] Build succeeds with 0 errors/warnings
- [ ] ~25 unit tests pass
- [ ] XML documentation complete

---

## 15. Dependencies

### Required from v0.5.1a

| Type | Usage |
|------|-------|
| `RangeType` enum | Type classification |
| `Item.Range`, `Item.RangeType` | Base range properties |
| `RangeService.CheckRange()` | Base range validation |
| `RangeCheckResult` | Extended with penalty |

### Provides to v0.5.1c
- Full range validation for LOS integration
- Penalty calculations applied after LOS check

---

## 16. Future Considerations

### Deferred to v0.5.1c
- Line of sight blocking ranged attacks
- LOS validation in CheckFullRange

### Deferred to v0.5.2
- Cover affecting ranged attack accuracy
- Concealment

### Deferred to Future Versions
- Ammunition consumption tracking
- Arrow/bolt recovery after combat
- Thrown weapon retrieval mechanics
- Dual-wielding thrown weapons

---

*Document Version: 1.0*
*Last Updated: 2026-01-10*
*Author: AI Assistant*
