# v0.14.9c Design Specification: NPC Descriptor Schema

**Version:** 0.14.9c
**Parent:** v0.14.9 (Advanced Descriptor Configuration Schemas)
**Prerequisites:** v0.14.8 Complete (Dice Configuration Schemas)
**Status:** Design Complete

---

## Table of Contents

1. [Executive Summary](#1-executive-summary)
2. [Feature Overview](#2-feature-overview)
3. [Architecture Diagrams](#3-architecture-diagrams)
4. [Schema Root Definition](#4-schema-root-definition)
   - 4.1 [Root Configuration Properties](#41-root-configuration-properties)
   - 4.2 [Category Types](#42-category-types)
   - 4.3 [Pool Structure](#43-pool-structure)
5. [NPCPhysicalDescriptor Definition](#5-npcphysicaldescriptor-definition)
   - 5.1 [Core Properties](#51-core-properties)
   - 5.2 [Descriptor Types](#52-descriptor-types)
   - 5.3 [Age Categories](#53-age-categories)
6. [NPCAmbientBarkDescriptor Definition](#6-npcambientbarkdescriptor-definition)
   - 6.1 [Bark Properties](#61-bark-properties)
   - 6.2 [Bark Types](#62-bark-types)
   - 6.3 [Activity Contexts](#63-activity-contexts)
   - 6.4 [Trigger Conditions](#64-trigger-conditions)
7. [NPCReactionDescriptor Definition](#7-npcreactiondescriptor-definition)
   - 7.1 [Reaction Properties](#71-reaction-properties)
   - 7.2 [Reaction Types](#72-reaction-types)
   - 7.3 [Trigger Events](#73-trigger-events)
   - 7.4 [Action Tendencies](#74-action-tendencies)
8. [NPC Archetype Reference](#8-npc-archetype-reference)
   - 8.1 [Archetype Enum](#81-archetype-enum)
   - 8.2 [Archetype Subtypes](#82-archetype-subtypes)
9. [NPC Condition Reference](#9-npc-condition-reference)
10. [Disposition Reference](#10-disposition-reference)
11. [Variable Placeholders Reference](#11-variable-placeholders-reference)
12. [Configuration Schema](#12-configuration-schema)
13. [Logging Specifications](#13-logging-specifications)
14. [Unit Testing Requirements](#14-unit-testing-requirements)
15. [Use Cases](#15-use-cases)
16. [Deliverable Checklist](#16-deliverable-checklist)
17. [Acceptance Criteria](#17-acceptance-criteria)
18. [Dependencies](#18-dependencies)
19. [Future Considerations](#19-future-considerations)
20. [Appendix: Schema Validation Examples](#20-appendix-schema-validation-examples)

---

## 1. Executive Summary

Version 0.14.9c introduces the **NPC Descriptor Schema** (`npc-descriptors.schema.json`), which provides a comprehensive JSON schema for validating NPC flavor text descriptors including physical appearance descriptions, ambient dialogue barks, and emotional reaction descriptors. This schema enables full customization of NPC presentation organized by archetype and context—all without code changes.

The NPC Descriptor Schema converts the existing SQL schema and content from `docs/design/descriptors/` into JSON format, establishing a standard structure for all NPC-related narrative content in the game, supporting diverse character archetypes from Dvergr engineers to Seiðkona mystics to desperate bandits.

### Key Deliverables

| Category | Items |
|----------|-------|
| **Schema Files** | `npc-descriptors.schema.json` |
| **Schema Definitions** | `NPCPhysicalDescriptor`, `NPCAmbientBarkDescriptor`, `NPCReactionDescriptor`, `NPCArchetype`, `NPCSubtype`, `NPCCondition`, `Disposition`, `BarkType`, `ReactionType` |
| **Configuration Files** | `npc-descriptors.json` (example content) |
| **Tests** | ~6 new unit tests |

### Architectural Significance

This version provides:
- **Physical descriptors** - Full body, face, clothing, equipment, bearing descriptions
- **Ambient bark descriptors** - At-work, idle, warning, greeting dialogue
- **Reaction descriptors** - Emotional responses to player actions and events
- **8 NPC archetypes** - Dvergr, Seidkona, Bandit, Raider, Merchant, Guard, Citizen, Forlorn
- **16 bark types** - Comprehensive ambient dialogue categorization
- **15 reaction types** - Full emotional response range
- **5 dispositions** - Hostile, Unfriendly, Neutral, Friendly, Allied
- **Variable placeholders** - Dynamic content substitution
- **Biome-specific variations** - Location-based descriptor variants

### Relationship to Other Schemas

```
┌─────────────────────────────────────────────────────────────────────────────┐
│               v0.14.9 ADVANCED DESCRIPTOR CONFIGURATION SCHEMAS              │
└─────────────────────────────────────────────────────────────────────────────┘

  ┌─────────────────────────────────────────────────────────────────────────┐
  │  v0.14.9a: dialogue.schema.json (dialogue trees)                        │
  │  v0.14.9b: ability-descriptors.schema.json (Galdr, weapon arts)        │
  │  v0.14.9c: npc-descriptors.schema.json ◀── THIS VERSION (NPC FLAVOR)   │
  │  v0.14.9d: psychological-descriptors.schema.json (stress, trauma)      │
  │  v0.14.9e: capture-templates.schema.json (lore fragments)              │
  └─────────────────────────────────────────────────────────────────────────┘

  Source Material (SQL format):
  ├── docs/design/descriptors/schemas/npc_descriptors_barks_schema.sql
  └── docs/design/descriptors/descriptors/npc_descriptors_barks_data.sql

  Related Systems:
  • NPC generation system (character creation)
  • Room population service (NPC placement)
  • Combat system (combat barks, reactions)
  • Faction system (disposition tracking)
  • Biome system (environmental context)
```

---

## 2. Feature Overview

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                     NPC DESCRIPTOR SCHEMA FEATURE TREE                       │
└─────────────────────────────────────────────────────────────────────────────┘

npc-descriptors.schema.json
├── Root Configuration
│   ├── $schema reference
│   ├── version identifier
│   ├── category classification
│   └── pools (descriptor collections)
│
├── NPC Physical Descriptors
│   ├── Descriptor Types
│   │   ├── FullBody (overall appearance)
│   │   ├── Face (facial features)
│   │   ├── Clothing (attire, garments)
│   │   ├── Equipment (tools, weapons, gear)
│   │   ├── Bearing (posture, demeanor)
│   │   └── Distinguishing (unique traits)
│   │
│   ├── Condition Modifiers
│   │   ├── Healthy
│   │   ├── Wounded
│   │   ├── Exhausted
│   │   ├── Affluent
│   │   ├── Impoverished
│   │   └── BattleReady
│   │
│   └── Age Categories
│       ├── Young
│       ├── MiddleAged
│       ├── Elderly
│       └── Ageless
│
├── NPC Ambient Bark Descriptors
│   ├── Work Barks
│   │   ├── AtWork (performing tasks)
│   │   └── Crafting (creating items)
│   │
│   ├── Social Barks
│   │   ├── IdleConversation (casual chat)
│   │   ├── Greeting (welcoming)
│   │   ├── Encouragement (positive feedback)
│   │   └── Teaching (sharing knowledge)
│   │
│   ├── Alert Barks
│   │   ├── Observation (noticing things)
│   │   ├── Warning (caution)
│   │   ├── Suspicion (distrust)
│   │   └── Concern (worry)
│   │
│   ├── Combat Barks
│   │   ├── Threat (intimidation)
│   │   ├── Insult (mockery)
│   │   ├── BattleCry (combat initiation)
│   │   ├── Wounded (taking damage)
│   │   └── Fleeing (retreat)
│   │
│   └── Mood Barks
│       ├── Celebration (joy)
│       └── Complaint (dissatisfaction)
│
└── NPC Reaction Descriptors
    ├── Positive Reactions
    │   ├── Impressed (admiration)
    │   ├── Grateful (thankfulness)
    │   ├── Relieved (relief)
    │   ├── Joyful (happiness)
    │   ├── Proud (pride)
    │   └── Curious (interest)
    │
    ├── Negative Reactions
    │   ├── Angry (anger)
    │   ├── Fearful (fear)
    │   ├── Disgusted (disgust)
    │   ├── Betrayed (betrayal)
    │   └── Suspicious (mistrust)
    │
    └── Neutral Reactions
        ├── Surprised (shock)
        ├── Confused (bewilderment)
        ├── Pained (pain)
        └── Resigned (acceptance)
```

---

## 3. Architecture Diagrams

### 3.1 NPC Descriptor Pool Architecture

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                      NPC DESCRIPTOR POOL ARCHITECTURE                        │
└─────────────────────────────────────────────────────────────────────────────┘

                    npc-descriptors.json
            ┌───────────────────────────────────────┐
            │  {                                    │
            │    "$schema": "...",                  │
            │    "version": "1.0.0",                │
            │    "category": "npc-physical",        │
            │    "pools": {                         │
            │      "dvergr_tinkerer_fullbody": [...],
            │      "dvergr_tinkerer_face": [...],   │
            │      "seidkona_wandering_bearing":[...]│
            │    }                                  │
            │  }                                    │
            └─────────────────┬─────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                          DESCRIPTOR POOL                                     │
│─────────────────────────────────────────────────────────────────────────────│
│  Pool ID: "dvergr_tinkerer_fullbody"                                        │
│  Descriptors: [                                                              │
│    {                                                                         │
│      "id": "dvergr_tinkerer_fullbody_001",                                  │
│      "text": "A stocky Dvergr covered in soot and machine oil, tools        │
│               hanging from every belt loop.",                               │
│      "weight": 10,                                                           │
│      "archetype": "Dvergr",                                                 │
│      "subtype": "Tinkerer",                                                 │
│      "descriptorType": "FullBody",                                          │
│      "condition": "Healthy",                                                │
│      "tags": ["Memorable", "Technical"]                                     │
│    },                                                                        │
│    { ... more descriptors ... }                                              │
│  ]                                                                           │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 3.2 NPC Description Generation Flow

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                    NPC DESCRIPTION GENERATION FLOW                           │
└─────────────────────────────────────────────────────────────────────────────┘

              NPC Spawns in Room
                      │
                      ▼
        ┌─────────────────────────────────┐
        │  1. DETERMINE ARCHETYPE         │
        │  "Dvergr Tinkerer"              │
        │  (archetype: Dvergr,            │
        │   subtype: Tinkerer)            │
        └─────────────┬───────────────────┘
                      │
                      ▼
        ┌─────────────────────────────────┐
        │  2. DETERMINE CONDITION         │
        │  "Healthy" / "Wounded" /        │
        │  "BattleReady" based on         │
        │  NPC state                      │
        └─────────────┬───────────────────┘
                      │
                      ▼
        ┌─────────────────────────────────┐
        │  3. BUILD COMPOSITE DESCRIPTION │
        │  Pool: "dvergr_tinkerer_fullbody"│
        │  + Pool: "dvergr_tinkerer_face" │
        │  + Pool: "dvergr_distinguishing"│
        └─────────────┬───────────────────┘
                      │
                      ▼
        ┌─────────────────────────────────┐
        │  4. SELECT BY WEIGHT            │
        │  Weighted random selection      │
        │  from each pool                 │
        └─────────────┬───────────────────┘
                      │
                      ▼
        ┌─────────────────────────────────┐
        │  5. SUBSTITUTE VARIABLES        │
        │  {NPCName} → "Volund"           │
        │  {Tool} → "wrench"              │
        │  {Biome} → "The Roots"          │
        └─────────────┬───────────────────┘
                      │
                      ▼
   ┌──────────────────────────────────────────────────────────┐
   │ OUTPUT: "A stocky Dvergr covered in soot and machine     │
   │          oil, tools hanging from every belt loop."       │
   └──────────────────────────────────────────────────────────┘

  Descriptor Combination Example:
  ═══════════════════════════════
  FullBody: "A stocky Dvergr covered in soot and machine oil..."
  Face:     "An elderly Dvergr whose eyes reflect the light strangely..."
  Equipment: "This Dvergr's hands are stained black from decades..."

  Combined: "A stocky Dvergr covered in soot and machine oil, tools
            hanging from every belt loop. An elderly face whose eyes
            reflect the light strangely—hands stained black from
            decades of working with corroded metal."
```

### 3.3 Ambient Bark Selection Flow

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                      AMBIENT BARK SELECTION FLOW                             │
└─────────────────────────────────────────────────────────────────────────────┘

              Game Tick / Trigger Event
                         │
        ┌────────────────┴────────────────┐
        │                                 │
     Idle Tick                      Event Trigger
        │                                 │
        ▼                                 ▼
┌──────────────────┐             ┌──────────────────┐
│ Check Activity   │             │ Check Trigger    │
│ Context:         │             │ Condition:       │
│ • Working        │             │ • PlayerNearby   │
│ • Idle           │             │ • EnemyNear      │
│ • Trading        │             │ • DangerDetected │
│ • Guarding       │             │ • ResourceFound  │
└────────┬─────────┘             └────────┬─────────┘
         │                                │
         └────────────────┬───────────────┘
                          │
                          ▼
         ┌────────────────────────────────┐
         │  FILTER BY DISPOSITION         │
         │  Hostile  → Threat, Insult     │
         │  Neutral  → Observation, Work  │
         │  Friendly → Greeting, Teaching │
         └────────────────┬───────────────┘
                          │
                          ▼
         ┌────────────────────────────────┐
         │  SELECT BARK BY TYPE           │
         │  Pool: "{archetype}_{subtype}_ │
         │         {barkType}"            │
         │  e.g., "dvergr_tinkerer_atwork"│
         └────────────────┬───────────────┘
                          │
                          ▼
   ┌──────────────────────────────────────────────────────────┐
   │ OUTPUT: "Tolerance specifications are off by point-oh-   │
   │          three millimeters. Unacceptable."               │
   └──────────────────────────────────────────────────────────┘

  Bark Type Selection by Context:
  ═══════════════════════════════
  Working + Friendly   → AtWork, Teaching
  Idle + Neutral       → IdleConversation, Observation
  Guarding + Unfriendly→ Warning, Suspicion
  Fighting + Hostile   → Threat, BattleCry, Insult
  TakingDamage         → Wounded
  HealthLow + Hostile  → Fleeing
```

### 3.4 Reaction Descriptor Selection Flow

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                     REACTION DESCRIPTOR SELECTION FLOW                       │
└─────────────────────────────────────────────────────────────────────────────┘

              Player Action / Event
                      │
         ┌────────────┴────────────┐
         │                         │
    Player Action           Game Event
         │                         │
         ▼                         ▼
┌──────────────────┐      ┌──────────────────┐
│ PlayerApproaches │      │ AllyKilled       │
│ PlayerAttacks    │      │ VictoryAchieved  │
│ PlayerHelps      │      │ TreasureFound    │
│ PlayerGifts      │      │ BlightEncounter  │
│ PlayerSteals     │      │ MechanismRepaired│
└────────┬─────────┘      └────────┬─────────┘
         │                         │
         └───────────┬─────────────┘
                     │
                     ▼
        ┌────────────────────────────────┐
        │  DETERMINE REACTION TYPE       │
        │  Based on:                     │
        │  • Trigger Event               │
        │  • Prior Disposition           │
        │  • NPC Archetype               │
        └────────────────┬───────────────┘
                         │
                         ▼
        ┌────────────────────────────────┐
        │  DETERMINE INTENSITY           │
        │  Mild → Moderate → Strong →    │
        │  Extreme                       │
        └────────────────┬───────────────┘
                         │
                         ▼
        ┌────────────────────────────────┐
        │  DETERMINE ACTION TENDENCY     │
        │  Approach, Flee, Attack,       │
        │  Assist, Ignore, Report,       │
        │  Investigate, Guard            │
        └────────────────┬───────────────┘
                         │
                         ▼
   ┌──────────────────────────────────────────────────────────┐
   │ OUTPUT: "You have the look of someone who can actually   │
   │          fix things. Rare, these days."                  │
   │ Action: Assist                                           │
   └──────────────────────────────────────────────────────────┘

  Reaction Matrix (Trigger × Disposition):
  ════════════════════════════════════════
  PlayerApproaches + Hostile   → Suspicious, Guard
  PlayerApproaches + Friendly  → Curious, Approach
  PlayerAttacks + Any          → Angry, Attack/Flee
  PlayerHelps + Neutral        → Impressed, Assist
  PlayerHelps + Friendly       → Grateful, Approach
  AllyKilled + Any             → Fearful/Angry, Flee/Attack
  MechanismRepaired + Dvergr   → Impressed, Assist
  MagicWitnessed + Seidkona    → Impressed, Approach
```

### 3.5 Schema Layer Diagram

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           SCHEMA LAYER DIAGRAM                               │
└─────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────┐
│                              PRESENTATION                                    │
│                                                                              │
│  Room UI displays NPC descriptions                                           │
│  • NPC appearance when entering room                                         │
│  • Ambient bark in dialogue area                                             │
│  • Reaction dialogue on player actions                                       │
│  • Variable substitution ({NPCName}, {Activity}, etc.)                       │
└─────────────────────────────────────────────────────────────────────────────┘
                                     │
                                     ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                              APPLICATION                                     │
│                                                                              │
│  NPCDescriptorService manages descriptor selection                           │
│  • GetPhysicalDescriptor(archetype, subtype, type, condition, age)           │
│  • GetAmbientBark(archetype, subtype, barkType, activity, disposition)       │
│  • GetReactionDescriptor(archetype, subtype, reaction, trigger, intensity)   │
│  • SelectByWeight(descriptors) → weighted random selection                   │
│  • SubstituteVariables(text, context) → {Variable} replacement               │
│  • BuildCompositeDescription(descriptors[]) → combined description           │
└─────────────────────────────────────────────────────────────────────────────┘
                                     │
                                     ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                             DOMAIN LAYER                                     │
│                                                                              │
│  NPC definitions and descriptor collections                                  │
│  • NPCPhysicalDescriptor (appearance descriptions)                           │
│  • NPCAmbientBarkDescriptor (ambient dialogue)                               │
│  • NPCReactionDescriptor (emotional responses)                               │
│  • NPCArchetype enum (8 archetypes)                                          │
│  • NPCCondition enum (6 conditions)                                          │
│  • Disposition enum (5 dispositions)                                         │
│  • BarkType enum (16 types)                                                  │
│  • ReactionType enum (15 types)                                              │
└─────────────────────────────────────────────────────────────────────────────┘
                                     │
                                     ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                           INFRASTRUCTURE                                     │
│                                                                              │
│  NPCDescriptorProvider loads from JSON with schema validation                │
│  • LoadDescriptors(category) → reads npc-descriptors/*.json                  │
│  • Validates against config/schemas/npc-descriptors.schema.json              │
│  • Builds pool lookup by archetype, subtype, and type                        │
│  • Caches descriptors for performance                                        │
│  • Logs warnings for missing required fields                                 │
└─────────────────────────────────────────────────────────────────────────────┘
                                     │
                                     ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                            CONFIGURATION                                     │
│                                                                              │
│  config/schemas/npc-descriptors.schema.json                                  │
│  config/npc-descriptors/physical-descriptors.json                            │
│  config/npc-descriptors/ambient-barks.json                                   │
│  config/npc-descriptors/reaction-descriptors.json                            │
│                                                                              │
│  Related Systems:                                                            │
│  • NPC generation (character creation)                                       │
│  • Room population (NPC placement)                                           │
│  • Faction system (disposition tracking)                                     │
│  • Combat system (combat reactions)                                          │
│  • Biome system (environmental context)                                      │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 4. Schema Root Definition

### 4.1 Root Configuration Properties

The NPC descriptor schema defines a collection of descriptor pools organized by category.

| Property | Type | Required | Default | Description |
|----------|------|----------|---------|-------------|
| `$schema` | string | No | - | JSON Schema reference |
| `version` | string | **Yes** | - | Schema version (semver format) |
| `category` | string | **Yes** | - | Descriptor category (enum) |
| `pools` | object | **Yes** | - | Map of pool ID to descriptor array |

### 4.2 Category Types

| Category | Description | Descriptor Type |
|----------|-------------|-----------------|
| `npc-physical` | Physical appearance | NPCPhysicalDescriptor |
| `npc-barks` | Ambient dialogue | NPCAmbientBarkDescriptor |
| `npc-reactions` | Emotional responses | NPCReactionDescriptor |

### 4.3 Pool Structure

Pools are identified by a composite key pattern:

```
Pool ID Pattern: {archetype}_{subtype}_{descriptorType}
Example: "dvergr_tinkerer_fullbody"

Alternative Pattern: {archetype}_{subtype}_{barkType}
Example: "dvergr_tinkerer_atwork"

Reaction Pattern: {archetype}_{subtype}_{reactionType}
Example: "dvergr_tinkerer_impressed"
```

Each pool contains an array of descriptors with weighted random selection support.

---

## 5. NPCPhysicalDescriptor Definition

### 5.1 Core Properties

| Property | Type | Required | Default | Description |
|----------|------|----------|---------|-------------|
| `id` | string | **Yes** | - | Unique descriptor identifier |
| `text` | string | **Yes** | - | Descriptor text with {Variable} placeholders |
| `weight` | integer | No | 10 | Selection weight (higher = more likely) |
| `archetype` | string | **Yes** | - | NPC archetype (enum) |
| `subtype` | string | **Yes** | - | Archetype-specific subtype |
| `descriptorType` | string | **Yes** | - | Physical descriptor type (enum) |
| `condition` | string | No | null | NPC condition filter |
| `biome` | string | No | null | Biome-specific variant |
| `ageCategory` | string | No | null | Age category filter |
| `tags` | array | No | [] | Metadata tags for filtering |

### 5.2 Descriptor Types

| Type | Description | Example |
|------|-------------|---------|
| `FullBody` | Overall physical appearance | "A stocky Dvergr covered in soot..." |
| `Face` | Facial features and expression | "An elderly face whose eyes reflect light strangely..." |
| `Clothing` | Attire and garments | "Robes inscribed with protective runes..." |
| `Equipment` | Tools, weapons, gear | "Tools hanging from every belt loop..." |
| `Bearing` | Posture, demeanor, presence | "This scout moves with predatory grace..." |
| `Distinguishing` | Unique identifying traits | "A singed beard, evidence of explosive mishaps..." |

### 5.3 Age Categories

| Category | Description | Example Archetypes |
|----------|-------------|-------------------|
| `Young` | Youthful, inexperienced | YoungAcolyte, Rookie |
| `MiddleAged` | Prime of life | Most archetypes |
| `Elderly` | Advanced age, experienced | Elder, Veteran |
| `Ageless` | Supernatural, timeless | Forlorn, some Seidkona |

---

## 6. NPCAmbientBarkDescriptor Definition

### 6.1 Bark Properties

| Property | Type | Required | Default | Description |
|----------|------|----------|---------|-------------|
| `id` | string | **Yes** | - | Unique descriptor identifier |
| `text` | string | **Yes** | - | Bark dialogue text |
| `weight` | integer | No | 10 | Selection weight |
| `archetype` | string | **Yes** | - | NPC archetype (enum) |
| `subtype` | string | **Yes** | - | Archetype-specific subtype |
| `barkType` | string | **Yes** | - | Bark type (enum) |
| `activityContext` | string | No | null | Activity filter |
| `dispositionContext` | string | No | null | Disposition filter |
| `biome` | string | No | null | Biome-specific variant |
| `triggerCondition` | string | No | null | Trigger condition |
| `tags` | array | No | [] | Metadata tags |

### 6.2 Bark Types

| Type | Category | Description | Example |
|------|----------|-------------|---------|
| `AtWork` | Work | Performing task | "Tolerance specifications are off..." |
| `IdleConversation` | Social | Casual chat | "Remember when the forges ran hot?" |
| `Observation` | Alert | Noticing environment | "Did you hear that?" |
| `Warning` | Alert | Caution | "Stay back!" |
| `Greeting` | Social | Welcoming | "Well met, traveler." |
| `Celebration` | Mood | Joy | "Victory is ours!" |
| `Concern` | Alert | Worry | "Something's not right..." |
| `Suspicion` | Alert | Distrust | "I don't like the look of this..." |
| `Encouragement` | Social | Positive feedback | "I respect competence. You've got it." |
| `Complaint` | Mood | Dissatisfaction | "This rust is endless..." |
| `Teaching` | Social | Sharing knowledge | "The runes are not tools. They are living forces." |
| `Threat` | Combat | Intimidation | "Your gear or your life. Choose quick." |
| `Insult` | Combat | Mockery | "Amateur hour." |
| `Wounded` | Combat | Taking damage | "I'm not dying in this rust-heap!" |
| `Fleeing` | Combat | Retreat | "Not worth it! Fall back!" |
| `BattleCry` | Combat | Combat initiation | "For the Combine!" |

### 6.3 Activity Contexts

| Context | Description | Typical Barks |
|---------|-------------|---------------|
| `Working` | Performing job | AtWork, Teaching |
| `Idle` | Not actively engaged | IdleConversation, Observation |
| `Trading` | Commerce activity | Greeting, Suspicion |
| `Guarding` | Protective duty | Warning, Threat |
| `Crafting` | Creating items | AtWork, Encouragement |
| `Traveling` | Moving through area | Observation, Concern |
| `Fighting` | In combat | BattleCry, Threat, Wounded |
| `Resting` | Recuperating | IdleConversation, Complaint |
| `Searching` | Looking for something | Observation, Encouragement |
| `Performing_Ritual` | Magical ceremony | AtWork (mystical) |

### 6.4 Trigger Conditions

| Condition | Description | Typical Barks |
|-----------|-------------|---------------|
| `PlayerNearby` | Player in proximity | Greeting, Suspicion |
| `PlayerAbsent` | Player not visible | IdleConversation |
| `AllyPresent` | Friendly NPC nearby | IdleConversation, Encouragement |
| `EnemyNear` | Hostile detected | Warning, Threat |
| `DangerDetected` | Threat identified | Warning, Concern |
| `ResourceFound` | Valuable discovered | Celebration, Observation |
| `MechanismRepaired` | Machine fixed | Celebration, Encouragement |
| `RitualComplete` | Magic finished | Celebration (mystical) |

---

## 7. NPCReactionDescriptor Definition

### 7.1 Reaction Properties

| Property | Type | Required | Default | Description |
|----------|------|----------|---------|-------------|
| `id` | string | **Yes** | - | Unique descriptor identifier |
| `text` | string | **Yes** | - | Reaction dialogue/description |
| `weight` | integer | No | 10 | Selection weight |
| `archetype` | string | **Yes** | - | NPC archetype (enum) |
| `subtype` | string | **Yes** | - | Archetype-specific subtype |
| `reactionType` | string | **Yes** | - | Reaction type (enum) |
| `triggerEvent` | string | **Yes** | - | Event that triggered reaction |
| `intensity` | string | No | null | Reaction intensity |
| `priorDisposition` | string | No | null | Disposition before event |
| `actionTendency` | string | No | null | Likely follow-up action |
| `biome` | string | No | null | Biome-specific variant |
| `tags` | array | No | [] | Metadata tags |

### 7.2 Reaction Types

| Type | Category | Description | Example |
|------|----------|-------------|---------|
| `Surprised` | Neutral | Shock, unexpected | "Hmm? Need something?" |
| `Angry` | Negative | Rage, fury | "You'll pay for that!" |
| `Fearful` | Negative | Fear, terror | "Not worth it! Fall back!" |
| `Relieved` | Positive | Relief | "Thank the gods..." |
| `Suspicious` | Negative | Mistrust | "State your business." |
| `Joyful` | Positive | Happiness | "Excellent work!" |
| `Pained` | Neutral | Physical pain | "Bastard got me..." |
| `Confused` | Neutral | Bewilderment | "What just happened?" |
| `Impressed` | Positive | Admiration | "You have the look of someone who can actually fix things." |
| `Disgusted` | Negative | Disgust | "Sloppy. That kind of work gets people killed." |
| `Grateful` | Positive | Thankfulness | "Good work. Efficiency matters." |
| `Betrayed` | Negative | Betrayal | "I trusted you..." |
| `Proud` | Positive | Pride | "You understand the balance." |
| `Curious` | Positive | Interest | "The threads of fate brought you here. Curious." |
| `Resigned` | Neutral | Acceptance | "You win this round." |

### 7.3 Trigger Events

| Event | Category | Description |
|-------|----------|-------------|
| `PlayerApproaches` | Social | Player enters proximity |
| `PlayerAttacks` | Combat | Player initiates combat |
| `PlayerHelps` | Social | Player provides assistance |
| `PlayerGifts` | Social | Player gives item |
| `PlayerSteals` | Social | Player takes item |
| `AllyKilled` | Combat | Friendly NPC dies |
| `EnemyKilled` | Combat | Hostile NPC dies |
| `TakingDamage` | Combat | NPC receives damage |
| `VictoryAchieved` | Combat | Combat won |
| `TreasureFound` | Discovery | Valuable discovered |
| `SecretRevealed` | Discovery | Hidden info found |
| `MechanismRepaired` | Achievement | Machine fixed |
| `AncientKnowledgeFound` | Discovery | Lore discovered |
| `TrapTriggered` | Danger | Trap activated |
| `BlightEncounter` | Danger | Blight detected |
| `StructuralCollapse` | Danger | Building damage |
| `AmbushDetected` | Danger | Ambush discovered |
| `QuestCompleted` | Achievement | Quest finished |
| `BetrayalDetected` | Social | Treachery discovered |
| `GiftReceived` | Social | Item received |
| `TheftDetected` | Social | Theft discovered |
| `MagicWitnessed` | Discovery | Magic observed |
| `RuneActivated` | Discovery | Rune powered |
| `ProphecyFulfilled` | Discovery | Prediction realized |

### 7.4 Action Tendencies

| Tendency | Description | Typical Context |
|----------|-------------|-----------------|
| `Approach` | Move toward player | Friendly, Curious |
| `Flee` | Run away | Fearful, Overwhelmed |
| `Attack` | Engage in combat | Angry, Hostile |
| `Assist` | Help player | Grateful, Allied |
| `Ignore` | No action | Neutral, Uninvolved |
| `Report` | Tell others | Suspicious, Betrayed |
| `Investigate` | Examine | Curious, Surprised |
| `Guard` | Defensive stance | Suspicious, Protective |

---

## 8. NPC Archetype Reference

### 8.1 Archetype Enum

| Archetype | Description | Cultural Voice |
|-----------|-------------|----------------|
| `Dvergr` | Dwarven craftsmen/engineers | Technical, precise, obsessed with function |
| `Seidkona` | Norse magic practitioners | Mystical, archaic, speaking in metaphor |
| `Bandit` | Outlaws and thieves | Harsh, survivalist, desperate |
| `Raider` | Aggressive warriors | Aggressive, confrontational |
| `Merchant` | Traders and shopkeepers | Mercantile, shrewd, practical |
| `Guard` | Protectors and enforcers | Duty-bound, alert, authoritative |
| `Citizen` | Common folk | Varied, everyday concerns |
| `Forlorn` | Blight-corrupted NPCs | Broken, haunted, unstable |

### 8.2 Archetype Subtypes

| Archetype | Subtypes | Description |
|-----------|----------|-------------|
| `Dvergr` | `Tinkerer`, `Runecaster`, `Merchant` | Engineers, mages, traders |
| `Seidkona` | `WanderingSeidkona`, `YoungAcolyte`, `Seidmadr` | Mystics, students, male practitioners |
| `Bandit` | `Scout`, `Leader`, `DesperateOutcast` | Reconnaissance, command, desperate |
| `Raider` | `Veteran`, `Brute`, `Scavenger` | Experienced, muscle, looters |
| `Merchant` | `Prosperous`, `Struggling`, `Shrewd` | Wealthy, poor, cunning |
| `Guard` | `Veteran`, `Rookie`, `Captain` | Experienced, new, command |
| `Citizen` | `Laborer`, `Artisan`, `Elder` | Workers, craftspeople, seniors |
| `Forlorn` | `Fresh`, `Deteriorated`, `Ancient` | Recent, progressed, long-corrupted |

---

## 9. NPC Condition Reference

| Condition | Description | Visual Indicators |
|-----------|-------------|-------------------|
| `Healthy` | Normal state | Clean, alert, unblemished |
| `Wounded` | Injured | Bandages, blood, limping |
| `Exhausted` | Fatigued | Drooping, dark circles, slow |
| `Affluent` | Wealthy | Fine clothes, jewelry, clean |
| `Impoverished` | Poor | Rags, thin, dirty |
| `BattleReady` | Combat prepared | Armor donned, weapons drawn |

---

## 10. Disposition Reference

| Disposition | Relationship | Typical Behaviors |
|-------------|--------------|-------------------|
| `Hostile` | Enemies | Attack on sight, threats, insults |
| `Unfriendly` | Distrustful | Suspicion, warnings, reluctant help |
| `Neutral` | Unknown | Observation, cautious interaction |
| `Friendly` | Positive | Greetings, encouragement, assistance |
| `Allied` | Partners | Full cooperation, defense, teaching |

---

## 11. Variable Placeholders Reference

### NPC Variables

| Variable | Description | Example Value |
|----------|-------------|---------------|
| `{NPCName}` | NPC's name | "Volund" |
| `{NPCArchetype}` | Archetype name | "Dvergr" |
| `{NPCSubtype}` | Subtype name | "Tinkerer" |
| `{NPCTitle}` | Title if any | "Master Engineer" |

### Player Variables

| Variable | Description | Example Value |
|----------|-------------|---------------|
| `{PlayerName}` | Player character name | "Bjorn Ironwill" |
| `{PlayerClass}` | Player class | "Runecaster" |
| `{PlayerFaction}` | Player faction | "Forge Combine" |

### Context Variables

| Variable | Description | Example Value |
|----------|-------------|---------------|
| `{Biome}` | Current biome | "The Roots" |
| `{LocationName}` | Room/area name | "Abandoned Workshop" |
| `{TimeOfDay}` | Time period | "Dusk" |
| `{Weather}` | Weather condition | "Rust-storm" |

### Activity Variables

| Variable | Description | Example Value |
|----------|-------------|---------------|
| `{Activity}` | Current activity | "repairing" |
| `{Tool}` | Tool being used | "wrench" |
| `{Resource}` | Resource involved | "copper wire" |
| `{ItemName}` | Item referenced | "Rusted Gear" |

### Physical Variables

| Variable | Description | Example Value |
|----------|-------------|---------------|
| `{Height}` | NPC height | "short" |
| `{Build}` | Body type | "stocky" |
| `{HairColor}` | Hair color | "gray" |
| `{EyeColor}` | Eye color | "amber" |
| `{Weapon}` | Equipped weapon | "iron hammer" |
| `{Armor}` | Equipped armor | "leather apron" |
| `{Wounds}` | Visible injuries | "a fresh cut on the arm" |
| `{Scars}` | Old injuries | "burn marks on the hands" |
| `{Accessory}` | Notable accessory | "runic amulet" |
| `{Weathering}` | Environmental wear | "rust-stained" |

### Reaction Variables

| Variable | Description | Example Value |
|----------|-------------|---------------|
| `{Disposition}` | Current disposition | "Friendly" |
| `{Condition}` | Current condition | "Wounded" |
| `{PlayerAction}` | Triggering action | "helped repair" |
| `{TriggerEvent}` | Event description | "the mechanism repair" |
| `{AllyName}` | Affected ally name | "Gunnar" |
| `{ReactionType}` | Reaction category | "Impressed" |
| `{Intensity}` | Reaction strength | "Moderate" |

---

## 12. Configuration Schema

### Complete `npc-descriptors.schema.json`

```json
{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "https://rune-game.com/schemas/npc-descriptors.schema.json",
  "title": "NPC Descriptor Configuration",
  "description": "Schema for NPC flavor text descriptors",
  "type": "object",
  "properties": {
    "$schema": {
      "type": "string",
      "description": "JSON Schema reference"
    },
    "version": {
      "type": "string",
      "description": "Schema version (semver format)",
      "pattern": "^\\d+\\.\\d+\\.\\d+$"
    },
    "category": {
      "type": "string",
      "description": "Descriptor category",
      "enum": [
        "npc-physical",
        "npc-barks",
        "npc-reactions"
      ]
    },
    "pools": {
      "type": "object",
      "description": "Map of pool ID to descriptor array",
      "additionalProperties": {
        "type": "array",
        "items": {
          "oneOf": [
            { "$ref": "#/definitions/NPCPhysicalDescriptor" },
            { "$ref": "#/definitions/NPCAmbientBarkDescriptor" },
            { "$ref": "#/definitions/NPCReactionDescriptor" }
          ]
        },
        "minItems": 1
      },
      "propertyNames": {
        "pattern": "^[a-z][a-z0-9_]*$"
      }
    }
  },
  "required": ["version", "category", "pools"],
  "additionalProperties": false,
  "definitions": {
    "NPCPhysicalDescriptor": {
      "type": "object",
      "description": "NPC physical appearance descriptor",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique descriptor identifier",
          "pattern": "^[a-z][a-z0-9_-]*$"
        },
        "text": {
          "type": "string",
          "description": "Descriptor text with {Variable} placeholders",
          "minLength": 1
        },
        "weight": {
          "type": "integer",
          "description": "Selection weight (higher = more likely)",
          "minimum": 1,
          "default": 10
        },
        "archetype": {
          "$ref": "#/definitions/NPCArchetype",
          "description": "NPC archetype"
        },
        "subtype": {
          "type": "string",
          "description": "Archetype-specific subtype",
          "minLength": 1
        },
        "descriptorType": {
          "type": "string",
          "description": "Physical descriptor type",
          "enum": [
            "FullBody",
            "Face",
            "Clothing",
            "Equipment",
            "Bearing",
            "Distinguishing"
          ]
        },
        "condition": {
          "oneOf": [
            { "$ref": "#/definitions/NPCCondition" },
            { "type": "null" }
          ],
          "description": "NPC condition filter"
        },
        "biome": {
          "type": ["string", "null"],
          "description": "Biome-specific variant"
        },
        "ageCategory": {
          "type": ["string", "null"],
          "description": "Age category filter",
          "enum": ["Young", "MiddleAged", "Elderly", "Ageless", null]
        },
        "tags": {
          "type": "array",
          "description": "Metadata tags for filtering",
          "items": { "type": "string" },
          "default": []
        }
      },
      "required": ["id", "text", "archetype", "subtype", "descriptorType"],
      "additionalProperties": false
    },
    "NPCAmbientBarkDescriptor": {
      "type": "object",
      "description": "NPC ambient dialogue bark descriptor",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique descriptor identifier",
          "pattern": "^[a-z][a-z0-9_-]*$"
        },
        "text": {
          "type": "string",
          "description": "Bark dialogue text",
          "minLength": 1
        },
        "weight": {
          "type": "integer",
          "description": "Selection weight",
          "minimum": 1,
          "default": 10
        },
        "archetype": {
          "$ref": "#/definitions/NPCArchetype",
          "description": "NPC archetype"
        },
        "subtype": {
          "type": "string",
          "description": "Archetype-specific subtype",
          "minLength": 1
        },
        "barkType": {
          "$ref": "#/definitions/BarkType",
          "description": "Bark type"
        },
        "activityContext": {
          "type": ["string", "null"],
          "description": "Activity filter",
          "enum": [
            "Working", "Idle", "Trading", "Guarding", "Crafting",
            "Traveling", "Fighting", "Resting", "Searching",
            "Performing_Ritual", null
          ]
        },
        "dispositionContext": {
          "oneOf": [
            { "$ref": "#/definitions/Disposition" },
            { "type": "null" }
          ],
          "description": "Disposition filter"
        },
        "biome": {
          "type": ["string", "null"],
          "description": "Biome-specific variant"
        },
        "triggerCondition": {
          "type": ["string", "null"],
          "description": "Trigger condition",
          "enum": [
            "PlayerNearby", "PlayerAbsent", "AllyPresent", "EnemyNear",
            "DangerDetected", "ResourceFound", "MechanismRepaired",
            "RitualComplete", null
          ]
        },
        "tags": {
          "type": "array",
          "items": { "type": "string" },
          "default": []
        }
      },
      "required": ["id", "text", "archetype", "subtype", "barkType"],
      "additionalProperties": false
    },
    "NPCReactionDescriptor": {
      "type": "object",
      "description": "NPC emotional reaction descriptor",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique descriptor identifier",
          "pattern": "^[a-z][a-z0-9_-]*$"
        },
        "text": {
          "type": "string",
          "description": "Reaction dialogue/description",
          "minLength": 1
        },
        "weight": {
          "type": "integer",
          "description": "Selection weight",
          "minimum": 1,
          "default": 10
        },
        "archetype": {
          "$ref": "#/definitions/NPCArchetype",
          "description": "NPC archetype"
        },
        "subtype": {
          "type": "string",
          "description": "Archetype-specific subtype",
          "minLength": 1
        },
        "reactionType": {
          "$ref": "#/definitions/ReactionType",
          "description": "Reaction type"
        },
        "triggerEvent": {
          "$ref": "#/definitions/TriggerEvent",
          "description": "Event that triggered reaction"
        },
        "intensity": {
          "type": ["string", "null"],
          "description": "Reaction intensity",
          "enum": ["Mild", "Moderate", "Strong", "Extreme", null]
        },
        "priorDisposition": {
          "oneOf": [
            { "$ref": "#/definitions/Disposition" },
            { "type": "null" }
          ],
          "description": "Disposition before event"
        },
        "actionTendency": {
          "type": ["string", "null"],
          "description": "Likely follow-up action",
          "enum": [
            "Approach", "Flee", "Attack", "Assist",
            "Ignore", "Report", "Investigate", "Guard", null
          ]
        },
        "biome": {
          "type": ["string", "null"],
          "description": "Biome-specific variant"
        },
        "tags": {
          "type": "array",
          "items": { "type": "string" },
          "default": []
        }
      },
      "required": ["id", "text", "archetype", "subtype", "reactionType", "triggerEvent"],
      "additionalProperties": false
    },
    "NPCArchetype": {
      "type": "string",
      "description": "NPC archetype classification",
      "enum": [
        "Dvergr",
        "Seidkona",
        "Bandit",
        "Raider",
        "Merchant",
        "Guard",
        "Citizen",
        "Forlorn"
      ]
    },
    "NPCCondition": {
      "type": "string",
      "description": "NPC physical/mental condition",
      "enum": [
        "Healthy",
        "Wounded",
        "Exhausted",
        "Affluent",
        "Impoverished",
        "BattleReady"
      ]
    },
    "Disposition": {
      "type": "string",
      "description": "NPC disposition toward player",
      "enum": [
        "Hostile",
        "Unfriendly",
        "Neutral",
        "Friendly",
        "Allied"
      ]
    },
    "BarkType": {
      "type": "string",
      "description": "Ambient bark type",
      "enum": [
        "AtWork",
        "IdleConversation",
        "Observation",
        "Warning",
        "Celebration",
        "Concern",
        "Suspicion",
        "Encouragement",
        "Complaint",
        "Teaching",
        "Threat",
        "Insult",
        "Wounded",
        "Fleeing",
        "BattleCry",
        "Greeting"
      ]
    },
    "ReactionType": {
      "type": "string",
      "description": "Emotional reaction type",
      "enum": [
        "Surprised",
        "Angry",
        "Fearful",
        "Relieved",
        "Suspicious",
        "Joyful",
        "Pained",
        "Confused",
        "Impressed",
        "Disgusted",
        "Grateful",
        "Betrayed",
        "Proud",
        "Curious",
        "Resigned"
      ]
    },
    "TriggerEvent": {
      "type": "string",
      "description": "Event that triggers reaction",
      "enum": [
        "PlayerApproaches",
        "PlayerAttacks",
        "PlayerHelps",
        "PlayerGifts",
        "PlayerSteals",
        "AllyKilled",
        "EnemyKilled",
        "TakingDamage",
        "VictoryAchieved",
        "TreasureFound",
        "SecretRevealed",
        "MechanismRepaired",
        "AncientKnowledgeFound",
        "TrapTriggered",
        "BlightEncounter",
        "StructuralCollapse",
        "AmbushDetected",
        "QuestCompleted",
        "BetrayalDetected",
        "GiftReceived",
        "TheftDetected",
        "MagicWitnessed",
        "RuneActivated",
        "ProphecyFulfilled"
      ]
    }
  }
}
```

---

## 13. Logging Specifications

### Schema Validation Logging

| Event | Level | Message Format |
|-------|-------|----------------|
| Schema loaded | INFO | `NPC descriptor schema loaded from {path}` |
| Validation success | DEBUG | `NPC descriptors validated ({poolCount} pools, {descriptorCount} descriptors)` |
| Validation failure | ERROR | `NPC descriptor validation failed: {errors}` |
| Invalid archetype | ERROR | `Archetype '{archetype}' not in valid enum` |
| Invalid bark type | ERROR | `BarkType '{type}' not in valid enum` |
| Invalid reaction type | ERROR | `ReactionType '{type}' not in valid enum` |
| Invalid disposition | ERROR | `Disposition '{disposition}' not in valid enum` |
| Missing required | ERROR | `Descriptor missing required field: {field}` |
| Empty pool | WARN | `Pool '{poolId}' contains no descriptors` |

### Runtime Logging

| Event | Level | Message Format |
|-------|-------|----------------|
| Pool loaded | DEBUG | `Loaded pool '{poolId}' ({count} descriptors)` |
| Descriptor selected | DEBUG | `Selected descriptor '{id}' from pool '{poolId}'` |
| Variable substitution | TRACE | `Substituted {count} variables in descriptor '{id}'` |
| Missing pool | WARN | `Pool '{poolId}' not found, using fallback` |
| No matching descriptor | WARN | `No descriptor matches filters: {filters}` |

---

## 14. Unit Testing Requirements

### Test Summary

| Test ID | Test Name | Description |
|---------|-----------|-------------|
| NPC-001 | ValidNPCDescriptorConfiguration | Validates complete configuration file |
| NPC-002 | NPCPhysicalDescriptorValidation | Validates physical descriptor structure |
| NPC-003 | NPCAmbientBarkValidation | Validates ambient bark structure |
| NPC-004 | NPCReactionDescriptorValidation | Validates reaction descriptor structure |
| NPC-005 | NPCArchetypeEnumValidation | Validates all 8 archetypes |
| NPC-006 | DispositionEnumValidation | Validates disposition enums |

### Test Specifications

#### NPC-001: ValidNPCDescriptorConfiguration

```
Test: Valid complete NPC descriptor configuration passes validation
Given: An NPC descriptor JSON file with multiple pools and descriptors
When: Schema validation is performed
Then: Validation passes with no errors
And: All pools contain at least one descriptor
And: Archetypes are valid enum values
And: Descriptor types are valid enum values
```

#### NPC-002: NPCPhysicalDescriptorValidation

```
Test: NPC physical descriptor structure validates correctly
Given: Physical descriptors with various configurations
When: Schema validation is performed:
  - { "id": "test", "text": "A stocky...", "archetype": "Dvergr", "subtype": "Tinkerer", "descriptorType": "FullBody" } → passes (minimal)
  - { "id": "test", "text": "...", "archetype": "Dvergr", "subtype": "Tinkerer", "descriptorType": "FullBody", "condition": "Healthy" } → passes
  - { "text": "...", "archetype": "Dvergr", "subtype": "Tinkerer", "descriptorType": "FullBody" } → fails (missing id)
  - { "id": "test", "archetype": "Dvergr", "subtype": "Tinkerer", "descriptorType": "FullBody" } → fails (missing text)
  - { "id": "test", "text": "...", "archetype": "Invalid", "subtype": "Tinkerer", "descriptorType": "FullBody" } → fails (invalid archetype)
  - { "id": "test", "text": "...", "archetype": "Dvergr", "subtype": "Tinkerer", "descriptorType": "Invalid" } → fails (invalid descriptorType)
Then: Required fields enforced, enums validated
```

#### NPC-003: NPCAmbientBarkValidation

```
Test: NPC ambient bark descriptor validates bark types
Given: Bark descriptors with various configurations
When: Schema validation is performed:
  - { "id": "test", "text": "...", "archetype": "Dvergr", "subtype": "Tinkerer", "barkType": "AtWork" } → passes
  - { "id": "test", "text": "...", "archetype": "Seidkona", "subtype": "WanderingSeidkona", "barkType": "Teaching" } → passes
  - { "id": "test", "text": "...", "archetype": "Dvergr", "subtype": "Tinkerer", "barkType": "Invalid" } → fails
  - { "id": "test", "text": "...", "archetype": "Dvergr", "subtype": "Tinkerer" } → fails (missing barkType)
Then: Bark types validated against enum
```

#### NPC-004: NPCReactionDescriptorValidation

```
Test: NPC reaction descriptor validates reaction types and triggers
Given: Reaction descriptors with various configurations
When: Schema validation is performed:
  - { "id": "test", "text": "...", "archetype": "Dvergr", "subtype": "Tinkerer", "reactionType": "Impressed", "triggerEvent": "MechanismRepaired" } → passes
  - { "id": "test", "text": "...", "archetype": "Bandit", "subtype": "Scout", "reactionType": "Fearful", "triggerEvent": "AllyKilled", "intensity": "Strong", "actionTendency": "Flee" } → passes
  - { "id": "test", "text": "...", "archetype": "Dvergr", "subtype": "Tinkerer", "reactionType": "Invalid", "triggerEvent": "MechanismRepaired" } → fails
  - { "id": "test", "text": "...", "archetype": "Dvergr", "subtype": "Tinkerer", "reactionType": "Impressed", "triggerEvent": "Invalid" } → fails
  - { "id": "test", "text": "...", "archetype": "Dvergr", "subtype": "Tinkerer", "reactionType": "Impressed" } → fails (missing triggerEvent)
Then: Reaction types and trigger events validated against enums
```

#### NPC-005: NPCArchetypeEnumValidation

```
Test: All 8 NPC archetypes validate correctly
Given: Descriptors with each archetype
When: Schema validation is performed:
  - archetype: "Dvergr" → passes
  - archetype: "Seidkona" → passes
  - archetype: "Bandit" → passes
  - archetype: "Raider" → passes
  - archetype: "Merchant" → passes
  - archetype: "Guard" → passes
  - archetype: "Citizen" → passes
  - archetype: "Forlorn" → passes
  - archetype: "InvalidArchetype" → fails
  - archetype: "dvergr" → fails (lowercase)
Then: Only valid PascalCase archetype names accepted
```

#### NPC-006: DispositionEnumValidation

```
Test: Dispositions validate correctly
Given: Descriptors with various dispositions
When: Schema validation is performed:
  - dispositionContext: "Hostile" → passes
  - dispositionContext: "Unfriendly" → passes
  - dispositionContext: "Neutral" → passes
  - dispositionContext: "Friendly" → passes
  - dispositionContext: "Allied" → passes
  - dispositionContext: null → passes (optional)
  - dispositionContext: "hostile" → fails (lowercase)
  - dispositionContext: "Invalid" → fails
Then: Only valid disposition enum values accepted
```

---

## 15. Use Cases

### UC-001: Load NPC Physical Descriptors

```
┌─────────────────────────────────────────────────────────────────────────────┐
│ UC-001: Load NPC Physical Descriptors                                        │
├─────────────────────────────────────────────────────────────────────────────┤
│ Actors: Game System                                                          │
│ Trigger: Game initialization                                                 │
│ Preconditions: Descriptor files exist                                        │
├─────────────────────────────────────────────────────────────────────────────┤
│ Flow:                                                                        │
│ 1. System loads npc-descriptors.schema.json                                  │
│ 2. System reads physical-descriptors.json                                    │
│ 3. Validate configuration against schema                                     │
│ 4. Build pool lookup by archetype, subtype, type                             │
│ 5. Cache descriptors for performance                                         │
│ 6. Log pool statistics                                                       │
├─────────────────────────────────────────────────────────────────────────────┤
│ Postconditions: Descriptors loaded and cached                                │
│ Exceptions: Invalid JSON → log error, use fallback text                      │
└─────────────────────────────────────────────────────────────────────────────┘
```

### UC-002: Generate NPC Appearance Description

```
┌─────────────────────────────────────────────────────────────────────────────┐
│ UC-002: Generate NPC Appearance Description                                  │
├─────────────────────────────────────────────────────────────────────────────┤
│ Actors: Room Population Service                                              │
│ Trigger: NPC spawns in room                                                  │
│ Preconditions: Physical descriptors loaded                                   │
├─────────────────────────────────────────────────────────────────────────────┤
│ Flow:                                                                        │
│ 1. Determine NPC archetype and subtype (e.g., "Dvergr", "Tinkerer")          │
│ 2. Determine NPC condition (e.g., "Healthy")                                 │
│ 3. Determine age category if applicable                                      │
│ 4. Build pool ID: "dvergr_tinkerer_fullbody"                                 │
│ 5. Retrieve pool from cache                                                  │
│ 6. Filter by condition if applicable                                         │
│ 7. Select descriptor by weighted random                                      │
│ 8. Optionally combine multiple descriptor types                              │
│ 9. Substitute variables ({NPCName}, {Tool}, etc.)                            │
│ 10. Return formatted description                                             │
├─────────────────────────────────────────────────────────────────────────────┤
│ Postconditions: NPC has generated appearance description                     │
│ Exceptions: Pool not found → use generic pool or fallback text               │
└─────────────────────────────────────────────────────────────────────────────┘
```

### UC-003: Select Ambient Bark

```
┌─────────────────────────────────────────────────────────────────────────────┐
│ UC-003: Select Ambient Bark                                                  │
├─────────────────────────────────────────────────────────────────────────────┤
│ Actors: NPC Behavior System                                                  │
│ Trigger: Idle tick or trigger condition met                                  │
│ Preconditions: Bark descriptors loaded                                       │
├─────────────────────────────────────────────────────────────────────────────┤
│ Flow:                                                                        │
│ 1. Determine NPC archetype and subtype                                       │
│ 2. Determine current activity context (Working, Idle, etc.)                  │
│ 3. Determine current disposition toward player                               │
│ 4. Check for trigger conditions (PlayerNearby, etc.)                         │
│ 5. Select appropriate bark type                                              │
│ 6. Build pool ID: "dvergr_tinkerer_atwork"                                   │
│ 7. Retrieve pool from cache                                                  │
│ 8. Filter by activity and disposition                                        │
│ 9. Select bark by weighted random                                            │
│ 10. Substitute variables                                                     │
│ 11. Display bark in dialogue area                                            │
├─────────────────────────────────────────────────────────────────────────────┤
│ Postconditions: Bark displayed to player                                     │
│ Exceptions: No matching bark → skip or use generic                           │
└─────────────────────────────────────────────────────────────────────────────┘
```

### UC-004: Select Reaction Descriptor

```
┌─────────────────────────────────────────────────────────────────────────────┐
│ UC-004: Select Reaction Descriptor                                           │
├─────────────────────────────────────────────────────────────────────────────┤
│ Actors: Event System                                                         │
│ Trigger: Player action or game event                                         │
│ Preconditions: Reaction descriptors loaded                                   │
├─────────────────────────────────────────────────────────────────────────────┤
│ Flow:                                                                        │
│ 1. Identify trigger event (e.g., "PlayerHelps", "MechanismRepaired")         │
│ 2. Determine NPC archetype and subtype                                       │
│ 3. Determine prior disposition                                               │
│ 4. Determine appropriate reaction type (e.g., "Impressed")                   │
│ 5. Determine intensity based on event significance                           │
│ 6. Build pool ID: "dvergr_tinkerer_impressed"                                │
│ 7. Retrieve pool from cache                                                  │
│ 8. Filter by trigger event and disposition                                   │
│ 9. Select reaction by weighted random                                        │
│ 10. Extract action tendency if present                                       │
│ 11. Substitute variables                                                     │
│ 12. Display reaction and execute action tendency                             │
├─────────────────────────────────────────────────────────────────────────────┤
│ Postconditions: NPC reacts to event appropriately                            │
│ Exceptions: No matching reaction → use generic or skip                       │
└─────────────────────────────────────────────────────────────────────────────┘
```

### UC-005: Filter Descriptors by Biome

```
┌─────────────────────────────────────────────────────────────────────────────┐
│ UC-005: Filter Descriptors by Biome                                          │
├─────────────────────────────────────────────────────────────────────────────┤
│ Actors: NPC Descriptor Service                                               │
│ Trigger: Descriptor selection request                                        │
│ Preconditions: Descriptors loaded, biome context available                   │
├─────────────────────────────────────────────────────────────────────────────┤
│ Flow:                                                                        │
│ 1. Receive descriptor selection request with biome context                   │
│ 2. Retrieve pool for archetype/subtype/type                                  │
│ 3. Filter descriptors where biome matches or biome is null                   │
│ 4. Prefer biome-specific descriptors if available                            │
│ 5. Fall back to generic (null biome) if no match                             │
│ 6. Select from filtered set by weighted random                               │
│ 7. Return selected descriptor                                                │
├─────────────────────────────────────────────────────────────────────────────┤
│ Postconditions: Biome-appropriate descriptor selected                        │
│ Exceptions: No biome-specific → use generic descriptors                      │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 16. Deliverable Checklist

### Configuration Files

| Status | File | Description |
|--------|------|-------------|
| ☐ | `config/schemas/npc-descriptors.schema.json` | JSON Schema for validation |
| ☐ | `config/npc-descriptors/physical-descriptors.json` | Example physical descriptors |
| ☐ | `config/npc-descriptors/ambient-barks.json` | Example ambient barks |
| ☐ | `config/npc-descriptors/reaction-descriptors.json` | Example reaction descriptors |

### Unit Tests

| Status | Test | Description |
|--------|------|-------------|
| ☐ | NPC-001 | Valid complete configuration |
| ☐ | NPC-002 | Physical descriptor validation |
| ☐ | NPC-003 | Ambient bark validation |
| ☐ | NPC-004 | Reaction descriptor validation |
| ☐ | NPC-005 | Archetype enum validation |
| ☐ | NPC-006 | Disposition enum validation |

### Documentation

| Status | Document | Description |
|--------|----------|-------------|
| ☑ | Design Specification | This document |
| ☐ | Schema Documentation | Inline in schema file |
| ☐ | Variable Placeholder Guide | Developer reference |

---

## 17. Acceptance Criteria

### Functional Criteria

- [ ] `npc-descriptors.schema.json` created in `config/schemas/`
- [ ] Schema validates all 8 NPC archetypes
- [ ] Descriptor types validated (6 types)
- [ ] Bark types validated (16 types)
- [ ] Reaction types validated (15 types)
- [ ] Trigger events validated (24 events)
- [ ] Conditions validated (6 conditions)
- [ ] Dispositions validated (5 dispositions)
- [ ] Pool ID pattern validated (snake_case)
- [ ] Descriptor ID pattern validated
- [ ] Variable placeholders documented
- [ ] ~6 unit tests pass

### Quality Criteria

- [ ] Schema follows JSON Schema Draft-07 specification
- [ ] All properties include descriptive comments
- [ ] Default values documented for optional fields
- [ ] Pattern constraints clearly specified
- [ ] Enum values match existing SQL content

### Integration Criteria

- [ ] Schema follows patterns from v0.14.9b (ability descriptor schema)
- [ ] Compatible with existing SQL schema structure
- [ ] Pool IDs use snake_case
- [ ] Property names use camelCase within descriptors
- [ ] Archetype names use PascalCase (Dvergr, not dvergr)

---

## 18. Dependencies

### Required From

| Version | Dependency | Usage |
|---------|------------|-------|
| v0.14.8 | Dice Configuration Schemas | Schema infrastructure patterns |
| v0.14.9a | Dialogue Schema | Schema pattern reference |
| v0.14.9b | Ability Descriptor Schema | Schema pattern reference |
| Existing | `npc_descriptors_barks_schema.sql` | Source structure |
| Existing | `npc_descriptors_barks_data.sql` | Source content |

### Provides To

| Version | Consumer | Usage |
|---------|----------|-------|
| v0.14.9d | Psychological Descriptor Schema | Schema pattern reference |
| Future | NPCDescriptorService | Descriptor loading and selection |
| Future | RoomPopulationService | NPC appearance generation |
| Future | NPCBehaviorSystem | Ambient bark selection |
| Future | EventSystem | Reaction descriptor selection |

---

## 19. Future Considerations

### Deferred to Later Versions

| Feature | Rationale |
|---------|-----------|
| Psychological descriptor schema | v0.14.9d scope |
| Capture template schema | v0.14.9e scope |
| Descriptor execution logic | Runtime concern |
| Audio cue integration | Future audio version |
| Localization support | Future i18n version |

### Potential Enhancements

| Enhancement | Description |
|-------------|-------------|
| Relationship tracking | Descriptors change based on relationship history |
| Memory system | NPCs remember player actions and adjust barks |
| Mood system | NPC mood affects bark selection |
| Group dynamics | Barks change when multiple NPCs present |
| Quest integration | Special descriptors for quest-related NPCs |
| Seasonal variants | Descriptors change with in-game seasons |
| Corruption tracking | Forlorn descriptors progress with corruption |
| Injury details | Wounded descriptors specify injury location |

---

## 20. Appendix: Schema Validation Examples

### Valid NPC Physical Descriptor (Minimal)

```json
{
  "id": "dvergr_tinkerer_fullbody_001",
  "text": "A stocky Dvergr covered in soot and machine oil.",
  "archetype": "Dvergr",
  "subtype": "Tinkerer",
  "descriptorType": "FullBody"
}
```

### Valid NPC Physical Descriptor (Complete)

```json
{
  "id": "dvergr_tinkerer_fullbody_001",
  "text": "A stocky Dvergr covered in soot and machine oil, tools hanging from every belt loop.",
  "weight": 10,
  "archetype": "Dvergr",
  "subtype": "Tinkerer",
  "descriptorType": "FullBody",
  "condition": "Healthy",
  "biome": null,
  "ageCategory": null,
  "tags": ["Memorable", "Technical"]
}
```

### Valid NPC Ambient Bark Descriptor

```json
{
  "id": "dvergr_tinkerer_atwork_001",
  "text": "Tolerance specifications are off by point-oh-three millimeters. Unacceptable.",
  "weight": 10,
  "archetype": "Dvergr",
  "subtype": "Tinkerer",
  "barkType": "AtWork",
  "activityContext": "Working",
  "dispositionContext": null,
  "biome": null,
  "triggerCondition": null,
  "tags": ["Dvergr_Technical"]
}
```

### Valid NPC Reaction Descriptor

```json
{
  "id": "dvergr_tinkerer_impressed_001",
  "text": "You have the look of someone who can actually fix things. Rare, these days.",
  "weight": 10,
  "archetype": "Dvergr",
  "subtype": "Tinkerer",
  "reactionType": "Impressed",
  "triggerEvent": "MechanismRepaired",
  "intensity": "Moderate",
  "priorDisposition": "Neutral",
  "actionTendency": "Assist",
  "biome": null,
  "tags": ["Social", "Positive"]
}
```

### Valid Configuration File

```json
{
  "$schema": "../../config/schemas/npc-descriptors.schema.json",
  "version": "1.0.0",
  "category": "npc-physical",
  "pools": {
    "dvergr_tinkerer_fullbody": [
      {
        "id": "dvergr_tinkerer_fullbody_001",
        "text": "A stocky Dvergr covered in soot and machine oil, tools hanging from every belt loop.",
        "weight": 10,
        "archetype": "Dvergr",
        "subtype": "Tinkerer",
        "descriptorType": "FullBody",
        "condition": "Healthy",
        "tags": ["Memorable", "Technical"]
      },
      {
        "id": "dvergr_tinkerer_fullbody_002",
        "text": "A short, broad-shouldered craftsman with thick goggles pushed up on their forehead.",
        "weight": 10,
        "archetype": "Dvergr",
        "subtype": "Tinkerer",
        "descriptorType": "FullBody",
        "condition": "Healthy",
        "tags": ["Professional", "Distinctive"]
      }
    ],
    "dvergr_tinkerer_distinguishing": [
      {
        "id": "dvergr_tinkerer_distinguishing_001",
        "text": "This Dvergr's hands are stained black from decades of working with corroded metal.",
        "weight": 10,
        "archetype": "Dvergr",
        "subtype": "Tinkerer",
        "descriptorType": "Distinguishing",
        "tags": ["Memorable"]
      }
    ],
    "seidkona_wandering_fullbody": [
      {
        "id": "seidkona_wandering_fullbody_001",
        "text": "A weathered woman in traveling furs, a staff carved with runes in one hand.",
        "weight": 10,
        "archetype": "Seidkona",
        "subtype": "WanderingSeidkona",
        "descriptorType": "FullBody",
        "condition": "Healthy",
        "tags": ["Mystical", "Memorable"]
      }
    ]
  }
}
```

### Invalid Examples

```json
// Invalid: Missing required 'archetype'
{
  "id": "test_001",
  "text": "A stocky figure...",
  "subtype": "Tinkerer",
  "descriptorType": "FullBody"
}
// Error: Missing required property 'archetype'

// Invalid: Invalid archetype
{
  "id": "test_001",
  "text": "...",
  "archetype": "InvalidArchetype",
  "subtype": "Tinkerer",
  "descriptorType": "FullBody"
}
// Error: 'archetype' must be one of the valid archetypes

// Invalid: Invalid bark type
{
  "id": "test_001",
  "text": "...",
  "archetype": "Dvergr",
  "subtype": "Tinkerer",
  "barkType": "InvalidType"
}
// Error: 'barkType' must be one of: AtWork, IdleConversation, etc.

// Invalid: Missing trigger event in reaction
{
  "id": "test_001",
  "text": "...",
  "archetype": "Dvergr",
  "subtype": "Tinkerer",
  "reactionType": "Impressed"
}
// Error: Missing required property 'triggerEvent'

// Invalid: Invalid disposition
{
  "id": "test_001",
  "text": "...",
  "archetype": "Dvergr",
  "subtype": "Tinkerer",
  "barkType": "AtWork",
  "dispositionContext": "VeryFriendly"
}
// Error: 'dispositionContext' must be one of: Hostile, Unfriendly, Neutral, Friendly, Allied

// Invalid: Pool ID with uppercase
{
  "pools": {
    "Dvergr_Tinkerer_FullBody": [...]
  }
}
// Error: Pool ID must match pattern ^[a-z][a-z0-9_]*$

// Invalid: Empty pool
{
  "pools": {
    "dvergr_tinkerer_fullbody": []
  }
}
// Error: Pool must contain at least 1 descriptor
```

---

*End of v0.14.9c Design Specification*
