# v0.38.7: Galdr Flavor Text - Integration Guide

**Date:** 2025-11-17
**Status:** ‚úÖ INTEGRATED
**Dependencies:** v0.38.6 (Combat Flavor Text), v0.23 (Ability System), v0.19.8 (Magic Service)

---

## üîó Integration Complete

The Galdr flavor text system is now **fully integrated** with the existing game systems. This guide explains what was integrated and how to use it.

---

## üìã Integration Summary

### What Was Integrated

1. **‚úÖ Ability Class Extended** (`RuneAndRust.Core/Ability.cs`)
   - Added `RuneSchool` property (Fehu, Thurisaz, Ansuz, etc.)
   - Added `AbilityCategory` property (WeaponArt, TacticalAbility, etc.)
   - Added `Element` property (Fire, Ice, Lightning, etc.)
   - Added `IsGaldr` property (computed from RuneSchool)

2. **‚úÖ CombatEngine Extended** (`RuneAndRust.Engine/`)
   - Made partial class to support extensions
   - Added `GaldrFlavorTextService` field and constructor parameter
   - Created `CombatEngine_GaldrFlavorExtensions.cs` with flavor text methods
   - Follows same pattern as existing `CombatFlavorTextService`

3. **‚úÖ AbilityDatabase Extended** (`RuneAndRust.Engine/AbilityDatabase_GaldrExtensions.cs`)
   - Created extension methods for configuring abilities
   - Helper methods for creating Galdr vs non-Galdr abilities
   - Example Mystic abilities (FlameBolt, FrostLance, etc.)

---

## üöÄ Quick Start

### 1. Initialize Services

When creating `CombatEngine`, pass in `GaldrFlavorTextService`:

```csharp
// In your game initialization
var repository = new DescriptorRepository(connectionString);
var galdrService = new GaldrFlavorTextService(repository);
var combatFlavorService = new CombatFlavorTextService(repository);

var combatEngine = new CombatEngine(
    diceService,
    sagaService,
    lootService,
    equipmentService,
    hazardService,
    currencyService,
    statusEffectService,
    counterAttackService,
    connectionString,
    territoryService,
    combatFlavorService,        // v0.38.6
    galdrService                // v0.38.7 - NEW
);
```

### 2. Configure Existing Abilities

Call `ConfigureGaldrProperties()` on your `AbilityDatabase`:

```csharp
var abilityDatabase = new AbilityDatabase();
abilityDatabase.ConfigureGaldrProperties(); // Configures all existing abilities
```

This sets up:
- **Warrior abilities** ‚Üí `AbilityCategory` (WeaponArt, TacticalAbility, etc.)
- **Mystic abilities** ‚Üí `RuneSchool` + `Element` (when you add them)

### 3. Create Mystic Abilities

Use the helper methods to create Galdr abilities:

```csharp
// Example: Adding Flame Bolt to AbilityDatabase
private Ability CreateFlameBolt()
{
    return AbilityDatabaseGaldrExtensions.CreateGaldrAbility(
        name: "Flame Bolt",
        description: "Invoke Fehu to hurl a bolt of primal fire...",
        runeSchool: "Fehu",
        element: "Fire",
        apCost: 10,
        attributeUsed: "will",
        bonusDice: 1,
        damageDice: 2,
        type: AbilityType.Attack
    );
}
```

### 4. Generate Flavor Text in Combat

In `CombatEngine`, after an ability is used, call:

```csharp
// After ability roll succeeds and effects are applied
combatEngine.GenerateAndLogAbilityFlavor(
    ability: ability,
    successCount: successCount,
    targetName: enemy.Name,
    damageOrHealing: damageDealt,
    outcomeType: "Hit", // or "CriticalHit", "Miss", etc.
    combatState: combatState
);
```

This automatically:
- Generates **casting flavor** (Galdr chant or weapon art activation)
- Generates **environmental reaction** (biome-specific, 30% chance for Galdr)
- Generates **outcome flavor** (damage, healing, effects)

---

## üìñ Detailed Integration Points

### Ability Class Properties

```csharp
public class Ability
{
    // Existing properties...

    // v0.38.7: New properties
    public string? RuneSchool { get; set; }      // "Fehu", "Thurisaz", etc. or null
    public string? AbilityCategory { get; set; }  // "WeaponArt", "TacticalAbility", etc. or null
    public string? Element { get; set; }          // "Fire", "Ice", "Lightning", etc. or null
    public bool IsGaldr => !string.IsNullOrEmpty(RuneSchool);
}
```

**Rules:**
- **Galdr abilities:** Set `RuneSchool` + `Element`, leave `AbilityCategory` null
- **Non-Galdr abilities:** Set `AbilityCategory`, leave `RuneSchool` null
- **IsGaldr:** Automatically true if `RuneSchool` is set

### CombatEngine Extension Methods

Located in `CombatEngine_GaldrFlavorExtensions.cs`:

#### 1. Generate Galdr Casting Flavor

```csharp
private string GenerateGaldrCastingFlavor(
    Ability ability,
    int successCount,
    string targetName,
    string casterName = "You",
    string? casterArchetype = null)
```

**When to call:** After ability roll succeeds, before applying effects.

**Returns:** Casting narrative (invocation, chant, rune manifestation).

**Example output:**
> "You invoke Fehu with perfect resonance‚Äîthe rune blazes in the air before you! A devastating torrent of flame engulfs the Corrupted Servitor!"

#### 2. Generate Galdr Outcome Flavor

```csharp
private string GenerateGaldrOutcomeFlavor(
    Ability ability,
    string outcomeType,
    string targetName,
    int? damageOrHealing = null,
    string? enemyArchetype = null)
```

**When to call:** After ability effects are applied.

**Returns:** Outcome narrative (damage, healing, status effects).

**Example output:**
> "Fire engulfs the Corrupted Servitor, scorching their chassis! Circuits melt, hydraulics burst‚Äîit jerks spasmodically! [15 damage]"

#### 3. Generate Non-Galdr Ability Flavor

```csharp
private string GenerateAbilityFlavor(
    Ability ability,
    string? weaponName = null,
    string? targetName = null,
    string? successLevel = null,
    string? specialization = null)
```

**When to call:** For Warrior/Adept abilities (weapon arts, tactics, etc.).

**Returns:** Ability activation narrative.

**Example output:**
> "You spin, your Rusted Greataxe becoming a devastating blur of steel!"

#### 4. Generate Miscast Flavor

```csharp
private string GenerateMiscastFlavor(
    Ability ability,
    string severity = "Moderate")
```

**When to call:** When Galdr ability roll fails or critical failure occurs.

**Returns:** Miscast/paradox narrative.

**Example output:**
> "Your chant falters‚Äîthe Blight warps Fehu's meaning! Fire burns backward, cold as ice, wrong!"

#### 5. Generate Environmental Reaction

```csharp
private string GenerateEnvironmentalReactionFlavor(Ability ability)
```

**When to call:** After Galdr casting (chance-based, ~30%).

**Returns:** Biome reaction to magic.

**Example output:**
> "Steam erupts from rusty pipes as your Galdr ignites the humid air!"

### Helper: All-in-One Method

```csharp
public void GenerateAndLogAbilityFlavor(
    Ability ability,
    int successCount,
    string targetName,
    int? damageOrHealing,
    string outcomeType,
    CombatState combatState)
```

**This is the main integration point.** Call this once after ability resolution, and it handles:
1. Casting flavor (Galdr or non-Galdr)
2. Environmental reaction (Galdr only, chance-based)
3. Outcome flavor (damage/healing/effects)

All text is automatically logged to `combatState.AddLogEntry()`.

---

## üéØ Usage Examples

### Example 1: Galdr Ability (Flame Bolt)

```csharp
// 1. Player uses Flame Bolt
var ability = abilityDatabase.GetAbility("Flame Bolt");
var enemy = combatState.Enemies[0];

// 2. Roll ability check
var roll = diceService.Roll(player.Will + ability.BonusDice);
var successCount = roll.Successes;

if (successCount >= ability.SuccessThreshold)
{
    // 3. Apply damage
    var damage = CalculateDamage(roll, ability);
    enemy.HP -= damage;

    // 4. Generate flavor text (all-in-one)
    combatEngine.GenerateAndLogAbilityFlavor(
        ability: ability,
        successCount: successCount,
        targetName: enemy.Name,
        damageOrHealing: damage,
        outcomeType: DetermineOutcome(successCount), // "Hit", "CriticalHit", etc.
        combatState: combatState
    );
}
else
{
    // Failed cast - generate miscast flavor
    combatEngine.GenerateAndLogMiscastFlavor(
        ability: ability,
        severity: DetermineMiscastSeverity(successCount),
        combatState: combatState
    );
}
```

**Output:**
```
You invoke Fehu with perfect resonance‚Äîthe rune blazes in the air before you!
A devastating torrent of flame engulfs the Corrupted Servitor!

[Environmental] Steam erupts from rusty pipes as your Galdr ignites the humid air!

[Outcome] Fire washes over the Servitor's chassis! Circuits melt, hydraulics burst‚Äî
it jerks spasmodically! [15 damage]
```

### Example 2: Non-Galdr Ability (Whirlwind Strike)

```csharp
// 1. Player uses Whirlwind Strike
var ability = abilityDatabase.GetAbility("Whirlwind Strike");

// 2. Roll and apply damage
var roll = diceService.Roll(player.Might + ability.BonusDice);
var successCount = roll.Successes;

if (successCount >= ability.SuccessThreshold)
{
    var damage = CalculateAOEDamage(roll, ability, enemies);

    // 3. Generate flavor text
    combatEngine.GenerateAndLogAbilityFlavor(
        ability: ability,
        successCount: successCount,
        targetName: "all nearby enemies",
        damageOrHealing: damage,
        outcomeType: "Hit",
        combatState: combatState
    );
}
```

**Output:**
```
You spin, your Rusted Greataxe becoming a devastating blur of steel!
```

---

## üîß Biome Integration

### Getting Current Biome

The extension methods call `GetCurrentBiomeName()` which needs implementation:

```csharp
// Option 1: If Room has BiomeName
private string? GetCurrentBiomeName()
{
    return combatState.CurrentRoom?.BiomeName;
}

// Option 2: If using separate biome system
private string? GetCurrentBiomeName()
{
    return _gameState?.CurrentBiome;
}

// Option 3: Hardcoded for testing
private string? GetCurrentBiomeName()
{
    return "The_Roots"; // Test biome
}
```

**Update:** `/RuneAndRust.Engine/CombatEngine_GaldrFlavorExtensions.cs` line ~230

### Biome-Specific Effects

Biomes modify Galdr manifestations:
- **The Roots** - Industrial decay (steam from pipes, rust)
- **Muspelheim** - Volcanic inferno (fire amplified, ice interfered)
- **Niflheim** - Eternal winter (ice amplified, fire weakened)
- **Alfheim** - Reality distortion (Cursed Choir, paradoxes)
- **Jotunheim** - Ancient halls (resonance with giant-magic)

---

## üìä Success Level Determination

Helper method in extensions:

```csharp
private string DetermineSuccessLevel(int successCount)
{
    return successCount switch
    {
        <= 2 => "MinorSuccess",         // Weak, sputtering
        >= 5 => "ExceptionalSuccess",    // Devastating, reality-bending
        _ => "SolidSuccess"              // Effective, reliable
    };
}
```

This maps to descriptor `success_level` in the database, controlling flavor text intensity.

---

## üóÑÔ∏è Database Setup

### 1. Run Schema

```bash
sqlite3 your_database.db < Data/v0.38.7_galdr_flavor_text_schema.sql
```

Creates 7 tables:
- `Galdr_Action_Descriptors`
- `Galdr_Manifestation_Descriptors`
- `Galdr_Outcome_Descriptors`
- `Galdr_Miscast_Descriptors`
- `Galdr_Caster_Voices`
- `Galdr_Environmental_Reactions`
- `Ability_Flavor_Descriptors`

### 2. Populate Data

```bash
sqlite3 your_database.db < Data/v0.38.7_galdr_action_descriptors.sql
sqlite3 your_database.db < Data/v0.38.7_galdr_outcome_descriptors.sql
sqlite3 your_database.db < Data/v0.38.7_galdr_miscast_descriptors.sql
sqlite3 your_database.db < Data/v0.38.7_galdr_manifestations_and_environmental.sql
sqlite3 your_database.db < Data/v0.38.7_caster_voices_and_ability_flavors.sql
```

Populates 220+ descriptors across all rune schools and ability types.

---

## üé® Customization

### Adding New Rune Schools

1. **Add to `GaldrActionDescriptor.RuneSchools`:**
```csharp
public const string Kenaz = "Kenaz";  // Knowledge/Vision
```

2. **Create descriptors in SQL:**
```sql
INSERT INTO Galdr_Action_Descriptors (...)
VALUES (...);
```

3. **Create example abilities:**
```csharp
public static Ability CreateKenazAbility() { ... }
```

### Adding New Ability Categories

1. **Add to `AbilityFlavorDescriptor.AbilityCategories`:**
```csharp
public const string StealthAbility = "StealthAbility";
```

2. **Configure abilities:**
```csharp
ConfigureWarriorAbility(database, "Sneak Attack", "StealthAbility");
```

### Custom Caster Voices

Create custom personality profiles for NPCs:

```sql
INSERT INTO Galdr_Caster_Voices (
    caster_archetype, voice_name, voice_description, casting_style
) VALUES (
    'FlameSinger',
    'Flame Singer''s Passionate Aria',
    'Passionate and artistic, magic as performance',
    'Operatic chanting with theatrical gestures'
);
```

Then use in code:
```csharp
GenerateGaldrCastingFlavor(ability, successCount, targetName, "You", "FlameSinger");
```

---

## ‚ö†Ô∏è Important Notes

### Null-Safety

All flavor text methods are **null-safe**:
- If `GaldrFlavorTextService` is null, methods return `string.Empty`
- If ability is not configured, fallback text is used
- Exceptions are caught and logged, never crash the game

### Performance

- Descriptor queries use indexed lookups (fast)
- Weighted random selection for variety
- Optional environmental reactions (30% trigger chance)

### Testing Without Database

If database isn't set up yet:
```csharp
var combatEngine = new CombatEngine(..., galdrFlavorTextService: null);
```

System falls back to:
- No flavor text generated
- Basic ability descriptions used
- No miscasts or environmental reactions

---

## üêõ Troubleshooting

### "No Galdr flavor text generated"

**Check:**
1. Is `GaldrFlavorTextService` passed to `CombatEngine` constructor?
2. Is `ability.RuneSchool` set?
3. Are database tables populated?
4. Is `ability.IsGaldr` true?

**Debug:**
```csharp
var ability = database.GetAbility("Flame Bolt");
Console.WriteLine($"RuneSchool: {ability.RuneSchool}"); // Should be "Fehu"
Console.WriteLine($"IsGaldr: {ability.IsGaldr}");       // Should be true
```

### "Flavor text is always the same"

**Check:**
- Multiple descriptors exist for same ability/success level
- `weight` values are set (default 1.0)
- Random selection is working

**Solution:** Add more descriptors with varied `descriptor_text`.

### "Environmental reactions never trigger"

**Check:**
- `trigger_chance` in database (default 0.30 = 30%)
- Biome name matches exactly (case-sensitive)
- `GetCurrentBiomeName()` returns correct value

**Debug:**
```csharp
var biomeName = GetCurrentBiomeName();
Console.WriteLine($"Current biome: {biomeName}"); // Should be "The_Roots", etc.
```

---

## üìö Related Documentation

- **Implementation Summary:** `/V0.38.7_IMPLEMENTATION_SUMMARY.md`
- **Database Schema:** `/Data/v0.38.7_galdr_flavor_text_schema.sql`
- **Ability Class:** `/RuneAndRust.Core/Ability.cs`
- **CombatEngine Extensions:** `/RuneAndRust.Engine/CombatEngine_GaldrFlavorExtensions.cs`
- **AbilityDatabase Extensions:** `/RuneAndRust.Engine/AbilityDatabase_GaldrExtensions.cs`

---

## ‚úÖ Integration Checklist

- [x] Ability class extended with Galdr properties
- [x] CombatEngine made partial and extended
- [x] GaldrFlavorTextService wired into constructor
- [x] Extension methods created for flavor generation
- [x] AbilityDatabase extension methods created
- [x] Example Mystic abilities provided
- [x] Helper methods for ability configuration
- [x] Null-safe implementation
- [x] Integration documentation complete

---

## üéâ You're Ready!

The Galdr flavor text system is fully integrated. Start by:

1. Running database scripts
2. Passing `GaldrFlavorTextService` to `CombatEngine`
3. Calling `ConfigureGaldrProperties()` on `AbilityDatabase`
4. Using `GenerateAndLogAbilityFlavor()` after ability resolution

**May your Galdr resonate with the ancient powers!** üî•‚ö°‚ùÑÔ∏èüåø
