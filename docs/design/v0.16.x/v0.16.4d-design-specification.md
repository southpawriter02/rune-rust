# v0.16.4d Design Specification: Container Loot Service

## Document Information

| Field            | Value                                                                |
| ---------------- | -------------------------------------------------------------------- |
| Version          | v0.16.4d                                                             |
| Parent Version   | v0.16.4 - Container Loot Generation                                  |
| Epic             | v0.16.x - Advanced Loot & Proficiency Systems                        |
| Status           | Draft                                                                |
| Created          | 2025-01-27                                                           |
| Scope Breakdown  | [v0.16.4-scope-breakdown.md](v0.16.4-scope-breakdown.md)             |
| Previous Version | [v0.16.4c-design-specification.md](v0.16.4c-design-specification.md) |

---

## 1. Executive Summary

### 1.1 Overview

Version 0.16.4d introduces the **Container Loot Service**, which orchestrates loot generation for containers. This sub-phase creates the `IContainerLootService` interface and `ContainerLootGenerator` implementation, integrating the container type definitions, biome modifiers, and smart loot system.

### 1.2 Key Deliverables

| Category               | Count | Artifact                 |
| ---------------------- | ----- | ------------------------ |
| Application Interfaces | 1     | `IContainerLootService`  |
| Application Services   | 1     | `ContainerLootGenerator` |
| Unit Tests             | ~3    | Generation logic tests   |

### 1.3 Success Metrics

- Containers generate correct item counts based on type
- Biome modifiers correctly affect loot generation
- Looted containers return empty on subsequent access
- Smart loot integration provides class-appropriate items

---

## 2. Feature Overview

### 2.1 Feature Tree

```
v0.16.4d: Container Loot Service
├── IContainerLootService Interface
│   ├── GenerateContents(containerId, playerId, biomeId)
│   ├── GetContainerDefinition(containerType)
│   └── GetBiomeModifiers(biomeId)
├── ContainerLootGenerator Implementation
│   ├── Container type definition lookup
│   ├── Biome modifier application
│   ├── Smart loot integration
│   ├── Item count calculation
│   ├── Currency amount calculation
│   └── Tier selection with modifiers
└── Integration Points
    ├── ISmartLootService (from v0.16.3)
    ├── ContainerTypeDefinition (from v0.16.4a)
    ├── ContainerLootTable (from v0.16.4b)
    └── BiomeLootModifiers (from v0.16.4c)
```

### 2.2 Scope Boundaries

**In Scope:**

- `IContainerLootService` interface definition
- `ContainerLootGenerator` implementation
- Integration with smart loot service
- Biome modifier application during generation
- Loading container type definitions and biome modifiers
- Unit tests for generation logic

**Out of Scope:**

- State persistence (v0.16.4e)
- Room integration (v0.16.4f)
- Container discovery mechanics
- Lock/unlock mechanics

---

## 3. Architecture Diagrams

### 3.1 Component Integration Diagram

```
┌─────────────────────────────────────────────────────────────────────────┐
│                        APPLICATION LAYER                                 │
│                                                                          │
│  ┌────────────────────────────────────────────────────────────────────┐ │
│  │                    IContainerLootService                            │ │
│  │                                                                     │ │
│  │  + GenerateContents(containerId, playerId, biomeId)                 │ │
│  │    → ContainerContents                                              │ │
│  │                                                                     │ │
│  │  + GetContainerDefinition(containerType)                            │ │
│  │    → ContainerTypeDefinition                                        │ │
│  │                                                                     │ │
│  │  + GetBiomeModifiers(biomeId)                                       │ │
│  │    → BiomeLootModifiers                                             │ │
│  └────────────────────────────────────────────────────────────────────┘ │
│                                  ▲                                       │
│                                  │ implements                            │
│                                  │                                       │
│  ┌────────────────────────────────────────────────────────────────────┐ │
│  │                   ContainerLootGenerator                            │ │
│  │                                                                     │ │
│  │  Dependencies:                                                      │ │
│  │  ├── ISmartLootService (from v0.16.3)                               │ │
│  │  ├── ILogger<ContainerLootGenerator>                                │ │
│  │  ├── Dictionary<ContainerType, ContainerTypeDefinition>             │ │
│  │  └── Dictionary<string, BiomeLootModifiers>                         │ │
│  │                                                                     │ │
│  │  Private Methods:                                                   │ │
│  │  ├── CalculateItemCount(definition, modifiers, random)              │ │
│  │  ├── CalculateCurrency(definition, modifiers, random)               │ │
│  │  ├── SelectTier(definition, modifiers, random)                      │ │
│  │  └── GenerateItems(count, tier, filter, player)                     │ │
│  └────────────────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────────────────┘
                                   │
                                   │ uses
                                   ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                          DOMAIN LAYER                                    │
│                                                                          │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────────────┐  │
│  │ ContainerType   │  │ ContainerType   │  │ BiomeLootModifiers      │  │
│  │ (Enum)          │  │ Definition      │  │ (Value Object)          │  │
│  │ from v0.16.4a   │  │ from v0.16.4a   │  │ from v0.16.4c           │  │
│  └─────────────────┘  └─────────────────┘  └─────────────────────────┘  │
│                                                                          │
│  ┌─────────────────┐  ┌─────────────────────────────────────────────┐   │
│  │ ContainerLoot   │  │ ContainerContents                           │   │
│  │ Table (Entity)  │  │ (Value Object)                              │   │
│  │ from v0.16.4b   │  │ from v0.16.4b                               │   │
│  └─────────────────┘  └─────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────────────┘
```

### 3.2 Generation Flow Diagram

```
┌──────────────────────────────────────────────────────────────────────────┐
│                    GenerateContents(containerId, playerId, biomeId)      │
└──────────────────────────────────────────────────────────────────────────┘
                                      │
                                      ▼
                         ┌────────────────────────┐
                         │ Get ContainerLootTable │
                         │ by containerId         │
                         └───────────┬────────────┘
                                     │
                         ┌───────────▼────────────┐
                         │ Container already      │
                         │ has contents?          │
                         └───────────┬────────────┘
                              Yes    │    No
                         ┌───────────┴───────────┐
                         ▼                       ▼
              ┌──────────────────┐    ┌──────────────────────────┐
              │ Return existing  │    │ Get ContainerType        │
              │ contents         │    │ Definition               │
              └──────────────────┘    └───────────┬──────────────┘
                                                  │
                                      ┌───────────▼──────────────┐
                                      │ Get BiomeLootModifiers   │
                                      │ (or use Default)         │
                                      └───────────┬──────────────┘
                                                  │
                                      ┌───────────▼──────────────┐
                                      │ Calculate item count     │
                                      │ Apply drop rate modifier │
                                      └───────────┬──────────────┘
                                                  │
                                      ┌───────────▼──────────────┐
                                      │ Select quality tier      │
                                      │ Apply quality bonus      │
                                      └───────────┬──────────────┘
                                                  │
                                      ┌───────────▼──────────────┐
                                      │ Generate items via       │
                                      │ ISmartLootService        │
                                      └───────────┬──────────────┘
                                                  │
                                      ┌───────────▼──────────────┐
                                      │ Calculate currency       │
                                      │ Apply gold multiplier    │
                                      └───────────┬──────────────┘
                                                  │
                                      ┌───────────▼──────────────┐
                                      │ Create ContainerContents │
                                      │ Set on ContainerLootTable│
                                      └───────────┬──────────────┘
                                                  │
                                                  ▼
                                      ┌──────────────────────────┐
                                      │ Return ContainerContents │
                                      └──────────────────────────┘
```

### 3.3 Decision Tree: Category Filter Application

```
                    ┌─────────────────────────────┐
                    │ Container has category      │
                    │ filter (ItemCategoryFilter)?│
                    └──────────────┬──────────────┘
                            Yes    │    No
                    ┌──────────────┴──────────────┐
                    ▼                             ▼
         ┌───────────────────────┐    ┌───────────────────────┐
         │ Filter = "weapons"?   │    │ Use ISmartLootService │
         │ "armor"? "consumables"│    │ with no filter        │
         └──────────┬────────────┘    └───────────────────────┘
                    │
         ┌──────────┴─────────────────────────────┐
         │                    │                   │
         ▼                    ▼                   ▼
┌─────────────────┐ ┌─────────────────┐ ┌─────────────────┐
│ Generate only   │ │ Generate only   │ │ Generate only   │
│ weapon items    │ │ armor items     │ │ consumable items│
└─────────────────┘ └─────────────────┘ └─────────────────┘
```

---

## 4. Feature Section: IContainerLootService Interface

### 4.1 Purpose

The `IContainerLootService` interface defines the contract for container loot generation and configuration lookup.

### 4.2 Implementation

**File:** `src/Core/RuneAndRust.Application/Interfaces/IContainerLootService.cs`

```csharp
using RuneAndRust.Domain.Enums;
using RuneAndRust.Domain.ValueObjects;

namespace RuneAndRust.Application.Interfaces;

/// <summary>
/// Service interface for generating and managing container loot.
/// </summary>
/// <remarks>
/// This service orchestrates loot generation by combining container type
/// definitions, biome modifiers, and smart loot algorithms. Contents are
/// generated lazily on first access and cached for subsequent lookups.
/// </remarks>
public interface IContainerLootService
{
    /// <summary>
    /// Generates contents for a container, applying biome modifiers and smart loot.
    /// </summary>
    /// <param name="container">The container to generate contents for.</param>
    /// <param name="playerId">The player ID for smart loot calculations.</param>
    /// <param name="biomeId">The biome ID for modifier lookup.</param>
    /// <returns>
    /// The generated container contents, or empty for previously looted containers.
    /// </returns>
    /// <remarks>
    /// If the container already has generated contents, returns existing contents.
    /// If the container is looted, returns empty contents.
    /// Otherwise, generates new contents based on container type and modifiers.
    /// </remarks>
    ContainerContents GenerateContents(
        ContainerLootTable container,
        Guid playerId,
        string biomeId);

    /// <summary>
    /// Gets the definition for a specific container type.
    /// </summary>
    /// <param name="containerType">The container type to look up.</param>
    /// <returns>The container type definition.</returns>
    /// <exception cref="KeyNotFoundException">
    /// Thrown when no definition exists for the specified type.
    /// </exception>
    ContainerTypeDefinition GetContainerDefinition(ContainerType containerType);

    /// <summary>
    /// Gets the biome modifiers for a specific biome.
    /// </summary>
    /// <param name="biomeId">The biome ID to look up.</param>
    /// <returns>
    /// The biome modifiers, or <see cref="BiomeLootModifiers.Default"/> if not found.
    /// </returns>
    BiomeLootModifiers GetBiomeModifiers(string biomeId);

    /// <summary>
    /// Checks if contents have been generated for a container.
    /// </summary>
    /// <param name="container">The container to check.</param>
    /// <returns>True if contents exist, false otherwise.</returns>
    bool HasGeneratedContents(ContainerLootTable container);
}
```

### 4.3 Design Decisions

| Decision                   | Rationale                                      |
| -------------------------- | ---------------------------------------------- |
| Entity passed by reference | Allows service to set contents on the entity   |
| Player ID parameter        | Required for smart loot class-based generation |
| Biome ID as string         | Matches configuration-driven approach          |
| Default biome modifiers    | Graceful fallback for unknown biomes           |
| Separate definition lookup | Allows queries without triggering generation   |

---

## 5. Feature Section: ContainerLootGenerator

### 5.1 Purpose

The `ContainerLootGenerator` implements `IContainerLootService`, orchestrating the complete loot generation pipeline.

### 5.2 Implementation

**File:** `src/Core/RuneAndRust.Application/Services/ContainerLootGenerator.cs`

```csharp
using Microsoft.Extensions.Logging;
using RuneAndRust.Application.Interfaces;
using RuneAndRust.Domain.Entities;
using RuneAndRust.Domain.Enums;
using RuneAndRust.Domain.ValueObjects;

namespace RuneAndRust.Application.Services;

/// <summary>
/// Generates loot for containers using type definitions, biome modifiers, and smart loot.
/// </summary>
/// <remarks>
/// This service integrates multiple systems to produce contextually appropriate loot:
/// <list type="bullet">
///   <item>Container type definitions specify base item counts, tiers, and currency</item>
///   <item>Biome modifiers adjust quantities and quality based on location</item>
///   <item>Smart loot service provides class-appropriate items for the player</item>
/// </list>
/// </remarks>
public class ContainerLootGenerator : IContainerLootService
{
    private readonly ISmartLootService _smartLootService;
    private readonly ILogger<ContainerLootGenerator> _logger;
    private readonly Dictionary<ContainerType, ContainerTypeDefinition> _containerDefinitions;
    private readonly Dictionary<string, BiomeLootModifiers> _biomeModifiers;
    private readonly Random _random;

    /// <summary>
    /// Initializes a new instance of the ContainerLootGenerator.
    /// </summary>
    /// <param name="smartLootService">The smart loot service for item generation.</param>
    /// <param name="logger">The logger instance.</param>
    /// <param name="containerDefinitions">Container type definitions.</param>
    /// <param name="biomeModifiers">Biome modifier definitions.</param>
    /// <param name="random">Optional random instance for testing.</param>
    public ContainerLootGenerator(
        ISmartLootService smartLootService,
        ILogger<ContainerLootGenerator> logger,
        IEnumerable<ContainerTypeDefinition> containerDefinitions,
        IEnumerable<BiomeLootModifiers> biomeModifiers,
        Random? random = null)
    {
        ArgumentNullException.ThrowIfNull(smartLootService);
        ArgumentNullException.ThrowIfNull(logger);
        ArgumentNullException.ThrowIfNull(containerDefinitions);
        ArgumentNullException.ThrowIfNull(biomeModifiers);

        _smartLootService = smartLootService;
        _logger = logger;
        _random = random ?? Random.Shared;

        _containerDefinitions = containerDefinitions
            .ToDictionary(d => d.Type, d => d);

        _biomeModifiers = biomeModifiers
            .ToDictionary(m => m.BiomeId.ToLowerInvariant(), m => m);

        _logger.LogInformation(
            "ContainerLootGenerator initialized with {ContainerCount} container types and {BiomeCount} biomes",
            _containerDefinitions.Count,
            _biomeModifiers.Count);
    }

    /// <inheritdoc />
    public ContainerContents GenerateContents(
        ContainerLootTable container,
        Guid playerId,
        string biomeId)
    {
        ArgumentNullException.ThrowIfNull(container);

        // Already generated - return existing
        if (container.HasGeneratedContents)
        {
            _logger.LogDebug(
                "Container {ContainerId} already has contents, returning existing",
                container.Id);
            return container.GetDisplayContents();
        }

        // Already looted - return empty
        if (container.IsLooted)
        {
            _logger.LogDebug(
                "Container {ContainerId} is looted, returning empty",
                container.Id);
            return ContainerContents.Empty;
        }

        // Get definitions and modifiers
        var definition = GetContainerDefinition(container.Type);
        var modifiers = GetBiomeModifiers(biomeId);

        _logger.LogDebug(
            "Generating contents for {ContainerType} in biome {BiomeId}",
            container.Type,
            biomeId);

        // Calculate values with modifiers
        var itemCount = CalculateItemCount(definition, modifiers);
        var tier = SelectTier(definition, modifiers);
        var currency = CalculateCurrency(definition, modifiers);

        // Generate items
        var itemIds = GenerateItems(
            itemCount,
            tier,
            definition.ItemCategoryFilter,
            playerId);

        // Create contents
        var contents = ContainerContents.Create(itemIds, currency, tier);
        container.SetContents(contents);

        _logger.LogInformation(
            "Generated contents for container {ContainerId}: {ItemCount} items, {Currency} gold, tier {Tier}",
            container.Id,
            itemIds.Count,
            currency,
            tier);

        return contents;
    }

    /// <inheritdoc />
    public ContainerTypeDefinition GetContainerDefinition(ContainerType containerType)
    {
        if (!_containerDefinitions.TryGetValue(containerType, out var definition))
        {
            _logger.LogError(
                "No definition found for container type {ContainerType}",
                containerType);
            throw new KeyNotFoundException(
                $"No definition found for container type: {containerType}");
        }

        return definition;
    }

    /// <inheritdoc />
    public BiomeLootModifiers GetBiomeModifiers(string biomeId)
    {
        var normalizedId = biomeId?.ToLowerInvariant() ?? string.Empty;

        if (!_biomeModifiers.TryGetValue(normalizedId, out var modifiers))
        {
            _logger.LogWarning(
                "No modifiers found for biome {BiomeId}, using default",
                biomeId);
            return BiomeLootModifiers.Default;
        }

        return modifiers;
    }

    /// <inheritdoc />
    public bool HasGeneratedContents(ContainerLootTable container)
    {
        ArgumentNullException.ThrowIfNull(container);
        return container.HasGeneratedContents;
    }

    /// <summary>
    /// Calculates the number of items to generate.
    /// </summary>
    private int CalculateItemCount(
        ContainerTypeDefinition definition,
        BiomeLootModifiers modifiers)
    {
        // Random count within range
        var baseCount = _random.Next(definition.MinItems, definition.MaxItems + 1);

        // Apply drop rate modifier
        var adjustedCount = modifiers.ApplyToItemCount(baseCount, definition.MinItems);

        _logger.LogDebug(
            "Item count: base={Base}, adjusted={Adjusted} (drop rate: {Rate})",
            baseCount,
            adjustedCount,
            modifiers.DropRateMultiplier);

        return adjustedCount;
    }

    /// <summary>
    /// Selects the quality tier for generated items.
    /// </summary>
    private int SelectTier(
        ContainerTypeDefinition definition,
        BiomeLootModifiers modifiers)
    {
        // Random tier within range
        var baseTier = _random.Next(definition.MinTier, definition.MaxTier + 1);

        // Apply quality bonus
        var adjustedTier = modifiers.ApplyToTier(baseTier, definition.MaxTier);

        _logger.LogDebug(
            "Tier selection: base={Base}, adjusted={Adjusted} (bonus: +{Bonus})",
            baseTier,
            adjustedTier,
            modifiers.QualityBonus);

        return adjustedTier;
    }

    /// <summary>
    /// Calculates the currency amount to generate.
    /// </summary>
    private int CalculateCurrency(
        ContainerTypeDefinition definition,
        BiomeLootModifiers modifiers)
    {
        if (!definition.AwardsCurrency)
        {
            return 0;
        }

        // Random currency within range
        var baseCurrency = _random.Next(
            definition.MinCurrency!.Value,
            definition.MaxCurrency!.Value + 1);

        // Apply gold multiplier
        var adjustedCurrency = modifiers.ApplyToGold(baseCurrency);

        _logger.LogDebug(
            "Currency: base={Base}, adjusted={Adjusted} (multiplier: {Mult})",
            baseCurrency,
            adjustedCurrency,
            modifiers.GoldMultiplier);

        return adjustedCurrency;
    }

    /// <summary>
    /// Generates items using the smart loot service.
    /// </summary>
    private IReadOnlyList<string> GenerateItems(
        int count,
        int tier,
        string? categoryFilter,
        Guid playerId)
    {
        if (count <= 0)
        {
            return Array.Empty<string>();
        }

        var items = new List<string>(count);

        for (var i = 0; i < count; i++)
        {
            var context = new SmartLootContext(
                PlayerId: playerId,
                QualityTier: tier,
                CategoryFilter: categoryFilter);

            var result = _smartLootService.GenerateItem(context);

            if (result.Success && !string.IsNullOrEmpty(result.ItemId))
            {
                items.Add(result.ItemId);
            }
        }

        _logger.LogDebug(
            "Generated {Count} items with filter '{Filter}'",
            items.Count,
            categoryFilter ?? "none");

        return items;
    }
}
```

### 5.3 Design Decisions

| Decision                     | Rationale                                            |
| ---------------------------- | ---------------------------------------------------- |
| Dictionary lookups           | O(1) access for frequently used definitions          |
| Random injection             | Enables deterministic testing                        |
| Lazy generation              | Contents only generated when needed                  |
| Min item count respected     | Drop rate modifier cannot go below container minimum |
| Tier capped at container max | Quality bonus respects container tier limits         |
| Smart loot per item          | Each item generated with player context              |

---

## 6. Data Model Changes

### 6.1 New Interfaces

| Interface               | File Path                                                              | Purpose                   |
| ----------------------- | ---------------------------------------------------------------------- | ------------------------- |
| `IContainerLootService` | `src/Core/RuneAndRust.Application/Interfaces/IContainerLootService.cs` | Container loot generation |

### 6.2 New Services

| Service                  | File Path                                                             | Purpose              |
| ------------------------ | --------------------------------------------------------------------- | -------------------- |
| `ContainerLootGenerator` | `src/Core/RuneAndRust.Application/Services/ContainerLootGenerator.cs` | Loot generation impl |

---

## 7. Logging Specifications

| Component              | Level       | Event                                                     |
| ---------------------- | ----------- | --------------------------------------------------------- |
| ContainerLootGenerator | Information | "ContainerLootGenerator initialized with {Count} types"   |
| ContainerLootGenerator | Information | "Generated contents for container {Id}: {Items} items"    |
| ContainerLootGenerator | Debug       | "Container {Id} already has contents, returning existing" |
| ContainerLootGenerator | Debug       | "Container {Id} is looted, returning empty"               |
| ContainerLootGenerator | Debug       | "Generating contents for {Type} in biome {Biome}"         |
| ContainerLootGenerator | Debug       | "Item count: base={Base}, adjusted={Adjusted}"            |
| ContainerLootGenerator | Debug       | "Tier selection: base={Base}, adjusted={Adjusted}"        |
| ContainerLootGenerator | Debug       | "Currency: base={Base}, adjusted={Adjusted}"              |
| ContainerLootGenerator | Debug       | "Generated {Count} items with filter '{Filter}'"          |
| ContainerLootGenerator | Warning     | "No modifiers found for biome {BiomeId}, using default"   |
| ContainerLootGenerator | Error       | "No definition found for container type {Type}"           |

---

## 8. Unit Testing Requirements

### 8.1 Test Summary

| Test Class                    | Test Count | Focus Area       |
| ----------------------------- | ---------- | ---------------- |
| `ContainerLootGeneratorTests` | ~3         | Generation logic |

### 8.2 Test Specifications

**File:** `tests/RuneAndRust.Application.UnitTests/Services/ContainerLootGeneratorTests.cs`

```csharp
using FluentAssertions;
using Microsoft.Extensions.Logging;
using Moq;
using NUnit.Framework;
using RuneAndRust.Application.Interfaces;
using RuneAndRust.Application.Services;
using RuneAndRust.Domain.Entities;
using RuneAndRust.Domain.Enums;
using RuneAndRust.Domain.ValueObjects;

namespace RuneAndRust.Application.UnitTests.Services;

[TestFixture]
public class ContainerLootGeneratorTests
{
    private Mock<ISmartLootService> _mockSmartLootService = null!;
    private Mock<ILogger<ContainerLootGenerator>> _mockLogger = null!;
    private ContainerLootGenerator _generator = null!;

    [SetUp]
    public void SetUp()
    {
        _mockSmartLootService = new Mock<ISmartLootService>();
        _mockLogger = new Mock<ILogger<ContainerLootGenerator>>();

        _mockSmartLootService
            .Setup(s => s.GenerateItem(It.IsAny<SmartLootContext>()))
            .Returns(new SmartLootResult(true, "test-item-id", null));

        var definitions = new[]
        {
            ContainerTypeDefinition.Create(
                ContainerType.SmallChest, 1, 2, 0, 1, 10, 30)
        };

        var modifiers = new[]
        {
            BiomeLootModifiers.Create("test-biome", 1.5m, 1.0m, 0, 0)
        };

        _generator = new ContainerLootGenerator(
            _mockSmartLootService.Object,
            _mockLogger.Object,
            definitions,
            modifiers,
            new Random(42)); // Seeded for determinism
    }

    [Test]
    public void GenerateContents_ForNewContainer_GeneratesCorrectItemCount()
    {
        // Arrange
        var container = ContainerLootTable.Create(ContainerType.SmallChest);
        container.Open();

        // Act
        var contents = _generator.GenerateContents(
            container,
            Guid.NewGuid(),
            "test-biome");

        // Assert
        contents.HasContents.Should().BeTrue();
        contents.ItemCount.Should().BeInRange(1, 2);
    }

    [Test]
    public void GenerateContents_WithBiomeModifiers_AppliesGoldMultiplier()
    {
        // Arrange
        var container = ContainerLootTable.Create(ContainerType.SmallChest);
        container.Open();

        // Act
        var contents = _generator.GenerateContents(
            container,
            Guid.NewGuid(),
            "test-biome");

        // Assert - Gold should be base (10-30) * 1.5 = 15-45
        contents.CurrencyAmount.Should().BeInRange(15, 45);
    }

    [Test]
    public void GenerateContents_ForLootedContainer_ReturnsEmpty()
    {
        // Arrange
        var container = ContainerLootTable.Create(ContainerType.SmallChest);
        container.Open();
        container.SetContents(ContainerContents.Create(
            new List<string> { "item" }, 10, 1));
        container.Loot();

        // Act
        var contents = _generator.GenerateContents(
            container,
            Guid.NewGuid(),
            "test-biome");

        // Assert
        contents.Should().Be(ContainerContents.Empty);
    }
}
```

---

## 9. Use Cases

### UC-001: Generate Contents for New Container

| Field   | Value                                                                                                                                                                                                                                                                                                                                                                                |
| ------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ |
| Actor   | Game System                                                                                                                                                                                                                                                                                                                                                                          |
| Trigger | Player opens container for first time                                                                                                                                                                                                                                                                                                                                                |
| Flow    | 1. Call GenerateContents with container, player, biome<br>2. Service checks container has no contents<br>3. Get container type definition<br>4. Get biome modifiers<br>5. Calculate item count with drop rate modifier<br>6. Select tier with quality bonus<br>7. Generate items via smart loot<br>8. Calculate currency with gold multiplier<br>9. Create and set ContainerContents |
| Outcome | Container populated with generated loot                                                                                                                                                                                                                                                                                                                                              |

### UC-002: Access Container with Existing Contents

| Field   | Value                                                                                           |
| ------- | ----------------------------------------------------------------------------------------------- |
| Actor   | Game System                                                                                     |
| Trigger | Player opens container that was previously opened                                               |
| Flow    | 1. Call GenerateContents<br>2. Service detects existing contents<br>3. Return existing contents |
| Outcome | Same contents returned without regeneration                                                     |

### UC-003: Access Looted Container

| Field   | Value                                                                                   |
| ------- | --------------------------------------------------------------------------------------- |
| Actor   | Player                                                                                  |
| Trigger | Player interacts with previously looted container                                       |
| Flow    | 1. Call GenerateContents<br>2. Service detects looted state<br>3. Return empty contents |
| Outcome | Empty contents returned                                                                 |

---

## 10. Deliverable Checklist

### 10.1 Application Layer

- [ ] `IContainerLootService` interface (`src/Core/RuneAndRust.Application/Interfaces/IContainerLootService.cs`)
- [ ] `ContainerLootGenerator` service (`src/Core/RuneAndRust.Application/Services/ContainerLootGenerator.cs`)

### 10.2 Tests

- [ ] `ContainerLootGeneratorTests` (`tests/RuneAndRust.Application.UnitTests/Services/ContainerLootGeneratorTests.cs`)

---

## 11. Acceptance Criteria

### 11.1 Functional Criteria

| ID    | Criterion                                       | Verification |
| ----- | ----------------------------------------------- | ------------ |
| AC-01 | Container generates correct item count          | Unit test    |
| AC-02 | Biome modifiers affect gold generation          | Unit test    |
| AC-03 | Biome modifiers affect tier selection           | Unit test    |
| AC-04 | Looted container returns empty                  | Unit test    |
| AC-05 | Existing contents returned without regeneration | Unit test    |
| AC-06 | Category filter restricts item types            | Unit test    |

### 11.2 Quality Criteria

| ID    | Criterion                      | Verification    |
| ----- | ------------------------------ | --------------- |
| QC-01 | All code has XML documentation | Code inspection |
| QC-02 | ~3 unit tests pass             | Test execution  |
| QC-03 | Structured logging implemented | Code review     |

---

## 12. Dependencies

### 12.1 Prerequisites

| Dependency | Description                            | Status   |
| ---------- | -------------------------------------- | -------- |
| v0.16.3    | ISmartLootService for item generation  | Complete |
| v0.16.4a   | ContainerType, ContainerTypeDefinition | Complete |
| v0.16.4b   | ContainerLootTable, ContainerContents  | Complete |
| v0.16.4c   | BiomeLootModifiers                     | Complete |

### 12.2 Provides To

| Consumer | Description                            |
| -------- | -------------------------------------- |
| v0.16.4e | Repository can save generated contents |
| v0.16.4f | Room integration calls service         |

---

## 13. Future Considerations

### 13.1 Deferred to v0.16.4e

- `IContainerStateRepository` for persistence
- Save/load container state

### 13.2 Deferred to v0.16.4f

- Room integration and container placement
- Container discovery in rooms

### 13.3 Potential Future Enhancements

- Batch container generation for performance
- Loot table weights for item rarity
- Container-specific item exclusions
- Player luck stat affecting rare chances
