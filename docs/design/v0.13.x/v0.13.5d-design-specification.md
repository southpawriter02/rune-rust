# v0.13.5d Design Specification: Error Handling & Logging

**Version:** 0.13.5d
**Theme:** Error Handling & Logging
**Author:** Claude
**Created:** 2026-01-16
**Status:** Draft
**Prerequisites:** v0.13.5c Complete (Service Integration Patterns)

---

## Table of Contents

1. [Overview](#1-overview)
2. [Dependencies](#2-dependencies)
3. [Architecture Diagrams](#3-architecture-diagrams)
4. [SafeRender Pattern](#4-saferender-pattern)
5. [Logging Extensions](#5-logging-extensions)
6. [Fallback Rendering](#6-fallback-rendering)
7. [Error Recovery Strategies](#7-error-recovery-strategies)
8. [Data Model Changes](#8-data-model-changes)
9. [Configuration](#9-configuration)
10. [Commands](#10-commands)
11. [User-Facing Changes](#11-user-facing-changes)
12. [Logging Specifications](#12-logging-specifications)
13. [Unit Testing Requirements](#13-unit-testing-requirements)
14. [Use Cases](#14-use-cases)
15. [Deliverable Checklist](#15-deliverable-checklist)
16. [Acceptance Criteria](#16-acceptance-criteria)
17. [Future Considerations](#17-future-considerations)
18. [Implementation Notes](#18-implementation-notes)
19. [Document Metadata](#19-document-metadata)

---

## 1. Overview

### 1.1 Purpose

This document provides a comprehensive design specification for v0.13.5d, the Error Handling & Logging implementation. This part focuses on implementing consistent error handling patterns for all UI components, including the SafeRender pattern for graceful degradation, logging extensions for diagnostic visibility, and fallback rendering strategies to ensure the application remains usable even when individual components encounter errors.

### 1.2 Scope

**In Scope:**
- Implement SafeRender pattern in base classes
- Create `UiLoggingExtensions` for consistent logging
- Create `RenderErrorHandler` for centralized error handling
- Implement fallback rendering for component errors
- Add diagnostic logging for UI state changes
- Define error recovery strategies by component type
- Document error handling guidelines

**Out of Scope:**
- Service integration patterns (v0.13.5c - completed)
- Theme consolidation (v0.13.5b - completed)
- Naming conventions (v0.13.5a - completed)
- Shared layer refactoring (v0.13.5e)
- Accessibility and performance (v0.13.5f)
- Domain/Application layer error handling

### 1.3 Key Deliverables

| Type | Count | Details |
|------|-------|---------|
| Extension Classes | 1 | `UiLoggingExtensions` |
| Utility Classes | 1 | `RenderErrorHandler` |
| Base Class Updates | 2 | SafeRender added to `TuiComponentBase`, `GuiControlBase` |
| Documentation | 1 | `ErrorHandlingGuidelines.md` in `/docs/guidelines/` |
| Unit Tests | ~4 | Error handling, fallback, logging tests |

---

## 2. Dependencies

### 2.1 Required from v0.13.5c (Service Integration Patterns)

| Component | Location | Usage |
|-----------|----------|-------|
| `TuiComponentBase` | `Presentation.Tui/Base/TuiComponentBase.cs` | Add SafeRender method |
| `GuiControlBase` | `Presentation.Gui/Base/GuiControlBase.cs` | Add SafeRender method |
| `IComponentLifecycle` | `Presentation.Shared/Interfaces/IComponentLifecycle.cs` | Lifecycle hooks for error recovery |
| Logger dependency | Constructor injection | Required for error logging |

### 2.2 Required from v0.13.5b (Theme Consolidation)

| Component | Location | Usage |
|-----------|----------|-------|
| `IThemeService` | `Presentation.Shared/Interfaces/IThemeService.cs` | Fallback color access |
| `ColorKey` | `Presentation.Shared/Enums/ColorKey.cs` | Error/warning colors |

### 2.3 Components Requiring Error Handling Updates

| Component | Layer | Error Scenarios |
|-----------|-------|-----------------|
| `HealthBarDisplay` | TUI | Division by zero (max=0), negative values |
| `ResourceBarDisplay` | TUI | Unknown resource type, null values |
| `CombatGridPanel` | TUI | Invalid grid coordinates, null cells |
| `SpectreGameRenderer` | TUI | Console output errors, encoding issues |
| `ColoredTextRenderer` | TUI | Invalid color strings, null text |
| `HealthBarControl` | GUI | Binding failures, null ViewModel |
| `GridCellControl` | GUI | Invalid terrain types, render exceptions |
| `EntityTokenControl` | GUI | Missing entity data, null tokens |
| `DamagePopupControl` | GUI | Animation failures, disposed controls |

### 2.4 Provides to v0.13.5e (Shared Layer Utilization)

| Type | Usage |
|------|-------|
| `UiLoggingExtensions` | Shared logging patterns |
| `RenderErrorHandler` | Shared error handling |
| Error handling patterns | Foundation for shared utilities |

---

## 3. Architecture Diagrams

### 3.1 Error Handling Architecture

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                    ERROR HANDLING ARCHITECTURE                               │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│                         Presentation.Shared                                  │
│                         ───────────────────                                  │
│                                                                              │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │              UiLoggingExtensions (Static Class)                      │    │
│  ├─────────────────────────────────────────────────────────────────────┤    │
│  │ + LogRenderStart(ILogger, string) : IDisposable                      │    │
│  │ + LogRenderComplete(ILogger, string, TimeSpan) : void                │    │
│  │ + LogRenderError(ILogger, string, Exception) : void                  │    │
│  │ + LogStateChange<T>(ILogger, string, string, T, T) : void            │    │
│  │ + LogComponentEvent(ILogger, string, string) : void                  │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
│                                                                              │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │              RenderErrorHandler (Utility Class)                      │    │
│  ├─────────────────────────────────────────────────────────────────────┤    │
│  │ + HandleRenderError(Exception, string, ILogger) : void               │    │
│  │ + GetFallbackContent(string, FallbackType) : string                  │    │
│  │ + ShouldRetry(Exception) : bool                                      │    │
│  │ + GetErrorSeverity(Exception) : ErrorSeverity                        │    │
│  │ + CreateErrorContext(Exception, string) : RenderErrorContext         │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
│                                                                              │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │              RenderErrorContext (Record)                             │    │
│  ├─────────────────────────────────────────────────────────────────────┤    │
│  │ + ComponentName : string                                             │    │
│  │ + Exception : Exception                                              │    │
│  │ + Timestamp : DateTimeOffset                                         │    │
│  │ + Severity : ErrorSeverity                                           │    │
│  │ + IsRecoverable : bool                                               │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
│                                                                              │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │              ErrorSeverity (Enum)                                    │    │
│  ├─────────────────────────────────────────────────────────────────────┤    │
│  │ + Transient    (retry immediately)                                   │    │
│  │ + Recoverable  (use fallback, retry later)                           │    │
│  │ + Permanent    (use fallback, don't retry)                           │    │
│  │ + Critical     (propagate exception)                                 │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
│                                                                              │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │              FallbackType (Enum)                                     │    │
│  ├─────────────────────────────────────────────────────────────────────┤    │
│  │ + Empty        (blank/hidden)                                        │    │
│  │ + Placeholder  (generic placeholder text)                            │    │
│  │ + ErrorMessage (show error indicator)                                │    │
│  │ + LastKnown    (use cached last valid render)                        │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 3.2 SafeRender Flow

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                         SAFERENDER FLOW                                      │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  Component.Render(data)                                                      │
│       │                                                                      │
│       ▼                                                                      │
│  ┌────────────────────────────────────────────────────────────────────────┐ │
│  │  SafeRender(renderAction, componentName)                                │ │
│  └────────────────────────────────────────────────────────────────────────┘ │
│       │                                                                      │
│       ▼                                                                      │
│  ┌─────────────────────┐                                                    │
│  │  LogRenderStart()   │                                                    │
│  └─────────┬───────────┘                                                    │
│            │                                                                 │
│            ▼                                                                 │
│  ┌─────────────────────┐     ┌─────────────────────────────────────────┐   │
│  │  try {              │     │                                         │   │
│  │    renderAction()   │────▶│  SUCCESS PATH                           │   │
│  │  }                  │     │  ├── LogRenderComplete()                │   │
│  └─────────┬───────────┘     │  └── Return normally                    │   │
│            │                  └─────────────────────────────────────────┘   │
│            │ catch                                                          │
│            ▼                                                                 │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │  ERROR PATH                                                          │   │
│  │  ├── LogRenderError(exception, componentName)                        │   │
│  │  ├── errorContext = CreateErrorContext(exception, componentName)     │   │
│  │  │                                                                   │   │
│  │  ├── if (ShouldRetry(exception))                                     │   │
│  │  │   └── Schedule retry (once)                                       │   │
│  │  │                                                                   │   │
│  │  ├── severity = GetErrorSeverity(exception)                          │   │
│  │  │   ├── Transient:    Retry immediately                             │   │
│  │  │   ├── Recoverable:  RenderFallback(componentName)                 │   │
│  │  │   ├── Permanent:    RenderFallback(componentName)                 │   │
│  │  │   └── Critical:     Re-throw exception                            │   │
│  │  │                                                                   │   │
│  │  └── OnRenderError(errorContext)  [virtual hook]                     │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 3.3 Logging Level Decision Tree

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                    LOGGING LEVEL DECISION TREE                               │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│                          UI Event Occurs                                     │
│                                │                                             │
│                                ▼                                             │
│                    ┌─────────────────────┐                                  │
│                    │ What type of event? │                                  │
│                    └─────────┬───────────┘                                  │
│                              │                                               │
│         ┌────────────────────┼────────────────────┐                         │
│         │                    │                    │                         │
│         ▼                    ▼                    ▼                         │
│  ┌─────────────┐     ┌─────────────┐     ┌─────────────┐                   │
│  │   Normal    │     │   Warning   │     │   Error     │                   │
│  │  Operation  │     │  Condition  │     │  Condition  │                   │
│  └──────┬──────┘     └──────┬──────┘     └──────┬──────┘                   │
│         │                   │                   │                           │
│         ▼                   ▼                   ▼                           │
│  ┌─────────────┐     ┌─────────────┐     ┌─────────────┐                   │
│  │ Is it a     │     │ Is fallback │     │ Did error   │                   │
│  │ state       │     │ triggered?  │     │ propagate?  │                   │
│  │ change?     │     └──────┬──────┘     └──────┬──────┘                   │
│  └──────┬──────┘            │                   │                           │
│         │            ┌──────┴──────┐     ┌──────┴──────┐                   │
│   ┌─────┴─────┐      │             │     │             │                   │
│   │           │      ▼             ▼     ▼             ▼                   │
│   ▼           ▼   ┌──────┐    ┌──────┐ ┌──────┐   ┌──────┐                │
│ ┌───────┐ ┌───────┐│ Yes  │    │ No   │ │ Yes  │   │ No   │                │
│ │ Debug │ │ Trace ││      │    │      │ │      │   │      │                │
│ │ Level │ │ Level │└──┬───┘    └──┬───┘ └──┬───┘   └──┬───┘                │
│ └───────┘ └───────┘   │           │        │          │                    │
│                       ▼           ▼        ▼          ▼                    │
│                   ┌───────┐  ┌───────┐ ┌───────┐  ┌───────┐               │
│                   │Warning│  │ Debug │ │ Error │  │Warning│               │
│                   │ Level │  │ Level │ │ Level │  │ Level │               │
│                   └───────┘  └───────┘ └───────┘  └───────┘               │
│                                                                              │
│  Summary:                                                                    │
│  ─────────                                                                   │
│  • Trace:   Render cycles, fine-grained events                              │
│  • Debug:   State changes, lifecycle events, component init                 │
│  • Info:    Major state transitions, significant events                     │
│  • Warning: Recoverable errors, fallback rendering triggered                │
│  • Error:   Unrecoverable errors, component failure                         │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 4. SafeRender Pattern

### 4.1 TuiComponentBase SafeRender Implementation

```
┌─────────────────────────────────────────────────────────────────────────────┐
│  TuiComponentBase SafeRender (Update to Presentation.Tui/Base)               │
│  ─────────────────────────────────────────────────────────────               │
│                                                                              │
│  // Add to TuiComponentBase class:                                           │
│                                                                              │
│  private string? _lastValidOutput;                                           │
│  private int _consecutiveErrors;                                             │
│  private const int MaxConsecutiveErrors = 3;                                 │
│                                                                              │
│  /// <summary>                                                               │
│  /// Executes a render action with error handling and fallback.              │
│  /// </summary>                                                              │
│  /// <param name="renderAction">The render action to execute.</param>        │
│  /// <param name="context">Optional context for error messages.</param>      │
│  protected void SafeRender(Action renderAction, string? context = null)      │
│  {                                                                           │
│      var renderContext = context ?? ComponentName;                           │
│      var stopwatch = Stopwatch.StartNew();                                   │
│                                                                              │
│      using (Logger.LogRenderStart(renderContext))                            │
│      {                                                                       │
│          try                                                                 │
│          {                                                                   │
│              renderAction();                                                 │
│              stopwatch.Stop();                                               │
│                                                                              │
│              _consecutiveErrors = 0;  // Reset on success                    │
│              Logger.LogRenderComplete(renderContext, stopwatch.Elapsed);     │
│          }                                                                   │
│          catch (Exception ex)                                                │
│          {                                                                   │
│              stopwatch.Stop();                                               │
│              _consecutiveErrors++;                                           │
│                                                                              │
│              Logger.LogRenderError(renderContext, ex);                       │
│                                                                              │
│              var severity = RenderErrorHandler.GetErrorSeverity(ex);         │
│              var errorContext = RenderErrorHandler.CreateErrorContext(       │
│                  ex, renderContext);                                         │
│                                                                              │
│              switch (severity)                                               │
│              {                                                               │
│                  case ErrorSeverity.Transient when _consecutiveErrors < Max: │
│                      // Retry once for transient errors                      │
│                      SafeRender(renderAction, context);                      │
│                      break;                                                  │
│                                                                              │
│                  case ErrorSeverity.Critical:                                │
│                      // Propagate critical errors                            │
│                      throw;                                                  │
│                                                                              │
│                  default:                                                    │
│                      // Use fallback for recoverable/permanent errors        │
│                      RenderFallback(renderContext);                          │
│                      break;                                                  │
│              }                                                               │
│                                                                              │
│              OnRenderError(errorContext);                                    │
│          }                                                                   │
│      }                                                                       │
│  }                                                                           │
│                                                                              │
│  /// <summary>                                                               │
│  /// Renders fallback content when primary render fails.                     │
│  /// </summary>                                                              │
│  protected virtual void RenderFallback(string context)                       │
│  {                                                                           │
│      var fallback = RenderErrorHandler.GetFallbackContent(                   │
│          context, FallbackType.Placeholder);                                 │
│                                                                              │
│      // Output fallback to console with muted color                          │
│      var color = GetColor(ColorKey.Muted);                                   │
│      Console.ForegroundColor = color;                                        │
│      Console.Write(fallback);                                                │
│      Console.ResetColor();                                                   │
│  }                                                                           │
│                                                                              │
│  /// <summary>                                                               │
│  /// Called when a render error occurs. Override to add custom handling.     │
│  /// </summary>                                                              │
│  protected virtual void OnRenderError(RenderErrorContext context)            │
│  {                                                                           │
│      // Default: no additional handling                                       │
│      // Subclasses can override for custom error handling                    │
│  }                                                                           │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 4.2 GuiControlBase SafeRender Implementation

```
┌─────────────────────────────────────────────────────────────────────────────┐
│  GuiControlBase SafeRender (Update to Presentation.Gui/Base)                 │
│  ───────────────────────────────────────────────────────────                 │
│                                                                              │
│  // Add to GuiControlBase class:                                             │
│                                                                              │
│  private object? _lastValidState;                                            │
│  private int _consecutiveErrors;                                             │
│  private const int MaxConsecutiveErrors = 3;                                 │
│                                                                              │
│  /// <summary>                                                               │
│  /// Executes a render action with error handling and fallback.              │
│  /// </summary>                                                              │
│  protected void SafeRender(Action renderAction, string? context = null)      │
│  {                                                                           │
│      var renderContext = context ?? ControlName;                             │
│      var stopwatch = Stopwatch.StartNew();                                   │
│                                                                              │
│      using (Logger.LogRenderStart(renderContext))                            │
│      {                                                                       │
│          try                                                                 │
│          {                                                                   │
│              renderAction();                                                 │
│              stopwatch.Stop();                                               │
│                                                                              │
│              _consecutiveErrors = 0;                                         │
│              Logger.LogRenderComplete(renderContext, stopwatch.Elapsed);     │
│          }                                                                   │
│          catch (Exception ex)                                                │
│          {                                                                   │
│              stopwatch.Stop();                                               │
│              _consecutiveErrors++;                                           │
│                                                                              │
│              Logger.LogRenderError(renderContext, ex);                       │
│                                                                              │
│              var severity = RenderErrorHandler.GetErrorSeverity(ex);         │
│              var errorContext = RenderErrorHandler.CreateErrorContext(       │
│                  ex, renderContext);                                         │
│                                                                              │
│              // Dispatch to UI thread for fallback render                    │
│              Dispatcher.UIThread.Post(() =>                                  │
│              {                                                               │
│                  switch (severity)                                           │
│                  {                                                           │
│                      case ErrorSeverity.Critical:                            │
│                          // Show error indicator for critical errors         │
│                          RenderFallback(renderContext, FallbackType.Error);  │
│                          break;                                              │
│                                                                              │
│                      default:                                                │
│                          RenderFallback(renderContext, FallbackType.Placeho);│
│                          break;                                              │
│                  }                                                           │
│              });                                                             │
│                                                                              │
│              OnRenderError(errorContext);                                    │
│          }                                                                   │
│      }                                                                       │
│  }                                                                           │
│                                                                              │
│  /// <summary>                                                               │
│  /// Renders fallback content when primary render fails.                     │
│  /// </summary>                                                              │
│  protected virtual void RenderFallback(string context, FallbackType type)    │
│  {                                                                           │
│      var fallbackText = RenderErrorHandler.GetFallbackContent(context, type);│
│                                                                              │
│      // Update control to show fallback state                                │
│      switch (type)                                                           │
│      {                                                                       │
│          case FallbackType.Empty:                                            │
│              IsVisible = false;                                              │
│              break;                                                          │
│                                                                              │
│          case FallbackType.ErrorMessage:                                     │
│              Background = GetBrush(ColorKey.Accent);  // Error color         │
│              // Set error indicator if control supports it                   │
│              break;                                                          │
│                                                                              │
│          case FallbackType.Placeholder:                                      │
│          default:                                                            │
│              Background = GetBrush(ColorKey.Surface);                        │
│              Opacity = 0.5;                                                  │
│              break;                                                          │
│      }                                                                       │
│  }                                                                           │
│                                                                              │
│  /// <summary>                                                               │
│  /// Called when a render error occurs. Override for custom handling.        │
│  /// </summary>                                                              │
│  protected virtual void OnRenderError(RenderErrorContext context)            │
│  {                                                                           │
│      // Default: no additional handling                                       │
│  }                                                                           │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 5. Logging Extensions

### 5.1 UiLoggingExtensions Class

```
┌─────────────────────────────────────────────────────────────────────────────┐
│  UiLoggingExtensions (Static Class - Presentation.Shared)                    │
│  ────────────────────────────────────────────────────────                    │
│                                                                              │
│  Location: Presentation.Shared/Extensions/UiLoggingExtensions.cs             │
│                                                                              │
│  public static class UiLoggingExtensions                                     │
│  {                                                                           │
│      // ═══════════════════════════════════════════════════════════════════ │
│      // RENDER LOGGING                                                       │
│      // ═══════════════════════════════════════════════════════════════════ │
│                                                                              │
│      /// <summary>                                                           │
│      /// Logs render start and returns disposable for automatic completion.  │
│      /// </summary>                                                          │
│      public static IDisposable LogRenderStart(                               │
│          this ILogger logger,                                                │
│          string componentName)                                               │
│      {                                                                       │
│          logger.LogTrace("Render starting: {Component}", componentName);     │
│          return new RenderScope(logger, componentName, Stopwatch.StartNew());│
│      }                                                                       │
│                                                                              │
│      /// <summary>                                                           │
│      /// Logs render completion with duration.                               │
│      /// </summary>                                                          │
│      public static void LogRenderComplete(                                   │
│          this ILogger logger,                                                │
│          string componentName,                                               │
│          TimeSpan duration)                                                  │
│      {                                                                       │
│          logger.LogTrace(                                                    │
│              "Render complete: {Component} ({Duration:F2}ms)",               │
│              componentName,                                                  │
│              duration.TotalMilliseconds);                                    │
│      }                                                                       │
│                                                                              │
│      /// <summary>                                                           │
│      /// Logs render error with exception details.                           │
│      /// </summary>                                                          │
│      public static void LogRenderError(                                      │
│          this ILogger logger,                                                │
│          string componentName,                                               │
│          Exception exception)                                                │
│      {                                                                       │
│          logger.LogWarning(                                                  │
│              exception,                                                      │
│              "Render failed: {Component} - {Error}",                         │
│              componentName,                                                  │
│              exception.Message);                                             │
│      }                                                                       │
│                                                                              │
│      // ═══════════════════════════════════════════════════════════════════ │
│      // STATE CHANGE LOGGING                                                 │
│      // ═══════════════════════════════════════════════════════════════════ │
│                                                                              │
│      /// <summary>                                                           │
│      /// Logs a state change with old and new values.                        │
│      /// </summary>                                                          │
│      public static void LogStateChange<T>(                                   │
│          this ILogger logger,                                                │
│          string componentName,                                               │
│          string propertyName,                                                │
│          T oldValue,                                                         │
│          T newValue)                                                         │
│      {                                                                       │
│          logger.LogDebug(                                                    │
│              "State change: {Component}.{Property}: {Old} -> {New}",         │
│              componentName,                                                  │
│              propertyName,                                                   │
│              oldValue,                                                       │
│              newValue);                                                      │
│      }                                                                       │
│                                                                              │
│      // ═══════════════════════════════════════════════════════════════════ │
│      // COMPONENT EVENT LOGGING                                              │
│      // ═══════════════════════════════════════════════════════════════════ │
│                                                                              │
│      /// <summary>                                                           │
│      /// Logs a component event.                                             │
│      /// </summary>                                                          │
│      public static void LogComponentEvent(                                   │
│          this ILogger logger,                                                │
│          string componentName,                                               │
│          string eventName)                                                   │
│      {                                                                       │
│          logger.LogDebug(                                                    │
│              "Component event: {Component} - {Event}",                       │
│              componentName,                                                  │
│              eventName);                                                     │
│      }                                                                       │
│                                                                              │
│      /// <summary>                                                           │
│      /// Logs a component event with details.                                │
│      /// </summary>                                                          │
│      public static void LogComponentEvent(                                   │
│          this ILogger logger,                                                │
│          string componentName,                                               │
│          string eventName,                                                   │
│          object details)                                                     │
│      {                                                                       │
│          logger.LogDebug(                                                    │
│              "Component event: {Component} - {Event}: {Details}",            │
│              componentName,                                                  │
│              eventName,                                                      │
│              details);                                                       │
│      }                                                                       │
│                                                                              │
│      // ═══════════════════════════════════════════════════════════════════ │
│      // FALLBACK LOGGING                                                     │
│      // ═══════════════════════════════════════════════════════════════════ │
│                                                                              │
│      /// <summary>                                                           │
│      /// Logs when fallback rendering is triggered.                          │
│      /// </summary>                                                          │
│      public static void LogFallbackTriggered(                                │
│          this ILogger logger,                                                │
│          string componentName,                                               │
│          FallbackType fallbackType)                                          │
│      {                                                                       │
│          logger.LogWarning(                                                  │
│              "Fallback triggered: {Component} using {FallbackType}",         │
│              componentName,                                                  │
│              fallbackType);                                                  │
│      }                                                                       │
│                                                                              │
│      // ═══════════════════════════════════════════════════════════════════ │
│      // HELPER CLASSES                                                       │
│      // ═══════════════════════════════════════════════════════════════════ │
│                                                                              │
│      private sealed class RenderScope : IDisposable                          │
│      {                                                                       │
│          private readonly ILogger _logger;                                   │
│          private readonly string _componentName;                             │
│          private readonly Stopwatch _stopwatch;                              │
│          private bool _disposed;                                             │
│                                                                              │
│          public RenderScope(ILogger logger, string name, Stopwatch sw)       │
│          {                                                                   │
│              _logger = logger;                                               │
│              _componentName = name;                                          │
│              _stopwatch = sw;                                                │
│          }                                                                   │
│                                                                              │
│          public void Dispose()                                               │
│          {                                                                   │
│              if (_disposed) return;                                          │
│              _disposed = true;                                               │
│              _stopwatch.Stop();                                              │
│              // Note: LogRenderComplete called explicitly on success         │
│          }                                                                   │
│      }                                                                       │
│  }                                                                           │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 6. Fallback Rendering

### 6.1 RenderErrorHandler Class

```
┌─────────────────────────────────────────────────────────────────────────────┐
│  RenderErrorHandler (Utility Class - Presentation.Shared)                    │
│  ────────────────────────────────────────────────────────                    │
│                                                                              │
│  Location: Presentation.Shared/Utilities/RenderErrorHandler.cs               │
│                                                                              │
│  public static class RenderErrorHandler                                      │
│  {                                                                           │
│      // ═══════════════════════════════════════════════════════════════════ │
│      // ERROR HANDLING                                                       │
│      // ═══════════════════════════════════════════════════════════════════ │
│                                                                              │
│      /// <summary>                                                           │
│      /// Handles a render error by logging and determining next steps.       │
│      /// </summary>                                                          │
│      public static void HandleRenderError(                                   │
│          Exception exception,                                                │
│          string componentName,                                               │
│          ILogger logger)                                                     │
│      {                                                                       │
│          var severity = GetErrorSeverity(exception);                         │
│          var context = CreateErrorContext(exception, componentName);         │
│                                                                              │
│          switch (severity)                                                   │
│          {                                                                   │
│              case ErrorSeverity.Transient:                                   │
│                  logger.LogDebug(                                            │
│                      exception,                                              │
│                      "Transient error in {Component}, will retry",           │
│                      componentName);                                         │
│                  break;                                                      │
│                                                                              │
│              case ErrorSeverity.Recoverable:                                 │
│                  logger.LogWarning(                                          │
│                      exception,                                              │
│                      "Recoverable error in {Component}, using fallback",     │
│                      componentName);                                         │
│                  break;                                                      │
│                                                                              │
│              case ErrorSeverity.Permanent:                                   │
│                  logger.LogWarning(                                          │
│                      exception,                                              │
│                      "Permanent error in {Component}, fallback only",        │
│                      componentName);                                         │
│                  break;                                                      │
│                                                                              │
│              case ErrorSeverity.Critical:                                    │
│                  logger.LogError(                                            │
│                      exception,                                              │
│                      "Critical error in {Component}, propagating",           │
│                      componentName);                                         │
│                  break;                                                      │
│          }                                                                   │
│      }                                                                       │
│                                                                              │
│      // ═══════════════════════════════════════════════════════════════════ │
│      // FALLBACK CONTENT                                                     │
│      // ═══════════════════════════════════════════════════════════════════ │
│                                                                              │
│      /// <summary>                                                           │
│      /// Gets fallback content for a failed component.                       │
│      /// </summary>                                                          │
│      public static string GetFallbackContent(                                │
│          string componentName,                                               │
│          FallbackType fallbackType)                                          │
│      {                                                                       │
│          return fallbackType switch                                          │
│          {                                                                   │
│              FallbackType.Empty => string.Empty,                             │
│              FallbackType.Placeholder => $"[{componentName}]",               │
│              FallbackType.ErrorMessage => $"[!{componentName}]",             │
│              FallbackType.LastKnown => $"[~{componentName}]",                │
│              _ => $"[{componentName}]"                                       │
│          };                                                                  │
│      }                                                                       │
│                                                                              │
│      // ═══════════════════════════════════════════════════════════════════ │
│      // ERROR CLASSIFICATION                                                 │
│      // ═══════════════════════════════════════════════════════════════════ │
│                                                                              │
│      /// <summary>                                                           │
│      /// Determines if an error should trigger a retry.                      │
│      /// </summary>                                                          │
│      public static bool ShouldRetry(Exception exception)                     │
│      {                                                                       │
│          return exception switch                                             │
│          {                                                                   │
│              // Transient errors that may resolve                            │
│              TimeoutException => true,                                       │
│              IOException io when IsTransientIO(io) => true,                  │
│                                                                              │
│              // Never retry these                                            │
│              ArgumentException => false,                                     │
│              NullReferenceException => false,                                │
│              InvalidOperationException => false,                             │
│              ObjectDisposedException => false,                               │
│                                                                              │
│              _ => false                                                      │
│          };                                                                  │
│      }                                                                       │
│                                                                              │
│      /// <summary>                                                           │
│      /// Gets the severity level of an exception.                            │
│      /// </summary>                                                          │
│      public static ErrorSeverity GetErrorSeverity(Exception exception)       │
│      {                                                                       │
│          return exception switch                                             │
│          {                                                                   │
│              // Transient - may self-resolve                                 │
│              TimeoutException => ErrorSeverity.Transient,                    │
│                                                                              │
│              // Recoverable - fallback works, may fix later                  │
│              FormatException => ErrorSeverity.Recoverable,                   │
│              ArgumentOutOfRangeException => ErrorSeverity.Recoverable,       │
│              KeyNotFoundException => ErrorSeverity.Recoverable,              │
│                                                                              │
│              // Permanent - won't self-resolve                               │
│              ArgumentNullException => ErrorSeverity.Permanent,               │
│              InvalidOperationException => ErrorSeverity.Permanent,           │
│              NullReferenceException => ErrorSeverity.Permanent,              │
│                                                                              │
│              // Critical - must propagate                                    │
│              OutOfMemoryException => ErrorSeverity.Critical,                 │
│              StackOverflowException => ErrorSeverity.Critical,               │
│              AccessViolationException => ErrorSeverity.Critical,             │
│              ObjectDisposedException => ErrorSeverity.Critical,              │
│                                                                              │
│              // Default to recoverable for unknown exceptions                │
│              _ => ErrorSeverity.Recoverable                                  │
│          };                                                                  │
│      }                                                                       │
│                                                                              │
│      // ═══════════════════════════════════════════════════════════════════ │
│      // ERROR CONTEXT                                                        │
│      // ═══════════════════════════════════════════════════════════════════ │
│                                                                              │
│      /// <summary>                                                           │
│      /// Creates an error context record for diagnostics.                    │
│      /// </summary>                                                          │
│      public static RenderErrorContext CreateErrorContext(                    │
│          Exception exception,                                                │
│          string componentName)                                               │
│      {                                                                       │
│          var severity = GetErrorSeverity(exception);                         │
│          return new RenderErrorContext(                                      │
│              ComponentName: componentName,                                   │
│              Exception: exception,                                           │
│              Timestamp: DateTimeOffset.UtcNow,                               │
│              Severity: severity,                                             │
│              IsRecoverable: severity != ErrorSeverity.Critical);             │
│      }                                                                       │
│                                                                              │
│      // ═══════════════════════════════════════════════════════════════════ │
│      // HELPERS                                                              │
│      // ═══════════════════════════════════════════════════════════════════ │
│                                                                              │
│      private static bool IsTransientIO(IOException exception)                │
│      {                                                                       │
│          // Check for transient I/O conditions                               │
│          var message = exception.Message.ToLowerInvariant();                 │
│          return message.Contains("temporarily") ||                           │
│                 message.Contains("busy") ||                                  │
│                 message.Contains("locked");                                  │
│      }                                                                       │
│  }                                                                           │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 6.2 Component-Specific Fallback Strategies

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                    COMPONENT FALLBACK STRATEGIES                             │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │  HealthBarDisplay Fallback                                            │    │
│  │  ─────────────────────────────                                        │    │
│  │                                                                       │    │
│  │  Error Scenarios:                                                     │    │
│  │  • Division by zero (max = 0)                                         │    │
│  │  • Negative values                                                    │    │
│  │  • Values exceeding max                                               │    │
│  │                                                                       │    │
│  │  Fallback Strategy:                                                   │    │
│  │  ┌────────────────────────────────────────────────────────────────┐  │    │
│  │  │ protected override void RenderFallback(string context)          │  │    │
│  │  │ {                                                                │  │    │
│  │  │     // Show empty bar with placeholder                           │  │    │
│  │  │     var color = GetColor(ColorKey.Muted);                        │  │    │
│  │  │     Console.ForegroundColor = color;                             │  │    │
│  │  │     Console.Write("[HP: ---/---]");                              │  │    │
│  │  │     Console.ResetColor();                                        │  │    │
│  │  │ }                                                                │  │    │
│  │  └────────────────────────────────────────────────────────────────┘  │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
│                                                                              │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │  CombatGridPanel Fallback                                             │    │
│  │  ────────────────────────────                                         │    │
│  │                                                                       │    │
│  │  Error Scenarios:                                                     │    │
│  │  • Invalid grid coordinates                                           │    │
│  │  • Null cell data                                                     │    │
│  │  • Missing terrain types                                              │    │
│  │                                                                       │    │
│  │  Fallback Strategy:                                                   │    │
│  │  ┌────────────────────────────────────────────────────────────────┐  │    │
│  │  │ protected override void RenderFallback(string context)          │  │    │
│  │  │ {                                                                │  │    │
│  │  │     // Show empty grid outline                                   │  │    │
│  │  │     var border = GetColor(ColorKey.Muted);                       │  │    │
│  │  │     Console.ForegroundColor = border;                            │  │    │
│  │  │     Console.WriteLine("┌─────────────────┐");                    │  │    │
│  │  │     Console.WriteLine("│  [Grid Error]   │");                    │  │    │
│  │  │     Console.WriteLine("└─────────────────┘");                    │  │    │
│  │  │     Console.ResetColor();                                        │  │    │
│  │  │ }                                                                │  │    │
│  │  └────────────────────────────────────────────────────────────────┘  │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
│                                                                              │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │  HealthBarControl (GUI) Fallback                                      │    │
│  │  ───────────────────────────────                                      │    │
│  │                                                                       │    │
│  │  Error Scenarios:                                                     │    │
│  │  • ViewModel binding failure                                          │    │
│  │  • Null ViewModel                                                     │    │
│  │  • Brush creation failure                                             │    │
│  │                                                                       │    │
│  │  Fallback Strategy:                                                   │    │
│  │  ┌────────────────────────────────────────────────────────────────┐  │    │
│  │  │ protected override void RenderFallback(string ctx, FallbackType t)│  │    │
│  │  │ {                                                                │  │    │
│  │  │     // Show grayed-out bar with error indicator                  │  │    │
│  │  │     HealthBar.Background = GetBrush(ColorKey.Surface);           │  │    │
│  │  │     HealthBar.Foreground = GetBrush(ColorKey.Muted);             │  │    │
│  │  │     HealthLabel.Text = "---";                                    │  │    │
│  │  │     Opacity = 0.5;                                               │  │    │
│  │  │ }                                                                │  │    │
│  │  └────────────────────────────────────────────────────────────────┘  │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
│                                                                              │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │  GridCellControl (GUI) Fallback                                       │    │
│  │  ──────────────────────────────                                       │    │
│  │                                                                       │    │
│  │  Error Scenarios:                                                     │    │
│  │  • Unknown terrain type                                               │    │
│  │  • Render exception                                                   │    │
│  │                                                                       │    │
│  │  Fallback Strategy:                                                   │    │
│  │  ┌────────────────────────────────────────────────────────────────┐  │    │
│  │  │ protected override void RenderFallback(string ctx, FallbackType t)│  │    │
│  │  │ {                                                                │  │    │
│  │  │     // Show neutral cell with question mark                      │  │    │
│  │  │     Background = GetBrush(ColorKey.Surface);                     │  │    │
│  │  │     CellSymbol.Text = "?";                                       │  │    │
│  │  │     CellSymbol.Foreground = GetBrush(ColorKey.Muted);            │  │    │
│  │  │ }                                                                │  │    │
│  │  └────────────────────────────────────────────────────────────────┘  │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 7. Error Recovery Strategies

### 7.1 Recovery Strategy by Error Type

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                    ERROR RECOVERY STRATEGIES                                 │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  ┌────────────────────┬──────────────────┬─────────────────────────────┐    │
│  │ Exception Type     │ Severity         │ Recovery Action             │    │
│  ├────────────────────┼──────────────────┼─────────────────────────────┤    │
│  │ TimeoutException   │ Transient        │ Retry once, then fallback   │    │
│  │ IOException (temp) │ Transient        │ Retry once, then fallback   │    │
│  ├────────────────────┼──────────────────┼─────────────────────────────┤    │
│  │ FormatException    │ Recoverable      │ Use default/fallback value  │    │
│  │ ArgOutOfRange      │ Recoverable      │ Clamp to valid range        │    │
│  │ KeyNotFound        │ Recoverable      │ Use default value           │    │
│  │ DivideByZero       │ Recoverable      │ Use zero/empty state        │    │
│  ├────────────────────┼──────────────────┼─────────────────────────────┤    │
│  │ ArgumentNull       │ Permanent        │ Show placeholder, log error │    │
│  │ InvalidOperation   │ Permanent        │ Show placeholder, log error │    │
│  │ NullReference      │ Permanent        │ Show placeholder, log error │    │
│  ├────────────────────┼──────────────────┼─────────────────────────────┤    │
│  │ OutOfMemory        │ Critical         │ Propagate to caller         │    │
│  │ StackOverflow      │ Critical         │ Propagate to caller         │    │
│  │ ObjectDisposed     │ Critical         │ Propagate to caller         │    │
│  └────────────────────┴──────────────────┴─────────────────────────────┘    │
│                                                                              │
│  Recovery Flow:                                                              │
│  ──────────────                                                              │
│                                                                              │
│  1. Transient Errors:                                                        │
│     ├── Log at Debug level                                                   │
│     ├── Wait briefly (no explicit delay, immediate retry)                    │
│     ├── Retry render once                                                    │
│     └── If retry fails, treat as Recoverable                                │
│                                                                              │
│  2. Recoverable Errors:                                                      │
│     ├── Log at Warning level                                                 │
│     ├── Render fallback content                                              │
│     └── Continue normal operation                                            │
│                                                                              │
│  3. Permanent Errors:                                                        │
│     ├── Log at Warning level                                                 │
│     ├── Render fallback content                                              │
│     ├── Mark component as degraded                                           │
│     └── Wait for external state change to retry                              │
│                                                                              │
│  4. Critical Errors:                                                         │
│     ├── Log at Error level                                                   │
│     ├── Re-throw exception                                                   │
│     └── Let caller handle (may crash gracefully)                             │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 8. Data Model Changes

### 8.1 New Types Summary

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                         DATA MODEL CHANGES                                   │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  NEW: ErrorSeverity (Enum - Presentation.Shared)                             │
│  ├── Transient      = 0  (retry immediately)                                 │
│  ├── Recoverable    = 1  (use fallback, may retry later)                     │
│  ├── Permanent      = 2  (use fallback, don't retry)                         │
│  └── Critical       = 3  (propagate exception)                               │
│                                                                              │
│  NEW: FallbackType (Enum - Presentation.Shared)                              │
│  ├── Empty          = 0  (blank/hidden)                                      │
│  ├── Placeholder    = 1  (generic placeholder text)                          │
│  ├── ErrorMessage   = 2  (show error indicator)                              │
│  └── LastKnown      = 3  (use cached last valid render)                      │
│                                                                              │
│  NEW: RenderErrorContext (Record - Presentation.Shared)                      │
│  ├── ComponentName : string                                                  │
│  ├── Exception : Exception                                                   │
│  ├── Timestamp : DateTimeOffset                                              │
│  ├── Severity : ErrorSeverity                                                │
│  └── IsRecoverable : bool                                                    │
│                                                                              │
│  NEW: UiLoggingExtensions (Static Class - Presentation.Shared)               │
│  ├── LogRenderStart(ILogger, string) : IDisposable                           │
│  ├── LogRenderComplete(ILogger, string, TimeSpan) : void                     │
│  ├── LogRenderError(ILogger, string, Exception) : void                       │
│  ├── LogStateChange<T>(ILogger, string, string, T, T) : void                 │
│  ├── LogComponentEvent(ILogger, string, string) : void                       │
│  ├── LogComponentEvent(ILogger, string, string, object) : void               │
│  └── LogFallbackTriggered(ILogger, string, FallbackType) : void              │
│                                                                              │
│  NEW: RenderErrorHandler (Static Class - Presentation.Shared)                │
│  ├── HandleRenderError(Exception, string, ILogger) : void                    │
│  ├── GetFallbackContent(string, FallbackType) : string                       │
│  ├── ShouldRetry(Exception) : bool                                           │
│  ├── GetErrorSeverity(Exception) : ErrorSeverity                             │
│  └── CreateErrorContext(Exception, string) : RenderErrorContext              │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 8.2 Base Class Updates

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                         BASE CLASS UPDATES                                   │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  UPDATED: TuiComponentBase (Presentation.Tui)                                │
│  ├── ADDED: _lastValidOutput : string? (private)                             │
│  ├── ADDED: _consecutiveErrors : int (private)                               │
│  ├── ADDED: MaxConsecutiveErrors : int = 3 (private const)                   │
│  ├── ADDED: SafeRender(Action, string?) : void (protected)                   │
│  ├── ADDED: RenderFallback(string) : void (protected virtual)                │
│  └── ADDED: OnRenderError(RenderErrorContext) : void (protected virtual)     │
│                                                                              │
│  UPDATED: GuiControlBase (Presentation.Gui)                                  │
│  ├── ADDED: _lastValidState : object? (private)                              │
│  ├── ADDED: _consecutiveErrors : int (private)                               │
│  ├── ADDED: MaxConsecutiveErrors : int = 3 (private const)                   │
│  ├── ADDED: SafeRender(Action, string?) : void (protected)                   │
│  ├── ADDED: RenderFallback(string, FallbackType) : void (protected virtual)  │
│  └── ADDED: OnRenderError(RenderErrorContext) : void (protected virtual)     │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 9. Configuration

### 9.1 No New Configuration Files

This part does not introduce new configuration files. Error handling behavior is defined through the `RenderErrorHandler` utility class with sensible defaults.

### 9.2 Logging Configuration

Logging levels should be configured through the existing logging framework (Microsoft.Extensions.Logging or similar):

```json
{
  "Logging": {
    "LogLevel": {
      "Default": "Information",
      "RuneRust.Presentation": "Debug",
      "RuneRust.Presentation.Tui": "Debug",
      "RuneRust.Presentation.Gui": "Debug"
    }
  }
}
```

---

## 10. Commands

This part does not introduce new user-facing commands. Error handling is an internal implementation detail.

---

## 11. User-Facing Changes

### 11.1 Improved Error Resilience

Users will experience improved application stability:

- Components gracefully degrade instead of crashing
- Error states show placeholder content
- Application continues functioning when individual components fail
- No visible error messages for transient issues (handled silently)

### 11.2 Visible Fallback States

When a component fails, users may see:

| Fallback | TUI Display | GUI Display |
|----------|-------------|-------------|
| Placeholder | `[ComponentName]` | Grayed-out control |
| Error | `[!ComponentName]` | Red-highlighted control |
| Empty | (nothing) | Hidden control |

---

## 12. Logging Specifications

### 12.1 Log Message Format

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                    LOG MESSAGE SPECIFICATIONS                                │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  Render Start (Trace):                                                       │
│  Template: "Render starting: {Component}"                                    │
│  Example:  [TRC] Render starting: HealthBar                                  │
│                                                                              │
│  Render Complete (Trace):                                                    │
│  Template: "Render complete: {Component} ({Duration:F2}ms)"                  │
│  Example:  [TRC] Render complete: HealthBar (0.42ms)                         │
│                                                                              │
│  Render Error (Warning):                                                     │
│  Template: "Render failed: {Component} - {Error}"                            │
│  Example:  [WRN] Render failed: HealthBar - Division by zero                 │
│                                                                              │
│  State Change (Debug):                                                       │
│  Template: "State change: {Component}.{Property}: {Old} -> {New}"            │
│  Example:  [DBG] State change: HealthBar.Value: 100 -> 75                    │
│                                                                              │
│  Component Event (Debug):                                                    │
│  Template: "Component event: {Component} - {Event}"                          │
│  Example:  [DBG] Component event: HealthBar - Activated                      │
│                                                                              │
│  Fallback Triggered (Warning):                                               │
│  Template: "Fallback triggered: {Component} using {FallbackType}"            │
│  Example:  [WRN] Fallback triggered: HealthBar using Placeholder             │
│                                                                              │
│  Error Classification (Debug/Warning/Error):                                 │
│  Templates:                                                                  │
│  - "Transient error in {Component}, will retry"                   (Debug)   │
│  - "Recoverable error in {Component}, using fallback"             (Warning) │
│  - "Permanent error in {Component}, fallback only"                (Warning) │
│  - "Critical error in {Component}, propagating"                   (Error)   │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 12.2 Structured Logging Properties

All log messages include structured properties for filtering and analysis:

| Property | Type | Description |
|----------|------|-------------|
| `Component` | string | Name of the component |
| `Duration` | double | Render duration in milliseconds |
| `Error` | string | Error message (for errors) |
| `Property` | string | Property name (for state changes) |
| `Old` | object | Previous value (for state changes) |
| `New` | object | New value (for state changes) |
| `Event` | string | Event name (for component events) |
| `FallbackType` | FallbackType | Type of fallback used |

---

## 13. Unit Testing Requirements

### 13.1 Test Categories

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                    UNIT TESTING REQUIREMENTS (~4 tests)                      │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  Category 1: SafeRender Tests (2 tests)                                      │
│  ──────────────────────────────────────                                      │
│                                                                              │
│  Test: SafeRender_SuccessfulRender_LogsCompletion                            │
│  ├── Given: Component with successful render action                          │
│  ├── When: SafeRender called                                                 │
│  ├── Then: LogRenderStart and LogRenderComplete called                       │
│  └── Then: No fallback rendered                                              │
│                                                                              │
│  Test: SafeRender_RecoverableError_RendersFallback                           │
│  ├── Given: Component with render action that throws FormatException         │
│  ├── When: SafeRender called                                                 │
│  ├── Then: LogRenderError called                                             │
│  ├── Then: RenderFallback called                                             │
│  └── Then: No exception propagated                                           │
│                                                                              │
│  Category 2: RenderErrorHandler Tests (1 test)                               │
│  ─────────────────────────────────────────────                               │
│                                                                              │
│  Test: GetErrorSeverity_ClassifiesExceptionsCorrectly                        │
│  ├── Given: Various exception types                                          │
│  ├── When: GetErrorSeverity called for each                                  │
│  └── Then: Correct severity returned:                                        │
│      ├── TimeoutException → Transient                                        │
│      ├── FormatException → Recoverable                                       │
│      ├── NullReferenceException → Permanent                                  │
│      └── OutOfMemoryException → Critical                                     │
│                                                                              │
│  Category 3: UiLoggingExtensions Tests (1 test)                              │
│  ──────────────────────────────────────────────                              │
│                                                                              │
│  Test: LogRenderStart_ReturnsDisposableScope                                 │
│  ├── Given: Mock ILogger                                                     │
│  ├── When: LogRenderStart called                                             │
│  ├── Then: IDisposable returned                                              │
│  └── Then: Trace log emitted with component name                             │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 13.2 Test File Locations

```
Tests/
├── Presentation.Shared.Tests/
│   ├── Extensions/
│   │   └── UiLoggingExtensionsTests.cs
│   └── Utilities/
│       └── RenderErrorHandlerTests.cs
├── Presentation.Tui.Tests/
│   └── Base/
│       └── TuiComponentBaseSafeRenderTests.cs
└── Presentation.Gui.Tests/
    └── Base/
        └── GuiControlBaseSafeRenderTests.cs
```

---

## 14. Use Cases

### 14.1 UC-5d-01: Handle Render Error Gracefully

```
┌─────────────────────────────────────────────────────────────────────────────┐
│  USE CASE: UC-5d-01 - Handle Render Error Gracefully                         │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  Actor: UI Component                                                         │
│  Goal: Render fallback content when primary render fails                     │
│                                                                              │
│  Preconditions:                                                              │
│  • Component extends TuiComponentBase or GuiControlBase                      │
│  • SafeRender pattern implemented                                            │
│                                                                              │
│  Main Flow:                                                                  │
│  1. Component receives render request with data                              │
│  2. Component calls SafeRender with render action                            │
│  3. Render action throws FormatException                                     │
│  4. SafeRender catches exception                                             │
│  5. SafeRender logs error at Warning level                                   │
│  6. SafeRender classifies error as Recoverable                               │
│  7. SafeRender calls RenderFallback                                          │
│  8. Component displays placeholder content                                   │
│  9. Application continues normally                                           │
│                                                                              │
│  Postconditions:                                                             │
│  • User sees placeholder instead of crash                                    │
│  • Error logged for diagnostics                                              │
│  • Application remains responsive                                            │
│                                                                              │
│  Alternative Flow (Critical Error):                                          │
│  3a. Render action throws OutOfMemoryException                               │
│  4a. SafeRender catches exception                                            │
│  5a. SafeRender logs error at Error level                                    │
│  6a. SafeRender classifies error as Critical                                 │
│  7a. SafeRender re-throws exception                                          │
│  8a. Caller handles critical error (may gracefully shutdown)                 │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 14.2 UC-5d-02: Log State Change for Diagnostics

```
┌─────────────────────────────────────────────────────────────────────────────┐
│  USE CASE: UC-5d-02 - Log State Change for Diagnostics                       │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  Actor: UI Component                                                         │
│  Goal: Log state changes for debugging                                       │
│                                                                              │
│  Preconditions:                                                              │
│  • Component extends base class with Logger                                  │
│  • UiLoggingExtensions available                                             │
│                                                                              │
│  Steps:                                                                      │
│  1. Component property value changes (e.g., health from 100 to 75)           │
│  2. Component calls Logger.LogStateChange()                                  │
│  3. Log entry created at Debug level                                         │
│  4. Log includes component name, property, old value, new value              │
│                                                                              │
│  Example Code:                                                               │
│  ┌────────────────────────────────────────────────────────────────────────┐ │
│  │ private int _health;                                                    │ │
│  │ public int Health                                                       │ │
│  │ {                                                                        │ │
│  │     get => _health;                                                      │ │
│  │     set                                                                  │ │
│  │     {                                                                    │ │
│  │         if (_health != value)                                            │ │
│  │         {                                                                │ │
│  │             Logger.LogStateChange(ComponentName, "Health", _health, val);│ │
│  │             _health = value;                                             │ │
│  │         }                                                                │ │
│  │     }                                                                    │ │
│  │ }                                                                        │ │
│  └────────────────────────────────────────────────────────────────────────┘ │
│                                                                              │
│  Postconditions:                                                             │
│  • State change logged with full context                                     │
│  • Debugging facilitated with historical state                               │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 15. Deliverable Checklist

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                         DELIVERABLE CHECKLIST                                │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  Enums                                                                       │
│  ─────                                                                       │
│  [ ] ErrorSeverity in Presentation.Shared/Enums/                             │
│  [ ] FallbackType in Presentation.Shared/Enums/                              │
│                                                                              │
│  Records                                                                     │
│  ───────                                                                     │
│  [ ] RenderErrorContext in Presentation.Shared/Models/                       │
│                                                                              │
│  Extension Classes                                                           │
│  ─────────────────                                                           │
│  [ ] UiLoggingExtensions in Presentation.Shared/Extensions/                  │
│                                                                              │
│  Utility Classes                                                             │
│  ───────────────                                                             │
│  [ ] RenderErrorHandler in Presentation.Shared/Utilities/                    │
│                                                                              │
│  Base Class Updates                                                          │
│  ──────────────────                                                          │
│  [ ] TuiComponentBase - Add SafeRender, RenderFallback, OnRenderError        │
│  [ ] GuiControlBase - Add SafeRender, RenderFallback, OnRenderError          │
│                                                                              │
│  Documentation                                                               │
│  ─────────────                                                               │
│  [ ] ErrorHandlingGuidelines.md in /docs/guidelines/                         │
│                                                                              │
│  Unit Tests                                                                  │
│  ──────────                                                                  │
│  [ ] TuiComponentBaseSafeRenderTests.cs (~1 test)                            │
│  [ ] GuiControlBaseSafeRenderTests.cs (~1 test)                              │
│  [ ] RenderErrorHandlerTests.cs (~1 test)                                    │
│  [ ] UiLoggingExtensionsTests.cs (~1 test)                                   │
│                                                                              │
│  Total: ~4 unit tests                                                        │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 16. Acceptance Criteria

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                         ACCEPTANCE CRITERIA                                  │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  SafeRender Pattern                                                          │
│  ──────────────────                                                          │
│  [ ] SafeRender implemented in TuiComponentBase                              │
│  [ ] SafeRender implemented in GuiControlBase                                │
│  [ ] Successful renders logged at Trace level                                │
│  [ ] Failed renders logged at Warning level                                  │
│  [ ] Critical errors propagated to caller                                    │
│  [ ] Transient errors retried once before fallback                           │
│                                                                              │
│  Fallback Rendering                                                          │
│  ──────────────────                                                          │
│  [ ] RenderFallback produces visible placeholder                             │
│  [ ] Fallback uses muted/neutral colors                                      │
│  [ ] Multiple fallback types supported (Empty, Placeholder, Error)           │
│  [ ] GUI controls support opacity/visibility changes                         │
│                                                                              │
│  Error Classification                                                        │
│  ────────────────────                                                        │
│  [ ] GetErrorSeverity correctly classifies exceptions                        │
│  [ ] ShouldRetry identifies transient errors                                 │
│  [ ] CreateErrorContext produces diagnostic records                          │
│                                                                              │
│  Logging Extensions                                                          │
│  ──────────────────                                                          │
│  [ ] UiLoggingExtensions created with all methods                            │
│  [ ] LogRenderStart returns IDisposable scope                                │
│  [ ] LogStateChange logs old and new values                                  │
│  [ ] LogFallbackTriggered logs fallback type                                 │
│                                                                              │
│  Error Recovery                                                              │
│  ──────────────                                                              │
│  [ ] No unhandled exceptions in UI layer                                     │
│  [ ] Consecutive error tracking prevents infinite loops                      │
│  [ ] Components recover after transient errors                               │
│                                                                              │
│  Documentation                                                               │
│  ─────────────                                                               │
│  [ ] Error handling guidelines documented                                    │
│  [ ] Logging level usage documented                                          │
│  [ ] Fallback strategies documented                                          │
│                                                                              │
│  Testing                                                                     │
│  ───────                                                                     │
│  [ ] ~4 unit tests pass                                                      │
│  [ ] All existing tests continue to pass                                     │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 17. Future Considerations

### 17.1 v0.13.5e Integration (Shared Layer)

The logging and error handling utilities will be candidates for shared layer extraction:

- `UiLoggingExtensions` can be used by both TUI and GUI
- `RenderErrorHandler` provides shared error classification
- Common fallback patterns can be extracted

### 17.2 v0.13.5f Integration (Accessibility)

Error handling may need accessibility considerations:

```csharp
// Future: Announce errors to screen reader
if (Accessibility?.IsScreenReaderActive == true)
{
    Accessibility.Announce($"{ComponentName} encountered an error");
}
```

### 17.3 Potential Enhancements

- **Error Telemetry**: Send error metrics to monitoring service
- **Error Rate Tracking**: Track error frequency per component
- **Circuit Breaker**: Disable component after too many errors
- **User Error Reporting**: Allow users to report UI issues
- **Recovery Suggestions**: Suggest user actions for common errors

---

## 18. Implementation Notes

### 18.1 Implementation Order

1. **Phase 1**: Create enums (ErrorSeverity, FallbackType)
2. **Phase 2**: Create RenderErrorContext record
3. **Phase 3**: Create RenderErrorHandler utility
4. **Phase 4**: Create UiLoggingExtensions
5. **Phase 5**: Update TuiComponentBase with SafeRender
6. **Phase 6**: Update GuiControlBase with SafeRender
7. **Phase 7**: Create documentation
8. **Phase 8**: Write and run tests

### 18.2 Thread Safety Considerations

- TUI components: Single-threaded, no special handling needed
- GUI components: SafeRender uses Dispatcher.UIThread for fallback rendering
- Logging: Assumed thread-safe (ILogger contract)

### 18.3 Performance Considerations

- Stopwatch usage adds minimal overhead (~nanoseconds)
- Logging at Trace level can be disabled in production
- Exception handling overhead only on error paths
- No allocations in success path (except logging)

---

## 19. Document Metadata

| Field | Value |
|-------|-------|
| **Document Version** | 1.0 |
| **Created** | 2026-01-16 |
| **Last Updated** | 2026-01-16 |
| **Author** | Claude |
| **Status** | Draft |
| **Related Documents** | v0.13.5-scope-breakdown.md, v0.13.5c-design-specification.md |

### Change History

| Version | Date | Author | Changes |
|---------|------|--------|---------|
| 1.0 | 2026-01-16 | Claude | Initial draft |

---

*This design specification provides a comprehensive blueprint for implementing v0.13.5d Error Handling & Logging. The SafeRender pattern and logging extensions established here ensure graceful degradation of UI components and provide diagnostic visibility for debugging and monitoring.*
