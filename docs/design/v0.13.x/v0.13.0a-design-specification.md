# v0.13.0a Design Specification: Status Effect Display

**Version:** 0.13.0a
**Parent:** v0.13.0 (Combat UI)
**Prerequisites:** v0.12.1c Complete (Achievements & Leaderboards), v0.10.0c Complete (Effect Triggers & Cleanse)
**Status:** Design Complete
**Estimated Unit Tests:** ~8

---

## Table of Contents

1. [Executive Summary](#1-executive-summary)
2. [Feature Overview](#2-feature-overview)
3. [Architecture Diagrams](#3-architecture-diagrams)
4. [Status Effect Display Component](#4-status-effect-display-component)
   - 4.1 [StatusEffectDisplay Class](#41-statuseffectdisplay-class)
   - 4.2 [Effect Icon Rendering](#42-effect-icon-rendering)
   - 4.3 [Duration Timer Display](#43-duration-timer-display)
   - 4.4 [Stack Count Display](#44-stack-count-display)
5. [Status Effect Renderer](#5-status-effect-renderer)
   - 5.1 [StatusEffectRenderer Class](#51-statuseffectrenderer-class)
   - 5.2 [Icon Mapping](#52-icon-mapping)
   - 5.3 [Color Mapping](#53-color-mapping)
6. [Effect Tooltip System](#6-effect-tooltip-system)
   - 6.1 [Tooltip Content Structure](#61-tooltip-content-structure)
   - 6.2 [Tooltip Rendering](#62-tooltip-rendering)
7. [Immunity Indicator Display](#7-immunity-indicator-display)
8. [Data Model Changes](#8-data-model-changes)
9. [Configuration File Schemas](#9-configuration-file-schemas)
10. [CombatView Integration](#10-combatview-integration)
11. [Logging Specifications](#11-logging-specifications)
12. [Unit Testing Requirements](#12-unit-testing-requirements)
13. [Use Cases](#13-use-cases)
14. [Deliverable Checklist](#14-deliverable-checklist)
15. [Acceptance Criteria](#15-acceptance-criteria)
16. [Dependencies](#16-dependencies)
17. [Future Considerations](#17-future-considerations)

---

## 1. Executive Summary

This version implements the visual presentation layer for status effects (buffs and debuffs) in combat. The status effect system logic was fully implemented in v0.10.0a-c; this version adds the UI components to display active effects on combatants. Players will see icons, duration timers, stack counts, tooltips, and immunity indicators during combat.

### Key Deliverables

| Category | Items |
|----------|-------|
| **UI Components** | `StatusEffectDisplay` |
| **Renderers** | `StatusEffectRenderer` |
| **DTOs** | `StatusEffectDisplayDto`, `EffectTooltipDto` |
| **View Updates** | `CombatView` integration |
| **Configuration** | `status-effect-display.json` |
| **Tests** | ~8 unit tests |

### Architectural Significance

This version establishes the **Combat UI Component Pattern** that will be used for all v0.13.0 sub-parts:
- UI Components receive data from services via DTOs
- Renderers handle symbol/color mapping and terminal output
- Components integrate with existing `CombatView` via defined integration points
- Configuration drives visual appearance (colors, symbols, formats)

---

## 2. Feature Overview

```
v0.13.0a Features
├── StatusEffectDisplay (UI Component)
│   ├── RenderBuffRow(effects)
│   ├── RenderDebuffRow(effects)
│   ├── UpdateDurations()
│   └── ShowTooltip(effect)
│
├── StatusEffectRenderer (Renderer)
│   ├── GetEffectIcon(definition)
│   ├── GetEffectColor(category, effectType)
│   ├── FormatDuration(turns)
│   ├── FormatStacks(count)
│   └── GetImmunityIndicator()
│
├── Effect Tooltip System
│   ├── Tooltip Content Generation
│   ├── Tooltip Positioning
│   └── Tooltip Rendering
│
├── Immunity Indicator
│   ├── Blocked Effect Display
│   └── Immunity Source Display
│
└── CombatView Integration
    ├── Sidebar Panel Placement
    ├── Turn-Based Refresh
    └── Selection-Based Tooltips
```

### Scope Verification

| Feature | Source | Included |
|---------|--------|----------|
| Buff/Debuff Icons | v0.13.0-scope-breakdown.md | Yes |
| Duration Timers | v0.13.0-scope-breakdown.md | Yes |
| Stack Count Display | v0.13.0-scope-breakdown.md | Yes |
| Effect Tooltips | v0.13.0-scope-breakdown.md | Yes |
| Immunity Indicators | v0.13.0-scope-breakdown.md | Yes |
| AoE Zone Highlighting | v0.13.0-scope-breakdown.md | No (v0.13.0b) |
| Combo Chain Indicator | v0.13.0-scope-breakdown.md | No (v0.13.0c) |

---

## 3. Architecture Diagrams

### 3.1 Layer Diagram

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                          PRESENTATION LAYER                                  │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  ┌─────────────────────────┐      ┌─────────────────────────┐               │
│  │     CombatView          │      │  StatusEffectDisplay    │               │
│  │     (existing)          │◄────▶│  (NEW)                  │               │
│  ├─────────────────────────┤      ├─────────────────────────┤               │
│  │ - RenderCombatState()   │      │ - RenderBuffRow()       │               │
│  │ - HandleSelection()     │      │ - RenderDebuffRow()     │               │
│  │ - IntegrateComponents() │      │ - ShowTooltip()         │               │
│  └─────────────────────────┘      │ - UpdateDurations()     │               │
│                                    └───────────┬─────────────┘               │
│                                                │                             │
│  ┌─────────────────────────┐                   │                             │
│  │  StatusEffectRenderer   │◄──────────────────┘                             │
│  │  (NEW)                  │                                                 │
│  ├─────────────────────────┤                                                 │
│  │ - GetEffectIcon()       │                                                 │
│  │ - GetEffectColor()      │                                                 │
│  │ - FormatDuration()      │                                                 │
│  │ - FormatStacks()        │                                                 │
│  └─────────────────────────┘                                                 │
│                                                                              │
└──────────────────────────────────────────────────────────────────────────────┘
                                        │
                                        ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                          APPLICATION LAYER                                   │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │                    IBuffDebuffService (existing v0.10.0)            │    │
│  ├─────────────────────────────────────────────────────────────────────┤    │
│  │ + GetActiveEffects(target) : IReadOnlyList<ActiveStatusEffect>     │    │
│  │ + GetActiveEffects(target, category) : IReadOnlyList<...>          │    │
│  │ + IsImmune(target, effectId) : bool                                │    │
│  │ + GetStackCount(target, effectId) : int                            │    │
│  │ + GetRemainingDuration(target, effectId) : int?                    │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
│                                                                              │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │                    IStatusEffectProvider (existing v0.10.0)         │    │
│  ├─────────────────────────────────────────────────────────────────────┤    │
│  │ + GetEffect(effectId) : StatusEffectDefinition?                    │    │
│  │ + GetAllEffects() : IReadOnlyList<StatusEffectDefinition>          │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
│                                                                              │
└──────────────────────────────────────────────────────────────────────────────┘
                                        │
                                        ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                            DOMAIN LAYER                                      │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  ┌─────────────────────────┐      ┌─────────────────────────┐               │
│  │ StatusEffectDefinition  │      │  ActiveStatusEffect     │               │
│  │ (existing v0.10.0)      │◄─────│  (existing v0.10.0)     │               │
│  ├─────────────────────────┤      ├─────────────────────────┤               │
│  │ + Id: string            │      │ + Id: Guid              │               │
│  │ + Name: string          │      │ + Definition: ...       │               │
│  │ + Description: string   │      │ + RemainingDuration: int│               │
│  │ + Category: EffectCat.  │      │ + Stacks: int           │               │
│  │ + DurationType: ...     │      │ + SourceId: Guid?       │               │
│  │ + IconId: string?       │      │ + SourceName: string?   │               │
│  │ + StatModifiers: list   │      │ + IsExpired: bool       │               │
│  │ + DamagePerTurn: int?   │      │ + IsActive: bool        │               │
│  │ + IsBeneficial: bool    │      └─────────────────────────┘               │
│  │ + IsHarmful: bool       │                                                 │
│  └─────────────────────────┘                                                 │
│                                                                              │
│  ┌─────────────────────────┐      ┌─────────────────────────┐               │
│  │    EffectCategory       │      │    StatusEffectType     │               │
│  │    (existing v0.10.0)   │      │    (existing v0.10.0)   │               │
│  ├─────────────────────────┤      ├─────────────────────────┤               │
│  │ - Buff                  │      │ - StatModifier          │               │
│  │ - Debuff                │      │ - DamageOverTime        │               │
│  │ - Environmental         │      │ - HealOverTime          │               │
│  └─────────────────────────┘      │ - ActionPrevention      │               │
│                                    │ - Movement              │               │
│                                    │ - Special               │               │
│                                    └─────────────────────────┘               │
│                                                                              │
└──────────────────────────────────────────────────────────────────────────────┘
```

### 3.2 Data Flow Diagram

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                    STATUS EFFECT DISPLAY DATA FLOW                           │
└─────────────────────────────────────────────────────────────────────────────┘

    Combat Turn Update
           │
           ▼
┌─────────────────────────┐
│      CombatView         │
│  RenderCombatState()    │
└───────────┬─────────────┘
            │
            │ 1. Request active effects for combatant
            ▼
┌─────────────────────────┐
│   IBuffDebuffService    │
│  GetActiveEffects()     │
└───────────┬─────────────┘
            │
            │ 2. Returns IReadOnlyList<ActiveStatusEffect>
            ▼
┌─────────────────────────┐
│  StatusEffectDisplay    │
│                         │
│  ┌───────────────────┐  │
│  │ MapToDisplayDto() │  │ 3. Transform to DTOs
│  └─────────┬─────────┘  │
│            │            │
│            ▼            │
│  ┌───────────────────┐  │
│  │ SeparateByCategory│  │ 4. Split buffs/debuffs
│  └─────────┬─────────┘  │
│            │            │
│            ▼            │
│  ┌───────────────────┐  │
│  │ RenderBuffRow()   │  │ 5. Render buff icons
│  │ RenderDebuffRow() │  │    Render debuff icons
│  └─────────┬─────────┘  │
└────────────┼────────────┘
             │
             │ 6. Call renderer for each effect
             ▼
┌─────────────────────────┐
│  StatusEffectRenderer   │
├─────────────────────────┤
│ - GetEffectIcon()       │ 7. Map effect type → icon
│ - GetEffectColor()      │ 8. Map category → color
│ - FormatDuration()      │ 9. Format "Xt" string
│ - FormatStacks()        │ 10. Format "xN" string
└───────────┬─────────────┘
            │
            │ 11. Formatted string per effect
            ▼
┌─────────────────────────┐
│    ITerminalService     │
│    Write() output       │
└─────────────────────────┘


           User Selection
                 │
                 ▼
┌─────────────────────────────────────────────────────────────────┐
│                    TOOLTIP FLOW                                  │
└─────────────────────────────────────────────────────────────────┘
                 │
                 │ User selects effect (keyboard nav)
                 ▼
┌─────────────────────────┐
│  StatusEffectDisplay    │
│  ShowTooltip(effect)    │
└───────────┬─────────────┘
            │
            │ 1. Get full definition
            ▼
┌─────────────────────────┐
│ IStatusEffectProvider   │
│ GetEffect(effectId)     │
└───────────┬─────────────┘
            │
            │ 2. Returns StatusEffectDefinition
            ▼
┌─────────────────────────┐
│ BuildTooltipDto()       │
│ - Name, Description     │
│ - Duration remaining    │
│ - Stacks & effects      │
│ - Source name           │
│ - Stat modifiers        │
└───────────┬─────────────┘
            │
            │ 3. Render tooltip panel
            ▼
┌─────────────────────────┐
│  ScreenLayout           │
│  RenderToPanel(Popup)   │
└─────────────────────────┘
```

### 3.3 Component Integration Diagram

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                          CombatView Layout                                   │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  ┌───────────────────────────────────────────┐  ┌──────────────────────┐    │
│  │              MainContent Panel            │  │   Sidebar Panel      │    │
│  │                                           │  │                      │    │
│  │  ┌─────────────────────────────────────┐  │  │ ┌──────────────────┐ │    │
│  │  │          Combat Grid                │  │  │ │  Combatant List  │ │    │
│  │  │       (CombatGridView)              │  │  │ │                  │ │    │
│  │  │                                     │  │  │ │  Player  [80/100]│ │    │
│  │  │   A  B  C  D  E  F  G  H            │  │  │ │  Goblin  [45/60] │ │    │
│  │  │ 1 .  .  .  .  .  .  .  .            │  │  │ │                  │ │    │
│  │  │ 2 .  @  .  .  .  .  .  .            │  │  │ └──────────────────┘ │    │
│  │  │ 3 .  .  .  M  .  .  .  .            │  │  │                      │    │
│  │  │ 4 .  .  .  .  .  .  .  .            │  │  │ ┌──────────────────┐ │    │
│  │  │                                     │  │  │ │ STATUS EFFECTS   │ │    │
│  │  └─────────────────────────────────────┘  │  │ │ (NEW v0.13.0a)   │ │    │
│  │                                           │  │ │                  │ │    │
│  │  ┌─────────────────────────────────────┐  │  │ │ BUFFS:           │ │    │
│  │  │          Combat Log                 │  │  │ │ [R5t] [S3x2]    │ │    │
│  │  │                                     │  │  │ │                  │ │    │
│  │  │  > Player attacks Goblin            │  │  │ │ DEBUFFS:         │ │    │
│  │  │  > Hit! 12 damage                   │  │  │ │ [P3tx3] [B2t]   │ │    │
│  │  │  > Goblin is poisoned!              │  │  │ │                  │ │    │
│  │  │                                     │  │  │ └──────────────────┘ │    │
│  │  └─────────────────────────────────────┘  │  │                      │    │
│  │                                           │  │                      │    │
│  └───────────────────────────────────────────┘  └──────────────────────┘    │
│                                                                              │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │                         Footer Panel                                 │    │
│  │  HP: 80/100  MP: 45/50  Round: 3  Turn: Player                      │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
│                                                                              │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │                         Input Panel                                  │    │
│  │  > _                                                                 │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
│                                                                              │
└──────────────────────────────────────────────────────────────────────────────┘


            Tooltip Overlay (when effect selected)
┌──────────────────────────────────────────────────────────────────────────────┐
│                                                                              │
│                          ┌────────────────────────────────┐                  │
│                          │ POISONED                       │                  │
│                          ├────────────────────────────────┤                  │
│                          │ Taking damage each turn from   │                  │
│                          │ poison.                        │                  │
│                          │                                │                  │
│                          │ Duration: 3 turns remaining    │                  │
│                          │ Stacks: 3 (max 3)              │                  │
│                          │ Damage: 1d4 poison per stack   │                  │
│                          │         (3d4 total)            │                  │
│                          │ Source: Venomous Spider        │                  │
│                          └────────────────────────────────┘                  │
│                                                                              │
└──────────────────────────────────────────────────────────────────────────────┘
```

---

## 4. Status Effect Display Component

### 4.1 StatusEffectDisplay Class

**File:** `src/Presentation/RuneAndRust.Presentation.Tui/UI/StatusEffectDisplay.cs`

```csharp
namespace RuneAndRust.Presentation.Tui.UI;

/// <summary>
/// UI component for displaying active status effects on a combatant.
/// Shows buff and debuff icons with duration timers and stack counts.
/// </summary>
public class StatusEffectDisplay
{
    private readonly ITerminalService _terminal;
    private readonly StatusEffectRenderer _renderer;
    private readonly IStatusEffectProvider _effectProvider;
    private readonly ILogger<StatusEffectDisplay> _logger;

    private IReadOnlyList<StatusEffectDisplayDto> _currentBuffs = [];
    private IReadOnlyList<StatusEffectDisplayDto> _currentDebuffs = [];
    private int _selectedIndex = -1;
    private bool _isBuffSelected = true;

    /// <summary>Maximum effects to display per row.</summary>
    private const int MaxEffectsPerRow = 6;

    public StatusEffectDisplay(
        ITerminalService terminal,
        StatusEffectRenderer renderer,
        IStatusEffectProvider effectProvider,
        ILogger<StatusEffectDisplay> logger)
    {
        _terminal = terminal;
        _renderer = renderer;
        _effectProvider = effectProvider;
        _logger = logger;
    }

    /// <summary>
    /// Renders buffs in a single row.
    /// </summary>
    /// <param name="buffs">Active buff effects to display.</param>
    /// <returns>Formatted string for the buff row.</returns>
    public string RenderBuffRow(IReadOnlyList<ActiveStatusEffect> buffs)
    {
        _currentBuffs = MapToDisplayDtos(buffs);

        if (_currentBuffs.Count == 0)
        {
            return "BUFFS: (none)";
        }

        var effectStrings = _currentBuffs
            .Take(MaxEffectsPerRow)
            .Select((dto, index) => FormatEffectIcon(dto, isSelected: _isBuffSelected && index == _selectedIndex));

        var row = $"BUFFS: {string.Join(" ", effectStrings)}";

        if (_currentBuffs.Count > MaxEffectsPerRow)
        {
            row += $" (+{_currentBuffs.Count - MaxEffectsPerRow})";
        }

        _logger.LogDebug("Rendered {Count} buffs", _currentBuffs.Count);
        return row;
    }

    /// <summary>
    /// Renders debuffs in a single row.
    /// </summary>
    /// <param name="debuffs">Active debuff effects to display.</param>
    /// <returns>Formatted string for the debuff row.</returns>
    public string RenderDebuffRow(IReadOnlyList<ActiveStatusEffect> debuffs)
    {
        _currentDebuffs = MapToDisplayDtos(debuffs);

        if (_currentDebuffs.Count == 0)
        {
            return "DEBUFFS: (none)";
        }

        var effectStrings = _currentDebuffs
            .Take(MaxEffectsPerRow)
            .Select((dto, index) => FormatEffectIcon(dto, isSelected: !_isBuffSelected && index == _selectedIndex));

        var row = $"DEBUFFS: {string.Join(" ", effectStrings)}";

        if (_currentDebuffs.Count > MaxEffectsPerRow)
        {
            row += $" (+{_currentDebuffs.Count - MaxEffectsPerRow})";
        }

        _logger.LogDebug("Rendered {Count} debuffs", _currentDebuffs.Count);
        return row;
    }

    /// <summary>
    /// Renders all status effects for a combatant.
    /// </summary>
    /// <param name="effects">All active effects on the combatant.</param>
    /// <returns>List of formatted lines for display.</returns>
    public IReadOnlyList<string> RenderAll(IReadOnlyList<ActiveStatusEffect> effects)
    {
        var buffs = effects.Where(e => e.Definition.IsBeneficial).ToList();
        var debuffs = effects.Where(e => e.Definition.IsHarmful).ToList();

        return new List<string>
        {
            RenderBuffRow(buffs),
            RenderDebuffRow(debuffs)
        };
    }

    /// <summary>
    /// Updates duration display for all tracked effects.
    /// Called at the start of each turn.
    /// </summary>
    public void UpdateDurations()
    {
        // Durations are read fresh from ActiveStatusEffect each render
        // This method signals that a refresh is needed
        _logger.LogDebug("Duration update signaled");
    }

    /// <summary>
    /// Shows detailed tooltip for the specified effect.
    /// </summary>
    /// <param name="effect">The active effect to show details for.</param>
    /// <returns>Tooltip content as a list of lines.</returns>
    public IReadOnlyList<string> ShowTooltip(ActiveStatusEffect effect)
    {
        var definition = effect.Definition;

        var tooltip = new EffectTooltipDto
        {
            Name = definition.Name,
            Description = definition.Description,
            Category = definition.Category,
            RemainingDuration = effect.RemainingDuration,
            DurationType = definition.DurationType,
            CurrentStacks = effect.Stacks,
            MaxStacks = definition.MaxStacks,
            DamagePerTurn = definition.DamagePerTurn,
            DamageType = definition.DamageType,
            HealingPerTurn = definition.HealingPerTurn,
            StatModifiers = definition.StatModifiers.ToList(),
            SourceName = effect.SourceName
        };

        _logger.LogDebug("Showing tooltip for effect {EffectName}", definition.Name);
        return _renderer.RenderTooltip(tooltip);
    }

    /// <summary>
    /// Navigates selection to the next effect.
    /// </summary>
    public void SelectNext()
    {
        var currentList = _isBuffSelected ? _currentBuffs : _currentDebuffs;

        if (currentList.Count == 0)
        {
            // Try switching to other list
            _isBuffSelected = !_isBuffSelected;
            currentList = _isBuffSelected ? _currentBuffs : _currentDebuffs;
            if (currentList.Count == 0)
            {
                _selectedIndex = -1;
                return;
            }
            _selectedIndex = 0;
            return;
        }

        _selectedIndex++;
        if (_selectedIndex >= Math.Min(currentList.Count, MaxEffectsPerRow))
        {
            // Move to other list or wrap
            _isBuffSelected = !_isBuffSelected;
            _selectedIndex = 0;
        }
    }

    /// <summary>
    /// Navigates selection to the previous effect.
    /// </summary>
    public void SelectPrevious()
    {
        var currentList = _isBuffSelected ? _currentBuffs : _currentDebuffs;

        if (currentList.Count == 0)
        {
            _isBuffSelected = !_isBuffSelected;
            currentList = _isBuffSelected ? _currentBuffs : _currentDebuffs;
            if (currentList.Count == 0)
            {
                _selectedIndex = -1;
                return;
            }
            _selectedIndex = Math.Min(currentList.Count, MaxEffectsPerRow) - 1;
            return;
        }

        _selectedIndex--;
        if (_selectedIndex < 0)
        {
            _isBuffSelected = !_isBuffSelected;
            currentList = _isBuffSelected ? _currentBuffs : _currentDebuffs;
            _selectedIndex = Math.Min(currentList.Count, MaxEffectsPerRow) - 1;
        }
    }

    /// <summary>
    /// Gets the currently selected effect, if any.
    /// </summary>
    /// <returns>The selected effect DTO or null.</returns>
    public StatusEffectDisplayDto? GetSelectedEffect()
    {
        if (_selectedIndex < 0) return null;

        var list = _isBuffSelected ? _currentBuffs : _currentDebuffs;
        if (_selectedIndex >= list.Count) return null;

        return list[_selectedIndex];
    }

    /// <summary>
    /// Clears the current selection.
    /// </summary>
    public void ClearSelection()
    {
        _selectedIndex = -1;
    }

    private IReadOnlyList<StatusEffectDisplayDto> MapToDisplayDtos(IReadOnlyList<ActiveStatusEffect> effects)
    {
        return effects.Select(e => new StatusEffectDisplayDto
        {
            EffectId = e.Definition.Id,
            Name = e.Definition.Name,
            Category = e.Definition.Category,
            EffectType = GetEffectType(e.Definition),
            RemainingDuration = e.RemainingDuration,
            DurationType = e.Definition.DurationType,
            CurrentStacks = e.Stacks,
            MaxStacks = e.Definition.MaxStacks,
            IconId = e.Definition.IconId,
            SourceName = e.SourceName
        }).ToList();
    }

    private StatusEffectType GetEffectType(StatusEffectDefinition def)
    {
        // Determine primary effect type from definition properties
        if (def.DamagePerTurn.HasValue && def.DamagePerTurn > 0)
            return StatusEffectType.DamageOverTime;
        if (def.HealingPerTurn.HasValue && def.HealingPerTurn > 0)
            return StatusEffectType.HealOverTime;
        if (def.PreventsActions || def.PreventsMovement || def.PreventsAbilities || def.PreventsAttacking)
            return StatusEffectType.ActionPrevention;
        if (def.StatModifiers.Any())
            return StatusEffectType.StatModifier;
        return StatusEffectType.Special;
    }

    private string FormatEffectIcon(StatusEffectDisplayDto dto, bool isSelected)
    {
        var icon = _renderer.FormatEffectDisplay(dto);
        return isSelected ? $">{icon}<" : icon;
    }
}
```

### 4.2 Effect Icon Rendering

**Icon Format:** `[XNt]` where:
- `X` = Category/type symbol (1 char)
- `N` = Stack count or modifier value (if applicable)
- `t` = Remaining turns (if turn-based duration)

**Format Examples:**

| Effect | Icon | Breakdown |
|--------|------|-----------|
| Poison (3 stacks, 5 turns) | `[P3x5t]` | P=Poison, 3=stacks, x=stack indicator, 5t=turns |
| Regeneration (5 turns) | `[R5t]` | R=Regen, 5t=turns |
| Stunned (1 turn) | `[!1t]` | !=Control, 1t=turn |
| Strength Up (+4, 3 turns) | `[+43t]` | +=Buff stat, 4=value, 3t=turns |
| Burning (2 turns) | `[F2t]` | F=Fire, 2t=turns |
| Permanent Shield | `[S]` | S=Shield, no duration |

### 4.3 Duration Timer Display

Duration formats based on `DurationType`:

| Duration Type | Format | Example |
|---------------|--------|---------|
| Turns | `Nt` | `5t` = 5 turns |
| Permanent | (none) | No suffix |
| Triggered | `?` | `?` = until triggered |
| ResourceBased | `[N]` | `[50]` = 50 resource remaining |

### 4.4 Stack Count Display

Stack display rules:

| Condition | Format | Example |
|-----------|--------|---------|
| Single stack | (hidden) | `[P5t]` |
| Multiple stacks | `Nx` prefix | `[P3x5t]` = 3 stacks |
| Max stacks | `Nx!` prefix | `[P3x!5t]` = at max |

---

## 5. Status Effect Renderer

### 5.1 StatusEffectRenderer Class

**File:** `src/Presentation/RuneAndRust.Presentation.Tui/Renderers/StatusEffectRenderer.cs`

```csharp
namespace RuneAndRust.Presentation.Tui.Renderers;

/// <summary>
/// Renders status effect icons, colors, and formatted text.
/// Handles mapping from effect data to visual representation.
/// </summary>
public class StatusEffectRenderer
{
    private readonly ITerminalService _terminal;
    private readonly StatusEffectDisplayConfig _config;

    public StatusEffectRenderer(
        ITerminalService terminal,
        IOptions<StatusEffectDisplayConfig> config)
    {
        _terminal = terminal;
        _config = config.Value;
    }

    /// <summary>
    /// Gets the icon character for an effect type.
    /// </summary>
    /// <param name="effectType">The type of effect.</param>
    /// <returns>Single character icon.</returns>
    public char GetEffectIcon(StatusEffectType effectType)
    {
        return effectType switch
        {
            StatusEffectType.StatModifier => _config.Icons.StatModifier,
            StatusEffectType.DamageOverTime => _config.Icons.DamageOverTime,
            StatusEffectType.HealOverTime => _config.Icons.HealOverTime,
            StatusEffectType.ActionPrevention => _config.Icons.ActionPrevention,
            StatusEffectType.Movement => _config.Icons.Movement,
            StatusEffectType.Special => _config.Icons.Special,
            _ => '?'
        };
    }

    /// <summary>
    /// Gets the damage type icon for DoT effects.
    /// </summary>
    /// <param name="damageType">The damage type string.</param>
    /// <returns>Single character icon for the damage type.</returns>
    public char GetDamageTypeIcon(string? damageType)
    {
        if (string.IsNullOrEmpty(damageType)) return 'D';

        return damageType.ToLowerInvariant() switch
        {
            "fire" => 'F',
            "ice" or "cold" => 'I',
            "poison" => 'P',
            "lightning" or "electric" => 'L',
            "acid" => 'A',
            "necrotic" => 'N',
            "bleed" or "bleeding" => 'B',
            _ => 'D'
        };
    }

    /// <summary>
    /// Gets the console color for an effect category.
    /// </summary>
    /// <param name="category">The effect category.</param>
    /// <returns>Console color for rendering.</returns>
    public ConsoleColor GetEffectColor(EffectCategory category)
    {
        return category switch
        {
            EffectCategory.Buff => _config.Colors.Buff,
            EffectCategory.Debuff => _config.Colors.Debuff,
            EffectCategory.Environmental => _config.Colors.Environmental,
            _ => ConsoleColor.Gray
        };
    }

    /// <summary>
    /// Gets color based on remaining duration (urgency indication).
    /// </summary>
    /// <param name="remaining">Remaining turns.</param>
    /// <param name="baseColor">Base category color.</param>
    /// <returns>Color indicating urgency.</returns>
    public ConsoleColor GetDurationColor(int? remaining, ConsoleColor baseColor)
    {
        if (!remaining.HasValue) return baseColor;

        return remaining.Value switch
        {
            <= 1 => _config.Colors.ExpiringUrgent,   // About to expire
            <= 2 => _config.Colors.ExpiringSoon,     // Expiring soon
            _ => baseColor
        };
    }

    /// <summary>
    /// Formats duration for display.
    /// </summary>
    /// <param name="remaining">Remaining duration.</param>
    /// <param name="durationType">Type of duration tracking.</param>
    /// <returns>Formatted duration string.</returns>
    public string FormatDuration(int? remaining, DurationType durationType)
    {
        return durationType switch
        {
            DurationType.Turns => remaining.HasValue ? $"{remaining}t" : "",
            DurationType.Permanent => "",
            DurationType.Triggered => "?",
            DurationType.ResourceBased => remaining.HasValue ? $"[{remaining}]" : "[?]",
            _ => ""
        };
    }

    /// <summary>
    /// Formats stack count for display.
    /// </summary>
    /// <param name="current">Current stack count.</param>
    /// <param name="max">Maximum stack count.</param>
    /// <returns>Formatted stack string.</returns>
    public string FormatStacks(int current, int max)
    {
        if (current <= 1) return "";

        var atMax = current >= max ? "!" : "";
        return $"{current}x{atMax}";
    }

    /// <summary>
    /// Gets the immunity indicator symbol.
    /// </summary>
    /// <returns>Immunity indicator string.</returns>
    public string GetImmunityIndicator()
    {
        return _terminal.SupportsUnicode ? _config.Symbols.ImmunityUnicode : _config.Symbols.ImmunityAscii;
    }

    /// <summary>
    /// Formats a complete effect display string.
    /// </summary>
    /// <param name="dto">Effect display data.</param>
    /// <returns>Formatted effect string like "[P3x5t]".</returns>
    public string FormatEffectDisplay(StatusEffectDisplayDto dto)
    {
        var icon = dto.EffectType == StatusEffectType.DamageOverTime
            ? GetDamageTypeIcon(dto.DamageType)
            : GetEffectIcon(dto.EffectType);

        var stacks = FormatStacks(dto.CurrentStacks, dto.MaxStacks);
        var duration = FormatDuration(dto.RemainingDuration, dto.DurationType);

        // Build the display: [XNxDt] format
        var content = $"{icon}{stacks}{duration}";
        return $"[{content}]";
    }

    /// <summary>
    /// Renders a tooltip for an effect.
    /// </summary>
    /// <param name="tooltip">Tooltip data.</param>
    /// <returns>List of lines for the tooltip.</returns>
    public IReadOnlyList<string> RenderTooltip(EffectTooltipDto tooltip)
    {
        var lines = new List<string>();
        var width = 36;
        var border = new string('─', width - 2);

        // Header
        lines.Add($"┌{border}┐");
        lines.Add($"│ {tooltip.Name.ToUpperInvariant().PadRight(width - 4)} │");
        lines.Add($"├{border}┤");

        // Description (word-wrapped)
        var descLines = WrapText(tooltip.Description, width - 4);
        foreach (var line in descLines)
        {
            lines.Add($"│ {line.PadRight(width - 4)} │");
        }
        lines.Add($"│{new string(' ', width - 2)}│");

        // Duration
        var durationText = tooltip.DurationType switch
        {
            DurationType.Turns => $"Duration: {tooltip.RemainingDuration} turns remaining",
            DurationType.Permanent => "Duration: Permanent",
            DurationType.Triggered => "Duration: Until triggered",
            DurationType.ResourceBased => $"Resource: {tooltip.RemainingDuration} remaining",
            _ => ""
        };
        if (!string.IsNullOrEmpty(durationText))
        {
            lines.Add($"│ {durationText.PadRight(width - 4)} │");
        }

        // Stacks
        if (tooltip.MaxStacks > 1)
        {
            var stackText = $"Stacks: {tooltip.CurrentStacks} / {tooltip.MaxStacks}";
            if (tooltip.CurrentStacks >= tooltip.MaxStacks)
            {
                stackText += " (MAX)";
            }
            lines.Add($"│ {stackText.PadRight(width - 4)} │");
        }

        // Damage/Healing per turn
        if (tooltip.DamagePerTurn.HasValue && tooltip.DamagePerTurn > 0)
        {
            var dmgText = $"Damage: {tooltip.DamagePerTurn} {tooltip.DamageType ?? "damage"} per turn";
            if (tooltip.CurrentStacks > 1)
            {
                var total = tooltip.DamagePerTurn.Value * tooltip.CurrentStacks;
                dmgText = $"Damage: {tooltip.DamagePerTurn} {tooltip.DamageType ?? ""}/turn x{tooltip.CurrentStacks} = {total}";
            }
            lines.Add($"│ {dmgText.PadRight(width - 4)} │");
        }

        if (tooltip.HealingPerTurn.HasValue && tooltip.HealingPerTurn > 0)
        {
            var healText = $"Healing: {tooltip.HealingPerTurn} per turn";
            lines.Add($"│ {healText.PadRight(width - 4)} │");
        }

        // Stat modifiers
        if (tooltip.StatModifiers?.Count > 0)
        {
            lines.Add($"│ {"Stat Changes:".PadRight(width - 4)} │");
            foreach (var mod in tooltip.StatModifiers.Take(4))
            {
                var modText = FormatStatModifier(mod, tooltip.CurrentStacks);
                lines.Add($"│   {modText.PadRight(width - 6)} │");
            }
            if (tooltip.StatModifiers.Count > 4)
            {
                lines.Add($"│   {"...".PadRight(width - 6)} │");
            }
        }

        // Source
        if (!string.IsNullOrEmpty(tooltip.SourceName))
        {
            lines.Add($"│{new string(' ', width - 2)}│");
            lines.Add($"│ {"Source: " + tooltip.SourceName,-width + 4} │");
        }

        // Footer
        lines.Add($"└{border}┘");

        return lines;
    }

    private string FormatStatModifier(StatModifier mod, int stacks)
    {
        var effectiveValue = mod.ModifierType switch
        {
            StatModifierType.Flat => (int)(mod.Value * stacks),
            StatModifierType.Percentage => (int)(mod.Value * 100),
            _ => (int)mod.Value
        };

        var sign = effectiveValue >= 0 ? "+" : "";
        var suffix = mod.ModifierType == StatModifierType.Percentage ? "%" : "";

        return $"{sign}{effectiveValue}{suffix} {mod.StatId}";
    }

    private IReadOnlyList<string> WrapText(string text, int maxWidth)
    {
        var lines = new List<string>();
        var words = text.Split(' ');
        var currentLine = "";

        foreach (var word in words)
        {
            if (currentLine.Length + word.Length + 1 <= maxWidth)
            {
                currentLine += (currentLine.Length > 0 ? " " : "") + word;
            }
            else
            {
                if (currentLine.Length > 0)
                {
                    lines.Add(currentLine);
                }
                currentLine = word;
            }
        }

        if (currentLine.Length > 0)
        {
            lines.Add(currentLine);
        }

        return lines;
    }
}
```

### 5.2 Icon Mapping

**File:** (Part of configuration)

| Effect Type | Unicode | ASCII | Description |
|-------------|---------|-------|-------------|
| StatModifier | `±` | `+` | Stat buffs/debuffs |
| DamageOverTime | `☠` | `D` | DoT effects (uses damage type icon) |
| HealOverTime | `♥` | `H` | Regeneration/healing |
| ActionPrevention | `!` | `!` | Stun/freeze/silence |
| Movement | `→` | `>` | Haste/slow |
| Special | `★` | `*` | Unique effects |

**Damage Type Icons:**

| Damage Type | Icon | Description |
|-------------|------|-------------|
| Fire | `F` | Burning effects |
| Ice/Cold | `I` | Freezing effects |
| Poison | `P` | Poison effects |
| Lightning | `L` | Electric effects |
| Acid | `A` | Corrosive effects |
| Necrotic | `N` | Death/decay effects |
| Bleed | `B` | Bleeding effects |

### 5.3 Color Mapping

| Category | Color | RGB (approx) |
|----------|-------|--------------|
| Buff | Green | `ConsoleColor.Green` |
| Debuff | Red | `ConsoleColor.Red` |
| Environmental | Cyan | `ConsoleColor.Cyan` |
| Expiring Soon (2t) | Yellow | `ConsoleColor.Yellow` |
| Expiring Urgent (1t) | DarkRed | `ConsoleColor.DarkRed` |

---

## 6. Effect Tooltip System

### 6.1 Tooltip Content Structure

**File:** `src/Presentation/RuneAndRust.Presentation.Tui/DTOs/EffectTooltipDto.cs`

```csharp
namespace RuneAndRust.Presentation.Tui.DTOs;

/// <summary>
/// Data transfer object for effect tooltip content.
/// </summary>
public record EffectTooltipDto
{
    /// <summary>Effect display name.</summary>
    public required string Name { get; init; }

    /// <summary>Effect description text.</summary>
    public required string Description { get; init; }

    /// <summary>Effect category (Buff/Debuff/Environmental).</summary>
    public required EffectCategory Category { get; init; }

    /// <summary>Remaining duration (turns or resource).</summary>
    public int? RemainingDuration { get; init; }

    /// <summary>Type of duration tracking.</summary>
    public required DurationType DurationType { get; init; }

    /// <summary>Current stack count.</summary>
    public int CurrentStacks { get; init; } = 1;

    /// <summary>Maximum stack count.</summary>
    public int MaxStacks { get; init; } = 1;

    /// <summary>Damage dealt per turn (for DoT).</summary>
    public int? DamagePerTurn { get; init; }

    /// <summary>Damage type for DoT effects.</summary>
    public string? DamageType { get; init; }

    /// <summary>Healing per turn (for HoT).</summary>
    public int? HealingPerTurn { get; init; }

    /// <summary>List of stat modifiers applied.</summary>
    public IReadOnlyList<StatModifier>? StatModifiers { get; init; }

    /// <summary>Name of the entity that applied this effect.</summary>
    public string? SourceName { get; init; }
}
```

### 6.2 Tooltip Rendering

**Display Example:**

```
┌──────────────────────────────────┐
│ POISONED                         │
├──────────────────────────────────┤
│ Taking damage each turn from     │
│ poison.                          │
│                                  │
│ Duration: 3 turns remaining      │
│ Stacks: 3 / 3 (MAX)              │
│ Damage: 1d4 poison/turn x3 = 3d4 │
│                                  │
│ Source: Venomous Spider          │
└──────────────────────────────────┘
```

**Stat Modifier Tooltip Example:**

```
┌──────────────────────────────────┐
│ BLESSED                          │
├──────────────────────────────────┤
│ Divine favor grants bonuses to   │
│ all saving throws.               │
│                                  │
│ Duration: 8 turns remaining      │
│ Stat Changes:                    │
│   +2 fortitudeSave               │
│   +2 reflexSave                  │
│   +2 willSave                    │
│                                  │
│ Source: Cleric                   │
└──────────────────────────────────┘
```

---

## 7. Immunity Indicator Display

### 7.1 Immunity Display Behavior

When an effect application is blocked due to immunity:

1. Show immunity indicator (`IMMUNE` or shield icon)
2. Display the blocked effect name
3. Show source of immunity (if known)

**File:** (Part of StatusEffectDisplay)

```csharp
/// <summary>
/// Renders an immunity indicator when an effect is blocked.
/// </summary>
/// <param name="effectName">Name of the blocked effect.</param>
/// <param name="immunitySource">Source granting immunity (optional).</param>
/// <returns>Formatted immunity message.</returns>
public string RenderImmunityIndicator(string effectName, string? immunitySource = null)
{
    var indicator = _renderer.GetImmunityIndicator();
    var message = $"{indicator} IMMUNE to {effectName}";

    if (!string.IsNullOrEmpty(immunitySource))
    {
        message += $" (from {immunitySource})";
    }

    return message;
}
```

### 7.2 Immunity Visual Style

| Terminal | Display | Example |
|----------|---------|---------|
| Unicode | `🛡 IMMUNE to Poison` | Shield emoji prefix |
| ASCII | `[X] IMMUNE to Poison` | Bracketed X prefix |

---

## 8. Data Model Changes

### 8.1 New DTOs

**File:** `src/Presentation/RuneAndRust.Presentation.Tui/DTOs/StatusEffectDisplayDto.cs`

```csharp
namespace RuneAndRust.Presentation.Tui.DTOs;

/// <summary>
/// Data transfer object for status effect display.
/// Contains all information needed to render an effect icon.
/// </summary>
public record StatusEffectDisplayDto
{
    /// <summary>Effect definition ID.</summary>
    public required string EffectId { get; init; }

    /// <summary>Effect display name.</summary>
    public required string Name { get; init; }

    /// <summary>Effect category (Buff/Debuff/Environmental).</summary>
    public required EffectCategory Category { get; init; }

    /// <summary>Primary effect type for icon selection.</summary>
    public required StatusEffectType EffectType { get; init; }

    /// <summary>Remaining duration (null if permanent).</summary>
    public int? RemainingDuration { get; init; }

    /// <summary>Duration type for formatting.</summary>
    public required DurationType DurationType { get; init; }

    /// <summary>Current stack count.</summary>
    public int CurrentStacks { get; init; } = 1;

    /// <summary>Maximum stack count.</summary>
    public int MaxStacks { get; init; } = 1;

    /// <summary>Damage type for DoT effects.</summary>
    public string? DamageType { get; init; }

    /// <summary>Icon identifier from definition.</summary>
    public string? IconId { get; init; }

    /// <summary>Name of effect source.</summary>
    public string? SourceName { get; init; }
}
```

### 8.2 Entity Summary Table

| Entity | Layer | New? | Description |
|--------|-------|------|-------------|
| `StatusEffectDisplayDto` | Presentation | NEW | Icon display data |
| `EffectTooltipDto` | Presentation | NEW | Tooltip content data |
| `StatusEffectDisplayConfig` | Presentation | NEW | Visual configuration |
| `StatusEffectDisplay` | Presentation | NEW | UI component |
| `StatusEffectRenderer` | Presentation | NEW | Rendering logic |

---

## 9. Configuration File Schemas

### 9.1 status-effect-display.json

**File:** `config/status-effect-display.json`

```json
{
  "$schema": "./schemas/status-effect-display.schema.json",
  "icons": {
    "statModifier": "+",
    "damageOverTime": "D",
    "healOverTime": "H",
    "actionPrevention": "!",
    "movement": ">",
    "special": "*"
  },
  "colors": {
    "buff": "Green",
    "debuff": "Red",
    "environmental": "Cyan",
    "expiringSoon": "Yellow",
    "expiringUrgent": "DarkRed"
  },
  "symbols": {
    "immunityUnicode": "🛡",
    "immunityAscii": "[X]",
    "stackIndicator": "x",
    "maxStackIndicator": "!",
    "turnSuffix": "t"
  },
  "display": {
    "maxEffectsPerRow": 6,
    "tooltipWidth": 36,
    "showSourceInTooltip": true,
    "showStacksWhenSingle": false
  }
}
```

### 9.2 Configuration Schema

**File:** `config/schemas/status-effect-display.schema.json`

```json
{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "title": "Status Effect Display Configuration",
  "type": "object",
  "properties": {
    "icons": {
      "type": "object",
      "properties": {
        "statModifier": { "type": "string", "maxLength": 1 },
        "damageOverTime": { "type": "string", "maxLength": 1 },
        "healOverTime": { "type": "string", "maxLength": 1 },
        "actionPrevention": { "type": "string", "maxLength": 1 },
        "movement": { "type": "string", "maxLength": 1 },
        "special": { "type": "string", "maxLength": 1 }
      },
      "required": ["statModifier", "damageOverTime", "healOverTime", "actionPrevention", "movement", "special"]
    },
    "colors": {
      "type": "object",
      "properties": {
        "buff": { "type": "string" },
        "debuff": { "type": "string" },
        "environmental": { "type": "string" },
        "expiringSoon": { "type": "string" },
        "expiringUrgent": { "type": "string" }
      },
      "required": ["buff", "debuff", "environmental", "expiringSoon", "expiringUrgent"]
    },
    "symbols": {
      "type": "object",
      "properties": {
        "immunityUnicode": { "type": "string" },
        "immunityAscii": { "type": "string" },
        "stackIndicator": { "type": "string", "maxLength": 1 },
        "maxStackIndicator": { "type": "string", "maxLength": 1 },
        "turnSuffix": { "type": "string", "maxLength": 1 }
      },
      "required": ["immunityUnicode", "immunityAscii", "stackIndicator", "maxStackIndicator", "turnSuffix"]
    },
    "display": {
      "type": "object",
      "properties": {
        "maxEffectsPerRow": { "type": "integer", "minimum": 1, "maximum": 10 },
        "tooltipWidth": { "type": "integer", "minimum": 20, "maximum": 60 },
        "showSourceInTooltip": { "type": "boolean" },
        "showStacksWhenSingle": { "type": "boolean" }
      },
      "required": ["maxEffectsPerRow", "tooltipWidth", "showSourceInTooltip", "showStacksWhenSingle"]
    }
  },
  "required": ["icons", "colors", "symbols", "display"]
}
```

### 9.3 Configuration Class

**File:** `src/Presentation/RuneAndRust.Presentation.Tui/Configuration/StatusEffectDisplayConfig.cs`

```csharp
namespace RuneAndRust.Presentation.Tui.Configuration;

/// <summary>
/// Configuration for status effect display visuals.
/// </summary>
public record StatusEffectDisplayConfig
{
    /// <summary>Icon characters for effect types.</summary>
    public required IconConfig Icons { get; init; }

    /// <summary>Colors for effect categories.</summary>
    public required ColorConfig Colors { get; init; }

    /// <summary>Symbol characters for indicators.</summary>
    public required SymbolConfig Symbols { get; init; }

    /// <summary>Display behavior settings.</summary>
    public required DisplayConfig Display { get; init; }

    public static StatusEffectDisplayConfig CreateDefault() => new()
    {
        Icons = new IconConfig
        {
            StatModifier = '+',
            DamageOverTime = 'D',
            HealOverTime = 'H',
            ActionPrevention = '!',
            Movement = '>',
            Special = '*'
        },
        Colors = new ColorConfig
        {
            Buff = ConsoleColor.Green,
            Debuff = ConsoleColor.Red,
            Environmental = ConsoleColor.Cyan,
            ExpiringSoon = ConsoleColor.Yellow,
            ExpiringUrgent = ConsoleColor.DarkRed
        },
        Symbols = new SymbolConfig
        {
            ImmunityUnicode = "🛡",
            ImmunityAscii = "[X]",
            StackIndicator = 'x',
            MaxStackIndicator = '!',
            TurnSuffix = 't'
        },
        Display = new DisplayConfig
        {
            MaxEffectsPerRow = 6,
            TooltipWidth = 36,
            ShowSourceInTooltip = true,
            ShowStacksWhenSingle = false
        }
    };
}

public record IconConfig
{
    public char StatModifier { get; init; }
    public char DamageOverTime { get; init; }
    public char HealOverTime { get; init; }
    public char ActionPrevention { get; init; }
    public char Movement { get; init; }
    public char Special { get; init; }
}

public record ColorConfig
{
    public ConsoleColor Buff { get; init; }
    public ConsoleColor Debuff { get; init; }
    public ConsoleColor Environmental { get; init; }
    public ConsoleColor ExpiringSoon { get; init; }
    public ConsoleColor ExpiringUrgent { get; init; }
}

public record SymbolConfig
{
    public string ImmunityUnicode { get; init; } = "🛡";
    public string ImmunityAscii { get; init; } = "[X]";
    public char StackIndicator { get; init; }
    public char MaxStackIndicator { get; init; }
    public char TurnSuffix { get; init; }
}

public record DisplayConfig
{
    public int MaxEffectsPerRow { get; init; }
    public int TooltipWidth { get; init; }
    public bool ShowSourceInTooltip { get; init; }
    public bool ShowStacksWhenSingle { get; init; }
}
```

---

## 10. CombatView Integration

### 10.1 Integration Points

**File:** `src/Presentation/RuneAndRust.Presentation.Tui/Views/GameView.cs` (modifications)

```csharp
// Add to GameView class:

private readonly StatusEffectDisplay _statusEffectDisplay;

// In RenderCombatState method, after combatant list:
private async Task RenderStatusEffectsAsync(IEffectTarget combatant, CancellationToken ct)
{
    var effects = _buffDebuffService.GetActiveEffects(combatant);
    var lines = _statusEffectDisplay.RenderAll(effects);

    // Render to sidebar panel below combatant list
    _layout.RenderToPanel(PanelPosition.Sidebar, lines, startLine: GetStatusEffectStartLine());
}

// Handle effect selection for tooltips
private void HandleEffectSelection(ConsoleKeyInfo key)
{
    switch (key.Key)
    {
        case ConsoleKey.Tab:
            _statusEffectDisplay.SelectNext();
            ShowSelectedEffectTooltip();
            break;
        case ConsoleKey.Escape:
            _statusEffectDisplay.ClearSelection();
            HideTooltip();
            break;
    }
}

private void ShowSelectedEffectTooltip()
{
    var selected = _statusEffectDisplay.GetSelectedEffect();
    if (selected == null)
    {
        HideTooltip();
        return;
    }

    // Get full effect for tooltip
    var activeEffect = GetActiveEffectById(selected.EffectId);
    if (activeEffect == null) return;

    var tooltipLines = _statusEffectDisplay.ShowTooltip(activeEffect);
    _layout.RenderToPanel(PanelPosition.Popup, tooltipLines);
}
```

### 10.2 Keyboard Navigation

| Key | Action |
|-----|--------|
| `Tab` | Select next effect |
| `Shift+Tab` | Select previous effect |
| `Enter` | Show tooltip for selected |
| `Escape` | Clear selection / hide tooltip |

### 10.3 Refresh Triggers

| Event | Action |
|-------|--------|
| Turn Start | Call `UpdateDurations()`, re-render |
| Effect Applied | Re-render effect rows |
| Effect Removed | Re-render effect rows |
| Effect Expired | Re-render effect rows |

---

## 11. Logging Specifications

### Log Levels by Component

| Component | Level | Events |
|-----------|-------|--------|
| `StatusEffectDisplay` | Information | Effect rows rendered |
| `StatusEffectDisplay` | Debug | Individual effect rendering, selection changes |
| `StatusEffectDisplay` | Warning | Effect not found for tooltip |
| `StatusEffectRenderer` | Debug | Icon/color mapping, format generation |
| `StatusEffectRenderer` | Warning | Unknown effect type or damage type |

### Log Message Examples

```
[INF] StatusEffectDisplay: Rendered status effects for Player (3 buffs, 2 debuffs)
[DBG] StatusEffectDisplay: Rendered buff row with 3 effects
[DBG] StatusEffectDisplay: Showing tooltip for effect Poisoned
[DBG] StatusEffectRenderer: Mapped DamageOverTime (poison) to icon 'P' color Red
[WRN] StatusEffectRenderer: Unknown damage type 'chaos', using default icon
```

---

## 12. Unit Testing Requirements

### Test Count by Feature

| Feature | Test Count |
|---------|------------|
| StatusEffectDisplay.RenderBuffRow | 2 |
| StatusEffectDisplay.RenderDebuffRow | 1 |
| StatusEffectDisplay.ShowTooltip | 1 |
| StatusEffectRenderer.FormatEffectDisplay | 2 |
| StatusEffectRenderer.GetEffectIcon | 1 |
| StatusEffectRenderer.FormatDuration | 1 |
| **Total** | **~8** |

### Test Specifications

**File:** `tests/RuneAndRust.Presentation.Tui.Tests/UI/StatusEffectDisplayTests.cs`

```csharp
[TestFixture]
public class StatusEffectDisplayTests
{
    [Test]
    public void RenderBuffRow_WithNoBuffs_ReturnsNoneMessage();

    [Test]
    public void RenderBuffRow_WithMultipleBuffs_FormatsCorrectly();

    [Test]
    public void RenderDebuffRow_WithDebuffs_FormatsWithDebuffIcons();

    [Test]
    public void ShowTooltip_WithStackingEffect_ShowsStackInfo();
}
```

**File:** `tests/RuneAndRust.Presentation.Tui.Tests/Renderers/StatusEffectRendererTests.cs`

```csharp
[TestFixture]
public class StatusEffectRendererTests
{
    [Test]
    public void FormatEffectDisplay_DoTEffect_UsesCorrectIcon();

    [Test]
    public void FormatEffectDisplay_WithStacks_IncludesStackCount();

    [Test]
    public void GetEffectIcon_AllTypes_ReturnsMappedCharacter();

    [Test]
    public void FormatDuration_TurnBased_AppendsTurnSuffix();
}
```

---

## 13. Use Cases

### UC-001: View Active Status Effects
**Actor:** Player
**Flow:** Combat begins → Player views sidebar → Status effect rows show buffs/debuffs → Icons display with duration and stacks

### UC-002: Inspect Effect Details
**Actor:** Player
**Flow:** Player presses Tab → Effect is selected → Press Enter → Tooltip appears with full details → Press Escape → Tooltip closes

### UC-003: Monitor Effect Duration
**Actor:** Player
**Flow:** Effect has 2 turns remaining → Duration shows `2t` in yellow → Turn passes → Duration shows `1t` in dark red → Turn passes → Effect expires and icon removed

### UC-004: View Stacking Effect
**Actor:** Player
**Flow:** Poison applied → `[P5t]` shows → Poison stacks to 3 → `[P3x5t]` shows → Tooltip shows "3 / 3 (MAX)"

### UC-005: Observe Immunity
**Actor:** Player
**Flow:** Enemy attempts to apply Stun → Player is immune → `🛡 IMMUNE to Stunned` appears in combat log → No stun icon added

---

## 14. Deliverable Checklist

### UI Components
- [ ] `StatusEffectDisplay.cs` created
- [ ] `RenderBuffRow()` implemented
- [ ] `RenderDebuffRow()` implemented
- [ ] `RenderAll()` implemented
- [ ] `ShowTooltip()` implemented
- [ ] Selection navigation implemented

### Renderers
- [ ] `StatusEffectRenderer.cs` created
- [ ] `GetEffectIcon()` implemented
- [ ] `GetEffectColor()` implemented
- [ ] `FormatDuration()` implemented
- [ ] `FormatStacks()` implemented
- [ ] `FormatEffectDisplay()` implemented
- [ ] `RenderTooltip()` implemented
- [ ] `GetImmunityIndicator()` implemented

### DTOs
- [ ] `StatusEffectDisplayDto.cs` created
- [ ] `EffectTooltipDto.cs` created

### Configuration
- [ ] `config/status-effect-display.json` created
- [ ] `config/schemas/status-effect-display.schema.json` created
- [ ] `StatusEffectDisplayConfig.cs` created

### View Integration
- [ ] `GameView` modified to integrate `StatusEffectDisplay`
- [ ] Sidebar panel rendering added
- [ ] Keyboard navigation for effect selection
- [ ] Tooltip popup rendering

### Testing
- [ ] ~8 unit tests implemented
- [ ] All tests passing

---

## 15. Acceptance Criteria

### Functional
- [ ] Buff icons display for all buff-category effects
- [ ] Debuff icons display for all debuff-category effects
- [ ] Duration timers show correct remaining turns
- [ ] Stack counts display for stacking effects (>1 stack)
- [ ] Effect tooltips show on selection via Tab + Enter
- [ ] Immunity indicators show when effects are blocked
- [ ] Environmental effects display with distinct color
- [ ] Expiring effects show warning colors (yellow at 2t, red at 1t)

### Quality
- [ ] Build succeeds with 0 errors
- [ ] Build succeeds with 0 warnings
- [ ] All ~8 unit tests pass
- [ ] Configuration file validates against schema
- [ ] XML documentation complete on all public members
- [ ] ASCII fallback works when Unicode not supported

---

## 16. Dependencies

### Required from v0.10.0x

| Type | Location | Usage in this phase |
|------|----------|---------------------|
| `IBuffDebuffService` | Application/Interfaces | Get active effects |
| `StatusEffectDefinition` | Domain/Definitions | Effect templates for display |
| `ActiveStatusEffect` | Domain/Entities | Runtime effect state |
| `EffectCategory` | Domain/Enums | Buff/Debuff categorization |
| `StatusEffectType` | Domain/Enums | Effect type icons |
| `DurationType` | Domain/Enums | Duration formatting |
| `StatModifier` | Domain/ValueObjects | Tooltip stat display |
| `IStatusEffectProvider` | Application/Interfaces | Get effect definitions |

### Required from v0.7.x-v0.8.x

| Type | Location | Usage in this phase |
|------|----------|---------------------|
| `ITerminalService` | Application/Interfaces | Terminal output |
| `ScreenLayout` | Presentation.Tui/UI | Panel rendering |
| `PanelPosition` | Presentation.Tui/UI | Panel placement |

### Provides to v0.13.0b-d

| Type | Usage |
|------|-------|
| Combat UI Component Pattern | Architecture pattern for AoE, Combo, Defense displays |
| `StatusEffectDisplayConfig` pattern | Configuration pattern for other display configs |

---

## 17. Future Considerations

### Deferred to v0.13.0b
- **AoE Zone Overlay** - Grid-based zone highlighting uses different rendering approach

### Deferred to v0.13.0c
- **Combo Chain Display** - Sequence-based display pattern differs from status effects

### Deferred to v0.13.0d
- **Defense Prompts** - Real-time timing windows require different update mechanism
- **Stance Indicator** - Single active state differs from multiple effect tracking

### Out of Scope (Future Versions)
- **Effect Animations** - Pulsing/flashing effects for expiring statuses
- **Sound Integration** - Audio cues for effect application/expiration
- **Effect History** - Log of recently expired effects

---

*Document Version: 1.0*
*Last Updated: 2026-01-16*
*Author: Claude Code*
