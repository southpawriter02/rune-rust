# v0.29.1 Testing & Validation Guide
## Muspelheim Database Schema Implementation

### Prerequisites
- .NET SDK installed
- SQLite3 command-line tool (optional, for manual inspection)
- Access to runeandrust.db database

### Automated Testing Steps

#### 1. Build Verification
```bash
cd /path/to/rune-rust
dotnet build
```
**Expected Result:** No compilation errors

#### 2. Database Initialization Test
The database tables will be created automatically when SaveRepository is first initialized. To trigger this:

```bash
# Run the game application
dotnet run --project RuneAndRust.ConsoleApp
```

The InitializeDatabase() method will:
1. Create all 6 new biome tables
2. Create 13 indices for performance
3. Seed Muspelheim biome data (1 biome, 8 room templates, 9 resources)

**Expected Log Output:**
```
[DBG] Creating Muspelheim biome system tables
[DBG] Seeding Muspelheim biome data
[INF] Muspelheim biome data seeded: 1 biome, 8 room templates, 9 resources
[INF] Muspelheim biome system tables created successfully
[INF] Database initialized successfully
```

### Manual Validation Queries

If you have SQLite3 CLI access, run these queries against runeandrust.db:

#### Test 1: Verify Muspelheim biome exists
```sql
SELECT * FROM Biomes WHERE biome_id = 4;
```
**Expected:** 1 row with biome_name = 'Muspelheim'

#### Test 2: Verify all 8 room templates inserted
```sql
SELECT COUNT(*) as template_count FROM Biome_RoomTemplates WHERE biome_id = 4;
```
**Expected:** template_count = 8

#### Test 3: Verify room template details
```sql
SELECT
    template_name,
    room_size_category,
    hazard_density,
    enemy_spawn_weight,
    resource_spawn_chance
FROM Biome_RoomTemplates
WHERE biome_id = 4
ORDER BY enemy_spawn_weight DESC;
```
**Expected:** 8 rows with varying attributes

#### Test 4: Verify at least 1 entrance template
```sql
SELECT COUNT(*) as entrance_count
FROM Biome_RoomTemplates
WHERE biome_id = 4 AND can_be_entrance = 1;
```
**Expected:** entrance_count >= 1

#### Test 5: Verify at least 1 exit template
```sql
SELECT COUNT(*) as exit_count
FROM Biome_RoomTemplates
WHERE biome_id = 4 AND can_be_exit = 1;
```
**Expected:** exit_count >= 1

#### Test 6: Verify all 9 resources inserted
```sql
SELECT COUNT(*) as resource_count FROM Biome_ResourceDrops WHERE biome_id = 4;
```
**Expected:** resource_count = 9

#### Test 7: Verify resource tier distribution
```sql
SELECT
    resource_tier,
    COUNT(*) as count
FROM Biome_ResourceDrops
WHERE biome_id = 4
GROUP BY resource_tier
ORDER BY resource_tier;
```
**Expected:**
- Tier 3: 3 resources
- Tier 4: 3 resources
- Tier 5: 3 resources

#### Test 8: Verify drop chance constraints
```sql
SELECT COUNT(*) as invalid_count
FROM Biome_ResourceDrops
WHERE biome_id = 4
  AND (base_drop_chance < 0.0 OR base_drop_chance > 1.0);
```
**Expected:** invalid_count = 0

#### Test 9: Verify boss room (Containment Breach Zone) isolation
```sql
SELECT
    template_name,
    wfc_adjacency_rules
FROM Biome_RoomTemplates
WHERE biome_id = 4
  AND template_name = 'Containment Breach Zone';
```
**Expected:** wfc_adjacency_rules contains empty "allow" array and extensive "forbid" list

#### Test 10: Verify hub room (Geothermal Control Chamber) connectivity
```sql
SELECT
    template_name,
    min_connections,
    max_connections,
    can_be_hub
FROM Biome_RoomTemplates
WHERE biome_id = 4
  AND template_name = 'Geothermal Control Chamber';
```
**Expected:** min_connections = 3, max_connections = 5, can_be_hub = 1

#### Test 11: Verify resource spawn probability distribution
```sql
SELECT
    resource_tier,
    AVG(base_drop_chance) as avg_drop_chance,
    SUM(base_drop_chance * weight) / SUM(weight) as weighted_avg
FROM Biome_ResourceDrops
WHERE biome_id = 4
GROUP BY resource_tier
ORDER BY resource_tier;
```
**Expected:**
- Tier 3: ~0.25-0.30 weighted average
- Tier 4: ~0.10 weighted average
- Tier 5: ~0.03 weighted average

#### Test 12: Verify hazard density distribution
```sql
SELECT
    hazard_density,
    COUNT(*) as count
FROM Biome_RoomTemplates
WHERE biome_id = 4
GROUP BY hazard_density
ORDER BY hazard_density;
```
**Expected:** Mix of Low (2), Medium (1), High (2), Extreme (3)

#### Test 13: Verify all indices created
```sql
SELECT name
FROM sqlite_master
WHERE type = 'index'
  AND name LIKE 'idx_biome%';
```
**Expected:** 13 index rows

#### Test 14: Verify Characters_BiomeStatus unique constraint
```sql
-- This test requires a character save to exist first
-- Attempting to insert duplicate character_id + biome_id should fail

-- Step 1: Create test character (requires valid character_id from saves table)
-- INSERT INTO Characters_BiomeStatus (character_id, biome_id) VALUES (1, 4);

-- Step 2: Attempt duplicate (should fail with UNIQUE constraint violation)
-- INSERT INTO Characters_BiomeStatus (character_id, biome_id) VALUES (1, 4);
```
**Expected:** Second insert fails with UNIQUE constraint error

### v5.0 Setting Compliance Verification

#### ASCII-Only Entity Names Check
All entity names must use only ASCII characters (no special characters like ö, ü, etc.)

**Manual Review:**
- ✅ "Muspelheim" (not "Múspellsheimr")
- ✅ "Surtur Engine Core" (not "Surt ur")
- ✅ "Jotun-Forged" in description (display name can use Jötun, DB uses Jotun)
- ✅ All room template names ASCII-compliant
- ✅ All resource names ASCII-compliant

#### Technology Language Check
All descriptions must use technological/industrial failure language, not supernatural:

**Keywords to verify present:**
- "thermal regulation failure" ✅
- "containment breach" ✅
- "geothermal" ✅
- "industrial" ✅
- "defunct thermal monitoring" ✅
- "pre-Glitch technology" ✅

**Keywords that should NOT appear:**
- "magic" ❌
- "curse" ❌
- "supernatural" ❌
- "elemental spirits" ❌

**Query to verify:**
```sql
SELECT resource_description
FROM Biome_ResourceDrops
WHERE biome_id = 4
  AND (
    resource_description LIKE '%magic%'
    OR resource_description LIKE '%curse%'
    OR resource_description LIKE '%supernatural%'
  );
```
**Expected:** 0 rows (no magical language)

### Integration Testing

#### Test Biome Data Retrieval
Create a simple C# test to verify biome data can be retrieved:

```csharp
using var connection = new SqliteConnection("Data Source=runeandrust.db");
connection.Open();

var command = connection.CreateCommand();
command.CommandText = "SELECT * FROM Biomes WHERE biome_id = 4";
using var reader = command.ExecuteReader();

if (reader.Read())
{
    Console.WriteLine($"Biome Name: {reader.GetString(reader.GetOrdinal("biome_name"))}");
    Console.WriteLine($"Min Level: {reader.GetInt32(reader.GetOrdinal("min_character_level"))}");
    Console.WriteLine($"Max Level: {reader.GetInt32(reader.GetOrdinal("max_character_level"))}");
}
```

**Expected Output:**
```
Biome Name: Muspelheim
Min Level: 7
Max Level: 12
```

### Performance Validation

#### Index Usage Check
Verify that queries use indices efficiently:

```sql
EXPLAIN QUERY PLAN
SELECT * FROM Biome_RoomTemplates WHERE biome_id = 4;
```
**Expected:** Should mention "USING INDEX idx_biome_room_templates_biome"

```sql
EXPLAIN QUERY PLAN
SELECT * FROM Biome_ResourceDrops WHERE resource_tier = 5 AND biome_id = 4;
```
**Expected:** Should use either idx_biome_resources_biome or idx_biome_resources_tier

### Success Criteria Summary

✅ All 6 tables created successfully
✅ Muspelheim biome entry inserted (biome_id: 4)
✅ All 8 room templates inserted with valid WFC rules
✅ All 9 resources inserted with correct tier/rarity/drop rates
✅ Foreign key relationships validated
✅ All 13 indices created
✅ Data integrity constraints enforced
✅ ASCII-only entity names confirmed
✅ v5.0 setting compliance verified (no magic language)
✅ No compilation errors
✅ Database initialization completes without exceptions

### Troubleshooting

#### Issue: Tables not created
**Solution:** Check that foreign keys are enabled:
```sql
PRAGMA foreign_keys = ON;
```

#### Issue: Duplicate key errors on re-run
**Solution:** INSERT OR IGNORE statements should prevent this. If errors occur, check for conflicting data.

#### Issue: Foreign key constraint failures
**Solution:** Ensure `saves` table exists before creating Characters_BiomeStatus entries.

### Next Steps After v0.29.1

Once all tests pass, proceed to:
- **v0.29.2:** Environmental Hazards & Ambient Conditions
- **v0.29.3:** Enemy Definitions & Spawn System
- **v0.29.4:** Service Implementation & Testing
