# v0.2.1a Design Specification: Codex Foundation

## Overview

**Version:** 0.2.1a
**Status:** Planning
**Focus:** Establish the core Codex system with entity model, categories, and basic discovery mechanics
**Prerequisites:** v0.2.0d (Companions), v0.1.5 (Procedural Puzzles & Secrets)
**Estimated Unit Tests:** ~30

---

## Table of Contents

1. [Executive Summary](#1-executive-summary)
2. [Feature Overview](#2-feature-overview)
3. [Architecture Diagrams](#3-architecture-diagrams)
4. [User Stories](#4-user-stories)
5. [Data Models](#5-data-models)
6. [Configuration Schemas](#6-configuration-schemas)
7. [Service Specifications](#7-service-specifications)
8. [Codex Command Flow](#8-codex-command-flow)
9. [User-Facing Changes](#9-user-facing-changes)
10. [Logging Requirements](#10-logging-requirements)
11. [Unit Test Specifications](#11-unit-test-specifications)
12. [Use Cases](#12-use-cases)
13. [Acceptance Criteria](#13-acceptance-criteria)
14. [Deliverable Checklist](#14-deliverable-checklist)
15. [Dependencies](#15-dependencies)
16. [Future Considerations](#16-future-considerations)

---

## 1. Executive Summary

This version introduces the foundational Codex system, an in-game encyclopedia that players unlock through discovery. The Codex transforms exploration and interaction from purely mechanical activities into knowledge-gathering experiences. Players discover entries by defeating monsters, examining items, exploring locations, and conversing with NPCs.

### Key Deliverables

| Category | Items |
|----------|-------|
| **Entities** | CodexEntry |
| **Definitions** | CodexEntryDefinition |
| **Value Objects** | CodexProgress, CodexUnlockCondition, CodexEntryState |
| **Enums** | CodexCategory, UnlockTriggerType |
| **Commands** | `codex`, `codex <topic>`, `codex search <term>` |
| **Services** | CodexService (ICodexService) |
| **Configuration** | codex-entries.json, codex-entries.schema.json |
| **Tests** | ~30 new unit tests |

### Architectural Significance

This version establishes the **discovery-based knowledge pattern** that will be extended throughout future versions:
- Codex entries as discoverable content gated by player actions
- Definition-based entry creation from configuration
- Category-based organization for navigation
- Foundation for lore fragments (v0.2.1b), codex hints (v0.2.1c), and UI enhancements (v0.2.1d)

---

## 2. Feature Overview

```
v0.2.1a Features
├── Codex Entry System
│   ├── CodexEntryDefinition (config-loaded templates)
│   ├── CodexEntry (player-discovered instance)
│   ├── CodexCategory enum (Bestiary, Locations, etc.)
│   └── Partial entry states (discovered vs. complete)
├── Discovery Mechanics
│   ├── UnlockTriggerType enum (Defeat, Examine, Explore, Dialogue)
│   ├── CodexUnlockCondition value object
│   ├── Discovery event integration
│   └── Automatic unlock on qualifying actions
├── Codex Commands
│   ├── codex - Open codex interface (list categories)
│   ├── codex <topic> - View specific entry
│   └── codex search <term> - Search entries
├── Progress Tracking
│   ├── CodexProgress per player
│   ├── Completion percentage per category
│   └── Total discovery progress
└── Service Layer
    ├── CodexService (entry management)
    ├── ICodexService interface
    └── Integration with existing services
```

---

## 3. Architecture Diagrams

### 3.1 Layer Diagram

```
┌─────────────────────────────────────────────────────────────────────────┐
│                         PRESENTATION LAYER                              │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  ┌─────────────────────┐  ┌─────────────────────┐  ┌────────────────┐  │
│  │   CodexHandler      │  │   InputHandler      │  │ IGameRenderer  │  │
│  │                     │  │   (updated)         │  │ (updated)      │  │
│  │ - HandleCodex()     │  │ - ParseCodexCmd()   │  │ - RenderCodex()│  │
│  │ - HandleCodexView() │  │                     │  │ - RenderEntry()│  │
│  │ - HandleCodexSearch │  │                     │  │ - RenderSearch │  │
│  └─────────┬───────────┘  └─────────┬───────────┘  └───────┬────────┘  │
│            │                        │                      │           │
└────────────┼────────────────────────┼──────────────────────┼───────────┘
             │                        │                      │
             ▼                        ▼                      ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                         APPLICATION LAYER                               │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │                         CodexService                             │   │
│  ├─────────────────────────────────────────────────────────────────┤   │
│  │ + GetCodexEntryDefinition(id) : CodexEntryDefinition?           │   │
│  │ + GetAllDefinitions() : IReadOnlyList<CodexEntryDefinition>     │   │
│  │ + GetDiscoveredEntries(playerId) : IReadOnlyList<CodexEntry>    │   │
│  │ + GetEntriesByCategory(playerId, cat) : IReadOnlyList<...>      │   │
│  │ + TryUnlockEntry(playerId, definitionId) : CodexUnlockResult    │   │
│  │ + TryUnlockByTrigger(playerId, trigger, targetId) : ...         │   │
│  │ + RevealMoreContent(playerId, entryId) : bool                   │   │
│  │ + SearchEntries(playerId, term) : IReadOnlyList<CodexEntry>     │   │
│  │ + GetProgress(playerId) : CodexProgress                         │   │
│  │ + GetCategoryProgress(playerId, cat) : (int, int)               │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │                    GameSessionService (updated)                  │   │
│  ├─────────────────────────────────────────────────────────────────┤   │
│  │ + OpenCodex() : CodexSummaryDto                                 │   │
│  │ + ViewCodexEntry(topic) : CodexEntryDto?                        │   │
│  │ + SearchCodex(term) : IReadOnlyList<CodexSearchResultDto>       │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │               CombatService / ItemService / NPCService          │   │
│  │                           (updated)                              │   │
│  ├─────────────────────────────────────────────────────────────────┤   │
│  │ // On monster defeat: notify CodexService                       │   │
│  │ // On item examine: notify CodexService                         │   │
│  │ // On room enter: notify CodexService                           │   │
│  │ // On dialogue: notify CodexService                             │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                           DOMAIN LAYER                                  │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  ENTITIES                                                               │
│  ┌────────────────────────────────────────────────────────────────┐    │
│  │                       CodexEntry                                │    │
│  ├────────────────────────────────────────────────────────────────┤    │
│  │ + Id: Guid                                                      │    │
│  │ + DefinitionId: string                                          │    │
│  │ + PlayerId: Guid                                                │    │
│  │ + Category: CodexCategory                                       │    │
│  │ + Title: string                                                 │    │
│  │ + State: CodexEntryState                                        │    │
│  │ + DiscoveredAt: DateTime                                        │    │
│  │ + RevealedSections: int                                         │    │
│  │ + TotalSections: int                                            │    │
│  │ + IsComplete: bool                                              │    │
│  └────────────────────────────────────────────────────────────────┘    │
│                                                                         │
│  DEFINITIONS                                                            │
│  ┌────────────────────────────────────────────────────────────────┐    │
│  │                   CodexEntryDefinition                          │    │
│  ├────────────────────────────────────────────────────────────────┤    │
│  │ + Id: string                                                    │    │
│  │ + Title: string                                                 │    │
│  │ + Category: CodexCategory                                       │    │
│  │ + Sections: IReadOnlyList<CodexSection>                         │    │
│  │ + UnlockConditions: IReadOnlyList<CodexUnlockCondition>         │    │
│  │ + RevealConditions: IReadOnlyList<CodexUnlockCondition>         │    │
│  │ + RelatedEntryIds: IReadOnlyList<string>                        │    │
│  │ + Tags: IReadOnlyList<string>                                   │    │
│  └────────────────────────────────────────────────────────────────┘    │
│                                                                         │
│  VALUE OBJECTS                                                          │
│  ┌────────────────────────┐  ┌────────────────────────┐                │
│  │   CodexSection         │  │  CodexUnlockCondition  │                │
│  ├────────────────────────┤  ├────────────────────────┤                │
│  │ + Title: string        │  │ + TriggerType: ...     │                │
│  │ + Content: string      │  │ + TargetId: string     │                │
│  │ + Order: int           │  │ + Count: int           │                │
│  │ + RequiresReveal: bool │  └────────────────────────┘                │
│  └────────────────────────┘                                            │
│                                                                         │
│  ┌────────────────────────┐  ┌────────────────────────┐                │
│  │    CodexProgress       │  │   CodexEntryState      │                │
│  ├────────────────────────┤  ├────────────────────────┤                │
│  │ + PlayerId: Guid       │  │ Locked                 │                │
│  │ + TotalEntries: int    │  │ Discovered             │                │
│  │ + DiscoveredCount: int │  │ Complete               │                │
│  │ + CompleteCount: int   │  └────────────────────────┘                │
│  │ + ByCategory: Dict     │                                            │
│  │ + PercentComplete: int │                                            │
│  └────────────────────────┘                                            │
│                                                                         │
│  ENUMS                                                                  │
│  ┌────────────────────────┐  ┌────────────────────────┐                │
│  │    CodexCategory       │  │   UnlockTriggerType    │                │
│  ├────────────────────────┤  ├────────────────────────┤                │
│  │ Bestiary               │  │ DefeatMonster          │                │
│  │ Locations              │  │ ExamineItem            │                │
│  │ ItemsAndArtifacts      │  │ AcquireItem            │                │
│  │ Characters             │  │ ExploreRoom            │                │
│  │ Factions               │  │ DialogueChoice         │                │
│  │ History                │  │ ReadDocument           │                │
│  │ Legends                │  │ FlagSet                │                │
│  │ CraftingKnowledge      │  └────────────────────────┘                │
│  └────────────────────────┘                                            │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                        INFRASTRUCTURE LAYER                             │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │                IConfigurationProvider (updated)                  │   │
│  ├─────────────────────────────────────────────────────────────────┤   │
│  │ + LoadCodexEntryDefinitions() : IReadOnlyList<...>              │   │
│  │ + GetCodexEntryDefinition(string id) : CodexEntryDefinition?    │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
│  Configuration Files:                                                   │
│  ├── config/codex-entries.json                                         │
│  └── config/schemas/codex-entries.schema.json                          │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

### 3.2 Discovery Flow

```
┌───────────────────┐
│   Player Action   │
│ (defeat monster,  │
│  examine item,    │
│  enter room,      │
│  dialogue choice) │
└─────────┬─────────┘
          │
          ▼
┌───────────────────┐
│ Originating       │
│ Service notifies  │
│ CodexService      │
└─────────┬─────────┘
          │
          ▼
┌───────────────────┐
│ CodexService.     │
│ TryUnlockByTrigger│
│ (trigger, targetId│
└─────────┬─────────┘
          │
          ▼
┌───────────────────┐
│ Find matching     │
│ definitions by    │
│ trigger + target  │
└─────────┬─────────┘
          │
          ▼
┌───────────────────────────────────────────────────────────────┐
│                   FOR EACH MATCHING DEFINITION                 │
├───────────────────────────────────────────────────────────────┤
│                                                                 │
│  ┌───────────────────┐                                         │
│  │ Already discovered│      ┌───────────────────┐              │
│  │ by this player?   │──YES▶│ Check reveal      │              │
│  └─────────┬─────────┘      │ conditions        │              │
│            │                └─────────┬─────────┘              │
│           NO                          │                         │
│            │                          ▼                         │
│            ▼                ┌───────────────────┐              │
│  ┌───────────────────┐      │ Reveal more       │              │
│  │ Create CodexEntry │      │ sections if       │              │
│  │ with initial      │      │ conditions met    │              │
│  │ revealed sections │      └───────────────────┘              │
│  └─────────┬─────────┘                                         │
│            │                                                    │
│            ▼                                                    │
│  ┌───────────────────┐                                         │
│  │ Set state:        │                                         │
│  │ Discovered or     │                                         │
│  │ Complete          │                                         │
│  └─────────┬─────────┘                                         │
│            │                                                    │
└────────────┼────────────────────────────────────────────────────┘
             │
             ▼
┌───────────────────┐
│ Return CodexUnlock│
│ Result with newly │
│ unlocked entries  │
└─────────┬─────────┘
          │
          ▼
┌───────────────────┐
│ Display discovery │
│ notification to   │
│ player            │
└───────────────────┘
```

### 3.3 Codex Command Flow

```
┌───────────────────┐
│   Player Input    │
│ "codex" or        │
│ "codex <topic>"   │
│ "codex search X"  │
└─────────┬─────────┘
          │
          ▼
┌───────────────────┐      ┌───────────────────┐
│   InputHandler    │─────▶│ GameSessionService│
│  ParseCodexCmd()  │      │   Codex methods   │
└───────────────────┘      └─────────┬─────────┘
                                     │
                    ┌────────────────┼────────────────┐
                    │                │                │
                    ▼                ▼                ▼
           ┌─────────────┐  ┌─────────────┐  ┌─────────────┐
           │   "codex"   │  │  "codex     │  │  "codex     │
           │  (no args)  │  │   <topic>"  │  │  search X"  │
           └──────┬──────┘  └──────┬──────┘  └──────┬──────┘
                  │                │                │
                  ▼                ▼                ▼
           ┌─────────────┐  ┌─────────────┐  ┌─────────────┐
           │ OpenCodex() │  │ ViewEntry() │  │SearchEntries│
           │ Show cats   │  │ Show entry  │  │ Show results│
           │ + progress  │  │ content     │  │             │
           └──────┬──────┘  └──────┬──────┘  └──────┬──────┘
                  │                │                │
                  └────────────────┼────────────────┘
                                   │
                                   ▼
                           ┌───────────────────┐
                           │   IGameRenderer   │
                           │  Render Codex UI  │
                           └───────────────────┘
```

---

## 4. User Stories

### US-2.1a-1: View Codex Categories
**As a** player exploring the dungeon
**I want to** see all codex categories with my progress
**So that** I know what knowledge I've gathered

**Acceptance Criteria:**
- `codex` command shows all 8 categories
- Each category shows discovered/total count
- Overall completion percentage is displayed
- Categories are listed in logical order

### US-2.1a-2: View Codex Entry
**As a** player who has discovered an entry
**I want to** view the entry's content
**So that** I can read the lore and information

**Acceptance Criteria:**
- `codex <topic>` displays the entry
- Entry shows title, category, and content sections
- Only revealed sections are shown
- Related entries are listed if available

### US-2.1a-3: Search Codex
**As a** player looking for specific information
**I want to** search my discovered entries
**So that** I can find relevant knowledge quickly

**Acceptance Criteria:**
- `codex search <term>` searches title and content
- Only discovered entries are searchable
- Results show entry title and category
- Empty search returns helpful message

### US-2.1a-4: Discover Entry by Defeating Monster
**As a** player defeating a monster
**I want to** unlock its bestiary entry
**So that** I learn about the creatures I face

**Acceptance Criteria:**
- Defeating monster unlocks basic bestiary entry
- Entry includes monster name and description
- Repeat defeats may reveal more sections
- Notification shown when entry unlocked

### US-2.1a-5: Discover Entry by Examining
**As a** player examining items or the environment
**I want to** unlock relevant codex entries
**So that** examination has knowledge value

**Acceptance Criteria:**
- Using `examine` on items can unlock entries
- Items with lore unlock Items & Artifacts entries
- Notification shown for new discoveries
- Already discovered items don't re-notify

### US-2.1a-6: Configure Codex via JSON
**As a** game designer
**I want to** define codex entries in configuration files
**So that** I can create lore without code changes

**Acceptance Criteria:**
- Entries can be defined in codex-entries.json
- All entry properties are configurable
- Schema validation catches errors
- Related entry references are validated

---

## 5. Data Models

### 5.1 CodexEntry Entity

```csharp
namespace RuneAndRust.Domain.Entities;

/// <summary>
/// Represents a player's discovered codex entry.
/// </summary>
/// <remarks>
/// CodexEntries track individual player progress on codex definitions.
/// Each player has their own set of discovered entries with varying
/// levels of revealed content based on their actions.
/// </remarks>
public class CodexEntry : IEntity
{
    /// <summary>
    /// Gets the unique identifier for this entry instance.
    /// </summary>
    public Guid Id { get; private set; }

    /// <summary>
    /// Gets the codex entry definition ID.
    /// </summary>
    /// <example>"goblin-bestiary", "iron-sword-lore"</example>
    public string DefinitionId { get; private set; } = string.Empty;

    /// <summary>
    /// Gets the player who discovered this entry.
    /// </summary>
    public Guid PlayerId { get; private set; }

    /// <summary>
    /// Gets the entry's category.
    /// </summary>
    public CodexCategory Category { get; private set; }

    /// <summary>
    /// Gets the entry's display title.
    /// </summary>
    public string Title { get; private set; } = string.Empty;

    /// <summary>
    /// Gets the current state of this entry.
    /// </summary>
    public CodexEntryState State { get; private set; }

    /// <summary>
    /// Gets when this entry was first discovered.
    /// </summary>
    public DateTime DiscoveredAt { get; private set; }

    /// <summary>
    /// Gets the number of sections revealed to the player.
    /// </summary>
    /// <remarks>
    /// Starts at the number of non-hidden sections. Increases as
    /// the player meets reveal conditions for hidden sections.
    /// </remarks>
    public int RevealedSections { get; private set; }

    /// <summary>
    /// Gets the total number of sections in this entry.
    /// </summary>
    public int TotalSections { get; private set; }

    /// <summary>
    /// Gets whether all sections have been revealed.
    /// </summary>
    public bool IsComplete => RevealedSections >= TotalSections;

    /// <summary>
    /// Private constructor for EF Core.
    /// </summary>
    private CodexEntry() { }

    /// <summary>
    /// Creates a new codex entry from a definition.
    /// </summary>
    /// <param name="definition">The entry definition.</param>
    /// <param name="playerId">The discovering player's ID.</param>
    /// <param name="initialRevealedSections">Number of sections initially visible.</param>
    /// <returns>A new CodexEntry instance.</returns>
    /// <exception cref="ArgumentNullException">Thrown if definition is null.</exception>
    public static CodexEntry Create(
        CodexEntryDefinition definition,
        Guid playerId,
        int initialRevealedSections)
    {
        ArgumentNullException.ThrowIfNull(definition);

        var totalSections = definition.Sections.Count;
        var revealed = Math.Min(initialRevealedSections, totalSections);

        return new CodexEntry
        {
            Id = Guid.NewGuid(),
            DefinitionId = definition.Id,
            PlayerId = playerId,
            Category = definition.Category,
            Title = definition.Title,
            State = revealed >= totalSections
                ? CodexEntryState.Complete
                : CodexEntryState.Discovered,
            DiscoveredAt = DateTime.UtcNow,
            RevealedSections = revealed,
            TotalSections = totalSections
        };
    }

    /// <summary>
    /// Reveals additional sections of this entry.
    /// </summary>
    /// <param name="count">Number of additional sections to reveal.</param>
    /// <returns>The number of sections actually revealed.</returns>
    public int RevealSections(int count)
    {
        var available = TotalSections - RevealedSections;
        var toReveal = Math.Min(count, available);

        RevealedSections += toReveal;

        if (IsComplete)
        {
            State = CodexEntryState.Complete;
        }

        return toReveal;
    }

    /// <summary>
    /// Marks all sections as revealed.
    /// </summary>
    public void RevealAll()
    {
        RevealedSections = TotalSections;
        State = CodexEntryState.Complete;
    }

    /// <summary>
    /// Gets the completion percentage for this entry.
    /// </summary>
    /// <returns>Percentage from 0-100.</returns>
    public int GetCompletionPercent()
    {
        if (TotalSections == 0) return 100;
        return (RevealedSections * 100) / TotalSections;
    }
}
```

### 5.2 CodexEntryState Enum

```csharp
namespace RuneAndRust.Domain.Enums;

/// <summary>
/// Represents the discovery state of a codex entry.
/// </summary>
public enum CodexEntryState
{
    /// <summary>
    /// Entry has not been discovered.
    /// </summary>
    /// <remarks>
    /// This state is implied by the absence of a CodexEntry record.
    /// </remarks>
    Locked,

    /// <summary>
    /// Entry has been discovered but not all sections revealed.
    /// </summary>
    /// <remarks>
    /// Player has partial information about this topic.
    /// </remarks>
    Discovered,

    /// <summary>
    /// All sections of the entry have been revealed.
    /// </summary>
    /// <remarks>
    /// Player has complete knowledge of this topic.
    /// </remarks>
    Complete
}
```

### 5.3 CodexCategory Enum

```csharp
namespace RuneAndRust.Domain.Enums;

/// <summary>
/// Categories for organizing codex entries.
/// </summary>
/// <remarks>
/// Categories help players navigate the codex and track
/// progress in different areas of knowledge.
/// </remarks>
public enum CodexCategory
{
    /// <summary>
    /// Monster entries with stats, weaknesses, and lore.
    /// </summary>
    /// <remarks>
    /// Unlocked by defeating or examining monsters.
    /// </remarks>
    Bestiary,

    /// <summary>
    /// Region and dungeon lore.
    /// </summary>
    /// <remarks>
    /// Unlocked by exploration and discovery.
    /// </remarks>
    Locations,

    /// <summary>
    /// Detailed item lore and artifact descriptions.
    /// </summary>
    /// <remarks>
    /// Unlocked by acquiring or examining items.
    /// </remarks>
    ItemsAndArtifacts,

    /// <summary>
    /// NPC backgrounds and histories.
    /// </summary>
    /// <remarks>
    /// Unlocked through dialogue and interaction.
    /// </remarks>
    Characters,

    /// <summary>
    /// Groups, guilds, and organizations.
    /// </summary>
    /// <remarks>
    /// Unlocked by encounters and reputation.
    /// </remarks>
    Factions,

    /// <summary>
    /// World events and timeline.
    /// </summary>
    /// <remarks>
    /// Unlocked by finding documents and talking to NPCs.
    /// </remarks>
    History,

    /// <summary>
    /// Myths, prophecies, and tales.
    /// </summary>
    /// <remarks>
    /// Pieced together from fragments found throughout the dungeon.
    /// </remarks>
    Legends,

    /// <summary>
    /// Material properties and recipe hints.
    /// </summary>
    /// <remarks>
    /// Unlocked by crafting and experimentation.
    /// </remarks>
    CraftingKnowledge
}
```

### 5.4 UnlockTriggerType Enum

```csharp
namespace RuneAndRust.Domain.Enums;

/// <summary>
/// Types of player actions that can unlock codex entries.
/// </summary>
/// <remarks>
/// Used in CodexUnlockCondition to specify what action
/// triggers the discovery of a codex entry.
/// </remarks>
public enum UnlockTriggerType
{
    /// <summary>
    /// Defeating a specific monster type.
    /// </summary>
    /// <remarks>
    /// TargetId = monster definition ID.
    /// </remarks>
    DefeatMonster,

    /// <summary>
    /// Examining an item.
    /// </summary>
    /// <remarks>
    /// TargetId = item definition ID.
    /// </remarks>
    ExamineItem,

    /// <summary>
    /// Acquiring an item (picking up or receiving).
    /// </summary>
    /// <remarks>
    /// TargetId = item definition ID.
    /// </remarks>
    AcquireItem,

    /// <summary>
    /// Entering a specific room or area.
    /// </summary>
    /// <remarks>
    /// TargetId = room definition ID or room tag.
    /// </remarks>
    ExploreRoom,

    /// <summary>
    /// Making a specific dialogue choice.
    /// </summary>
    /// <remarks>
    /// TargetId = dialogue option ID.
    /// </remarks>
    DialogueChoice,

    /// <summary>
    /// Reading a document or inscription.
    /// </summary>
    /// <remarks>
    /// TargetId = document/inscription definition ID.
    /// </remarks>
    ReadDocument,

    /// <summary>
    /// A dialogue flag being set.
    /// </summary>
    /// <remarks>
    /// TargetId = flag name.
    /// </remarks>
    FlagSet
}
```

### 5.5 CodexUnlockCondition Value Object

```csharp
namespace RuneAndRust.Domain.ValueObjects;

/// <summary>
/// Represents a condition that unlocks or reveals codex content.
/// </summary>
/// <remarks>
/// Used both for initial unlock of entries and for revealing
/// additional sections of partially discovered entries.
/// </remarks>
public readonly record struct CodexUnlockCondition
{
    /// <summary>
    /// Gets the type of trigger that activates this condition.
    /// </summary>
    public UnlockTriggerType TriggerType { get; init; }

    /// <summary>
    /// Gets the target identifier for the trigger.
    /// </summary>
    /// <remarks>
    /// Interpretation depends on TriggerType:
    /// - DefeatMonster: Monster definition ID
    /// - ExamineItem: Item definition ID
    /// - AcquireItem: Item definition ID
    /// - ExploreRoom: Room definition ID or tag
    /// - DialogueChoice: Dialogue option ID
    /// - ReadDocument: Document ID
    /// - FlagSet: Flag name
    /// </remarks>
    public string TargetId { get; init; }

    /// <summary>
    /// Gets the number of times the action must be performed.
    /// </summary>
    /// <remarks>
    /// For example, defeating 5 goblins to unlock full bestiary entry.
    /// Default is 1.
    /// </remarks>
    public int Count { get; init; }

    /// <summary>
    /// Gets the number of sections to reveal when this condition is met.
    /// </summary>
    /// <remarks>
    /// Used for progressive reveal. Default is 1.
    /// </remarks>
    public int SectionsToReveal { get; init; }

    /// <summary>
    /// Creates an unlock condition.
    /// </summary>
    public static CodexUnlockCondition Create(
        UnlockTriggerType triggerType,
        string targetId,
        int count = 1,
        int sectionsToReveal = 1)
    {
        return new CodexUnlockCondition
        {
            TriggerType = triggerType,
            TargetId = targetId,
            Count = Math.Max(1, count),
            SectionsToReveal = Math.Max(1, sectionsToReveal)
        };
    }

    /// <summary>
    /// Checks if this condition matches a trigger event.
    /// </summary>
    /// <param name="triggerType">The event trigger type.</param>
    /// <param name="targetId">The event target ID.</param>
    /// <returns>True if this condition matches.</returns>
    public bool Matches(UnlockTriggerType triggerType, string targetId)
    {
        return TriggerType == triggerType &&
               TargetId.Equals(targetId, StringComparison.OrdinalIgnoreCase);
    }
}
```

### 5.6 CodexSection Value Object

```csharp
namespace RuneAndRust.Domain.ValueObjects;

/// <summary>
/// Represents a section of content within a codex entry.
/// </summary>
/// <remarks>
/// Entries are divided into sections for progressive revelation.
/// Initial sections are shown on discovery; additional sections
/// require meeting reveal conditions.
/// </remarks>
public readonly record struct CodexSection
{
    /// <summary>
    /// Gets the section title.
    /// </summary>
    /// <remarks>
    /// May be empty for untitled content blocks.
    /// </remarks>
    /// <example>"Description", "Weaknesses", "History"</example>
    public string Title { get; init; }

    /// <summary>
    /// Gets the section content.
    /// </summary>
    /// <remarks>
    /// The main text of this section. Supports basic formatting.
    /// </remarks>
    public string Content { get; init; }

    /// <summary>
    /// Gets the display order of this section.
    /// </summary>
    /// <remarks>
    /// Lower numbers appear first. Sections are sorted by Order.
    /// </remarks>
    public int Order { get; init; }

    /// <summary>
    /// Gets whether this section requires explicit reveal.
    /// </summary>
    /// <remarks>
    /// False = shown on initial discovery.
    /// True = hidden until reveal conditions met.
    /// </remarks>
    public bool RequiresReveal { get; init; }

    /// <summary>
    /// Creates a codex section.
    /// </summary>
    public static CodexSection Create(
        string title,
        string content,
        int order,
        bool requiresReveal = false)
    {
        return new CodexSection
        {
            Title = title ?? string.Empty,
            Content = content ?? string.Empty,
            Order = order,
            RequiresReveal = requiresReveal
        };
    }
}
```

### 5.7 CodexEntryDefinition

```csharp
namespace RuneAndRust.Domain.Definitions;

/// <summary>
/// Configuration template for codex entries.
/// </summary>
/// <remarks>
/// Loaded from JSON configuration. Defines the structure and content
/// of codex entries, along with conditions for discovery and revelation.
/// </remarks>
public class CodexEntryDefinition
{
    /// <summary>
    /// Gets the unique identifier for this entry.
    /// </summary>
    /// <example>"goblin-bestiary", "merchant-guild-faction"</example>
    public string Id { get; init; } = string.Empty;

    /// <summary>
    /// Gets the entry's display title.
    /// </summary>
    /// <example>"Goblin", "The Merchant Guild"</example>
    public string Title { get; init; } = string.Empty;

    /// <summary>
    /// Gets the entry's category.
    /// </summary>
    public CodexCategory Category { get; init; }

    /// <summary>
    /// Gets the content sections of this entry.
    /// </summary>
    /// <remarks>
    /// Ordered by Section.Order. Some sections may require reveal.
    /// </remarks>
    public IReadOnlyList<CodexSection> Sections { get; init; } = [];

    /// <summary>
    /// Gets conditions that unlock this entry.
    /// </summary>
    /// <remarks>
    /// Any matching condition unlocks the entry. Multiple conditions
    /// provide multiple discovery paths.
    /// </remarks>
    public IReadOnlyList<CodexUnlockCondition> UnlockConditions { get; init; } = [];

    /// <summary>
    /// Gets conditions that reveal additional sections.
    /// </summary>
    /// <remarks>
    /// After initial discovery, these conditions reveal hidden sections.
    /// Evaluated in order; each condition reveals its SectionsToReveal.
    /// </remarks>
    public IReadOnlyList<CodexUnlockCondition> RevealConditions { get; init; } = [];

    /// <summary>
    /// Gets IDs of related codex entries.
    /// </summary>
    /// <remarks>
    /// Shown as "See Also" links in the codex interface.
    /// </remarks>
    public IReadOnlyList<string> RelatedEntryIds { get; init; } = [];

    /// <summary>
    /// Gets tags for categorization and searching.
    /// </summary>
    /// <example>["monster", "goblinoid", "level-1"]</example>
    public IReadOnlyList<string> Tags { get; init; } = [];

    /// <summary>
    /// Private constructor for deserialization.
    /// </summary>
    private CodexEntryDefinition() { }

    /// <summary>
    /// Creates a codex entry definition.
    /// </summary>
    public static CodexEntryDefinition Create(
        string id,
        string title,
        CodexCategory category,
        IEnumerable<CodexSection>? sections = null,
        IEnumerable<CodexUnlockCondition>? unlockConditions = null,
        IEnumerable<CodexUnlockCondition>? revealConditions = null,
        IEnumerable<string>? relatedEntryIds = null,
        IEnumerable<string>? tags = null)
    {
        ArgumentException.ThrowIfNullOrWhiteSpace(id);
        ArgumentException.ThrowIfNullOrWhiteSpace(title);

        return new CodexEntryDefinition
        {
            Id = id.ToLowerInvariant(),
            Title = title,
            Category = category,
            Sections = sections?.OrderBy(s => s.Order).ToList() ?? [],
            UnlockConditions = unlockConditions?.ToList() ?? [],
            RevealConditions = revealConditions?.ToList() ?? [],
            RelatedEntryIds = relatedEntryIds?.Select(r => r.ToLowerInvariant()).ToList() ?? [],
            Tags = tags?.Select(t => t.ToLowerInvariant()).ToList() ?? []
        };
    }

    /// <summary>
    /// Gets the number of sections visible on initial discovery.
    /// </summary>
    /// <returns>Count of sections where RequiresReveal is false.</returns>
    public int GetInitialSectionCount()
    {
        return Sections.Count(s => !s.RequiresReveal);
    }

    /// <summary>
    /// Gets sections that are visible for a given reveal count.
    /// </summary>
    /// <param name="revealedCount">Number of sections revealed.</param>
    /// <returns>Visible sections in order.</returns>
    public IReadOnlyList<CodexSection> GetVisibleSections(int revealedCount)
    {
        return Sections
            .OrderBy(s => s.Order)
            .Take(revealedCount)
            .ToList();
    }
}
```

### 5.8 CodexProgress Value Object

```csharp
namespace RuneAndRust.Domain.ValueObjects;

/// <summary>
/// Tracks a player's overall codex completion progress.
/// </summary>
public readonly record struct CodexProgress
{
    /// <summary>
    /// Gets the player ID.
    /// </summary>
    public Guid PlayerId { get; init; }

    /// <summary>
    /// Gets the total number of codex entries.
    /// </summary>
    public int TotalEntries { get; init; }

    /// <summary>
    /// Gets the number of discovered entries.
    /// </summary>
    public int DiscoveredCount { get; init; }

    /// <summary>
    /// Gets the number of fully completed entries.
    /// </summary>
    public int CompleteCount { get; init; }

    /// <summary>
    /// Gets progress by category.
    /// </summary>
    /// <remarks>
    /// Key = category, Value = (discovered, total) tuple.
    /// </remarks>
    public IReadOnlyDictionary<CodexCategory, (int Discovered, int Total)> ByCategory { get; init; }

    /// <summary>
    /// Gets the overall completion percentage.
    /// </summary>
    /// <remarks>
    /// Based on discovered entries, not complete entries.
    /// </remarks>
    public int PercentComplete => TotalEntries > 0
        ? (DiscoveredCount * 100) / TotalEntries
        : 0;

    /// <summary>
    /// Gets the full completion percentage.
    /// </summary>
    /// <remarks>
    /// Based on fully completed entries.
    /// </remarks>
    public int PercentFullyComplete => TotalEntries > 0
        ? (CompleteCount * 100) / TotalEntries
        : 0;

    /// <summary>
    /// Creates a progress summary.
    /// </summary>
    public static CodexProgress Create(
        Guid playerId,
        int totalEntries,
        int discoveredCount,
        int completeCount,
        Dictionary<CodexCategory, (int, int)>? byCategory = null)
    {
        return new CodexProgress
        {
            PlayerId = playerId,
            TotalEntries = totalEntries,
            DiscoveredCount = discoveredCount,
            CompleteCount = completeCount,
            ByCategory = byCategory ?? new Dictionary<CodexCategory, (int, int)>()
        };
    }
}
```

### 5.9 CodexUnlockResult Value Object

```csharp
namespace RuneAndRust.Domain.ValueObjects;

/// <summary>
/// Result of attempting to unlock or reveal codex content.
/// </summary>
public readonly record struct CodexUnlockResult
{
    /// <summary>
    /// Gets whether any new content was unlocked.
    /// </summary>
    public bool Success { get; init; }

    /// <summary>
    /// Gets newly discovered entries.
    /// </summary>
    public IReadOnlyList<CodexEntry> NewlyDiscovered { get; init; }

    /// <summary>
    /// Gets entries with newly revealed sections.
    /// </summary>
    public IReadOnlyList<CodexEntry> NewlyRevealed { get; init; }

    /// <summary>
    /// Gets a message describing the unlock.
    /// </summary>
    public string Message { get; init; }

    /// <summary>
    /// Creates a successful result with new discoveries.
    /// </summary>
    public static CodexUnlockResult Discovered(
        IReadOnlyList<CodexEntry> entries,
        string message)
    {
        return new CodexUnlockResult
        {
            Success = true,
            NewlyDiscovered = entries,
            NewlyRevealed = [],
            Message = message
        };
    }

    /// <summary>
    /// Creates a successful result with revealed sections.
    /// </summary>
    public static CodexUnlockResult Revealed(
        IReadOnlyList<CodexEntry> entries,
        string message)
    {
        return new CodexUnlockResult
        {
            Success = true,
            NewlyDiscovered = [],
            NewlyRevealed = entries,
            Message = message
        };
    }

    /// <summary>
    /// Creates a combined result with both discoveries and reveals.
    /// </summary>
    public static CodexUnlockResult Combined(
        IReadOnlyList<CodexEntry> discovered,
        IReadOnlyList<CodexEntry> revealed,
        string message)
    {
        return new CodexUnlockResult
        {
            Success = discovered.Count > 0 || revealed.Count > 0,
            NewlyDiscovered = discovered,
            NewlyRevealed = revealed,
            Message = message
        };
    }

    /// <summary>
    /// Creates an empty result (nothing unlocked).
    /// </summary>
    public static CodexUnlockResult None()
    {
        return new CodexUnlockResult
        {
            Success = false,
            NewlyDiscovered = [],
            NewlyRevealed = [],
            Message = string.Empty
        };
    }
}
```

---

## 6. Configuration Schemas

### 6.1 codex-entries.json

```json
{
  "$schema": "../schemas/codex-entries.schema.json",
  "entries": [
    {
      "id": "goblin-bestiary",
      "title": "Goblin",
      "category": "Bestiary",
      "sections": [
        {
          "title": "Overview",
          "content": "Goblins are small, cunning creatures that infest the upper levels of dungeons. They are cowardly when alone but dangerous in groups.",
          "order": 1,
          "requiresReveal": false
        },
        {
          "title": "Weaknesses",
          "content": "Goblins fear fire and bright light. Their thin armor provides little protection against piercing weapons.",
          "order": 2,
          "requiresReveal": true
        },
        {
          "title": "Society",
          "content": "Goblin tribes are led by the strongest or most cunning member. They value shiny objects and often hoard stolen treasures.",
          "order": 3,
          "requiresReveal": true
        }
      ],
      "unlockConditions": [
        {
          "triggerType": "DefeatMonster",
          "targetId": "goblin",
          "count": 1,
          "sectionsToReveal": 1
        }
      ],
      "revealConditions": [
        {
          "triggerType": "DefeatMonster",
          "targetId": "goblin",
          "count": 5,
          "sectionsToReveal": 1
        },
        {
          "triggerType": "DefeatMonster",
          "targetId": "goblin",
          "count": 10,
          "sectionsToReveal": 1
        }
      ],
      "relatedEntryIds": ["goblin-chief-bestiary", "goblin-lair-location"],
      "tags": ["monster", "goblinoid", "common"]
    },
    {
      "id": "iron-sword-lore",
      "title": "Iron Sword",
      "category": "ItemsAndArtifacts",
      "sections": [
        {
          "title": "Description",
          "content": "A sturdy sword forged from iron ore. The most common weapon among adventurers and guards alike.",
          "order": 1,
          "requiresReveal": false
        },
        {
          "title": "Crafting Notes",
          "content": "Iron swords require a forge and moderate smithing skill. The quality depends on the purity of the iron used.",
          "order": 2,
          "requiresReveal": true
        }
      ],
      "unlockConditions": [
        {
          "triggerType": "ExamineItem",
          "targetId": "iron-sword",
          "count": 1,
          "sectionsToReveal": 1
        },
        {
          "triggerType": "AcquireItem",
          "targetId": "iron-sword",
          "count": 1,
          "sectionsToReveal": 1
        }
      ],
      "revealConditions": [
        {
          "triggerType": "FlagSet",
          "targetId": "learned-smithing-basics",
          "count": 1,
          "sectionsToReveal": 1
        }
      ],
      "relatedEntryIds": ["steel-sword-lore", "iron-ore-lore"],
      "tags": ["weapon", "sword", "iron", "common"]
    },
    {
      "id": "merchant-guild-faction",
      "title": "The Merchant Guild",
      "category": "Factions",
      "sections": [
        {
          "title": "Overview",
          "content": "A network of traders and shopkeepers who control commerce in the dungeon depths. They value fair dealing and profitable ventures.",
          "order": 1,
          "requiresReveal": false
        },
        {
          "title": "History",
          "content": "The Merchant Guild was founded by Grimbold's grandfather, who saw opportunity in the dangerous depths where others saw only death.",
          "order": 2,
          "requiresReveal": true
        },
        {
          "title": "Allies and Enemies",
          "content": "The Guild maintains friendly relations with the Adventurer's League but is in constant conflict with the Thieves' Syndicate.",
          "order": 3,
          "requiresReveal": true
        }
      ],
      "unlockConditions": [
        {
          "triggerType": "DialogueChoice",
          "targetId": "grimbold-special-question",
          "count": 1,
          "sectionsToReveal": 1
        }
      ],
      "revealConditions": [
        {
          "triggerType": "FlagSet",
          "targetId": "merchant-guild-friendly",
          "count": 1,
          "sectionsToReveal": 1
        },
        {
          "triggerType": "FlagSet",
          "targetId": "merchant-guild-honored",
          "count": 1,
          "sectionsToReveal": 1
        }
      ],
      "relatedEntryIds": ["grimbold-character", "thieves-syndicate-faction"],
      "tags": ["faction", "merchants", "trade"]
    },
    {
      "id": "dusty-alcove-location",
      "title": "The Dusty Merchant's Alcove",
      "category": "Locations",
      "sections": [
        {
          "title": "Description",
          "content": "A cramped space converted into a makeshift shop. Wooden shelves line the walls, filled with wares and trinkets. The faint smell of pipe smoke lingers.",
          "order": 1,
          "requiresReveal": false
        },
        {
          "title": "Notable Features",
          "content": "Behind the worn counter, a hidden compartment contains Grimbold's most valuable items - reserved for trusted customers only.",
          "order": 2,
          "requiresReveal": true
        }
      ],
      "unlockConditions": [
        {
          "triggerType": "ExploreRoom",
          "targetId": "dusty-merchant-alcove",
          "count": 1,
          "sectionsToReveal": 1
        }
      ],
      "revealConditions": [
        {
          "triggerType": "FlagSet",
          "targetId": "grimbold-persuaded",
          "count": 1,
          "sectionsToReveal": 1
        }
      ],
      "relatedEntryIds": ["grimbold-character", "merchant-guild-faction"],
      "tags": ["location", "shop", "safe"]
    },
    {
      "id": "grimbold-character",
      "title": "Grimbold the Trader",
      "category": "Characters",
      "sections": [
        {
          "title": "Appearance",
          "content": "A stout dwarf with a braided gray beard and shrewd eyes. He wears a leather apron over chainmail, ever-ready for the dangers of the depths.",
          "order": 1,
          "requiresReveal": false
        },
        {
          "title": "Personality",
          "content": "Grimbold is a shrewd businessman who values profit but maintains a code of honor. He respects those who earn his trust.",
          "order": 2,
          "requiresReveal": true
        },
        {
          "title": "Background",
          "content": "Third generation of his family to work the dungeon trade routes. Lost his brother to thieves, fueling his hatred of the Syndicate.",
          "order": 3,
          "requiresReveal": true
        }
      ],
      "unlockConditions": [
        {
          "triggerType": "DialogueChoice",
          "targetId": "grimbold-main",
          "count": 1,
          "sectionsToReveal": 1
        }
      ],
      "revealConditions": [
        {
          "triggerType": "FlagSet",
          "targetId": "visited-grimbold-shop",
          "count": 1,
          "sectionsToReveal": 1
        },
        {
          "triggerType": "FlagSet",
          "targetId": "grimbold-persuaded",
          "count": 1,
          "sectionsToReveal": 1
        }
      ],
      "relatedEntryIds": ["merchant-guild-faction", "dusty-alcove-location"],
      "tags": ["character", "npc", "merchant", "dwarf"]
    }
  ]
}
```

### 6.2 codex-entries.schema.json

```json
{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "title": "Codex Entries Configuration",
  "description": "Defines codex entries for the in-game encyclopedia",
  "type": "object",
  "required": ["entries"],
  "properties": {
    "entries": {
      "type": "array",
      "description": "List of codex entry definitions",
      "items": {
        "$ref": "#/definitions/codexEntryDefinition"
      }
    }
  },
  "definitions": {
    "codexEntryDefinition": {
      "type": "object",
      "required": ["id", "title", "category", "sections", "unlockConditions"],
      "properties": {
        "id": {
          "type": "string",
          "pattern": "^[a-z][a-z0-9-]*$",
          "description": "Unique identifier (lowercase, alphanumeric with hyphens)"
        },
        "title": {
          "type": "string",
          "minLength": 1,
          "maxLength": 100,
          "description": "Display title of the entry"
        },
        "category": {
          "type": "string",
          "enum": [
            "Bestiary",
            "Locations",
            "ItemsAndArtifacts",
            "Characters",
            "Factions",
            "History",
            "Legends",
            "CraftingKnowledge"
          ],
          "description": "Entry category"
        },
        "sections": {
          "type": "array",
          "minItems": 1,
          "items": {
            "$ref": "#/definitions/codexSection"
          },
          "description": "Content sections of the entry"
        },
        "unlockConditions": {
          "type": "array",
          "minItems": 1,
          "items": {
            "$ref": "#/definitions/unlockCondition"
          },
          "description": "Conditions that unlock this entry"
        },
        "revealConditions": {
          "type": "array",
          "items": {
            "$ref": "#/definitions/unlockCondition"
          },
          "description": "Conditions that reveal additional sections"
        },
        "relatedEntryIds": {
          "type": "array",
          "items": {
            "type": "string",
            "pattern": "^[a-z][a-z0-9-]*$"
          },
          "description": "IDs of related entries"
        },
        "tags": {
          "type": "array",
          "items": {
            "type": "string",
            "pattern": "^[a-z][a-z0-9-]*$"
          },
          "description": "Tags for categorization and search"
        }
      }
    },
    "codexSection": {
      "type": "object",
      "required": ["content", "order"],
      "properties": {
        "title": {
          "type": "string",
          "maxLength": 100,
          "description": "Section title (optional)"
        },
        "content": {
          "type": "string",
          "minLength": 1,
          "maxLength": 2000,
          "description": "Section content text"
        },
        "order": {
          "type": "integer",
          "minimum": 1,
          "description": "Display order (lower = earlier)"
        },
        "requiresReveal": {
          "type": "boolean",
          "default": false,
          "description": "Whether this section is hidden initially"
        }
      }
    },
    "unlockCondition": {
      "type": "object",
      "required": ["triggerType", "targetId"],
      "properties": {
        "triggerType": {
          "type": "string",
          "enum": [
            "DefeatMonster",
            "ExamineItem",
            "AcquireItem",
            "ExploreRoom",
            "DialogueChoice",
            "ReadDocument",
            "FlagSet"
          ],
          "description": "Type of action that triggers unlock"
        },
        "targetId": {
          "type": "string",
          "minLength": 1,
          "description": "Target identifier for the trigger"
        },
        "count": {
          "type": "integer",
          "minimum": 1,
          "default": 1,
          "description": "Number of times action must occur"
        },
        "sectionsToReveal": {
          "type": "integer",
          "minimum": 1,
          "default": 1,
          "description": "Sections to reveal when condition met"
        }
      }
    }
  }
}
```

---

## 7. Service Specifications

### 7.1 ICodexService Interface

```csharp
namespace RuneAndRust.Application.Interfaces;

/// <summary>
/// Provides operations for codex management and discovery.
/// </summary>
public interface ICodexService
{
    /// <summary>
    /// Gets all codex entry definitions.
    /// </summary>
    /// <returns>List of all entry definitions.</returns>
    IReadOnlyList<CodexEntryDefinition> GetAllDefinitions();

    /// <summary>
    /// Gets a codex entry definition by ID.
    /// </summary>
    /// <param name="id">The definition ID.</param>
    /// <returns>The definition, or null if not found.</returns>
    CodexEntryDefinition? GetCodexEntryDefinition(string id);

    /// <summary>
    /// Gets all entries discovered by a player.
    /// </summary>
    /// <param name="playerId">The player's ID.</param>
    /// <returns>List of discovered entries.</returns>
    IReadOnlyList<CodexEntry> GetDiscoveredEntries(Guid playerId);

    /// <summary>
    /// Gets discovered entries in a specific category.
    /// </summary>
    /// <param name="playerId">The player's ID.</param>
    /// <param name="category">The category to filter by.</param>
    /// <returns>List of entries in the category.</returns>
    IReadOnlyList<CodexEntry> GetEntriesByCategory(Guid playerId, CodexCategory category);

    /// <summary>
    /// Attempts to unlock a codex entry by definition ID.
    /// </summary>
    /// <param name="playerId">The player's ID.</param>
    /// <param name="definitionId">The entry definition ID.</param>
    /// <returns>Result of the unlock attempt.</returns>
    CodexUnlockResult TryUnlockEntry(Guid playerId, string definitionId);

    /// <summary>
    /// Attempts to unlock entries based on a trigger event.
    /// </summary>
    /// <param name="playerId">The player's ID.</param>
    /// <param name="triggerType">The type of triggering action.</param>
    /// <param name="targetId">The target of the action.</param>
    /// <param name="count">Number of times action occurred.</param>
    /// <returns>Result with any unlocked/revealed entries.</returns>
    CodexUnlockResult TryUnlockByTrigger(
        Guid playerId,
        UnlockTriggerType triggerType,
        string targetId,
        int count = 1);

    /// <summary>
    /// Reveals additional sections of a discovered entry.
    /// </summary>
    /// <param name="playerId">The player's ID.</param>
    /// <param name="entryId">The entry instance ID.</param>
    /// <param name="sectionsToReveal">Number of sections to reveal.</param>
    /// <returns>True if sections were revealed.</returns>
    bool RevealSections(Guid playerId, Guid entryId, int sectionsToReveal);

    /// <summary>
    /// Searches discovered entries.
    /// </summary>
    /// <param name="playerId">The player's ID.</param>
    /// <param name="searchTerm">The term to search for.</param>
    /// <returns>Matching entries.</returns>
    IReadOnlyList<CodexEntry> SearchEntries(Guid playerId, string searchTerm);

    /// <summary>
    /// Gets overall codex progress for a player.
    /// </summary>
    /// <param name="playerId">The player's ID.</param>
    /// <returns>Progress summary.</returns>
    CodexProgress GetProgress(Guid playerId);

    /// <summary>
    /// Gets progress for a specific category.
    /// </summary>
    /// <param name="playerId">The player's ID.</param>
    /// <param name="category">The category.</param>
    /// <returns>Tuple of (discovered, total).</returns>
    (int Discovered, int Total) GetCategoryProgress(Guid playerId, CodexCategory category);
}
```

### 7.2 CodexService Implementation

```csharp
namespace RuneAndRust.Application.Services;

/// <summary>
/// Manages codex entries, discovery, and progress tracking.
/// </summary>
public class CodexService : ICodexService
{
    private readonly IReadOnlyList<CodexEntryDefinition> _definitions;
    private readonly Dictionary<string, CodexEntryDefinition> _definitionLookup;
    private readonly Dictionary<Guid, List<CodexEntry>> _playerEntries = new();
    private readonly Dictionary<(Guid, string), int> _triggerCounts = new();
    private readonly ILogger<CodexService> _logger;

    /// <summary>
    /// Initializes a new instance of CodexService.
    /// </summary>
    /// <param name="configProvider">Configuration provider.</param>
    /// <param name="logger">Logger instance.</param>
    public CodexService(
        IConfigurationProvider configProvider,
        ILogger<CodexService> logger)
    {
        _logger = logger;
        _definitions = configProvider.LoadCodexEntryDefinitions();
        _definitionLookup = _definitions.ToDictionary(
            d => d.Id,
            StringComparer.OrdinalIgnoreCase);

        _logger.LogInformation(
            "CodexService initialized with {EntryCount} entry definitions",
            _definitions.Count);
    }

    /// <inheritdoc />
    public IReadOnlyList<CodexEntryDefinition> GetAllDefinitions()
    {
        _logger.LogDebug("GetAllDefinitions called");
        return _definitions;
    }

    /// <inheritdoc />
    public CodexEntryDefinition? GetCodexEntryDefinition(string id)
    {
        _logger.LogDebug("GetCodexEntryDefinition called for ID: {DefinitionId}", id);
        return _definitionLookup.TryGetValue(id, out var def) ? def : null;
    }

    /// <inheritdoc />
    public IReadOnlyList<CodexEntry> GetDiscoveredEntries(Guid playerId)
    {
        _logger.LogDebug("GetDiscoveredEntries called for player: {PlayerId}", playerId);

        if (!_playerEntries.TryGetValue(playerId, out var entries))
        {
            return [];
        }

        return entries.AsReadOnly();
    }

    /// <inheritdoc />
    public IReadOnlyList<CodexEntry> GetEntriesByCategory(Guid playerId, CodexCategory category)
    {
        _logger.LogDebug(
            "GetEntriesByCategory called for player: {PlayerId}, category: {Category}",
            playerId, category);

        return GetDiscoveredEntries(playerId)
            .Where(e => e.Category == category)
            .ToList();
    }

    /// <inheritdoc />
    public CodexUnlockResult TryUnlockEntry(Guid playerId, string definitionId)
    {
        _logger.LogDebug(
            "TryUnlockEntry called for player: {PlayerId}, definition: {DefinitionId}",
            playerId, definitionId);

        var definition = GetCodexEntryDefinition(definitionId);
        if (definition is null)
        {
            _logger.LogWarning("Definition not found: {DefinitionId}", definitionId);
            return CodexUnlockResult.None();
        }

        // Check if already discovered
        var existingEntries = GetDiscoveredEntries(playerId);
        var existing = existingEntries.FirstOrDefault(
            e => e.DefinitionId.Equals(definitionId, StringComparison.OrdinalIgnoreCase));

        if (existing is not null)
        {
            _logger.LogDebug("Entry already discovered: {DefinitionId}", definitionId);
            return CodexUnlockResult.None();
        }

        // Create new entry
        var initialSections = definition.GetInitialSectionCount();
        var entry = CodexEntry.Create(definition, playerId, initialSections);

        // Track entry
        if (!_playerEntries.ContainsKey(playerId))
        {
            _playerEntries[playerId] = new List<CodexEntry>();
        }
        _playerEntries[playerId].Add(entry);

        _logger.LogInformation(
            "Player {PlayerId} discovered codex entry: {EntryTitle} ({DefinitionId})",
            playerId, definition.Title, definitionId);

        return CodexUnlockResult.Discovered(
            [entry],
            $"Discovered: {definition.Title}");
    }

    /// <inheritdoc />
    public CodexUnlockResult TryUnlockByTrigger(
        Guid playerId,
        UnlockTriggerType triggerType,
        string targetId,
        int count = 1)
    {
        _logger.LogDebug(
            "TryUnlockByTrigger: player={PlayerId}, trigger={TriggerType}, target={TargetId}, count={Count}",
            playerId, triggerType, targetId, count);

        // Update trigger count
        var key = (playerId, $"{triggerType}:{targetId}".ToLowerInvariant());
        _triggerCounts.TryGetValue(key, out var currentCount);
        currentCount += count;
        _triggerCounts[key] = currentCount;

        var newlyDiscovered = new List<CodexEntry>();
        var newlyRevealed = new List<CodexEntry>();

        // Find definitions with matching unlock conditions
        foreach (var definition in _definitions)
        {
            // Check unlock conditions
            foreach (var condition in definition.UnlockConditions)
            {
                if (condition.Matches(triggerType, targetId) && currentCount >= condition.Count)
                {
                    var result = TryUnlockEntry(playerId, definition.Id);
                    if (result.Success && result.NewlyDiscovered.Count > 0)
                    {
                        newlyDiscovered.AddRange(result.NewlyDiscovered);
                    }
                    break;
                }
            }

            // Check reveal conditions for already discovered entries
            var existingEntry = GetDiscoveredEntries(playerId)
                .FirstOrDefault(e => e.DefinitionId.Equals(definition.Id, StringComparison.OrdinalIgnoreCase));

            if (existingEntry is not null && !existingEntry.IsComplete)
            {
                foreach (var condition in definition.RevealConditions)
                {
                    if (condition.Matches(triggerType, targetId) && currentCount >= condition.Count)
                    {
                        var revealed = existingEntry.RevealSections(condition.SectionsToReveal);
                        if (revealed > 0)
                        {
                            newlyRevealed.Add(existingEntry);
                            _logger.LogInformation(
                                "Revealed {Count} sections of {EntryTitle} for player {PlayerId}",
                                revealed, definition.Title, playerId);
                        }
                    }
                }
            }
        }

        if (newlyDiscovered.Count == 0 && newlyRevealed.Count == 0)
        {
            return CodexUnlockResult.None();
        }

        var message = BuildUnlockMessage(newlyDiscovered, newlyRevealed);
        return CodexUnlockResult.Combined(newlyDiscovered, newlyRevealed, message);
    }

    /// <inheritdoc />
    public bool RevealSections(Guid playerId, Guid entryId, int sectionsToReveal)
    {
        _logger.LogDebug(
            "RevealSections: player={PlayerId}, entry={EntryId}, count={Count}",
            playerId, entryId, sectionsToReveal);

        var entries = GetDiscoveredEntries(playerId);
        var entry = entries.FirstOrDefault(e => e.Id == entryId);

        if (entry is null)
        {
            _logger.LogWarning("Entry not found: {EntryId}", entryId);
            return false;
        }

        var revealed = entry.RevealSections(sectionsToReveal);
        return revealed > 0;
    }

    /// <inheritdoc />
    public IReadOnlyList<CodexEntry> SearchEntries(Guid playerId, string searchTerm)
    {
        _logger.LogDebug(
            "SearchEntries: player={PlayerId}, term={SearchTerm}",
            playerId, searchTerm);

        if (string.IsNullOrWhiteSpace(searchTerm))
        {
            return [];
        }

        var term = searchTerm.ToLowerInvariant();
        var entries = GetDiscoveredEntries(playerId);

        return entries.Where(entry =>
        {
            // Search title
            if (entry.Title.Contains(term, StringComparison.OrdinalIgnoreCase))
            {
                return true;
            }

            // Search visible content
            var definition = GetCodexEntryDefinition(entry.DefinitionId);
            if (definition is not null)
            {
                var visibleSections = definition.GetVisibleSections(entry.RevealedSections);
                foreach (var section in visibleSections)
                {
                    if (section.Title.Contains(term, StringComparison.OrdinalIgnoreCase) ||
                        section.Content.Contains(term, StringComparison.OrdinalIgnoreCase))
                    {
                        return true;
                    }
                }

                // Search tags
                if (definition.Tags.Any(t => t.Contains(term, StringComparison.OrdinalIgnoreCase)))
                {
                    return true;
                }
            }

            return false;
        }).ToList();
    }

    /// <inheritdoc />
    public CodexProgress GetProgress(Guid playerId)
    {
        _logger.LogDebug("GetProgress called for player: {PlayerId}", playerId);

        var entries = GetDiscoveredEntries(playerId);
        var totalEntries = _definitions.Count;
        var discoveredCount = entries.Count;
        var completeCount = entries.Count(e => e.IsComplete);

        var byCategory = new Dictionary<CodexCategory, (int, int)>();
        foreach (CodexCategory category in Enum.GetValues<CodexCategory>())
        {
            var total = _definitions.Count(d => d.Category == category);
            var discovered = entries.Count(e => e.Category == category);
            byCategory[category] = (discovered, total);
        }

        return CodexProgress.Create(
            playerId,
            totalEntries,
            discoveredCount,
            completeCount,
            byCategory);
    }

    /// <inheritdoc />
    public (int Discovered, int Total) GetCategoryProgress(Guid playerId, CodexCategory category)
    {
        var total = _definitions.Count(d => d.Category == category);
        var discovered = GetEntriesByCategory(playerId, category).Count;
        return (discovered, total);
    }

    private static string BuildUnlockMessage(
        IReadOnlyList<CodexEntry> discovered,
        IReadOnlyList<CodexEntry> revealed)
    {
        var parts = new List<string>();

        if (discovered.Count > 0)
        {
            var titles = string.Join(", ", discovered.Select(e => e.Title));
            parts.Add($"Discovered: {titles}");
        }

        if (revealed.Count > 0)
        {
            var titles = string.Join(", ", revealed.Select(e => e.Title));
            parts.Add($"New information: {titles}");
        }

        return string.Join(" | ", parts);
    }
}
```

### 7.3 GameSessionService Updates

```csharp
// Additions to existing GameSessionService

/// <summary>
/// Opens the codex interface.
/// </summary>
/// <returns>Summary of codex categories and progress.</returns>
public CodexSummaryDto OpenCodex()
{
    EnsureGameStarted();

    _logger.LogDebug("OpenCodex called");

    var progress = _codexService.GetProgress(_player!.Id);

    var categories = new List<CodexCategoryDto>();
    foreach (CodexCategory category in Enum.GetValues<CodexCategory>())
    {
        var (discovered, total) = _codexService.GetCategoryProgress(_player!.Id, category);
        categories.Add(new CodexCategoryDto
        {
            Category = category,
            Name = GetCategoryDisplayName(category),
            DiscoveredCount = discovered,
            TotalCount = total
        });
    }

    return new CodexSummaryDto
    {
        Categories = categories,
        TotalDiscovered = progress.DiscoveredCount,
        TotalEntries = progress.TotalEntries,
        PercentComplete = progress.PercentComplete
    };
}

/// <summary>
/// Views a specific codex entry.
/// </summary>
/// <param name="topic">The entry title or ID to view.</param>
/// <returns>The entry content, or null if not found/discovered.</returns>
public CodexEntryDto? ViewCodexEntry(string topic)
{
    EnsureGameStarted();

    _logger.LogDebug("ViewCodexEntry called for topic: {Topic}", topic);

    var entries = _codexService.GetDiscoveredEntries(_player!.Id);

    // Search by title or ID
    var entry = entries.FirstOrDefault(e =>
        e.Title.Equals(topic, StringComparison.OrdinalIgnoreCase) ||
        e.DefinitionId.Equals(topic, StringComparison.OrdinalIgnoreCase));

    if (entry is null)
    {
        _logger.LogDebug("Entry not found or not discovered: {Topic}", topic);
        return null;
    }

    var definition = _codexService.GetCodexEntryDefinition(entry.DefinitionId);
    if (definition is null)
    {
        return null;
    }

    var visibleSections = definition.GetVisibleSections(entry.RevealedSections);

    // Get related entries that are discovered
    var relatedEntries = new List<string>();
    foreach (var relatedId in definition.RelatedEntryIds)
    {
        var related = entries.FirstOrDefault(e =>
            e.DefinitionId.Equals(relatedId, StringComparison.OrdinalIgnoreCase));
        if (related is not null)
        {
            relatedEntries.Add(related.Title);
        }
    }

    return new CodexEntryDto
    {
        Title = entry.Title,
        Category = entry.Category,
        CategoryName = GetCategoryDisplayName(entry.Category),
        Sections = visibleSections.Select(s => new CodexSectionDto
        {
            Title = s.Title,
            Content = s.Content
        }).ToList(),
        IsComplete = entry.IsComplete,
        RevealedSections = entry.RevealedSections,
        TotalSections = entry.TotalSections,
        RelatedEntries = relatedEntries
    };
}

/// <summary>
/// Searches the codex.
/// </summary>
/// <param name="term">The search term.</param>
/// <returns>List of matching entries.</returns>
public IReadOnlyList<CodexSearchResultDto> SearchCodex(string term)
{
    EnsureGameStarted();

    _logger.LogDebug("SearchCodex called with term: {Term}", term);

    var results = _codexService.SearchEntries(_player!.Id, term);

    return results.Select(e => new CodexSearchResultDto
    {
        Title = e.Title,
        Category = e.Category,
        CategoryName = GetCategoryDisplayName(e.Category),
        IsComplete = e.IsComplete
    }).ToList();
}

private static string GetCategoryDisplayName(CodexCategory category)
{
    return category switch
    {
        CodexCategory.Bestiary => "Bestiary",
        CodexCategory.Locations => "Locations",
        CodexCategory.ItemsAndArtifacts => "Items & Artifacts",
        CodexCategory.Characters => "Characters",
        CodexCategory.Factions => "Factions",
        CodexCategory.History => "History",
        CodexCategory.Legends => "Legends",
        CodexCategory.CraftingKnowledge => "Crafting Knowledge",
        _ => category.ToString()
    };
}
```

---

## 8. Codex Command Flow

### 8.1 Input Handling

```csharp
// In InputHandler or CommandParser

/// <summary>
/// Parses a codex command.
/// </summary>
/// <param name="input">The raw input string.</param>
/// <returns>Parsed command information.</returns>
public CommandInfo ParseCodexCommand(string input)
{
    var parts = input.Trim().Split(' ', 3, StringSplitOptions.RemoveEmptyEntries);

    if (parts.Length == 0 || !parts[0].Equals("codex", StringComparison.OrdinalIgnoreCase))
    {
        return CommandInfo.Invalid("Invalid command");
    }

    // codex (no args) - open codex
    if (parts.Length == 1)
    {
        return new CommandInfo
        {
            Command = CommandType.OpenCodex
        };
    }

    // codex search <term>
    if (parts[1].Equals("search", StringComparison.OrdinalIgnoreCase))
    {
        var searchTerm = parts.Length > 2 ? parts[2] : string.Empty;
        return new CommandInfo
        {
            Command = CommandType.SearchCodex,
            SearchTerm = searchTerm
        };
    }

    // codex <topic> - view specific entry
    var topic = string.Join(" ", parts.Skip(1));
    return new CommandInfo
    {
        Command = CommandType.ViewCodexEntry,
        TargetName = topic
    };
}
```

---

## 9. User-Facing Changes

### 9.1 Commands

```
> codex                    # Open the codex interface
> codex <topic>            # View specific entry (by title or ID)
> codex search <term>      # Search codex entries
```

### 9.2 Output Examples

#### Codex Overview

```
╔════════════════════════════════════════════════════════════════════════╗
║                              CODEX                                      ║
║                         12 / 87 Discovered (14%)                        ║
╠════════════════════════════════════════════════════════════════════════╣
║                                                                         ║
║  Category               Discovered                                      ║
║  ─────────────────────────────────────────────────────────────────      ║
║  Bestiary               3 / 24      ████████░░░░░░░░░░░░░░░░░░░░░░     ║
║  Locations              2 / 15      ████████████░░░░░░░░░░░░░░░░░░     ║
║  Items & Artifacts      4 / 20      ██████████████████░░░░░░░░░░░░     ║
║  Characters             2 / 12      ██████████████░░░░░░░░░░░░░░░░     ║
║  Factions               1 / 8       ██████████░░░░░░░░░░░░░░░░░░░░     ║
║  History                0 / 5       ░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░     ║
║  Legends                0 / 3       ░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░     ║
║  Crafting Knowledge     0 / 0       N/A                                 ║
║                                                                         ║
║  Use 'codex <topic>' to view an entry.                                  ║
║  Use 'codex search <term>' to search.                                   ║
║                                                                         ║
╚════════════════════════════════════════════════════════════════════════╝
```

#### View Entry

```
╔════════════════════════════════════════════════════════════════════════╗
║                              GOBLIN                                     ║
║                           [Bestiary]                                    ║
╠════════════════════════════════════════════════════════════════════════╣
║                                                                         ║
║  OVERVIEW                                                               ║
║  ─────────────────────────────────────────────────────────────────      ║
║  Goblins are small, cunning creatures that infest the upper levels     ║
║  of dungeons. They are cowardly when alone but dangerous in groups.    ║
║                                                                         ║
║  WEAKNESSES                                                             ║
║  ─────────────────────────────────────────────────────────────────      ║
║  Goblins fear fire and bright light. Their thin armor provides         ║
║  little protection against piercing weapons.                            ║
║                                                                         ║
║  [1 section remaining - defeat more goblins to learn more]              ║
║                                                                         ║
║  ─────────────────────────────────────────────────────────────────      ║
║  Related: Goblin Chief, Goblin Lair                                     ║
║                                                                         ║
╚════════════════════════════════════════════════════════════════════════╝
```

#### Search Results

```
╔════════════════════════════════════════════════════════════════════════╗
║                      CODEX SEARCH: "sword"                              ║
╠════════════════════════════════════════════════════════════════════════╣
║                                                                         ║
║  Found 2 entries:                                                       ║
║                                                                         ║
║  • Iron Sword [Items & Artifacts] ✓                                     ║
║  • Steel Sword [Items & Artifacts]                                      ║
║                                                                         ║
║  ✓ = Complete entry                                                     ║
║  Use 'codex <title>' to view an entry.                                  ║
║                                                                         ║
╚════════════════════════════════════════════════════════════════════════╝
```

#### Discovery Notification

```
╔════════════════════════════════════════════════════════════════════════╗
║                         CODEX DISCOVERY                                 ║
╠════════════════════════════════════════════════════════════════════════╣
║                                                                         ║
║  New Entry Discovered: Goblin [Bestiary]                                ║
║                                                                         ║
║  Use 'codex goblin' to view this entry.                                 ║
║                                                                         ║
╚════════════════════════════════════════════════════════════════════════╝
```

---

## 10. Logging Requirements

### 10.1 Log Events

| Event | Level | Message Template | Properties |
|-------|-------|------------------|------------|
| Service Init | Information | "CodexService initialized with {EntryCount} entry definitions" | EntryCount |
| Definition Loaded | Debug | "Loaded codex definition: {DefinitionId} ({Title})" | DefinitionId, Title |
| Entry Discovered | Information | "Player {PlayerId} discovered codex entry: {EntryTitle} ({DefinitionId})" | PlayerId, EntryTitle, DefinitionId |
| Sections Revealed | Information | "Revealed {Count} sections of {EntryTitle} for player {PlayerId}" | Count, EntryTitle, PlayerId |
| Search Performed | Debug | "SearchEntries: player={PlayerId}, term={SearchTerm}" | PlayerId, SearchTerm |
| Trigger Processed | Debug | "TryUnlockByTrigger: player={PlayerId}, trigger={TriggerType}, target={TargetId}" | PlayerId, TriggerType, TargetId |
| Entry Not Found | Warning | "Definition not found: {DefinitionId}" | DefinitionId |
| Config Load Error | Error | "Failed to load codex definitions: {ErrorMessage}" | ErrorMessage |

### 10.2 Example Log Output

```
[2024-01-20 14:30:15 INF] CodexService initialized with 87 entry definitions
[2024-01-20 14:30:15 DBG] Loaded codex definition: goblin-bestiary (Goblin)
[2024-01-20 14:30:15 DBG] Loaded codex definition: iron-sword-lore (Iron Sword)
[2024-01-20 14:35:42 DBG] TryUnlockByTrigger: player=a1b2c3d4-..., trigger=DefeatMonster, target=goblin
[2024-01-20 14:35:42 INF] Player a1b2c3d4-... discovered codex entry: Goblin (goblin-bestiary)
[2024-01-20 14:38:15 DBG] TryUnlockByTrigger: player=a1b2c3d4-..., trigger=DefeatMonster, target=goblin
[2024-01-20 14:38:15 INF] Revealed 1 sections of Goblin for player a1b2c3d4-...
```

---

## 11. Unit Test Specifications

### 11.1 CodexEntry Tests (~8 tests)

```csharp
namespace RuneAndRust.Domain.Tests.Entities;

[TestFixture]
public class CodexEntryTests
{
    private CodexEntryDefinition _testDefinition;

    [SetUp]
    public void Setup()
    {
        _testDefinition = CodexEntryDefinition.Create(
            "test-entry",
            "Test Entry",
            CodexCategory.Bestiary,
            sections: new[]
            {
                CodexSection.Create("Section 1", "Content 1", 1, false),
                CodexSection.Create("Section 2", "Content 2", 2, true),
                CodexSection.Create("Section 3", "Content 3", 3, true)
            });
    }

    [Test]
    public void Create_WithValidDefinition_ReturnsEntry()
    {
        var playerId = Guid.NewGuid();
        var entry = CodexEntry.Create(_testDefinition, playerId, 1);

        entry.Should().NotBeNull();
        entry.Id.Should().NotBe(Guid.Empty);
        entry.DefinitionId.Should().Be("test-entry");
        entry.PlayerId.Should().Be(playerId);
        entry.Category.Should().Be(CodexCategory.Bestiary);
    }

    [Test]
    public void Create_WithNullDefinition_ThrowsArgumentNullException()
    {
        var act = () => CodexEntry.Create(null!, Guid.NewGuid(), 1);

        act.Should().Throw<ArgumentNullException>();
    }

    [Test]
    public void Create_WithInitialSections_SetsRevealedSections()
    {
        var entry = CodexEntry.Create(_testDefinition, Guid.NewGuid(), 1);

        entry.RevealedSections.Should().Be(1);
        entry.TotalSections.Should().Be(3);
        entry.State.Should().Be(CodexEntryState.Discovered);
    }

    [Test]
    public void Create_WithAllSectionsRevealed_SetsCompleteState()
    {
        var entry = CodexEntry.Create(_testDefinition, Guid.NewGuid(), 3);

        entry.State.Should().Be(CodexEntryState.Complete);
        entry.IsComplete.Should().BeTrue();
    }

    [Test]
    public void RevealSections_IncreasesRevealedCount()
    {
        var entry = CodexEntry.Create(_testDefinition, Guid.NewGuid(), 1);

        var revealed = entry.RevealSections(1);

        revealed.Should().Be(1);
        entry.RevealedSections.Should().Be(2);
    }

    [Test]
    public void RevealSections_CapsAtTotal()
    {
        var entry = CodexEntry.Create(_testDefinition, Guid.NewGuid(), 2);

        var revealed = entry.RevealSections(5);

        revealed.Should().Be(1);
        entry.RevealedSections.Should().Be(3);
        entry.IsComplete.Should().BeTrue();
    }

    [Test]
    public void RevealAll_SetsAllSectionsRevealed()
    {
        var entry = CodexEntry.Create(_testDefinition, Guid.NewGuid(), 1);

        entry.RevealAll();

        entry.RevealedSections.Should().Be(3);
        entry.State.Should().Be(CodexEntryState.Complete);
    }

    [Test]
    public void GetCompletionPercent_ReturnsCorrectPercentage()
    {
        var entry = CodexEntry.Create(_testDefinition, Guid.NewGuid(), 2);

        var percent = entry.GetCompletionPercent();

        percent.Should().Be(66); // 2/3 = 66%
    }
}
```

### 11.2 CodexEntryDefinition Tests (~5 tests)

```csharp
[TestFixture]
public class CodexEntryDefinitionTests
{
    [Test]
    public void Create_WithValidParameters_ReturnsDefinition()
    {
        var definition = CodexEntryDefinition.Create(
            "test-entry",
            "Test Entry",
            CodexCategory.Bestiary);

        definition.Id.Should().Be("test-entry");
        definition.Title.Should().Be("Test Entry");
        definition.Category.Should().Be(CodexCategory.Bestiary);
    }

    [Test]
    public void Create_WithNullId_ThrowsArgumentException()
    {
        var act = () => CodexEntryDefinition.Create(
            null!, "Test", CodexCategory.Bestiary);

        act.Should().Throw<ArgumentException>();
    }

    [Test]
    public void Create_NormalizesIdToLowercase()
    {
        var definition = CodexEntryDefinition.Create(
            "TEST-ENTRY", "Test", CodexCategory.Bestiary);

        definition.Id.Should().Be("test-entry");
    }

    [Test]
    public void GetInitialSectionCount_ReturnsNonHiddenSections()
    {
        var definition = CodexEntryDefinition.Create(
            "test", "Test", CodexCategory.Bestiary,
            sections: new[]
            {
                CodexSection.Create("S1", "C1", 1, false),
                CodexSection.Create("S2", "C2", 2, true),
                CodexSection.Create("S3", "C3", 3, false)
            });

        definition.GetInitialSectionCount().Should().Be(2);
    }

    [Test]
    public void GetVisibleSections_ReturnsCorrectCount()
    {
        var definition = CodexEntryDefinition.Create(
            "test", "Test", CodexCategory.Bestiary,
            sections: new[]
            {
                CodexSection.Create("S1", "C1", 1, false),
                CodexSection.Create("S2", "C2", 2, false),
                CodexSection.Create("S3", "C3", 3, false)
            });

        var visible = definition.GetVisibleSections(2);

        visible.Should().HaveCount(2);
    }
}
```

### 11.3 CodexUnlockCondition Tests (~4 tests)

```csharp
[TestFixture]
public class CodexUnlockConditionTests
{
    [Test]
    public void Create_SetsPropertiesCorrectly()
    {
        var condition = CodexUnlockCondition.Create(
            UnlockTriggerType.DefeatMonster,
            "goblin",
            5,
            2);

        condition.TriggerType.Should().Be(UnlockTriggerType.DefeatMonster);
        condition.TargetId.Should().Be("goblin");
        condition.Count.Should().Be(5);
        condition.SectionsToReveal.Should().Be(2);
    }

    [Test]
    public void Create_EnforcesMinimumCount()
    {
        var condition = CodexUnlockCondition.Create(
            UnlockTriggerType.ExamineItem,
            "item",
            0);

        condition.Count.Should().Be(1);
    }

    [Test]
    public void Matches_WithMatchingTriggerAndTarget_ReturnsTrue()
    {
        var condition = CodexUnlockCondition.Create(
            UnlockTriggerType.DefeatMonster,
            "goblin");

        condition.Matches(UnlockTriggerType.DefeatMonster, "goblin").Should().BeTrue();
    }

    [Test]
    public void Matches_WithDifferentTrigger_ReturnsFalse()
    {
        var condition = CodexUnlockCondition.Create(
            UnlockTriggerType.DefeatMonster,
            "goblin");

        condition.Matches(UnlockTriggerType.ExamineItem, "goblin").Should().BeFalse();
    }
}
```

### 11.4 CodexService Tests (~10 tests)

```csharp
[TestFixture]
public class CodexServiceTests
{
    private Mock<IConfigurationProvider> _configProviderMock;
    private Mock<ILogger<CodexService>> _loggerMock;
    private CodexService _service;
    private List<CodexEntryDefinition> _definitions;

    [SetUp]
    public void Setup()
    {
        _definitions = new List<CodexEntryDefinition>
        {
            CodexEntryDefinition.Create(
                "goblin-bestiary",
                "Goblin",
                CodexCategory.Bestiary,
                sections: new[] { CodexSection.Create("Desc", "Content", 1, false) },
                unlockConditions: new[]
                {
                    CodexUnlockCondition.Create(UnlockTriggerType.DefeatMonster, "goblin")
                }),
            CodexEntryDefinition.Create(
                "iron-sword-lore",
                "Iron Sword",
                CodexCategory.ItemsAndArtifacts,
                sections: new[] { CodexSection.Create("Desc", "Content", 1, false) },
                unlockConditions: new[]
                {
                    CodexUnlockCondition.Create(UnlockTriggerType.ExamineItem, "iron-sword")
                })
        };

        _configProviderMock = new Mock<IConfigurationProvider>();
        _configProviderMock.Setup(x => x.LoadCodexEntryDefinitions())
            .Returns(_definitions);

        _loggerMock = new Mock<ILogger<CodexService>>();

        _service = new CodexService(_configProviderMock.Object, _loggerMock.Object);
    }

    [Test]
    public void GetAllDefinitions_ReturnsAllDefinitions()
    {
        var result = _service.GetAllDefinitions();

        result.Should().HaveCount(2);
    }

    [Test]
    public void GetCodexEntryDefinition_WithValidId_ReturnsDefinition()
    {
        var result = _service.GetCodexEntryDefinition("goblin-bestiary");

        result.Should().NotBeNull();
        result!.Title.Should().Be("Goblin");
    }

    [Test]
    public void GetCodexEntryDefinition_WithInvalidId_ReturnsNull()
    {
        var result = _service.GetCodexEntryDefinition("nonexistent");

        result.Should().BeNull();
    }

    [Test]
    public void TryUnlockEntry_WithValidId_CreatesEntry()
    {
        var playerId = Guid.NewGuid();

        var result = _service.TryUnlockEntry(playerId, "goblin-bestiary");

        result.Success.Should().BeTrue();
        result.NewlyDiscovered.Should().HaveCount(1);
    }

    [Test]
    public void TryUnlockEntry_WhenAlreadyDiscovered_ReturnsNone()
    {
        var playerId = Guid.NewGuid();
        _service.TryUnlockEntry(playerId, "goblin-bestiary");

        var result = _service.TryUnlockEntry(playerId, "goblin-bestiary");

        result.Success.Should().BeFalse();
    }

    [Test]
    public void TryUnlockByTrigger_WithMatchingCondition_UnlocksEntry()
    {
        var playerId = Guid.NewGuid();

        var result = _service.TryUnlockByTrigger(
            playerId,
            UnlockTriggerType.DefeatMonster,
            "goblin");

        result.Success.Should().BeTrue();
        result.NewlyDiscovered.Should().HaveCount(1);
    }

    [Test]
    public void TryUnlockByTrigger_WithNoMatchingCondition_ReturnsNone()
    {
        var playerId = Guid.NewGuid();

        var result = _service.TryUnlockByTrigger(
            playerId,
            UnlockTriggerType.DefeatMonster,
            "unknown-monster");

        result.Success.Should().BeFalse();
    }

    [Test]
    public void GetDiscoveredEntries_ReturnsPlayerEntries()
    {
        var playerId = Guid.NewGuid();
        _service.TryUnlockEntry(playerId, "goblin-bestiary");

        var result = _service.GetDiscoveredEntries(playerId);

        result.Should().HaveCount(1);
    }

    [Test]
    public void SearchEntries_FindsMatchingTitle()
    {
        var playerId = Guid.NewGuid();
        _service.TryUnlockEntry(playerId, "goblin-bestiary");
        _service.TryUnlockEntry(playerId, "iron-sword-lore");

        var result = _service.SearchEntries(playerId, "goblin");

        result.Should().HaveCount(1);
        result[0].Title.Should().Be("Goblin");
    }

    [Test]
    public void GetProgress_ReturnsCorrectCounts()
    {
        var playerId = Guid.NewGuid();
        _service.TryUnlockEntry(playerId, "goblin-bestiary");

        var result = _service.GetProgress(playerId);

        result.TotalEntries.Should().Be(2);
        result.DiscoveredCount.Should().Be(1);
        result.PercentComplete.Should().Be(50);
    }
}
```

### 11.5 CodexProgress Tests (~3 tests)

```csharp
[TestFixture]
public class CodexProgressTests
{
    [Test]
    public void PercentComplete_CalculatesCorrectly()
    {
        var progress = CodexProgress.Create(
            Guid.NewGuid(),
            totalEntries: 100,
            discoveredCount: 25,
            completeCount: 10);

        progress.PercentComplete.Should().Be(25);
    }

    [Test]
    public void PercentFullyComplete_CalculatesCorrectly()
    {
        var progress = CodexProgress.Create(
            Guid.NewGuid(),
            totalEntries: 100,
            discoveredCount: 25,
            completeCount: 10);

        progress.PercentFullyComplete.Should().Be(10);
    }

    [Test]
    public void PercentComplete_WithZeroTotal_ReturnsZero()
    {
        var progress = CodexProgress.Create(
            Guid.NewGuid(),
            totalEntries: 0,
            discoveredCount: 0,
            completeCount: 0);

        progress.PercentComplete.Should().Be(0);
    }
}
```

---

## 12. Use Cases

### UC-001: View Codex Overview
**Actor:** Player
**Flow:** Enter `codex` command -> See category list -> See progress for each category -> See overall completion percentage

### UC-002: View Specific Entry
**Actor:** Player
**Flow:** Enter `codex goblin` -> See entry title and category -> See visible content sections -> See related entries (if discovered)

### UC-003: Search Codex
**Actor:** Player
**Flow:** Enter `codex search sword` -> See matching entries -> Select entry to view -> View entry content

### UC-004: Discover Entry by Combat
**Actor:** Player
**Flow:** Defeat goblin -> CombatService notifies CodexService -> Entry unlocked -> Discovery notification displayed

### UC-005: Discover Entry by Examination
**Actor:** Player
**Flow:** Examine iron sword -> ItemService notifies CodexService -> Entry unlocked -> Discovery notification displayed

### UC-006: Reveal More Content
**Actor:** Player
**Flow:** Defeat 5 goblins -> RevealCondition triggered -> Additional section revealed -> "New information" notification

### UC-007: Configure New Entry
**Actor:** Game Designer
**Flow:** Edit codex-entries.json -> Add entry definition -> Start game -> Entry discoverable

---

## 13. Acceptance Criteria

### AC-2.1a-1: Codex Entity
- [ ] CodexEntry entity can be created from CodexEntryDefinition
- [ ] CodexEntry stores Id, DefinitionId, PlayerId, Category, Title, State
- [ ] CodexEntry tracks RevealedSections and TotalSections
- [ ] CodexEntry.IsComplete returns true when all sections revealed
- [ ] CodexEntry.RevealSections increases revealed count correctly

### AC-2.1a-2: CodexCategory Enum
- [ ] CodexCategory has 8 values: Bestiary, Locations, ItemsAndArtifacts, Characters, Factions, History, Legends, CraftingKnowledge
- [ ] All values have XML documentation

### AC-2.1a-3: UnlockTriggerType Enum
- [ ] UnlockTriggerType has 7 values: DefeatMonster, ExamineItem, AcquireItem, ExploreRoom, DialogueChoice, ReadDocument, FlagSet
- [ ] All values have XML documentation

### AC-2.1a-4: Codex Commands
- [ ] `codex` command shows category overview with progress
- [ ] `codex <topic>` shows entry content (if discovered)
- [ ] `codex <topic>` shows error if not discovered
- [ ] `codex search <term>` returns matching entries
- [ ] Empty search returns helpful message

### AC-2.1a-5: Discovery Mechanics
- [ ] Defeating monster triggers DefeatMonster unlock check
- [ ] Examining item triggers ExamineItem unlock check
- [ ] Entering room triggers ExploreRoom unlock check
- [ ] Dialogue choices trigger DialogueChoice unlock check
- [ ] Flag changes trigger FlagSet unlock check

### AC-2.1a-6: Progress Tracking
- [ ] CodexProgress tracks total, discovered, and complete counts
- [ ] CodexProgress tracks per-category progress
- [ ] PercentComplete calculates correctly
- [ ] GetCategoryProgress returns correct tuple

### AC-2.1a-7: Configuration
- [ ] Entries can be defined in codex-entries.json
- [ ] codex-entries.schema.json validates configuration
- [ ] Invalid configuration produces clear error messages
- [ ] All entry properties are configurable

### AC-2.1a-8: Logging
- [ ] Service initialization logs entry definition count
- [ ] Entry discovery logs player, entry title, and definition ID
- [ ] Section reveal logs count, entry title, and player ID

### AC-2.1a-9: Unit Tests
- [ ] ~30 unit tests implemented
- [ ] All tests pass
- [ ] Tests cover happy path and error cases

---

## 14. Deliverable Checklist

### Domain Layer
- [ ] `Entities/CodexEntry.cs`
- [ ] `Definitions/CodexEntryDefinition.cs`
- [ ] `Enums/CodexCategory.cs`
- [ ] `Enums/CodexEntryState.cs`
- [ ] `Enums/UnlockTriggerType.cs`
- [ ] `ValueObjects/CodexSection.cs`
- [ ] `ValueObjects/CodexUnlockCondition.cs`
- [ ] `ValueObjects/CodexProgress.cs`
- [ ] `ValueObjects/CodexUnlockResult.cs`

### Application Layer
- [ ] `Interfaces/ICodexService.cs`
- [ ] `Services/CodexService.cs`
- [ ] `Services/GameSessionService.cs` updates (codex methods)
- [ ] `DTOs/CodexSummaryDto.cs`
- [ ] `DTOs/CodexCategoryDto.cs`
- [ ] `DTOs/CodexEntryDto.cs`
- [ ] `DTOs/CodexSectionDto.cs`
- [ ] `DTOs/CodexSearchResultDto.cs`
- [ ] `Interfaces/IConfigurationProvider.cs` updates

### Infrastructure Layer
- [ ] `Configuration/JsonConfigurationProvider.cs` updates (LoadCodexEntryDefinitions)

### Configuration Files
- [ ] `config/codex-entries.json`
- [ ] `config/schemas/codex-entries.schema.json`

### Presentation Layer
- [ ] Codex command handler
- [ ] InputHandler updates (parse codex commands)
- [ ] IGameRenderer updates (RenderCodex, RenderCodexEntry, RenderCodexSearch)

### Integration Updates
- [ ] CombatService - notify on monster defeat
- [ ] ItemService - notify on examine
- [ ] RoomService - notify on room enter
- [ ] DialogueService - notify on dialogue choice

### Tests
- [ ] `Domain.Tests/Entities/CodexEntryTests.cs`
- [ ] `Domain.Tests/Definitions/CodexEntryDefinitionTests.cs`
- [ ] `Domain.Tests/ValueObjects/CodexUnlockConditionTests.cs`
- [ ] `Domain.Tests/ValueObjects/CodexProgressTests.cs`
- [ ] `Application.Tests/Services/CodexServiceTests.cs`

### Documentation
- [ ] XML documentation on all public members
- [ ] JSON schema documentation

---

## 15. Dependencies

### Required from Previous Versions

#### From v0.2.0a (NPC Foundation)
| Component | Purpose for v0.2.1a |
|-----------|---------------------|
| `NPC` entity | DialogueChoice triggers unlock codex entries about characters |
| `NPCService` | Integration point for dialogue-based discovery |

#### From v0.2.0b (Dialogue System)
| Component | Purpose for v0.2.1a |
|-----------|---------------------|
| `DialogueService` | Notify CodexService on dialogue choices |
| `DialogueOutcome` | FlagSet triggers can unlock entries |
| Dialogue flags | Condition checking for unlock/reveal |

#### From v0.2.0c (Reputation & Memory)
| Component | Purpose for v0.2.1a |
|-----------|---------------------|
| `FactionDefinition` | Faction entries in codex |
| Dialogue flags | Persistent state for unlock conditions |

#### From Combat System
| Component | Purpose for v0.2.1a |
|-----------|---------------------|
| `CombatService` | Notify on monster defeat |
| `Monster` entity | DefeatMonster trigger target |

#### From Item System
| Component | Purpose for v0.2.1a |
|-----------|---------------------|
| `ItemService` | Notify on item examine/acquire |
| `Item` entity | ExamineItem/AcquireItem trigger target |

#### From Room System
| Component | Purpose for v0.2.1a |
|-----------|---------------------|
| `Room` entity | ExploreRoom trigger target |
| Room navigation | Trigger room entry events |

### Provided to v0.2.1b (Lore Fragments)
- CodexEntry entity as base for fragment tracking
- CodexService for managing fragment collection
- Discovery trigger system for fragment unlocks

### Provided to v0.2.1c (Codex UI Enhancements)
- CodexProgress for UI display
- CodexEntry for detailed view
- Search functionality for UI

---

## 16. Future Considerations

### Deferred to v0.2.1b
- **Lore Fragments**: Scattered pieces of larger lore entries
- **Fragment Collection**: Collecting all fragments completes entry
- **Fragment Sources**: Different locations/sources for fragments

### Deferred to v0.2.1c
- **Codex Hints**: Incomplete entries suggest where to find more
- **Achievement Unlocks**: Milestones for codex completion
- **Cross-references**: Clickable links between related entries

### Deferred to v0.2.1d
- **TUI Interface**: Navigable text-based codex browser
- **GUI Interface**: Visual codex with images and formatting
- **Category Filtering**: Advanced filtering and sorting

### Out of Scope
- **Codex Achievements**: Achievement system integration
- **Codex Sharing**: Multiplayer codex sharing
- **Codex Export**: Exporting codex to external format
- **Audio Entries**: Voice-over for codex content

---

*Document Version: 1.0*
*Last Updated: 2024-01-20*
*Author: Claude Code*
