# v0.4.3d Design Specification: Skills & Environment

**Version:** 0.4.3d  
**Phase Name:** Skills & Environment  
**Parent Version:** v0.4.3 (Light & Environment Systems)  
**Prerequisites:** v0.4.3c Complete (Skills Foundation)  
**Estimated Tests:** ~25 unit tests

---

## Table of Contents

1. [Executive Summary](#1-executive-summary)
2. [Feature Overview](#2-feature-overview)
3. [Architecture Diagrams](#3-architecture-diagrams)
4. [Skill Integrations](#4-skill-integrations)
5. [GameTime Value Object](#5-gametime-value-object)
6. [Weather System](#6-weather-system)
7. [Service Modifications](#7-service-modifications)
8. [User-Facing Commands](#8-user-facing-commands)
9. [Configuration File Schemas](#9-configuration-file-schemas)
10. [Logging Specifications](#10-logging-specifications)
11. [Unit Testing Requirements](#11-unit-testing-requirements)
12. [Decision Trees](#12-decision-trees)
13. [Use Cases](#13-use-cases)
14. [Deliverable Checklist](#14-deliverable-checklist)
15. [Acceptance Criteria](#15-acceptance-criteria)
16. [Dependencies](#16-dependencies)
17. [Future Considerations](#17-future-considerations)

---

## 1. Executive Summary

### 1.1 Purpose

This specification integrates the skills foundation (v0.4.3c) with existing game systems and adds environmental features. Specific skills now affect gameplay mechanics, and outdoor areas respond to day/night cycles and weather conditions.

### 1.2 Key Deliverables

| Category | Items |
|----------|-------|
| **Value Objects** | `GameTime`, `Weather` |
| **Enums** | `TimeOfDay`, `WeatherType` |
| **Service Updates** | `TrapService`, `CombatService`, `LockService`, `HealingService` |
| **Commands** | `time` |
| **Configuration** | `time-weather.json`, `time-weather.schema.json` |
| **Tests** | ~25 unit tests |

### 1.3 Architectural Significance

This version establishes **two major patterns**:

**Skill Integration Pattern:**
- Skills modify existing service calculations
- Experience awarded automatically on skill usage
- Light/weather conditions apply modifiers to skill checks

**Environment Pattern:**
- `GameTime` tracks in-game time progression
- `Weather` applies visibility modifiers
- Outdoor rooms calculate light from time + weather

---

## 2. Feature Overview

```
v0.4.3d Skills & Environment
├── Skill Integrations
│   ├── Perception → TrapService (detection DC)
│   ├── Stealth → CombatService (surprise rolls)
│   ├── Lockpicking → LockService (pick locks)
│   ├── Acrobatics → MovementService (jumps, climbs)
│   ├── Field Medicine → HealingService (wound treatment)
│   ├── Wilderness Survival → ExplorationService (foraging)
│   └── Rhetoric → NpcService (dialogue checks)
├── GameTime
│   ├── Hour (0-23), Day
│   ├── TimeOfDay enum (Dawn, Morning, Noon, etc.)
│   ├── IsDaytime, IsNighttime
│   ├── AdvanceTurn(), AdvanceHours()
│   └── GetOutdoorLightLevel()
├── Weather
│   ├── WeatherType enum
│   ├── VisibilityModifier
│   ├── AffectsLight
│   └── GetDescription()
└── Commands
    └── time
```

### 2.1 Scope Alignment

**In Scope:**
- Perception skill integration with trap detection
- Stealth skill integration with monster surprise
- Lockpicking skill for locked objects
- Acrobatics for movement-related checks
- Field Medicine for out-of-combat healing
- Rhetoric for NPC interaction checks
- GameTime value object for time tracking
- TimeOfDay enum (Dawn, Morning, Noon, Afternoon, Dusk, Evening, Night)
- WeatherType enum (Clear, Cloudy, LightRain, HeavyRain, Fog, Storm)
- Weather visibility modifiers
- Day/night affecting outdoor room light levels
- `time` command
- ~25 unit tests

**Out of Scope:**
- Weather affecting combat damage (future)
- Seasons (future)
- Complex skill trees (future)
- NPC training for skills (future)

---

## 3. Architecture Diagrams

### 3.1 Skill Integration Flow

```
┌─────────────────────────────────────────────────────────────────────┐
│                    SKILL INTEGRATION PATTERN                         │
└─────────────────────────────────────────────────────────────────────┘

   Game System              SkillService            PlayerSkill
       │                         │                      │
       │  Need skill bonus       │                      │
       ├────────────────────────▶│                      │
       │                         │                      │
       │                         │  Get proficiency     │
       │                         ├─────────────────────▶│
       │                         │                      │
       │                         │  ◀── bonus ─────────│
       │                         │                      │
       │  ◀── skill bonus ───────│                      │
       │                         │                      │
       │  Perform check          │                      │
       │  Roll + bonus vs DC     │                      │
       │                         │                      │
       │  Award experience       │                      │
       ├────────────────────────▶│                      │
       │                         │  Add experience      │
       │                         ├─────────────────────▶│
       │                         │                      │
       ▼                         ▼                      ▼
```

### 3.2 Day/Night Cycle Flow

```
┌─────────────────────────────────────────────────────────────────────┐
│                    DAY/NIGHT CYCLE FLOW                              │
└─────────────────────────────────────────────────────────────────────┘

  GameSession              GameTime               Room
       │                      │                    │
       │  AdvanceTurn()       │                    │
       ├─────────────────────▶│                    │
       │                      │                    │
       │  [Every N turns]     │                    │
       │  Hour increments     │                    │
       │                      │                    │
       │  Render room         │                    │
       │──────────────────────┼───────────────────▶│
       │                      │                    │
       │                      │  [If outdoor]      │
       │                      │  GetOutdoorLight() │
       │                      │◀───────────────────│
       │                      │                    │
       │                      │  TimeOfDay +       │
       │                      │  Weather → Light   │
       │                      │───────────────────▶│
       │                      │                    │
       ▼                      ▼                    ▼
```

### 3.3 Layer Diagram

```
┌─────────────────────────────────────────────────────────────────────┐
│                        PRESENTATION LAYER                            │
├─────────────────────────────────────────────────────────────────────┤
│  TimeCommand                                                         │
│  "time" → Display current time and weather                          │
│                                                                      │
│  Room Description Updates                                            │
│  [Outdoor] Show time/weather in description                          │
└───────┬─────────────────────────────────────────────────────────────┘
        │
        ▼
┌─────────────────────────────────────────────────────────────────────┐
│                       APPLICATION LAYER                              │
├─────────────────────────────────────────────────────────────────────┤
│  TrapService (Modified)                                              │
│  ├── CheckPassiveDetection() uses Perception skill                  │
│  └── Awards Perception experience                                   │
│                                                                      │
│  CombatService (Modified)                                            │
│  ├── CheckSurpriseRound() uses Stealth skill                        │
│  ├── Light modifiers affect Stealth bonus                           │
│  └── Awards Stealth experience                                      │
│                                                                      │
│  LockService (Modified)                                              │
│  ├── AttemptLockpick() uses Lockpicking skill                       │
│  ├── Requires trained Lockpicking                                   │
│  └── Awards Lockpicking experience                                  │
│                                                                      │
│  HealingService (New or Modified)                                    │
│  ├── TreatWounds() uses Field Medicine skill                        │
│  └── Awards Field Medicine experience                               │
│                                                                      │
│  TimeService (New)                                                   │
│  ├── AdvanceTurn() → Updates GameTime                               │
│  ├── GetCurrentTime() → Display string                              │
│  └── GetOutdoorLightLevel() → Light for outdoor rooms               │
│                                                                      │
│  WeatherService (New)                                                │
│  ├── GenerateWeather() → Random weather per region                  │
│  ├── AdvanceWeather() → Duration tracking                           │
│  └── GetVisibilityModifier() → Skill check modifier                 │
└───────┬─────────────────────────────────────────────────────────────┘
        │
        ▼
┌─────────────────────────────────────────────────────────────────────┐
│                         DOMAIN LAYER                                 │
├─────────────────────────────────────────────────────────────────────┤
│  ┌────────────────────────────────────────────────────────────────┐ │
│  │ GameTime (Value Object)                                        │ │
│  ├────────────────────────────────────────────────────────────────┤ │
│  │ + Hour: int (0-23)                                             │ │
│  │ + Day: int                                                     │ │
│  │ + TurnCount: int                                               │ │
│  │ + TimeOfDay: TimeOfDay                                         │ │
│  │ + IsDaytime: bool                                              │ │
│  │ + IsNighttime: bool                                            │ │
│  │ + AdvanceTurn(turnsPerHour): void                              │ │
│  │ + AdvanceHours(hours): void                                    │ │
│  │ + GetOutdoorLightLevel(weather): LightLevel                    │ │
│  │ + GetDisplayString(): string                                   │ │
│  └────────────────────────────────────────────────────────────────┘ │
│                                                                      │
│  ┌────────────────────────────────────────────────────────────────┐ │
│  │ Weather (Value Object)                                         │ │
│  ├────────────────────────────────────────────────────────────────┤ │
│  │ + Type: WeatherType                                            │ │
│  │ + Duration: int (-1 = indefinite)                              │ │
│  │ + VisibilityModifier: int                                      │ │
│  │ + AffectsLight: bool                                           │ │
│  │ + AdvanceHour(): bool                                          │ │
│  │ + GetDescription(): string                                     │ │
│  └────────────────────────────────────────────────────────────────┘ │
│                                                                      │
│  ┌──────────────────┐  ┌──────────────────┐                         │
│  │ TimeOfDay (Enum) │  │ WeatherType      │                         │
│  ├──────────────────┤  │     (Enum)       │                         │
│  │ Dawn             │  ├──────────────────┤                         │
│  │ Morning          │  │ Clear            │                         │
│  │ Noon             │  │ Cloudy           │                         │
│  │ Afternoon        │  │ LightRain        │                         │
│  │ Dusk             │  │ HeavyRain        │                         │
│  │ Evening          │  │ Fog              │                         │
│  │ Night            │  │ Storm            │                         │
│  └──────────────────┘  └──────────────────┘                         │
└─────────────────────────────────────────────────────────────────────┘
```

---

## 4. Skill Integrations

### 4.1 Perception → Trap Detection

**File:** `src/Core/RuneAndRust.Application/Services/TrapService.cs`

```csharp
/// <summary>
/// Checks for passive trap detection using Perception skill.
/// </summary>
/// <remarks>
/// <para>
/// Detection formula: 2d6 + Perception bonus - light penalty >= trap DC
/// </para>
/// <para>
/// Experience awarded: 10 on success, 5 on failure.
/// </para>
/// </remarks>
public TrapDetectionResult CheckPassiveDetection(
    Player player,
    Trap trap,
    Room room,
    ISkillService skillService,
    ILightService lightService)
{
    // Get Perception bonus from skill service
    var perceptionBonus = skillService.GetSkillBonus(player, "perception");

    // Get light penalty
    var effectiveLightLevel = lightService.GetEffectiveLightLevel(player, room);
    var lightPenalty = LightPenalties.GetPerceptionDCModifier(effectiveLightLevel);

    // Roll detection
    var roll = _diceService.Roll("2d6").Total;
    var total = roll + perceptionBonus - lightPenalty;

    var detected = total >= trap.DetectionDC;

    // Award experience
    var expAmount = detected ? 10 : 5;
    skillService.AwardSkillExperience(player, "perception", expAmount);

    _logger.LogInformation(
        "Trap detection: Roll {Roll} + {Bonus} - {Penalty} = {Total} vs DC {DC} = {Result}",
        roll, perceptionBonus, lightPenalty, total, trap.DetectionDC,
        detected ? "Detected" : "Missed");

    return new TrapDetectionResult(
        trap.Id,
        detected,
        roll,
        perceptionBonus,
        lightPenalty,
        total,
        trap.DetectionDC,
        detected ? "You spot a trap!" : "You don't notice anything.");
}
```

### 4.2 Stealth → Monster Surprise

**File:** `src/Core/RuneAndRust.Application/Services/CombatService.cs`

```csharp
/// <summary>
/// Checks if player can surprise a monster using Stealth skill.
/// </summary>
/// <remarks>
/// <para>
/// Surprise formula: 2d6 + Stealth bonus + light modifier >= monster perception DC
/// </para>
/// <para>
/// Light modifier: +3 in Dark, +1 in Dim, -2 in Bright, +5 in MagicalDarkness.
/// </para>
/// </remarks>
public SurpriseCheckResult CheckSurprise(
    Player player,
    Monster monster,
    Room room,
    ISkillService skillService,
    ILightService lightService)
{
    // Player must be hiding
    if (!player.IsHiding)
        return SurpriseCheckResult.NotHiding;

    var stealthBonus = skillService.GetSkillBonus(player, "stealth");
    var lightModifier = GetStealthLightModifier(room.CurrentLightLevel);

    var roll = _diceService.Roll("2d6").Total;
    var total = roll + stealthBonus + lightModifier;
    var perceptionDC = 10 + monster.PerceptionModifier;

    var success = total >= perceptionDC;

    // Award experience
    skillService.AwardSkillExperience(player, "stealth", success ? 15 : 5);

    _logger.LogInformation(
        "Surprise check: Roll {Roll} + {Stealth} + {Light} = {Total} vs DC {DC}",
        roll, stealthBonus, lightModifier, total, perceptionDC);

    return new SurpriseCheckResult(success, roll, stealthBonus, lightModifier, total, perceptionDC);
}

/// <summary>
/// Gets the Stealth modifier based on light level.
/// </summary>
private static int GetStealthLightModifier(LightLevel level) => level switch
{
    LightLevel.MagicalDarkness => 5,
    LightLevel.Dark => 3,
    LightLevel.Dim => 1,
    LightLevel.Bright => -2,
    _ => 0
};
```

### 4.3 Lockpicking → Unlock Objects

**File:** `src/Core/RuneAndRust.Application/Services/LockService.cs` (new or modified)

```csharp
/// <summary>
/// Attempts to pick a lock using the Lockpicking skill.
/// </summary>
/// <remarks>
/// <para>
/// Lockpicking requires at least Novice proficiency.
/// </para>
/// <para>
/// Pick formula: 2d6 + Lockpicking bonus >= lock DC
/// </para>
/// </remarks>
public LockpickResult AttemptLockpick(
    Player player,
    InteractiveObject lockedObject,
    ISkillService skillService)
{
    // Check for trained lockpicking
    var proficiency = player.GetSkillProficiency("lockpicking");
    if (proficiency == SkillProficiency.Untrained)
    {
        return new LockpickResult(
            false, 0, 0, 0, 0,
            "You don't know how to pick locks.");
    }

    var lockpickBonus = skillService.GetSkillBonus(player, "lockpicking");
    var roll = _diceService.Roll("2d6").Total;
    var total = roll + lockpickBonus;

    var lockDC = lockedObject.Lock?.LockpickDC ?? 15;
    var success = total >= lockDC;

    // Award experience
    skillService.AwardSkillExperience(player, "lockpicking", success ? 20 : 10);

    _logger.LogInformation(
        "Lockpick attempt: Roll {Roll} + {Bonus} = {Total} vs DC {DC}",
        roll, lockpickBonus, total, lockDC);

    return new LockpickResult(
        success, roll, lockpickBonus, total, lockDC,
        success ? "Click! The lock opens." : "The lock resists your attempts.");
}
```

### 4.4 Field Medicine → Healing

```csharp
/// <summary>
/// Treats wounds using Field Medicine skill.
/// </summary>
/// <remarks>
/// <para>
/// Healing formula: Skill bonus + 1d6 HP restored.
/// </para>
/// <para>
/// Can only be used once per rest period per target.
/// </para>
/// </remarks>
public HealingResult TreatWounds(
    Player healer,
    Player target,
    ISkillService skillService)
{
    var medicineBonus = skillService.GetSkillBonus(healer, "field-medicine");
    var healRoll = _diceService.Roll("1d6").Total;
    var healAmount = medicineBonus + healRoll;

    target.Heal(healAmount);

    // Award experience based on amount healed
    var expAmount = Math.Min(healAmount * 2, 25);
    skillService.AwardSkillExperience(healer, "field-medicine", expAmount);

    _logger.LogInformation(
        "Field medicine: {Healer} healed {Target} for {Amount} HP",
        healer.Name, target.Name, healAmount);

    return new HealingResult(true, healAmount,
        $"You treat the wounds, restoring {healAmount} HP.");
}
```

---

## 5. GameTime Value Object

**File:** `src/Core/RuneAndRust.Domain/ValueObjects/GameTime.cs`

```csharp
namespace RuneAndRust.Domain.ValueObjects;

/// <summary>
/// Tracks in-game time for day/night cycle and event scheduling.
/// </summary>
/// <remarks>
/// <para>
/// Time advances with turns. Default is 6 turns per hour.
/// </para>
/// <para>
/// Day/night affects outdoor room light levels:
/// <list type="bullet">
///   <item><description>Night (0:00-5:00, 20:00-23:59): Dark</description></item>
///   <item><description>Dawn/Dusk (5:00-7:00, 17:00-20:00): Dim</description></item>
///   <item><description>Day (7:00-17:00): Bright</description></item>
/// </list>
/// </para>
/// </remarks>
public class GameTime
{
    /// <summary>
    /// Gets the current hour (0-23).
    /// </summary>
    public int Hour { get; private set; }

    /// <summary>
    /// Gets the current day (1+).
    /// </summary>
    public int Day { get; private set; } = 1;

    /// <summary>
    /// Gets the accumulated turn count within the current hour.
    /// </summary>
    public int TurnCount { get; private set; }

    /// <summary>
    /// Gets whether it is daytime (6:00 - 18:00).
    /// </summary>
    public bool IsDaytime => Hour >= 6 && Hour < 18;

    /// <summary>
    /// Gets whether it is nighttime.
    /// </summary>
    public bool IsNighttime => !IsDaytime;

    /// <summary>
    /// Gets the current time of day descriptor.
    /// </summary>
    public TimeOfDay TimeOfDay => Hour switch
    {
        >= 5 and < 7 => TimeOfDay.Dawn,
        >= 7 and < 12 => TimeOfDay.Morning,
        >= 12 and < 14 => TimeOfDay.Noon,
        >= 14 and < 17 => TimeOfDay.Afternoon,
        >= 17 and < 20 => TimeOfDay.Dusk,
        >= 20 and < 24 => TimeOfDay.Evening,
        _ => TimeOfDay.Night
    };

    private GameTime() { }

    /// <summary>
    /// Creates a new GameTime instance.
    /// </summary>
    public static GameTime Create(int hour = 8, int day = 1)
    {
        return new GameTime
        {
            Hour = Math.Clamp(hour, 0, 23),
            Day = Math.Max(1, day),
            TurnCount = 0
        };
    }

    /// <summary>
    /// Advances time by one turn.
    /// </summary>
    /// <param name="turnsPerHour">Number of turns that equal one hour.</param>
    public void AdvanceTurn(int turnsPerHour = 6)
    {
        TurnCount++;
        if (TurnCount >= turnsPerHour)
        {
            TurnCount = 0;
            AdvanceHours(1);
        }
    }

    /// <summary>
    /// Advances time by specified hours.
    /// </summary>
    public void AdvanceHours(int hours)
    {
        Hour += hours;
        while (Hour >= 24)
        {
            Hour -= 24;
            Day++;
        }
    }

    /// <summary>
    /// Gets a display string for the current time.
    /// </summary>
    public string GetDisplayString()
    {
        var period = Hour >= 12 ? "PM" : "AM";
        var displayHour = Hour > 12 ? Hour - 12 : (Hour == 0 ? 12 : Hour);
        return $"Day {Day}, {displayHour}:00 {period} ({TimeOfDay})";
    }

    /// <summary>
    /// Gets the light level for outdoor areas based on time and weather.
    /// </summary>
    public LightLevel GetOutdoorLightLevel(WeatherType weather)
    {
        // Base light from time of day
        var baseLight = TimeOfDay switch
        {
            TimeOfDay.Night => LightLevel.Dark,
            TimeOfDay.Dawn or TimeOfDay.Dusk => LightLevel.Dim,
            _ => LightLevel.Bright
        };

        // Weather can reduce light
        if (weather is WeatherType.Fog or WeatherType.HeavyRain or WeatherType.Storm)
        {
            return baseLight switch
            {
                LightLevel.Bright => LightLevel.Dim,
                LightLevel.Dim => LightLevel.Dark,
                _ => baseLight
            };
        }

        return baseLight;
    }

    public override string ToString() => GetDisplayString();
}
```

---

## 6. Weather System

### 6.1 WeatherType Enum

**File:** `src/Core/RuneAndRust.Domain/Enums/WeatherType.cs`

```csharp
namespace RuneAndRust.Domain.Enums;

/// <summary>
/// Types of weather conditions affecting outdoor areas.
/// </summary>
public enum WeatherType
{
    /// <summary>Clear skies, no visibility penalty.</summary>
    Clear,

    /// <summary>Overcast, no visibility penalty.</summary>
    Cloudy,

    /// <summary>Light rain, minor visibility penalty (-1).</summary>
    LightRain,

    /// <summary>Heavy rain, significant visibility penalty (-3).</summary>
    HeavyRain,

    /// <summary>Dense fog, major visibility penalty (-4).</summary>
    Fog,

    /// <summary>Violent storm, severe visibility penalty (-5).</summary>
    Storm
}
```

### 6.2 TimeOfDay Enum

**File:** `src/Core/RuneAndRust.Domain/Enums/TimeOfDay.cs`

```csharp
namespace RuneAndRust.Domain.Enums;

/// <summary>
/// Descriptive periods of the day.
/// </summary>
public enum TimeOfDay
{
    Dawn,       // 5:00 - 7:00
    Morning,    // 7:00 - 12:00
    Noon,       // 12:00 - 14:00
    Afternoon,  // 14:00 - 17:00
    Dusk,       // 17:00 - 20:00
    Evening,    // 20:00 - 24:00
    Night       // 0:00 - 5:00
}
```

### 6.3 Weather Value Object

**File:** `src/Core/RuneAndRust.Domain/ValueObjects/Weather.cs`

```csharp
namespace RuneAndRust.Domain.ValueObjects;

/// <summary>
/// Current weather conditions affecting outdoor areas.
/// </summary>
public class Weather
{
    /// <summary>
    /// Gets the current weather type.
    /// </summary>
    public WeatherType Type { get; private set; } = WeatherType.Clear;

    /// <summary>
    /// Gets the remaining duration in hours (-1 = indefinite).
    /// </summary>
    public int Duration { get; private set; } = -1;

    /// <summary>
    /// Gets the visibility modifier for skill checks.
    /// </summary>
    public int VisibilityModifier => Type switch
    {
        WeatherType.Clear => 0,
        WeatherType.Cloudy => 0,
        WeatherType.LightRain => -1,
        WeatherType.HeavyRain => -3,
        WeatherType.Fog => -4,
        WeatherType.Storm => -5,
        _ => 0
    };

    /// <summary>
    /// Gets whether this weather affects light levels.
    /// </summary>
    public bool AffectsLight =>
        Type is WeatherType.Fog or WeatherType.HeavyRain or WeatherType.Storm;

    private Weather() { }

    public static Weather Create(WeatherType type, int duration = -1)
    {
        return new Weather
        {
            Type = type,
            Duration = duration
        };
    }

    public static Weather Clear() => Create(WeatherType.Clear);

    /// <summary>
    /// Advances weather duration by one hour.
    /// </summary>
    /// <returns>True if weather ended.</returns>
    public bool AdvanceHour()
    {
        if (Duration < 0)
            return false;

        Duration--;
        return Duration <= 0;
    }

    /// <summary>
    /// Gets a descriptive string for the weather.
    /// </summary>
    public string GetDescription() => Type switch
    {
        WeatherType.Clear => "Clear skies",
        WeatherType.Cloudy => "Overcast",
        WeatherType.LightRain => "Light rain falls",
        WeatherType.HeavyRain => "Heavy rain pours down",
        WeatherType.Fog => "Thick fog blankets the area",
        WeatherType.Storm => "A violent storm rages",
        _ => "Unknown weather"
    };

    public override string ToString() => GetDescription();
}
```

---

## 7. Service Modifications

### 7.1 New Result Types

```csharp
// TrapDetectionResult
public readonly record struct TrapDetectionResult(
    Guid TrapId,
    bool Detected,
    int Roll,
    int PerceptionBonus,
    int LightPenalty,
    int Total,
    int DC,
    string Message);

// SurpriseCheckResult
public readonly record struct SurpriseCheckResult(
    bool Success,
    int Roll,
    int StealthBonus,
    int LightModifier,
    int Total,
    int DC)
{
    public static SurpriseCheckResult NotHiding =>
        new(false, 0, 0, 0, 0, 0);
}

// LockpickResult
public readonly record struct LockpickResult(
    bool Success,
    int Roll,
    int Bonus,
    int Total,
    int DC,
    string Message);

// HealingResult
public readonly record struct HealingResult(
    bool Success,
    int HealAmount,
    string Message);
```

### 7.2 Room Modifications

```csharp
// Add to Room entity

/// <summary>
/// Gets whether this room is outdoors (affected by time/weather).
/// </summary>
public bool IsOutdoor { get; private set; }

/// <summary>
/// Calculates current light level considering time and weather for outdoor rooms.
/// </summary>
public LightLevel CalculateCurrentLightLevel(GameTime? time = null, Weather? weather = null)
{
    // Check for active player light sources
    var activeSources = _lightSources.Where(ls => ls.IsActive).ToList();
    if (activeSources.Any())
    {
        var brightestSource = activeSources.Max(ls => ls.ProvidedLight);
        if (brightestSource < BaseLightLevel)
            return BaseLightLevel;
        return brightestSource;
    }

    // Outdoor rooms use time/weather
    if (IsOutdoor && time != null)
    {
        var weatherType = weather?.Type ?? WeatherType.Clear;
        return time.GetOutdoorLightLevel(weatherType);
    }

    return BaseLightLevel;
}
```

---

## 8. User-Facing Commands

### 8.1 Time Command

```
> time

Current Time: Day 3, 2:00 PM (Afternoon)
Weather: Light rain falls

The afternoon sun is partially obscured by rain clouds.
```

### 8.2 Room Description with Time/Weather

```
Forest Clearing                          [Dim]
=============================================
Day 3, 7:15 PM (Dusk)

The sun sets behind the trees, casting long shadows
across the clearing. A light rain patters on the leaves.

[Light rain: -1 visibility]

Exits: north (forest path), south (cave entrance)
```

### 8.3 Night Time Display

```
Forest Clearing                          [Dark]
=============================================
Day 3, 11:00 PM (Night)

Darkness has fallen over the forest. The stars are
hidden behind thick clouds.

[DARKNESS PENALTIES ACTIVE]
Without a light source, you can barely see.

Exits: north, south (you can see dim light)
```

### 8.4 Skill Check with Environmental Modifiers

```
> search

You examine the area carefully...

[Skill Check: Perception]
Roll: 2d6 = [5, 3] = 8
Skill Bonus: +3 (Journeyman)
Weather Penalty: -1 (Light rain)
Total: 10 vs DC 12

The rain makes it difficult to spot details.
[+5 Perception experience]
```

---

## 9. Configuration File Schemas

### 9.1 time-weather.json

**File:** `config/time-weather.json`

```json
{
  "$schema": "./schemas/time-weather.schema.json",
  "timeSettings": {
    "startingHour": 8,
    "startingDay": 1,
    "turnsPerHour": 6,
    "enableDayNightCycle": true
  },
  "weatherPatterns": [
    {
      "id": "temperate-forest",
      "region": "Forest",
      "patterns": [
        { "type": "Clear", "weight": 40 },
        { "type": "Cloudy", "weight": 25 },
        { "type": "LightRain", "weight": 20 },
        { "type": "HeavyRain", "weight": 10 },
        { "type": "Fog", "weight": 5 }
      ]
    },
    {
      "id": "dungeon-interior",
      "region": "Dungeon",
      "patterns": [
        { "type": "Clear", "weight": 100 }
      ]
    },
    {
      "id": "mountain-peak",
      "region": "Mountain",
      "patterns": [
        { "type": "Clear", "weight": 30 },
        { "type": "Cloudy", "weight": 20 },
        { "type": "Storm", "weight": 25 },
        { "type": "Fog", "weight": 25 }
      ]
    }
  ]
}
```

### 9.2 JSON Schema

**File:** `config/schemas/time-weather.schema.json`

```json
{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "title": "Time and Weather Configuration",
  "type": "object",
  "properties": {
    "timeSettings": {
      "type": "object",
      "properties": {
        "startingHour": { "type": "integer", "minimum": 0, "maximum": 23 },
        "startingDay": { "type": "integer", "minimum": 1 },
        "turnsPerHour": { "type": "integer", "minimum": 1, "maximum": 60 },
        "enableDayNightCycle": { "type": "boolean" }
      },
      "required": ["startingHour", "turnsPerHour"]
    },
    "weatherPatterns": {
      "type": "array",
      "items": {
        "type": "object",
        "properties": {
          "id": { "type": "string" },
          "region": { "type": "string" },
          "patterns": {
            "type": "array",
            "items": {
              "type": "object",
              "properties": {
                "type": { "enum": ["Clear", "Cloudy", "LightRain", "HeavyRain", "Fog", "Storm"] },
                "weight": { "type": "integer", "minimum": 0 }
              },
              "required": ["type", "weight"]
            }
          }
        },
        "required": ["id", "patterns"]
      }
    }
  }
}
```

---

## 10. Logging Specifications

### 10.1 Logging Table

| Component | Level | Event | Template |
|-----------|-------|-------|----------|
| TrapService | Information | Detection check | `"Trap detection: Roll {Roll} + {Bonus} - {Penalty} = {Total} vs DC {DC} = {Result}"` |
| TrapService | Debug | Experience award | `"Awarded {Exp} Perception experience to {Player}"` |
| CombatService | Information | Surprise check | `"Surprise check: Roll {Roll} + {Stealth} + {Light} = {Total} vs DC {DC}"` |
| LockService | Information | Lockpick attempt | `"Lockpick attempt: Roll {Roll} + {Bonus} = {Total} vs DC {DC}"` |
| LockService | Warning | Untrained attempt | `"Player {Player} attempted lockpicking without training"` |
| HealingService | Information | Treat wounds | `"Field medicine: {Healer} healed {Target} for {Amount} HP"` |
| TimeService | Debug | Time advance | `"Time advanced to {Hour}:00 on Day {Day}"` |
| WeatherService | Information | Weather change | `"Weather changed to {Weather} for {Duration} hours"` |

### 10.2 Logging Guidelines

```csharp
// Information - Important gameplay events
_logger.LogInformation(
    "Trap detection: Roll {Roll} + {Bonus} - {Penalty} = {Total} vs DC {DC} = {Result}",
    roll, perceptionBonus, lightPenalty, total, trap.DetectionDC,
    detected ? "Detected" : "Missed");

// Debug - Internal state changes
_logger.LogDebug(
    "Time advanced: Turns={TurnCount}, Hour={Hour}, Day={Day}",
    turnCount, hour, day);

// Warning - Unusual but valid scenarios
_logger.LogWarning(
    "Player {Player} attempted lockpicking without training",
    player.Name);
```

---

## 11. Unit Testing Requirements

### 11.1 Test Coverage

| Feature | Test File | Count |
|---------|-----------|-------|
| GameTime | `GameTimeTests.cs` | 6 |
| Weather | `WeatherTests.cs` | 4 |
| TimeOfDay/WeatherType Enums | `EnvironmentEnumTests.cs` | 2 |
| Perception Integration | `TrapServiceSkillTests.cs` | 4 |
| Stealth Integration | `CombatServiceStealthTests.cs` | 3 |
| Lockpicking Integration | `LockServiceTests.cs` | 3 |
| Field Medicine Integration | `HealingServiceTests.cs` | 3 |
| **Total** | | **~25** |

### 11.2 Test Examples

```csharp
[TestFixture]
public class GameTimeTests
{
    [Test]
    public void Create_WithDefaultValues_StartsAtMorning()
    {
        // Act
        var time = GameTime.Create();

        // Assert
        time.Hour.Should().Be(8);
        time.Day.Should().Be(1);
        time.TimeOfDay.Should().Be(TimeOfDay.Morning);
        time.IsDaytime.Should().BeTrue();
    }

    [Test]
    public void AdvanceTurn_AfterTurnsPerHour_IncrementsHour()
    {
        // Arrange
        var time = GameTime.Create(hour: 8);

        // Act - advance 6 turns (default turnsPerHour)
        for (int i = 0; i < 6; i++)
            time.AdvanceTurn();

        // Assert
        time.Hour.Should().Be(9);
    }

    [Test]
    public void GetOutdoorLightLevel_AtNight_ReturnsDark()
    {
        // Arrange
        var time = GameTime.Create(hour: 2);

        // Act
        var light = time.GetOutdoorLightLevel(WeatherType.Clear);

        // Assert
        light.Should().Be(LightLevel.Dark);
    }

    [Test]
    public void GetOutdoorLightLevel_AtNoonWithFog_ReturnsDim()
    {
        // Arrange
        var time = GameTime.Create(hour: 12);

        // Act
        var light = time.GetOutdoorLightLevel(WeatherType.Fog);

        // Assert
        light.Should().Be(LightLevel.Dim);
    }
}

[TestFixture]
public class TrapServiceSkillTests
{
    [Test]
    public void CheckPassiveDetection_WithHighPerception_DetectsEasierTrap()
    {
        // Arrange
        var player = CreatePlayerWithPerception(SkillProficiency.Expert);
        var trap = CreateTrap(detectionDC: 12);
        var room = CreateRoom(LightLevel.Bright);

        // Act
        var result = _service.CheckPassiveDetection(player, trap, room,
            _mockSkillService.Object, _mockLightService.Object);

        // Assert - with +4 bonus, easier to detect
        // Test depends on roll, use mock for deterministic testing
    }

    [Test]
    public void CheckPassiveDetection_AwardsExperience_OnSuccess()
    {
        // Arrange
        _mockDiceService.Setup(d => d.Roll("2d6")).Returns(new DiceResult(12));
        _mockSkillService.Setup(s => s.GetSkillBonus(It.IsAny<Player>(), "perception"))
            .Returns(3);

        // Act
        var result = _service.CheckPassiveDetection(player, trap, room,
            _mockSkillService.Object, _mockLightService.Object);

        // Assert
        _mockSkillService.Verify(
            s => s.AwardSkillExperience(player, "perception", 10),
            Times.Once);
    }
}
```

---

## 12. Decision Trees

### 12.1 Skill Check Decision Tree

```
SKILL CHECK FLOW
================

Player attempts skill action
          │
          ▼
    ┌─────────────────┐
    │ Is skill trained│  No   ┌────────────────────────┐
    │  required?      ├──────▶│ Is AllowUntrained true?│
    └────────┬────────┘       └───────────┬────────────┘
             │ Yes                        │
             │                    ┌───────┴───────┐
             ▼                    │ Yes      No   │
    ┌─────────────────┐           ▼               ▼
    │ Player has skill│    Continue         Return failure:
    │ at Novice+?     │                     "Requires training"
    └────────┬────────┘
             │
     ┌───────┴───────┐
     │ Yes      No   │
     ▼               ▼
 Continue       Return failure:
                "Need training"
     │
     ▼
┌─────────────────┐
│ Get skill bonus │
│ from service    │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│ Apply modifiers │
│ (light/weather) │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│ Roll 2d6 + mods │
│ vs DC           │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│ Award exp based │
│ on result       │
└────────┬────────┘
         │
         ▼
    Return result
```

### 12.2 Outdoor Light Level Decision Tree

```
OUTDOOR LIGHT CALCULATION
=========================

Room.CalculateCurrentLightLevel()
          │
          ▼
    ┌─────────────────┐
    │ Has active      │  Yes   Return brightest
    │ light source?   ├──────▶ active source level
    └────────┬────────┘
             │ No
             ▼
    ┌─────────────────┐
    │ Is room outdoor?│  No    Return BaseLightLevel
    └────────┬────────┘ ──────▶
             │ Yes
             ▼
    ┌─────────────────┐
    │ Get TimeOfDay   │
    │ from GameTime   │
    └────────┬────────┘
             │
             ▼
    ┌─────────────────────────────────────┐
    │ TimeOfDay → Base Light              │
    │   Night → Dark                      │
    │   Dawn/Dusk → Dim                   │
    │   Morning/Noon/Afternoon → Bright   │
    └────────┬────────────────────────────┘
             │
             ▼
    ┌─────────────────┐
    │ Does weather    │  Yes   Reduce one level:
    │ affect light?   ├──────▶ Bright→Dim, Dim→Dark
    │ (Fog/HeavyRain) │
    └────────┬────────┘
             │ No
             ▼
    Return base light
```

---

## 13. Use Cases

### UC-001: Trap Detection with Perception

**Actor:** Player  
**Precondition:** Player enters room with hidden trap  
**Flow:**
1. TrapService calls CheckPassiveDetection
2. Get Perception bonus from SkillService
3. Get light penalty from LightService
4. Roll 2d6 + bonus - penalty
5. Compare to trap DetectionDC
6. Award Perception experience (10 success, 5 fail)
7. If detected, reveal trap to player

### UC-002: Surprise Attack with Stealth

**Actor:** Player  
**Precondition:** Player is hiding, enters room with monster  
**Flow:**
1. CombatService calls CheckSurprise
2. Get Stealth bonus from SkillService
3. Calculate light modifier (darkness helps stealth)
4. Roll 2d6 + stealth + light modifier
5. Compare to monster perception DC
6. Award Stealth experience
7. If success, player gets surprise round

### UC-003: Pick Lock with Lockpicking

**Actor:** Player  
**Precondition:** Player has lockpicks, facing locked object  
**Flow:**
1. Verify player has trained Lockpicking (Novice+)
2. If untrained, return "Requires training"
3. Get Lockpicking bonus from SkillService
4. Roll 2d6 + bonus
5. Compare to lock DC
6. Award Lockpicking experience
7. If success, unlock object

### UC-004: Check Time Command

**Actor:** Player  
**Precondition:** None  
**Flow:**
1. Player enters `time` command
2. TimeService returns GameTime.GetDisplayString()
3. WeatherService returns current Weather
4. Display combined time/weather information

### UC-005: Day/Night Cycle in Outdoor Room

**Actor:** System  
**Precondition:** Player in outdoor room, GameTime tracking enabled  
**Flow:**
1. Player executes action (uses turn)
2. GameTime.AdvanceTurn() called
3. If hour changed, potentially change weather
4. When room renders, call CalculateCurrentLightLevel()
5. Outdoor room gets light from TimeOfDay + Weather
6. Display appropriate room description

---

## 14. Deliverable Checklist

### Domain Layer
- [ ] `TimeOfDay` enum
- [ ] `WeatherType` enum
- [ ] `GameTime` value object
- [ ] `Weather` value object
- [ ] Room modifications for outdoor/time/weather

### Application Layer
- [ ] TrapService Perception integration
- [ ] CombatService Stealth integration
- [ ] LockService Lockpicking integration
- [ ] HealingService Field Medicine integration
- [ ] TimeService (or GameSessionService updates)
- [ ] WeatherService (if separate)
- [ ] Result types for skill integrations

### Presentation Layer
- [ ] `time` command
- [ ] Room description updates for outdoor areas
- [ ] Time/weather display

### Configuration
- [ ] `time-weather.json`
- [ ] `time-weather.schema.json`

### Testing
- [ ] `GameTimeTests.cs` (~6 tests)
- [ ] `WeatherTests.cs` (~4 tests)
- [ ] `EnvironmentEnumTests.cs` (~2 tests)
- [ ] `TrapServiceSkillTests.cs` (~4 tests)
- [ ] `CombatServiceStealthTests.cs` (~3 tests)
- [ ] `LockServiceTests.cs` (~3 tests)
- [ ] `HealingServiceTests.cs` (~3 tests)
- [ ] All tests passing

### Documentation
- [ ] Inline comments on all new code
- [ ] XML documentation on public members
- [ ] Changelog v0.4.3d-changelog.md
- [ ] Walkthrough update

---

## 15. Acceptance Criteria

### Functional Criteria
- [ ] Perception skill integrates with trap detection
- [ ] Stealth skill affects monster surprise checks
- [ ] Lockpicking skill unlocks locked objects (requires training)
- [ ] Field Medicine skill provides out-of-combat healing
- [ ] GameTime tracks hour and day progression
- [ ] TimeOfDay correctly calculated from hour
- [ ] Day/night affects outdoor room light levels
- [ ] Weather affects visibility in outdoor rooms
- [ ] `time` command displays current time and weather
- [ ] Indoor rooms unaffected by time/weather
- [ ] Experience awarded on all skill usages
- [ ] Light penalties apply to Perception checks

### Quality Criteria
- [ ] Build succeeds with 0 errors/warnings
- [ ] ~25 unit tests pass
- [ ] Configuration validates against schema
- [ ] XML documentation complete on all public members
- [ ] Logging present on all skill checks and time/weather changes

---

## 16. Dependencies

### Required from v0.4.3c

| Type | Location | Usage |
|------|----------|-------|
| `SkillProficiency` | `Domain/Enums` | Check trained status |
| `PlayerSkill` | `Domain/Entities` | Get player proficiency |
| `SkillDefinition` | `Domain/Definitions` | Skill configuration |
| `ISkillService` | `Application/Interfaces` | Get bonus, award exp |
| `SkillService` | `Application/Services` | Skill operations |

### Required from v0.4.3b

| Type | Location | Usage |
|------|----------|-------|
| `LightLevel` | `Domain/Enums` | Outdoor light calculation |
| `VisionType` | `Domain/Enums` | Vision considerations |
| `ILightService` | `Application/Interfaces` | Get effective light |

### Required from v0.4.3a

| Type | Location | Usage |
|------|----------|-------|
| `LightPenalties` | `Domain/Constants` | Perception DC modifiers |

### Provides to Future Versions
- GameTime for event scheduling
- Weather system for expanded effects
- Skill integration pattern for new skills

---

## 17. Future Considerations

### Deferred to Future Versions
- Weather affecting combat (fire damage reduced in rain, etc.)
- Seasonal variations (summer days longer, winter nights colder)
- Complex skill trees with prerequisites
- NPC training for skills
- Time-sensitive quests
- Weather-triggered events

### Design Considerations
- GameTime could support minutes for finer granularity
- Weather patterns could vary by season
- Skills could have synergies (Stealth + Perception for scouting)

---

*Document Version: 1.0*  
*Created: 2026-01-13*  
*Author: AI Assistant*
