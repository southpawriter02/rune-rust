> **Archived** - This changelog has been consolidated. See the complete version at [v0.2.0](../v0.2.x/v0.2.0.md).

# Changelog: v0.2.0c - The Interface (Combat UI)

**Release Date:** 2025-12-19

## Summary

This release implements the visual layer for combat in Rune & Rust, transforming debug logs into a playable Terminal User Interface (TUI) using Spectre.Console. The implementation introduces a structured combat screen with three distinct regions: a player stats header bar, an initiative-sorted turn order table, and a rolling combat log panel. Key design pillars enforced include hiding enemy HP as narrative descriptions ("Healthy", "Wounded", "Critical", "Dead") while showing exact player HP/Stamina values, and maintaining dual logging systems where player-visible combat events (with Spectre markup) are separate from Serilog debug traces. The Core Layer gained ViewModels for UI data transformation and a new renderer interface, the Engine Layer extended CombatService with ViewModel generation and combat log management, the Terminal Layer received the CombatScreenRenderer implementation, and the Test Layer added 32 comprehensive tests validating ViewModel generation, narrative health thresholds, and combat log behavior.

---

## Design Pillars

### Hide Enemy Numbers
- Enemy HP displayed as narrative health: "Healthy" (green), "Wounded" (yellow), "Critical" (red), "Dead" (grey)
- Player HP/Stamina displayed as exact numbers
- Health thresholds: >75% = Healthy, 26-75% = Wounded, 1-25% = Critical, 0% = Dead

### Dual Logging System
- **Combat Log**: Player-visible rolling buffer (max 10 events) with Spectre markup for TUI display
- **Serilog**: Debug/trace logging for development and diagnostics
- Both systems receive entries but serve different purposes

### Separation of Concerns
- **ViewModel Pattern**: CombatState transformed to CombatViewModel for display
- **Renderer Interface**: ICombatScreenRenderer allows testability (nullable in GameService)
- **ViewModels in Core Layer**: Avoids circular dependency with ICombatService

---

## New Files Created

### Core Layer

| File | Purpose |
|------|---------|
| `RuneAndRust.Core/ViewModels/CombatViewModel.cs` | Record types for combat UI data transformation: CombatViewModel, CombatantView, PlayerStatsView |
| `RuneAndRust.Core/Interfaces/ICombatScreenRenderer.cs` | Contract defining combat UI rendering with Render(CombatViewModel) method |

### Terminal Layer

| File | Purpose |
|------|---------|
| `RuneAndRust.Terminal/Services/CombatScreenRenderer.cs` | Spectre.Console implementation rendering header, turn order table, and combat log panel |

---

## Files Modified

| File | Change |
|------|--------|
| `RuneAndRust.Core/Interfaces/ICombatService.cs` | Added `GetViewModel()` and `LogCombatEvent(string)` method signatures |
| `RuneAndRust.Engine/Services/CombatService.cs` | Added combat log queue, ViewModel generation, narrative health mapping, Spectre markup message builders |
| `RuneAndRust.Engine/Services/GameService.cs` | Added ICombatService and ICombatScreenRenderer dependencies; integrated combat screen rendering in game loop |
| `RuneAndRust.Terminal/Program.cs` | Registered CombatScreenRenderer in DI container; updated version to v0.2.0c |
| `RuneAndRust.Tests/Engine/CombatServiceTests.cs` | Added 32 new tests for LogCombatEvent, GetViewModel, narrative health thresholds, and combat log integration |
| `RuneAndRust.Tests/Engine/GameServiceTests.cs` | Updated GameService constructor calls with new ICombatService and ICombatScreenRenderer parameters |
| `RuneAndRust.Tests/Engine/GameLoopTests.cs` | Updated GameService constructor calls with new ICombatService and ICombatScreenRenderer parameters |

---

## Code Implementation Details

### CombatViewModel Records

**File:** `RuneAndRust.Core/ViewModels/CombatViewModel.cs`

```csharp
public record CombatViewModel(
    int RoundNumber,
    string ActiveCombatantName,
    List<CombatantView> TurnOrder,
    List<string> CombatLog,
    PlayerStatsView PlayerStats
);

public record CombatantView(
    Guid Id,
    string Name,
    bool IsPlayer,
    bool IsActive,
    string HealthStatus,    // "75/100" for player, "[green]Healthy[/]" for enemy
    string StatusEffects,   // Placeholder for future expansion
    string InitiativeDisplay
);

public record PlayerStatsView(
    int CurrentHp,
    int MaxHp,
    int CurrentStamina,
    int MaxStamina
);
```

**Design Rationale:**
- Immutable records ensure thread-safety and predictable state
- HealthStatus contains pre-formatted display strings (Spectre markup for enemies)
- StatusEffects reserved for future status effect icons
- PlayerStats separated for header rendering convenience

### ICombatScreenRenderer Interface

**File:** `RuneAndRust.Core/Interfaces/ICombatScreenRenderer.cs`

```csharp
public interface ICombatScreenRenderer
{
    void Render(CombatViewModel viewModel);
}
```

**Contract:**
- Single method renders complete combat screen
- Clears terminal before rendering
- Displays header (player stats), turn order table, and combat log panel

### CombatScreenRenderer Implementation

**File:** `RuneAndRust.Terminal/Services/CombatScreenRenderer.cs`

**Dependencies:**
- `ILogger<CombatScreenRenderer>` - For trace logging
- Spectre.Console - For TUI rendering

**Layout Structure:**
```
┌─ COMBAT ───────────────────────────────────────────┐
│   HP: 75/100    Stamina: 40/60                     │ <- RenderHeader
├────────────────────────────────────────────────────┤
│ Init │ Name              │ Condition               │ <- RenderTurnOrder
│   15 │ > TestPlayer      │ 75/100                  │
│   12 │   Training Dummy  │ [yellow]Wounded[/]      │
├────────────────────────────────────────────────────┤
│ ╔══════════════════════════════════════════════════╗
│ ║ Round 1                                          ║ <- RenderCombatLog
│ ║ [bold]Combat begins![/]                          ║
│ ║ [cyan]Player[/] faces [red]Training Dummy[/].    ║
│ ╚══════════════════════════════════════════════════╝
└────────────────────────────────────────────────────┘
```

**Method: RenderHeader**
```csharp
private static void RenderHeader(PlayerStatsView stats)
```
- Displays HP with color coding (green >50%, yellow 25-50%, red <25%)
- Displays Stamina with color coding (cyan >50%, yellow 25-50%, red <25%)
- Uses Spectre.Console Rule for header separator

**Method: RenderTurnOrder**
```csharp
private static void RenderTurnOrder(List<CombatantView> turnOrder)
```
- Creates Spectre Table with Init, Name, Condition columns
- Active combatant marked with `>` prefix in yellow
- Player names displayed in cyan, enemy names in red
- Health status passed through (pre-formatted with Spectre markup)

**Method: RenderCombatLog**
```csharp
private static void RenderCombatLog(int roundNumber, List<string> combatLog)
```
- Creates Spectre Panel with heavy border
- Header shows current round number
- Displays all combat log entries (up to 10)
- Empty log shows "[grey]No combat events yet.[/]"

**Method: EscapeMarkup**
```csharp
private static string EscapeMarkup(string text)
```
- Escapes `[` and `]` to prevent Spectre markup injection
- Applied to combatant names for safety

### Extended ICombatService Interface

**File:** `RuneAndRust.Core/Interfaces/ICombatService.cs`

**New Method Signatures:**
```csharp
CombatViewModel? GetViewModel();
void LogCombatEvent(string message);
```

**GetViewModel Contract:**
- Returns null if no combat is active
- Returns null if no player is in turn order (abnormal state)
- Transforms CombatState to display-ready CombatViewModel
- Converts enemy HP to narrative descriptions

**LogCombatEvent Contract:**
- Adds message to rolling buffer (max 10 entries)
- Oldest entry removed when buffer is full
- Messages may contain Spectre markup

### Extended CombatService Implementation

**File:** `RuneAndRust.Engine/Services/CombatService.cs`

**New Fields:**
```csharp
private readonly Queue<string> _combatLog = new();
private const int MaxLogHistory = 10;
```

**Method: LogCombatEvent**
```csharp
public void LogCombatEvent(string message)
{
    if (_combatLog.Count >= MaxLogHistory)
    {
        _combatLog.Dequeue();
    }
    _combatLog.Enqueue(message);
    _logger.LogTrace("Combat log: {Message}", message);
}
```
- FIFO queue maintains insertion order
- Dequeues oldest when at capacity
- Mirrors entry to Serilog at Trace level

**Method: GetViewModel**
```csharp
public CombatViewModel? GetViewModel()
```
- Returns null on invalid state (no combat, no player)
- Maps each Combatant to CombatantView via `MapToView`
- Converts combat log queue to list snapshot
- Creates PlayerStatsView from player Combatant

**Method: MapToView**
```csharp
private static CombatantView MapToView(Combatant combatant, Combatant? activeCombatant)
```
- Player health: `"{CurrentHp}/{MaxHp}"` (exact numbers)
- Enemy health: Calls `GetNarrativeHealth` for narrative description
- IsActive determined by ID comparison with active combatant

**Method: GetNarrativeHealth**
```csharp
private static string GetNarrativeHealth(Combatant combatant)
```
- Returns Spectre-formatted health descriptions:
  - `<= 0%`: `"[grey]Dead[/]"`
  - `<= 25%`: `"[red]Critical[/]"`
  - `<= 75%`: `"[yellow]Wounded[/]"`
  - `> 75%`: `"[green]Healthy[/]"`
- Handles edge case of `MaxHp <= 0` returning `"Unknown"`

**New Message Builders:**
```csharp
private static string BuildLogMessage(AttackResult result, Combatant target,
    bool isDeath = false, bool isVictory = false)
private static string BuildMissLogMessage(AttackResult result, Combatant target)
```
- Create Spectre-formatted strings for combat log display
- Different from existing `BuildHitMessage`/`BuildMissMessage` (plain text for input handler)

**StartCombat Updates:**
```csharp
_combatLog.Clear();
LogCombatEvent("[bold]Combat begins![/]");
LogCombatEvent($"[cyan]{player.Name}[/] faces {string.Join(", ", enemies.Select(e => $"[red]{e.Name}[/]"))}.");
```
- Clears log from previous combat
- Adds initial combat messages with Spectre markup

**ExecutePlayerAttack Updates:**
- Calls `LogCombatEvent(BuildLogMessage(...))` on hit/death/victory
- Calls `LogCombatEvent(BuildMissLogMessage(...))` on miss

### Extended GameService

**File:** `RuneAndRust.Engine/Services/GameService.cs`

**New Dependencies:**
```csharp
private readonly ICombatService _combatService;
private readonly ICombatScreenRenderer? _combatRenderer;
```

**Constructor Update:**
```csharp
public GameService(
    ILogger<GameService> logger,
    IInputHandler inputHandler,
    CommandParser parser,
    GameState state,
    ICombatService combatService,
    ICombatScreenRenderer? combatRenderer = null)
```
- `combatRenderer` is nullable for testability
- Tests can pass `null` to skip rendering

**Game Loop Update:**
```csharp
while (_state.Phase != GamePhase.Quit)
{
    // 1. Render combat UI if in combat phase
    if (_state.Phase == GamePhase.Combat && _combatRenderer != null)
    {
        var viewModel = _combatService.GetViewModel();
        if (viewModel != null)
        {
            _combatRenderer.Render(viewModel);
        }
    }

    // 2. Get input and process...
}
```
- Combat screen renders before each input prompt when in Combat phase
- Null checks prevent crashes when renderer not available or no combat active

---

## Logging Matrix

### CombatScreenRenderer

| Event | Level | Template |
|-------|-------|----------|
| Combat screen rendered | Trace | `"Rendered combat screen"` |

### CombatService (New Entries)

| Event | Level | Template |
|-------|-------|----------|
| Combat log event added | Trace | `"Combat log: {Message}"` |
| ViewModel generated | Trace | `"Generated CombatViewModel for Round {Round}"` |

### GameService

| Event | Level | Template |
|-------|-------|----------|
| Game loop initialized | Information | `"Game Loop Initialized."` |
| Game loop ended | Information | `"Game Loop Ended. Shutting down."` |

---

## Test Coverage

```
Total: 1289 | Passed: 1289 | Failed: 0 | Duration: 558ms
```

**New Tests Added:** 32 tests in CombatServiceTests

### LogCombatEvent Tests (3 tests)

| Test Name | Description |
|-----------|-------------|
| `LogCombatEvent_AddsMessageToLog` | Validates message appears in GetViewModel().CombatLog |
| `LogCombatEvent_MaxTenEntries_RemovesOldest` | Validates 12 entries reduces to 10, oldest removed |
| `LogCombatEvent_PreservesInsertionOrder` | Validates FIFO order maintained in log |

### GetViewModel Tests (14 tests)

| Test Name | Description |
|-----------|-------------|
| `GetViewModel_WhenNoCombat_ReturnsNull` | Validates null when CombatState is null |
| `GetViewModel_ReturnsCorrectRoundNumber` | Validates RoundNumber matches state |
| `GetViewModel_ReturnsActiveCombatantName` | Validates ActiveCombatantName from state |
| `GetViewModel_ReturnsAllCombatantsInTurnOrder` | Validates TurnOrder count and order |
| `GetViewModel_MarksActiveCombatant` | Validates IsActive flag on active combatant |
| `GetViewModel_PlayerShowsExactHpNumbers` | Validates player HealthStatus is "75/100" format |
| `GetViewModel_EnemyShowsNarrativeHealth_Healthy` | Validates "Healthy" at 100% HP |
| `GetViewModel_EnemyShowsNarrativeHealth_Wounded` | Validates "Wounded" at 50% HP |
| `GetViewModel_EnemyShowsNarrativeHealth_Critical` | Validates "Critical" at 20% HP |
| `GetViewModel_EnemyShowsNarrativeHealth_Dead` | Validates "Dead" at 0% HP |
| `GetViewModel_IncludesPlayerStats` | Validates PlayerStats HP/Stamina values |
| `GetViewModel_IncludesCombatLog` | Validates CombatLog contains logged events |
| `GetViewModel_WhenNoPlayer_ReturnsNull` | Validates null when only enemies in combat |

### Narrative Health Thresholds Tests (9 tests via Theory)

| Test Name | Description |
|-----------|-------------|
| `GetViewModel_NarrativeHealthThresholds_AreCorrect` [Theory] | Validates boundary conditions: 100%→Healthy, 76%→Healthy, 75%→Wounded, 50%→Wounded, 26%→Wounded, 25%→Critical, 10%→Critical, 1%→Critical, 0%→Dead |

### StartCombat Combat Log Tests (3 tests)

| Test Name | Description |
|-----------|-------------|
| `StartCombat_ClearsPreviousCombatLog` | Validates new combat clears old log entries |
| `StartCombat_AddsInitialCombatBeginsMessage` | Validates "Combat begins!" in log |
| `StartCombat_LogsEnemyNames` | Validates enemy names appear in initial log |

### ExecutePlayerAttack Combat Log Tests (4 tests)

| Test Name | Description |
|-----------|-------------|
| `ExecutePlayerAttack_Hit_LogsToCombatLog` | Validates hit adds entry with target name |
| `ExecutePlayerAttack_Miss_LogsToCombatLog` | Validates miss/evade logged |
| `ExecutePlayerAttack_Critical_LogsCriticalMessage` | Validates "CRITICAL" in log on crit |
| `ExecutePlayerAttack_Victory_LogsVictoryMessage` | Validates "VICTORY" in log on last kill |

---

## DI Registration

**File:** `RuneAndRust.Terminal/Program.cs`

```csharp
// Register Combat Services
services.AddSingleton<IInitiativeService, InitiativeService>();
services.AddSingleton<IAttackResolutionService, AttackResolutionService>();
services.AddSingleton<ICombatService, CombatService>();
services.AddSingleton<ICombatScreenRenderer, CombatScreenRenderer>();
```

**Justification for Singleton Lifetime:**
- `CombatScreenRenderer` is stateless (all state passed via ViewModel)
- Depends only on ILogger (transient-safe)
- Console output is inherently single-threaded
- Matches other combat service lifetimes

---

## Verification Results

### Build Output

```
Build succeeded.

    63 Warning(s)
    0 Error(s)

Time Elapsed 00:00:03.20
```

**Note:** Warnings are pre-existing EntityFrameworkCore version conflicts and xUnit async advisories, unrelated to this release.

### Test Output

```
Passed!  - Failed:     0, Passed:  1289, Skipped:     0, Total:  1289, Duration: 558 ms
```

**Test Progression:**
- v0.2.0b: 1257 tests
- v0.2.0c: 1289 tests (+32 new tests)

---

## Directory Structure After Release

```
RuneAndRust.Core/
├── Entities/
│   └── (unchanged)
├── Enums/
│   └── (unchanged)
├── Interfaces/
│   ├── ICombatScreenRenderer.cs [NEW]
│   ├── ICombatService.cs [MODIFIED]
│   └── (other interfaces unchanged)
├── Models/
│   └── (unchanged)
└── ViewModels/
    └── CombatViewModel.cs [NEW]

RuneAndRust.Engine/
├── Services/
│   ├── CombatService.cs [MODIFIED]
│   ├── GameService.cs [MODIFIED]
│   └── (other services unchanged)
└── (other directories unchanged)

RuneAndRust.Terminal/
├── Program.cs [MODIFIED]
└── Services/
    ├── CharacterCreationController.cs
    ├── CombatScreenRenderer.cs [NEW]
    └── TerminalInputHandler.cs

RuneAndRust.Tests/
├── Engine/
│   ├── CombatServiceTests.cs [MODIFIED +32 tests]
│   ├── GameLoopTests.cs [MODIFIED - constructor params]
│   ├── GameServiceTests.cs [MODIFIED - constructor params]
│   └── (other test files unchanged)
└── (other directories unchanged)
```

---

## Running Tests

### Run All Tests
```bash
dotnet test
```

### Run Combat ViewModel Tests Only
```bash
dotnet test --filter "FullyQualifiedName~CombatServiceTests.GetViewModel"
```

### Run Combat Log Tests Only
```bash
dotnet test --filter "FullyQualifiedName~CombatServiceTests.LogCombatEvent"
```

### Run Narrative Health Threshold Tests
```bash
dotnet test --filter "FullyQualifiedName~NarrativeHealthThresholds"
```

---

## Next Steps

**Planned for v0.2.0d:**
- Implement enemy AI attack actions during enemy turns
- Add stamina regeneration between rounds
- Implement flee mechanics with FINESSE + WITS check
- Add blocking/defensive stance mechanics

**Planned for v0.2.1:**
- Add status effects (Bleeding, Stunned, Fortified)
- Implement weapon equipment affecting attack type and damage
- Create combat victory rewards (XP, loot drops)
- Add defeat handling (death, respawn, load save)
- Implement multi-target combat encounters

**Planned for v0.2.2:**
- Expand Enemy entity with AI behavior patterns
- Add enemy type definitions (Automaton, Revenant, Beast)
- Implement surprise round mechanics
- Create bestiary entries for Codex system
- Add combat encounter triggers in Exploration phase
