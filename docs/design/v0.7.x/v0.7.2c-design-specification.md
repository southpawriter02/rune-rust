# v0.7.2c Design Specification: Command Input Panel

**Version:** 0.7.2c
**Parent:** v0.7.2 (Interactive Panels)
**Prerequisites:** v0.7.2b Complete (Context Menus)
**Status:** Design Complete
**Estimated Unit Tests:** ~10

---

## Table of Contents

1. [Overview](#1-overview)
2. [Feature Overview](#2-feature-overview)
3. [Architecture](#3-architecture)
4. [Command Input Panel](#4-command-input-panel)
5. [Command Input ViewModel](#5-command-input-viewmodel)
6. [Completion Popup Control](#6-completion-popup-control)
7. [Key Handling Behavior](#7-key-handling-behavior)
8. [Styles](#8-styles)
9. [Data Model Changes](#9-data-model-changes)
10. [Logging Specifications](#10-logging-specifications)
11. [Unit Testing Requirements](#11-unit-testing-requirements)
12. [Use Cases](#12-use-cases)
13. [Deliverable Checklist](#13-deliverable-checklist)
14. [Acceptance Criteria](#14-acceptance-criteria)
15. [Dependencies](#15-dependencies)
16. [Future Considerations](#16-future-considerations)

---

## 1. Overview

### Purpose

This phase implements the command input panel that provides a text input field with command history navigation (up/down arrows) and tab completion with a popup showing suggestions. This integrates the existing TUI CommandHistoryService and TabCompletionService with the Avalonia GUI, providing a familiar command-line experience within the graphical interface.

### Key Deliverables

| Category | Items |
|----------|-------|
| **User Controls** | `CommandInputPanel`, `CompletionPopupControl` |
| **ViewModels** | `CommandInputViewModel` |
| **Behaviors** | Input key handling |
| **Styles** | `InputPanelStyles.axaml` |
| **Tests** | ~10 unit tests |

### Design Principles

1. **Familiar Experience**: Matches TUI command-line behavior
2. **History Navigation**: Up/down arrows recall previous commands
3. **Tab Completion**: Smart completion with visual popup
4. **Responsive Input**: Immediate feedback on keystrokes

---

## 2. Feature Overview

```
v0.7.2c Features
├── Command Input Panel (UserControl)
│   ├── Input prompt (> symbol)
│   ├── TextBox for input
│   ├── Watermark text
│   ├── History indicator
│   └── Completion popup anchor
├── Command Input ViewModel
│   ├── InputText property
│   ├── IsCompletionVisible property
│   ├── Suggestions collection
│   ├── SelectedSuggestionIndex property
│   ├── IsNavigatingHistory property
│   ├── SubmitCommand
│   ├── History navigation
│   └── Tab completion logic
├── Completion Popup Control (TemplatedControl)
│   ├── Suggestions property
│   ├── SelectedIndex property
│   ├── OnAccepted event
│   ├── Visual highlight
│   └── Click to select
├── Key Handling
│   ├── Enter → submit or accept
│   ├── Up/Down → history or popup
│   ├── Tab → trigger completion
│   ├── Escape → cancel popup
│   └── Regular typing
└── Styles
    └── InputPanelStyles.axaml
```

---

## 3. Architecture

### Component Diagram

```
┌─────────────────────────────────────────────────────────────────────────┐
│                       PRESENTATION LAYER                                │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  VIEWS                                                                  │
│  ┌───────────────────────────────────────────────────────────────────┐ │
│  │                    CommandInputPanel                               │ │
│  ├───────────────────────────────────────────────────────────────────┤ │
│  │ - PromptText ("> ")                                               │ │
│  │ - InputBox (TextBox)                                              │ │
│  │ - HistoryIndicator (optional)                                     │ │
│  │ - CompletionPopup (Popup)                                         │ │
│  └────────────────────────────────┬──────────────────────────────────┘ │
│                                   │ DataContext                        │
│                                   ▼                                    │
│  VIEWMODELS                                                             │
│  ┌───────────────────────────────────────────────────────────────────┐ │
│  │                  CommandInputViewModel                             │ │
│  ├───────────────────────────────────────────────────────────────────┤ │
│  │ + InputText: string                                               │ │
│  │ + IsCompletionVisible: bool                                       │ │
│  │ + Suggestions: ObservableCollection<string>                       │ │
│  │ + SelectedSuggestionIndex: int                                    │ │
│  │ + IsNavigatingHistory: bool                                       │ │
│  │ + HandleKeyDown(key): bool                                        │ │
│  │ - SubmitCommand(): void                                           │ │
│  │ - NavigateHistoryBack(): void                                     │ │
│  │ - NavigateHistoryForward(): void                                  │ │
│  │ - TriggerCompletion(): void                                       │ │
│  │ - AcceptCompletion(): void                                        │ │
│  │ - HideCompletion(): void                                          │ │
│  └───────────────────────────────────────────────────────────────────┘ │
│                                                                         │
│  CUSTOM CONTROLS                                                        │
│  ┌───────────────────────────────────────────────────────────────────┐ │
│  │                   CompletionPopupControl                           │ │
│  ├───────────────────────────────────────────────────────────────────┤ │
│  │ + Suggestions: IEnumerable<string> (StyledProperty)               │ │
│  │ + SelectedIndex: int (StyledProperty)                             │ │
│  │ + OnAccepted: event EventHandler<string>                          │ │
│  └───────────────────────────────────────────────────────────────────┘ │
│                                                                         │
└────────────────────────────────────┬────────────────────────────────────┘
                                     │
                                     ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                         APPLICATION LAYER                               │
├─────────────────────────────────────────────────────────────────────────┤
│  ┌────────────────────────────────────────────────────────────────────┐│
│  │                    ICommandHistoryService                          ││
│  ├────────────────────────────────────────────────────────────────────┤│
│  │ + Add(command): void                                               ││
│  │ + GetPrevious(): string?                                           ││
│  │ + GetNext(): string?                                               ││
│  │ + ResetNavigation(): void                                          ││
│  └────────────────────────────────────────────────────────────────────┘│
│  ┌────────────────────────────────────────────────────────────────────┐│
│  │                    ITabCompletionService                           ││
│  ├────────────────────────────────────────────────────────────────────┤│
│  │ + GetCompletions(input, context): IReadOnlyList<string>           ││
│  └────────────────────────────────────────────────────────────────────┘│
│  ┌────────────────────────────────────────────────────────────────────┐│
│  │                      IGameSessionService                           ││
│  ├────────────────────────────────────────────────────────────────────┤│
│  │ + ExecuteCommand(command): void                                    ││
│  └────────────────────────────────────────────────────────────────────┘│
└─────────────────────────────────────────────────────────────────────────┘
```

### Input Flow

```
┌─────────────────────────────────────────────────────────────────────────┐
│                       COMMAND INPUT FLOW                                │
└─────────────────────────────────────────────────────────────────────────┘

    User types in input field
            │
            ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                    InputBox.KeyDown Event                               │
├─────────────────────────────────────────────────────────────────────────┤
│  Routes to CommandInputViewModel.HandleKeyDown(key)                    │
└─────────────────────────────────────────────────────────────────────────┘
            │
            ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                    Key-Specific Handling                                │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  ┌─────────────┐   ┌─────────────┐   ┌─────────────┐   ┌─────────────┐ │
│  │   ENTER     │   │   UP/DOWN   │   │    TAB      │   │   ESCAPE    │ │
│  │             │   │             │   │             │   │             │ │
│  │ If popup:   │   │ If popup:   │   │ Trigger     │   │ Hide popup  │ │
│  │  Accept     │   │  Navigate   │   │ completion  │   │             │ │
│  │ Else:       │   │ Else:       │   │             │   │             │ │
│  │  Submit     │   │  History    │   │             │   │             │ │
│  └─────────────┘   └─────────────┘   └─────────────┘   └─────────────┘ │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
            │
            ▼
┌─────────────────────────────────────────────────────────────────────────┐
│               Submit: GameSessionService.ExecuteCommand()               │
│               History: CommandHistoryService.GetPrevious/Next()        │
│               Complete: TabCompletionService.GetCompletions()           │
└─────────────────────────────────────────────────────────────────────────┘
```

---

## 4. Command Input Panel

### Panel Layout

```
STANDARD INPUT:
┌─────────────────────────────────────────────────────────────────────────┐
│ > attack skeleton_                                                      │
└─────────────────────────────────────────────────────────────────────────┘

WITH HISTORY (up arrow pressed):
┌─────────────────────────────────────────────────────────────────────────┐
│ > go north                                                   [History ▲]│
└─────────────────────────────────────────────────────────────────────────┘

WITH COMPLETION POPUP:
┌─────────────────────────────────────────────────────────────────────────┐
│ > use hea                                                               │
│   ┌──────────────────────────┐                                          │
│   │ healing-potion        ◄──│ (selected)                               │
│   │ health-scroll            │                                          │
│   │ heavy-armor              │                                          │
│   └──────────────────────────┘                                          │
└─────────────────────────────────────────────────────────────────────────┘

COMMAND COMPLETION:
┌─────────────────────────────────────────────────────────────────────────┐
│ > at                                                                    │
│   ┌──────────────────────────┐                                          │
│   │ attack              ◄────│                                          │
│   └──────────────────────────┘                                          │
└─────────────────────────────────────────────────────────────────────────┘
```

### XAML Implementation

**File:** `src/Presentation/RuneAndRust.Avalonia/Controls/CommandInputPanel.axaml`

```xml
<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:vm="using:RuneAndRust.Avalonia.ViewModels"
             xmlns:ctrl="using:RuneAndRust.Avalonia.Controls"
             x:Class="RuneAndRust.Avalonia.Controls.CommandInputPanel"
             x:DataType="vm:CommandInputViewModel"
             Focusable="True">
    
    <Design.DataContext>
        <vm:CommandInputViewModel />
    </Design.DataContext>
    
    <Panel>
        <!-- Main Input Area -->
        <Border Classes="panel input-panel" Padding="8,6">
            <DockPanel>
                <!-- Prompt -->
                <TextBlock DockPanel.Dock="Left" 
                           Text="> " 
                           Classes="input-prompt"
                           FontFamily="{StaticResource MonoFont}"
                           VerticalAlignment="Center"
                           Margin="0,0,4,0" />
                
                <!-- History Indicator -->
                <Border DockPanel.Dock="Right"
                        Classes="history-indicator"
                        IsVisible="{Binding IsNavigatingHistory}"
                        Margin="4,0,0,0">
                    <TextBlock Text="[History ▲]" 
                               Classes="muted"
                               FontSize="10" />
                </Border>
                
                <!-- Input TextBox -->
                <TextBox x:Name="InputBox"
                         Text="{Binding InputText, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                         Watermark="Enter command..."
                         Classes="command-input"
                         FontFamily="{StaticResource MonoFont}"
                         BorderThickness="0"
                         Background="Transparent"
                         VerticalAlignment="Center"
                         KeyDown="OnInputKeyDown" />
            </DockPanel>
        </Border>
        
        <!-- Completion Popup -->
        <Popup x:Name="CompletionPopup"
               IsOpen="{Binding IsCompletionVisible}"
               PlacementTarget="{Binding ElementName=InputBox}"
               Placement="Top"
               PlacementAnchor="TopLeft"
               PlacementGravity="TopLeft"
               IsLightDismissEnabled="False"
               WindowManagerAddShadowHint="False">
            
            <ctrl:CompletionPopupControl 
                Suggestions="{Binding Suggestions}"
                SelectedIndex="{Binding SelectedSuggestionIndex, Mode=TwoWay}"
                SuggestionAccepted="OnCompletionAccepted" />
        </Popup>
    </Panel>
</UserControl>
```

**File:** `src/Presentation/RuneAndRust.Avalonia/Controls/CommandInputPanel.axaml.cs`

```csharp
namespace RuneAndRust.Avalonia.Controls;

using global::Avalonia.Controls;
using global::Avalonia.Input;
using RuneAndRust.Avalonia.ViewModels;

/// <summary>
/// Panel control for command input with history and tab completion.
/// </summary>
public partial class CommandInputPanel : UserControl
{
    public CommandInputPanel()
    {
        InitializeComponent();
    }

    private void OnInputKeyDown(object? sender, KeyEventArgs e)
    {
        if (DataContext is not CommandInputViewModel vm)
            return;

        // Let the ViewModel handle the key
        var handled = vm.HandleKeyDown(e.Key);
        
        if (handled)
        {
            e.Handled = true;
        }
    }

    private void OnCompletionAccepted(object? sender, string suggestion)
    {
        if (DataContext is CommandInputViewModel vm)
        {
            vm.ApplyCompletion(suggestion);
            
            // Refocus the input box
            InputBox.Focus();
            InputBox.CaretIndex = InputBox.Text?.Length ?? 0;
        }
    }

    /// <summary>
    /// Sets focus to the input box.
    /// </summary>
    public void FocusInput()
    {
        InputBox.Focus();
    }
}
```

---

## 5. Command Input ViewModel

**File:** `src/Presentation/RuneAndRust.Avalonia/ViewModels/CommandInputViewModel.cs`

```csharp
namespace RuneAndRust.Avalonia.ViewModels;

using CommunityToolkit.Mvvm.ComponentModel;
using global::Avalonia.Input;
using RuneAndRust.Application.Interfaces;
using Serilog;
using System.Collections.ObjectModel;

/// <summary>
/// View model for the command input panel.
/// </summary>
public partial class CommandInputViewModel : ViewModelBase
{
    private readonly IGameSessionService? _gameSession;
    private readonly ICommandHistoryService? _history;
    private readonly ITabCompletionService? _completion;

    [ObservableProperty]
    private string _inputText = string.Empty;

    [ObservableProperty]
    private bool _isCompletionVisible;

    [ObservableProperty]
    private ObservableCollection<string> _suggestions = new();

    [ObservableProperty]
    private int _selectedSuggestionIndex = -1;

    [ObservableProperty]
    private bool _isNavigatingHistory;

    private string _inputBeforeHistory = string.Empty;

    /// <summary>
    /// Creates a new CommandInputViewModel with services.
    /// </summary>
    public CommandInputViewModel(
        IGameSessionService gameSession,
        ICommandHistoryService history,
        ITabCompletionService completion)
    {
        _gameSession = gameSession;
        _history = history;
        _completion = completion;
    }

    /// <summary>
    /// Design-time constructor.
    /// </summary>
    public CommandInputViewModel()
    {
    }

    /// <summary>
    /// Handles key press events.
    /// </summary>
    /// <param name="key">The key that was pressed.</param>
    /// <returns>True if the key was handled, false otherwise.</returns>
    public bool HandleKeyDown(Key key)
    {
        switch (key)
        {
            case Key.Enter:
                if (IsCompletionVisible && SelectedSuggestionIndex >= 0)
                {
                    AcceptCompletion();
                }
                else
                {
                    SubmitCommand();
                }
                return true;

            case Key.Up:
                if (IsCompletionVisible)
                {
                    MoveSuggestionSelection(-1);
                }
                else
                {
                    NavigateHistoryBack();
                }
                return true;

            case Key.Down:
                if (IsCompletionVisible)
                {
                    MoveSuggestionSelection(1);
                }
                else
                {
                    NavigateHistoryForward();
                }
                return true;

            case Key.Tab:
                TriggerCompletion();
                return true;

            case Key.Escape:
                if (IsCompletionVisible)
                {
                    HideCompletion();
                    return true;
                }
                return false;

            default:
                // Regular input - hide completion if visible
                if (IsCompletionVisible)
                {
                    // Could optionally update completions as user types
                }
                return false;
        }
    }

    /// <summary>
    /// Applies a completion suggestion to the input.
    /// </summary>
    /// <param name="completion">The completion to apply.</param>
    public void ApplyCompletion(string completion)
    {
        // Replace current word with completion
        var words = InputText.Split(' ', StringSplitOptions.RemoveEmptyEntries);
        if (words.Length > 0)
        {
            words[^1] = completion;
            InputText = string.Join(' ', words) + " ";
        }
        else
        {
            InputText = completion + " ";
        }
        
        HideCompletion();
        Log.Debug("Applied completion: {Completion}", completion);
    }

    private void SubmitCommand()
    {
        if (string.IsNullOrWhiteSpace(InputText))
            return;

        var command = InputText.Trim();
        
        Log.Information("Submitting command: {Command}", command);
        
        _history?.Add(command);
        _gameSession?.ExecuteCommand(command);
        
        InputText = string.Empty;
        IsNavigatingHistory = false;
        _history?.ResetNavigation();
    }

    private void NavigateHistoryBack()
    {
        if (_history is null)
            return;

        if (!IsNavigatingHistory)
        {
            _inputBeforeHistory = InputText;
            IsNavigatingHistory = true;
        }

        var previous = _history.GetPrevious();
        if (previous is not null)
        {
            InputText = previous;
            Log.Debug("Navigated to previous history: {Command}", previous);
        }
    }

    private void NavigateHistoryForward()
    {
        if (_history is null)
            return;

        var next = _history.GetNext();
        if (next is not null)
        {
            InputText = next;
            Log.Debug("Navigated to next history: {Command}", next);
        }
        else
        {
            // Return to original input
            InputText = _inputBeforeHistory;
            IsNavigatingHistory = false;
        }
    }

    private void TriggerCompletion()
    {
        if (_completion is null || string.IsNullOrWhiteSpace(InputText))
            return;

        var context = CreateCompletionContext();
        var completions = _completion.GetCompletions(InputText, context);

        if (completions.Count == 0)
        {
            HideCompletion();
            Log.Debug("No completions found for: {Input}", InputText);
            return;
        }

        if (completions.Count == 1)
        {
            // Single match - complete inline
            ApplyCompletion(completions[0]);
            Log.Debug("Single completion applied: {Completion}", completions[0]);
        }
        else
        {
            // Multiple matches - show popup
            Suggestions.Clear();
            foreach (var c in completions)
            {
                Suggestions.Add(c);
            }

            SelectedSuggestionIndex = 0;
            IsCompletionVisible = true;
            Log.Debug("Showing {Count} completions", completions.Count);
        }
    }

    private void AcceptCompletion()
    {
        if (SelectedSuggestionIndex >= 0 && SelectedSuggestionIndex < Suggestions.Count)
        {
            ApplyCompletion(Suggestions[SelectedSuggestionIndex]);
        }
        HideCompletion();
    }

    private void MoveSuggestionSelection(int delta)
    {
        if (Suggestions.Count == 0)
            return;

        var newIndex = SelectedSuggestionIndex + delta;
        
        // Wrap around
        if (newIndex < 0)
            newIndex = Suggestions.Count - 1;
        else if (newIndex >= Suggestions.Count)
            newIndex = 0;

        SelectedSuggestionIndex = newIndex;
    }

    private void HideCompletion()
    {
        IsCompletionVisible = false;
        Suggestions.Clear();
        SelectedSuggestionIndex = -1;
    }

    private CompletionContext CreateCompletionContext()
    {
        // Create context based on current input
        var words = InputText.Split(' ', StringSplitOptions.RemoveEmptyEntries);
        return new CompletionContext
        {
            Command = words.Length > 0 ? words[0] : string.Empty,
            PartialWord = words.Length > 0 ? words[^1] : string.Empty,
            WordIndex = words.Length - 1
        };
    }
}

/// <summary>
/// Context for tab completion.
/// </summary>
public record CompletionContext
{
    public string Command { get; init; } = string.Empty;
    public string PartialWord { get; init; } = string.Empty;
    public int WordIndex { get; init; }
}
```

---

## 6. Completion Popup Control

**File:** `src/Presentation/RuneAndRust.Avalonia/Controls/CompletionPopupControl.cs`

```csharp
namespace RuneAndRust.Avalonia.Controls;

using global::Avalonia;
using global::Avalonia.Controls;
using global::Avalonia.Controls.Primitives;
using global::Avalonia.Input;
using System.Collections.Generic;

/// <summary>
/// Displays tab completion suggestions.
/// </summary>
public class CompletionPopupControl : TemplatedControl
{
    public static readonly StyledProperty<IEnumerable<string>> SuggestionsProperty =
        AvaloniaProperty.Register<CompletionPopupControl, IEnumerable<string>>(
            nameof(Suggestions), 
            defaultValue: Array.Empty<string>());

    public static readonly StyledProperty<int> SelectedIndexProperty =
        AvaloniaProperty.Register<CompletionPopupControl, int>(
            nameof(SelectedIndex), 
            defaultValue: -1);

    /// <summary>
    /// Gets or sets the completion suggestions.
    /// </summary>
    public IEnumerable<string> Suggestions
    {
        get => GetValue(SuggestionsProperty);
        set => SetValue(SuggestionsProperty, value);
    }

    /// <summary>
    /// Gets or sets the selected suggestion index.
    /// </summary>
    public int SelectedIndex
    {
        get => GetValue(SelectedIndexProperty);
        set => SetValue(SelectedIndexProperty, value);
    }

    /// <summary>
    /// Raised when a suggestion is accepted (clicked or Enter pressed).
    /// </summary>
    public event EventHandler<string>? SuggestionAccepted;

    private ListBox? _listBox;

    protected override void OnApplyTemplate(TemplateAppliedEventArgs e)
    {
        base.OnApplyTemplate(e);

        _listBox = e.NameScope.Find<ListBox>("PART_SuggestionList");
        
        if (_listBox is not null)
        {
            _listBox.DoubleTapped += OnListBoxDoubleTapped;
        }
    }

    private void OnListBoxDoubleTapped(object? sender, TappedEventArgs e)
    {
        if (_listBox?.SelectedItem is string suggestion)
        {
            SuggestionAccepted?.Invoke(this, suggestion);
        }
    }

    protected override void OnPointerPressed(PointerPressedEventArgs e)
    {
        base.OnPointerPressed(e);

        if (_listBox?.SelectedItem is string suggestion)
        {
            SuggestionAccepted?.Invoke(this, suggestion);
        }
    }
}
```

**File:** `src/Presentation/RuneAndRust.Avalonia/Controls/CompletionPopupControl.axaml`

```xml
<Styles xmlns="https://github.com/avaloniaui"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:ctrl="using:RuneAndRust.Avalonia.Controls">
    
    <Style Selector="ctrl|CompletionPopupControl">
        <Setter Property="Template">
            <ControlTemplate>
                <Border Background="{StaticResource SurfaceBrush}"
                        BorderBrush="{StaticResource BorderBrush}"
                        BorderThickness="1"
                        CornerRadius="4"
                        Padding="2"
                        MinWidth="180"
                        MaxHeight="150">
                    <ListBox x:Name="PART_SuggestionList"
                             ItemsSource="{TemplateBinding Suggestions}"
                             SelectedIndex="{TemplateBinding SelectedIndex, Mode=TwoWay}"
                             Background="Transparent"
                             BorderThickness="0">
                        <ListBox.ItemTemplate>
                            <DataTemplate>
                                <TextBlock Text="{Binding}"
                                           FontFamily="{StaticResource MonoFont}"
                                           Padding="8,4" />
                            </DataTemplate>
                        </ListBox.ItemTemplate>
                    </ListBox>
                </Border>
            </ControlTemplate>
        </Setter>
    </Style>
    
    <!-- Selected item styling -->
    <Style Selector="ctrl|CompletionPopupControl ListBoxItem:selected">
        <Setter Property="Background" Value="{StaticResource PrimaryBrush}" />
    </Style>
    
    <Style Selector="ctrl|CompletionPopupControl ListBoxItem:pointerover">
        <Setter Property="Background" Value="{StaticResource PrimaryLightBrush}" />
    </Style>
    
    <!-- Selection indicator -->
    <Style Selector="ctrl|CompletionPopupControl ListBoxItem:selected /template/ ContentPresenter">
        <Setter Property="Foreground" Value="{StaticResource TextPrimaryBrush}" />
    </Style>
    
</Styles>
```

---

## 7. Key Handling Behavior

### Key Mapping Table

| Key | Popup Hidden | Popup Visible |
|-----|--------------|---------------|
| **Enter** | Submit command | Accept selected suggestion |
| **Up** | Previous history | Move selection up |
| **Down** | Next history / restore | Move selection down |
| **Tab** | Trigger completion | (no action) |
| **Escape** | (no action) | Hide popup |
| **Other** | Normal input | Normal input |

### State Transitions

```
┌─────────────────────────────────────────────────────────────────────────┐
│                       STATE MACHINE                                     │
└─────────────────────────────────────────────────────────────────────────┘

    ┌────────────┐
    │   IDLE     │◄───────────────────────────────────────────────────┐
    │            │                                                     │
    │ InputText  │                                                     │
    │ (typing)   │                                                     │
    └─────┬──────┘                                                     │
          │                                                            │
          │ Tab pressed                                                │
          ▼                                                            │
    ┌────────────┐                                                     │
    │ COMPLETING │                                                     │
    │            │                                                     │
    │ Get        │                                                     │
    │ completions│                                                     │
    └─────┬──────┘                                                     │
          │                                                            │
          ├── 0 matches ───────────────────────────────────────────────┤
          │                                                            │
          ├── 1 match ─────► Apply inline ─────────────────────────────┤
          │                                                            │
          └── N matches ──┐                                            │
                          ▼                                            │
                    ┌────────────┐                                     │
                    │ POPUP OPEN │                                     │
                    │            │                                     │
                    │ Show       │                                     │
                    │ suggestions│                                     │
                    └─────┬──────┘                                     │
                          │                                            │
          ┌───────────────┼───────────────┐                            │
          │               │               │                            │
          ▼               ▼               ▼                            │
    Up/Down         Enter           Escape                             │
    Navigate        Accept          Cancel ────────────────────────────┤
    selection       selection                                          │
                          │                                            │
                          └── Apply completion ────────────────────────┘


    ┌────────────┐
    │   IDLE     │
    │            │
    └─────┬──────┘
          │
          │ Up arrow pressed
          ▼
    ┌────────────┐
    │ HISTORY    │
    │ NAVIGATION │◄───────┐
    │            │        │
    │ Show prev  │        │ More Up arrows
    │ command    │────────┘
    └─────┬──────┘
          │
          │ Down arrow (no more next) OR Submit OR Type
          ▼
    ┌────────────┐
    │   IDLE     │
    └────────────┘
```

---

## 8. Styles

**File:** `src/Presentation/RuneAndRust.Avalonia/Styles/InputPanelStyles.axaml`

```xml
<Styles xmlns="https://github.com/avaloniaui"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml">
    
    <!-- Include CompletionPopupControl styles -->
    <StyleInclude Source="avares://RuneAndRust.Avalonia/Controls/CompletionPopupControl.axaml" />
    
    <!-- Input Panel Container -->
    <Style Selector="Border.input-panel">
        <Setter Property="Background" Value="{StaticResource SurfaceBrush}" />
        <Setter Property="BorderBrush" Value="{StaticResource BorderBrush}" />
        <Setter Property="BorderThickness" Value="1" />
        <Setter Property="CornerRadius" Value="4" />
    </Style>
    
    <!-- Input Prompt -->
    <Style Selector="TextBlock.input-prompt">
        <Setter Property="Foreground" Value="{StaticResource AccentBrush}" />
        <Setter Property="FontWeight" Value="Bold" />
        <Setter Property="FontSize" Value="{StaticResource FontSizeMedium}" />
    </Style>
    
    <!-- Command Input TextBox -->
    <Style Selector="TextBox.command-input">
        <Setter Property="Foreground" Value="{StaticResource TextPrimaryBrush}" />
        <Setter Property="CaretBrush" Value="{StaticResource AccentBrush}" />
        <Setter Property="SelectionBrush" Value="{StaticResource PrimaryBrush}" />
        <Setter Property="FontSize" Value="{StaticResource FontSizeMedium}" />
        <Setter Property="Padding" Value="0" />
    </Style>
    
    <Style Selector="TextBox.command-input:focus">
        <Setter Property="BorderThickness" Value="0" />
    </Style>
    
    <Style Selector="TextBox.command-input /template/ TextBlock#PART_Watermark">
        <Setter Property="Foreground" Value="{StaticResource TextMutedBrush}" />
        <Setter Property="Opacity" Value="0.6" />
    </Style>
    
    <!-- History Indicator -->
    <Style Selector="Border.history-indicator">
        <Setter Property="Background" Value="{StaticResource SurfaceDarkBrush}" />
        <Setter Property="CornerRadius" Value="2" />
        <Setter Property="Padding" Value="4,2" />
    </Style>
    
    <!-- Focus state for panel -->
    <Style Selector="Border.input-panel:focus-within">
        <Setter Property="BorderBrush" Value="{StaticResource AccentBrush}" />
    </Style>
    
</Styles>
```

---

## 9. Data Model Changes

### New Types

| Type | Layer | Description |
|------|-------|-------------|
| `CommandInputPanel` | Presentation | Input UserControl |
| `CommandInputViewModel` | Presentation | Input state view model |
| `CompletionPopupControl` | Presentation | Completion popup control |
| `CompletionContext` | Presentation | Completion context record |

### Service Contracts (Existing)

| Type | Layer | Description |
|------|-------|-------------|
| `ICommandHistoryService` | Application | Command history interface |
| `ITabCompletionService` | Application | Tab completion interface |

### DI Registration

**File:** `src/Presentation/RuneAndRust.Avalonia/App.axaml.cs` (additions)

```csharp
// ViewModels are typically transient
services.AddTransient<CommandInputViewModel>();
```

---

## 10. Logging Specifications

| Component | Level | Events |
|-----------|-------|--------|
| `CommandInputViewModel` | Information | Command submission |
| `CommandInputViewModel` | Debug | History navigation, completion events |
| `CommandInputViewModel` | Debug | Completion results count |

---

## 11. Unit Testing Requirements

### Test Count by Feature

| Feature | Test Count |
|---------|------------|
| CommandInputViewModel | ~6 |
| Key handling | ~2 |
| Completion logic | ~2 |
| **Total** | **~10** |

### Test Specifications

**File:** `tests/RuneAndRust.Avalonia.UnitTests/ViewModels/CommandInputViewModelTests.cs`

```csharp
[TestFixture]
public class CommandInputViewModelTests
{
    private Mock<IGameSessionService> _gameSessionMock;
    private Mock<ICommandHistoryService> _historyMock;
    private Mock<ITabCompletionService> _completionMock;
    private CommandInputViewModel _viewModel;

    [SetUp]
    public void Setup()
    {
        _gameSessionMock = new Mock<IGameSessionService>();
        _historyMock = new Mock<ICommandHistoryService>();
        _completionMock = new Mock<ITabCompletionService>();
        
        _viewModel = new CommandInputViewModel(
            _gameSessionMock.Object,
            _historyMock.Object,
            _completionMock.Object);
    }

    [Test]
    public void HandleKeyDown_Enter_SubmitsCommand()
    {
        // Arrange
        _viewModel.InputText = "go north";

        // Act
        _viewModel.HandleKeyDown(Key.Enter);

        // Assert
        _gameSessionMock.Verify(x => x.ExecuteCommand("go north"), Times.Once);
        _viewModel.InputText.Should().BeEmpty();
    }

    [Test]
    public void HandleKeyDown_Enter_AddsToHistory()
    {
        // Arrange
        _viewModel.InputText = "attack";

        // Act
        _viewModel.HandleKeyDown(Key.Enter);

        // Assert
        _historyMock.Verify(x => x.Add("attack"), Times.Once);
    }

    [Test]
    public void HandleKeyDown_Up_NavigatesHistoryBack()
    {
        // Arrange
        _historyMock.Setup(x => x.GetPrevious()).Returns("previous command");

        // Act
        _viewModel.HandleKeyDown(Key.Up);

        // Assert
        _viewModel.InputText.Should().Be("previous command");
        _viewModel.IsNavigatingHistory.Should().BeTrue();
    }

    [Test]
    public void HandleKeyDown_Tab_TriggersCompletion()
    {
        // Arrange
        _viewModel.InputText = "att";
        _completionMock.Setup(x => x.GetCompletions(It.IsAny<string>(), It.IsAny<object>()))
            .Returns(new List<string> { "attack" });

        // Act
        _viewModel.HandleKeyDown(Key.Tab);

        // Assert
        // Single match applies inline
        _viewModel.InputText.Should().Be("attack ");
    }

    [Test]
    public void HandleKeyDown_Tab_ShowsPopupForMultipleMatches()
    {
        // Arrange
        _viewModel.InputText = "a";
        _completionMock.Setup(x => x.GetCompletions(It.IsAny<string>(), It.IsAny<object>()))
            .Returns(new List<string> { "attack", "armor", "axe" });

        // Act
        _viewModel.HandleKeyDown(Key.Tab);

        // Assert
        _viewModel.IsCompletionVisible.Should().BeTrue();
        _viewModel.Suggestions.Should().HaveCount(3);
    }

    [Test]
    public void HandleKeyDown_Escape_HidesPopup()
    {
        // Arrange
        _viewModel.IsCompletionVisible = true;
        _viewModel.Suggestions.Add("test");

        // Act
        _viewModel.HandleKeyDown(Key.Escape);

        // Assert
        _viewModel.IsCompletionVisible.Should().BeFalse();
        _viewModel.Suggestions.Should().BeEmpty();
    }
}
```

---

## 12. Use Cases

### UC-072c-001: Enter Command
**Actor:** Player
**Flow:** Type command → Press Enter → Command executes → Input clears

### UC-072c-002: Recall Previous Command
**Actor:** Player
**Flow:** Press Up arrow → Previous command appears → History indicator shows

### UC-072c-003: Navigate History Forward
**Actor:** Player
**Flow:** After Up, press Down → Next command or original input appears

### UC-072c-004: Tab Complete Single Match
**Actor:** Player
**Flow:** Type partial → Press Tab → Single match completes inline

### UC-072c-005: Tab Complete Multiple Matches
**Actor:** Player
**Flow:** Type partial → Press Tab → Popup shows matches → Navigate with arrows → Enter accepts

### UC-072c-006: Cancel Completion
**Actor:** Player
**Flow:** Tab shows popup → Press Escape → Popup closes, input unchanged

### UC-072c-007: Empty Input Submit
**Actor:** Player
**Flow:** Press Enter with empty input → Nothing happens

---

## 13. Deliverable Checklist

### Controls
- [ ] `Controls/CommandInputPanel.axaml` created
- [ ] `Controls/CommandInputPanel.axaml.cs` created
- [ ] `Controls/CompletionPopupControl.cs` created
- [ ] `Controls/CompletionPopupControl.axaml` created

### ViewModels
- [ ] `ViewModels/CommandInputViewModel.cs` created

### Styles
- [ ] `Styles/InputPanelStyles.axaml` created

### Integration
- [ ] `App.axaml` includes InputPanelStyles
- [ ] GameWindow registers CommandInputPanel in BottomContent region
- [ ] DI registration for CommandInputViewModel

### Testing
- [ ] ~10 unit tests implemented
- [ ] All tests passing

---

## 14. Acceptance Criteria

### Text Input
- [ ] Text input accepts typing
- [ ] Watermark shows when empty
- [ ] Prompt symbol (>) displays
- [ ] Monospace font used

### Command Submission
- [ ] Enter submits command
- [ ] Command added to history
- [ ] Input clears after submit
- [ ] Empty input does nothing

### History Navigation
- [ ] Up arrow recalls previous command
- [ ] Down arrow moves forward
- [ ] History indicator shows when navigating
- [ ] Original input restored at end

### Tab Completion
- [ ] Tab triggers completion lookup
- [ ] Single match completes inline
- [ ] Multiple matches show popup
- [ ] Arrow keys navigate popup
- [ ] Enter accepts popup selection
- [ ] Escape closes popup

### Visual
- [ ] Focus state shows border
- [ ] Popup positioned above input
- [ ] Selected item highlighted
- [ ] Consistent styling

### Quality
- [ ] Build completes with 0 errors
- [ ] Build completes with 0 warnings
- [ ] ~10 unit tests pass
- [ ] Panel integrates with GameWindow

---

## 15. Dependencies

### Required from v0.7.2b

| Type | Location | Usage |
|------|----------|-------|
| Integration patterns | v0.7.2b | Event handling patterns |
| Style patterns | v0.7.2b | Consistent theming |

### Required from v0.7.0c

| Type | Location | Usage |
|------|----------|-------|
| `GameWindow` | `Views/GameWindow.axaml` | BottomContent region host |
| `IWindowLayoutService` | `Services/IWindowLayoutService.cs` | Panel registration |
| `PanelRegion.BottomContent` | `Services/PanelRegion.cs` | Region identifier |

### Required from Application Layer

| Type | Location | Usage |
|------|----------|-------|
| `IGameSessionService` | Application layer | Command execution |
| `ICommandHistoryService` | Application layer | History navigation |
| `ITabCompletionService` | Application layer | Tab completion |

### Provides to v0.7.3

| Type | Usage |
|------|-------|
| Complete Interactive Panels | Foundation for advanced interactions |
| Command patterns | Consistent command handling |

---

## 16. Future Considerations

### Deferred to v0.7.3
- **Tooltips and Help**: Hover help for UI elements

### Deferred to v0.8.0
- **Command aliases**: User-defined shortcuts
- **Macro recording**: Record command sequences
- **Syntax highlighting**: Color-code command parts

### Deferred to v0.9.0
- **Voice input**: Speech-to-text commands
- **Auto-suggestions**: Proactive suggestions while typing

### Out of Scope
- **Multi-line input**: Single-line commands only
- **Command scripting**: No script execution
- **Rich text input**: Plain text only

---

*Document Version: 1.0*
*Last Updated: 2026-01-10*
*Author: Assistant*
