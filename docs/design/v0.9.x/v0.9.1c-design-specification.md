# v0.9.1c Design Specification: Theme Transitions

**Version:** 0.9.1c
**Parent:** v0.9.1 (Music System)
**Prerequisites:** v0.9.1b Complete (Music Themes)
**Status:** Design Complete
**Estimated Unit Tests:** ~6

---

## 1. Overview

### Purpose

Implement smooth theme transitions with crossfade effects and game state triggers. Music automatically changes based on game context: entering combat triggers combat theme, defeating a boss triggers victory stinger, entering a safe area triggers peaceful music. Stingers interrupt and duck background music, resuming after completion.

### Key Deliverables

| Category | Items |
|----------|-------|
| **Interfaces** | `ICrossfadeManager` |
| **Services** | `CrossfadeManager`, `MusicEventHandler` |
| **Configuration** | Transition settings in `music-themes.json` |
| **Tests** | ~6 unit tests |

---

## 2. Feature Overview

```
v0.9.1c Features
├── ICrossfadeManager Interface
│   ├── CrossfadeTo(track, duration)
│   ├── FadeOut(duration)
│   ├── FadeIn(duration)
│   ├── DuckFor(stinger, duckLevel)
│   └── Cancel()
│
├── CrossfadeManager Implementation
│   ├── Linear volume interpolation
│   ├── Concurrent fade out/in
│   ├── Configurable durations
│   └── Cancel active transitions
│
├── Stinger with Duck
│   ├── Reduce background volume
│   ├── Play stinger at full
│   ├── Restore volume after
│   └── Resume previous track
│
├── MusicEventHandler
│   ├── CombatStarted → Combat theme
│   ├── BossEncounter → BossCombat theme
│   ├── CombatEnded (victory) → Victory stinger → Exploration
│   ├── CombatEnded (defeat) → Defeat stinger
│   ├── EnterSafeArea → SafeArea theme
│   ├── LeaveSafeArea → Exploration theme
│   ├── GamePaused → Fade out
│   └── GameResumed → Fade in
│
└── Transition Configuration
    ├── defaultCrossfade: 2.0s
    ├── combatCrossfade: 0.5s
    ├── stingerFadeOut: 1.0s
    └── stingerResumeDelay: 0.5s
```

---

## 3. Architecture

```
┌─────────────────────────────────────────────────────────────────────────┐
│                       GAME EVENTS                                       │
├─────────────────────────────────────────────────────────────────────────┤
│  CombatStartedEvent ──────────┐                                         │
│  BossEncounterEvent ──────────┼──▶  MusicEventHandler                  │
│  CombatEndedEvent ────────────┤     ├── Maps events to themes          │
│  EnterSafeAreaEvent ──────────┤     └── Calls CrossfadeManager         │
│  LeaveSafeAreaEvent ──────────┤                                         │
│  GamePausedEvent ─────────────┘              │                         │
└──────────────────────────────────────────────┼─────────────────────────┘
                                               ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                       ICrossfadeManager                                 │
├─────────────────────────────────────────────────────────────────────────┤
│  CrossfadeTo(track, duration, onComplete)                              │
│  FadeOut(duration)                                                      │
│  FadeIn(duration)                                                       │
│  DuckAndPlay(stinger, duckLevel, onComplete)                           │
│  Cancel()                                                               │
│  bool IsTransitioning { get; }                                         │
└─────────────────────────────────────────────────────────────────────────┘
                                               │
                                               ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                       CrossfadeManager                                  │
├─────────────────────────────────────────────────────────────────────────┤
│  _musicService: IMusicService                                          │
│  _audioService: IAudioService                                          │
│  _transitionSettings: TransitionSettings                               │
│  _timer: DispatcherTimer / Task delay                                  │
│  _originalVolume: float                                                │
│  _isTransitioning: bool                                                │
└─────────────────────────────────────────────────────────────────────────┘
                                               │
                                               ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                       MusicService (v0.9.1a)                            │
│                       IAudioService (v0.9.0a)                           │
└─────────────────────────────────────────────────────────────────────────┘
```

---

## 4. ICrossfadeManager Interface

**File:** `src/Core/RuneAndRust.Application/Interfaces/ICrossfadeManager.cs`

```csharp
namespace RuneAndRust.Application.Interfaces;

/// <summary>
/// Manages smooth audio transitions between music tracks.
/// </summary>
public interface ICrossfadeManager
{
    /// <summary>Gets whether a transition is currently in progress.</summary>
    bool IsTransitioning { get; }

    /// <summary>Crossfades from current track to a new track.</summary>
    /// <param name="newTrack">Path to the new track.</param>
    /// <param name="duration">Crossfade duration in seconds.</param>
    /// <param name="onComplete">Callback when transition completes.</param>
    void CrossfadeTo(string newTrack, float duration, Action? onComplete = null);

    /// <summary>Crossfades to a new theme.</summary>
    /// <param name="theme">The theme to transition to.</param>
    /// <param name="duration">Crossfade duration in seconds.</param>
    void CrossfadeToTheme(MusicTheme theme, float duration);

    /// <summary>Fades out current music.</summary>
    /// <param name="duration">Fade duration in seconds.</param>
    void FadeOut(float duration);

    /// <summary>Fades in current music.</summary>
    /// <param name="duration">Fade duration in seconds.</param>
    void FadeIn(float duration);

    /// <summary>Ducks background music and plays a stinger.</summary>
    /// <param name="stingerName">Name of the stinger.</param>
    /// <param name="duckLevel">Background volume during stinger (0.0-1.0).</param>
    /// <param name="onComplete">Callback when stinger completes.</param>
    void DuckAndPlay(string stingerName, float duckLevel = 0.2f, Action? onComplete = null);

    /// <summary>Cancels any active transition.</summary>
    void Cancel();
}
```

---

## 5. CrossfadeManager Implementation

**File:** `src/Infrastructure/RuneAndRust.Infrastructure/Services/CrossfadeManager.cs`

```csharp
namespace RuneAndRust.Infrastructure.Services;

public class CrossfadeManager : ICrossfadeManager
{
    private readonly IMusicService _musicService;
    private readonly IAudioService _audioService;
    private readonly IMusicThemeConfig _themeConfig;
    private readonly ILogger<CrossfadeManager> _logger;
    private readonly TransitionSettings _settings;

    private CancellationTokenSource? _transitionCts;
    private float _originalVolume;
    private bool _isTransitioning;

    public bool IsTransitioning => _isTransitioning;

    public CrossfadeManager(IMusicService musicService, IAudioService audioService,
        IMusicThemeConfig themeConfig, ILogger<CrossfadeManager> logger)
    {
        _musicService = musicService;
        _audioService = audioService;
        _themeConfig = themeConfig;
        _logger = logger;
        _settings = LoadTransitionSettings();
    }

    public void CrossfadeTo(string newTrack, float duration, Action? onComplete = null)
    {
        Cancel();
        _transitionCts = new CancellationTokenSource();
        _isTransitioning = true;

        _ = ExecuteCrossfadeAsync(newTrack, duration, onComplete, _transitionCts.Token);
    }

    public void CrossfadeToTheme(MusicTheme theme, float duration)
    {
        var track = _themeConfig.GetTrackForTheme(theme);
        if (track is null)
        {
            _logger.LogWarning("No track for theme {Theme}", theme);
            return;
        }

        // Check for intro track
        var intro = _themeConfig.GetIntroTrack(theme);
        if (intro is not null)
        {
            // Play intro first, then crossfade to main
            CrossfadeTo(intro, duration, () =>
            {
                _musicService.PlayTrack(track, loop: true);
            });
        }
        else
        {
            CrossfadeTo(track, duration);
        }
    }

    private async Task ExecuteCrossfadeAsync(string newTrack, float duration,
        Action? onComplete, CancellationToken ct)
    {
        try
        {
            var steps = 20;
            var stepDuration = duration / steps;
            _originalVolume = _musicService.GetVolume();

            // Fade out current
            for (int i = steps; i >= 0 && !ct.IsCancellationRequested; i--)
            {
                var vol = _originalVolume * (i / (float)steps);
                _musicService.SetVolume(vol);
                await Task.Delay(TimeSpan.FromSeconds(stepDuration), ct);
            }

            if (ct.IsCancellationRequested) return;

            // Switch track
            _musicService.PlayTrack(newTrack, loop: true);

            // Fade in new
            for (int i = 0; i <= steps && !ct.IsCancellationRequested; i++)
            {
                var vol = _originalVolume * (i / (float)steps);
                _musicService.SetVolume(vol);
                await Task.Delay(TimeSpan.FromSeconds(stepDuration), ct);
            }

            _musicService.SetVolume(_originalVolume);
            _logger.LogDebug("Crossfade complete: {Track}", newTrack);
            onComplete?.Invoke();
        }
        finally
        {
            _isTransitioning = false;
        }
    }

    public void FadeOut(float duration)
    {
        Cancel();
        _transitionCts = new CancellationTokenSource();
        _isTransitioning = true;

        _ = ExecuteFadeAsync(fadeIn: false, duration, _transitionCts.Token);
    }

    public void FadeIn(float duration)
    {
        Cancel();
        _transitionCts = new CancellationTokenSource();
        _isTransitioning = true;

        _ = ExecuteFadeAsync(fadeIn: true, duration, _transitionCts.Token);
    }

    private async Task ExecuteFadeAsync(bool fadeIn, float duration, CancellationToken ct)
    {
        try
        {
            var steps = 20;
            var stepDuration = duration / steps;
            _originalVolume = _musicService.GetVolume();

            for (int i = 0; i <= steps && !ct.IsCancellationRequested; i++)
            {
                var progress = i / (float)steps;
                var vol = fadeIn ? (_originalVolume * progress) : (_originalVolume * (1 - progress));
                _musicService.SetVolume(vol);
                await Task.Delay(TimeSpan.FromSeconds(stepDuration), ct);
            }

            if (!fadeIn) _musicService.Pause();
            _logger.LogDebug("Fade {Direction} complete", fadeIn ? "in" : "out");
        }
        finally
        {
            _isTransitioning = false;
        }
    }

    public void DuckAndPlay(string stingerName, float duckLevel = 0.2f, Action? onComplete = null)
    {
        var stingerTrack = _themeConfig.GetStingerTrack(stingerName);
        if (stingerTrack is null)
        {
            _logger.LogWarning("Stinger not found: {Name}", stingerName);
            onComplete?.Invoke();
            return;
        }

        _originalVolume = _musicService.GetVolume();

        // Duck background
        _musicService.SetVolume(_originalVolume * duckLevel);

        // Play stinger
        _musicService.PlayStinger(stingerName, () =>
        {
            // Restore volume after delay
            Task.Delay(TimeSpan.FromSeconds(_settings.StingerResumeDelay)).ContinueWith(_ =>
            {
                _musicService.SetVolume(_originalVolume);
                _logger.LogDebug("Stinger complete, volume restored");
                onComplete?.Invoke();
            });
        });

        _logger.LogDebug("Playing stinger {Name} with duck to {Level}", stingerName, duckLevel);
    }

    public void Cancel()
    {
        _transitionCts?.Cancel();
        _transitionCts?.Dispose();
        _transitionCts = null;
        _isTransitioning = false;
    }

    private TransitionSettings LoadTransitionSettings() => new()
    {
        DefaultCrossfade = 2.0f,
        CombatCrossfade = 0.5f,
        StingerFadeOut = 1.0f,
        StingerResumeDelay = 0.5f
    };
}
```

---

## 6. MusicEventHandler

**File:** `src/Infrastructure/RuneAndRust.Infrastructure/Services/MusicEventHandler.cs`

```csharp
namespace RuneAndRust.Infrastructure.Services;

/// <summary>
/// Subscribes to game events and triggers music transitions.
/// </summary>
public class MusicEventHandler : IDisposable
{
    private readonly IMusicService _musicService;
    private readonly ICrossfadeManager _crossfade;
    private readonly IEventBus _eventBus;
    private readonly ILogger<MusicEventHandler> _logger;
    private readonly List<IDisposable> _subscriptions = new();

    private MusicTheme _themeBeforeCombat = MusicTheme.Exploration;

    public MusicEventHandler(IMusicService musicService, ICrossfadeManager crossfade,
        IEventBus eventBus, ILogger<MusicEventHandler> logger)
    {
        _musicService = musicService;
        _crossfade = crossfade;
        _eventBus = eventBus;
        _logger = logger;
        SubscribeToEvents();
    }

    private void SubscribeToEvents()
    {
        _subscriptions.Add(_eventBus.Subscribe<CombatStartedEvent>(OnCombatStarted));
        _subscriptions.Add(_eventBus.Subscribe<BossEncounterEvent>(OnBossEncounter));
        _subscriptions.Add(_eventBus.Subscribe<CombatEndedEvent>(OnCombatEnded));
        _subscriptions.Add(_eventBus.Subscribe<EnterSafeAreaEvent>(OnEnterSafeArea));
        _subscriptions.Add(_eventBus.Subscribe<LeaveSafeAreaEvent>(OnLeaveSafeArea));
        _subscriptions.Add(_eventBus.Subscribe<GamePausedEvent>(OnGamePaused));
        _subscriptions.Add(_eventBus.Subscribe<GameResumedEvent>(OnGameResumed));
        _subscriptions.Add(_eventBus.Subscribe<LevelUpEvent>(OnLevelUp));
        _subscriptions.Add(_eventBus.Subscribe<QuestCompletedEvent>(OnQuestCompleted));

        _logger.LogDebug("MusicEventHandler subscribed to game events");
    }

    private void OnCombatStarted(CombatStartedEvent e)
    {
        _themeBeforeCombat = _musicService.CurrentTheme;
        _crossfade.CrossfadeToTheme(MusicTheme.Combat, 0.5f);
        _logger.LogDebug("Combat started: transitioning to Combat theme");
    }

    private void OnBossEncounter(BossEncounterEvent e)
    {
        _crossfade.CrossfadeToTheme(MusicTheme.BossCombat, 0.5f);
        _logger.LogDebug("Boss encounter: transitioning to BossCombat theme");
    }

    private void OnCombatEnded(CombatEndedEvent e)
    {
        if (e.IsVictory)
        {
            // Play victory stinger, then return to exploration
            _crossfade.DuckAndPlay("victory", 0.2f, () =>
            {
                _crossfade.CrossfadeToTheme(MusicTheme.Exploration, 2.0f);
            });
            _logger.LogDebug("Victory: playing stinger then Exploration");
        }
        else
        {
            // Play defeat stinger
            _crossfade.DuckAndPlay("defeat", 0.1f);
            _logger.LogDebug("Defeat: playing stinger");
        }
    }

    private void OnEnterSafeArea(EnterSafeAreaEvent e)
    {
        _crossfade.CrossfadeToTheme(MusicTheme.SafeArea, 2.0f);
        _logger.LogDebug("Entered safe area: transitioning to SafeArea theme");
    }

    private void OnLeaveSafeArea(LeaveSafeAreaEvent e)
    {
        _crossfade.CrossfadeToTheme(MusicTheme.Exploration, 2.0f);
        _logger.LogDebug("Left safe area: transitioning to Exploration theme");
    }

    private void OnGamePaused(GamePausedEvent e)
    {
        _crossfade.FadeOut(0.5f);
        _logger.LogDebug("Game paused: fading out music");
    }

    private void OnGameResumed(GameResumedEvent e)
    {
        _musicService.Resume();
        _crossfade.FadeIn(0.5f);
        _logger.LogDebug("Game resumed: fading in music");
    }

    private void OnLevelUp(LevelUpEvent e)
    {
        _crossfade.DuckAndPlay("level-up", 0.3f);
        _logger.LogDebug("Level up: playing stinger");
    }

    private void OnQuestCompleted(QuestCompletedEvent e)
    {
        _crossfade.DuckAndPlay("quest-complete", 0.3f);
        _logger.LogDebug("Quest completed: playing stinger");
    }

    public void Dispose()
    {
        foreach (var sub in _subscriptions) sub.Dispose();
        _subscriptions.Clear();
    }
}
```

---

## 7. Transition Visualization

```
CROSSFADE VISUALIZATION (2.0s duration):
═══════════════════════════════════════════════════════════════════════

Time:    0.0s      0.5s      1.0s      1.5s      2.0s
         │         │         │         │         │
Old:     ████████  ██████░░  ████░░░░  ██░░░░░░  ░░░░░░░░
New:     ░░░░░░░░  ░░██████  ░░░░████  ░░░░░░██  ████████
         │         │         │         │         │
Vol:     100%      75%       50%       25%       0% (old)
         0%        25%       50%       75%       100% (new)


STINGER WITH DUCK:
═══════════════════════════════════════════════════════════════════════

Time:    0.0s      0.5s      1.0s      1.5s      2.0s      2.5s
         │         │         │         │         │         │
BG:      ████████  ██░░░░░░  ██░░░░░░  ██░░░░░░  ████████  ████████
         100%      20%       20%       20%       rising    100%
                   │         │         │         │
Stinger:           ████████  ████████  ████████  ░░░░░░░░
                   100%      100%      ending    complete


EVENT FLOW:
═══════════════════════════════════════════════════════════════════════

[Exploration] ─────── CombatStarted ────────▶ [Combat] (0.5s fade)
                           │
                           │ (boss detected)
                           ▼
[Combat] ──────────── BossEncounter ────────▶ [BossCombat] (0.5s fade)
                           │
                           │ (boss defeated)
                           ▼
[BossCombat] ─────── Victory ───────────────▶ [Stinger: victory]
                           │                        │
                           │                  (stinger ends)
                           │                        ▼
                           └──────────────────▶ [Exploration] (2.0s fade)
```

---

## 8. Unit Testing Requirements (~6 tests)

| Feature | Tests |
|---------|-------|
| CrossfadeTo starts transition | 1 |
| FadeOut reduces volume to 0 | 1 |
| FadeIn restores volume | 1 |
| DuckAndPlay reduces then restores | 1 |
| Cancel stops active transition | 1 |
| Event handler triggers on combat | 1 |

---

## 9. Acceptance Criteria

- [ ] CrossfadeTo smoothly transitions between tracks
- [ ] Crossfade respects duration setting
- [ ] FadeOut reduces volume to 0 and pauses
- [ ] FadeIn restores volume from 0
- [ ] DuckAndPlay reduces volume during stinger
- [ ] Volume restores after stinger completes
- [ ] Cancel stops active transitions
- [ ] IsTransitioning reports correctly
- [ ] CombatStarted triggers Combat theme
- [ ] BossEncounter triggers BossCombat theme
- [ ] Victory triggers stinger then Exploration
- [ ] Defeat triggers defeat stinger
- [ ] EnterSafeArea triggers SafeArea theme
- [ ] LeaveSafeArea triggers Exploration
- [ ] GamePaused fades out music
- [ ] GameResumed fades in music
- [ ] LevelUp triggers level-up stinger
- [ ] QuestCompleted triggers quest stinger
- [ ] ~6 unit tests pass

---

## 10. Dependencies

| From | Required |
|------|----------|
| v0.9.1a | `IMusicService` |
| v0.9.1b | `IMusicThemeConfig`, `TransitionSettings` |
| v0.9.0a | `IAudioService` |
| Application | `IEventBus`, game events |

---

## 11. Summary

v0.9.1c completes the Music System by adding:
- **Crossfade transitions** for smooth theme changes
- **Stinger ducking** for one-shot events with background reduction
- **Event-driven triggers** connecting game state to music
- **Configurable durations** for all transition types

---

*Document Version: 1.0 | Last Updated: 2026-01-10*
