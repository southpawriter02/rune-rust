# v0.13.5e Design Specification: Shared Layer Utilization

**Version:** 0.13.5e
**Theme:** Shared Layer Utilization
**Author:** Claude
**Created:** 2026-01-16
**Status:** Draft
**Prerequisites:** v0.13.5d Complete (Error Handling & Logging)

---

## Table of Contents

1. [Overview](#1-overview)
2. [Dependencies](#2-dependencies)
3. [Architecture Diagrams](#3-architecture-diagrams)
4. [Duplication Audit Results](#4-duplication-audit-results)
5. [Shared Utility Extractions](#5-shared-utility-extractions)
6. [Component Refactoring Plan](#6-component-refactoring-plan)
7. [Shared Layer Guidelines](#7-shared-layer-guidelines)
8. [Data Model Changes](#8-data-model-changes)
9. [Configuration](#9-configuration)
10. [Commands](#10-commands)
11. [User-Facing Changes](#11-user-facing-changes)
12. [Logging Specifications](#12-logging-specifications)
13. [Unit Testing Requirements](#13-unit-testing-requirements)
14. [Use Cases](#14-use-cases)
15. [Deliverable Checklist](#15-deliverable-checklist)
16. [Acceptance Criteria](#16-acceptance-criteria)
17. [Future Considerations](#17-future-considerations)
18. [Implementation Notes](#18-implementation-notes)
19. [Document Metadata](#19-document-metadata)

---

## 1. Overview

### 1.1 Purpose

This document provides a comprehensive design specification for v0.13.5e, the Shared Layer Utilization implementation. This part focuses on identifying duplicated logic between TUI and GUI layers, extracting common utilities to `Presentation.Shared`, refactoring existing components to use the shared code, and documenting guidelines for future shared layer usage.

### 1.2 Scope

**In Scope:**
- Audit TUI/GUI layers for duplicated logic
- Create `FormatUtilities` for common formatting operations
- Create `GridUtilities` for grid coordinate calculations
- Create `IconUtilities` for icon/symbol lookups
- Create `ValidationUtilities` for common input validation
- Refactor existing components to use shared utilities
- Document shared layer guidelines

**Out of Scope:**
- Error handling changes (v0.13.5d - completed)
- Service integration patterns (v0.13.5c - completed)
- Theme consolidation (v0.13.5b - completed)
- Naming conventions (v0.13.5a - completed)
- Accessibility and performance (v0.13.5f)

### 1.3 Key Deliverables

| Type | Count | Details |
|------|-------|---------|
| Shared Utility Classes | 4 | `FormatUtilities`, `GridUtilities`, `IconUtilities`, `ValidationUtilities` |
| Documentation | 1 | `SharedLayerGuidelines.md` in `/docs/guidelines/` |
| Refactored Components | ~8 | Components updated to use shared utilities |
| Unit Tests | ~4 | Shared utility tests |

---

## 2. Dependencies

### 2.1 Required from v0.13.5d (Error Handling & Logging)

| Component | Location | Usage |
|-----------|----------|-------|
| `UiLoggingExtensions` | `Presentation.Shared/Extensions/` | Already in shared layer |
| `RenderErrorHandler` | `Presentation.Shared/Utilities/` | Already in shared layer |
| `ErrorSeverity` | `Presentation.Shared/Enums/` | Already in shared layer |
| `FallbackType` | `Presentation.Shared/Enums/` | Already in shared layer |

### 2.2 Required from v0.13.5b (Theme Consolidation)

| Component | Location | Usage |
|-----------|----------|-------|
| `IThemeService` | `Presentation.Shared/Interfaces/` | Already in shared layer |
| `ThemeColor` | `Presentation.Shared/ValueObjects/` | Already in shared layer |
| `ColorKey` | `Presentation.Shared/Enums/` | Already in shared layer |
| `IconKey` | `Presentation.Shared/Enums/` | Already in shared layer |

### 2.3 Components with Duplicated Logic

| TUI Component | GUI Component | Duplicated Logic |
|---------------|---------------|------------------|
| `HealthBarDisplay` | `HealthBarControl` | Percentage formatting |
| `HealthBarDisplay` | `HealthBarControl` | Health threshold calculation |
| `ResourceBarDisplay` | `ResourceControl` | Resource type icon mapping |
| `StatusEffectPanel` | `StatusEffectControl` | Duration formatting |
| `CombatGridPanel` | `GridPanel` | Grid coordinate math |
| `CombatGridPanel` | `GridCellControl` | Position validation |
| `DamagePopupControl` | `DamagePopup` | Damage number formatting |
| `SpectreGameRenderer` | `MessageDisplay` | Message truncation |

### 2.4 Provides to v0.13.5f (Accessibility & Performance)

| Type | Usage |
|------|-------|
| `FormatUtilities` | Accessibility-friendly number formatting |
| `ValidationUtilities` | Input validation for accessibility features |

---

## 3. Architecture Diagrams

### 3.1 Shared Layer Architecture

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                    SHARED LAYER ARCHITECTURE                                 │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│                         Presentation.Shared                                  │
│                         ───────────────────                                  │
│                                                                              │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │                         UTILITIES                                    │    │
│  ├─────────────────────────────────────────────────────────────────────┤    │
│  │                                                                       │    │
│  │  ┌─────────────────────┐  ┌─────────────────────┐                    │    │
│  │  │   FormatUtilities   │  │   GridUtilities     │                    │    │
│  │  ├─────────────────────┤  ├─────────────────────┤                    │    │
│  │  │ FormatPercentage()  │  │ CalculateGridPos()  │                    │    │
│  │  │ FormatDuration()    │  │ IsValidPosition()   │                    │    │
│  │  │ FormatNumber()      │  │ GetAdjacentPos()    │                    │    │
│  │  │ FormatDelta()       │  │ CalculateDistance() │                    │    │
│  │  │ TruncateText()      │  │ GetDirection()      │                    │    │
│  │  └─────────────────────┘  └─────────────────────┘                    │    │
│  │                                                                       │    │
│  │  ┌─────────────────────┐  ┌─────────────────────┐                    │    │
│  │  │   IconUtilities     │  │ ValidationUtilities │                    │    │
│  │  ├─────────────────────┤  ├─────────────────────┤                    │    │
│  │  │ GetResourceIcon()   │  │ ValidatePercentage()│                    │    │
│  │  │ GetStatusIcon()     │  │ ValidateGridPos()   │                    │    │
│  │  │ GetDirectionIcon()  │  │ ClampValue()        │                    │    │
│  │  │ GetDamageTypeIcon() │  │ NormalizeValue()    │                    │    │
│  │  │ GetDiceIcon()       │  │ IsInRange()         │                    │    │
│  │  └─────────────────────┘  └─────────────────────┘                    │    │
│  │                                                                       │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
│                                                                              │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │                    EXISTING SHARED COMPONENTS                        │    │
│  ├─────────────────────────────────────────────────────────────────────┤    │
│  │                                                                       │    │
│  │  From v0.13.5b:           From v0.13.5c:         From v0.13.5d:      │    │
│  │  ├── IThemeService        ├── IComponentLife..   ├── UiLoggingExt    │    │
│  │  ├── ThemeColor           └────────────────────  ├── RenderError..   │    │
│  │  ├── ColorKey                                    ├── ErrorSeverity   │    │
│  │  ├── IconKey                                     └── FallbackType    │    │
│  │  └── ColorPalette                                                    │    │
│  │                                                                       │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
│                                                                              │
│                    ▲                         ▲                              │
│                    │ references              │ references                   │
│                    │                         │                              │
│  ┌─────────────────┴───────┐    ┌───────────┴─────────────────────────┐    │
│  │    Presentation.Tui     │    │         Presentation.Gui            │    │
│  │    ──────────────────   │    │         ────────────────            │    │
│  │                         │    │                                      │    │
│  │  Components now use:    │    │  Controls now use:                  │    │
│  │  ├── FormatUtilities    │    │  ├── FormatUtilities                │    │
│  │  ├── GridUtilities      │    │  ├── GridUtilities                  │    │
│  │  ├── IconUtilities      │    │  ├── IconUtilities                  │    │
│  │  └── ValidationUtils    │    │  └── ValidationUtils                │    │
│  │                         │    │                                      │    │
│  └─────────────────────────┘    └──────────────────────────────────────┘    │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 3.2 Duplication Elimination Flow

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                    DUPLICATION ELIMINATION FLOW                              │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  BEFORE:                                                                     │
│  ───────                                                                     │
│                                                                              │
│  Presentation.Tui                        Presentation.Gui                    │
│  ┌─────────────────────────┐            ┌─────────────────────────┐         │
│  │ HealthBarDisplay        │            │ HealthBarControl        │         │
│  │ ───────────────────     │            │ ──────────────────      │         │
│  │                         │            │                         │         │
│  │ string FormatPercent()  │◄──DUPE──►  │ string FormatPercent()  │         │
│  │ {                       │            │ {                       │         │
│  │   return $"{pct:P0}";   │            │   return $"{pct:P0}";   │         │
│  │ }                       │            │ }                       │         │
│  └─────────────────────────┘            └─────────────────────────┘         │
│                                                                              │
│  ┌─────────────────────────┐            ┌─────────────────────────┐         │
│  │ StatusEffectPanel       │            │ StatusEffectControl     │         │
│  │ ───────────────────     │            │ ─────────────────────   │         │
│  │                         │            │                         │         │
│  │ string FormatDuration() │◄──DUPE──►  │ string FormatDuration() │         │
│  │ {                       │            │ {                       │         │
│  │   if (ts < 1min)        │            │   if (ts < 1min)        │         │
│  │     return $"{s}s";     │            │     return $"{s}s";     │         │
│  │   ...                   │            │   ...                   │         │
│  │ }                       │            │ }                       │         │
│  └─────────────────────────┘            └─────────────────────────┘         │
│                                                                              │
│  ════════════════════════════════════════════════════════════════════════   │
│                                                                              │
│  AFTER:                                                                      │
│  ──────                                                                      │
│                                                                              │
│              Presentation.Shared                                             │
│              ┌─────────────────────────────────┐                            │
│              │      FormatUtilities            │                            │
│              │      ─────────────────          │                            │
│              │                                 │                            │
│              │ static string FormatPercentage()│                            │
│              │ static string FormatDuration()  │                            │
│              │ ...                             │                            │
│              └──────────────┬──────────────────┘                            │
│                             │                                                │
│              ┌──────────────┴──────────────┐                                │
│              │                             │                                │
│              ▼                             ▼                                │
│  Presentation.Tui                 Presentation.Gui                          │
│  ┌─────────────────────┐          ┌─────────────────────┐                   │
│  │ HealthBarDisplay    │          │ HealthBarControl    │                   │
│  │ ─────────────────   │          │ ──────────────────  │                   │
│  │                     │          │                     │                   │
│  │ // Uses shared:     │          │ // Uses shared:     │                   │
│  │ FormatUtilities     │          │ FormatUtilities     │                   │
│  │   .FormatPercentage │          │   .FormatPercentage │                   │
│  └─────────────────────┘          └─────────────────────┘                   │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 4. Duplication Audit Results

### 4.1 Identified Duplications

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                    DUPLICATION AUDIT RESULTS                                 │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  Category 1: Formatting Logic                                                │
│  ────────────────────────────                                                │
│                                                                              │
│  ┌────────────────────────────────────────────────────────────────────────┐ │
│  │ Duplication: Percentage Formatting                                      │ │
│  ├────────────────────────────────────────────────────────────────────────┤ │
│  │ TUI Location: HealthBarDisplay.FormatPercentage()                       │ │
│  │ GUI Location: HealthBarControl.FormatPercentage()                       │ │
│  │ Also in:      ResourceBarDisplay, BossHealthBarDisplay                  │ │
│  │                                                                          │ │
│  │ Code Pattern:                                                            │ │
│  │ ┌──────────────────────────────────────────────────────────────────┐    │ │
│  │ │ private string FormatPercentage(int current, int max)             │    │ │
│  │ │ {                                                                  │    │ │
│  │ │     if (max <= 0) return "0%";                                     │    │ │
│  │ │     var percentage = (double)current / max;                        │    │ │
│  │ │     return $"{percentage:P0}";                                     │    │ │
│  │ │ }                                                                  │    │ │
│  │ └──────────────────────────────────────────────────────────────────┘    │ │
│  │                                                                          │ │
│  │ Occurrences: 5                                                           │ │
│  │ Extract to: FormatUtilities.FormatPercentage()                          │ │
│  └────────────────────────────────────────────────────────────────────────┘ │
│                                                                              │
│  ┌────────────────────────────────────────────────────────────────────────┐ │
│  │ Duplication: Duration Formatting                                        │ │
│  ├────────────────────────────────────────────────────────────────────────┤ │
│  │ TUI Location: StatusEffectPanel.FormatDuration()                        │ │
│  │ GUI Location: StatusEffectControl.FormatDuration()                      │ │
│  │ Also in:      CooldownDisplay, BuffPanel                                │ │
│  │                                                                          │ │
│  │ Code Pattern:                                                            │ │
│  │ ┌──────────────────────────────────────────────────────────────────┐    │ │
│  │ │ private string FormatDuration(TimeSpan duration)                  │    │ │
│  │ │ {                                                                  │    │ │
│  │ │     if (duration.TotalSeconds < 60)                                │    │ │
│  │ │         return $"{duration.Seconds}s";                             │    │ │
│  │ │     if (duration.TotalMinutes < 60)                                │    │ │
│  │ │         return $"{duration.Minutes}m {duration.Seconds}s";         │    │ │
│  │ │     return $"{duration.Hours}h {duration.Minutes}m";               │    │ │
│  │ │ }                                                                  │    │ │
│  │ └──────────────────────────────────────────────────────────────────┘    │ │
│  │                                                                          │ │
│  │ Occurrences: 4                                                           │ │
│  │ Extract to: FormatUtilities.FormatDuration()                            │ │
│  └────────────────────────────────────────────────────────────────────────┘ │
│                                                                              │
│  ┌────────────────────────────────────────────────────────────────────────┐ │
│  │ Duplication: Number Formatting with Sign                                │ │
│  ├────────────────────────────────────────────────────────────────────────┤ │
│  │ TUI Location: DamageDisplay.FormatDelta()                               │ │
│  │ GUI Location: DamagePopupControl.FormatDelta()                          │ │
│  │ Also in:      StatChangeDisplay                                         │ │
│  │                                                                          │ │
│  │ Code Pattern:                                                            │ │
│  │ ┌──────────────────────────────────────────────────────────────────┐    │ │
│  │ │ private string FormatDelta(int oldValue, int newValue)            │    │ │
│  │ │ {                                                                  │    │ │
│  │ │     var delta = newValue - oldValue;                               │    │ │
│  │ │     return delta >= 0 ? $"+{delta}" : $"{delta}";                  │    │ │
│  │ │ }                                                                  │    │ │
│  │ └──────────────────────────────────────────────────────────────────┘    │ │
│  │                                                                          │ │
│  │ Occurrences: 3                                                           │ │
│  │ Extract to: FormatUtilities.FormatDelta()                               │ │
│  └────────────────────────────────────────────────────────────────────────┘ │
│                                                                              │
│  Category 2: Grid/Position Logic                                             │
│  ───────────────────────────────                                             │
│                                                                              │
│  ┌────────────────────────────────────────────────────────────────────────┐ │
│  │ Duplication: Grid Position Calculation                                  │ │
│  ├────────────────────────────────────────────────────────────────────────┤ │
│  │ TUI Location: CombatGridPanel.CalculatePosition()                       │ │
│  │ GUI Location: GridPanel.CalculatePosition()                             │ │
│  │                                                                          │ │
│  │ Code Pattern:                                                            │ │
│  │ ┌──────────────────────────────────────────────────────────────────┐    │ │
│  │ │ private Point CalculateGridPosition(int index, int gridWidth)     │    │ │
│  │ │ {                                                                  │    │ │
│  │ │     int x = index % gridWidth;                                     │    │ │
│  │ │     int y = index / gridWidth;                                     │    │ │
│  │ │     return new Point(x, y);                                        │    │ │
│  │ │ }                                                                  │    │ │
│  │ └──────────────────────────────────────────────────────────────────┘    │ │
│  │                                                                          │ │
│  │ Occurrences: 2                                                           │ │
│  │ Extract to: GridUtilities.CalculateGridPosition()                       │ │
│  └────────────────────────────────────────────────────────────────────────┘ │
│                                                                              │
│  ┌────────────────────────────────────────────────────────────────────────┐ │
│  │ Duplication: Position Validation                                        │ │
│  ├────────────────────────────────────────────────────────────────────────┤ │
│  │ TUI Location: CombatGridPanel.IsValidPosition()                         │ │
│  │ GUI Location: GridCellControl.IsValidPosition()                         │ │
│  │                                                                          │ │
│  │ Code Pattern:                                                            │ │
│  │ ┌──────────────────────────────────────────────────────────────────┐    │ │
│  │ │ private bool IsValidPosition(int x, int y, int width, int height) │    │ │
│  │ │ {                                                                  │    │ │
│  │ │     return x >= 0 && x < width && y >= 0 && y < height;            │    │ │
│  │ │ }                                                                  │    │ │
│  │ └──────────────────────────────────────────────────────────────────┘    │ │
│  │                                                                          │ │
│  │ Occurrences: 2                                                           │ │
│  │ Extract to: GridUtilities.IsValidPosition()                             │ │
│  └────────────────────────────────────────────────────────────────────────┘ │
│                                                                              │
│  ┌────────────────────────────────────────────────────────────────────────┐ │
│  │ Duplication: Adjacent Position Calculation                              │ │
│  ├────────────────────────────────────────────────────────────────────────┤ │
│  │ TUI Location: CombatGridPanel.GetAdjacentPositions()                    │ │
│  │ GUI Location: GridPanel.GetAdjacentPositions()                          │ │
│  │                                                                          │ │
│  │ Code Pattern:                                                            │ │
│  │ ┌──────────────────────────────────────────────────────────────────┐    │ │
│  │ │ private IEnumerable<Point> GetAdjacentPositions(int x, int y)     │    │ │
│  │ │ {                                                                  │    │ │
│  │ │     yield return new Point(x - 1, y);  // Left                     │    │ │
│  │ │     yield return new Point(x + 1, y);  // Right                    │    │ │
│  │ │     yield return new Point(x, y - 1);  // Up                       │    │ │
│  │ │     yield return new Point(x, y + 1);  // Down                     │    │ │
│  │ │ }                                                                  │    │ │
│  │ └──────────────────────────────────────────────────────────────────┘    │ │
│  │                                                                          │ │
│  │ Occurrences: 2                                                           │ │
│  │ Extract to: GridUtilities.GetAdjacentPositions()                        │ │
│  └────────────────────────────────────────────────────────────────────────┘ │
│                                                                              │
│  Category 3: Icon/Symbol Mapping                                             │
│  ───────────────────────────────                                             │
│                                                                              │
│  ┌────────────────────────────────────────────────────────────────────────┐ │
│  │ Duplication: Resource Type Icons                                        │ │
│  ├────────────────────────────────────────────────────────────────────────┤ │
│  │ TUI Location: ResourceBarDisplay (static dictionary)                    │ │
│  │ GUI Location: ResourceControl (static dictionary)                       │ │
│  │                                                                          │ │
│  │ Note: Partially addressed by IThemeService.GetIcon() in v0.13.5b        │ │
│  │ Remaining: Specific resource type → icon mapping logic                  │ │
│  │                                                                          │ │
│  │ Extract to: IconUtilities.GetResourceIcon()                             │ │
│  └────────────────────────────────────────────────────────────────────────┘ │
│                                                                              │
│  ┌────────────────────────────────────────────────────────────────────────┐ │
│  │ Duplication: Direction Symbols                                          │ │
│  ├────────────────────────────────────────────────────────────────────────┤ │
│  │ TUI Location: CombatGridPanel (switch expression)                       │ │
│  │ GUI Location: MovementIndicator (switch expression)                     │ │
│  │                                                                          │ │
│  │ Extract to: IconUtilities.GetDirectionIcon()                            │ │
│  └────────────────────────────────────────────────────────────────────────┘ │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 4.2 Duplication Summary

| Category | Duplications Found | Lines Duplicated | Extract To |
|----------|-------------------|------------------|------------|
| Percentage Formatting | 5 | ~25 | FormatUtilities |
| Duration Formatting | 4 | ~32 | FormatUtilities |
| Delta Formatting | 3 | ~15 | FormatUtilities |
| Grid Position | 2 | ~10 | GridUtilities |
| Position Validation | 2 | ~8 | GridUtilities |
| Adjacent Positions | 2 | ~12 | GridUtilities |
| Resource Icons | 2 | ~20 | IconUtilities |
| Direction Symbols | 2 | ~16 | IconUtilities |
| **Total** | **22** | **~138** | **4 utilities** |

---

## 5. Shared Utility Extractions

### 5.1 FormatUtilities Class

```
┌─────────────────────────────────────────────────────────────────────────────┐
│  FormatUtilities (Static Class - Presentation.Shared)                        │
│  ────────────────────────────────────────────────────                        │
│                                                                              │
│  Location: Presentation.Shared/Utilities/FormatUtilities.cs                  │
│                                                                              │
│  public static class FormatUtilities                                         │
│  {                                                                           │
│      // ═══════════════════════════════════════════════════════════════════ │
│      // PERCENTAGE FORMATTING                                                │
│      // ═══════════════════════════════════════════════════════════════════ │
│                                                                              │
│      /// <summary>                                                           │
│      /// Formats a current/max value pair as a percentage string.            │
│      /// </summary>                                                          │
│      /// <param name="current">Current value.</param>                        │
│      /// <param name="max">Maximum value.</param>                            │
│      /// <param name="format">Format string (default "P0").</param>          │
│      /// <returns>Formatted percentage string (e.g., "75%").</returns>       │
│      public static string FormatPercentage(int current, int max,             │
│          string format = "P0")                                               │
│      {                                                                       │
│          if (max <= 0) return "0%";                                          │
│          var percentage = Math.Clamp((double)current / max, 0, 1);           │
│          return percentage.ToString(format);                                 │
│      }                                                                       │
│                                                                              │
│      /// <summary>                                                           │
│      /// Formats a percentage value (0.0-1.0) as a string.                   │
│      /// </summary>                                                          │
│      public static string FormatPercentage(double percentage,                │
│          string format = "P0")                                               │
│      {                                                                       │
│          var clamped = Math.Clamp(percentage, 0, 1);                         │
│          return clamped.ToString(format);                                    │
│      }                                                                       │
│                                                                              │
│      // ═══════════════════════════════════════════════════════════════════ │
│      // DURATION FORMATTING                                                  │
│      // ═══════════════════════════════════════════════════════════════════ │
│                                                                              │
│      /// <summary>                                                           │
│      /// Formats a TimeSpan as a human-readable duration string.             │
│      /// </summary>                                                          │
│      /// <param name="duration">The duration to format.</param>              │
│      /// <param name="compact">Use compact format (default true).</param>    │
│      /// <returns>Formatted duration (e.g., "45s", "2m 30s").</returns>      │
│      public static string FormatDuration(TimeSpan duration,                  │
│          bool compact = true)                                                │
│      {                                                                       │
│          if (duration.TotalSeconds < 1)                                      │
│              return compact ? "<1s" : "less than 1 second";                  │
│                                                                              │
│          if (duration.TotalSeconds < 60)                                     │
│              return compact                                                  │
│                  ? $"{duration.Seconds}s"                                    │
│                  : $"{duration.Seconds} seconds";                            │
│                                                                              │
│          if (duration.TotalMinutes < 60)                                     │
│          {                                                                   │
│              var mins = (int)duration.TotalMinutes;                          │
│              var secs = duration.Seconds;                                    │
│              if (secs == 0)                                                  │
│                  return compact ? $"{mins}m" : $"{mins} minutes";            │
│              return compact                                                  │
│                  ? $"{mins}m {secs}s"                                        │
│                  : $"{mins} minutes {secs} seconds";                         │
│          }                                                                   │
│                                                                              │
│          var hours = (int)duration.TotalHours;                               │
│          var minutes = duration.Minutes;                                     │
│          if (minutes == 0)                                                   │
│              return compact ? $"{hours}h" : $"{hours} hours";                │
│          return compact                                                      │
│              ? $"{hours}h {minutes}m"                                        │
│              : $"{hours} hours {minutes} minutes";                           │
│      }                                                                       │
│                                                                              │
│      // ═══════════════════════════════════════════════════════════════════ │
│      // NUMBER FORMATTING                                                    │
│      // ═══════════════════════════════════════════════════════════════════ │
│                                                                              │
│      /// <summary>                                                           │
│      /// Formats a number with thousands separators.                         │
│      /// </summary>                                                          │
│      public static string FormatNumber(int value)                            │
│      {                                                                       │
│          return value.ToString("N0");                                        │
│      }                                                                       │
│                                                                              │
│      /// <summary>                                                           │
│      /// Formats a large number in compact form (e.g., 1.2K, 3.4M).          │
│      /// </summary>                                                          │
│      public static string FormatCompactNumber(long value)                    │
│      {                                                                       │
│          return value switch                                                 │
│          {                                                                   │
│              >= 1_000_000_000 => $"{value / 1_000_000_000.0:F1}B",           │
│              >= 1_000_000 => $"{value / 1_000_000.0:F1}M",                   │
│              >= 1_000 => $"{value / 1_000.0:F1}K",                           │
│              _ => value.ToString()                                           │
│          };                                                                  │
│      }                                                                       │
│                                                                              │
│      /// <summary>                                                           │
│      /// Formats a delta value with sign prefix.                             │
│      /// </summary>                                                          │
│      /// <param name="oldValue">Previous value.</param>                      │
│      /// <param name="newValue">New value.</param>                           │
│      /// <returns>Formatted delta (e.g., "+10", "-5").</returns>             │
│      public static string FormatDelta(int oldValue, int newValue)            │
│      {                                                                       │
│          var delta = newValue - oldValue;                                    │
│          return delta >= 0 ? $"+{delta}" : delta.ToString();                 │
│      }                                                                       │
│                                                                              │
│      /// <summary>                                                           │
│      /// Formats a delta value with sign prefix.                             │
│      /// </summary>                                                          │
│      public static string FormatDelta(int delta)                             │
│      {                                                                       │
│          return delta >= 0 ? $"+{delta}" : delta.ToString();                 │
│      }                                                                       │
│                                                                              │
│      // ═══════════════════════════════════════════════════════════════════ │
│      // TEXT FORMATTING                                                      │
│      // ═══════════════════════════════════════════════════════════════════ │
│                                                                              │
│      /// <summary>                                                           │
│      /// Truncates text to a maximum length with ellipsis.                   │
│      /// </summary>                                                          │
│      public static string TruncateText(string text, int maxLength,           │
│          string ellipsis = "...")                                            │
│      {                                                                       │
│          if (string.IsNullOrEmpty(text)) return string.Empty;                │
│          if (text.Length <= maxLength) return text;                          │
│          if (maxLength <= ellipsis.Length) return ellipsis[..maxLength];     │
│          return text[..(maxLength - ellipsis.Length)] + ellipsis;            │
│      }                                                                       │
│                                                                              │
│      /// <summary>                                                           │
│      /// Pads text to center within a given width.                           │
│      /// </summary>                                                          │
│      public static string CenterText(string text, int width)                 │
│      {                                                                       │
│          if (string.IsNullOrEmpty(text)) return new string(' ', width);      │
│          if (text.Length >= width) return text;                              │
│          var padding = (width - text.Length) / 2;                            │
│          return text.PadLeft(padding + text.Length).PadRight(width);         │
│      }                                                                       │
│  }                                                                           │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 5.2 GridUtilities Class

```
┌─────────────────────────────────────────────────────────────────────────────┐
│  GridUtilities (Static Class - Presentation.Shared)                          │
│  ──────────────────────────────────────────────────                          │
│                                                                              │
│  Location: Presentation.Shared/Utilities/GridUtilities.cs                    │
│                                                                              │
│  public static class GridUtilities                                           │
│  {                                                                           │
│      // ═══════════════════════════════════════════════════════════════════ │
│      // POSITION CALCULATION                                                 │
│      // ═══════════════════════════════════════════════════════════════════ │
│                                                                              │
│      /// <summary>                                                           │
│      /// Converts a linear index to grid coordinates.                        │
│      /// </summary>                                                          │
│      /// <param name="index">Linear index (0-based).</param>                 │
│      /// <param name="gridWidth">Width of the grid.</param>                  │
│      /// <returns>Grid position as (x, y) tuple.</returns>                   │
│      public static (int X, int Y) CalculateGridPosition(int index,           │
│          int gridWidth)                                                      │
│      {                                                                       │
│          if (gridWidth <= 0)                                                 │
│              throw new ArgumentOutOfRangeException(nameof(gridWidth));       │
│          return (index % gridWidth, index / gridWidth);                      │
│      }                                                                       │
│                                                                              │
│      /// <summary>                                                           │
│      /// Converts grid coordinates to a linear index.                        │
│      /// </summary>                                                          │
│      public static int CalculateLinearIndex(int x, int y, int gridWidth)     │
│      {                                                                       │
│          if (gridWidth <= 0)                                                 │
│              throw new ArgumentOutOfRangeException(nameof(gridWidth));       │
│          return y * gridWidth + x;                                           │
│      }                                                                       │
│                                                                              │
│      // ═══════════════════════════════════════════════════════════════════ │
│      // POSITION VALIDATION                                                  │
│      // ═══════════════════════════════════════════════════════════════════ │
│                                                                              │
│      /// <summary>                                                           │
│      /// Checks if coordinates are within grid bounds.                       │
│      /// </summary>                                                          │
│      public static bool IsValidPosition(int x, int y, int width, int height) │
│      {                                                                       │
│          return x >= 0 && x < width && y >= 0 && y < height;                 │
│      }                                                                       │
│                                                                              │
│      /// <summary>                                                           │
│      /// Checks if coordinates are within grid bounds.                       │
│      /// </summary>                                                          │
│      public static bool IsValidPosition((int X, int Y) position,             │
│          int width, int height)                                              │
│      {                                                                       │
│          return IsValidPosition(position.X, position.Y, width, height);      │
│      }                                                                       │
│                                                                              │
│      // ═══════════════════════════════════════════════════════════════════ │
│      // ADJACENT POSITIONS                                                   │
│      // ═══════════════════════════════════════════════════════════════════ │
│                                                                              │
│      /// <summary>                                                           │
│      /// Gets the four cardinal adjacent positions.                          │
│      /// </summary>                                                          │
│      public static IEnumerable<(int X, int Y)> GetAdjacentPositions(         │
│          int x, int y)                                                       │
│      {                                                                       │
│          yield return (x - 1, y);  // Left                                   │
│          yield return (x + 1, y);  // Right                                  │
│          yield return (x, y - 1);  // Up                                     │
│          yield return (x, y + 1);  // Down                                   │
│      }                                                                       │
│                                                                              │
│      /// <summary>                                                           │
│      /// Gets all eight adjacent positions (including diagonals).            │
│      /// </summary>                                                          │
│      public static IEnumerable<(int X, int Y)> GetAllAdjacentPositions(      │
│          int x, int y)                                                       │
│      {                                                                       │
│          for (int dx = -1; dx <= 1; dx++)                                    │
│          {                                                                   │
│              for (int dy = -1; dy <= 1; dy++)                                │
│              {                                                               │
│                  if (dx == 0 && dy == 0) continue;                           │
│                  yield return (x + dx, y + dy);                              │
│              }                                                               │
│          }                                                                   │
│      }                                                                       │
│                                                                              │
│      /// <summary>                                                           │
│      /// Gets valid adjacent positions within grid bounds.                   │
│      /// </summary>                                                          │
│      public static IEnumerable<(int X, int Y)> GetValidAdjacentPositions(    │
│          int x, int y, int width, int height,                                │
│          bool includeDiagonals = false)                                      │
│      {                                                                       │
│          var positions = includeDiagonals                                    │
│              ? GetAllAdjacentPositions(x, y)                                 │
│              : GetAdjacentPositions(x, y);                                   │
│                                                                              │
│          return positions.Where(p => IsValidPosition(p, width, height));     │
│      }                                                                       │
│                                                                              │
│      // ═══════════════════════════════════════════════════════════════════ │
│      // DISTANCE CALCULATION                                                 │
│      // ═══════════════════════════════════════════════════════════════════ │
│                                                                              │
│      /// <summary>                                                           │
│      /// Calculates Manhattan distance between two positions.                │
│      /// </summary>                                                          │
│      public static int CalculateManhattanDistance(int x1, int y1,            │
│          int x2, int y2)                                                     │
│      {                                                                       │
│          return Math.Abs(x2 - x1) + Math.Abs(y2 - y1);                       │
│      }                                                                       │
│                                                                              │
│      /// <summary>                                                           │
│      /// Calculates Chebyshev distance (diagonal movement allowed).          │
│      /// </summary>                                                          │
│      public static int CalculateChebyshevDistance(int x1, int y1,            │
│          int x2, int y2)                                                     │
│      {                                                                       │
│          return Math.Max(Math.Abs(x2 - x1), Math.Abs(y2 - y1));              │
│      }                                                                       │
│                                                                              │
│      // ═══════════════════════════════════════════════════════════════════ │
│      // DIRECTION CALCULATION                                                │
│      // ═══════════════════════════════════════════════════════════════════ │
│                                                                              │
│      /// <summary>                                                           │
│      /// Gets the direction from one position to another.                    │
│      /// </summary>                                                          │
│      public static Direction GetDirection(int fromX, int fromY,              │
│          int toX, int toY)                                                   │
│      {                                                                       │
│          var dx = Math.Sign(toX - fromX);                                    │
│          var dy = Math.Sign(toY - fromY);                                    │
│                                                                              │
│          return (dx, dy) switch                                              │
│          {                                                                   │
│              (0, -1) => Direction.North,                                     │
│              (1, -1) => Direction.NorthEast,                                 │
│              (1, 0) => Direction.East,                                       │
│              (1, 1) => Direction.SouthEast,                                  │
│              (0, 1) => Direction.South,                                      │
│              (-1, 1) => Direction.SouthWest,                                 │
│              (-1, 0) => Direction.West,                                      │
│              (-1, -1) => Direction.NorthWest,                                │
│              _ => Direction.None                                             │
│          };                                                                  │
│      }                                                                       │
│  }                                                                           │
│                                                                              │
│  public enum Direction                                                       │
│  {                                                                           │
│      None,                                                                   │
│      North, NorthEast, East, SouthEast,                                      │
│      South, SouthWest, West, NorthWest                                       │
│  }                                                                           │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 5.3 IconUtilities Class

```
┌─────────────────────────────────────────────────────────────────────────────┐
│  IconUtilities (Static Class - Presentation.Shared)                          │
│  ──────────────────────────────────────────────────                          │
│                                                                              │
│  Location: Presentation.Shared/Utilities/IconUtilities.cs                    │
│                                                                              │
│  public static class IconUtilities                                           │
│  {                                                                           │
│      // ═══════════════════════════════════════════════════════════════════ │
│      // DIRECTION ICONS                                                      │
│      // ═══════════════════════════════════════════════════════════════════ │
│                                                                              │
│      /// <summary>                                                           │
│      /// Gets an arrow icon for a direction.                                 │
│      /// </summary>                                                          │
│      public static string GetDirectionIcon(Direction direction,              │
│          bool useUnicode = true)                                             │
│      {                                                                       │
│          if (useUnicode)                                                     │
│          {                                                                   │
│              return direction switch                                         │
│              {                                                               │
│                  Direction.North => "↑",                                     │
│                  Direction.NorthEast => "↗",                                 │
│                  Direction.East => "→",                                      │
│                  Direction.SouthEast => "↘",                                 │
│                  Direction.South => "↓",                                     │
│                  Direction.SouthWest => "↙",                                 │
│                  Direction.West => "←",                                      │
│                  Direction.NorthWest => "↖",                                 │
│                  _ => "·"                                                    │
│              };                                                              │
│          }                                                                   │
│          else                                                                │
│          {                                                                   │
│              return direction switch                                         │
│              {                                                               │
│                  Direction.North => "^",                                     │
│                  Direction.NorthEast => "/",                                 │
│                  Direction.East => ">",                                      │
│                  Direction.SouthEast => "\\",                                │
│                  Direction.South => "v",                                     │
│                  Direction.SouthWest => "/",                                 │
│                  Direction.West => "<",                                      │
│                  Direction.NorthWest => "\\",                                │
│                  _ => "."                                                    │
│              };                                                              │
│          }                                                                   │
│      }                                                                       │
│                                                                              │
│      // ═══════════════════════════════════════════════════════════════════ │
│      // DAMAGE TYPE ICONS                                                    │
│      // ═══════════════════════════════════════════════════════════════════ │
│                                                                              │
│      /// <summary>                                                           │
│      /// Gets an icon for a damage type.                                     │
│      /// </summary>                                                          │
│      public static string GetDamageTypeIcon(DamageType damageType,           │
│          bool useUnicode = true)                                             │
│      {                                                                       │
│          if (useUnicode)                                                     │
│          {                                                                   │
│              return damageType switch                                        │
│              {                                                               │
│                  DamageType.Physical => "⚔",                                 │
│                  DamageType.Fire => "🔥",                                    │
│                  DamageType.Ice => "❄",                                      │
│                  DamageType.Lightning => "⚡",                               │
│                  DamageType.Poison => "☠",                                   │
│                  DamageType.Healing => "💚",                                 │
│                  _ => "✦"                                                    │
│              };                                                              │
│          }                                                                   │
│          else                                                                │
│          {                                                                   │
│              return damageType switch                                        │
│              {                                                               │
│                  DamageType.Physical => "[P]",                               │
│                  DamageType.Fire => "[F]",                                   │
│                  DamageType.Ice => "[I]",                                    │
│                  DamageType.Lightning => "[L]",                              │
│                  DamageType.Poison => "[X]",                                 │
│                  DamageType.Healing => "[H]",                                │
│                  _ => "[?]"                                                  │
│              };                                                              │
│          }                                                                   │
│      }                                                                       │
│                                                                              │
│      // ═══════════════════════════════════════════════════════════════════ │
│      // DICE ICONS                                                           │
│      // ═══════════════════════════════════════════════════════════════════ │
│                                                                              │
│      /// <summary>                                                           │
│      /// Gets an icon representing a die face value (1-6).                   │
│      /// </summary>                                                          │
│      public static string GetDieFaceIcon(int value, bool useUnicode = true)  │
│      {                                                                       │
│          if (useUnicode && value >= 1 && value <= 6)                         │
│          {                                                                   │
│              // Unicode die faces: ⚀ ⚁ ⚂ ⚃ ⚄ ⚅                              │
│              return ((char)(0x2680 + value - 1)).ToString();                 │
│          }                                                                   │
│          return $"[{value}]";                                                │
│      }                                                                       │
│                                                                              │
│      /// <summary>                                                           │
│      /// Gets a generic die icon.                                            │
│      /// </summary>                                                          │
│      public static string GetDiceIcon(DiceType diceType,                     │
│          bool useUnicode = true)                                             │
│      {                                                                       │
│          if (useUnicode)                                                     │
│          {                                                                   │
│              return diceType switch                                          │
│              {                                                               │
│                  DiceType.D4 => "🎲₄",                                       │
│                  DiceType.D6 => "🎲₆",                                       │
│                  DiceType.D8 => "🎲₈",                                       │
│                  DiceType.D10 => "🎲₁₀",                                     │
│                  DiceType.D12 => "🎲₁₂",                                     │
│                  DiceType.D20 => "🎲₂₀",                                     │
│                  DiceType.D100 => "🎲₁₀₀",                                   │
│                  _ => "🎲"                                                   │
│              };                                                              │
│          }                                                                   │
│          return $"d{(int)diceType}";                                         │
│      }                                                                       │
│                                                                              │
│      // ═══════════════════════════════════════════════════════════════════ │
│      // STATUS INDICATORS                                                    │
│      // ═══════════════════════════════════════════════════════════════════ │
│                                                                              │
│      /// <summary>                                                           │
│      /// Gets a status indicator icon.                                       │
│      /// </summary>                                                          │
│      public static string GetStatusIcon(StatusType status,                   │
│          bool useUnicode = true)                                             │
│      {                                                                       │
│          if (useUnicode)                                                     │
│          {                                                                   │
│              return status switch                                            │
│              {                                                               │
│                  StatusType.Success => "✓",                                  │
│                  StatusType.Failure => "✗",                                  │
│                  StatusType.Warning => "⚠",                                  │
│                  StatusType.Info => "ℹ",                                     │
│                  StatusType.Pending => "◌",                                  │
│                  StatusType.InProgress => "◐",                               │
│                  _ => "○"                                                    │
│              };                                                              │
│          }                                                                   │
│          return status switch                                                │
│          {                                                                   │
│              StatusType.Success => "[OK]",                                   │
│              StatusType.Failure => "[X]",                                    │
│              StatusType.Warning => "[!]",                                    │
│              StatusType.Info => "[i]",                                       │
│              StatusType.Pending => "[ ]",                                    │
│              StatusType.InProgress => "[.]",                                 │
│              _ => "[ ]"                                                      │
│          };                                                                  │
│      }                                                                       │
│  }                                                                           │
│                                                                              │
│  public enum StatusType                                                      │
│  {                                                                           │
│      Success, Failure, Warning, Info, Pending, InProgress                    │
│  }                                                                           │
│                                                                              │
│  public enum DiceType                                                        │
│  {                                                                           │
│      D4 = 4, D6 = 6, D8 = 8, D10 = 10, D12 = 12, D20 = 20, D100 = 100       │
│  }                                                                           │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 5.4 ValidationUtilities Class

```
┌─────────────────────────────────────────────────────────────────────────────┐
│  ValidationUtilities (Static Class - Presentation.Shared)                    │
│  ────────────────────────────────────────────────────────                    │
│                                                                              │
│  Location: Presentation.Shared/Utilities/ValidationUtilities.cs              │
│                                                                              │
│  public static class ValidationUtilities                                     │
│  {                                                                           │
│      // ═══════════════════════════════════════════════════════════════════ │
│      // VALUE VALIDATION                                                     │
│      // ═══════════════════════════════════════════════════════════════════ │
│                                                                              │
│      /// <summary>                                                           │
│      /// Validates a percentage value is between 0 and 1.                    │
│      /// </summary>                                                          │
│      public static bool ValidatePercentage(double percentage)                │
│      {                                                                       │
│          return percentage >= 0 && percentage <= 1;                          │
│      }                                                                       │
│                                                                              │
│      /// <summary>                                                           │
│      /// Validates that current <= max and both are non-negative.            │
│      /// </summary>                                                          │
│      public static bool ValidateCurrentMax(int current, int max)             │
│      {                                                                       │
│          return current >= 0 && max >= 0 && current <= max;                  │
│      }                                                                       │
│                                                                              │
│      /// <summary>                                                           │
│      /// Checks if a value is within a specified range (inclusive).          │
│      /// </summary>                                                          │
│      public static bool IsInRange(int value, int min, int max)               │
│      {                                                                       │
│          return value >= min && value <= max;                                │
│      }                                                                       │
│                                                                              │
│      /// <summary>                                                           │
│      /// Checks if a value is within a specified range (inclusive).          │
│      /// </summary>                                                          │
│      public static bool IsInRange(double value, double min, double max)      │
│      {                                                                       │
│          return value >= min && value <= max;                                │
│      }                                                                       │
│                                                                              │
│      // ═══════════════════════════════════════════════════════════════════ │
│      // VALUE CLAMPING                                                       │
│      // ═══════════════════════════════════════════════════════════════════ │
│                                                                              │
│      /// <summary>                                                           │
│      /// Clamps a value to be within the specified range.                    │
│      /// </summary>                                                          │
│      public static int ClampValue(int value, int min, int max)               │
│      {                                                                       │
│          return Math.Clamp(value, min, max);                                 │
│      }                                                                       │
│                                                                              │
│      /// <summary>                                                           │
│      /// Clamps a value to be within the specified range.                    │
│      /// </summary>                                                          │
│      public static double ClampValue(double value, double min, double max)   │
│      {                                                                       │
│          return Math.Clamp(value, min, max);                                 │
│      }                                                                       │
│                                                                              │
│      /// <summary>                                                           │
│      /// Clamps a percentage to [0, 1].                                      │
│      /// </summary>                                                          │
│      public static double ClampPercentage(double percentage)                 │
│      {                                                                       │
│          return Math.Clamp(percentage, 0, 1);                                │
│      }                                                                       │
│                                                                              │
│      // ═══════════════════════════════════════════════════════════════════ │
│      // VALUE NORMALIZATION                                                  │
│      // ═══════════════════════════════════════════════════════════════════ │
│                                                                              │
│      /// <summary>                                                           │
│      /// Normalizes a value to a 0-1 range.                                  │
│      /// </summary>                                                          │
│      public static double NormalizeValue(int value, int min, int max)        │
│      {                                                                       │
│          if (max <= min) return 0;                                           │
│          return Math.Clamp((double)(value - min) / (max - min), 0, 1);       │
│      }                                                                       │
│                                                                              │
│      /// <summary>                                                           │
│      /// Normalizes a value to a 0-1 range.                                  │
│      /// </summary>                                                          │
│      public static double NormalizeValue(double value, double min,           │
│          double max)                                                         │
│      {                                                                       │
│          if (max <= min) return 0;                                           │
│          return Math.Clamp((value - min) / (max - min), 0, 1);               │
│      }                                                                       │
│                                                                              │
│      /// <summary>                                                           │
│      /// Denormalizes a 0-1 value to the specified range.                    │
│      /// </summary>                                                          │
│      public static int DenormalizeValue(double normalized, int min, int max) │
│      {                                                                       │
│          var clamped = Math.Clamp(normalized, 0, 1);                         │
│          return (int)Math.Round(min + clamped * (max - min));                │
│      }                                                                       │
│                                                                              │
│      // ═══════════════════════════════════════════════════════════════════ │
│      // GRID VALIDATION                                                      │
│      // ═══════════════════════════════════════════════════════════════════ │
│                                                                              │
│      /// <summary>                                                           │
│      /// Validates grid dimensions are positive.                             │
│      /// </summary>                                                          │
│      public static bool ValidateGridDimensions(int width, int height)        │
│      {                                                                       │
│          return width > 0 && height > 0;                                     │
│      }                                                                       │
│                                                                              │
│      /// <summary>                                                           │
│      /// Validates a grid position is within bounds.                         │
│      /// </summary>                                                          │
│      public static bool ValidateGridPosition(int x, int y,                   │
│          int width, int height)                                              │
│      {                                                                       │
│          return x >= 0 && x < width && y >= 0 && y < height;                 │
│      }                                                                       │
│  }                                                                           │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 6. Component Refactoring Plan

### 6.1 TUI Component Refactoring

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                    TUI COMPONENT REFACTORING                                 │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │  HealthBarDisplay Refactoring                                         │    │
│  │  ────────────────────────────                                         │    │
│  │                                                                       │    │
│  │  BEFORE:                                                              │    │
│  │  ┌────────────────────────────────────────────────────────────────┐  │    │
│  │  │ private string FormatPercentage(int current, int max)           │  │    │
│  │  │ {                                                                │  │    │
│  │  │     if (max <= 0) return "0%";                                   │  │    │
│  │  │     return $"{(double)current / max:P0}";                        │  │    │
│  │  │ }                                                                │  │    │
│  │  └────────────────────────────────────────────────────────────────┘  │    │
│  │                                                                       │    │
│  │  AFTER:                                                               │    │
│  │  ┌────────────────────────────────────────────────────────────────┐  │    │
│  │  │ // Remove local method, use shared utility:                      │  │    │
│  │  │ var display = FormatUtilities.FormatPercentage(current, max);    │  │    │
│  │  └────────────────────────────────────────────────────────────────┘  │    │
│  │                                                                       │    │
│  │  Changes: Remove 1 method (~6 lines), add 1 using, update 1 call    │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
│                                                                              │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │  StatusEffectPanel Refactoring                                        │    │
│  │  ─────────────────────────────                                        │    │
│  │                                                                       │    │
│  │  BEFORE:                                                              │    │
│  │  ┌────────────────────────────────────────────────────────────────┐  │    │
│  │  │ private string FormatDuration(TimeSpan duration)                 │  │    │
│  │  │ {                                                                │  │    │
│  │  │     if (duration.TotalSeconds < 60)                              │  │    │
│  │  │         return $"{duration.Seconds}s";                           │  │    │
│  │  │     if (duration.TotalMinutes < 60)                              │  │    │
│  │  │         return $"{duration.Minutes}m {duration.Seconds}s";       │  │    │
│  │  │     return $"{duration.Hours}h {duration.Minutes}m";             │  │    │
│  │  │ }                                                                │  │    │
│  │  └────────────────────────────────────────────────────────────────┘  │    │
│  │                                                                       │    │
│  │  AFTER:                                                               │    │
│  │  ┌────────────────────────────────────────────────────────────────┐  │    │
│  │  │ var display = FormatUtilities.FormatDuration(duration);          │  │    │
│  │  └────────────────────────────────────────────────────────────────┘  │    │
│  │                                                                       │    │
│  │  Changes: Remove 1 method (~8 lines), add 1 using, update 2 calls   │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
│                                                                              │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │  CombatGridPanel Refactoring                                          │    │
│  │  ───────────────────────────                                          │    │
│  │                                                                       │    │
│  │  BEFORE:                                                              │    │
│  │  ┌────────────────────────────────────────────────────────────────┐  │    │
│  │  │ private (int x, int y) CalculatePosition(int index)              │  │    │
│  │  │ {                                                                │  │    │
│  │  │     return (index % _gridWidth, index / _gridWidth);             │  │    │
│  │  │ }                                                                │  │    │
│  │  │                                                                  │  │    │
│  │  │ private bool IsValidPosition(int x, int y)                       │  │    │
│  │  │ {                                                                │  │    │
│  │  │     return x >= 0 && x < _gridWidth &&                           │  │    │
│  │  │            y >= 0 && y < _gridHeight;                            │  │    │
│  │  │ }                                                                │  │    │
│  │  │                                                                  │  │    │
│  │  │ private IEnumerable<(int, int)> GetAdjacentPositions(int x, y)   │  │    │
│  │  │ {                                                                │  │    │
│  │  │     yield return (x - 1, y);                                     │  │    │
│  │  │     yield return (x + 1, y);                                     │  │    │
│  │  │     yield return (x, y - 1);                                     │  │    │
│  │  │     yield return (x, y + 1);                                     │  │    │
│  │  │ }                                                                │  │    │
│  │  └────────────────────────────────────────────────────────────────┘  │    │
│  │                                                                       │    │
│  │  AFTER:                                                               │    │
│  │  ┌────────────────────────────────────────────────────────────────┐  │    │
│  │  │ var pos = GridUtilities.CalculateGridPosition(index, _gridWidth);│  │    │
│  │  │ var valid = GridUtilities.IsValidPosition(x, y, _width, _height);│  │    │
│  │  │ var adj = GridUtilities.GetAdjacentPositions(x, y);              │  │    │
│  │  └────────────────────────────────────────────────────────────────┘  │    │
│  │                                                                       │    │
│  │  Changes: Remove 3 methods (~15 lines), add 1 using, update 5 calls │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
│                                                                              │
│  Summary of TUI Refactoring:                                                 │
│  ──────────────────────────                                                  │
│  Components: HealthBarDisplay, ResourceBarDisplay, StatusEffectPanel,        │
│              CombatGridPanel, SpectreGameRenderer                            │
│  Methods removed: ~12                                                        │
│  Lines saved: ~60                                                            │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 6.2 GUI Component Refactoring

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                    GUI COMPONENT REFACTORING                                 │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │  HealthBarControl Refactoring                                         │    │
│  │  ────────────────────────────                                         │    │
│  │                                                                       │    │
│  │  BEFORE:                                                              │    │
│  │  ┌────────────────────────────────────────────────────────────────┐  │    │
│  │  │ private string FormatPercentage(double percentage)               │  │    │
│  │  │ {                                                                │  │    │
│  │  │     return $"{percentage:P0}";                                   │  │    │
│  │  │ }                                                                │  │    │
│  │  └────────────────────────────────────────────────────────────────┘  │    │
│  │                                                                       │    │
│  │  AFTER:                                                               │    │
│  │  ┌────────────────────────────────────────────────────────────────┐  │    │
│  │  │ var display = FormatUtilities.FormatPercentage(percentage);      │  │    │
│  │  └────────────────────────────────────────────────────────────────┘  │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
│                                                                              │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │  GridCellControl Refactoring                                          │    │
│  │  ───────────────────────────                                          │    │
│  │                                                                       │    │
│  │  BEFORE:                                                              │    │
│  │  ┌────────────────────────────────────────────────────────────────┐  │    │
│  │  │ private bool IsValidPosition(int x, int y)                       │  │    │
│  │  │ {                                                                │  │    │
│  │  │     return x >= 0 && x < GridWidth && y >= 0 && y < GridHeight;  │  │    │
│  │  │ }                                                                │  │    │
│  │  └────────────────────────────────────────────────────────────────┘  │    │
│  │                                                                       │    │
│  │  AFTER:                                                               │    │
│  │  ┌────────────────────────────────────────────────────────────────┐  │    │
│  │  │ var valid = GridUtilities.IsValidPosition(x, y, GridWidth,       │  │    │
│  │  │     GridHeight);                                                 │  │    │
│  │  └────────────────────────────────────────────────────────────────┘  │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
│                                                                              │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │  StatusEffectControl Refactoring                                      │    │
│  │  ───────────────────────────────                                      │    │
│  │                                                                       │    │
│  │  BEFORE:                                                              │    │
│  │  ┌────────────────────────────────────────────────────────────────┐  │    │
│  │  │ private string FormatDuration(TimeSpan remaining)                │  │    │
│  │  │ {                                                                │  │    │
│  │  │     if (remaining.TotalSeconds < 60)                             │  │    │
│  │  │         return $"{remaining.Seconds}s";                          │  │    │
│  │  │     return $"{remaining.Minutes}:{remaining.Seconds:D2}";        │  │    │
│  │  │ }                                                                │  │    │
│  │  └────────────────────────────────────────────────────────────────┘  │    │
│  │                                                                       │    │
│  │  AFTER:                                                               │    │
│  │  ┌────────────────────────────────────────────────────────────────┐  │    │
│  │  │ var display = FormatUtilities.FormatDuration(remaining);         │  │    │
│  │  └────────────────────────────────────────────────────────────────┘  │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
│                                                                              │
│  Summary of GUI Refactoring:                                                 │
│  ──────────────────────────                                                  │
│  Components: HealthBarControl, GridCellControl, StatusEffectControl,         │
│              DamagePopupControl, GridPanel                                   │
│  Methods removed: ~10                                                        │
│  Lines saved: ~50                                                            │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 7. Shared Layer Guidelines

### 7.1 Guidelines Summary

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                    SHARED LAYER GUIDELINES                                   │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  1. WHAT BELONGS IN PRESENTATION.SHARED                                      │
│  ─────────────────────────────────────                                       │
│                                                                              │
│  ✓ Platform-agnostic utility classes (FormatUtilities, GridUtilities)        │
│  ✓ Shared interfaces (IThemeService, IComponentLifecycle)                    │
│  ✓ Shared enums (ColorKey, IconKey, ErrorSeverity)                           │
│  ✓ Shared value objects (ThemeColor, RenderErrorContext)                     │
│  ✓ Extension methods for shared dependencies (UiLoggingExtensions)           │
│  ✓ Constants shared between TUI and GUI                                      │
│                                                                              │
│  ✗ TUI-specific code (ConsoleColor, Spectre.Console)                         │
│  ✗ GUI-specific code (Avalonia, Brushes)                                     │
│  ✗ Platform-specific implementations                                         │
│  ✗ UI component implementations                                              │
│                                                                              │
│  2. DESIGN PRINCIPLES                                                        │
│  ────────────────────                                                        │
│                                                                              │
│  • Prefer static utility classes for stateless operations                    │
│  • Use interfaces for dependencies that require implementation               │
│  • Keep shared code minimal and focused                                      │
│  • Avoid platform-specific dependencies                                      │
│  • Test utilities independently                                              │
│                                                                              │
│  3. NAMING CONVENTIONS                                                       │
│  ─────────────────────                                                       │
│                                                                              │
│  • Utilities: *Utilities (e.g., FormatUtilities, GridUtilities)              │
│  • Extensions: *Extensions (e.g., UiLoggingExtensions)                       │
│  • Interfaces: I* (e.g., IThemeService)                                      │
│  • Enums: Descriptive name (e.g., ColorKey, not ColorKeyEnum)                │
│  • Value Objects: Descriptive name (e.g., ThemeColor)                        │
│                                                                              │
│  4. EXTRACTION CRITERIA                                                      │
│  ─────────────────────                                                       │
│                                                                              │
│  Extract to Presentation.Shared when:                                        │
│  ✓ Same logic exists in both TUI and GUI                                     │
│  ✓ Logic is platform-agnostic                                                │
│  ✓ Logic is general-purpose (not component-specific)                         │
│  ✓ Multiple components benefit from sharing                                  │
│                                                                              │
│  Keep in TUI/GUI layer when:                                                 │
│  ✓ Logic is platform-specific                                                │
│  ✓ Logic is component-specific                                               │
│  ✓ Only one layer uses the logic                                             │
│  ✓ Logic requires platform-specific dependencies                             │
│                                                                              │
│  5. DEPENDENCY RULES                                                         │
│  ──────────────────                                                          │
│                                                                              │
│  Presentation.Shared MAY depend on:                                          │
│  ✓ .NET Standard / .NET libraries                                            │
│  ✓ Microsoft.Extensions.Logging.Abstractions                                 │
│  ✓ Domain layer (for shared domain types)                                    │
│                                                                              │
│  Presentation.Shared MUST NOT depend on:                                     │
│  ✗ Spectre.Console                                                           │
│  ✗ Avalonia                                                                  │
│  ✗ Any TUI-specific library                                                  │
│  ✗ Any GUI-specific library                                                  │
│  ✗ Presentation.Tui                                                          │
│  ✗ Presentation.Gui                                                          │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 8. Data Model Changes

### 8.1 New Types Summary

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                         DATA MODEL CHANGES                                   │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  NEW: FormatUtilities (Static Class - Presentation.Shared)                   │
│  ├── FormatPercentage(int, int, string?) : string                            │
│  ├── FormatPercentage(double, string?) : string                              │
│  ├── FormatDuration(TimeSpan, bool) : string                                 │
│  ├── FormatNumber(int) : string                                              │
│  ├── FormatCompactNumber(long) : string                                      │
│  ├── FormatDelta(int, int) : string                                          │
│  ├── FormatDelta(int) : string                                               │
│  ├── TruncateText(string, int, string?) : string                             │
│  └── CenterText(string, int) : string                                        │
│                                                                              │
│  NEW: GridUtilities (Static Class - Presentation.Shared)                     │
│  ├── CalculateGridPosition(int, int) : (int, int)                            │
│  ├── CalculateLinearIndex(int, int, int) : int                               │
│  ├── IsValidPosition(int, int, int, int) : bool                              │
│  ├── IsValidPosition((int, int), int, int) : bool                            │
│  ├── GetAdjacentPositions(int, int) : IEnumerable<(int, int)>                │
│  ├── GetAllAdjacentPositions(int, int) : IEnumerable<(int, int)>             │
│  ├── GetValidAdjacentPositions(int, int, int, int, bool) : IEnum<(int, int)> │
│  ├── CalculateManhattanDistance(int, int, int, int) : int                    │
│  ├── CalculateChebyshevDistance(int, int, int, int) : int                    │
│  └── GetDirection(int, int, int, int) : Direction                            │
│                                                                              │
│  NEW: IconUtilities (Static Class - Presentation.Shared)                     │
│  ├── GetDirectionIcon(Direction, bool) : string                              │
│  ├── GetDamageTypeIcon(DamageType, bool) : string                            │
│  ├── GetDieFaceIcon(int, bool) : string                                      │
│  ├── GetDiceIcon(DiceType, bool) : string                                    │
│  └── GetStatusIcon(StatusType, bool) : string                                │
│                                                                              │
│  NEW: ValidationUtilities (Static Class - Presentation.Shared)               │
│  ├── ValidatePercentage(double) : bool                                       │
│  ├── ValidateCurrentMax(int, int) : bool                                     │
│  ├── IsInRange(int, int, int) : bool                                         │
│  ├── IsInRange(double, double, double) : bool                                │
│  ├── ClampValue(int, int, int) : int                                         │
│  ├── ClampValue(double, double, double) : double                             │
│  ├── ClampPercentage(double) : double                                        │
│  ├── NormalizeValue(int, int, int) : double                                  │
│  ├── NormalizeValue(double, double, double) : double                         │
│  ├── DenormalizeValue(double, int, int) : int                                │
│  ├── ValidateGridDimensions(int, int) : bool                                 │
│  └── ValidateGridPosition(int, int, int, int) : bool                         │
│                                                                              │
│  NEW: Direction (Enum - Presentation.Shared)                                 │
│  └── None, North, NorthEast, East, SouthEast, South, SouthWest, West, NW     │
│                                                                              │
│  NEW: StatusType (Enum - Presentation.Shared)                                │
│  └── Success, Failure, Warning, Info, Pending, InProgress                    │
│                                                                              │
│  NEW: DiceType (Enum - Presentation.Shared)                                  │
│  └── D4=4, D6=6, D8=8, D10=10, D12=12, D20=20, D100=100                      │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 9. Configuration

This part does not introduce new configuration files.

---

## 10. Commands

This part does not introduce new user-facing commands.

---

## 11. User-Facing Changes

This part focuses on internal refactoring. Users will not notice any changes to the application's behavior or appearance. The benefits are entirely in code maintainability and consistency.

---

## 12. Logging Specifications

No new logging is introduced. Existing logging in refactored components remains unchanged.

---

## 13. Unit Testing Requirements

### 13.1 Test Categories

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                    UNIT TESTING REQUIREMENTS (~4 tests)                      │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  Category 1: FormatUtilities Tests (1 test)                                  │
│  ──────────────────────────────────────────                                  │
│                                                                              │
│  Test: FormatUtilities_FormatPercentage_HandlesEdgeCases                     │
│  ├── Given: Various current/max combinations                                 │
│  ├── When: FormatPercentage called                                           │
│  └── Then: Correct percentages returned:                                     │
│      ├── (50, 100) → "50%"                                                   │
│      ├── (0, 100) → "0%"                                                     │
│      ├── (100, 100) → "100%"                                                 │
│      ├── (0, 0) → "0%" (edge case: max=0)                                    │
│      └── (150, 100) → "100%" (clamped)                                       │
│                                                                              │
│  Category 2: GridUtilities Tests (1 test)                                    │
│  ─────────────────────────────────────────                                   │
│                                                                              │
│  Test: GridUtilities_CalculateGridPosition_ConvertsCorrectly                 │
│  ├── Given: Various linear indices and grid widths                           │
│  ├── When: CalculateGridPosition called                                      │
│  └── Then: Correct (x, y) returned:                                          │
│      ├── (0, 5) → (0, 0)                                                     │
│      ├── (4, 5) → (4, 0)                                                     │
│      ├── (5, 5) → (0, 1)                                                     │
│      └── (12, 5) → (2, 2)                                                    │
│                                                                              │
│  Category 3: IconUtilities Tests (1 test)                                    │
│  ─────────────────────────────────────────                                   │
│                                                                              │
│  Test: IconUtilities_GetDirectionIcon_ReturnsCorrectIcons                    │
│  ├── Given: Various directions                                               │
│  ├── When: GetDirectionIcon called with useUnicode=true                      │
│  └── Then: Correct Unicode arrows returned:                                  │
│      ├── Direction.North → "↑"                                               │
│      ├── Direction.East → "→"                                                │
│      └── Direction.None → "·"                                                │
│                                                                              │
│  Category 4: ValidationUtilities Tests (1 test)                              │
│  ──────────────────────────────────────────────                              │
│                                                                              │
│  Test: ValidationUtilities_NormalizeValue_NormalizesCorrectly                │
│  ├── Given: Various value ranges                                             │
│  ├── When: NormalizeValue called                                             │
│  └── Then: Correct 0-1 values returned:                                      │
│      ├── (50, 0, 100) → 0.5                                                  │
│      ├── (0, 0, 100) → 0.0                                                   │
│      ├── (100, 0, 100) → 1.0                                                 │
│      └── (150, 0, 100) → 1.0 (clamped)                                       │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 13.2 Test File Locations

```
Tests/
└── Presentation.Shared.Tests/
    └── Utilities/
        ├── FormatUtilitiesTests.cs
        ├── GridUtilitiesTests.cs
        ├── IconUtilitiesTests.cs
        └── ValidationUtilitiesTests.cs
```

---

## 14. Use Cases

### 14.1 UC-5e-01: Use Shared Formatting

```
┌─────────────────────────────────────────────────────────────────────────────┐
│  USE CASE: UC-5e-01 - Use Shared Formatting                                  │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  Actor: UI Component Developer                                               │
│  Goal: Format values consistently across TUI and GUI                         │
│                                                                              │
│  Steps:                                                                      │
│  1. Developer identifies need for percentage display                         │
│  2. Developer adds using statement for Presentation.Shared.Utilities         │
│  3. Developer calls FormatUtilities.FormatPercentage(current, max)           │
│  4. Formatted string returned consistently with other components             │
│                                                                              │
│  Example:                                                                    │
│  ┌────────────────────────────────────────────────────────────────────────┐ │
│  │ using RuneRust.Presentation.Shared.Utilities;                           │ │
│  │                                                                          │ │
│  │ public class NewHealthDisplay : TuiComponentBase                         │ │
│  │ {                                                                        │ │
│  │     public void Render(int current, int max)                             │ │
│  │     {                                                                    │ │
│  │         // Use shared utility instead of local method                    │ │
│  │         var display = FormatUtilities.FormatPercentage(current, max);    │ │
│  │         Console.Write($"HP: {display}");                                 │ │
│  │     }                                                                    │ │
│  │ }                                                                        │ │
│  └────────────────────────────────────────────────────────────────────────┘ │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 15. Deliverable Checklist

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                         DELIVERABLE CHECKLIST                                │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  Utility Classes                                                             │
│  ───────────────                                                             │
│  [ ] FormatUtilities in Presentation.Shared/Utilities/                       │
│  [ ] GridUtilities in Presentation.Shared/Utilities/                         │
│  [ ] IconUtilities in Presentation.Shared/Utilities/                         │
│  [ ] ValidationUtilities in Presentation.Shared/Utilities/                   │
│                                                                              │
│  Enums                                                                       │
│  ─────                                                                       │
│  [ ] Direction in Presentation.Shared/Enums/                                 │
│  [ ] StatusType in Presentation.Shared/Enums/                                │
│  [ ] DiceType in Presentation.Shared/Enums/                                  │
│                                                                              │
│  Refactored TUI Components                                                   │
│  ─────────────────────────                                                   │
│  [ ] HealthBarDisplay uses FormatUtilities                                   │
│  [ ] ResourceBarDisplay uses FormatUtilities                                 │
│  [ ] StatusEffectPanel uses FormatUtilities                                  │
│  [ ] CombatGridPanel uses GridUtilities                                      │
│                                                                              │
│  Refactored GUI Components                                                   │
│  ─────────────────────────                                                   │
│  [ ] HealthBarControl uses FormatUtilities                                   │
│  [ ] GridCellControl uses GridUtilities                                      │
│  [ ] StatusEffectControl uses FormatUtilities                                │
│  [ ] DamagePopupControl uses FormatUtilities                                 │
│                                                                              │
│  Documentation                                                               │
│  ─────────────                                                               │
│  [ ] SharedLayerGuidelines.md in /docs/guidelines/                           │
│                                                                              │
│  Unit Tests                                                                  │
│  ──────────                                                                  │
│  [ ] FormatUtilitiesTests.cs (~1 test)                                       │
│  [ ] GridUtilitiesTests.cs (~1 test)                                         │
│  [ ] IconUtilitiesTests.cs (~1 test)                                         │
│  [ ] ValidationUtilitiesTests.cs (~1 test)                                   │
│                                                                              │
│  Total: ~4 unit tests                                                        │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 16. Acceptance Criteria

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                         ACCEPTANCE CRITERIA                                  │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  Shared Utilities                                                            │
│  ────────────────                                                            │
│  [ ] FormatUtilities created with all formatting methods                     │
│  [ ] GridUtilities created with grid math methods                            │
│  [ ] IconUtilities created with icon lookup methods                          │
│  [ ] ValidationUtilities created with validation methods                     │
│                                                                              │
│  Code Deduplication                                                          │
│  ──────────────────                                                          │
│  [ ] At least 3 TUI components refactored to use shared utilities            │
│  [ ] At least 3 GUI components refactored to use shared utilities            │
│  [ ] No duplicate formatting methods in TUI/GUI layers                       │
│  [ ] No duplicate grid calculation methods in TUI/GUI layers                 │
│                                                                              │
│  Behavior Preservation                                                       │
│  ─────────────────────                                                       │
│  [ ] Refactored components produce identical output                          │
│  [ ] All existing tests continue to pass                                     │
│  [ ] No functional changes to UI behavior                                    │
│                                                                              │
│  Guidelines                                                                  │
│  ──────────                                                                  │
│  [ ] Shared layer guidelines documented                                      │
│  [ ] Extraction criteria defined                                             │
│  [ ] Dependency rules specified                                              │
│                                                                              │
│  Testing                                                                     │
│  ───────                                                                     │
│  [ ] ~4 unit tests pass                                                      │
│  [ ] Edge cases handled (division by zero, empty strings, etc.)              │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 17. Future Considerations

### 17.1 v0.13.5f Integration

The shared utilities support accessibility features:
- `FormatUtilities.FormatDuration(compact: false)` for screen readers
- `IconUtilities.Get*Icon(useUnicode: false)` for ASCII fallbacks
- `ValidationUtilities` for input validation

### 17.2 Potential Additional Utilities

- `AnimationUtilities` for timing calculations
- `ColorUtilities` for color manipulation
- `AudioUtilities` for sound volume/pan calculations

---

## 18. Implementation Notes

### 18.1 Implementation Order

1. Create FormatUtilities with tests
2. Create GridUtilities with tests
3. Create IconUtilities with tests
4. Create ValidationUtilities with tests
5. Refactor TUI components
6. Refactor GUI components
7. Create documentation
8. Verify all tests pass

### 18.2 Backward Compatibility

Existing public APIs remain unchanged. Only internal implementation is refactored to use shared utilities.

---

## 19. Document Metadata

| Field | Value |
|-------|-------|
| **Document Version** | 1.0 |
| **Created** | 2026-01-16 |
| **Last Updated** | 2026-01-16 |
| **Author** | Claude |
| **Status** | Draft |
| **Related Documents** | v0.13.5-scope-breakdown.md, v0.13.5d-design-specification.md |

### Change History

| Version | Date | Author | Changes |
|---------|------|--------|---------|
| 1.0 | 2026-01-16 | Claude | Initial draft |

---

*This design specification provides a comprehensive blueprint for implementing v0.13.5e Shared Layer Utilization. The extracted utilities eliminate code duplication and establish consistent patterns for both TUI and GUI presentation layers.*
