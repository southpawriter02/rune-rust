# v0.13.0b Design Specification: AoE Zone Overlay

**Version:** 0.13.0b
**Parent:** v0.13.0 (Combat UI)
**Prerequisites:** v0.12.1c Complete (Achievements & Leaderboards), v0.10.1x Complete (AoE System)
**Status:** Design Complete
**Estimated Unit Tests:** ~6

---

## Table of Contents

1. [Executive Summary](#1-executive-summary)
2. [Feature Overview](#2-feature-overview)
3. [Architecture Diagrams](#3-architecture-diagrams)
4. [AoE Zone Overlay Component](#4-aoe-zone-overlay-component)
   - 4.1 [AoEZoneOverlay Class](#41-aoezoneoverlay-class)
   - 4.2 [Zone Cell Rendering](#42-zone-cell-rendering)
   - 4.3 [Duration Display](#43-duration-display)
5. [Zone Renderer](#5-zone-renderer)
   - 5.1 [ZoneRenderer Class](#51-zonerenderer-class)
   - 5.2 [Zone Symbol Mapping](#52-zone-symbol-mapping)
   - 5.3 [Zone Color Mapping](#53-zone-color-mapping)
6. [Hazard Indicator System](#6-hazard-indicator-system)
   - 6.1 [Hazard Icon Display](#61-hazard-icon-display)
   - 6.2 [Hazard Type Mapping](#62-hazard-type-mapping)
7. [Zone Legend Display](#7-zone-legend-display)
8. [Data Model Changes](#8-data-model-changes)
9. [Configuration File Schemas](#9-configuration-file-schemas)
10. [CombatGridView Integration](#10-combatgridview-integration)
11. [Logging Specifications](#11-logging-specifications)
12. [Unit Testing Requirements](#12-unit-testing-requirements)
13. [Use Cases](#13-use-cases)
14. [Deliverable Checklist](#14-deliverable-checklist)
15. [Acceptance Criteria](#15-acceptance-criteria)
16. [Dependencies](#16-dependencies)
17. [Future Considerations](#17-future-considerations)

---

## 1. Executive Summary

This version implements the visual presentation layer for area-of-effect (AoE) zones on the combat grid. The AoE system logic was fully implemented in v0.10.1x; this version adds the UI components to display active zones as grid overlays. Players will see highlighted tiles for zone effects, hazard indicators for persistent zones, and duration displays for temporary zones.

### Key Deliverables

| Category | Items |
|----------|-------|
| **UI Components** | `AoEZoneOverlay` |
| **Renderers** | `ZoneRenderer` |
| **DTOs** | `ZoneDisplayDto`, `ZoneLegendEntryDto` |
| **View Updates** | `CombatGridView` integration |
| **Configuration** | `zone-display.json` |
| **Tests** | ~6 unit tests |

### Architectural Significance

This version extends the **Combat UI Component Pattern** established in v0.13.0a to grid-based overlays:
- Zone overlays integrate with existing `CombatGridView` cell rendering
- Overlay layer sits between terrain and entity rendering
- Zone symbols and colors are configuration-driven
- Consistent with existing highlight mechanism for movement/attack ranges

---

## 2. Feature Overview

```
v0.13.0b Features
â”œâ”€â”€ AoEZoneOverlay (UI Component)
â”‚   â”œâ”€â”€ RenderZones(zones)
â”‚   â”œâ”€â”€ HighlightTiles(positions)
â”‚   â”œâ”€â”€ ShowHazardIcons(zone)
â”‚   â””â”€â”€ UpdateDurations()
â”‚
â”œâ”€â”€ ZoneRenderer (Renderer)
â”‚   â”œâ”€â”€ GetZoneSymbol(zoneType)
â”‚   â”œâ”€â”€ GetZoneColor(zoneType)
â”‚   â”œâ”€â”€ FormatZoneDuration(turns)
â”‚   â””â”€â”€ GetHazardIcon(damageType)
â”‚
â”œâ”€â”€ Hazard Indicator System
â”‚   â”œâ”€â”€ Damage Type Icons
â”‚   â”œâ”€â”€ Persistent Zone Markers
â”‚   â””â”€â”€ Effect Type Indicators
â”‚
â”œâ”€â”€ Zone Legend Display
â”‚   â”œâ”€â”€ Active Zone List
â”‚   â”œâ”€â”€ Zone Information Summary
â”‚   â””â”€â”€ Duration Countdown
â”‚
â””â”€â”€ CombatGridView Integration
    â”œâ”€â”€ Cell Overlay Layer
    â”œâ”€â”€ Priority Ordering
    â””â”€â”€ Turn-Based Refresh
```

### Scope Verification

| Feature | Source | Included |
|---------|--------|----------|
| AoE Zone Highlighting | v0.13.0-scope-breakdown.md | Yes |
| Hazard Indicators | v0.13.0-scope-breakdown.md | Yes |
| Zone Duration Display | v0.13.0-scope-breakdown.md | Yes |
| Zone Type Differentiation | v0.13.0-scope-breakdown.md | Yes |
| Status Effect Display | v0.13.0-scope-breakdown.md | No (v0.13.0a) |
| Combo Chain Indicator | v0.13.0-scope-breakdown.md | No (v0.13.0c) |

---

## 3. Architecture Diagrams

### 3.1 Layer Diagram

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          PRESENTATION LAYER                                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”‚
â”‚  â”‚    CombatGridView       â”‚      â”‚    AoEZoneOverlay       â”‚               â”‚
â”‚  â”‚    (existing)           â”‚â—„â”€â”€â”€â”€â–¶â”‚    (NEW)                â”‚               â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤      â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤               â”‚
â”‚  â”‚ - RenderGrid()          â”‚      â”‚ - RenderZones()         â”‚               â”‚
â”‚  â”‚ - HighlightCells()      â”‚      â”‚ - HighlightTiles()      â”‚               â”‚
â”‚  â”‚ - RenderToPanel()       â”‚      â”‚ - ShowHazardIcons()     â”‚               â”‚
â”‚  â”‚ - SetAoEZone() (NEW)    â”‚      â”‚ - UpdateDurations()     â”‚               â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚ - RenderLegend()        â”‚               â”‚
â”‚             â”‚                      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â”‚
â”‚             â”‚                                  â”‚                             â”‚
â”‚             â–¼                                  â”‚                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                   â”‚                             â”‚
â”‚  â”‚     ZoneRenderer        â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                             â”‚
â”‚  â”‚     (NEW)               â”‚                                                 â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                                                 â”‚
â”‚  â”‚ - GetZoneSymbol()       â”‚                                                 â”‚
â”‚  â”‚ - GetZoneColor()        â”‚                                                 â”‚
â”‚  â”‚ - FormatZoneDuration()  â”‚                                                 â”‚
â”‚  â”‚ - GetHazardIcon()       â”‚                                                 â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                                 â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                        â”‚
                                        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          APPLICATION LAYER                                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚                  IAreaEffectService (existing v0.10.1)              â”‚    â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤    â”‚
â”‚  â”‚ + GetAffectedCells(areaEffect, origin, target) : IEnumerable<Pos>  â”‚    â”‚
â”‚  â”‚ + GetPreview(areaEffect, origin, target) : AreaEffectPreview       â”‚    â”‚
â”‚  â”‚ + GetCircleCells(center, radius) : IEnumerable<GridPosition>       â”‚    â”‚
â”‚  â”‚ + GetConeCells(origin, direction, length, angle) : IEnumerable<...>â”‚    â”‚
â”‚  â”‚ + GetLineCells(origin, target, width) : IEnumerable<GridPosition>  â”‚    â”‚
â”‚  â”‚ + GetSquareCells(center, size) : IEnumerable<GridPosition>         â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚                  ICombatGridService (existing v0.7.x)               â”‚    â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤    â”‚
â”‚  â”‚ + GetActiveGrid() : CombatGrid                                     â”‚    â”‚
â”‚  â”‚ + GetCell(position) : GridCell?                                    â”‚    â”‚
â”‚  â”‚ + GetEntityPosition(entityId) : GridPosition?                      â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                        â”‚
                                        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                            DOMAIN LAYER                                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”‚
â”‚  â”‚     AreaEffect          â”‚      â”‚     GridPosition        â”‚               â”‚
â”‚  â”‚   (existing v0.10.1)    â”‚      â”‚   (existing v0.7.x)     â”‚               â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤      â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤               â”‚
â”‚  â”‚ + Shape: AreaEffectShapeâ”‚      â”‚ + X: int                â”‚               â”‚
â”‚  â”‚ + Radius: int           â”‚      â”‚ + Y: int                â”‚               â”‚
â”‚  â”‚ + Length: int           â”‚      â”‚ + DistanceTo(other): intâ”‚               â”‚
â”‚  â”‚ + Width: int            â”‚      â”‚ + ToString(): string    â”‚               â”‚
â”‚  â”‚ + IncludesCaster: bool  â”‚      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â”‚
â”‚  â”‚ + AffectsAllies: bool   â”‚                                                 â”‚
â”‚  â”‚ + AffectsEnemies: bool  â”‚      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚   AreaEffectShape       â”‚               â”‚
â”‚                                    â”‚   (existing v0.10.1)    â”‚               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤               â”‚
â”‚  â”‚     HazardZone          â”‚      â”‚ - None                  â”‚               â”‚
â”‚  â”‚   (existing v0.10.1)    â”‚      â”‚ - Circle                â”‚               â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤      â”‚ - Cone                  â”‚               â”‚
â”‚  â”‚ + Id: Guid              â”‚      â”‚ - Line                  â”‚               â”‚
â”‚  â”‚ + Name: string          â”‚      â”‚ - Square                â”‚               â”‚
â”‚  â”‚ + HazardType: HazardTypeâ”‚      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â”‚
â”‚  â”‚ + DamageType: string?   â”‚                                                 â”‚
â”‚  â”‚ + Duration: int         â”‚      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”‚
â”‚  â”‚ + IsActive: bool        â”‚      â”‚     HazardType          â”‚               â”‚
â”‚  â”‚ + IsPermanent: bool     â”‚      â”‚   (existing v0.10.1)    â”‚               â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤               â”‚
â”‚                                    â”‚ - Fire                  â”‚               â”‚
â”‚                                    â”‚ - Ice                   â”‚               â”‚
â”‚                                    â”‚ - Poison                â”‚               â”‚
â”‚                                    â”‚ - Lightning             â”‚               â”‚
â”‚                                    â”‚ - Acid                  â”‚               â”‚
â”‚                                    â”‚ - Necrotic              â”‚               â”‚
â”‚                                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3.2 Data Flow Diagram

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    AoE ZONE OVERLAY DATA FLOW                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

    Combat State Update / Ability Targeting
                      â”‚
                      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           ZONE DATA SOURCES                                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”‚
â”‚  â”‚  Active Hazard Zones    â”‚      â”‚  Ability Targeting      â”‚               â”‚
â”‚  â”‚  (persistent effects)   â”‚      â”‚  (preview mode)         â”‚               â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤      â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤               â”‚
â”‚  â”‚ - Fire zones            â”‚      â”‚ - Target selection      â”‚               â”‚
â”‚  â”‚ - Ice zones             â”‚      â”‚ - AoE preview           â”‚               â”‚
â”‚  â”‚ - Poison clouds         â”‚      â”‚ - Range highlighting    â”‚               â”‚
â”‚  â”‚ - Environmental hazards â”‚      â”‚ - Affected targets      â”‚               â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â”‚
â”‚              â”‚                                â”‚                              â”‚
â”‚              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                              â”‚
â”‚                           â”‚                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         AoEZoneOverlay                                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚  1. Collect zone data from sources                                          â”‚
â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚     â”‚ _activeZones = hazardService.GetActiveZones(gridId)             â”‚     â”‚
â”‚     â”‚ _previewZone = targetingService.GetCurrentPreview()             â”‚     â”‚
â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚                                                                              â”‚
â”‚  2. Map zones to display DTOs                                                â”‚
â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚     â”‚ var zoneDtos = _activeZones.Select(z => MapToZoneDisplayDto(z)) â”‚     â”‚
â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚                                                                              â”‚
â”‚  3. Build cell-to-zone mapping                                               â”‚
â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚     â”‚ foreach zone â†’ foreach cell in zone.AffectedCells               â”‚     â”‚
â”‚     â”‚   _zoneCells[cell] = zone                                       â”‚     â”‚
â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚                                                                              â”‚
â”‚  4. Send to CombatGridView for rendering                                     â”‚
â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚     â”‚ _gridView.SetAoEZones(_zoneCells)                               â”‚     â”‚
â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                       CombatGridView Cell Rendering                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚  Render Priority (highest to lowest):                                        â”‚
â”‚                                                                              â”‚
â”‚    1. Entity Layer (@ = Player, M = Monster, A = Ally)                       â”‚
â”‚       â””â”€â–¶ Always visible, entities on top of everything                      â”‚
â”‚                                                                              â”‚
â”‚    2. Selection/Highlight Layer ([X] = selected, *X* = highlighted)          â”‚
â”‚       â””â”€â–¶ Movement range, attack targets, ability targets                    â”‚
â”‚                                                                              â”‚
â”‚    3. AoE Zone Layer (F = Fire, I = Ice, P = Poison, etc.) â—„â”€â”€ NEW          â”‚
â”‚       â””â”€â–¶ Persistent hazards, ability effect areas                           â”‚
â”‚                                                                              â”‚
â”‚    4. Terrain Layer (. = open, # = wall, ~ = water, ^ = hazard)             â”‚
â”‚       â””â”€â–¶ Base terrain, only visible if no overlay                           â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         Zone Legend Display                                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚  Active Zones:                                                               â”‚
â”‚    [F] Fire Zone - 2 turns - 5 fire damage/turn                             â”‚
â”‚    [I] Ice Zone - 3 turns - Slowed movement                                 â”‚
â”‚    [P] Poison Cloud - 4 turns - 3 poison damage/turn                        â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3.3 Grid Overlay Integration Diagram

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Combat Grid With AoE Zone Overlay                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚      A   B   C   D   E   F   G   H                                          â”‚
â”‚    â”Œâ”€â”€â”€â”¬â”€â”€â”€â”¬â”€â”€â”€â”¬â”€â”€â”€â”¬â”€â”€â”€â”¬â”€â”€â”€â”¬â”€â”€â”€â”¬â”€â”€â”€â”                                        â”‚
â”‚  1 â”‚ F â”‚ F â”‚ . â”‚ . â”‚ . â”‚ . â”‚ . â”‚ . â”‚   F = Fire zone (affected cells)       â”‚
â”‚    â”œâ”€â”€â”€â”¼â”€â”€â”€â”¼â”€â”€â”€â”¼â”€â”€â”€â”¼â”€â”€â”€â”¼â”€â”€â”€â”¼â”€â”€â”€â”¼â”€â”€â”€â”¤                                        â”‚
â”‚  2 â”‚ F â”‚ @ â”‚ . â”‚ . â”‚ . â”‚ . â”‚ . â”‚ . â”‚   @ = Player (on fire zone!)           â”‚
â”‚    â”œâ”€â”€â”€â”¼â”€â”€â”€â”¼â”€â”€â”€â”¼â”€â”€â”€â”¼â”€â”€â”€â”¼â”€â”€â”€â”¼â”€â”€â”€â”¼â”€â”€â”€â”¤                                        â”‚
â”‚  3 â”‚ . â”‚ . â”‚ . â”‚ . â”‚ I â”‚ I â”‚ I â”‚ . â”‚   I = Ice zone (affected cells)        â”‚
â”‚    â”œâ”€â”€â”€â”¼â”€â”€â”€â”¼â”€â”€â”€â”¼â”€â”€â”€â”¼â”€â”€â”€â”¼â”€â”€â”€â”¼â”€â”€â”€â”¼â”€â”€â”€â”¤                                        â”‚
â”‚  4 â”‚ . â”‚ . â”‚ . â”‚ . â”‚ I â”‚ I â”‚ I â”‚ . â”‚   M = Monster (in ice zone)            â”‚
â”‚    â”œâ”€â”€â”€â”¼â”€â”€â”€â”¼â”€â”€â”€â”¼â”€â”€â”€â”¼â”€â”€â”€â”¼â”€â”€â”€â”¼â”€â”€â”€â”¼â”€â”€â”€â”¤                                        â”‚
â”‚  5 â”‚ . â”‚ . â”‚ P â”‚ P â”‚ I â”‚ I â”‚ M â”‚ . â”‚   P = Poison cloud                     â”‚
â”‚    â”œâ”€â”€â”€â”¼â”€â”€â”€â”¼â”€â”€â”€â”¼â”€â”€â”€â”¼â”€â”€â”€â”¼â”€â”€â”€â”¼â”€â”€â”€â”¼â”€â”€â”€â”¤                                        â”‚
â”‚  6 â”‚ . â”‚ . â”‚ P â”‚ P â”‚ . â”‚ . â”‚ . â”‚ . â”‚   . = Open terrain (no zone)           â”‚
â”‚    â”œâ”€â”€â”€â”¼â”€â”€â”€â”¼â”€â”€â”€â”¼â”€â”€â”€â”¼â”€â”€â”€â”¼â”€â”€â”€â”¼â”€â”€â”€â”¼â”€â”€â”€â”¤                                        â”‚
â”‚  7 â”‚ . â”‚ . â”‚ . â”‚ . â”‚ . â”‚ . â”‚ . â”‚ . â”‚                                        â”‚
â”‚    â”œâ”€â”€â”€â”¼â”€â”€â”€â”¼â”€â”€â”€â”¼â”€â”€â”€â”¼â”€â”€â”€â”¼â”€â”€â”€â”¼â”€â”€â”€â”¼â”€â”€â”€â”¤                                        â”‚
â”‚  8 â”‚ . â”‚ . â”‚ . â”‚ . â”‚ . â”‚ . â”‚ . â”‚ . â”‚                                        â”‚
â”‚    â””â”€â”€â”€â”´â”€â”€â”€â”´â”€â”€â”€â”´â”€â”€â”€â”´â”€â”€â”€â”´â”€â”€â”€â”´â”€â”€â”€â”´â”€â”€â”€â”˜                                        â”‚
â”‚                                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚ ACTIVE ZONES:                                                        â”‚    â”‚
â”‚  â”‚   [F] Fire Zone - 2 turns - 5 fire damage/turn                      â”‚    â”‚
â”‚  â”‚   [I] Ice Zone - 3 turns - Slowed movement                          â”‚    â”‚
â”‚  â”‚   [P] Poison Cloud - 4 turns - 3 poison damage/turn                 â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


                    Zone Overlap Priority Example
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                                              â”‚
â”‚  When multiple zones overlap on a cell:                                      â”‚
â”‚                                                                              â”‚
â”‚    Cell E5: Ice zone + Poison cloud overlap                                  â”‚
â”‚      Display: Most dangerous zone symbol (P for poison)                      â”‚
â”‚      Legend: Both zones listed with cell noted as overlap                    â”‚
â”‚                                                                              â”‚
â”‚    Cell B2: Fire zone + Player entity                                        â”‚
â”‚      Display: Player symbol (@) - entities always on top                     â”‚
â”‚      Color: Red background or hazard indicator                               â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 4. AoE Zone Overlay Component

### 4.1 AoEZoneOverlay Class

**File:** `src/Presentation/RuneAndRust.Presentation.Tui/UI/AoEZoneOverlay.cs`

```csharp
namespace RuneAndRust.Presentation.Tui.UI;

/// <summary>
/// UI component for displaying AoE zone overlays on the combat grid.
/// Shows zone highlighting, hazard indicators, and duration information.
/// </summary>
public class AoEZoneOverlay
{
    private readonly ZoneRenderer _renderer;
    private readonly ILogger<AoEZoneOverlay> _logger;

    private readonly Dictionary<GridPosition, ZoneDisplayDto> _zoneCells = new();
    private readonly List<ZoneDisplayDto> _activeZones = new();
    private ZoneDisplayDto? _previewZone;

    public AoEZoneOverlay(
        ZoneRenderer renderer,
        ILogger<AoEZoneOverlay> logger)
    {
        _renderer = renderer;
        _logger = logger;
    }

    /// <summary>
    /// Renders all active zones and builds the cell-to-zone mapping.
    /// </summary>
    /// <param name="zones">Active zone data from hazard/ability services.</param>
    public void RenderZones(IReadOnlyList<ZoneDisplayDto> zones)
    {
        _activeZones.Clear();
        _zoneCells.Clear();

        foreach (var zone in zones)
        {
            _activeZones.Add(zone);

            foreach (var cell in zone.AffectedCells)
            {
                // If cell already has a zone, use priority to determine which shows
                if (_zoneCells.TryGetValue(cell, out var existingZone))
                {
                    if (GetZonePriority(zone.ZoneType) > GetZonePriority(existingZone.ZoneType))
                    {
                        _zoneCells[cell] = zone;
                    }
                }
                else
                {
                    _zoneCells[cell] = zone;
                }
            }
        }

        _logger.LogDebug("Rendered {ZoneCount} zones affecting {CellCount} cells",
            _activeZones.Count, _zoneCells.Count);
    }

    /// <summary>
    /// Highlights specific tiles for ability targeting preview.
    /// </summary>
    /// <param name="positions">Grid positions to highlight.</param>
    /// <param name="zoneType">Type of zone for visual styling.</param>
    /// <param name="isPreview">Whether this is a targeting preview.</param>
    public void HighlightTiles(
        IReadOnlyList<GridPosition> positions,
        ZoneType zoneType,
        bool isPreview = false)
    {
        if (isPreview)
        {
            _previewZone = new ZoneDisplayDto
            {
                ZoneId = Guid.Empty,
                Name = "Target Area",
                ZoneType = zoneType,
                AffectedCells = positions,
                RemainingDuration = null,
                IsPermanent = false,
                IsPreview = true
            };

            // Add preview cells to mapping (lower priority than active zones)
            foreach (var cell in positions)
            {
                if (!_zoneCells.ContainsKey(cell))
                {
                    _zoneCells[cell] = _previewZone;
                }
            }
        }

        _logger.LogDebug("Highlighted {CellCount} tiles for {ZoneType} (preview={IsPreview})",
            positions.Count, zoneType, isPreview);
    }

    /// <summary>
    /// Clears the targeting preview zone.
    /// </summary>
    public void ClearPreview()
    {
        if (_previewZone == null) return;

        // Remove preview cells from mapping
        foreach (var cell in _previewZone.AffectedCells)
        {
            if (_zoneCells.TryGetValue(cell, out var zone) && zone.IsPreview)
            {
                _zoneCells.Remove(cell);
            }
        }

        _previewZone = null;
        _logger.LogDebug("Cleared targeting preview");
    }

    /// <summary>
    /// Gets the zone affecting a specific cell, if any.
    /// </summary>
    /// <param name="position">Grid position to check.</param>
    /// <returns>Zone display data or null.</returns>
    public ZoneDisplayDto? GetZoneAtCell(GridPosition position)
    {
        return _zoneCells.GetValueOrDefault(position);
    }

    /// <summary>
    /// Gets all cells affected by any zone.
    /// </summary>
    /// <returns>Dictionary mapping positions to zone data.</returns>
    public IReadOnlyDictionary<GridPosition, ZoneDisplayDto> GetAllZoneCells()
    {
        return _zoneCells;
    }

    /// <summary>
    /// Updates duration display for all tracked zones.
    /// Called at the start of each turn.
    /// </summary>
    public void UpdateDurations()
    {
        // Durations are read fresh from zone data each render
        // This method signals that a refresh is needed
        _logger.LogDebug("Duration update signaled for {ZoneCount} zones", _activeZones.Count);
    }

    /// <summary>
    /// Renders the zone legend showing active zone information.
    /// </summary>
    /// <returns>List of formatted lines for the legend.</returns>
    public IReadOnlyList<string> RenderLegend()
    {
        if (_activeZones.Count == 0)
        {
            return new List<string> { "No active zones" };
        }

        var lines = new List<string> { "ACTIVE ZONES:" };

        foreach (var zone in _activeZones.Where(z => !z.IsPreview))
        {
            var symbol = _renderer.GetZoneSymbol(zone.ZoneType);
            var duration = zone.IsPermanent
                ? "permanent"
                : _renderer.FormatZoneDuration(zone.RemainingDuration);
            var effect = GetZoneEffectSummary(zone);

            lines.Add($"  [{symbol}] {zone.Name} - {duration} - {effect}");
        }

        return lines;
    }

    /// <summary>
    /// Shows hazard icons for a specific zone.
    /// </summary>
    /// <param name="zone">Zone to show hazard icons for.</param>
    /// <returns>Hazard icon string.</returns>
    public string ShowHazardIcons(ZoneDisplayDto zone)
    {
        return _renderer.GetHazardIcon(zone.DamageType);
    }

    private static int GetZonePriority(ZoneType type)
    {
        // Higher priority zones show on top when overlapping
        return type switch
        {
            ZoneType.Damage => 4,      // Damage zones highest priority
            ZoneType.Control => 3,     // Control zones (stun, root)
            ZoneType.Debuff => 2,      // Debuff zones
            ZoneType.Buff => 1,        // Buff zones lowest priority
            ZoneType.Preview => 0,     // Preview always lowest
            _ => 0
        };
    }

    private static string GetZoneEffectSummary(ZoneDisplayDto zone)
    {
        if (zone.DamagePerTurn.HasValue && zone.DamagePerTurn > 0)
        {
            return $"{zone.DamagePerTurn} {zone.DamageType ?? "damage"}/turn";
        }

        if (!string.IsNullOrEmpty(zone.StatusEffect))
        {
            return zone.StatusEffect;
        }

        return zone.ZoneType switch
        {
            ZoneType.Damage => "Damage zone",
            ZoneType.Control => "Control effect",
            ZoneType.Debuff => "Debuff zone",
            ZoneType.Buff => "Buff zone",
            _ => "Zone effect"
        };
    }
}
```

### 4.2 Zone Cell Rendering

Zone cells are rendered by modifying the base terrain symbol when a zone is present:

**Render Priority:**
1. **Entity** (always on top): `@`, `M`, `A`
2. **Selection/Highlight** (combat UI): `[X]`, `*X*`
3. **Zone Overlay** (this feature): `F`, `I`, `P`, `L`, etc.
4. **Terrain** (base layer): `.`, `#`, `~`, `^`

**Cell Format Examples:**

| Condition | Display | Notes |
|-----------|---------|-------|
| Fire zone, no entity | ` F ` | Zone symbol with spaces |
| Fire zone, player present | ` @ ` | Entity takes priority |
| Fire zone, selected | `[F]` | Selection brackets |
| Ice zone, highlighted | `*I*` | Highlight asterisks |
| Overlap (fire + poison) | ` P ` | Higher priority zone |

### 4.3 Duration Display

Duration formats for zones:

| Duration Type | Format | Example |
|---------------|--------|---------|
| Turn-based | `N turns` | `3 turns` |
| Permanent | `permanent` | `permanent` |
| Triggered | `until triggered` | `until triggered` |
| Preview | (none) | No duration shown |

---

## 5. Zone Renderer

### 5.1 ZoneRenderer Class

**File:** `src/Presentation/RuneAndRust.Presentation.Tui/Renderers/ZoneRenderer.cs`

```csharp
namespace RuneAndRust.Presentation.Tui.Renderers;

/// <summary>
/// Renders zone symbols, colors, and formatted text for AoE zone overlays.
/// </summary>
public class ZoneRenderer
{
    private readonly ITerminalService _terminal;
    private readonly ZoneDisplayConfig _config;

    public ZoneRenderer(
        ITerminalService terminal,
        IOptions<ZoneDisplayConfig> config)
    {
        _terminal = terminal;
        _config = config.Value;
    }

    /// <summary>
    /// Gets the display symbol for a zone type.
    /// </summary>
    /// <param name="zoneType">Type of zone.</param>
    /// <returns>Single character symbol.</returns>
    public char GetZoneSymbol(ZoneType zoneType)
    {
        return zoneType switch
        {
            ZoneType.Damage => _config.Symbols.Damage,
            ZoneType.Control => _config.Symbols.Control,
            ZoneType.Debuff => _config.Symbols.Debuff,
            ZoneType.Buff => _config.Symbols.Buff,
            ZoneType.Preview => _config.Symbols.Preview,
            _ => '?'
        };
    }

    /// <summary>
    /// Gets the symbol for a specific damage type.
    /// </summary>
    /// <param name="damageType">Damage type string.</param>
    /// <returns>Single character symbol.</returns>
    public char GetDamageTypeSymbol(string? damageType)
    {
        if (string.IsNullOrEmpty(damageType)) return 'D';

        return damageType.ToLowerInvariant() switch
        {
            "fire" => 'F',
            "ice" or "cold" or "frost" => 'I',
            "poison" => 'P',
            "lightning" or "electric" => 'L',
            "acid" => 'A',
            "necrotic" or "shadow" => 'N',
            "holy" or "radiant" => 'H',
            _ => 'D'
        };
    }

    /// <summary>
    /// Gets the console color for a zone type.
    /// </summary>
    /// <param name="zoneType">Type of zone.</param>
    /// <returns>Console color for rendering.</returns>
    public ConsoleColor GetZoneColor(ZoneType zoneType)
    {
        return zoneType switch
        {
            ZoneType.Damage => _config.Colors.Damage,
            ZoneType.Control => _config.Colors.Control,
            ZoneType.Debuff => _config.Colors.Debuff,
            ZoneType.Buff => _config.Colors.Buff,
            ZoneType.Preview => _config.Colors.Preview,
            _ => ConsoleColor.Gray
        };
    }

    /// <summary>
    /// Gets the console color for a specific damage type.
    /// </summary>
    /// <param name="damageType">Damage type string.</param>
    /// <returns>Console color for rendering.</returns>
    public ConsoleColor GetDamageTypeColor(string? damageType)
    {
        if (string.IsNullOrEmpty(damageType)) return ConsoleColor.Gray;

        return damageType.ToLowerInvariant() switch
        {
            "fire" => ConsoleColor.Red,
            "ice" or "cold" or "frost" => ConsoleColor.Cyan,
            "poison" => ConsoleColor.DarkGreen,
            "lightning" or "electric" => ConsoleColor.Yellow,
            "acid" => ConsoleColor.DarkYellow,
            "necrotic" or "shadow" => ConsoleColor.DarkMagenta,
            "holy" or "radiant" => ConsoleColor.White,
            _ => ConsoleColor.Gray
        };
    }

    /// <summary>
    /// Formats zone duration for display.
    /// </summary>
    /// <param name="remainingTurns">Remaining turns or null if permanent.</param>
    /// <returns>Formatted duration string.</returns>
    public string FormatZoneDuration(int? remainingTurns)
    {
        if (!remainingTurns.HasValue) return "permanent";
        if (remainingTurns.Value <= 0) return "expiring";
        return remainingTurns.Value == 1 ? "1 turn" : $"{remainingTurns.Value} turns";
    }

    /// <summary>
    /// Gets the hazard icon for a damage type.
    /// </summary>
    /// <param name="damageType">Damage type string.</param>
    /// <returns>Hazard icon string.</returns>
    public string GetHazardIcon(string? damageType)
    {
        if (!_terminal.SupportsUnicode)
        {
            return GetDamageTypeSymbol(damageType).ToString();
        }

        return damageType?.ToLowerInvariant() switch
        {
            "fire" => "ğŸ”¥",
            "ice" or "cold" or "frost" => "â„",
            "poison" => "â˜ ",
            "lightning" or "electric" => "âš¡",
            "acid" => "ğŸ’§",
            "necrotic" or "shadow" => "ğŸ’€",
            "holy" or "radiant" => "âœ¨",
            _ => "âš "
        };
    }

    /// <summary>
    /// Formats a complete zone cell display.
    /// </summary>
    /// <param name="zone">Zone display data.</param>
    /// <returns>Formatted cell content (3 characters).</returns>
    public string FormatZoneCell(ZoneDisplayDto zone)
    {
        var symbol = !string.IsNullOrEmpty(zone.DamageType)
            ? GetDamageTypeSymbol(zone.DamageType)
            : GetZoneSymbol(zone.ZoneType);

        return $" {symbol} ";
    }

    /// <summary>
    /// Gets the ASCII fallback symbol for a zone type.
    /// </summary>
    /// <param name="zoneType">Type of zone.</param>
    /// <returns>ASCII character.</returns>
    public char GetAsciiFallbackSymbol(ZoneType zoneType)
    {
        return zoneType switch
        {
            ZoneType.Damage => 'X',
            ZoneType.Control => '!',
            ZoneType.Debuff => '-',
            ZoneType.Buff => '+',
            ZoneType.Preview => '.',
            _ => '?'
        };
    }
}
```

### 5.2 Zone Symbol Mapping

| Zone Type | Symbol | Description |
|-----------|--------|-------------|
| Damage | Damage type letter | `F`, `I`, `P`, `L`, `A`, `N`, `H` |
| Control | `!` | Stun, root, freeze zones |
| Debuff | `-` | Slow, weaken zones |
| Buff | `+` | Healing, buff zones |
| Preview | `.` | Targeting preview |

**Damage Type Symbols:**

| Damage Type | Symbol | Color |
|-------------|--------|-------|
| Fire | `F` | Red |
| Ice/Cold/Frost | `I` | Cyan |
| Poison | `P` | DarkGreen |
| Lightning | `L` | Yellow |
| Acid | `A` | DarkYellow |
| Necrotic/Shadow | `N` | DarkMagenta |
| Holy/Radiant | `H` | White |

### 5.3 Zone Color Mapping

| Zone Type | Color | Usage |
|-----------|-------|-------|
| Damage | Red | Damaging hazard zones |
| Control | Magenta | CC effect zones |
| Debuff | DarkYellow | Debuff zones |
| Buff | Green | Beneficial zones |
| Preview | DarkGray | Targeting preview |

---

## 6. Hazard Indicator System

### 6.1 Hazard Icon Display

Hazard icons provide visual indicators for the type of danger a zone presents:

**Unicode Icons:**

| Damage Type | Icon | Description |
|-------------|------|-------------|
| Fire | ğŸ”¥ | Burning hazard |
| Ice | â„ | Freezing hazard |
| Poison | â˜  | Poison cloud |
| Lightning | âš¡ | Electric hazard |
| Acid | ğŸ’§ | Corrosive hazard |
| Necrotic | ğŸ’€ | Death/decay hazard |
| Holy | âœ¨ | Radiant zone |
| Generic | âš  | Unknown hazard |

**ASCII Fallbacks:**

| Damage Type | ASCII | Description |
|-------------|-------|-------------|
| Fire | `F` | Fire letter |
| Ice | `I` | Ice letter |
| Poison | `P` | Poison letter |
| All others | First letter | First letter of type |

### 6.2 Hazard Type Mapping

```csharp
/// <summary>
/// Zone effect types for categorization and rendering.
/// </summary>
public enum ZoneType
{
    /// <summary>Zones that deal damage per turn.</summary>
    Damage,

    /// <summary>Zones that apply control effects (stun, root).</summary>
    Control,

    /// <summary>Zones that apply debuffs.</summary>
    Debuff,

    /// <summary>Zones that apply buffs or healing.</summary>
    Buff,

    /// <summary>Targeting preview (not a real zone).</summary>
    Preview
}
```

---

## 7. Zone Legend Display

### 7.1 Legend Format

The zone legend displays below the combat grid, summarizing all active zones:

```
ACTIVE ZONES:
  [F] Fire Zone - 2 turns - 5 fire damage/turn
  [I] Ice Zone - 3 turns - Slowed movement
  [P] Poison Cloud - 4 turns - 3 poison damage/turn
```

### 7.2 Legend Entry Structure

**File:** `src/Presentation/RuneAndRust.Presentation.Tui/DTOs/ZoneLegendEntryDto.cs`

```csharp
namespace RuneAndRust.Presentation.Tui.DTOs;

/// <summary>
/// Data transfer object for zone legend entries.
/// </summary>
public record ZoneLegendEntryDto
{
    /// <summary>Zone display symbol.</summary>
    public required char Symbol { get; init; }

    /// <summary>Zone display name.</summary>
    public required string Name { get; init; }

    /// <summary>Formatted duration string.</summary>
    public required string Duration { get; init; }

    /// <summary>Effect summary string.</summary>
    public required string Effect { get; init; }

    /// <summary>Zone color for rendering.</summary>
    public ConsoleColor Color { get; init; }
}
```

---

## 8. Data Model Changes

### 8.1 New DTOs

**File:** `src/Presentation/RuneAndRust.Presentation.Tui/DTOs/ZoneDisplayDto.cs`

```csharp
namespace RuneAndRust.Presentation.Tui.DTOs;

/// <summary>
/// Data transfer object for zone display rendering.
/// </summary>
public record ZoneDisplayDto
{
    /// <summary>Unique zone identifier.</summary>
    public required Guid ZoneId { get; init; }

    /// <summary>Zone display name.</summary>
    public required string Name { get; init; }

    /// <summary>Zone effect type for styling.</summary>
    public required ZoneType ZoneType { get; init; }

    /// <summary>Cells affected by this zone.</summary>
    public required IReadOnlyList<GridPosition> AffectedCells { get; init; }

    /// <summary>Remaining duration in turns (null if permanent).</summary>
    public int? RemainingDuration { get; init; }

    /// <summary>Whether this zone is permanent.</summary>
    public bool IsPermanent { get; init; }

    /// <summary>Whether this is a targeting preview.</summary>
    public bool IsPreview { get; init; }

    /// <summary>Damage type for damage zones.</summary>
    public string? DamageType { get; init; }

    /// <summary>Damage per turn for damage zones.</summary>
    public int? DamagePerTurn { get; init; }

    /// <summary>Status effect applied by this zone.</summary>
    public string? StatusEffect { get; init; }
}
```

### 8.2 New Enums

**File:** `src/Presentation/RuneAndRust.Presentation.Tui/Enums/ZoneType.cs`

```csharp
namespace RuneAndRust.Presentation.Tui.Enums;

/// <summary>
/// Zone effect types for UI categorization and rendering.
/// </summary>
public enum ZoneType
{
    /// <summary>Zones that deal damage per turn.</summary>
    Damage,

    /// <summary>Zones that apply control effects (stun, root).</summary>
    Control,

    /// <summary>Zones that apply debuffs.</summary>
    Debuff,

    /// <summary>Zones that apply buffs or healing.</summary>
    Buff,

    /// <summary>Targeting preview (not a real zone).</summary>
    Preview
}
```

### 8.3 Entity Summary Table

| Entity | Layer | New? | Description |
|--------|-------|------|-------------|
| `ZoneDisplayDto` | Presentation | NEW | Zone display data |
| `ZoneLegendEntryDto` | Presentation | NEW | Legend entry data |
| `ZoneType` | Presentation | NEW | Zone categorization enum |
| `ZoneDisplayConfig` | Presentation | NEW | Visual configuration |
| `AoEZoneOverlay` | Presentation | NEW | UI component |
| `ZoneRenderer` | Presentation | NEW | Rendering logic |

---

## 9. Configuration File Schemas

### 9.1 zone-display.json

**File:** `config/zone-display.json`

```json
{
  "$schema": "./schemas/zone-display.schema.json",
  "symbols": {
    "damage": "X",
    "control": "!",
    "debuff": "-",
    "buff": "+",
    "preview": "."
  },
  "damageTypeSymbols": {
    "fire": "F",
    "ice": "I",
    "poison": "P",
    "lightning": "L",
    "acid": "A",
    "necrotic": "N",
    "holy": "H"
  },
  "colors": {
    "damage": "Red",
    "control": "Magenta",
    "debuff": "DarkYellow",
    "buff": "Green",
    "preview": "DarkGray"
  },
  "damageTypeColors": {
    "fire": "Red",
    "ice": "Cyan",
    "poison": "DarkGreen",
    "lightning": "Yellow",
    "acid": "DarkYellow",
    "necrotic": "DarkMagenta",
    "holy": "White"
  },
  "hazardIcons": {
    "fire": "ğŸ”¥",
    "ice": "â„",
    "poison": "â˜ ",
    "lightning": "âš¡",
    "acid": "ğŸ’§",
    "necrotic": "ğŸ’€",
    "holy": "âœ¨",
    "default": "âš "
  },
  "display": {
    "showLegend": true,
    "showDuration": true,
    "showDamagePerTurn": true,
    "previewOpacity": 0.5
  }
}
```

### 9.2 Configuration Schema

**File:** `config/schemas/zone-display.schema.json`

```json
{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "title": "Zone Display Configuration",
  "type": "object",
  "properties": {
    "symbols": {
      "type": "object",
      "properties": {
        "damage": { "type": "string", "maxLength": 1 },
        "control": { "type": "string", "maxLength": 1 },
        "debuff": { "type": "string", "maxLength": 1 },
        "buff": { "type": "string", "maxLength": 1 },
        "preview": { "type": "string", "maxLength": 1 }
      },
      "required": ["damage", "control", "debuff", "buff", "preview"]
    },
    "damageTypeSymbols": {
      "type": "object",
      "additionalProperties": { "type": "string", "maxLength": 1 }
    },
    "colors": {
      "type": "object",
      "properties": {
        "damage": { "type": "string" },
        "control": { "type": "string" },
        "debuff": { "type": "string" },
        "buff": { "type": "string" },
        "preview": { "type": "string" }
      },
      "required": ["damage", "control", "debuff", "buff", "preview"]
    },
    "damageTypeColors": {
      "type": "object",
      "additionalProperties": { "type": "string" }
    },
    "hazardIcons": {
      "type": "object",
      "additionalProperties": { "type": "string" }
    },
    "display": {
      "type": "object",
      "properties": {
        "showLegend": { "type": "boolean" },
        "showDuration": { "type": "boolean" },
        "showDamagePerTurn": { "type": "boolean" },
        "previewOpacity": { "type": "number", "minimum": 0, "maximum": 1 }
      }
    }
  },
  "required": ["symbols", "colors", "display"]
}
```

### 9.3 Configuration Class

**File:** `src/Presentation/RuneAndRust.Presentation.Tui/Configuration/ZoneDisplayConfig.cs`

```csharp
namespace RuneAndRust.Presentation.Tui.Configuration;

/// <summary>
/// Configuration for zone display visuals.
/// </summary>
public record ZoneDisplayConfig
{
    /// <summary>Symbols for zone types.</summary>
    public required SymbolConfig Symbols { get; init; }

    /// <summary>Symbols for specific damage types.</summary>
    public required Dictionary<string, char> DamageTypeSymbols { get; init; }

    /// <summary>Colors for zone types.</summary>
    public required ZoneColorConfig Colors { get; init; }

    /// <summary>Colors for specific damage types.</summary>
    public required Dictionary<string, ConsoleColor> DamageTypeColors { get; init; }

    /// <summary>Unicode hazard icons.</summary>
    public required Dictionary<string, string> HazardIcons { get; init; }

    /// <summary>Display behavior settings.</summary>
    public required ZoneDisplaySettings Display { get; init; }

    public static ZoneDisplayConfig CreateDefault() => new()
    {
        Symbols = new SymbolConfig
        {
            Damage = 'X',
            Control = '!',
            Debuff = '-',
            Buff = '+',
            Preview = '.'
        },
        DamageTypeSymbols = new Dictionary<string, char>
        {
            ["fire"] = 'F',
            ["ice"] = 'I',
            ["poison"] = 'P',
            ["lightning"] = 'L',
            ["acid"] = 'A',
            ["necrotic"] = 'N',
            ["holy"] = 'H'
        },
        Colors = new ZoneColorConfig
        {
            Damage = ConsoleColor.Red,
            Control = ConsoleColor.Magenta,
            Debuff = ConsoleColor.DarkYellow,
            Buff = ConsoleColor.Green,
            Preview = ConsoleColor.DarkGray
        },
        DamageTypeColors = new Dictionary<string, ConsoleColor>
        {
            ["fire"] = ConsoleColor.Red,
            ["ice"] = ConsoleColor.Cyan,
            ["poison"] = ConsoleColor.DarkGreen,
            ["lightning"] = ConsoleColor.Yellow,
            ["acid"] = ConsoleColor.DarkYellow,
            ["necrotic"] = ConsoleColor.DarkMagenta,
            ["holy"] = ConsoleColor.White
        },
        HazardIcons = new Dictionary<string, string>
        {
            ["fire"] = "ğŸ”¥",
            ["ice"] = "â„",
            ["poison"] = "â˜ ",
            ["lightning"] = "âš¡",
            ["acid"] = "ğŸ’§",
            ["necrotic"] = "ğŸ’€",
            ["holy"] = "âœ¨",
            ["default"] = "âš "
        },
        Display = new ZoneDisplaySettings
        {
            ShowLegend = true,
            ShowDuration = true,
            ShowDamagePerTurn = true
        }
    };
}

public record SymbolConfig
{
    public char Damage { get; init; }
    public char Control { get; init; }
    public char Debuff { get; init; }
    public char Buff { get; init; }
    public char Preview { get; init; }
}

public record ZoneColorConfig
{
    public ConsoleColor Damage { get; init; }
    public ConsoleColor Control { get; init; }
    public ConsoleColor Debuff { get; init; }
    public ConsoleColor Buff { get; init; }
    public ConsoleColor Preview { get; init; }
}

public record ZoneDisplaySettings
{
    public bool ShowLegend { get; init; }
    public bool ShowDuration { get; init; }
    public bool ShowDamagePerTurn { get; init; }
}
```

---

## 10. CombatGridView Integration

### 10.1 Integration Points

**File:** `src/Presentation/RuneAndRust.Presentation.Tui/UI/CombatGridView.cs` (modifications)

```csharp
// Add to CombatGridView class:

private readonly Dictionary<GridPosition, ZoneDisplayDto> _aoeZones = new();
private readonly ZoneRenderer _zoneRenderer;

/// <summary>
/// Sets the active AoE zones to display on the grid.
/// </summary>
/// <param name="zones">Dictionary mapping positions to zone data.</param>
public void SetAoEZones(IReadOnlyDictionary<GridPosition, ZoneDisplayDto> zones)
{
    _aoeZones.Clear();
    foreach (var kvp in zones)
    {
        _aoeZones[kvp.Key] = kvp.Value;
    }
}

/// <summary>
/// Clears all AoE zone overlays.
/// </summary>
public void ClearAoEZones()
{
    _aoeZones.Clear();
}

// Modify cell rendering logic in RenderGrid:
private char GetCellSymbol(int col, int row, string terrain, EntityInfo? entity)
{
    // Priority 1: Entity
    if (entity != null)
    {
        return entity.Value.IsPlayer ? PlayerSymbol :
               entity.Value.IsAlly ? AllySymbol : MonsterSymbol;
    }

    // Priority 2: AoE Zone (NEW)
    var gridPos = new GridPosition(col, row);
    if (_aoeZones.TryGetValue(gridPos, out var zone))
    {
        return !string.IsNullOrEmpty(zone.DamageType)
            ? _zoneRenderer.GetDamageTypeSymbol(zone.DamageType)
            : _zoneRenderer.GetZoneSymbol(zone.ZoneType);
    }

    // Priority 3: Terrain
    return TerrainSymbols.GetValueOrDefault(terrain?.ToLowerInvariant() ?? "open", '.');
}
```

### 10.2 Render Layer Priority

```
Render Order (top to bottom in display):
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

1. ENTITY LAYER
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ @ = Player, M = Monster, A = Ally   â”‚
   â”‚ Always visible, highest priority    â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚
              â–¼
2. SELECTION/HIGHLIGHT LAYER
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ [X] = Selected cell                 â”‚
   â”‚ *X* = Highlighted cell              â”‚
   â”‚ Movement range, attack targets      â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚
              â–¼
3. AoE ZONE LAYER (NEW)
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ F = Fire, I = Ice, P = Poison, etc. â”‚
   â”‚ Zone symbols with colored rendering â”‚
   â”‚ Replaces terrain when zone present  â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚
              â–¼
4. TERRAIN LAYER
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ . = Open, # = Wall, ~ = Water       â”‚
   â”‚ Base layer, only if no overlay      â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 10.3 Refresh Triggers

| Event | Action |
|-------|--------|
| Turn Start | Update zone durations, re-render grid |
| Zone Created | Add to zone overlay, re-render |
| Zone Expired | Remove from zone overlay, re-render |
| Ability Targeting | Show preview overlay |
| Target Confirmed | Clear preview, apply zone |
| Target Cancelled | Clear preview overlay |

---

## 11. Logging Specifications

### Log Levels by Component

| Component | Level | Events |
|-----------|-------|--------|
| `AoEZoneOverlay` | Information | Zones rendered, major updates |
| `AoEZoneOverlay` | Debug | Cell mapping, preview changes |
| `AoEZoneOverlay` | Warning | Zone overlap conflicts |
| `ZoneRenderer` | Debug | Symbol/color mapping |
| `ZoneRenderer` | Warning | Unknown zone type or damage type |
| `CombatGridView` | Debug | Zone layer rendering |

### Log Message Examples

```
[INF] AoEZoneOverlay: Rendered 3 zones affecting 15 cells
[DBG] AoEZoneOverlay: Highlighted 9 tiles for Damage (preview=true)
[DBG] AoEZoneOverlay: Zone overlap at E5 - Poison takes priority over Ice
[DBG] ZoneRenderer: Mapped fire zone to symbol 'F' color Red
[WRN] ZoneRenderer: Unknown damage type 'chaos', using default symbol
```

---

## 12. Unit Testing Requirements

### Test Count by Feature

| Feature | Test Count |
|---------|------------|
| AoEZoneOverlay.RenderZones | 2 |
| AoEZoneOverlay.HighlightTiles | 1 |
| AoEZoneOverlay.RenderLegend | 1 |
| ZoneRenderer.GetZoneSymbol | 1 |
| ZoneRenderer.GetDamageTypeSymbol | 1 |
| **Total** | **~6** |

### Test Specifications

**File:** `tests/RuneAndRust.Presentation.Tui.Tests/UI/AoEZoneOverlayTests.cs`

```csharp
[TestFixture]
public class AoEZoneOverlayTests
{
    [Test]
    public void RenderZones_WithMultipleZones_BuildsCorrectCellMapping();

    [Test]
    public void RenderZones_WithOverlappingZones_UsesPriorityOrder();

    [Test]
    public void HighlightTiles_PreviewMode_AddsToMappingWithLowPriority();

    [Test]
    public void RenderLegend_WithActiveZones_FormatsCorrectly();
}
```

**File:** `tests/RuneAndRust.Presentation.Tui.Tests/Renderers/ZoneRendererTests.cs`

```csharp
[TestFixture]
public class ZoneRendererTests
{
    [Test]
    public void GetZoneSymbol_AllTypes_ReturnsMappedCharacter();

    [Test]
    public void GetDamageTypeSymbol_AllTypes_ReturnsMappedCharacter();
}
```

---

## 13. Use Cases

### UC-001: View Active Hazard Zones
**Actor:** Player
**Flow:** Combat begins â†’ Player views grid â†’ Hazard zones show as colored symbols â†’ Legend displays zone information

### UC-002: Preview Ability Targeting
**Actor:** Player
**Flow:** Player selects AoE ability â†’ Targeting mode activates â†’ Preview overlay shows affected cells â†’ Player confirms or cancels

### UC-003: Monitor Zone Duration
**Actor:** Player
**Flow:** Fire zone has 2 turns remaining â†’ Legend shows "2 turns" â†’ Turn passes â†’ Legend shows "1 turn" â†’ Turn passes â†’ Zone expires and overlay removed

### UC-004: Overlapping Zones
**Actor:** Player
**Flow:** Fire zone covers cells A1-B2 â†’ Ice zone added covering B2-C3 â†’ B2 shows higher priority zone â†’ Legend lists both zones

### UC-005: Enter Hazard Zone
**Actor:** Player
**Flow:** Player moves to cell with fire zone â†’ Entity symbol (@) displays on top of zone â†’ Cell color indicates danger â†’ Legend shows zone affects player's position

---

## 14. Deliverable Checklist

### UI Components
- [ ] `AoEZoneOverlay.cs` created
- [ ] `RenderZones()` implemented
- [ ] `HighlightTiles()` implemented
- [ ] `ShowHazardIcons()` implemented
- [ ] `UpdateDurations()` implemented
- [ ] `RenderLegend()` implemented

### Renderers
- [ ] `ZoneRenderer.cs` created
- [ ] `GetZoneSymbol()` implemented
- [ ] `GetDamageTypeSymbol()` implemented
- [ ] `GetZoneColor()` implemented
- [ ] `GetDamageTypeColor()` implemented
- [ ] `FormatZoneDuration()` implemented
- [ ] `GetHazardIcon()` implemented

### DTOs
- [ ] `ZoneDisplayDto.cs` created
- [ ] `ZoneLegendEntryDto.cs` created

### Enums
- [ ] `ZoneType.cs` created

### Configuration
- [ ] `config/zone-display.json` created
- [ ] `config/schemas/zone-display.schema.json` created
- [ ] `ZoneDisplayConfig.cs` created

### View Integration
- [ ] `CombatGridView` modified with `SetAoEZones()` method
- [ ] Cell rendering updated with zone layer
- [ ] Legend rendering integration

### Testing
- [ ] ~6 unit tests implemented
- [ ] All tests passing

---

## 15. Acceptance Criteria

### Functional
- [ ] AoE zones highlight affected tiles on combat grid
- [ ] Hazard indicators show correct damage type symbols
- [ ] Zone duration displays remaining turns
- [ ] Different zone types have distinct visual indicators
- [ ] Zone legend shows active zone information
- [ ] Preview mode shows targeting area
- [ ] Entities display on top of zone overlays
- [ ] Overlapping zones use priority ordering

### Quality
- [ ] Build succeeds with 0 errors
- [ ] Build succeeds with 0 warnings
- [ ] All ~6 unit tests pass
- [ ] Configuration file validates against schema
- [ ] XML documentation complete on all public members
- [ ] ASCII fallback works when Unicode not supported

---

## 16. Dependencies

### Required from v0.10.1x

| Type | Location | Usage in this phase |
|------|----------|---------------------|
| `IAreaEffectService` | Application/Interfaces | Get affected cells |
| `AreaEffect` | Domain/ValueObjects | AoE configuration |
| `AreaEffectShape` | Domain/Enums | Shape types |
| `GridPosition` | Domain/ValueObjects | Cell positions |
| `HazardZone` | Domain/Entities | Persistent zone data |
| `HazardType` | Domain/Enums | Hazard categorization |

### Required from v0.7.x-v0.8.x

| Type | Location | Usage in this phase |
|------|----------|---------------------|
| `CombatGridView` | Presentation.Tui/UI | Grid rendering |
| `ITerminalService` | Application/Interfaces | Terminal output |
| `ScreenLayout` | Presentation.Tui/UI | Panel rendering |

### Required from v0.13.0a

| Type | Location | Usage in this phase |
|------|----------|---------------------|
| Combat UI Component Pattern | v0.13.0a | Architecture pattern |
| Configuration pattern | v0.13.0a | Config class structure |

### Provides to v0.13.0c-d

| Type | Usage |
|------|-------|
| Grid overlay pattern | AoE and combo displays can use similar cell overlay |
| `ZoneType` enum pattern | Defense prompts may use similar categorization |

---

## 17. Future Considerations

### Deferred to v0.13.0c
- **Combo Chain Display** - Different display pattern (sequence-based, not grid-based)

### Deferred to v0.13.0d
- **Defense Prompts** - Real-time prompts, not persistent overlays
- **Stance Indicator** - Single indicator, not grid overlay

### Out of Scope (Future Versions)
- **Zone Animations** - Pulsing/flickering effects for zones
- **Zone Transitions** - Fade-in/fade-out when zones appear/disappear
- **3D Height Zones** - Zones affecting different grid heights
- **Zone Interaction Effects** - Visual effects when zones interact

---

*Document Version: 1.0*
*Last Updated: 2026-01-16*
*Author: Claude Code*
