# v0.0.10b Design Specification: Unit Test Coverage

**Version:** 0.0.10b
**Phase Name:** Unit Test Coverage
**Parent Version:** v0.0.10 (Documentation & Polish)
**Prerequisites:** v0.0.9 Complete (Monster Variety & Loot), v0.0.10a Complete (Logging Infrastructure)
**Estimated Tests:** ~15 new framework tests (v0.0.5-9 tests defined in their respective specifications)

---

## 1. Overview

### 1.1 Purpose

Establish comprehensive unit test coverage for all systems implemented in v0.0.5 through v0.0.9, standardize test organization and naming conventions, and create reusable test utilities and fixtures to simplify test authoring.

### 1.2 Current State

The project currently has 198 tests (as of v0.0.4d):

| Test Suite | Count | Coverage |
|------------|-------|----------|
| Domain Unit Tests | 123 | v0.0.1-v0.0.4 entities, value objects, definitions |
| Application Unit Tests | 67 | v0.0.1-v0.0.4 services |
| Architecture Tests | 8 | Layer dependency validation |
| **Total** | **198** | |

### 1.3 Test Framework

| Component | Technology |
|-----------|------------|
| Test Framework | NUnit |
| Assertions | FluentAssertions |
| Mocking | Moq |
| Architecture | NetArchTest.Rules |

### 1.4 Scope

**In Scope:**
- Define test requirements for v0.0.5-v0.0.9 systems
- Standardize test naming conventions
- Create test builder utilities for common entities
- Create mock factory utilities for services
- Establish test organization standards
- Define coverage targets by layer
- Create test fixture base classes

**Out of Scope:**
- Integration tests (already in separate project)
- UI/E2E tests
- Performance/Load tests
- Writing the actual v0.0.5-9 tests (those are defined in their respective design specs)

### 1.5 Design Goals

1. **Consistency**: All tests follow the same naming and structure patterns
2. **Maintainability**: Tests are easy to understand and modify
3. **Isolation**: Each test is independent and doesn't rely on external state
4. **Speed**: Unit tests run quickly (< 1s per test)
5. **Readability**: Test failures clearly indicate what went wrong
6. **DRY**: Common setup logic is reusable via builders and fixtures

---

## 2. Test Naming Standards

### 2.1 Test Method Naming Convention

All test methods should follow the pattern:

```
MethodName_StateUnderTest_ExpectedBehavior
```

**Examples:**

```csharp
// Domain entity tests
public void TakeDamage_WithResistance_ReducesDamageByPercentage()
public void Heal_WhenAtMaxHealth_ReturnsZero()
public void MoveTo_WithValidPosition_UpdatesPosition()

// Service tests
public void SpawnMonster_WithValidDefinitionId_ReturnsMonsterInstance()
public void CanUseAbility_WhenOnCooldown_ReturnsFalse()
public void ProcessTurnEnd_WithActiveEffects_ReducesDurations()

// Value object tests
public void Create_WithNegativeValue_ThrowsArgumentOutOfRangeException()
public void Parse_ValidNotation_ReturnsDicePool()
```

### 2.2 Test Class Naming Convention

Test classes should mirror the class under test with a `Tests` suffix:

| Source Class | Test Class |
|--------------|------------|
| `Player.cs` | `PlayerTests.cs` |
| `MonsterService.cs` | `MonsterServiceTests.cs` |
| `DicePool.cs` | `DicePoolTests.cs` |
| `AbilityDefinition.cs` | `AbilityDefinitionTests.cs` |

### 2.3 Test File Organization

```
tests/
├── RuneAndRust.Domain.UnitTests/
│   ├── Entities/
│   │   ├── PlayerTests.cs
│   │   ├── MonsterTests.cs
│   │   ├── RoomTests.cs
│   │   ├── GameSessionTests.cs
│   │   ├── CombatEncounterTests.cs          # v0.0.6
│   │   └── PlayerAbilityTests.cs
│   ├── ValueObjects/
│   │   ├── StatsTests.cs
│   │   ├── PositionTests.cs
│   │   ├── DicePoolTests.cs                 # v0.0.5
│   │   ├── DiceRollResultTests.cs           # v0.0.5
│   │   ├── SkillCheckResultTests.cs         # v0.0.5
│   │   ├── InitiativeRollTests.cs           # v0.0.6
│   │   ├── DamageResistancesTests.cs        # v0.0.9
│   │   └── LootDropTests.cs                 # v0.0.9
│   ├── Definitions/
│   │   ├── ClassDefinitionTests.cs
│   │   ├── AbilityDefinitionTests.cs
│   │   ├── SkillDefinitionTests.cs          # v0.0.5
│   │   ├── StatusEffectDefinitionTests.cs   # v0.0.6
│   │   ├── MonsterDefinitionTests.cs        # v0.0.9
│   │   ├── TierDefinitionTests.cs           # v0.0.9
│   │   └── DamageTypeDefinitionTests.cs     # v0.0.9
│   ├── Services/
│   │   └── CombatServiceTests.cs
│   └── Validation/
│       └── PlayerNameValidatorTests.cs
├── RuneAndRust.Application.UnitTests/
│   ├── Services/
│   │   ├── GameSessionServiceTests.cs
│   │   ├── AbilityServiceTests.cs
│   │   ├── ResourceServiceTests.cs
│   │   ├── ClassServiceTests.cs
│   │   ├── DiceServiceTests.cs              # v0.0.5
│   │   ├── SkillCheckServiceTests.cs        # v0.0.5
│   │   ├── InitiativeServiceTests.cs        # v0.0.6
│   │   ├── MonsterAIServiceTests.cs         # v0.0.6
│   │   ├── StatusEffectServiceTests.cs      # v0.0.6
│   │   ├── EquipmentServiceTests.cs         # v0.0.7
│   │   ├── ExperienceServiceTests.cs        # v0.0.8
│   │   ├── ProgressionServiceTests.cs       # v0.0.8
│   │   ├── MonsterServiceTests.cs           # v0.0.9
│   │   ├── DamageCalculationServiceTests.cs # v0.0.9
│   │   ├── TierServiceTests.cs              # v0.0.9
│   │   └── LootServiceTests.cs              # v0.0.9
│   └── Logging/
│       └── LoggingTests.cs                  # v0.0.10a
├── RuneAndRust.Architecture.Tests/
│   └── LayerDependencyTests.cs
└── RuneAndRust.TestUtilities/               # NEW
    ├── Builders/
    │   ├── PlayerBuilder.cs
    │   ├── MonsterBuilder.cs
    │   ├── RoomBuilder.cs
    │   └── GameSessionBuilder.cs
    ├── Mocks/
    │   ├── MockConfigurationProvider.cs
    │   └── MockRepository.cs
    ├── Logging/
    │   ├── TestLogger.cs
    │   └── TestLoggerFactory.cs
    └── Fixtures/
        └── TestFixtureBase.cs
```

---

## 3. Test Coverage Requirements

### 3.1 Projected Test Counts by Version

Based on design specifications:

| Version | Phase | Planned Tests | Focus |
|---------|-------|---------------|-------|
| v0.0.5a | Core Dice Engine | ~18 | DicePool, DiceRollResult, DiceService |
| v0.0.5b | Skill Check System | ~20 | SkillDefinition, SkillCheckService |
| v0.0.5c | Combat Integration | ~15 | Dice-based combat |
| v0.0.5d | Configuration & Polish | ~9 | Commands, rendering |
| v0.0.6a | Multi-Monster Combat | ~20 | CombatEncounter, Initiative |
| v0.0.6b | Monster AI & Flee | ~18 | MonsterAIService, FleeCommand |
| v0.0.6c | Status Effect Framework | ~25 | StatusEffectDefinition, StatusEffectService |
| v0.0.6d | Status Effect Integration | ~20 | Effect interactions, cleanse |
| v0.0.7a | Equipment Slots | ~15 | EquipmentSlot, EquipmentService |
| v0.0.7b | Weapons & Armor | ~18 | WeaponDefinition, ArmorDefinition |
| v0.0.7c | Equipment Effects | ~12 | Stat bonuses, set bonuses |
| v0.0.7d | Integration & Polish | ~10 | Commands, UI |
| v0.0.8a | Experience System | ~12 | ExperienceService |
| v0.0.8b | Level Progression | ~15 | ProgressionService, LevelUpResult |
| v0.0.8c | Unlock System | ~10 | Ability unlocks, stat gains |
| v0.0.8d | Integration & Polish | ~8 | XP display, level up flow |
| v0.0.9a | Monster Definitions | ~18 | MonsterDefinition, MonsterService |
| v0.0.9b | Damage Types | ~15 | DamageTypeDefinition, DamageCalculationService |
| v0.0.9c | Tiers & Traits | ~16 | TierDefinition, TraitService |
| v0.0.9d | Loot & Currency | ~16 | LootTable, LootService |
| v0.0.10a | Logging | ~15 | TestLogger, PerformanceScope |
| v0.0.10b | Test Utilities | ~15 | Builders, fixtures |

### 3.2 Final Target Counts

| Suite | v0.0.4d | v0.0.10 Target |
|-------|---------|----------------|
| Domain Unit Tests | 123 | ~280 |
| Application Unit Tests | 67 | ~180 |
| Architecture Tests | 8 | 8 |
| **Total** | **198** | **~468** |

### 3.3 Coverage by Category

| Category | Minimum Coverage | Notes |
|----------|------------------|-------|
| Entity methods | 100% | All public methods tested |
| Value object creation | 100% | Valid and invalid cases |
| Definition validation | 100% | Create() factory methods |
| Service public methods | 90% | Key paths covered |
| Edge cases | 80% | Null, empty, boundary values |
| Error conditions | 90% | Exception throwing verified |

---

## 4. Test Utilities

### 4.1 Entity Builders

Fluent builders simplify test entity creation with sensible defaults.

**File:** `tests/RuneAndRust.TestUtilities/Builders/PlayerBuilder.cs`

```csharp
using RuneAndRust.Domain.Entities;
using RuneAndRust.Domain.ValueObjects;

namespace RuneAndRust.TestUtilities.Builders;

/// <summary>
/// Fluent builder for creating test Player instances.
/// </summary>
public class PlayerBuilder
{
    private string _name = "TestPlayer";
    private Stats _stats = Stats.Default;
    private PlayerAttributes _attributes = PlayerAttributes.Default;
    private string _raceId = "human";
    private string _backgroundId = "soldier";
    private int? _currentHealth;
    private Position? _position;
    private readonly List<Item> _inventoryItems = [];
    private string? _classId;
    private string? _archetypeId;
    private readonly Dictionary<string, ResourcePool> _resources = new();
    private readonly Dictionary<string, PlayerAbility> _abilities = new();

    /// <summary>
    /// Creates a new PlayerBuilder with default values.
    /// </summary>
    public static PlayerBuilder Create() => new();

    /// <summary>
    /// Sets the player name.
    /// </summary>
    public PlayerBuilder WithName(string name)
    {
        _name = name;
        return this;
    }

    /// <summary>
    /// Sets the player stats.
    /// </summary>
    public PlayerBuilder WithStats(Stats stats)
    {
        _stats = stats;
        return this;
    }

    /// <summary>
    /// Sets the player stats using individual values.
    /// </summary>
    public PlayerBuilder WithStats(int maxHealth, int attack, int defense)
    {
        _stats = new Stats(maxHealth, attack, defense);
        return this;
    }

    /// <summary>
    /// Sets the player attributes.
    /// </summary>
    public PlayerBuilder WithAttributes(PlayerAttributes attributes)
    {
        _attributes = attributes;
        return this;
    }

    /// <summary>
    /// Sets the player attributes using individual values.
    /// </summary>
    public PlayerBuilder WithAttributes(int might, int fortitude, int will, int wits, int finesse)
    {
        _attributes = PlayerAttributes.Create(might, fortitude, will, wits, finesse);
        return this;
    }

    /// <summary>
    /// Sets the current health (damages the player if below max).
    /// </summary>
    public PlayerBuilder WithCurrentHealth(int health)
    {
        _currentHealth = health;
        return this;
    }

    /// <summary>
    /// Sets the player position.
    /// </summary>
    public PlayerBuilder AtPosition(int x, int y)
    {
        _position = new Position(x, y);
        return this;
    }

    /// <summary>
    /// Adds an item to the player's inventory.
    /// </summary>
    public PlayerBuilder WithItem(Item item)
    {
        _inventoryItems.Add(item);
        return this;
    }

    /// <summary>
    /// Sets the player's class and archetype.
    /// </summary>
    public PlayerBuilder WithClass(string archetypeId, string classId)
    {
        _archetypeId = archetypeId;
        _classId = classId;
        return this;
    }

    /// <summary>
    /// Adds a resource pool to the player.
    /// </summary>
    public PlayerBuilder WithResource(string resourceTypeId, int maximum, int? current = null)
    {
        var pool = new ResourcePool(resourceTypeId, maximum, startAtZero: false);
        if (current.HasValue && current.Value < maximum)
        {
            // Spend to get to current value
            pool.Spend(maximum - current.Value);
        }
        _resources[resourceTypeId] = pool;
        return this;
    }

    /// <summary>
    /// Adds an ability to the player.
    /// </summary>
    public PlayerBuilder WithAbility(string abilityId, bool isUnlocked = true, int cooldown = 0)
    {
        var ability = PlayerAbility.Create(abilityId, isUnlocked);
        if (cooldown > 0)
        {
            ability.Use(cooldown);
        }
        _abilities[abilityId] = ability;
        return this;
    }

    /// <summary>
    /// Builds the Player instance.
    /// </summary>
    public Player Build()
    {
        var player = new Player(_name, _raceId, _backgroundId, _attributes, stats: _stats);

        if (_classId != null && _archetypeId != null)
        {
            player.SetClass(_archetypeId, _classId);
        }

        if (_position.HasValue)
        {
            player.MoveTo(_position.Value);
        }

        foreach (var item in _inventoryItems)
        {
            player.TryPickUpItem(item);
        }

        foreach (var (id, pool) in _resources)
        {
            player.InitializeResource(id, pool.Maximum);
            if (pool.Current < pool.Maximum)
            {
                player.GetResource(id)?.Spend(pool.Maximum - pool.Current);
            }
        }

        foreach (var ability in _abilities.Values)
        {
            player.AddAbility(ability);
        }

        // Apply damage to reach target health
        if (_currentHealth.HasValue && _currentHealth.Value < _stats.MaxHealth)
        {
            var damageNeeded = _stats.MaxHealth - _currentHealth.Value;
            player.TakeDamage(damageNeeded + _stats.Defense); // Account for defense
        }

        return player;
    }
}
```

**File:** `tests/RuneAndRust.TestUtilities/Builders/MonsterBuilder.cs`

```csharp
using RuneAndRust.Domain.Entities;
using RuneAndRust.Domain.ValueObjects;

namespace RuneAndRust.TestUtilities.Builders;

/// <summary>
/// Fluent builder for creating test Monster instances.
/// </summary>
public class MonsterBuilder
{
    private string _name = "Test Monster";
    private string _description = "A monster for testing.";
    private int _maxHealth = 50;
    private Stats _stats = new Stats(50, 10, 5);
    private int? _currentHealth;
    private string? _definitionId;
    private int _experienceValue = 25;

    /// <summary>
    /// Creates a new MonsterBuilder with default values.
    /// </summary>
    public static MonsterBuilder Create() => new();

    /// <summary>
    /// Creates a builder preset for a goblin.
    /// </summary>
    public static MonsterBuilder Goblin() => Create()
        .WithName("Goblin")
        .WithDescription("A small, green creature with sharp teeth.")
        .WithDefinitionId("goblin")
        .WithStats(30, 8, 2)
        .WithExperienceValue(25);

    /// <summary>
    /// Creates a builder preset for an orc.
    /// </summary>
    public static MonsterBuilder Orc() => Create()
        .WithName("Orc")
        .WithDescription("A hulking, brutish warrior.")
        .WithDefinitionId("orc")
        .WithStats(50, 12, 4)
        .WithExperienceValue(50);

    /// <summary>
    /// Sets the monster name.
    /// </summary>
    public MonsterBuilder WithName(string name)
    {
        _name = name;
        return this;
    }

    /// <summary>
    /// Sets the monster description.
    /// </summary>
    public MonsterBuilder WithDescription(string description)
    {
        _description = description;
        return this;
    }

    /// <summary>
    /// Sets the monster stats using individual values.
    /// </summary>
    public MonsterBuilder WithStats(int maxHealth, int attack, int defense)
    {
        _maxHealth = maxHealth;
        _stats = new Stats(maxHealth, attack, defense);
        return this;
    }

    /// <summary>
    /// Sets the current health (damages the monster if below max).
    /// </summary>
    public MonsterBuilder WithCurrentHealth(int health)
    {
        _currentHealth = health;
        return this;
    }

    /// <summary>
    /// Sets the monster definition ID.
    /// </summary>
    public MonsterBuilder WithDefinitionId(string definitionId)
    {
        _definitionId = definitionId;
        return this;
    }

    /// <summary>
    /// Sets the experience value.
    /// </summary>
    public MonsterBuilder WithExperienceValue(int xp)
    {
        _experienceValue = xp;
        return this;
    }

    /// <summary>
    /// Builds the Monster instance.
    /// </summary>
    public Monster Build()
    {
        var monster = new Monster(_name, _description, _maxHealth, _stats);

        // Apply damage to reach target health
        if (_currentHealth.HasValue && _currentHealth.Value < _maxHealth)
        {
            var damageNeeded = _maxHealth - _currentHealth.Value;
            monster.TakeDamage(damageNeeded + _stats.Defense);
        }

        return monster;
    }
}
```

### 4.2 Mock Configuration Provider

**File:** `tests/RuneAndRust.TestUtilities/Mocks/MockConfigurationProvider.cs`

```csharp
using RuneAndRust.Application.Interfaces;
using RuneAndRust.Domain.Definitions;

namespace RuneAndRust.TestUtilities.Mocks;

/// <summary>
/// In-memory configuration provider for tests.
/// </summary>
public class MockConfigurationProvider : IGameConfigurationProvider
{
    private readonly List<ClassDefinition> _classes = [];
    private readonly List<ArchetypeDefinition> _archetypes = [];
    private readonly List<AbilityDefinition> _abilities = [];
    private readonly List<ResourceTypeDefinition> _resourceTypes = [];
    private readonly List<MonsterDefinition> _monsters = [];
    private readonly List<DamageTypeDefinition> _damageTypes = [];
    private readonly List<TierDefinition> _tiers = [];

    /// <summary>
    /// Adds a class definition.
    /// </summary>
    public MockConfigurationProvider WithClass(ClassDefinition classDef)
    {
        _classes.Add(classDef);
        return this;
    }

    /// <summary>
    /// Adds an archetype definition.
    /// </summary>
    public MockConfigurationProvider WithArchetype(ArchetypeDefinition archetype)
    {
        _archetypes.Add(archetype);
        return this;
    }

    /// <summary>
    /// Adds an ability definition.
    /// </summary>
    public MockConfigurationProvider WithAbility(AbilityDefinition ability)
    {
        _abilities.Add(ability);
        return this;
    }

    /// <summary>
    /// Adds a resource type definition.
    /// </summary>
    public MockConfigurationProvider WithResourceType(ResourceTypeDefinition resourceType)
    {
        _resourceTypes.Add(resourceType);
        return this;
    }

    /// <summary>
    /// Adds a monster definition.
    /// </summary>
    public MockConfigurationProvider WithMonster(MonsterDefinition monster)
    {
        _monsters.Add(monster);
        return this;
    }

    /// <summary>
    /// Adds default resource types (mana, rage, faith, stamina).
    /// </summary>
    public MockConfigurationProvider WithDefaultResourceTypes()
    {
        _resourceTypes.AddRange([
            ResourceTypeDefinition.Create("mana", "Mana", "MP", "#0066FF", "Magical energy", 100),
            ResourceTypeDefinition.Create("rage", "Rage", "RG", "#FF0000", "Battle fury", 100, startAtZero: true),
            ResourceTypeDefinition.Create("faith", "Faith", "FP", "#FFD700", "Divine power", 50),
            ResourceTypeDefinition.Create("stamina", "Stamina", "SP", "#00FF00", "Physical energy", 100)
        ]);
        return this;
    }

    // IGameConfigurationProvider implementation
    public IReadOnlyList<ClassDefinition> GetClasses() => _classes;
    public ClassDefinition? GetClassById(string classId) =>
        _classes.FirstOrDefault(c => c.Id.Equals(classId, StringComparison.OrdinalIgnoreCase));

    public IReadOnlyList<ArchetypeDefinition> GetArchetypes() => _archetypes;
    public ArchetypeDefinition? GetArchetypeById(string archetypeId) =>
        _archetypes.FirstOrDefault(a => a.Id.Equals(archetypeId, StringComparison.OrdinalIgnoreCase));

    public IReadOnlyList<AbilityDefinition> GetAbilities() => _abilities;
    public AbilityDefinition? GetAbilityById(string abilityId) =>
        _abilities.FirstOrDefault(a => a.Id.Equals(abilityId, StringComparison.OrdinalIgnoreCase));
    public IReadOnlyList<AbilityDefinition> GetAbilitiesForClass(string classId) =>
        _abilities.Where(a => a.IsAvailableToClass(classId)).ToList();

    public IReadOnlyList<ResourceTypeDefinition> GetResourceTypes() => _resourceTypes;
    public ResourceTypeDefinition? GetResourceTypeById(string resourceTypeId) =>
        _resourceTypes.FirstOrDefault(r => r.Id.Equals(resourceTypeId, StringComparison.OrdinalIgnoreCase));

    public IReadOnlyList<MonsterDefinition> GetMonsters() => _monsters;
    public MonsterDefinition? GetMonsterById(string monsterId) =>
        _monsters.FirstOrDefault(m => m.Id.Equals(monsterId, StringComparison.OrdinalIgnoreCase));

    // Additional methods for v0.0.5-9 features will be added as needed
}
```

### 4.3 Test Fixture Base Class

**File:** `tests/RuneAndRust.TestUtilities/Fixtures/TestFixtureBase.cs`

```csharp
using Microsoft.Extensions.Logging;
using Moq;
using RuneAndRust.TestUtilities.Logging;
using RuneAndRust.TestUtilities.Mocks;

namespace RuneAndRust.TestUtilities.Fixtures;

/// <summary>
/// Base class for test fixtures with common setup.
/// </summary>
public abstract class TestFixtureBase
{
    /// <summary>
    /// Mock configuration provider for tests.
    /// </summary>
    protected MockConfigurationProvider ConfigProvider { get; private set; } = null!;

    /// <summary>
    /// Test logger factory for capturing logs.
    /// </summary>
    protected TestLoggerFactory LoggerFactory { get; private set; } = null!;

    /// <summary>
    /// Sets up common test infrastructure.
    /// </summary>
    [SetUp]
    public virtual void SetUp()
    {
        ConfigProvider = new MockConfigurationProvider();
        LoggerFactory = new TestLoggerFactory();
    }

    /// <summary>
    /// Creates a mock logger for the specified type.
    /// </summary>
    protected Mock<ILogger<T>> CreateMockLogger<T>() => new();

    /// <summary>
    /// Gets a test logger that captures log entries.
    /// </summary>
    protected TestLogger<T> GetTestLogger<T>() => LoggerFactory.GetTestLogger<T>();

    /// <summary>
    /// Verifies that a log message was written at the specified level.
    /// </summary>
    protected void VerifyLog<T>(LogLevel level, string messageFragment)
    {
        var logger = GetTestLogger<T>();
        var hasMessage = logger.GetEntries(level)
            .Any(e => e.Message.Contains(messageFragment, StringComparison.OrdinalIgnoreCase));

        if (!hasMessage)
        {
            throw new AssertionException(
                $"Expected log message containing '{messageFragment}' at level {level}, but none was found.");
        }
    }
}
```

### 4.4 Seeded Random for Deterministic Tests

**File:** `tests/RuneAndRust.TestUtilities/SeededRandom.cs`

```csharp
namespace RuneAndRust.TestUtilities;

/// <summary>
/// Provides seeded random number generation for deterministic tests.
/// </summary>
public static class SeededRandom
{
    /// <summary>
    /// Default seed for reproducible tests.
    /// </summary>
    public const int DefaultSeed = 12345;

    /// <summary>
    /// Creates a seeded Random instance for deterministic tests.
    /// </summary>
    /// <param name="seed">The seed value (default: 12345).</param>
    /// <returns>A seeded Random instance.</returns>
    public static Random Create(int seed = DefaultSeed) => new(seed);

    /// <summary>
    /// Creates multiple seeded Random instances for parallel test scenarios.
    /// </summary>
    public static IEnumerable<Random> CreateMultiple(int count, int baseSeed = DefaultSeed)
    {
        for (var i = 0; i < count; i++)
        {
            yield return new Random(baseSeed + i);
        }
    }
}
```

---

## 5. Test Patterns

### 5.1 Arrange-Act-Assert Pattern

All tests should follow the AAA pattern:

```csharp
[Test]
public void MethodName_StateUnderTest_ExpectedBehavior()
{
    // Arrange - Set up test data and dependencies
    var player = PlayerBuilder.Create()
        .WithName("TestHero")
        .WithStats(100, 10, 5)
        .Build();
    var monster = MonsterBuilder.Goblin().Build();

    // Act - Execute the method under test
    var result = _combatService.ResolveCombatRound(player, monster);

    // Assert - Verify the results
    result.DamageDealt.Should().BeGreaterThan(0);
    monster.Health.Should().BeLessThan(30);
}
```

### 5.2 Parameterized Tests

Use `[TestCase]` for testing multiple scenarios:

```csharp
[TestCase(10, 5, 5)]   // damage = attack - defense
[TestCase(5, 10, 0)]   // minimum 0 damage
[TestCase(20, 0, 20)]  // no defense
public void CalculateDamage_WithVariousStats_ReturnsExpectedDamage(
    int attack, int defense, int expectedDamage)
{
    // Arrange
    var result = _combatService.CalculateDamage(attack, defense);

    // Assert
    result.Should().Be(expectedDamage);
}
```

### 5.3 Exception Testing

```csharp
[Test]
public void Create_WithNullId_ThrowsArgumentException()
{
    // Arrange & Act
    var act = () => MonsterDefinition.Create(
        id: null!,
        name: "Test",
        description: "Test",
        examineText: "Test",
        baseHealth: 50,
        baseAttack: 10,
        baseDefense: 5,
        baseExperienceValue: 25);

    // Assert
    act.Should().Throw<ArgumentException>()
        .WithParameterName("id");
}
```

### 5.4 Async Test Pattern

```csharp
[Test]
public async Task SaveAsync_WithValidSession_PersistsToRepository()
{
    // Arrange
    var session = GameSessionBuilder.Create().Build();

    // Act
    await _repository.SaveAsync(session, CancellationToken.None);

    // Assert
    var loaded = await _repository.GetByIdAsync(session.Id, CancellationToken.None);
    loaded.Should().NotBeNull();
    loaded!.Id.Should().Be(session.Id);
}
```

---

## 6. Test Categories

### 6.1 Test Categories by Layer

| Category | Attribute | Description |
|----------|-----------|-------------|
| Domain | `[Category("Domain")]` | Entity, value object, domain service tests |
| Application | `[Category("Application")]` | Application service tests |
| Architecture | `[Category("Architecture")]` | Layer dependency tests |
| Integration | `[Category("Integration")]` | Cross-layer integration tests |

### 6.2 Test Categories by Speed

| Category | Attribute | Max Duration |
|----------|-----------|--------------|
| Fast | `[Category("Fast")]` | < 100ms |
| Normal | (default) | < 1s |
| Slow | `[Category("Slow")]` | > 1s |

### 6.3 Usage Example

```csharp
[TestFixture]
[Category("Domain")]
public class PlayerTests
{
    [Test]
    [Category("Fast")]
    public void Constructor_WithValidName_CreatesPlayer()
    {
        // ...
    }
}
```

---

## 7. Test Requirements by System

### 7.1 v0.0.5 Dice Pool System Tests

| Component | Required Tests | Priority |
|-----------|----------------|----------|
| DicePool.Create() | Valid/invalid parameters | High |
| DicePool.Parse() | Notation parsing (3d6+5, 1d10, 2d8!) | High |
| DiceRollResult properties | IsNaturalMax, IsNaturalOne | Medium |
| DiceService.Roll() | Basic rolling, advantage, disadvantage | High |
| DiceService exploding dice | Explosion triggers, max explosions | Medium |
| SkillDefinition.Create() | Validation tests | High |
| SkillCheckService | Check execution, critical success/failure | High |

### 7.2 v0.0.6 Enhanced Combat System Tests

| Component | Required Tests | Priority |
|-----------|----------------|----------|
| CombatEncounter creation | Valid scenarios | High |
| Initiative rolling | Roll mechanics, tie-breaking | High |
| Turn order | Order determination, advancement | High |
| Target selection | By name, by number, invalid targets | High |
| AIBehavior decisions | All behavior types | High |
| Flee mechanics | Success/failure, opportunity attacks | Medium |
| StatusEffectDefinition | Creation, validation | High |
| StatusEffectService | Apply, remove, tick | High |
| Effect stacking | Refresh vs block rules | Medium |
| Effect interactions | Wet+Lightning, etc. | Medium |

### 7.3 v0.0.7 Equipment System Tests

| Component | Required Tests | Priority |
|-----------|----------------|----------|
| EquipmentSlot | Valid/invalid slots | High |
| Equipment equip/unequip | Slot validation | High |
| Stat bonuses | Calculation accuracy | High |
| Weapon damage dice | Integration with combat | High |
| Armor defense | Integration with damage | High |

### 7.4 v0.0.8 Experience & Leveling Tests

| Component | Required Tests | Priority |
|-----------|----------------|----------|
| XP gain | From monster defeat | High |
| Level calculation | XP thresholds | High |
| Level up process | Stat gains, ability unlocks | High |
| Progression table | Configuration loading | Medium |

### 7.5 v0.0.9 Monster Variety & Loot Tests

| Component | Required Tests | Priority |
|-----------|----------------|----------|
| MonsterDefinition.Create() | Validation tests | High |
| MonsterService.SpawnMonster() | Valid/invalid IDs | High |
| MonsterService.SpawnRandomMonster() | Weighted selection | Medium |
| DamageTypeDefinition | Creation, validation | High |
| DamageCalculationService | Resistance/vulnerability | High |
| TierDefinition | Multiplier application | High |
| LootTable.Roll() | Drop chance, quantities | High |
| LootService | Generation, collection | High |

---

## 8. Acceptance Criteria

### 8.1 Functional Requirements

- [ ] All v0.0.5 tests defined in design spec pass
- [ ] All v0.0.6 tests defined in design spec pass
- [ ] All v0.0.7 tests defined in design spec pass
- [ ] All v0.0.8 tests defined in design spec pass
- [ ] All v0.0.9 tests defined in design spec pass
- [ ] Test utilities (builders, mocks) are reusable
- [ ] Tests follow naming conventions
- [ ] Tests are organized by layer and component

### 8.2 Non-Functional Requirements

- [ ] All unit tests run in < 30 seconds total
- [ ] Individual tests run in < 1 second
- [ ] Tests are independent (no shared state)
- [ ] Tests are deterministic (no random failures)
- [ ] Tests have clear failure messages

---

## 9. Test Specifications (v0.0.10b Framework Tests)

### 9.1 Builder Tests (~5 tests)

| Test Name | Description |
|-----------|-------------|
| `PlayerBuilder_Build_CreatesValidPlayer` | Default builder creates player |
| `PlayerBuilder_WithStats_SetsCorrectValues` | Stats are applied |
| `PlayerBuilder_WithResource_InitializesPool` | Resource pools work |
| `MonsterBuilder_Goblin_CreatesGoblinPreset` | Preset works |
| `MonsterBuilder_WithCurrentHealth_DamagesCorrectly` | Health setting works |

### 9.2 Mock Provider Tests (~5 tests)

| Test Name | Description |
|-----------|-------------|
| `MockConfigurationProvider_WithClass_ReturnsClass` | Class retrieval works |
| `MockConfigurationProvider_WithAbility_ReturnsAbility` | Ability retrieval works |
| `MockConfigurationProvider_GetClassById_FindsClass` | Lookup by ID works |
| `MockConfigurationProvider_WithDefaultResourceTypes_AddsAll` | Default types added |
| `MockConfigurationProvider_GetAbilitiesForClass_FiltersCorrectly` | Class filtering works |

### 9.3 Test Utility Tests (~5 tests)

| Test Name | Description |
|-----------|-------------|
| `SeededRandom_Create_ProducesDeterministicValues` | Same seed = same values |
| `SeededRandom_DifferentSeeds_ProduceDifferentValues` | Different seeds differ |
| `TestFixtureBase_SetUp_InitializesProviders` | Base setup works |
| `TestFixtureBase_GetTestLogger_ReturnsLogger` | Logger retrieval works |
| `TestFixtureBase_VerifyLog_FindsMessage` | Log verification works |

---

## 10. Dependencies

### 10.1 Required Prior Work

| Dependency | Version | Status | Notes |
|------------|---------|--------|-------|
| v0.0.5-v0.0.9 | All | Required | Systems to test |
| v0.0.10a | Logging | Required | TestLogger utilities |
| NUnit | 4.x | Complete | Test framework |
| FluentAssertions | 6.x | Complete | Assertions |
| Moq | 4.x | Complete | Mocking |

### 10.2 NuGet Packages

| Package | Project | Purpose |
|---------|---------|---------|
| NUnit | All test projects | Test framework |
| NUnit3TestAdapter | All test projects | IDE integration |
| FluentAssertions | All test projects | Fluent assertions |
| Moq | Application tests | Mocking interfaces |
| coverlet.collector | All test projects | Coverage collection |

---

## 11. Files Summary

### 11.1 New Files

| File | Purpose |
|------|---------|
| `tests/RuneAndRust.TestUtilities/RuneAndRust.TestUtilities.csproj` | Test utilities project |
| `tests/RuneAndRust.TestUtilities/Builders/PlayerBuilder.cs` | Player builder |
| `tests/RuneAndRust.TestUtilities/Builders/MonsterBuilder.cs` | Monster builder |
| `tests/RuneAndRust.TestUtilities/Builders/RoomBuilder.cs` | Room builder |
| `tests/RuneAndRust.TestUtilities/Builders/GameSessionBuilder.cs` | GameSession builder |
| `tests/RuneAndRust.TestUtilities/Mocks/MockConfigurationProvider.cs` | Mock config provider |
| `tests/RuneAndRust.TestUtilities/Mocks/MockRepository.cs` | Mock repository |
| `tests/RuneAndRust.TestUtilities/Fixtures/TestFixtureBase.cs` | Base fixture class |
| `tests/RuneAndRust.TestUtilities/SeededRandom.cs` | Deterministic random |
| `tests/RuneAndRust.TestUtilities/Builders/BuilderTests.cs` | Builder tests |
| `tests/RuneAndRust.TestUtilities/Mocks/MockProviderTests.cs` | Mock tests |

### 11.2 Modified Files

| File | Changes |
|------|---------|
| `RuneAndRust.sln` | Add TestUtilities project |
| `RuneAndRust.Domain.UnitTests.csproj` | Reference TestUtilities |
| `RuneAndRust.Application.UnitTests.csproj` | Reference TestUtilities |
| Existing test files | Refactor to use builders |

---

## 12. Future Considerations

### 12.1 Code Coverage Reporting

Consider adding:
- `coverlet.msbuild` for coverage during build
- Coverage thresholds in CI/CD pipeline
- Coverage badge in README

### 12.2 Mutation Testing

Consider adding `Stryker.NET` for mutation testing to verify test quality.

### 12.3 Performance Testing

Future versions may add performance test project for:
- Load testing dice rolling
- Combat simulation benchmarks
- Configuration loading performance

---

*This design specification establishes test infrastructure and standards for comprehensive coverage of all game systems. The test utilities created here enable faster test authoring while maintaining consistency across the test suite.*
