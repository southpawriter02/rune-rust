> **Archived** - This changelog has been consolidated. See the complete version at [v0.2.1](../v0.2.x/v0.2.1.md).

# Changelog: v0.2.1c - The Visuals (Combat UI Updates)

**Release Date:** 2025-12-20
**Codename:** The Visuals
**Test Coverage:** 1343 tests passing (+16 from v0.2.1b)
**Build Status:** SUCCESS

---

## Summary

This release updates the Terminal UI to visualize the mechanics introduced in v0.2.1a (Equipment/Loot) and v0.2.1b (Status Effects). The combat turn order table now displays a Status column showing active debuffs and buffs. A new VictoryScreen displays loot drops and XP rewards after successful combat before returning to exploration mode.

### Key Features
- **Status Column in Combat**: 4th column in turn order table showing effect icons (BLD, PSN, STUN, VULN, FRT, HAST, INSP)
- **Victory Screen**: Dedicated post-combat screen displaying XP earned and loot found
- **Quality-Based Loot Coloring**: Items colored by quality tier (grey→white→green→blue→magenta)
- **Seamless Integration**: Victory screen triggers automatically on combat victory

### Architectural Overview

```
┌─────────────────┐     ┌──────────────────────┐     ┌─────────────────────┐
│   GameService   │────▶│   CommandParser      │────▶│   CombatService     │
│   (Game Loop)   │     │   (ExecuteAttack)    │     │   (EndCombat)       │
└─────────────────┘     └──────────────────────┘     └─────────────────────┘
         │                        │                            │
         ▼                        ▼                            ▼
┌─────────────────┐     ┌──────────────────────┐     ┌─────────────────────┐
│ CombatScreen    │     │  VictoryScreen       │     │   CombatResult      │
│ Renderer        │     │  Renderer            │◄────│   (Victory/Loot)    │
│ (+Status Col)   │     │  (Loot + XP)         │     └─────────────────────┘
└─────────────────┘     └──────────────────────┘
```

---

## Files Created

| File Path | Description |
|-----------|-------------|
| `RuneAndRust.Core/Interfaces/IVictoryScreenRenderer.cs` | Interface defining the victory screen contract |
| `RuneAndRust.Terminal/Services/VictoryScreenRenderer.cs` | Implementation rendering loot/XP with Spectre.Console |
| `RuneAndRust.Tests/Terminal/VictoryScreenRendererTests.cs` | 16 unit tests for color mapping and validation |

---

## Files Modified

| File Path | Changes |
|-----------|---------|
| `RuneAndRust.Terminal/Services/CombatScreenRenderer.cs` | Added "Status" column to `RenderTurnOrder` table |
| `RuneAndRust.Engine/Services/CommandParser.cs` | Added `IVictoryScreenRenderer` field and constructor parameter; triggers victory screen on combat end |
| `RuneAndRust.Terminal/Program.cs` | Registered `IVictoryScreenRenderer` in DI container |
| `RuneAndRust.Tests/RuneAndRust.Tests.csproj` | Added project reference to `RuneAndRust.Terminal` |

---

## Code Implementation Details

### IVictoryScreenRenderer Interface

```csharp
namespace RuneAndRust.Core.Interfaces;

using RuneAndRust.Core.Models.Combat;

/// <summary>
/// Defines the contract for rendering the post-combat victory screen.
/// </summary>
public interface IVictoryScreenRenderer
{
    /// <summary>
    /// Renders the victory screen with loot and XP rewards.
    /// Blocks until the player acknowledges the screen.
    /// </summary>
    void Render(CombatResult result);
}
```

### VictoryScreenRenderer Implementation

```csharp
public class VictoryScreenRenderer : IVictoryScreenRenderer
{
    private readonly ILogger<VictoryScreenRenderer> _logger;

    public void Render(CombatResult result)
    {
        _logger.LogInformation(
            "Rendering victory screen. Victory: {Victory}, XP: {Xp}, Loot: {Count}",
            result.Victory, result.XpEarned, result.LootFound.Count);

        AnsiConsole.Clear();

        // Victory Banner
        RenderVictoryBanner();

        // XP Earned
        RenderXpSection(result.XpEarned);

        // Loot Table
        if (result.LootFound.Count > 0)
        {
            RenderLootTable(result.LootFound);
        }
        else
        {
            AnsiConsole.MarkupLine("\n[grey]No loot found.[/]");
        }

        // Continue prompt
        AnsiConsole.MarkupLine("[grey]Press any key to continue...[/]");
        Console.ReadKey(true);

        _logger.LogTrace("Victory screen rendered and dismissed");
    }
}
```

### Quality Tier Color Mapping

```csharp
public static string GetQualityColor(QualityTier quality) => quality switch
{
    QualityTier.JuryRigged => "grey",    // Lowest tier - scrap
    QualityTier.Scavenged => "white",    // Common finds
    QualityTier.ClanForged => "green",   // Quality crafted
    QualityTier.Optimized => "blue",     // Rare/enhanced
    QualityTier.MythForged => "magenta", // Legendary tier
    _ => "white"
};
```

### Updated RenderTurnOrder with Status Column

```csharp
private static void RenderTurnOrder(List<CombatantView> turnOrder)
{
    var table = new Table()
        .Border(TableBorder.Rounded)
        .BorderColor(Color.Grey)
        .Expand();

    table.AddColumn(new TableColumn("[grey]Init[/]").Centered().Width(6));
    table.AddColumn(new TableColumn("[grey]Name[/]").Width(20));
    table.AddColumn(new TableColumn("[grey]Condition[/]").Width(12));
    table.AddColumn(new TableColumn("[grey]Status[/]").Width(18));  // NEW

    foreach (var combatant in turnOrder)
    {
        var turnMarker = combatant.IsActive ? "[bold yellow]>[/] " : "  ";
        var nameColor = combatant.IsPlayer ? "cyan" : "red";
        var nameMarkup = $"{turnMarker}[{nameColor}]{EscapeMarkup(combatant.Name)}[/]";

        var healthDisplay = combatant.IsPlayer
            ? $"[green]{combatant.HealthStatus}[/]"
            : combatant.HealthStatus;

        // StatusEffects already contain Spectre markup from MapToView
        var statusDisplay = combatant.StatusEffects;

        table.AddRow(
            $"[grey]{combatant.InitiativeDisplay}[/]",
            nameMarkup,
            healthDisplay,
            statusDisplay  // NEW
        );
    }

    AnsiConsole.Write(table);
}
```

### CommandParser Victory Screen Integration

```csharp
// Field
private readonly IVictoryScreenRenderer? _victoryRenderer;

// Constructor
public CommandParser(
    ILogger<CommandParser> logger,
    IInputHandler inputHandler,
    GameState gameState,
    IJournalService? journalService = null,
    ICombatService? combatService = null,
    IVictoryScreenRenderer? victoryRenderer = null)  // NEW
{
    // ... existing assignments ...
    _victoryRenderer = victoryRenderer;
}

// ExecuteCombatAttack victory handling
if (_gameState.CombatState == null || _combatService.CheckVictoryCondition())
{
    var combatResult = _combatService.EndCombat();

    // Display victory screen with loot/XP if victory and renderer available
    if (combatResult != null && combatResult.Victory && _victoryRenderer != null)
    {
        _victoryRenderer.Render(combatResult);
    }
    else
    {
        _inputHandler.DisplayMessage("");
        _inputHandler.DisplayMessage("Combat has ended. Returning to exploration.");
    }

    return new ParseResult { RequiresLook = true };
}
```

---

## UI Examples

### Combat Turn Order Table (with Status Column)

```
╭──────┬──────────────────────┬──────────────┬──────────────────╮
│ Init │ Name                 │ Condition    │ Status           │
├──────┼──────────────────────┼──────────────┼──────────────────┤
│  18  │ > Player             │ Healthy      │ FRT×2            │
│  15  │   Goblin Warrior     │ Wounded      │ BLD×3            │
│  12  │   Rusty Automaton    │ Critical     │ PSN×1 VULN       │
╰──────┴──────────────────────┴──────────────┴──────────────────╯
```

### Victory Screen

```
────────────────────── VICTORY ──────────────────────

  Experience Earned: +75 XP

  Loot Found:

╭─────────────────────────┬────────────┬──────────┬────────╮
│ Item                    │ Quality    │ Type     │ Value  │
├─────────────────────────┼────────────┼──────────┼────────┤
│ Rusty Iron Sword        │ JuryRigged │ Weapon   │   15   │
│ Clan-Forged Shield      │ ClanForged │ Armor    │   45   │
│ Blight-Touched Amulet   │ Optimized  │ Trinket  │   80   │
╰─────────────────────────┴────────────┴──────────┴────────╯

Press any key to continue...
```

---

## Logging Matrix

| Event | Level | Template |
|-------|-------|----------|
| Victory screen start | Information | `"Rendering victory screen. Victory: {Victory}, XP: {Xp}, Loot: {Count}"` |
| Loot item rendered | Debug | `"Rendered loot: {Name} ({Quality})"` |
| Screen dismissed | Trace | `"Victory screen rendered and dismissed"` |
| Combat screen render | Trace | `"Rendered combat screen"` |

---

## Test Coverage

### VictoryScreenRendererTests.cs (16 tests)

#### GetQualityColor Tests
- `GetQualityColor_JuryRigged_ReturnsGrey`
- `GetQualityColor_Scavenged_ReturnsWhite`
- `GetQualityColor_ClanForged_ReturnsGreen`
- `GetQualityColor_Optimized_ReturnsBlue`
- `GetQualityColor_MythForged_ReturnsMagenta`
- `GetQualityColor_UndefinedValue_ReturnsWhite`
- `GetQualityColor_AllTiers_ReturnExpectedColors` (Theory with 5 cases)

#### Constructor Tests
- `Constructor_WithValidLogger_CreatesInstance`

#### CombatResult Validation Tests
- `CombatResult_WithEmptyLoot_IsValid`
- `CombatResult_WithLoot_ContainsItems`

#### Color Consistency Tests
- `GetQualityColor_SameTier_ReturnsSameColor`
- `GetQualityColor_DifferentTiers_ReturnDifferentColors`

---

## DI Registration

```csharp
// Register Combat Services
services.AddSingleton<IInitiativeService, InitiativeService>();
services.AddSingleton<IStatusEffectService, StatusEffectService>();
services.AddSingleton<IAttackResolutionService, AttackResolutionService>();
services.AddScoped<ILootService, LootService>();
services.AddSingleton<ICombatService, CombatService>();
services.AddSingleton<ICombatScreenRenderer, CombatScreenRenderer>();
services.AddSingleton<IVictoryScreenRenderer, VictoryScreenRenderer>();  // NEW
```

---

## Breaking Changes

### Constructor Signature Changes

**CommandParser** - Added `IVictoryScreenRenderer` parameter:
```csharp
// Before
public CommandParser(
    ILogger<CommandParser> logger,
    IInputHandler inputHandler,
    GameState gameState,
    IJournalService? journalService = null,
    ICombatService? combatService = null)

// After
public CommandParser(
    ILogger<CommandParser> logger,
    IInputHandler inputHandler,
    GameState gameState,
    IJournalService? journalService = null,
    ICombatService? combatService = null,
    IVictoryScreenRenderer? victoryRenderer = null)  // NEW
```

---

## Directory Structure Changes

```
RuneAndRust.Core/Interfaces/
├── IVictoryScreenRenderer.cs          [NEW]
├── ICombatScreenRenderer.cs
├── ICombatService.cs
└── ...

RuneAndRust.Terminal/Services/
├── VictoryScreenRenderer.cs           [NEW]
├── CombatScreenRenderer.cs            [MODIFIED - Status column]
├── TerminalInputHandler.cs
└── ...

RuneAndRust.Engine/Services/
├── CommandParser.cs                   [MODIFIED - Victory trigger]
├── CombatService.cs
└── ...

RuneAndRust.Tests/
├── Terminal/                          [NEW FOLDER]
│   └── VictoryScreenRendererTests.cs  [NEW - 16 tests]
├── Engine/
└── ...
```

---

## Build Verification

```bash
$ dotnet build
Build succeeded.
63 Warning(s) - Pre-existing xUnit async warnings
0 Error(s)

$ dotnet test
Passed!  - Failed: 0, Passed: 1343, Skipped: 0, Total: 1343, Duration: 573 ms
```

---

## Upgrade Notes

1. **DI Container**: If manually constructing `CommandParser`, add the optional `IVictoryScreenRenderer` parameter or pass `null`.

2. **Test Projects**: Add project reference to `RuneAndRust.Terminal` if testing Terminal components:
   ```xml
   <ProjectReference Include="..\RuneAndRust.Terminal\RuneAndRust.Terminal.csproj" />
   ```

3. **Combat Flow**: Victory screen now displays automatically after defeating all enemies. No action required from calling code.

---

## Related Releases

- **v0.2.1a** (The Armory): Equipment and Loot systems
- **v0.2.1b** (The Affliction): Status Effect system
- **v0.2.1c** (The Visuals): UI display for both systems

---

**v0.2.1c Codename: The Visuals**
*"See the battle unfold. Watch the loot gleam."*
