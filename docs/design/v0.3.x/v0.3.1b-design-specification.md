# v0.3.1b Design Specification: Quest Giver NPCs

## Overview

**Version:** 0.3.1b
**Parent:** v0.3.1 (Quest Rewards & NPCs)
**Prerequisites:** v0.3.1a Complete (Reward System)
**Status:** Design Complete
**Estimated Unit Tests:** ~25

---

## Table of Contents

1. [Executive Summary](#1-executive-summary)
2. [Feature Overview](#2-feature-overview)
3. [Architecture Diagrams](#3-architecture-diagrams)
4. [User Stories](#4-user-stories)
5. [Data Models](#5-data-models)
6. [Configuration Schemas](#6-configuration-schemas)
7. [Service Specifications](#7-service-specifications)
8. [User-Facing Changes](#8-user-facing-changes)
9. [Logging Requirements](#9-logging-requirements)
10. [Unit Test Specifications](#10-unit-test-specifications)
11. [Use Cases](#11-use-cases)
12. [Acceptance Criteria](#12-acceptance-criteria)
13. [Deliverable Checklist](#13-deliverable-checklist)
14. [Dependencies](#14-dependencies)
15. [Future Considerations](#15-future-considerations)

---

## 1. Executive Summary

This phase enhances NPCs with quest giver capabilities, enabling them to track offered quests, display visual indicators for quest availability, and integrate with the dialogue system for quest acceptance and turn-in. Players can identify quest givers in room descriptions through visual markers ([!], [?], [...]) and interact with them through dialogue to accept new quests or turn in completed ones.

### Key Deliverables

| Category | Items |
|----------|-------|
| **Enums** | QuestIndicator |
| **NPC Updates** | OfferedQuestIds, IsQuestGiver, GetQuestIndicator, GetAvailableQuests, GetTurnInQuests |
| **Dialogue Updates** | Quest-aware dialogue options |
| **Room Display** | NPC indicators in descriptions |
| **Tests** | ~25 new unit tests |

### Architectural Significance

This version establishes the **quest giver pattern** that will be extended throughout future versions:
- NPCs as quest providers with tracked quest lists
- Visual quest indicators in room descriptions
- Dialogue integration for quest management
- Foundation for prerequisites (v0.3.1c) and quest chains (v0.3.2)

---

## 2. Feature Overview

```
v0.3.1b Features
├── QuestIndicator Enum
│   ├── None (no indicator)
│   ├── Available [!] (new quest)
│   ├── InProgress [...] (active quest)
│   ├── ReadyToTurnIn [?] (completable)
│   └── Repeatable (future use)
├── NPC Entity Updates
│   ├── OfferedQuestIds collection
│   ├── IsQuestGiver property
│   ├── GetQuestIndicator() method
│   ├── GetAvailableQuests() method
│   └── GetTurnInQuests() method
├── Room Description Updates
│   ├── NPC list with indicators
│   └── Priority-based indicator display
├── Dialogue Integration
│   ├── Available quest list in dialogue
│   ├── Turn-in quest list in dialogue
│   ├── Accept quest option
│   └── Turn-in quest option
└── Configuration Updates
    └── NPC offeredQuestIds in npcs.json
```

---

## 3. Architecture Diagrams

### 3.1 Layer Diagram

```
┌─────────────────────────────────────────────────────────────────────────┐
│                         PRESENTATION LAYER                              │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │                    IGameRenderer (updated)                       │   │
│  ├─────────────────────────────────────────────────────────────────┤   │
│  │ RenderRoomAsync(RoomDto)           // NPCs with indicators      │   │
│  │ RenderDialogueAsync(DialogueDto)   // quest options             │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                         APPLICATION LAYER                               │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │                    NpcDisplayDto (updated)                       │   │
│  ├─────────────────────────────────────────────────────────────────┤   │
│  │ + QuestIndicator: QuestIndicator                    // NEW      │   │
│  │ + IndicatorString: string                           // NEW      │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │                    QuestGiverDialogueDto (new)                   │   │
│  ├─────────────────────────────────────────────────────────────────┤   │
│  │ + NpcName: string                                               │   │
│  │ + Greeting: string                                              │   │
│  │ + AvailableQuests: IReadOnlyList<QuestOfferDto>                │   │
│  │ + TurnInQuests: IReadOnlyList<QuestTurnInDto>                  │   │
│  │ + DialogueOptions: IReadOnlyList<DialogueOptionDto>            │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                           DOMAIN LAYER                                  │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  ENUMS                                                                  │
│  ┌────────────────────────┐                                            │
│  │    QuestIndicator      │                                            │
│  ├────────────────────────┤                                            │
│  │ None                   │                                            │
│  │ Available              │                                            │
│  │ InProgress             │                                            │
│  │ ReadyToTurnIn          │                                            │
│  │ Repeatable             │                                            │
│  └────────────────────────┘                                            │
│                                                                         │
│  ENTITY UPDATES                                                         │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │                         NPC (updated)                            │   │
│  ├─────────────────────────────────────────────────────────────────┤   │
│  │ + OfferedQuestIds: IReadOnlyList<string>            // NEW      │   │
│  │ + IsQuestGiver: bool                                // NEW      │   │
│  │ + GetQuestIndicator(player, questService): QuestIndicator // NEW│   │
│  │ + GetAvailableQuests(player, questService): IEnumerable  // NEW │   │
│  │ + GetTurnInQuests(player, questService): IEnumerable     // NEW │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                        INFRASTRUCTURE LAYER                             │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  Configuration Files:                                                   │
│  └── config/npcs.json (updated with offeredQuestIds)                   │
│                                                                         │
│  DTOs for Deserialization:                                              │
│  └── NpcConfigDto (updated with offeredQuestIds)                       │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

### 3.2 Quest Indicator Priority

```
┌─────────────────────────────────────────────────────────────────────────┐
│                    QUEST INDICATOR PRIORITY                             │
└─────────────────────────────────────────────────────────────────────────┘

    ┌───────────────────────────────────────────────────────────────┐
    │                 Indicator Selection Flow                       │
    │                   (highest priority first)                     │
    ├───────────────────────────────────────────────────────────────┤
    │                                                               │
    │  1. ReadyToTurnIn [?]  ◄── Quest complete, ready to turn in  │
    │         │                                                      │
    │         ▼                                                      │
    │  2. InProgress [...]   ◄── Player has active quest from NPC  │
    │         │                                                      │
    │         ▼                                                      │
    │  3. Available [!]      ◄── NPC has new quest for player      │
    │         │                                                      │
    │         ▼                                                      │
    │  4. None               ◄── No quest interaction available     │
    │                                                               │
    └───────────────────────────────────────────────────────────────┘
```

### 3.3 NPC Quest Flow

```
┌─────────────────────────────────────────────────────────────────────────┐
│                      NPC QUEST INTERACTION FLOW                         │
└─────────────────────────────────────────────────────────────────────────┘

    Player enters room
           │
           ▼
    ┌─────────────────────────────────────────────────────────────────┐
    │                     ROOM DESCRIPTION                             │
    │  Shows NPCs with quest indicators based on player state         │
    │  Example: "Guard Captain [!]" or "Merchant [?]"                 │
    └─────────────────────────────────────────────────────────────────┘
           │
           ▼
    Player uses "talk <npc>" command
           │
           ▼
    ┌─────────────────────────────────────────────────────────────────┐
    │                     DIALOGUE SCREEN                              │
    │  ┌─────────────────────────────────────────────────────────┐    │
    │  │  NPC Greeting                                            │    │
    │  ├─────────────────────────────────────────────────────────┤    │
    │  │  [QUESTS AVAILABLE] (if any)                            │    │
    │  │    [!] Quest Name 1 (New)                               │    │
    │  │    [!] Quest Name 2 (New)                               │    │
    │  ├─────────────────────────────────────────────────────────┤    │
    │  │  [QUEST READY TO TURN IN] (if any)                      │    │
    │  │    [?] Quest Name                                        │    │
    │  ├─────────────────────────────────────────────────────────┤    │
    │  │  Dialogue Options:                                       │    │
    │  │  [1] Tell me about Quest 1                              │    │
    │  │  [2] [Accept: Quest 1]                                   │    │
    │  │  [3] [Turn In: Quest Name]                              │    │
    │  │  [4] Just checking in.                                   │    │
    │  └─────────────────────────────────────────────────────────┘    │
    └─────────────────────────────────────────────────────────────────┘
           │
           ├─── Accept Quest ───▶ Quest added to journal, status Active
           │
           └─── Turn In Quest ──▶ Quest marked complete (rewards v0.3.1c)
```

---

## 4. User Stories

### US-3.1b-1: Identify Quest Givers in Room
**As a** player
**I want to** see visual indicators on NPCs that have quests
**So that** I can quickly identify who to talk to for quests

**Acceptance Criteria:**
- [!] indicator shows for NPCs with available quests
- [?] indicator shows for NPCs with turn-in ready quests
- [...] indicator shows for NPCs with in-progress quests
- Indicators appear in room description NPC list

### US-3.1b-2: View Available Quests in Dialogue
**As a** player
**I want to** see what quests an NPC offers when I talk to them
**So that** I can decide which quests to accept

**Acceptance Criteria:**
- Available quests listed at top of dialogue
- Each quest shows name and "New" indicator
- Dialogue options include "Tell me about" for each quest
- Dialogue options include "Accept" for each quest

### US-3.1b-3: Accept Quest from NPC
**As a** player
**I want to** accept quests through dialogue
**So that** I can add quests to my journal

**Acceptance Criteria:**
- Accept option available for each new quest
- Selecting accept adds quest to journal
- Quest status set to Active
- NPC indicator updates after acceptance

### US-3.1b-4: Turn In Completed Quest
**As a** player
**I want to** turn in completed quests to NPCs
**So that** I can complete the quest

**Acceptance Criteria:**
- Turn-in option appears when quest is completable
- Selecting turn-in marks quest as complete
- NPC dialogue acknowledges completion
- Indicator updates after turn-in

### US-3.1b-5: Configure Quest Givers
**As a** game designer
**I want to** configure which NPCs offer which quests
**So that** I can assign quests to appropriate NPCs

**Acceptance Criteria:**
- NPCs have offeredQuestIds array in configuration
- Multiple quests can be assigned to one NPC
- Same quest can be assigned to different NPCs
- Invalid quest IDs logged as warnings

---

## 5. Data Models

### 5.1 QuestIndicator Enum

```csharp
namespace RuneAndRust.Domain.Enums;

/// <summary>
/// Visual indicator for NPC quest status.
/// </summary>
/// <remarks>
/// QuestIndicator represents the visual marker shown next to an NPC's name
/// in room descriptions and dialogue. The indicator is calculated based on
/// the player's quest state with the NPC.
/// </remarks>
public enum QuestIndicator
{
    /// <summary>
    /// No quest-related indicator.
    /// </summary>
    /// <remarks>
    /// The NPC has no quest interactions available for this player.
    /// Either the NPC offers no quests, or all available quests have
    /// been completed.
    /// </remarks>
    None,

    /// <summary>
    /// NPC has a new quest available.
    /// </summary>
    /// <remarks>
    /// Displayed as [!] in room descriptions and dialogue.
    /// Indicates the player can accept a new quest from this NPC.
    /// </remarks>
    Available,

    /// <summary>
    /// NPC has a quest in progress.
    /// </summary>
    /// <remarks>
    /// Displayed as [...] in room descriptions and dialogue.
    /// The player has an active quest from this NPC but cannot turn it in yet.
    /// </remarks>
    InProgress,

    /// <summary>
    /// NPC has a quest ready to turn in.
    /// </summary>
    /// <remarks>
    /// Displayed as [?] in room descriptions and dialogue.
    /// The player has completed a quest that turns in to this NPC.
    /// This takes priority over InProgress.
    /// </remarks>
    ReadyToTurnIn,

    /// <summary>
    /// NPC has a repeatable quest available.
    /// </summary>
    /// <remarks>
    /// Future use for daily/weekly repeatable quests.
    /// May display differently from standard Available indicator.
    /// </remarks>
    Repeatable
}
```

### 5.2 QuestIndicator Extensions

```csharp
namespace RuneAndRust.Domain.Extensions;

/// <summary>
/// Extension methods for QuestIndicator enum.
/// </summary>
public static class QuestIndicatorExtensions
{
    /// <summary>
    /// Gets the display string for a quest indicator.
    /// </summary>
    /// <param name="indicator">The quest indicator.</param>
    /// <returns>The display string (e.g., "[!]", "[?]", "[...]").</returns>
    public static string ToDisplayString(this QuestIndicator indicator)
    {
        return indicator switch
        {
            QuestIndicator.Available => "[!]",
            QuestIndicator.ReadyToTurnIn => "[?]",
            QuestIndicator.InProgress => "[...]",
            QuestIndicator.Repeatable => "[!]",
            _ => string.Empty
        };
    }

    /// <summary>
    /// Gets whether the indicator should be displayed.
    /// </summary>
    /// <param name="indicator">The quest indicator.</param>
    /// <returns>True if the indicator has a visual representation.</returns>
    public static bool HasDisplay(this QuestIndicator indicator)
    {
        return indicator != QuestIndicator.None;
    }

    /// <summary>
    /// Gets the priority of the indicator for sorting.
    /// </summary>
    /// <param name="indicator">The quest indicator.</param>
    /// <returns>Priority value (lower = higher priority).</returns>
    /// <remarks>
    /// ReadyToTurnIn has highest priority (1), then Available (2),
    /// then InProgress (3), then None (4).
    /// </remarks>
    public static int GetPriority(this QuestIndicator indicator)
    {
        return indicator switch
        {
            QuestIndicator.ReadyToTurnIn => 1,
            QuestIndicator.Available => 2,
            QuestIndicator.Repeatable => 2,
            QuestIndicator.InProgress => 3,
            _ => 4
        };
    }
}
```

### 5.3 NPC Entity Updates

```csharp
// Additions to existing NPC entity in RuneAndRust.Domain.Entities

/// <summary>
/// Gets the quest definition IDs this NPC offers.
/// </summary>
/// <remarks>
/// Contains the IDs of quests this NPC can give to players.
/// Loaded from NPC configuration.
/// </remarks>
public IReadOnlyList<string> OfferedQuestIds { get; private set; } = Array.Empty<string>();

/// <summary>
/// Gets whether this NPC has quests to offer.
/// </summary>
/// <remarks>
/// Returns true if OfferedQuestIds contains any entries.
/// </remarks>
public bool IsQuestGiver => OfferedQuestIds.Count > 0;

/// <summary>
/// Gets the quest indicator for display.
/// </summary>
/// <param name="player">The player to check quest state for.</param>
/// <param name="questService">The quest service for quest lookups.</param>
/// <returns>The appropriate quest indicator.</returns>
/// <remarks>
/// Indicators are checked in priority order:
/// 1. ReadyToTurnIn - if any quest can be turned in
/// 2. InProgress - if player has active quest from this NPC
/// 3. Available - if any new quests are available
/// 4. None - no quest interaction available
/// </remarks>
public QuestIndicator GetQuestIndicator(Player player, IQuestService questService)
{
    ArgumentNullException.ThrowIfNull(player);
    ArgumentNullException.ThrowIfNull(questService);

    if (!IsQuestGiver)
        return QuestIndicator.None;

    // Check for ready to turn in first (highest priority)
    foreach (var questId in OfferedQuestIds)
    {
        var quest = questService.GetQuestByDefinition(player.Id, questId);
        if (quest != null && quest.CanTurnIn() && quest.TurnInNpcId == DefinitionId)
            return QuestIndicator.ReadyToTurnIn;
    }

    // Check for in-progress quests
    foreach (var questId in OfferedQuestIds)
    {
        var quest = questService.GetQuestByDefinition(player.Id, questId);
        if (quest != null && quest.Status == QuestStatus.Active)
            return QuestIndicator.InProgress;
    }

    // Check for available quests
    foreach (var questId in OfferedQuestIds)
    {
        if (!questService.HasActiveQuest(player.Id, questId) &&
            !player.HasCompletedQuest(questId))
            return QuestIndicator.Available;
    }

    return QuestIndicator.None;
}

/// <summary>
/// Gets available quests for a player.
/// </summary>
/// <param name="player">The player to check availability for.</param>
/// <param name="questService">The quest service for quest lookups.</param>
/// <returns>Quest definition IDs available to the player.</returns>
/// <remarks>
/// Returns quests that the player has not started and has not completed.
/// </remarks>
public IEnumerable<string> GetAvailableQuests(Player player, IQuestService questService)
{
    ArgumentNullException.ThrowIfNull(player);
    ArgumentNullException.ThrowIfNull(questService);

    return OfferedQuestIds.Where(id =>
        !questService.HasActiveQuest(player.Id, id) &&
        !player.HasCompletedQuest(id));
}

/// <summary>
/// Gets quests ready for turn-in.
/// </summary>
/// <param name="player">The player to check turn-in status for.</param>
/// <param name="questService">The quest service for quest lookups.</param>
/// <returns>Quest instances ready to be turned in.</returns>
/// <remarks>
/// Returns quests that:
/// - Are in the player's quest log
/// - Have all required objectives complete
/// - Have this NPC as the turn-in NPC
/// </remarks>
public IEnumerable<Quest> GetTurnInQuests(Player player, IQuestService questService)
{
    ArgumentNullException.ThrowIfNull(player);
    ArgumentNullException.ThrowIfNull(questService);

    return OfferedQuestIds
        .Select(id => questService.GetQuestByDefinition(player.Id, id))
        .Where(q => q != null && q.CanTurnIn() && q.TurnInNpcId == DefinitionId)!;
}

/// <summary>
/// Gets in-progress quests for a player.
/// </summary>
/// <param name="player">The player to check.</param>
/// <param name="questService">The quest service for quest lookups.</param>
/// <returns>Quest instances that are active but not ready for turn-in.</returns>
public IEnumerable<Quest> GetInProgressQuests(Player player, IQuestService questService)
{
    ArgumentNullException.ThrowIfNull(player);
    ArgumentNullException.ThrowIfNull(questService);

    return OfferedQuestIds
        .Select(id => questService.GetQuestByDefinition(player.Id, id))
        .Where(q => q != null && q.Status == QuestStatus.Active && !q.CanTurnIn())!;
}

// Update NPC.Create factory method:
public static NPC Create(
    string definitionId,
    string name,
    string description,
    NpcType type,
    string? greeting = null,
    IEnumerable<string>? offeredQuestIds = null)   // NEW
{
    ArgumentException.ThrowIfNullOrWhiteSpace(definitionId);
    ArgumentException.ThrowIfNullOrWhiteSpace(name);
    ArgumentException.ThrowIfNullOrWhiteSpace(description);

    return new NPC
    {
        Id = Guid.NewGuid(),
        DefinitionId = definitionId.ToLowerInvariant(),
        Name = name,
        Description = description,
        Type = type,
        Greeting = greeting,
        OfferedQuestIds = offeredQuestIds?.ToList() ?? new List<string>()  // NEW
    };
}

/// <summary>
/// Sets the offered quest IDs for this NPC.
/// </summary>
/// <param name="questIds">The quest definition IDs.</param>
/// <remarks>
/// Used during configuration loading.
/// </remarks>
internal void SetOfferedQuests(IEnumerable<string> questIds)
{
    OfferedQuestIds = questIds?.Select(id => id.ToLowerInvariant()).ToList()
        ?? new List<string>();
}
```

---

## 6. Configuration Schemas

### 6.1 Updated npcs.json

```json
{
  "$schema": "../schemas/npcs.schema.json",
  "npcs": [
    {
      "id": "guard-captain",
      "name": "Guard Captain",
      "description": "A weathered veteran in polished armor, studying tactical maps spread across a heavy oak desk.",
      "type": "QuestGiver",
      "greeting": "Adventurer! We could use someone with your skills.",
      "offeredQuestIds": [
        "goblin-menace",
        "patrol-eastern-tunnels",
        "eliminate-goblin-chief"
      ]
    },
    {
      "id": "grimbold-trader",
      "name": "Grimbold the Trader",
      "description": "A stout dwarf with a magnificent braided beard, surrounded by exotic wares from distant lands.",
      "type": "Merchant",
      "greeting": "Welcome to my shop! Best prices in the dungeon.",
      "offeredQuestIds": [
        "lost-heirloom",
        "rare-ingredients"
      ]
    },
    {
      "id": "guild-cartographer",
      "name": "Archivist Meren",
      "description": "An elderly elf hunched over ancient maps, quill in hand, cataloging the depths.",
      "type": "QuestGiver",
      "greeting": "Ah, another explorer! The depths hold many secrets.",
      "offeredQuestIds": [
        "dungeon-survey",
        "recover-lost-maps"
      ]
    },
    {
      "id": "quartermaster",
      "name": "Quartermaster Hilda",
      "description": "A no-nonsense woman managing supply crates with military efficiency.",
      "type": "QuestGiver",
      "greeting": "Need something done? I've got jobs that pay.",
      "offeredQuestIds": [
        "dangerous-errand",
        "supply-run"
      ]
    },
    {
      "id": "recruit-tam",
      "name": "Recruit Tam",
      "description": "A nervous young soldier, eyes darting at every sound.",
      "type": "Generic",
      "greeting": "H-hello. I'm just doing my duty here."
    }
  ]
}
```

### 6.2 Updated npcs.schema.json

```json
{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "title": "NPC Configuration",
  "description": "Defines NPCs and their properties",
  "type": "object",
  "required": ["npcs"],
  "properties": {
    "npcs": {
      "type": "array",
      "description": "List of NPC definitions",
      "items": {
        "$ref": "#/definitions/npcDefinition"
      }
    }
  },
  "definitions": {
    "npcDefinition": {
      "type": "object",
      "required": ["id", "name", "description", "type"],
      "properties": {
        "id": {
          "type": "string",
          "pattern": "^[a-z][a-z0-9-]*$",
          "description": "Unique identifier (lowercase, alphanumeric with hyphens)"
        },
        "name": {
          "type": "string",
          "minLength": 1,
          "maxLength": 100,
          "description": "Display name of the NPC"
        },
        "description": {
          "type": "string",
          "minLength": 10,
          "maxLength": 500,
          "description": "Description shown when examining the NPC"
        },
        "type": {
          "type": "string",
          "enum": ["Generic", "Merchant", "QuestGiver", "Trainer", "Guard"],
          "description": "The NPC type"
        },
        "greeting": {
          "type": ["string", "null"],
          "maxLength": 500,
          "description": "Greeting shown when initiating dialogue"
        },
        "offeredQuestIds": {
          "type": "array",
          "items": {
            "type": "string",
            "pattern": "^[a-z][a-z0-9-]*$"
          },
          "description": "Quest definition IDs this NPC offers"
        }
      }
    }
  }
}
```

---

## 7. Service Specifications

### 7.1 IQuestService Updates

```csharp
// Additions to existing IQuestService interface

/// <summary>
/// Gets whether a player has an active quest with the given definition.
/// </summary>
/// <param name="playerId">The player's ID.</param>
/// <param name="questDefinitionId">The quest definition ID.</param>
/// <returns>True if the player has an active quest with this definition.</returns>
bool HasActiveQuest(Guid playerId, string questDefinitionId);

/// <summary>
/// Gets a player's quest by definition ID.
/// </summary>
/// <param name="playerId">The player's ID.</param>
/// <param name="questDefinitionId">The quest definition ID.</param>
/// <returns>The quest if found, null otherwise.</returns>
Quest? GetQuestByDefinition(Guid playerId, string questDefinitionId);

/// <summary>
/// Accepts a quest for a player from an NPC.
/// </summary>
/// <param name="playerId">The player accepting the quest.</param>
/// <param name="questDefinitionId">The quest definition to accept.</param>
/// <param name="giverNpcId">The NPC giving the quest.</param>
/// <returns>The created quest, or null if quest cannot be accepted.</returns>
Quest? AcceptQuest(Guid playerId, string questDefinitionId, string giverNpcId);

/// <summary>
/// Turns in a completed quest.
/// </summary>
/// <param name="playerId">The player turning in the quest.</param>
/// <param name="questId">The quest instance ID.</param>
/// <returns>True if turn-in successful, false otherwise.</returns>
bool TurnInQuest(Guid playerId, Guid questId);
```

### 7.2 QuestService Implementation Updates

```csharp
// Additions to QuestService

public bool HasActiveQuest(Guid playerId, string questDefinitionId)
{
    ArgumentException.ThrowIfNullOrWhiteSpace(questDefinitionId);

    return _questRepository
        .GetPlayerQuests(playerId)
        .Any(q => q.DefinitionId.Equals(questDefinitionId, StringComparison.OrdinalIgnoreCase)
                  && q.Status == QuestStatus.Active);
}

public Quest? GetQuestByDefinition(Guid playerId, string questDefinitionId)
{
    ArgumentException.ThrowIfNullOrWhiteSpace(questDefinitionId);

    return _questRepository
        .GetPlayerQuests(playerId)
        .FirstOrDefault(q => q.DefinitionId.Equals(questDefinitionId, StringComparison.OrdinalIgnoreCase));
}

public Quest? AcceptQuest(Guid playerId, string questDefinitionId, string giverNpcId)
{
    ArgumentException.ThrowIfNullOrWhiteSpace(questDefinitionId);
    ArgumentException.ThrowIfNullOrWhiteSpace(giverNpcId);

    // Check if player already has this quest
    if (HasActiveQuest(playerId, questDefinitionId))
    {
        _logger.LogWarning(
            "Player {PlayerId} already has active quest {QuestId}",
            playerId, questDefinitionId);
        return null;
    }

    // Get quest definition
    var definition = _configProvider.GetQuestDefinition(questDefinitionId);
    if (definition == null)
    {
        _logger.LogWarning("Quest definition not found: {QuestId}", questDefinitionId);
        return null;
    }

    // Create quest instance
    var quest = Quest.Create(definition, playerId, giverNpcId);
    quest.Activate();

    _questRepository.Add(quest);

    _logger.LogInformation(
        "Player {PlayerId} accepted quest {QuestName} from {NpcId}",
        playerId, quest.Name, giverNpcId);

    return quest;
}

public bool TurnInQuest(Guid playerId, Guid questId)
{
    var quest = _questRepository.GetById(questId);
    if (quest == null || quest.PlayerId != playerId)
    {
        _logger.LogWarning("Quest {QuestId} not found for player {PlayerId}", questId, playerId);
        return false;
    }

    if (!quest.CanTurnIn())
    {
        _logger.LogWarning(
            "Quest {QuestName} cannot be turned in - not all objectives complete",
            quest.Name);
        return false;
    }

    quest.Complete();
    _questRepository.Update(quest);

    _logger.LogInformation(
        "Player {PlayerId} turned in quest {QuestName}",
        playerId, quest.Name);

    // Note: Reward distribution handled in v0.3.1c
    return true;
}
```

### 7.3 Room Description Service Updates

```csharp
// In RoomService or equivalent

/// <summary>
/// Gets the NPC list with quest indicators for room description.
/// </summary>
/// <param name="room">The room to get NPCs from.</param>
/// <param name="player">The player viewing the room.</param>
/// <param name="questService">The quest service for indicator calculation.</param>
/// <returns>Formatted NPC list with indicators.</returns>
public string GetNpcListWithIndicators(Room room, Player player, IQuestService questService)
{
    ArgumentNullException.ThrowIfNull(room);
    ArgumentNullException.ThrowIfNull(player);
    ArgumentNullException.ThrowIfNull(questService);

    var lines = new List<string>();

    foreach (var npc in room.NPCs.Where(n => n.IsAvailable))
    {
        var indicator = npc.GetQuestIndicator(player, questService);
        var indicatorStr = indicator.ToDisplayString();

        var suffix = string.IsNullOrEmpty(indicatorStr) ? "" : $" {indicatorStr}";
        lines.Add($"  {npc.Name}{suffix}");
    }

    return string.Join("\n", lines);
}
```

### 7.4 Application DTOs

```csharp
namespace RuneAndRust.Application.DTOs;

/// <summary>
/// DTO for NPC display in room descriptions.
/// </summary>
/// <param name="Id">The NPC instance ID.</param>
/// <param name="Name">The NPC name.</param>
/// <param name="Description">The NPC description.</param>
/// <param name="QuestIndicator">The quest indicator for this NPC.</param>
public record NpcDisplayDto(
    Guid Id,
    string Name,
    string Description,
    QuestIndicator QuestIndicator)
{
    /// <summary>
    /// Gets the display string including indicator.
    /// </summary>
    public string DisplayNameWithIndicator
    {
        get
        {
            var indicator = QuestIndicator.ToDisplayString();
            return string.IsNullOrEmpty(indicator) ? Name : $"{Name} {indicator}";
        }
    }
}

/// <summary>
/// DTO for quest giver dialogue.
/// </summary>
/// <param name="NpcId">The NPC definition ID.</param>
/// <param name="NpcName">The NPC display name.</param>
/// <param name="Greeting">The NPC greeting text.</param>
/// <param name="AvailableQuests">Quests available to accept.</param>
/// <param name="TurnInQuests">Quests ready to turn in.</param>
/// <param name="InProgressQuests">Quests in progress.</param>
public record QuestGiverDialogueDto(
    string NpcId,
    string NpcName,
    string Greeting,
    IReadOnlyList<QuestOfferDto> AvailableQuests,
    IReadOnlyList<QuestTurnInDto> TurnInQuests,
    IReadOnlyList<QuestProgressDto> InProgressQuests)
{
    /// <summary>
    /// Gets whether the NPC has any quest interactions.
    /// </summary>
    public bool HasQuestInteractions =>
        AvailableQuests.Count > 0 || TurnInQuests.Count > 0 || InProgressQuests.Count > 0;
}

/// <summary>
/// DTO for a quest offer in dialogue.
/// </summary>
/// <param name="QuestDefinitionId">The quest definition ID.</param>
/// <param name="Name">The quest name.</param>
/// <param name="Description">Brief quest description.</param>
/// <param name="RewardSummary">Summary of rewards.</param>
public record QuestOfferDto(
    string QuestDefinitionId,
    string Name,
    string Description,
    string RewardSummary);

/// <summary>
/// DTO for a quest turn-in in dialogue.
/// </summary>
/// <param name="QuestId">The quest instance ID.</param>
/// <param name="Name">The quest name.</param>
/// <param name="RewardSummary">Summary of rewards to receive.</param>
/// <param name="BonusEarned">Whether bonus rewards were earned.</param>
public record QuestTurnInDto(
    Guid QuestId,
    string Name,
    string RewardSummary,
    bool BonusEarned);

/// <summary>
/// DTO for an in-progress quest in dialogue.
/// </summary>
/// <param name="QuestId">The quest instance ID.</param>
/// <param name="Name">The quest name.</param>
/// <param name="Progress">Progress percentage.</param>
/// <param name="ObjectiveSummary">Brief summary of remaining objectives.</param>
public record QuestProgressDto(
    Guid QuestId,
    string Name,
    int Progress,
    string ObjectiveSummary);
```

---

## 8. User-Facing Changes

### 8.1 Room Description with Indicators

```
You are in the Guard Barracks. Soldiers practice their drills
while officers review reports at wooden desks.

You see:
  Guard Captain [!]
  Quartermaster [?]
  Recruit Tam

Exits: north, east
```

### 8.2 Dialogue with Quest Giver (Available Quests)

```
> talk captain

The Guard Captain looks up from his maps. "Adventurer! We could
use someone with your skills."

[QUESTS AVAILABLE]
  [!] The Goblin Menace (New)
  [!] Patrol the Eastern Tunnels (New)

[1] Tell me about the goblin problem.
[2] What's happening in the Eastern Tunnels?
[3] [Accept: The Goblin Menace]
[4] [Accept: Patrol the Eastern Tunnels]
[5] Just checking in.
```

### 8.3 Quest Accepted

```
> 3

Guard Captain: "The dungeon entrance is overrun with goblins.
Clear them out and make the area safe for other adventurers.
I'll make it worth your while."

Quest Accepted: The Goblin Menace
  Objective: Defeat 5 goblins
  Rewards: 50 XP, 25 gold, +100 City Guard reputation
```

### 8.4 Dialogue with Quest Ready to Turn In

```
> talk grimbold

Grimbold nods as you approach. "Ah, you found my locket!
You have my eternal gratitude."

[QUEST READY TO TURN IN]
  [?] The Lost Heirloom

[1] [Turn In: The Lost Heirloom]
[2] I'll hold onto it a bit longer.
[3] What else do you have for me?
```

### 8.5 Quest Turned In

```
> 1

Grimbold's eyes light up as he takes the locket. "My grandmother's
locket! I never thought I'd see it again. Please, take this as
a token of my appreciation."

Quest Complete: The Lost Heirloom
  Rewards: 75 XP, 50 gold, Ring of Protection, +150 Merchant Guild reputation
```

### 8.6 Dialogue with In-Progress Quest

```
> talk captain

The Guard Captain looks up. "How goes the goblin hunt?"

[QUEST IN PROGRESS]
  [...] The Goblin Menace (3/5 goblins defeated)

[1] Any tips for finding more goblins?
[2] I'll keep at it.
```

---

## 9. Logging Requirements

### 9.1 Log Events

| Event | Level | Message Template | Properties |
|-------|-------|------------------|------------|
| NPC Quest Load | Debug | "NPC '{NpcId}' offers {QuestCount} quests: {QuestIds}" | NpcId, QuestCount, QuestIds |
| Invalid Quest Ref | Warning | "NPC '{NpcId}' references unknown quest: {QuestId}" | NpcId, QuestId |
| Quest Accepted | Information | "Player {PlayerId} accepted quest '{QuestName}' from {NpcId}" | PlayerId, QuestName, NpcId |
| Quest Turned In | Information | "Player {PlayerId} turned in quest '{QuestName}'" | PlayerId, QuestName |
| Turn In Failed | Warning | "Quest '{QuestName}' cannot be turned in: {Reason}" | QuestName, Reason |
| Indicator Calc | Debug | "Calculated indicator {Indicator} for NPC '{NpcId}' and player {PlayerId}" | Indicator, NpcId, PlayerId |

### 9.2 Example Log Output

```
[2024-01-20 14:30:15 DBG] NPC 'guard-captain' offers 3 quests: goblin-menace, patrol-eastern-tunnels, eliminate-goblin-chief
[2024-01-20 14:30:15 DBG] NPC 'grimbold-trader' offers 2 quests: lost-heirloom, rare-ingredients
[2024-01-20 14:30:15 WRN] NPC 'old-hermit' references unknown quest: mysterious-artifact
[2024-01-20 14:35:22 INF] Player a1b2c3d4 accepted quest 'The Goblin Menace' from guard-captain
[2024-01-20 14:35:22 DBG] Calculated indicator InProgress for NPC 'guard-captain' and player a1b2c3d4
[2024-01-20 14:45:10 INF] Player a1b2c3d4 turned in quest 'The Lost Heirloom'
```

---

## 10. Unit Test Specifications

### 10.1 QuestIndicator Tests (~5 tests)

```csharp
namespace RuneAndRust.Domain.Tests.Enums;

[TestFixture]
public class QuestIndicatorTests
{
    [Test]
    public void ToDisplayString_Available_ReturnsBang()
    {
        QuestIndicator.Available.ToDisplayString().Should().Be("[!]");
    }

    [Test]
    public void ToDisplayString_ReadyToTurnIn_ReturnsQuestion()
    {
        QuestIndicator.ReadyToTurnIn.ToDisplayString().Should().Be("[?]");
    }

    [Test]
    public void ToDisplayString_InProgress_ReturnsEllipsis()
    {
        QuestIndicator.InProgress.ToDisplayString().Should().Be("[...]");
    }

    [Test]
    public void ToDisplayString_None_ReturnsEmpty()
    {
        QuestIndicator.None.ToDisplayString().Should().BeEmpty();
    }

    [Test]
    public void GetPriority_ReadyToTurnIn_HighestPriority()
    {
        QuestIndicator.ReadyToTurnIn.GetPriority().Should().BeLessThan(
            QuestIndicator.Available.GetPriority());
        QuestIndicator.Available.GetPriority().Should().BeLessThan(
            QuestIndicator.InProgress.GetPriority());
        QuestIndicator.InProgress.GetPriority().Should().BeLessThan(
            QuestIndicator.None.GetPriority());
    }
}
```

### 10.2 NPC Quest Giver Tests (~10 tests)

```csharp
namespace RuneAndRust.Domain.Tests.Entities;

[TestFixture]
public class NpcQuestGiverTests
{
    private Mock<IQuestService> _questServiceMock;
    private Player _player;
    private NPC _npc;

    [SetUp]
    public void SetUp()
    {
        _questServiceMock = new Mock<IQuestService>();
        _player = Player.Create("TestPlayer");
        _npc = NPC.Create(
            "test-npc",
            "Test NPC",
            "A test NPC for quests.",
            NpcType.QuestGiver,
            "Hello!",
            new[] { "quest-1", "quest-2" });
    }

    [Test]
    public void IsQuestGiver_WithOfferedQuests_ReturnsTrue()
    {
        _npc.IsQuestGiver.Should().BeTrue();
    }

    [Test]
    public void IsQuestGiver_WithNoQuests_ReturnsFalse()
    {
        var npc = NPC.Create("npc", "NPC", "Description", NpcType.Generic);
        npc.IsQuestGiver.Should().BeFalse();
    }

    [Test]
    public void GetQuestIndicator_NoQuests_ReturnsNone()
    {
        var npc = NPC.Create("npc", "NPC", "Description", NpcType.Generic);

        var indicator = npc.GetQuestIndicator(_player, _questServiceMock.Object);

        indicator.Should().Be(QuestIndicator.None);
    }

    [Test]
    public void GetQuestIndicator_AvailableQuest_ReturnsAvailable()
    {
        _questServiceMock.Setup(s => s.HasActiveQuest(_player.Id, It.IsAny<string>()))
            .Returns(false);

        var indicator = _npc.GetQuestIndicator(_player, _questServiceMock.Object);

        indicator.Should().Be(QuestIndicator.Available);
    }

    [Test]
    public void GetQuestIndicator_InProgressQuest_ReturnsInProgress()
    {
        var quest = CreateMockQuest(QuestStatus.Active, canTurnIn: false);
        _questServiceMock.Setup(s => s.GetQuestByDefinition(_player.Id, "quest-1"))
            .Returns(quest);
        _questServiceMock.Setup(s => s.HasActiveQuest(_player.Id, "quest-1"))
            .Returns(true);

        var indicator = _npc.GetQuestIndicator(_player, _questServiceMock.Object);

        indicator.Should().Be(QuestIndicator.InProgress);
    }

    [Test]
    public void GetQuestIndicator_ReadyToTurnIn_ReturnsReadyToTurnIn()
    {
        var quest = CreateMockQuest(QuestStatus.Active, canTurnIn: true, turnInNpcId: "test-npc");
        _questServiceMock.Setup(s => s.GetQuestByDefinition(_player.Id, "quest-1"))
            .Returns(quest);

        var indicator = _npc.GetQuestIndicator(_player, _questServiceMock.Object);

        indicator.Should().Be(QuestIndicator.ReadyToTurnIn);
    }

    [Test]
    public void GetQuestIndicator_TurnInPriorityOverInProgress()
    {
        var turnInQuest = CreateMockQuest(QuestStatus.Active, canTurnIn: true, turnInNpcId: "test-npc");
        var inProgressQuest = CreateMockQuest(QuestStatus.Active, canTurnIn: false);

        _questServiceMock.Setup(s => s.GetQuestByDefinition(_player.Id, "quest-1"))
            .Returns(turnInQuest);
        _questServiceMock.Setup(s => s.GetQuestByDefinition(_player.Id, "quest-2"))
            .Returns(inProgressQuest);

        var indicator = _npc.GetQuestIndicator(_player, _questServiceMock.Object);

        indicator.Should().Be(QuestIndicator.ReadyToTurnIn);
    }

    [Test]
    public void GetAvailableQuests_ReturnsUnstartedQuests()
    {
        _questServiceMock.Setup(s => s.HasActiveQuest(_player.Id, "quest-1"))
            .Returns(true);
        _questServiceMock.Setup(s => s.HasActiveQuest(_player.Id, "quest-2"))
            .Returns(false);

        var available = _npc.GetAvailableQuests(_player, _questServiceMock.Object).ToList();

        available.Should().HaveCount(1);
        available.Should().Contain("quest-2");
    }

    [Test]
    public void GetTurnInQuests_ReturnsCompletableQuests()
    {
        var quest = CreateMockQuest(QuestStatus.Active, canTurnIn: true, turnInNpcId: "test-npc");
        _questServiceMock.Setup(s => s.GetQuestByDefinition(_player.Id, "quest-1"))
            .Returns(quest);

        var turnIn = _npc.GetTurnInQuests(_player, _questServiceMock.Object).ToList();

        turnIn.Should().HaveCount(1);
        turnIn[0].Should().Be(quest);
    }

    [Test]
    public void GetTurnInQuests_ExcludesWrongTurnInNpc()
    {
        var quest = CreateMockQuest(QuestStatus.Active, canTurnIn: true, turnInNpcId: "other-npc");
        _questServiceMock.Setup(s => s.GetQuestByDefinition(_player.Id, "quest-1"))
            .Returns(quest);

        var turnIn = _npc.GetTurnInQuests(_player, _questServiceMock.Object).ToList();

        turnIn.Should().BeEmpty();
    }

    private Quest CreateMockQuest(QuestStatus status, bool canTurnIn, string? turnInNpcId = null)
    {
        var quest = new Mock<Quest>();
        quest.SetupGet(q => q.Status).Returns(status);
        quest.Setup(q => q.CanTurnIn()).Returns(canTurnIn);
        quest.SetupGet(q => q.TurnInNpcId).Returns(turnInNpcId);
        return quest.Object;
    }
}
```

### 10.3 QuestService Quest Accept/Turn-in Tests (~6 tests)

```csharp
namespace RuneAndRust.Application.Tests.Services;

[TestFixture]
public class QuestServiceAcceptTurnInTests
{
    private QuestService _service;
    private Mock<IQuestRepository> _repoMock;
    private Mock<IConfigurationProvider> _configMock;
    private Guid _playerId;

    [SetUp]
    public void SetUp()
    {
        _repoMock = new Mock<IQuestRepository>();
        _configMock = new Mock<IConfigurationProvider>();
        _service = new QuestService(_repoMock.Object, _configMock.Object, Mock.Of<ILogger<QuestService>>());
        _playerId = Guid.NewGuid();
    }

    [Test]
    public void HasActiveQuest_WithActive_ReturnsTrue()
    {
        var quest = CreateTestQuest(QuestStatus.Active);
        _repoMock.Setup(r => r.GetPlayerQuests(_playerId))
            .Returns(new[] { quest });

        var result = _service.HasActiveQuest(_playerId, "test-quest");

        result.Should().BeTrue();
    }

    [Test]
    public void HasActiveQuest_WithCompleted_ReturnsFalse()
    {
        var quest = CreateTestQuest(QuestStatus.Completed);
        _repoMock.Setup(r => r.GetPlayerQuests(_playerId))
            .Returns(new[] { quest });

        var result = _service.HasActiveQuest(_playerId, "test-quest");

        result.Should().BeFalse();
    }

    [Test]
    public void AcceptQuest_CreatesNewQuest()
    {
        var definition = CreateTestDefinition();
        _configMock.Setup(c => c.GetQuestDefinition("test-quest"))
            .Returns(definition);
        _repoMock.Setup(r => r.GetPlayerQuests(_playerId))
            .Returns(Array.Empty<Quest>());

        var quest = _service.AcceptQuest(_playerId, "test-quest", "npc-1");

        quest.Should().NotBeNull();
        quest!.Status.Should().Be(QuestStatus.Active);
        _repoMock.Verify(r => r.Add(It.IsAny<Quest>()), Times.Once);
    }

    [Test]
    public void AcceptQuest_AlreadyActive_ReturnsNull()
    {
        var existingQuest = CreateTestQuest(QuestStatus.Active);
        _repoMock.Setup(r => r.GetPlayerQuests(_playerId))
            .Returns(new[] { existingQuest });

        var quest = _service.AcceptQuest(_playerId, "test-quest", "npc-1");

        quest.Should().BeNull();
        _repoMock.Verify(r => r.Add(It.IsAny<Quest>()), Times.Never);
    }

    [Test]
    public void TurnInQuest_CompletesQuest()
    {
        var quest = CreateTestQuest(QuestStatus.Active, canTurnIn: true);
        _repoMock.Setup(r => r.GetById(quest.Id))
            .Returns(quest);

        var result = _service.TurnInQuest(_playerId, quest.Id);

        result.Should().BeTrue();
        quest.Status.Should().Be(QuestStatus.Completed);
        _repoMock.Verify(r => r.Update(quest), Times.Once);
    }

    [Test]
    public void TurnInQuest_NotComplete_ReturnsFalse()
    {
        var quest = CreateTestQuest(QuestStatus.Active, canTurnIn: false);
        _repoMock.Setup(r => r.GetById(quest.Id))
            .Returns(quest);

        var result = _service.TurnInQuest(_playerId, quest.Id);

        result.Should().BeFalse();
        quest.Status.Should().Be(QuestStatus.Active);
    }

    private Quest CreateTestQuest(QuestStatus status, bool canTurnIn = false)
    {
        // Create actual quest with test data
    }

    private QuestDefinition CreateTestDefinition()
    {
        // Create actual definition with test data
    }
}
```

### 10.4 DTO Tests (~4 tests)

```csharp
namespace RuneAndRust.Application.Tests.DTOs;

[TestFixture]
public class NpcDisplayDtoTests
{
    [Test]
    public void DisplayNameWithIndicator_Available_IncludesIndicator()
    {
        var dto = new NpcDisplayDto(Guid.NewGuid(), "Guard Captain", "Description", QuestIndicator.Available);

        dto.DisplayNameWithIndicator.Should().Be("Guard Captain [!]");
    }

    [Test]
    public void DisplayNameWithIndicator_None_NoIndicator()
    {
        var dto = new NpcDisplayDto(Guid.NewGuid(), "Recruit", "Description", QuestIndicator.None);

        dto.DisplayNameWithIndicator.Should().Be("Recruit");
    }

    [Test]
    public void QuestGiverDialogueDto_HasQuestInteractions_WithAvailable_ReturnsTrue()
    {
        var dto = new QuestGiverDialogueDto(
            "npc-1",
            "NPC",
            "Hello",
            new[] { new QuestOfferDto("q1", "Quest 1", "Desc", "50 XP") },
            Array.Empty<QuestTurnInDto>(),
            Array.Empty<QuestProgressDto>());

        dto.HasQuestInteractions.Should().BeTrue();
    }

    [Test]
    public void QuestGiverDialogueDto_HasQuestInteractions_Empty_ReturnsFalse()
    {
        var dto = new QuestGiverDialogueDto(
            "npc-1",
            "NPC",
            "Hello",
            Array.Empty<QuestOfferDto>(),
            Array.Empty<QuestTurnInDto>(),
            Array.Empty<QuestProgressDto>());

        dto.HasQuestInteractions.Should().BeFalse();
    }
}
```

---

## 11. Use Cases

### UC-001: View Quest Givers in Room
**Actor:** Player
**Flow:** Enter room → View description → See NPCs with indicators ([!], [?], [...])

### UC-002: Accept Quest from NPC
**Actor:** Player
**Flow:** Talk to NPC → See available quests → Select accept option → Quest added to journal

### UC-003: Turn In Completed Quest
**Actor:** Player
**Flow:** Complete objectives → Return to NPC → Select turn-in option → Quest marked complete

### UC-004: Configure Quest Giver
**Actor:** Game Designer
**Flow:** Edit npcs.json → Add offeredQuestIds → Configuration loaded → NPC offers quests

---

## 12. Acceptance Criteria

### AC-3.1b-1: QuestIndicator Enum
- [ ] QuestIndicator has 5 values: None, Available, InProgress, ReadyToTurnIn, Repeatable
- [ ] ToDisplayString returns correct symbols ([!], [?], [...])
- [ ] GetPriority returns correct priority order

### AC-3.1b-2: NPC Entity Updates
- [ ] NPC.OfferedQuestIds stores quest definition IDs
- [ ] NPC.IsQuestGiver returns true when has quests
- [ ] GetQuestIndicator returns correct indicator based on player state
- [ ] GetAvailableQuests returns unstarted, uncompleted quests
- [ ] GetTurnInQuests returns completable quests for this NPC
- [ ] GetInProgressQuests returns active but not completable quests

### AC-3.1b-3: Quest Indicator Priority
- [ ] ReadyToTurnIn takes priority over all other indicators
- [ ] InProgress takes priority over Available
- [ ] Available shows when no active or completable quests

### AC-3.1b-4: Room Description
- [ ] NPCs with Available quests show [!] indicator
- [ ] NPCs with ReadyToTurnIn quests show [?] indicator
- [ ] NPCs with InProgress quests show [...] indicator
- [ ] NPCs with no quest interaction show no indicator

### AC-3.1b-5: Dialogue Integration
- [ ] Available quests listed at top of dialogue
- [ ] Turn-in quests show when completable
- [ ] In-progress quests show with progress
- [ ] Accept option creates new quest
- [ ] Turn-in option completes quest

### AC-3.1b-6: Configuration
- [ ] NPCs support offeredQuestIds array
- [ ] Multiple quests can be assigned per NPC
- [ ] Invalid quest IDs logged as warnings
- [ ] Schema validates offeredQuestIds

### AC-3.1b-7: Unit Tests
- [ ] ~25 unit tests implemented
- [ ] All tests pass
- [ ] Tests cover indicator priority, quest accept, quest turn-in

---

## 13. Deliverable Checklist

### Domain Layer
- [ ] `Enums/QuestIndicator.cs`
- [ ] `Extensions/QuestIndicatorExtensions.cs`
- [ ] `Entities/NPC.cs` updates (OfferedQuestIds, IsQuestGiver, GetQuestIndicator, etc.)

### Application Layer
- [ ] `DTOs/NpcDisplayDto.cs` updates
- [ ] `DTOs/QuestGiverDialogueDto.cs`
- [ ] `DTOs/QuestOfferDto.cs`
- [ ] `DTOs/QuestTurnInDto.cs`
- [ ] `DTOs/QuestProgressDto.cs`
- [ ] `Interfaces/IQuestService.cs` updates
- [ ] `Services/QuestService.cs` updates (HasActiveQuest, GetQuestByDefinition, AcceptQuest, TurnInQuest)

### Infrastructure Layer
- [ ] `Configuration/JsonConfigurationProvider.cs` updates (NPC quest loading)
- [ ] `Configuration/NpcConfigDto.cs` updates

### Configuration Files
- [ ] `config/npcs.json` updates (offeredQuestIds)
- [ ] `config/schemas/npcs.schema.json` updates

### Tests
- [ ] `Domain.Tests/Enums/QuestIndicatorTests.cs`
- [ ] `Domain.Tests/Entities/NpcQuestGiverTests.cs`
- [ ] `Application.Tests/Services/QuestServiceAcceptTurnInTests.cs`
- [ ] `Application.Tests/DTOs/NpcDisplayDtoTests.cs`

### Documentation
- [ ] XML documentation on all public members

---

## 14. Dependencies

### Required from v0.3.0
- Quest entity (from v0.3.0a)
- QuestStatus enum (from v0.3.0a)
- QuestService (from v0.3.0a)
- Player entity with HasCompletedQuest (from v0.3.0c)

### Required from v0.3.1a
- QuestReward for display in dialogue
- RewardDisplayDto for reward summary

### Provided to v0.3.1c (Prerequisites & Distribution)
- NPC quest giver infrastructure
- Quest accept/turn-in service methods
- Turn-in point for reward distribution

### Provided to v0.3.2 (Quest Chains)
- NPC quest offering system
- Quest giver dialogue integration

---

## 15. Future Considerations

### Deferred to v0.3.1c
- **Reward Distribution**: Actually granting rewards on turn-in
- **Prerequisites**: Checking quest prerequisites before offering

### Deferred to v0.3.2
- **Quest Chains**: Sequential quest requirements
- **Repeatable Quests**: Quests that can be done multiple times
- **Daily/Weekly Quests**: Time-limited repeatable quests

### Out of Scope
- **NPC Schedules**: NPCs available at certain times
- **Reputation Gating**: Requiring reputation to see quests
- **Quest Sharing**: Multiple players sharing a quest

---

*Document Version: 1.0*
*Last Updated: 2024-01-20*
*Author: Claude Code*
