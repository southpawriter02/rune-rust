# v0.0.5a Design Specification: Core Dice Engine

**Version:** 0.0.5a
**Parent:** v0.0.5 (Dice Pool System)
**Status:** Ready for Implementation
**Prerequisite:** v0.0.4d Complete (198 tests passing)
**Target Tests:** 198 → 220 (+22 tests)

---

## Table of Contents

1. [Executive Summary](#executive-summary)
2. [User Stories](#user-stories)
3. [Functional Requirements](#functional-requirements)
4. [Technical Design](#technical-design)
5. [Architecture](#architecture)
6. [Workflows & Decision Trees](#workflows--decision-trees)
7. [API Reference](#api-reference)
8. [Configuration](#configuration)
9. [Logging Strategy](#logging-strategy)
10. [Testing Strategy](#testing-strategy)
11. [Documentation Requirements](#documentation-requirements)
12. [Implementation Checklist](#implementation-checklist)
13. [Acceptance Criteria](#acceptance-criteria)
14. [Dependencies & Integration](#dependencies--integration)

---

## Executive Summary

### Purpose
Phase 5a establishes the foundational dice rolling infrastructure that will power all randomization in the game. This phase creates the core building blocks without any game integration - pure dice mechanics only.

### Scope
- **In Scope:** Dice value objects, enums, DiceService, parsing, DTOs
- **Out of Scope:** Skill checks, combat integration, UI rendering, commands

### Key Deliverables
| Type | Count | Files |
|------|-------|-------|
| Domain Enums | 3 | DiceType, AdvantageType, SuccessLevel |
| Domain Value Objects | 2 | DicePool, DiceRollResult |
| Application Services | 1 | DiceService |
| Application DTOs | 1 | DiceDtos.cs |
| Unit Tests | 22 | 3 test files |

### Success Metrics
- All 22 new tests pass
- All existing 198 tests continue to pass
- Build completes with 0 errors, 0 warnings
- Code coverage for new code ≥ 90%

---

## User Stories

### US-5a-1: Roll Dice Pool
**As a** game system
**I want to** roll a pool of dice with modifiers
**So that** random outcomes can be generated for game mechanics

**Acceptance Criteria:**
- [ ] Can roll any combination of standard dice (d4, d6, d8, d10, d12, d20, d100)
- [ ] Can roll multiple dice of the same type (e.g., 3d6)
- [ ] Can add positive or negative modifiers
- [ ] Result includes individual die values
- [ ] Result includes total

**Example:**
```
Input: Roll 3d6+5
Output: DiceRollResult {
  Pool: "3d6+5",
  Rolls: [4, 2, 6],
  DiceTotal: 12,
  Total: 17,
  Modifier: 5
}
```

---

### US-5a-2: Parse Dice Notation
**As a** developer
**I want to** parse standard dice notation strings
**So that** dice pools can be created from user input or configuration

**Acceptance Criteria:**
- [ ] Parses standard notation: "3d6", "1d20", "2d8+5"
- [ ] Handles negative modifiers: "1d20-2"
- [ ] Handles omitted count: "d20" → 1d20
- [ ] Handles exploding notation: "1d6!"
- [ ] Returns clear error for invalid notation
- [ ] Case-insensitive: "3D6" = "3d6"

**Valid Notation Examples:**
| Input | Count | Faces | Modifier | Exploding |
|-------|-------|-------|----------|-----------|
| `3d6` | 3 | 6 | 0 | No |
| `d10` | 1 | 10 | 0 | No |
| `2d8+5` | 2 | 8 | +5 | No |
| `1d6-2` | 1 | 6 | -2 | No |
| `4d6!` | 4 | 6 | 0 | Yes |
| `2d10+3!` | 2 | 10 | +3 | Yes |

**Invalid Notation Examples:**
| Input | Error |
|-------|-------|
| `3d7` | "Unsupported dice type: d7" |
| `abc` | "Invalid dice notation: abc" |
| `0d6` | "Dice count must be at least 1" |
| `d` | "Invalid dice faces: " |
| `` | "Dice notation cannot be empty" |
| `1d20` | "Unsupported dice type: d20" |

---

### US-5a-3: Roll with Advantage/Disadvantage
**As a** game system
**I want to** roll dice with advantage or disadvantage
**So that** situational bonuses can affect outcomes

**Acceptance Criteria:**
- [ ] Advantage: Roll twice, use higher result
- [ ] Disadvantage: Roll twice, use lower result
- [ ] Result includes both roll totals
- [ ] Result indicates which roll was selected

**Flow Diagram:**
```
┌─────────────────────────────────────────────────────────────────┐
│                     ADVANTAGE/DISADVANTAGE FLOW                  │
└─────────────────────────────────────────────────────────────────┘

       ┌──────────────┐
       │ Roll Request │
       │ with ADV/DIS │
       └──────┬───────┘
              │
              ▼
       ┌──────────────┐
       │  Roll Pool   │──────────────┐
       │  (First)     │              │
       └──────┬───────┘              │
              │                      │
              ▼                      ▼
       ┌──────────────┐       ┌──────────────┐
       │  Roll Pool   │       │ Store Roll 1 │
       │  (Second)    │       │   Total      │
       └──────┬───────┘       └──────────────┘
              │                      │
              ▼                      │
       ┌──────────────┐              │
       │ Store Roll 2 │◀─────────────┘
       │   Total      │
       └──────┬───────┘
              │
              ▼
       ┌──────────────────────────────────────┐
       │           Compare Totals              │
       │  ┌─────────────────────────────────┐ │
       │  │ ADVANTAGE:  Select MAX(R1, R2)  │ │
       │  │ DISADVANTAGE: Select MIN(R1,R2)│ │
       │  └─────────────────────────────────┘ │
       └──────────────┬───────────────────────┘
                      │
                      ▼
       ┌──────────────────────────────────────┐
       │         Return Result                 │
       │  - Selected roll details              │
       │  - AllRollTotals: [R1, R2]           │
       │  - SelectedRollIndex: 0 or 1         │
       │  - AdvantageType: ADV or DIS         │
       └──────────────────────────────────────┘
```

---

### US-5a-4: Exploding Dice
**As a** game system
**I want to** roll exploding dice
**So that** maximum rolls can chain into additional rolls

**Acceptance Criteria:**
- [ ] When die shows maximum value, roll additional die
- [ ] Chain continues while rolling maximum
- [ ] Maximum explosions capped (default: 10)
- [ ] All explosion rolls tracked separately
- [ ] Total includes all explosion values

**Exploding Dice Decision Tree:**
```
                    ┌─────────────────┐
                    │   Roll Die      │
                    │   (faces = N)   │
                    └────────┬────────┘
                             │
                             ▼
                    ┌─────────────────┐
                    │  Result = R     │
                    └────────┬────────┘
                             │
                             ▼
                  ┌──────────────────────┐
                  │   Is Exploding       │
                  │   Enabled?           │
                  └──────────┬───────────┘
                             │
              ┌──────────────┴──────────────┐
              │ NO                          │ YES
              ▼                             ▼
    ┌─────────────────┐           ┌─────────────────┐
    │ Add R to Rolls  │           │   R == N?       │
    │ Continue        │           │   (Max Value?)  │
    └─────────────────┘           └────────┬────────┘
                                           │
                              ┌────────────┴────────────┐
                              │ NO                      │ YES
                              ▼                         ▼
                    ┌─────────────────┐       ┌─────────────────┐
                    │ Add R to Rolls  │       │ explosions < max│
                    │ Continue        │       │ explosions?     │
                    └─────────────────┘       └────────┬────────┘
                                                       │
                                          ┌────────────┴────────────┐
                                          │ NO                      │ YES
                                          ▼                         ▼
                                ┌─────────────────┐       ┌─────────────────┐
                                │ Add R to Rolls  │       │ Roll Again!     │
                                │ Stop Exploding  │       │ Add to          │
                                │ (Cap reached)   │       │ ExplosionRolls  │
                                └─────────────────┘       │ explosions++    │
                                                          │ Loop back ↑     │
                                                          └─────────────────┘
```

**Example Scenario:**
```
Pool: 1d6! (exploding d6)

Roll 1: 6 (MAX!) → Explodes
  Explosion 1: 6 (MAX!) → Explodes again
    Explosion 2: 3 → Stops

Result: {
  Rolls: [6],
  ExplosionRolls: [6, 3],
  DiceTotal: 15,
  Total: 15,
  HadExplosions: true,
  ExplosionCount: 2
}
```

---

### US-5a-5: Calculate Statistics
**As a** developer
**I want to** know the statistical properties of a dice pool
**So that** I can validate game balance and display expectations

**Acceptance Criteria:**
- [ ] Calculate minimum possible result
- [ ] Calculate maximum possible result (without explosions)
- [ ] Calculate average expected result

**Formulas:**
```
MinimumResult = Count × 1 + Modifier
MaximumResult = Count × Faces + Modifier
AverageResult = Count × ((Faces + 1) / 2) + Modifier

Example: 3d6+5
  Minimum = 3 × 1 + 5 = 8
  Maximum = 3 × 6 + 5 = 23
  Average = 3 × 3.5 + 5 = 15.5
```

---

### US-5a-6: Detect Critical Rolls
**As a** game system
**I want to** detect when a natural maximum or minimum is rolled
**So that** critical successes and failures can be identified

**Acceptance Criteria:**
- [ ] `IsNaturalMax` true when first die = faces
- [ ] `IsNaturalOne` true when first die = 1
- [ ] Both properties based on first die only (for d10 checks)

**Critical Detection Logic:**
```
                    ┌─────────────────────────────────────┐
                    │        CRITICAL DETECTION           │
                    └─────────────────────────────────────┘
                                     │
                                     ▼
                    ┌─────────────────────────────────────┐
                    │     Get First Die Value (Rolls[0])  │
                    └─────────────────┬───────────────────┘
                                      │
                     ┌────────────────┴────────────────┐
                     │                                 │
                     ▼                                 ▼
           ┌─────────────────┐               ┌─────────────────┐
           │  Rolls[0] == 1  │               │ Rolls[0] == Max │
           └────────┬────────┘               └────────┬────────┘
                    │                                 │
         ┌──────────┴──────────┐           ┌──────────┴──────────┐
         │ YES                 │ NO        │ YES                 │ NO
         ▼                     ▼           ▼                     ▼
┌─────────────────┐   ┌──────────┐ ┌─────────────────┐   ┌──────────┐
│ IsNaturalOne    │   │ false    │ │ IsNaturalMax    │   │ false    │
│ = true          │   │          │ │ = true          │   │          │
│                 │   │          │ │                 │   │          │
│ CRITICAL FAIL   │   │          │ │ CRITICAL SUCCESS│   │          │
└─────────────────┘   └──────────┘ └─────────────────┘   └──────────┘
```

---

## Functional Requirements

### FR-5a-1: Dice Types
The system SHALL support the following dice types:

| Enum Value | Faces | Common Use |
|------------|-------|------------|
| D4 | 4 | Minor damage, small effects |
| D6 | 6 | Standard damage, ability rolls |
| D8 | 8 | Heavy damage, moderate effects |
| D10 | 10 | Resolution rolls, skill checks, major effects |

**Note:** All skill checks and resolutions use d10 increments. The d4, d6, and d8 are primarily for damage and effect scaling.

### FR-5a-2: Dice Pool Constraints
| Property | Constraint |
|----------|------------|
| Count | 1 ≤ Count ≤ 100 |
| Modifier | -1000 ≤ Modifier ≤ 1000 |
| MaxExplosions | 0 ≤ MaxExplosions ≤ 100, default 10 |

### FR-5a-3: Roll Result Properties
| Property | Type | Description |
|----------|------|-------------|
| Pool | DicePool | The pool that was rolled |
| Rolls | int[] | Individual die results |
| ExplosionRolls | int[] | Additional explosion results |
| DiceTotal | int | Sum of Rolls + ExplosionRolls |
| Total | int | DiceTotal + Modifier |
| AdvantageType | enum | Normal, Advantage, Disadvantage |
| AllRollTotals | int[] | All totals for advantage/disadvantage |
| IsNaturalMax | bool | First die = max faces |
| IsNaturalOne | bool | First die = 1 |

---

## Technical Design

### Class Diagram

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                              DOMAIN LAYER                                    │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  ┌───────────────────┐     ┌───────────────────┐     ┌───────────────────┐  │
│  │   <<enum>>        │     │   <<enum>>        │     │   <<enum>>        │  │
│  │   DiceType        │     │   AdvantageType   │     │   SuccessLevel    │  │
│  ├───────────────────┤     ├───────────────────┤     ├───────────────────┤  │
│  │ D4 = 4            │     │ Normal            │     │ CriticalFailure   │  │
│  │ D6 = 6            │     │ Advantage         │     │ Failure           │  │
│  │ D8 = 8            │     │ Disadvantage      │     │ Success           │  │
│  │ D10 = 10          │     └───────────────────┘     │ CriticalSuccess   │  │
│  └───────────────────┘                               └───────────────────┘  │                                                      │
│                                                                              │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │  <<record struct>>                                                   │   │
│  │  DicePool                                                            │   │
│  ├─────────────────────────────────────────────────────────────────────┤   │
│  │  + Count: int {get; init;}                                          │   │
│  │  + DiceType: DiceType {get; init;}                                  │   │
│  │  + Modifier: int {get; init;}                                       │   │
│  │  + Exploding: bool {get; init;}                                     │   │
│  │  + MaxExplosions: int {get; init;}                                  │   │
│  ├─────────────────────────────────────────────────────────────────────┤   │
│  │  + Faces: int {get;} → (int)DiceType                                │   │
│  │  + MinimumResult: int {get;} → Count + Modifier                     │   │
│  │  + MaximumResult: int {get;} → Count * Faces + Modifier             │   │
│  │  + AverageResult: float {get;} → Count * ((Faces+1)/2f) + Modifier  │   │
│  ├─────────────────────────────────────────────────────────────────────┤   │
│  │  + DicePool(count, diceType, modifier?, exploding?, maxExplosions?) │   │
│  │  + ToString(): string → "3d6+5" format                              │   │
│  │  + WithExploding(maxExplosions?): DicePool                          │   │
│  │  + WithModifier(modifier): DicePool                                 │   │
│  │  + «static» Parse(notation): DicePool                               │   │
│  │  + «static» TryParse(notation, out result): bool                    │   │
│  │  + «static» D4(count?, modifier?): DicePool                         │   │
│  │  + «static» D6(count?, modifier?): DicePool                         │   │
│  │  + «static» D8(count?, modifier?): DicePool                         │   │
│  │  + «static» D10(count?, modifier?): DicePool                        │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                              │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │  <<record struct>>                                                   │   │
│  │  DiceRollResult                                                      │   │
│  ├─────────────────────────────────────────────────────────────────────┤   │
│  │  + Pool: DicePool {get; init;}                                      │   │
│  │  + Rolls: IReadOnlyList<int> {get; init;}                           │   │
│  │  + ExplosionRolls: IReadOnlyList<int> {get; init;}                  │   │
│  │  + DiceTotal: int {get; init;}                                      │   │
│  │  + Total: int {get; init;}                                          │   │
│  │  + AdvantageType: AdvantageType {get; init;}                        │   │
│  │  + AllRollTotals: IReadOnlyList<int> {get; init;}                   │   │
│  │  + SelectedRollIndex: int {get; init;}                              │   │
│  ├─────────────────────────────────────────────────────────────────────┤   │
│  │  + IsNaturalMax: bool {get;} → Rolls[0] == Pool.Faces               │   │
│  │  + IsNaturalOne: bool {get;} → Rolls[0] == 1                        │   │
│  │  + HadExplosions: bool {get;} → ExplosionRolls.Count > 0            │   │
│  │  + ExplosionCount: int {get;} → ExplosionRolls.Count                │   │
│  ├─────────────────────────────────────────────────────────────────────┤   │
│  │  + DiceRollResult(pool, rolls, total, ...)                          │   │
│  │  + ToString(): string → "3d6+5: [4,2,5] +5 = 16"                    │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────┐
│                            APPLICATION LAYER                                 │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │  <<class>>                                                           │   │
│  │  DiceService                                                         │   │
│  ├─────────────────────────────────────────────────────────────────────┤   │
│  │  - _random: Random                                                   │   │
│  │  - _logger: ILogger<DiceService>                                    │   │
│  ├─────────────────────────────────────────────────────────────────────┤   │
│  │  + DiceService(logger, random?)                                     │   │
│  │  + Roll(pool, advantageType?): DiceRollResult                       │   │
│  │  + Roll(notation, advantageType?): DiceRollResult                   │   │
│  │  + Roll(diceType, count?, modifier?): DiceRollResult                │   │
│  │  + RollTotal(pool): int                                             │   │
│  │  + RollTotal(notation): int                                         │   │
│  ├─────────────────────────────────────────────────────────────────────┤   │
│  │  - RollOnce(pool, advantageType): DiceRollResult                    │   │
│  │  - RollSingleDie(faces): int                                        │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                              │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │  <<record>>                                                          │   │
│  │  DiceRollDto                                                         │   │
│  ├─────────────────────────────────────────────────────────────────────┤   │
│  │  + Notation: string                                                  │   │
│  │  + Rolls: IReadOnlyList<int>                                        │   │
│  │  + ExplosionRolls: IReadOnlyList<int>                               │   │
│  │  + Modifier: int                                                     │   │
│  │  + DiceTotal: int                                                    │   │
│  │  + Total: int                                                        │   │
│  │  + IsNaturalMax: bool                                               │   │
│  │  + IsNaturalOne: bool                                               │   │
│  │  + HadExplosions: bool                                              │   │
│  │  + AdvantageType: string                                            │   │
│  │  + AllRollTotals: IReadOnlyList<int>?                               │   │
│  │  + Descriptor: string?                                               │   │
│  ├─────────────────────────────────────────────────────────────────────┤   │
│  │  + «static» FromDomainResult(result, descriptor?): DiceRollDto      │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                              │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │  <<record>>                                                          │   │
│  │  DicePoolDto                                                         │   │
│  ├─────────────────────────────────────────────────────────────────────┤   │
│  │  + Id: string                                                        │   │
│  │  + Name: string                                                      │   │
│  │  + Notation: string                                                  │   │
│  │  + Exploding: bool                                                   │   │
│  │  + MaxExplosions: int                                               │   │
│  │  + Description: string?                                             │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

### Sequence Diagram: Roll with Advantage

```
┌─────────┐          ┌─────────────┐          ┌────────────────┐
│ Caller  │          │ DiceService │          │    Random      │
└────┬────┘          └──────┬──────┘          └───────┬────────┘
     │                      │                         │
     │ Roll(pool, Advantage)│                         │
     │─────────────────────>│                         │
     │                      │                         │
     │                      │ RollOnce(pool)          │
     │                      │────────────┐            │
     │                      │            │            │
     │                      │    for each die:        │
     │                      │            │            │
     │                      │            │ Next(1, faces+1)
     │                      │            │───────────>│
     │                      │            │            │
     │                      │            │   value    │
     │                      │            │<───────────│
     │                      │            │            │
     │                      │<───────────┘            │
     │                      │ roll1: DiceRollResult   │
     │                      │                         │
     │                      │ RollOnce(pool)          │
     │                      │────────────┐            │
     │                      │            │            │
     │                      │    for each die:        │
     │                      │            │            │
     │                      │            │ Next(1, faces+1)
     │                      │            │───────────>│
     │                      │            │            │
     │                      │            │   value    │
     │                      │            │<───────────│
     │                      │            │            │
     │                      │<───────────┘            │
     │                      │ roll2: DiceRollResult   │
     │                      │                         │
     │                      │ Compare: MAX(roll1, roll2)
     │                      │                         │
     │   DiceRollResult     │                         │
     │<─────────────────────│                         │
     │   (AllRollTotals,    │                         │
     │    SelectedRoll)     │                         │
     │                      │                         │
```

### Sequence Diagram: Exploding Dice

```
┌─────────┐          ┌─────────────┐          ┌────────────────┐
│ Caller  │          │ DiceService │          │    Random      │
└────┬────┘          └──────┬──────┘          └───────┬────────┘
     │                      │                         │
     │ Roll(1d6!)           │                         │
     │─────────────────────>│                         │
     │                      │                         │
     │                      │ Next(1, 7)              │
     │                      │────────────────────────>│
     │                      │                         │
     │                      │         6 (MAX!)        │
     │                      │<────────────────────────│
     │                      │                         │
     │                      │ rolls = [6]             │
     │                      │ exploding && roll==6    │
     │                      │                         │
     │                      │ Next(1, 7)  [explosion] │
     │                      │────────────────────────>│
     │                      │                         │
     │                      │         6 (MAX!)        │
     │                      │<────────────────────────│
     │                      │                         │
     │                      │ explosions = [6]        │
     │                      │ count=1, still==6       │
     │                      │                         │
     │                      │ Next(1, 7)  [explosion] │
     │                      │────────────────────────>│
     │                      │                         │
     │                      │         3               │
     │                      │<────────────────────────│
     │                      │                         │
     │                      │ explosions = [6, 3]     │
     │                      │ count=2, 3!=6, stop     │
     │                      │                         │
     │   DiceRollResult     │                         │
     │<─────────────────────│                         │
     │   Rolls: [6]         │                         │
     │   Explosions: [6,3]  │                         │
     │   Total: 15          │                         │
     │                      │                         │
```

---

## Architecture

### Layer Placement

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           PRESENTATION LAYER                                 │
│                    (Future: Phase 5d will add rendering)                     │
│                                                                              │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────────────────────────────┐ │
│  │ GameView    │  │ Renderer    │  │ InputHandler                        │ │
│  │ (future)    │  │ (future)    │  │ (future: "roll 3d6" command)        │ │
│  └─────────────┘  └─────────────┘  └─────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────────────────────┘
                                      │
                                      ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                           APPLICATION LAYER                                  │
│                        ★ NEW IN PHASE 5a ★                                  │
│                                                                              │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                        DiceService                                   │   │
│  │  - Roll dice pools with various configurations                       │   │
│  │  - Handle advantage/disadvantage                                     │   │
│  │  - Process exploding dice                                           │   │
│  │  - Log all operations                                               │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                              │
│  ┌───────────────────────┐  ┌───────────────────────┐                      │
│  │      DiceRollDto      │  │     DicePoolDto       │                      │
│  │  (for presentation)   │  │  (for configuration)  │                      │
│  └───────────────────────┘  └───────────────────────┘                      │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
                                      │
                                      ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                            DOMAIN LAYER                                      │
│                        ★ NEW IN PHASE 5a ★                                  │
│                                                                              │
│  ┌───────────────────────────────────────────────────────────────────────┐ │
│  │                         Enums/                                         │ │
│  │  ┌──────────────┐  ┌──────────────────┐  ┌──────────────────┐        │ │
│  │  │  DiceType    │  │  AdvantageType   │  │  SuccessLevel    │        │ │
│  │  │  d4-d100     │  │  Normal/Adv/Dis  │  │  Crit to Success │        │ │
│  │  └──────────────┘  └──────────────────┘  └──────────────────┘        │ │
│  └───────────────────────────────────────────────────────────────────────┘ │
│                                                                              │
│  ┌───────────────────────────────────────────────────────────────────────┐ │
│  │                       ValueObjects/                                    │ │
│  │  ┌───────────────────────────┐  ┌───────────────────────────┐        │ │
│  │  │        DicePool           │  │     DiceRollResult        │        │ │
│  │  │  - Count, Type, Modifier  │  │  - Rolls, Explosions      │        │ │
│  │  │  - Exploding, MaxExpl     │  │  - Total, Criticals       │        │ │
│  │  │  - Parse(), ToString()    │  │  - Advantage details      │        │ │
│  │  └───────────────────────────┘  └───────────────────────────┘        │ │
│  └───────────────────────────────────────────────────────────────────────┘ │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

### File Structure

```
src/
├── Core/
│   ├── RuneAndRust.Domain/
│   │   ├── Enums/
│   │   │   ├── DiceType.cs              ★ NEW
│   │   │   ├── AdvantageType.cs         ★ NEW
│   │   │   └── SuccessLevel.cs          ★ NEW
│   │   └── ValueObjects/
│   │       ├── DicePool.cs              ★ NEW
│   │       └── DiceRollResult.cs        ★ NEW
│   │
│   └── RuneAndRust.Application/
│       ├── Services/
│       │   └── DiceService.cs           ★ NEW
│       └── DTOs/
│           └── DiceDtos.cs              ★ NEW
│
tests/
├── RuneAndRust.Domain.UnitTests/
│   ├── Enums/
│   │   └── DiceTypeTests.cs             ★ NEW (optional)
│   └── ValueObjects/
│       ├── DicePoolTests.cs             ★ NEW
│       └── DiceRollResultTests.cs       ★ NEW
│
└── RuneAndRust.Application.UnitTests/
    └── Services/
        └── DiceServiceTests.cs          ★ NEW
```

---

## Workflows & Decision Trees

### Main Roll Workflow

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           DICE ROLL WORKFLOW                                 │
└─────────────────────────────────────────────────────────────────────────────┘

                    ┌─────────────────────┐
                    │   Roll Request      │
                    │   (pool, advantage) │
                    └──────────┬──────────┘
                               │
                               ▼
                    ┌─────────────────────┐
                    │  Log: "Rolling      │
                    │  {pool} with        │
                    │  {advantage}"       │
                    └──────────┬──────────┘
                               │
                               ▼
              ┌────────────────────────────────────┐
              │        Is Advantage/Disadvantage?   │
              └────────────────┬───────────────────┘
                               │
              ┌────────────────┴────────────────┐
              │ NORMAL                          │ ADV/DIS
              ▼                                 ▼
    ┌─────────────────┐               ┌─────────────────┐
    │  RollOnce()     │               │  RollOnce() x2  │
    │  → result       │               │  → roll1, roll2 │
    └────────┬────────┘               └────────┬────────┘
             │                                  │
             │                                  ▼
             │                        ┌─────────────────┐
             │                        │ Select Best/    │
             │                        │ Worst by        │
             │                        │ Advantage Type  │
             │                        └────────┬────────┘
             │                                  │
             │                                  ▼
             │                        ┌─────────────────┐
             │                        │ Build Result    │
             │                        │ w/ AllRollTotals│
             │                        └────────┬────────┘
             │                                  │
             └──────────────┬──────────────────┘
                            │
                            ▼
                  ┌─────────────────────┐
                  │  Log: "Roll {pool}: │
                  │  {details} = {total}│
                  └──────────┬──────────┘
                             │
                             ▼
                  ┌─────────────────────┐
                  │  Return Result      │
                  └─────────────────────┘
```

### RollOnce Sub-Workflow

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                         ROLL ONCE SUB-WORKFLOW                               │
└─────────────────────────────────────────────────────────────────────────────┘

                    ┌─────────────────────┐
                    │  RollOnce(pool)     │
                    └──────────┬──────────┘
                               │
                               ▼
                    ┌─────────────────────┐
                    │  rolls = []         │
                    │  explosions = []    │
                    └──────────┬──────────┘
                               │
                               ▼
                    ┌─────────────────────┐
                    │  for i = 0 to       │
                    │  pool.Count - 1     │
                    └──────────┬──────────┘
                               │
                               ▼
                    ┌─────────────────────┐
                    │  roll = Random.Next │
                    │  (1, faces + 1)     │
                    └──────────┬──────────┘
                               │
                               ▼
                    ┌─────────────────────┐
                    │  rolls.Add(roll)    │
                    └──────────┬──────────┘
                               │
                               ▼
              ┌────────────────────────────────────┐
              │  pool.Exploding && roll == faces?  │
              └────────────────┬───────────────────┘
                               │
              ┌────────────────┴────────────────┐
              │ NO                              │ YES
              │                                 ▼
              │                      ┌─────────────────────┐
              │                      │  EXPLOSION LOOP     │
              │                      │  while (roll==faces │
              │                      │    && count < max)  │
              │                      │  {                  │
              │                      │    roll = Random()  │
              │                      │    explosions.Add() │
              │                      │    count++          │
              │                      │    Log explosion    │
              │                      │  }                  │
              │                      └──────────┬──────────┘
              │                                 │
              └──────────────┬──────────────────┘
                             │
                             ▼
                    ┌─────────────────────┐
                    │  Next iteration or  │
                    │  continue below     │
                    └──────────┬──────────┘
                               │
                               ▼ (after loop)
                    ┌─────────────────────┐
                    │  diceTotal =        │
                    │  sum(rolls) +       │
                    │  sum(explosions)    │
                    └──────────┬──────────┘
                               │
                               ▼
                    ┌─────────────────────┐
                    │  total = diceTotal  │
                    │  + pool.Modifier    │
                    └──────────┬──────────┘
                               │
                               ▼
                    ┌─────────────────────┐
                    │  Log: dice details  │
                    └──────────┬──────────┘
                               │
                               ▼
                    ┌─────────────────────┐
                    │  Return             │
                    │  DiceRollResult     │
                    └─────────────────────┘
```

### Notation Parsing Decision Tree

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                      DICE NOTATION PARSING                                   │
└─────────────────────────────────────────────────────────────────────────────┘

Input: "3d6+5!"
       │
       ▼
┌──────────────────────┐
│ Is input null/empty? │
└──────────┬───────────┘
           │
    YES    │    NO
     │     └───────────────────┐
     ▼                         ▼
┌──────────────────┐  ┌──────────────────┐
│ FormatException: │  │ EndsWith('!')?   │
│ "cannot be empty"│  └──────────┬───────┘
└──────────────────┘             │
                          YES    │    NO
                           │     └─────────────┐
                           ▼                   │
                  ┌──────────────────┐        │
                  │ exploding = true │        │
                  │ Remove '!' from  │        │
                  │ notation         │        │
                  └────────┬─────────┘        │
                           │                   │
                           └───────────────────┼───────────────────┐
                                               │                   │
                                               ▼                   │
                                      ┌──────────────────┐        │
                                      │ Find 'd' index   │        │
                                      └──────────┬───────┘        │
                                                 │                 │
                                    NOT FOUND    │    FOUND        │
                                        │        └─────────────────┤
                                        ▼                          │
                              ┌──────────────────┐                │
                              │ FormatException: │                │
                              │ "Invalid dice    │                │
                              │ notation"        │                │
                              └──────────────────┘                │
                                                                   │
                                                                   ▼
                                                     ┌──────────────────────┐
                                                     │ Parse count          │
                                                     │ (before 'd')         │
                                                     │ default = 1          │
                                                     └──────────┬───────────┘
                                                                │
                                                     INVALID    │    VALID
                                                        │       └─────────────┐
                                                        ▼                     │
                                              ┌──────────────────┐           │
                                              │ FormatException: │           │
                                              │ "Invalid dice    │           │
                                              │ count"           │           │
                                              └──────────────────┘           │
                                                                              │
                                                                              ▼
                                                               ┌──────────────────────┐
                                                               │ Find '+' or '-'      │
                                                               │ for modifier         │
                                                               └──────────┬───────────┘
                                                                          │
                                                               FOUND      │    NOT FOUND
                                                                 │        └─────────────┐
                                                                 ▼                      │
                                                    ┌──────────────────┐               │
                                                    │ Parse faces      │               │
                                                    │ Parse modifier   │               │
                                                    └──────────┬───────┘               │
                                                               │                        │
                                                               └────────────────────────┤
                                                                                        │
                                                                                        ▼
                                                                          ┌──────────────────────┐
                                                                          │ Validate faces:      │
                                                                          │ 4,6,8,10,12,20,100? │
                                                                          └──────────┬───────────┘
                                                                                     │
                                                                          INVALID    │    VALID
                                                                             │       └─────────────┐
                                                                             ▼                     │
                                                                   ┌──────────────────┐           │
                                                                   │ FormatException: │           │
                                                                   │ "Unsupported     │           │
                                                                   │ dice type"       │           │
                                                                   └──────────────────┘           │
                                                                                                   │
                                                                                                   ▼
                                                                                    ┌──────────────────────┐
                                                                                    │ Return DicePool      │
                                                                                    │ (count, type,        │
                                                                                    │  modifier, exploding)│
                                                                                    └──────────────────────┘
```

---

## API Reference

### DicePool API

```csharp
// Construction
var pool = new DicePool(3, DiceType.D6, 5);           // 3d6+5
var pool = new DicePool(2, DiceType.D8, -2);          // 2d8-2
var pool = new DicePool(1, DiceType.D6, 0, true);     // 1d6! (exploding)
var pool = new DicePool(1, DiceType.D6, 0, true, 5);  // 1d6! (max 5 explosions)

// Static factories
var pool = DicePool.D10();                 // 1d10 (standard resolution die)
var pool = DicePool.D6(3, 2);              // 3d6+2
var pool = DicePool.D8(2).WithModifier(5); // 2d8+5

// Parsing
var pool = DicePool.Parse("3d6+5");        // 3d6+5
var pool = DicePool.Parse("d10");          // 1d10
var pool = DicePool.Parse("2d8!");         // 2d8! (exploding)

if (DicePool.TryParse("invalid", out var result))
{
    // Use result
}

// Modification (immutable - returns new instance)
var exploding = pool.WithExploding();      // Add exploding
var modified = pool.WithModifier(10);      // Change modifier

// Properties
int count = pool.Count;                    // Number of dice
int faces = pool.Faces;                    // Faces per die
int modifier = pool.Modifier;              // Flat modifier
bool exploding = pool.Exploding;           // Exploding enabled
int min = pool.MinimumResult;              // Theoretical minimum
int max = pool.MaximumResult;              // Theoretical maximum
float avg = pool.AverageResult;            // Expected average

// Display
string notation = pool.ToString();         // "3d6+5"
```

### DiceService API

```csharp
// Dependency injection
services.AddSingleton<DiceService>();

// Construction (manual)
var service = new DiceService(logger);
var service = new DiceService(logger, seededRandom);  // For testing

// Rolling
DiceRollResult result = service.Roll(pool);
DiceRollResult result = service.Roll(pool, AdvantageType.Advantage);
DiceRollResult result = service.Roll("3d6+5");
DiceRollResult result = service.Roll("1d10", AdvantageType.Disadvantage);
DiceRollResult result = service.Roll(DiceType.D10, count: 1, modifier: 5);

// Quick total (no breakdown)
int total = service.RollTotal(pool);
int total = service.RollTotal("3d6");
```

### DiceRollResult API

```csharp
// Properties
DicePool pool = result.Pool;                          // Original pool
IReadOnlyList<int> rolls = result.Rolls;              // [4, 2, 6]
IReadOnlyList<int> explosions = result.ExplosionRolls; // [5, 3] if exploded
int diceTotal = result.DiceTotal;                     // Sum of dice only
int total = result.Total;                             // Final total w/ modifier
AdvantageType adv = result.AdvantageType;             // Normal/Advantage/Disadvantage
IReadOnlyList<int> allTotals = result.AllRollTotals;  // [14, 18] for advantage
int selectedIdx = result.SelectedRollIndex;           // Which roll was selected

// Computed properties
bool isNat10 = result.IsNaturalMax;                   // Rolled max on first die
bool isNat1 = result.IsNaturalOne;                    // Rolled 1 on first die
bool exploded = result.HadExplosions;                 // Any explosions occurred
int explosionCount = result.ExplosionCount;           // Number of explosions

// Display
string display = result.ToString();
// "3d6+5: [4, 2, 6] +5 = 17"
// "1d10: [10] = 10 (ADV: [10, 7])"
```

### DiceRollDto API

```csharp
// Create from domain result
var dto = DiceRollDto.FromDomainResult(result);
var dto = DiceRollDto.FromDomainResult(result, "Fortune favors you!");

// Properties (all from domain, plus)
string? descriptor = dto.Descriptor;  // Flavor text
```

---

## Configuration

### Future Configuration (Phase 5d)

While Phase 5a doesn't require configuration files, here's the planned structure for Phase 5d:

```json
// config/dice.json (FUTURE - not implemented in 5a)
{
  "$schema": "dice.schema.json",
  "defaultMaxExplosions": 10,
  "commonPools": [
    {
      "id": "attack",
      "name": "Attack Roll",
      "notation": "1d20",
      "description": "Standard attack roll"
    },
    {
      "id": "damage-sword",
      "name": "Sword Damage",
      "notation": "1d8",
      "description": "Standard longsword damage"
    },
    {
      "id": "damage-dagger",
      "name": "Dagger Damage",
      "notation": "1d4",
      "description": "Standard dagger damage"
    }
  ]
}
```

### Dependency Injection

```csharp
// In DependencyInjection.cs (Infrastructure)
public static IServiceCollection AddDiceServices(this IServiceCollection services)
{
    services.AddSingleton<DiceService>();
    return services;
}
```

---

## Logging Strategy

### Log Levels

| Level | Use Case | Example |
|-------|----------|---------|
| **Information** | Service lifecycle, completed rolls | "DiceService initialized", "Roll 3d6+5: 17" |
| **Debug** | Roll details, explosions, advantage selection | "Die exploded! Roll 6 on d6" |
| **Warning** | Parse failures, edge cases | "Invalid dice notation: xyz" |
| **Error** | Unexpected failures | "Failed to roll dice pool" |

### Log Message Templates

```csharp
// Service initialization
_logger.LogInformation("DiceService initialized");

// Roll request
_logger.LogDebug("Rolling {Pool} with {AdvantageType}", pool, advantageType);

// Single die roll
_logger.LogDebug("Die {Index}: rolled {Value} on d{Faces}", i, roll, pool.Faces);

// Explosion
_logger.LogDebug(
    "Die exploded! Roll {ExplosionValue} on d{Faces} (explosion {Count})",
    explosionRoll, pool.Faces, explosionCount);

// Roll complete (single)
_logger.LogDebug(
    "Rolled {Pool}: dice=[{Rolls}] explosions=[{Explosions}] total={Total}",
    pool, string.Join(",", rolls), string.Join(",", explosions), total);

// Roll complete (advantage/disadvantage)
_logger.LogInformation(
    "Roll {Pool} ({AdvantageType}): [{Roll1}, {Roll2}] -> {Selected}",
    pool, advantageType, roll1.Total, roll2.Total, result.Total);

// Parse error
_logger.LogWarning("Failed to parse dice notation: {Notation} - {Error}",
    notation, ex.Message);
```

### Structured Logging Properties

| Property | Type | Description |
|----------|------|-------------|
| Pool | string | Dice notation (e.g., "3d6+5") |
| AdvantageType | string | "Normal", "Advantage", "Disadvantage" |
| Rolls | string | Comma-separated rolls (e.g., "4,2,6") |
| Explosions | string | Comma-separated explosions |
| Total | int | Final result |
| Roll1 | int | First roll total (advantage) |
| Roll2 | int | Second roll total (advantage) |
| Selected | int | Selected total (advantage) |
| ExplosionValue | int | Individual explosion roll |
| ExplosionCount | int | Current explosion count |

---

## Testing Strategy

### Test Organization

```
tests/
├── RuneAndRust.Domain.UnitTests/
│   └── ValueObjects/
│       ├── DicePoolTests.cs           (14 tests)
│       └── DiceRollResultTests.cs     (6 tests)
│
└── RuneAndRust.Application.UnitTests/
    └── Services/
        └── DiceServiceTests.cs        (10 tests)
```

### Test Categories

#### DicePoolTests (14 tests)

| Test Name | Category | Description |
|-----------|----------|-------------|
| Constructor_WithValidCount_CreatesDicePool | Construction | Basic creation |
| Constructor_WithZeroCount_ThrowsException | Validation | Count validation |
| Constructor_WithNegativeCount_ThrowsException | Validation | Count validation |
| Constructor_WithNegativeMaxExplosions_ThrowsException | Validation | MaxExplosions validation |
| MinimumResult_CalculatesCorrectly | Calculation | Min formula |
| MaximumResult_CalculatesCorrectly | Calculation | Max formula |
| AverageResult_CalculatesCorrectly | Calculation | Average formula |
| ToString_FormatsPositiveModifier | Formatting | "+5" format |
| ToString_FormatsNegativeModifier | Formatting | "-3" format |
| ToString_FormatsExploding | Formatting | "!" suffix |
| Parse_ValidNotation_CreatesDicePool | Parsing | Basic parse |
| Parse_NegativeModifier_ParsesCorrectly | Parsing | "-3" modifier |
| Parse_ExplodingNotation_SetsFlag | Parsing | "!" suffix |
| Parse_InvalidNotation_ThrowsFormatException | Parsing | Error handling |

#### DiceRollResultTests (6 tests)

| Test Name | Category | Description |
|-----------|----------|-------------|
| IsNaturalMax_WhenFirstDieIsMax_ReturnsTrue | Critical | Max detection |
| IsNaturalMax_WhenFirstDieNotMax_ReturnsFalse | Critical | Max detection |
| IsNaturalOne_WhenFirstDieIsOne_ReturnsTrue | Critical | One detection |
| IsNaturalOne_WhenFirstDieNotOne_ReturnsFalse | Critical | One detection |
| HadExplosions_WhenExplosionsExist_ReturnsTrue | Explosions | Explosion detection |
| ToString_FormatsCorrectly | Formatting | Display format |

#### DiceServiceTests (10 tests)

| Test Name | Category | Description |
|-----------|----------|-------------|
| Roll_SingleD10_ReturnsValidRange | Rolling | Range validation |
| Roll_3d6Plus5_ReturnsCorrectRange | Rolling | Range with modifier |
| Roll_WithAdvantage_RollsTwiceAndTakesHigher | Advantage | Higher selection |
| Roll_WithDisadvantage_RollsTwiceAndTakesLower | Advantage | Lower selection |
| Roll_ExplodingDice_ChainsExplosions | Explosions | Chain behavior |
| Roll_ExplodingDice_RespectsMaxExplosions | Explosions | Cap enforcement |
| Roll_FromNotation_ParsesAndRolls | Integration | Notation + roll |
| Roll_InvalidNotation_ThrowsFormatException | Error | Parse error |
| RollTotal_ReturnsJustTotal | Convenience | Total only |
| Roll_WithSeededRandom_ProducesDeterministicResult | Determinism | Testing support |

### Test Patterns

#### Pattern 1: Range Testing
```csharp
[Test]
public void Roll_SingleD10_ReturnsValidRange()
{
    // Roll many times and verify all results in range
    var results = Enumerable.Range(0, 100)
        .Select(_ => _service.Roll(DicePool.D10()))
        .ToList();

    results.Should().AllSatisfy(r =>
    {
        r.Total.Should().BeInRange(1, 10);
        r.Rolls.Should().HaveCount(1);
    });
}
```

#### Pattern 2: Deterministic Testing
```csharp
[Test]
public void Roll_WithSeededRandom_ProducesDeterministicResult()
{
    // Use seeded random for reproducible tests
    var seededRandom = new Random(42);
    var service = new DiceService(_mockLogger.Object, seededRandom);

    var result1 = service.Roll(DicePool.D10());

    // Reset and roll again
    seededRandom = new Random(42);
    service = new DiceService(_mockLogger.Object, seededRandom);
    var result2 = service.Roll(DicePool.D10());

    result1.Total.Should().Be(result2.Total);
}
```

#### Pattern 3: Statistical Testing
```csharp
[Test]
public void Roll_ManyD6_ProducesReasonableDistribution()
{
    var results = Enumerable.Range(0, 6000)
        .Select(_ => _service.Roll(DicePool.D6()))
        .GroupBy(r => r.Total)
        .ToDictionary(g => g.Key, g => g.Count());

    // Each face should appear roughly 1000 times (6000/6)
    // Allow 20% variance
    foreach (var (face, count) in results)
    {
        count.Should().BeInRange(800, 1200,
            $"Face {face} appeared {count} times, expected ~1000");
    }
}
```

#### Pattern 4: Explosion Testing
```csharp
[Test]
public void Roll_ExplodingDice_ChainsExplosions()
{
    // Force explosions with seeded random that produces max values
    var mockRandom = new MockRandomThatReturns(new[] { 6, 6, 6, 3 });
    var service = new DiceService(_mockLogger.Object, mockRandom);

    var pool = DicePool.D6().WithExploding();
    var result = service.Roll(pool);

    result.Rolls.Should().Equal(new[] { 6 });
    result.ExplosionRolls.Should().Equal(new[] { 6, 6, 3 });
    result.HadExplosions.Should().BeTrue();
    result.ExplosionCount.Should().Be(3);
    result.DiceTotal.Should().Be(21); // 6 + 6 + 6 + 3
}
```

### Mock Classes for Testing

```csharp
/// <summary>
/// Mock Random that returns predetermined values.
/// </summary>
public class MockRandomSequence : Random
{
    private readonly Queue<int> _values;

    public MockRandomSequence(IEnumerable<int> values)
    {
        _values = new Queue<int>(values);
    }

    public override int Next(int minValue, int maxValue)
    {
        if (_values.Count == 0)
            throw new InvalidOperationException("No more mock values");
        return _values.Dequeue();
    }
}
```

---

## Documentation Requirements

### XML Documentation (Required)

All public types and members must have XML documentation:

```csharp
/// <summary>
/// Represents a pool of dice to be rolled together.
/// </summary>
/// <remarks>
/// Immutable value object supporting standard dice notation (e.g., "3d6+5").
/// Use static factory methods or Parse() for convenient construction.
/// </remarks>
/// <example>
/// <code>
/// var pool = DicePool.Parse("3d6+5");
/// var pool = DicePool.D20();
/// var pool = new DicePool(2, DiceType.D8, modifier: 3);
/// </code>
/// </example>
public readonly record struct DicePool
```

### Code Examples in Documentation

```csharp
/// <summary>
/// Rolls a dice pool and returns the result.
/// </summary>
/// <param name="pool">The dice pool to roll.</param>
/// <param name="advantageType">Whether to roll with advantage or disadvantage.</param>
/// <returns>The complete roll result with breakdown.</returns>
/// <example>
/// Basic roll:
/// <code>
/// var result = diceService.Roll(DicePool.D10());
/// Console.WriteLine($"Rolled {result.Total}");
/// </code>
///
/// Roll with advantage:
/// <code>
/// var result = diceService.Roll(DicePool.D10(), AdvantageType.Advantage);
/// Console.WriteLine($"Best of {result.AllRollTotals[0]} and {result.AllRollTotals[1]}: {result.Total}");
/// </code>
///
/// Exploding dice:
/// <code>
/// var pool = DicePool.D6().WithExploding();
/// var result = diceService.Roll(pool);
/// if (result.HadExplosions)
///     Console.WriteLine($"Exploded {result.ExplosionCount} times!");
/// </code>
/// </example>
public DiceRollResult Roll(DicePool pool, AdvantageType advantageType = AdvantageType.Normal)
```

### README Section (Future)

Add to project README after implementation:

```markdown
## Dice System

The dice system provides flexible dice rolling capabilities using d4, d6, d8, and d10 dice. All skill checks and resolutions use d10 increments.

### Basic Usage

```csharp
var diceService = serviceProvider.GetRequiredService<DiceService>();

// Roll a d10 (standard resolution die)
var result = diceService.Roll(DicePool.D10());

// Roll 3d6+5
var result = diceService.Roll("3d6+5");

// Roll with advantage (take higher of two)
var result = diceService.Roll(DicePool.D10(), AdvantageType.Advantage);
```

### Dice Notation

| Notation | Description |
|----------|-------------|
| `3d6` | Roll 3 six-sided dice |
| `1d10+5` | Roll d10 and add 5 |
| `2d8-2` | Roll 2d8 and subtract 2 |
| `1d6!` | Roll exploding d6 (reroll on 6) |
```

---

## Implementation Checklist

### Phase 5a Deliverables

#### Domain Layer
- [ ] Create `src/Core/RuneAndRust.Domain/Enums/DiceType.cs`
  - [ ] Define enum with D4, D6, D8, D10
  - [ ] Add XML documentation
- [ ] Create `src/Core/RuneAndRust.Domain/Enums/AdvantageType.cs`
  - [ ] Define enum with Normal, Advantage, Disadvantage
  - [ ] Add XML documentation
- [ ] Create `src/Core/RuneAndRust.Domain/Enums/SuccessLevel.cs`
  - [ ] Define enum with CriticalFailure, Failure, Success, CriticalSuccess
  - [ ] Add XML documentation
- [ ] Create `src/Core/RuneAndRust.Domain/ValueObjects/DicePool.cs`
  - [ ] Implement as readonly record struct
  - [ ] Add constructor with validation
  - [ ] Add calculated properties (Faces, Min, Max, Avg)
  - [ ] Add ToString() formatting
  - [ ] Add static factory methods (D4, D6, D8, D10)
  - [ ] Add WithExploding() and WithModifier()
  - [ ] Add Parse() and TryParse()
  - [ ] Add XML documentation
- [ ] Create `src/Core/RuneAndRust.Domain/ValueObjects/DiceRollResult.cs`
  - [ ] Implement as readonly record struct
  - [ ] Add constructor with field initialization
  - [ ] Add IsNaturalMax and IsNaturalOne properties
  - [ ] Add HadExplosions and ExplosionCount properties
  - [ ] Add ToString() formatting
  - [ ] Add XML documentation

#### Application Layer
- [ ] Create `src/Core/RuneAndRust.Application/Services/DiceService.cs`
  - [ ] Add Random field
  - [ ] Add ILogger field
  - [ ] Add constructor with optional Random injection
  - [ ] Implement Roll(DicePool, AdvantageType)
  - [ ] Implement Roll(string notation, AdvantageType)
  - [ ] Implement Roll(DiceType, count, modifier)
  - [ ] Implement RollTotal() convenience methods
  - [ ] Implement RollOnce() private method
  - [ ] Implement RollSingleDie() private method
  - [ ] Add comprehensive logging
  - [ ] Add XML documentation
- [ ] Create `src/Core/RuneAndRust.Application/DTOs/DiceDtos.cs`
  - [ ] Add DiceRollDto record
  - [ ] Add DicePoolDto record
  - [ ] Add FromDomainResult() factory method
  - [ ] Add XML documentation

#### Tests
- [ ] Create `tests/RuneAndRust.Domain.UnitTests/ValueObjects/DicePoolTests.cs`
  - [ ] Constructor tests (4)
  - [ ] Calculation tests (3)
  - [ ] Formatting tests (3)
  - [ ] Parsing tests (4)
- [ ] Create `tests/RuneAndRust.Domain.UnitTests/ValueObjects/DiceRollResultTests.cs`
  - [ ] Critical detection tests (4)
  - [ ] Explosion tests (1)
  - [ ] Formatting tests (1)
- [ ] Create `tests/RuneAndRust.Application.UnitTests/Services/DiceServiceTests.cs`
  - [ ] Range tests (2)
  - [ ] Advantage/Disadvantage tests (2)
  - [ ] Explosion tests (2)
  - [ ] Integration tests (2)
  - [ ] Determinism tests (1)
  - [ ] Error handling tests (1)

#### Validation
- [ ] All 22 new tests pass
- [ ] All existing 198 tests pass
- [ ] Build completes with 0 errors
- [ ] Build completes with 0 warnings
- [ ] Code coverage ≥ 90% for new code

---

## Acceptance Criteria

### Functional Criteria

| ID | Criterion | Verification |
|----|-----------|--------------|
| AC-1 | Can roll any standard dice type (d4, d6, d8, d10) | Unit test |
| AC-2 | Can roll multiple dice of same type | Unit test |
| AC-3 | Can add positive and negative modifiers | Unit test |
| AC-4 | Advantage rolls twice and takes higher | Unit test |
| AC-5 | Disadvantage rolls twice and takes lower | Unit test |
| AC-6 | Exploding dice chain on max value | Unit test |
| AC-7 | Explosion cap is enforced | Unit test |
| AC-8 | Natural max detected on first die | Unit test |
| AC-9 | Natural one detected on first die | Unit test |
| AC-10 | Can parse standard dice notation | Unit test |
| AC-11 | Parse handles all variations | Unit test |
| AC-12 | Invalid notation throws FormatException | Unit test |

### Non-Functional Criteria

| ID | Criterion | Verification |
|----|-----------|--------------|
| NF-1 | DicePool is immutable | Code review |
| NF-2 | DiceRollResult is immutable | Code review |
| NF-3 | All public APIs documented | Code review |
| NF-4 | Logging at appropriate levels | Code review |
| NF-5 | No breaking changes to existing code | Test suite |
| NF-6 | Testable via dependency injection | Unit test with mock Random |

---

## Dependencies & Integration

### Dependencies (Phase 5a)

| Dependency | Type | Notes |
|------------|------|-------|
| Microsoft.Extensions.Logging | NuGet | Logging infrastructure |
| System.Random | BCL | Randomization (injectable) |

### Integration Points (Future Phases)

| Phase | Integration | Impact on 5a |
|-------|-------------|--------------|
| 5b | SkillCheckService uses DiceService | DiceService must be injectable |
| 5c | CombatService uses DiceService | DiceRollResult must expose all data |
| 5d | Renderer displays DiceRollDto | DTO must contain all display data |
| 5d | Commands parse dice notation | DicePool.Parse must handle edge cases |

### Breaking Change Risk

**Risk: None**

Phase 5a introduces new types only. No existing code is modified. No breaking changes.

### Backward Compatibility

| Component | Compatibility |
|-----------|---------------|
| CombatService | Unchanged (will integrate in 5c) |
| GameSessionService | Unchanged (will integrate in 5c) |
| Configuration | No changes required |
| Database | No changes required |

---

## Summary

Phase 5a establishes the foundational dice rolling system through:

1. **3 Domain Enums**: DiceType, AdvantageType, SuccessLevel
2. **2 Domain Value Objects**: DicePool, DiceRollResult
3. **1 Application Service**: DiceService
4. **1 DTO File**: DiceDtos.cs (DiceRollDto, DicePoolDto)
5. **22 Unit Tests**: Comprehensive coverage

This phase is isolated and introduces no breaking changes. It provides the building blocks for:
- Skill checks (Phase 5b)
- Combat rolls (Phase 5c)
- User commands (Phase 5d)

**Next Phase:** v0.0.5b - Skill Check System
