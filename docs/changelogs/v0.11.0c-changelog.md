# v0.11.0c Changelog: Gathering Service

**Version:** 0.11.0c
**Phase:** Gathering Service (Resource Harvesting Mechanics)
**Date:** 2026-01-19
**Status:** Complete

---

## Summary

Implements the gathering service that handles the complete resource harvesting flow from harvestable features. This includes skill check validation, dice rolling via the skill service, quantity determination, quality upgrade logic (margin >= 10), inventory updates, feature depletion, and replenishment processing. The service completes the v0.11.0 Resources & Gathering feature set.

---

## Added

### Application Layer - DTOs

| DTO | Description |
|-----|-------------|
| `GatherResult` | Immutable record capturing all gathering attempt details |
| `GatherValidation` | Pre-roll validation result with DC and failure reason |

#### GatherResult Properties

| Property | Type | Description |
|----------|------|-------------|
| `IsSuccess` | `bool` | Whether the gathering attempt succeeded |
| `Roll` | `int` | Raw dice roll result |
| `Modifier` | `int` | Skill modifier applied (Survival) |
| `Total` | `int` | Roll + Modifier |
| `DifficultyClass` | `int` | DC that needed to be met |
| `ResourceId` | `string?` | ID of gathered resource |
| `ResourceName` | `string?` | Display name of resource |
| `Quantity` | `int` | Amount gathered |
| `Quality` | `ResourceQuality?` | Quality tier (may be upgraded) |
| `FeatureDepleted` | `bool` | Whether feature is now depleted |
| `FailureReason` | `string?` | Reason for failure if unsuccessful |

#### GatherResult Factory Methods

| Method | Description |
|--------|-------------|
| `Success(...)` | Creates successful result with all resource details |
| `Failed(roll, modifier, total, dc)` | Creates failure result with dice roll details |
| `ValidationFailed(reason)` | Creates validation failure (no roll made) |

#### GatherResult Computed Properties

| Property | Description |
|----------|-------------|
| `IsValidationFailure` | True if no roll was made (!IsSuccess && Roll == 0) |
| `Margin` | Roll margin (Total - DC) |

#### GatherResult Display Methods

| Method | Description |
|--------|-------------|
| `GetRollDisplay()` | Returns "1d20 (15) +3 = 18 vs DC 12" |
| `GetOutcomeDisplay()` | Returns human-readable outcome |

#### GatherValidation Properties

| Property | Type | Description |
|----------|------|-------------|
| `IsValid` | `bool` | Whether gathering can proceed |
| `DifficultyClass` | `int?` | DC for the gathering check |
| `FailureReason` | `string?` | Reason if validation failed |

#### GatherValidation Factory Methods

| Method | Description |
|--------|-------------|
| `Success(dc)` | Creates valid result with DC |
| `Failed(reason)` | Creates invalid result with reason |

### Application Layer - Events

| Event | Description |
|-------|-------------|
| `GatherAttemptedEvent` | Raised after every gathering attempt (success or failure) |
| `ResourceGatheredEvent` | Raised only on successful gathers |
| `FeatureReplenishedEvent` | Raised when a depleted feature replenishes |

#### GatherAttemptedEvent Properties

| Property | Type | Description |
|----------|------|-------------|
| `PlayerId` | `Guid` | Player who attempted |
| `FeatureId` | `Guid` | Feature instance ID |
| `FeatureDefinitionId` | `string` | Feature definition ID |
| `Roll` | `int` | Raw dice roll |
| `Modifier` | `int` | Skill modifier |
| `Total` | `int` | Roll + Modifier |
| `DifficultyClass` | `int` | DC for the check |
| `Success` | `bool` | Whether check succeeded |
| `Timestamp` | `DateTimeOffset` | When event occurred |
| `Margin` | `int` | Computed: Total - DC |
| `IsCriticalSuccess` | `bool` | True if Roll == 20 |
| `IsCriticalFailure` | `bool` | True if Roll == 1 |

#### ResourceGatheredEvent Properties

| Property | Type | Description |
|----------|------|-------------|
| `PlayerId` | `Guid` | Player who gathered |
| `ResourceId` | `string` | Resource definition ID |
| `ResourceName` | `string` | Resource display name |
| `Quantity` | `int` | Amount gathered |
| `Quality` | `ResourceQuality` | Quality tier |
| `FeatureId` | `Guid` | Feature instance ID |
| `FeatureDepleted` | `bool` | Whether feature depleted |
| `Timestamp` | `DateTimeOffset` | When event occurred |
| `GetTotalValue(baseValue)` | Method | Calculates total value |

#### FeatureReplenishedEvent Properties

| Property | Type | Description |
|----------|------|-------------|
| `FeatureId` | `Guid` | Feature instance ID |
| `FeatureDefinitionId` | `string` | Feature definition ID |
| `RoomId` | `Guid` | Room containing feature |
| `NewQuantity` | `int` | Restored quantity |
| `Timestamp` | `DateTimeOffset` | When event occurred |

### Application Layer - Interfaces

| Interface | Description |
|-----------|-------------|
| `IGatheringService` | Service for gathering resources from harvestable features |

#### IGatheringService Methods

| Method | Description |
|--------|-------------|
| `GetHarvestableFeatures(room)` | Gets non-depleted features in room |
| `CanGather(player, feature)` | Validates gathering attempt |
| `Gather(player, feature)` | Executes complete gathering flow |
| `GetGatherDC(feature)` | Gets DC for a feature |
| `GetGatherModifier(player)` | Gets player's Survival modifier |
| `ProcessReplenishment(room, turn)` | Replenishes ready features |

### Application Layer - Services

| Service | Description |
|---------|-------------|
| `GatheringService` | Implementation of IGatheringService |

#### GatheringService Dependencies

| Dependency | Purpose |
|------------|---------|
| `IHarvestableFeatureProvider` | Feature definitions |
| `IResourceProvider` | Resource definitions |
| `ISkillService` | Skill checks via PerformSkillCheck |
| `IGameEventLogger` | Event logging |
| `ILogger<GatheringService>` | Diagnostic logging |
| `Random` | Quantity randomization |

#### GatheringService Constants

| Constant | Value | Description |
|----------|-------|-------------|
| `GatherSkill` | "survival" | Skill used for gathering |
| `QualityUpgradeMargin` | 10 | Margin needed for quality upgrade |

#### GatheringService Implementation Details

- Uses `ISkillService.PerformSkillCheck()` for gathering rolls (2d6 + modifier)
- Validates tool requirements via inventory check
- Determines quantity within feature's min/max range
- Upgrades quality by one tier when margin >= 10 (capped at Legendary)
- Depletes feature by gathered quantity
- Sets replenishment timer for depleted features that replenish
- Publishes events via `IGameEventLogger.LogInteraction()`

---

## Gathering Mechanics

### Skill Check Formula

```
Roll = 2d6 (via ISkillService)
Modifier = Player's Survival skill bonus
Total = Roll + Modifier
Success = Total >= Difficulty Class
```

### Quantity Determination

```
Available = min(Feature.RemainingQuantity, Definition.MaxQuantity)
MinGather = min(Definition.MinQuantity, Available)
Quantity = Random within [MinGather, Available]
```

### Quality Upgrade Rules

| Margin (Total - DC) | Quality Change |
|--------------------|----------------|
| < 10 | No change (base quality) |
| >= 10 | Upgrade by 1 tier (max Legendary) |

### Quality Progression

```
Common -> Fine -> Rare -> Legendary (max)
```

---

## Event Flow

```
1. Player calls Gather(player, feature)
2. CanGather() validation
   - Check depletion state
   - Check tool requirements
   - Get DC from definition
3. ISkillService.PerformSkillCheck()
4. Log "GatherAttempted" event (always)
5. If success:
   a. Determine quantity
   b. Determine quality (potential upgrade)
   c. Add to inventory (TODO: inventory service)
   d. Deplete feature
   e. Set replenishment timer if applicable
   f. Log "ResourceGathered" event
6. Return GatherResult
```

---

## Unit Tests

### GatherResultTests (21 tests)

- Factory method creation (Success, Failed, ValidationFailed)
- Property value validation
- Computed properties (IsValidationFailure, Margin)
- Display methods (GetRollDisplay, GetOutcomeDisplay)
- Edge cases (zero values, null values)

### GatherValidationTests (10 tests)

- Factory method creation (Success, Failed)
- Property value validation
- DC handling

### GatheringServiceTests (34 tests)

- GetHarvestableFeatures returns non-depleted features
- CanGather validation (depleted, missing tool, missing definition)
- Gather success flow with inventory update
- Gather failure flow (roll below DC)
- Quality upgrade when margin >= 10
- Feature depletion handling
- Replenishment timer setting
- ProcessReplenishment execution
- Event logging verification
- Argument null validation

**Total: 65 unit tests**

---

## Files Created

| Path | Description |
|------|-------------|
| `src/Core/RuneAndRust.Application/DTOs/GatherResult.cs` | Gathering result record |
| `src/Core/RuneAndRust.Application/DTOs/GatherValidation.cs` | Validation result record |
| `src/Core/RuneAndRust.Application/Events/GatheringEvents.cs` | Gathering event records |
| `src/Core/RuneAndRust.Application/Interfaces/IGatheringService.cs` | Service interface |
| `src/Core/RuneAndRust.Application/Services/GatheringService.cs` | Service implementation |
| `tests/.../DTOs/GatherResultTests.cs` | GatherResult tests |
| `tests/.../DTOs/GatherValidationTests.cs` | GatherValidation tests |
| `tests/.../Services/GatheringServiceTests.cs` | GatheringService tests |

---

## API Examples

### Basic Gathering Flow

```csharp
// Get available features in room
var features = gatheringService.GetHarvestableFeatures(room);
var feature = features.FirstOrDefault(f => f.Name.Contains("ore"));

if (feature is not null)
{
    // Validate gathering
    var validation = gatheringService.CanGather(player, feature);
    if (validation.IsValid)
    {
        // Attempt to gather
        var result = gatheringService.Gather(player, feature);
        if (result.IsSuccess)
        {
            Console.WriteLine($"Gathered {result.Quantity}x {result.ResourceName}!");
            if (result.FeatureDepleted)
            {
                Console.WriteLine("The resource has been depleted.");
            }
        }
        else
        {
            Console.WriteLine($"Failed: {result.GetRollDisplay()}");
        }
    }
    else
    {
        Console.WriteLine(validation.FailureReason);
    }
}
```

### Processing Replenishment

```csharp
// Call each turn to restore depleted features
var replenished = gatheringService.ProcessReplenishment(room, gameState.CurrentTurn);
foreach (var feature in replenished)
{
    Console.WriteLine($"The {feature.Name} has regrown!");
}
```

### Checking Player Modifier

```csharp
var modifier = gatheringService.GetGatherModifier(player);
var dc = gatheringService.GetGatherDC(feature);
Console.WriteLine($"Gathering check: 2d6 + {modifier} vs DC {dc}");
```

---

## v0.11.0 Progress

| Version | Feature | Status |
|---------|---------|--------|
| v0.11.0a | Resource Definitions | Complete |
| v0.11.0b | Harvestable Features | Complete |
| v0.11.0c | Gathering Service | Complete |
| v0.11.0d | Crafting Service | Pending |

---

## Dependencies

- Builds on v0.11.0a (Resource Definitions) and v0.11.0b (Harvestable Features)
- `IResourceProvider` required for resource lookup
- `IHarvestableFeatureProvider` required for feature definitions
- `ISkillService.PerformSkillCheck()` for dice rolling
- `IGameEventLogger` for event publishing
- Uses existing logging patterns (Debug/Info/Warning/Error)

---

## Adaptations from Design Specification

| Design Spec | Actual Implementation |
|-------------|----------------------|
| IDiceService with d20 rolls | ISkillService.PerformSkillCheck (2d6) |
| IInventoryService.AddResource | TODO: Currently tracked via events |
| IEventBus.Publish | IGameEventLogger.LogInteraction |
| GatherCommand (UI layer) | Deferred - requires IGameCommand infrastructure |
| GatherCommandTests | Deferred - requires command infrastructure |

---

## Notes

- Gathering uses the Survival skill via `ISkillService.PerformSkillCheck()`
- The game uses 2d6 skill checks, not d20 as originally specified
- Quality upgrades are capped at Legendary tier
- Quantity gathered cannot exceed feature's remaining quantity
- Tool requirement validation uses keyword matching
- GatherCommand deferred pending IGameCommand/IGameSessionService infrastructure
- Events are logged via IGameEventLogger for UI/statistics integration
- All 65 tests pass with 0 errors and 0 warnings
