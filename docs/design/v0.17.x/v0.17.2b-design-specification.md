# v0.17.2b Design Specification: Allocation Mode System

**Version:** 0.17.2b  
**Phase Name:** Allocation Mode System  
**Parent Version:** v0.17.2 (Attribute System)  
**Prerequisites:** v0.17.2a Complete (Core Attribute Enum)  
**Estimated Tests:** ~6 unit tests

---

## Table of Contents

1. [Executive Summary](#1-executive-summary)
2. [Feature Overview](#2-feature-overview)
3. [Architecture Diagrams](#3-architecture-diagrams)
4. [AttributeAllocationMode Enum](#4-attributeallocationmode-enum)
5. [AttributeAllocationState Value Object](#5-attributeallocationstate-value-object)
6. [Data Model Changes](#6-data-model-changes)
7. [Configuration File Schemas](#7-configuration-file-schemas)
8. [Logging Specifications](#8-logging-specifications)
9. [Unit Testing Requirements](#9-unit-testing-requirements)
10. [Use Cases](#10-use-cases)
11. [User Stories](#11-user-stories)
12. [Deliverable Checklist](#12-deliverable-checklist)
13. [Acceptance Criteria](#13-acceptance-criteria)
14. [Dependencies](#14-dependencies)
15. [Future Considerations](#15-future-considerations)

---

## 1. Executive Summary

### 1.1 Purpose

This specification defines the `AttributeAllocationMode` enum and `AttributeAllocationState` value object that enable two distinct approaches to attribute allocation during character creation:

- **Simple Mode** — New players select an archetype, and attributes are auto-set to recommended values
- **Advanced Mode** — Experienced players use point-buy for full customization

### 1.2 Key Deliverables

| Category          | Items                                  |
| ----------------- | -------------------------------------- |
| **Enums**         | `AttributeAllocationMode`              |
| **Value Objects** | `AttributeAllocationState`             |
| **Configuration** | `attributes.json` (recommended builds) |
| **Tests**         | ~6 unit tests                          |

### 1.3 Architectural Significance

- **Dual-Mode Pattern**: Supports both guided and expert allocation paths
- **State Tracking**: `AttributeAllocationState` tracks all allocation progress
- **Mode Switching**: Players can switch between modes during creation
- **Archetype Integration**: Simple mode uses archetype-defined recommended builds

---

## 2. Feature Overview

```
v0.17.2b Allocation Mode System
├── AttributeAllocationMode Enum
│   ├── Simple (0) — Archetype-recommended builds
│   └── Advanced (1) — Point-buy customization
├── AttributeAllocationState Value Object
│   ├── Mode: AttributeAllocationMode
│   ├── CurrentMight, CurrentFinesse, CurrentWits, CurrentWill, CurrentSturdiness: int
│   ├── PointsSpent, PointsRemaining, TotalPoints: int
│   └── SelectedArchetypeId: string? (for Simple mode)
└── Recommended Builds (Configuration)
    ├── Warrior: M4, F3, Wi2, Wl2, S4 (15 pts)
    ├── Skirmisher: M3, F4, Wi3, Wl2, S3 (15 pts)
    ├── Mystic: M2, F3, Wi4, Wl4, S2 (15 pts)
    └── Adept: M3, F3, Wi3, Wl2, S3 (14 pts)
```

### 2.1 Scope Alignment

**In Scope:**

- `AttributeAllocationMode` enum (Simple, Advanced)
- `AttributeAllocationState` value object with all tracking properties
- Mode behavior definitions (auto-set vs. point-buy)
- Recommended builds per archetype in configuration
- Mode switching logic foundations

**Out of Scope:**

- Point-buy cost calculation → v0.17.2c
- Derived stat calculation → v0.17.2d
- Provider/service implementations → v0.17.2e-g

---

## 3. Architecture Diagrams

### 3.1 Mode System Overview

```
┌─────────────────────────────────────────────────────────────────────┐
│                   ALLOCATION MODE SYSTEM OVERVIEW                    │
└─────────────────────────────────────────────────────────────────────┘

    Character Creation: Step 3 (Attributes)
           │
           ▼
    ┌──────────────────────┐
    │ Select Allocation    │
    │ Mode                 │
    └──────────┬───────────┘
               │
    ┌──────────┴──────────────────────────────────────┐
    │                                                  │
    ▼                                                  ▼
┌──────────────────────┐              ┌──────────────────────────────┐
│     SIMPLE MODE      │              │       ADVANCED MODE          │
├──────────────────────┤              ├──────────────────────────────┤
│ 1. Select archetype  │              │ 1. All attributes start at 1 │
│ 2. Auto-apply build  │              │ 2. Spend points freely       │
│ 3. No manual adjust  │              │ 3. Cost scaling applies      │
│ 4. Fast path         │              │ 4. Full control              │
└──────────────────────┘              └──────────────────────────────┘
           │                                           │
           └─────────────────┬─────────────────────────┘
                             ▼
                 ┌──────────────────────┐
                 │ AttributeAllocation  │
                 │ State                │
                 ├──────────────────────┤
                 │ Mode                 │
                 │ CurrentMight: int    │
                 │ CurrentFinesse: int  │
                 │ CurrentWits: int     │
                 │ CurrentWill: int     │
                 │ CurrentSturdiness: int│
                 │ PointsSpent: int     │
                 │ PointsRemaining: int │
                 │ TotalPoints: int     │
                 │ SelectedArchetypeId? │
                 └──────────────────────┘
```

### 3.2 Mode Switching Decision Flow

```
┌─────────────────────────────────────────────────────────────────────┐
│                    MODE SWITCHING DECISION FLOW                      │
└─────────────────────────────────────────────────────────────────────┘

    Player requests mode switch
           │
           ▼
    ┌──────────────────────┐
    │ Current Mode?        │
    └──────────┬───────────┘
               │
    ┌──────────┴──────────┐
    │                     │
    ▼                     ▼
┌────────┐          ┌──────────┐
│ Simple │          │ Advanced │
└────┬───┘          └────┬─────┘
     │                   │
     ▼                   ▼
┌─────────────────┐  ┌─────────────────────────────────────────┐
│ Switch to       │  │ Switch to Simple                        │
│ Advanced:       │  │                                         │
│ • Keep current  │  │ • Warn: "Current allocation will reset" │
│   values        │  │ • If confirmed:                         │
│ • Enable +/-    │  │   - Apply archetype build               │
│   controls      │  │   - Disable manual adjustment           │
│ • Calculate     │  │                                         │
│   points spent  │  │                                         │
└─────────────────┘  └─────────────────────────────────────────┘
```

### 3.3 Simple Mode Flow

```
┌─────────────────────────────────────────────────────────────────────┐
│                      SIMPLE MODE FLOW                                │
└─────────────────────────────────────────────────────────────────────┘

    Player selects "Simple Mode"
           │
           ▼
┌─────────────────────────────────────────────────────────────────────┐
│                  DISPLAY ARCHETYPE SELECTION                         │
├─────────────────────────────────────────────────────────────────────┤
│  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐ ┌─────────────┐   │
│  │  WARRIOR    │ │ SKIRMISHER  │ │   MYSTIC    │ │    ADEPT    │   │
│  │ M4 F3 Wi2   │ │ M3 F4 Wi3   │ │ M2 F3 Wi4   │ │ M3 F3 Wi3   │   │
│  │ Wl2 S4      │ │ Wl2 S3      │ │ Wl4 S2      │ │ Wl2 S3      │   │
│  │ (15 pts)    │ │ (15 pts)    │ │ (15 pts)    │ │ (14 pts)    │   │
│  └─────────────┘ └─────────────┘ └─────────────┘ └─────────────┘   │
└─────────────────────────────────────────────────────────────────────┘
           │
           │  Player selects Warrior
           ▼
┌─────────────────────────────────────────────────────────────────────┐
│                  APPLY RECOMMENDED BUILD                             │
├─────────────────────────────────────────────────────────────────────┤
│  Might = 4, Finesse = 3, Wits = 2, Will = 2, Sturdiness = 4        │
│  PointsSpent = 15, PointsRemaining = 0                              │
│  SelectedArchetypeId = "warrior"                                    │
│  [+/- buttons DISABLED]                                             │
└─────────────────────────────────────────────────────────────────────┘
```

### 3.4 Recommended Builds Table

```
┌─────────────────────────────────────────────────────────────────────┐
│                    RECOMMENDED BUILDS BY ARCHETYPE                   │
└─────────────────────────────────────────────────────────────────────┘

    ┌───────────┬───────┬─────────┬──────┬──────┬───────────┬───────┐
    │ Archetype │ MIGHT │ FINESSE │ WITS │ WILL │ STURDINESS│ Total │
    ├───────────┼───────┼─────────┼──────┼──────┼───────────┼───────┤
    │ Warrior   │   4   │    3    │   2  │   2  │     4     │  15   │
    ├───────────┼───────┼─────────┼──────┼──────┼───────────┼───────┤
    │ Skirmisher│   3   │    4    │   3  │   2  │     3     │  15   │
    ├───────────┼───────┼─────────┼──────┼──────┼───────────┼───────┤
    │ Mystic    │   2   │    3    │   4  │   4  │     2     │  15   │
    ├───────────┼───────┼─────────┼──────┼──────┼───────────┼───────┤
    │ Adept     │   3   │    3    │   3  │   2  │     3     │  14   │
    └───────────┴───────┴─────────┴──────┴──────┴───────────┴───────┘

    Design Notes:
    • Warrior: Balanced physical (high Might + Sturdiness)
    • Skirmisher: Agility-focused (high Finesse)
    • Mystic: Mental focus (high Wits + Will for Aether)
    • Adept: Generalist (14 pts allows for future growth)
```

---

## 4. AttributeAllocationMode Enum

### 4.1 Purpose

The `AttributeAllocationMode` enum defines the two available modes for attribute allocation during character creation.

### 4.2 Implementation

**File:** `src/Core/RuneAndRust.Domain/Enums/AttributeAllocationMode.cs`

```csharp
namespace RuneAndRust.Domain.Enums;

/// <summary>
/// Defines the available modes for attribute allocation during character creation.
/// </summary>
/// <remarks>
/// <para>
/// The allocation mode determines how a player assigns attribute points:
/// - Simple: Archetype-recommended builds for quick character creation
/// - Advanced: Full point-buy control for experienced players
/// </para>
/// <para>
/// Simple mode is the default for new players, providing a guided experience.
/// Advanced mode allows complete customization using the point-buy system.
/// Players can switch between modes during character creation.
/// </para>
/// </remarks>
public enum AttributeAllocationMode
{
    /// <summary>
    /// Simple mode uses archetype-recommended attribute builds.
    /// </summary>
    /// <remarks>
    /// In Simple mode:
    /// - Player selects an archetype first
    /// - Attributes are automatically set to recommended values
    /// - Manual adjustment is disabled
    /// - Fastest path through character creation
    /// </remarks>
    Simple = 0,

    /// <summary>
    /// Advanced mode enables full point-buy customization.
    /// </summary>
    /// <remarks>
    /// In Advanced mode:
    /// - All attributes start at 1
    /// - Player spends points to increase attributes
    /// - Cost scaling applies (values 9-10 cost extra)
    /// - Full control over attribute distribution
    /// </remarks>
    Advanced = 1
}
```

---

## 5. AttributeAllocationState Value Object

### 5.1 Purpose

The `AttributeAllocationState` value object tracks the complete state of attribute allocation, including current values, points spent/remaining, and the selected mode.

### 5.2 Implementation

**File:** `src/Core/RuneAndRust.Domain/ValueObjects/AttributeAllocationState.cs`

```csharp
namespace RuneAndRust.Domain.ValueObjects;

using RuneAndRust.Domain.Enums;

/// <summary>
/// Represents the complete state of attribute allocation during character creation.
/// </summary>
/// <remarks>
/// <para>
/// AttributeAllocationState is an immutable value object that captures all information
/// about a character's attribute allocation progress. It tracks the current mode,
/// individual attribute values, and point expenditure.
/// </para>
/// <para>
/// In Simple mode, attributes are set via archetype selection.
/// In Advanced mode, players manually allocate points.
/// </para>
/// </remarks>
public readonly record struct AttributeAllocationState
{
    /// <summary>Gets the current allocation mode.</summary>
    public AttributeAllocationMode Mode { get; init; }

    /// <summary>Gets the current Might value (1-10).</summary>
    public int CurrentMight { get; init; }

    /// <summary>Gets the current Finesse value (1-10).</summary>
    public int CurrentFinesse { get; init; }

    /// <summary>Gets the current Wits value (1-10).</summary>
    public int CurrentWits { get; init; }

    /// <summary>Gets the current Will value (1-10).</summary>
    public int CurrentWill { get; init; }

    /// <summary>Gets the current Sturdiness value (1-10).</summary>
    public int CurrentSturdiness { get; init; }

    /// <summary>Gets the total points spent on attributes.</summary>
    public int PointsSpent { get; init; }

    /// <summary>Gets the points remaining to spend.</summary>
    public int PointsRemaining { get; init; }

    /// <summary>Gets the total point pool available.</summary>
    public int TotalPoints { get; init; }

    /// <summary>Gets the selected archetype ID (Simple mode only).</summary>
    public string? SelectedArchetypeId { get; init; }

    /// <summary>Gets whether all points have been allocated.</summary>
    public bool IsComplete => PointsRemaining == 0;

    /// <summary>Gets whether manual adjustment is allowed.</summary>
    public bool AllowsManualAdjustment => Mode == AttributeAllocationMode.Advanced;

    /// <summary>Gets the attribute value for a specific attribute.</summary>
    public int GetAttributeValue(CoreAttribute attribute) => attribute switch
    {
        CoreAttribute.Might => CurrentMight,
        CoreAttribute.Finesse => CurrentFinesse,
        CoreAttribute.Wits => CurrentWits,
        CoreAttribute.Will => CurrentWill,
        CoreAttribute.Sturdiness => CurrentSturdiness,
        _ => throw new ArgumentOutOfRangeException(nameof(attribute))
    };

    /// <summary>Creates the default initial state for Advanced mode.</summary>
    public static AttributeAllocationState CreateAdvancedDefault(int totalPoints = 15) =>
        new()
        {
            Mode = AttributeAllocationMode.Advanced,
            CurrentMight = 1,
            CurrentFinesse = 1,
            CurrentWits = 1,
            CurrentWill = 1,
            CurrentSturdiness = 1,
            PointsSpent = 0,
            PointsRemaining = totalPoints,
            TotalPoints = totalPoints,
            SelectedArchetypeId = null
        };

    /// <summary>Creates a state from an archetype's recommended build.</summary>
    public static AttributeAllocationState CreateFromRecommendedBuild(
        string archetypeId,
        int might, int finesse, int wits, int will, int sturdiness,
        int totalPoints)
    {
        ArgumentException.ThrowIfNullOrWhiteSpace(archetypeId);

        return new AttributeAllocationState
        {
            Mode = AttributeAllocationMode.Simple,
            CurrentMight = might,
            CurrentFinesse = finesse,
            CurrentWits = wits,
            CurrentWill = will,
            CurrentSturdiness = sturdiness,
            PointsSpent = totalPoints,
            PointsRemaining = 0,
            TotalPoints = totalPoints,
            SelectedArchetypeId = archetypeId.ToLowerInvariant()
        };
    }

    /// <summary>Creates a new state with an updated attribute value.</summary>
    public AttributeAllocationState WithAttributeValue(
        CoreAttribute attribute, int newValue, int pointDelta)
    {
        if (Mode != AttributeAllocationMode.Advanced)
            throw new InvalidOperationException("Cannot modify attributes in Simple mode");

        return attribute switch
        {
            CoreAttribute.Might => this with
            {
                CurrentMight = newValue,
                PointsSpent = PointsSpent + pointDelta,
                PointsRemaining = PointsRemaining - pointDelta
            },
            CoreAttribute.Finesse => this with
            {
                CurrentFinesse = newValue,
                PointsSpent = PointsSpent + pointDelta,
                PointsRemaining = PointsRemaining - pointDelta
            },
            CoreAttribute.Wits => this with
            {
                CurrentWits = newValue,
                PointsSpent = PointsSpent + pointDelta,
                PointsRemaining = PointsRemaining - pointDelta
            },
            CoreAttribute.Will => this with
            {
                CurrentWill = newValue,
                PointsSpent = PointsSpent + pointDelta,
                PointsRemaining = PointsRemaining - pointDelta
            },
            CoreAttribute.Sturdiness => this with
            {
                CurrentSturdiness = newValue,
                PointsSpent = PointsSpent + pointDelta,
                PointsRemaining = PointsRemaining - pointDelta
            },
            _ => throw new ArgumentOutOfRangeException(nameof(attribute))
        };
    }

    /// <summary>Switches to Advanced mode, preserving current values.</summary>
    public AttributeAllocationState SwitchToAdvanced(int pointsSpent) =>
        this with
        {
            Mode = AttributeAllocationMode.Advanced,
            PointsSpent = pointsSpent,
            PointsRemaining = TotalPoints - pointsSpent,
            SelectedArchetypeId = null
        };

    public override string ToString() =>
        $"[{Mode}] M:{CurrentMight} F:{CurrentFinesse} Wi:{CurrentWits} " +
        $"Wl:{CurrentWill} S:{CurrentSturdiness} ({PointsRemaining}/{TotalPoints} remaining)";
}
```

---

## 6. Data Model Changes

### 6.1 New Types Summary

| Type                       | Layer  | Category     | Description                  |
| -------------------------- | ------ | ------------ | ---------------------------- |
| `AttributeAllocationMode`  | Domain | Enum         | Simple vs Advanced mode      |
| `AttributeAllocationState` | Domain | Value Object | Complete allocation tracking |

### 6.2 File Locations

```
src/Core/RuneAndRust.Domain/
├── Enums/
│   ├── CoreAttribute.cs                        (v0.17.2a)
│   └── AttributeAllocationMode.cs              ← NEW
├── ValueObjects/
│   ├── AttributeDescription.cs                 (v0.17.2a)
│   └── AttributeAllocationState.cs             ← NEW
```

---

## 7. Configuration File Schemas

### 7.1 attributes.json (Recommended Builds Section)

**File:** `config/attributes.json` (extended)

```json
{
    "recommendedBuilds": [
        {
            "archetypeId": "warrior",
            "might": 4,
            "finesse": 3,
            "wits": 2,
            "will": 2,
            "sturdiness": 4,
            "totalPoints": 15
        },
        {
            "archetypeId": "skirmisher",
            "might": 3,
            "finesse": 4,
            "wits": 3,
            "will": 2,
            "sturdiness": 3,
            "totalPoints": 15
        },
        {
            "archetypeId": "mystic",
            "might": 2,
            "finesse": 3,
            "wits": 4,
            "will": 4,
            "sturdiness": 2,
            "totalPoints": 15
        },
        {
            "archetypeId": "adept",
            "might": 3,
            "finesse": 3,
            "wits": 3,
            "will": 2,
            "sturdiness": 3,
            "totalPoints": 14
        }
    ]
}
```

---

## 8. Logging Specifications

| Event                   | Level       | Template                                        |
| ----------------------- | ----------- | ----------------------------------------------- |
| State created           | Debug       | "Created allocation state: {State}"             |
| Mode switched           | Information | "Switched to {Mode} mode"                       |
| Archetype build applied | Information | "Applied {Archetype} build: {State}"            |
| Attribute modified      | Debug       | "Modified {Attribute}: {OldValue} → {NewValue}" |
| Invalid modification    | Warning     | "Cannot modify in Simple mode"                  |

---

## 9. Unit Testing Requirements

### 9.1 Test Count: ~6 tests

```csharp
[TestFixture]
public class AttributeAllocationModeTests
{
    [Test]
    public void AttributeAllocationMode_HasTwoValues()
    {
        Enum.GetValues<AttributeAllocationMode>().Should().HaveCount(2);
    }

    [Test]
    [TestCase(AttributeAllocationMode.Simple, 0)]
    [TestCase(AttributeAllocationMode.Advanced, 1)]
    public void AttributeAllocationMode_HasCorrectIntegerValues(
        AttributeAllocationMode mode, int expected)
    {
        ((int)mode).Should().Be(expected);
    }
}

[TestFixture]
public class AttributeAllocationStateTests
{
    [Test]
    public void CreateAdvancedDefault_SetsAllAttributesToOne()
    {
        var state = AttributeAllocationState.CreateAdvancedDefault(15);

        state.CurrentMight.Should().Be(1);
        state.CurrentFinesse.Should().Be(1);
        state.PointsRemaining.Should().Be(15);
        state.Mode.Should().Be(AttributeAllocationMode.Advanced);
    }

    [Test]
    public void CreateFromRecommendedBuild_AppliesArchetypeValues()
    {
        var state = AttributeAllocationState.CreateFromRecommendedBuild(
            "warrior", 4, 3, 2, 2, 4, 15);

        state.CurrentMight.Should().Be(4);
        state.CurrentSturdiness.Should().Be(4);
        state.Mode.Should().Be(AttributeAllocationMode.Simple);
        state.SelectedArchetypeId.Should().Be("warrior");
    }

    [Test]
    public void WithAttributeValue_InSimpleMode_ThrowsInvalidOperationException()
    {
        var state = AttributeAllocationState.CreateFromRecommendedBuild(
            "warrior", 4, 3, 2, 2, 4, 15);

        var act = () => state.WithAttributeValue(CoreAttribute.Might, 5, 1);

        act.Should().Throw<InvalidOperationException>();
    }

    [Test]
    public void SwitchToAdvanced_PreservesValuesAndCalculatesPoints()
    {
        var state = AttributeAllocationState.CreateFromRecommendedBuild(
            "warrior", 4, 3, 2, 2, 4, 15);

        var advanced = state.SwitchToAdvanced(15);

        advanced.Mode.Should().Be(AttributeAllocationMode.Advanced);
        advanced.CurrentMight.Should().Be(4);
        advanced.SelectedArchetypeId.Should().BeNull();
    }
}
```

---

## 10. Use Cases

| ID     | Use Case                 | Flow                                                                 |
| ------ | ------------------------ | -------------------------------------------------------------------- |
| UC-001 | Quick Character Creation | Player → Simple mode → Select archetype → Auto-apply → Continue      |
| UC-002 | Custom Allocation        | Player → Advanced mode → Spend points → Validate → Continue          |
| UC-003 | Mode Switch              | Player in Simple → Switch to Advanced → Keep values → Enable editing |

---

## 11. User Stories

**US-001:** As a new player, I want to select a recommended build so I can start playing quickly.

**US-002:** As an experienced player, I want full control over my attribute allocation so I can optimize my build.

**US-003:** As a player who changed their mind, I want to switch from Simple to Advanced mode to customize my attributes.

---

## 12. Deliverable Checklist

- [ ] `AttributeAllocationMode` enum created with 2 values
- [ ] `AttributeAllocationState` value object created
- [ ] Factory methods implemented (`CreateAdvancedDefault`, `CreateFromRecommendedBuild`)
- [ ] Mode switching method implemented (`SwitchToAdvanced`)
- [ ] Configuration extended with recommended builds
- [ ] ~6 unit tests implemented and passing
- [ ] XML documentation complete

---

## 13. Acceptance Criteria

### Functional

- [ ] `AttributeAllocationMode` has exactly 2 values (Simple=0, Advanced=1)
- [ ] `AttributeAllocationState` tracks all 5 attributes plus points
- [ ] Simple mode prevents manual attribute modification
- [ ] Advanced mode allows point-based modification
- [ ] Recommended builds match scope breakdown values

### Quality

- [ ] Build succeeds with 0 errors/warnings
- [ ] All ~6 unit tests pass
- [ ] XML documentation complete for all public members

---

## 14. Dependencies

### Required from Previous Phases

| Type            | Phase    | Usage                         |
| --------------- | -------- | ----------------------------- |
| `CoreAttribute` | v0.17.2a | Used in `GetAttributeValue()` |

### Provides to Future Phases

| Type                       | Phase    | Usage                             |
| -------------------------- | -------- | --------------------------------- |
| `AttributeAllocationMode`  | v0.17.2f | Mode parameter in service methods |
| `AttributeAllocationState` | v0.17.2f | State management in allocation    |

---

## 15. Future Considerations

### Deferred to v0.17.2c

- Point-buy cost calculations
- Cost table configuration

### Deferred to v0.17.2f

- Full allocation service with validation
- Point constraint enforcement

### Out of Scope for v0.17.2

- Custom recommended builds
- Mode presets beyond Simple/Advanced

---

_Document Version: 1.0_  
_Last Updated: 2025-01-27_
