# v0.18.4a Design Specification: Rage System (Berserker)

**Version:** 0.18.4a
**Parent:** v0.18.4 (Specialization-Specific Resources)
**Prerequisites:** v0.17.4 (Specialization System), v0.18.0 (Psychic Stress System)
**Status:** Design Complete
**Estimated Unit Tests:** ~5

---

## Table of Contents

1. [Executive Summary](#1-executive-summary)
2. [Feature Overview](#2-feature-overview)
3. [Architecture Diagrams](#3-architecture-diagrams)
4. [User Stories](#4-user-stories)
5. [Domain Model](#5-domain-model)
6. [Data Model](#6-data-model)
7. [Logging Specifications](#7-logging-specifications)
8. [Unit Testing Requirements](#8-unit-testing-requirements)
9. [Deliverable Checklist](#9-deliverable-checklist)
10. [Acceptance Criteria](#10-acceptance-criteria)
11. [Dependencies](#11-dependencies)
12. [Future Considerations](#12-future-considerations)

---

## 1. Executive Summary

This design specification defines the **Rage System** for the Berserker specialization — a volatile combat resource powered by violence and pain that grants offensive bonuses and damage mitigation at escalating thresholds.

v0.18.4a establishes the **Domain Layer Foundation** for Rage by defining:

- `RageThreshold` enum — 5 tiers of escalating fury
- `RageSource` enum — 5 sources of rage generation
- `RageState` entity — immutable snapshot of rage status
- `RageGainResult` and `RageDecayResult` value objects — transaction records

### Key Deliverables

| Category              | Items                                        |
| --------------------- | -------------------------------------------- |
| **Domain Enums**      | `RageThreshold`, `RageSource`                |
| **Domain Entities**   | `RageState`                                  |
| **Value Objects**     | `RageGainResult`, `RageDecayResult`          |
| **Tests**             | ~5 unit tests                                |

### Rage Threshold Overview

| Threshold          | Rage  | Damage Bonus | Soak Bonus | Special Effects                                          |
| ------------------ | ----- | ------------ | ---------- | -------------------------------------------------------- |
| Calm               | 0-20  | +0 to +2     | +0         | None                                                     |
| Simmering          | 21-40 | +3 to +4     | +1         | Minor aggression                                         |
| Burning            | 41-60 | +5 to +6     | +2         | Intimidation bonus                                       |
| BerserkFury        | 61-80 | +7 to +8     | +3         | Fear resistance                                          |
| FrenzyBeyondReason | 81+   | +9 to +10    | +4         | Party -10 stress, Fear immune, Must attack nearest      |

---

## 2. Feature Overview

```
v0.18.4a Features
└── Rage System (Domain Layer)
    │
    ├── RageThreshold Enum
    │   ├── Calm (0-20 rage)
    │   ├── Simmering (21-40 rage)
    │   ├── Burning (41-60 rage)
    │   ├── BerserkFury (61-80 rage)
    │   └── FrenzyBeyondReason (81-100 rage)
    │
    ├── RageSource Enum
    │   ├── TakingDamage - Gain from damage taken
    │   ├── DealingDamage - Gain from damage dealt
    │   ├── AllyDamaged - Rage when allies hurt
    │   ├── EnemyKill - Bonus rage from kills
    │   └── RageMaintenance - Passive in FrenzyBeyondReason
    │
    ├── RageState Entity
    │   ├── CharacterId: Guid
    │   ├── CurrentRage: int (0-100)
    │   ├── Threshold: RageThreshold (computed)
    │   ├── DamageBonus: int (floor(Rage/10))
    │   ├── DamageTakenReduction: int (floor(Rage/20) × 5%)
    │   ├── SoakBonus: int (by threshold)
    │   ├── PartyStressReduction: int? (at FrenzyBeyondReason)
    │   ├── FearImmune: bool (at FrenzyBeyondReason)
    │   ├── MustAttackNearest: bool (at FrenzyBeyondReason)
    │   ├── DecayPerTurn: int (10 per turn in non-combat)
    │   └── LastCombatTime: DateTime?
    │
    ├── RageGainResult Record
    │   ├── PreviousRage: int
    │   ├── NewRage: int
    │   ├── AmountGained: int
    │   ├── Source: RageSource
    │   ├── ThresholdChanged: bool
    │   └── NewThreshold: RageThreshold?
    │
    └── RageDecayResult Record
        ├── PreviousRage: int
        ├── NewRage: int
        ├── AmountDecayed: int
        ├── ThresholdChanged: bool
        └── NewThreshold: RageThreshold?
```

---

## 3. Architecture Diagrams

### 3.1 Domain Layer Structure

```
┌─────────────────────────────────────────────────────────────────────────┐
│                          DOMAIN LAYER                                    │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                          │
│  ┌─────────────────────────────────────────────────────────────────┐    │
│  │                          ENUMS                                   │    │
│  ├──────────────────────────────────┬──────────────────────────────┤    │
│  │         RageThreshold            │         RageSource           │    │
│  ├──────────────────────────────────┼──────────────────────────────┤    │
│  │ Calm = 0                         │ TakingDamage = 0             │    │
│  │ Simmering = 1                    │ DealingDamage = 1            │    │
│  │ Burning = 2                      │ AllyDamaged = 2              │    │
│  │ BerserkFury = 3                  │ EnemyKill = 3                │    │
│  │ FrenzyBeyondReason = 4           │ RageMaintenance = 4          │    │
│  └──────────────────────────────────┴──────────────────────────────┘    │
│                                                                          │
│  ┌─────────────────────────────────────────────────────────────────┐    │
│  │                    RageState (Entity)                            │    │
│  ├─────────────────────────────────────────────────────────────────┤    │
│  │  Properties:                                                     │    │
│  │  + CharacterId: Guid                                            │    │
│  │  + CurrentRage: int (0-100, computed from events)              │    │
│  │  + Threshold: RageThreshold (computed from CurrentRage)        │    │
│  │  + DamageBonus: int (computed: floor(CurrentRage / 10))        │    │
│  │  + DamageTakenReduction: int (computed by threshold)           │    │
│  │  + SoakBonus: int (computed by threshold)                      │    │
│  │  + FearImmune: bool (true if threshold == FrenzyBeyondReason)  │    │
│  │  + MustAttackNearest: bool (true if threshold >= BerserkFury)  │    │
│  │  + PartyStressReduction: int? (10 if FrenzyBeyondReason)       │    │
│  │  + DecayPerTurn: int (constant: 10)                            │    │
│  │  + LastCombatTime: DateTime? (tracking non-combat decay)       │    │
│  ├─────────────────────────────────────────────────────────────────┤    │
│  │  Constants:                                                      │    │
│  │  + MinRage = 0                                                   │    │
│  │  + MaxRage = 100                                                 │    │
│  │  + CalmThreshold = 20                                            │    │
│  │  + SimmeringThreshold = 40                                       │    │
│  │  + BurningThreshold = 60                                         │    │
│  │  + BerserkFuryThreshold = 80                                     │    │
│  │  + DecayPerNonCombatTurn = 10                                    │    │
│  ├─────────────────────────────────────────────────────────────────┤    │
│  │  Factory:                                                        │    │
│  │  + Create(Guid characterId): RageState                         │    │
│  │  + DetermineThreshold(int rage): RageThreshold                 │    │
│  └─────────────────────────────────────────────────────────────────┘    │
│                                                                          │
│  ┌─────────────────────────────────────────────────────────────────┐    │
│  │           RageGainResult & RageDecayResult (Records)             │    │
│  ├─────────────────────────────────────────────────────────────────┤    │
│  │  RageGainResult: Immutable record of rage gain transaction     │    │
│  │  RageDecayResult: Immutable record of rage decay transaction   │    │
│  └─────────────────────────────────────────────────────────────────┘    │
│                                                                          │
└─────────────────────────────────────────────────────────────────────────┘
```

### 3.2 Rage Threshold Determination Flowchart

```
                    ┌────────────────────────┐
                    │   Current Rage Value   │
                    └───────────┬────────────┘
                                │
           ┌────────────────────┼────────────────────┐
           │                    │                    │
           ▼                    ▼                    ▼
    ┌─────────────┐     ┌─────────────┐      ┌─────────────┐
    │  rage ≤ 20  │     │  21 ≤ r ≤ 40│      │ 41 ≤ r ≤ 60│
    │             │     │             │      │             │
    │   = Calm    │     │ = Simmering │      │  = Burning  │
    └─────────────┘     └─────────────┘      └─────────────┘
           │                    │                    │
           │                    │                    │
           │                    ▼                    │
           │            ┌─────────────┐              │
           │            │ 61 ≤ r ≤ 80 │              │
           │            │             │              │
           │            │ = Berserk   │◄─────────────┘
           │            │    Fury     │
           │            └─────────────┘
           │                    │
           │                    ▼
           │            ┌─────────────┐
           │            │  rage ≥ 81  │
           │            │             │
           └───────────►│  = Frenzy   │
                        │  Beyond     │
                        │   Reason    │
                        └─────────────┘
```

### 3.3 Rage Threshold Bonuses Table

```
┌─────────────────────┬───────┬──────────────┬────────────┬──────────────────────────────┐
│ Threshold           │ Rage  │ Damage Bonus │ Soak Bonus │ Special Effects              │
├─────────────────────┼───────┼──────────────┼────────────┼──────────────────────────────┤
│ Calm                │ 0-20  │ +0 to +2     │ +0         │ None                         │
│ Simmering           │ 21-40 │ +3 to +4     │ +1         │ Minor aggression             │
│ Burning             │ 41-60 │ +5 to +6     │ +2         │ Intimidation bonus           │
│ BerserkFury         │ 61-80 │ +7 to +8     │ +3         │ Fear resistance              │
│ FrenzyBeyondReason  │ 81+   │ +9 to +10    │ +4         │ Party -10 stress, Fear immune│
└─────────────────────┴───────┴──────────────┴────────────┴──────────────────────────────┘
```

### 3.4 Rage Decay in Non-Combat

```
                    ┌──────────────────────────┐
                    │   Non-Combat Turn Start  │
                    └───────────┬──────────────┘
                                │
                                ▼
                    ┌──────────────────────────┐
                    │   Check LastCombatTime   │
                    └───────────┬──────────────┘
                                │
        ┌───────────────────────┼───────────────────────┐
        │                       │                       │
        ▼                       ▼                       ▼
   ┌─────────┐         ┌──────────────┐         ┌────────────┐
   │ > 1 min │         │ > 5 min      │         │ > 10 min   │
   │ ago?    │         │ ago?         │         │ ago?       │
   └────┬────┘         └──────┬───────┘         └────┬───────┘
        │                     │                      │
        ▼                     ▼                      ▼
   Decay -10           Decay -10              Decay -10
   Rage/Turn           (Accelerated)          (Accelerated)
```

---

## 4. User Stories

### US-18.4a-1: Determine Rage Threshold from Current Rage

**As a** rage system developer
**I want to** determine the rage threshold from current rage value
**So that** threshold-appropriate bonuses can be applied

**Acceptance Criteria:**
- Threshold correctly determined for all rage ranges
- Boundary values handled correctly (e.g., 20 → Calm, 21 → Simmering)
- Rage clamped to 0-100 range
- Computed properties reflect correct threshold

### US-18.4a-2: Calculate Damage Bonuses from Rage

**As a** combat system developer
**I want to** calculate damage bonus based on rage level
**So that** higher rage grants proportional damage bonuses

**Acceptance Criteria:**
- Damage bonus = floor(CurrentRage / 10)
- Ranges from 0 to 10
- Recalculated when rage changes

### US-18.4a-3: Apply Threshold-Specific Bonuses

**As a** a combat system developer
**I want to** apply soak/fear/party-stress bonuses based on threshold
**So that** thresholds provide meaningful power progression

**Acceptance Criteria:**
- Soak bonus scales with threshold (0, 1, 2, 3, 4)
- Fear immunity only at FrenzyBeyondReason
- Party stress reduction only at FrenzyBeyondReason (10 stress)
- MustAttackNearest enforced at BerserkFury and higher

### US-18.4a-4: Track Rage Gain and Decay Transactions

**As a** an event logging system
**I want to** record rage gain and decay events
**So that** I can audit rage changes and trigger effects

**Acceptance Criteria:**
- RageGainResult captures source and threshold change
- RageDecayResult captures decay amount and threshold change
- Records include previous/new rage values
- Threshold change flag set when crossing threshold

---

## 5. Domain Model

### 5.1 RageThreshold Enum

**File:** `src/Core/RuneAndRust.Domain/Enums/RageThreshold.cs`

```csharp
namespace RuneAndRust.Domain.Enums;

/// <summary>
/// Represents the stages of Rage for the Berserker specialization.
/// </summary>
/// <remarks>
/// <para>
/// Rage is a volatile combat resource powered by violence and pain.
/// Unlike controlled resources, Rage grows from aggression and provides
/// both offensive and defensive bonuses, but with a cost: forced
/// engagement at the highest threshold.
/// </para>
/// <para>
/// Threshold Ranges (based on Rage 0-100):
/// <list type="bullet">
/// <item>Calm: 0-20 rage — Clear mind, minimal bonuses</item>
/// <item>Simmering: 21-40 rage — Building power</item>
/// <item>Burning: 41-60 rage — Significant aggression</item>
/// <item>BerserkFury: 61-80 rage — Overwhelming power</item>
/// <item>FrenzyBeyondReason: 81-100 rage — Ultimate fury with consequences</item>
/// </list>
/// </para>
/// </remarks>
public enum RageThreshold
{
    /// <summary>
    /// Calm state (0-20 rage).
    /// </summary>
    /// <remarks>
    /// No significant bonuses. Mind is relatively clear.
    /// </remarks>
    Calm = 0,

    /// <summary>
    /// Simmering state (21-40 rage).
    /// </summary>
    /// <remarks>
    /// Building power. Minor damage and soak bonuses.
    /// </remarks>
    Simmering = 1,

    /// <summary>
    /// Burning state (41-60 rage).
    /// </summary>
    /// <remarks>
    /// Significant aggression. Moderate bonuses and intimidation effects.
    /// </remarks>
    Burning = 2,

    /// <summary>
    /// Berserk Fury state (61-80 rage).
    /// </summary>
    /// <remarks>
    /// Overwhelming power. Strong bonuses and fear resistance.
    /// Must attack nearest enemy.
    /// </remarks>
    BerserkFury = 3,

    /// <summary>
    /// Frenzy Beyond Reason state (81-100 rage).
    /// </summary>
    /// <remarks>
    /// Ultimate fury with severe consequences. Maximum bonuses,
    /// fear immunity, forced aggression, and party stress reduction.
    /// </remarks>
    FrenzyBeyondReason = 4
}
```

### 5.2 RageSource Enum

**File:** `src/Core/RuneAndRust.Domain/Enums/RageSource.cs`

```csharp
namespace RuneAndRust.Domain.Enums;

/// <summary>
/// Represents the sources of Rage generation.
/// </summary>
/// <remarks>
/// Each source determines how rage is gained and may have
/// different multipliers or flat values.
/// </remarks>
public enum RageSource
{
    /// <summary>
    /// Rage gained from taking damage.
    /// </summary>
    /// <remarks>
    /// Formula: floor(damage / 5)
    /// Encourages standing firm in combat.
    /// </remarks>
    TakingDamage = 0,

    /// <summary>
    /// Rage gained from dealing damage to enemies.
    /// </summary>
    /// <remarks>
    /// Formula: floor(damage / 10)
    /// Encourages offensive gameplay.
    /// </remarks>
    DealingDamage = 1,

    /// <summary>
    /// Rage gained when allies take damage.
    /// </summary>
    /// <remarks>
    /// Flat: 5 rage per ally damaged
    /// Encourages protecting allies.
    /// </remarks>
    AllyDamaged = 2,

    /// <summary>
    /// Bonus rage from defeating enemies.
    /// </summary>
    /// <remarks>
    /// Flat: 15 rage per kill
    /// Encourages finishing enemies.
    /// </remarks>
    EnemyKill = 3,

    /// <summary>
    /// Passive rage maintenance at FrenzyBeyondReason threshold.
    /// </summary>
    /// <remarks>
    /// Flat: 5 rage per turn
    /// Keeps berserker in highest state.
    /// </remarks>
    RageMaintenance = 4
}
```

### 5.3 RageState Entity

**File:** `src/Core/RuneAndRust.Domain/Entities/RageState.cs`

```csharp
namespace RuneAndRust.Domain.Entities;

using RuneAndRust.Domain.Enums;

/// <summary>
/// Represents the rage state of a Berserker character.
/// </summary>
/// <remarks>
/// <para>
/// RageState is the core domain entity for the Rage system.
/// It is derived from character actions and provides bonuses
/// that scale with rage level.
/// </para>
/// <para>
/// Key Properties:
/// - CurrentRage: 0-100 integer
/// - Threshold: Computed from CurrentRage
/// - DamageBonus: floor(CurrentRage / 10), ranges 0-10
/// - DamageTakenReduction: Computed by threshold
/// - SoakBonus: Ranges 0-4 depending on threshold
/// - FearImmune: true only at FrenzyBeyondReason
/// - MustAttackNearest: true at BerserkFury and above
/// - PartyStressReduction: 10 only at FrenzyBeyondReason
/// - DecayPerTurn: 10 per non-combat turn
/// </para>
/// </remarks>
public class RageState
{
    #region Constants

    /// <summary>Minimum rage value.</summary>
    public const int MinRage = 0;

    /// <summary>Maximum rage value.</summary>
    public const int MaxRage = 100;

    /// <summary>Rage threshold for Simmering state.</summary>
    public const int SimmeringThreshold = 20;

    /// <summary>Rage threshold for Burning state.</summary>
    public const int BurningThreshold = 40;

    /// <summary>Rage threshold for BerserkFury state.</summary>
    public const int BerserkFuryThreshold = 60;

    /// <summary>Rage threshold for FrenzyBeyondReason state.</summary>
    public const int FrenzyBeyondReasonThreshold = 80;

    /// <summary>Rage decay per non-combat turn.</summary>
    public const int DecayPerNonCombatTurn = 10;

    #endregion

    #region Properties

    /// <summary>
    /// Gets the character ID this rage state belongs to.
    /// </summary>
    public Guid CharacterId { get; private init; }

    /// <summary>
    /// Gets the current rage level (0-100).
    /// </summary>
    public int CurrentRage { get; private init; }

    /// <summary>
    /// Gets the current rage threshold based on rage level.
    /// </summary>
    public RageThreshold Threshold { get; private init; }

    /// <summary>
    /// Gets the damage bonus from rage (floor(CurrentRage / 10)).
    /// </summary>
    /// <remarks>
    /// Ranges from 0 to 10.
    /// </remarks>
    public int DamageBonus { get; private init; }

    /// <summary>
    /// Gets the damage reduction percentage from rage absorption.
    /// </summary>
    /// <remarks>
    /// Calculated as floor(CurrentRage / 20) * 5%.
    /// Ranges from 0% to 25%.
    /// </remarks>
    public int DamageTakenReduction { get; private init; }

    /// <summary>
    /// Gets the soak bonus (defense against damage) from threshold.
    /// </summary>
    /// <remarks>
    /// Ranges 0-4 depending on threshold.
    /// </remarks>
    public int SoakBonus { get; private init; }

    /// <summary>
    /// Gets whether the character is immune to fear effects.
    /// </summary>
    /// <remarks>
    /// True only at FrenzyBeyondReason threshold.
    /// </remarks>
    public bool FearImmune { get; private init; }

    /// <summary>
    /// Gets whether the character must attack the nearest enemy.
    /// </summary>
    /// <remarks>
    /// True at BerserkFury and FrenzyBeyondReason thresholds.
    /// </remarks>
    public bool MustAttackNearest { get; private init; }

    /// <summary>
    /// Gets the party stress reduction at FrenzyBeyondReason.
    /// </summary>
    /// <remarks>
    /// 10 stress reduction for party at rest, or null if not active.
    /// </remarks>
    public int? PartyStressReduction { get; private init; }

    /// <summary>
    /// Gets the time of last combat engagement.
    /// </summary>
    /// <remarks>
    /// Used to determine non-combat decay eligibility.
    /// </remarks>
    public DateTime? LastCombatTime { get; private init; }

    #endregion

    #region Computed Properties

    /// <summary>
    /// Gets the decay per non-combat turn (constant: 10).
    /// </summary>
    public int DecayPerTurn => DecayPerNonCombatTurn;

    #endregion

    #region Constructors

    /// <summary>
    /// Private constructor for EF Core.
    /// </summary>
    private RageState() { }

    #endregion

    #region Factory Methods

    /// <summary>
    /// Creates a new RageState for a character.
    /// </summary>
    /// <param name="characterId">The character ID.</param>
    /// <param name="initialRage">Initial rage value (default 0).</param>
    /// <returns>A new RageState instance.</returns>
    public static RageState Create(Guid characterId, int initialRage = 0)
    {
        var clampedRage = Math.Clamp(initialRage, MinRage, MaxRage);
        var threshold = DetermineThreshold(clampedRage);

        return new RageState
        {
            CharacterId = characterId,
            CurrentRage = clampedRage,
            Threshold = threshold,
            DamageBonus = CalculateDamageBonus(clampedRage),
            DamageTakenReduction = CalculateDamageTakenReduction(clampedRage),
            SoakBonus = CalculateSoakBonus(threshold),
            FearImmune = threshold == RageThreshold.FrenzyBeyondReason,
            MustAttackNearest = threshold >= RageThreshold.BerserkFury,
            PartyStressReduction = threshold == RageThreshold.FrenzyBeyondReason ? 10 : null,
            LastCombatTime = null
        };
    }

    /// <summary>
    /// Determines the rage threshold for a given rage value.
    /// </summary>
    /// <param name="rage">The rage value (0-100).</param>
    /// <returns>The corresponding RageThreshold.</returns>
    public static RageThreshold DetermineThreshold(int rage) =>
        rage switch
        {
            > FrenzyBeyondReasonThreshold => RageThreshold.FrenzyBeyondReason,
            > BerserkFuryThreshold => RageThreshold.BerserkFury,
            > BurningThreshold => RageThreshold.Burning,
            > SimmeringThreshold => RageThreshold.Simmering,
            _ => RageThreshold.Calm
        };

    #endregion

    #region Private Calculation Methods

    /// <summary>
    /// Calculates damage bonus from rage value.
    /// </summary>
    private static int CalculateDamageBonus(int rage) =>
        Math.Min(MaxRage, rage) / 10;

    /// <summary>
    /// Calculates damage reduction percentage from rage value.
    /// </summary>
    private static int CalculateDamageTakenReduction(int rage) =>
        (rage / 20) * 5;

    /// <summary>
    /// Calculates soak bonus from threshold.
    /// </summary>
    private static int CalculateSoakBonus(RageThreshold threshold) =>
        threshold switch
        {
            RageThreshold.Calm => 0,
            RageThreshold.Simmering => 1,
            RageThreshold.Burning => 2,
            RageThreshold.BerserkFury => 3,
            RageThreshold.FrenzyBeyondReason => 4,
            _ => 0
        };

    #endregion

    #region Display

    /// <inheritdoc/>
    public override string ToString() =>
        $"Rage[{Threshold}]: {CurrentRage}/100 " +
        $"(DMG +{DamageBonus}, SOAK +{SoakBonus})" +
        (FearImmune ? " [FEAR IMMUNE]" : "") +
        (MustAttackNearest ? " [MUST ATTACK]" : "");

    #endregion
}
```

### 5.4 RageGainResult Record

**File:** `src/Core/RuneAndRust.Domain/ValueObjects/RageGainResult.cs`

```csharp
namespace RuneAndRust.Domain.ValueObjects;

using RuneAndRust.Domain.Enums;

/// <summary>
/// Represents the result of a rage gain operation.
/// </summary>
/// <param name="PreviousRage">Rage value before gain.</param>
/// <param name="NewRage">Rage value after gain.</param>
/// <param name="AmountGained">Amount of rage gained.</param>
/// <param name="Source">Source of rage generation.</param>
/// <param name="ThresholdChanged">Whether threshold changed.</param>
/// <param name="NewThreshold">New threshold if changed.</param>
public record RageGainResult(
    int PreviousRage,
    int NewRage,
    int AmountGained,
    RageSource Source,
    bool ThresholdChanged,
    RageThreshold? NewThreshold)
{
    /// <summary>
    /// Gets whether rage reached maximum (100).
    /// </summary>
    public bool CappedAtMaximum => NewRage == 100;

    /// <summary>
    /// Gets whether this gain triggered a threshold change.
    /// </summary>
    public bool IsCriticalGain =>
        ThresholdChanged && NewThreshold == RageThreshold.FrenzyBeyondReason;

    /// <summary>
    /// Creates a display string for this rage gain.
    /// </summary>
    public string ToDisplayString() =>
        $"Rage +{AmountGained} from {Source} " +
        $"({PreviousRage} → {NewRage})" +
        (ThresholdChanged ? $" [Threshold: {NewThreshold}]" : "");
}
```

### 5.5 RageDecayResult Record

**File:** `src/Core/RuneAndRust.Domain/ValueObjects/RageDecayResult.cs`

```csharp
namespace RuneAndRust.Domain.ValueObjects;

using RuneAndRust.Domain.Enums;

/// <summary>
/// Represents the result of a rage decay operation.
/// </summary>
/// <param name="PreviousRage">Rage value before decay.</param>
/// <param name="NewRage">Rage value after decay.</param>
/// <param name="AmountDecayed">Amount of rage decayed.</param>
/// <param name="ThresholdChanged">Whether threshold changed.</param>
/// <param name="NewThreshold">New threshold if changed.</param>
public record RageDecayResult(
    int PreviousRage,
    int NewRage,
    int AmountDecayed,
    bool ThresholdChanged,
    RageThreshold? NewThreshold)
{
    /// <summary>
    /// Gets whether rage fell to zero.
    /// </summary>
    public bool ZeroedOut => NewRage == 0;

    /// <summary>
    /// Creates a display string for this rage decay.
    /// </summary>
    public string ToDisplayString() =>
        $"Rage -{AmountDecayed} " +
        $"({PreviousRage} → {NewRage})" +
        (ThresholdChanged ? $" [Threshold: {NewThreshold}]" : "");
}
```

---

## 6. Data Model

### 6.1 Rage Entity Relationships

```csharp
// Add to Character entity:

/// <summary>
/// Gets the character's rage state.
/// </summary>
public RageState? RageState { get; private set; }
```

### 6.2 Database Schema (for v0.18.4f)

```sql
CREATE TABLE IF NOT EXISTS character_rage (
    character_id UUID PRIMARY KEY REFERENCES characters(id) ON DELETE CASCADE,
    current_rage INT NOT NULL DEFAULT 0
        CONSTRAINT chk_rage_range CHECK (current_rage >= 0 AND current_rage <= 100),
    last_combat_time TIMESTAMP,
    updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX idx_character_rage_combat_time
    ON character_rage(character_id, last_combat_time);
```

---

## 7. Logging Specifications

### 7.1 Domain Layer Logging

> **Note:** Enums and value objects do not log directly.
> All logging occurs in Application Layer services (v0.18.4e).

### 7.2 Expected Log Events (Future Implementation in v0.18.4e)

| Event                  | Level       | Template                                                      |
| ---------------------- | ----------- | ------------------------------------------------------------- |
| Rage Threshold Changed | Information | `"Rage threshold changed: {CharacterId} {OldThreshold} → {NewThreshold}"` |
| Rage Capped at Max     | Debug       | `"Rage capped at 100 for {CharacterId}: {Source}"`            |
| Rage Decayed           | Debug       | `"Rage decayed: {CharacterId} {Amount} points in non-combat"`  |
| FrenzyBeyondReason     | Warning     | `"FRENZY: {CharacterId} entered FrenzyBeyondReason threshold"` |

---

## 8. Unit Testing Requirements

### 8.1 Test File Location

**File:** `tests/RuneAndRust.Domain.UnitTests/Entities/RageStateTests.cs`

### 8.2 Required Tests

| Test Name                                              | Description                                                      |
| ------------------------------------------------------ | ---------------------------------------------------------------- |
| `Create_WithZeroRage_ReturnsCalmThreshold`             | Verify Calm threshold at 0 rage                                  |
| `Create_AtBoundaryValues_ReturnsCorrectThresholds`     | Verify all threshold boundaries (20→Simmering, 40→Burning, etc.) |
| `Create_WithMaxRage_ReturnsFrenzyBeyondReasonState`    | Verify FrenzyBeyondReason and bonuses at 100 rage               |
| `DamageBonus_CalculatesCorrectly_ForAllRanges`         | Verify damage bonus = floor(rage / 10)                          |
| `SoakBonus_ScalesWithThreshold_Correctly`              | Verify soak bonus 0-4 scales with threshold                     |

### 8.3 Example Tests

```csharp
[TestFixture]
public class RageStateTests
{
    [Test]
    public void Create_WithZeroRage_ReturnsCalmThreshold()
    {
        // Arrange & Act
        var rageState = RageState.Create(Guid.NewGuid(), initialRage: 0);

        // Assert
        rageState.Threshold.Should().Be(RageThreshold.Calm);
        rageState.CurrentRage.Should().Be(0);
        rageState.DamageBonus.Should().Be(0);
        rageState.SoakBonus.Should().Be(0);
        rageState.FearImmune.Should().BeFalse();
    }

    [TestCase(0, RageThreshold.Calm)]
    [TestCase(20, RageThreshold.Calm)]
    [TestCase(21, RageThreshold.Simmering)]
    [TestCase(40, RageThreshold.Simmering)]
    [TestCase(41, RageThreshold.Burning)]
    [TestCase(60, RageThreshold.Burning)]
    [TestCase(61, RageThreshold.BerserkFury)]
    [TestCase(80, RageThreshold.BerserkFury)]
    [TestCase(81, RageThreshold.FrenzyBeyondReason)]
    [TestCase(100, RageThreshold.FrenzyBeyondReason)]
    public void Create_AtBoundaryValues_ReturnsCorrectThresholds(int rage, RageThreshold expected)
    {
        // Arrange & Act
        var rageState = RageState.Create(Guid.NewGuid(), initialRage: rage);

        // Assert
        rageState.Threshold.Should().Be(expected);
    }

    [TestCase(0, 0)]
    [TestCase(5, 0)]
    [TestCase(10, 1)]
    [TestCase(50, 5)]
    [TestCase(99, 9)]
    [TestCase(100, 10)]
    public void DamageBonus_CalculatesCorrectly_ForAllRanges(int rage, int expectedBonus)
    {
        // Arrange & Act
        var rageState = RageState.Create(Guid.NewGuid(), initialRage: rage);

        // Assert
        rageState.DamageBonus.Should().Be(expectedBonus);
    }

    [TestCase(RageThreshold.Calm, 0)]
    [TestCase(RageThreshold.Simmering, 1)]
    [TestCase(RageThreshold.Burning, 2)]
    [TestCase(RageThreshold.BerserkFury, 3)]
    [TestCase(RageThreshold.FrenzyBeyondReason, 4)]
    public void SoakBonus_ScalesWithThreshold_Correctly(RageThreshold threshold, int expectedSoak)
    {
        // Arrange
        var rage = threshold switch
        {
            RageThreshold.Calm => 10,
            RageThreshold.Simmering => 30,
            RageThreshold.Burning => 50,
            RageThreshold.BerserkFury => 70,
            RageThreshold.FrenzyBeyondReason => 90,
            _ => 0
        };

        // Act
        var rageState = RageState.Create(Guid.NewGuid(), initialRage: rage);

        // Assert
        rageState.SoakBonus.Should().Be(expectedSoak);
    }
}
```

---

## 9. Deliverable Checklist

### 9.1 Domain Layer

- [ ] `src/Core/RuneAndRust.Domain/Enums/RageThreshold.cs`
- [ ] `src/Core/RuneAndRust.Domain/Enums/RageSource.cs`
- [ ] `src/Core/RuneAndRust.Domain/Entities/RageState.cs`
- [ ] `src/Core/RuneAndRust.Domain/ValueObjects/RageGainResult.cs`
- [ ] `src/Core/RuneAndRust.Domain/ValueObjects/RageDecayResult.cs`

### 9.2 Tests

- [ ] `tests/RuneAndRust.Domain.UnitTests/Entities/RageStateTests.cs`

### 9.3 Documentation

- [ ] Create `docs/design/v0.18.x/v0.18.4a-design-specification.md`
- [ ] Update `docs/design/v0.18.x/v0.18.4-scope-breakdown.md` (mark v0.18.4a complete)

---

## 10. Acceptance Criteria

### 10.1 Build Verification

- [ ] Solution builds without errors
- [ ] Solution builds without warnings in new code

### 10.2 Test Verification

- [ ] All new unit tests pass
- [ ] All existing unit tests continue to pass

### 10.3 Functional Verification

- [ ] `RageThreshold` enum contains all 5 thresholds
- [ ] `RageSource` enum contains all 5 sources
- [ ] `RageState.Create()` correctly determines threshold from rage
- [ ] `RageState.DetermineThreshold()` handles all boundary values
- [ ] Damage bonus correctly calculated as floor(rage / 10)
- [ ] Soak bonus scales 0-4 with threshold
- [ ] `FearImmune` true only at FrenzyBeyondReason
- [ ] `MustAttackNearest` true at BerserkFury and above
- [ ] `PartyStressReduction` is 10 only at FrenzyBeyondReason
- [ ] `RageGainResult` and `RageDecayResult` records serialize correctly

---

## 11. Dependencies

### 11.1 Required Prerequisites

| Dependency           | Version | Status   | Notes                               |
| -------------------- | ------- | -------- | ----------------------------------- |
| Specialization Sys   | v0.17.4 | Required | For Berserker specialization check |
| Psychic Stress Sys   | v0.18.0 | Required | For stress-related effects         |
| Character Domain     | v0.6.x+ | Required | RageState belongs to Character      |

### 11.2 Deferred to Later Phases

| Item                         | Deferred To | Reason                      |
| ---------------------------- | ----------- | --------------------------- |
| `IRageService` interface     | v0.18.4d    | Service contract separately |
| `RageService` implementation | v0.18.4e    | Service logic separately    |
| Configuration loading        | v0.18.4f    | Centralized in config phase |
| Database persistence         | v0.18.4f    | Persistence layer separate |

---

## 12. Future Considerations

### 12.1 v0.18.4b (Momentum System)

- Similar structure for Storm Blade specialization
- Different decay and bonus mechanics

### 12.2 v0.18.4c (Coherence System)

- Similar structure for Arcanist specialization
- Cascade and Apotheosis mechanics

### 12.3 v0.18.4d-e (Services)

- Service interfaces and implementations
- Cross-system interactions (stress, damage, etc.)

### 12.4 v0.18.4f (Configuration & Persistence)

- JSON configuration for all three resource systems
- Database persistence layer

---

## Changelog

| Version | Date       | Changes                  |
| ------- | ---------- | ------------------------ |
| 1.0     | 2026-01-28 | Initial design complete  |
