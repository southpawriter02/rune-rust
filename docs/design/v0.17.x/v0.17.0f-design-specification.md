# v0.17.0f Design Specification: LineageApplicationService

**Version:** 0.17.0f  
**Phase Name:** LineageApplicationService  
**Parent Version:** v0.17.0 (Lineage System)  
**Prerequisites:** v0.17.0e Complete (LineageProvider Service)  
**Estimated Tests:** ~6 unit tests

---

## Table of Contents

1. [Executive Summary](#1-executive-summary)
2. [Feature Overview](#2-feature-overview)
3. [Architecture Diagrams](#3-architecture-diagrams)
4. [ILineageApplicationService Interface](#4-ilineageapplicationservice-interface)
5. [LineageApplicationService Implementation](#5-lineageapplicationservice-implementation)
6. [LineageApplicationResult](#6-lineageapplicationresult)
7. [Data Model Changes](#7-data-model-changes)
8. [Logging Specifications](#8-logging-specifications)
9. [Unit Testing Requirements](#9-unit-testing-requirements)
10. [Use Cases](#10-use-cases)
11. [User Stories](#11-user-stories)
12. [Deliverable Checklist](#12-deliverable-checklist)
13. [Acceptance Criteria](#13-acceptance-criteria)
14. [Dependencies](#14-dependencies)
15. [Future Considerations](#15-future-considerations)

---

## 1. Executive Summary

### 1.1 Purpose

This specification defines the LineageApplicationService that applies lineage bonuses, traits, and trauma baselines to characters during creation. The service orchestrates the application of all lineage components from v0.17.0a-d to a character entity.

### 1.2 Key Deliverables

| Category         | Items                        |
| ---------------- | ---------------------------- |
| **Interfaces**   | `ILineageApplicationService` |
| **Services**     | `LineageApplicationService`  |
| **Result Types** | `LineageApplicationResult`   |
| **Tests**        | ~6 unit tests                |

### 1.3 Architectural Significance

- **Orchestration**: Coordinates application of all lineage components
- **Validation**: Ensures lineage can be applied to character
- **Result Pattern**: Returns detailed result with applied changes
- **Idempotency**: Prevents duplicate lineage application

---

## 2. Feature Overview

```
v0.17.0f LineageApplicationService
├── ILineageApplicationService Interface
│   ├── ApplyLineage(character, lineage): LineageApplicationResult
│   ├── ValidateLineageSelection(character, lineage): ValidationResult
│   └── GetApplicableLineages(character): IReadOnlyList<Lineage>
├── LineageApplicationService Implementation
│   ├── Uses ILineageProvider for lineage data
│   ├── Applies attribute modifiers
│   ├── Applies passive bonuses
│   ├── Registers unique trait
│   └── Sets trauma baseline
└── LineageApplicationResult
    ├── Success: bool
    ├── AppliedLineage: Lineage
    ├── AttributeChanges: Dictionary<CoreAttribute, int>
    ├── BonusesApplied: LineagePassiveBonuses
    ├── TraitRegistered: LineageTrait
    └── TraumaBaselineSet: LineageTraumaBaseline
```

---

## 3. Architecture Diagrams

### 3.1 System Overview

```
┌─────────────────────────────────────────────────────────────────────┐
│                LINEAGEAPPLICATIONSERVICE OVERVIEW                    │
└─────────────────────────────────────────────────────────────────────┘

    Character Creation Flow
           │
           ▼
┌─────────────────────────────────────────────────────────────────────┐
│                ILineageApplicationService                            │
├─────────────────────────────────────────────────────────────────────┤
│  + ApplyLineage(character, lineage): LineageApplicationResult       │
│  + ValidateLineageSelection(character, lineage): ValidationResult   │
│  + GetApplicableLineages(character): IReadOnlyList<Lineage>         │
└─────────────────────────────────────────────────────────────────────┘
           │
           │  Uses
           ▼
┌─────────────────────────────────────────────────────────────────────┐
│                     ILineageProvider                                 │
├─────────────────────────────────────────────────────────────────────┤
│  GetLineage(lineage) → LineageDefinition                            │
└─────────────────────────────────────────────────────────────────────┘
           │
           │  Applies to
           ▼
┌─────────────────────────────────────────────────────────────────────┐
│                        Character                                     │
├─────────────────────────────────────────────────────────────────────┤
│  + Attributes (modified by AttributeModifiers)                       │
│  + DerivedStats (modified by PassiveBonuses)                        │
│  + Traits (registers UniqueTrait)                                    │
│  + Corruption/Stress (set by TraumaBaseline)                        │
└─────────────────────────────────────────────────────────────────────┘
```

### 3.2 Application Flow

```
┌─────────────────────────────────────────────────────────────────────┐
│                    LINEAGE APPLICATION FLOW                          │
└─────────────────────────────────────────────────────────────────────┘

    ApplyLineage(character, Lineage.RuneMarked)
           │
           ▼
┌──────────────────────────┐
│ 1. VALIDATE              │
├──────────────────────────┤
│ - Character not null     │
│ - No lineage already set │
│ - Lineage exists         │
└──────────┬───────────────┘
           │
           ▼
┌──────────────────────────┐
│ 2. GET LINEAGE DEFINITION│
├──────────────────────────┤
│ _lineageProvider         │
│   .GetLineage(lineage)   │
└──────────┬───────────────┘
           │
           ▼
┌──────────────────────────┐      ┌────────────────────────────────┐
│ 3. APPLY ATTRIBUTES      │      │ WILL +2, STURDINESS -1         │
├──────────────────────────┤  →   │ character.ModifyAttribute(...)  │
│ AttributeModifiers       │      │                                 │
└──────────┬───────────────┘      └────────────────────────────────┘
           │
           ▼
┌──────────────────────────┐      ┌────────────────────────────────┐
│ 4. APPLY BONUSES         │      │ +5 Max AP, +1 Lore skill        │
├──────────────────────────┤  →   │ character.ApplyBonuses(...)     │
│ PassiveBonuses           │      │                                 │
└──────────┬───────────────┘      └────────────────────────────────┘
           │
           ▼
┌──────────────────────────┐      ┌────────────────────────────────┐
│ 5. REGISTER TRAIT        │      │ [Aether-Tainted] registered     │
├──────────────────────────┤  →   │ character.RegisterTrait(...)    │
│ UniqueTrait              │      │                                 │
└──────────┬───────────────┘      └────────────────────────────────┘
           │
           ▼
┌──────────────────────────┐      ┌────────────────────────────────┐
│ 6. SET TRAUMA BASELINE   │      │ Corruption=5, CorruptRes=-1     │
├──────────────────────────┤  →   │ character.SetTraumaBaseline(...) │
│ TraumaBaseline           │      │                                 │
└──────────┬───────────────┘      └────────────────────────────────┘
           │
           ▼
┌──────────────────────────┐
│ 7. RETURN RESULT         │
├──────────────────────────┤
│ Success = true           │
│ All changes documented   │
└──────────────────────────┘
```

### 3.3 Validation Decision Tree

```
    ValidateLineageSelection(character, lineage)
           │
           ▼
    ┌──────────────────────┐
    │ Character is null?   │
    └──────────┬───────────┘
          ┌────┴────┐
         YES        NO
          │          │
          ▼          ▼
    ┌──────────┐  ┌──────────────────────┐
    │ FAIL:    │  │ Character has        │
    │ No char  │  │ lineage already?     │
    └──────────┘  └──────────┬───────────┘
                        ┌────┴────┐
                       YES        NO
                        │          │
                        ▼          ▼
                  ┌──────────┐  ┌──────────────────────┐
                  │ FAIL:    │  │ Lineage exists in    │
                  │ Already  │  │ provider?            │
                  │ set      │  └──────────┬───────────┘
                  └──────────┘        ┌────┴────┐
                                     YES        NO
                                      │          │
                                      ▼          ▼
                                ┌──────────┐ ┌──────────┐
                                │ SUCCESS  │ │ FAIL:    │
                                │ Valid    │ │ Unknown  │
                                └──────────┘ │ lineage  │
                                             └──────────┘
```

---

## 4. ILineageApplicationService Interface

**File:** `src/Core/RuneAndRust.Application/Interfaces/ILineageApplicationService.cs`

```csharp
namespace RuneAndRust.Application.Interfaces;

using RuneAndRust.Domain.Entities;
using RuneAndRust.Domain.Enums;

/// <summary>
/// Applies lineage bonuses, traits, and trauma baselines to characters.
/// </summary>
public interface ILineageApplicationService
{
    /// <summary>
    /// Applies the specified lineage to a character during creation.
    /// </summary>
    /// <param name="character">The character to apply lineage to.</param>
    /// <param name="lineage">The lineage to apply.</param>
    /// <returns>Result containing success status and applied changes.</returns>
    LineageApplicationResult ApplyLineage(Character character, Lineage lineage);

    /// <summary>
    /// Validates whether a lineage can be applied to a character.
    /// </summary>
    /// <param name="character">The character to validate.</param>
    /// <param name="lineage">The lineage to validate.</param>
    /// <returns>Validation result with any failure reasons.</returns>
    ValidationResult ValidateLineageSelection(Character character, Lineage lineage);

    /// <summary>
    /// Gets all lineages that can be applied to the character.
    /// </summary>
    /// <param name="character">The character to check.</param>
    /// <returns>List of applicable lineages.</returns>
    IReadOnlyList<Lineage> GetApplicableLineages(Character character);
}
```

---

## 5. LineageApplicationService Implementation

**File:** `src/Core/RuneAndRust.Application/Services/LineageApplicationService.cs`

```csharp
namespace RuneAndRust.Application.Services;

using Microsoft.Extensions.Logging;
using RuneAndRust.Application.Interfaces;
using RuneAndRust.Domain.Entities;
using RuneAndRust.Domain.Enums;

/// <summary>
/// Applies lineage components to characters during creation.
/// </summary>
public class LineageApplicationService : ILineageApplicationService
{
    private readonly ILineageProvider _lineageProvider;
    private readonly ILogger<LineageApplicationService> _logger;

    public LineageApplicationService(
        ILineageProvider lineageProvider,
        ILogger<LineageApplicationService> logger)
    {
        _lineageProvider = lineageProvider;
        _logger = logger;
    }

    /// <inheritdoc />
    public LineageApplicationResult ApplyLineage(Character character, Lineage lineage)
    {
        var validation = ValidateLineageSelection(character, lineage);
        if (!validation.IsValid)
        {
            _logger.LogWarning(
                "Lineage application failed validation. Lineage={Lineage}, Reason={Reason}",
                lineage, validation.FailureReason);
            return LineageApplicationResult.Failure(validation.FailureReason!);
        }

        var definition = _lineageProvider.GetLineage(lineage)!;
        var attributeChanges = new Dictionary<CoreAttribute, int>();

        // 1. Apply attribute modifiers
        ApplyAttributeModifiers(character, definition.AttributeModifiers, attributeChanges);

        // 2. Apply passive bonuses
        ApplyPassiveBonuses(character, definition.PassiveBonuses);

        // 3. Register unique trait
        RegisterTrait(character, definition.UniqueTrait);

        // 4. Set trauma baseline
        SetTraumaBaseline(character, definition.TraumaBaseline);

        // 5. Set lineage on character
        character.SetLineage(lineage);

        _logger.LogInformation(
            "Applied lineage to character. CharId={CharId}, Lineage={Lineage}",
            character.Id, lineage);

        return LineageApplicationResult.Success(
            lineage,
            attributeChanges,
            definition.PassiveBonuses,
            definition.UniqueTrait,
            definition.TraumaBaseline);
    }

    /// <inheritdoc />
    public ValidationResult ValidateLineageSelection(Character character, Lineage lineage)
    {
        if (character == null)
            return ValidationResult.Fail("Character cannot be null");

        if (character.HasLineage)
            return ValidationResult.Fail("Character already has a lineage assigned");

        var definition = _lineageProvider.GetLineage(lineage);
        if (definition == null)
            return ValidationResult.Fail($"Unknown lineage: {lineage}");

        return ValidationResult.Valid();
    }

    /// <inheritdoc />
    public IReadOnlyList<Lineage> GetApplicableLineages(Character character)
    {
        if (character.HasLineage)
            return Array.Empty<Lineage>();

        return _lineageProvider.GetAllLineages()
            .Select(d => d.LineageId)
            .ToList()
            .AsReadOnly();
    }

    private void ApplyAttributeModifiers(
        Character character,
        LineageAttributeModifiers mods,
        Dictionary<CoreAttribute, int> changes)
    {
        if (mods.MightModifier != 0)
        {
            character.ModifyAttribute(CoreAttribute.Might, mods.MightModifier);
            changes[CoreAttribute.Might] = mods.MightModifier;
        }
        if (mods.FinesseModifier != 0)
        {
            character.ModifyAttribute(CoreAttribute.Finesse, mods.FinesseModifier);
            changes[CoreAttribute.Finesse] = mods.FinesseModifier;
        }
        if (mods.WitsModifier != 0)
        {
            character.ModifyAttribute(CoreAttribute.Wits, mods.WitsModifier);
            changes[CoreAttribute.Wits] = mods.WitsModifier;
        }
        if (mods.WillModifier != 0)
        {
            character.ModifyAttribute(CoreAttribute.Will, mods.WillModifier);
            changes[CoreAttribute.Will] = mods.WillModifier;
        }
        if (mods.SturdinessModifier != 0)
        {
            character.ModifyAttribute(CoreAttribute.Sturdiness, mods.SturdinessModifier);
            changes[CoreAttribute.Sturdiness] = mods.SturdinessModifier;
        }

        _logger.LogDebug(
            "Applied attribute modifiers. Changes={Changes}",
            string.Join(", ", changes.Select(c => $"{c.Key}:{c.Value:+#;-#;0}")));
    }

    private void ApplyPassiveBonuses(Character character, LineagePassiveBonuses bonuses)
    {
        if (bonuses.MaxHpBonus != 0)
            character.ModifyMaxHp(bonuses.MaxHpBonus);
        if (bonuses.MaxApBonus != 0)
            character.ModifyMaxAp(bonuses.MaxApBonus);
        if (bonuses.SoakBonus != 0)
            character.ModifySoak(bonuses.SoakBonus);
        if (bonuses.MovementBonus != 0)
            character.ModifyMovement(bonuses.MovementBonus);

        foreach (var skillBonus in bonuses.SkillBonuses)
            character.ModifySkill(skillBonus.SkillId, skillBonus.BonusAmount);

        _logger.LogDebug("Applied passive bonuses. Bonuses={Bonuses}", bonuses);
    }

    private void RegisterTrait(Character character, LineageTrait trait)
    {
        character.RegisterLineageTrait(trait);
        _logger.LogDebug("Registered unique trait. Trait={Trait}", trait.TraitName);
    }

    private void SetTraumaBaseline(Character character, LineageTraumaBaseline baseline)
    {
        character.SetTraumaBaseline(
            baseline.StartingCorruption,
            baseline.StartingStress,
            baseline.CorruptionResistanceModifier,
            baseline.StressResistanceModifier);

        _logger.LogDebug("Set trauma baseline. Baseline={Baseline}", baseline);
    }
}
```

---

## 6. LineageApplicationResult

**File:** `src/Core/RuneAndRust.Application/DTOs/LineageApplicationResult.cs`

```csharp
namespace RuneAndRust.Application.DTOs;

using RuneAndRust.Domain.Enums;
using RuneAndRust.Domain.ValueObjects;

/// <summary>
/// Result of applying a lineage to a character.
/// </summary>
public record LineageApplicationResult(
    bool IsSuccess,
    string? FailureReason,
    Lineage? AppliedLineage,
    IReadOnlyDictionary<CoreAttribute, int>? AttributeChanges,
    LineagePassiveBonuses? BonusesApplied,
    LineageTrait? TraitRegistered,
    LineageTraumaBaseline? TraumaBaselineSet)
{
    public static LineageApplicationResult Success(
        Lineage lineage,
        Dictionary<CoreAttribute, int> attributeChanges,
        LineagePassiveBonuses bonuses,
        LineageTrait trait,
        LineageTraumaBaseline baseline) =>
        new(true, null, lineage, attributeChanges, bonuses, trait, baseline);

    public static LineageApplicationResult Failure(string reason) =>
        new(false, reason, null, null, null, null, null);
}

/// <summary>
/// Result of validation operation.
/// </summary>
public record ValidationResult(bool IsValid, string? FailureReason)
{
    public static ValidationResult Valid() => new(true, null);
    public static ValidationResult Fail(string reason) => new(false, reason);
}
```

---

## 7. Data Model Changes

| Type                         | Layer       | Category  | Description                      |
| ---------------------------- | ----------- | --------- | -------------------------------- |
| `ILineageApplicationService` | Application | Interface | Lineage application contract     |
| `LineageApplicationService`  | Application | Service   | Orchestrates lineage application |
| `LineageApplicationResult`   | Application | DTO       | Application result details       |
| `ValidationResult`           | Application | DTO       | Validation result                |

### File Locations

```
src/Core/RuneAndRust.Application/
├── Interfaces/
│   └── ILineageApplicationService.cs    ← NEW
├── Services/
│   └── LineageApplicationService.cs     ← NEW
└── DTOs/
    └── LineageApplicationResult.cs      ← NEW
```

---

## 8. Logging Specifications

| Component                   | Level       | Events                       |
| --------------------------- | ----------- | ---------------------------- |
| `LineageApplicationService` | Information | Lineage applied successfully |
| `LineageApplicationService` | Debug       | Each component applied       |
| `LineageApplicationService` | Warning     | Validation failed            |

```csharp
// Information - Lineage applied
_logger.LogInformation(
    "Applied lineage to character. CharId={CharId}, Lineage={Lineage}",
    character.Id, lineage);

// Warning - Validation failed
_logger.LogWarning(
    "Lineage application failed validation. Lineage={Lineage}, Reason={Reason}",
    lineage, validation.FailureReason);
```

---

## 9. Unit Testing Requirements

**File:** `tests/RuneAndRust.Application.UnitTests/Services/LineageApplicationServiceTests.cs`

| Test                                                     | Description              |
| -------------------------------------------------------- | ------------------------ |
| `ApplyLineage_WithValidCharacter_AppliesAllComponents`   | Full application success |
| `ApplyLineage_CharacterAlreadyHasLineage_ReturnsFail`    | Prevents duplicate       |
| `ApplyLineage_InvalidLineage_ReturnsFail`                | Unknown lineage handling |
| `ValidateLineageSelection_NullCharacter_ReturnsFail`     | Null validation          |
| `GetApplicableLineages_CharacterHasLineage_ReturnsEmpty` | Already assigned         |
| `GetApplicableLineages_NewCharacter_ReturnsAllFour`      | All options available    |

---

## 10. Use Cases

| ID     | Actor            | Flow                                                                        |
| ------ | ---------------- | --------------------------------------------------------------------------- |
| UC-001 | CharacterFactory | Create character → Call ApplyLineage → Apply all components → Return result |
| UC-002 | CreationUI       | Display options → Validate selection → Show preview → Apply on confirm      |
| UC-003 | SaveService      | Load character → Verify lineage applied → Skip if already set               |

---

## 11. User Stories

**US-001:** As a character creation system, I want to apply all lineage components atomically so that characters are correctly initialized.

**US-002:** As a UI developer, I want validation before application so that I can show errors without side effects.

**US-003:** As a player, I want to see what was applied so that I understand my character's baseline.

---

## 12. Deliverable Checklist

- [ ] `ILineageApplicationService.cs` interface created
- [ ] `LineageApplicationService.cs` implementation created
- [ ] `LineageApplicationResult.cs` DTO created
- [ ] `ValidationResult.cs` DTO created
- [ ] ~6 unit tests passing
- [ ] DI registration added
- [ ] XML documentation complete
- [ ] `v0.17.0f-changelog.md` created

---

## 13. Acceptance Criteria

### Functional

- [ ] `ApplyLineage()` applies all four component types
- [ ] `ApplyLineage()` fails if character already has lineage
- [ ] `ApplyLineage()` returns detailed result with all changes
- [ ] `ValidateLineageSelection()` validates without side effects
- [ ] `GetApplicableLineages()` returns empty if lineage already set
- [ ] Attribute modifiers correctly applied
- [ ] Passive bonuses correctly applied
- [ ] Unique trait registered
- [ ] Trauma baseline set

### Quality

- [ ] Build succeeds with 0 errors/warnings
- [ ] ~6 unit tests pass
- [ ] All public types have XML documentation

---

## 14. Dependencies

### Required from v0.17.0a-e

| Type                | Usage                         |
| ------------------- | ----------------------------- |
| `ILineageProvider`  | Source of lineage definitions |
| `LineageDefinition` | Contains all component data   |
| All value objects   | Applied to character          |

### Provides to v0.17.5

| Type                         | Usage                       |
| ---------------------------- | --------------------------- |
| `ILineageApplicationService` | Used by CharacterFactory    |
| `LineageApplicationResult`   | UI displays applied changes |

---

## 15. Future Considerations

### Deferred to v0.17.5

- Character Factory integration
- Character Creation UI integration

### Deferred to Future

- Flexible bonus attribute selection UI
- Lineage change mechanics (if ever allowed)
- Modding/custom lineage application

---

_Document Version: 1.0 | Last Updated: 2026-01-27_
