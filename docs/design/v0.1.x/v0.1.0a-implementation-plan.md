# v0.1.0a Implementation Plan: Z-Axis Foundation

## Overview

**Version:** 0.1.0a
**Focus:** Extend dungeon coordinate system to support vertical movement between levels
**Prerequisites:** v0.0.11 (Descriptors & Ambience)
**Estimated Unit Tests:** ~18 tests
**Estimated Implementation Effort:** Medium complexity

---

## Executive Summary

This implementation extends the dungeon from a 2D grid system to a 3D coordinate system by introducing `Position3D`, adding Up/Down directions, and enabling vertical room connections via stairs. The changes follow existing patterns established in prior versions while maintaining backwards compatibility.

### Key Features
- **Position3D Value Object**: 3D coordinates (X, Y, Z) for room and player positioning
- **Direction Enum Extension**: Add Up (4) and Down (5) direction values
- **StairType Enum**: Define 7 vertical connection types for flavor variety
- **Vertical Room Connections**: `ConnectRoomsVertically()` with bidirectional/one-way support
- **Movement Commands**: up/down/climb/descend command aliases
- **Expanded Starter Dungeon**: 7+ rooms across 2 levels (Z=0 and Z=1)

### Design Principles
1. **Backwards Compatibility**: Retain 2D Position for areas not needing Z-axis
2. **Immutability**: Position3D as readonly record struct following existing patterns
3. **Data-Driven**: StairType enables future flavor text and gameplay hooks

---

## Prerequisites & Dependencies

### From Existing Codebase (v0.0.11)

| Component | Purpose for v0.1.0a | Verified ✓ |
|-----------|---------------------|------------|
| `Position` value object | Base pattern for Position3D | ✓ |
| `Direction` enum | Extend with Up/Down | ✓ |
| `Room` entity | Migrate position, update exits | ✓ |
| `Dungeon` entity | Add vertical connections | ✓ |
| `Player` entity | Migrate position property | ✓ |
| `GameSession` entity | Update TryMovePlayer | ✓ |
| `GameSessionService` | Enhanced movement messages | ✓ |

---

## Architecture Overview

### Layer Diagram

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           PRESENTATION LAYER                                 │
├─────────────────────────────────────────────────────────────────────────────┤
│  GameView                                                                    │
│  └── RenderRoom() (updated) - Show vertical exits                           │
└─────────────────────────────────────────────────────────────────────────────┘
                                      │
                                      ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                           APPLICATION LAYER                                  │
├─────────────────────────────────────────────────────────────────────────────┤
│  GameSessionService (updated)                                                │
│  └── TryMove() - Enhanced messages for vertical movement                    │
└─────────────────────────────────────────────────────────────────────────────┘
                                      │
                                      ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                             DOMAIN LAYER                                     │
├─────────────────────────────────────────────────────────────────────────────┤
│  NEW:                          UPDATED:                                      │
│  ┌─────────────────────┐      ┌─────────────────────┐                       │
│  │ Position3D (new)    │      │ Direction (updated) │                       │
│  │ ├── X, Y, Z: int    │      │ ├── Up = 4          │                       │
│  │ ├── Move()          │      │ └── Down = 5        │                       │
│  │ ├── MoveUp()        │      └─────────────────────┘                       │
│  │ ├── MoveDown()      │      ┌─────────────────────┐                       │
│  │ └── ToPosition2D()  │      │ Room (updated)      │                       │
│  └─────────────────────┘      │ └── Position3D      │                       │
│  ┌─────────────────────┐      └─────────────────────┘                       │
│  │ StairType (new)     │      ┌─────────────────────┐                       │
│  │ ├── StairsUp        │      │ Dungeon (updated)   │                       │
│  │ ├── StairsDown      │      │ ├── GetOpposite()   │                       │
│  │ ├── Ladder          │      │ └── ConnectVert()   │                       │
│  │ ├── Shaft           │      └─────────────────────┘                       │
│  │ ├── Pit             │      ┌─────────────────────┐                       │
│  │ ├── SpiralStairs    │      │ Player (updated)    │                       │
│  │ └── Portal          │      │ └── Position3D      │                       │
│  └─────────────────────┘      └─────────────────────┘                       │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## Implementation Phases

### Phase 1: Domain Layer - Value Objects & Enums

#### 1.1 [NEW] Position3D.cs

**File:** `src/Core/RuneAndRust.Domain/ValueObjects/Position3D.cs`

Create a new 3D position value object following the existing `Position` pattern:

```csharp
namespace RuneAndRust.Domain.ValueObjects;

/// <summary>
/// Represents a 3D position in the dungeon grid.
/// </summary>
public readonly record struct Position3D(int X, int Y, int Z)
{
    public static Position3D Origin => new(0, 0, 0);
    
    public Position3D Move(int deltaX, int deltaY, int deltaZ) =>
        new(X + deltaX, Y + deltaY, Z + deltaZ);
    
    public Position3D MoveUp() => new(X, Y, Z - 1);
    public Position3D MoveDown() => new(X, Y, Z + 1);
    
    public Position3D Move(Direction direction) => direction switch
    {
        Direction.North => new(X, Y + 1, Z),
        Direction.South => new(X, Y - 1, Z),
        Direction.East => new(X + 1, Y, Z),
        Direction.West => new(X - 1, Y, Z),
        Direction.Up => MoveUp(),
        Direction.Down => MoveDown(),
        _ => throw new ArgumentOutOfRangeException(nameof(direction))
    };
    
    public Position ToPosition2D() => new(X, Y);
    
    public static Position3D FromPosition2D(Position position, int z = 0) =>
        new(position.X, position.Y, z);
    
    public int ManhattanDistanceTo(Position3D other) =>
        Math.Abs(X - other.X) + Math.Abs(Y - other.Y) + Math.Abs(Z - other.Z);
    
    public override string ToString() => $"({X}, {Y}, Z={Z})";
}
```

---

#### 1.2 [UPDATE] Direction.cs

**File:** `src/Core/RuneAndRust.Domain/Enums/Direction.cs`

Add Up and Down values with explicit integer assignments:

```diff
 public enum Direction
 {
-    North,
-    South,
-    East,
-    West
+    North = 0,
+    South = 1,
+    East = 2,
+    West = 3,
+    Up = 4,
+    Down = 5
 }
```

Also update XML documentation to reference 3D grid system.

---

#### 1.3 [NEW] StairType.cs

**File:** `src/Core/RuneAndRust.Domain/Enums/StairType.cs`

```csharp
namespace RuneAndRust.Domain.Enums;

/// <summary>
/// Types of vertical connections between dungeon levels.
/// </summary>
public enum StairType
{
    StairsUp = 0,
    StairsDown = 1,
    Ladder = 2,
    Shaft = 3,
    Pit = 4,        // One-way (down only)
    SpiralStairs = 5,
    Portal = 6
}
```

---

### Phase 2: Domain Layer - Entity Updates

#### 2.1 [UPDATE] Room.cs

**File:** `src/Core/RuneAndRust.Domain/Entities/Room.cs`

**Changes:**
1. Change `Position` property type from `Position` to `Position3D`
2. Add new constructor accepting Position3D
3. Add backwards-compatible constructor with [Obsolete] attribute
4. Update `GetExitsDescription()` to separate horizontal and vertical exits

Key code changes:
```csharp
// Change property type
public Position3D Position { get; private set; }

// New constructor
public Room(string name, string description, Position3D position)
{
    // ... existing validation
    Position = position;
}

// Backwards-compatible constructor
[Obsolete("Use Position3D constructor for new code.")]
public Room(string name, string description, Position position)
    : this(name, description, Position3D.FromPosition2D(position))
{
}

// Updated GetExitsDescription
public string GetExitsDescription()
{
    if (_exits.Count == 0)
        return "There are no visible exits.";

    var horizontalExits = _exits.Keys
        .Where(d => d is Direction.North or Direction.South or Direction.East or Direction.West)
        .Select(d => d.ToString().ToLower());

    var verticalExits = _exits.Keys
        .Where(d => d is Direction.Up or Direction.Down)
        .Select(d => d == Direction.Up ? "up" : "down");

    var allExits = horizontalExits.Concat(verticalExits).ToList();
    return $"Exits: {string.Join(", ", allExits)}";
}
```

---

#### 2.2 [UPDATE] Dungeon.cs

**File:** `src/Core/RuneAndRust.Domain/Entities/Dungeon.cs`

**Changes:**
1. Update `GetOppositeDirection()` for Up↔Down
2. Add `ConnectRoomsVertically()` method
3. Add vertical connections dictionary
4. Add `GetStairType()` method
5. Add `GetRoomByPosition(Position3D)` overload
6. Add `HasRoomAt(Position3D)` method
7. Update `CreateStarterDungeon()` with Level 1 rooms

Key additions:
```csharp
// Add field
private readonly Dictionary<(Guid, Guid), StairType> _verticalConnections = [];

// Update GetOppositeDirection (make public static for tests)
public static Direction GetOppositeDirection(Direction direction) => direction switch
{
    Direction.North => Direction.South,
    Direction.South => Direction.North,
    Direction.East => Direction.West,
    Direction.West => Direction.East,
    Direction.Up => Direction.Down,
    Direction.Down => Direction.Up,
    _ => throw new ArgumentOutOfRangeException(nameof(direction))
};

// New method
public void ConnectRoomsVertically(Guid upperRoomId, Guid lowerRoomId, StairType stairType)
{
    // Validate rooms exist and Z-level relationship
    // Add bidirectional connection (unless Pit)
    // Store stair type metadata
}

public StairType? GetStairType(Guid fromRoomId, Guid toRoomId) { ... }

public Room? GetRoomByPosition(Position3D position) =>
    _rooms.Values.FirstOrDefault(r => r.Position.Equals(position));

public bool HasRoomAt(Position3D position) =>
    _rooms.Values.Any(r => r.Position.Equals(position));
```

---

#### 2.3 [UPDATE] Player.cs

**File:** `src/Core/RuneAndRust.Domain/Entities/Player.cs`

**Changes:**
1. Change `Position` property type to `Position3D`
2. Update `MoveTo()` method parameter
3. Update constructors to use `Position3D.Origin`

```csharp
public Position3D Position { get; private set; }

public void MoveTo(Position3D newPosition)
{
    Position = newPosition;
}

// In constructors
Position = Position3D.Origin;
```

---

#### 2.4 [UPDATE] GameSession.cs

**File:** `src/Core/RuneAndRust.Domain/Entities/GameSession.cs`

No direct changes needed - `TryMovePlayer()` already works with any Direction value and delegates to Room's GetExit. Just ensure it updates player position with the room's Position3D.

---

### Phase 3: Application Layer

#### 3.1 [UPDATE] GameSessionService.cs

**File:** `src/Core/RuneAndRust.Application/Services/GameSessionService.cs`

Add enhanced movement messages for vertical directions around line 280-300:

```csharp
// In TryMove method, after successful movement
private string GetMoveMessage(Direction direction, Room targetRoom)
{
    return direction switch
    {
        Direction.Up => $"You climb up to {targetRoom.Name}.",
        Direction.Down => $"You descend to {targetRoom.Name}.",
        _ => $"You head {direction.ToString().ToLower()}."
    };
}
```

---

### Phase 4: Starter Dungeon Update

Update `Dungeon.CreateStarterDungeon()` to:
1. Change all existing rooms to use `Position3D` with Z=0
2. Add 3 new Level 1 rooms (Forgotten Crypt, Underground Lake, Crystal Cavern)
3. Connect levels with `ConnectRoomsVertically()`

---

## Test Specifications

### Test Files and Counts

| File | Tests | Description |
|------|-------|-------------|
| `Position3DTests.cs` | ~6 | Constructor, Move, MoveUp/Down, ToPosition2D, ManhattanDistance, Move(Direction) |
| `DirectionTests.cs` | ~3 | GetOppositeDirection for Up/Down, enum has 6 values |
| `DungeonVerticalTests.cs` | ~4 | ConnectRoomsVertically, GetStairType, one-way pit, validation |
| `RoomExitsTests.cs` | ~3 | GetExitsDescription includes vertical, HasExit for Up/Down |
| `StarterDungeonTests.cs` | ~2 | Has two levels, vertical connection works |
| **Total** | **~18** | |

### Test File Locations

- Domain tests: `tests/RuneAndRust.Domain.UnitTests/ValueObjects/Position3DTests.cs`
- Domain tests: `tests/RuneAndRust.Domain.UnitTests/Enums/DirectionTests.cs`
- Domain tests: `tests/RuneAndRust.Domain.UnitTests/Entities/DungeonVerticalTests.cs`

---

## Verification Plan

### Automated Tests

**Command to run all tests:**
```bash
dotnet test tests/RuneAndRust.Domain.UnitTests --verbosity normal
```

**Command to run specific test file:**
```bash
dotnet test tests/RuneAndRust.Domain.UnitTests --filter "FullyQualifiedName~Position3DTests"
```

### Build Verification

```bash
dotnet build --warnaserror
```

### Manual Verification

After implementation, the user can verify by:
1. Run the TUI application
2. Navigate to Dungeon Passage (north from Entrance, north from Armory)
3. Type `down` or `descend` - should move to Forgotten Crypt
4. Type `look` - should show exits including "up"
5. Type `up` or `climb` - should return to Dungeon Passage

---

## Deliverable Checklist

### Domain Layer
- [ ] `Position3D.cs` value object created
- [ ] `StairType.cs` enum created
- [ ] `Direction.cs` updated with Up=4, Down=5
- [ ] `Room.cs` Position property migrated to Position3D
- [ ] `Room.cs` GetExitsDescription updated for vertical
- [ ] `Dungeon.cs` GetOppositeDirection updated
- [ ] `Dungeon.cs` ConnectRoomsVertically added
- [ ] `Dungeon.cs` GetRoomByPosition(Position3D) added
- [ ] `Dungeon.cs` CreateStarterDungeon updated with Level 1
- [ ] `Player.cs` Position property migrated to Position3D
- [ ] `GameSession.cs` TryMovePlayer works with Position3D

### Application Layer
- [ ] `GameSessionService.cs` movement messages enhanced

### Tests
- [ ] `Position3DTests.cs` (~6 tests)
- [ ] `DirectionTests.cs` (~3 tests)
- [ ] `DungeonVerticalTests.cs` (~4 tests)
- [ ] Room/Movement tests (~5 tests)
- [ ] All ~18 tests passing

### Quality
- [ ] Build succeeds with 0 errors and 0 warnings
- [ ] XML documentation complete for all new/modified types

---

## Future Considerations

### Deferred to v0.1.0b
- Procedural room generation across Z-levels
- Depth-based difficulty scaling

### Deferred to v0.1.0c
- Hidden vertical passages
- Climbing skill checks for shafts

### Deferred to v0.1.0d
- Multi-level map display
- Z-level indicator in UI

---

*This implementation plan provides a comprehensive roadmap for implementing v0.1.0a. It builds upon the established patterns from prior versions while maintaining the clean architecture principles already present in the codebase.*
