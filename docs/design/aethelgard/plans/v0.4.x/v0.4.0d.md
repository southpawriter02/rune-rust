# v0.4.0d: The Reward (XP Integration)

## Overview

This sub-phase focuses on "closing the loop" by integrating `SagaService` into the primary gameplay systems. It ensures actions (Kill Enemy, Discover Room) translate into Legend (XP) gains, which fuels the progression system built in Phases A, B, and C.

**Parent Plan:** [v0.4.0](./v0.4.0.md)
**Status:** Planned

---

## 1. Core Integrations

We need to inject `SagaService.AddLegend` calls into two key services: `CombatService` (for overcoming threats) and `NavigationService` (for exploration).

### 1.1 XP Tables

We will define standard XP values for threats and discoveries.

| Source | XP Value | Notes |
|--------|----------|-------|
| **Minion** | 25 | Weak fodders (Tier 0) |
| **Standard** | 100 | Baseline threats (Tier 1) |
| **Elite** | 250 | Hard threats (Tier 2) |
| **Boss** | 1000 | Milestone bosses (Tier 3) |
| **Discovery** | 10 | First time entering a Room |

---

## 2. Implementation Specifications

### 2.1 Combat Integration

**File:** `RuneAndRust.Engine/Services/CombatService.cs`

We will modify `EndCombat` to calculate and award XP *only on victory*.

*   **Logic:**
    1.  Upon `CheckVictoryCondition() == true`:
    2.  Iterate through `initialEnemies` (we need to track who we fought, or just sum them up as they die).
        *   *Better approach:* Accumulate `PendingXP` during the fight as enemies die?
        *   *Simpler approach:* In `EndCombat`, we have the list of enemies that were in the state. Wait, the `state` might be cleared.
        *   *Decision:* Track `XpPool` in `CombatState`. When an enemy dies (`RemoveDefeatedCombatant`), add their Tier XP to `XpPool`.
    3.  In `EndCombat`:
        *   If Victory: `_sagaService.AddLegend(character, state.XpPool, "Combat Victory")`.
        *   Log the gain.

### 2.2 Exploration Integration

**File:** `RuneAndRust.Engine/Services/NavigationService.cs`

We will modify `MoveAsync` to award XP for new discoveries.

*   **Logic:**
    1.  Check `_gameState.VisitedRoomIds.Contains(nextRoomId)`.
    2.  If **False** (New Room):
        *   `_sagaService.AddLegend(character, 10, "Room Discovery")`.
        *   Standard `VisitedRoomIds.Add` logic proceeds.

### 2.3 XP Calculator Helper

**File:** `RuneAndRust.Core/Calculators/XpCalculator.cs` (New)

Centralize the logic for converting Tiers/Actions to XP values to avoiding magic numbers in services.

```csharp
public static class XpCalculator
{
    public static int GetThreatXp(ThreatTier tier) => tier switch
    {
        ThreatTier.Minion => 25,
        ThreatTier.Standard => 100,
        ThreatTier.Elite => 250,
        ThreatTier.Boss => 1000,
        _ => 0
    };

    public const int RoomDiscoveryXp = 10;
}
```

---

## 3. Testing Strategy

### 3.1 Unit Tests

*   **`CombatServiceTests.cs`**:
    *   `EndCombat_Victory_AwardsXP`: Verify `SagaService.AddLegend` is called with correct total.
    *   `EndCombat_Defeat_NoXP`: Verify no XP awarded on loss.
*   **`NavigationServiceTests.cs`**:
    *   `Move_NewRoom_AwardsXP`: Verify 10 XP gain.
    *   `Move_VisitedRoom_NoXP`: Verify 0 XP gain.

### 3.2 Manual Verification

1.  **New Game:** Check initial Legend (0).
2.  **Move:** Enter a new room. Check Legend (10). Move back and forth. Check Legend (still 10).
3.  **Fight:** Trigger combat with a Rat (Minion). Win. Check Legend (35).
4.  **Level Up:** Continue until threshold (e.g., 100 XP). Verify Level Up event triggers.

---

## 4. Work Breakdown

- [ ] Core: Create `XpCalculator` static class.
- [ ] Engine: Update `CombatState` to track `XpPool`.
- [ ] Engine: Modify `CombatService` to accumulate XP on death and award on victory.
- [ ] Engine: Modify `NavigationService` to award XP on new room entry.
- [ ] Tests: Unit tests for integration points.
