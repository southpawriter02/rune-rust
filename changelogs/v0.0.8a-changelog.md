# v0.0.8a Changelog - Core Experience System

**Date:** 2026-01-08

## Summary

Implements the foundational experience (XP) system including XP tracking on players, XP values for monsters, XP awarding on combat victory, and XP display in the game UI.

## Added

### Domain Layer - Entities (Modified)

- `Player` entity enhancements:
  - `Experience` property (int, default 0) - tracks accumulated XP
  - `ExperienceToNextLevel` computed property - uses formula `(Level + 1) * 100`
  - `ExperienceProgressPercent` computed property (0-100) - progress toward next level
  - `AddExperience(int amount)` method - validates and adds XP, returns new total

- `Monster` entity enhancements:
  - `ExperienceValue` property (int) - XP awarded when defeated
  - Updated constructor with optional `experienceValue` parameter (clamped to 0 minimum)
  - Updated factory methods with XP values:
    - `CreateGoblin()` - 25 XP
    - `CreateSkeleton()` - 20 XP
    - `CreateOrc()` - 40 XP
    - `CreateGoblinShaman()` - 30 XP
    - `CreateSlime()` - 15 XP

### Domain Layer - Value Objects (Modified)

- `CombatRoundResult` enhancements:
  - `ExperienceGained` property (int) - XP earned from defeating the monster
  - Updated constructor with optional `experienceGained` parameter

### Domain Layer - Value Objects (New)

- `ExperienceGainResult` readonly record struct:
  - Properties: AmountGained, NewTotal, PreviousTotal, Source
  - `DidGainExperience` computed property
  - Factory methods: `FromMonsterDefeat()`, `None()`

### Domain Layer - Services (New)

- `ExperienceService` class:
  - `AwardExperienceFromMonster(Player, Monster)` - awards XP on defeat
  - `AwardExperience(Player, int amount, string source)` - generic XP award
  - `GetDefaultMonsterXp(string monsterName)` static helper - lookup XP values

### Domain Layer - Services (Modified)

- `CombatService` enhancements:
  - `ResolveCombatRound()` now populates `ExperienceGained` when monster is defeated

### Application Layer - DTOs (New)

- `ExperienceGainDto` record:
  - Properties: AmountGained, NewTotal, Source, CurrentLevel, ExperienceToNextLevel, ProgressPercent
  - Factory method: `FromResult(ExperienceGainResult, level, xpToNext, percent)`

### Application Layer - DTOs (Modified)

- `PlayerDto` record enhancements:
  - Added `Level` property (default 1)
  - Added `Experience` property (default 0)
  - Added `ExperienceToNextLevel` property (default 200)
  - Added `ExperienceProgressPercent` property (default 0)

### Application Layer - Services (Modified)

- `GameSessionService` enhancements:
  - Added `ExperienceService` dependency
  - `TryAttack()` now returns `(bool Success, string Message, ExperienceGainDto? ExperienceGain)`
  - Awards XP and creates DTO when monster is defeated

### Application Layer - Interfaces (Modified)

- `IGameRenderer` interface:
  - Added `RenderExperienceGainAsync(ExperienceGainDto, CancellationToken)` method

### Application Layer - DTOs (Modified)

- `DtoMapper` enhancements:
  - Updated `Player.ToDto()` to map Level, Experience, ExperienceToNextLevel, ExperienceProgressPercent

### Presentation Layer - Adapters (Modified)

- `SpectreGameRenderer` enhancements:
  - Implemented `RenderExperienceGainAsync()`:
    - Format: `★ You gained 25 XP!` (yellow star, green XP)
    - Progress line: `XP: 25/200 (12%)` (dim styling)
  - Updated `RenderStatusBar()`:
    - Added Level display: `Name (Lv 1)`
    - Added XP display: `XP: 0/200` (magenta color)
    - Now shows 5 columns: Name+Level, HP, XP, ATK, DEF

### Presentation Layer - Views (Modified)

- `GameView` enhancements:
  - `HandleAttackAsync()` now handles 3-element tuple from TryAttack
  - Renders experience gain after combat result

### Infrastructure Layer (Modified)

- `DependencyInjection` enhancements:
  - Registered `ExperienceService` as scoped service

## Tests Added

| Test File | Count |
|-----------|-------|
| `PlayerExperienceTests.cs` | 11 |
| `MonsterExperienceTests.cs` | 9 |
| `ExperienceServiceTests.cs` | 18 |
| `CombatResultExperienceTests.cs` | 5 |
| **Total New** | 43 |

## Test Results

```
Domain Tests:      398 passed (+41)
Application Tests: 117 passed
Architecture Tests:  8 passed
Total:             523 passed
```

## XP System Design

### XP Formula
```
Experience to Next Level = (Current Level + 1) * 100
Level 1 -> Level 2: 200 XP
Level 2 -> Level 3: 300 XP
Level 3 -> Level 4: 400 XP
...
```

### Progress Calculation
```
Progress Percent = (Current XP / XP to Next Level) * 100
Clamped to 0-100 range
```

### Monster XP Values
| Monster | XP Value |
|---------|----------|
| Goblin | 25 |
| Skeleton | 20 |
| Orc | 40 |
| Goblin Shaman | 30 |
| Slime | 15 |
| Default | 10 |

## UI Display

### Status Bar
```
Hero (Lv 1)  HP: 100/100  XP: 0/200  ATK: 10  DEF: 5
```

### Combat Victory
```
[Combat Result Panel]

★ You gained 25 XP!
XP: 25/200 (12%)
```

## Files Summary

### New Files (5)
| File | Purpose |
|------|---------|
| `Domain/ValueObjects/ExperienceGainResult.cs` | XP gain result value object |
| `Domain/Services/ExperienceService.cs` | XP awarding service |
| `Application/DTOs/ExperienceGainDto.cs` | XP gain display DTO |
| `Domain.UnitTests/Entities/PlayerExperienceTests.cs` | Player XP tests |
| `Domain.UnitTests/Entities/MonsterExperienceTests.cs` | Monster XP tests |
| `Domain.UnitTests/Services/ExperienceServiceTests.cs` | ExperienceService tests |
| `Domain.UnitTests/ValueObjects/CombatResultExperienceTests.cs` | Combat XP tests |

### Modified Files (11)
| File | Changes |
|------|---------|
| `Domain/Entities/Player.cs` | Experience property and methods |
| `Domain/Entities/Monster.cs` | ExperienceValue, updated factories |
| `Domain/ValueObjects/CombatResults.cs` | ExperienceGained property |
| `Domain/Services/CombatService.cs` | Return XP on defeat |
| `Application/DTOs/PlayerDto.cs` | Level/Experience fields |
| `Application/DTOs/DtoMapper.cs` | Map experience properties |
| `Application/Services/GameSessionService.cs` | ExperienceService, XP awarding |
| `Application/Interfaces/IGameRenderer.cs` | RenderExperienceGainAsync |
| `Presentation.Tui/Adapters/SpectreGameRenderer.cs` | XP rendering |
| `Presentation.Tui/Views/GameView.cs` | Handle XP in attack result |
| `Infrastructure/DependencyInjection.cs` | Register ExperienceService |

## v0.0.8a Complete

This completes the core experience system:
- XP tracking on Player entity with progress calculation
- XP values assigned to all monster types
- XP awarded automatically on monster defeat
- XP displayed in status bar and combat victory messages
- Ready for v0.0.8b: Leveling System
