## v0.17.3 - Archetype System

**Focus:** Archetype definitions, combat roles, resource pools, starting abilities, and permanent selection

**Source Specification:** [character-creation.md](../../aethelgard/design/01-core/character-creation.md)

### Overview

This version implements the Archetype system that defines a character's fundamental combat role and approach to survival. Archetype is a **permanent choice** that cannot be changed after character creation. Each archetype has distinct resource pools, starting abilities, and combat focus. The archetype also determines which specializations are available.

---

### Deliverables Summary

| Category | Items | Estimated Tests |
|----------|-------|-----------------|
| Enums | 2 | 2 |
| Value Objects | 4 | 5 |
| Entities | 1 | 3 |
| Services | 2 | 5 |
| **Total** | **9** | **~15** |

---

### v0.17.3a - Archetype Enum & Definition

#### Archetype Enum
```
Archetype
├── Warrior - Tank / Melee DPS
├── Skirmisher - Mobile DPS
├── Mystic - Caster / Control
├── Adept - Support / Utility
```

#### ArchetypeDefinition Entity
```
ArchetypeDefinition
├── ArchetypeId: Archetype enum
├── DisplayName: string
├── Tagline: string (e.g., "The Unyielding Bulwark")
├── Description: string
├── SelectionText: string (flavor for creation UI)
├── CombatRole: string
├── PrimaryResource: ResourceType enum
├── ResourceBonuses: ArchetypeResourceBonuses
├── StatBonuses: ArchetypeStatBonuses
├── StartingAbilities: List<string> (ability IDs)
├── AvailableSpecializations: List<string> (specialization IDs)
├── PlaystyleDescription: string
├── IsPermanent: bool (always true)
```

#### ResourceType Enum
```
ResourceType
├── Stamina - Used by Warrior, Skirmisher, Adept
├── AetherPool - Used by Mystic
```

**Archetype Overview:**
| Archetype | Role | Resource | HP Bonus | Key Strength |
|-----------|------|----------|----------|--------------|
| Warrior | Tank / Melee DPS | Stamina | +49 | Highest HP, defensive abilities |
| Skirmisher | Mobile DPS | Stamina | +30 | +1 Movement, evasion |
| Mystic | Caster / Control | Aether Pool | +20 | Ranged Aetheric power |
| Adept | Support / Utility | Stamina | +30 | +20% Consumable effectiveness |

**Configuration (`archetypes.json` - Definition Section):**
```json
{
  "archetypes": [
    {
      "archetypeId": "Warrior",
      "displayName": "Warrior",
      "tagline": "The Unyielding Bulwark",
      "description": "Warriors are the frontline fighters who absorb punishment and deal devastating melee damage.",
      "selectionText": "You are the shield between the innocent and the horror. When others flee, you advance. Your body is a weapon, your will is unbreakable.",
      "combatRole": "Tank / Melee DPS",
      "primaryResource": "Stamina",
      "isPermanent": true
    },
    {
      "archetypeId": "Mystic",
      "displayName": "Mystic",
      "tagline": "Wielder of Tainted Aether",
      "description": "Mystics channel the corrupted Aether to unleash devastating magical attacks from range.",
      "selectionText": "The Aether flows through you like a river of broken logic. Others fear its touch; you have learned to direct its chaos.",
      "combatRole": "Caster / Control",
      "primaryResource": "AetherPool",
      "isPermanent": true
    }
  ]
}
```

**Unit Tests (~2):**
- [x] Archetype enum has 4 values
- [x] ArchetypeDefinition loads from configuration

---

### v0.17.3b - Resource Bonuses

#### ArchetypeResourceBonuses Value Object
```
ArchetypeResourceBonuses
├── MaxHpBonus: int
├── MaxStaminaBonus: int
├── MaxAetherPoolBonus: int
├── MovementBonus: int
├── SpecialBonus: ArchetypeSpecialBonus?
```

#### ArchetypeSpecialBonus Value Object
```
ArchetypeSpecialBonus
├── BonusType: string (e.g., "ConsumableEffectiveness")
├── BonusValue: float (e.g., 0.20 for +20%)
├── Description: string
```

**Resource Bonuses by Archetype:**
| Archetype | HP Bonus | Stamina Bonus | AP Bonus | Movement | Special |
|-----------|----------|---------------|----------|----------|---------|
| Warrior | +49 | +5 | 0 | 0 | — |
| Skirmisher | +30 | +5 | 0 | +1 | — |
| Mystic | +20 | 0 | +20 | 0 | — |
| Adept | +30 | 0 | 0 | 0 | +20% Consumables |

**Configuration (`archetypes.json` - Resources Section):**
```json
{
  "archetypes": [
    {
      "archetypeId": "Warrior",
      "resourceBonuses": {
        "maxHpBonus": 49,
        "maxStaminaBonus": 5,
        "maxAetherPoolBonus": 0,
        "movementBonus": 0,
        "specialBonus": null
      }
    },
    {
      "archetypeId": "Skirmisher",
      "resourceBonuses": {
        "maxHpBonus": 30,
        "maxStaminaBonus": 5,
        "maxAetherPoolBonus": 0,
        "movementBonus": 1,
        "specialBonus": null
      }
    },
    {
      "archetypeId": "Adept",
      "resourceBonuses": {
        "maxHpBonus": 30,
        "maxStaminaBonus": 0,
        "maxAetherPoolBonus": 0,
        "movementBonus": 0,
        "specialBonus": {
          "bonusType": "ConsumableEffectiveness",
          "bonusValue": 0.20,
          "description": "+20% effectiveness from all consumable items"
        }
      }
    }
  ]
}
```

**Unit Tests (~2):**
- [ ] Warrior HP bonus is 49
- [ ] Adept has +20% consumable effectiveness

---

### v0.17.3c - Starting Abilities

#### ArchetypeAbilityGrant Value Object
```
ArchetypeAbilityGrant
├── AbilityId: string
├── AbilityName: string
├── AbilityType: AbilityType enum
├── Description: string
├── IsPassive: bool
```

#### AbilityType Enum
```
AbilityType
├── Active - Requires activation, costs resources
├── Passive - Always active, no cost
├── Stance - Toggle state, modifies behavior
```

**Starting Abilities by Archetype:**
| Archetype | Ability 1 | Ability 2 | Ability 3 |
|-----------|-----------|-----------|-----------|
| Warrior | Strike (Active) | Defensive Stance (Stance) | Warrior's Vigor (Passive) |
| Skirmisher | Quick Strike (Active) | Evasive Stance (Stance) | Fleet Footed (Passive) |
| Mystic | Aether Dart (Active) | Focus Aether (Active) | Aetheric Attunement (Passive) |
| Adept | Exploit Weakness (Active) | Scavenge (Active) | Resourceful (Passive) |

**Ability Descriptions:**
| Ability | Type | Description |
|---------|------|-------------|
| Strike | Active | Basic melee attack. Deal weapon damage. |
| Defensive Stance | Stance | +2 Defense, -1 Attack. |
| Warrior's Vigor | Passive | +10% HP regeneration while resting. |
| Quick Strike | Active | Fast melee attack. Lower damage, higher accuracy. |
| Evasive Stance | Stance | +2 Evasion, -1 Damage. |
| Fleet Footed | Passive | +1 Movement speed. |
| Aether Dart | Active | Ranged Aether attack. 1d6 + WILL damage. |
| Focus Aether | Active | Restore 10 AP. 2-round cooldown. |
| Aetheric Attunement | Passive | +10% AP regeneration. |
| Exploit Weakness | Active | Analyze enemy. Next attack gains +2 damage. |
| Scavenge | Active | Search for items after combat. +15% drop chance. |
| Resourceful | Passive | +20% effectiveness from consumables. |

**Configuration (`archetypes.json` - Abilities Section):**
```json
{
  "archetypes": [
    {
      "archetypeId": "Warrior",
      "startingAbilities": [
        {
          "abilityId": "strike",
          "abilityName": "Strike",
          "abilityType": "Active",
          "description": "Basic melee attack. Deal weapon damage.",
          "isPassive": false
        },
        {
          "abilityId": "defensive_stance",
          "abilityName": "Defensive Stance",
          "abilityType": "Stance",
          "description": "+2 Defense, -1 Attack while active.",
          "isPassive": false
        },
        {
          "abilityId": "warriors_vigor",
          "abilityName": "Warrior's Vigor",
          "abilityType": "Passive",
          "description": "+10% HP regeneration while resting.",
          "isPassive": true
        }
      ]
    },
    {
      "archetypeId": "Mystic",
      "startingAbilities": [
        {
          "abilityId": "aether_dart",
          "abilityName": "Aether Dart",
          "abilityType": "Active",
          "description": "Ranged Aether attack. 1d6 + WILL damage.",
          "isPassive": false
        },
        {
          "abilityId": "focus_aether",
          "abilityName": "Focus Aether",
          "abilityType": "Active",
          "description": "Restore 10 AP. 2-round cooldown.",
          "isPassive": false
        },
        {
          "abilityId": "aetheric_attunement",
          "abilityName": "Aetheric Attunement",
          "abilityType": "Passive",
          "description": "+10% AP regeneration.",
          "isPassive": true
        }
      ]
    }
  ]
}
```

**Unit Tests (~3):**
- [ ] Warrior starts with Strike, Defensive Stance, Warrior's Vigor
- [ ] Mystic starts with Aether Dart, Focus Aether, Aetheric Attunement
- [ ] Abilities correctly registered to character

---

### v0.17.3d - Available Specializations

#### ArchetypeSpecializationMapping Value Object
```
ArchetypeSpecializationMapping
├── ArchetypeId: Archetype
├── AvailableSpecializations: List<string>
├── RecommendedFirst: string
```

**Specializations by Archetype:**
| Archetype | Available Specializations |
|-----------|--------------------------|
| Warrior | Berserkr, Iron-Bane, Skjaldmaer, Skar-Horde, Atgeir-Wielder, Gorge-Maw |
| Skirmisher | Veiðimaðr, Myrk-gengr, Strandhögg, Hlekkr-master |
| Mystic | Seiðkona, Echo-Caller |
| Adept | Bone-Setter, Jötun-Reader, Skald, Scrap-Tinker, Einbúi |

**Configuration (`archetypes.json` - Specializations Section):**
```json
{
  "archetypes": [
    {
      "archetypeId": "Warrior",
      "availableSpecializations": [
        "berserkr", "iron_bane", "skjaldmaer", "skar_horde", "atgeir_wielder", "gorge_maw"
      ],
      "recommendedFirst": "skjaldmaer"
    },
    {
      "archetypeId": "Skirmisher",
      "availableSpecializations": [
        "veidimadr", "myrk_gengr", "strandhogg", "hlekkr_master"
      ],
      "recommendedFirst": "veidimadr"
    },
    {
      "archetypeId": "Mystic",
      "availableSpecializations": [
        "seidkona", "echo_caller"
      ],
      "recommendedFirst": "seidkona"
    },
    {
      "archetypeId": "Adept",
      "availableSpecializations": [
        "bone_setter", "jotun_reader", "skald", "scrap_tinker", "einbui"
      ],
      "recommendedFirst": "bone_setter"
    }
  ]
}
```

**Unit Tests (~2):**
- [ ] Warrior has 6 available specializations
- [ ] Mystic has 2 available specializations

---

### v0.17.3e - Archetype Provider Service

#### IArchetypeProvider Interface
```csharp
public interface IArchetypeProvider
{
    /// <summary>
    /// Gets all available archetype definitions.
    /// </summary>
    IReadOnlyList<ArchetypeDefinition> GetAllArchetypes();

    /// <summary>
    /// Gets a specific archetype by ID.
    /// </summary>
    ArchetypeDefinition? GetArchetype(Archetype archetypeId);

    /// <summary>
    /// Gets the display text for archetype selection UI.
    /// </summary>
    string GetSelectionText(Archetype archetypeId);

    /// <summary>
    /// Gets resource bonuses for an archetype.
    /// </summary>
    ArchetypeResourceBonuses GetResourceBonuses(Archetype archetypeId);

    /// <summary>
    /// Gets starting abilities for an archetype.
    /// </summary>
    IReadOnlyList<ArchetypeAbilityGrant> GetStartingAbilities(Archetype archetypeId);

    /// <summary>
    /// Gets available specializations for an archetype.
    /// </summary>
    IReadOnlyList<string> GetAvailableSpecializations(Archetype archetypeId);

    /// <summary>
    /// Gets recommended attribute build for an archetype.
    /// </summary>
    AttributeSet GetRecommendedBuild(Archetype archetypeId);
}
```

**Provider Implementation:**
```csharp
public class ArchetypeProvider : IArchetypeProvider
{
    private readonly Dictionary<Archetype, ArchetypeDefinition> _archetypes;

    public ArchetypeProvider(IConfiguration configuration)
    {
        _archetypes = LoadFromConfiguration(configuration);
    }

    public IReadOnlyList<ArchetypeDefinition> GetAllArchetypes()
        => _archetypes.Values.ToList();

    public ArchetypeDefinition? GetArchetype(Archetype archetypeId)
        => _archetypes.TryGetValue(archetypeId, out var def) ? def : null;
}
```

**Unit Tests (~2):**
- [ ] GetAllArchetypes returns 4 archetypes
- [ ] GetArchetype returns correct definition

---

### v0.17.3f - Archetype Application Service

#### IArchetypeApplicationService Interface
```csharp
public interface IArchetypeApplicationService
{
    /// <summary>
    /// Applies archetype to a character during creation.
    /// This choice is permanent.
    /// </summary>
    ArchetypeApplicationResult ApplyArchetypeToCharacter(
        PlayerCharacter character,
        Archetype archetype);

    /// <summary>
    /// Gets a preview of what the archetype will grant.
    /// </summary>
    ArchetypePreview GetArchetypePreview(
        Archetype archetype,
        AttributeSet attributes,
        Lineage lineage);

    /// <summary>
    /// Validates archetype selection.
    /// </summary>
    bool CanSelectArchetype(Archetype archetype);
}
```

#### ArchetypeApplicationResult Value Object
```
ArchetypeApplicationResult
├── Success: bool
├── AbilitiesGranted: List<string>
├── ResourcesUpdated: bool
├── FinalMaxHp: int
├── FinalMaxStamina: int
├── FinalMaxAp: int
├── Messages: List<string>
```

#### ArchetypePreview Value Object
```
ArchetypePreview
├── DisplayName: string
├── CombatRole: string
├── PreviewMaxHp: int
├── PreviewMaxStamina: int
├── PreviewMaxAp: int
├── AbilitySummary: string
├── SpecializationCount: int
```

**Application Logic:**
```
ApplyArchetypeToCharacter(character, archetype):
  1. Get archetype definition
  2. Set character.Archetype (permanent)
  3. Apply resource bonuses to derived stats
  4. Grant starting abilities:
     For each ability in definition.StartingAbilities:
       - abilityService.GrantAbility(character, ability.AbilityId)
  5. Set available specializations
  6. Return result with summaries
```

**Unit Tests (~3):**
- [ ] ApplyArchetypeToCharacter grants correct abilities
- [ ] Resource bonuses apply correctly
- [ ] Archetype cannot be changed after application

---

### Configuration Files

| File | Purpose |
|------|---------|
| `archetypes.json` | Complete archetype definitions |

**Complete Configuration Example:**
```json
{
  "archetypes": [
    {
      "archetypeId": "Warrior",
      "displayName": "Warrior",
      "tagline": "The Unyielding Bulwark",
      "description": "Warriors are the frontline fighters who absorb punishment and deal devastating melee damage.",
      "selectionText": "You are the shield between the innocent and the horror. When others flee, you advance.",
      "combatRole": "Tank / Melee DPS",
      "primaryResource": "Stamina",
      "resourceBonuses": {
        "maxHpBonus": 49,
        "maxStaminaBonus": 5,
        "maxAetherPoolBonus": 0,
        "movementBonus": 0,
        "specialBonus": null
      },
      "startingAbilities": [
        { "abilityId": "strike", "abilityName": "Strike", "abilityType": "Active", "isPassive": false },
        { "abilityId": "defensive_stance", "abilityName": "Defensive Stance", "abilityType": "Stance", "isPassive": false },
        { "abilityId": "warriors_vigor", "abilityName": "Warrior's Vigor", "abilityType": "Passive", "isPassive": true }
      ],
      "availableSpecializations": ["berserkr", "iron_bane", "skjaldmaer", "skar_horde", "atgeir_wielder", "gorge_maw"],
      "recommendedFirst": "skjaldmaer",
      "playstyleDescription": "Stand in the front, absorb damage, protect allies",
      "isPermanent": true
    },
    {
      "archetypeId": "Skirmisher",
      "displayName": "Skirmisher",
      "tagline": "Swift as Shadow",
      "description": "Skirmishers excel at mobility and precision strikes, weaving in and out of combat.",
      "selectionText": "Speed is survival. Strike fast, strike true, and be gone before they know you were there.",
      "combatRole": "Mobile DPS",
      "primaryResource": "Stamina",
      "resourceBonuses": {
        "maxHpBonus": 30,
        "maxStaminaBonus": 5,
        "maxAetherPoolBonus": 0,
        "movementBonus": 1,
        "specialBonus": null
      },
      "startingAbilities": [
        { "abilityId": "quick_strike", "abilityName": "Quick Strike", "abilityType": "Active", "isPassive": false },
        { "abilityId": "evasive_stance", "abilityName": "Evasive Stance", "abilityType": "Stance", "isPassive": false },
        { "abilityId": "fleet_footed", "abilityName": "Fleet Footed", "abilityType": "Passive", "isPassive": true }
      ],
      "availableSpecializations": ["veidimadr", "myrk_gengr", "strandhogg", "hlekkr_master"],
      "recommendedFirst": "veidimadr",
      "playstyleDescription": "High mobility, hit-and-run tactics, evasion",
      "isPermanent": true
    },
    {
      "archetypeId": "Mystic",
      "displayName": "Mystic",
      "tagline": "Wielder of Tainted Aether",
      "description": "Mystics channel the corrupted Aether to unleash devastating magical attacks.",
      "selectionText": "The Aether flows through you like a river of broken logic. You have learned to direct its chaos.",
      "combatRole": "Caster / Control",
      "primaryResource": "AetherPool",
      "resourceBonuses": {
        "maxHpBonus": 20,
        "maxStaminaBonus": 0,
        "maxAetherPoolBonus": 20,
        "movementBonus": 0,
        "specialBonus": null
      },
      "startingAbilities": [
        { "abilityId": "aether_dart", "abilityName": "Aether Dart", "abilityType": "Active", "isPassive": false },
        { "abilityId": "focus_aether", "abilityName": "Focus Aether", "abilityType": "Active", "isPassive": false },
        { "abilityId": "aetheric_attunement", "abilityName": "Aetheric Attunement", "abilityType": "Passive", "isPassive": true }
      ],
      "availableSpecializations": ["seidkona", "echo_caller"],
      "recommendedFirst": "seidkona",
      "playstyleDescription": "Ranged magical damage, crowd control, Aether management",
      "isPermanent": true
    },
    {
      "archetypeId": "Adept",
      "displayName": "Adept",
      "tagline": "Master of Mundane Arts",
      "description": "Adepts excel at support, utility, and making the most of limited resources.",
      "selectionText": "While others rely on strength or magic, you rely on knowledge, skill, and preparation.",
      "combatRole": "Support / Utility",
      "primaryResource": "Stamina",
      "resourceBonuses": {
        "maxHpBonus": 30,
        "maxStaminaBonus": 0,
        "maxAetherPoolBonus": 0,
        "movementBonus": 0,
        "specialBonus": {
          "bonusType": "ConsumableEffectiveness",
          "bonusValue": 0.20,
          "description": "+20% effectiveness from all consumable items"
        }
      },
      "startingAbilities": [
        { "abilityId": "exploit_weakness", "abilityName": "Exploit Weakness", "abilityType": "Active", "isPassive": false },
        { "abilityId": "scavenge", "abilityName": "Scavenge", "abilityType": "Active", "isPassive": false },
        { "abilityId": "resourceful", "abilityName": "Resourceful", "abilityType": "Passive", "isPassive": true }
      ],
      "availableSpecializations": ["bone_setter", "jotun_reader", "skald", "scrap_tinker", "einbui"],
      "recommendedFirst": "bone_setter",
      "playstyleDescription": "Support allies, maximize resources, utility skills",
      "isPermanent": true
    }
  ]
}
```

---

### Dependencies

**Requires:**
- v0.17.2: Attribute system (for recommended builds, derived stat calculation)
- Ability system: For granting starting abilities

**Provides to:**
- v0.17.4: Determines available specializations
- v0.17.5: Archetype step in creation workflow
- Combat system: Combat role and resource pools

---

### Acceptance Criteria

- [ ] Archetype enum has 4 values
- [ ] Each archetype has distinct resource bonuses
- [ ] Warrior has +49 HP bonus
- [ ] Skirmisher has +1 Movement bonus
- [ ] Mystic has +20 AP bonus
- [ ] Adept has +20% consumable effectiveness
- [ ] Each archetype grants 3 starting abilities
- [ ] Warrior starts with Strike, Defensive Stance, Warrior's Vigor
- [ ] Mystic starts with Aether Dart, Focus Aether, Aetheric Attunement
- [ ] Archetype determines available specializations
- [ ] Warrior has 6 available specializations
- [ ] Mystic has 2 available specializations
- [ ] Archetype choice is permanent (cannot be changed)
- [ ] Resource bonuses apply to derived stats
- [ ] ~15 unit tests pass
