# Changelog: v0.18.0a - Stress Enums & State

**Release Date:** 2026-01-31
**Phase:** Psychic Stress System (1/6)
**Status:** Complete

---

## Overview

Implements the foundational domain types for the Psychic Stress system — the enums and value objects that track a character's psychological state and determine mechanical penalties. This is the first phase of v0.18.0 (Psychic Stress System), establishing the **Stress State Pattern** that will be reused in v0.18.1 (Corruption) and v0.18.4 (Specialization Resources).

Three enums define stress classification (`StressThreshold`), stress origins (`StressSource`), and recovery mechanisms (`RestType`). Three corresponding extension classes provide calculations, display formatting, and resistance queries. One value object (`StressState`) encapsulates the stress value with computed penalties and trigger conditions.

The existing `StressSource` enum from v0.15.1e was replaced with broader gameplay categories aligned to the Psychic Stress system design. All dependent files were updated to use the new enum values.

---

## Added

### Domain Layer — Enums

- **`StressThreshold`** (`Domain/Enums/StressThreshold.cs`)
    - 6-tier enum: Calm (0-19), Uneasy (20-39), Anxious (40-59), Panicked (60-79), Breaking (80-99), Trauma (100)
    - Explicit integer values (0-5) matching defense penalty magnitude
    - Comprehensive XML documentation per value with stress ranges, penalties, and effects

- **`RestType`** (`Domain/Enums/RestType.cs`)
    - 4-value enum: Short=0, Long=1, Sanctuary=2, Milestone=3
    - Each value documents its recovery formula in XML remarks
    - Explicit integer assignments for stable serialization

### Domain Layer — Extension Classes

- **`StressThresholdExtensions`** (`Domain/Extensions/StressThresholdExtensions.cs`)
    - `GetMinStress()` / `GetMaxStress()` — stress range boundaries per tier
    - `GetDefensePenalty()` — returns `(int)threshold` (ordinal value = penalty)
    - `FromStressValue(int)` — static method resolving threshold from stress 0-100
    - `ToDisplayString()` — formatted string with name and range (e.g., "Anxious (40-59)")

- **`StressSourceExtensions`** (`Domain/Extensions/StressSourceExtensions.cs`)
    - `GetDescription()` — human-readable description per source category
    - `TypicallyResistable()` — false for Narrative and Corruption (unavoidable)

- **`RestTypeExtensions`** (`Domain/Extensions/RestTypeExtensions.cs`)
    - `CalculateRecovery(int willAttribute)` — Short: WILL×2, Long: WILL×5, Sanctuary: int.MaxValue, Milestone: 25
    - `GetFormulaDescription()` — display string with name and formula
    - `IsFullRecovery()` — true only for Sanctuary

### Domain Layer — Value Objects

- **`StressState`** (`Domain/ValueObjects/StressState.cs`)
    - `readonly record struct` with private constructor enforcing factory pattern
    - Constants: `MinStress = 0`, `MaxStress = 100`
    - Stored property: `CurrentStress` (clamped 0-100)
    - Computed in constructor: `Threshold`, `DefensePenalty`, `HasSkillDisadvantage`, `RequiresTraumaCheck`
    - Arrow-expression properties: `IsCalm`, `IsBreaking`, `StressPercentage`
    - Factory: `Create(int)`, static `Calm`
    - Mutation: `WithStress(int)`, `WithStressAdded(int)`, `WithStressReduced(int)`
    - `ToString()`: `"Stress: {CurrentStress}/{MaxStress} [{Threshold}] (Def: -{DefensePenalty})"`

### Unit Tests

- **`StressThresholdTests`** (`Enums/StressThresholdTests.cs`) — 22 test methods
    - `FromStressValue_ReturnsCorrectThreshold` — 11 boundary cases (0,19,20,39,40,59,60,79,80,99,100)
    - `FromStressValue_ThrowsForNegativeStress`, `FromStressValue_ThrowsForStressAbove100`
    - `GetMinStress_ReturnsCorrectValues` — 6 parameterized cases
    - `GetMaxStress_ReturnsCorrectValues` — 6 parameterized cases
    - `GetDefensePenalty_MatchesThresholdOrdinal` — 6 parameterized cases
    - `ToDisplayString_FormatsCorrectly` — 3 cases

- **`StressStateTests`** (`ValueObjects/StressStateTests.cs`) — 22 test methods
    - Factory methods: `Create_StoresValidValue`, `Create_ClampsNegativeToZero`, `Create_ClampsAbove100`, `Calm_ReturnsZeroStress`
    - Computed properties: `DefensePenalty_CalculatedCorrectly` (7 cases), `HasSkillDisadvantage_SetCorrectly` (4 cases), `RequiresTraumaCheck_TrueOnlyAt100OrAbove` (3 cases)
    - Arrow properties: `IsCalm_TrueOnlyForCalmThreshold` (4 cases), `IsBreaking_TrueForBreakingAndTrauma` (4 cases), `StressPercentage_CalculatesCorrectly`
    - Mutation: `WithStress_CreatesNewInstance`, `WithStressAdded_IncreasesStress`, `WithStressAdded_ClampsToMax`, `WithStressAdded_ThrowsForNegativeAmount`, `WithStressReduced_DecreasesStress`, `WithStressReduced_ClampsToMin`, `WithStressReduced_ThrowsForNegativeAmount`
    - Display: `ToString_FormatsCorrectly`, `ToString_ZeroStress_FormatsCorrectly`

- **`RestTypeExtensionsTests`** (`Extensions/RestTypeExtensionsTests.cs`) — 12 test methods
    - `CalculateRecovery` — Short (3 WILL values), Long (3 WILL values), Sanctuary, Milestone, Milestone ignores WILL
    - `CalculateRecovery_ThrowsForNegativeWill`
    - `GetFormulaDescription_ReturnsExpected` — 4 rest types
    - `IsFullRecovery_TrueOnlyForSanctuary` — 4 rest types

- **`StressSourceExtensionsTests`** (`Extensions/StressSourceExtensionsTests.cs`) — 10 test methods
    - `GetDescription_ReturnsNonEmptyForAllSources` — 6 parameterized cases
    - `GetDescription_ReturnsExpectedValues` — spot checks
    - `TypicallyResistable_ReturnsExpected` — 6 parameterized cases
    - `TypicallyResistable_NarrativeIsNotResistable`, `TypicallyResistable_CorruptionIsNotResistable`

### Glossary

- **`config/glossary.json`** — Added 4 glossary entries (sortOrder 75-78)
    - `stress-threshold`: Enum defining six stress tiers with defense penalties
    - `stress-source`: Enum categorizing six stress origin categories
    - `rest-type`: Enum defining four rest types with recovery formulas
    - `stress-state`: Value object tracking stress with computed penalties

---

## Changed

### Domain Layer — Enums

- **`StressSource`** (`Domain/Enums/StressSource.cs`)
    - **REPLACED** v0.15.1e skill-check-specific values with v0.18.0a gameplay categories
    - Old values: None=0, Corruption=1, Fumble=2, CorruptedObject=3, ExtendedExposure=4
    - New values: Combat, Exploration, Narrative, Heretical, Environmental, Corruption
    - No explicit integer assignments (implicit 0-5)
    - Added comprehensive XML documentation per value

### Domain Layer — Value Objects

- **`SkillStressResult`** (`Domain/ValueObjects/SkillStressResult.cs`)
    - `None()` factory: `StressSource.None` → `StressSource.Exploration`
    - `FromCorruption()` fallback: `StressSource.None` → `StressSource.Exploration`
    - `FromFumble()`: `StressSource.Fumble` → `StressSource.Combat`

### Application Layer — Services

- **`TraumaIntegrationService`** (`Application/Services/TraumaIntegrationService.cs`)
    - `CalculateObjectInteractionStress`: Fumble→Combat, CorruptedObject→Exploration, None→Exploration
    - `CalculateExtendedCheckStress`: Fumble→Combat, ExtendedExposure→Environmental, None→Exploration

### Test Projects

- **`SkillStressResultTests`** (`ValueObjects/SkillStressResultTests.cs`)
    - Updated enum references: `StressSource.None`→`StressSource.Exploration`, `StressSource.Fumble`→`StressSource.Combat`

- **`TraumaIntegrationServiceTests`** (`Services/TraumaIntegrationServiceTests.cs`)
    - Updated enum references: `StressSource.None`→`StressSource.Exploration`, `StressSource.Fumble`→`StressSource.Combat`, `StressSource.CorruptedObject`→`StressSource.Exploration`

### Documentation

- **`docs/design/v0.18.x/v0.18.0-scope-breakdown.md`** — Checked off v0.18.0a acceptance criteria
- **`docs/design/v0.18.x/v0.18.0a-design-specification.md`** — Checked off deliverable and acceptance criteria items

---

## Design Decisions

### StressSource Replacement Strategy

The existing `StressSource` enum (v0.15.1e) had skill-check-specific values (None, Fumble, CorruptedObject, ExtendedExposure) that didn't align with the v0.18.0a Psychic Stress system's broader gameplay categories. Rather than maintaining two separate enums or adding backward-compatibility shims, the enum was replaced entirely with a mapping:

| Old Value (v0.15.1e) | New Value (v0.18.0a) | Rationale |
|---|---|---|
| None | Exploration | Default benign category |
| Corruption | Corruption | Direct match |
| Fumble | Combat | Fumbles occur during combat |
| CorruptedObject | Exploration | Object interaction during exploration |
| ExtendedExposure | Environmental | Prolonged exposure is environmental |

All 4 dependent files were updated: SkillStressResult, TraumaIntegrationService, and both test files.

### Extension File Location

The design specification places extensions in the `Enums/` folder. The codebase convention (35+ existing extension files) uses the `Extensions/` folder with `RuneAndRust.Domain.Extensions` namespace. Codebase convention was followed.

### DefensePenalty Calculation

The design specification describes `floor(Stress/20)` for the defense penalty formula. The implementation uses `Threshold.GetDefensePenalty()` which returns `(int)threshold` (the ordinal value). These produce identical results since the threshold enum values (0-5) exactly correspond to `floor(Stress/20)` for each range.

### WithStressAdded Validation

The design specification's `WithStressAdded` accepts any integer (including negative). The implementation adds `ArgumentOutOfRangeException.ThrowIfNegative(amount)` to enforce semantic clarity — use `WithStressAdded` to increase stress and `WithStressReduced` to decrease it. This prevents accidental double-negation bugs.

### StressPercentage Type

The design specification defines `StressPercentage` as `int` (returning `CurrentStress` directly, since stress is already 0-100). The implementation returns `double` (0.0-1.0) for progress bar rendering compatibility. This is a minor deviation that provides better utility for TUI consumption.

---

## Dependencies

### Prerequisites

| Type | Phase | Usage |
| --- | --- | --- |
| `StressSource` (existing) | v0.15.1e | Replaced with new categories |
| `SkillStressResult` | v0.15.1e | Updated enum references |
| `TraumaIntegrationService` | v0.15.1e | Updated enum references |

### Provides to Future Phases

| Type | Phase | Usage |
| --- | --- | --- |
| `StressThreshold` | v0.18.0b | Used by StressCheckResult, StressApplicationResult |
| `StressSource` | v0.18.0b | Categorizes stress application events |
| `RestType` | v0.18.0b | Used by StressRecoveryResult |
| `StressState` | v0.18.0b-d | Before/after state in result objects |
| Extension methods | v0.18.0d | Recovery calculations in StressService |

---

## Logging Strategy

No runtime logging in v0.18.0a — all types are enums, extension methods, and a value object. Logging is deferred to v0.18.0d (StressService implementation) which will use the logging templates defined in the design specification.

---

## Files Created

| Path | Description |
|------|-------------|
| `src/Core/RuneAndRust.Domain/Enums/StressThreshold.cs` | Stress threshold enum (6 tiers) |
| `src/Core/RuneAndRust.Domain/Enums/RestType.cs` | Rest type enum (4 types) |
| `src/Core/RuneAndRust.Domain/Extensions/StressThresholdExtensions.cs` | Threshold range, penalty, resolution, display |
| `src/Core/RuneAndRust.Domain/Extensions/StressSourceExtensions.cs` | Description and resistance methods |
| `src/Core/RuneAndRust.Domain/Extensions/RestTypeExtensions.cs` | Recovery calculation, formula, full recovery |
| `src/Core/RuneAndRust.Domain/ValueObjects/StressState.cs` | Stress state value object |
| `tests/RuneAndRust.Domain.UnitTests/Enums/StressThresholdTests.cs` | Threshold tests (22 tests) |
| `tests/RuneAndRust.Domain.UnitTests/ValueObjects/StressStateTests.cs` | StressState tests (22 tests) |
| `tests/RuneAndRust.Domain.UnitTests/Extensions/RestTypeExtensionsTests.cs` | RestType extension tests (12 tests) |
| `tests/RuneAndRust.Domain.UnitTests/Extensions/StressSourceExtensionsTests.cs` | StressSource extension tests (10 tests) |
| `changelogs/v0.18.0a-changelog.md` | This changelog |

## Files Modified

| Path | Description |
|------|-------------|
| `src/Core/RuneAndRust.Domain/Enums/StressSource.cs` | Replaced with v0.18.0a categories |
| `src/Core/RuneAndRust.Domain/ValueObjects/SkillStressResult.cs` | Updated 3 enum references |
| `src/Core/RuneAndRust.Application/Services/TraumaIntegrationService.cs` | Updated 6 enum references |
| `tests/RuneAndRust.Domain.UnitTests/ValueObjects/SkillStressResultTests.cs` | Updated 2 enum references |
| `tests/RuneAndRust.Application.UnitTests/Services/TraumaIntegrationServiceTests.cs` | Updated 3 enum references |
| `config/glossary.json` | Added 4 glossary entries (sortOrder 75-78) |
| `docs/design/v0.18.x/v0.18.0-scope-breakdown.md` | Checked off v0.18.0a acceptance criteria |
| `docs/design/v0.18.x/v0.18.0a-design-specification.md` | Checked off deliverable checklist |

---

## Notes

- Total unit tests for v0.18.0a: 66 test methods across 4 test files (far exceeding the ~4 estimate)
- All 103 new tests pass; all 8 existing affected tests pass
- Build succeeds with 0 errors, 0 warnings
- All new files follow established codebase patterns: `═══════` section separators for enums/VOs, copyright `------` headers for extensions, file-scoped namespaces, comprehensive XML documentation
- The `Extensions/` folder convention was followed over the design spec's `Enums/` folder placement
- StressSource replacement touched 5 files beyond the enum itself (2 source + 2 test + 1 service)
