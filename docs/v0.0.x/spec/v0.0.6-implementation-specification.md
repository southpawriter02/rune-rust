# v0.0.6 Implementation Specification: Enhanced Combat

**Version:** 0.0.6
**Implementation Date:** 2026-01-08
**Design Specification:** [v0.0.6-scope-breakdown.md](../v0.0.6-scope-breakdown.md)
**Changelogs:** [v0.0.6a](../../changelogs/v0.0.6a-changelog.md), [v0.0.6b](../../changelogs/v0.0.6b-changelog.md), [v0.0.6c](../../changelogs/v0.0.6c-changelog.md), [v0.0.6d](../../changelogs/v0.0.6d-changelog.md)

---

## 1. Overview

### 1.1 Summary

v0.0.6 enhances the combat system with multi-monster encounters, initiative-based turn order, monster AI behaviors, flee mechanics, and a comprehensive status effect framework with elemental interactions.

### 1.2 Key Features

- **Multi-Monster Combat**: Fight multiple enemies simultaneously
- **Initiative System**: Dice-based turn order determination
- **Monster AI**: 5 behavior types (Aggressive, Defensive, Cowardly, Support, Chaotic)
- **Flee Mechanics**: Skill check to escape combat
- **Status Effects**: DoT, HoT, buffs, debuffs with durations
- **Elemental Interactions**: Wet + Lightning, Fire + Ice combinations

### 1.3 Deviations from Design

None significant; implementation matches design specification.

---

## 2. Architecture

### 2.1 Layer Interactions

```
┌─────────────────────────────────────────────────────────────┐
│                    Presentation Layer                        │
│  GameView → combat commands, flee                           │
│  SpectreGameRenderer → RenderCombatRoundAsync               │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                    Application Layer                         │
│  GameSessionService, EffectInteractionService               │
│  CleanseService                                             │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                      Domain Layer                            │
│  CombatEncounter, InitiativeRoll, MonsterAI                 │
│  StatusEffect, StatusEffectDefinition                       │
│  CombatService, StatusEffectService                         │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                   Infrastructure Layer                       │
│  effect-interactions.json, cleanse-items.json               │
│  status-effects.json                                        │
└─────────────────────────────────────────────────────────────┘
```

### 2.2 Key Patterns

- **State Pattern**: Combat encounter states (Active, Victory, Defeat, Fled)
- **Strategy Pattern**: AI behaviors as interchangeable strategies
- **Chain Pattern**: Effect interactions triggering follow-up effects
- **Composite Pattern**: Multiple status effects on single target

### 2.3 Dependencies

- v0.0.5 Dice System: Initiative rolls, flee checks
- v0.0.4 Ability System: Ability effects can apply status effects

---

## 3. Data Model

### 3.1 Combat Entities

| Entity | Key Properties |
|--------|----------------|
| `CombatEncounter` | Combatants, InitiativeOrder, CurrentTurn, State |
| `InitiativeRoll` | Entity, Roll, Modifier, Total |
| `StatusEffect` | Definition, Source, Target, RemainingDuration, Stacks |

### 3.2 Definitions

| Definition | Key Properties |
|------------|----------------|
| `StatusEffectDefinition` | Id, Name, EffectType, PerTickValue, Duration, Stackable |
| `EffectInteraction` | TriggerEffectId, RequiredEffectId, ResultEffect, BonusDamage |
| `CleanseItem` | Id, Name, CleanseType, AffectedEffectIds |

### 3.3 Enums

| Enum | Values |
|------|--------|
| `AIBehavior` | Aggressive, Defensive, Cowardly, Support, Chaotic |
| `StatusEffectType` | Buff, Debuff, DamageOverTime, HealOverTime, Disable |
| `EffectTrigger` | OnHit, OnDamage, OnTurnStart, Manual |
| `CleanseType` | AllNegative, Physical, Magical, Elemental, Specific |

---

## 4. Services

### 4.1 Combat Services

```csharp
// CombatService (Domain)
StartCombat(player, monsters) → CombatEncounter
RollInitiative(combatants) → InitiativeOrder
ExecutePlayerTurn(action) → CombatTurnResult
AdvanceTurn() → ICombatant
AttemptFlee(player) → FleeResult
```

### 4.2 Monster AI

```csharp
// MonsterAIService (Application)
SelectAction(monster, combatContext) → MonsterAction
ExecuteMonsterTurn(monster, combat) → MonsterTurnResult
GetBehaviorModifier(behavior, situation) → float
```

### 4.3 Status Effects

```csharp
// StatusEffectService (Domain)
ApplyEffect(target, effect) → ApplyResult
ProcessTurnStart(entity) → TurnStartEffectResult
ProcessTurnEnd(entity) → IReadOnlyList<EffectResult>
RemoveEffect(target, effectId) → bool
CleanseEffects(target, cleanseType) → CleanseResult
```

### 4.4 Effect Interactions

```csharp
// EffectInteractionService (Application)
CheckInteractions(target, newEffect) → EffectInteractionResult
GetPossibleInteractions(effectId) → IReadOnlyList<EffectInteraction>
```

---

## 5. Configuration

### 5.1 JSON Files

| File | Content |
|------|---------|
| `status-effects.json` | Effect definitions |
| `effect-interactions.json` | 5 elemental interactions |
| `cleanse-items.json` | 6 cleanse item definitions |

### 5.2 AI Behaviors

| Behavior | HP > 50% | HP < 50% | HP < 30% |
|----------|----------|----------|----------|
| Aggressive | Attack (strongest) | Attack | Attack |
| Defensive | Attack | Defend/Heal | Defend/Heal |
| Cowardly | Attack (weakest) | Attack | Flee |
| Support | Heal allies | Heal allies | Heal self |
| Chaotic | Random | Random | Random |

### 5.3 Elemental Interactions

| Combination | Result |
|-------------|--------|
| Wet + Lightning | +50% damage, apply Stunned |
| Wet + Ice | Apply Frozen, remove Wet |
| Burning + Wet | Remove Burning |
| Chilled + Ice | Apply Frozen, remove Chilled |
| On Fire + Wet | Remove On Fire |

---

## 6. Commands & Rendering

### 6.1 Commands

| Command | Action |
|---------|--------|
| `attack [target]` | Attack specific monster |
| `flee` | Attempt to escape combat |
| `target [monster]` | Change attack target |

### 6.2 Combat Display

```
╭─────────────────────────────────────╮
│            ⚔️ COMBAT ⚔️              │
├─────────────────────────────────────┤
│  Initiative Order:                  │
│  1. [YOU] ←                         │
│  2. Goblin Warrior                  │
│  3. Goblin Archer                   │
├─────────────────────────────────────┤
│  Goblin Warrior   [████░] 25 HP     │
│    Status: Poisoned (2 turns)       │
│  Goblin Archer    [██░░░] 12 HP     │
├─────────────────────────────────────┤
│  [A]ttack  [U]se Ability  [F]lee    │
╰─────────────────────────────────────╯
```

---

## 7. Use Cases

### 7.1 Primary Use Cases

- [UC-005: Engage in Combat](../../use-cases/player/UC-005-engage-in-combat.md)
- [UC-013: Flee Combat](../../use-cases/player/UC-013-flee-combat.md)
- [UC-104: Monster Turn](../../use-cases/system/UC-104-monster-turn.md)
- [UC-105: Apply Status Effects](../../use-cases/system/UC-105-apply-status-effects.md)
- [UC-108: Roll Initiative](../../use-cases/system/UC-108-roll-initiative.md)

### 7.2 Edge Cases

- All dice tied during initiative (re-roll)
- Flee attempt with no exits
- Status effect kills target (stops processing)
- Effect interaction chain limits

---

## 8. Testing

### 8.1 Test Coverage

| Phase | Tests | Areas |
|-------|-------|-------|
| v0.0.6a | ~25 | Multi-monster, CombatEncounter |
| v0.0.6b | ~30 | Monster AI, Flee mechanics |
| v0.0.6c | ~25 | Status effects, durations |
| v0.0.6d | 8 | Effect interactions, cleanse |
| **Total** | **387** | +103 from v0.0.5 |

### 8.2 Key Test Scenarios

- Initiative ordering with ties
- AI behavior selection by HP threshold
- Flee DC calculation with multiple monsters
- Status effect stacking and duration
- Elemental interaction triggers
- Cleanse targeting correct effects

---

## 9. Known Limitations

### 9.1 Current Limitations

- No formation or positioning
- Limited monster ability variety
- No summoning or reinforcements
- Status effects don't persist between combats

### 9.2 Future Improvements

- v0.0.9: Monster variety with unique abilities
- Position-based combat (future version)
- Persistent debuffs between encounters

---

## 10. Related Documentation

- **ADRs**: [ADR-002](../../architecture/ADR-002-json-configuration.md) (effect configuration)
- **Use Cases**: UC-005, UC-013, UC-104, UC-105, UC-108
- **Dependencies**: v0.0.5 (dice), v0.0.4 (abilities)
