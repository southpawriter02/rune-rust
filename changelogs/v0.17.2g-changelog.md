# Changelog: v0.17.2g - Derived Stat Calculator Service

**Release Date:** 2026-01-30
**Phase:** Attribute System (7/7)
**Status:** Complete

---

## Overview

Implements the Derived Stat Calculator Service for the v0.17.2 Attribute System: the `IDerivedStatCalculator` interface and `DerivedStatCalculator` implementation. This service is the centralized computation engine for all derived character statistics (Max HP, Max Stamina, Max Aether Pool, Initiative, Soak, Movement Speed, Carrying Capacity) during character creation.

The calculator uses formula-driven architecture where each stat is computed from a base value, attribute scaling multipliers, archetype bonuses, lineage bonuses, and optional lineage multipliers. It supports three access patterns: full calculation of all 7 stats, single stat lookup by name, and real-time preview from an `AttributeAllocationState` during allocation.

This phase completes the entire v0.17.2 Attribute System (phases a through g).

---

## Added

### Application Layer

#### Interfaces

- **`IDerivedStatCalculator`** (`Interfaces/IDerivedStatCalculator.cs`)
    - Interface with 3 methods providing derived stat calculation
    - `CalculateDerivedStats(attributes, archetypeId, lineageId)`: Calculates all 7 derived stats from attribute values
    - `CalculateStat(statName, attributes, archetypeId, lineageId)`: Calculates a single stat by name (case-insensitive)
    - `GetPreview(state, archetypeId, lineageId)`: Generates preview from `AttributeAllocationState` for real-time UI feedback
    - Comprehensive XML documentation with `<summary>`, `<remarks>`, `<param>`, `<returns>`, `<exception>`, `<example>` tags
    - `<seealso>` cross-references to `DerivedStats`, `DerivedStatFormula`, `AttributeAllocationState`, `CoreAttribute`

#### Services

- **`DerivedStatCalculator`** (`Services/DerivedStatCalculator.cs`)
    - Implements `IDerivedStatCalculator` with formula-driven calculation
    - Constructor: `(IReadOnlyDictionary<string, DerivedStatFormula> formulas, ILogger<DerivedStatCalculator> logger)` with null validation
    - Static factory: `CreateWithDefaultFormulas(logger)` creates pre-configured calculator with all 7 standard formulas
    - `CalculateDerivedStats`: Iterates all 7 formulas, assembles `DerivedStats.Create()` result
    - `CalculateStat`: Normalizes stat name to lowercase, looks up formula, returns 0 for unknown stats
    - `GetPreview`: Extracts attributes from `AttributeAllocationState`, delegates to `CalculateDerivedStats`
    - Private helper: `CalculateStatInternal` — formula lookup, delegation to `formula.Calculate()`, logging
    - Private helper: `ExtractAttributesFromState` — maps state properties to `Dictionary<CoreAttribute, int>`
    - Private helper: `CreateDefaultFormulas` — builds 7 formula definitions with case-insensitive key lookup
    - File header with `═══` borders, section separators for DEPENDENCIES, CONSTRUCTOR, STATIC FACTORY METHODS, PUBLIC METHODS, PRIVATE METHODS
    - Exhaustive structured logging at all levels

### Unit Tests

- **`DerivedStatCalculatorTests`** (`Services/DerivedStatCalculatorTests.cs`) — 10 tests
    - `CalculateDerivedStats_WarriorBuild_ReturnsCorrectHp`: Warrior HP = 139 ((4×10) + 50 + 49)
    - `CalculateDerivedStats_WarriorBuild_ReturnsCorrectStamina`: Warrior Stamina = 60 ((3×5) + (4×5) + 20 + 5)
    - `CalculateDerivedStats_MysticBuild_ReturnsCorrectAetherPool`: Mystic AP = 80 ((4×10) + (4×5) + 20)
    - `CalculateDerivedStats_WithClanBornLineage_AddsHpBonus`: Clan-Born HP = 144 (139 + 5)
    - `CalculateDerivedStats_RuneMarkedMystic_AppliesMultiplier`: Rune-Marked AP = 93 (85 × 1.10 → 93)
    - `CalculateDerivedStats_IronBlooded_AddsSoakBonus`: Iron-Blooded Soak = 4 ((4×0.5) + 2)
    - `CalculateDerivedStats_VargrKin_AddsMovementSpeed`: Vargr-Kin Movement = 6 (5 + 1)
    - `GetPreview_FromAllocationState_CalculatesCorrectly`: Full preview from Warrior state matches all 7 expected values
    - `CalculateStat_SingleStat_ReturnsCorrectValue`: Single stat lookup returns 139 for MaxHp
    - `CalculateStat_UnknownStat_ReturnsZero`: Unknown stat name returns 0

### Glossary

- **`config/glossary.json`** — Added derived stat calculator glossary entry
    - `derived-stat-calculator`: Application service for computing derived stats (sortOrder: 20)

---

## Changed

### Infrastructure Layer

- **`DependencyInjection.cs`** (`DependencyInjection.cs`)
    - Added `IDerivedStatCalculator` scoped registration in `AddApplicationServices()` method
    - Uses factory lambda with `DerivedStatCalculator.CreateWithDefaultFormulas(logger)`
    - Version comment: `// Derived stat calculator (v0.17.2g)`

---

## Design Decisions

### Case-Insensitive Formula Dictionary

The design specification's `CalculateStat` method normalizes the stat name to lowercase via `ToLowerInvariant()`, while the default formula keys use camelCase (e.g., "maxHp"). To ensure reliable lookup regardless of input casing, the formula dictionary was created with `StringComparer.OrdinalIgnoreCase`. This makes both `"MaxHp"`, `"maxhp"`, and `"maxHp"` all resolve correctly.

### CreateWithDefaultFormulas Factory Pattern

The calculator accepts formulas via constructor injection for testability and future extensibility (e.g., loading formulas from JSON configuration). The `CreateWithDefaultFormulas` static factory provides a convenient default that embeds the standard game balance values, used by both the DI registration and unit tests.

### Scoped DI Registration

The calculator was registered as scoped (not singleton) to match the pattern established by other application services in `AddApplicationServices()`. While the calculator is stateless and could be singleton, consistency with the existing registration pattern was prioritized.

### Formula Delegation to DerivedStatFormula.Calculate()

The calculator delegates individual stat calculation to `DerivedStatFormula.Calculate()` (v0.17.2d), which handles the full computation pipeline (base + scaling + archetype bonus + lineage bonus + multiplier + truncation). This avoids duplicating calculation logic and ensures consistency between direct formula usage and calculator-mediated calculation.

### ArgumentNullException for Attributes Parameter

Both `CalculateDerivedStats` and `CalculateStat` validate the attributes dictionary with `ArgumentNullException.ThrowIfNull`. The stat name parameter in `CalculateStat` is also validated with `ArgumentException.ThrowIfNullOrWhiteSpace` to fail fast on invalid input.

---

## Dependencies

### Prerequisites

- v0.17.2a (CoreAttribute Enum) — Provides `CoreAttribute` for attribute dictionary keys
- v0.17.2b (Allocation Mode System) — Provides `AttributeAllocationState` for preview support
- v0.17.2d (Derived Stat Calculation) — Provides `DerivedStats` return type and `DerivedStatFormula` calculation engine

### Provides to Future Phases

| Type | Phase | Usage |
| ---- | ----- | ----- |
| `IDerivedStatCalculator` | v0.17.5 | Character creation UI live stat preview during allocation |
| `IDerivedStatCalculator` | v0.18.x | Combat system stat access for attribute-based calculations |

---

## Logging Strategy

| Level | When |
|-------|------|
| Debug | Method entry with parameters, stat name normalization, formula lookup details, individual stat calculation results, attribute extraction from state, delegation details |
| Information | Calculator initialization with formula count and stat names, full derived stats calculation complete with summary |
| Warning | Unknown stat name requested (lists available stat names) |

---

## Files Created

| Path | Description |
|------|-------------|
| `src/Core/RuneAndRust.Application/Interfaces/IDerivedStatCalculator.cs` | Derived stat calculator interface |
| `src/Core/RuneAndRust.Application/Services/DerivedStatCalculator.cs` | Derived stat calculator implementation |
| `tests/RuneAndRust.Application.UnitTests/Services/DerivedStatCalculatorTests.cs` | Unit tests |

## Files Modified

| Path | Description |
|------|-------------|
| `src/Infrastructure/RuneAndRust.Infrastructure/DependencyInjection.cs` | Added IDerivedStatCalculator DI registration |
| `config/glossary.json` | Added derived-stat-calculator glossary term |
| `docs/design/v0.17.x/v0.17.2-scope-breakdown.md` | Checked off v0.17.2g deliverables |
| `docs/design/v0.17.x/v0.17.x-overview.md` | Updated v0.17.2 deliverable checkboxes |

---

## Version Completion

This phase completes the **v0.17.2 Attribute System**. All 7 sub-phases are now implemented:

| Phase | Name | Status |
| ----- | ---- | ------ |
| v0.17.2a | Core Attribute Enum | Complete |
| v0.17.2b | Allocation Mode System | Complete |
| v0.17.2c | Point-Buy Cost System | Complete |
| v0.17.2d | Derived Stat Calculation | Complete |
| v0.17.2e | Attribute Provider Service | Complete |
| v0.17.2f | Attribute Allocation Service | Complete |
| v0.17.2g | Derived Stat Calculator Service | Complete |

---

## Notes

- The Rune-Marked Aether-Tainted trait applies +5 flat bonus THEN ×1.10 multiplier (order matters): 85 × 1.10 = 93.5 → 93 (truncated)
- Initiative uses float scaling: Wits × 0.5 → integer truncation via `(int)` cast
- Movement Speed has no attribute scaling — flat base of 5 with optional lineage bonus
- Carrying Capacity has no archetype or lineage bonuses — purely Might-scaled
- The GetPreview method produces identical results to CalculateDerivedStats with the same attribute values
- Total unit tests across all v0.17.2 phases: ~56 tests
