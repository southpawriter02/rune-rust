# Changelog: v0.17.5b - Creation ViewModel

**Release Date:** 2026-01-31
**Phase:** Character Creation Workflow (2/7)
**Status:** Complete

---

## Overview

Implements the Creation ViewModel phase: 4 value objects (`DerivedStatsPreview`, `AbilitiesPreview`, `EquipmentPreview`/`EquipmentPreviewItem`, `CharacterCreationViewModel`), 1 interface (`IViewModelBuilder`), 1 application service (`ViewModelBuilder`), and comprehensive unit tests. The ViewModel provides an immutable, read-only presentation layer that cleanly separates state management (`CharacterCreationState`) from TUI rendering.

The `ViewModelBuilder` coordinates with 5 providers (`ILineageProvider`, `IBackgroundProvider`, `IArchetypeProvider`, `ISpecializationProvider`, `IDerivedStatCalculator`) to transform raw creation state into display-ready data: step information, navigation state, selection display names, preview data (derived stats, abilities, equipment), and validation status. A fresh ViewModel is constructed on every `Build()` call with no caching.

---

## Added

### Domain Layer

#### Value Objects

- **`DerivedStatsPreview`** (`ValueObjects/DerivedStatsPreview.cs`)
    - `readonly record struct` with 8 properties: `MaxHp`, `MaxStamina`, `MaxAp`, `HpFromLineage`, `HpFromArchetype`, `ApFromLineage`, `ApFromArchetype`, `StaminaFromArchetype`
    - Computed properties: `HasValues` (any resource > 0), `TotalResourcePool` (sum of all three)
    - Static `Empty` property (all zeros)
    - Helper methods: `GetSummary()` → `"HP: 104 | Stamina: 55 | AP: 30"`, `ToString()` for debugging
    - `MaxAp` maps to `DerivedStats.MaxAetherPool` in the domain model — "AP" is a presentation-layer abbreviation

- **`AbilitiesPreview`** (`ValueObjects/AbilitiesPreview.cs`)
    - `readonly record struct` with 2 list properties: `ArchetypeAbilities` (`IReadOnlyList<string>`), `SpecializationAbilities` (`IReadOnlyList<string>`)
    - Computed properties: `TotalCount`, `HasAbilities`, `HasSpecializationAbilities`
    - Static `Empty` property (both lists empty)
    - Helper methods: `GetSummary()` → `"Power Strike, Defensive Stance + Rage Strike, Blood Fury"`, `ToString()` for debugging
    - Populated in two stages: archetype abilities from Step 4, specialization Tier 1 abilities from Step 5

- **`EquipmentPreview`** + **`EquipmentPreviewItem`** (`ValueObjects/EquipmentPreview.cs`)
    - `EquipmentPreview`: `Items` (`IReadOnlyList<EquipmentPreviewItem>`), `FromBackground` (string)
    - `EquipmentPreviewItem`: `Name` (string), `Quantity` (int), `ItemType` (string)
    - Computed properties on `EquipmentPreview`: `ItemCount`, `HasItems`
    - Static `Empty` property on `EquipmentPreview` (empty items, empty background)
    - Helper methods: `GetSummary()` → `"Shield, Spear"` or `"Rations x3, Cloak"`, `ToString()` for debugging
    - Item names derived from kebab-case `BackgroundEquipmentGrant.ItemId` (e.g., "smiths-hammer" → "Smiths Hammer")
    - Item types derived from grant properties: equipped items → slot name, multi-quantity → "Consumable", single → "Item"

- **`CharacterCreationViewModel`** (`ValueObjects/CharacterCreationViewModel.cs`)
    - `readonly record struct` with 18 properties across 5 categories:
        - **Step Information:** `CurrentStep`, `StepTitle`, `StepDescription`, `StepNumber`, `TotalSteps`
        - **Navigation:** `CanGoBack`, `CanGoForward`, `IsPermanentChoice`, `PermanentWarning`
        - **Selections:** `SelectedLineageName`, `SelectedBackgroundName`, `SelectedArchetypeName`, `SelectedSpecializationName`, `CharacterName`
        - **Previews:** `DerivedStatsPreview?`, `AbilitiesPreview?`, `EquipmentPreview?`
        - **Validation:** `ValidationErrors` (`IReadOnlyList<string>`), `IsCurrentStepValid`
    - Computed properties: `ProgressIndicator` → `"Step 3 of 6"`, `HasAnySelections`, `HasPreviewData`
    - Static `Empty` property (Lineage step, empty fields, no previews, no errors)
    - `ToString()` override with step, navigation, and validation summary

### Application Layer

#### Interfaces

- **`IViewModelBuilder`** (`Interfaces/IViewModelBuilder.cs`)
    - `Build(CharacterCreationState state)` → `CharacterCreationViewModel`: Full ViewModel construction
    - `BuildDerivedStatsPreview(CharacterCreationState state)` → `DerivedStatsPreview`: Lightweight stats-only preview for real-time Step 3 updates
    - Comprehensive XML documentation with usage patterns, provider dependencies, and code examples

#### Services

- **`ViewModelBuilder`** (`Services/ViewModelBuilder.cs`)
    - Implements `IViewModelBuilder`
    - Constructor: 5 required providers + optional `ILogger<ViewModelBuilder>` (falls back to `NullLogger<T>`)
    - `Build()` method: Assembles complete ViewModel from state using corrected provider APIs
    - `BuildDerivedStatsPreview()` method: Public method returning `DerivedStatsPreview.Empty` when no attributes allocated
    - Private preview builders:
        - `BuildDerivedStatsPreviewInternal()`: Resolves lineage bonuses via `GetHpBonus()`/`GetApBonus()`, archetype bonuses via `GetResourceBonuses()`, calculates stats via `GetPreview()` with kebab-case string IDs
        - `BuildAbilitiesPreview()`: Retrieves archetype abilities via `GetStartingAbilities()` → `.AbilityName`, specialization Tier 1 via `GetTier(1)?.Abilities.Select(a => a.DisplayName)`
        - `BuildEquipmentPreview()`: Retrieves background equipment via `.EquipmentGrants`, transforms `ItemId` to display name
    - Private display name helpers: `GetLineageDisplayName()`, `GetBackgroundDisplayName()`, `GetArchetypeDisplayName()`, `GetSpecializationDisplayName()`
    - Private data transformation helpers:
        - `FormatItemIdAsDisplayName()`: Kebab-case → title case (e.g., "smiths-hammer" → "Smiths Hammer")
        - `DeriveItemType()`: Infers type from `IsEquipped`/`Slot`/`Quantity` since `BackgroundEquipmentGrant` has no `ItemType` property
        - `ConvertToKebabCase()`: PascalCase enum → kebab-case string via compiled regex (e.g., "ClanBorn" → "clan-born")
    - Exhaustive structured logging at Debug level for all operations, Warning level for missing definitions
    - Graceful degradation: missing provider data returns null display names and empty previews

### Unit Tests

- **`ViewModelBuilderTests`** (`Services/ViewModelBuilderTests.cs`) — 30 test methods (42 test cases with parameterization)
    - **Null Guard Tests (4 methods):**
        - `Build_NullState_ThrowsArgumentNullException`
        - `BuildDerivedStatsPreview_NullState_ThrowsArgumentNullException`
        - `Constructor_NullLineageProvider_ThrowsArgumentNullException`
        - `Constructor_NullDerivedStatCalculator_ThrowsArgumentNullException`
    - **Step Information Tests (3 methods):**
        - `Build_LineageStep_PopulatesStepInformation`: Title, description, step number, total steps
        - `Build_EachStep_SetsCorrectStepNumber`: Parameterized for all 6 steps
        - `Build_Step3_ProgressIndicatorFormatted`: Verifies "Step 3 of 6" format
    - **Navigation State Tests (4 methods):**
        - `Build_LineageStep_CanGoBackIsFalse`
        - `Build_StepsAfterLineage_CanGoBackIsTrue`: Parameterized for 5 steps
        - `Build_IncompleteStep_CanGoForwardIsFalse`
        - `Build_CompleteLineageStep_CanGoForwardIsTrue`
    - **Permanent Choice Tests (2 methods):**
        - `Build_ArchetypeStep_SetsPermanentChoice`: Verifies IsPermanentChoice and PermanentWarning
        - `Build_NonArchetypeStep_NoPermanentChoice`: Parameterized for 5 non-Archetype steps
    - **Selection Display Name Tests (7 methods):**
        - `Build_WithLineageSelected_ResolvesDisplayName`
        - `Build_WithBackgroundSelected_ResolvesDisplayName`
        - `Build_WithArchetypeSelected_ResolvesDisplayName`
        - `Build_WithSpecializationSelected_ResolvesDisplayName`
        - `Build_NoSelections_AllDisplayNamesAreNull`
        - `Build_WithCharacterName_IncludesNameInViewModel`
        - `Build_MissingLineageDefinition_ReturnsNullDisplayName`
    - **Derived Stats Preview Tests (4 methods):**
        - `Build_NoAttributes_DerivedStatsPreviewIsNull`
        - `Build_WithAttributes_PopulatesDerivedStatsPreview`: Full bonus source verification
        - `BuildDerivedStatsPreview_NoAttributes_ReturnsEmpty`
        - `BuildDerivedStatsPreview_RuneMarkedMystic_IncludesApBonuses`
        - `BuildDerivedStatsPreview_AttributesOnly_UsesNoBonuses`
    - **Abilities Preview Tests (3 methods):**
        - `Build_NoArchetype_AbilitiesPreviewIsNull`
        - `Build_WithArchetype_PopulatesArchetypeAbilities`
        - `Build_WithArchetypeAndSpecialization_PopulatesBothAbilityLists`
    - **Equipment Preview Tests (3 methods):**
        - `Build_NoBackground_EquipmentPreviewIsNull`
        - `Build_WithBackground_PopulatesEquipmentPreview`: Name transformation, type derivation, quantity
        - `Build_InventoryItem_DerivesItemType`: Non-equipped single item → "Item"
    - **Validation Tests (4 methods):**
        - `Build_CompleteStepNoErrors_IsCurrentStepValidTrue`
        - `Build_IncompleteStep_IsCurrentStepValidFalse`
        - `Build_WithValidationErrors_IncludesErrorsInViewModel`
        - `Build_CompleteStepWithErrors_IsCurrentStepValidFalse`
    - **Preview Data Tests (2 methods):**
        - `Build_NoPreviewData_HasPreviewDataIsFalse`
        - `Build_WithEquipmentPreview_HasPreviewDataIsTrue`
    - **Integration Test (1 method):**
        - `Build_SummaryStep_FullyPopulatedViewModel`: Complete workflow with all selections, all previews, full assertions
    - **Test Helpers:** 4 private setup methods for mock provider configuration: `SetupLineageProvider()`, `SetupBackgroundProvider()`, `SetupArchetypeProvider()`, `SetupSpecializationProvider()`

### Glossary

- **`config/glossary.json`** — Added 5 glossary entries
    - `character-creation-viewmodel`: Read-only presentation data for the character creation wizard (sortOrder: 52)
    - `derived-stats-preview`: Preview of HP, Stamina, and AP with bonus source breakdown (sortOrder: 53)
    - `abilities-preview`: Preview of archetype and specialization abilities (sortOrder: 54)
    - `equipment-preview`: Preview of starting equipment from background selection (sortOrder: 55)
    - `viewmodel-builder`: Service that builds creation ViewModel from state and providers (sortOrder: 56)

---

## Changed

### Documentation

- **`docs/design/v0.17.x/v0.17.5-scope-breakdown.md`** — Checked off v0.17.5b unit test items
    - `[x] ViewModel updates correctly on step change`
    - `[x] Preview data calculates from current state`

- **`docs/design/v0.17.x/v0.17.x-overview.md`** — Checked off v0.17.5 deliverable
    - `[x] CharacterCreationViewModel value object`

---

## Design Decisions

### Provider Method Names: Actual API vs. Design Specification

The design specification uses idealized method names that do not match the actual provider interfaces. All corrections are documented below:

| Spec Says | Actual API | Reason |
|---|---|---|
| `GetByLineage()` | `GetLineage(Lineage)` | `ILineageProvider` method signature |
| `GetByBackground()` | `GetBackground(Background)` | `IBackgroundProvider` method signature |
| `GetByArchetype()` | `GetArchetype(Archetype)` | `IArchetypeProvider` method signature |

### Lineage Bonuses via Methods, Not Properties

The design specification references `lineageDef.HpBonus` and `lineageDef.ApBonus` as properties. The actual `LineageDefinition` exposes these via methods: `GetHpBonus()` returns `PassiveBonuses.MaxHpBonus` and `GetApBonus()` returns `PassiveBonuses.MaxApBonus`.

### Archetype Bonuses via Provider, Not Definition

The design specification references `archetypeDef.HpBonus`, `.StaminaBonus`, `.ApBonus` as definition properties. The actual bonuses are accessed via `IArchetypeProvider.GetResourceBonuses(Archetype)` which returns `ArchetypeResourceBonuses` with `.MaxHpBonus`, `.MaxStaminaBonus`, `.MaxAetherPoolBonus`.

### Archetype Abilities via Provider Method

The design specification references `archetypeDef.StartingAbilities`. The actual API is `IArchetypeProvider.GetStartingAbilities(Archetype)` returning `IReadOnlyList<ArchetypeAbilityGrant>`, with each grant's `.AbilityName` property providing the display name.

### Specialization Tier 1 Abilities via GetTier

The design specification references `specDef.GetTier1AbilityNames()`. The actual API is `specDef.GetTier(1)` returning `SpecializationAbilityTier?`, with abilities accessed via `.Abilities.Select(a => a.DisplayName)`.

### Derived Stat Calculator: String-Based IDs

The design specification shows `Calculate(state, int, int, int)`. The actual API is `IDerivedStatCalculator.GetPreview(AttributeAllocationState, string?, string?)` which accepts kebab-case string identifiers for archetype and lineage. A new `ConvertToKebabCase()` helper method converts PascalCase enum names (e.g., "ClanBorn") to kebab-case strings (e.g., "clan-born") using a compiled regex.

### MaxAetherPool → MaxAp Presentation Mapping

The domain model uses `DerivedStats.MaxAetherPool`. The `DerivedStatsPreview` uses `MaxAp` as a shorter presentation-layer alias. The mapping happens in `BuildDerivedStatsPreviewInternal()`: `MaxAp = derivedStats.MaxAetherPool`.

### Equipment ItemId → Display Name Transformation

`BackgroundEquipmentGrant` stores kebab-case `ItemId` values (e.g., "smiths-hammer"). A new `FormatItemIdAsDisplayName()` helper converts these to title case (e.g., "Smiths Hammer") by splitting on hyphens and capitalizing each word.

### Equipment ItemType Derivation

`BackgroundEquipmentGrant` has no `ItemType` property. A new `DeriveItemType()` helper infers the type: equipped items with a slot use the slot name (e.g., "Weapon", "Armor"), multi-quantity non-equipped items are "Consumable", and single non-equipped items are "Item".

### Equipment Grants Property Name

The design specification references `backgroundDef.StartingEquipment`. The actual property is `backgroundDef.EquipmentGrants` (`IReadOnlyList<BackgroundEquipmentGrant>`).

### IsCurrentStepValid: Compound Check

`IsCurrentStepValid` requires both `IsStepComplete(currentStep)` returning true AND `ValidationErrors.Count == 0`. A step that is "complete" (all required selections made) can still be invalid if external validation errors have been added to the state.

---

## Dependencies

### Prerequisites

| Type | Phase | Usage |
| --- | --- | --- |
| `CharacterCreationStep` | v0.17.5a | Step enum for ViewModel step information |
| `CharacterCreationStepExtensions` | v0.17.5a | Display names, descriptions, navigation flags |
| `CharacterCreationState` | v0.17.5a | Source data for ViewModel construction |
| `ILineageProvider` | v0.17.0 | Lineage definitions and HP/AP bonuses |
| `IBackgroundProvider` | v0.17.1 | Background definitions and equipment grants |
| `IArchetypeProvider` | v0.17.3 | Archetype definitions, resource bonuses, starting abilities |
| `ISpecializationProvider` | v0.17.4 | Specialization definitions and Tier 1 abilities |
| `IDerivedStatCalculator` | v0.17.2 | Derived stat calculation from attribute allocation |
| `ArchetypeResourceBonuses` | v0.17.3 | Static bonus values per archetype |
| `BackgroundEquipmentGrant` | v0.17.1 | Equipment grant data (ItemId, Quantity, IsEquipped, Slot) |
| `ArchetypeAbilityGrant` | v0.17.3 | Ability grant data (AbilityName) |
| `SpecializationDefinition` | v0.17.4 | GetTier() for ability tier access |
| `DerivedStats` | v0.17.2 | MaxHp, MaxStamina, MaxAetherPool properties |

### Provides to Future Phases

| Type | Phase | Usage |
| --- | --- | --- |
| `CharacterCreationViewModel` | v0.17.5d | Controller provides ViewModel to TUI |
| `IViewModelBuilder` | v0.17.5d | Controller calls Build() after state changes |
| `DerivedStatsPreview` | v0.17.5d | Controller calls BuildDerivedStatsPreview() for Step 3 |
| `CharacterCreationViewModel` | v0.17.5f | TUI screens render from ViewModel data |
| `AbilitiesPreview` | v0.17.5f | TUI ability display panel |
| `EquipmentPreview` | v0.17.5f | TUI equipment display panel |

---

## Logging Strategy

| Level | When |
|---|---|
| Debug | ViewModel build started (step, step number, session ID) |
| Debug | Selection display names resolved (all 5 selection names, session ID) |
| Debug | Preview data built (HasDerivedStats, HasAbilities, HasEquipment, session ID) |
| Debug | Navigation state calculated (CanGoBack, CanGoForward, IsPermanent, validation error count, session ID) |
| Debug | ViewModel build complete (step, ViewModel summary, session ID) |
| Debug | Derived stats preview skipped (no attributes allocated) |
| Debug | Bonus sources resolved (HpFromLineage, ApFromLineage, HpFromArchetype, StaminaFromArchetype, ApFromArchetype) |
| Debug | Derived stats preview calculated (MaxHp, MaxStamina, MaxAetherPool, archetype/lineage IDs) |
| Debug | Archetype abilities retrieved (archetype, count) |
| Debug | Specialization Tier 1 abilities retrieved (specialization, count) |
| Debug | Abilities preview skipped (no archetype or specialization selected) |
| Debug | Equipment preview skipped (no background selected) |
| Debug | Equipment preview built (background, item count, item list) |
| Debug | BuildDerivedStatsPreview public method entry (HasAttributes, HasLineage, HasArchetype) |
| Warning | Lineage definition not found (lineage value, session ID) |
| Warning | Background definition not found (background value, session ID) |
| Warning | Archetype definition not found (archetype value) |
| Warning | Specialization definition not found (specialization ID, session ID) |
| Warning | Specialization has no Tier 1 abilities (specialization, session ID) |

All logging uses structured format with named parameters for efficient log aggregation.

---

## Files Created

| Path | Description |
|------|-------------|
| `src/Core/RuneAndRust.Domain/ValueObjects/DerivedStatsPreview.cs` | Derived stats preview with resource pools and source breakdown |
| `src/Core/RuneAndRust.Domain/ValueObjects/AbilitiesPreview.cs` | Abilities preview with archetype and specialization lists |
| `src/Core/RuneAndRust.Domain/ValueObjects/EquipmentPreview.cs` | Equipment preview with item name, quantity, and type |
| `src/Core/RuneAndRust.Domain/ValueObjects/CharacterCreationViewModel.cs` | Main ViewModel with step info, navigation, selections, previews, validation |
| `src/Core/RuneAndRust.Application/Interfaces/IViewModelBuilder.cs` | Interface for ViewModel construction |
| `src/Core/RuneAndRust.Application/Services/ViewModelBuilder.cs` | Service implementation coordinating 5 providers |
| `tests/RuneAndRust.Application.UnitTests/Services/ViewModelBuilderTests.cs` | 30 test methods (42 cases) for ViewModel construction |
| `changelogs/v0.17.5b-changelog.md` | This changelog |

## Files Modified

| Path | Description |
|------|-------------|
| `config/glossary.json` | Added 5 glossary entries (sortOrder 52-56) |
| `docs/design/v0.17.x/v0.17.5-scope-breakdown.md` | Checked off v0.17.5b unit test items |
| `docs/design/v0.17.x/v0.17.x-overview.md` | Checked off CharacterCreationViewModel deliverable |

---

## Notes

- Total unit tests for v0.17.5b: 30 test methods expanding to 42 test cases via parameterization
- Build: 0 errors, 0 warnings
- All 3755 tests pass (existing + new)
- The design specification estimated ~2 tests; 30 methods (42 cases) were implemented for comprehensive coverage
- All 4 value objects use `readonly record struct` for immutability and value equality
- The ViewModelBuilder constructs a fresh ViewModel on every `Build()` call — no caching
- Preview data is nullable: `DerivedStatsPreview?` (null until attributes allocated), `AbilitiesPreview?` (null until archetype selected), `EquipmentPreview?` (null until background selected)
- The `PermanentWarning` constant is defined in the ViewModelBuilder, not in configuration, matching the current approach
- `ConvertToKebabCase()` uses `Regex.Compiled` for performance in repeated calls
- Missing provider definitions result in null display names and logged warnings — the builder never throws for missing data
- `IsCurrentStepValid` is a compound check: step must be complete AND have zero validation errors
- All new files follow established codebase patterns: `═══════` section separators, copyright headers, comprehensive XML documentation, exhaustive structured logging
