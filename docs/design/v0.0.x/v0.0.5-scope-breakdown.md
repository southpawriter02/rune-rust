# v0.0.5 Dice Pool System - Scope Breakdown

**Version:** 0.0.5
**Theme:** Dice Pool System
**Prerequisites:** v0.0.4d Complete (Integration & Polish)
**Total Estimated Tests:** ~62 new tests (198 → 260)

---

## Executive Summary

The Dice Pool System provides the core randomization engine for all game mechanics, transforming simple random number generation into a comprehensive, configurable dice system. This system supports multiple dice types, dice pools, modifiers, advantage/disadvantage, exploding dice, skill checks, and dice-based combat resolution.

The work is divided into **four sub-phases**:

| Phase | Name | Focus | Est. Tests |
|-------|------|-------|------------|
| v0.0.5a | Core Dice Engine | DicePool, DiceResult, DiceService, basic rolling | ~18 |
| v0.0.5b | Skill Check System | SkillDefinition, SkillCheckService, difficulty classes | ~20 |
| v0.0.5c | Combat Integration | Attack rolls, damage rolls, CombatService refactor | ~15 |
| v0.0.5d | Configuration & Polish | JSON configs, rendering, commands, descriptors | ~9 |

---

## Feature Analysis & Categorization

### Core Dice Features

| Feature | Complexity | Dependencies | Assigned Phase |
|---------|------------|--------------|----------------|
| Dice Types (d4, d6, d8, d10) | Low | None | **v0.0.5a** |
| Dice Pools (e.g., 3d6+5) | Medium | Dice types | **v0.0.5a** |
| Modifiers | Low | Dice pools | **v0.0.5a** |
| Advantage/Disadvantage | Medium | Dice service | **v0.0.5a** |
| Exploding Dice | Medium | Dice service | **v0.0.5a** |
| Dice Notation Parsing | Medium | Dice pools | **v0.0.5a** |

### Skill Check Features

| Feature | Complexity | Dependencies | Assigned Phase |
|---------|------------|--------------|----------------|
| Skill Definitions | Medium | Configuration system | **v0.0.5b** |
| Difficulty Classes | Low | Configuration system | **v0.0.5b** |
| Skill Check Service | High | DiceService, Skills, DCs | **v0.0.5b** |
| Attribute Bonuses | Medium | Player attributes | **v0.0.5b** |
| Critical Success/Failure | Low | Dice results | **v0.0.5b** |

### Combat Features

| Feature | Complexity | Dependencies | Assigned Phase |
|---------|------------|--------------|----------------|
| Attack Rolls | Medium | DiceService | **v0.0.5c** |
| Damage Rolls | Medium | DiceService | **v0.0.5c** |
| Critical Hits | Medium | Attack rolls | **v0.0.5c** |
| Critical Miss | Low | Attack rolls | **v0.0.5c** |
| Monster Counterattack Dice | Medium | DiceService | **v0.0.5c** |

### Polish Features

| Feature | Complexity | Dependencies | Assigned Phase |
|---------|------------|--------------|----------------|
| Roll Command | Low | DiceService | **v0.0.5d** |
| Check Command | Medium | SkillCheckService | **v0.0.5d** |
| Dice Roll Display | Medium | Renderer | **v0.0.5d** |
| Descriptors | Low | Descriptor service | **v0.0.5d** |

---

## Phase Definitions

---

## v0.0.5a: Core Dice Engine

[v0.0.5a Implementation Plan](v0.0.5a-implementation-plan.md)

### Overview

Create the fundamental dice rolling infrastructure: value objects, enums, and the core DiceService that powers all randomization in the game.

### Scope

**In Scope:**
- `DiceType` enum (D4, D6, D8, D10)
- `AdvantageType` enum (Normal, Advantage, Disadvantage)
- `SuccessLevel` enum (CriticalFailure, Failure, Success, CriticalSuccess)
- `DicePool` value object with notation parsing
- `DiceRollResult` value object
- `DiceService` for rolling dice
- `DiceDtos` for presentation layer
- Dice notation parsing (e.g., "3d6+5", "1d10-2", "2d8!")

**Out of Scope:**
- Skill check system (v0.0.5b)
- Combat integration (v0.0.5c)
- Commands and rendering (v0.0.5d)

### Key Deliverables

| Type | Count | Details |
|------|-------|---------|
| Domain Enums | 3 | `DiceType`, `AdvantageType`, `SuccessLevel` |
| Domain Value Objects | 2 | `DicePool`, `DiceRollResult` |
| Application Services | 1 | `DiceService` |
| DTOs | 2 | `DiceRollDto`, `DicePoolDto` |
| Unit Tests | ~18 | |

### Data Model Changes

```
NEW: DiceType (Enum)
├── D4 = 4
├── D6 = 6
├── D8 = 8
└── D10 = 10

NEW: AdvantageType (Enum)
├── Normal
├── Advantage
└── Disadvantage

NEW: SuccessLevel (Enum)
├── CriticalFailure
├── Failure
├── Success
└── CriticalSuccess

NEW: DicePool (Value Object)
├── Count: int
├── DiceType: DiceType
├── Modifier: int
├── Exploding: bool
├── MaxExplosions: int
├── Faces: int (computed)
├── MinimumResult: int (computed)
├── MaximumResult: int (computed)
└── AverageResult: float (computed)

NEW: DiceRollResult (Value Object)
├── Pool: DicePool
├── Rolls: IReadOnlyList<int>
├── ExplosionRolls: IReadOnlyList<int>
├── DiceTotal: int
├── Total: int
├── AdvantageType: AdvantageType
├── AllRollTotals: IReadOnlyList<int>
├── SelectedRollIndex: int
├── IsNaturalMax: bool (computed)
├── IsNaturalOne: bool (computed)
└── HadExplosions: bool (computed)
```

### Acceptance Criteria

- [ ] Can roll any standard dice type (d4, d6, d8, d10)
- [ ] Dice notation parsing works (e.g., "3d6+5", "1d10-2", "2d8!")
- [ ] Exploding dice trigger on maximum value
- [ ] Advantage rolls twice and takes higher
- [ ] Disadvantage rolls twice and takes lower
- [ ] Roll results include individual die values
- [ ] ~18 unit tests pass

---

## v0.0.5b: Skill Check System

[v0.0.5b Design Specification](v0.0.5b-design-specification.md)

[v0.0.5b Implementation Plan](v0.0.5b-implementation-plan.md)

### Overview

Build the skill check framework that uses dice rolls to determine success/failure for player actions, with configurable skills and difficulty classes.

### Scope

**In Scope:**
- `SkillDefinition` entity for skill configuration
- `DifficultyClassDefinition` entity for DC levels
- `SkillCheckResult` value object
- `SkillCheckService` for performing checks
- `SkillCheckDtos` for presentation layer
- `config/skills.json` with 10 skill definitions
- `config/difficulty.json` with 8 difficulty classes
- Update `IGameConfigurationProvider` for skills/DCs

**Out of Scope:**
- Combat integration (v0.0.5c)
- Commands and rendering (v0.0.5d)
- Skill training system (future version)

### Key Deliverables

| Type | Count | Details |
|------|-------|---------|
| Domain Definitions | 2 | `SkillDefinition`, `DifficultyClassDefinition` |
| Domain Value Objects | 1 | `SkillCheckResult` |
| Application Services | 1 | `SkillCheckService` |
| DTOs | 3 | `SkillCheckResultDto`, `SkillDefinitionDto`, `DifficultyClassDto` |
| Configuration | 2 | `skills.json`, `difficulty.json` |
| Unit Tests | ~20 | |

### Data Model Changes

```
NEW: SkillDefinition (Entity)
├── Id: string
├── Name: string
├── Description: string
├── PrimaryAttribute: string
├── SecondaryAttribute: string?
├── BaseDicePool: string
├── AllowUntrained: bool
├── UntrainedPenalty: int
├── Category: string
└── Tags: IReadOnlyList<string>

NEW: DifficultyClassDefinition (Entity)
├── Id: string
├── Name: string
├── Description: string
├── TargetNumber: int
├── Color: string
└── SortOrder: int

NEW: SkillCheckResult (Value Object)
├── SkillId: string
├── SkillName: string
├── DiceResult: DiceRollResult
├── AttributeBonus: int
├── OtherBonus: int
├── TotalResult: int
├── DifficultyClass: int
├── DifficultyName: string
├── SuccessLevel: SuccessLevel
├── Margin: int (computed)
├── IsSuccess: bool (computed)
└── IsCritical: bool (computed)
```

### Skills Configuration

| Skill | Primary | Secondary | Category |
|-------|---------|-----------|----------|
| Athletics | Might | Fortitude | Physical |
| Acrobatics | Finesse | - | Physical |
| Stealth | Finesse | Wits | Physical |
| Perception | Wits | - | Mental |
| Investigation | Wits | Will | Mental |
| Lockpicking | Finesse | - | Specialty |
| Intimidation | Might | Will | Social |
| Persuasion | Will | Wits | Social |
| Arcana | Will | - | Knowledge |
| Endurance | Fortitude | - | Physical |

### Difficulty Classes

| DC Level | Target Number | Description |
|----------|---------------|-------------|
| Trivial | 5 | Almost anyone can do this |
| Easy | 8 | Simple task for basic ability |
| Moderate | 12 | Requires some skill or effort |
| Challenging | 15 | Difficult for most people |
| Hard | 18 | Only skilled individuals succeed |
| Very Hard | 22 | Even experts struggle |
| Heroic | 25 | A legendary feat |
| Impossible | 30 | Only the most exceptional succeed |

### Acceptance Criteria

- [ ] 10 skills defined in configuration
- [ ] 8 difficulty classes defined
- [ ] Skill checks use player attributes
- [ ] Critical success on natural max
- [ ] Critical failure on natural 1
- [ ] Skill check results include full breakdown
- [ ] ~20 unit tests pass

---

## v0.0.5c: Combat Integration

[v0.0.5c Design Specification](v0.0.5c-design-specification.md)

[v0.0.5c Implementation Plan](v0.0.5c-implementation-plan.md)

### Overview

Refactor the combat system to use dice-based attack and damage rolls instead of static calculations, adding transparency and tactical depth.

### Scope

**In Scope:**
- `CombatRoundResult` record with dice breakdown
- `MonsterCounterAttackResult` record
- Update `CombatService` to use `DiceService`
- Attack roll mechanics (1d10 + Finesse vs Defense)
- Damage roll mechanics (weapon dice + Might)
- Critical hit (natural 10) and critical miss (natural 1) support
- Update `GameSessionService.TryAttack()` integration
- Combat DTOs for dice display

**Out of Scope:**
- Multi-monster targeting (v0.0.6)
- Status effects (v0.0.6)
- Weapon equipment system (v0.0.7)
- Commands and rendering (v0.0.5d)

### Key Deliverables

| Type | Count | Details |
|------|-------|---------|
| Domain Value Objects | 2 | `CombatRoundResult`, `MonsterCounterAttackResult` |
| Domain Services | 1 | Update `CombatService` |
| Application Services | 1 | Update `GameSessionService` |
| DTOs | 2 | `CombatRoundResultDto`, `MonsterCounterAttackResultDto` |
| Unit Tests | ~15 | |

### Data Model Changes

```
NEW: CombatRoundResult (Record)
├── AttackRoll: DiceRollResult
├── AttackTotal: int
├── IsHit: bool
├── IsCriticalHit: bool
├── IsCriticalMiss: bool
├── DamageRoll: DiceRollResult?
├── DamageDealt: int
├── MonsterCounterAttack: MonsterCounterAttackResult?
├── MonsterDefeated: bool
└── PlayerDefeated: bool

NEW: MonsterCounterAttackResult (Record)
├── AttackRoll: DiceRollResult
├── AttackTotal: int
├── IsHit: bool
├── IsCriticalHit: bool
├── IsCriticalMiss: bool
├── DamageRoll: DiceRollResult?
├── DamageDealt: int
└── PlayerDefeated: bool

MODIFY: CombatService
├── ADD: ResolveCombatRound(Player, Monster, DiceService)
├── ADD: ResolvePlayerAttack() private
├── ADD: ResolveMonsterCounterAttack() private
├── ADD: GetPlayerDamagePool() private
└── ADD: GetMonsterDamagePool() private
```

### Combat Flow

```
ATTACK ROLL:
  Roll 1d10 + Finesse vs Monster Defense
  - Natural 10: Critical Hit (auto-hit, double damage dice)
  - Natural 1: Critical Miss (auto-miss)
  - Total >= Defense: Hit
  - Total < Defense: Miss

DAMAGE ROLL (if hit):
  Roll weapon dice (default 1d6) + Might
  - Critical Hit: Double the dice count (1d6 → 2d6)
  - Armor reduction: Damage - (Defense / 2)
  - Minimum damage: 1

MONSTER COUNTERATTACK (if alive):
  Same mechanics as player attack
```

### Acceptance Criteria

- [ ] Attack rolls determine hit/miss
- [ ] Critical hits (natural 10) double damage dice
- [ ] Critical misses (natural 1) always miss
- [ ] Damage rolls include weapon dice
- [ ] Monster counterattacks use dice
- [ ] Combat results show full dice breakdown
- [ ] ~15 unit tests pass

---

## v0.0.5d: Configuration & Polish

[v0.0.5d Design Specification](v0.0.5d-design-specification.md)

[v0.0.5d Implementation Plan](v0.0.5d-implementation-plan.md)

### Overview

Complete the presentation layer integration with dice rolling commands, skill check commands, and polished dice display with descriptors.

### Scope

**In Scope:**
- `roll <notation>` command for direct dice rolling
- `check <skill> [difficulty]` command for skill checks
- `RenderDiceRollAsync` in renderer
- `RenderSkillCheckAsync` in renderer
- `RenderCombatRoundAsync` in renderer
- Dice roll descriptors for critical results
- Command parsing updates

**Out of Scope:**
- New dice types (future version)
- Skill training commands (future version)

### Key Deliverables

| Type | Count | Details |
|------|-------|---------|
| Commands | 2 | `RollCommand`, `SkillCheckCommand` |
| Renderer Methods | 3 | `RenderDiceRollAsync`, `RenderSkillCheckAsync`, `RenderCombatRoundAsync` |
| Input Handler | 1 | Update `ConsoleInputHandler` |
| View Handler | 2 | `HandleRollCommandAsync`, `HandleSkillCheckCommandAsync` |
| Unit Tests | ~9 | |

### Commands

```
> roll <notation>           # Roll dice directly
> roll 3d6+5               # Example: rolls 3d6+5
> roll 1d10                # Example: rolls 1d10
> roll 2d8!                # Example: rolls 2d8 exploding

> check <skill>            # Perform skill check with default DC
> check perception         # Example: perception check
> check <skill> <dc>       # Perform skill check with specific DC
> check stealth hard       # Example: stealth vs Hard (DC 18)
```

### Display Examples

**Dice Roll:**
```
┌──────────────────────────────────────────┐
│ Dice     │ Rolls           │ Total      │
├──────────────────────────────────────────┤
│ 3d6+5    │ [4, 2, 6] + 5   │ 17         │
└──────────────────────────────────────────┘
```

**Skill Check:**
```
Perception Check (Wits)
Roll: [8] + 5 (Wits) = 13 vs DC 12 (Moderate)
Result: SUCCESS! (margin: +1)
```

**Combat Round:**
```
You attack the Goblin!
Attack Roll: [14] + 3 (Finesse) = 17 vs Defense 12
Hit! Rolling damage...
Damage Roll: 1d6 [4] + 2 (Might) = 6 damage!
The Goblin takes 6 damage. (HP: 30 -> 24)
```

### Acceptance Criteria

- [ ] `roll <notation>` command works
- [ ] `check <skill>` command works
- [ ] Dice rolls display with formatting
- [ ] Descriptors appear for critical rolls
- [ ] Combat round displays dice breakdown
- [ ] ~9 unit tests pass
- [ ] All 260 tests pass
- [ ] Build: 0 errors, 0 warnings

---

## Dependencies & Prerequisites

```
v0.0.4 (Classes & Abilities) - REQUIRED
    │
    ├── v0.0.4a: Class System ──────────┐
    ├── v0.0.4b: Resource System ───────┤
    ├── v0.0.4c: Ability System ────────┤
    └── v0.0.4d: Integration & Polish ──┘
                                        │
                                        ▼
v0.0.5 (Dice Pool System)
    │
    ├── v0.0.5a: Core Dice Engine ──────────────────┐
    │       Dependencies: None (foundation)          │
    │                                                │
    ├── v0.0.5b: Skill Check System ────────────────┤
    │       Dependencies: v0.0.5a (DiceService)     │
    │                                                │
    ├── v0.0.5c: Combat Integration ────────────────┤
    │       Dependencies: v0.0.5a (DiceService)     │
    │                                                │
    └── v0.0.5d: Configuration & Polish ────────────┘
            Dependencies: v0.0.5a, v0.0.5b, v0.0.5c
```

**Note:** v0.0.5b and v0.0.5c can be developed in parallel after v0.0.5a is complete.

---

## Estimated Effort Summary

| Phase | New Files | Modified Files | Est. Tests | Complexity |
|-------|-----------|----------------|------------|------------|
| v0.0.5a | ~7 | ~2 | ~18 | Medium |
| v0.0.5b | ~6 | ~3 | ~20 | Medium |
| v0.0.5c | ~2 | ~4 | ~15 | Medium |
| v0.0.5d | ~0 | ~6 | ~9 | Low |
| **Total** | **~15** | **~15** | **~62** | |

---

## Risk Assessment

| Risk | Impact | Probability | Mitigation |
|------|--------|-------------|------------|
| Combat balance disruption | High | Medium | Keep variance similar to current system initially |
| Infinite explosion loops | Medium | Low | MaxExplosions cap (default 10) |
| Random test flakiness | Medium | Medium | Use seeded Random for deterministic tests |
| Performance with many dice | Low | Low | Dice pools limited by game design |
| Breaking existing tests | High | Medium | Phase-by-phase integration with regression testing |

---

## Design Decisions (Confirmed)

### Dice Mechanics

| Decision | Value | Notes |
|----------|-------|-------|
| **Base resolution die** | d10 | All skill checks and attacks use d10 |
| **Attack roll formula** | 1d10 + Finesse | Finesse represents combat precision |
| **Damage modifier** | Might | Might represents raw physical power |
| **Default weapon dice** | 1d6 | Balanced baseline for unarmed/basic weapon |
| **Critical hit effect** | Double damage dice | Standard RPG convention |
| **Critical miss effect** | Always miss | Prevents impossible hits |
| **Armor damage reduction** | Defense / 2 | Partial mitigation, not full negation |

### Skill Check Mechanics

| Decision | Value | Notes |
|----------|-------|-------|
| **Primary attribute** | Full bonus | Main attribute for the skill |
| **Secondary attribute** | Half bonus | Supporting attribute |
| **Critical success** | Natural 10 | Always succeeds regardless of DC |
| **Critical failure** | Natural 1 | Always fails regardless of bonuses |

---

## Integration with v0.0.4 Systems

| v0.0.4 System | v0.0.5 Integration |
|---------------|-------------------|
| **Classes** | Class abilities provide skill check bonuses |
| **Resources** | Skill checks may cost resources |
| **Abilities** | Ability effects use dice for damage/healing |
| **Turn Processing** | Skill checks can be turn-ending actions |
| **Combat** | Attack/damage rolls replace static calculations |

---

## Files Summary

### Files to Create (New)

| Phase | File | Purpose |
|-------|------|---------|
| 5a | `DiceType.cs` | Enum for dice types |
| 5a | `AdvantageType.cs` | Enum for advantage |
| 5a | `SuccessLevel.cs` | Enum for success levels |
| 5a | `DicePool.cs` | Value object for dice pools |
| 5a | `DiceRollResult.cs` | Value object for results |
| 5a | `DiceService.cs` | Core rolling service |
| 5a | `DiceDtos.cs` | DTOs for dice rolls |
| 5b | `SkillDefinition.cs` | Skill definition entity |
| 5b | `DifficultyClassDefinition.cs` | DC definition entity |
| 5b | `SkillCheckResult.cs` | Value object for checks |
| 5b | `SkillCheckService.cs` | Skill check service |
| 5b | `SkillCheckDtos.cs` | DTOs for skill checks |
| 5b | `config/skills.json` | Skill configuration |
| 5b | `config/difficulty.json` | DC configuration |
| 5c | `CombatResults.cs` | Combat result records |

### Files to Modify

| Phase | File | Changes |
|-------|------|---------|
| 5b | `IGameConfigurationProvider.cs` | Add skill/DC methods |
| 5b | `JsonConfigurationProvider.cs` | Load skills/DCs |
| 5c | `CombatService.cs` | Use dice for combat |
| 5c | `GameSessionService.cs` | Pass DiceService to combat |
| 5d | `IInputHandler.cs` | Add roll/check commands |
| 5d | `ConsoleInputHandler.cs` | Parse roll/check |
| 5d | `IGameRenderer.cs` | Add dice rendering |
| 5d | `SpectreGameRenderer.cs` | Implement rendering |
| 5d | `GameView.cs` | Handle roll/check commands |

---

## Final Metrics

| Metric | Before v0.0.5 | After v0.0.5 |
|--------|---------------|--------------|
| Domain Tests | 123 | ~155 |
| Application Tests | 67 | ~97 |
| Architecture Tests | 8 | 8 |
| **Total Tests** | **198** | **~260** |
| Config Files | 7 | 9 |
| Domain Files | ~25 | ~33 |
| Application Files | ~18 | ~23 |

---

*This scope breakdown provides a structured approach to implementing v0.0.5 Dice Pool System. Each sub-phase builds on the previous, allowing for incremental development and testing. Note that v0.0.5b and v0.0.5c can be developed in parallel after v0.0.5a is complete.*
