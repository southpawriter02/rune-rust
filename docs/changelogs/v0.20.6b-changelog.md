# v0.20.6b Changelog — Bone-Setter Tier 2 Abilities

## Version: 0.20.6b

## Date: 2026-02-16

## Focus: Bone-Setter Specialization — Tier 2 Abilities (Emergency Surgery, Antidote Craft, Triage)

---

## Added

### Domain Layer — Enums

- **`RecoveryCondition`** — 5 recovery states for Emergency Surgery bonus calculation: Active (0), Incapacitated (+1 bonus), Recovering (+3 bonus), Dying (+4 bonus), Dead (no bonus)
- **`CraftingMaterialType`** — 5 crafting material classifications: PlantFiber, MineralPowder, AlchemicalReagent, RareBindingAgent, MachineSalvage

### Domain Layer — Value Objects

- **`CraftingMaterial`** — Crafting material input record with type, quantity, quality (1-5). Factory method `Create(CraftingMaterialType, int, int)` with validation. Used as method parameter to keep services pure.
- **`EmergencySurgeryResult`** — High-impact healing outcome with full breakdown: dice roll (4d6), quality bonus, Steady Hands bonus, recovery condition bonus, computed `TotalHealing`. Recovery condition tracking via `BonusTriggered` and `TargetCondition`. Display methods: `GetHealingBreakdown()` (includes recovery component when triggered), `GetStatusMessage()` (includes `[EMERGENCY INTERVENTION BONUS]` indicator).
- **`AntidoteCraftResult`** — Crafting outcome with success/failure factory methods: `CreateSuccess(recipe, quality, materials, antidote, supplies)` and `CreateFailure(recipe, reason, supplies)`. Tracks materials consumed via `IReadOnlyDictionary<string, int>`. Display: `GetMaterialSummary()`.
- **`TriageResult`** — Triage passive evaluation result with most wounded ally identification. Computed properties: `BonusHealing` = `(int)(BaseHealing * 0.5f)`, `TotalHealing` = `BaseHealing + BonusHealing`. Display: `GetBonusSummary()`.
- **`TriageTarget`** — Input data carrier for Triage evaluation with computed `HpPercentage`. Factory method `Create(Guid, string, int, int)` with validation.

### Application Layer — Interface Changes

- **`IBoneSetterAbilityService`** — Added 3 Tier 2 method signatures:
  - `ExecuteEmergencySurgery(Player, Guid, string, int, int, RecoveryCondition)` — High-impact 4d6 healing with recovery condition bonus
  - `ExecuteAntidoteCraft(Player, CraftingMaterial[])` — 100% success rate crafting from Herbs + materials
  - `EvaluateTriage(Player, TriageTarget[], int)` — Passive bonus calculation for most wounded ally
- Updated interface XML documentation to describe Tier 2 abilities

### Application Layer — Service Changes

- **`BoneSetterAbilityService`** — Added Tier 2 implementation:
  - 14 new constants: `EmergencySurgeryApCost` (3), `EmergencySurgerySupplyCost` (1), `AntidoteCraftApCost` (2), `AntidoteCraftHerbsCost` (1), `AntidoteCraftPlantFiberCost` (2), `AntidoteCraftMineralPowderCost` (1), `MaxCraftedQuality` (5), `HighQualityMaterialThreshold` (3), `TriageRadius` (5), `TriageBonusMultiplier` (0.5f), `RecoveryBonusRecovering` (3), `RecoveryBonusIncapacitated` (1), `RecoveryBonusDying` (4), `BasicAntidoteRecipeName` ("Basic Antidote")
  - `internal virtual int Roll4D6()` — Deterministic dice method for Emergency Surgery (range: 4-24)
  - `ExecuteEmergencySurgery` — Guard-clause chain → deduct 3 AP → spend highest-quality supply → Roll4D6 → quality + Steady Hands + recovery bonus → cap at max HP → build result → LogInformation
  - `ExecuteAntidoteCraft` — Guard-clause chain → validate Herbs + materials (PlantFiber ≥ 2, MineralPowder ≥ 1) → deduct 2 AP → spend Herbs → calculate quality (Herbs quality + material bonus, capped at 5) → create Antidote via `MedicalSupplyItem.Create` → add to inventory → build result → LogInformation
  - `EvaluateTriage` — Guard-clause chain → find most wounded (lowest HP%) → calculate bonus `(int)(baseHealing * 0.5f)` → build result → LogInformation
  - `private static int CalculateRecoveryBonus(RecoveryCondition)` — Switch expression: Active=0, Incapacitated=+1, Recovering=+3, Dying=+4, Dead=0
  - `private static int CalculateMaterialBonus(CraftingMaterial[])` — Returns +1 if all materials Q3+, else 0
  - `GetAbilityReadiness` — Updated switch expression with 3 Tier 2 cases: EmergencySurgery (AP + supplies), AntidoteCraft (AP + Herbs), Triage (always ready)

### Configuration

- Updated `config/abilities.json` with 3 Tier 2 ability entries:
  - `emergency-surgery` (id 603): Active, 3 AP + 1 supply (highest quality), 4d6 + quality + Steady Hands + recovery bonus, Coherent path
  - `antidote-craft` (id 604): Active, 2 AP + 1 Herbs supply + crafting materials, 100% success rate, Coherent path
  - `triage` (id 605): Passive, 5-space radius, +50% healing to most wounded ally, Coherent path

### Unit Tests

- **`BoneSetterAbilityServiceTests`** — 26 new Tier 2 tests (42 total):
  - Test subclass updated with `Fixed4D6` property and `Roll4D6()` override
  - `CreateTier2BoneSetter` helper (unlocks all T1+T2 = 12 PP)
  - `SetupEmergencySurgeryMocks` helper for highest-quality supply mocking
  - Emergency Surgery (9 tests): valid prereqs, Steady Hands bonus, Recovering/Dying/Incapacitated recovery bonuses, healing capped at max HP, insufficient AP, no supplies, ability not unlocked
  - Antidote Craft (7 tests): all materials success, high-quality bonus (+1), quality capped at 5, missing Herbs, insufficient Plant Fiber, insufficient Mineral Powder, insufficient AP
  - Triage (6 tests): identifies most wounded, single ally, no allies, null allies, ability not unlocked, odd base healing rounds down
  - Readiness & PP (4 tests): includes Tier 2 abilities, Emergency Surgery AP check, CanUnlockTier2 with T2 unlocked, GetPPInvested with T2 (12 PP)
- **`EmergencySurgeryResultTests`** — 6 domain tests: TotalHealing sum, zero bonuses, healing breakdown with/without recovery, status message with/without intervention bonus
- **`AntidoteCraftResultTests`** — 5 domain tests: CreateSuccess properties, read-only materials, CreateFailure properties, material summary formatted/empty
- **`CraftingMaterialTests`** — 7 domain tests: valid creation, min/max values, quality validation (below/above), quantity validation, all material types

## Design Decisions

- **Emergency Surgery uses highest-quality supply**: Opposite of Field Dressing (lowest quality first). Emergency situations deserve the best available supply, accessed via `GetHighestQualitySupply()` then `SpendSupply(player, type)`.
- **Antidote Craft always succeeds (100%)**: Per the v0.20.6b design specification, no DC check — simplified from the scope breakdown which mentioned DC 12. The crafting quality still varies based on Herbs quality and material bonus.
- **Triage as `EvaluateTriage()` method**: Callable by other healing abilities to get bonus amount — not a standalone user-invoked execute. The calling code passes allies-in-radius and base healing, gets back the most-wounded identification and bonus calculation.
- **CraftingMaterial as method parameter**: Not a Player property. Keeps the service pure by having callers provide material data, matching the target-data-as-params pattern established in v0.20.6a.
- **RecoveryCondition as method parameter**: The caller determines the target's recovery state; the service calculates the appropriate bonus. This decouples the bonus calculation from condition tracking.
- **Material failure returns `AntidoteCraftResult` (not null)**: When prerequisites pass but crafting materials are insufficient, the method returns `AntidoteCraftResult.CreateFailure()` rather than null. Null is reserved for prerequisite failures (wrong spec, ability not unlocked, insufficient AP, no Herbs).
- **No Player.cs modifications needed**: The existing `HasBoneSetterAbilityUnlocked`, `GetBoneSetterPPInvested`, and Medical Supplies infrastructure from v0.20.6a already handle Tier 2 abilities.

## Test Results

```
Bone-Setter Tier 2 tests: 60
     Passed: 60
     Failed: 0

Breakdown:
  BoneSetterAbilityServiceTests:       42 application tests (16 T1 + 26 T2)
  EmergencySurgeryResultTests:          6 domain tests
  AntidoteCraftResultTests:             5 domain tests
  CraftingMaterialTests:                7 domain tests
```
