# v0.4.2: Factions & Dialogue (The Society)

**Status:** Planning Complete
**Theme:** "The Society"
**Scope:** Faction reputation system, branching dialogue engine, skill-gated conversations, TUI integration
**Depends On:** v0.4.1 (Specializations), v0.4.0 (Saga Progression)

---

## Executive Summary

v0.4.2 introduces the **social fabric** of the Rune & Rust world. Players build reputation with factions (Iron-Banes, Dvergr, The Bound, The Faceless), engage in branching dialogues with NPCs, and unlock conversation options through skill checks and reputation thresholds.

**Key Features:**
- **Faction Reputation:** -100 to +100 scale with 5 disposition tiers (Hated → Exalted)
- **Disposition Events:** Threshold-crossing triggers for game state changes
- **Dialogue Engine:** Node-based branching conversations with conditional options
- **Skill Checks:** Attribute-gated dialogue (e.g., [WITS 6] "I notice your limp...")
- **Effect Execution:** Dialogue choices that modify reputation, give items, start quests
- **TUI Integration:** Full dialogue screen with typewriter effect and selection prompts

**Layers Touched:** Core (Enums, Entities, Models, Events, Interfaces), Engine (Services, Repositories), Terminal (Renderers, Controllers), Persistence (Migrations, Seeding), Tests
**Patterns Used:** Event-driven state, Result records, Condition evaluation, Join tables
**Target Test Count:** ~180 tests across all sub-versions

---

## Sub-Version Breakdown

| Version | Codename | Focus | Estimated Tests | Complexity |
|---------|----------|-------|-----------------|------------|
| v0.4.2a | The Repute | Faction data models, service, events | 42 | Medium |
| v0.4.2b | The Lexicon | Dialogue data models, condition system | 48 | High |
| v0.4.2c | The Voice | Dialogue service, effect execution | 45 | High |
| v0.4.2d | The Parley | TUI rendering, controller, game loop integration | 35 | Medium |
| v0.4.2e | The Archive | Seeding, sample NPCs, integration tests | 12 | Low |

---

## v0.4.2a: The Repute (Faction System Core)

**Goal:** Implement faction data structures, the FactionService for reputation management, and disposition change events.

### Scope
- Define `FactionType` and `Disposition` enums
- Create `Faction` entity with metadata (name, description, default disposition)
- Create `CharacterFactionStanding` join entity for Character ↔ Faction relationships
- Implement `IFactionService` with reputation modification and disposition calculation
- Publish `DispositionChangedEvent` when thresholds are crossed
- Add Character extension methods for reputation access

### Decision Trees

#### Modify Reputation Flow
```
ModifyReputation(character, faction, amount)
                │
                ▼
    ┌───────────────────────────────┐
    │ Get current reputation value  │
    │ (default 0 if not set)        │
    └───────────────────────────────┘
                │
                ▼
    ┌───────────────────────────────┐
    │ Calculate new value:          │
    │ newValue = current + amount   │
    └───────────────────────────────┘
                │
                ▼
    ┌───────────────────────────────┐
    │ Clamp to [-100, +100]         │
    └───────────────────────────────┘
                │
                ▼
    ┌───────────────────────────────┐
    │ Get oldDisposition from       │
    │ current value                 │
    └───────────────────────────────┘
                │
                ▼
    ┌───────────────────────────────┐
    │ Get newDisposition from       │
    │ clamped value                 │
    └───────────────────────────────┘
                │
                ▼
    ┌───────────────────────────────┐
    │ Persist new reputation value  │
    └───────────────────────────────┘
                │
                ▼
    ┌───────────────────────────────┐
    │ oldDisposition != new?        │
    └───────────────────────────────┘
                │
        ┌───────┴───────┐
       Yes              No
        │                │
        ▼                ▼
┌─────────────────┐  ┌─────────────────┐
│ Publish         │  │ Log reputation  │
│ Disposition     │  │ change only     │
│ ChangedEvent    │  │                 │
└─────────────────┘  └─────────────────┘
                │
                ▼
    ┌───────────────────────────────┐
    │ Return ReputationChangeResult │
    └───────────────────────────────┘
```

#### Get Disposition Flow
```
GetDisposition(reputationValue)
                │
                ▼
    ┌───────────────────────────────┐
    │ value <= -50?                 │──Yes──► Return Hated
    └───────────────────────────────┘
                │ No
                ▼
    ┌───────────────────────────────┐
    │ value <= -10?                 │──Yes──► Return Hostile
    └───────────────────────────────┘
                │ No
                ▼
    ┌───────────────────────────────┐
    │ value <= 9?                   │──Yes──► Return Neutral
    └───────────────────────────────┘
                │ No
                ▼
    ┌───────────────────────────────┐
    │ value <= 49?                  │──Yes──► Return Friendly
    └───────────────────────────────┘
                │ No
                ▼
    ┌───────────────────────────────┐
    │ Return Exalted                │
    └───────────────────────────────┘
```

### Deliverable Checklist

#### New Files to Create

| Layer | File Path | Purpose |
|-------|-----------|---------|
| Core | `RuneAndRust.Core/Enums/FactionType.cs` | Enum: IronBanes, Dvergr, TheBound, TheFaceless |
| Core | `RuneAndRust.Core/Enums/Disposition.cs` | Enum: Hated, Hostile, Neutral, Friendly, Exalted |
| Core | `RuneAndRust.Core/Entities/Faction.cs` | Faction metadata entity |
| Core | `RuneAndRust.Core/Entities/CharacterFactionStanding.cs` | Join entity for reputation |
| Core | `RuneAndRust.Core/Models/ReputationChangeResult.cs` | Result record |
| Core | `RuneAndRust.Core/Events/DispositionChangedEvent.cs` | Event record |
| Core | `RuneAndRust.Core/Events/ReputationChangedEvent.cs` | Event record |
| Core | `RuneAndRust.Core/Interfaces/IFactionService.cs` | Service interface |
| Core | `RuneAndRust.Core/Interfaces/IFactionRepository.cs` | Repository interface |
| Engine | `RuneAndRust.Engine/Services/FactionService.cs` | Service implementation |
| Persistence | `RuneAndRust.Persistence/Repositories/FactionRepository.cs` | Repository implementation |
| Tests | `RuneAndRust.Tests/Engine/FactionServiceTests.cs` | 42 unit tests |

#### Files to Modify

| File | Change |
|------|--------|
| `RuneAndRust.Core/Entities/Character.cs` | Add `ICollection<CharacterFactionStanding> FactionStandings` navigation |
| `RuneAndRust.Persistence/RuneAndRustDbContext.cs` | Add `DbSet<Faction>`, `DbSet<CharacterFactionStanding>` |
| `RuneAndRust.Terminal/Program.cs` | Register FactionService, FactionRepository |

### Key Models

#### FactionType Enum
```csharp
namespace RuneAndRust.Core.Enums;

/// <summary>
/// Canonical faction identifiers in Aethelgard.
/// </summary>
/// <remarks>See: v0.4.2a (The Repute) for Faction System implementation.</remarks>
public enum FactionType
{
    /// <summary>Scavenger clans of the upper ruins.</summary>
    IronBanes = 0,

    /// <summary>Deep-dwelling master smiths and artificers.</summary>
    Dvergr = 1,

    /// <summary>Cultists devoted to the Glitch. Generally hostile.</summary>
    TheBound = 2,

    /// <summary>Mysterious masked traders with unknown allegiances.</summary>
    TheFaceless = 3
}
```

#### Disposition Enum
```csharp
namespace RuneAndRust.Core.Enums;

/// <summary>
/// Faction disposition tiers based on reputation value.
/// </summary>
/// <remarks>See: v0.4.2a (The Repute) for Faction System implementation.</remarks>
public enum Disposition
{
    /// <summary>-100 to -50: Attack on sight, no trade.</summary>
    Hated = 0,

    /// <summary>-49 to -10: Refuse dialogue, threatening.</summary>
    Hostile = 1,

    /// <summary>-9 to +9: Indifferent, basic services.</summary>
    Neutral = 2,

    /// <summary>+10 to +49: Better prices, extra dialogue.</summary>
    Friendly = 3,

    /// <summary>+50 to +100: Unique items, special quests.</summary>
    Exalted = 4
}
```

#### CharacterFactionStanding Entity
```csharp
namespace RuneAndRust.Core.Entities;

/// <summary>
/// Join entity tracking a character's reputation with a faction.
/// </summary>
/// <remarks>See: v0.4.2a (The Repute) for Faction System implementation.</remarks>
public class CharacterFactionStanding
{
    #region Keys
    public Guid CharacterId { get; set; }
    public FactionType FactionType { get; set; }
    #endregion

    #region Properties
    /// <summary>Reputation value from -100 (Hated) to +100 (Exalted).</summary>
    public int Reputation { get; set; } = 0;

    /// <summary>When this standing was first established.</summary>
    public DateTime CreatedAt { get; set; } = DateTime.UtcNow;

    /// <summary>When this standing was last modified.</summary>
    public DateTime LastModifiedAt { get; set; } = DateTime.UtcNow;
    #endregion

    #region Navigation
    public Character Character { get; set; } = null!;
    #endregion
}
```

#### ReputationChangeResult
```csharp
namespace RuneAndRust.Core.Models;

/// <summary>
/// Result of a reputation modification operation.
/// </summary>
/// <remarks>See: v0.4.2a (The Repute) for Faction System implementation.</remarks>
public record ReputationChangeResult(
    bool Success,
    string Message,
    FactionType Faction,
    int OldValue,
    int NewValue,
    Disposition OldDisposition,
    Disposition NewDisposition,
    bool DispositionChanged)
{
    public static ReputationChangeResult Ok(
        FactionType faction, int oldVal, int newVal,
        Disposition oldDisp, Disposition newDisp) => new(
            true,
            newVal > oldVal
                ? $"Reputation with {faction} increased to {newVal}."
                : $"Reputation with {faction} decreased to {newVal}.",
            faction, oldVal, newVal, oldDisp, newDisp, oldDisp != newDisp);

    public static ReputationChangeResult NoChange(FactionType faction, int value, Disposition disp) => new(
        true, $"Reputation with {faction} unchanged at {value}.",
        faction, value, value, disp, disp, false);
}
```

### Logging Matrix

| Event | Level | Template |
|-------|-------|----------|
| ModifyRep entry | Trace | `[Faction] ModifyReputation: {CharName}, {Faction}, Amount={Amount}` |
| Rep clamped | Debug | `[Faction] Reputation clamped: {RawValue} → {ClampedValue}` |
| Rep changed | Info | `[Faction] {CharName} rep with {Faction}: {OldVal} → {NewVal}` |
| Disposition changed | Info | `[Faction] {CharName} now {NewDisp} with {Faction} (was {OldDisp})` |
| Event published | Debug | `[Faction] DispositionChangedEvent published: {CharName}, {Faction}` |
| GetDisposition | Trace | `[Faction] GetDisposition({Value}) = {Disposition}` |
| GetReputation | Trace | `[Faction] GetReputation({CharName}, {Faction}) = {Value}` |

### Test Coverage (42 tests)

#### ModifyReputation Tests (16 tests)
| Test Name | Description |
|-----------|-------------|
| `ModifyReputation_IncreasesValue_WhenPositiveAmount` | Basic increase |
| `ModifyReputation_DecreasesValue_WhenNegativeAmount` | Basic decrease |
| `ModifyReputation_ClampsToMax_When ExceedsUpperBound` | Clamp at +100 |
| `ModifyReputation_ClampsToMin_WhenExceedsLowerBound` | Clamp at -100 |
| `ModifyReputation_InitializesAtZero_WhenFirstInteraction` | Default standing |
| `ModifyReputation_PublishesEvent_WhenDispositionChanges` | Event on threshold |
| `ModifyReputation_NoEvent_WhenDispositionUnchanged` | No event if same tier |
| `ModifyReputation_UpdatesLastModified` | Timestamp update |
| `ModifyReputation_ReturnsCorrectOldNewValues` | Result accuracy |
| `ModifyReputation_HandlesZeroAmount` | No-op case |
| `ModifyReputation_HandlesExactThreshold_Neutral_ToFriendly` | Edge: 9→10 |
| `ModifyReputation_HandlesExactThreshold_Friendly_ToNeutral` | Edge: 10→9 |
| `ModifyReputation_HandlesExactThreshold_Hostile_ToHated` | Edge: -10→-50 |
| `ModifyReputation_MultipleFactions_Independent` | Per-faction tracking |
| `ModifyReputation_LogsAtCorrectLevels` | Logging verification |
| `ModifyReputation_PersistsToRepository` | Repository called |

#### GetDisposition Tests (10 tests)
| Test Name | Description |
|-----------|-------------|
| `GetDisposition_ReturnsHated_WhenNegative100` | Boundary: -100 |
| `GetDisposition_ReturnsHated_WhenNegative50` | Threshold: -50 |
| `GetDisposition_ReturnsHostile_WhenNegative49` | Boundary: -49 |
| `GetDisposition_ReturnsHostile_WhenNegative10` | Threshold: -10 |
| `GetDisposition_ReturnsNeutral_WhenNegative9` | Boundary: -9 |
| `GetDisposition_ReturnsNeutral_WhenZero` | Default: 0 |
| `GetDisposition_ReturnsNeutral_WhenPositive9` | Threshold: 9 |
| `GetDisposition_ReturnsFriendly_WhenPositive10` | Boundary: 10 |
| `GetDisposition_ReturnsFriendly_WhenPositive49` | Threshold: 49 |
| `GetDisposition_ReturnsExalted_WhenPositive50OrMore` | Boundary: 50+ |

#### GetReputation Tests (6 tests)
| Test Name | Description |
|-----------|-------------|
| `GetReputation_ReturnsZero_WhenNoStanding` | Default value |
| `GetReputation_ReturnsStoredValue_WhenExists` | Retrieval |
| `GetReputation_ReturnsCorrectFaction_WhenMultiple` | Multi-faction |
| `GetAllReputations_ReturnsEmpty_WhenNone` | Empty dictionary |
| `GetAllReputations_ReturnsAll_WhenMultiple` | Full dictionary |
| `GetFactionDisposition_ReturnsCombined` | Helper method |

#### Event Tests (6 tests)
| Test Name | Description |
|-----------|-------------|
| `DispositionChangedEvent_ContainsCorrectData` | Event payload |
| `DispositionChangedEvent_Direction_Improved` | Positive change |
| `DispositionChangedEvent_Direction_Degraded` | Negative change |
| `ReputationChangedEvent_Published_OnEveryChange` | Always fires |
| `ReputationChangedEvent_ContainsAmount` | Delta in event |
| `EventBus_Receives_BothEvents_WhenDispositionChanges` | Dual publish |

#### Character Extension Tests (4 tests)
| Test Name | Description |
|-----------|-------------|
| `Character_GetReputation_DelegatesToService` | Extension method |
| `Character_IsHostileTo_ReturnsTrue_WhenHatedOrHostile` | Convenience |
| `Character_IsFriendlyWith_ReturnsTrue_WhenFriendlyOrExalted` | Convenience |
| `Character_FactionStandings_NavigationWorks` | EF navigation |

---

## v0.4.2b: The Lexicon (Dialogue Data Models & Conditions)

**Goal:** Define dialogue tree data structures, the condition evaluation system, and the polymorphic condition types.

### Scope
- Create `DialogueTree`, `DialogueNode`, `DialogueOption` entities
- Design `DialogueCondition` polymorphic hierarchy (attribute checks, level checks, reputation checks, flag checks)
- Implement `IDialogueConditionEvaluator` service for condition validation
- Create `DialogueConditionResult` for detailed feedback
- Define visibility modes (Hidden vs Locked-with-reason)

### Key Entities

#### DialogueTree
```csharp
public class DialogueTree
{
    public Guid Id { get; set; } = Guid.NewGuid();
    public string TreeId { get; set; } = string.Empty;  // e.g., "npc_old_scavenger"
    public string NpcName { get; set; } = string.Empty;
    public string NpcTitle { get; set; } = string.Empty; // e.g., "Iron-Bane Elder"
    public Guid RootNodeId { get; set; }
    public FactionType? AssociatedFaction { get; set; }
    public ICollection<DialogueNode> Nodes { get; set; } = new List<DialogueNode>();
}
```

#### DialogueNode
```csharp
public class DialogueNode
{
    public Guid Id { get; set; } = Guid.NewGuid();
    public Guid TreeId { get; set; }
    public string NodeId { get; set; } = string.Empty;  // e.g., "greeting", "quest_offer"
    public string SpeakerName { get; set; } = string.Empty;
    public string Text { get; set; } = string.Empty;
    public bool IsTerminal { get; set; } = false;  // Ends conversation
    public ICollection<DialogueOption> Options { get; set; } = new List<DialogueOption>();
}
```

#### DialogueOption
```csharp
public class DialogueOption
{
    public Guid Id { get; set; } = Guid.NewGuid();
    public Guid NodeId { get; set; }
    public string Text { get; set; } = string.Empty;
    public string? NextNodeId { get; set; }  // null for terminal options
    public int DisplayOrder { get; set; } = 0;
    public OptionVisibility VisibilityMode { get; set; } = OptionVisibility.Visible;
    public List<DialogueCondition> Conditions { get; set; } = new();
    public List<DialogueEffect> Effects { get; set; } = new();
}
```

#### DialogueCondition (Polymorphic)
```csharp
public abstract class DialogueCondition
{
    public ConditionType Type { get; set; }
    public bool IsHiddenWhenFailed { get; set; } = false;
}

public class AttributeCondition : DialogueCondition
{
    public CharacterAttribute Attribute { get; set; }
    public int MinValue { get; set; }
}

public class ReputationCondition : DialogueCondition
{
    public FactionType Faction { get; set; }
    public Disposition MinDisposition { get; set; }
}

public class LevelCondition : DialogueCondition
{
    public int MinLevel { get; set; }
}

public class FlagCondition : DialogueCondition
{
    public string FlagKey { get; set; } = string.Empty;
    public bool RequiredValue { get; set; } = true;
}
```

### Estimated Test Count: 48 tests

---

## v0.4.2c: The Voice (Dialogue Service & Effects)

**Goal:** Implement the DialogueService for conversation flow management and the effect execution system.

### Scope
- Create `IDialogueService` with StartDialogue, SelectOption, GetCurrentState
- Implement `DialogueState` tracking (current node, visited nodes, session context)
- Create `IDialogueEffectExecutor` for executing effects on selection
- Define `DialogueEffect` types (ModifyReputation, GiveItem, SetFlag, StartQuest)
- Integrate with FactionService for reputation effects

### Key Methods

```csharp
public interface IDialogueService
{
    Task<DialogueSessionResult> StartDialogueAsync(Character character, string npcId);
    Task<DialogueStepResult> SelectOptionAsync(Guid optionId);
    Task<DialogueExitResult> EndDialogueAsync();
    DialogueViewModel GetCurrentState();
    bool IsInDialogue { get; }
}
```

### Estimated Test Count: 45 tests

---

## v0.4.2d: The Parley (UI & Game Loop Integration)

**Goal:** Integrate dialogue into the game loop with a full TUI implementation.

### Scope
- Add `GamePhase.Dialogue` to state machine
- Create `DialogueController` for input handling
- Create `DialogueScreenRenderer` with Spectre.Console
- Implement `talk [npc]` command in exploration
- Add typewriter effect for NPC text
- Handle locked option display with requirement tooltips

### UI Layout

```
┌─────────────────────────────────────────────────────────────────┐
│                    ✦ OLD SCAVENGER ✦                            │
│                      Iron-Bane Elder                            │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  "Aye, newcomer. The upper halls ain't what they used to be.   │
│   The iron-walkers stir more often now. You seeking work, or   │
│   just passing through?"                                        │
│                                                                 │
├─────────────────────────────────────────────────────────────────┤
│  > 1. "I'm looking for work."                                   │
│    2. "What can you tell me about this place?"                  │
│    3. [WITS 6] "I noticed the tremors. Something's changed."    │
│    4. [LOCKED: Friendly] "I'd like to trade supplies."          │
│    5. "I should go."                                            │
└─────────────────────────────────────────────────────────────────┘
  ↑↓ Select  │  Enter: Choose  │  Esc: Leave
```

### Estimated Test Count: 35 tests

---

## v0.4.2e: The Archive (Seeding & Integration)

**Goal:** Seed sample NPCs, create integration tests, and validate full conversation flows.

### Scope
- Seed 4 faction definitions with metadata
- Create sample dialogue trees (Old Scavenger, Dvergr Smith)
- Integration tests for full conversation journeys
- Validate reputation → disposition → dialogue option visibility chain

### Estimated Test Count: 12 tests

---

## Cross-Version Logging Matrix

| System | Event | Level | Template |
|--------|-------|-------|----------|
| Faction | Rep change | Info | `[Faction] {CharName} rep with {Faction}: {OldVal} → {NewVal}` |
| Faction | Disposition | Info | `[Faction] {CharName} now {Status} with {Faction}` |
| Dialogue | Start | Info | `[Dialogue] Started with {NpcName} (Tree: {TreeId})` |
| Dialogue | Node visit | Debug | `[Dialogue] Entered node '{NodeId}'` |
| Dialogue | Option select | Debug | `[Dialogue] Selected '{OptionText}' → {NextNodeId}` |
| Dialogue | Condition check | Trace | `[Dialogue] Condition {Type}: {Result} ({Details})` |
| Dialogue | Effect execute | Info | `[Dialogue] Effect: {EffectType} ({Details})` |
| Dialogue | End | Info | `[Dialogue] Ended conversation with {NpcName}` |

---

## Database Migrations

### v0.4.2a Migration: Factions
```sql
-- V0.4.2a__Faction_System.sql

CREATE TABLE factions (
    faction_type INTEGER PRIMARY KEY,
    name TEXT NOT NULL,
    description TEXT,
    default_disposition INTEGER NOT NULL DEFAULT 2,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

CREATE TABLE character_faction_standings (
    character_id UUID NOT NULL REFERENCES characters(id) ON DELETE CASCADE,
    faction_type INTEGER NOT NULL,
    reputation INTEGER NOT NULL DEFAULT 0 CHECK (reputation >= -100 AND reputation <= 100),
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    last_modified_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    PRIMARY KEY (character_id, faction_type)
);

CREATE INDEX idx_standings_character ON character_faction_standings(character_id);
CREATE INDEX idx_standings_faction ON character_faction_standings(faction_type);
```

### v0.4.2b Migration: Dialogue
```sql
-- V0.4.2b__Dialogue_System.sql

CREATE TABLE dialogue_trees (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    tree_id TEXT NOT NULL UNIQUE,
    npc_name TEXT NOT NULL,
    npc_title TEXT,
    root_node_id UUID NOT NULL,
    associated_faction INTEGER,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

CREATE TABLE dialogue_nodes (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    tree_id UUID NOT NULL REFERENCES dialogue_trees(id) ON DELETE CASCADE,
    node_id TEXT NOT NULL,
    speaker_name TEXT NOT NULL,
    text TEXT NOT NULL,
    is_terminal BOOLEAN NOT NULL DEFAULT FALSE,
    UNIQUE(tree_id, node_id)
);

CREATE TABLE dialogue_options (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    node_id UUID NOT NULL REFERENCES dialogue_nodes(id) ON DELETE CASCADE,
    text TEXT NOT NULL,
    next_node_id TEXT,
    display_order INTEGER NOT NULL DEFAULT 0,
    visibility_mode INTEGER NOT NULL DEFAULT 0,
    conditions JSONB DEFAULT '[]',
    effects JSONB DEFAULT '[]'
);

CREATE INDEX idx_nodes_tree ON dialogue_nodes(tree_id);
CREATE INDEX idx_options_node ON dialogue_options(node_id);
```

---

## Implementation Order

1. **v0.4.2a** - Faction foundation (no dependencies)
2. **v0.4.2b** - Dialogue models (requires v0.4.2a for ReputationCondition)
3. **v0.4.2c** - Dialogue service (requires v0.4.2a + v0.4.2b)
4. **v0.4.2d** - UI integration (requires v0.4.2c)
5. **v0.4.2e** - Seeding and integration tests (requires all above)

---

## Design Decisions

### Why Signed Integer (-100 to +100) for Reputation?

**Problem:** Need a reputation system that supports both positive and negative relationships.

**Decision:** Single signed integer with symmetric range.

**Rationale:**
- Intuitive for designers and players
- Zero as neutral baseline
- Symmetric positive/negative allows "fall from grace" narratives
- Easy clamping with Math.Clamp
- Direct mapping to 5 disposition tiers

### Why Polymorphic Conditions vs. Unified Condition Table?

**Problem:** Conditions need different data (attribute checks need attribute + threshold; reputation checks need faction + disposition).

**Decision:** Polymorphic hierarchy with base `DialogueCondition` and derived types.

**Rationale:**
- Type-safe evaluation in C#
- JSONB storage in PostgreSQL handles polymorphism
- Extensible for future condition types (quest state, time of day)
- Clear switch expression in evaluator

### Why JSONB for Conditions/Effects Instead of Join Tables?

**Problem:** Dialogue options have variable numbers of conditions and effects with heterogeneous data.

**Decision:** Store as JSONB arrays in PostgreSQL.

**Rationale:**
- Avoids complex join table hierarchy
- Supports polymorphic condition types naturally
- Easy deserialization to C# collections
- Atomic updates (whole array replaced)
- Good query performance with GIN indexes if needed

### Why Separate Dialogue Phase vs. Modal Overlay?

**Problem:** Dialogue needs exclusive input handling but shouldn't lose exploration context.

**Decision:** Dedicated `GamePhase.Dialogue` that suspends exploration commands.

**Rationale:**
- Consistent with existing SagaMenu and SpecializationMenu patterns
- Clear state machine transitions
- Input isolation prevents accidental movement during dialogue
- Easy to return to previous phase on exit

---

## Risk Assessment

| Risk | Likelihood | Impact | Mitigation |
|------|------------|--------|------------|
| Complex condition evaluation logic | Medium | High | Extensive unit tests per condition type |
| Dialogue tree data authoring | High | Medium | JSON schema validation, sample templates |
| Performance with large dialogue trees | Low | Low | Lazy loading of nodes, caching |
| UI complexity with locked options | Medium | Medium | Start with simple locked display, iterate |
| Effect execution side effects | Medium | High | Transaction wrapping, rollback on failure |

---

## Next Steps After v0.4.2

- **v0.4.3:** Quest System (integrates with dialogue for quest triggers)
- **v0.4.4:** Trading System (uses faction disposition for prices)
- **v0.4.5:** World Events (faction-wide state changes)

---

## Appendix A: Disposition Threshold Reference

| Disposition | Min Rep | Max Rep | Behavior |
|-------------|---------|---------|----------|
| Hated | -100 | -50 | Attack on sight, no services |
| Hostile | -49 | -10 | Refuses dialogue, threatening |
| Neutral | -9 | +9 | Basic services, standard prices |
| Friendly | +10 | +49 | Discounts, extra dialogue options |
| Exalted | +50 | +100 | Unique items, special quests |

---

## Appendix B: Condition Type Reference

| Type | Parameters | Example |
|------|------------|---------|
| Attribute | Attribute, MinValue | `[WITS >= 6]` |
| Level | MinLevel | `[Level >= 5]` |
| Reputation | Faction, MinDisposition | `[Iron-Banes: Friendly]` |
| Flag | FlagKey, RequiredValue | `[HasCompletedTutorial]` |
| Item | ItemId, MinQuantity | `[Has: Iron Key]` |
| Specialization | SpecId | `[Is: Berserkr]` |
| Node | SpecNodeId | `[Has: Rage ability]` |

---

## Appendix C: Effect Type Reference

| Type | Parameters | Example |
|------|------------|---------|
| ModifyReputation | Faction, Amount | `+10 with Iron-Banes` |
| GiveItem | ItemId, Quantity | `Give: Rusty Key x1` |
| RemoveItem | ItemId, Quantity | `Remove: Gold x50` |
| SetFlag | FlagKey, Value | `Set: MetOldScavenger = true` |
| StartQuest | QuestId | `Start: quest_iron_bane_intro` |
| TriggerCombat | EncounterId | `Combat: ambush_bound_cultist` |
| Heal | Amount | `Heal: 10 HP` |
| GiveXP | Amount | `Grant: 50 Legend` |
