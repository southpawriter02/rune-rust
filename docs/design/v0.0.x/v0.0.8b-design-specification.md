# v0.0.8b Design Specification: Level-Up Mechanics

**Version:** 0.0.8b
**Parent:** v0.0.8 (Experience & Leveling)
**Prerequisites:** v0.0.8a Complete (Core Experience System)
**Status:** Design Complete

---

## Table of Contents

1. [Overview](#overview)
2. [Scope](#scope)
3. [Data Model](#data-model)
4. [Services](#services)
5. [Command Changes](#command-changes)
6. [Rendering Changes](#rendering-changes)
7. [Configuration](#configuration)
8. [Acceptance Criteria](#acceptance-criteria)
9. [Test Specifications](#test-specifications)
10. [Dependencies](#dependencies)

---

## Overview

### Purpose

Implement level-up detection, stat increases on level-up, and level-up notifications. This phase builds on the XP tracking infrastructure from v0.0.8a and integrates with the existing ability unlock system from v0.0.4c. When a player accumulates enough XP to reach the next level threshold, the system automatically levels them up, applies stat bonuses, checks for newly unlocked abilities, and displays a celebratory notification.

### Key Changes

| Area | Current State (v0.0.8a) | Target State (v0.0.8b) |
|------|------------------------|------------------------|
| XP System | Tracks XP, displays progress | Triggers level-up at thresholds |
| Player Level | Manual `SetLevel()` only | Automatic level-up from XP |
| Player Stats | Static after creation | Increase on level-up |
| Abilities | Locked by UnlockLevel | Automatically unlocked on level-up |
| Combat Victory | Shows XP gain | Shows level-up notification if applicable |
| Status Display | Shows XP progress | Updates to show new stats after level-up |

### Design Principles

1. **Build on v0.0.8a**: Use existing `Experience`, `AddExperience()`, and `ExperienceToNextLevel` infrastructure
2. **Integrate with v0.0.4c**: Leverage existing `GetUnlockedAbilitiesAtLevel()` for ability unlocks
3. **Multi-Level Support**: Handle cases where enough XP is gained to skip levels
4. **Immediate Application**: Stats are updated immediately on level-up
5. **Full Heal on Level-Up**: Player health is restored to new maximum as a quality-of-life feature
6. **Future-Ready**: Default progression values will be configurable in v0.0.8c

---

## Scope

### In Scope

- `ProgressionService` for level-up detection and application
- `LevelUpResult` value object containing level-up details
- `StatModifiers` value object for representing stat changes
- Default level thresholds using `level * 100` formula from v0.0.8a
- Default stat increases per level: +5 MaxHealth, +1 Attack, +1 Defense
- Level-up detection after XP is added
- Multi-level gain support (e.g., gaining enough XP to go from level 1 to level 3)
- Stat application on level-up (modifying player's Stats)
- Health restoration to new maximum on level-up
- Ability unlock check using existing v0.0.4c `AbilityService.GetUnlockedAbilitiesAtLevel()`
- `LevelUpDto` for presenting level-up information to the UI
- Level-up notification display
- Update `IGameRenderer` with `RenderLevelUpAsync()`
- Implement level-up rendering in `SpectreGameRenderer`

### Out of Scope (Future Phases)

- Configurable XP terminology (v0.0.8c)
- Configurable progression curves (v0.0.8c)
- Class-specific stat bonuses (v0.0.8c)
- Custom level rewards (v0.0.8c)
- Maximum level cap configuration (v0.0.8c)
- Skill points or attribute allocation (future)
- Prestige/Rebirth system (future)

---

## Data Model

### New: LevelUpResult (Value Object)

```csharp
namespace RuneAndRust.Domain.ValueObjects;

/// <summary>
/// Represents the result of a level-up operation.
/// </summary>
/// <remarks>
/// Contains all information about what changed during the level-up,
/// including stat increases and newly unlocked abilities.
/// </remarks>
/// <param name="OldLevel">The player's level before the level-up.</param>
/// <param name="NewLevel">The player's level after the level-up.</param>
/// <param name="StatIncreases">The total stat increases applied.</param>
/// <param name="NewAbilities">List of ability IDs that were unlocked.</param>
public readonly record struct LevelUpResult(
    int OldLevel,
    int NewLevel,
    StatModifiers StatIncreases,
    IReadOnlyList<string> NewAbilities)
{
    /// <summary>
    /// Gets the number of levels gained in this level-up.
    /// </summary>
    public int LevelsGained => NewLevel - OldLevel;

    /// <summary>
    /// Gets whether multiple levels were gained at once.
    /// </summary>
    public bool IsMultiLevel => LevelsGained > 1;

    /// <summary>
    /// Gets whether any abilities were unlocked.
    /// </summary>
    public bool HasNewAbilities => NewAbilities.Count > 0;

    /// <summary>
    /// Creates a result for no level-up occurring.
    /// </summary>
    /// <param name="currentLevel">The player's current level.</param>
    /// <returns>A LevelUpResult indicating no change.</returns>
    public static LevelUpResult None(int currentLevel) =>
        new(currentLevel, currentLevel, StatModifiers.Zero, Array.Empty<string>());

    /// <summary>
    /// Gets whether a level-up actually occurred.
    /// </summary>
    public bool DidLevelUp => LevelsGained > 0;
}
```

### New: StatModifiers (Value Object)

```csharp
namespace RuneAndRust.Domain.ValueObjects;

/// <summary>
/// Represents a set of stat modifications that can be applied to a player.
/// </summary>
/// <remarks>
/// Used for level-up bonuses, equipment effects, and buff/debuff calculations.
/// All values are additive modifiers to base stats.
/// </remarks>
/// <param name="MaxHealth">The modifier to maximum health.</param>
/// <param name="Attack">The modifier to attack stat.</param>
/// <param name="Defense">The modifier to defense stat.</param>
public readonly record struct StatModifiers(
    int MaxHealth,
    int Attack,
    int Defense)
{
    /// <summary>
    /// A zero modifier that applies no changes.
    /// </summary>
    public static readonly StatModifiers Zero = new(0, 0, 0);

    /// <summary>
    /// The default stat increases per level.
    /// </summary>
    /// <remarks>
    /// +5 MaxHealth, +1 Attack, +1 Defense per level.
    /// Will be configurable in v0.0.8c.
    /// </remarks>
    public static readonly StatModifiers DefaultLevelUp = new(5, 1, 1);

    /// <summary>
    /// Gets whether any stats are modified.
    /// </summary>
    public bool HasModifications => MaxHealth != 0 || Attack != 0 || Defense != 0;

    /// <summary>
    /// Adds two stat modifiers together.
    /// </summary>
    /// <param name="other">The other modifier to add.</param>
    /// <returns>A new StatModifiers with combined values.</returns>
    public StatModifiers Add(StatModifiers other) =>
        new(MaxHealth + other.MaxHealth, Attack + other.Attack, Defense + other.Defense);

    /// <summary>
    /// Multiplies all stat modifiers by a factor.
    /// </summary>
    /// <param name="factor">The multiplication factor.</param>
    /// <returns>A new StatModifiers with scaled values.</returns>
    public StatModifiers Multiply(int factor) =>
        new(MaxHealth * factor, Attack * factor, Defense * factor);
}
```

### Modified: Player (Entity)

```csharp
// Add to existing Player entity in src/Core/RuneAndRust.Domain/Entities/Player.cs

/// <summary>
/// Applies stat modifiers to the player's stats.
/// </summary>
/// <param name="modifiers">The stat modifiers to apply.</param>
/// <param name="healToNewMax">Whether to heal to the new max health.</param>
/// <remarks>
/// Used during level-up to increase stats. When healToNewMax is true,
/// the player's current health is set to the new maximum.
/// </remarks>
public void ApplyStatModifiers(StatModifiers modifiers, bool healToNewMax = false)
{
    var newMaxHealth = Stats.MaxHealth + modifiers.MaxHealth;
    var newAttack = Stats.Attack + modifiers.Attack;
    var newDefense = Stats.Defense + modifiers.Defense;

    Stats = new Stats(newMaxHealth, newAttack, newDefense);

    if (healToNewMax)
    {
        Health = Stats.MaxHealth;
    }
}

/// <summary>
/// Gets the cumulative XP required to reach the specified level.
/// </summary>
/// <param name="level">The target level.</param>
/// <returns>The cumulative XP required.</returns>
/// <remarks>
/// Default formula: level * 100 (Level 2 = 200 XP, Level 3 = 300 XP).
/// Will be replaced with configurable curves in v0.0.8c.
/// </remarks>
public static int GetExperienceForLevel(int level)
{
    if (level <= 1) return 0;
    return level * 100;
}

/// <summary>
/// Gets what level the player should be at for a given XP amount.
/// </summary>
/// <param name="experience">The experience amount.</param>
/// <returns>The level corresponding to that experience.</returns>
public static int GetLevelForExperience(int experience)
{
    if (experience < 200) return 1;  // Level 2 requires 200 XP

    // level * 100 = XP, so level = XP / 100
    // But we need the highest level where XP >= threshold
    var level = experience / 100;
    return Math.Max(1, level);
}
```

---

## Services

### New: ProgressionService

```csharp
using Microsoft.Extensions.Logging;
using RuneAndRust.Domain.Entities;
using RuneAndRust.Domain.ValueObjects;

namespace RuneAndRust.Domain.Services;

/// <summary>
/// Service for managing player level progression.
/// </summary>
/// <remarks>
/// Handles level-up detection, stat increases, and ability unlocks.
/// Uses default progression values that will be configurable in v0.0.8c.
/// </remarks>
public class ProgressionService
{
    private readonly ILogger<ProgressionService> _logger;

    /// <summary>
    /// Creates a new ProgressionService instance.
    /// </summary>
    /// <param name="logger">The logger for progression operations.</param>
    public ProgressionService(ILogger<ProgressionService> logger)
    {
        _logger = logger;
    }

    /// <summary>
    /// Checks if the player should level up based on their current experience.
    /// </summary>
    /// <param name="player">The player to check.</param>
    /// <returns>A LevelUpResult if leveling up, or LevelUpResult.None if not.</returns>
    /// <exception cref="ArgumentNullException">Thrown when player is null.</exception>
    public LevelUpResult CheckForLevelUp(Player player)
    {
        ArgumentNullException.ThrowIfNull(player);

        var targetLevel = Player.GetLevelForExperience(player.Experience);

        if (targetLevel <= player.Level)
        {
            _logger.LogDebug(
                "No level up - Player {PlayerName} at level {Level} with {XP} XP",
                player.Name, player.Level, player.Experience);
            return LevelUpResult.None(player.Level);
        }

        var levelsGained = targetLevel - player.Level;
        var statIncreases = GetStatIncreasesForLevels(levelsGained);

        _logger.LogInformation(
            "Level up detected - Player {PlayerName}: Level {OldLevel} -> {NewLevel} " +
            "(+{HP} HP, +{ATK} ATK, +{DEF} DEF)",
            player.Name, player.Level, targetLevel,
            statIncreases.MaxHealth, statIncreases.Attack, statIncreases.Defense);

        return new LevelUpResult(
            player.Level,
            targetLevel,
            statIncreases,
            Array.Empty<string>()  // Abilities filled in by ApplyLevelUp
        );
    }

    /// <summary>
    /// Applies a level-up result to the player.
    /// </summary>
    /// <param name="player">The player to level up.</param>
    /// <param name="result">The level-up result to apply.</param>
    /// <param name="getAbilitiesAtLevel">Function to get abilities unlocked at a level.</param>
    /// <returns>The final LevelUpResult with unlocked abilities populated.</returns>
    /// <exception cref="ArgumentNullException">Thrown when player is null.</exception>
    public LevelUpResult ApplyLevelUp(
        Player player,
        LevelUpResult result,
        Func<int, IReadOnlyList<string>>? getAbilitiesAtLevel = null)
    {
        ArgumentNullException.ThrowIfNull(player);

        if (!result.DidLevelUp)
        {
            return result;
        }

        // Apply stat increases
        player.ApplyStatModifiers(result.StatIncreases, healToNewMax: true);

        // Update level
        player.SetLevel(result.NewLevel);

        // Check for newly unlocked abilities
        var unlockedAbilities = new List<string>();
        if (getAbilitiesAtLevel != null)
        {
            for (var level = result.OldLevel + 1; level <= result.NewLevel; level++)
            {
                var abilities = getAbilitiesAtLevel(level);
                unlockedAbilities.AddRange(abilities);
            }
        }

        _logger.LogInformation(
            "Level up applied - Player {PlayerName} is now level {Level}. " +
            "Stats: HP={HP}, ATK={ATK}, DEF={DEF}. Abilities unlocked: {AbilityCount}",
            player.Name, player.Level,
            player.Stats.MaxHealth, player.Stats.Attack, player.Stats.Defense,
            unlockedAbilities.Count);

        // Return updated result with abilities
        return new LevelUpResult(
            result.OldLevel,
            result.NewLevel,
            result.StatIncreases,
            unlockedAbilities);
    }

    /// <summary>
    /// Checks for level-up and applies it in one operation.
    /// </summary>
    /// <param name="player">The player to check and potentially level up.</param>
    /// <param name="getAbilitiesAtLevel">Function to get abilities unlocked at a level.</param>
    /// <returns>The LevelUpResult (DidLevelUp will be false if no level-up occurred).</returns>
    public LevelUpResult CheckAndApplyLevelUp(
        Player player,
        Func<int, IReadOnlyList<string>>? getAbilitiesAtLevel = null)
    {
        var result = CheckForLevelUp(player);

        if (!result.DidLevelUp)
        {
            return result;
        }

        return ApplyLevelUp(player, result, getAbilitiesAtLevel);
    }

    /// <summary>
    /// Gets the cumulative stat increases for gaining multiple levels.
    /// </summary>
    /// <param name="levelsGained">The number of levels gained.</param>
    /// <returns>The total stat increases.</returns>
    /// <remarks>
    /// Uses default values: +5 MaxHealth, +1 Attack, +1 Defense per level.
    /// Will be configurable in v0.0.8c.
    /// </remarks>
    public StatModifiers GetStatIncreasesForLevels(int levelsGained)
    {
        if (levelsGained <= 0)
        {
            return StatModifiers.Zero;
        }

        return StatModifiers.DefaultLevelUp.Multiply(levelsGained);
    }

    /// <summary>
    /// Gets the XP required for the next level.
    /// </summary>
    /// <param name="currentLevel">The current level.</param>
    /// <returns>The XP required to reach the next level.</returns>
    public int GetExperienceForNextLevel(int currentLevel)
    {
        return Player.GetExperienceForLevel(currentLevel + 1);
    }

    /// <summary>
    /// Gets the XP remaining until the next level.
    /// </summary>
    /// <param name="player">The player to check.</param>
    /// <returns>The XP needed to reach the next level.</returns>
    public int GetExperienceUntilNextLevel(Player player)
    {
        ArgumentNullException.ThrowIfNull(player);

        var nextLevelXp = Player.GetExperienceForLevel(player.Level + 1);
        return Math.Max(0, nextLevelXp - player.Experience);
    }
}
```

### Modified: ExperienceService

```csharp
// Update ExperienceService to integrate with ProgressionService
// In src/Core/RuneAndRust.Domain/Services/ExperienceService.cs

// Update AwardExperience to return information for level-up checking:

/// <summary>
/// Awards experience points to a player and returns the result.
/// </summary>
/// <param name="player">The player to award XP to.</param>
/// <param name="amount">The amount of XP to award.</param>
/// <param name="source">A description of where the XP came from.</param>
/// <returns>The result of the XP award operation.</returns>
/// <remarks>
/// This method only adds XP; level-up detection should be performed
/// by calling ProgressionService.CheckAndApplyLevelUp() after this.
/// </remarks>
public ExperienceGainResult AwardExperience(Player player, int amount, string source)
{
    // ... existing implementation unchanged ...
}
```

### Service Flow Diagram

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                      LEVEL-UP FLOW (After XP Award)                          │
└─────────────────────────────────────────────────────────────────────────────┘

    Monster Defeated → ExperienceService.AwardExperience()
                │
                ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                    STEP 1: CHECK FOR LEVEL UP                                │
├─────────────────────────────────────────────────────────────────────────────┤
│  ProgressionService.CheckForLevelUp(player)                                  │
│  ├── Get target level: Player.GetLevelForExperience(player.Experience)       │
│  ├── Compare to current level                                                │
│  ├── If targetLevel <= currentLevel → Return LevelUpResult.None              │
│  └── Otherwise → Calculate stat increases, return LevelUpResult              │
└─────────────────────────────────────────────────────────────────────────────┘
                │
                ▼ (if DidLevelUp)
┌─────────────────────────────────────────────────────────────────────────────┐
│                    STEP 2: APPLY LEVEL UP                                    │
├─────────────────────────────────────────────────────────────────────────────┤
│  ProgressionService.ApplyLevelUp(player, result, getAbilitiesAtLevel)        │
│  ├── player.ApplyStatModifiers(result.StatIncreases, healToNewMax: true)     │
│  ├── player.SetLevel(result.NewLevel)                                        │
│  ├── For each level gained:                                                  │
│  │   └── getAbilitiesAtLevel(level) → collect unlocked abilities             │
│  └── Return updated LevelUpResult with abilities                             │
└─────────────────────────────────────────────────────────────────────────────┘
                │
                ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                    STEP 3: CREATE DTO                                        │
├─────────────────────────────────────────────────────────────────────────────┤
│  LevelUpDto.FromResult(result, player, abilityNames)                         │
│  ├── OldLevel: 1                                                             │
│  ├── NewLevel: 2                                                             │
│  ├── StatIncreases: (+5 HP, +1 ATK, +1 DEF)                                  │
│  ├── OldStats / NewStats for display                                         │
│  ├── UnlockedAbilityNames: ["Shield Bash"]                                   │
│  └── XpToNextLevel: 100                                                      │
└─────────────────────────────────────────────────────────────────────────────┘
                │
                ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                    STEP 4: RENDER LEVEL UP                                   │
├─────────────────────────────────────────────────────────────────────────────┤
│  IGameRenderer.RenderLevelUpAsync(dto)                                       │
│  ├── ═══════════════════════════════════════════                            │
│  ├──            ★ LEVEL UP! ★                                               │
│  ├── ═══════════════════════════════════════════                            │
│  ├── You have reached Level 2!                                              │
│  ├──                                                                         │
│  ├── Stat Increases:                                                         │
│  ├──   Max Health: 100 → 105                                                │
│  ├──   Attack: 10 → 11                                                      │
│  ├──   Defense: 5 → 6                                                       │
│  ├──                                                                         │
│  ├── New Abilities Unlocked:                                                 │
│  ├──   • Shield Bash                                                        │
│  ├──                                                                         │
│  └── Next Level: 100 XP needed (Level 3)                                    │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## Command Changes

### No New Commands

v0.0.8b does not introduce any new player commands. Level-up is triggered automatically when XP is awarded (from combat victory) and the threshold is reached.

### Modified: Combat Flow

After a monster is defeated and XP is awarded, the system now checks for level-up:

```
> attack goblin

You attack the Goblin for 15 damage!
The Goblin has been defeated!

★ You gained 25 XP!
XP: 200/300 (66%)

═══════════════════════════════════════════
           ★ LEVEL UP! ★
═══════════════════════════════════════════
You have reached Level 2!

Stat Increases:
  Max Health: 100 → 105
  Attack: 10 → 11
  Defense: 5 → 6

Next Level: 100 XP needed (Level 3)
═══════════════════════════════════════════
```

---

## Rendering Changes

### New: LevelUpDto

```csharp
using RuneAndRust.Domain.ValueObjects;

namespace RuneAndRust.Application.DTOs;

/// <summary>
/// DTO for displaying level-up information to the UI.
/// </summary>
/// <param name="OldLevel">The player's previous level.</param>
/// <param name="NewLevel">The player's new level.</param>
/// <param name="LevelsGained">Number of levels gained.</param>
/// <param name="OldMaxHealth">Previous max health.</param>
/// <param name="NewMaxHealth">New max health.</param>
/// <param name="OldAttack">Previous attack stat.</param>
/// <param name="NewAttack">New attack stat.</param>
/// <param name="OldDefense">Previous defense stat.</param>
/// <param name="NewDefense">New defense stat.</param>
/// <param name="UnlockedAbilityNames">Names of newly unlocked abilities.</param>
/// <param name="XpToNextLevel">XP needed to reach the next level.</param>
public record LevelUpDto(
    int OldLevel,
    int NewLevel,
    int LevelsGained,
    int OldMaxHealth,
    int NewMaxHealth,
    int OldAttack,
    int NewAttack,
    int OldDefense,
    int NewDefense,
    IReadOnlyList<string> UnlockedAbilityNames,
    int XpToNextLevel)
{
    /// <summary>
    /// Gets whether multiple levels were gained.
    /// </summary>
    public bool IsMultiLevel => LevelsGained > 1;

    /// <summary>
    /// Gets whether any abilities were unlocked.
    /// </summary>
    public bool HasUnlockedAbilities => UnlockedAbilityNames.Count > 0;

    /// <summary>
    /// Creates a DTO from a LevelUpResult and player state.
    /// </summary>
    /// <param name="result">The level-up result.</param>
    /// <param name="oldStats">The player's stats before level-up.</param>
    /// <param name="newStats">The player's stats after level-up.</param>
    /// <param name="abilityNames">Names of unlocked abilities.</param>
    /// <param name="xpToNextLevel">XP needed for next level.</param>
    /// <returns>A DTO for rendering.</returns>
    public static LevelUpDto FromResult(
        LevelUpResult result,
        Stats oldStats,
        Stats newStats,
        IReadOnlyList<string> abilityNames,
        int xpToNextLevel) =>
        new(
            result.OldLevel,
            result.NewLevel,
            result.LevelsGained,
            oldStats.MaxHealth,
            newStats.MaxHealth,
            oldStats.Attack,
            newStats.Attack,
            oldStats.Defense,
            newStats.Defense,
            abilityNames,
            xpToNextLevel);
}
```

### Modified: IGameRenderer

```csharp
// Add to existing IGameRenderer interface in src/Core/RuneAndRust.Application/Interfaces/IGameRenderer.cs

/// <summary>
/// Renders level-up notification with stat increases and unlocked abilities.
/// </summary>
/// <param name="levelUp">The level-up information to display.</param>
/// <param name="ct">Cancellation token.</param>
/// <returns>A task representing the async operation.</returns>
Task RenderLevelUpAsync(LevelUpDto levelUp, CancellationToken ct = default);
```

### Modified: SpectreGameRenderer

```csharp
// Implement in src/Presentation/RuneAndRust.Presentation.Tui/Adapters/SpectreGameRenderer.cs

/// <inheritdoc />
public Task RenderLevelUpAsync(LevelUpDto levelUp, CancellationToken ct = default)
{
    var panel = new Panel(BuildLevelUpContent(levelUp))
    {
        Border = BoxBorder.Double,
        BorderStyle = new Style(Color.Yellow),
        Padding = new Padding(2, 1),
        Header = new PanelHeader("[bold yellow]★ LEVEL UP! ★[/]", Justify.Center)
    };

    AnsiConsole.WriteLine();
    AnsiConsole.Write(panel);
    AnsiConsole.WriteLine();

    return Task.CompletedTask;
}

private static string BuildLevelUpContent(LevelUpDto levelUp)
{
    var sb = new StringBuilder();

    // Level announcement
    if (levelUp.IsMultiLevel)
    {
        sb.AppendLine($"[bold]You gained {levelUp.LevelsGained} levels![/]");
        sb.AppendLine($"[dim]Level {levelUp.OldLevel} → Level {levelUp.NewLevel}[/]");
    }
    else
    {
        sb.AppendLine($"[bold]You have reached Level {levelUp.NewLevel}![/]");
    }

    sb.AppendLine();

    // Stat increases
    sb.AppendLine("[underline]Stat Increases:[/]");
    sb.AppendLine($"  Max Health: [dim]{levelUp.OldMaxHealth}[/] → [green]{levelUp.NewMaxHealth}[/] [dim](+{levelUp.NewMaxHealth - levelUp.OldMaxHealth})[/]");
    sb.AppendLine($"  Attack: [dim]{levelUp.OldAttack}[/] → [green]{levelUp.NewAttack}[/] [dim](+{levelUp.NewAttack - levelUp.OldAttack})[/]");
    sb.AppendLine($"  Defense: [dim]{levelUp.OldDefense}[/] → [green]{levelUp.NewDefense}[/] [dim](+{levelUp.NewDefense - levelUp.OldDefense})[/]");

    // Unlocked abilities
    if (levelUp.HasUnlockedAbilities)
    {
        sb.AppendLine();
        sb.AppendLine("[underline]New Abilities Unlocked:[/]");
        foreach (var ability in levelUp.UnlockedAbilityNames)
        {
            sb.AppendLine($"  [cyan]•[/] [bold]{ability}[/]");
        }
    }

    // Next level info
    sb.AppendLine();
    sb.AppendLine($"[dim]Next Level: {levelUp.XpToNextLevel} XP needed (Level {levelUp.NewLevel + 1})[/]");

    return sb.ToString();
}
```

### Modified: GameSessionService

```csharp
// Update combat handling in src/Core/RuneAndRust.Application/Services/GameSessionService.cs

// Add ProgressionService dependency:
private readonly ProgressionService _progressionService;

// Update constructor:
public GameSessionService(
    // ... existing dependencies ...
    ExperienceService experienceService,
    ProgressionService progressionService)
{
    // ... existing initialization ...
    _experienceService = experienceService;
    _progressionService = progressionService;
}

// Update HandleCombatResult to check for level-up after XP award:
private async Task HandleCombatResult(CombatResult result, Monster monster, CancellationToken ct)
{
    // ... existing combat result handling (render damage, defeat message) ...

    // Award XP if monster was defeated
    if (result.MonsterDefeated && result.ExperienceGained > 0)
    {
        var xpResult = _experienceService.AwardExperienceFromMonster(_session!.Player, monster);

        if (xpResult.DidGainExperience)
        {
            var xpDto = ExperienceGainDto.FromResult(
                xpResult,
                _session.Player.Level,
                _session.Player.ExperienceToNextLevel,
                _session.Player.ExperienceProgressPercent);

            await _renderer.RenderExperienceGainAsync(xpDto, ct);

            // Check for level-up
            await CheckAndHandleLevelUp(ct);
        }
    }
}

/// <summary>
/// Checks for level-up and renders notification if applicable.
/// </summary>
private async Task CheckAndHandleLevelUp(CancellationToken ct)
{
    var player = _session!.Player;
    var oldStats = player.Stats;

    // Function to get ability names for a level
    IReadOnlyList<string> GetAbilityNamesAtLevel(int level)
    {
        if (player.ClassId == null) return Array.Empty<string>();

        return _abilityService.GetUnlockedAbilitiesAtLevel(player.ClassId, level)
            .Select(a => a.Name)
            .ToList();
    }

    // Function to get ability IDs for unlocking
    IReadOnlyList<string> GetAbilityIdsAtLevel(int level)
    {
        if (player.ClassId == null) return Array.Empty<string>();

        return _abilityService.GetUnlockedAbilitiesAtLevel(player.ClassId, level)
            .Select(a => a.Id)
            .ToList();
    }

    var levelUpResult = _progressionService.CheckAndApplyLevelUp(player, GetAbilityIdsAtLevel);

    if (levelUpResult.DidLevelUp)
    {
        // Collect ability names for display
        var abilityNames = new List<string>();
        for (var level = levelUpResult.OldLevel + 1; level <= levelUpResult.NewLevel; level++)
        {
            abilityNames.AddRange(GetAbilityNamesAtLevel(level));
        }

        // Unlock abilities on the player
        foreach (var abilityId in levelUpResult.NewAbilities)
        {
            var ability = player.GetAbility(abilityId);
            if (ability != null && !ability.IsUnlocked)
            {
                ability.Unlock();
            }
        }

        var levelUpDto = LevelUpDto.FromResult(
            levelUpResult,
            oldStats,
            player.Stats,
            abilityNames,
            _progressionService.GetExperienceUntilNextLevel(player));

        await _renderer.RenderLevelUpAsync(levelUpDto, ct);
    }
}
```

### Display Examples

**Single Level-Up:**
```
═══════════════════════════════════════════
           ★ LEVEL UP! ★
═══════════════════════════════════════════
You have reached Level 2!

Stat Increases:
  Max Health: 100 → 105 (+5)
  Attack: 10 → 11 (+1)
  Defense: 5 → 6 (+1)

New Abilities Unlocked:
  • Shield Bash

Next Level: 100 XP needed (Level 3)
═══════════════════════════════════════════
```

**Multi-Level Gain:**
```
═══════════════════════════════════════════
           ★ LEVEL UP! ★
═══════════════════════════════════════════
You gained 2 levels!
Level 1 → Level 3

Stat Increases:
  Max Health: 100 → 110 (+10)
  Attack: 10 → 12 (+2)
  Defense: 5 → 7 (+2)

New Abilities Unlocked:
  • Shield Bash
  • Whirlwind

Next Level: 100 XP needed (Level 4)
═══════════════════════════════════════════
```

**No Abilities Unlocked:**
```
═══════════════════════════════════════════
           ★ LEVEL UP! ★
═══════════════════════════════════════════
You have reached Level 4!

Stat Increases:
  Max Health: 110 → 115 (+5)
  Attack: 12 → 13 (+1)
  Defense: 7 → 8 (+1)

Next Level: 100 XP needed (Level 5)
═══════════════════════════════════════════
```

---

## Configuration

*No configuration files are required for v0.0.8b. The level-up system uses hardcoded default values that will be replaced with configurable values in v0.0.8c.*

### Default Values

| Setting | Value | Notes |
|---------|-------|-------|
| XP Formula | `level * 100` | Level 2 = 200 XP, Level 3 = 300 XP, etc. |
| HP Bonus per Level | +5 | Applied cumulatively |
| Attack Bonus per Level | +1 | Applied cumulatively |
| Defense Bonus per Level | +1 | Applied cumulatively |
| Heal on Level-Up | Yes | Health restored to new maximum |
| Max Level | None | No cap in v0.0.8b (configurable in v0.0.8c) |

---

## Acceptance Criteria

### LevelUpResult Value Object

- [ ] Contains `OldLevel`, `NewLevel`, `StatIncreases`, and `NewAbilities` properties
- [ ] `LevelsGained` computed property returns correct difference
- [ ] `IsMultiLevel` returns true when more than one level gained
- [ ] `DidLevelUp` returns true when levels were gained
- [ ] `None()` factory method creates result with no level change

### StatModifiers Value Object

- [ ] Contains `MaxHealth`, `Attack`, `Defense` modifiers
- [ ] `Zero` static field provides zero-modification instance
- [ ] `DefaultLevelUp` provides +5 HP, +1 ATK, +1 DEF
- [ ] `Add()` combines two modifiers correctly
- [ ] `Multiply()` scales modifiers by factor

### Player Entity Updates

- [ ] `ApplyStatModifiers()` updates player stats correctly
- [ ] `ApplyStatModifiers()` with `healToNewMax: true` sets health to new max
- [ ] `GetExperienceForLevel()` returns correct XP thresholds
- [ ] `GetLevelForExperience()` returns correct level for XP amount

### ProgressionService

- [ ] `CheckForLevelUp()` detects when player should level up
- [ ] `CheckForLevelUp()` returns `None` when no level-up needed
- [ ] `ApplyLevelUp()` updates player level
- [ ] `ApplyLevelUp()` applies stat increases
- [ ] `ApplyLevelUp()` heals player to new max health
- [ ] `ApplyLevelUp()` collects unlocked abilities
- [ ] `CheckAndApplyLevelUp()` combines check and apply
- [ ] Multi-level gains are handled correctly (e.g., 1 → 3)
- [ ] Stat increases scale correctly for multi-level gains

### GameSessionService Integration

- [ ] Level-up check occurs after XP is awarded
- [ ] Level-up notification renders when level increases
- [ ] Abilities are unlocked on level-up

### Display

- [ ] Level-up notification shows old and new level
- [ ] Stat increases displayed with before/after values
- [ ] Unlocked abilities listed when applicable
- [ ] XP to next level shown at bottom
- [ ] Multi-level display shows levels gained count

### General

- [ ] ~18 unit tests pass
- [ ] Build completes with 0 errors
- [ ] Build completes with 0 warnings

---

## Test Specifications

### Unit Tests (~18 tests)

#### LevelUpResultTests.cs (~4 tests)

```csharp
[TestFixture]
public class LevelUpResultTests
{
    [Test]
    public void LevelsGained_ReturnsCorrectDifference()
    {
        var result = new LevelUpResult(1, 3, StatModifiers.DefaultLevelUp.Multiply(2), Array.Empty<string>());
        Assert.That(result.LevelsGained, Is.EqualTo(2));
    }

    [Test]
    public void IsMultiLevel_MultipleLevels_ReturnsTrue()
    {
        var result = new LevelUpResult(1, 3, StatModifiers.DefaultLevelUp.Multiply(2), Array.Empty<string>());
        Assert.That(result.IsMultiLevel, Is.True);
    }

    [Test]
    public void IsMultiLevel_SingleLevel_ReturnsFalse()
    {
        var result = new LevelUpResult(1, 2, StatModifiers.DefaultLevelUp, Array.Empty<string>());
        Assert.That(result.IsMultiLevel, Is.False);
    }

    [Test]
    public void None_ReturnsResultWithNoChange()
    {
        var result = LevelUpResult.None(5);
        Assert.That(result.DidLevelUp, Is.False);
        Assert.That(result.OldLevel, Is.EqualTo(5));
        Assert.That(result.NewLevel, Is.EqualTo(5));
    }
}
```

#### StatModifiersTests.cs (~4 tests)

```csharp
[TestFixture]
public class StatModifiersTests
{
    [Test]
    public void Zero_HasNoModifications()
    {
        Assert.That(StatModifiers.Zero.HasModifications, Is.False);
    }

    [Test]
    public void DefaultLevelUp_HasCorrectValues()
    {
        var defaults = StatModifiers.DefaultLevelUp;
        Assert.That(defaults.MaxHealth, Is.EqualTo(5));
        Assert.That(defaults.Attack, Is.EqualTo(1));
        Assert.That(defaults.Defense, Is.EqualTo(1));
    }

    [Test]
    public void Add_CombinesModifiers()
    {
        var a = new StatModifiers(5, 1, 1);
        var b = new StatModifiers(10, 2, 3);
        var result = a.Add(b);

        Assert.That(result.MaxHealth, Is.EqualTo(15));
        Assert.That(result.Attack, Is.EqualTo(3));
        Assert.That(result.Defense, Is.EqualTo(4));
    }

    [Test]
    public void Multiply_ScalesAllValues()
    {
        var modifiers = new StatModifiers(5, 1, 1);
        var result = modifiers.Multiply(3);

        Assert.That(result.MaxHealth, Is.EqualTo(15));
        Assert.That(result.Attack, Is.EqualTo(3));
        Assert.That(result.Defense, Is.EqualTo(3));
    }
}
```

#### PlayerLevelUpTests.cs (~4 tests)

```csharp
[TestFixture]
public class PlayerLevelUpTests
{
    private Player _player = null!;

    [SetUp]
    public void SetUp()
    {
        _player = new Player("TestPlayer", new Stats(100, 10, 5));
    }

    [Test]
    public void ApplyStatModifiers_IncreasesStats()
    {
        var modifiers = new StatModifiers(5, 1, 1);

        _player.ApplyStatModifiers(modifiers);

        Assert.That(_player.Stats.MaxHealth, Is.EqualTo(105));
        Assert.That(_player.Stats.Attack, Is.EqualTo(11));
        Assert.That(_player.Stats.Defense, Is.EqualTo(6));
    }

    [Test]
    public void ApplyStatModifiers_WithHealToMax_RestoresHealth()
    {
        _player.TakeDamage(50); // Damage player first
        var modifiers = new StatModifiers(5, 1, 1);

        _player.ApplyStatModifiers(modifiers, healToNewMax: true);

        Assert.That(_player.Health, Is.EqualTo(105)); // Full health at new max
    }

    [Test]
    public void GetExperienceForLevel_ReturnsCorrectThresholds()
    {
        Assert.That(Player.GetExperienceForLevel(1), Is.EqualTo(0));
        Assert.That(Player.GetExperienceForLevel(2), Is.EqualTo(200));
        Assert.That(Player.GetExperienceForLevel(3), Is.EqualTo(300));
        Assert.That(Player.GetExperienceForLevel(5), Is.EqualTo(500));
    }

    [Test]
    public void GetLevelForExperience_ReturnsCorrectLevel()
    {
        Assert.That(Player.GetLevelForExperience(0), Is.EqualTo(1));
        Assert.That(Player.GetLevelForExperience(199), Is.EqualTo(1));
        Assert.That(Player.GetLevelForExperience(200), Is.EqualTo(2));
        Assert.That(Player.GetLevelForExperience(350), Is.EqualTo(3));
    }
}
```

#### ProgressionServiceTests.cs (~6 tests)

```csharp
[TestFixture]
public class ProgressionServiceTests
{
    private ProgressionService _service = null!;
    private Player _player = null!;

    [SetUp]
    public void SetUp()
    {
        var loggerFactory = new NullLoggerFactory();
        _service = new ProgressionService(loggerFactory.CreateLogger<ProgressionService>());
        _player = new Player("TestPlayer", new Stats(100, 10, 5));
    }

    [Test]
    public void CheckForLevelUp_BelowThreshold_ReturnsNone()
    {
        _player.AddExperience(150); // Not enough for level 2

        var result = _service.CheckForLevelUp(_player);

        Assert.That(result.DidLevelUp, Is.False);
    }

    [Test]
    public void CheckForLevelUp_AtThreshold_ReturnsLevelUp()
    {
        _player.AddExperience(200); // Exactly level 2

        var result = _service.CheckForLevelUp(_player);

        Assert.That(result.DidLevelUp, Is.True);
        Assert.That(result.NewLevel, Is.EqualTo(2));
    }

    [Test]
    public void CheckForLevelUp_MultiLevel_ReturnsCorrectLevels()
    {
        _player.AddExperience(500); // Enough for level 5

        var result = _service.CheckForLevelUp(_player);

        Assert.That(result.DidLevelUp, Is.True);
        Assert.That(result.OldLevel, Is.EqualTo(1));
        Assert.That(result.NewLevel, Is.EqualTo(5));
        Assert.That(result.LevelsGained, Is.EqualTo(4));
    }

    [Test]
    public void ApplyLevelUp_UpdatesPlayerLevel()
    {
        _player.AddExperience(200);
        var result = _service.CheckForLevelUp(_player);

        _service.ApplyLevelUp(_player, result);

        Assert.That(_player.Level, Is.EqualTo(2));
    }

    [Test]
    public void ApplyLevelUp_AppliesStatIncreases()
    {
        _player.AddExperience(200);
        var result = _service.CheckForLevelUp(_player);

        _service.ApplyLevelUp(_player, result);

        Assert.That(_player.Stats.MaxHealth, Is.EqualTo(105));
        Assert.That(_player.Stats.Attack, Is.EqualTo(11));
        Assert.That(_player.Stats.Defense, Is.EqualTo(6));
    }

    [Test]
    public void ApplyLevelUp_HealsToNewMax()
    {
        _player.TakeDamage(50);
        _player.AddExperience(200);
        var result = _service.CheckForLevelUp(_player);

        _service.ApplyLevelUp(_player, result);

        Assert.That(_player.Health, Is.EqualTo(_player.Stats.MaxHealth));
    }
}
```

### Test Summary

| Test File | Test Count | Focus Areas |
|-----------|------------|-------------|
| `LevelUpResultTests.cs` | ~4 | Value object behavior, computed properties |
| `StatModifiersTests.cs` | ~4 | Modifier arithmetic, defaults |
| `PlayerLevelUpTests.cs` | ~4 | Player entity level-up methods |
| `ProgressionServiceTests.cs` | ~6 | Level-up detection, application, multi-level |
| **Total** | **~18** | |

---

## Dependencies

### Required from v0.0.8a (Core Experience System)

| Type | Location | Usage in this phase |
|------|----------|---------------------|
| `Player.Experience` | `Domain/Entities/Player.cs` | Used to determine target level |
| `Player.AddExperience()` | `Domain/Entities/Player.cs` | XP tracking (no changes needed) |
| `Player.ExperienceToNextLevel` | `Domain/Entities/Player.cs` | Used for display calculations |
| `Player.ExperienceProgressPercent` | `Domain/Entities/Player.cs` | Used for display calculations |
| `ExperienceService` | `Domain/Services/ExperienceService.cs` | Awards XP before level-up check |
| `ExperienceGainResult` | `Domain/ValueObjects/ExperienceGainResult.cs` | XP award result |
| `CombatResult.ExperienceGained` | `Domain/Services/CombatService.cs` | XP value on monster defeat |

### Required from v0.0.4c (Ability System)

| Type | Location | Usage in this phase |
|------|----------|---------------------|
| `AbilityService.GetUnlockedAbilitiesAtLevel()` | `Application/Services/AbilityService.cs` | Get abilities to unlock at level |
| `AbilityDefinition.UnlockLevel` | `Domain/Definitions/AbilityDefinition.cs` | Ability level requirements |
| `PlayerAbility.Unlock()` | `Domain/ValueObjects/PlayerAbility.cs` | Unlock ability for player |
| `Player.GetAbility()` | `Domain/Entities/Player.cs` | Access player's abilities |

### Required from Core Domain

| Type | Location | Usage in this phase |
|------|----------|---------------------|
| `Player` | `Domain/Entities/Player.cs` | Extended with ApplyStatModifiers, GetExperienceForLevel |
| `Player.Level` | `Domain/Entities/Player.cs` | Current level property |
| `Player.SetLevel()` | `Domain/Entities/Player.cs` | Update level after level-up |
| `Player.Stats` | `Domain/Entities/Player.cs` | Stats to modify on level-up |
| `Stats` | `Domain/ValueObjects/Stats.cs` | Stat values (MaxHealth, Attack, Defense) |
| `IGameRenderer` | `Application/Interfaces/IGameRenderer.cs` | Extended with RenderLevelUpAsync |
| `GameSessionService` | `Application/Services/GameSessionService.cs` | Integrates level-up check |

### Provides to v0.0.8c (Progression Configuration)

| Type | Usage |
|------|-------|
| `ProgressionService` | Replace default formulas with config-driven calculations |
| `StatModifiers` | Replace DefaultLevelUp with config-driven values |
| `LevelUpResult` | Extended with custom reward information |
| `Player.GetExperienceForLevel()` | Replace with config-driven thresholds |
| `Player.GetLevelForExperience()` | Replace with config-driven lookup |

---

## Files Summary

### Files to Create (New)

| File | Purpose |
|------|---------|
| `src/Core/RuneAndRust.Domain/ValueObjects/LevelUpResult.cs` | Level-up result value object |
| `src/Core/RuneAndRust.Domain/ValueObjects/StatModifiers.cs` | Stat modification value object |
| `src/Core/RuneAndRust.Domain/Services/ProgressionService.cs` | Level-up detection and application |
| `src/Core/RuneAndRust.Application/DTOs/LevelUpDto.cs` | Level-up display DTO |
| `tests/RuneAndRust.Domain.UnitTests/ValueObjects/LevelUpResultTests.cs` | Value object tests |
| `tests/RuneAndRust.Domain.UnitTests/ValueObjects/StatModifiersTests.cs` | Modifier tests |
| `tests/RuneAndRust.Domain.UnitTests/Services/ProgressionServiceTests.cs` | Service tests |

### Files to Modify

| File | Changes |
|------|---------|
| `src/Core/RuneAndRust.Domain/Entities/Player.cs` | Add ApplyStatModifiers(), GetExperienceForLevel(), GetLevelForExperience() |
| `src/Core/RuneAndRust.Application/Services/GameSessionService.cs` | Add ProgressionService dependency, level-up check after XP award |
| `src/Core/RuneAndRust.Application/Interfaces/IGameRenderer.cs` | Add RenderLevelUpAsync() |
| `src/Presentation/RuneAndRust.Presentation.Tui/Adapters/SpectreGameRenderer.cs` | Implement RenderLevelUpAsync() |
| DI Container | Register ProgressionService |
| `tests/RuneAndRust.Domain.UnitTests/Entities/PlayerTests.cs` | Add level-up method tests |

### Test Files Summary

| File | Test Count |
|------|------------|
| `LevelUpResultTests.cs` | ~4 |
| `StatModifiersTests.cs` | ~4 |
| `PlayerLevelUpTests.cs` | ~4 |
| `ProgressionServiceTests.cs` | ~6 |
| **Total** | **~18** |

---

## Risk Assessment

| Risk | Likelihood | Impact | Mitigation |
|------|------------|--------|------------|
| XP threshold changes break existing saves | Low | Medium | Formula is same as v0.0.8a |
| Stat overflow at very high levels | Low | Low | int max is ~2B, stats won't reach that |
| Ability unlock not triggering | Medium | Medium | Thorough testing of ability service integration |
| Multi-level edge cases | Medium | Medium | Comprehensive tests for large XP gains |
| Health heal conflicts with damage-in-progress | Low | Medium | Level-up only occurs after combat resolution |
| Display formatting issues with large numbers | Low | Low | Test with high level/stat values |

---

*This design specification provides the detailed blueprint for implementing v0.0.8b Level-Up Mechanics. This phase builds on the XP tracking from v0.0.8a and integrates with the ability unlock system from v0.0.4c, while establishing the foundation for configurable progression in v0.0.8c.*
