# v0.15.6b Design Specification: Three-Layer Examination System

**Version:** 0.15.6b
**Phase Name:** Three-Layer Examination System
**Parent Version:** v0.15.6 (Advanced Perception System)
**Prerequisites:** v0.15.6a Complete (Passive Perception System), v0.15.1 Complete (Skill Infrastructure), v0.15.0 Complete (Dice Pool Refactor)
**Estimated Tests:** ~4 unit tests

---

## Table of Contents

1. [Executive Summary](#1-executive-summary)
2. [Feature Overview](#2-feature-overview)
3. [Architecture Diagrams](#3-architecture-diagrams)
4. [ExaminationLayer Enum](#4-examinationlayer-enum)
5. [ExaminationContext Value Object](#5-examinationcontext-value-object)
6. [ExaminationResult Value Object](#6-examinationresult-value-object)
7. [IExaminationService Interface](#7-iexaminationservice-interface)
8. [Data Model Changes](#8-data-model-changes)
9. [Configuration File Schemas](#9-configuration-file-schemas)
10. [Logging Specifications](#10-logging-specifications)
11. [Unit Testing Requirements](#11-unit-testing-requirements)
12. [Use Cases](#12-use-cases)
13. [Deliverable Checklist](#13-deliverable-checklist)
14. [Acceptance Criteria](#14-acceptance-criteria)
15. [Dependencies](#15-dependencies)
16. [Future Considerations](#16-future-considerations)

---

## 1. Executive Summary

### 1.1 Purpose

This specification defines the Three-Layer Examination System, which provides progressive depth of detail when characters examine objects in the game world. Unlike passive perception (v0.15.6a) which operates automatically on room entry, active examination requires player input and rewards higher WITS attributes with richer information.

The system introduces a tiered information model:
- **Layer 1 (Cursory)**: Always available, basic visual information
- **Layer 2 (Detailed)**: Requires DC 12 WITS check, reveals functional details
- **Layer 3 (Expert)**: Requires DC 18 WITS check, reveals historical context and secrets

This creates meaningful differentiation between character builds—a high-WITS scholar gains insights that a low-WITS warrior would miss, encouraging diverse party composition and replay value.

### 1.2 Key Deliverables

| Category | Items |
|----------|-------|
| **Enums** | `ExaminationLayer` |
| **Value Objects** | `ExaminationContext`, `ExaminationResult` |
| **Services** | `IExaminationService`, `ExaminationService` |
| **Configuration** | Layer DC requirements (built-in), examination descriptor integration (v0.15.6c) |
| **Tests** | ~4 unit tests |

### 1.3 Architectural Significance

This version establishes the **Layered Information Pattern** that will be used throughout the game:

- **Progressive Revelation**: Information depth increases with skill
- **DC-Based Gating**: Higher DCs unlock more valuable information
- **Character Persistence**: Once a layer is unlocked, it remains available on re-examination
- **Composite Description**: All unlocked layers combine into a single narrative
- **Hint Integration Foundation**: Layer 3 reveals link to puzzle hints (v0.15.6e)

---

## 2. Feature Overview

```
v0.15.6b Three-Layer Examination System
├── ExaminationLayer Enum
│   ├── Cursory (Layer 1) - No check required
│   ├── Detailed (Layer 2) - WITS DC 12
│   └── Expert (Layer 3) - WITS DC 18
├── ExaminationContext Value Object
│   ├── ObjectId being examined
│   ├── ObjectType categorization
│   ├── CharacterId of examiner
│   ├── WitsPool for check
│   ├── BiomeId for context
│   └── PreviousExaminations tracking
├── ExaminationResult Value Object
│   ├── ObjectId examined
│   ├── ObjectName display
│   ├── WitsCheckResult (net successes)
│   ├── HighestLayerUnlocked (1, 2, or 3)
│   ├── CompositeDescription (all layers combined)
│   ├── LayerTexts (individual layer texts)
│   ├── RevealedHint indicator
│   ├── RevealedSolutionId (puzzle link)
│   └── RevealedInteractions (new commands)
└── IExaminationService Interface
    ├── ExamineObject() - Full examination with WITS check
    ├── GetCursoryDescription() - Layer 1 only (for look command)
    └── HasExpertKnowledge() - Check if Layer 3 unlocked
```

### 2.1 Scope Alignment

**In Scope:**
- `ExaminationLayer` enum with three layers (Cursory, Detailed, Expert)
- `ExaminationContext` value object for examination parameters
- `ExaminationResult` value object for examination outcomes
- `IExaminationService` interface definition
- `ExaminationService` implementation
- Layer DC requirements (Layer 1: auto, Layer 2: DC 12, Layer 3: DC 18)
- WITS-based dice pool check using v0.15.0 success-counting
- Composite description generation from unlocked layers
- Character-object examination state tracking
- Integration with `look` command for Layer 1 descriptions

**Out of Scope:**
- Object category descriptors (v0.15.6c)
- Flora & fauna observation (v0.15.6d)
- Puzzle hint integration (v0.15.6e)
- Search command enhancement (v0.15.6f)
- Investigation command (v0.15.6g)
- Specialization examination bonuses (v0.15.6h)
- Room entry integration (v0.15.6i)

---

## 3. Architecture Diagrams

### 3.1 Three-Layer Examination Flow

```
┌─────────────────────────────────────────────────────────────────────┐
│                  THREE-LAYER EXAMINATION FLOW                        │
└─────────────────────────────────────────────────────────────────────┘

    Player issues "examine <object>"
           │
           ▼
┌─────────────────────────────────────────────────────────────────────┐
│                    BUILD EXAMINATION CONTEXT                         │
├─────────────────────────────────────────────────────────────────────┤
│  1. Resolve ObjectId from player input                              │
│  2. Get ObjectType from object definition                           │
│  3. Get CharacterId from current player                             │
│  4. Calculate WitsPool from character attributes                    │
│  5. Get BiomeId from current room                                   │
│  6. Check PreviousExaminations for this character/object pair       │
└─────────────────────────────────────────────────────────────────────┘
           │
           ▼
┌─────────────────────────────────────────────────────────────────────┐
│                      LAYER 1: CURSORY (AUTO)                         │
├─────────────────────────────────────────────────────────────────────┤
│  - Always unlocked, no check required                               │
│  - Basic visual description                                         │
│  - Example: "A heavy iron door, currently locked."                  │
└─────────────────────────────────────────────────────────────────────┘
           │
           ▼
┌─────────────────────────────────────────────────────────────────────┐
│                    LAYER 2: DETAILED (DC 12)                         │
├─────────────────────────────────────────────────────────────────────┤
│  Roll WITS pool using success-counting (v0.15.0):                   │
│    - Count successes (7+ on d10)                                    │
│    - Compare net successes to DC 12                                 │
│                                                                      │
│  IF success:                                                         │
│    - Unlock Layer 2 description                                     │
│    - Functional details, condition, hints                           │
│    - Example: "A heavy iron door reinforced with Jötun              │
│               metalwork. The lock mechanism is complex..."          │
│  ELSE:                                                               │
│    - Layer 2 remains locked                                         │
│    - Character gains no additional information                      │
└─────────────────────────────────────────────────────────────────────┘
           │
           ▼ (only if Layer 2 succeeded)
┌─────────────────────────────────────────────────────────────────────┐
│                     LAYER 3: EXPERT (DC 18)                          │
├─────────────────────────────────────────────────────────────────────┤
│  Roll WITS pool vs DC 18 (same roll, higher threshold):             │
│                                                                      │
│  IF success:                                                         │
│    - Unlock Layer 3 description                                     │
│    - Historical context, secrets, puzzle solutions                  │
│    - May reveal new interactions                                    │
│    - Example: "A heavy iron door bearing the seal of Level 7        │
│               Security Clearance. The lock uses a combination       │
│               of physical tumblers and runic authentication..."     │
│  ELSE:                                                               │
│    - Layer 3 remains locked                                         │
│    - Character has Layer 1 + Layer 2 only                           │
└─────────────────────────────────────────────────────────────────────┘
           │
           ▼
┌─────────────────────────────────────────────────────────────────────┐
│                   COMPOSE EXAMINATION RESULT                         │
├─────────────────────────────────────────────────────────────────────┤
│  1. Combine all unlocked layer texts into CompositeDescription      │
│  2. Record HighestLayerUnlocked (1, 2, or 3)                        │
│  3. Track any revealed hints (Layer 3 only, v0.15.6e)               │
│  4. List any newly available interactions                           │
│  5. Persist examination state for this character/object             │
└─────────────────────────────────────────────────────────────────────┘
           │
           ▼
┌─────────────────────────────────────────────────────────────────────┐
│                     RETURN EXAMINATION RESULT                        │
├─────────────────────────────────────────────────────────────────────┤
│  ExaminationResult:                                                  │
│    - ObjectId                                                        │
│    - ObjectName                                                      │
│    - WitsCheckResult (net successes)                                │
│    - HighestLayerUnlocked (1, 2, or 3)                              │
│    - CompositeDescription (narrative text)                          │
│    - LayerTexts (individual layers for debugging)                   │
│    - RevealedHint (bool)                                            │
│    - RevealedSolutionId (optional)                                  │
│    - RevealedInteractions (list of new commands)                    │
└─────────────────────────────────────────────────────────────────────┘
```

### 3.2 Layer Diagram

```
┌─────────────────────────────────────────────────────────────────────┐
│                        PRESENTATION LAYER                            │
├─────────────────────────────────────────────────────────────────────┤
│  IGameRenderer                                                       │
│  └── RenderExaminationResultAsync() - displays examination results  │
│                                                                      │
│  ConsoleInputHandler                                                 │
│  └── Parse "examine <object>" command                               │
│  └── Parse "look <object>" command (Layer 1 only)                   │
└───────┬─────────────────────────────────────────────────────────────┘
        │
        ▼
┌─────────────────────────────────────────────────────────────────────┐
│                       APPLICATION LAYER                              │
├─────────────────────────────────────────────────────────────────────┤
│  ┌───────────────────────────────────────────────────────────────┐  │
│  │                  ExaminationService                            │  │
│  ├───────────────────────────────────────────────────────────────┤  │
│  │  + ExamineObject(objectId, characterId, context?)             │  │
│  │      : ExaminationResult                                      │  │
│  │  + GetCursoryDescription(objectId): string                    │  │
│  │  + HasExpertKnowledge(characterId, objectId): bool            │  │
│  │                                                               │  │
│  │  - BuildExaminationContext(objectId, characterId)             │  │
│  │      : ExaminationContext                                     │  │
│  │  - RollWitsCheck(witsPool): int (net successes)               │  │
│  │  - GetLayerDescription(objectId, layer): string               │  │
│  │  - ComposeDescription(layerTexts): string                     │  │
│  │  - PersistExaminationState(characterId, objectId, layer)      │  │
│  └───────────────────────────────────────────────────────────────┘  │
│                                                                      │
│  GameSessionService                                                  │
│  └── Handles ExamineCommand by calling ExaminationService           │
└───────┬─────────────────────────────────────────────────────────────┘
        │
        ▼
┌─────────────────────────────────────────────────────────────────────┐
│                         DOMAIN LAYER                                 │
├─────────────────────────────────────────────────────────────────────┤
│  ┌─────────────────────┐  ┌────────────────────────────────────┐   │
│  │  ExaminationLayer   │  │        ExaminationContext          │   │
│  │       (Enum)        │  │         (Value Object)             │   │
│  ├─────────────────────┤  ├────────────────────────────────────┤   │
│  │ Cursory = 1         │  │ ObjectId: string                   │   │
│  │ Detailed = 2        │  │ ObjectType: string                 │   │
│  │ Expert = 3          │  │ CharacterId: string                │   │
│  └─────────────────────┘  │ WitsPool: int                      │   │
│                           │ BiomeId: string                    │   │
│                           │ PreviousExaminations: int (layer)  │   │
│                           └────────────────────────────────────┘   │
│                                                                     │
│  ┌─────────────────────────────────────────────────────────────┐   │
│  │                    ExaminationResult                         │   │
│  │                     (Value Object)                           │   │
│  ├─────────────────────────────────────────────────────────────┤   │
│  │ ObjectId: string                                             │   │
│  │ ObjectName: string                                           │   │
│  │ WitsCheckResult: int                                         │   │
│  │ HighestLayerUnlocked: int                                    │   │
│  │ CompositeDescription: string                                 │   │
│  │ LayerTexts: IReadOnlyList<string>                            │   │
│  │ RevealedHint: bool                                           │   │
│  │ RevealedSolutionId: string?                                  │   │
│  │ RevealedInteractions: IReadOnlyList<string>                  │   │
│  └─────────────────────────────────────────────────────────────┘   │
│                                                                     │
│  (From v0.15.6a)                                                    │
│  ┌─────────────────────┐                                           │
│  │  PassivePerception  │ ← Used to determine if previously seen    │
│  │   (Value Object)    │                                           │
│  └─────────────────────┘                                           │
└─────────────────────────────────────────────────────────────────────┘
```

### 3.3 Layer DC Reference

```
┌─────────────────────────────────────────────────────────────────────┐
│                    LAYER DC REQUIREMENTS                             │
└─────────────────────────────────────────────────────────────────────┘

    ┌───────────────────────────────────────────────────────────────┐
    │                     LAYER 1: CURSORY                          │
    │                                                               │
    │    DC Required: 0 (Automatic)                                 │
    │    Information: Basic visual, obvious features                │
    │                                                               │
    │    Example:                                                   │
    │    "A heavy iron door, currently locked."                     │
    └───────────────────────────────────────────────────────────────┘
                                │
                                ▼
    ┌───────────────────────────────────────────────────────────────┐
    │                     LAYER 2: DETAILED                         │
    │                                                               │
    │    DC Required: 12 (WITS check)                               │
    │    Information: Functional details, condition, hints          │
    │                                                               │
    │    Example:                                                   │
    │    "A heavy iron door reinforced with Jötun metalwork. The    │
    │    lock mechanism is complex—Jötun engineering, designed to   │
    │    resist forced entry. No visible signs of recent use;       │
    │    dust coats the handle."                                    │
    └───────────────────────────────────────────────────────────────┘
                                │
                                ▼
    ┌───────────────────────────────────────────────────────────────┐
    │                      LAYER 3: EXPERT                          │
    │                                                               │
    │    DC Required: 18 (WITS check)                               │
    │    Information: Historical context, secrets, solutions        │
    │                                                               │
    │    Example:                                                   │
    │    "A heavy iron door bearing the seal of Level 7 Security    │
    │    Clearance. The lock mechanism uses a combination of        │
    │    physical tumblers and runic authentication. Age has        │
    │    corrupted the rune-lock—a skilled lockpicker might bypass  │
    │    the physical mechanism, or someone with Galdr knowledge    │
    │    could attempt to restore the runic component."             │
    │                                                               │
    │    [May reveal hints or new interactions]                     │
    └───────────────────────────────────────────────────────────────┘


    ┌───────────────────────────────────────────────────────────────┐
    │                   WITS-TO-SUCCESS REFERENCE                   │
    ├───────────────────────────────────────────────────────────────┤
    │  WITS Pool → Expected Successes (7+ on d10)                   │
    │                                                               │
    │    WITS 4  → ~1.6 successes → Layer 2 unlikely                │
    │    WITS 6  → ~2.4 successes → Layer 2 possible                │
    │    WITS 8  → ~3.2 successes → Layer 2 likely                  │
    │    WITS 10 → ~4.0 successes → Layer 2 reliable                │
    │    WITS 12 → ~4.8 successes → Layer 3 possible                │
    │    WITS 14 → ~5.6 successes → Layer 3 likely                  │
    │    WITS 16 → ~6.4 successes → Layer 3 reliable                │
    │                                                               │
    │  Note: Success threshold of 7+ gives 40% per die              │
    │  DC 12 = ~30 expected dice pool (WITS × 10 / 4)               │
    │  DC 18 = ~45 expected dice pool                               │
    │                                                               │
    │  [Actual DCs may differ based on v0.15.0 success scaling]     │
    └───────────────────────────────────────────────────────────────┘
```

### 3.4 Examination State Persistence

```
┌─────────────────────────────────────────────────────────────────────┐
│                  EXAMINATION STATE PERSISTENCE                       │
└─────────────────────────────────────────────────────────────────────┘

    First Examination
           │
           ▼
┌───────────────────────────────────────────────────────────────────┐
│                     EXAMINATION CHECK                              │
├───────────────────────────────────────────────────────────────────┤
│  Character: Player-1                                              │
│  Object: iron-door-01                                             │
│  WITS Pool: 8                                                     │
│                                                                   │
│  Roll Result: 4 successes                                         │
│  Layer 2 (DC 12): UNLOCKED                                        │
│  Layer 3 (DC 18): LOCKED                                          │
│                                                                   │
│  → Persist: (Player-1, iron-door-01) = Layer 2                    │
└───────────────────────────────────────────────────────────────────┘
           │
           ▼
    Later: Re-examine same object
           │
           ▼
┌───────────────────────────────────────────────────────────────────┐
│                   RE-EXAMINATION CHECK                             │
├───────────────────────────────────────────────────────────────────┤
│  Character: Player-1                                              │
│  Object: iron-door-01                                             │
│  Previous State: Layer 2 unlocked                                 │
│                                                                   │
│  Layer 1: Auto (always)                                           │
│  Layer 2: Already unlocked (no check needed)                      │
│  Layer 3: Check DC 18 (may improve)                               │
│                                                                   │
│  Roll Result: 6 successes                                         │
│  Layer 3 (DC 18): UNLOCKED                                        │
│                                                                   │
│  → Update: (Player-1, iron-door-01) = Layer 3                     │
└───────────────────────────────────────────────────────────────────┘
           │
           ▼
    Future: Re-examine again
           │
           ▼
┌───────────────────────────────────────────────────────────────────┐
│                    EXPERT KNOWLEDGE                                │
├───────────────────────────────────────────────────────────────────┤
│  Character: Player-1                                              │
│  Object: iron-door-01                                             │
│  Previous State: Layer 3 unlocked (Expert)                        │
│                                                                   │
│  → No check needed                                                │
│  → Return full composite description (all 3 layers)               │
│  → HasExpertKnowledge = true                                      │
└───────────────────────────────────────────────────────────────────┘
```

---

## 4. ExaminationLayer Enum

### 4.1 Purpose

The `ExaminationLayer` enum defines the three tiers of examination depth, each requiring progressively higher WITS checks to unlock.

### 4.2 Implementation

**File:** `src/Core/RuneAndRust.Domain/Enums/ExaminationLayer.cs`

```csharp
namespace RuneAndRust.Domain.Enums;

/// <summary>
/// Defines the depth of information available when examining objects.
/// </summary>
/// <remarks>
/// <para>
/// Examination layers provide progressive detail based on WITS checks:
/// </para>
/// <list type="bullet">
///   <item><description>Cursory (Layer 1): Always available, basic visual information</description></item>
///   <item><description>Detailed (Layer 2): Requires DC 12, functional details and condition</description></item>
///   <item><description>Expert (Layer 3): Requires DC 18, historical context and secrets</description></item>
/// </list>
/// <para>
/// Once a layer is unlocked for a character-object pair, it remains available
/// on subsequent examinations. Higher layers can be unlocked on re-examination
/// if the character's WITS improves or they roll better.
/// </para>
/// </remarks>
public enum ExaminationLayer
{
    /// <summary>
    /// Basic visual information available without any check.
    /// </summary>
    /// <remarks>
    /// Provides obvious features visible at a glance.
    /// DC: 0 (automatic).
    /// Used by the `look` command.
    /// </remarks>
    Cursory = 1,

    /// <summary>
    /// Functional details requiring a successful WITS check.
    /// </summary>
    /// <remarks>
    /// Reveals condition, craftsmanship, hints about function.
    /// DC: 12 (WITS check).
    /// May suggest possible interactions.
    /// </remarks>
    Detailed = 2,

    /// <summary>
    /// Expert-level knowledge requiring a high WITS check.
    /// </summary>
    /// <remarks>
    /// Provides historical context, secrets, puzzle solutions.
    /// DC: 18 (WITS check).
    /// May unlock new interactions or reveal puzzle hints.
    /// </remarks>
    Expert = 3
}
```

### 4.3 Layer DC Requirements

| Layer | Enum Value | DC Required | Information Type | Command |
|-------|------------|-------------|------------------|---------|
| Cursory | 1 | 0 (auto) | Basic visual, obvious features | `look`, `examine` |
| Detailed | 2 | 12 | Functional details, condition, hints | `examine` |
| Expert | 3 | 18 | Historical context, secrets, solutions | `examine` |

---

## 5. ExaminationContext Value Object

### 5.1 Purpose

The `ExaminationContext` value object encapsulates all the information needed to perform an examination check, including the examiner's capabilities and any previous examination history.

### 5.2 Implementation

**File:** `src/Core/RuneAndRust.Domain/ValueObjects/ExaminationContext.cs`

```csharp
namespace RuneAndRust.Domain.ValueObjects;

using RuneAndRust.Domain.Enums;

/// <summary>
/// Encapsulates the context for an examination check.
/// </summary>
/// <remarks>
/// <para>
/// Contains all information needed to perform a WITS-based examination:
/// - The object being examined
/// - The character performing the examination
/// - The character's WITS dice pool
/// - Environmental context (biome)
/// - Previous examination state
/// </para>
/// <para>
/// Previous examination state allows returning cached results for already-unlocked
/// layers without requiring re-rolls.
/// </para>
/// </remarks>
/// <param name="ObjectId">The unique identifier of the object being examined.</param>
/// <param name="ObjectType">The type/category of the object (e.g., "Door", "Machinery").</param>
/// <param name="CharacterId">The unique identifier of the examining character.</param>
/// <param name="WitsPool">The character's WITS dice pool for the check.</param>
/// <param name="BiomeId">The current biome for contextual descriptions.</param>
/// <param name="PreviousHighestLayer">The highest layer previously unlocked (0 if never examined).</param>
public readonly record struct ExaminationContext(
    string ObjectId,
    string ObjectType,
    string CharacterId,
    int WitsPool,
    string BiomeId,
    int PreviousHighestLayer)
{
    /// <summary>
    /// Gets whether this object has been examined before by this character.
    /// </summary>
    public bool HasPreviousExamination => PreviousHighestLayer > 0;

    /// <summary>
    /// Gets whether the character already has Layer 2 (Detailed) knowledge.
    /// </summary>
    public bool HasDetailedKnowledge => PreviousHighestLayer >= (int)ExaminationLayer.Detailed;

    /// <summary>
    /// Gets whether the character already has Layer 3 (Expert) knowledge.
    /// </summary>
    public bool HasExpertKnowledge => PreviousHighestLayer >= (int)ExaminationLayer.Expert;

    /// <summary>
    /// Gets the DC required for the next layer to unlock.
    /// </summary>
    /// <remarks>
    /// Returns 0 if only Layer 1 is needed (auto-unlock).
    /// Returns 12 if Layer 2 is the next target.
    /// Returns 18 if Layer 3 is the next target.
    /// Returns -1 if all layers are already unlocked.
    /// </remarks>
    public int NextLayerDc
    {
        get
        {
            if (HasExpertKnowledge)
                return -1; // All layers unlocked
            if (HasDetailedKnowledge)
                return 18; // Need Layer 3
            if (HasPreviousExamination)
                return 12; // Need Layer 2
            return 0; // Need Layer 1 (auto)
        }
    }

    /// <summary>
    /// Creates an examination context for a first-time examination.
    /// </summary>
    /// <param name="objectId">The object identifier.</param>
    /// <param name="objectType">The object type.</param>
    /// <param name="characterId">The character identifier.</param>
    /// <param name="witsPool">The WITS dice pool.</param>
    /// <param name="biomeId">The current biome.</param>
    /// <returns>A new ExaminationContext with no previous examination history.</returns>
    public static ExaminationContext FirstExamination(
        string objectId,
        string objectType,
        string characterId,
        int witsPool,
        string biomeId)
    {
        return new ExaminationContext(
            objectId,
            objectType,
            characterId,
            witsPool,
            biomeId,
            PreviousHighestLayer: 0);
    }

    /// <summary>
    /// Creates an examination context with previous examination history.
    /// </summary>
    /// <param name="objectId">The object identifier.</param>
    /// <param name="objectType">The object type.</param>
    /// <param name="characterId">The character identifier.</param>
    /// <param name="witsPool">The WITS dice pool.</param>
    /// <param name="biomeId">The current biome.</param>
    /// <param name="previousLayer">The highest layer previously unlocked.</param>
    /// <returns>A new ExaminationContext with examination history.</returns>
    public static ExaminationContext WithHistory(
        string objectId,
        string objectType,
        string characterId,
        int witsPool,
        string biomeId,
        int previousLayer)
    {
        return new ExaminationContext(
            objectId,
            objectType,
            characterId,
            witsPool,
            biomeId,
            PreviousHighestLayer: Math.Clamp(previousLayer, 0, 3));
    }
}
```

---

## 6. ExaminationResult Value Object

### 6.1 Purpose

The `ExaminationResult` value object encapsulates the complete outcome of an examination, including the WITS check result, unlocked layers, composite description, and any revealed hints or interactions.

### 6.2 Implementation

**File:** `src/Core/RuneAndRust.Domain/ValueObjects/ExaminationResult.cs`

```csharp
namespace RuneAndRust.Domain.ValueObjects;

using RuneAndRust.Domain.Enums;

/// <summary>
/// Represents the complete result of examining an object.
/// </summary>
/// <remarks>
/// <para>
/// Contains the outcome of a WITS check against layer DCs, including:
/// - The number of successes rolled
/// - Which layers were unlocked
/// - The combined narrative description
/// - Any revealed hints or new interactions
/// </para>
/// <para>
/// The composite description combines all unlocked layer texts into a
/// flowing narrative, while LayerTexts preserves individual layers for
/// debugging or special display needs.
/// </para>
/// </remarks>
/// <param name="ObjectId">The unique identifier of the examined object.</param>
/// <param name="ObjectName">The display name of the object.</param>
/// <param name="WitsCheckResult">The number of net successes from the WITS check.</param>
/// <param name="HighestLayerUnlocked">The highest layer unlocked (1, 2, or 3).</param>
/// <param name="CompositeDescription">All unlocked layers combined into narrative text.</param>
/// <param name="LayerTexts">Individual layer description texts.</param>
/// <param name="RevealedHint">Whether a puzzle hint was revealed (Layer 3 only).</param>
/// <param name="RevealedSolutionId">The puzzle solution ID if a hint was revealed.</param>
/// <param name="RevealedInteractions">New commands/interactions made available.</param>
public readonly record struct ExaminationResult(
    string ObjectId,
    string ObjectName,
    int WitsCheckResult,
    int HighestLayerUnlocked,
    string CompositeDescription,
    IReadOnlyList<string> LayerTexts,
    bool RevealedHint,
    string? RevealedSolutionId,
    IReadOnlyList<string> RevealedInteractions)
{
    /// <summary>
    /// Gets the examination layer enum value for the highest unlocked layer.
    /// </summary>
    public ExaminationLayer UnlockedLayer => (ExaminationLayer)HighestLayerUnlocked;

    /// <summary>
    /// Gets whether Layer 2 (Detailed) was unlocked.
    /// </summary>
    public bool HasDetailedKnowledge => HighestLayerUnlocked >= (int)ExaminationLayer.Detailed;

    /// <summary>
    /// Gets whether Layer 3 (Expert) was unlocked.
    /// </summary>
    public bool HasExpertKnowledge => HighestLayerUnlocked >= (int)ExaminationLayer.Expert;

    /// <summary>
    /// Gets whether any new interactions were revealed.
    /// </summary>
    public bool HasNewInteractions => RevealedInteractions.Count > 0;

    /// <summary>
    /// Gets the layer count (how many layers are included in the description).
    /// </summary>
    public int LayerCount => LayerTexts.Count;

    /// <summary>
    /// Creates a cursory-only result (Layer 1, no check required).
    /// </summary>
    /// <param name="objectId">The object identifier.</param>
    /// <param name="objectName">The object display name.</param>
    /// <param name="cursoryDescription">The Layer 1 description text.</param>
    /// <returns>An ExaminationResult with only Layer 1 unlocked.</returns>
    public static ExaminationResult CursoryOnly(
        string objectId,
        string objectName,
        string cursoryDescription)
    {
        return new ExaminationResult(
            objectId,
            objectName,
            WitsCheckResult: 0,
            HighestLayerUnlocked: (int)ExaminationLayer.Cursory,
            CompositeDescription: cursoryDescription,
            LayerTexts: new[] { cursoryDescription },
            RevealedHint: false,
            RevealedSolutionId: null,
            RevealedInteractions: Array.Empty<string>());
    }

    /// <summary>
    /// Creates a result with specified layers unlocked.
    /// </summary>
    /// <param name="objectId">The object identifier.</param>
    /// <param name="objectName">The object display name.</param>
    /// <param name="witsResult">The WITS check result.</param>
    /// <param name="highestLayer">The highest layer unlocked.</param>
    /// <param name="layerTexts">The individual layer texts.</param>
    /// <param name="revealedHint">Whether a hint was revealed.</param>
    /// <param name="solutionId">The revealed solution ID (if any).</param>
    /// <param name="interactions">Revealed interactions (if any).</param>
    /// <returns>A new ExaminationResult with composed description.</returns>
    public static ExaminationResult Create(
        string objectId,
        string objectName,
        int witsResult,
        int highestLayer,
        IReadOnlyList<string> layerTexts,
        bool revealedHint = false,
        string? solutionId = null,
        IReadOnlyList<string>? interactions = null)
    {
        // Compose description from unlocked layers
        var composite = string.Join("\n\n", layerTexts.Take(highestLayer));

        return new ExaminationResult(
            objectId,
            objectName,
            witsResult,
            highestLayer,
            composite,
            layerTexts.Take(highestLayer).ToList(),
            revealedHint,
            solutionId,
            interactions ?? Array.Empty<string>());
    }

    /// <summary>
    /// Creates a display string summarizing the examination outcome.
    /// </summary>
    /// <returns>A formatted summary string.</returns>
    public string ToSummaryString()
    {
        var layerName = UnlockedLayer switch
        {
            ExaminationLayer.Cursory => "Cursory",
            ExaminationLayer.Detailed => "Detailed",
            ExaminationLayer.Expert => "Expert",
            _ => "Unknown"
        };

        var summary = $"[{ObjectName}] - {layerName} Knowledge";

        if (WitsCheckResult > 0)
        {
            summary += $" (WITS check: {WitsCheckResult} successes)";
        }

        if (RevealedHint)
        {
            summary += " [Hint revealed!]";
        }

        if (HasNewInteractions)
        {
            summary += $" [New commands: {string.Join(", ", RevealedInteractions)}]";
        }

        return summary;
    }
}
```

---

## 7. IExaminationService Interface

### 7.1 Purpose

The `IExaminationService` interface defines the contract for examination operations, enabling dependency injection and testability.

### 7.2 Interface Definition

**File:** `src/Core/RuneAndRust.Application/Interfaces/IExaminationService.cs`

```csharp
namespace RuneAndRust.Application.Interfaces;

using RuneAndRust.Domain.ValueObjects;

/// <summary>
/// Service for examining objects with layered detail depth.
/// </summary>
/// <remarks>
/// <para>
/// Provides three layers of examination detail:
/// - Layer 1 (Cursory): Always available, basic visual information
/// - Layer 2 (Detailed): DC 12 WITS check, functional details
/// - Layer 3 (Expert): DC 18 WITS check, secrets and solutions
/// </para>
/// <para>
/// Once a layer is unlocked for a character-object pair, it remains
/// available on subsequent examinations without requiring re-rolls.
/// </para>
/// </remarks>
public interface IExaminationService
{
    /// <summary>
    /// Examines an object with a WITS check, returning layered description.
    /// </summary>
    /// <param name="objectId">The unique identifier of the object to examine.</param>
    /// <param name="characterId">The unique identifier of the examining character.</param>
    /// <param name="context">Optional skill context for modifiers.</param>
    /// <returns>The examination result with all unlocked layers.</returns>
    /// <remarks>
    /// Performs a WITS check against layer DCs:
    /// - Layer 1: Auto (no check)
    /// - Layer 2: DC 12
    /// - Layer 3: DC 18
    ///
    /// If the character has previously examined this object, already-unlocked
    /// layers are included automatically without requiring new checks.
    /// </remarks>
    /// <exception cref="ArgumentException">Thrown when IDs are invalid.</exception>
    /// <exception cref="InvalidOperationException">Thrown when object not found.</exception>
    ExaminationResult ExamineObject(
        string objectId,
        string characterId,
        SkillContext? context = null);

    /// <summary>
    /// Gets the base (Layer 1) description without a check.
    /// </summary>
    /// <param name="objectId">The unique identifier of the object.</param>
    /// <returns>The cursory (Layer 1) description text.</returns>
    /// <remarks>
    /// Used by the `look` command to display basic information.
    /// Does not require or perform any WITS check.
    /// Does not update examination state.
    /// </remarks>
    /// <exception cref="ArgumentException">Thrown when objectId is invalid.</exception>
    /// <exception cref="InvalidOperationException">Thrown when object not found.</exception>
    string GetCursoryDescription(string objectId);

    /// <summary>
    /// Checks if a character has unlocked Layer 3 (Expert) knowledge for an object.
    /// </summary>
    /// <param name="characterId">The character's unique identifier.</param>
    /// <param name="objectId">The object's unique identifier.</param>
    /// <returns>True if the character has expert knowledge of this object.</returns>
    /// <remarks>
    /// Used to determine if puzzle hints have been revealed or if
    /// special interactions are available.
    /// </remarks>
    /// <exception cref="ArgumentException">Thrown when IDs are invalid.</exception>
    bool HasExpertKnowledge(string characterId, string objectId);
}
```

### 7.3 Service Implementation

**File:** `src/Core/RuneAndRust.Application/Services/ExaminationService.cs`

```csharp
namespace RuneAndRust.Application.Services;

using Microsoft.Extensions.Logging;
using RuneAndRust.Application.Interfaces;
using RuneAndRust.Domain.Enums;
using RuneAndRust.Domain.ValueObjects;

/// <summary>
/// Implementation of the three-layer examination system.
/// </summary>
public class ExaminationService : IExaminationService
{
    /// <summary>
    /// The DC required for Layer 2 (Detailed) knowledge.
    /// </summary>
    public const int DetailedLayerDc = 12;

    /// <summary>
    /// The DC required for Layer 3 (Expert) knowledge.
    /// </summary>
    public const int ExpertLayerDc = 18;

    private readonly IPlayerRepository _playerRepository;
    private readonly IObjectRepository _objectRepository;
    private readonly IExaminationStateRepository _examinationStateRepository;
    private readonly IDiceService _diceService;
    private readonly IRoomRepository _roomRepository;
    private readonly ILogger<ExaminationService> _logger;

    /// <summary>
    /// Initializes a new instance of ExaminationService.
    /// </summary>
    public ExaminationService(
        IPlayerRepository playerRepository,
        IObjectRepository objectRepository,
        IExaminationStateRepository examinationStateRepository,
        IDiceService diceService,
        IRoomRepository roomRepository,
        ILogger<ExaminationService> logger)
    {
        _playerRepository = playerRepository;
        _objectRepository = objectRepository;
        _examinationStateRepository = examinationStateRepository;
        _diceService = diceService;
        _roomRepository = roomRepository;
        _logger = logger;
    }

    /// <inheritdoc />
    public ExaminationResult ExamineObject(
        string objectId,
        string characterId,
        SkillContext? context = null)
    {
        ArgumentException.ThrowIfNullOrWhiteSpace(objectId);
        ArgumentException.ThrowIfNullOrWhiteSpace(characterId);

        // Get character and object
        var player = _playerRepository.GetById(characterId)
            ?? throw new InvalidOperationException($"Character '{characterId}' not found.");

        var gameObject = _objectRepository.GetById(objectId)
            ?? throw new InvalidOperationException($"Object '{objectId}' not found.");

        // Build examination context
        var examinationContext = BuildExaminationContext(
            objectId,
            gameObject.ObjectType,
            characterId,
            player);

        // Get layer descriptions
        var layerTexts = GetLayerDescriptions(objectId, gameObject.ObjectType);

        // Determine highest layer to unlock
        int highestLayer = DetermineHighestLayer(examinationContext, out int witsResult);

        // Check for hint/interaction reveals (Layer 3 only)
        bool revealedHint = false;
        string? solutionId = null;
        var interactions = new List<string>();

        if (highestLayer >= (int)ExaminationLayer.Expert)
        {
            // Hint integration will be added in v0.15.6e
            // For now, just log expert knowledge attained
            _logger.LogInformation(
                "Character {CharacterId} gained Expert knowledge of {ObjectId}",
                characterId,
                objectId);
        }

        // Persist examination state
        _examinationStateRepository.SetHighestLayer(characterId, objectId, highestLayer);

        // Create result
        var result = ExaminationResult.Create(
            objectId,
            gameObject.DisplayName,
            witsResult,
            highestLayer,
            layerTexts,
            revealedHint,
            solutionId,
            interactions);

        _logger.LogDebug(
            "Examination complete: {CharacterId} examined {ObjectId}, unlocked Layer {Layer} " +
            "(WITS {WitsResult})",
            characterId,
            objectId,
            highestLayer,
            witsResult);

        return result;
    }

    /// <inheritdoc />
    public string GetCursoryDescription(string objectId)
    {
        ArgumentException.ThrowIfNullOrWhiteSpace(objectId);

        var gameObject = _objectRepository.GetById(objectId)
            ?? throw new InvalidOperationException($"Object '{objectId}' not found.");

        var layerTexts = GetLayerDescriptions(objectId, gameObject.ObjectType);

        return layerTexts.FirstOrDefault() ?? $"You see {gameObject.DisplayName}.";
    }

    /// <inheritdoc />
    public bool HasExpertKnowledge(string characterId, string objectId)
    {
        ArgumentException.ThrowIfNullOrWhiteSpace(characterId);
        ArgumentException.ThrowIfNullOrWhiteSpace(objectId);

        var highestLayer = _examinationStateRepository.GetHighestLayer(characterId, objectId);
        return highestLayer >= (int)ExaminationLayer.Expert;
    }

    /// <summary>
    /// Builds the examination context from character and object data.
    /// </summary>
    private ExaminationContext BuildExaminationContext(
        string objectId,
        string objectType,
        string characterId,
        Player player)
    {
        var witsPool = player.GetEffectiveAttributes().Wits;
        var room = _roomRepository.GetByPosition(player.Position);
        var biomeId = room?.BiomeId ?? "unknown";

        var previousLayer = _examinationStateRepository.GetHighestLayer(characterId, objectId);

        return ExaminationContext.WithHistory(
            objectId,
            objectType,
            characterId,
            witsPool,
            biomeId,
            previousLayer);
    }

    /// <summary>
    /// Determines the highest layer to unlock based on WITS check.
    /// </summary>
    private int DetermineHighestLayer(ExaminationContext context, out int witsResult)
    {
        // Layer 1 is always unlocked
        int highestLayer = (int)ExaminationLayer.Cursory;
        witsResult = 0;

        // If already at Expert level, no need to roll
        if (context.HasExpertKnowledge)
        {
            highestLayer = (int)ExaminationLayer.Expert;
            return highestLayer;
        }

        // Roll WITS check using success-counting
        var rollResult = _diceService.RollSuccessPool(context.WitsPool);
        witsResult = rollResult.NetSuccesses;

        _logger.LogDebug(
            "WITS check for {CharacterId} examining {ObjectId}: {Successes} successes",
            context.CharacterId,
            context.ObjectId,
            witsResult);

        // Check Layer 2 (DC 12)
        if (context.HasDetailedKnowledge || witsResult >= DetailedLayerDc)
        {
            highestLayer = (int)ExaminationLayer.Detailed;

            // Check Layer 3 (DC 18)
            if (witsResult >= ExpertLayerDc)
            {
                highestLayer = (int)ExaminationLayer.Expert;
            }
        }

        // Ensure we don't regress from previous knowledge
        return Math.Max(highestLayer, context.PreviousHighestLayer);
    }

    /// <summary>
    /// Gets the description texts for all layers of an object.
    /// </summary>
    private IReadOnlyList<string> GetLayerDescriptions(string objectId, string objectType)
    {
        // In v0.15.6c, this will use examination-descriptors.json
        // For now, return placeholder descriptions based on object
        var descriptions = _objectRepository.GetLayerDescriptions(objectId);

        if (descriptions.Count > 0)
        {
            return descriptions;
        }

        // Fallback default descriptions
        return new[]
        {
            $"You see a {objectType.ToLower()}.", // Layer 1
            $"Upon closer inspection, the {objectType.ToLower()} reveals more details.", // Layer 2
            $"With expert knowledge, you understand the full significance of this {objectType.ToLower()}." // Layer 3
        };
    }
}
```

---

## 8. Data Model Changes

### 8.1 New Enums

| Enum | Layer | Description |
|------|-------|-------------|
| `ExaminationLayer` | Domain | Defines the three examination depth tiers |

### 8.2 New Value Objects

| Value Object | Layer | Description |
|--------------|-------|-------------|
| `ExaminationContext` | Domain | Parameters for an examination check |
| `ExaminationResult` | Domain | Complete outcome of an examination |

### 8.3 New Interfaces

| Interface | Layer | Description |
|-----------|-------|-------------|
| `IExaminationService` | Application | Examination service contract |
| `IExaminationStateRepository` | Application | Persists character-object examination state |
| `IObjectRepository.GetLayerDescriptions()` | Application | Extended to return layer descriptions |

### 8.4 New Services

| Service | Layer | Description |
|---------|-------|-------------|
| `ExaminationService` | Application | Three-layer examination implementation |

### 8.5 Examination State Entity

**File:** `src/Core/RuneAndRust.Domain/Entities/ExaminationState.cs`

```csharp
namespace RuneAndRust.Domain.Entities;

using RuneAndRust.Domain.Interfaces;

/// <summary>
/// Tracks the highest examination layer unlocked for a character-object pair.
/// </summary>
/// <remarks>
/// <para>
/// Persists examination progress so characters don't need to re-roll for
/// already-unlocked layers. Only stores the highest layer achieved.
/// </para>
/// </remarks>
public class ExaminationState : IEntity
{
    /// <summary>
    /// Gets the unique identifier for this state record.
    /// </summary>
    public Guid Id { get; private set; }

    /// <summary>
    /// Gets the character who performed the examination.
    /// </summary>
    public string CharacterId { get; private set; } = string.Empty;

    /// <summary>
    /// Gets the object that was examined.
    /// </summary>
    public string ObjectId { get; private set; } = string.Empty;

    /// <summary>
    /// Gets the highest layer unlocked (1, 2, or 3).
    /// </summary>
    public int HighestLayerUnlocked { get; private set; }

    /// <summary>
    /// Gets when this state was first created.
    /// </summary>
    public DateTime FirstExaminedAt { get; private set; }

    /// <summary>
    /// Gets when this state was last updated.
    /// </summary>
    public DateTime LastExaminedAt { get; private set; }

    /// <summary>
    /// Private constructor for EF Core.
    /// </summary>
    private ExaminationState() { }

    /// <summary>
    /// Creates a new examination state record.
    /// </summary>
    /// <param name="characterId">The character ID.</param>
    /// <param name="objectId">The object ID.</param>
    /// <param name="highestLayer">The highest layer unlocked.</param>
    /// <returns>A new ExaminationState instance.</returns>
    public static ExaminationState Create(
        string characterId,
        string objectId,
        int highestLayer)
    {
        ArgumentException.ThrowIfNullOrWhiteSpace(characterId);
        ArgumentException.ThrowIfNullOrWhiteSpace(objectId);

        var now = DateTime.UtcNow;

        return new ExaminationState
        {
            Id = Guid.NewGuid(),
            CharacterId = characterId,
            ObjectId = objectId,
            HighestLayerUnlocked = Math.Clamp(highestLayer, 1, 3),
            FirstExaminedAt = now,
            LastExaminedAt = now
        };
    }

    /// <summary>
    /// Updates the highest layer if the new value is higher.
    /// </summary>
    /// <param name="newLayer">The new layer value.</param>
    /// <returns>True if the layer was upgraded, false otherwise.</returns>
    public bool TryUpgradeLayer(int newLayer)
    {
        var clampedLayer = Math.Clamp(newLayer, 1, 3);

        if (clampedLayer > HighestLayerUnlocked)
        {
            HighestLayerUnlocked = clampedLayer;
            LastExaminedAt = DateTime.UtcNow;
            return true;
        }

        LastExaminedAt = DateTime.UtcNow;
        return false;
    }
}
```

---

## 9. Configuration File Schemas

### 9.1 Layer DC Configuration (Built-in)

Layer DCs are defined as constants in `ExaminationService`:

```csharp
public const int DetailedLayerDc = 12;
public const int ExpertLayerDc = 18;
```

These are intentionally not configurable to maintain consistent game balance.

### 9.2 Object Layer Descriptions (Preparation for v0.15.6c)

**Note:** Full object category descriptors are defined in v0.15.6c. This section shows the expected structure that the `IObjectRepository.GetLayerDescriptions()` method will return.

**Expected Format:**

```json
{
  "$schema": "./schemas/object-layers.schema.json",
  "objects": [
    {
      "objectId": "iron-door-01",
      "objectType": "Door",
      "displayName": "Iron Door",
      "layers": [
        {
          "layer": 1,
          "text": "A heavy iron door, currently locked."
        },
        {
          "layer": 2,
          "text": "A heavy iron door reinforced with Jötun metalwork. The lock mechanism is complex—Jötun engineering, designed to resist forced entry. No visible signs of recent use; dust coats the handle."
        },
        {
          "layer": 3,
          "text": "A heavy iron door bearing the seal of Level 7 Security Clearance. The lock mechanism uses a combination of physical tumblers and runic authentication. Age has corrupted the rune-lock—a skilled lockpicker might bypass the physical mechanism, or someone with Galdr knowledge could attempt to restore the runic component."
        }
      ]
    }
  ]
}
```

---

## 10. Logging Specifications

### 10.1 Log Levels by Component

| Component | Level | Events |
|-----------|-------|--------|
| `ExaminationService` | Information | Expert knowledge gained, hint revealed |
| `ExaminationService` | Debug | WITS check result, layer unlocked, examination complete |
| `ExaminationService` | Warning | Object not found, character not found |

### 10.2 Example Log Messages

```
[INF] ExaminationService: Character 'player-1' gained Expert knowledge of 'iron-door-01'
[DBG] ExaminationService: WITS check for player-1 examining iron-door-01: 14 successes
[DBG] ExaminationService: Examination complete: player-1 examined iron-door-01, unlocked Layer 3 (WITS 14)
[DBG] ExaminationService: Using cached Layer 2 knowledge for player-1 examining iron-door-01
[WRN] ExaminationService: Object 'unknown-object' not found for examination
```

---

## 11. Unit Testing Requirements

### 11.1 Test Count by Feature

| Feature | Test Count |
|---------|------------|
| ExaminationLayer functionality | ~4 |
| **Total** | **~4** |

### 11.2 Test Specifications

#### ExaminationResultTests.cs

**File:** `tests/RuneAndRust.Domain.Tests/ValueObjects/ExaminationResultTests.cs`

```csharp
[TestFixture]
public class ExaminationResultTests
{
    [Test]
    public void CursoryOnly_Layer1_ReturnsWithoutCheck()
    {
        // Arrange
        var objectId = "door-01";
        var objectName = "Iron Door";
        var description = "A heavy iron door.";

        // Act
        var result = ExaminationResult.CursoryOnly(objectId, objectName, description);

        // Assert
        Assert.Multiple(() =>
        {
            Assert.That(result.HighestLayerUnlocked, Is.EqualTo(1));
            Assert.That(result.WitsCheckResult, Is.EqualTo(0));
            Assert.That(result.CompositeDescription, Is.EqualTo(description));
            Assert.That(result.HasDetailedKnowledge, Is.False);
            Assert.That(result.HasExpertKnowledge, Is.False);
        });
    }

    [Test]
    public void Create_Layer2Unlocked_IncludesDetailedKnowledge()
    {
        // Arrange
        var layerTexts = new[]
        {
            "Layer 1 text.",
            "Layer 2 text.",
            "Layer 3 text."
        };

        // Act
        var result = ExaminationResult.Create(
            "obj-01", "Object", 14, 2, layerTexts);

        // Assert
        Assert.Multiple(() =>
        {
            Assert.That(result.HighestLayerUnlocked, Is.EqualTo(2));
            Assert.That(result.HasDetailedKnowledge, Is.True);
            Assert.That(result.HasExpertKnowledge, Is.False);
            Assert.That(result.LayerCount, Is.EqualTo(2));
            Assert.That(result.CompositeDescription, Contains.Substring("Layer 1"));
            Assert.That(result.CompositeDescription, Contains.Substring("Layer 2"));
            Assert.That(result.CompositeDescription, Does.Not.Contain("Layer 3"));
        });
    }

    [Test]
    public void Create_Layer3Unlocked_IncludesExpertKnowledge()
    {
        // Arrange
        var layerTexts = new[]
        {
            "Layer 1 text.",
            "Layer 2 text.",
            "Layer 3 text."
        };

        // Act
        var result = ExaminationResult.Create(
            "obj-01", "Object", 20, 3, layerTexts);

        // Assert
        Assert.Multiple(() =>
        {
            Assert.That(result.HighestLayerUnlocked, Is.EqualTo(3));
            Assert.That(result.HasDetailedKnowledge, Is.True);
            Assert.That(result.HasExpertKnowledge, Is.True);
            Assert.That(result.LayerCount, Is.EqualTo(3));
            Assert.That(result.CompositeDescription, Contains.Substring("Layer 3"));
        });
    }

    [Test]
    public void CompositeDescription_MultipleUnlockedLayers_CombinesCorrectly()
    {
        // Arrange
        var layerTexts = new[]
        {
            "A heavy iron door.",
            "Reinforced with Jötun metalwork.",
            "Bears the seal of Level 7 Security."
        };

        // Act
        var result = ExaminationResult.Create(
            "door-01", "Iron Door", 18, 3, layerTexts);

        // Assert
        Assert.Multiple(() =>
        {
            Assert.That(result.CompositeDescription, Contains.Substring("heavy iron door"));
            Assert.That(result.CompositeDescription, Contains.Substring("Jötun metalwork"));
            Assert.That(result.CompositeDescription, Contains.Substring("Level 7 Security"));
        });
    }
}
```

---

## 12. Use Cases

### UC-001: Basic Examine Command

**Actor:** Player
**Preconditions:** Player is in a room with an examinable object
**Flow:**
1. Player enters `examine iron door`
2. System resolves object reference
3. System builds ExaminationContext
4. System rolls WITS check
5. System determines highest unlocked layer
6. System composes description
7. System displays result to player
8. System persists examination state

**Postconditions:** Player sees layered description, state is saved

### UC-002: High-WITS Character Gains Expert Knowledge

**Actor:** Player with high WITS (14+)
**Flow:**
1. Player examines object for first time
2. WITS check succeeds against DC 18
3. All three layers unlock
4. Full composite description displayed
5. Expert knowledge flag set
6. Potential hint revealed (v0.15.6e)
7. New interactions available

**Postconditions:** Character has expert knowledge persisted

### UC-003: Low-WITS Character Gets Cursory Information

**Actor:** Player with low WITS (4)
**Flow:**
1. Player examines object
2. WITS check fails against DC 12
3. Only Layer 1 unlocks
4. Basic description displayed
5. Player may try again later (with stat improvements)

**Postconditions:** Only cursory knowledge saved

### UC-004: Re-Examination Improves Knowledge

**Actor:** Player who previously examined object
**Flow:**
1. Player previously unlocked Layer 2
2. Player's WITS has improved (training, equipment)
3. Player re-examines object
4. System retrieves previous state (Layer 2)
5. System rolls new WITS check
6. Check succeeds against DC 18
7. Layer 3 unlocks, state updated
8. Full description now available

**Postconditions:** Knowledge upgraded from Layer 2 to Layer 3

### UC-005: Look Command Returns Layer 1 Only

**Actor:** Player
**Flow:**
1. Player uses `look iron door` command
2. System calls GetCursoryDescription()
3. Only Layer 1 description returned
4. No WITS check performed
5. Examination state not updated

**Postconditions:** Quick information without modifying state

---

## 13. Deliverable Checklist

### Domain Layer

- [ ] `ExaminationLayer` enum with three values (Cursory, Detailed, Expert)
- [ ] `ExaminationContext` value object with history tracking
- [ ] `ExaminationResult` value object with composite description
- [ ] `ExaminationState` entity for persisting examination progress

### Application Layer

- [ ] `IExaminationService` interface with three methods
- [ ] `ExaminationService` implementation
- [ ] `IExaminationStateRepository` interface
- [ ] Layer DC constants (12 and 18)

### Testing

- [ ] ~4 unit tests implemented
- [ ] All tests passing

---

## 14. Acceptance Criteria

### Functional

- [ ] ExaminationLayer enum defines Cursory (1), Detailed (2), Expert (3)
- [ ] Layer 1 (Cursory) always returns without any check
- [ ] Layer 2 (Detailed) requires DC 12 WITS success
- [ ] Layer 3 (Expert) requires DC 18 WITS success
- [ ] WITS check uses success-counting dice pool (v0.15.0)
- [ ] Composite description includes all unlocked layers combined
- [ ] Individual layer texts preserved in LayerTexts collection
- [ ] Examination state persists highest layer for character-object pair
- [ ] Re-examination uses cached knowledge without re-rolling lower layers
- [ ] GetCursoryDescription returns Layer 1 without check or state change
- [ ] HasExpertKnowledge correctly reports Layer 3 status
- [ ] ExaminationResult tracks revealed hints and interactions (for v0.15.6e)

### Quality

- [ ] Build succeeds with 0 errors
- [ ] Build succeeds with 0 warnings
- [ ] ~4 unit tests pass
- [ ] XML documentation complete for all public members
- [ ] Layer DCs are constants, not configurable (game balance)

---

## 15. Dependencies

### 15.1 Required from Previous Versions

| Type | Location | Usage in this phase |
|------|----------|---------------------|
| `Player.GetEffectiveAttributes()` | `Domain/Entities/Player.cs` | Get WITS for examination check |
| `IDiceService.RollSuccessPool()` | `Application/Interfaces/IDiceService.cs` | Success-counting WITS check |
| v0.15.0 Dice System | Various | Success-counting mechanics |
| v0.15.1 Skill Infrastructure | Various | SkillContext integration |
| `PassivePerception` (v0.15.6a) | `Domain/ValueObjects/PassivePerception.cs` | Foundation for WITS-based checks |

### 15.2 Provides to v0.15.6c

| Type | Usage |
|------|-------|
| `ExaminationLayer` | Used to categorize object descriptors |
| `ExaminationResult` | Extended with object category context |
| `IExaminationService` | Called with category-specific descriptors |

### 15.3 Provides to v0.15.6d

| Type | Usage |
|------|-------|
| `ExaminationResult` | Used for flora/fauna examination results |
| `IExaminationService.ExamineObject()` | Called for species examination |

### 15.4 Provides to v0.15.6e

| Type | Usage |
|------|-------|
| `ExaminationResult.RevealedHint` | Puzzle hint integration |
| `ExaminationResult.RevealedSolutionId` | Links to puzzle solutions |
| `ExaminationResult.RevealedInteractions` | New commands from hints |
| `HasExpertKnowledge()` | Checks if hints should be revealed |

### 15.5 Provides to v0.15.6h

| Type | Usage |
|------|-------|
| `ExaminationContext` | Extended with specialization bonuses |
| `ExaminationService.DetermineHighestLayer()` | Modified for auto-succeed abilities |

### 15.6 Provides to v0.15.6i

| Type | Usage |
|------|-------|
| `GetCursoryDescription()` | Called during room entry for visible objects |
| `ExaminationResult` | Integrated into room description composition |

---

## 16. Future Considerations

### Deferred to v0.15.6c

- **Object category descriptors** - Category-specific examination text
- **ObjectCategory enum** - Door, Machinery, Decorative, etc.
- **ObjectDescriptor entity** - Layered descriptions by category
- **Biome affinity** - Biome-specific descriptor variants

### Deferred to v0.15.6e

- **Puzzle hint integration** - Layer 3 reveals puzzle hints
- **PuzzleHint value object** - Hint definitions
- **ExaminationHintLink** - Links objects to hints
- **New interaction unlocking** - Commands revealed by hints

### Deferred to v0.15.6h

- **Specialization examination bonuses**:
  - Jötun-Reader: +2d10 to examine machinery, auto-succeed Layer 2 for Jötun tech
  - Thul: Auto-succeed Layer 3 for historical objects
  - Ruin-Stalker: Bonus to examining traps and mechanisms
- **Equipment examination modifiers** - Items that boost examination checks

### Out of Scope for v0.15.6

- **Time cost for examination** - Examination is instantaneous
- **Examination skill proficiency** - No dedicated examination skill
- **Party knowledge sharing** - Each character has independent state
- **Examination minigames** - No interactive examination mechanics

---

*Document Version: 1.0*
*Last Updated: 2026-01-18*
*Author: AI Assistant*
