# v0.14.10b Design Specification: Quest Schema

**Version:** 0.14.10b
**Parent:** v0.14.10 (Game Systems Configuration Schemas)
**Prerequisites:** v0.14.10a Complete (Faction Schema)
**Status:** Design Complete

---

## Table of Contents

1. [Executive Summary](#1-executive-summary)
2. [Feature Overview](#2-feature-overview)
3. [Architecture Diagrams](#3-architecture-diagrams)
4. [Schema Root Definition](#4-schema-root-definition)
   - 4.1 [Root Configuration Properties](#41-root-configuration-properties)
   - 4.2 [Quest Category Defaults](#42-quest-category-defaults)
   - 4.3 [Schema Version Control](#43-schema-version-control)
5. [Quest Definition](#5-quest-definition)
   - 5.1 [Core Properties](#51-core-properties)
   - 5.2 [Identity Properties](#52-identity-properties)
   - 5.3 [Quest Giver Configuration](#53-quest-giver-configuration)
6. [QuestCategory Enum](#6-questcategory-enum)
   - 6.1 [Category Types](#61-category-types)
   - 6.2 [Category Characteristics](#62-category-characteristics)
   - 6.3 [Category Usage Examples](#63-category-usage-examples)
7. [QuestStage Definition](#7-queststage-definition)
   - 7.1 [Stage Structure](#71-stage-structure)
   - 7.2 [Stage Sequencing](#72-stage-sequencing)
   - 7.3 [Stage Completion Actions](#73-stage-completion-actions)
8. [Objective Definition](#8-objective-definition)
   - 8.1 [Objective Types](#81-objective-types)
   - 8.2 [Objective Structure](#82-objective-structure)
   - 8.3 [Modular Objective System](#83-modular-objective-system)
9. [Prerequisite Definition](#9-prerequisite-definition)
   - 9.1 [Prerequisite Types](#91-prerequisite-types)
   - 9.2 [Prerequisite Structure](#92-prerequisite-structure)
   - 9.3 [Prerequisite Operators](#93-prerequisite-operators)
10. [Reward Definition](#10-reward-definition)
    - 10.1 [Reward Types](#101-reward-types)
    - 10.2 [Reward Structure](#102-reward-structure)
    - 10.3 [Choice Rewards](#103-choice-rewards)
11. [QuestBranch Definition](#11-questbranch-definition)
    - 11.1 [Branch Structure](#111-branch-structure)
    - 11.2 [Branch Conditions](#112-branch-conditions)
    - 11.3 [Multiple Endings](#113-multiple-endings)
12. [FailureCondition Definition](#12-failurecondition-definition)
    - 12.1 [Failure Types](#121-failure-types)
    - 12.2 [Failure Consequences](#122-failure-consequences)
13. [Configuration Schema](#13-configuration-schema)
14. [Example Configuration File](#14-example-configuration-file)
15. [Logging Specifications](#15-logging-specifications)
16. [Unit Testing Requirements](#16-unit-testing-requirements)
17. [Use Cases](#17-use-cases)
18. [Deliverable Checklist](#18-deliverable-checklist)
19. [Acceptance Criteria](#19-acceptance-criteria)
20. [Dependencies](#20-dependencies)
21. [Future Considerations](#21-future-considerations)
22. [Appendix: Quest Design Patterns](#22-appendix-quest-design-patterns)

---

## 1. Executive Summary

Version 0.14.10b introduces the **Quest Schema** (`quests.schema.json`), which provides a comprehensive JSON Schema Draft-07 specification for validating quest definitions. This schema enables full customization of quest structure, objectives, stages, prerequisites, rewards, branching paths, and failure conditions—all without code changes.

The Quest Schema integrates with the Faction Schema (v0.14.10a) for reputation rewards, dialogue outcomes (v0.14.9a) through `QuestUpdate` references, and the Codex Schema (v0.14.10c) for discovery objectives. This schema supports the narrative-driven quest system of Rune & Rust, where player choices create meaningful consequences through modular objective paths.

### Key Deliverables

| Category | Items |
|----------|-------|
| **Schema Files** | `quests.schema.json` (JSON Schema Draft-07) |
| **Schema Definitions** | `Quest`, `QuestStage`, `Objective`, `Prerequisite`, `Reward`, `QuestBranch`, `FailureCondition`, `QuestGiver` |
| **Configuration Files** | `quests.json` with example quests |
| **Tests** | ~6 new unit tests |

### Architectural Significance

This version provides:
- **Quest identity** - ID, name, description, category, level, tags
- **Quest categories** - 8 types (MainStory, SideQuest, FactionQuest, Bounty, Exploration, Crafting, Daily, Event)
- **Quest stages** - Sequential progression with objectives
- **Objective types** - 12 types (Kill, Collect, Talk, Explore, Escort, Defend, Craft, Discover, Deliver, Use, Survive, Reach)
- **Prerequisites** - 9 types (Level, QuestComplete, QuestActive, FactionReputation, HasItem, HasAbility, HasFlag, ClassIs, RaceIs)
- **Rewards** - 8 types (Experience, Gold, Item, Reputation, Ability, Title, Unlock, Flag)
- **Branching paths** - Multiple endings with conditional triggers
- **Failure conditions** - 6 types with consequences
- **Quest giver** - NPC references with turn-in locations

### Relationship to Other Schemas

```
┌─────────────────────────────────────────────────────────────────────────────┐
│              v0.14.10 GAME SYSTEMS CONFIGURATION SCHEMAS                     │
└─────────────────────────────────────────────────────────────────────────────┘

  ┌─────────────────────────────────────────────────────────────────────────┐
  │  v0.14.10a: factions.schema.json (reputation rewards)                   │
  │  v0.14.10b: quests.schema.json ◀── THIS VERSION                        │
  │  v0.14.10c: codex.schema.json (discovery objectives)                   │
  │  v0.14.10d: commands.schema.json                                       │
  │  v0.14.10e: glossary.schema.json                                       │
  │  v0.14.10f: stances.schema.json                                        │
  └─────────────────────────────────────────────────────────────────────────┘

  Integration Points:
  └── v0.14.9a dialogue.schema.json
      ├── Outcome.Type = "QuestUpdate"
      ├── Outcome.Data → references quest stage/objective
      └── Outcome.Type = "QuestStart" → initiates quest

  └── v0.14.10a factions.schema.json
      └── Reward.Type = "Reputation" → faction reputation change

  Source Material:
  └── docs/design/aethelgard/design/
      ├── 08-ui/quest-journal-ui.md
      └── 99-legacy/rune-rust-docs/spec/world/environment/10_system_quest.md
```

---

## 2. Feature Overview

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                        QUEST SCHEMA FEATURE TREE                             │
└─────────────────────────────────────────────────────────────────────────────┘

quests.schema.json
├── Root Configuration
│   ├── $schema reference
│   ├── version identifier (semver)
│   └── quests (array)
│
├── Quest Definition
│   ├── id (globally unique, kebab-case)
│   ├── name (display name)
│   ├── description (quest log text)
│   ├── category (enum: 8 types)
│   ├── level (recommended level)
│   ├── isRepeatable (boolean)
│   ├── isHidden (secret quests)
│   ├── prerequisites (array)
│   ├── questGiver (object)
│   ├── stages (array, minItems: 1)
│   ├── rewards (array)
│   ├── failureConditions (array)
│   ├── failureConsequences (array)
│   ├── timeLimit (turns, optional)
│   ├── branches (array)
│   └── tags (metadata array)
│
├── QuestCategory Enum
│   ├── MainStory (primary narrative)
│   ├── SideQuest (optional stories)
│   ├── FactionQuest (faction-specific)
│   ├── Bounty (kill targets)
│   ├── Exploration (discover locations)
│   ├── Crafting (create items)
│   ├── Daily (repeatable)
│   └── Event (limited-time)
│
├── QuestStage
│   ├── id (unique within quest)
│   ├── name (stage title)
│   ├── description (stage-specific text)
│   ├── objectives (array, minItems: 1)
│   ├── onComplete (triggered actions)
│   ├── nextStageId (or null = complete)
│   └── isOptional (boolean)
│
├── Objective
│   ├── id (unique within stage)
│   ├── type (enum: 12 types)
│   ├── description (objective text)
│   ├── target (entity reference)
│   ├── quantity (default: 1)
│   ├── location (required location)
│   ├── isOptional (boolean)
│   ├── isHidden (revealed on discovery)
│   └── conditions (array)
│
├── Prerequisite
│   ├── type (enum: 9 types)
│   ├── target (reference ID)
│   ├── value (comparison value)
│   └── operator (enum: 5 operators)
│
├── Reward
│   ├── type (enum: 8 types)
│   ├── target (item/faction/ability ID)
│   ├── amount (integer)
│   ├── isOptional (choice rewards)
│   └── description
│
├── QuestBranch
│   ├── id (unique within quest)
│   ├── condition (trigger)
│   ├── targetStageId (branch destination)
│   └── description
│
├── FailureCondition
│   ├── type (enum: 6 types)
│   ├── target (entity reference)
│   └── description
│
└── QuestGiver
    ├── npcId (reference)
    ├── dialogueNodeId (starting dialogue)
    ├── turnInNpcId (different NPC for turn-in)
    └── turnInDialogueNodeId
```

---

## 3. Architecture Diagrams

### 3.1 Quest System Architecture

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                       QUEST SYSTEM ARCHITECTURE                              │
└─────────────────────────────────────────────────────────────────────────────┘

                    quests.json
          ┌───────────────────────────────────────┐
          │  {                                    │
          │    "$schema": "...",                  │
          │    "version": "1.0.0",                │
          │    "quests": [                        │
          │      {                                │
          │        "id": "iron-path",             │
          │        "name": "The Iron Path",       │
          │        "category": "MainStory",       │
          │        "stages": [...],               │
          │        "rewards": [...],              │
          │        "branches": [...]              │
          │      }                                │
          │    ]                                  │
          │  }                                    │
          └─────────────────┬─────────────────────┘
                            │
                            ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                         QUEST DEFINITION                                     │
│─────────────────────────────────────────────────────────────────────────────│
│  Identity         │  Structure         │  Prerequisites    │  Rewards       │
│  ─────────────────┼────────────────────┼───────────────────┼────────────────│
│  id: iron-path    │  stages: [         │  Level >= 5       │  +500 Legend   │
│  name: Iron Path  │    speak-kjartan   │  QuestComplete:   │  +200 Cogs     │
│  category: Main   │    find-descent    │    intro-quest    │  Iron Blade    │
│  level: 5         │    defeat-lord     │                   │  +50 Faction   │
│                   │    return          │                   │                │
│                   │  ]                 │                   │                │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 3.2 Quest Lifecycle Flow

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                        QUEST LIFECYCLE FLOW                                  │
└─────────────────────────────────────────────────────────────────────────────┘

        NOT_STARTED         AVAILABLE           ACTIVE           COMPLETE
            │                   │                  │                  │
            ▼                   ▼                  ▼                  ▼
       ┌─────────┐         ┌─────────┐        ┌─────────┐        ┌─────────┐
       │ Quest   │ prereqs │ Quest   │ accept │ Quest   │ finish │ Quest   │
       │ defined │───met──▶│ can be  │───────▶│ in      │───────▶│ ready   │
       │ in JSON │         │ offered │        │ progress│        │ turn-in │
       └─────────┘         └─────────┘        └────┬────┘        └────┬────┘
                                                   │                   │
                                                   │                   │
                                                   ▼                   ▼
                                              ┌─────────┐        ┌─────────┐
                                              │ FAILED  │        │ TURNED  │
                                              │         │        │   IN    │
                                              │ failure │        │         │
                                              │ trigger │        │ rewards │
                                              │ hit     │        │ granted │
                                              └─────────┘        └─────────┘

  State Transitions:
  ═══════════════════
  NOT_STARTED → AVAILABLE: All prerequisites met
  AVAILABLE → ACTIVE: Player accepts quest
  ACTIVE → COMPLETE: All required objectives done
  ACTIVE → FAILED: Failure condition triggered
  COMPLETE → TURNED_IN: Player returns to quest giver
```

### 3.3 Stage and Objective Flow

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                      STAGE AND OBJECTIVE FLOW                                │
└─────────────────────────────────────────────────────────────────────────────┘

          Quest: The Iron Path
          ┌───────────────────────────────────────┐
          │  Stage 1: speak-kjartan               │
          │  ─────────────────────────────────────│
          │  Objective: Talk to Kjartan           │
          │  Type: Talk                           │
          │  Target: npc-kjartan                  │
          │  nextStageId: find-descent            │
          └─────────────────┬─────────────────────┘
                            │ ☑ Complete
                            ▼
          ┌───────────────────────────────────────┐
          │  Stage 2: find-descent                │
          │  ─────────────────────────────────────│
          │  Objective: Find the Iron Crypts      │
          │  Type: Explore                        │
          │  Target: location-iron-crypts         │
          │  nextStageId: defeat-lord             │
          │                                       │
          │  [Optional] Objective: Collect notes  │
          │  Type: Collect                        │
          │  Target: item-ancient-notes           │
          └─────────────────┬─────────────────────┘
                            │ ☑ Complete (required)
                            ▼
          ┌───────────────────────────────────────┐
          │  Stage 3: defeat-lord                 │
          │  ─────────────────────────────────────│
          │  Objective: Defeat the Rust Lord      │
          │  Type: Kill                           │
          │  Target: enemy-rust-lord              │
          │  Quantity: 1                          │
          │  nextStageId: return-kjartan          │
          │                                       │
          │  [Branch] Hack console → skip combat  │
          └─────────────────┬─────────────────────┘
                            │ ☑ Complete (any path)
                            ▼
          ┌───────────────────────────────────────┐
          │  Stage 4: return-kjartan              │
          │  ─────────────────────────────────────│
          │  Objective: Return to Kjartan         │
          │  Type: Talk                           │
          │  Target: npc-kjartan                  │
          │  nextStageId: null ◀── QUEST COMPLETE │
          └───────────────────────────────────────┘
```

### 3.4 Modular Objective System

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                      MODULAR OBJECTIVE SYSTEM                                │
└─────────────────────────────────────────────────────────────────────────────┘

  Goal: "Disable the Warden" (Stage objective: disable-warden)

                    ┌───────────────────────────────────────┐
                    │         MAIN OBJECTIVE                 │
                    │  Disable the Warden (incomplete)       │
                    │                                        │
                    │  ┌─────────────────────────────────┐   │
                    │  │  MODULAR SOLUTION PATHS          │   │
                    │  │  (Any one completes objective)   │   │
                    │  └─────────────────────────────────┘   │
                    └─────────────────┬─────────────────────┘
                                      │
              ┌───────────────────────┼───────────────────────┐
              │                       │                       │
              ▼                       ▼                       ▼
    ┌───────────────────┐   ┌───────────────────┐   ┌───────────────────┐
    │ Combat Path       │   │ Technical Path    │   │ Environmental     │
    │ ─────────────────│   │ ─────────────────│   │ Path              │
    │ Type: Kill        │   │ Type: Use         │   │ ─────────────────│
    │ Target: warden    │   │ Target: console   │   │ Type: Use         │
    │ Description:      │   │ Description:      │   │ Target: ceiling   │
    │ Defeat in combat  │   │ Hack the console  │   │ Description:      │
    │                   │   │                   │   │ Trigger collapse  │
    │ conditions:       │   │ conditions:       │   │                   │
    │ [none]            │   │ [HasAbility:hack] │   │ conditions:       │
    └───────────────────┘   └───────────────────┘   │ [InLocation]      │
                                                    └───────────────────┘

  Resolution:
  ═══════════
  • Completing ANY solution path marks main objective complete
  • System tracks which path was taken for narrative outcomes
  • Different paths may grant different bonus rewards
  • Certain paths may affect faction reputation
```

### 3.5 Quest Branching System

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                       QUEST BRANCHING SYSTEM                                 │
└─────────────────────────────────────────────────────────────────────────────┘

          Quest: The Rusted Heart

          Stage: investigate-warden
          ┌───────────────────────────────────────┐
          │  Investigate the rogue Warden         │
          │                                       │
          │  Branches:                            │
          │  ───────────                          │
          │  [1] Combat approach detected         │
          │      → combat-path (stage)            │
          │                                       │
          │  [2] Hacking skill used               │
          │      → technical-path (stage)         │
          │                                       │
          │  [3] Override Protocol item found     │
          │      → heretical-path (stage)         │
          │                                       │
          │  [default] No branch triggered        │
          │      → nextStageId (continue linear)  │
          └─────────────────┬─────────────────────┘
                            │
           ┌────────────────┼────────────────┐
           │                │                │
           ▼                ▼                ▼
    ┌─────────────┐  ┌─────────────┐  ┌─────────────┐
    │ combat-path │  │ tech-path   │  │ heretical   │
    │             │  │             │  │ -path       │
    │ Defeat in   │  │ Hack the    │  │ Use the     │
    │ combat      │  │ console     │  │ Override    │
    │             │  │             │  │ Protocol    │
    │ Reward:     │  │ Reward:     │  │ Reward:     │
    │ +50 Rep     │  │ +25 Rep     │  │ -50 Rep     │
    │ (Iron-Banes)│  │ (Rust Clans)│  │ (Iron-Banes)│
    └──────┬──────┘  └──────┬──────┘  └──────┬──────┘
           │                │                │
           └────────────────┼────────────────┘
                            │
                            ▼
          ┌───────────────────────────────────────┐
          │  All paths converge                   │
          │  Stage: report-findings               │
          │  (Dialogue varies based on path)      │
          └───────────────────────────────────────┘
```

### 3.6 Dialogue Integration Flow

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                      DIALOGUE INTEGRATION FLOW                               │
└─────────────────────────────────────────────────────────────────────────────┘

              Dialogue Outcome (from v0.14.9a)
          ┌───────────────────────────────────────┐
          │  {                                    │
          │    "Outcome": {                       │
          │      "Type": "QuestStart",            │
          │      "Data": "iron-path"              │◀── References quest ID
          │    }                                  │
          │  }                                    │
          └─────────────────┬─────────────────────┘
                            │
                            ▼
          ┌───────────────────────────────────────┐
          │         QUEST LOOKUP                   │
          │─────────────────────────────────────── │
          │  1. Parse Data value (quest ID)        │
          │  2. Look up quest by ID                │
          │  3. Validate quest exists              │
          │  4. Check prerequisites                │
          │  5. If met, add to player's active     │
          │  6. Set first stage as current         │
          │  7. Fire QuestStarted event            │
          └─────────────────────────────────────── ┘
                            │
                            ▼
          ┌───────────────────────────────────────┐
          │         UI NOTIFICATION                │
          │  ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ │
          │  ★ New Contract: The Iron Path        │
          │  Objective: Speak with Kjartan        │
          │  ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ │
          └───────────────────────────────────────┘

  QuestUpdate Outcome:
  ════════════════════
  {
    "Outcome": {
      "Type": "QuestUpdate",
      "Data": "iron-path:find-descent"   ← quest-id:stage-id
    }
  }
  → Advances quest to specified stage
```

### 3.7 Schema Layer Diagram

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           SCHEMA LAYER DIAGRAM                               │
└─────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────┐
│                              PRESENTATION                                    │
│                                                                              │
│  Quest Journal displays active quests, objectives, and progress              │
│  • Contracts tab in Scavenger's Journal                                      │
│  • Active/Available/Completed/Failed tabs                                    │
│  • HUD tracking widget for current objective                                 │
│  • Quest completion notifications                                            │
└─────────────────────────────────────────────────────────────────────────────┘
                                     │
                                     ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                              APPLICATION                                     │
│                                                                              │
│  QuestService manages quest lifecycle and objective tracking                 │
│  • StartQuest(questId) → initiates quest                                     │
│  • UpdateObjective(questId, objectiveId, progress) → tracks progress         │
│  • CompleteStage(questId, stageId) → advances to next stage                  │
│  • CanAcceptQuest(questId) → checks prerequisites                            │
│  • GetActiveQuests() → returns player's current quests                       │
│  • TurnInQuest(questId) → grants rewards                                     │
│  • FailQuest(questId, reason) → handles failure                              │
└─────────────────────────────────────────────────────────────────────────────┘
                                     │
                                     ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                             DOMAIN LAYER                                     │
│                                                                              │
│  Quest definitions and value objects                                         │
│  • Quest entity (identity, stages, rewards, branches)                        │
│  • QuestStage value object (objectives, next stage)                          │
│  • Objective value object (type, target, quantity)                           │
│  • Prerequisite value object (type, target, operator)                        │
│  • Reward value object (type, amount, target)                                │
│  • QuestBranch value object (condition, destination)                         │
│  • FailureCondition value object (type, target)                              │
│  • QuestGiver value object (NPC, dialogue references)                        │
└─────────────────────────────────────────────────────────────────────────────┘
                                     │
                                     ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                           INFRASTRUCTURE                                     │
│                                                                              │
│  QuestProvider loads from JSON with schema validation                        │
│  • LoadQuests() → reads config/quests.json                                   │
│  • Validates against config/schemas/quests.schema.json                       │
│  • Builds quest lookup by ID                                                 │
│  • Validates prerequisite references                                         │
│  • Validates faction references (from v0.14.10a)                             │
│  • Logs warnings for invalid references                                      │
└─────────────────────────────────────────────────────────────────────────────┘
                                     │
                                     ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                            CONFIGURATION                                     │
│                                                                              │
│  config/schemas/quests.schema.json (Draft-07)                                │
│  config/quests.json (quest definitions)                                      │
│                                                                              │
│  Related Schemas:                                                            │
│  • dialogue.schema.json (v0.14.9a) → QuestStart/QuestUpdate outcomes         │
│  • factions.schema.json (v0.14.10a) → Reputation rewards                     │
│  • codex.schema.json (v0.14.10c) → Discover objectives                       │
│  • items.schema.json (v0.14.2) → Item rewards                                │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 4. Schema Root Definition

### 4.1 Root Configuration Properties

The quest schema defines a collection of quest definitions.

| Property | Type | Required | Default | Description |
|----------|------|----------|---------|-------------|
| `$schema` | string | No | - | JSON Schema reference |
| `version` | string | **Yes** | - | Schema version (semver format) |
| `quests` | array | **Yes** | - | Array of quest definitions |

### 4.2 Quest Category Defaults

Each quest category has recommended characteristics:

| Category | Typical Level | Repeatable | Rewards |
|----------|---------------|------------|---------|
| `MainStory` | Story-gated | No | High XP, artifacts, story progression |
| `SideQuest` | Variable | No | Moderate XP, unique items |
| `FactionQuest` | Faction-gated | Some | Reputation, faction items |
| `Bounty` | Variable | Yes | Gold, minor XP |
| `Exploration` | None | No | Codex entries, lore |
| `Crafting` | Skill-gated | Yes | Recipes, materials |
| `Daily` | None | Yes | Currency, resources |
| `Event` | Time-limited | No | Unique rewards |

### 4.3 Schema Version Control

The `version` field enables migration support:

| Version Pattern | Description |
|-----------------|-------------|
| `1.0.0` | Initial release |
| `1.1.0` | Minor additions (backward compatible) |
| `2.0.0` | Breaking changes |

---

## 5. Quest Definition

### 5.1 Core Properties

| Property | Type | Required | Default | Description |
|----------|------|----------|---------|-------------|
| `id` | string | **Yes** | - | Unique quest identifier (kebab-case) |
| `name` | string | **Yes** | - | Display name for UI |
| `description` | string | **Yes** | - | Quest log description text |
| `category` | string | **Yes** | - | Quest category (enum) |
| `level` | integer | No | null | Recommended player level |
| `isRepeatable` | boolean | No | false | Can be repeated after completion |
| `isHidden` | boolean | No | false | Secret quest (hidden until discovered) |
| `prerequisites` | array | No | [] | Requirements to accept |
| `questGiver` | object | No | null | Quest giver configuration |
| `stages` | array | **Yes** | - | Quest stages (minItems: 1) |
| `rewards` | array | No | [] | Completion rewards |
| `failureConditions` | array | No | null | Conditions that fail the quest |
| `failureConsequences` | array | No | null | Effects when quest fails |
| `timeLimit` | integer | No | null | Turns to complete (null = no limit) |
| `branches` | array | No | null | Branching path definitions |
| `tags` | array | No | [] | Metadata tags for filtering |

### 5.2 Identity Properties

| Property | Constraint | Example |
|----------|------------|---------|
| `id` | Pattern: `^[a-z][a-z0-9-]*$` | `"iron-path"` |
| `name` | minLength: 1 | `"The Iron Path"` |
| `description` | minLength: 10 | `"Legends speak of an ancient forge..."` |

### 5.3 Quest Giver Configuration

```json
{
  "questGiver": {
    "npcId": "npc-kjartan",
    "dialogueNodeId": "kjartan-quest-offer",
    "turnInNpcId": "npc-kjartan",
    "turnInDialogueNodeId": "kjartan-quest-complete"
  }
}
```

| Property | Type | Required | Description |
|----------|------|----------|-------------|
| `npcId` | string | **Yes** | Reference to NPC definition |
| `dialogueNodeId` | string | No | Starting dialogue node |
| `turnInNpcId` | string | No | Different NPC for turn-in (null = same) |
| `turnInDialogueNodeId` | string | No | Turn-in dialogue node |

---

## 6. QuestCategory Enum

### 6.1 Category Types

| Category | Symbol | Color | Description |
|----------|--------|-------|-------------|
| `MainStory` | `★` | Gold | Primary narrative quests |
| `SideQuest` | `○` | White | Optional character stories |
| `FactionQuest` | `◆` | Faction | Faction-specific tasks |
| `Bounty` | `✕` | Red | Kill target quests |
| `Exploration` | `◎` | Cyan | Discover locations |
| `Crafting` | `⚒` | Orange | Create items |
| `Daily` | `↻` | Green | Repeatable dailies |
| `Event` | `⚡` | Purple | Limited-time quests |

### 6.2 Category Characteristics

| Category | Narrative | Repeatable | Time-Limited | Primary Reward |
|----------|-----------|------------|--------------|----------------|
| `MainStory` | Heavy | No | No | Story + Artifacts |
| `SideQuest` | Moderate | No | No | Unique Items |
| `FactionQuest` | Light | Some | No | Reputation |
| `Bounty` | Minimal | Yes | No | Gold |
| `Exploration` | Lore | No | No | Codex + Lore |
| `Crafting` | Minimal | Yes | No | Recipes |
| `Daily` | None | Yes | Daily Reset | Currency |
| `Event` | Thematic | No | Yes | Limited Items |

### 6.3 Category Usage Examples

```json
// MainStory - Primary narrative quest
{ "category": "MainStory", "name": "The Iron Path", "level": 5 }

// SideQuest - Optional story
{ "category": "SideQuest", "name": "Lost Tools", "level": null }

// FactionQuest - Faction reputation
{ "category": "FactionQuest", "name": "Salvage Run", "tags": ["rust-clans"] }

// Bounty - Repeatable kill quest
{ "category": "Bounty", "name": "Clear the Corridor", "isRepeatable": true }

// Exploration - Discovery quest
{ "category": "Exploration", "name": "The Hidden Cache", "isHidden": true }

// Daily - Repeatable daily
{ "category": "Daily", "name": "Patrol Duty", "isRepeatable": true }
```

---

## 7. QuestStage Definition

### 7.1 Stage Structure

```json
{
  "id": "find-descent",
  "name": "Find the Descent",
  "description": "Locate the entrance to the Iron Crypts beneath Ironhold.",
  "objectives": [
    {
      "id": "locate-entrance",
      "type": "Explore",
      "description": "Find the descent to the Iron Crypts",
      "target": "location-iron-crypts-entrance"
    }
  ],
  "onComplete": [
    {
      "type": "Notification",
      "data": "You've found the entrance. The darkness beckons."
    }
  ],
  "nextStageId": "defeat-lord",
  "isOptional": false
}
```

| Property | Type | Required | Default | Description |
|----------|------|----------|---------|-------------|
| `id` | string | **Yes** | - | Unique stage identifier within quest |
| `name` | string | **Yes** | - | Stage title |
| `description` | string | **Yes** | - | Stage-specific description |
| `objectives` | array | **Yes** | - | Objectives for this stage (minItems: 1) |
| `onComplete` | array | No | null | Actions triggered when stage completes |
| `nextStageId` | string | No | null | Next stage ID (null = quest complete) |
| `isOptional` | boolean | No | false | Optional stage (can be skipped) |

### 7.2 Stage Sequencing

```
Stage 1 (speak-kjartan)
    │
    │ nextStageId: "find-descent"
    ▼
Stage 2 (find-descent)
    │
    │ nextStageId: "defeat-lord"
    ▼
Stage 3 (defeat-lord)
    │
    │ nextStageId: "return-kjartan"
    ▼
Stage 4 (return-kjartan)
    │
    │ nextStageId: null ◀── QUEST COMPLETE
    ▼
[Quest Complete]
```

### 7.3 Stage Completion Actions

| Action Type | Description | Example |
|-------------|-------------|---------|
| `Notification` | Show message to player | "The way is clear." |
| `SpawnEnemy` | Spawn enemy at location | Trigger boss appearance |
| `UnlockArea` | Unlock a previously locked area | Open sealed door |
| `GrantItem` | Give item to player | Quest-specific key |
| `UpdateWorldState` | Modify world state flag | "forge_discovered" |
| `TriggerEvent` | Fire a game event | Environmental change |

---

## 8. Objective Definition

### 8.1 Objective Types

| Type | Target | Description | Example |
|------|--------|-------------|---------|
| `Kill` | Enemy ID | Defeat specific enemies | Defeat Rust Lord (0/1) |
| `Collect` | Item ID | Gather items | Collect Dvergr Hammers (2/5) |
| `Talk` | NPC ID | Speak with an NPC | Talk to Kjartan |
| `Explore` | Location ID | Visit a location | Find the Iron Crypts |
| `Escort` | NPC ID | Protect NPC to destination | Escort the Scholar |
| `Defend` | Location ID | Protect location for duration | Defend the Gate (3 turns) |
| `Craft` | Item ID | Create specific item | Forge the Rune-Key |
| `Discover` | Codex Entry ID | Find lore/knowledge | Discover ancient texts |
| `Deliver` | Item ID + NPC ID | Bring item to NPC | Deliver package to Bjorn |
| `Use` | Item/Object ID | Interact with object | Activate the console |
| `Survive` | Duration | Stay alive for duration | Survive the ambush |
| `Reach` | Location ID | Arrive at destination | Reach the summit |

### 8.2 Objective Structure

```json
{
  "id": "collect-hammers",
  "type": "Collect",
  "description": "Collect Dvergr Hammers",
  "target": "item-dvergr-hammer",
  "quantity": 5,
  "location": null,
  "isOptional": false,
  "isHidden": false,
  "conditions": null
}
```

| Property | Type | Required | Default | Description |
|----------|------|----------|---------|-------------|
| `id` | string | **Yes** | - | Unique identifier within stage |
| `type` | string | **Yes** | - | Objective type (enum) |
| `description` | string | **Yes** | - | Objective text shown to player |
| `target` | string | No | null | Entity reference (enemy, item, NPC, location) |
| `quantity` | integer | No | 1 | Number required |
| `location` | string | No | null | Required location (null = any) |
| `isOptional` | boolean | No | false | Optional objective |
| `isHidden` | boolean | No | false | Hidden until discovered |
| `conditions` | array | No | null | Additional conditions |

### 8.3 Modular Objective System

The modular objective system allows multiple solution paths:

```json
{
  "objectives": [
    {
      "id": "disable-warden-main",
      "type": "Custom",
      "description": "Disable the Warden",
      "isOptional": false,
      "conditions": [
        { "type": "AnyObjectiveComplete", "targets": ["combat-path", "tech-path", "env-path"] }
      ]
    },
    {
      "id": "combat-path",
      "type": "Kill",
      "description": "Defeat the Warden in combat",
      "target": "enemy-warden",
      "isHidden": true
    },
    {
      "id": "tech-path",
      "type": "Use",
      "description": "Hack the command console",
      "target": "object-command-console",
      "isHidden": true,
      "conditions": [{ "type": "HasAbility", "target": "ability-hack" }]
    },
    {
      "id": "env-path",
      "type": "Use",
      "description": "Trigger the ceiling collapse",
      "target": "object-ceiling-support",
      "isHidden": true,
      "conditions": [{ "type": "InLocation", "target": "location-unstable-room" }]
    }
  ]
}
```

---

## 9. Prerequisite Definition

### 9.1 Prerequisite Types

| Type | Target | Value | Description |
|------|--------|-------|-------------|
| `Level` | - | integer | Player level requirement |
| `QuestComplete` | Quest ID | - | Completed quest requirement |
| `QuestActive` | Quest ID | - | Active quest requirement |
| `FactionReputation` | Faction ID | integer | Minimum faction reputation |
| `HasItem` | Item ID | integer | Has item in inventory |
| `HasAbility` | Ability ID | - | Has unlocked ability |
| `HasFlag` | Flag name | - | World state flag is set |
| `ClassIs` | Class ID | - | Player is specific class |
| `RaceIs` | Race ID | - | Player is specific race |

### 9.2 Prerequisite Structure

```json
{
  "prerequisites": [
    {
      "type": "Level",
      "target": null,
      "value": 5,
      "operator": "greaterThan"
    },
    {
      "type": "QuestComplete",
      "target": "intro-quest",
      "value": null,
      "operator": "equals"
    },
    {
      "type": "FactionReputation",
      "target": "rust-clans",
      "value": 500,
      "operator": "greaterThan"
    }
  ]
}
```

| Property | Type | Required | Description |
|----------|------|----------|-------------|
| `type` | string | **Yes** | Prerequisite type (enum) |
| `target` | string | Varies | Target reference (quest ID, faction ID, etc.) |
| `value` | varies | Varies | Comparison value |
| `operator` | string | **Yes** | Comparison operator |

### 9.3 Prerequisite Operators

| Operator | Description | Example |
|----------|-------------|---------|
| `equals` | Exact match | Level = 5 |
| `greaterThan` | Greater than | Level > 5 |
| `lessThan` | Less than | Reputation < 1000 |
| `has` | Has item/ability/flag | Has hacking ability |
| `notHas` | Does not have | Does not have curse |

---

## 10. Reward Definition

### 10.1 Reward Types

| Type | Target | Amount | Description |
|------|--------|--------|-------------|
| `Experience` | - | integer | XP / Legend points |
| `Gold` | Currency ID | integer | Currency reward |
| `Item` | Item ID | integer | Item reward (quantity) |
| `Reputation` | Faction ID | integer | Faction reputation change |
| `Ability` | Ability ID | - | Unlock ability |
| `Title` | Title ID | - | Grant title |
| `Unlock` | Unlock ID | - | Unlock content (area, feature) |
| `Flag` | Flag name | - | Set world state flag |

### 10.2 Reward Structure

```json
{
  "rewards": [
    {
      "type": "Experience",
      "target": null,
      "amount": 500,
      "isOptional": false,
      "description": "+500 Legend"
    },
    {
      "type": "Gold",
      "target": "cogs",
      "amount": 200,
      "isOptional": false,
      "description": "+200 Dvergr Cogs"
    },
    {
      "type": "Item",
      "target": "item-rune-etched-blade",
      "amount": 1,
      "isOptional": false,
      "description": "Rune-Etched Blade [Rare]"
    },
    {
      "type": "Reputation",
      "target": "iron-banes",
      "amount": 50,
      "isOptional": false,
      "description": "+50 Iron-Banes Reputation"
    }
  ]
}
```

| Property | Type | Required | Default | Description |
|----------|------|----------|---------|-------------|
| `type` | string | **Yes** | - | Reward type (enum) |
| `target` | string | Varies | null | Target reference (item, faction, etc.) |
| `amount` | integer | Varies | null | Reward amount |
| `isOptional` | boolean | No | false | Choice reward (player picks) |
| `description` | string | No | null | Display text for reward |

### 10.3 Choice Rewards

For quests with multiple reward options:

```json
{
  "rewards": [
    {
      "type": "Experience",
      "amount": 500,
      "isOptional": false
    },
    {
      "type": "Item",
      "target": "item-warriors-blade",
      "amount": 1,
      "isOptional": true,
      "description": "Warrior's Blade - Choose this for melee combat"
    },
    {
      "type": "Item",
      "target": "item-scholars-staff",
      "amount": 1,
      "isOptional": true,
      "description": "Scholar's Staff - Choose this for magic"
    }
  ]
}
```

---

## 11. QuestBranch Definition

### 11.1 Branch Structure

```json
{
  "branches": [
    {
      "id": "combat-approach",
      "condition": {
        "type": "ObjectiveComplete",
        "target": "combat-path"
      },
      "targetStageId": "combat-resolution",
      "description": "Player chose direct combat approach"
    },
    {
      "id": "tech-approach",
      "condition": {
        "type": "ObjectiveComplete",
        "target": "tech-path"
      },
      "targetStageId": "tech-resolution",
      "description": "Player chose hacking approach"
    }
  ]
}
```

| Property | Type | Required | Description |
|----------|------|----------|-------------|
| `id` | string | **Yes** | Unique branch identifier |
| `condition` | object | **Yes** | Trigger condition |
| `targetStageId` | string | **Yes** | Destination stage ID |
| `description` | string | No | Branch description (for debugging) |

### 11.2 Branch Conditions

| Condition Type | Description | Example |
|----------------|-------------|---------|
| `ObjectiveComplete` | Specific objective completed | Hacked the console |
| `HasItem` | Player has specific item | Has Override Protocol |
| `FactionReputation` | Meets faction threshold | Allied with Iron-Banes |
| `DialogueChoice` | Specific dialogue choice made | Chose aggressive option |
| `TimeExpired` | Time limit reached | 5 turns passed |
| `CustomFlag` | World state flag check | forge_discovered = true |

### 11.3 Multiple Endings

Branches can lead to different quest endings:

```json
{
  "stages": [
    { "id": "investigate", "nextStageId": "resolve" },
    {
      "id": "resolve",
      "objectives": [...],
      "nextStageId": null
    },
    {
      "id": "combat-resolution",
      "objectives": [...],
      "nextStageId": null
    },
    {
      "id": "tech-resolution",
      "objectives": [...],
      "nextStageId": null
    }
  ],
  "branches": [
    { "id": "to-combat", "condition": {...}, "targetStageId": "combat-resolution" },
    { "id": "to-tech", "condition": {...}, "targetStageId": "tech-resolution" }
  ]
}
```

---

## 12. FailureCondition Definition

### 12.1 Failure Types

| Type | Target | Description |
|------|--------|-------------|
| `NPCDeath` | NPC ID | Protected NPC dies |
| `TimeExpired` | - | Quest time limit exceeded |
| `ItemLost` | Item ID | Required item destroyed/sold |
| `LocationLeft` | Location ID | Left required area |
| `PlayerDeath` | - | Player dies during quest |
| `FactionHostile` | Faction ID | Faction becomes hostile |

### 12.2 Failure Consequences

```json
{
  "failureConditions": [
    {
      "type": "NPCDeath",
      "target": "npc-scholar",
      "description": "The Scholar dies"
    },
    {
      "type": "TimeExpired",
      "target": null,
      "description": "The ritual completes before you can stop it"
    }
  ],
  "failureConsequences": [
    {
      "type": "Reputation",
      "target": "rust-clans",
      "amount": -50,
      "description": "Lost reputation with Rust Clans"
    },
    {
      "type": "Flag",
      "target": "scholar_dead",
      "description": "The Scholar is permanently lost"
    },
    {
      "type": "LockQuest",
      "target": "scholars-secret",
      "description": "Cannot access the Scholar's secret quest"
    }
  ]
}
```

| Consequence Type | Description |
|------------------|-------------|
| `Reputation` | Faction reputation loss |
| `Flag` | Set world state flag |
| `LockQuest` | Permanently lock another quest |
| `SpawnEnemy` | Hostile spawn |
| `ItemLoss` | Remove item from inventory |
| `Notification` | Show failure message |

---

## 13. Configuration Schema

### Complete `quests.schema.json`

```json
{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "https://rune-game.com/schemas/quests.schema.json",
  "title": "Quest Configuration",
  "description": "Schema for quest definitions in Rune & Rust.",
  "type": "object",
  "properties": {
    "$schema": {
      "type": "string",
      "description": "Reference to this schema file"
    },
    "version": {
      "type": "string",
      "description": "Schema version for migration tracking (semver format)",
      "pattern": "^\\d+\\.\\d+\\.\\d+$",
      "examples": ["1.0.0"]
    },
    "quests": {
      "type": "array",
      "description": "Array of quest definitions",
      "items": {
        "$ref": "#/definitions/Quest"
      },
      "minItems": 1
    }
  },
  "required": ["version", "quests"],
  "additionalProperties": false,
  "definitions": {
    "Quest": {
      "type": "object",
      "description": "A single quest definition",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique quest identifier (kebab-case)",
          "pattern": "^[a-z][a-z0-9-]*$",
          "examples": ["iron-path", "lost-tools", "patrol-route"]
        },
        "name": {
          "type": "string",
          "description": "Display name for UI",
          "minLength": 1,
          "examples": ["The Iron Path", "Lost Tools"]
        },
        "description": {
          "type": "string",
          "description": "Quest log description text",
          "minLength": 10
        },
        "category": {
          "type": "string",
          "description": "Quest category",
          "enum": ["MainStory", "SideQuest", "FactionQuest", "Bounty", "Exploration", "Crafting", "Daily", "Event"]
        },
        "level": {
          "type": ["integer", "null"],
          "description": "Recommended player level (null = no recommendation)",
          "minimum": 1,
          "maximum": 100,
          "default": null
        },
        "isRepeatable": {
          "type": "boolean",
          "description": "Can be repeated after completion",
          "default": false
        },
        "isHidden": {
          "type": "boolean",
          "description": "Secret quest (hidden until discovered)",
          "default": false
        },
        "prerequisites": {
          "type": "array",
          "description": "Requirements to accept this quest",
          "items": {
            "$ref": "#/definitions/Prerequisite"
          },
          "default": []
        },
        "questGiver": {
          "$ref": "#/definitions/QuestGiver",
          "description": "Quest giver configuration"
        },
        "stages": {
          "type": "array",
          "description": "Quest stages in sequence",
          "items": {
            "$ref": "#/definitions/QuestStage"
          },
          "minItems": 1
        },
        "rewards": {
          "type": "array",
          "description": "Rewards granted on completion",
          "items": {
            "$ref": "#/definitions/Reward"
          },
          "default": []
        },
        "failureConditions": {
          "type": ["array", "null"],
          "description": "Conditions that fail the quest",
          "items": {
            "$ref": "#/definitions/FailureCondition"
          },
          "default": null
        },
        "failureConsequences": {
          "type": ["array", "null"],
          "description": "Effects when quest fails",
          "items": {
            "$ref": "#/definitions/Consequence"
          },
          "default": null
        },
        "timeLimit": {
          "type": ["integer", "null"],
          "description": "Turns to complete (null = no limit)",
          "minimum": 1,
          "default": null
        },
        "branches": {
          "type": ["array", "null"],
          "description": "Branching path definitions",
          "items": {
            "$ref": "#/definitions/QuestBranch"
          },
          "default": null
        },
        "tags": {
          "type": "array",
          "description": "Metadata tags for filtering",
          "items": {
            "type": "string"
          },
          "default": []
        }
      },
      "required": ["id", "name", "description", "category", "stages"],
      "additionalProperties": false
    },
    "QuestStage": {
      "type": "object",
      "description": "A single quest stage",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique stage identifier within quest",
          "pattern": "^[a-z][a-z0-9-]*$"
        },
        "name": {
          "type": "string",
          "description": "Stage title",
          "minLength": 1
        },
        "description": {
          "type": "string",
          "description": "Stage-specific description",
          "minLength": 5
        },
        "objectives": {
          "type": "array",
          "description": "Objectives for this stage",
          "items": {
            "$ref": "#/definitions/Objective"
          },
          "minItems": 1
        },
        "onComplete": {
          "type": ["array", "null"],
          "description": "Actions triggered when stage completes",
          "items": {
            "$ref": "#/definitions/StageAction"
          },
          "default": null
        },
        "nextStageId": {
          "type": ["string", "null"],
          "description": "Next stage ID (null = quest complete)",
          "default": null
        },
        "isOptional": {
          "type": "boolean",
          "description": "Optional stage (can be skipped)",
          "default": false
        }
      },
      "required": ["id", "name", "description", "objectives"],
      "additionalProperties": false
    },
    "Objective": {
      "type": "object",
      "description": "A single objective within a stage",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique objective identifier within stage",
          "pattern": "^[a-z][a-z0-9-]*$"
        },
        "type": {
          "type": "string",
          "description": "Objective type",
          "enum": ["Kill", "Collect", "Talk", "Explore", "Escort", "Defend", "Craft", "Discover", "Deliver", "Use", "Survive", "Reach"]
        },
        "description": {
          "type": "string",
          "description": "Objective text shown to player",
          "minLength": 5
        },
        "target": {
          "type": ["string", "null"],
          "description": "Entity reference (enemy, item, NPC, location ID)",
          "default": null
        },
        "quantity": {
          "type": "integer",
          "description": "Number required",
          "minimum": 1,
          "default": 1
        },
        "location": {
          "type": ["string", "null"],
          "description": "Required location (null = any)",
          "default": null
        },
        "isOptional": {
          "type": "boolean",
          "description": "Optional objective",
          "default": false
        },
        "isHidden": {
          "type": "boolean",
          "description": "Hidden until discovered",
          "default": false
        },
        "conditions": {
          "type": ["array", "null"],
          "description": "Additional conditions for objective",
          "items": {
            "$ref": "#/definitions/ObjectiveCondition"
          },
          "default": null
        }
      },
      "required": ["id", "type", "description"],
      "additionalProperties": false
    },
    "ObjectiveCondition": {
      "type": "object",
      "description": "Condition for objective completion or visibility",
      "properties": {
        "type": {
          "type": "string",
          "description": "Condition type",
          "enum": ["HasAbility", "HasItem", "InLocation", "FactionReputation", "AnyObjectiveComplete", "CustomFlag"]
        },
        "target": {
          "type": ["string", "array"],
          "description": "Condition target(s)"
        },
        "value": {
          "type": ["string", "integer", "boolean", "null"],
          "description": "Condition value"
        }
      },
      "required": ["type", "target"],
      "additionalProperties": false
    },
    "Prerequisite": {
      "type": "object",
      "description": "Requirement to accept a quest",
      "properties": {
        "type": {
          "type": "string",
          "description": "Prerequisite type",
          "enum": ["Level", "QuestComplete", "QuestActive", "FactionReputation", "HasItem", "HasAbility", "HasFlag", "ClassIs", "RaceIs"]
        },
        "target": {
          "type": ["string", "null"],
          "description": "Target reference (quest ID, faction ID, etc.)",
          "default": null
        },
        "value": {
          "type": ["integer", "string", "null"],
          "description": "Comparison value"
        },
        "operator": {
          "type": "string",
          "description": "Comparison operator",
          "enum": ["equals", "greaterThan", "lessThan", "has", "notHas"],
          "default": "equals"
        }
      },
      "required": ["type", "operator"],
      "additionalProperties": false
    },
    "Reward": {
      "type": "object",
      "description": "Reward for completing the quest",
      "properties": {
        "type": {
          "type": "string",
          "description": "Reward type",
          "enum": ["Experience", "Gold", "Item", "Reputation", "Ability", "Title", "Unlock", "Flag"]
        },
        "target": {
          "type": ["string", "null"],
          "description": "Target reference (item ID, faction ID, etc.)",
          "default": null
        },
        "amount": {
          "type": ["integer", "null"],
          "description": "Reward amount",
          "default": null
        },
        "isOptional": {
          "type": "boolean",
          "description": "Choice reward (player picks)",
          "default": false
        },
        "description": {
          "type": ["string", "null"],
          "description": "Display text for reward",
          "default": null
        }
      },
      "required": ["type"],
      "additionalProperties": false
    },
    "QuestBranch": {
      "type": "object",
      "description": "A branching path in the quest",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique branch identifier",
          "pattern": "^[a-z][a-z0-9-]*$"
        },
        "condition": {
          "$ref": "#/definitions/BranchCondition",
          "description": "Trigger condition for this branch"
        },
        "targetStageId": {
          "type": "string",
          "description": "Destination stage ID"
        },
        "description": {
          "type": ["string", "null"],
          "description": "Branch description (for debugging)",
          "default": null
        }
      },
      "required": ["id", "condition", "targetStageId"],
      "additionalProperties": false
    },
    "BranchCondition": {
      "type": "object",
      "description": "Condition that triggers a branch",
      "properties": {
        "type": {
          "type": "string",
          "description": "Condition type",
          "enum": ["ObjectiveComplete", "HasItem", "FactionReputation", "DialogueChoice", "TimeExpired", "CustomFlag"]
        },
        "target": {
          "type": "string",
          "description": "Condition target"
        },
        "value": {
          "type": ["string", "integer", "boolean", "null"],
          "description": "Condition value"
        }
      },
      "required": ["type", "target"],
      "additionalProperties": false
    },
    "FailureCondition": {
      "type": "object",
      "description": "Condition that fails the quest",
      "properties": {
        "type": {
          "type": "string",
          "description": "Failure condition type",
          "enum": ["NPCDeath", "TimeExpired", "ItemLost", "LocationLeft", "PlayerDeath", "FactionHostile"]
        },
        "target": {
          "type": ["string", "null"],
          "description": "Target reference (NPC ID, item ID, etc.)",
          "default": null
        },
        "description": {
          "type": "string",
          "description": "Description of the failure condition",
          "minLength": 5
        }
      },
      "required": ["type", "description"],
      "additionalProperties": false
    },
    "Consequence": {
      "type": "object",
      "description": "Effect when quest fails",
      "properties": {
        "type": {
          "type": "string",
          "description": "Consequence type",
          "enum": ["Reputation", "Flag", "LockQuest", "SpawnEnemy", "ItemLoss", "Notification"]
        },
        "target": {
          "type": ["string", "null"],
          "description": "Target reference",
          "default": null
        },
        "amount": {
          "type": ["integer", "null"],
          "description": "Amount (for Reputation type)",
          "default": null
        },
        "description": {
          "type": ["string", "null"],
          "description": "Description of the consequence",
          "default": null
        }
      },
      "required": ["type"],
      "additionalProperties": false
    },
    "StageAction": {
      "type": "object",
      "description": "Action triggered on stage completion",
      "properties": {
        "type": {
          "type": "string",
          "description": "Action type",
          "enum": ["Notification", "SpawnEnemy", "UnlockArea", "GrantItem", "UpdateWorldState", "TriggerEvent"]
        },
        "target": {
          "type": ["string", "null"],
          "description": "Action target"
        },
        "data": {
          "type": ["string", "null"],
          "description": "Action data (message text, etc.)"
        }
      },
      "required": ["type"],
      "additionalProperties": false
    },
    "QuestGiver": {
      "type": "object",
      "description": "Quest giver configuration",
      "properties": {
        "npcId": {
          "type": "string",
          "description": "Reference to NPC definition",
          "pattern": "^[a-z][a-z0-9-]*$"
        },
        "dialogueNodeId": {
          "type": ["string", "null"],
          "description": "Starting dialogue node ID",
          "default": null
        },
        "turnInNpcId": {
          "type": ["string", "null"],
          "description": "Different NPC for turn-in (null = same as giver)",
          "default": null
        },
        "turnInDialogueNodeId": {
          "type": ["string", "null"],
          "description": "Turn-in dialogue node ID",
          "default": null
        }
      },
      "required": ["npcId"],
      "additionalProperties": false
    }
  }
}
```

---

## 14. Example Configuration File

### Complete `quests.json`

```json
{
  "$schema": "../schemas/quests.schema.json",
  "version": "1.0.0",
  "quests": [
    {
      "id": "iron-path",
      "name": "The Iron Path",
      "description": "Legends speak of an ancient Dvergr forge, hidden beneath Ironhold. Kjartan the Smith believes it may hold the key to breaking the Rust Curse that plagues the eastern valleys.",
      "category": "MainStory",
      "level": 5,
      "isRepeatable": false,
      "isHidden": false,
      "tags": ["main-story", "dvergr", "forge"],
      "prerequisites": [
        {
          "type": "Level",
          "value": 5,
          "operator": "greaterThan"
        },
        {
          "type": "QuestComplete",
          "target": "intro-arrival",
          "operator": "equals"
        }
      ],
      "questGiver": {
        "npcId": "npc-kjartan",
        "dialogueNodeId": "kjartan-iron-path-offer",
        "turnInNpcId": "npc-kjartan",
        "turnInDialogueNodeId": "kjartan-iron-path-complete"
      },
      "stages": [
        {
          "id": "speak-kjartan",
          "name": "The Smith's Tale",
          "description": "Speak with Kjartan about the forge legends.",
          "objectives": [
            {
              "id": "talk-kjartan",
              "type": "Talk",
              "description": "Speak with Kjartan about the forge legends",
              "target": "npc-kjartan"
            }
          ],
          "onComplete": [
            {
              "type": "Notification",
              "data": "Kjartan has marked the likely entrance on your map."
            }
          ],
          "nextStageId": "find-descent"
        },
        {
          "id": "find-descent",
          "name": "The Descent",
          "description": "Find the entrance to the Iron Crypts beneath Ironhold.",
          "objectives": [
            {
              "id": "locate-entrance",
              "type": "Explore",
              "description": "Find the descent to the Iron Crypts",
              "target": "location-iron-crypts-entrance"
            },
            {
              "id": "collect-notes",
              "type": "Collect",
              "description": "Collect ancient Dvergr notes",
              "target": "item-dvergr-notes",
              "quantity": 3,
              "isOptional": true
            }
          ],
          "nextStageId": "defeat-lord"
        },
        {
          "id": "defeat-lord",
          "name": "The Rust Lord",
          "description": "Confront and defeat the Rust Lord that guards the forge.",
          "objectives": [
            {
              "id": "defeat-rust-lord",
              "type": "Kill",
              "description": "Defeat the Rust Lord",
              "target": "enemy-rust-lord",
              "quantity": 1
            }
          ],
          "onComplete": [
            {
              "type": "UpdateWorldState",
              "target": "rust_lord_defeated",
              "data": "true"
            }
          ],
          "nextStageId": "return-kjartan"
        },
        {
          "id": "return-kjartan",
          "name": "The Smith's Gratitude",
          "description": "Return to Kjartan with proof of your victory.",
          "objectives": [
            {
              "id": "return-to-kjartan",
              "type": "Talk",
              "description": "Return to Kjartan with proof",
              "target": "npc-kjartan"
            }
          ],
          "nextStageId": null
        }
      ],
      "rewards": [
        {
          "type": "Experience",
          "amount": 500,
          "description": "+500 Legend"
        },
        {
          "type": "Gold",
          "target": "cogs",
          "amount": 200,
          "description": "+200 Dvergr Cogs"
        },
        {
          "type": "Item",
          "target": "item-rune-etched-blade",
          "amount": 1,
          "description": "Rune-Etched Blade [Rare]"
        },
        {
          "type": "Reputation",
          "target": "dvergr-guild",
          "amount": 50,
          "description": "+50 Dvergr Guild Reputation"
        }
      ],
      "failureConditions": null,
      "branches": null
    },
    {
      "id": "lost-tools",
      "name": "Lost Tools",
      "description": "Kjartan's implements have been scattered throughout the nearby ruins. Recover them so he can continue his work.",
      "category": "SideQuest",
      "level": null,
      "isRepeatable": false,
      "tags": ["side-quest", "fetch", "kjartan"],
      "prerequisites": [
        {
          "type": "QuestComplete",
          "target": "iron-path",
          "operator": "has"
        }
      ],
      "questGiver": {
        "npcId": "npc-kjartan",
        "dialogueNodeId": "kjartan-lost-tools-offer"
      },
      "stages": [
        {
          "id": "collect-hammers",
          "name": "The Scattered Implements",
          "description": "Search the ruins for Kjartan's lost tools.",
          "objectives": [
            {
              "id": "find-hammers",
              "type": "Collect",
              "description": "Collect Dvergr Hammers",
              "target": "item-dvergr-hammer",
              "quantity": 5
            }
          ],
          "nextStageId": "return-tools"
        },
        {
          "id": "return-tools",
          "name": "Return to the Smith",
          "description": "Bring the recovered tools back to Kjartan.",
          "objectives": [
            {
              "id": "deliver-tools",
              "type": "Deliver",
              "description": "Return the hammers to Kjartan",
              "target": "npc-kjartan"
            }
          ],
          "nextStageId": null
        }
      ],
      "rewards": [
        {
          "type": "Experience",
          "amount": 100,
          "description": "+100 Legend"
        },
        {
          "type": "Gold",
          "target": "cogs",
          "amount": 50,
          "description": "+50 Dvergr Cogs"
        }
      ]
    },
    {
      "id": "patrol-route",
      "name": "Patrol Route",
      "description": "Clear the eastern corridor of hostile creatures threatening trade routes.",
      "category": "Bounty",
      "level": null,
      "isRepeatable": true,
      "tags": ["bounty", "combat", "repeatable"],
      "questGiver": {
        "npcId": "npc-patrol-captain"
      },
      "stages": [
        {
          "id": "clear-corridor",
          "name": "Clear the Corridor",
          "description": "Eliminate the Rust-Horrors infesting the eastern passage.",
          "objectives": [
            {
              "id": "kill-horrors",
              "type": "Kill",
              "description": "Eliminate Rust-Horrors",
              "target": "enemy-rust-horror",
              "quantity": 5,
              "location": "location-eastern-corridor"
            }
          ],
          "nextStageId": "report-back"
        },
        {
          "id": "report-back",
          "name": "Report Success",
          "description": "Return to the Patrol Captain to confirm the route is clear.",
          "objectives": [
            {
              "id": "report",
              "type": "Talk",
              "description": "Report to the Patrol Captain",
              "target": "npc-patrol-captain"
            }
          ],
          "nextStageId": null
        }
      ],
      "rewards": [
        {
          "type": "Gold",
          "target": "cogs",
          "amount": 25,
          "description": "+25 Cogs"
        },
        {
          "type": "Experience",
          "amount": 50,
          "description": "+50 Legend"
        }
      ]
    },
    {
      "id": "rusted-heart",
      "name": "The Rusted Heart",
      "description": "An ancient Undying Warden has awakened and threatens the settlement. Find a way to disable it before it destroys everything.",
      "category": "MainStory",
      "level": 10,
      "isRepeatable": false,
      "tags": ["main-story", "modular", "undying"],
      "prerequisites": [
        {
          "type": "Level",
          "value": 10,
          "operator": "greaterThan"
        },
        {
          "type": "QuestComplete",
          "target": "iron-path",
          "operator": "equals"
        }
      ],
      "questGiver": {
        "npcId": "npc-elder-sigrun",
        "dialogueNodeId": "sigrun-rusted-heart-offer"
      },
      "stages": [
        {
          "id": "investigate-warden",
          "name": "Investigate the Threat",
          "description": "Learn more about the awakened Warden and find a way to stop it.",
          "objectives": [
            {
              "id": "gather-intel",
              "type": "Talk",
              "description": "Gather information about the Warden",
              "target": "npc-elder-sigrun"
            }
          ],
          "nextStageId": "disable-warden"
        },
        {
          "id": "disable-warden",
          "name": "Disable the Warden",
          "description": "Find a way to neutralize the Undying Warden.",
          "objectives": [
            {
              "id": "combat-path",
              "type": "Kill",
              "description": "Defeat the Warden in direct combat",
              "target": "enemy-undying-warden",
              "isHidden": true
            },
            {
              "id": "tech-path",
              "type": "Use",
              "description": "Hack the Warden's command console",
              "target": "object-warden-console",
              "isHidden": true,
              "conditions": [
                {
                  "type": "HasAbility",
                  "target": "ability-hack",
                  "value": true
                }
              ]
            },
            {
              "id": "env-path",
              "type": "Use",
              "description": "Trigger a structural collapse on the Warden",
              "target": "object-ceiling-support",
              "isHidden": true,
              "conditions": [
                {
                  "type": "InLocation",
                  "target": "location-unstable-chamber",
                  "value": true
                }
              ]
            }
          ],
          "nextStageId": "report-sigrun"
        },
        {
          "id": "combat-resolution",
          "name": "Victory Through Steel",
          "description": "You defeated the Warden through direct combat.",
          "objectives": [
            {
              "id": "confirm-combat",
              "type": "Talk",
              "description": "Report your combat victory to Sigrun",
              "target": "npc-elder-sigrun"
            }
          ],
          "nextStageId": null,
          "isOptional": true
        },
        {
          "id": "tech-resolution",
          "name": "The Hacker's Way",
          "description": "You disabled the Warden through technical means.",
          "objectives": [
            {
              "id": "confirm-tech",
              "type": "Talk",
              "description": "Report your technical solution to Sigrun",
              "target": "npc-elder-sigrun"
            }
          ],
          "nextStageId": null,
          "isOptional": true
        },
        {
          "id": "report-sigrun",
          "name": "Report to Sigrun",
          "description": "Tell Elder Sigrun how you dealt with the threat.",
          "objectives": [
            {
              "id": "final-report",
              "type": "Talk",
              "description": "Report to Elder Sigrun",
              "target": "npc-elder-sigrun"
            }
          ],
          "nextStageId": null
        }
      ],
      "rewards": [
        {
          "type": "Experience",
          "amount": 750,
          "description": "+750 Legend"
        },
        {
          "type": "Reputation",
          "target": "rust-clans",
          "amount": 100,
          "description": "+100 Rust Clans Reputation"
        }
      ],
      "branches": [
        {
          "id": "branch-combat",
          "condition": {
            "type": "ObjectiveComplete",
            "target": "combat-path"
          },
          "targetStageId": "combat-resolution",
          "description": "Player chose direct combat"
        },
        {
          "id": "branch-tech",
          "condition": {
            "type": "ObjectiveComplete",
            "target": "tech-path"
          },
          "targetStageId": "tech-resolution",
          "description": "Player chose hacking approach"
        }
      ],
      "failureConditions": [
        {
          "type": "TimeExpired",
          "description": "The Warden reached the settlement"
        }
      ],
      "failureConsequences": [
        {
          "type": "Reputation",
          "target": "rust-clans",
          "amount": -50,
          "description": "Lost reputation for failing to protect the settlement"
        },
        {
          "type": "Flag",
          "target": "settlement_damaged",
          "description": "The settlement suffers permanent damage"
        }
      ],
      "timeLimit": 50
    },
    {
      "id": "salvage-run-daily",
      "name": "Daily Salvage Run",
      "description": "Collect salvage materials from the designated scrap piles.",
      "category": "Daily",
      "level": null,
      "isRepeatable": true,
      "tags": ["daily", "salvage", "rust-clans"],
      "questGiver": {
        "npcId": "npc-salvage-master"
      },
      "stages": [
        {
          "id": "collect-salvage",
          "name": "Gather Salvage",
          "description": "Collect scrap materials from the designated areas.",
          "objectives": [
            {
              "id": "gather-scrap",
              "type": "Collect",
              "description": "Collect scrap metal",
              "target": "item-scrap-metal",
              "quantity": 10
            }
          ],
          "nextStageId": "turn-in-salvage"
        },
        {
          "id": "turn-in-salvage",
          "name": "Turn In",
          "description": "Return the salvage to the Salvage Master.",
          "objectives": [
            {
              "id": "deliver-salvage",
              "type": "Deliver",
              "description": "Deliver salvage to the Salvage Master",
              "target": "npc-salvage-master"
            }
          ],
          "nextStageId": null
        }
      ],
      "rewards": [
        {
          "type": "Gold",
          "target": "cogs",
          "amount": 15,
          "description": "+15 Cogs"
        },
        {
          "type": "Reputation",
          "target": "rust-clans",
          "amount": 5,
          "description": "+5 Rust Clans Reputation"
        }
      ]
    }
  ]
}
```

---

## 15. Logging Specifications

### Schema Validation Logging

| Event | Level | Message Format |
|-------|-------|----------------|
| Schema loaded | INFO | `Quest schema loaded from {path}` |
| Configuration loaded | INFO | `Loaded {count} quests from configuration` |
| Validation success | DEBUG | `Quest configuration validated successfully` |
| Validation failure | ERROR | `Quest validation failed: {errors}` |
| Invalid quest ID | ERROR | `Quest ID '{id}' does not match pattern ^[a-z][a-z0-9-]*$` |
| Duplicate quest ID | ERROR | `Duplicate quest ID '{id}' found` |
| Invalid stage reference | ERROR | `Quest '{id}' stage '{stageId}' references unknown nextStageId '{ref}'` |
| Invalid prerequisite | WARN | `Quest '{id}' references unknown prerequisite target '{target}'` |
| Invalid reward target | WARN | `Quest '{id}' reward references unknown target '{target}'` |

### Runtime Logging

| Event | Level | Message Format |
|-------|-------|----------------|
| Quest started | INFO | `Quest started: {questName}` |
| Objective updated | DEBUG | `Objective progress: {objective} ({current}/{required})` |
| Objective complete | INFO | `Objective complete: {objective}` |
| Stage complete | INFO | `Stage complete: {stageName}` |
| Quest complete | INFO | `Quest complete: {questName}` |
| Quest failed | WARN | `Quest failed: {questName} - {reason}` |
| Branch triggered | DEBUG | `Quest branch triggered: {branchId} → {targetStage}` |
| Reward granted | INFO | `Reward granted: {rewardDescription}` |

---

## 16. Unit Testing Requirements

### Test Summary

| Test ID | Test Name | Description |
|---------|-----------|-------------|
| QST-001 | ValidQuestConfiguration | Validates complete configuration file |
| QST-002 | QuestIdentityValidation | Validates quest ID and name patterns |
| QST-003 | QuestCategoryValidation | Validates category enum values |
| QST-004 | StageSequenceValidation | Validates stage sequencing and references |
| QST-005 | ObjectiveTypeValidation | Validates objective type enum values |
| QST-006 | RewardTypeValidation | Validates reward types and targets |

### Test Specifications

#### QST-001: ValidQuestConfiguration

```
Test: Valid complete quest configuration passes validation
Given: A quest JSON file with all required properties
When: Schema validation is performed
Then: Validation passes with no errors
And: Version matches semver pattern
And: Quests array has at least one quest
And: Each quest has id, name, description, category, stages
```

#### QST-002: QuestIdentityValidation

```
Test: Quest identity properties validate correctly
Given: Quests with various ID and name configurations
When: Schema validation is performed:
  - { "id": "iron-path", "name": "The Iron Path", ... } → passes
  - { "id": "lost-tools", ... } → passes
  - { "id": "IronPath", ... } → fails (uppercase)
  - { "id": "iron_path", ... } → fails (underscore)
  - { "name": "", ... } → fails (empty name)
Then: ID pattern enforced, name required
```

#### QST-003: QuestCategoryValidation

```
Test: Quest category enum values validated correctly
Given: Quests with various category values
When: Schema validation is performed:
  - "category": "MainStory" → passes
  - "category": "SideQuest" → passes
  - "category": "FactionQuest" → passes
  - "category": "Bounty" → passes
  - "category": "Exploration" → passes
  - "category": "Crafting" → passes
  - "category": "Daily" → passes
  - "category": "Event" → passes
  - "category": "main-story" → fails (case-sensitive)
  - "category": "Random" → fails (invalid enum)
Then: Only valid enum values accepted
```

#### QST-004: StageSequenceValidation

```
Test: Quest stages validated with sequence and references
Given: Quests with various stage configurations
When: Schema validation is performed:
  - Quest with stages array (minItems: 1) → passes
  - Quest with empty stages → fails
  - Stage with nextStageId referencing valid stage → passes
  - Stage with nextStageId: null (final stage) → passes
  - Each stage has id, name, description, objectives → passes
  - Stage missing objectives → fails
Then: Stage structure and sequencing enforced
```

#### QST-005: ObjectiveTypeValidation

```
Test: Objective types validated correctly
Given: Stages with various objective types
When: Schema validation is performed:
  - "type": "Kill" → passes
  - "type": "Collect" → passes
  - "type": "Talk" → passes
  - "type": "Explore" → passes
  - "type": "Escort" → passes
  - "type": "Defend" → passes
  - "type": "Craft" → passes
  - "type": "Discover" → passes
  - "type": "Deliver" → passes
  - "type": "Use" → passes
  - "type": "Survive" → passes
  - "type": "Reach" → passes
  - "type": "fight" → fails (case-sensitive)
  - "type": "Hunt" → fails (invalid enum)
Then: Only valid 12 objective types accepted
```

#### QST-006: RewardTypeValidation

```
Test: Reward types and structures validated
Given: Quests with various reward configurations
When: Schema validation is performed:
  - { "type": "Experience", "amount": 500 } → passes
  - { "type": "Gold", "target": "cogs", "amount": 200 } → passes
  - { "type": "Item", "target": "item-blade", "amount": 1 } → passes
  - { "type": "Reputation", "target": "rust-clans", "amount": 50 } → passes
  - { "type": "Ability", "target": "ability-hack" } → passes
  - { "type": "Title", "target": "title-hero" } → passes
  - { "type": "Unlock", "target": "area-deep-forge" } → passes
  - { "type": "Flag", "target": "forge_discovered" } → passes
  - { "type": "Money" } → fails (invalid enum)
Then: 8 reward types validated with appropriate fields
```

---

## 17. Use Cases

### UC-001: Load Quest Configuration

```
┌─────────────────────────────────────────────────────────────────────────────┐
│ UC-001: Load Quest Configuration                                             │
├─────────────────────────────────────────────────────────────────────────────┤
│ Actors: Game System                                                          │
│ Trigger: Game initialization                                                 │
│ Preconditions: Configuration files exist                                     │
├─────────────────────────────────────────────────────────────────────────────┤
│ Flow:                                                                        │
│ 1. System loads quests.schema.json                                           │
│ 2. System reads config/quests.json                                           │
│ 3. Validate configuration against schema                                     │
│ 4. Build quest lookup by ID                                                  │
│ 5. Validate stage sequence references                                        │
│ 6. Validate prerequisite references (quest IDs, faction IDs)                 │
│ 7. Cache quest data for performance                                          │
│ 8. Log quest statistics                                                      │
├─────────────────────────────────────────────────────────────────────────────┤
│ Postconditions: Quests loaded and cached                                     │
│ Exceptions: Invalid JSON → log error, use fallback empty quests              │
└─────────────────────────────────────────────────────────────────────────────┘
```

### UC-002: Check Quest Prerequisites

```
┌─────────────────────────────────────────────────────────────────────────────┐
│ UC-002: Check Quest Prerequisites                                            │
├─────────────────────────────────────────────────────────────────────────────┤
│ Actors: Player, Game System                                                  │
│ Trigger: Player encounters quest giver or quest trigger                      │
│ Preconditions: Quests loaded                                                 │
├─────────────────────────────────────────────────────────────────────────────┤
│ Flow:                                                                        │
│ 1. Get quest definition by ID                                                │
│ 2. For each prerequisite in quest.prerequisites:                             │
│    a. Evaluate prerequisite based on type:                                   │
│       - Level: Check player level                                            │
│       - QuestComplete: Check completed quests                                │
│       - FactionReputation: Check faction standing                            │
│       - HasItem: Check inventory                                             │
│       - HasAbility: Check unlocked abilities                                 │
│    b. Apply operator (equals, greaterThan, lessThan, has, notHas)            │
│ 3. If all prerequisites met → quest available                                │
│ 4. If not → quest locked, show requirements                                  │
├─────────────────────────────────────────────────────────────────────────────┤
│ Postconditions: Quest availability determined                                │
│ Exceptions: Unknown prerequisite type → log warning, treat as unmet          │
└─────────────────────────────────────────────────────────────────────────────┘
```

### UC-003: Track Objective Progress

```
┌─────────────────────────────────────────────────────────────────────────────┐
│ UC-003: Track Objective Progress                                             │
├─────────────────────────────────────────────────────────────────────────────┤
│ Actors: Player, Game System                                                  │
│ Trigger: Player action matches objective (kill, collect, explore, etc.)      │
│ Preconditions: Quest active with current stage                               │
├─────────────────────────────────────────────────────────────────────────────┤
│ Flow:                                                                        │
│ 1. Receive game event (OnEnemyKilled, OnItemCollected, etc.)                 │
│ 2. For each active quest:                                                    │
│    a. Get current stage                                                      │
│    b. For each objective in stage:                                           │
│       - Check if event matches objective type and target                     │
│       - If match, increment progress                                         │
│       - Check if objective complete (progress >= quantity)                   │
│ 3. If objective complete:                                                    │
│    a. Mark objective as complete                                             │
│    b. Fire ObjectiveComplete event                                           │
│    c. Display notification                                                   │
│ 4. Check if all required objectives in stage complete                        │
│ 5. If stage complete → advance to nextStageId                                │
├─────────────────────────────────────────────────────────────────────────────┤
│ Postconditions: Objective progress updated                                   │
│ Exceptions: No matching objective → no action                                │
└─────────────────────────────────────────────────────────────────────────────┘
```

### UC-004: Handle Quest Branching

```
┌─────────────────────────────────────────────────────────────────────────────┐
│ UC-004: Handle Quest Branching                                               │
├─────────────────────────────────────────────────────────────────────────────┤
│ Actors: Game System                                                          │
│ Trigger: Objective complete or condition met                                 │
│ Preconditions: Quest has branches defined                                    │
├─────────────────────────────────────────────────────────────────────────────┤
│ Flow:                                                                        │
│ 1. On objective complete, check quest.branches                               │
│ 2. For each branch:                                                          │
│    a. Evaluate branch.condition:                                             │
│       - ObjectiveComplete: Check if specific objective done                  │
│       - HasItem: Check inventory                                             │
│       - FactionReputation: Check standing                                    │
│       - DialogueChoice: Check dialogue history                               │
│    b. If condition met → mark branch as triggered                            │
│ 3. If branch triggered:                                                      │
│    a. Set current stage to branch.targetStageId                              │
│    b. Skip normal nextStageId progression                                    │
│    c. Log branch taken for narrative tracking                                │
│ 4. If no branch triggered → use normal nextStageId                           │
├─────────────────────────────────────────────────────────────────────────────┤
│ Postconditions: Quest advanced to appropriate stage                          │
│ Exceptions: Invalid targetStageId → log error, continue normal flow          │
└─────────────────────────────────────────────────────────────────────────────┘
```

### UC-005: Grant Quest Rewards

```
┌─────────────────────────────────────────────────────────────────────────────┐
│ UC-005: Grant Quest Rewards                                                  │
├─────────────────────────────────────────────────────────────────────────────┤
│ Actors: Player, Game System                                                  │
│ Trigger: Player turns in completed quest                                     │
│ Preconditions: Quest complete, player at turn-in location                    │
├─────────────────────────────────────────────────────────────────────────────┤
│ Flow:                                                                        │
│ 1. Validate quest is complete (all required objectives done)                 │
│ 2. For each reward in quest.rewards:                                         │
│    a. If reward.isOptional → present choice to player                        │
│    b. Process reward by type:                                                │
│       - Experience: Add to player XP                                         │
│       - Gold: Add currency                                                   │
│       - Item: Add to inventory                                               │
│       - Reputation: Modify faction standing (via v0.14.10a)                  │
│       - Ability: Unlock ability                                              │
│       - Title: Grant title                                                   │
│       - Unlock: Set unlock flag                                              │
│       - Flag: Set world state flag                                           │
│    c. Display reward notification                                            │
│ 3. Mark quest as TurnedIn                                                    │
│ 4. If quest.isRepeatable → reset quest to NotStarted                         │
│ 5. Fire QuestComplete event                                                  │
├─────────────────────────────────────────────────────────────────────────────┤
│ Postconditions: Rewards granted, quest completed                             │
│ Exceptions: Inventory full → prompt player, hold reward                      │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 18. Deliverable Checklist

### Configuration Files

| Status | File | Description |
|--------|------|-------------|
| ☐ | `config/schemas/quests.schema.json` | JSON Schema Draft-07 for validation |
| ☐ | `config/quests.json` | Quest definitions |

### Unit Tests

| Status | Test | Description |
|--------|------|-------------|
| ☐ | QST-001 | Valid complete configuration |
| ☐ | QST-002 | Quest identity validation |
| ☐ | QST-003 | Quest category validation |
| ☐ | QST-004 | Stage sequence validation |
| ☐ | QST-005 | Objective type validation |
| ☐ | QST-006 | Reward type validation |

### Documentation

| Status | Document | Description |
|--------|----------|-------------|
| ☑ | Design Specification | This document |
| ☐ | Schema Documentation | Inline in schema file |

---

## 19. Acceptance Criteria

### Functional Criteria

- [ ] `quests.schema.json` created in `config/schemas/`
- [ ] Quest ID pattern validated (kebab-case)
- [ ] Quest categories validated (8 types)
- [ ] Objective types validated (12 types)
- [ ] Prerequisites validated (9 types)
- [ ] Rewards validated (8 types)
- [ ] Quest stages validated (at least one required)
- [ ] Stage sequencing validated (nextStageId references)
- [ ] Branching paths validated
- [ ] Failure conditions validated (6 types)
- [ ] ~6 unit tests pass

### Quality Criteria

- [ ] Schema follows JSON Schema Draft-07 specification
- [ ] All properties include descriptive comments
- [ ] Default values documented for optional fields
- [ ] Pattern constraints clearly specified
- [ ] Enum values documented with descriptions

### Integration Criteria

- [ ] Schema follows patterns from v0.14.10a (faction schema)
- [ ] ID patterns use kebab-case (lowercase)
- [ ] Property names use camelCase
- [ ] Category and type enums use PascalCase
- [ ] Reputation rewards reference faction IDs from v0.14.10a
- [ ] Compatible with dialogue.schema.json QuestStart/QuestUpdate outcomes

---

## 20. Dependencies

### Required From

| Version | Dependency | Usage |
|---------|------------|-------|
| v0.14.10a | Faction Schema | Reputation reward targets |
| v0.14.9a | Dialogue Schema | QuestStart/QuestUpdate outcomes |
| v0.14.2 | Item Schema | Item reward targets |
| Existing | Quest UI specification | Journal integration |
| Existing | Quest system specification | Quest mechanics design |

### Provides To

| Version | Consumer | Usage |
|---------|----------|-------|
| v0.14.10c | Codex Schema | Discover objective targets |
| Future | QuestService | Quest data loading |
| Future | DialogueService | Quest trigger processing |
| Future | RewardService | Reward granting |

---

## 21. Future Considerations

### Deferred to Later Versions

| Feature | Rationale |
|---------|-----------|
| Quest state machine logic | Runtime concern |
| Objective progress tracking | Runtime concern |
| Quest UI implementation | UI concern |
| Save/load quest state | Persistence concern |
| Quest generation algorithms | Procedural content concern |

### Potential Enhancements

| Enhancement | Description |
|-------------|-------------|
| Procedural quest generation | Daily/bounty quest generation from templates |
| Quest chains | Automatic progression through related quests |
| Companion quests | Party member specific quests |
| Environmental quests | Quests triggered by world state |
| Seasonal events | Time-limited event quest systems |
| Quest difficulty scaling | Dynamic objective scaling by player level |
| Cooperative quests | Multi-player objective sharing |
| Failed quest redemption | Ways to retry failed quests |

---

## 22. Appendix: Quest Design Patterns

### Quest Category Guidelines

| Category | Structure | Narrative | Example |
|----------|-----------|-----------|---------|
| `MainStory` | Multi-stage, linear | Heavy exposition | The Iron Path |
| `SideQuest` | 2-4 stages | Character-focused | Lost Tools |
| `FactionQuest` | Variable | Faction ideology | Salvage Run |
| `Bounty` | Simple kill | Minimal | Patrol Route |
| `Exploration` | Discovery | Lore fragments | Hidden Cache |
| `Crafting` | Gather → Craft | Minimal | Forge the Key |
| `Daily` | Repeatable | None | Daily Salvage |
| `Event` | Special mechanics | Thematic | Frost Festival |

### Modular Quest Design

From the quest system specification:

> "To maximize player agency, quests are built with a modular objective system. The goal is defined, but the method of achieving it is flexible, allowing players to leverage their unique skills."

**Implementation Pattern:**
1. Define main objective (visible)
2. Define solution paths (hidden)
3. Link solution paths via `AnyObjectiveComplete` condition
4. Track which path was taken for narrative outcomes

### Quest Reward Balance

| Quest Type | XP Range | Gold Range | Items | Reputation |
|------------|----------|------------|-------|------------|
| MainStory | 500-1000 | 200-500 | Rare+ | 50-100 |
| SideQuest | 100-300 | 50-150 | Uncommon | 25-50 |
| FactionQuest | 100-200 | 50-100 | Faction | 25-75 |
| Bounty | 25-100 | 25-50 | None | 0-10 |
| Exploration | 50-150 | 0-50 | Lore | 0 |
| Crafting | 25-75 | 0 | Recipe | 0-15 |
| Daily | 25-50 | 10-25 | None | 5-10 |
| Event | Variable | Variable | Unique | Variable |

---

*End of v0.14.10b Design Specification*
