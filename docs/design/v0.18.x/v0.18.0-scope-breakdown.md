# v0.18.0 Scope Breakdown: Psychic Stress System

## Overview

v0.18.0 implements the **Psychic Stress** system — the primary psychological damage resource that creates tactical pressure during combat and exploration. Stress accumulates from horror encounters and penalizes Defense, creating a death spiral that rewards proactive management.

---

## Feature Tree

```
v0.18.0 — Psychic Stress System
├── Domain Layer
│   ├── StressState (value object)
│   ├── StressThreshold (enum)
│   ├── StressSource (enum)
│   └── StressCheckResult (record)
│
├── Application Layer
│   ├── IStressService (interface)
│   └── StressService (implementation)
│
├── Infrastructure Layer
│   └── Database schema extension
│
├── Configuration
│   ├── stress_sources.json
│   └── stress_sources.schema.json
│
└── Tests (~18 unit tests)
```

---

## In Scope

### Domain Layer

#### StressThreshold Enum

```csharp
/// <summary>
/// Defines the psychological state tiers based on current Psychic Stress level.
/// Each threshold carries specific mechanical penalties.
/// </summary>
public enum StressThreshold
{
    /// <summary>0-19 Stress: No penalties, normal operation.</summary>
    Calm = 0,

    /// <summary>20-39 Stress: -1 Defense penalty.</summary>
    Uneasy = 1,

    /// <summary>40-59 Stress: -2 Defense penalty.</summary>
    Anxious = 2,

    /// <summary>60-79 Stress: -3 Defense penalty.</summary>
    Panicked = 3,

    /// <summary>80-99 Stress: -4 Defense penalty, skill check disadvantage.</summary>
    Breaking = 4,

    /// <summary>100 Stress: -5 Defense penalty, Trauma Check triggered.</summary>
    Trauma = 5
}
```

#### StressSource Enum

```csharp
/// <summary>
/// Categorizes the sources of Psychic Stress gain.
/// </summary>
public enum StressSource
{
    /// <summary>Fear auras, psychic attacks in combat.</summary>
    Combat,

    /// <summary>Disturbing discoveries, corpses, paradoxes.</summary>
    Exploration,

    /// <summary>Story-driven traumatic events.</summary>
    Narrative,

    /// <summary>Using heretical/forbidden abilities.</summary>
    Heretical,

    /// <summary>Environmental hazards (Blight zones).</summary>
    Environmental,

    /// <summary>Failed Corruption resistance check.</summary>
    Corruption
}
```

#### StressState Value Object

```csharp
/// <summary>
/// Represents the current Psychic Stress state of a character.
/// Immutable value object for stress tracking.
/// </summary>
public sealed record StressState
{
    /// <summary>Current stress value (0-100).</summary>
    public int CurrentStress { get; init; }

    /// <summary>Maximum stress cap (always 100).</summary>
    public const int MaxStress = 100;

    /// <summary>Minimum stress floor (always 0).</summary>
    public const int MinStress = 0;

    /// <summary>Gets the current stress threshold tier.</summary>
    public StressThreshold Threshold => CurrentStress switch
    {
        < 20 => StressThreshold.Calm,
        < 40 => StressThreshold.Uneasy,
        < 60 => StressThreshold.Anxious,
        < 80 => StressThreshold.Panicked,
        < 100 => StressThreshold.Breaking,
        _ => StressThreshold.Trauma
    };

    /// <summary>Gets the Defense penalty based on stress level.</summary>
    public int DefensePenalty => CurrentStress / 20;

    /// <summary>Whether skill checks have disadvantage.</summary>
    public bool HasSkillDisadvantage => CurrentStress >= 80;

    /// <summary>Whether a Trauma Check is required.</summary>
    public bool RequiresTraumaCheck => CurrentStress >= 100;
}
```

#### StressCheckResult Record

```csharp
/// <summary>
/// Result of a stress resistance check (WILL vs DC).
/// </summary>
public sealed record StressCheckResult
{
    /// <summary>Whether the resistance check succeeded.</summary>
    public bool Succeeded { get; init; }

    /// <summary>Number of successes rolled.</summary>
    public int Successes { get; init; }

    /// <summary>Original stress amount before resistance.</summary>
    public int BaseStress { get; init; }

    /// <summary>Final stress amount after resistance.</summary>
    public int FinalStress { get; init; }

    /// <summary>Stress reduction percentage applied.</summary>
    public decimal ReductionPercent => Successes switch
    {
        0 => 0m,      // Full stress
        1 => 0.5m,    // Half stress
        2 or 3 => 0.75m, // 25% stress
        _ => 1.0m     // No stress
    };
}
```

### Application Layer

#### IStressService Interface

```csharp
/// <summary>
/// Service for managing Psychic Stress mechanics.
/// </summary>
public interface IStressService
{
    /// <summary>Gets the current stress state for a character.</summary>
    StressState GetStressState(Guid characterId);

    /// <summary>
    /// Applies stress to a character, optionally with a resistance check.
    /// </summary>
    /// <param name="characterId">Target character.</param>
    /// <param name="amount">Base stress amount.</param>
    /// <param name="source">Source category of the stress.</param>
    /// <param name="resistDc">DC for resistance check (0 = no check).</param>
    /// <returns>Result containing final stress applied.</returns>
    StressApplicationResult ApplyStress(
        Guid characterId,
        int amount,
        StressSource source,
        int resistDc = 0);

    /// <summary>
    /// Performs a stress resistance check using WILL.
    /// </summary>
    StressCheckResult PerformResistanceCheck(
        Guid characterId,
        int baseStress,
        int dc);

    /// <summary>
    /// Recovers stress based on rest type.
    /// </summary>
    /// <param name="characterId">Target character.</param>
    /// <param name="restType">Type of rest taken.</param>
    /// <returns>Amount of stress recovered.</returns>
    int RecoverStress(Guid characterId, RestType restType);

    /// <summary>
    /// Recovers a specific amount of stress (ability/item effect).
    /// </summary>
    int RecoverStress(Guid characterId, int amount, string source);

    /// <summary>
    /// Gets the Defense penalty for a character's current stress.
    /// </summary>
    int GetDefensePenalty(Guid characterId);

    /// <summary>
    /// Checks if a Trauma Check is required.
    /// </summary>
    bool RequiresTraumaCheck(Guid characterId);

    /// <summary>
    /// Resets stress after a Trauma Check.
    /// </summary>
    /// <param name="characterId">Target character.</param>
    /// <param name="passed">Whether the Trauma Check passed.</param>
    void ResetAfterTraumaCheck(Guid characterId, bool passed);
}
```

#### StressApplicationResult Record

```csharp
/// <summary>
/// Result of applying stress to a character.
/// </summary>
public sealed record StressApplicationResult
{
    /// <summary>Stress amount before application.</summary>
    public int PreviousStress { get; init; }

    /// <summary>Stress amount after application.</summary>
    public int NewStress { get; init; }

    /// <summary>Actual stress gained (after resistance).</summary>
    public int StressGained { get; init; }

    /// <summary>Previous stress threshold.</summary>
    public StressThreshold PreviousThreshold { get; init; }

    /// <summary>New stress threshold.</summary>
    public StressThreshold NewThreshold { get; init; }

    /// <summary>Whether a threshold was crossed.</summary>
    public bool ThresholdCrossed => NewThreshold > PreviousThreshold;

    /// <summary>Whether a Trauma Check is now required.</summary>
    public bool TraumaCheckTriggered { get; init; }

    /// <summary>Result of resistance check (if performed).</summary>
    public StressCheckResult? ResistanceResult { get; init; }
}
```

#### RestType Enum (if not already defined)

```csharp
/// <summary>
/// Types of rest that affect resource recovery.
/// </summary>
public enum RestType
{
    /// <summary>Short rest: WILL × 2 stress recovery.</summary>
    Short,

    /// <summary>Long rest: WILL × 5 stress recovery.</summary>
    Long,

    /// <summary>Sanctuary: Full stress reset to 0.</summary>
    Sanctuary,

    /// <summary>Milestone: Partial stress recovery.</summary>
    Milestone
}
```

### Infrastructure Layer

#### Database Schema

```sql
-- Extend character_resources table for stress tracking
ALTER TABLE character_resources ADD COLUMN IF NOT EXISTS
    psychic_stress INT NOT NULL DEFAULT 0
    CONSTRAINT chk_psychic_stress CHECK (psychic_stress >= 0 AND psychic_stress <= 100);

-- Stress event history for analytics
CREATE TABLE IF NOT EXISTS stress_history (
    id SERIAL PRIMARY KEY,
    character_id UUID NOT NULL REFERENCES characters(id) ON DELETE CASCADE,
    amount INT NOT NULL,
    source VARCHAR(50) NOT NULL,
    resisted BOOLEAN NOT NULL DEFAULT false,
    final_amount INT NOT NULL,
    new_total INT NOT NULL,
    threshold_crossed VARCHAR(20),
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX idx_stress_history_char ON stress_history(character_id);
CREATE INDEX idx_stress_history_time ON stress_history(created_at);
```

### Configuration

#### stress_sources.json

```json
{
  "version": "1.0",
  "stressSources": {
    "combat": [
      {
        "id": "enemy_fear_aura",
        "name": "Enemy Fear Aura",
        "baseStress": 15,
        "resistDc": 2,
        "description": "Presence of terrifying enemy"
      },
      {
        "id": "psychic_attack",
        "name": "Psychic Attack",
        "baseStress": 20,
        "resistDc": 3,
        "description": "Direct mental assault"
      },
      {
        "id": "ally_down",
        "name": "Ally Drops to 0 HP",
        "baseStress": 10,
        "resistDc": 2,
        "description": "Witnessing ally fall"
      },
      {
        "id": "witness_death",
        "name": "Witness Death",
        "baseStress": 15,
        "resistDc": 2,
        "description": "Ally or NPC death"
      },
      {
        "id": "forlorn_presence",
        "name": "Forlorn Presence",
        "baseStress": 30,
        "resistDc": 4,
        "description": "Reality-warping horror"
      }
    ],
    "exploration": [
      {
        "id": "disturbing_discovery",
        "name": "Disturbing Discovery",
        "baseStress": 8,
        "resistDc": 1,
        "description": "Finding something wrong"
      },
      {
        "id": "corpse_room",
        "name": "Corpse Discovery",
        "baseStress": 5,
        "resistDc": 1,
        "description": "The dead do not dream"
      },
      {
        "id": "paradox_encounter",
        "name": "Paradox Encounter",
        "baseStress": 15,
        "resistDc": 3,
        "description": "Witnessing impossible geometry"
      },
      {
        "id": "forbidden_text",
        "name": "Reading Forbidden Text",
        "baseStress": 18,
        "resistDc": 3,
        "description": "The words... they move"
      }
    ],
    "heretical": [
      {
        "id": "psychic_lash",
        "name": "Psychic Lash (Use)",
        "baseStress": 10,
        "resistDc": 0,
        "description": "Self-inflicted heretical cost"
      },
      {
        "id": "mass_psychic_lash",
        "name": "Mass Psychic Lash",
        "baseStress": 20,
        "resistDc": 0,
        "description": "High-cost heretical power"
      }
    ],
    "environmental": [
      {
        "id": "psychic_resonance_zone",
        "name": "Psychic Resonance Zone",
        "baseStress": 8,
        "resistDc": 2,
        "perTurn": true,
        "description": "Passive area effect"
      }
    ]
  },
  "recoveryRates": {
    "shortRest": {
      "formula": "WILL × 2",
      "description": "Brief respite"
    },
    "longRest": {
      "formula": "WILL × 5",
      "description": "Full night's rest"
    },
    "sanctuary": {
      "formula": "FULL_RESET",
      "description": "Safe haven restoration"
    },
    "milestone": {
      "formula": "25",
      "description": "Achievement recovery"
    }
  }
}
```

---

## Out of Scope

The following are explicitly **not** included in v0.18.0:

| Feature | Deferred To | Reason |
|---------|-------------|--------|
| Trauma Check execution | v0.18.3 | Requires Trauma system |
| Permanent Trauma assignment | v0.18.3 | Requires Trauma definitions |
| CPS stage progression | v0.18.2 | Separate CPS system |
| Corruption interaction | v0.18.5 | Integration version |
| Combat UI integration | v0.19.x | UI version |
| Sound effects | v0.19.x | Audio version |

---

## Unit Tests (~18 tests)

### StressState Tests

| Test | Description |
|------|-------------|
| `StressState_Threshold_Calm_WhenUnder20` | Verify Calm threshold for 0-19 |
| `StressState_Threshold_Uneasy_When20To39` | Verify Uneasy threshold for 20-39 |
| `StressState_Threshold_Anxious_When40To59` | Verify Anxious threshold for 40-59 |
| `StressState_Threshold_Panicked_When60To79` | Verify Panicked threshold for 60-79 |
| `StressState_Threshold_Breaking_When80To99` | Verify Breaking threshold for 80-99 |
| `StressState_Threshold_Trauma_At100` | Verify Trauma threshold at 100 |
| `StressState_DefensePenalty_CalculatesCorrectly` | Verify floor(Stress/20) formula |
| `StressState_SkillDisadvantage_TrueAt80Plus` | Verify disadvantage flag |

### StressService Tests

| Test | Description |
|------|-------------|
| `ApplyStress_ClampsTo100` | Stress cannot exceed 100 |
| `ApplyStress_ClampsTo0OnRecovery` | Stress cannot go below 0 |
| `ApplyStress_WithResistance_ReducesOnSuccess` | Successful check reduces stress |
| `ApplyStress_WithResistance_FullOnFailure` | Failed check applies full stress |
| `ApplyStress_DetectsThresholdCrossing` | Correctly flags threshold changes |
| `ApplyStress_TriggersTraumaCheckAt100` | Flag set when reaching 100 |
| `RecoverStress_ShortRest_UsesWillFormula` | WILL × 2 recovery |
| `RecoverStress_LongRest_UsesWillFormula` | WILL × 5 recovery |
| `RecoverStress_Sanctuary_FullReset` | Sanctuary clears all stress |
| `ResetAfterTraumaCheck_Pass_SetsTo75` | Passed check sets stress to 75 |
| `ResetAfterTraumaCheck_Fail_SetsTo50` | Failed check sets stress to 50 |

---

## Acceptance Criteria

### Functional Requirements

- [ ] Stress accumulates correctly from all source types
- [ ] Defense penalty calculated as `floor(Stress / 20)`
- [ ] Skill disadvantage activates at 80+ stress
- [ ] Trauma Check flag triggers at exactly 100 stress
- [ ] Resistance checks reduce stress based on success count
- [ ] Recovery formulas apply correctly per rest type
- [ ] Sanctuary rest fully clears stress

### Quality Requirements

- [ ] All public methods have XML documentation
- [ ] All enum values have summary descriptions
- [ ] Unit test coverage ≥ 90%
- [ ] No stress values outside 0-100 range possible

---

## Dependencies

### Requires

| Dependency | Purpose |
|------------|---------|
| Dice System (v0.6.x) | WILL resistance checks |
| Attribute System (v0.17.2) | WILL attribute access |
| Character System | Character data access |

### Provides

| Feature | Consumer |
|---------|----------|
| `StressState` | CPS system (v0.18.2) |
| `StressApplicationResult` | Combat system |
| `IStressService` | Trauma system (v0.18.3) |

---

## Changelog

| Version | Date | Changes |
|---------|------|---------|
| 1.0 | 2026-01-17 | Initial scope breakdown |
