# v0.0.8 Experience & Leveling - Scope Breakdown

**Version:** 0.0.8
**Theme:** Experience & Leveling
**Prerequisites:** v0.0.7 Complete (Equipment System)
**Total Estimated Tests:** ~50 new tests

---

## Executive Summary

The Experience & Leveling system introduces character progression through defeating monsters. Players earn experience points (with configurable terminology), level up at defined thresholds, gain stat increases, and unlock new abilities. The system is fully data-driven to support custom progression curves and terminology.

The work is divided into **three sub-phases**:

| Phase | Name | Focus | Est. Tests |
|-------|------|-------|------------|
| v0.0.8a | Core Experience System | XP tracking, monster XP values, XP display | ~18 |
| v0.0.8b | Level-Up Mechanics | Level thresholds, stat increases, level-up notifications | ~18 |
| v0.0.8c | Progression Configuration | Configurable terminology, progression curves, ability unlocks | ~14 |

---

## Executive Summary - Existing Infrastructure

### Already Implemented (from v0.0.4)

| Feature | Location | Notes |
|---------|----------|-------|
| `Player.Level` property | `Player.cs` | Defaults to 1, has `SetLevel()` method |
| `AbilityDefinition.UnlockLevel` | `AbilityDefinition.cs` | Abilities define level requirements |
| `GetUnlockedAbilitiesAtLevel()` | `AbilityService.cs` | Query abilities by level |
| Ability lock validation | `AbilityService.cs` | Checks player level vs ability unlock level |

### Needs Implementation (v0.0.8)

| Feature | Phase | Notes |
|---------|-------|-------|
| Experience tracking | v0.0.8a | Add `Experience` to Player |
| Monster XP values | v0.0.8a | Add `ExperienceValue` to Monster |
| XP gain on kill | v0.0.8a | Award XP when monster defeated |
| Level-up detection | v0.0.8b | Check XP against thresholds |
| Stat increases | v0.0.8b | Apply bonuses on level-up |
| Progression config | v0.0.8c | JSON-driven progression system |
| Terminology config | v0.0.8c | Customizable XP/Level names |

---

## Feature Analysis & Categorization

### From v0.0.8-index.md - Core Features

| Feature | Complexity | Dependencies | Assigned Phase |
|---------|------------|--------------|----------------|
| Experience Points property | Low | Player entity | **v0.0.8a** |
| Monster XP Values | Low | Monster entity | **v0.0.8a** |
| XP Gain on Combat | Medium | CombatService | **v0.0.8a** |
| XP Display | Low | Renderer | **v0.0.8a** |

### From v0.0.8-index.md - Level System

| Feature | Complexity | Dependencies | Assigned Phase |
|---------|------------|--------------|----------------|
| Level Thresholds | Medium | ProgressionService | **v0.0.8b** |
| Level-Up Detection | Medium | XP tracking | **v0.0.8b** |
| Stat Increases | Medium | Player stats | **v0.0.8b** |
| Level-Up Notification | Low | Renderer | **v0.0.8b** |
| Ability Unlocks | Low | Already in v0.0.4c | *Complete* |

### From v0.0.8-index.md - Customization Features

| Feature | Complexity | Dependencies | Assigned Phase |
|---------|------------|--------------|----------------|
| Progression Terminology | Medium | Configuration | **v0.0.8c** |
| Progression Curve Config | Medium | Configuration | **v0.0.8c** |
| Level Rewards Config | Medium | Configuration | **v0.0.8c** |
| Class-Specific Progression | High | Classes (v0.0.4a) | **v0.0.8c** |
| Prestige/Rebirth System | High | Full progression | *Future* |

---

## Phase Definitions

---

## v0.0.8a: Core Experience System

[v0.0.8a Design Specification](v0.0.8a-design-specification.md)

### Overview

Implement the foundation for experience tracking: adding XP to the Player entity, XP values to monsters, awarding XP on combat victory, and displaying XP progress.

### Scope

**In Scope:**
- `Experience` property on `Player` entity
- `ExperienceValue` property on `Monster` entity
- XP gain when monster is defeated in combat
- XP display in status output
- `ExperienceService` for XP calculations
- Default XP values for existing monsters

**Out of Scope:**
- Level-up detection (v0.0.8b)
- Stat increases (v0.0.8b)
- Configurable terminology (v0.0.8c)
- Configurable XP formulas (v0.0.8c)

### Key Deliverables

| Type | Count | Details |
|------|-------|---------|
| Domain Services | 1 | `ExperienceService` |
| Application Services | 1 | Update `GameSessionService` |
| DTOs | 1 | `ExperienceGainDto` |
| Unit Tests | ~18 | |

### Data Model Changes

```
MODIFY: Player (Entity)
├── ADD: Experience: int (default 0)
├── ADD: AddExperience(amount): int (returns new total)
└── ADD: ExperienceToNextLevel: int (computed, uses default formula initially)

MODIFY: Monster (Entity)
└── ADD: ExperienceValue: int (XP awarded on defeat)

MODIFY: CombatService
└── UPDATE: On monster defeat, return XP value for awarding
```

### Monster XP Values

| Monster | XP Value | Notes |
|---------|----------|-------|
| Goblin | 25 | Basic enemy (currently only monster) |
| *(Future monsters)* | Scaled | Based on difficulty |

### User-Facing Changes

**Combat Output:**
```
> attack goblin

You attack the Goblin!
Attack Roll: [18] + 3 (Finesse) = 21 vs Defense 12
Hit! Rolling damage...
Damage Roll: 1d8 [7] + 2 (Might) = 9 damage!
The Goblin is defeated!

You gained 25 XP!
```

**Status Output:**
```
> status

=== Hero (Level 1 Warrior) ===
HP: 100/100
XP: 75/100 (75%)
...
```

### Acceptance Criteria

- [ ] Player tracks experience points
- [ ] Monsters have XP values
- [ ] XP awarded when monster is defeated
- [ ] XP displayed in status output
- [ ] XP gain shown after combat victory
- [ ] ~18 unit tests pass

---

## v0.0.8b: Level-Up Mechanics

[v0.0.8b Design Specification](v0.0.8b-design-specification.md)

### Overview

Implement level-up detection, stat increases on level-up, and level-up notifications. Uses default progression curve initially (configurable in v0.0.8c).

### Scope

**In Scope:**
- `ProgressionService` for level-up logic
- Default level thresholds (100, 250, 500, 1000, ...)
- Level-up detection when XP threshold reached
- Stat increases on level-up (+5 MaxHealth, +1 Attack, +1 Defense per level)
- Level-up notification with details
- Automatic ability unlock check (uses existing v0.0.4c infrastructure)
- Multi-level support (gaining enough XP to skip levels)

**Out of Scope:**
- Configurable terminology (v0.0.8c)
- Configurable progression curves (v0.0.8c)
- Class-specific stat bonuses (v0.0.8c)

### Key Deliverables

| Type | Count | Details |
|------|-------|---------|
| Domain Services | 1 | `ProgressionService` |
| Domain Value Objects | 1 | `LevelUpResult` |
| Application Services | 1 | Update `GameSessionService` |
| DTOs | 1 | `LevelUpDto` |
| Unit Tests | ~18 | |

### Data Model Changes

```
NEW: LevelUpResult (Value Object)
├── OldLevel: int
├── NewLevel: int
├── StatIncreases: StatModifiers
├── UnlockedAbilities: IReadOnlyList<string>
└── LevelsGained: int (computed)

NEW: ProgressionService
├── GetExperienceForLevel(level): int
├── GetLevelForExperience(xp): int
├── CheckLevelUp(player): LevelUpResult?
├── ApplyLevelUp(player, result): void
└── GetStatIncreasesForLevel(level): StatModifiers
```

### Default Level Thresholds

| Level | XP Required | Cumulative XP | Stat Bonuses |
|-------|-------------|---------------|--------------|
| 1 | 0 | 0 | (starting) |
| 2 | 100 | 100 | +5 HP, +1 ATK, +1 DEF |
| 3 | 150 | 250 | +5 HP, +1 ATK, +1 DEF |
| 4 | 250 | 500 | +5 HP, +1 ATK, +1 DEF |
| 5 | 500 | 1000 | +5 HP, +1 ATK, +1 DEF |
| 6+ | +500/level | ... | +5 HP, +1 ATK, +1 DEF |

### User-Facing Changes

**Level-Up Notification:**
```
═══════════════════════════════════════════
           ★ LEVEL UP! ★
═══════════════════════════════════════════
You have reached Level 2!

Stat Increases:
  Max Health: 100 → 105
  Attack: 10 → 11
  Defense: 5 → 6

New Abilities Unlocked:
  • Shield Bash (Warrior)

Next Level: 150 XP needed (Level 3)
═══════════════════════════════════════════
```

**Multi-Level Gain:**
```
═══════════════════════════════════════════
           ★ LEVEL UP! ★
═══════════════════════════════════════════
You gained 2 levels! (Level 1 → Level 3)

Total Stat Increases:
  Max Health: 100 → 110 (+10)
  Attack: 10 → 12 (+2)
  Defense: 5 → 7 (+2)
═══════════════════════════════════════════
```

### Acceptance Criteria

- [ ] Level-up detected when XP reaches threshold
- [ ] Player level increases correctly
- [ ] Stats increase on level-up
- [ ] Level-up notification displays
- [ ] Multiple levels can be gained at once
- [ ] Abilities unlock at appropriate levels (uses v0.0.4c)
- [ ] ~18 unit tests pass

---

## v0.0.8c: Progression Configuration

[v0.0.8c Design Specification](v0.0.8c-design-specification.md)

### Overview

Make the progression system fully configurable through JSON configuration, including terminology customization, progression curves, and class-specific rewards.

### Scope

**In Scope:**
- `ProgressionDefinition` entity loaded from config
- `LevelDefinition` for per-level configuration
- Configurable terminology (XP name, Level name)
- Configurable progression curves (linear, exponential, custom)
- Class-specific stat bonuses per level
- `config/progression.json` configuration file

**Out of Scope:**
- Prestige/Rebirth system (future version)
- Skill point allocation (future version)

### Key Deliverables

| Type | Count | Details |
|------|-------|---------|
| Domain Definitions | 2 | `ProgressionDefinition`, `LevelDefinition` |
| Configuration | 1 | `progression.json` |
| Application Services | 1 | Update `ProgressionService` |
| DTOs | 2 | `ProgressionDto`, `LevelDefinitionDto` |
| Unit Tests | ~14 | |

### Data Model Changes

```
NEW: ProgressionDefinition (Entity)
├── ExperienceTerminology: string (default "XP")
├── LevelTerminology: string (default "Level")
├── MaxLevel: int (default 20)
├── CurveType: ProgressionCurve (Linear, Exponential, Custom)
├── BaseXpRequirement: int (XP for level 2)
├── XpMultiplier: float (for exponential curves)
├── Levels: IReadOnlyList<LevelDefinition>
└── ClassOverrides: Dictionary<string, ClassProgressionOverride>

NEW: LevelDefinition (Entity)
├── Level: int
├── XpRequired: int (cumulative)
├── StatBonuses: StatModifiers
├── AbilitySlots: int (if using slot system)
└── CustomRewards: IReadOnlyList<string> (descriptive rewards)

NEW: ProgressionCurve (Enum)
├── Linear
├── Exponential
└── Custom

NEW: ClassProgressionOverride
├── ClassId: string
├── StatBonusMultipliers: StatModifiers (multipliers, not flat)
└── BonusXpMultiplier: float
```

### Configuration Example

```json
{
  "progression": {
    "experienceTerminology": "XP",
    "levelTerminology": "Level",
    "maxLevel": 20,
    "curveType": "Exponential",
    "baseXpRequirement": 100,
    "xpMultiplier": 1.5,
    "defaultStatBonuses": {
      "maxHealth": 5,
      "attack": 1,
      "defense": 1
    },
    "classOverrides": {
      "warrior": {
        "statBonusMultipliers": {
          "maxHealth": 1.5,
          "attack": 1.0,
          "defense": 1.2
        }
      },
      "mage": {
        "statBonusMultipliers": {
          "maxHealth": 0.8,
          "attack": 1.0,
          "defense": 0.8
        }
      }
    },
    "levels": [
      { "level": 5, "customRewards": ["Unlock: Advanced Training"] },
      { "level": 10, "customRewards": ["Unlock: Mastery Skills"] },
      { "level": 20, "customRewards": ["Title: Champion"] }
    ]
  }
}
```

### Custom Terminology Example

For a game wanting different terminology:

```json
{
  "progression": {
    "experienceTerminology": "Glory",
    "levelTerminology": "Rank",
    ...
  }
}
```

**Status Output with Custom Terminology:**
```
> status

=== Hero (Rank 3 Warrior) ===
HP: 110/110
Glory: 380/500 (76%)
```

### Acceptance Criteria

- [ ] Progression loaded from JSON configuration
- [ ] Terminology configurable (XP name, Level name)
- [ ] Progression curve selectable (linear, exponential, custom)
- [ ] Class-specific stat bonus multipliers work
- [ ] Display uses configured terminology
- [ ] Default configuration works if no custom config
- [ ] ~14 unit tests pass

---

## Dependencies & Prerequisites

```
v0.0.4 (Classes & Abilities) - REQUIRED
    │
    └── v0.0.4c: Ability System ──────────────────────┐
            (UnlockLevel, GetUnlockedAbilitiesAtLevel) │
                                                       │
v0.0.5 (Dice Pool System) - REQUIRED                  │
    │                                                  │
    └── v0.0.5c: Combat Integration ──────────────────┤
            (CombatService, monster defeat)            │
                                                       │
v0.0.6 (Enhanced Combat) - REQUIRED                   │
    │                                                  │
    └── Multi-monster combat, combat resolution ──────┤
                                                       │
v0.0.7 (Equipment System) - REQUIRED                  │
    │                                                  │
    └── Equipment bonuses affect stats ───────────────┘
                                                       │
                                                       ▼
v0.0.8 (Experience & Leveling)
    │
    ├── v0.0.8a: Core Experience System ──────────────┐
    │       Dependencies: CombatService, Monster       │
    │                                                  │
    ├── v0.0.8b: Level-Up Mechanics ──────────────────┤
    │       Dependencies: v0.0.8a, v0.0.4c (abilities)│
    │                                                  │
    └── v0.0.8c: Progression Configuration ───────────┘
            Dependencies: v0.0.8a, v0.0.8b
```

---

## Estimated Effort Summary

| Phase | New Files | Modified Files | Est. Tests | Complexity |
|-------|-----------|----------------|------------|------------|
| v0.0.8a | ~3 | ~4 | ~18 | Low |
| v0.0.8b | ~4 | ~3 | ~18 | Medium |
| v0.0.8c | ~4 | ~3 | ~14 | Medium |
| **Total** | **~11** | **~10** | **~50** | |

---

## Risk Assessment

| Risk | Impact | Probability | Mitigation |
|------|--------|-------------|------------|
| XP balance issues | Medium | Medium | Start conservative, tune based on playtesting |
| Stat inflation at high levels | Medium | Medium | Cap maximum level, diminishing returns |
| Breaking ability unlock logic | High | Low | Extensive tests, v0.0.4c already handles unlock levels |
| Configuration complexity | Medium | Low | Provide sensible defaults, validate JSON schema |
| Multi-level edge cases | Medium | Medium | Comprehensive tests for XP overflow scenarios |

---

## Design Decisions (Confirmed)

### Experience Mechanics

| Decision | Value | Notes |
|----------|-------|-------|
| **XP persistence** | On Player entity | Simple, persists with save |
| **XP source** | Monster defeat only (initially) | Quests, exploration in future |
| **XP sharing** | N/A (single player) | Multiplayer would need splitting logic |
| **Overkill bonus** | None | Simple formula for MVP |

### Level Mechanics

| Decision | Value | Notes |
|----------|-------|-------|
| **Max level** | 20 (default) | Configurable in v0.0.8c |
| **Multi-level gain** | Supported | Can gain multiple levels from one XP award |
| **Level down** | Not supported | No experience loss mechanic |
| **Level 1 XP** | 0 | Start at level 1 with 0 XP |

### Stat Increases

| Decision | Value | Notes |
|----------|-------|-------|
| **Default HP bonus** | +5 per level | Configurable |
| **Default ATK bonus** | +1 per level | Configurable |
| **Default DEF bonus** | +1 per level | Configurable |
| **Application** | Immediate | Stats updated on level-up |
| **HP on level-up** | Heal to new max | Quality of life |

### Progression Curves

| Decision | Value | Notes |
|----------|-------|-------|
| **Default curve** | Exponential (1.5x) | Standard RPG feel |
| **Base requirement** | 100 XP | XP needed for level 2 |
| **Custom levels** | Supported | Override specific levels in config |

---

## Integration with Existing Systems

### CombatService Integration

```csharp
// In CombatService, after monster defeat:
public CombatRoundResult ResolveCombatRound(...)
{
    // ... existing combat logic ...

    if (monster.IsDefeated)
    {
        // Return XP value in result
        return result with { ExperienceGained = monster.ExperienceValue };
    }
}
```

### AbilityService Integration (v0.0.4c)

```csharp
// Already exists - check for newly unlocked abilities
public IReadOnlyList<string> GetUnlockedAbilitiesAtLevel(string classId, int level)
{
    return _abilities.Values
        .Where(a => a.IsAvailableToClass(classId) && a.UnlockLevel == level)
        .Select(a => a.Id)
        .ToList();
}
```

---

## Files Summary

### Files to Create (New)

| Phase | File | Purpose |
|-------|------|---------|
| 8a | `ExperienceService.cs` | XP calculation and awarding |
| 8a | `ExperienceGainDto.cs` | DTO for XP gain events |
| 8b | `ProgressionService.cs` | Level-up logic |
| 8b | `LevelUpResult.cs` | Value object for level-up details |
| 8b | `LevelUpDto.cs` | DTO for level-up display |
| 8c | `ProgressionDefinition.cs` | Progression config entity |
| 8c | `LevelDefinition.cs` | Per-level config entity |
| 8c | `ProgressionCurve.cs` | Enum for curve types |
| 8c | `config/progression.json` | Progression configuration |

### Files to Modify

| Phase | File | Changes |
|-------|------|---------|
| 8a | `Player.cs` | Add `Experience`, `AddExperience()` |
| 8a | `Monster.cs` | Add `ExperienceValue` |
| 8a | `CombatService.cs` | Return XP on monster defeat |
| 8a | `SpectreGameRenderer.cs` | Display XP in status, show XP gain |
| 8b | `GameSessionService.cs` | Check level-up after XP gain |
| 8b | `SpectreGameRenderer.cs` | Render level-up notification |
| 8c | `ProgressionService.cs` | Load config, apply class overrides |
| 8c | `IGameConfigurationProvider.cs` | Add progression config methods |
| 8c | `JsonConfigurationProvider.cs` | Load progression.json |

---

## Next Steps

1. **Review & Approve** - Confirm scope breakdown
2. **v0.0.8a Design Spec** - Create XP system specification
3. **Implement v0.0.8a** - Build experience tracking
4. **v0.0.8b Design Spec** - Create level-up specification
5. **Implement v0.0.8b** - Build level-up mechanics
6. **v0.0.8c Design Spec** - Create configuration specification
7. **Implement v0.0.8c** - Build configurable progression

---

*This scope breakdown provides a structured approach to implementing v0.0.8 Experience & Leveling. The system builds on existing infrastructure (Player.Level, AbilityDefinition.UnlockLevel) and integrates with the combat system to create a complete progression loop.*
