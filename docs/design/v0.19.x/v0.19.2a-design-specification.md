# Design Specification: v0.19.2a - Svartalfheim & Helheim Implementation

**Version:** v0.19.2a
**Status:** Design Phase
**Last Updated:** 2026-01-28
**Target Tests:** ~24 unit and integration tests
**Decks Implemented:** Deck 06 (Svartalfheim), Deck 09 (Helheim)

---

## Table of Contents

1. [Executive Summary](#1-executive-summary)
2. [Feature Overview](#2-feature-overview)
3. [Architecture Diagrams](#3-architecture-diagrams)
4. [User Stories](#4-user-stories)
5. [Svartalfheim Biome Specification](#5-svartalfheim-biome-specification)
6. [Helheim Biome Specification](#6-helheim-biome-specification)
7. [Zone Specifications](#7-zone-specifications)
8. [TotalDarkness Environmental Condition](#8-totaldarkness-environmental-condition)
9. [ToxicAtmosphere Environmental Condition](#9-toxicatmosphere-environmental-condition)
10. [Garm's Watch Shared Zone Mechanics](#10-garms-watch-shared-zone-mechanics)
11. [Environmental Property Systems](#11-environmental-property-systems)
12. [Decision Trees and Flow Diagrams](#12-decision-trees-and-flow-diagrams)
13. [Configuration Files](#13-configuration-files)
14. [Code Examples](#14-code-examples)
15. [Logging Specifications](#15-logging-specifications)
16. [Unit Testing Requirements](#16-unit-testing-requirements)
17. [Deliverable Checklist](#17-deliverable-checklist)
18. [Acceptance Criteria](#18-acceptance-criteria)
19. [Dependencies](#19-dependencies)
20. [Deferrals and Future Considerations](#20-deferrals-and-future-considerations)

---

## 1. Executive Summary

Version 0.19.2a introduces two Norse-themed realm decks with specialized environmental hazard systems and vertical stratification. This implementation focuses on:

- **Svartalfheim (Deck 06):** The Dvergr Forges - a dark underground manufacturing complex with total darkness as the primary condition
- **Helheim (Deck 09):** The Gangrenous Gut - a toxic waste reclamation facility with extreme environmental corruption
- **Environmental Conditions:** Two new specialized condition types (TotalDarkness, ToxicAtmosphere) with distinct mechanical effects
- **Shared Zone:** Garm's Watch serves as a transition point between both realms with shared accessibility
- **Vertical Stratification:** Both realms feature 2-3 Z-level ranges with zone-specific difficulty progression

### Key Deliverables

| Category | Count | Details |
|----------|-------|---------|
| **Biome Definitions** | 2 | Svartalfheim, Helheim |
| **Zones** | 6 | 3 for Svartalfheim, 3 for Helheim (1 shared) |
| **Environmental Conditions** | 2 | TotalDarkness, ToxicAtmosphere |
| **Condition Mechanics** | 4 | Vision blocking, light sources, poison damage, hallucination |
| **Configuration Files** | 2 | svartalfheim.json, helheim.json |
| **Zone Definitions** | 6 | Complete specifications with hazard DCs |
| **Unit Tests** | ~24 | Comprehensive test coverage |

### Realm Implementation Status

| Realm | Deck | Status | Hazard Type | Condition |
|-------|------|--------|-------------|-----------|
| **Svartalfheim** | 06 | v0.19.2a | Environmental Darkness | TotalDarkness |
| **Helheim** | 09 | v0.19.2a | Biological Toxicity | ToxicAtmosphere |

---

## 2. Feature Overview

### 2.1 Svartalfheim (Deck 06) - The Dvergr Forges

**Conceptual Theme:** An underground dwarven manufacturing complex shrouded in perpetual darkness, lit only by the glow of sacred forges and trade illumination.

**Key Features:**
- TotalDarkness primary condition (vision blocked without light sources, DC 12 base)
- Three distinct zones with varying light levels
- Sacred forge locations with intense heat (45°C, DC 12)
- Vertical range: Z -2 to Z 0
- Environmental stress: Moderate temperature (25°C), low corrosion (0.1), dwergr scale (0.9)
- Aetheric saturation: 0.4 (neutral magical field)

**Zones:**

| Zone | Light Level | Difficulty | Description | Key Mechanics |
|------|------------|-----------|-------------|---|
| The Bright Halls | 0.6 | None | Trade halls and merchant areas | No primary hazard, standard visibility |
| The Black Veins | 0.0 | DC 16 | Deep mining tunnels with active extraction | Total darkness, vision completely blocked |
| Forge Core | 0.3 | DC 12 | Sacred forges and crafting areas | Intense heat (45°C), moderate darkness |

### 2.2 Helheim (Deck 09) - The Gangrenous Gut

**Conceptual Theme:** An organic waste reclamation facility that has become a gangrenous processing center of biological corruption and toxic decomposition.

**Key Features:**
- ToxicAtmosphere primary condition (poison damage + hallucinations, DC 14 base)
- Extreme environmental corruption (corrosion 0.8)
- Three distinct processing zones with escalating hazard levels
- Vertical range: Z -3 to Z -1
- Environmental stress: High temperature (28°C), extreme humidity (90%), standard scale (1.0)
- Aetheric saturation: 0.2 (low magical field)

**Zones:**

| Zone | Atmosphere DC | Damage | Description | Key Mechanics |
|------|--------------|--------|-------------|---|
| Upper Bile | DC 12 | 1d6 | Surface processing and collection areas | Standard toxic exposure |
| The Dissolution Pits | DC 20 | 3d8 | Active recycling vats with intense corrosion | Extreme hazard, cumulative damage |
| Garm's Watch | None | None | Fortified checkpoint and transition zone | Shared with Svartalfheim, no hazard |

---

## 3. Architecture Diagrams

### 3.1 Domain Layer Architecture

```
┌─────────────────────────────────────────────────────────────┐
│                 Nine Realms System (v0.19.2a)               │
├─────────────────────────────────────────────────────────────┤
│                                                               │
│  ┌──────────────────────────┐  ┌──────────────────────────┐  │
│  │ Svartalfheim (Deck 06)   │  │ Helheim (Deck 09)        │  │
│  │   The Dvergr Forges      │  │ The Gangrenous Gut       │  │
│  ├──────────────────────────┤  ├──────────────────────────┤  │
│  │ Primary: TotalDarkness   │  │ Primary: ToxicAtmosphere │  │
│  │ - The Bright Halls       │  │ - Upper Bile             │  │
│  │ - The Black Veins        │  │ - Dissolution Pits       │  │
│  │ - Forge Core             │  │ - Garm's Watch (shared)  │  │
│  │                          │  │                          │  │
│  │ Temp: 25°C               │  │ Temp: 28°C               │  │
│  │ Humidity: 30%            │  │ Humidity: 90%            │  │
│  │ Aetheric: 0.4            │  │ Aetheric: 0.2            │  │
│  │ Z Range: -2 to 0         │  │ Z Range: -3 to -1        │  │
│  └──────────────────────────┘  └──────────────────────────┘  │
│            │                                    │             │
│            └────────────────┬───────────────────┘             │
│                             │                                 │
│              ┌──────────────▼──────────────┐                  │
│              │   Zone Management Layer     │                  │
│              ├──────────────────────────────┤                  │
│              │ - Zone Definitions           │                  │
│              │ - Environmental Properties   │                  │
│              │ - Condition Resolution       │                  │
│              │ - Adjacency Management       │                  │
│              │ - Shared Zone Coordination   │                  │
│              └──────────────────────────────┘                  │
│                             │                                 │
│              ┌──────────────▼──────────────┐                  │
│              │ Environmental System Layer  │                  │
│              ├──────────────────────────────┤                  │
│              │ - Temperature Modeling       │                  │
│              │ - Visibility Calculations    │                  │
│              │ - Poison Damage Resolution   │                  │
│              │ - Condition Effect Stacking  │                  │
│              │ - Hallucination Management   │                  │
│              └──────────────────────────────┘                  │
│                                                               │
└─────────────────────────────────────────────────────────────┘
```

### 3.2 Application Layer Architecture

```
┌─────────────────────────────────────────────────────────────┐
│              Application Services Layer                      │
├─────────────────────────────────────────────────────────────┤
│                                                               │
│  ┌──────────────────────┐  ┌──────────────────────────┐     │
│  │ IBiomeProvider       │  │ IEnvironmentalCondition  │     │
│  │ Interface            │  │ Service Interface        │     │
│  ├──────────────────────┤  ├──────────────────────────┤     │
│  │ + GetBiome()         │  │ + ResolveDarkness()      │     │
│  │ + GetZone()          │  │ + ResolveToxicity()      │     │
│  │ + ListZones()        │  │ + CalculateVision()      │     │
│  │ + ValidateAccess()   │  │ + CalculateDamage()      │     │
│  │ + GetProperties()    │  │ + ApplyHallucination()   │     │
│  └──────────────────────┘  └──────────────────────────┘     │
│           │                              │                  │
│           └──────────────┬───────────────┘                  │
│                          │                                  │
│  ┌──────────────────────────────────────────────────┐       │
│  │ SvartalfheimService / HelheimService             │       │
│  │ (Specialized Implementations)                    │       │
│  ├──────────────────────────────────────────────────┤       │
│  │ + EvaluateLightSources()                         │       │
│  │ + CalculateHallucinationResistance()             │       │
│  │ + ComputeSharedZoneAccess()                      │       │
│  │ + VerifyZoneTransition()                         │       │
│  └──────────────────────────────────────────────────┘       │
│                          │                                  │
│  ┌──────────────────────────────────────────────────┐       │
│  │ Data Layer                                       │       │
│  ├──────────────────────────────────────────────────┤       │
│  │ - svartalfheim.json (zone definitions)           │       │
│  │ - helheim.json (zone definitions)                │       │
│  │ - Environmental Configuration                    │       │
│  │ - Condition Look-up Tables                       │       │
│  └──────────────────────────────────────────────────┘       │
│                                                               │
└─────────────────────────────────────────────────────────────┘
```

---

## 4. User Stories

### User Story 1: Navigator Enters Dark Mining Zone

**As a** player character entering The Black Veins of Svartalfheim
**I want to** navigate through total darkness using light sources or spatial awareness
**So that** I can explore the mining tunnels and locate resources

**Acceptance Criteria:**
- Without light sources, vision is completely blocked (DC 16 Perception check required)
- Carrying a light source (torch, enchanted item) reveals environment up to 30 feet
- Failed perception checks result in fumbling movement or getting disoriented
- Multiple light sources provide cumulative illumination radius
- Environmental condition "TotalDarkness" is automatically applied upon zone entry

### User Story 2: Worker Exposed to Toxic Waste

**As a** character in The Dissolution Pits of Helheim
**I want to** resist the toxic atmosphere with Constitution saves and protective equipment
**So that** I can survive long-term exposure to the hazardous environment

**Acceptance Criteria:**
- Initial exposure triggers DC 20 Constitution check
- Failed save deals 3d8 poison damage
- Successful save deals half damage (1d8 + 1d8)
- Repeated saves increase DC by +1 (stacking up to maximum DC 25)
- Protective gear (chemical suit) grants +2 bonus to saves or +4 if specialized
- Hallucination effects manifest on critical failures (double failed saves)

### User Story 3: Transition Through Shared Zone

**As a** character navigating between Svartalfheim and Helheim
**I want to** pass through Garm's Watch without encountering realm-specific hazards
**So that** I can explore both realms without logistical barriers

**Acceptance Criteria:**
- Garm's Watch is accessible from both Svartalfheim (Forge Core exit) and Helheim (Upper Bile entrance)
- Primary environmental conditions (TotalDarkness, ToxicAtmosphere) do NOT apply in this zone
- Zone status shows "SharedWith: [Svartalfheim, Helheim]" in configuration
- Transitioning characters retain movement points and condition status
- Light sources remain active when transitioning from Svartalfheim
- Poison resistance checks do not apply in Garm's Watch itself

### User Story 4: Strategic Resource Management

**As a** expedition leader
**I want to** understand the environmental hazards and plan resource allocation
**So that** I can optimize party composition and equipment loadouts

**Acceptance Criteria:**
- Character sheet displays active environmental conditions with DC and effects
- Equipment durability warnings trigger when corrosion rates exceed thresholds
- Light source inventory is tracked and consumable units are displayed
- Poison resistance items/potions show effectiveness duration
- Environmental hazard roadmap is available showing all zones and their specific DCs
- Condition stacking mechanics are transparent in UI display

---

## 5. Svartalfheim Biome Specification

### 5.1 Biome Definition

**Realm ID:** Svartalfheim (6)
**Deck Number:** 06
**Name:** The Dvergr Forges
**Theme:** Underground dwarven manufacturing complex shrouded in sacred darkness

### 5.2 Base Environmental Properties

```
Base Properties:
- Temperature: 25°C (cool underground)
- Aetheric Saturation: 0.4 (neutral magical field)
- Humidity: 30% (dry due to forge ventilation)
- Light Level: 0.3 (baseline, zone-specific)
- Scale Multiplier: 0.9 (Dvergr tunnels, slightly compressed)
- Corrosion Rate: 0.1 (minimal degradation, well-maintained)
```

### 5.3 Primary Environmental Condition

**Condition Type:** TotalDarkness
**Base DC:** 12
**Effect Category:** Vision Blocking / Light Dependent
**Duration:** Persistent (zone-dependent)

### 5.4 Vertical Range

**Minimum Z-Level:** -2 (Deep forges and mining operations)
**Maximum Z-Level:** 0 (Upper halls and merchant areas)
**Height Progression:** Linear descent through zones

### 5.5 Biome Zones (3 total)

#### Zone 1: The Bright Halls

**Zone ID:** svartalfheim.bright_halls
**Vertical Range:** Z 0 (ground level)
**Local Temperature:** 25°C (maintained by ventilation systems)
**Light Level:** 0.6 (bright by underground standards)
**Primary Hazard:** None
**Difficulty:** Narrative/Social (no combat hazard)

**Description:**
The upper trading halls of Svartalfheim feature merchant stalls, negotiation areas, and administrative chambers. Magical rune-lamps mounted on stone pillars provide steady illumination, casting dancing shadows across carved reliefs of dwarven engineering achievements. The air smells of metal polish and ancient stone.

**Mechanical Effects:**
- Standard visibility (60 feet in normal conditions)
- No environmental condition hazards
- Movement cost: Normal
- Safe zone for resource trading and character interaction

#### Zone 2: The Black Veins

**Zone ID:** svartalfheim.black_veins
**Vertical Range:** Z -2 to Z -1 (mining tunnels)
**Local Temperature:** 25°C (stable due to depth)
**Light Level:** 0.0 (absolute darkness)
**Primary Hazard:** TotalDarkness
**Difficulty:** DC 16 Perception/Survival

**Description:**
Ancient mining tunnels carved through obsidian veins and dark granite. These passages were worked by dwarven miners for millennia, creating a maze-like network of extraction chambers and secondary shafts. The air carries the scent of iron ore and deep earth. Without light sources, navigating here is nearly impossible as darkness is absolute and complete.

**Mechanical Effects:**
- TotalDarkness condition applies on entry
- Vision completely blocked without light sources (see Section 8)
- Failed DC 16 Perception check: character becomes disoriented
  - Next movement action has 50% chance of fumbling
  - Character may accidentally trigger hazards
- Carrying functional light source: negates vision blocking up to 30 feet radius
- Multiple light sources stack (radius +20 feet per additional source)
- Sensory abilities (tremorsense, darkvision) may partially bypass darkness
  - Darkvision reveals terrain but not specific hazards
  - Tremorsense provides clear spatial orientation

#### Zone 3: Forge Core

**Zone ID:** svartalfheim.forge_core
**Vertical Range:** Z -1 to Z 0 (sacred forge chamber)
**Local Temperature:** 45°C (extreme heat from active forges)
**Light Level:** 0.3 (firelight from active furnaces)
**Primary Hazard:** IntenseHeat
**Secondary Hazard:** TotalDarkness (partial)
**Difficulty:** DC 12 Endurance/Fortitude

**Description:**
The heart of dwarven manufacturing - a vast chamber housing seven sacred forges permanently lit with magical flames. Massive stone anvils dominate the central work areas. The heat radiates from metal-working stations where artifacts are crafted. Ventilation shafts carry smoke upward into vast chimney systems. The combination of firelight and shadows creates an eerie, wavering illumination.

**Mechanical Effects:**
- IntenseHeat condition applies: DC 12 Endurance check required per round of exposure
  - Failed check: 1d6 heat damage + exhaustion counter +1
  - Successful check: no damage, resistance builds
  - Critical success: +1 AC bonus from heat acclimation (next 10 minutes)
- TotalDarkness partially mitigated (light level 0.3)
  - Vision reduced to 20 feet without light sources
  - Firelight provides dim illumination of terrain
- Fire safety hazards present
  - Characters may suffer immersion in lava-adjacent areas
  - Equipment near forges requires endurance checks to prevent damage

---

## 6. Helheim Biome Specification

### 6.1 Biome Definition

**Realm ID:** Helheim (9)
**Deck Number:** 09
**Name:** The Gangrenous Gut
**Theme:** Organic waste reclamation facility descended into biological corruption

### 6.2 Base Environmental Properties

```
Base Properties:
- Temperature: 28°C (warm due to bacterial decomposition)
- Aetheric Saturation: 0.2 (low magical field, disrupted by toxins)
- Humidity: 90% (extreme moisture from recycling processes)
- Light Level: 0.4 (baseline, zone-specific)
- Scale Multiplier: 1.0 (humanoid scale)
- Corrosion Rate: 0.8 (extreme degradation from toxic compounds)
```

### 6.3 Primary Environmental Condition

**Condition Type:** ToxicAtmosphere
**Base DC:** 14
**Effect Category:** Poison Damage / Hallucination
**Duration:** Persistent (cumulative exposure)

### 6.4 Vertical Range

**Minimum Z-Level:** -3 (Deep recycling vats)
**Maximum Z-Level:** -1 (Upper processing areas)
**Height Progression:** Descending through processing layers

### 6.5 Biome Zones (3 total, 1 shared)

#### Zone 1: Upper Bile

**Zone ID:** helheim.upper_bile
**Vertical Range:** Z -1 (surface collection)
**Local Temperature:** 28°C (baseline)
**Humidity:** 90%
**Light Level:** 0.4 (bioluminescent molds)
**Primary Hazard:** ToxicAtmosphere
**Difficulty:** DC 12 Constitution

**Description:**
The upper processing chambers where organic waste is initially collected and sorted. Bioluminescent mold colonies provide eerie green-blue illumination. Large receptacles and conveyor systems move material downward to the deeper processing areas. The air reeks of decomposition and caustic chemicals. Moisture condenses on every surface, and slime coats the floor.

**Mechanical Effects:**
- ToxicAtmosphere condition applies on entry
- DC 12 Constitution check required on arrival and every subsequent turn
  - Failed check: 1d6 poison damage
  - Successful check: no damage, +1 resistance for next 10 minutes
- Equipment corrosion check: DC 13 to prevent -1 durability penalty
- Hallucination check: on critical failure (natural 1), DC 16 Wisdom save or suffer minor hallucination
  - Minor hallucination: -1 penalty to next Perception check
- Protective gear grants +2 to Constitution check or negates damage on success (chemical suit)

#### Zone 2: The Dissolution Pits

**Zone ID:** helheim.dissolution_pits
**Vertical Range:** Z -3 to Z -2 (deep recycling vats)
**Local Temperature:** 28°C (constant from thermal processes)
**Humidity:** 95%+ (saturated mist)
**Light Level:** 0.2 (dim bioluminescence)
**Primary Hazard:** ToxicAtmosphere (Extreme)
**Difficulty:** DC 20 Constitution

**Description:**
The deepest processing area where organic material is dissolved and recycled in massive stone vats. Caustic chemical solutions bubble and steam. The light is almost completely obscured by thick poisonous mist. Ghostly forms move in the fog - possibly creatures adapted to this hellscape, or merely hallucinations from the toxic exposure. The caustic smell burns lungs and eyes. This is the most dangerous zone in Helheim.

**Mechanical Effects:**
- ToxicAtmosphere condition applies (extreme intensity)
- DC 20 Constitution check required on arrival and every round
  - Failed check: 3d8 poison damage (massive exposure)
  - Successful check: half damage (1d8 + 1d4)
  - Critical failure: damage + DC 16 Wisdom save or suffer major hallucination
- Repeated exposure stacks DC +1 for each check failed (cumulative, max DC 25)
- Equipment corrosion check: DC 11 (automatic on any round spent here)
  - Failed check: -1 durability + item must make DC 15 save or break
- Visibility severely reduced: 10 feet maximum
- Hallucination effects on major hallucination (2+ consecutive failures):
  - Character sees threatening illusions
  - -3 penalty to AC and attack rolls for 1d4 rounds
  - Random wandering movement possible

#### Zone 3: Garm's Watch (SHARED)

**Zone ID:** helheim.garms_watch
**Administratively Assigned:** Helheim
**Shared With:** Svartalfheim (via Forge Core)
**Vertical Range:** Z -1 (fortified checkpoint level)
**Local Temperature:** 26°C (moderate, between both realms)
**Humidity:** 60% (controlled ventilation)
**Light Level:** 0.5 (maintained by magical wards)
**Primary Hazard:** None
**Difficulty:** None (safe zone)

**Description:**
An ancient fortified checkpoint where the two realms connect. Stone walls reinforced with runes of protection create a buffer zone between Svartalfheim's forges and Helheim's toxic processing. A statue of Garm, the legendary guardian, stands in the center chamber, its eyes glowing faintly with protective magic. Air flows freely here, creating a neutral atmospheric zone. This is the only place where representatives from both realms have historically met to negotiate.

**Mechanical Effects:**
- SharedWith flag: [Svartalfheim, Helheim]
- No realm-specific environmental conditions apply
- TotalDarkness effect: NEGATED (light level 0.5 is sufficient)
- ToxicAtmosphere effect: NEGATED (ventilation negates poison)
- Safe transition point for movement between realms
- Light sources remain active upon entry/exit
- Character condition status preserved on transition
- Movement cost: Normal (no penalties)
- Environmental conditions from adjacent zones do NOT bleed into this zone

---

## 7. Zone Specifications

### 7.1 Zone Summary Table

| Realm | Zone Name | Zone ID | Z-Range | Light | Hazard | DC | Damage |
|-------|-----------|---------|---------|-------|--------|----|----|
| Svartalfheim | The Bright Halls | sbh | 0 | 0.6 | None | — | — |
| Svartalfheim | The Black Veins | sbv | -2 to -1 | 0.0 | TotalDarkness | 16 | Vision blocked |
| Svartalfheim | Forge Core | sfc | -1 to 0 | 0.3 | IntenseHeat | 12 | 1d6 heat |
| Helheim | Upper Bile | hbu | -1 | 0.4 | ToxicAtmosphere | 12 | 1d6 poison |
| Helheim | Dissolution Pits | hdp | -3 to -2 | 0.2 | ToxicAtmosphere (Extreme) | 20 | 3d8 poison |
| Helheim | Garm's Watch | hgw | -1 | 0.5 | None (Shared) | — | — |

### 7.2 Zone Access and Connectivity

**Svartalfheim Internal Flow:**
```
The Bright Halls (Z 0)
    ↓
Forge Core (Z -1 to 0)
    ↓
The Black Veins (Z -2 to -1)
```

**Helheim Internal Flow:**
```
Upper Bile (Z -1)
    ↓
The Dissolution Pits (Z -3 to -2)
```

**Cross-Realm Transition:**
```
Svartalfheim: Forge Core (Z 0)
    ↔ (via Garm's Watch)
Helheim: Upper Bile (Z -1)
```

---

## 8. TotalDarkness Environmental Condition

### 8.1 Condition Definition

**Condition Type:** Environmental / Vision-Based
**Scope:** Affects sight-dependent actions and navigation
**Duration:** Persistent while in zone (The Black Veins)
**Interaction Model:** Light Source Dependent

### 8.2 Mechanical Framework

#### Vision Blocking Mechanics

**Base State (No Light Source):**
- Vision range: 0 feet (completely blocked)
- Perception checks: DC +4 modifier
- Darkvision: Works normally (bypasses darkness)
- Tremorsense: Works normally (bypasses darkness)
- Blindsight: Works normally (bypasses darkness)
- Magic-based sight: Requires DC 16 Arcana check to maintain

**Light Source Presence:**
- Single torch or equivalent: Vision range extends to 30 feet
- Multiple light sources: +20 feet per additional source
- Magical light (dancing lights, continual flame): 40-50 feet radius
- Natural bioluminescence: 10-15 feet (variable)
- Moonlight/external light: BLOCKED (underground, no external source)

**Light Source Effectiveness:**

| Source | Bright Radius | Dim Radius | Duration | Cost |
|--------|--------------|-----------|----------|------|
| Torch | 20 ft | 40 ft | 1 hour | Common (1 sp) |
| Lamp | 30 ft | 60 ft | 4 hours | Uncommon (2 sp) |
| Continual Flame | 60 ft | 120 ft | Permanent | Magical (300 gp) |
| Enchanted Orb | 40 ft | 80 ft | 8 hours | Rare (100+ gp) |
| Daylight Spell | 60 ft | 120 ft | 1 hour | Spell slot |
| Darkvision | Natural | Natural | Permanent | Innate |

#### Vision-Dependent Actions

**Navigation Checks:**
- Moving cautiously: DC 14 Survival check (no light source)
- Moving at normal pace: DC 16 Survival check (no light source)
- Moving at fast pace: DC 18 Survival check (no light source)
- Running: Automatic collision with terrain (50% failure)

**Perception Checks:**
- Spotting hazards: DC 16 base + 2 per light source absence
- Detecting movement: DC 14 base + 1 per light source absence
- Identifying objects: DC 12 base + 3 per light source absence

**Combat Modifications:**
- Attack rolls: -2 penalty per 10 feet of darkness beyond vision
- AC: +2 bonus (partial concealment from darkness)
- Initiative: -1 penalty (slower reaction in darkness)

### 8.3 Light Source Management System

**Resource Tracking:**
```
Light Source Inventory (Character Sheet):
├── Torch (3x)
│   ├── Condition: Good
│   ├── Burn Time: 1 hour
│   └── Range: 20 ft bright
├── Oil Lamp (1x)
│   ├── Condition: Good
│   ├── Burn Time: 4 hours
│   └── Range: 30 ft bright
└── Enchanted Orb (1x)
    ├── Condition: Good
    ├── Charge: 87% full
    └── Range: 40 ft bright
```

**Light Source Depletion:**
- Torch burns 1 unit per hour of active use
- Oil lamp burns 1 unit per 4 hours
- Enchanted items require recharge (usually magical means)
- Extinguished sources can be re-lit (torches, lamps)
- Magical light cannot be extinguished by non-magical means

**Environmental Interactions:**
- Water and moisture: Torches have 40% chance to extinguish per round in wet areas
- Violent movement: Torches have 20% chance to extinguish per dodge/tumble
- Wind currents: Torches have 30% chance to extinguish if exposed
- Magical suppression: Anti-magic field extinguishes all but permanent magical light

### 8.4 Fallback Navigation Systems

**Sensory Alternatives to Light:**
- Tremorsense (10-20 feet through ground vibrations)
- Echolocation (character shouts, noise-based navigation)
- Touch-based navigation (character guides self by hand on walls)
- Magical detection (detect magic, detect life)

**Skill Checks for Sensory Navigation:**
- Tremorsense: DC 12 Survival check
- Echolocation: DC 14 Perception check (requires noise)
- Touch navigation: DC 10 Acrobatics check (movement halved)
- Magical detection: Varies by spell

### 8.5 Special Interactions

**Svartalfheim Forge Light:**
- Forges in Forge Core emit significant light (cumulative +0.3 light level)
- Sacred flame cannot be extinguished by mundane means
- Forges provide slight reduction in darkness DC (DC 12 vs DC 16 in Black Veins)

**Rune-Lamps:**
- Dwarven enchanted lamps in Bright Halls provide stable light
- These lamps are FIXED installations (cannot be taken)
- If character carries enchanted portable light from Bright Halls, carries crafted rune-lamp

---

## 9. ToxicAtmosphere Environmental Condition

### 9.1 Condition Definition

**Condition Type:** Environmental / Poison-Based
**Scope:** Affects health via poison damage and mental state via hallucinations
**Duration:** Cumulative exposure (damage persists across rounds)
**Interaction Model:** Cumulative DC with Environmental Resistance

### 9.2 Poison Damage Mechanics

#### Primary Exposure Framework

**Initial Exposure (Zone Entry):**
- Automatically triggered when entering Upper Bile or Dissolution Pits
- Constitution save required immediately (DC 12 or DC 20)
- No action required to resist (automatic reflex)
- Result determines immediate damage

**Damage Calculation:**

| Zone | Difficulty | Success | Failure | Critical Failure |
|------|-----------|---------|---------|------------------|
| Upper Bile | DC 12 | No damage | 1d6 poison | 1d6 + hallucination |
| Dissolution Pits | DC 20 | 1d8 poison (half) | 3d8 poison | 3d8 + major hallucination |

**Sustained Exposure:**
- Each round in affected zone requires repeated Constitution save
- Stacking DC: Base DC + (number of failed saves × 1)
- Maximum stacking DC: 25 (cannot exceed)
- Successful save: +1 temporary resistance bonus for next 10 minutes (stacks up to +5)
- Failed save: apply damage, increment failure counter

**Example Sustained Exposure Sequence (Dissolution Pits):**
```
Round 1: DC 20 Constitution save
  - Fail → 3d8 poison damage, failure counter = 1
Round 2: DC 21 Constitution save (20 + 1)
  - Fail → 3d8 poison damage, failure counter = 2
Round 3: DC 22 Constitution save (20 + 2)
  - Success → No damage, +1 resistance bonus for 10 minutes
Round 4: DC 22 Constitution save (maintains level)
  - Fail → 3d8 poison damage, failure counter = 3
  - NOTE: Critical failure would trigger major hallucination
```

#### Poison Resistance Factors

**Character Abilities:**
- Poison resistance: Automatic 50% damage reduction
- Poison immunity: Complete negation of damage
- Constitution modifier: +1 per point above 10 (-1 per point below 10)
- Class features (Paladin Lay on Hands, Druid, etc.): Apply as specified

**Equipment and Items:**
- Antitoxin potion: +4 to Constitution save (one-time use, 1 hour duration)
- Chemical suit: +2 to Constitution save OR auto-success on one check
- Breathable filter mask: DC reduction -2 (e.g., DC 12 becomes DC 10)
- Protective gloves: No effect on poison damage but prevents contact-based poison

**Environmental Modifiers:**
- Active ventilation (Garm's Watch): ToxicAtmosphere negated
- Wind or air current: DC reduction -1
- High temperature (heat damage nearby): DC reduction -2 (accelerated immune response)
- Magical barrier (protection from poison): Auto-resistance or +3 to save

**Stacking Rules:**
- Multiple bonuses stack additively
- Maximum effective bonus: +10 (beyond which DC approaches 4, minimum)
- Equipment and ability bonuses stack freely
- Temporary resistance bonuses (from successful saves) stack with permanent bonuses

### 9.3 Hallucination Mechanics

#### Hallucination Trigger Conditions

**Minor Hallucinations (Trigger):**
- Critical failure on Constitution save (natural 1)
- OR: 2 consecutive failed saves in same zone (without intervening success)
- Effect severity: Low (visual/auditory disturbances)

**Major Hallucinations (Trigger):**
- 3+ consecutive failed saves in same zone
- OR: Critical failure followed by failure (cumulative)
- Effect severity: High (loss of reality, behavioral changes)

#### Hallucination Effects

**Minor Hallucination Effects:**
- Duration: 1d4 rounds
- Save: DC 16 Wisdom save to resist/end early
- Effects (roll 1d4):
  1. **Visual Distortion:** -1 to Perception checks
  2. **Auditory Confusion:** Perceive whispers/voices (disadvantage on Listen checks)
  3. **Spatial Warping:** Estimate distance incorrectly (20% chance per action to misjudge)
  4. **Color Inversion:** World colors appear reversed, -1 to initiative

**Major Hallucination Effects:**
- Duration: 2d6 rounds or until removed magically
- Save: DC 16 Wisdom save per round to partially resist
- Effects (roll 1d6):
  1. **Entity Hallucination:** See phantom enemies (attack them, -3 to AC/attacks against real enemies)
  2. **Ground Warping:** Believe ground is not solid (50% chance to stumble per movement)
  3. **Self-Perception:** Believe self is transformed/corrupted (-2 to all rolls, paranoia)
  4. **Temporal Distortion:** Time seems to move wrong (-2 initiative, +2 rounds to complete actions)
  5. **Multiplicity:** See multiple copies of everything (disadvantage on all attack rolls)
  6. **Void Perception:** See only darkness and emptiness (-4 to Perception, lose sense of direction)

#### Hallucination Resistance

**Innate Resistances:**
- Elves: Natural resistance, hallucinations shortened by 50%
- Dwarves: Magical resistance to illusions, DC reduction -2
- Gnomes: Illusion affinity, saves have advantage

**Class Features:**
- Paladin: Turn ability may dispel hallucinations (DC 14 Charisma save for effect)
- Wizard/Sorcerer: Dispel magic ends hallucinations
- Cleric: Remove curse/greater restoration removes hallucinations

**Equipment:**
- Ring of protection: +1 to Wisdom saves vs hallucination
- Helm of telepathy: Can communicate with allies to reality-check hallucination
- Amulet of clarity: Automatic Wisdom save with advantage

### 9.4 Cumulative Exposure Tracking

**Exposure Counter:**
- Tracks number of poison damage instances received
- Resets when character leaves zone and rests for 1 hour
- Does not reset if character re-enters same zone within 1 hour

**Cumulative Effects:**

| Damage Count | Effect | Severity |
|--------------|--------|----------|
| 1-2 | Mild nausea, -0 penalties | Minimal |
| 3-4 | Moderate poisoning, -1 to Constitution checks | Moderate |
| 5-7 | Severe poisoning, -2 to Constitution checks, disadvantage | Severe |
| 8+ | Critical poisoning, -3 to Constitution checks, hallucinations guaranteed | Critical |

**Recovery Mechanics:**
- Long rest outside toxic zone: Reset exposure counter to 0
- Greater restoration spell: Reset counter and remove hallucinations
- Specific antidote (if available): Reset counter by 5
- Cleanse curse ritual: Full removal of all effects

### 9.5 Equipment Corrosion System

**Corrosion Mechanics (Helheim-specific):**
- Base corrosion rate: 0.8 (extreme)
- Equipment in toxic zone requires DC 13 save per round
- Failed save: -1 durability penalty
- Critical failure: -2 durability + item must make DC 15 save or break completely

**Corrosion Progression:**

| Durability | Condition | Effects |
|-----------|-----------|---------|
| 100% | Perfect | No effects |
| 75% | Worn | -1 to attack rolls (if weapon) |
| 50% | Corroded | -2 to attack rolls, 50% chance to fail |
| 25% | Heavily Corroded | -3 to attack rolls, function unreliable |
| 0% | Broken | Non-functional, requires repair |

**Repair Mechanics:**
- Requires blacksmith or crafting skills (minimum DC 15)
- Time required: 1 hour per 25% durability
- Cost: Iron and materials equal to item cost / 10
- Temporary repair (field): DC 12, lasts 1 hour only

---

## 10. Garm's Watch Shared Zone Mechanics

### 10.1 Shared Zone Definition

**Official Classification:** Transition Zone / Neutral Ground
**Administrative Assignment:** Helheim (for database/lookup purposes)
**Functional Assignment:** Shared access to both Svartalfheim and Helheim

### 10.2 Zone Properties

```
Garm's Watch (Shared)
├── Realm Access: Svartalfheim ↔ Helheim (bidirectional)
├── Primary Environment:
│   ├── Temperature: 26°C (compromise between 25°C and 28°C)
│   ├── Humidity: 60% (controlled ventilation)
│   ├── Light Level: 0.5 (maintained by wards)
│   ├── Aetheric: 0.3 (neutralized field)
│   └── Scale: 0.95 (neutral scale)
├── Hazard Zones: None active
├── Condition Suppression:
│   ├── TotalDarkness: NEGATED
│   ├── ToxicAtmosphere: NEGATED
│   └── IntenseHeat: REDUCED (environmental, not hazard)
└── Special Properties:
    ├── Guardian statue (Garm) - protective aura
    ├── Warded against realm-specific toxins
    └── Neutral diplomatic ground
```

### 10.3 Access Control and Verification

**Entry Requirements:**
- No special permissions required (open transit zone)
- Characters from either realm may pass freely
- No hazard exposure before/after entry

**Transition Mechanics:**
1. Character initiates movement toward adjacent zone exit
2. System checks character's current zone (Forge Core vs Upper Bile)
3. Garm's Watch is entered (intermediate zone)
4. Environmental conditions are cleared (TotalDarkness/ToxicAtmosphere negated)
5. Character moves to destination zone (Upper Bile/Forge Core)
6. New zone conditions apply upon entry

**Movement Cost:**
- Entering Garm's Watch: 5 feet of movement
- Traversing Garm's Watch: 10 feet of movement
- Exiting Garm's Watch: 5 feet of movement
- Total transit: 20 feet of movement (negotiable terrain allows shortcuts)

### 10.4 Condition Status Preservation

**What TRANSFERS During Transition:**
- Health/Hit Points (full transfer)
- Spell slots and resources (full transfer)
- Equipment and inventory (full transfer)
- Active buffs and enhancements (full transfer)
- Temporary ability modifiers (full transfer)

**What DOES NOT Transfer:**
- TotalDarkness vision penalties (negated in Garm's Watch)
- ToxicAtmosphere poison damage (negated in Garm's Watch)
- Hallucination effects (can persist but reduced)
- Environmental condition stacking counters (reset upon entry to Garm's Watch)

**Hallucination Handling:**
- Existing hallucinations persist through transition (character still hallucinating)
- Hallucination DC reduced by 2 in Garm's Watch (reality-anchoring effect)
- Hallucinations end 1 round after exiting Garm's Watch (if character is in safe zone)

### 10.5 Shared Zone Mechanics

**Configuration Entry:**
```json
{
  "zone_id": "helheim.garms_watch",
  "administrative_realm": "helheim",
  "shared_with": ["svartalfheim"],
  "name": "Garm's Watch",
  "description": "Fortified checkpoint between realms",
  "vertical_zone": "transition",
  "environment": {
    "temperature_celsius": 26,
    "humidity_percent": 60,
    "light_level": 0.5,
    "aetheric_saturation": 0.3,
    "scale_multiplier": 0.95,
    "corrosion_rate": 0.0
  },
  "hazards": [],
  "primary_condition": "none",
  "adjacent_zones": {
    "entrance": "svartalfheim.forge_core",
    "exit": "helheim.upper_bile"
  },
  "special_properties": {
    "is_transition_zone": true,
    "blocks_realm_conditions": ["TotalDarkness", "ToxicAtmosphere"],
    "condition_reset": true,
    "neutral_ground": true
  }
}
```

### 10.6 NPC and Encounter Behavior

**Guardian Presence:**
- Garm statue animates if violence occurs in zone
- Automatically separates combatants (magical barrier)
- Enforces peace for 1 minute (combat cooldown)
- Does not attack; purely defensive

**Merchant/Diplomat Activity:**
- NPCs from both realms may congregate here
- Safe trading ground
- No environmental hazards threaten transactions
- Standard encounter rules apply (social, no combat)

**Respawn Point:**
- If character dies in either realm, resurrection magic can restore them in Garm's Watch
- Garm's statue acts as focal point for resurrection rituals
- Requires willing participant and spell slot from ally

---

## 11. Environmental Property Systems

### 11.1 Base Environmental Properties Model

**Core Properties (Applied to all zones):**

```
Environmental Properties {
  // Temperature System
  temperature_celsius: float [0-100]
  temperature_effects: [cold_damage | heat_damage | comfort | none]

  // Atmospheric Composition
  humidity_percent: float [0-100]
  aetheric_saturation: float [0.0-1.0]
  oxygen_levels: float [0.0-1.0]

  // Light and Visibility
  light_level: float [0.0-1.0]
  bioluminescence: boolean

  // Physical Characteristics
  scale_multiplier: float [0.1-10.0]
  gravity_modifier: float [0.1-2.0]

  // Environmental Degradation
  corrosion_rate: float [0.0-1.0]
  rust_generation: float [0.0-1.0]
  decay_acceleration: float [0.0-1.0]
}
```

### 11.2 Property Modifiers by Zone

**Svartalfheim Baseline:**
```
Temperature: 25°C (cool, stable)
Humidity: 30% (dry, well-ventilated)
Aetheric: 0.4 (neutral field)
Light: 0.3 (dark baseline)
Scale: 0.9 (dwergr compression)
Corrosion: 0.1 (minimal degradation)
```

**Helheim Baseline:**
```
Temperature: 28°C (warm from decomposition)
Humidity: 90% (extreme, saturated)
Aetheric: 0.2 (disrupted by toxins)
Light: 0.4 (bioluminescent)
Scale: 1.0 (humanoid scale)
Corrosion: 0.8 (extreme degradation)
```

### 11.3 Zone-Specific Property Overrides

**Svartalfheim Properties Override Table:**

| Zone | Temp | Humidity | Light | Hazard DC |
|------|------|----------|-------|-----------|
| Bright Halls | 25 | 25 | 0.6 | None |
| Black Veins | 25 | 28 | 0.0 | DC 16 |
| Forge Core | 45 | 20 | 0.3 | DC 12 |

**Helheim Properties Override Table:**

| Zone | Temp | Humidity | Light | Hazard DC |
|------|------|----------|-------|-----------|
| Upper Bile | 28 | 90 | 0.4 | DC 12 |
| Dissolution Pits | 28 | 95 | 0.2 | DC 20 |
| Garm's Watch | 26 | 60 | 0.5 | None |

---

## 12. Decision Trees and Flow Diagrams

### 12.1 Zone Entry Decision Tree

```
Character Moves to New Zone
    │
    ├─→ Is destination zone in Svartalfheim?
    │   ├─→ YES
    │   │   ├─→ Is destination "The Black Veins"?
    │   │   │   ├─→ YES: Apply TotalDarkness (DC 16)
    │   │   │   │   └─→ Check for light sources
    │   │   │   │       ├─→ Has light: Vision 30+ ft
    │   │   │   │       └─→ No light: Vision blocked
    │   │   │   │
    │   │   │   └─→ NO: Check other zones
    │   │   │       ├─→ "Forge Core": Apply IntenseHeat (DC 12)
    │   │   │       └─→ "Bright Halls": No hazard
    │   │   │
    │   └─→ NO
    │       ├─→ Is destination zone in Helheim?
    │       │   ├─→ YES
    │       │   │   ├─→ Is destination "Dissolution Pits"?
    │       │   │   │   ├─→ YES: Apply ToxicAtmosphere (DC 20)
    │       │   │   │   │   └─→ Constitution save required
    │       │   │   │   │       ├─→ Success: Half damage (1d8+1d4)
    │       │   │   │   │       └─→ Failure: Full damage (3d8)
    │       │   │   │   │
    │       │   │   │   └─→ NO: Check other zones
    │       │   │   │       ├─→ "Upper Bile": Apply ToxicAtmosphere (DC 12)
    │       │   │   │       │   └─→ Constitution save required
    │       │   │   │       │       ├─→ Success: No damage
    │       │   │   │       │       └─→ Failure: 1d6 poison
    │       │   │   │       │
    │       │   │   │       └─→ "Garm's Watch": Negate all conditions
    │       │   │   │           └─→ Transition zone - safe passage
    │       │   │   │
    │       │   └─→ NO: Unknown zone, error state
    │       │
    │       └─→ End zone entry processing
    │
    └─→ Apply environmental effects and begin round
```

### 12.2 TotalDarkness Resolution Flow

```
Character in The Black Veins (TotalDarkness Active)
    │
    ├─→ Character takes action requiring vision?
    │   ├─→ YES
    │   │   ├─→ Check for active light sources
    │   │   │   ├─→ Has functional light source(s)?
    │   │   │   │   ├─→ YES
    │   │   │   │   │   ├─→ Calculate vision radius
    │   │   │   │   │   │   ├─→ Single source: 30 feet
    │   │   │   │   │   │   ├─→ Multiple sources: +20 feet each
    │   │   │   │   │   │   └─→ Magical source: 40-60 feet
    │   │   │   │   │   │
    │   │   │   │   │   └─→ Action proceeds with vision
    │   │   │   │   │
    │   │   │   │   └─→ NO: Vision completely blocked
    │   │   │   │       ├─→ Can use alternative sense?
    │   │   │   │       │   ├─→ Darkvision: Use darkvision range
    │   │   │   │       │   ├─→ Tremorsense: Use tremorsense range
    │   │   │   │       │   └─→ Blindsight: Use blindsight range
    │   │   │   │       │
    │   │   │   │       └─→ Roll Perception check (DC 16)
    │   │   │   │           ├─→ Success: Proceed with reduced effectiveness (-2)
    │   │   │   │           └─→ Failure: Action fumbles (50% failure)
    │   │   │   │
    │   │   │   └─→ Light source extinguished?
    │   │   │       ├─→ YES: Relight check
    │   │   │       │   ├─→ Torch: 40% to re-light
    │   │   │       │   └─→ Lamp: 60% to re-light
    │   │   │       │
    │   │   │       └─→ NO: Light continues active
    │   │   │
    │   │   └─→ Action completes with vision modifier applied
    │   │
    │   └─→ NO: Non-vision action, proceed normally
    │
    └─→ Round ends, ready for next action
```

### 12.3 ToxicAtmosphere Resolution Flow

```
Character enters Toxic Zone (ToxicAtmosphere Active)
    │
    ├─→ Determine zone difficulty
    │   ├─→ Upper Bile: DC 12
    │   └─→ Dissolution Pits: DC 20
    │
    ├─→ Check for protective equipment
    │   ├─→ Has chemical suit: +2 to save
    │   ├─→ Has antitoxin: +4 to save
    │   ├─→ Has poison immunity: Auto-success
    │   └─→ Has poison resistance: 50% damage reduction
    │
    ├─→ Calculate effective DC
    │   ├─→ Base DC - equipment bonuses = effective DC
    │   ├─→ Add stacking DC from previous failures
    │   └─→ Cap effective DC at 25
    │
    ├─→ Roll Constitution save vs effective DC
    │   ├─→ Critical success (≥DC+5): No damage + 1 resistance
    │   ├─→ Success (≥DC): No damage (Upper) or half damage (Dissolution)
    │   ├─→ Failure (<DC): Apply full damage
    │   └─→ Critical failure (natural 1): Damage + hallucination roll
    │
    ├─→ Track exposure counter
    │   ├─→ Increment on damage taken
    │   ├─→ At 3+ consecutive failures: Trigger major hallucination
    │   └─→ Reset on long rest or zone exit + 1 hour
    │
    └─→ Apply hallucination effects if triggered
        ├─→ Minor hallucination: DC 16 Wisdom save to resist
        └─→ Major hallucination: 2d6 rounds, persistent effects
```

### 12.4 Garm's Watch Transition Flow

```
Character moves between Svartalfheim and Helheim
    │
    ├─→ Character initiates transition from Forge Core
    │   ├─→ Movement cost: 5 feet
    │   └─→ Enter Garm's Watch zone
    │
    ├─→ Apply zone entry effects for Garm's Watch
    │   ├─→ Clear TotalDarkness condition (negated)
    │   ├─→ Clear ToxicAtmosphere condition (negated)
    │   ├─→ Set light level to 0.5 (sufficient visibility)
    │   └─→ Reset hallucination DC by -2 (if applicable)
    │
    ├─→ Character in Garm's Watch (safe zone)
    │   ├─→ Can interact with NPCs
    │   ├─→ Can conduct trade
    │   ├─→ Cannot rest (too short duration)
    │   └─→ Combat possible but Garm may intervene
    │
    ├─→ Character exits Garm's Watch toward Upper Bile
    │   ├─→ Movement cost: 5 feet
    │   └─→ Leave Garm's Watch zone
    │
    ├─→ Apply zone entry effects for Upper Bile
    │   ├─→ Apply ToxicAtmosphere (DC 12)
    │   ├─→ Require Constitution save
    │   └─→ Apply poison damage if failed
    │
    └─→ Character in Upper Bile, continue normally
```

---

## 13. Configuration Files

### 13.1 svartalfheim.json

```json
{
  "realm_id": "svartalfheim",
  "deck_number": 6,
  "name": "Svartalfheim - The Dvergr Forges",
  "theme": "Underground dwarven manufacturing complex",
  "base_properties": {
    "temperature_celsius": 25,
    "aetheric_saturation": 0.4,
    "humidity_percent": 30,
    "light_level": 0.3,
    "scale_multiplier": 0.9,
    "corrosion_rate": 0.1,
    "oxygen_level": 1.0
  },
  "primary_condition": "TotalDarkness",
  "vertical_range": {
    "min_z": -2,
    "max_z": 0
  },
  "zones": [
    {
      "zone_id": "svartalfheim.bright_halls",
      "name": "The Bright Halls",
      "description": "Upper trading halls with merchant stalls and administrative chambers",
      "vertical_range": {
        "min_z": 0,
        "max_z": 0
      },
      "environment": {
        "temperature_celsius": 25,
        "humidity_percent": 25,
        "light_level": 0.6,
        "aetheric_saturation": 0.4
      },
      "hazards": [],
      "primary_condition": null,
      "difficulty_dc": null,
      "difficulty_type": "social"
    },
    {
      "zone_id": "svartalfheim.black_veins",
      "name": "The Black Veins",
      "description": "Ancient mining tunnels with absolute darkness and obsidian veins",
      "vertical_range": {
        "min_z": -2,
        "max_z": -1
      },
      "environment": {
        "temperature_celsius": 25,
        "humidity_percent": 28,
        "light_level": 0.0,
        "aetheric_saturation": 0.4
      },
      "hazards": ["TotalDarkness"],
      "primary_condition": "TotalDarkness",
      "difficulty_dc": 16,
      "difficulty_type": "perception",
      "condition_details": {
        "vision_blocked": true,
        "light_source_required": true,
        "vision_range_with_light": 30,
        "additional_light_bonus": 20
      }
    },
    {
      "zone_id": "svartalfheim.forge_core",
      "name": "Forge Core",
      "description": "Sacred forges and crafting areas with intense magical flames",
      "vertical_range": {
        "min_z": -1,
        "max_z": 0
      },
      "environment": {
        "temperature_celsius": 45,
        "humidity_percent": 20,
        "light_level": 0.3,
        "aetheric_saturation": 0.5
      },
      "hazards": ["IntenseHeat", "TotalDarkness"],
      "primary_condition": "IntenseHeat",
      "difficulty_dc": 12,
      "difficulty_type": "endurance",
      "condition_details": {
        "damage_dice": "1d6",
        "damage_type": "heat",
        "exhaustion_counter_increment": 1
      }
    }
  ],
  "adjacency_rules": [
    {
      "from": "svartalfheim.bright_halls",
      "to": "svartalfheim.forge_core",
      "direction": "down",
      "transition_difficulty": "normal"
    },
    {
      "from": "svartalfheim.forge_core",
      "to": "svartalfheim.black_veins",
      "direction": "down",
      "transition_difficulty": "normal"
    },
    {
      "from": "svartalfheim.forge_core",
      "to": "helheim.garms_watch",
      "direction": "cross_realm",
      "transition_difficulty": "normal",
      "requires_shared_zone": true
    }
  ]
}
```

### 13.2 helheim.json

```json
{
  "realm_id": "helheim",
  "deck_number": 9,
  "name": "Helheim - The Gangrenous Gut",
  "theme": "Organic waste reclamation facility with biological corruption",
  "base_properties": {
    "temperature_celsius": 28,
    "aetheric_saturation": 0.2,
    "humidity_percent": 90,
    "light_level": 0.4,
    "scale_multiplier": 1.0,
    "corrosion_rate": 0.8,
    "oxygen_level": 0.6
  },
  "primary_condition": "ToxicAtmosphere",
  "vertical_range": {
    "min_z": -3,
    "max_z": -1
  },
  "zones": [
    {
      "zone_id": "helheim.upper_bile",
      "name": "Upper Bile",
      "description": "Surface processing chambers with bioluminescent molds and waste collection",
      "vertical_range": {
        "min_z": -1,
        "max_z": -1
      },
      "environment": {
        "temperature_celsius": 28,
        "humidity_percent": 90,
        "light_level": 0.4,
        "aetheric_saturation": 0.2,
        "corrosion_rate": 0.7
      },
      "hazards": ["ToxicAtmosphere"],
      "primary_condition": "ToxicAtmosphere",
      "difficulty_dc": 12,
      "difficulty_type": "constitution",
      "condition_details": {
        "damage_dice": "1d6",
        "damage_type": "poison",
        "hallucination_trigger": "critical_failure",
        "equipment_corrosion_dc": 13
      }
    },
    {
      "zone_id": "helheim.dissolution_pits",
      "name": "The Dissolution Pits",
      "description": "Deep recycling vats with caustic chemical solutions and toxic mist",
      "vertical_range": {
        "min_z": -3,
        "max_z": -2
      },
      "environment": {
        "temperature_celsius": 28,
        "humidity_percent": 95,
        "light_level": 0.2,
        "aetheric_saturation": 0.1,
        "corrosion_rate": 0.9
      },
      "hazards": ["ToxicAtmosphere"],
      "primary_condition": "ToxicAtmosphere",
      "difficulty_dc": 20,
      "difficulty_type": "constitution",
      "condition_details": {
        "damage_dice_success": "1d8+1d4",
        "damage_dice_failure": "3d8",
        "hallucination_trigger": "critical_failure_or_multiple_failures",
        "equipment_corrosion_dc": 11,
        "stacking_dc_increment": 1,
        "max_stacking_dc": 25
      }
    },
    {
      "zone_id": "helheim.garms_watch",
      "name": "Garm's Watch",
      "description": "Fortified checkpoint and neutral transition zone between realms",
      "vertical_range": {
        "min_z": -1,
        "max_z": -1
      },
      "administrative_realm": "helheim",
      "shared_with": ["svartalfheim"],
      "environment": {
        "temperature_celsius": 26,
        "humidity_percent": 60,
        "light_level": 0.5,
        "aetheric_saturation": 0.3,
        "corrosion_rate": 0.0
      },
      "hazards": [],
      "primary_condition": null,
      "difficulty_dc": null,
      "condition_override": {
        "blocks_conditions": ["TotalDarkness", "ToxicAtmosphere"],
        "resets_exposure_counter": true,
        "is_safe_zone": true
      },
      "special_properties": {
        "guardian_npc": "Garm Statue",
        "diplomatic_ground": true,
        "transition_zone": true
      }
    }
  ],
  "adjacency_rules": [
    {
      "from": "helheim.upper_bile",
      "to": "helheim.dissolution_pits",
      "direction": "down",
      "transition_difficulty": "normal"
    },
    {
      "from": "helheim.upper_bile",
      "to": "helheim.garms_watch",
      "direction": "cross_realm",
      "transition_difficulty": "normal",
      "requires_shared_zone": true
    },
    {
      "from": "helheim.garms_watch",
      "to": "svartalfheim.forge_core",
      "direction": "cross_realm",
      "transition_difficulty": "normal",
      "requires_shared_zone": true
    }
  ]
}
```

---

## 14. Code Examples

### 14.1 C# Entity: TotalDarkness Condition

```csharp
/// <summary>
/// Represents the TotalDarkness environmental condition found in Svartalfheim's
/// mining tunnels. This condition completely blocks vision without external light
/// sources and requires specialized navigation techniques.
/// </summary>
public class TotalDarknessCondition : EnvironmentalCondition
{
    /// <summary>
    /// Gets the base Difficulty Class for perception checks in total darkness.
    /// Default is 12 for general darkness, 16 for extreme darkness zones.
    /// </summary>
    public int BaseDifficultyClass { get; set; } = 12;

    /// <summary>
    /// Gets or sets the threshold light level below which total darkness applies.
    /// Values below this (e.g., 0.1) trigger full vision blocking.
    /// </summary>
    public float LightThreshold { get; set; } = 0.1f;

    /// <summary>
    /// Gets the collection of light sources currently active for the character.
    /// Used to calculate effective vision range and bypass darkness penalties.
    /// </summary>
    public List<LightSource> ActiveLightSources { get; set; } = new();

    /// <summary>
    /// Calculates the effective vision range based on active light sources.
    /// Returns 0 if no light sources are active, representing total vision blockage.
    /// </summary>
    /// <returns>Vision range in feet, or 0 if completely blocked.</returns>
    public int CalculateVisionRange()
    {
        if (ActiveLightSources.Count == 0)
            return 0; // Vision completely blocked

        int baseRange = ActiveLightSources[0].BrightRadius;
        for (int i = 1; i < ActiveLightSources.Count; i++)
        {
            baseRange += 20; // Additional light sources provide +20 feet
        }

        return Math.Min(baseRange, 120); // Cap at 120 feet maximum
    }

    /// <summary>
    /// Attempts to resolve vision-based actions in total darkness.
    /// Applies appropriate penalties or vision blockage based on light sources.
    /// </summary>
    /// <param name="character">Character attempting the action.</param>
    /// <param name="actionType">Type of action being attempted.</param>
    /// <returns>Result with penalties or vision status.</returns>
    public EnvironmentalResolutionResult ResolveVisionAction(Character character, ActionType actionType)
    {
        var visionRange = CalculateVisionRange();

        if (visionRange == 0)
        {
            // No light source - attempt alternative senses
            if (character.HasDarkvision || character.HasTremorsense || character.HasBlind sight)
            {
                return new EnvironmentalResolutionResult
                {
                    VisionBlocked = false,
                    VisionRange = character.AlternativeSenseRange,
                    PenaltyApplied = -2,
                    Message = "Using alternative sensory abilities in total darkness"
                };
            }

            // No alternative senses - roll perception check
            int perceptionCheck = character.RollPerceptionCheck();
            if (perceptionCheck >= BaseDifficultyClass + 4) // DC 16 for Black Veins
            {
                return new EnvironmentalResolutionResult
                {
                    VisionBlocked = true,
                    VisionRange = 0,
                    PenaltyApplied = -2,
                    Message = "Successfully navigating by touch and careful movement",
                    SuccessfulNavigationWithoutLight = true
                };
            }

            // Failed check - fumble
            return new EnvironmentalResolutionResult
            {
                VisionBlocked = true,
                VisionRange = 0,
                PenaltyApplied = -4,
                FumbleOccurred = true,
                Message = "Complete vision blockage - character fumbles in darkness"
            };
        }

        // Light source present - normal vision with range
        return new EnvironmentalResolutionResult
        {
            VisionBlocked = false,
            VisionRange = visionRange,
            PenaltyApplied = 0,
            Message = $"Vision available: {visionRange} feet radius"
        };
    }

    /// <summary>
    /// Manages light source depletion and re-lighting mechanics.
    /// </summary>
    /// <param name="lightSource">The light source to evaluate.</param>
    /// <returns>True if light source remains functional, false if extinguished.</returns>
    public bool EvaluateLightSourceDuration(LightSource lightSource)
    {
        if (lightSource.IsExtinguished)
            return false;

        lightSource.DecrementDuration();

        if (lightSource.RemainingDuration <= 0)
        {
            lightSource.IsExtinguished = true;
            return false;
        }

        return true;
    }
}

/// <summary>
/// Represents a light source (torch, lamp, magical orb, etc.) used to mitigate darkness.
/// </summary>
public class LightSource
{
    /// <summary>
    /// Gets the radius (in feet) where light is bright and visibility is clear.
    /// </summary>
    public int BrightRadius { get; set; }

    /// <summary>
    /// Gets the radius (in feet) where light is dim and visibility is reduced by 50%.
    /// </summary>
    public int DimRadius { get; set; }

    /// <summary>
    /// Gets or sets whether this light source is currently active/functional.
    /// </summary>
    public bool IsExtinguished { get; set; }

    /// <summary>
    /// Gets the remaining duration in hours (for consumable light sources like torches).
    /// -1 indicates permanent light (magical sources).
    /// </summary>
    public float RemainingDuration { get; set; }

    /// <summary>
    /// Attempts to re-light an extinguished torch or lamp.
    /// Magical light sources cannot be re-lit; they must be recharged.
    /// </summary>
    /// <returns>Probability (0.0-1.0) of successful re-lighting.</returns>
    public float AttemptReLighting()
    {
        if (RemainingDuration < 0) // Magical light
            return 0.0f; // Cannot re-light; must recharge

        // Torch: 40% success, Lamp: 60% success
        return BrightRadius switch
        {
            20 => 0.4f,  // Torch
            30 => 0.6f,  // Lamp
            _ => 0.5f    // Default
        };
    }

    /// <summary>
    /// Decrements the duration of this light source by one time unit.
    /// Used each round or hour depending on game time scale.
    /// </summary>
    public void DecrementDuration()
    {
        if (RemainingDuration > 0) // Only consumable sources
            RemainingDuration -= 1.0f / 60f; // Decrement in 1-minute increments
    }
}

/// <summary>
/// Result of resolving a vision-dependent action in total darkness.
/// </summary>
public class EnvironmentalResolutionResult
{
    public bool VisionBlocked { get; set; }
    public int VisionRange { get; set; }
    public int PenaltyApplied { get; set; }
    public bool FumbleOccurred { get; set; }
    public bool SuccessfulNavigationWithoutLight { get; set; }
    public string Message { get; set; }
}
```

### 14.2 C# Service: ToxicAtmosphere Resolution

```csharp
/// <summary>
/// Service responsible for resolving ToxicAtmosphere environmental condition effects,
/// including poison damage, hallucination triggers, and equipment corrosion.
/// Implements DC stacking for sustained exposure in zones like The Dissolution Pits.
/// </summary>
public class ToxicAtmosphereService : IEnvironmentalConditionService
{
    private readonly IDiceRoller _diceRoller;
    private readonly IHallucinationManager _hallucinationManager;

    public ToxicAtmosphereService(IDiceRoller diceRoller, IHallucinationManager hallucinationManager)
    {
        _diceRoller = diceRoller;
        _hallucinationManager = hallucinationManager;
    }

    /// <summary>
    /// Resolves initial exposure to toxic atmosphere upon entering a zone.
    /// Triggers Constitution save and applies damage/effects accordingly.
    /// </summary>
    /// <param name="character">Character entering toxic zone.</param>
    /// <param name="zoneDifficulty">Base DC for the zone (12 for Upper Bile, 20 for Dissolution Pits).</param>
    /// <returns>Damage result with effects applied.</returns>
    public ToxicityResolutionResult ResolveInitialExposure(Character character, int zoneDifficulty)
    {
        var savingThrow = character.RollConstitutionSave();
        var effectivedc = CalculateEffectivedc(zoneDifficulty, character);

        var result = new ToxicityResolutionResult
        {
            InitialExposure = true,
            SaveRoll = savingThrow,
            DifficultyClass = effectivedc,
            ZoneName = GetZoneName(zoneDifficulty)
        };

        if (savingThrow >= effectivedc)
        {
            // Success
            result.Success = true;
            result.DamageDealt = 0;
            result.HalfDamage = false;
            result.Message = "Constitution save successful - resisted toxic exposure";

            if (savingThrow >= effectivedc + 5)
            {
                // Critical success
                result.CriticalSuccess = true;
                character.ApplyTemporaryBonus(new TemporaryBonus("ToxinResistance", +1, TimeSpan.FromMinutes(10)));
                result.Message += " (Critical success - poison resistance temporarily increased)";
            }

            return result;
        }

        // Failure - apply damage
        result.Success = false;
        var damageDice = zoneDifficulty == 20 ? "3d8" : "1d6";
        result.DamageDealt = _diceRoller.Roll(damageDice);
        result.PoisonDamageDealt = result.DamageDealt;

        // Detect critical failure
        if (savingThrow == 1)
        {
            result.CriticalFailure = true;
            result.HallucinationTriggered = true;
            result.HallucinationSeverity = "minor";
            result.Message = $"CRITICAL FAILURE - {result.DamageDealt} poison damage + hallucination triggered";
        }
        else
        {
            result.Message = $"Failed save - {result.DamageDealt} poison damage dealt";
        }

        character.ApplyPoisonDamage(result.DamageDealt);
        character.IncrementToxicExposureCounter();

        return result;
    }

    /// <summary>
    /// Resolves sustained exposure to toxic atmosphere over multiple rounds.
    /// Handles DC stacking, cumulative damage, and hallucination progression.
    /// </summary>
    /// <param name="character">Character in toxic zone.</param>
    /// <param name="zoneDifficulty">Base DC for the zone.</param>
    /// <param name="roundsExposed">Number of rounds character has been in zone.</param>
    /// <returns>Cumulative damage result with stacking DC applied.</returns>
    public ToxicityResolutionResult ResolveSustainedExposure(Character character, int zoneDifficulty, int roundsExposed)
    {
        var failureCount = character.GetToxicAtmosphereFailureCount();
        var stackingDc = CalculateStackingdc(zoneDifficulty, failureCount);
        var effectivedc = CalculateEffectivedc(stackingDc, character);

        var savingThrow = character.RollConstitutionSave();

        var result = new ToxicityResolutionResult
        {
            SustainedExposure = true,
            RoundsExposed = roundsExposed,
            FailureCount = failureCount,
            StackingDC = stackingDc,
            Effectivedc = effectivedc,
            SaveRoll = savingThrow
        };

        if (savingThrow >= effectivedc)
        {
            result.Success = true;
            result.DamageDealt = 0;
            character.ApplyTemporaryBonus(new TemporaryBonus("ToxinResistance", +1, TimeSpan.FromMinutes(10)));
            result.Message = "Sustained exposure save successful - gained temporary poison resistance";
            return result;
        }

        // Failure - apply damage with stacking effect
        result.Success = false;
        var damageDice = zoneDifficulty == 20 ? "3d8" : "1d6";
        result.DamageDealt = _diceRoller.Roll(damageDice);
        result.PoisonDamageDealt = result.DamageDealt;

        character.ApplyPoisonDamage(result.DamageDealt);
        character.IncrementToxicAtmosphereFailureCount();

        // Check for hallucination triggers
        var newFailureCount = failureCount + 1;
        if (savingThrow == 1 || newFailureCount >= 3)
        {
            result.HallucinationTriggered = true;
            result.HallucinationSeverity = newFailureCount >= 3 ? "major" : "minor";

            var hallucinationResult = _hallucinationManager.TriggerHallucination(
                character,
                result.HallucinationSeverity);

            result.Message = $"Failed save - {result.DamageDealt} damage + {result.HallucinationSeverity} hallucination";
        }
        else
        {
            result.Message = $"Failed save (Failure #{newFailureCount}) - {result.DamageDealt} damage";
        }

        return result;
    }

    /// <summary>
    /// Calculates effective DC after applying character bonuses/equipment modifiers.
    /// </summary>
    private int CalculateEffectivedc(int basedc, Character character)
    {
        int modifier = 0;

        // Equipment bonuses
        if (character.HasEquipment("ChemicalSuit"))
            modifier += 2;
        if (character.HasEquipment("Antitoxin"))
            modifier += 4;
        if (character.HasEquipment("BreathableFilter"))
            modifier -= 2; // DC reduction

        // Class/racial features
        modifier += character.GetPoisonResistanceModifier();

        // Apply capped effective DC (minimum 4, maximum 25)
        int effectivedc = Math.Max(4, basedc - modifier);
        return Math.Min(effectivedc, 25);
    }

    /// <summary>
    /// Calculates stacking DC based on number of consecutive failures.
    /// Each failure increases DC by 1, capped at 25 maximum.
    /// </summary>
    private int CalculateStackingdc(int basedc, int failureCount)
    {
        return Math.Min(basedc + failureCount, 25);
    }

    private string GetZoneName(int zoneDifficulty) =>
        zoneDifficulty == 20 ? "The Dissolution Pits" : "Upper Bile";
}

/// <summary>
/// Encapsulates the result of a toxicity resolution check.
/// </summary>
public class ToxicityResolutionResult
{
    public bool InitialExposure { get; set; }
    public bool SustainedExposure { get; set; }
    public bool Success { get; set; }
    public bool CriticalSuccess { get; set; }
    public bool CriticalFailure { get; set; }
    public int SaveRoll { get; set; }
    public int DifficultyClass { get; set; }
    public int Effectivedc { get; set; }
    public int StackingDC { get; set; }
    public int FailureCount { get; set; }
    public int RoundsExposed { get; set; }
    public int DamageDealt { get; set; }
    public int PoisonDamageDealt { get; set; }
    public bool HalfDamage { get; set; }
    public bool HallucinationTriggered { get; set; }
    public string HallucinationSeverity { get; set; }
    public string ZoneName { get; set; }
    public string Message { get; set; }
}
```

### 14.3 C# Entity: Shared Zone Handler

```csharp
/// <summary>
/// Manages shared zone mechanics for Garm's Watch, allowing safe transition
/// between Svartalfheim and Helheim while negating realm-specific hazards.
/// </summary>
public class SharedZoneHandler
{
    private readonly IZoneRepository _zoneRepository;
    private readonly IEnvironmentalConditionService _conditionService;

    public SharedZoneHandler(IZoneRepository zoneRepository, IEnvironmentalConditionService conditionService)
    {
        _zoneRepository = zoneRepository;
        _conditionService = conditionService;
    }

    /// <summary>
    /// Verifies that a character can access Garm's Watch as a transition zone.
    /// </summary>
    /// <param name="character">Character attempting transition.</param>
    /// <param name="sourceZone">Zone character is leaving.</param>
    /// <param name="destinationRealm">Realm character is entering.</param>
    /// <returns>Access verification result.</returns>
    public SharedZoneAccessResult VerifyAccess(Character character, BiomeZone sourceZone, string destinationRealm)
    {
        var result = new SharedZoneAccessResult { Allowed = true };

        // Verify source zone is adjacent to Garm's Watch
        if (!IsAdjacentToSharedZone(sourceZone))
        {
            result.Allowed = false;
            result.Reason = "Source zone is not adjacent to Garm's Watch";
            return result;
        }

        // Verify destination realm is valid
        var validDestinations = sourceZone.ZoneId.Contains("svartalfheim") ?
            new[] { "helheim" } : new[] { "svartalfheim" };

        if (!validDestinations.Contains(destinationRealm))
        {
            result.Allowed = false;
            result.Reason = $"Invalid transition from {sourceZone.BiomeId} to {destinationRealm}";
            return result;
        }

        return result;
    }

    /// <summary>
    /// Processes character entry into Garm's Watch, negating realm-specific conditions.
    /// </summary>
    /// <param name="character">Character entering shared zone.</param>
    /// <param name="sourceRealm">Realm character is leaving.</param>
    /// <returns>Zone entry result with conditions applied.</returns>
    public SharedZoneEntryResult ProcessEntry(Character character, string sourceRealm)
    {
        var result = new SharedZoneEntryResult
        {
            SourceRealm = sourceRealm,
            ZoneName = "Garm's Watch",
            ConditionsNegated = new List<string>()
        };

        // Negate TotalDarkness if coming from Svartalfheim
        if (sourceRealm == "svartalfheim")
        {
            character.RemoveCondition("TotalDarkness");
            result.ConditionsNegated.Add("TotalDarkness");
            result.Message += "Vision fully restored in neutral ground.\n";
        }

        // Negate ToxicAtmosphere if coming from Helheim
        if (sourceRealm == "helheim")
        {
            character.RemoveCondition("ToxicAtmosphere");
            result.ConditionsNegated.Add("ToxicAtmosphere");
            result.Message += "Toxic atmosphere negated by protective wards.\n";
        }

        // Set light level to sufficient level
        character.CurrentZone.SetLightLevel(0.5f);
        result.LightLevelSet = 0.5f;

        // Reduce hallucination effects
        if (character.IsHallucinating())
        {
            character.ReduceHallucinationdc(-2);
            result.HallucinationReduced = true;
            result.Message += "Hallucinations partially reduced in reality-anchoring zone.\n";
        }

        return result;
    }

    /// <summary>
    /// Processes character exit from Garm's Watch, re-applying destination realm conditions.
    /// </summary>
    /// <param name="character">Character leaving shared zone.</param>
    /// <param name="destinationZone">Zone character is entering.</param>
    /// <returns>Zone exit result with new conditions applied.</returns>
    public SharedZoneExitResult ProcessExit(Character character, BiomeZone destinationZone)
    {
        var result = new SharedZoneExitResult
        {
            DestinationZone = destinationZone.Name,
            ConditionsApplied = new List<string>()
        };

        // Re-apply conditions based on destination zone
        if (destinationZone.BiomeId == "svartalfheim" && destinationZone.ZoneId == "svartalfheim.black_veins")
        {
            character.ApplyCondition(new TotalDarknessCondition { BaseDifficultyClass = 16 });
            result.ConditionsApplied.Add("TotalDarkness (DC 16)");
            result.Message += "Total darkness engulfs you as you leave the protective zone.\n";
        }
        else if (destinationZone.BiomeId == "helheim" &&
                 (destinationZone.ZoneId == "helheim.upper_bile" || destinationZone.ZoneId == "helheim.dissolution_pits"))
        {
            var dc = destinationZone.ZoneId == "helheim.dissolution_pits" ? 20 : 12;
            character.ApplyCondition(new ToxicAtmosphereCondition { BaseDifficultyClass = dc });
            result.ConditionsApplied.Add($"ToxicAtmosphere (DC {dc})");
            result.Message += "Toxic fumes assault your senses as you leave the neutral zone.\n";
        }

        return result;
    }

    /// <summary>
    /// Checks if a zone is adjacent to Garm's Watch for transition purposes.
    /// </summary>
    private bool IsAdjacentToSharedZone(BiomeZone zone)
    {
        return zone.ZoneId == "svartalfheim.forge_core" || zone.ZoneId == "helheim.upper_bile";
    }
}

/// <summary>
/// Result of verifying access to Garm's Watch.
/// </summary>
public class SharedZoneAccessResult
{
    public bool Allowed { get; set; }
    public string Reason { get; set; }
}

/// <summary>
/// Result of entering Garm's Watch shared zone.
/// </summary>
public class SharedZoneEntryResult
{
    public string SourceRealm { get; set; }
    public string ZoneName { get; set; }
    public List<string> ConditionsNegated { get; set; }
    public float LightLevelSet { get; set; }
    public bool HallucinationReduced { get; set; }
    public string Message { get; set; }
}

/// <summary>
/// Result of exiting Garm's Watch shared zone.
/// </summary>
public class SharedZoneExitResult
{
    public string DestinationZone { get; set; }
    public List<string> ConditionsApplied { get; set; }
    public string Message { get; set; }
}
```

---

## 15. Logging Specifications

### 15.1 Zone Entry Logging

```
[Zone Entry Event]
Timestamp: 2026-01-28T14:32:45.123Z
Character: Thorin Blackbeard (Fighter Level 5)
Source Zone: svartalfheim.bright_halls
Destination Zone: svartalfheim.black_veins
Movement Cost: Normal (30 feet movement available)

Environmental Conditions Applied:
- TotalDarkness [DC 16]
  - Vision completely blocked
  - Light sources checked: 1 torch detected (active, 45 minutes remaining)
  - Effective vision range: 20 feet (torch bright radius)

Skill Checks Required: None (entry automatic)
Character Status: Ready to act
```

### 15.2 Environmental Resolution Logging

```
[Environmental Resolution Event]
Timestamp: 2026-01-28T14:35:12.456Z
Character: Valdis Stonehelm (Paladin Level 6)
Zone: helheim.dissolution_pits
Condition: ToxicAtmosphere [DC 20]

Exposure Type: Sustained (Round 3 in zone)
Previous Failures: 2
Stacking DC Applied: 22 (base 20 + 2 failures)

Protective Equipment: Chemical Suit (+2 bonus)
Effective DC: 20 (22 - 2 equipment bonus)

Constitution Save Roll: 14
Result: FAILURE
Damage: 3d8 = [4, 5, 3] = 12 poison damage
Character HP: 31 → 19

Hallucination Trigger: YES
Failure Count: 3 (triggers MAJOR hallucination)
Hallucination Type: Entity Hallucination (phantom enemies)
Hallucination Duration: 2d6 = 5 rounds

Status: Critical condition, requires intervention
```

### 15.3 Light Source Management Logging

```
[Light Source Status Event]
Timestamp: 2026-01-28T14:28:33.789Z
Character: Astrid Firehand (Rogue Level 4)
Zone: svartalfheim.black_veins
Light Sources Status:

Active Light Sources:
1. Torch #1 (Bright: 20 ft, Dim: 40 ft)
   - Duration: 48 minutes remaining
   - Condition: Good
   - Usage Rate: 1 unit/hour

2. Enchanted Orb (Bright: 40 ft, Dim: 80 ft)
   - Charge: 92% full
   - Condition: Excellent
   - Recharge Rate: 1 hour per 10% charge via ritual

Calculated Vision Range: 60 feet (40 ft from orb + 20 ft bonus)

Environmental Modifier: None
Final Vision Range: 60 feet
Movement Penalty: None
Action Penalty: None
```

### 15.4 Hallucination Tracking Logging

```
[Hallucination Progression Event]
Timestamp: 2026-01-28T14:41:22.101Z
Character: Grimjack Emberclaw (Barbarian Level 5)
Zone: helheim.dissolution_pits

Hallucination Type: Major - Temporal Distortion
Duration: 2d6 = 4 rounds remaining

Effects Applied:
- Initiative penalty: -2
- Action time increase: +2 rounds to complete actions
- Perception penalty: -2 to perception checks
- Spatial awareness: Severely impaired

Current Round: Round 2 of 4
Behavior Log:
  Round 1: Character attempted to attack phantom (missed by 5)
  Round 2: Character moved erratically (50% fumble)

Resistance Attempts: 0 of 4 possible (DC 16 Wisdom saves available)
```

---

## 16. Unit Testing Requirements

### 16.1 Test Categories and Coverage

**Total Target Tests:** ~24 comprehensive tests

#### Category 1: TotalDarkness Condition (8 tests)

1. **Test_TotalDarkness_VisionBlockedWithoutLight**
   - Setup: Character in Black Veins without light source
   - Action: Attempt perception check
   - Expected: Vision range = 0, DC 16 modifier applied

2. **Test_TotalDarkness_VisionRestoredWithTorch**
   - Setup: Character in Black Veins with active torch
   - Action: Calculate vision range
   - Expected: Vision range = 20 feet (torch bright radius)

3. **Test_TotalDarkness_MultipleSourcesStackAdditive**
   - Setup: Character with torch + enchanted orb
   - Action: Calculate combined vision range
   - Expected: Vision range = 60 feet (40 from orb + 20 bonus)

4. **Test_TotalDarkness_DarkvisionBypassesDarkness**
   - Setup: Dwarf with natural darkvision in Black Veins
   - Action: Attempt navigation without light
   - Expected: Darkvision range applies, no penalty

5. **Test_TotalDarkness_TorchExtinguishmentChance**
   - Setup: Character moving violently with torch
   - Action: Simulate tumble action with torch
   - Expected: 20% chance torch extinguishes

6. **Test_TotalDarkness_FailedNavigationFumble**
   - Setup: Character in Black Veins, no light, failed DC 16 check
   - Action: Attempt normal-pace movement
   - Expected: 50% fumble chance applied to next action

7. **Test_TotalDarkness_BrightHallsNoHazard**
   - Setup: Character enters Bright Halls zone
   - Action: Check for darkness condition
   - Expected: No condition applied, light level 0.6

8. **Test_TotalDarkness_ForgeCoreLightPartialMitigation**
   - Setup: Character in Forge Core with firelight
   - Action: Calculate vision range with 0.3 light level
   - Expected: Vision range = 20 feet (partial visibility from forge fire)

#### Category 2: ToxicAtmosphere Condition (10 tests)

9. **Test_ToxicAtmosphere_InitialExposure_UpperBile_Success**
   - Setup: Character enters Upper Bile with good CON
   - Action: Roll DC 12 Constitution save, roll = 13
   - Expected: No damage, success message

10. **Test_ToxicAtmosphere_InitialExposure_DissolutionPits_Failure**
    - Setup: Character enters Dissolution Pits with poor CON
    - Action: Roll DC 20 Constitution save, roll = 12
    - Expected: 3d8 poison damage applied

11. **Test_ToxicAtmosphere_SustainedExposure_Stackingdc**
    - Setup: Character in Dissolution Pits, 2 previous failures
    - Action: Roll third exposure check
    - Expected: DC = 22 (base 20 + 2 failures), damage applied

12. **Test_ToxicAtmosphere_EquipmentBonus_ChemicalSuit**
    - Setup: Character with chemical suit in Dissolution Pits
    - Action: Apply equipment bonus to save
    - Expected: Effective DC = 18 (20 - 2 equipment bonus)

13. **Test_ToxicAtmosphere_CriticalFailure_HallucinationTrigger**
    - Setup: Character rolls natural 1 on DC 20 save
    - Action: Apply critical failure effects
    - Expected: Damage + minor hallucination triggered

14. **Test_ToxicAtmosphere_HallucinationProgression_MajorTrigger**
    - Setup: Character fails 3 consecutive saves
    - Action: Check hallucination severity
    - Expected: Major hallucination triggered (2d6 duration)

15. **Test_ToxicAtmosphere_EquipmentCorrosion_UpperBile**
    - Setup: Character equipment in Upper Bile (corrosion DC 13)
    - Action: Make corrosion check, roll = 11
    - Expected: Equipment durability -1

16. **Test_ToxicAtmosphere_PoisonResistance_DwarfRace**
    - Setup: Dwarf character in Dissolution Pits
    - Action: Apply racial poison resistance to save
    - Expected: +2 to Constitution save (dwarf feature)

17. **Test_ToxicAtmosphere_ExposureCounterReset**
    - Setup: Character exposed to toxins, left zone, rests 1 hour
    - Action: Re-enter same zone
    - Expected: Exposure counter reset to 0

18. **Test_ToxicAtmosphere_MaxStackingdc_Capped**
    - Setup: Character fails 10+ consecutive saves
    - Action: Calculate final stacking DC
    - Expected: DC capped at 25 (maximum)

#### Category 3: Garm's Watch Shared Zone (4 tests)

19. **Test_SharedZone_AccessVerification_ValidTransition**
    - Setup: Character in Forge Core attempting transition to Upper Bile
    - Action: Verify access through Garm's Watch
    - Expected: Access allowed

20. **Test_SharedZone_ConditionNegation_TotalDarkness**
    - Setup: Character from Svartalfheim entering Garm's Watch
    - Action: Check TotalDarkness condition status
    - Expected: TotalDarkness negated, light level set to 0.5

21. **Test_SharedZone_ConditionNegation_ToxicAtmosphere**
    - Setup: Character from Helheim entering Garm's Watch
    - Action: Check ToxicAtmosphere condition status
    - Expected: ToxicAtmosphere negated, no poison damage

22. **Test_SharedZone_ReappliesConditionOnExit**
    - Setup: Character exits Garm's Watch to Black Veins
    - Action: Check zone entry effects
    - Expected: TotalDarkness (DC 16) re-applied

#### Category 4: Zone Integration (2 tests)

23. **Test_ZoneIntegration_VerticalProgression_Svartalfheim**
    - Setup: Character traverses Bright Halls → Forge Core → Black Veins
    - Action: Verify environmental properties change appropriately
    - Expected: Temperature, light level, hazards change per zone

24. **Test_ZoneIntegration_VerticalProgression_Helheim**
    - Setup: Character descends Upper Bile → Dissolution Pits
    - Action: Verify difficulty and hazard escalation
    - Expected: DC 12 → DC 20, corrosion rate increases, damage increases

---

## 17. Deliverable Checklist

- [x] Executive Summary (complete)
- [x] Feature Overview with feature tree (complete)
- [x] Architecture Diagrams (Domain and Application layers)
- [x] 4+ User Stories with acceptance criteria
- [x] Svartalfheim Biome Specification (complete)
- [x] Helheim Biome Specification (complete)
- [x] 6 Zone Specifications (including shared zone)
- [x] TotalDarkness Condition Mechanics (vision blocking, light sources)
- [x] ToxicAtmosphere Condition Mechanics (poison damage, hallucinations)
- [x] Garm's Watch Shared Zone Mechanics
- [x] Environmental Property Systems documentation
- [x] Decision Trees and Flow Diagrams
- [x] Configuration Files (svartalfheim.json, helheim.json)
- [x] Code Examples (C# with XML documentation)
- [x] Logging Specifications
- [x] Unit Testing Requirements (~24 tests detailed)
- [x] Deliverable Checklist (this section)
- [x] Acceptance Criteria (next section)
- [x] Dependencies documentation
- [x] Deferrals/Future Considerations

---

## 18. Acceptance Criteria

### Core Acceptance Criteria

**AC-1: Biome Definitions**
- Both Svartalfheim and Helheim are fully defined with correct base properties
- All zones are properly configured with environmental parameters
- Vertical ranges are correctly specified (-2 to 0 for Svartalfheim, -3 to -1 for Helheim)

**AC-2: Environmental Conditions**
- TotalDarkness condition blocks vision without light sources (DC 16 in Black Veins)
- ToxicAtmosphere condition applies poison damage with stacking DC (DC 12-20)
- Hallucinations are triggered on critical failures or 3+ consecutive failures
- Equipment corrosion occurs in Helheim zones with appropriate DC checks

**AC-3: Light Source System**
- Light sources provide correct vision radii (torch: 20 ft bright, etc.)
- Multiple light sources stack additively (+20 ft per additional source)
- Light sources deplete over time and can be extinguished
- Torches have re-lighting chances (40% for torch, 60% for lamp)

**AC-4: Poison Damage Resolution**
- Upper Bile: DC 12 Constitution save, 1d6 poison on failure
- Dissolution Pits: DC 20 Constitution save, 3d8 poison on failure
- Successful saves at Upper Bile: No damage
- Successful saves at Dissolution Pits: Half damage (1d8+1d4)

**AC-5: Shared Zone Mechanics**
- Garm's Watch is accessible from both Forge Core and Upper Bile
- TotalDarkness is negated when entering Garm's Watch from Svartalfheim
- ToxicAtmosphere is negated when entering Garm's Watch from Helheim
- Light level is set to 0.5 (sufficient visibility) in Garm's Watch
- Hallucination DC is reduced by -2 in Garm's Watch

**AC-6: Configuration Files**
- svartalfheim.json is valid and loads without errors
- helheim.json is valid and loads without errors
- All zone definitions match specification requirements
- Adjacency rules correctly define zone connectivity

**AC-7: Unit Tests**
- 24 comprehensive tests pass with 100% coverage
- All TotalDarkness mechanics are tested (8 tests)
- All ToxicAtmosphere mechanics are tested (10 tests)
- Shared zone functionality is fully tested (4 tests)
- Zone integration tests pass (2 tests)

---

## 19. Dependencies

### Internal Dependencies

- **v0.19.0a (Core Biome Infrastructure):** Required
  - BiomeDefinition entity
  - EnvironmentalCondition entity
  - IBiomeProvider interface
  - BiomeZone entity
  - All core enums (RealmId, EnvironmentalConditionType, VerticalZone)

- **v0.6.x (Dice System):** Required
  - IDiceRoller interface
  - Dice notation parsing
  - Damage calculation system

- **v0.18.x (Advanced Character Creation):** Required
  - Character class with all attributes and modifiers
  - Ability score system
  - Class feature system
  - Equipment system

### External Dependencies

- **C# (.NET 6.0 or later):** Language and runtime
- **xUnit or NUnit:** Unit testing framework
- **Newtonsoft.Json:** JSON serialization/deserialization

### Peer Dependencies (v0.19.x)

- **v0.19.1a (Asgard & Alfheim):** Information purposes only
- **v0.19.3a (Niflheim & Muspelheim):** Information purposes only
- **v0.19.4a (Jötunheim & Vanaheim):** Information purposes only

---

## 20. Deferrals and Future Considerations

### Known Deferrals (Out of Scope)

1. **Advanced Environmental Interactions**
   - Combining TotalDarkness with other conditions
   - Cascading environmental effects
   - Deferred to v0.19.5a or later

2. **NPC-Specific Reactions**
   - How NPCs navigate Garm's Watch
   - NPC alliance/faction mechanics in shared zones
   - Deferred to social system enhancement phase

3. **Extended Hallucination Effects**
   - Permanent hallucination mechanics
   - Hallucination-induced permanent abilities/penalties
   - Deferred to advanced condition system (v0.20.x)

4. **Environmental Damage to Structures**
   - How buildings/equipment degrade from corrosion
   - Settlement-level hazard effects
   - Deferred to settlement system (v0.21.x)

5. **Multiplayer Shared Zone Mechanics**
   - How multiple parties interact in Garm's Watch
   - PvP safety mechanics
   - Deferred to multiplayer expansion (v0.22.x)

### Future Enhancement Opportunities

1. **Seasonal Environmental Variations**
   - Svartalfheim: Forge maintenance cycles affecting heat levels
   - Helheim: Toxic purity cycles affecting atmospheric DC
   - Potential implementation: v0.19.6a

2. **Character Adaptation Mechanics**
   - Gaining environmental resistance through repeated exposure
   - Building immunity to specific toxins
   - Potential implementation: v0.20.1a

3. **Crafting System Integration**
   - Forging items in Svartalfheim Forge Core
   - Decomposing materials in Helheim vats
   - Potential implementation: v0.21.2a

4. **Environmental Artifact Discovery**
   - Ancient dwarven artifacts hidden in Black Veins
   - Corrupted relics in Dissolution Pits
   - Potential implementation: v0.22.x

5. **Dynamic Zone States**
   - Forges going dormant/active
   - Toxic vat levels rising/falling
   - Potential implementation: v0.23.x

---

## Revision History

| Version | Date | Author | Changes |
|---------|------|--------|---------|
| 0.19.2a | 2026-01-28 | Design Team | Initial specification creation |

---

**END OF SPECIFICATION**

*This document specifies v0.19.2a: Svartalfheim & Helheim Implementation with complete mechanical systems for TotalDarkness and ToxicAtmosphere conditions, comprehensive zone definitions, and Garm's Watch shared zone mechanics.*
