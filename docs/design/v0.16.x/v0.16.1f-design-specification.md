# v0.16.1f Design Specification: Combat Integration

**Version:** 0.16.1f  
**Phase Name:** Combat Integration  
**Parent Version:** v0.16.1 (Weapon Proficiency System)  
**Prerequisites:** v0.16.1a-e Complete (All Weapon Proficiency System Components)  
**Estimated Tests:** ~2 unit tests

---

## Table of Contents

1. [Executive Summary](#1-executive-summary)
2. [Feature Overview](#2-feature-overview)
3. [Architecture Diagrams](#3-architecture-diagrams)
4. [IProficiencyCheckService Interface](#4-iproficiencycheckservice-interface)
5. [Combat Modifier Calculations](#5-combat-modifier-calculations)
6. [Data Model Changes](#6-data-model-changes)
7. [Logging Specifications](#7-logging-specifications)
8. [Unit Testing Requirements](#8-unit-testing-requirements)
9. [Use Cases](#9-use-cases)
10. [Deliverable Checklist](#10-deliverable-checklist)
11. [Acceptance Criteria](#11-acceptance-criteria)
12. [Dependencies](#12-dependencies)
13. [Future Considerations](#13-future-considerations)

---

## 1. Executive Summary

### 1.1 Purpose

This specification defines the combat integration for the weapon proficiency system. It introduces `IProficiencyCheckService`, which calculates attack and damage modifiers based on a character's proficiency level with their equipped weapon category. Additionally, it handles special property blocking for non-proficient characters and records combat experience after each attack.

The proficiency effects in combat are:

| Level         | Attack Mod | Damage Mod | Special Properties | Techniques |
| ------------- | ---------- | ---------- | ------------------ | ---------- |
| NonProficient | -3         | -2         | Blocked            | None       |
| Proficient    | 0          | 0          | Allowed            | Basic      |
| Expert        | +1         | 0          | Allowed            | Advanced   |
| Master        | +2         | +1         | Allowed            | Signature  |

### 1.2 Key Deliverables

| Category          | Items                        |
| ----------------- | ---------------------------- |
| **Interfaces**    | `IProficiencyCheckService`   |
| **Value Objects** | `CombatProficiencyModifiers` |
| **Tests**         | ~2 unit tests                |

### 1.3 Architectural Significance

This version establishes the **Combat Proficiency Pattern**:

- **Centralized Modifier Calculation**: All proficiency-based combat calculations go through `IProficiencyCheckService`
- **Special Property Blocking**: NonProficient characters cannot use weapon special properties
- **Automatic Experience Recording**: Combat usage automatically awards proficiency experience
- **Integration Point**: Combat service calls proficiency check service during attack resolution

---

## 2. Feature Overview

```
v0.16.1f Combat Integration
├── IProficiencyCheckService Interface
│   ├── GetCombatModifiers(character, weaponCategory): CombatProficiencyModifiers
│   ├── GetAttackModifier(character, weaponCategory): int
│   ├── GetDamageModifier(character, weaponCategory): int
│   ├── CanUseSpecialProperties(character, weaponCategory): bool
│   ├── CanUseTechnique(character, weaponCategory, techniqueLevel): bool
│   └── RecordCombatUsage(character, weaponCategory): ProficiencyGainResult
├── CombatProficiencyModifiers Value Object
│   ├── ProficiencyLevel: WeaponProficiencyLevel
│   ├── AttackModifier: int
│   ├── DamageModifier: int
│   ├── CanUseSpecialProperties: bool
│   ├── UnlockedTechniqueLevel: TechniqueAccess
│   └── Description: string
└── Combat Service Integration
    ├── Attack resolution applies modifiers
    ├── Damage resolution applies modifiers
    ├── Special property check before activation
    └── Experience recording after combat
```

### 2.1 Scope Alignment

**In Scope:**

- `IProficiencyCheckService` application interface
- `CombatProficiencyModifiers` value object
- Attack modifier calculation based on proficiency level
- Damage modifier calculation based on proficiency level
- Special property blocking for NonProficient characters
- Combat experience recording via `IProficiencyAcquisitionService`
- Technique access level checking

**Out of Scope:**

- Advanced technique implementations (future version)
- Technique-specific combat effects (future version)
- Weapon mastery bonuses beyond Master level (future version)
- Dual-wielding proficiency interactions (future version)

---

## 3. Architecture Diagrams

### 3.1 Combat Integration System Overview

```
┌─────────────────────────────────────────────────────────────────────┐
│              COMBAT INTEGRATION SYSTEM OVERVIEW                      │
└─────────────────────────────────────────────────────────────────────┘

    Player initiates attack with weapon
         │
         ▼
┌─────────────────────────────────────────────────────────────────────┐
│                       CombatService                                  │
├─────────────────────────────────────────────────────────────────────┤
│  1. Get equipped weapon                                              │
│  2. Determine weapon category                                        │
│  3. Call IProficiencyCheckService.GetCombatModifiers()              │
└─────────────────────────────────────────────────────────────────────┘
         │
         ▼
┌─────────────────────────────────────────────────────────────────────┐
│              IProficiencyCheckService                                │
├─────────────────────────────────────────────────────────────────────┤
│  1. Get character's CharacterProficiencies                          │
│  2. Get current ProficiencyProgress for weapon's category           │
│  3. Get ProficiencyEffect for current level (from v0.16.1a)         │
│  4. Return CombatProficiencyModifiers                               │
└─────────────────────────────────────────────────────────────────────┘
         │
         ▼
┌─────────────────────────────────────────────────────────────────────┐
│                CombatProficiencyModifiers                            │
├─────────────────────────────────────────────────────────────────────┤
│  AttackModifier: -3 / 0 / +1 / +2                                   │
│  DamageModifier: -2 / 0 / 0 / +1                                    │
│  CanUseSpecialProperties: false / true / true / true                │
│  UnlockedTechniqueLevel: None / Basic / Advanced / Signature        │
└─────────────────────────────────────────────────────────────────────┘
         │
         ▼
┌─────────────────────────────────────────────────────────────────────┐
│                    APPLY IN COMBAT                                   │
├─────────────────────────────────────────────────────────────────────┤
│  Attack Roll = Base Roll + Attack Modifier + Other Bonuses          │
│  Damage Roll = Base Damage + Damage Modifier + Other Bonuses        │
│  Special Properties = Blocked if CanUseSpecialProperties == false   │
└─────────────────────────────────────────────────────────────────────┘
         │
         ▼
┌─────────────────────────────────────────────────────────────────────┐
│              RECORD COMBAT EXPERIENCE                                │
├─────────────────────────────────────────────────────────────────────┤
│  After attack resolves:                                              │
│  IProficiencyCheckService.RecordCombatUsage(character, category)    │
│    → IProficiencyAcquisitionService.RecordCombatExperienceAsync()    │
│    → Character gains 1 combat experience for this category          │
│    → If threshold reached, auto-advance proficiency level           │
└─────────────────────────────────────────────────────────────────────┘
```

### 3.2 Attack Resolution Flow with Proficiency

```
┌─────────────────────────────────────────────────────────────────────┐
│              ATTACK RESOLUTION FLOW WITH PROFICIENCY                 │
└─────────────────────────────────────────────────────────────────────┘

    Character attacks with Sword (Category: Swords)
         │
         ▼
    ┌──────────────────────────────────────────────────────────────────┐
    │  1. GET PROFICIENCY MODIFIERS                                     │
    ├──────────────────────────────────────────────────────────────────┤
    │  modifiers = proficiencyCheckService.GetCombatModifiers(         │
    │      character, WeaponCategory.Swords)                           │
    │                                                                   │
    │  Character is Proficient level:                                  │
    │    AttackModifier = 0                                            │
    │    DamageModifier = 0                                            │
    │    CanUseSpecialProperties = true                                │
    └──────────────────────────────────────────────────────────────────┘
         │
         ▼
    ┌──────────────────────────────────────────────────────────────────┐
    │  2. CALCULATE ATTACK ROLL                                         │
    ├──────────────────────────────────────────────────────────────────┤
    │  Base Attack = Character.AttackBonus (e.g., 5)                   │
    │  Weapon Bonus = Sword.AttackBonus (e.g., +2)                     │
    │  Proficiency Modifier = modifiers.AttackModifier (0)             │
    │  Other Modifiers = (situational bonuses)                         │
    │                                                                   │
    │  Total Attack Bonus = 5 + 2 + 0 = 7                              │
    │  Roll = 1d20 + 7                                                 │
    └──────────────────────────────────────────────────────────────────┘
         │
         ▼
    ┌──────────────────────────────────────────────────────────────────┐
    │  3. RESOLVE HIT/MISS                                              │
    ├──────────────────────────────────────────────────────────────────┤
    │  IF Roll >= Target.Defense                                       │
    │    → HIT, proceed to damage                                      │
    │  ELSE                                                             │
    │    → MISS, no damage                                             │
    └──────────────────────────────────────────────────────────────────┘
         │
         │ (if hit)
         ▼
    ┌──────────────────────────────────────────────────────────────────┐
    │  4. CALCULATE DAMAGE                                              │
    ├──────────────────────────────────────────────────────────────────┤
    │  Base Damage = Weapon.BaseDamage (e.g., 1d8)                     │
    │  Strength Bonus = Character.StrengthMod (e.g., +3)               │
    │  Proficiency Modifier = modifiers.DamageModifier (0)             │
    │                                                                   │
    │  Total Damage = 1d8 + 3 + 0                                      │
    └──────────────────────────────────────────────────────────────────┘
         │
         ▼
    ┌──────────────────────────────────────────────────────────────────┐
    │  5. CHECK SPECIAL PROPERTIES (if weapon has any)                  │
    ├──────────────────────────────────────────────────────────────────┤
    │  IF weapon.HasSpecialProperties                                  │
    │    IF modifiers.CanUseSpecialProperties == true                  │
    │      → Apply special effects (e.g., Flaming: +1d6 fire)         │
    │    ELSE (NonProficient)                                          │
    │      → Special properties BLOCKED                                │
    │      → Display: "You lack the proficiency to use this           │
    │         weapon's special properties"                             │
    └──────────────────────────────────────────────────────────────────┘
         │
         ▼
    ┌──────────────────────────────────────────────────────────────────┐
    │  6. RECORD COMBAT EXPERIENCE                                      │
    ├──────────────────────────────────────────────────────────────────┤
    │  proficiencyCheckService.RecordCombatUsage(character, Swords)    │
    │    → +1 combat experience for Swords category                    │
    │    → If threshold reached, level advances automatically          │
    └──────────────────────────────────────────────────────────────────┘
```

### 3.3 NonProficient Combat Penalty Visualization

```
┌─────────────────────────────────────────────────────────────────────┐
│              NON-PROFICIENT COMBAT PENALTY EXAMPLE                   │
└─────────────────────────────────────────────────────────────────────┘

Scenario: Mystic (proficient with Daggers, Staves, ArcaneImplements)
          picks up a Greatsword (Category: Swords)

    Mystic attacks with Greatsword
         │
         ▼
    ┌──────────────────────────────────────────────────────────────────┐
    │  CHECK PROFICIENCY                                                │
    ├──────────────────────────────────────────────────────────────────┤
    │  character.Proficiencies.GetLevel(Swords)                        │
    │    → Mystic is NonProficient with Swords                         │
    │                                                                   │
    │  GetCombatModifiers returns:                                     │
    │    AttackModifier = -3                                           │
    │    DamageModifier = -2                                           │
    │    CanUseSpecialProperties = false                               │
    │    UnlockedTechniqueLevel = None                                 │
    └──────────────────────────────────────────────────────────────────┘
         │
         ▼
    ┌──────────────────────────────────────────────────────────────────┐
    │  ATTACK CALCULATION                                               │
    ├──────────────────────────────────────────────────────────────────┤
    │  Base Attack = 3 (Mystic has low base attack)                    │
    │  Weapon Bonus = +2 (Greatsword bonus)                            │
    │  Proficiency Modifier = -3 (NonProficient penalty)               │
    │                                                                   │
    │  Total Attack Bonus = 3 + 2 + (-3) = 2                           │
    │  Penalty: 3 lower than if using a Proficient weapon             │
    └──────────────────────────────────────────────────────────────────┘
         │
         ▼
    ┌──────────────────────────────────────────────────────────────────┐
    │  DAMAGE CALCULATION                                               │
    ├──────────────────────────────────────────────────────────────────┤
    │  Base Damage = 2d6 (Greatsword)                                  │
    │  Strength Bonus = +1                                             │
    │  Proficiency Modifier = -2 (NonProficient penalty)               │
    │                                                                   │
    │  Total Damage = 2d6 + 1 + (-2) = 2d6 - 1                         │
    │  Minimum damage is 0 (negative damage becomes 0)                 │
    └──────────────────────────────────────────────────────────────────┘
         │
         ▼
    ┌──────────────────────────────────────────────────────────────────┐
    │  SPECIAL PROPERTIES BLOCKED                                       │
    ├──────────────────────────────────────────────────────────────────┤
    │  Greatsword has "Cleave" special property                        │
    │  CanUseSpecialProperties = false                                 │
    │                                                                   │
    │  → Cleave ability is BLOCKED                                     │
    │  → Message: "You lack the skill to use Cleave with this weapon" │
    └──────────────────────────────────────────────────────────────────┘
         │
         ▼
    ┌──────────────────────────────────────────────────────────────────┐
    │  COMBAT EXPERIENCE STILL RECORDED                                 │
    ├──────────────────────────────────────────────────────────────────┤
    │  RecordCombatUsage(mystic, Swords)                               │
    │    → Mystic gains 1 combat experience with Swords                │
    │    → After 10 combats, will become Proficient                    │
    │    → NonProficient penalty will be removed                       │
    └──────────────────────────────────────────────────────────────────┘
```

### 3.4 Layer Diagram

```
┌─────────────────────────────────────────────────────────────────────┐
│                        PRESENTATION LAYER                            │
├─────────────────────────────────────────────────────────────────────┤
│  CombatView                                                          │
│  ├── Displays attack result with proficiency info                   │
│  └── Shows "NonProficient with Swords (-3 attack, -2 damage)"       │
│                                                                      │
│  CombatLogRenderer                                                   │
│  └── "You attack the goblin with your sword. [NonProficient: -3]"   │
└───────┬─────────────────────────────────────────────────────────────┘
        │
        ▼
┌─────────────────────────────────────────────────────────────────────┐
│                       APPLICATION LAYER                              │
├─────────────────────────────────────────────────────────────────────┤
│  CombatService                                                       │
│  └── Uses IProficiencyCheckService during attack resolution         │
│                                                                      │
│  ┌───────────────────────────────────────────────────────────────┐  │
│  │           ProficiencyCheckService                              │  │
│  │      (implements IProficiencyCheckService)                     │  │
│  ├───────────────────────────────────────────────────────────────┤  │
│  │  + GetCombatModifiers(char, cat): CombatProficiencyModifiers  │  │
│  │  + GetAttackModifier(char, cat): int                          │  │
│  │  + GetDamageModifier(char, cat): int                          │  │
│  │  + CanUseSpecialProperties(char, cat): bool                   │  │
│  │  + CanUseTechnique(char, cat, level): bool                    │  │
│  │  + RecordCombatUsage(char, cat): ProficiencyGainResult        │  │
│  │                                                               │  │
│  │  Dependencies:                                                │  │
│  │  ├─ IProficiencyEffectProvider (v0.16.1a)                    │  │
│  │  └─ IProficiencyAcquisitionService (v0.16.1e)                 │  │
│  └───────────────────────────────────────────────────────────────┘  │
└───────┬─────────────────────────────────────────────────────────────┘
        │
        ▼
┌─────────────────────────────────────────────────────────────────────┐
│                         DOMAIN LAYER                                 │
├─────────────────────────────────────────────────────────────────────┤
│  ┌───────────────────────────────────────────────────────────────┐  │
│  │            CombatProficiencyModifiers                          │  │
│  │                 (Value Object)                                 │  │
│  ├───────────────────────────────────────────────────────────────┤  │
│  │  ProficiencyLevel: WeaponProficiencyLevel                      │  │
│  │  AttackModifier: int                                           │  │
│  │  DamageModifier: int                                           │  │
│  │  CanUseSpecialProperties: bool                                 │  │
│  │  UnlockedTechniqueLevel: TechniqueAccess                       │  │
│  │  Description: string                                           │  │
│  │                                                                │  │
│  │  + IsNonProficient: bool                                       │  │
│  │  + HasPenalty: bool                                            │  │
│  │  + HasBonus: bool                                              │  │
│  └───────────────────────────────────────────────────────────────┘  │
│                                                                      │
│  Existing Types Used:                                                │
│  ├─ WeaponProficiencyLevel (v0.16.1a)                               │
│  ├─ TechniqueAccess (v0.16.1a)                                      │
│  ├─ ProficiencyEffect (v0.16.1a)                                    │
│  ├─ WeaponCategory (v0.16.1b)                                        │
│  ├─ CharacterProficiencies (v0.16.1d)                               │
│  └─ ProficiencyGainResult (v0.16.1e)                                │
└─────────────────────────────────────────────────────────────────────┘
```

---

## 4. IProficiencyCheckService Interface

### 4.1 Purpose

The `IProficiencyCheckService` interface provides proficiency-based combat modifiers and handles experience recording. It is the primary integration point between the combat system and the proficiency system.

### 4.2 Implementation

**File:** `src/Core/RuneAndRust.Application/Interfaces/IProficiencyCheckService.cs`

```csharp
namespace RuneAndRust.Application.Interfaces;

using RuneAndRust.Domain.Entities;
using RuneAndRust.Domain.Enums;
using RuneAndRust.Domain.ValueObjects;

/// <summary>
/// Provides proficiency-based combat modifiers and experience recording.
/// </summary>
/// <remarks>
/// <para>
/// This service is called by the combat system during attack resolution
/// to apply proficiency bonuses and penalties. It also handles recording
/// combat experience after each attack.
/// </para>
/// <para>
/// For combat performance, prefer using <see cref="GetCombatModifiers"/>
/// once per attack, then reuse the returned modifiers object.
/// </para>
/// </remarks>
public interface IProficiencyCheckService
{
    /// <summary>
    /// Gets all combat modifiers for a character using a weapon category.
    /// </summary>
    /// <param name="character">The attacking character.</param>
    /// <param name="weaponCategory">The weapon's category.</param>
    /// <returns>Complete proficiency modifiers for combat.</returns>
    /// <remarks>
    /// This is the primary method for combat integration. Call once per
    /// attack and reuse the returned modifiers for attack and damage.
    /// </remarks>
    CombatProficiencyModifiers GetCombatModifiers(
        Character character,
        WeaponCategory weaponCategory);

    /// <summary>
    /// Gets only the attack modifier for a character and weapon category.
    /// </summary>
    /// <param name="character">The attacking character.</param>
    /// <param name="weaponCategory">The weapon's category.</param>
    /// <returns>Attack modifier: -3 (NonProf), 0 (Prof), +1 (Expert), +2 (Master).</returns>
    int GetAttackModifier(Character character, WeaponCategory weaponCategory);

    /// <summary>
    /// Gets only the damage modifier for a character and weapon category.
    /// </summary>
    /// <param name="character">The attacking character.</param>
    /// <param name="weaponCategory">The weapon's category.</param>
    /// <returns>Damage modifier: -2 (NonProf), 0 (Prof/Expert), +1 (Master).</returns>
    int GetDamageModifier(Character character, WeaponCategory weaponCategory);

    /// <summary>
    /// Checks if a character can use weapon special properties.
    /// </summary>
    /// <param name="character">The character.</param>
    /// <param name="weaponCategory">The weapon's category.</param>
    /// <returns>True if Proficient or higher, false if NonProficient.</returns>
    /// <remarks>
    /// NonProficient characters cannot activate weapon special properties
    /// like elemental damage, cleave effects, or magical abilities.
    /// </remarks>
    bool CanUseSpecialProperties(Character character, WeaponCategory weaponCategory);

    /// <summary>
    /// Checks if a character can use a specific technique level.
    /// </summary>
    /// <param name="character">The character.</param>
    /// <param name="weaponCategory">The weapon's category.</param>
    /// <param name="techniqueLevel">The required technique access level.</param>
    /// <returns>True if character's proficiency unlocks the technique level.</returns>
    /// <remarks>
    /// Technique access levels:
    /// - None: Never available
    /// - Basic: Requires Proficient+
    /// - Advanced: Requires Expert+
    /// - Signature: Requires Master
    /// </remarks>
    bool CanUseTechnique(
        Character character,
        WeaponCategory weaponCategory,
        TechniqueAccess techniqueLevel);

    /// <summary>
    /// Records combat usage for proficiency experience.
    /// </summary>
    /// <param name="character">The character who used the weapon.</param>
    /// <param name="weaponCategory">The weapon category used.</param>
    /// <returns>Result indicating if proficiency level increased.</returns>
    /// <remarks>
    /// Call this after each combat where the character attacked with a weapon.
    /// This delegates to <see cref="IProficiencyAcquisitionService.RecordCombatExperienceAsync"/>.
    /// </remarks>
    Task<ProficiencyGainResult> RecordCombatUsageAsync(
        Character character,
        WeaponCategory weaponCategory,
        CancellationToken ct = default);

    /// <summary>
    /// Gets a description of proficiency effects for display.
    /// </summary>
    /// <param name="level">The proficiency level.</param>
    /// <returns>Human-readable description of the level's combat effects.</returns>
    string GetProficiencyDescription(WeaponProficiencyLevel level);
}
```

### 4.3 Usage Examples

```csharp
// During combat attack resolution
public async Task<AttackResult> ResolveAttack(
    Character attacker,
    Character target,
    Weapon weapon)
{
    // Get proficiency modifiers (call once, reuse for attack and damage)
    var category = weapon.Category;
    var modifiers = _proficiencyCheckService.GetCombatModifiers(attacker, category);

    // Calculate attack roll
    var attackBonus = attacker.BaseAttackBonus
        + weapon.AttackBonus
        + modifiers.AttackModifier;  // -3 / 0 / +1 / +2

    var roll = _diceService.Roll(1, 20) + attackBonus;
    var hit = roll >= target.Defense;

    if (!hit)
    {
        return AttackResult.Miss(attacker, target);
    }

    // Calculate damage
    var baseDamage = weapon.RollDamage();
    var damageBonus = attacker.StrengthModifier + modifiers.DamageModifier; // -2 / 0 / 0 / +1
    var totalDamage = Math.Max(0, baseDamage + damageBonus);

    // Check special properties
    var specialEffects = new List<SpecialEffect>();
    if (weapon.HasSpecialProperties && modifiers.CanUseSpecialProperties)
    {
        specialEffects = weapon.ApplySpecialProperties(target);
    }
    else if (weapon.HasSpecialProperties && !modifiers.CanUseSpecialProperties)
    {
        _logger.LogDebug(
            "Special properties blocked due to NonProficient. Attacker={Attacker}, Weapon={Weapon}",
            attacker.Name,
            weapon.Name);
    }

    // Record combat experience
    var expResult = await _proficiencyCheckService.RecordCombatUsageAsync(attacker, category);
    if (expResult.LevelChanged)
    {
        _logger.LogInformation(
            "Proficiency advanced during combat! {OldLevel} → {NewLevel}",
            expResult.OldLevel,
            expResult.NewLevel);
    }

    return AttackResult.Hit(attacker, target, totalDamage, specialEffects, expResult);
}
```

---

## 5. Combat Modifier Calculations

### 5.1 CombatProficiencyModifiers Value Object

**File:** `src/Core/RuneAndRust.Domain/ValueObjects/CombatProficiencyModifiers.cs`

```csharp
namespace RuneAndRust.Domain.ValueObjects;

using RuneAndRust.Domain.Enums;

/// <summary>
/// Represents all proficiency-based combat modifiers for an attack.
/// </summary>
/// <param name="ProficiencyLevel">Current proficiency level with the weapon category.</param>
/// <param name="AttackModifier">Bonus/penalty to attack rolls.</param>
/// <param name="DamageModifier">Bonus/penalty to damage rolls.</param>
/// <param name="CanUseSpecialProperties">Whether weapon special properties can be activated.</param>
/// <param name="UnlockedTechniqueLevel">Highest technique level available.</param>
public readonly record struct CombatProficiencyModifiers(
    WeaponProficiencyLevel ProficiencyLevel,
    int AttackModifier,
    int DamageModifier,
    bool CanUseSpecialProperties,
    TechniqueAccess UnlockedTechniqueLevel)
{
    /// <summary>
    /// Gets whether the character is non-proficient (has penalties).
    /// </summary>
    public bool IsNonProficient => ProficiencyLevel == WeaponProficiencyLevel.NonProficient;

    /// <summary>
    /// Gets whether there are any penalties (negative modifiers).
    /// </summary>
    public bool HasPenalty => AttackModifier < 0 || DamageModifier < 0;

    /// <summary>
    /// Gets whether there are any bonuses (positive modifiers).
    /// </summary>
    public bool HasBonus => AttackModifier > 0 || DamageModifier > 0;

    /// <summary>
    /// Gets whether the character is at Expert level or higher.
    /// </summary>
    public bool IsExpertOrHigher => ProficiencyLevel >= WeaponProficiencyLevel.Expert;

    /// <summary>
    /// Gets whether the character has mastered this weapon category.
    /// </summary>
    public bool IsMaster => ProficiencyLevel == WeaponProficiencyLevel.Master;

    /// <summary>
    /// Gets a formatted description of the modifiers.
    /// </summary>
    public string Description
    {
        get
        {
            if (IsNonProficient)
            {
                return $"NonProficient ({AttackModifier:+0;-#} attack, {DamageModifier:+0;-#} damage, special properties blocked)";
            }

            if (HasBonus)
            {
                return $"{ProficiencyLevel} ({AttackModifier:+0;-#} attack, {DamageModifier:+0;-#} damage)";
            }

            return ProficiencyLevel.ToString();
        }
    }

    /// <summary>
    /// Creates modifiers from a ProficiencyEffect.
    /// </summary>
    /// <param name="level">The proficiency level.</param>
    /// <param name="effect">The effect configuration for this level.</param>
    /// <returns>Combat modifiers based on the effect.</returns>
    public static CombatProficiencyModifiers FromEffect(
        WeaponProficiencyLevel level,
        ProficiencyEffect effect)
    {
        return new CombatProficiencyModifiers(
            ProficiencyLevel: level,
            AttackModifier: effect.AttackModifier,
            DamageModifier: effect.DamageModifier,
            CanUseSpecialProperties: effect.CanUseSpecialProperties,
            UnlockedTechniqueLevel: effect.UnlockedTechniques);
    }

    /// <summary>
    /// Creates default modifiers for NonProficient level.
    /// </summary>
    public static CombatProficiencyModifiers NonProficient =>
        new(
            ProficiencyLevel: WeaponProficiencyLevel.NonProficient,
            AttackModifier: -3,
            DamageModifier: -2,
            CanUseSpecialProperties: false,
            UnlockedTechniqueLevel: TechniqueAccess.None);

    /// <summary>
    /// Creates default modifiers for Proficient level.
    /// </summary>
    public static CombatProficiencyModifiers Proficient =>
        new(
            ProficiencyLevel: WeaponProficiencyLevel.Proficient,
            AttackModifier: 0,
            DamageModifier: 0,
            CanUseSpecialProperties: true,
            UnlockedTechniqueLevel: TechniqueAccess.Basic);

    /// <summary>
    /// Creates default modifiers for Expert level.
    /// </summary>
    public static CombatProficiencyModifiers Expert =>
        new(
            ProficiencyLevel: WeaponProficiencyLevel.Expert,
            AttackModifier: +1,
            DamageModifier: 0,
            CanUseSpecialProperties: true,
            UnlockedTechniqueLevel: TechniqueAccess.Advanced);

    /// <summary>
    /// Creates default modifiers for Master level.
    /// </summary>
    public static CombatProficiencyModifiers Master =>
        new(
            ProficiencyLevel: WeaponProficiencyLevel.Master,
            AttackModifier: +2,
            DamageModifier: +1,
            CanUseSpecialProperties: true,
            UnlockedTechniqueLevel: TechniqueAccess.Signature);

    /// <summary>
    /// Creates a display string for debug/logging purposes.
    /// </summary>
    public override string ToString() => Description;
}
```

### 5.2 Modifier Calculation Summary

```
┌─────────────────────────────────────────────────────────────────────┐
│              PROFICIENCY COMBAT MODIFIER SUMMARY                     │
└─────────────────────────────────────────────────────────────────────┘

Level         │ Attack │ Damage │ Special Props │ Techniques
──────────────┼────────┼────────┼───────────────┼──────────────
NonProficient │  -3    │  -2    │   Blocked     │ None
Proficient    │   0    │   0    │   Allowed     │ Basic
Expert        │  +1    │   0    │   Allowed     │ Advanced
Master        │  +2    │  +1    │   Allowed     │ Signature

MODIFIER APPLICATION:
─────────────────────
Attack Roll = d20 + BaseAttack + WeaponBonus + ProficiencyMod + OtherMods
Damage Roll = WeaponDamage + StrMod + ProficiencyMod + OtherMods

MINIMUM DAMAGE:
───────────────
Damage cannot go below 0 (negative damage becomes 0)

SPECIAL PROPERTIES:
───────────────────
NonProficient characters CANNOT use:
- Elemental damage bonuses (Flaming, Frost, Shock)
- On-hit effects (Vampiric, Stunning)
- Active abilities (Cleave, Whirlwind)
- Weapon-specific techniques

They CAN still use the weapon's base functionality:
- Basic attacks
- Base damage dice
- Critical hit multipliers (if they hit)

TECHNIQUE ACCESS:
─────────────────
- None: No techniques available (NonProficient)
- Basic: Simple techniques any trained user knows (Proficient+)
- Advanced: Complex techniques requiring experience (Expert+)
- Signature: Master-level techniques unique to weapon mastery (Master only)
```

---

## 6. Data Model Changes

### 6.1 New Types Summary

| Type                         | Layer       | Category     | Description               |
| ---------------------------- | ----------- | ------------ | ------------------------- |
| `IProficiencyCheckService`   | Application | Interface    | Combat proficiency checks |
| `CombatProficiencyModifiers` | Domain      | Value Object | Complete combat mod set   |

### 6.2 File Locations

```
src/Core/RuneAndRust.Application/
├── Interfaces/
│   └── IProficiencyCheckService.cs          ← NEW
└── Services/
    └── ProficiencyCheckService.cs           ← NEW (implementation)

src/Core/RuneAndRust.Domain/
└── ValueObjects/
    └── CombatProficiencyModifiers.cs        ← NEW
```

### 6.3 Integration Points

```
┌─────────────────────────────────────────────────────────────────────┐
│              COMBAT SERVICE INTEGRATION POINTS                       │
└─────────────────────────────────────────────────────────────────────┘

CombatService (existing)
├── UPDATED: Add IProficiencyCheckService dependency
│
├── ResolveAttack() method
│   ├── UPDATED: Call GetCombatModifiers() before attack roll
│   ├── UPDATED: Add AttackModifier to attack roll
│   ├── UPDATED: Add DamageModifier to damage roll
│   ├── UPDATED: Check CanUseSpecialProperties before activating
│   └── UPDATED: Call RecordCombatUsageAsync() after attack
│
└── DisplayAttackResult() method
    └── UPDATED: Show proficiency info in combat log

AttackResult (existing or new DTO)
├── UPDATED: Add ProficiencyModifiers property
├── UPDATED: Add ProficiencyAdvanced flag
└── UPDATED: Add ProficiencyGainResult property
```

---

## 7. Logging Specifications

### 7.1 Log Levels by Component

| Component                 | Level       | Events                                         |
| ------------------------- | ----------- | ---------------------------------------------- |
| `ProficiencyCheckService` | Information | Proficiency level changed during combat        |
| `ProficiencyCheckService` | Debug       | Modifier calculations, technique checks        |
| `CombatService`           | Debug       | Proficiency modifiers applied to attack/damage |

### 7.2 Structured Logging Templates

```csharp
// Information - Proficiency advanced during combat
_logger.LogInformation(
    "Proficiency advanced during combat! CharacterId={CharacterId}, " +
    "Category={Category}, OldLevel={OldLevel}, NewLevel={NewLevel}",
    character.Id,
    category,
    oldLevel,
    newLevel);

// Debug - Combat modifiers retrieved
_logger.LogDebug(
    "Combat modifiers calculated. CharacterId={CharacterId}, Category={Category}, " +
    "Level={Level}, AttackMod={AttackMod}, DamageMod={DamageMod}, SpecialProps={SpecialProps}",
    character.Id,
    category,
    modifiers.ProficiencyLevel,
    modifiers.AttackModifier,
    modifiers.DamageModifier,
    modifiers.CanUseSpecialProperties);

// Debug - Special properties blocked
_logger.LogDebug(
    "Special properties blocked for NonProficient character. " +
    "CharacterId={CharacterId}, WeaponName={Weapon}, Category={Category}",
    character.Id,
    weapon.Name,
    category);

// Debug - Technique check
_logger.LogDebug(
    "Technique access checked. CharacterId={CharacterId}, Category={Category}, " +
    "RequiredLevel={Required}, UnlockedLevel={Unlocked}, Allowed={Allowed}",
    character.Id,
    category,
    requiredLevel,
    unlockedLevel,
    allowed);

// Debug - Combat experience recorded
_logger.LogDebug(
    "Combat experience recorded. CharacterId={CharacterId}, Category={Category}, " +
    "NewExperience={NewExp}, LevelChanged={LevelChanged}",
    character.Id,
    category,
    newExperience,
    result.LevelChanged);
```

---

## 8. Unit Testing Requirements

### 8.1 Test Count by Feature

| Feature                          | Test Count |
| -------------------------------- | ---------- |
| IProficiencyCheckService methods | ~2         |
| **Total**                        | **~2**     |

### 8.2 Test Specifications

**File:** `tests/RuneAndRust.Application.UnitTests/Services/ProficiencyCheckServiceTests.cs`

```csharp
[TestFixture]
public class ProficiencyCheckServiceTests
{
    private IProficiencyCheckService _service;
    private Mock<IProficiencyEffectProvider> _effectProviderMock;
    private Mock<IProficiencyAcquisitionService> _acquisitionServiceMock;

    [SetUp]
    public void SetUp()
    {
        _effectProviderMock = new Mock<IProficiencyEffectProvider>();
        _acquisitionServiceMock = new Mock<IProficiencyAcquisitionService>();
        _service = new ProficiencyCheckService(
            _effectProviderMock.Object,
            _acquisitionServiceMock.Object,
            Mock.Of<ILogger<ProficiencyCheckService>>());
    }

    [Test]
    public void GetCombatModifiers_ForNonProficient_ReturnsNegativeModifiers();

    [Test]
    public void GetCombatModifiers_ForMaster_ReturnsPositiveModifiers();

    [Test]
    public void GetAttackModifier_ForNonProficient_ReturnsMinus3();

    [Test]
    public void GetAttackModifier_ForProficient_Returns0();

    [Test]
    public void GetAttackModifier_ForExpert_ReturnsPlus1();

    [Test]
    public void GetAttackModifier_ForMaster_ReturnsPlus2();

    [Test]
    public void GetDamageModifier_ForNonProficient_ReturnsMinus2();

    [Test]
    public void GetDamageModifier_ForMaster_ReturnsPlus1();

    [Test]
    public void CanUseSpecialProperties_ForNonProficient_ReturnsFalse();

    [Test]
    public void CanUseSpecialProperties_ForProficient_ReturnsTrue();

    [Test]
    public void CanUseTechnique_BasicForProficient_ReturnsTrue();

    [Test]
    public void CanUseTechnique_AdvancedForProficient_ReturnsFalse();

    [Test]
    public void CanUseTechnique_SignatureForMaster_ReturnsTrue();

    [Test]
    public async Task RecordCombatUsage_CallsAcquisitionService();
}
```

---

## 9. Use Cases

### UC-001: Apply Proficiency Modifiers to Attack

**Actor:** Combat Service  
**Flow:** Player attacks → Get weapon category → Call `GetCombatModifiers()` → Add `AttackModifier` to roll → Add `DamageModifier` to damage → Return attack result

### UC-002: Block Special Properties for NonProficient

**Actor:** Combat Service  
**Flow:** Attack hits → Check if weapon has special properties → Call `CanUseSpecialProperties()` → If false, skip special property activation → Display blocked message

### UC-003: Check Technique Availability

**Actor:** Combat Service / Ability Service  
**Flow:** Player selects technique → Get technique requirement level → Call `CanUseTechnique()` → If false, display "Requires Expert level proficiency" → If true, execute technique

### UC-004: Record Combat Experience

**Actor:** Combat Service  
**Flow:** Attack resolves → Call `RecordCombatUsageAsync()` → Experience incremented → If level changed, display advancement message → Return result for UI

---

## 10. Deliverable Checklist

### Application Layer

- [ ] `IProficiencyCheckService.cs` interface created
- [ ] `ProficiencyCheckService.cs` implementation created
- [ ] Interface has complete XML documentation

### Domain Layer

- [ ] `CombatProficiencyModifiers.cs` value object created
- [ ] Value object has complete XML documentation

### Combat Service Integration

- [ ] `CombatService` updated to use `IProficiencyCheckService`
- [ ] Attack roll includes proficiency modifier
- [ ] Damage roll includes proficiency modifier
- [ ] Special property check implemented
- [ ] Combat experience recording called after attacks

### Testing

- [ ] `ProficiencyCheckServiceTests.cs` created
- [ ] ~2 unit tests passing

### Documentation

- [ ] `v0.16.1f-changelog.md` created

---

## 11. Acceptance Criteria

### Functional

- [ ] `GetCombatModifiers()` returns correct modifiers for each proficiency level
- [ ] NonProficient attack has -3 modifier
- [ ] NonProficient damage has -2 modifier
- [ ] Proficient attack has 0 modifier
- [ ] Expert attack has +1 modifier
- [ ] Master attack has +2 modifier, damage has +1 modifier
- [ ] `CanUseSpecialProperties()` returns false for NonProficient
- [ ] `CanUseSpecialProperties()` returns true for Proficient+
- [ ] `CanUseTechnique()` correctly checks technique access levels
- [ ] `RecordCombatUsageAsync()` awards combat experience
- [ ] Combat experience can trigger level advancement
- [ ] Combat log displays proficiency information

### Quality

- [ ] Build succeeds with 0 errors
- [ ] Build succeeds with 0 warnings
- [ ] ~2 unit tests pass
- [ ] All public types have XML documentation

---

## 12. Dependencies

### Required from v0.16.1a

| Type                         | Usage                      |
| ---------------------------- | -------------------------- |
| `WeaponProficiencyLevel`     | Used in modifiers          |
| `TechniqueAccess`            | Used in technique checking |
| `ProficiencyEffect`          | Provides modifier values   |
| `IProficiencyEffectProvider` | Gets effects for levels    |

### Required from v0.16.1b

| Type             | Usage                    |
| ---------------- | ------------------------ |
| `WeaponCategory` | Parameter for all checks |

### Required from v0.16.1d

| Type                     | Usage                      |
| ------------------------ | -------------------------- |
| `CharacterProficiencies` | Queried for current levels |

### Required from v0.16.1e

| Type                             | Usage                                |
| -------------------------------- | ------------------------------------ |
| `IProficiencyAcquisitionService` | Delegates experience recording       |
| `ProficiencyGainResult`          | Returned from combat usage recording |

---

## 13. Future Considerations

### Deferred to Future Versions

- **Technique implementations**: Basic, Advanced, and Signature techniques with actual combat effects
- **Weapon mastery system**: Additional bonuses beyond Master level for prolonged use
- **Dual-wielding proficiency**: How proficiency works with two weapons of different categories
- **Shield proficiency integration**: Special rules for shield combat (blocking, bashing)
- **Ranged proficiency penalties**: Different penalties for distance, movement, etc.
- **Mounted combat proficiency**: Weapon proficiency while mounted

### Out of Scope

- **Automatic weapon switching**: Proficiency system doesn't suggest better weapons
- **Proficiency training in combat**: Cannot gain training benefits during active combat
- **Proficiency-based critical hits**: Critical system is separate from proficiency
- **Proficiency affects initiative**: Initiative is not modified by weapon proficiency

---

_Document Version: 1.0_  
_Last Updated: 2026-01-27_  
_Author: AI Assistant_
