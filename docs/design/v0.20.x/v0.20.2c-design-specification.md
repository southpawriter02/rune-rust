# Design Specification: v0.20.2c - Tier 3 & Capstone Abilities (Rúnasmiðr)

**Version:** v0.20.2c
**Status:** Design Phase
**Last Updated:** 2026-01-28
**Target Tests:** ~7 unit and integration tests
**Specialization:** Rúnasmiðr (Runesmith)
**Theme:** Master of Runes & Dispelling Power

---

## Table of Contents

1. [Executive Summary](#1-executive-summary)
2. [Feature Overview](#2-feature-overview)
3. [Architecture Diagrams](#3-architecture-diagrams)
4. [User Stories](#4-user-stories)
5. [Domain Layer Specifications](#5-domain-layer-specifications)
6. [Application Layer Specifications](#6-application-layer-specifications)
7. [Infrastructure Layer Specifications](#7-infrastructure-layer-specifications)
8. [Master Scrivener Ability](#8-master-scrivener-ability)
9. [Living Runes Ability](#9-living-runes-ability)
10. [Word of Unmaking Ability](#10-word-of-unmaking-ability)
11. [Summoned Entity System](#11-summoned-entity-system)
12. [Dispel Mechanics](#12-dispel-mechanics)
13. [Decision Trees and Flow Diagrams](#13-decision-trees-and-flow-diagrams)
14. [Configuration Files](#14-configuration-files)
15. [Code Examples](#15-code-examples)
16. [Logging Specifications](#16-logging-specifications)
17. [Unit Testing Requirements](#17-unit-testing-requirements)
18. [Deliverable Checklist](#18-deliverable-checklist)
19. [Acceptance Criteria](#19-acceptance-criteria)
20. [Dependencies](#20-dependencies)
21. [Deferrals and Future Considerations](#21-deferrals-and-future-considerations)

---

## 1. Executive Summary

Version 0.20.2c implements the pinnacle of Rúnasmiðr mastery: the **two Tier 3 abilities** and the devastating **Capstone ultimate ability**. This phase completes the specialization with abilities representing the absolute peak of runic craftsmanship, including rune duration mastery, animated rune entities, and the power to dispel all magic in an area.

### Key Deliverables

| Category | Count | Details |
|----------|-------|---------|
| **Domain Value Objects** | 1 | LivingRuneEntity |
| **Application Services** | 1 | Tier 3 ability handlers (extensions) |
| **Ability Implementations** | 3 | Master Scrivener, Living Runes, Word of Unmaking |
| **Summoned Entity System** | 1 | Living Rune creature behavior/AI |
| **Dispel System** | 1 | Area magical effect removal |
| **Configuration Updates** | 1 | abilities.json Tier 3 + Capstone entries |
| **Unit Tests** | ~7 | Comprehensive test coverage |

### Tier 3 & Capstone Identity

| Ability | Cost | Type | Effect |
|---------|------|------|--------|
| **Master Scrivener** | Passive | Passive | Runes last 2x longer |
| **Living Runes** | 4 AP, 3 Charges | Active | Summon 2 entities (10 HP, +4 Attack, 1d8 dmg) |
| **Word of Unmaking** | 5 AP, 4 Charges | Ultimate | Dispel all magic in 4-space radius |

**Unlock Requirements:**
- Tier 3: 16 PP invested, 5 PP cost each
- Capstone: 24 PP invested, 6 PP cost

---

## 2. Feature Overview

### 2.1 Master Scrivener (Tier 3 - Passive)

**Purpose:** Extend rune durations to maximize preparation time and effect longevity.

**Key Characteristics:**
- All runes last 2x longer (duration multiplier)
- Applies to: Inscribe Rune, Empowered Inscription, Runic Traps
- Runestone Ward: No change (until destroyed)
- Living Runes: Not affected (summoned entities, not runes)
- Applies retroactively to existing runes when unlocked
- Always active when ability unlocked
- Cost: 0 AP (Passive)

**Duration Modifications:**
| Ability | Base | With Master Scrivener |
|---------|------|----------------------|
| Inscribe Rune | 10 turns | 20 turns |
| Empowered Inscription | 10 turns | 20 turns |
| Runic Trap | 1 hour | 2 hours |
| Runestone Ward | Until destroyed | Until destroyed |

### 2.2 Living Runes (Tier 3 - Active)

**Purpose:** Animate runes to become independent combat entities.

**Key Characteristics:**
- Summons 2 Living Rune entities
- Act on owner's initiative
- Each has: 10 HP, 12 Defense, +4 Attack, 1d8 damage, 4 movement
- Attack nearest enemy automatically
- Disappear when duration ends or destroyed
- Cannot be healed but can be resummoned
- Lasts 5 turns
- Cost: 4 AP, 3 Rune Charges

**Living Rune Stats:**
| Stat | Value | Notes |
|------|-------|-------|
| HP | 10 | Fixed, cannot be healed |
| Defense | 12 | Standard for rune entities |
| Attack Bonus | +4 | Moderate accuracy |
| Damage | 1d8 | Single d8 per hit |
| Movement | 4 spaces | Normal humanoid movement |
| Behavior | Aggressive | Always attacks nearest enemy |
| Appearance | Animated glyph | Translucent rune shape |

### 2.3 Word of Unmaking (Capstone - Ultimate)

**Purpose:** The ultimate dispel ability - remove ALL magic in an area.

**Key Characteristics:**
- Creates 4-space radius dispel zone
- Removes ALL magical effects (buffs and debuffs)
- Destroys summoned creatures (including own Living Runes)
- Destroys magical items' temporary enchantments
- Does not affect permanent magical properties
- Affects allies and enemies equally
- Cannot be resisted
- Once per combat
- Cost: 5 AP, 4 Rune Charges

**Effects Removed:**
- All buff status effects
- All debuff status effects
- Summoned creatures (including own)
- Temporary enchantments
- Active magical stances
- Runic traps in area
- Protective wards (including own)

---

## 3. Architecture Diagrams

### 3.1 Domain Layer - Tier 3 Objects

```
┌──────────────────────────────────────────────────────────────┐
│         v0.20.2c Rúnasmiðr Domain Layer Additions           │
├──────────────────────────────────────────────────────────────┤
│                                                               │
│  ┌────────────────────────────────────────────────┐          │
│  │ LivingRuneEntity (Summoned Creature)           │          │
│  ├────────────────────────────────────────────────┤          │
│  │ -EntityId: Guid                                │          │
│  │ -OwnerId: Guid (summoner)                      │          │
│  │ -CurrentHp: int (max 10)                       │          │
│  │ -MaxHp: int (10)                               │          │
│  │ -Defense: int (12)                             │          │
│  │ -AttackBonus: int (+4)                         │          │
│  │ -DamageDice: string ("1d8")                    │          │
│  │ -Movement: int (4 spaces)                      │          │
│  │ -Position: Position                            │          │
│  │ -TurnsRemaining: int (5 max)                   │          │
│  │ -CreatedAt: DateTime                           │          │
│  │ +TakeDamage(int): bool (destroyed?)            │          │
│  │ +Attack(targetId): AttackResult                │          │
│  │ +Move(newPosition): void                       │          │
│  │ +Tick(): void (countdown)                      │          │
│  │ +IsExpired(): bool                             │          │
│  │ +GetStatusDisplay(): string                    │          │
│  └────────────────────────────────────────────────┘          │
│                                                               │
│  ┌──────────────────────────────────────────────┐            │
│  │ DispelEffectResult (Value Object)            │            │
│  ├──────────────────────────────────────────────┤            │
│  │ -EffectsRemoved: List<string>                │            │
│  │ -EntitiesDestroyed: List<Guid>               │            │
│  │ -ItemsAffected: List<Guid>                   │            │
│  │ -AffectedCharacters: List<Guid>              │            │
│  │ -TotalEffectsDispelled: int                  │            │
│  └──────────────────────────────────────────────┘            │
│                                                               │
└──────────────────────────────────────────────────────────────┘
```

### 3.2 Application Layer - Tier 3 Services

```
┌──────────────────────────────────────────────────────────────┐
│         v0.20.2c Application Layer Extensions                │
├──────────────────────────────────────────────────────────────┤
│                                                               │
│  IRúnasmiðrAbilityService (extended from v0.20.2a/2b)        │
│  ┌──────────────────────────────────────────────────────┐    │
│  │ + ExecuteLivingRunes(charId): AbilityExecutionResult │    │
│  │ + ExecuteWordOfUnmaking(charId, position):           │    │
│  │     AbilityExecutionResult                           │    │
│  │ + GetActiveLivingRunes(charId):                      │    │
│  │     IReadOnlyList<LivingRuneEntity>                  │    │
│  │ + HasUsedWordOfUnmaking(charId, combatId): bool      │    │
│  │ + RollbackWordOfUnmakingCooldown(charId, combatId)   │    │
│  └──────────────────────────────────────────────────────┘    │
│                              │                                │
│  IMasterScrivenerService (new integration)                   │
│  ┌──────────────────────────────────────────────────────┐    │
│  │ + ApplyDurationMultiplier(duration): int (2x)        │    │
│  │ + HasMasterScrivener(charId): bool                   │    │
│  │ + ApplyRetroactivelyToExisting(charId): void         │    │
│  └──────────────────────────────────────────────────────┘    │
│                              │                                │
│  ILivingRuneAIEngine (new service)                           │
│  ┌──────────────────────────────────────────────────────┐    │
│  │ + SelectTarget(entity, enemies): Guid               │    │
│  │ + ComputeAttack(attacker, defender): AttackResult   │    │
│  │ + ExecuteMovement(entity, position): void           │    │
│  │ + OnTurnStart(entity): void                          │    │
│  └──────────────────────────────────────────────────────┘    │
│                              │                                │
│  IDispelService (new service)                                │
│  ┌──────────────────────────────────────────────────────┐    │
│  │ + DispelAreaEffects(position, radius):               │    │
│  │     DispelEffectResult                               │    │
│  │ + RemoveAllBuffs(charId): void                       │    │
│  │ + RemoveAllDebuffs(charId): void                     │    │
│  │ + DestroySummonedEntities(position, radius): void    │    │
│  │ + DestroyTemporaryEnchantments(position, radius):    │    │
│  │     void                                             │    │
│  └──────────────────────────────────────────────────────┘    │
│                              │                                │
│  Implementation Classes                                       │
│  ├── MasterScrivenerIntegration                              │
│  ├── LivingRunesHandler                                      │
│  ├── LivingRuneAIEngine                                      │
│  ├── WordOfUnmakingHandler                                   │
│  └── DispelServiceImpl                                        │
│                                                               │
└──────────────────────────────────────────────────────────────┘
```

### 3.3 Combat Flow Integration

```
Living Runes Combat Flow:

┌────────────────────────┐
│ Summon Living Runes    │
└─────────┬──────────────┘
          │
          ▼
┌────────────────────────────────────┐
│ Create 2 LivingRuneEntity objects   │
│ Position at summoner's location     │
│ Set TurnsRemaining = 5              │
└─────────┬──────────────────────────┘
          │
          ▼
┌────────────────────────────────────┐
│ Add to initiative on owner's turn   │
│ Runes act immediately after owner   │
└─────────┬──────────────────────────┘
          │
          ├─────────────────────────────────────────┐
          │                                         │
    (Each Turn)                              (Each Turn)
          │                                         │
          ▼                                         ▼
    ┌──────────────┐                    ┌────────────────┐
    │ Owner's turn │                    │ Runes' turn    │
    └──────┬───────┘                    ├────────────────┤
           │                            │ Select target  │
           ▼                            │ (nearest enemy)│
    [Owner takes actions]                │ Attack roll    │
                                         │ Damage dealt   │
                                         │ Move 4 spaces  │
                                         │ Tick counter   │
                                         └────────┬───────┘
                                                  │
                                    ┌─────────────┴─────────────┐
                                    │                           │
                            (TurnsRemaining > 0)   (TurnsRemaining = 0)
                                    │                           │
                                    ▼                           ▼
                          ┌──────────────────┐      ┌──────────────────┐
                          │ Continue combat  │      │ Rune disappears  │
                          │ (next round)     │      │ Despawn entity   │
                          └──────────────────┘      └──────────────────┘
```

---

## 4. User Stories

### User Story 1: Runesmith Extends Rune Duration

**As a** Rúnasmiðr character in a longer dungeon expedition
**I want to** make my runes last twice as long
**So that** I can maintain protection and enhancements for extended periods

**Acceptance Criteria:**
- Character must have unlocked Master Scrivener (5 PP cost, 16 PP requirement)
- Inscribe Rune: 10 turns → 20 turns
- Empowered Inscription: 10 turns → 20 turns
- Runic Trap: 1 hour → 2 hours
- Runestone Ward: No change (already permanent until destroyed)
- Living Runes: Not affected (only active 5 turns by design)
- Applies to runes inscribed before and after unlock
- Passive activation when unlocked

### User Story 2: Runesmith Summons Animated Runes

**As a** Rúnasmiðr character in intense combat
**I want to** animate my runes into independent fighters
**So that** I can overwhelm enemies with summoned allies

**Acceptance Criteria:**
- Ability costs 4 AP and 3 Rune Charges
- Summons exactly 2 Living Rune entities
- Each entity has 10 HP, 12 Defense, +4 Attack, 1d8 damage
- Entities act on owner's initiative (same turn, after owner)
- Each entity attacks nearest enemy automatically
- Entities last 5 turns maximum
- Cannot be healed (destroyed = gone)
- Can be resummoned after expiration
- Displays clear status: "Living Runes: 1/2 active"

### User Story 3: Runesmith Casts Ultimate Dispel

**As a** Rúnasmiðr character facing a magically-enhanced enemy group
**I want to** remove all magical effects in a large area
**So that** I can level the playing field and nullify enemy buffs

**Acceptance Criteria:**
- Ability costs 5 AP and 4 Rune Charges
- Affects 4-space radius area around caster
- Removes ALL magical effects (buffs, debuffs, enchantments)
- Destroys summoned creatures including own Living Runes
- Destroys temporary magical enchantments
- Does NOT affect permanent magical properties
- Cannot be resisted or saved against
- Affects allies and enemies equally
- Usable once per combat (cooldown resets per combat)
- Clear notification: "Word of Unmaking cast - all magic in area dispelled"

### User Story 4: Player Manages Living Rune Summons

**As a** player controlling summoned Living Runes
**I want to** see clear status of my summons and their behavior
**So that** I can coordinate with them and plan tactics

**Acceptance Criteria:**
- Living Runes show HP bar in combat display
- Movement paths visible on tactical map
- Attack targets clearly indicated
- Turn countdown displayed ("3 turns remaining")
- Automatic target selection visible to player
- Can dismiss summons early if desired
- Death of Living Rune provides notification

---

## 5. Domain Layer Specifications

### 5.1 LivingRuneEntity Value Object

**Purpose:** Represents an animated rune summoned to fight in combat.

**Properties:**
- `EntityId: Guid` - Unique identifier
- `OwnerId: Guid` - Character who summoned it
- `CurrentHp: int` - Current health (0-10)
- `MaxHp: int` - Always 10
- `Defense: int` - Always 12
- `AttackBonus: int` - Always +4
- `DamageDice: string` - Always "1d8"
- `Movement: int` - Always 4 spaces
- `Position: Position` - Current X, Y, Z location
- `TurnsRemaining: int` - Countdown to despawn
- `CreatedAt: DateTime` - Summoning time
- `IsActive: bool` - Still in combat

**Methods:**

```csharp
/// <summary>
/// Applies damage to the Living Rune.
/// </summary>
/// <param name="damage">Damage amount</param>
/// <returns>True if this destruction killed the rune</returns>
public bool TakeDamage(int damage)
{
    CurrentHp = Math.Max(0, CurrentHp - damage);
    return IsDestroyed();
}

/// <summary>
/// Determines if the Living Rune is destroyed.
/// </summary>
public bool IsDestroyed() => CurrentHp <= 0;

/// <summary>
/// Performs an attack on the target.
/// </summary>
/// <param name="targetId">Creature to attack</param>
/// <returns>Result including hit/miss and damage</returns>
public AttackResult Attack(Guid targetId)
{
    var attackRoll = DiceRoller.RollD20() + AttackBonus;
    var damageRoll = new DiceRoll("1d8");

    return new AttackResult(
        attackRoll: attackRoll,
        damageRoll: damageRoll,
        targetId: targetId,
        source: $"Living Rune ({OwnerId})");
}

/// <summary>
/// Moves the entity to a new position.
/// </summary>
public void Move(Position newPosition)
{
    if (CanReach(newPosition))
        Position = newPosition;
}

/// <summary>
/// Checks if entity can reach a position within movement.
/// </summary>
private bool CanReach(Position target) =>
    ManhattanDistance(Position, target) <= Movement;

/// <summary>
/// Advances the rune's countdown by one turn.
/// </summary>
public void Tick()
{
    if (TurnsRemaining > 0)
        TurnsRemaining--;

    if (TurnsRemaining <= 0)
        IsActive = false;
}

/// <summary>
/// Determines if the Living Rune has expired naturally.
/// </summary>
public bool IsExpired() => TurnsRemaining <= 0 && !IsDestroyed();

/// <summary>
/// Gets human-readable status display (e.g., "Living Rune: 8/10 HP, 3 turns").
/// </summary>
public string GetStatusDisplay()
{
    var hpBar = GetHpBar(10);
    return $"Living Rune {hpBar} {CurrentHp}/10 HP ({TurnsRemaining} turns)";
}

private string GetHpBar(int width = 10)
{
    int filled = (int)Math.Ceiling((double)CurrentHp / MaxHp * width);
    return new string('█', filled) + new string('░', width - filled);
}

/// <summary>
/// Gets average damage per attack (1d8 ≈ 4.5).
/// </summary>
public decimal GetAverageDamage() => 4.5m;
```

### 5.2 DispelEffectResult Value Object

**Purpose:** Reports the results of a dispel action.

**Properties:**
- `EffectsRemoved: List<string>` - Names of effects removed
- `EntitiesDestroyed: List<Guid>` - IDs of summoned entities destroyed
- `ItemsAffected: List<Guid>` - IDs of items with enchantments removed
- `AffectedCharacters: List<Guid>` - IDs of affected characters
- `TotalEffectsDispelled: int` - Count of effects removed
- `CreatedAt: DateTime` - When dispel occurred

**Methods:**

```csharp
/// <summary>
/// Gets a summary display of dispel results.
/// </summary>
public string GetSummaryDisplay()
{
    var sb = new StringBuilder();
    sb.AppendLine($"Word of Unmaking: Dispelled {TotalEffectsDispelled} effects");
    sb.AppendLine($"  - Effects removed: {string.Join(", ", EffectsRemoved.Take(5))}");
    sb.AppendLine($"  - Entities destroyed: {EntitiesDestroyed.Count}");
    sb.AppendLine($"  - Characters affected: {AffectedCharacters.Count}");
    return sb.ToString();
}

/// <summary>
/// Checks if any entities were destroyed by the dispel.
/// </summary>
public bool DestoyedEntities() => EntitiesDestroyed.Count > 0;
```

---

## 6. Application Layer Specifications

### 6.1 MasterScrivenerIntegration

```csharp
/// <summary>
/// Integrates Master Scrivener passive ability with rune systems.
/// </summary>
public class MasterScrivenerIntegration : IRuneDurationModifier
{
    private readonly ICharacterRepository _characterRepository;
    private readonly ILogger _logger;

    public int ModifyRuneDuration(Guid characterId, int baseDuration)
    {
        var character = _characterRepository.GetById(characterId);

        if (!HasMasterScrivener(character))
            return baseDuration;

        // Apply 2x multiplier
        var modifiedDuration = baseDuration * 2;

        _logger.LogDebug(
            $"Master Scrivener applied to rune for {characterId}. " +
            $"Duration: {baseDuration} → {modifiedDuration}");

        return modifiedDuration;
    }

    public decimal GetDurationMultiplier() => 2.0m;

    private bool HasMasterScrivener(Character character)
    {
        return character?.Specialization?.AbilityTree
            ?.GetUnlockedAbilities()
            ?.Contains(RunasmidrAbilityId.MasterScrivener) ?? false;
    }
}
```

### 6.2 LivingRunesHandler

```csharp
/// <summary>
/// Handler for Living Runes ability execution.
/// </summary>
public class LivingRunesHandler : IAbilityHandler
{
    private readonly ICharacterRepository _characterRepository;
    private readonly IRuneChargeService _runeChargeService;
    private readonly ILivingRuneRepository _livingRuneRepository;
    private readonly IInitiativeTracker _initiativeTracker;
    private readonly ILogger _logger;

    public LivingRunesHandler(
        ICharacterRepository characterRepository,
        IRuneChargeService runeChargeService,
        ILivingRuneRepository livingRuneRepository,
        IInitiativeTracker initiativeTracker,
        ILogger logger)
    {
        _characterRepository = characterRepository;
        _runeChargeService = runeChargeService;
        _livingRuneRepository = livingRuneRepository;
        _initiativeTracker = initiativeTracker;
        _logger = logger;
    }

    /// <summary>
    /// Executes Living Runes ability.
    /// </summary>
    /// <remarks>
    /// XML Documentation for Living Runes:
    /// - Summons 2 Living Rune entities at summoner's position
    /// - Each has 10 HP, 12 Defense, +4 Attack, 1d8 damage
    /// - Movement: 4 spaces per turn
    /// - Behavior: Attack nearest enemy automatically
    /// - Duration: 5 turns
    /// - Act on owner's initiative
    /// - Cannot be healed, can be resummoned after expiration
    /// - Cost: 4 AP, 3 Rune Charges
    /// - Requires 5 PP to unlock (Tier 3 ability)
    /// </remarks>
    public AbilityExecutionResult Execute(AbilityExecutionContext context)
    {
        if (context == null)
            throw new ArgumentNullException(nameof(context));

        var character = _characterRepository.GetById(context.CharacterId);
        if (character == null)
            return new AbilityExecutionResult(success: false, message: "Character not found");

        // Check Rune Charges (need 3)
        if (!_runeChargeService.CanAfford(context.CharacterId, 3))
        {
            _logger.LogWarning($"Character {context.CharacterId} lacks rune charges for Living Runes");
            return new AbilityExecutionResult(
                success: false,
                message: "Insufficient Rune Charges (need 3)");
        }

        // Spend Rune Charges
        if (!_runeChargeService.TrySpend(context.CharacterId, 3))
            return new AbilityExecutionResult(success: false, message: "Failed to spend Rune Charges");

        // Create 2 Living Rune entities
        var runes = new List<LivingRuneEntity>();
        for (int i = 0; i < 2; i++)
        {
            var rune = new LivingRuneEntity(
                entityId: Guid.NewGuid(),
                ownerId: context.CharacterId,
                currentHp: 10,
                maxHp: 10,
                defense: 12,
                attackBonus: 4,
                damageDice: "1d8",
                movement: 4,
                position: character.Position,
                turnsRemaining: 5,
                createdAt: DateTime.UtcNow);

            runes.Add(rune);
            _livingRuneRepository.Add(rune);
        }

        // Add to initiative immediately after owner
        foreach (var rune in runes)
        {
            _initiativeTracker.AddEntity(rune, context.CharacterId);
        }

        _logger.LogInfo(
            $"Character {context.CharacterId} summoned 2 Living Runes. " +
            $"Duration: 5 turns. Position: {character.Position}");

        return new AbilityExecutionResult(
            success: true,
            message: $"Summoned 2 Living Runes (10/10 HP each, 5 turns). " +
                     $"They will attack the nearest enemy each turn.",
            resourcesSpent: new Dictionary<string, int> { { "rune-charges", 3 } });
    }
}
```

### 6.3 LivingRuneAIEngine

```csharp
/// <summary>
/// AI engine for Living Rune combat behavior.
/// </summary>
public class LivingRuneAIEngine
{
    private readonly ICombatService _combatService;
    private readonly IPositionService _positionService;
    private readonly ILogger _logger;

    /// <summary>
    /// Executes one turn of Living Rune behavior.
    /// </summary>
    public void ExecuteTurn(LivingRuneEntity rune, List<Character> enemies)
    {
        if (rune.IsDestroyed() || rune.IsExpired())
            return;

        // Select target (nearest enemy)
        var target = SelectTarget(rune, enemies);

        if (target == null)
        {
            _logger.LogDebug($"Living Rune {rune.EntityId}: No valid targets");
            rune.Tick();
            return;
        }

        // Move toward target if not adjacent
        if (!IsAdjacent(rune.Position, target.Position))
        {
            MoveTowardTarget(rune, target);
        }

        // Attack target
        var attackResult = rune.Attack(target.Id);

        if (attackResult.Hit)
        {
            var damage = _combatService.RollDamage(attackResult.DamageRoll);
            _combatService.DealDamage(target.Id, damage, DamageType.Physical, "Living Rune");

            _logger.LogInfo(
                $"Living Rune {rune.EntityId} attacks {target.Name} for {damage} damage. " +
                $"Target HP: {target.CurrentHp - damage}/{target.MaxHp}");
        }
        else
        {
            _logger.LogInfo($"Living Rune {rune.EntityId} misses attack on {target.Name}");
        }

        // Advance countdown
        rune.Tick();
    }

    /// <summary>
    /// Selects the nearest enemy target.
    /// </summary>
    private Character SelectTarget(LivingRuneEntity rune, List<Character> enemies)
    {
        if (!enemies.Any())
            return null;

        return enemies
            .OrderBy(e => ManhattanDistance(rune.Position, e.Position))
            .FirstOrDefault();
    }

    /// <summary>
    /// Moves the rune toward the target.
    /// </summary>
    private void MoveTowardTarget(LivingRuneEntity rune, Character target)
    {
        var path = _positionService.FindPath(rune.Position, target.Position, rune.Movement);

        if (path.Count > 0)
        {
            rune.Move(path.Last());
            _logger.LogDebug($"Living Rune {rune.EntityId} moves toward {target.Name}");
        }
    }

    private bool IsAdjacent(Position from, Position to) =>
        ManhattanDistance(from, to) == 1;

    private int ManhattanDistance(Position from, Position to) =>
        Math.Abs(from.X - to.X) + Math.Abs(from.Y - to.Y) + Math.Abs(from.Z - to.Z);
}
```

### 6.4 WordOfUnmakingHandler & DispelService

```csharp
/// <summary>
/// Handler for Word of Unmaking ultimate ability.
/// </summary>
public class WordOfUnmakingHandler : IAbilityHandler
{
    private readonly ICharacterRepository _characterRepository;
    private readonly IRuneChargeService _runeChargeService;
    private readonly IDispelService _dispelService;
    private readonly ICombatTracker _combatTracker;
    private readonly ILogger _logger;

    /// <summary>
    /// Executes Word of Unmaking ability.
    /// </summary>
    /// <remarks>
    /// XML Documentation for Word of Unmaking:
    /// - Speak the Word of Unmaking, dispelling ALL magical effects
    /// - Range: 4-space radius centered on caster
    /// - Affects all creatures in radius (allies and enemies equally)
    /// - Removes: all buffs, all debuffs, summons, temporary enchantments
    /// - Ignores: permanent magical properties
    /// - Cannot be resisted or saved against
    /// - Usable once per combat (cooldown resets between combats)
    /// - Cost: 5 AP, 4 Rune Charges
    /// - Requires 6 PP to unlock (Capstone ability)
    /// </remarks>
    public AbilityExecutionResult Execute(AbilityExecutionContext context)
    {
        if (context == null)
            throw new ArgumentNullException(nameof(context));

        var character = _characterRepository.GetById(context.CharacterId);
        if (character == null)
            return new AbilityExecutionResult(success: false, message: "Character not found");

        // Check if already used in this combat
        var currentCombat = _combatTracker.GetCurrentCombat();
        if (currentCombat != null && HasUsedWordOfUnmaking(context.CharacterId, currentCombat.Id))
        {
            return new AbilityExecutionResult(
                success: false,
                message: "Word of Unmaking already used this combat");
        }

        // Check Rune Charges (need 4)
        if (!_runeChargeService.CanAfford(context.CharacterId, 4))
        {
            _logger.LogWarning($"Character {context.CharacterId} lacks rune charges for Word of Unmaking");
            return new AbilityExecutionResult(
                success: false,
                message: "Insufficient Rune Charges (need 4)");
        }

        // Spend Rune Charges
        if (!_runeChargeService.TrySpend(context.CharacterId, 4))
            return new AbilityExecutionResult(success: false, message: "Failed to spend Rune Charges");

        // Execute dispel
        var dispelResult = _dispelService.DispelAreaEffects(
            centerPosition: character.Position,
            radius: 4);

        // Record usage for cooldown tracking
        if (currentCombat != null)
        {
            RecordWordOfUnmakingUsage(context.CharacterId, currentCombat.Id);
        }

        _logger.LogInfo(
            $"Character {context.CharacterId} cast Word of Unmaking. " +
            $"Dispelled {dispelResult.TotalEffectsDispelled} effects. " +
            $"Destroyed {dispelResult.EntitiesDestroyed.Count} entities. " +
            $"Affected {dispelResult.AffectedCharacters.Count} characters.");

        return new AbilityExecutionResult(
            success: true,
            message: dispelResult.GetSummaryDisplay(),
            resourcesSpent: new Dictionary<string, int> { { "rune-charges", 4 } });
    }

    private bool HasUsedWordOfUnmaking(Guid characterId, Guid combatId)
    {
        // Check if character has already used ability in this combat
        return _combatTracker.GetAbilityUseCount(characterId, "word-of-unmaking", combatId) > 0;
    }

    private void RecordWordOfUnmakingUsage(Guid characterId, Guid combatId)
    {
        _combatTracker.RecordAbilityUse(characterId, "word-of-unmaking", combatId);
    }
}

/// <summary>
/// Service for dispelling magical effects.
/// </summary>
public class DispelServiceImpl : IDispelService
{
    private readonly ICharacterRepository _characterRepository;
    private readonly ILivingRuneRepository _livingRuneRepository;
    private readonly ITrapRepository _trapRepository;
    private readonly IStatusEffectService _statusEffectService;
    private readonly ILogger _logger;

    public DispelEffectResult DispelAreaEffects(Position centerPosition, int radius)
    {
        var result = new DispelEffectResult();

        // Find all affected characters
        var affectedCharacters = _characterRepository.GetInRadius(centerPosition, radius);

        foreach (var character in affectedCharacters)
        {
            // Remove all buffs
            foreach (var buff in character.ActiveBuffs)
            {
                _statusEffectService.RemoveEffect(character.Id, buff.EffectId);
                result.EffectsRemoved.Add(buff.EffectName);
            }

            // Remove all debuffs
            foreach (var debuff in character.ActiveDebuffs)
            {
                _statusEffectService.RemoveEffect(character.Id, debuff.EffectId);
                result.EffectsRemoved.Add(debuff.EffectName);
            }

            result.AffectedCharacters.Add(character.Id);
        }

        // Destroy summoned entities
        var summonedInRadius = _livingRuneRepository.GetInRadius(centerPosition, radius)
            .Where(e => !e.IsDestroyed())
            .ToList();

        foreach (var entity in summonedInRadius)
        {
            entity.TakeDamage(entity.CurrentHp); // Kill them
            _livingRuneRepository.Update(entity);
            result.EntitiesDestroyed.Add(entity.EntityId);
            result.EffectsRemoved.Add($"Destroyed {entity.GetStatusDisplay()}");
        }

        // Destroy traps in radius
        var trapsInRadius = _trapRepository.GetInRadius(centerPosition, radius)
            .Where(t => !t.IsTriggered)
            .ToList();

        foreach (var trap in trapsInRadius)
        {
            trap.Trigger(Guid.Empty); // Force trigger with empty target
            _trapRepository.Update(trap);
            result.EffectsRemoved.Add("Dispelled runic trap");
        }

        // Remove temporary enchantments
        var itemsInRadius = _characterRepository.GetItemsInRadius(centerPosition, radius);
        foreach (var item in itemsInRadius)
        {
            if (item.HasTemporaryEnchantment)
            {
                item.RemoveTemporaryEnchantment();
                result.ItemsAffected.Add(item.Id);
                result.EffectsRemoved.Add($"Removed enchantment from {item.ItemName}");
            }
        }

        result.TotalEffectsDispelled = result.EffectsRemoved.Count;

        _logger.LogInfo($"Word of Unmaking dispelled {result.TotalEffectsDispelled} effects in {radius}-space radius");

        return result;
    }
}
```

---

## 7. Infrastructure Layer Specifications

### 7.1 abilities.json Update (Tier 3 & Capstone)

```json
{
    "abilities": [
        {
            "abilityId": "master-scrivener",
            "displayName": "Master Scrivener",
            "specializationId": "Runasmidr",
            "tier": 3,
            "type": "Passive",
            "apCost": 0,
            "resourceCost": null,
            "ppCost": 5,
            "ppPrerequisite": 16,
            "description": "Your runes are inscribed with such precision that they last twice as long. Applies retroactively to existing runes.",
            "requirements": {
                "specialization": "Runasmidr",
                "ppInvested": 16
            },
            "effects": [
                {
                    "type": "RuneDurationMultiplier",
                    "multiplier": 2.0,
                    "appliesTo": ["InscribeRune", "EmpoweredInscription", "RunicTrap"],
                    "excludes": ["RunestoneWard", "LivingRunes"]
                }
            ],
            "tags": ["passive", "duration", "mastery", "tier3"]
        },
        {
            "abilityId": "living-runes",
            "displayName": "Living Runes",
            "specializationId": "Runasmidr",
            "tier": 3,
            "type": "Active",
            "apCost": 4,
            "resourceCost": {
                "resourceId": "rune-charges",
                "amount": 3
            },
            "duration": 5,
            "durationUnit": "Turns",
            "ppCost": 5,
            "ppPrerequisite": 16,
            "description": "Summon 2 Living Rune entities that attack the nearest enemy each turn. Each has 10 HP, +4 Attack, deals 1d8 damage. They act on your initiative.",
            "requirements": {
                "specialization": "Runasmidr",
                "resourceAvailable": "rune-charges:3",
                "ppInvested": 16
            },
            "effects": [
                {
                    "type": "SummonEntity",
                    "entityType": "LivingRune",
                    "count": 2,
                    "duration": 5,
                    "stats": {
                        "hp": 10,
                        "defense": 12,
                        "attackBonus": 4,
                        "damage": "1d8",
                        "movement": 4,
                        "behavior": "Aggressive"
                    }
                }
            ],
            "tags": ["summon", "combat", "tier3"]
        },
        {
            "abilityId": "word-of-unmaking",
            "displayName": "Word of Unmaking",
            "specializationId": "Runasmidr",
            "tier": "capstone",
            "type": "Ultimate",
            "apCost": 5,
            "resourceCost": {
                "resourceId": "rune-charges",
                "amount": 4
            },
            "range": 4,
            "rangeType": "Radius",
            "cooldown": {
                "type": "PerCombat",
                "uses": 1
            },
            "ppCost": 6,
            "ppPrerequisite": 24,
            "description": "Speak the Word of Unmaking, dispelling ALL magical effects within 4 spaces. Affects allies and enemies equally. Destroys summons and temporary enchantments. Cannot be resisted. Usable once per combat.",
            "requirements": {
                "specialization": "Runasmidr",
                "resourceAvailable": "rune-charges:4",
                "ppInvested": 24
            },
            "effects": [
                {
                    "type": "DispelArea",
                    "radius": 4,
                    "targetsAllies": true,
                    "targetsEnemies": true,
                    "destroysSummons": true,
                    "destroysTemporaryEnchantments": true,
                    "affectsWards": true,
                    "affectsTraps": true,
                    "resisted": false
                }
            ],
            "cooldown": {
                "type": "PerCombat",
                "maxUses": 1
            },
            "tags": ["ultimate", "dispel", "aoe", "capstone"]
        }
    ]
}
```

---

## 8. Master Scrivener Ability

### 8.1 Duration Mechanics

**Duration Multiplier Application:**
- All rune-type abilities: 2x duration
- Non-rune abilities: No change
- Living Runes: Not affected (fixed 5-turn duration)
- Runestone Ward: No change (persists until destroyed)

**Examples:**
- Inscribe Rune: 10 → 20 turns (2 full combat rounds)
- Empowered Inscription: 10 → 20 turns
- Runic Trap: 1 hour → 2 hours (extended dungeon coverage)

---

## 9. Living Runes Ability

### 9.1 Entity Stats & Behavior

**Stats (per entity):**
| Stat | Value |
|------|-------|
| HP | 10 (fixed) |
| Defense | 12 |
| Attack Bonus | +4 |
| Damage | 1d8 (average 4.5) |
| Movement | 4 spaces/turn |
| Behavior | Always attacks nearest enemy |

**Behavior Rules:**
- Act immediately after owner's turn (same initiative)
- Select target: Nearest visible enemy
- Attack priority: Any enemy > no enemy
- Movement: Toward target if not adjacent
- Attack: If adjacent to target
- Tick: Decrement TurnsRemaining each turn
- Despawn: When TurnsRemaining = 0 or destroyed

---

## 10. Word of Unmaking Ability

### 10.1 Dispel Mechanics

**Effects Removed:**
- All buff effects (positive status effects)
- All debuff effects (negative status effects)
- All active stances (magical only)
- Temporary enchantments on items
- Runic traps in radius

**Entities Destroyed:**
- Summoned creatures (including own Living Runes)
- Cannot destroy constructs with permanent magic

**Unaffected:**
- Permanent magical properties
- Innate magical abilities
- Passive effects
- Non-magical buffs/debuffs

---

## 11. Summoned Entity System

### 11.1 Initiative Integration

Living Runes are added to initiative after their owner's turn:

```
Initiative Order Example:
1. Enemy A (Goblin) - rolls initiative
2. Character (Rúnasmiðr) - rolls initiative
   └─ Living Rune 1 (acts immediately after)
   └─ Living Rune 2 (acts immediately after)
3. Enemy B (Wizard) - rolls initiative
```

### 11.2 Combat Lifecycle

```
Turn Start: Check Living Rune conditions
├─ Is destroyed? → Remove from combat
├─ Is expired (0 turns)? → Despawn
└─ Is active? → Execute turn:
    ├─ Select target
    ├─ Move (if needed)
    ├─ Attack (if adjacent)
    ├─ Tick countdown
    └─ Return status

End of Combat: Automatically despawn all Living Runes
```

---

## 12. Dispel Mechanics

### 12.1 Dispel Resolution

```
Word of Unmaking cast at Position X, Radius 4

1. Find all creatures in radius
   ├─ Allies: Remove all buffs/debuffs
   └─ Enemies: Remove all buffs/debuffs

2. Find all summoned entities in radius
   └─ Destroy all summons (reduce to 0 HP)

3. Find all traps in radius
   └─ Trigger/destroy all traps

4. Find all items with temporary enchantments
   └─ Remove temporary enchantments

5. Report results:
   ├─ Total effects dispelled: X
   ├─ Entities destroyed: Y
   ├─ Characters affected: Z
   └─ Items affected: W
```

---

## 13. Decision Trees and Flow Diagrams

### 13.1 Living Runes Execution Flow

```
┌────────────────────────────┐
│ Cast Living Runes          │
└─────────┬──────────────────┘
          │
          ▼
┌────────────────────────────────────┐
│ Check: 3+ Rune Charges             │
└──────────┬─────────────┬───────────┘
    YES    │             │    NO
           │             │
           ▼             ▼
    ┌────────────────┐  FAIL
    │ Spend 3        │
    │ Charges        │
    └─────┬──────────┘
          │
          ▼
┌─────────────────────────────────┐
│ Create 2 LivingRuneEntity objs   │
│ Position: summoner's location    │
│ Stats: 10 HP, 12 DEF, +4 ATK     │
│ Turns: 5                         │
└─────────┬───────────────────────┘
          │
          ▼
┌─────────────────────────────────┐
│ Add to initiative tracker        │
│ (after owner's initiative)       │
└─────────┬───────────────────────┘
          │
          ▼
┌─────────────────────────────────┐
│ Log action & display result     │
│ Show: "Living Runes: 2/2 active"│
│ Display: "5 turns remaining"    │
└─────────────────────────────────┘
```

### 13.2 Word of Unmaking Resolution Flow

```
┌────────────────────────────┐
│ Cast Word of Unmaking      │
└─────────┬──────────────────┘
          │
          ▼
┌──────────────────────────────────┐
│ Check: 4+ Rune Charges           │
└──────────┬────────────┬──────────┘
    YES    │            │    NO
           │            │
           ▼            ▼
    ┌──────────────┐   FAIL
    │ Check combat │
    │ cooldown     │
    └──────┬───────┘
           │
           ▼
┌──────────────────────────────────┐
│ Already used Word of Unmaking?   │
└──────────┬────────────┬──────────┘
    NO     │            │    YES
           │            │
           ▼            ▼
    ┌──────────────┐   FAIL
    │ Spend 4      │
    │ Charges      │
    └──────┬───────┘
           │
           ▼
┌──────────────────────────────────┐
│ Find affected creatures (R=4)    │
├──────────────────────────────────┤
│ ├─ Remove all buffs              │
│ ├─ Remove all debuffs            │
│ └─ Report affects               │
└──────────┬───────────────────────┘
           │
           ▼
┌──────────────────────────────────┐
│ Find summoned entities (R=4)     │
├──────────────────────────────────┤
│ ├─ Kill all summons              │
│ └─ Report destroyed             │
└──────────┬───────────────────────┘
           │
           ▼
┌──────────────────────────────────┐
│ Find traps & items (R=4)         │
├──────────────────────────────────┤
│ ├─ Trigger/destroy traps         │
│ ├─ Remove enchantments           │
│ └─ Report affected              │
└──────────┬───────────────────────┘
           │
           ▼
┌──────────────────────────────────┐
│ Record cooldown usage            │
│ Log comprehensive results        │
│ Display summary notification     │
└──────────────────────────────────┘
```

---

## 14. Configuration Files

### 14.1 specializations.json Final Update

```json
{
    "specializations": [
        {
            "specializationId": "Runasmidr",
            "abilityTiers": [
                {
                    "tier": 1,
                    "ppRequirement": 0,
                    "abilityCost": 0,
                    "abilities": ["inscribe-rune", "read-the-marks", "runestone-ward"]
                },
                {
                    "tier": 2,
                    "ppRequirement": 8,
                    "abilityCost": 4,
                    "abilities": ["empowered-inscription", "runic-trap", "dvergr-techniques"]
                },
                {
                    "tier": 3,
                    "ppRequirement": 16,
                    "abilityCost": 5,
                    "abilities": ["master-scrivener", "living-runes"]
                },
                {
                    "tier": "capstone",
                    "ppRequirement": 24,
                    "abilityCost": 6,
                    "abilities": ["word-of-unmaking"]
                }
            ]
        }
    ]
}
```

---

## 15. Code Examples

### 15.1 Complete Living Runes Handler

See section 6.2 for full implementation.

### 15.2 Living Rune AI Turn Execution

```csharp
// Example: Living Rune takes its turn
var livingRune = _livingRuneRepository.GetById(rune1Id);
var enemies = _combatService.GetEnemies(livingRune.OwnerId, livingRune.Position, radius: 10);

// AI Engine handles all behavior
_aiEngine.ExecuteTurn(livingRune, enemies);

// Output:
// Living Rune selects Goblin as nearest enemy
// Moves 3 spaces closer (1 move remaining)
// Attacks Goblin: Rolls 14 + 4 = 18 vs AC 14 = HIT
// Deals 1d8 damage (rolled 6) = 6 damage
// Countdown: 5 → 4 turns remaining
```

---

## 16. Logging Specifications

### Log Events

**Master Scrivener Applied:**
```
[DEBUG] Master Scrivener applied to rune. Duration: {base} → {modified}
```

**Living Runes Summoned:**
```
[INFO] Character {characterId} summoned 2 Living Runes.
       Duration: 5 turns. Position: {position}
```

**Living Rune Attack:**
```
[INFO] Living Rune {runeId} attacks {targetName} for {damage} damage.
       Target HP: {currentHp}/{maxHp}
```

**Living Rune Despawn:**
```
[INFO] Living Rune {runeId} despawned (0 turns remaining)
```

**Word of Unmaking Cast:**
```
[INFO] Character {characterId} cast Word of Unmaking.
       Dispelled {totalEffects} effects. Destroyed {entities} entities.
       Affected {characters} characters.
```

**Word of Unmaking Cooldown:**
```
[WARN] Character {characterId} attempted Word of Unmaking but already used this combat
```

---

## 17. Unit Testing Requirements

### 17.1 Tier 3 & Capstone Tests (~7 tests)

```csharp
[TestFixture]
public class Tier3AndCapstoneTests
{
    [Test]
    public void MasterScrivener_DoublesRuneDuration()
    {
        // Test all affected abilities have 2x duration
    }

    [Test]
    public void LivingRunes_SummonsTwoEntities()
    {
        // Test exactly 2 runes created
    }

    [Test]
    public void LivingRunes_EntitiesHaveCorrectStats()
    {
        // Test 10 HP, 12 DEF, +4 ATK, 1d8 damage
    }

    [Test]
    public void LivingRunes_AttackNearestEnemy()
    {
        // Test AI selects correct target
    }

    [Test]
    public void WordOfUnmaking_DispelsAllEffects()
    {
        // Test all buffs/debuffs removed
    }

    [Test]
    public void WordOfUnmaking_AffectsAlliesAndEnemies()
    {
        // Test both friend and foe affected
    }

    [Test]
    public void WordOfUnmaking_OncePerCombat()
    {
        // Test cooldown enforcement
    }
}
```

---

## 18. Deliverable Checklist

### Domain Layer
- [ ] `LivingRuneEntity` value object with full combat methods
- [ ] `DispelEffectResult` value object with result tracking

### Application Layer
- [ ] `MasterScrivenerIntegration` passive implementation
- [ ] `LivingRunesHandler` ability handler
- [ ] `LivingRuneAIEngine` combat AI
- [ ] `WordOfUnmakingHandler` ability handler
- [ ] `DispelServiceImpl` dispel logic implementation
- [ ] Extension methods to IRúnasmiðrAbilityService

### Infrastructure Layer
- [ ] `abilities.json` entries for 2 Tier 3 + 1 Capstone
- [ ] `specializations.json` complete tier configuration

### Tests
- [ ] `Tier3AndCapstoneTests.cs` (7 tests)
- [ ] All tests passing with >95% code coverage

---

## 19. Acceptance Criteria

### Master Scrivener
- [ ] Rune durations doubled (Inscribe: 20 turns, Trap: 2 hours)
- [ ] Runestone Ward unaffected
- [ ] Living Runes unaffected (5 turns fixed)
- [ ] Applies retroactively to existing runes
- [ ] Passive activation when unlocked

### Living Runes
- [ ] Costs 4 AP and 3 Rune Charges
- [ ] Summons exactly 2 entities
- [ ] Each has correct stats (10 HP, 12 DEF, +4 ATK, 1d8 dmg)
- [ ] Entities act on owner's initiative
- [ ] Attack nearest enemy automatically
- [ ] Last 5 turns
- [ ] Cannot be healed
- [ ] Can be resummoned after expiration

### Word of Unmaking
- [ ] Costs 5 AP and 4 Rune Charges
- [ ] 4-space radius dispel area
- [ ] Removes all magical effects (buffs/debuffs)
- [ ] Destroys all summoned creatures including own
- [ ] Destroys temporary enchantments
- [ ] Affects allies and enemies equally
- [ ] Cannot be resisted
- [ ] Once per combat (cooldown enforced)
- [ ] Destroys runic traps in area

### Tier System
- [ ] Tier 3 locked until 16 PP invested
- [ ] Capstone locked until 24 PP invested
- [ ] Tier 3 costs 5 PP each
- [ ] Capstone costs 6 PP

---

## 20. Dependencies

### Hard Dependencies
- **v0.20.2a** - Rúnasmiðr Framework (RuneChargeResource, base abilities)
- **v0.20.2b** - Tier 2 Abilities (base mechanics established)
- **Combat System** - Initiative, damage, entity management
- **Status Effect System** - Buff/debuff removal

### Soft Dependencies
- **Summoned Entity System** - Creature behavior
- **Position/Terrain System** - Movement and radius calculations

---

## 21. Deferrals and Future Considerations

### Future Enhancements
- **Rune Variants** - Different Living Rune types (ranged, melee, support)
- **Master of Elements** - Integrate elemental damage with Living Runes
- **Controlled Dispel** - Choose which effects to remove
- **Rune Mastery** - Combine multiple rune types for compound effects
- **Animated Arsenal** - Animate weapons as Living Runes

### Post-v0.20.2 Development
- Other Adept specializations (v0.20.3 - Jötun-Reader)
- Warrior specializations (v0.21.x)
- Rogue specializations (v0.22.x)

---

_This design specification completes the comprehensive documentation for the Rúnasmiðr specialization (v0.20.2a, v0.20.2b, v0.20.2c). Combined, these three documents provide full architectural, mechanical, and implementation guidance for the complete Runesmith specialization across all ability tiers._
