# v0.13.2d Changelog: Tooltips & Interaction

## Version
**Release**: v0.13.2d  
**Date**: 2026-01-20  
**Status**: Complete

---

## Overview

This version implements the tooltip and interaction layer for the Ability Tree UI, providing
contextual information display when nodes are selected, including ability details, requirements,
and unlock confirmation prompts.

---

## Added

### DTOs (`DTOs/TooltipDtos.cs`)
- **TooltipDisplayDto** - Data transfer object for complete tooltip content
- **TooltipSectionDto** - Represents a tooltip section with header and lines
- **TooltipLineDto** - Individual tooltip line with label, value, and satisfaction state
- **TooltipPosition** - X/Y coordinates for tooltip positioning
- **TalentPointDisplayDto** - DTO for talent point status (available/spent/total)

### Configuration (`Configuration/NodeTooltipConfig.cs`)
- **NodeTooltipConfig** - Configurable tooltip settings including:
  - Tooltip dimensions (width, max height, offset)
  - Point display width
  - Color settings (border, available points, spent points, prompt)
  - Factory method `CreateDefault()` for default configuration

### JSON Configuration
- **`config/node-tooltip.json`** - Default tooltip settings
- **`config/schemas/node-tooltip.schema.json`** - JSON Schema for validation

### Renderers (`Renderers/TooltipRenderer.cs`)
- **TooltipRenderer** - Formats tooltip content with methods for:
  - `FormatAbilityDetails()` - Creates tooltip from node data
  - `FormatRequirements()` - Formats prerequisite section with satisfaction markers
  - `FormatCost()` - Formats point cost (singular/plural)
  - `GetTooltipPosition()` - Calculates screen position
  - `BuildTooltipLines()` - Builds renderable content with word wrapping

### UI Components

#### NodeTooltip (`UI/NodeTooltip.cs`)
- Displays ability node information in overlay format
- Properties: `IsVisible`, `AwaitingConfirmation`, `CurrentNodeId`
- Methods: `ShowTooltip()`, `HideTooltip()`, `ShowRequirements()`, `ShowUnlockPrompt()`, `HideUnlockPrompt()`
- Full terminal rendering with border characters

#### TalentPointDisplay (`UI/TalentPointDisplay.cs`)
- Displays talent point allocation status
- Format: `Talent Points: 3 Available | 12 Spent`
- Color coding for available/spent points
- Flash animation on point spend
- Supports position configuration and DTO conversion

### Commands (`Commands/AbilityTreeCommand.cs`)
- **AbilityTreeCommand** - Handles ability tree user interactions:
  - Enter: Select node and show tooltip
  - [U]: Initiate unlock for available nodes
  - [Y]/[N]: Confirm or cancel unlock
  - Escape: Close tooltip or cancel confirmation
- **UnlockResult** - Result record for unlock confirmation

---

## Unit Tests

### TooltipRendererTests (~12 tests)
- `FormatAbilityDetails_WithValidNode_ReturnsExpectedTitle`
- `FormatAbilityDetails_WithTierOne_ReturnsExpectedSubtitle`
- `FormatAbilityDetails_WithMultiRankNode_IncludesRankSection`
- `FormatAbilityDetails_WhenUnlocked_SetsStatusToUnlocked`
- `FormatAbilityDetails_WhenAvailable_IncludesUnlockPrompt`
- `FormatRequirements_WithSatisfiedPrereqs_MarksSatisfied`
- `FormatRequirements_WithNoUnlocked_NoneAreSatisfied`
- `FormatCost_WithOnePoint_ReturnsSingular`
- `FormatCost_WithMultiplePoints_ReturnsPlural`
- `BuildTooltipLines_WithValidTooltip_ReturnsFormattedLines`
- `GetTooltipPosition_WithNodeBounds_ReturnsPositionToRight`

### NodeTooltipTests (~9 tests)
- `IsVisible_InitialState_ReturnsFalse`
- `ShowTooltip_WithValidNode_SetsIsVisibleTrue`
- `HideTooltip_WhenVisible_SetsIsVisibleFalse`
- `ShowTooltip_WithNode_SetsCurrentNodeId`
- `HideTooltip_ClearsCurrentNodeId`
- `ShowUnlockPrompt_WhenTooltipVisible_SetsAwaitingConfirmationTrue`
- `ShowUnlockPrompt_WhenNotVisible_DoesNotSetAwaitingConfirmation`
- `HideUnlockPrompt_WhenAwaiting_SetsAwaitingConfirmationFalse`
- `ShowTooltip_CallsTerminalService`

### TalentPointDisplayTests (~8 tests)
- `AvailablePoints_InitialState_ReturnsZero`
- `SpentPoints_InitialState_ReturnsZero`
- `TotalPoints_InitialState_ReturnsZero`
- `RenderPoints_WithValidValues_UpdatesProperties`
- `RenderPoints_CallsTerminalService`
- `UpdateAvailable_WithPointSpent_UpdatesSpentPoints`
- `SetPosition_WithValues_UpdatesPosition`
- `ToDto_AfterRenderPoints_ReturnsDtoWithCorrectValues`
- `Clear_CallsTerminalServiceToWriteBlank`

---

## Test Results

```
Passed!  - Failed: 0, Passed: 29, Skipped: 0, Total: 29
```

---

## Architecture Notes

### Node State Determination
The AbilityTreeCommand includes a `DetermineNodeState()` method that evaluates:
1. Whether the node is already unlocked
2. Whether all prerequisite nodes are unlocked
3. Whether the player has sufficient talent points

### Tooltip Positioning
Tooltips position to the right of the selected node by default, with automatic
repositioning to the left when the tooltip would exceed screen bounds.

### Unlock Flow
1. User selects node (Enter) → Tooltip displays
2. User presses [U] → Unlock prompt shown
3. User confirms [Y]/[N] → `UnlockResult` returned to caller
4. Caller executes unlock via game service

---

## Dependencies

- `ITerminalService` - Terminal output abstraction
- `NodeStateRenderer` - For state-specific formatting
- `NodeStateDisplayConfig` - For node display dimensions
- `IOptions<NodeTooltipConfig>` - Configuration injection
