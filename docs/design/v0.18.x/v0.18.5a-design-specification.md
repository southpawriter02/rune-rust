# v0.18.5a Design Specification: TraumaEconomyState

**Version:** 0.18.5a
**Parent:** v0.18.5 (Resource Integration / Trauma Economy Integration)
**Prerequisites:** v0.18.0 (Psychic Stress), v0.18.1 (Runic Blight/Corruption), v0.18.2 (CPS), v0.18.3 (Trauma), v0.18.4 (Specialization Resources)
**Status:** Design Complete
**Estimated Unit Tests:** ~4

---

## Table of Contents

1. [Executive Summary](#1-executive-summary)
2. [Feature Overview](#2-feature-overview)
3. [Architecture Diagrams](#3-architecture-diagrams)
4. [User Stories](#4-user-stories)
5. [TraumaEconomyState Entity](#5-traumaeconomystate-entity)
6. [TraumaEconomySnapshot Value Object](#6-traumaeconomysnapshot-value-object)
7. [Cross-System Calculations](#7-cross-system-calculations)
8. [Logging Specifications](#8-logging-specifications)
9. [Unit Testing Requirements](#9-unit-testing-requirements)
10. [Deliverable Checklist](#10-deliverable-checklist)
11. [Acceptance Criteria](#11-acceptance-criteria)
12. [Dependencies](#12-dependencies)
13. [Future Considerations](#13-future-considerations)

---

## 1. Executive Summary

This design specification defines the **unified state aggregation layer** for the Trauma Economy — the central coordinating entity that brings together all trauma economy components (Stress, Corruption, CPS, Trauma, and Specialization Resources) into a single queryable state object.

v0.18.5a establishes the **Foundation for Integration** by defining:

- `TraumaEconomyState` entity — aggregates all trauma economy states
- `TraumaEconomySnapshot` value object — immutable point-in-time capture
- Cross-system computed properties — effects calculated on demand

### Key Deliverables

| Category            | Items                                           |
| ------------------- | ----------------------------------------------- |
| **Domain Entities** | `TraumaEconomyState`                            |
| **Value Objects**   | `TraumaEconomySnapshot`                         |
| **Tests**           | ~4 unit tests                                   |

### State Aggregation Overview

| Component           | Integration          |
| ------------------- | -------------------- |
| Stress System       | StressState property |
| Corruption System   | CorruptionState prop |
| CPS System          | Derived from stress  |
| Trauma System       | Traumas list         |
| Specialization      | Generic resource     |

---

## 2. Feature Overview

```
v0.18.5a Features
└── Unified State Aggregation (Integration Foundation)
    │
    ├── TraumaEconomyState Entity
    │   ├── StressState (from v0.18.0)
    │   ├── CorruptionState (from v0.18.1)
    │   ├── CpsState (derived from stress)
    │   ├── Traumas (from v0.18.3)
    │   ├── SpecializationResource (from v0.18.4)
    │   │
    │   ├── Computed Cross-System Properties
    │   │   ├── EffectiveMaxHp
    │   │   ├── EffectiveMaxAp
    │   │   ├── EffectiveResolve
    │   │   ├── TotalDefensePenalty
    │   │   ├── TotalSkillPenalty
    │   │   ├── IsCriticalState
    │   │   ├── IsTerminalState
    │   │   ├── ActiveWarnings
    │   │   └── ActiveTraumaEffects
    │   │
    │   └── Query Methods
    │       ├── HasCriticalSystem()
    │       ├── GetWarningLevel()
    │       └── IsInMultipleThresholds()
    │
    └── TraumaEconomySnapshot Value Object
        ├── CharacterId
        ├── CapturedAt
        ├── Stress & Threshold
        ├── Corruption & Threshold
        ├── CpsStage
        ├── TraumaCount & Ids
        ├── SpecializationType & Value
        └── IsValid()
```

---

## 3. Architecture Diagrams

### 3.1 State Aggregation Architecture

```
┌──────────────────────────────────────────────────────────────────────────┐
│                     TRAUMA ECONOMY STATE LAYER                            │
├──────────────────────────────────────────────────────────────────────────┤
│                                                                            │
│  ┌────────────────────────────────────────────────────────────────────┐  │
│  │                  TraumaEconomyState (Aggregate Root)                │  │
│  ├────────────────────────────────────────────────────────────────────┤  │
│  │                                                                     │  │
│  │  Aggregated States:                                               │  │
│  │  ┌──────────────────┬──────────────┬────────────────────────────┐ │  │
│  │  │  StressState     │ CorruptionSt │ CpsState (derived)         │ │  │
│  │  │  (v0.18.0)       │ (v0.18.1)    │ (from Stress)              │ │  │
│  │  └──────────────────┴──────────────┴────────────────────────────┘ │  │
│  │                                                                     │  │
│  │  ┌──────────────────┬──────────────┬────────────────────────────┐ │  │
│  │  │ Traumas (list)   │ Specialization Resource (polymorphic)     │ │  │
│  │  │ (v0.18.3)        │ (RageState | MomentumState | Coherence)   │ │  │
│  │  └──────────────────┴──────────────┴────────────────────────────┘ │  │
│  │                                                                     │  │
│  │  ┌─────────────────────────────────────────────────────────────┐  │  │
│  │  │  Computed Cross-System Properties:                          │  │  │
│  │  │                                                              │  │  │
│  │  │  • EffectiveMaxHp      = BaseHP × (1 - Corruption%)        │  │  │
│  │  │  • EffectiveMaxAp      = BaseAP × (1 - Corruption%)        │  │  │
│  │  │  • EffectiveResolve    = BaseResolve - CorruptionPenalty   │  │  │
│  │  │  • TotalDefensePenalty = StressDefensePenalty              │  │  │
│  │  │  • TotalSkillPenalty   = StressSkill + CpsLogicDisadvantage│  │  │
│  │  │  • IsCriticalState     = Any(Stress, Corrupt) >= 80        │  │  │
│  │  │  • IsTerminalState     = Any(Stress, Corrupt) >= 100       │  │  │
│  │  │  • ActiveWarnings      = List<string> (computed)           │  │  │
│  │  │  • ActiveTraumaEffects = List<TraumaEffect>                │  │  │
│  │  │                                                              │  │  │
│  │  └─────────────────────────────────────────────────────────────┘  │  │
│  │                                                                     │  │
│  └────────────────────────────────────────────────────────────────────┘  │
│                                                                            │
└──────────────────────────────────────────────────────────────────────────┘
```

### 3.2 State Access Flow

```
┌────────────────────────────────────────────────────────────┐
│   External Code Requests Character State                   │
└──────────────────┬─────────────────────────────────────────┘
                   │
                   ▼
┌────────────────────────────────────────────────────────────┐
│  TraumaEconomyState.GetState(characterId)                  │
├────────────────────────────────────────────────────────────┤
│  Queries all sub-systems:                                  │
│  • StressService.GetStress(characterId)                    │
│  • CorruptionService.GetCorruption(characterId)            │
│  • TraumaService.GetTraumas(characterId)                   │
│  • SpecializationProvider.GetResource(characterId)         │
└──────────────────┬─────────────────────────────────────────┘
                   │
                   ▼
┌────────────────────────────────────────────────────────────┐
│  Compute Cross-System Properties                           │
│  • Apply Corruption modifiers to HP/AP/Resolve            │
│  • Calculate penalty stacking                              │
│  • Determine warning states                                │
└──────────────────┬─────────────────────────────────────────┘
                   │
                   ▼
┌────────────────────────────────────────────────────────────┐
│  Return Fully Populated TraumaEconomyState                 │
└────────────────────────────────────────────────────────────┘
```

### 3.3 Cross-System Penalty Stacking

```
                   STRESS (0-100)
                        │
        ┌───────────────┼───────────────┐
        │               │               │
        ▼               ▼               ▼
   Defense          Skill             CPS
   Penalty          Penalty           Stage
   (from            (from             (from
   Threshold)       Threshold)        Stage)
        │               │               │
        └───────────────┴───────────────┘
                   │
                   ▼
        ┌─────────────────────────────────┐
        │  TotalSkillPenalty += CPSStage  │
        │  (Stress penalties stack with   │
        │   CPS logic disadvantage)       │
        └─────────────────────────────────┘

                 CORRUPTION (0-100)
                        │
        ┌───────────────┼───────────────┐
        │               │               │
        ▼               ▼               ▼
   HP Penalty      AP Penalty        Resolve
   (%)             (%)               Penalty
                                    (dice)
        │               │               │
        └───────────────┴───────────────┘
                   │
                   ▼
        ┌─────────────────────────────────┐
        │  EffectiveMaxHp = Base - Penalty│
        │  EffectiveMaxAp = Base - Penalty│
        │  EffectiveResolve = Base - Dice │
        └─────────────────────────────────┘

             COMBINED STATE ASSESSMENT
                   │
        ┌──────────┼──────────┐
        │          │          │
        ▼          ▼          ▼
    CriticalSt  TerminalSt  MultipleThresholds
    (any>=80)   (any>=100)   (multiple systems affected)
        │          │          │
        └──────────┴──────────┘
                   │
                   ▼
        ┌─────────────────────────────────┐
        │  ActiveWarnings computed        │
        │  (combine all states)           │
        └─────────────────────────────────┘
```

---

## 4. User Stories

### US-18.5a-1: Aggregate All Trauma Economy States

**As a** trauma economy service developer
**I want to** retrieve all trauma economy component states in a single object
**So that** I can query cross-system effects without multiple service calls

**Acceptance Criteria:**

- TraumaEconomyState contains all required component states
- State is populated from all sub-services (Stress, Corruption, CPS, Trauma, Specialization)
- No data is stale (queries are current)
- State is immutable after creation

### US-18.5a-2: Calculate Cross-System Modifiers

**As a** game mechanic system
**I want to** calculate combined effects from multiple trauma economy systems
**So that** character mechanics correctly apply all penalties

**Acceptance Criteria:**

- EffectiveMaxHp applies Corruption penalty
- EffectiveMaxAp applies Corruption penalty
- EffectiveResolve applies Corruption dice penalty
- TotalDefensePenalty combines stress thresholds
- TotalSkillPenalty combines stress and CPS penalties
- All calculations are composable and stackable

### US-18.5a-3: Identify Critical and Terminal States

**As a** game state machine
**I want to** know when any trauma economy system reaches critical or terminal levels
**So that** I can trigger appropriate narrative or mechanical consequences

**Acceptance Criteria:**

- IsCriticalState true when any system >= 80
- IsTerminalState true when any system >= 100
- ActiveWarnings populated for systems in critical range
- MultipleThresholds detected when 2+ systems in critical state

### US-18.5a-4: Capture Point-in-Time Snapshot

**As a** state history or logging system
**I want to** capture an immutable snapshot of the trauma economy at a specific moment
**So that** I can compare changes or generate reports

**Acceptance Criteria:**

- TraumaEconomySnapshot captures all key values
- Snapshot includes captured timestamp
- Snapshot.IsValid() validates consistency
- Snapshot can be serialized to JSON

---

## 5. TraumaEconomyState Entity

### 5.1 Purpose

Aggregate root that brings together all trauma economy component states and provides cross-system computed properties.

### 5.2 Definition

**File:** `src/Core/RuneAndRust.Domain/Entities/TraumaEconomyState.cs`

```csharp
namespace RuneAndRust.Domain.Entities;

using RuneAndRust.Domain.ValueObjects;
using RuneAndRust.Domain.Enums;

/// <summary>
/// Aggregate root representing the unified trauma economy state for a character.
/// </summary>
/// <remarks>
/// <para>
/// TraumaEconomyState aggregates all trauma economy component states and provides
/// computed cross-system properties. It serves as the primary query interface for
/// trauma economy information and is used by services to calculate integrated effects.
/// </para>
/// <para>
/// The entity does not persist individual states; instead, it composes them from
/// the individual sub-systems (StressService, CorruptionService, TraumaService, etc).
/// </para>
/// <para>
/// Computed properties are calculated on-demand and not cached, ensuring consistency
/// with underlying state systems.
/// </para>
/// </remarks>
/// <example>
/// <code>
/// var state = TraumaEconomyState.Create(characterId, stressState, corruptionState, cpsState, traumas, specializationResource);
/// var effectiveHp = state.EffectiveMaxHp; // Applies corruption penalty
/// var warnings = state.ActiveWarnings; // Lists all active system warnings
/// </code>
/// </example>
public class TraumaEconomyState
{
    #region Properties

    /// <summary>
    /// Gets the character ID for this trauma economy state.
    /// </summary>
    public Guid CharacterId { get; private set; }

    /// <summary>
    /// Gets the current psychic stress state.
    /// </summary>
    /// <remarks>
    /// Contains stress value (0-100) and derived CPS stage.
    /// </remarks>
    public StressState StressState { get; private set; }

    /// <summary>
    /// Gets the current corruption state.
    /// </summary>
    /// <remarks>
    /// Contains corruption value (0-100) and severity penalties.
    /// </remarks>
    public CorruptionState CorruptionState { get; private set; }

    /// <summary>
    /// Gets the current Cognitive Paradox Syndrome state.
    /// </summary>
    /// <remarks>
    /// Derived from StressState. Includes stage and panic check status.
    /// </remarks>
    public CpsState CpsState { get; private set; }

    /// <summary>
    /// Gets the immutable list of active traumas for this character.
    /// </summary>
    /// <remarks>
    /// Traumas are acquired through near-death and ally death events.
    /// Each trauma has ongoing mechanical effects.
    /// </remarks>
    public IReadOnlyList<CharacterTrauma> Traumas { get; private set; }

    /// <summary>
    /// Gets the specialization-specific resource (polymorphic).
    /// </summary>
    /// <remarks>
    /// May be RageState (Berserker), MomentumState (Storm Blade),
    /// or CoherenceState (Arcanist). Null if no specialization active.
    /// </remarks>
    public object? SpecializationResource { get; private set; }

    /// <summary>
    /// Gets the specialization type name.
    /// </summary>
    /// <remarks>
    /// Examples: "rage", "momentum", "coherence", or null.
    /// </remarks>
    public string? SpecializationType { get; private set; }

    #endregion

    #region Computed Cross-System Properties

    /// <summary>
    /// Gets the effective maximum hit points after corruption penalty.
    /// </summary>
    /// <remarks>
    /// Formula: BaseHP × (1 - CorruptionPenaltyPercentage)
    /// </remarks>
    public int EffectiveMaxHp =>
        (int)(BaseHp * (1 - CorruptionState.HitPointPenaltyPercentage));

    /// <summary>
    /// Gets the effective maximum action points after corruption penalty.
    /// </summary>
    /// <remarks>
    /// Formula: BaseAP × (1 - CorruptionPenaltyPercentage)
    /// </remarks>
    public int EffectiveMaxAp =>
        (int)(BaseAp * (1 - CorruptionState.ActionPointPenaltyPercentage));

    /// <summary>
    /// Gets the effective Resolve dice after corruption penalty.
    /// </summary>
    /// <remarks>
    /// Formula: BaseResolve - CorruptionDicePenalty
    /// </remarks>
    public int EffectiveResolve =>
        Math.Max(1, BaseResolve - CorruptionState.ResolveDicePenalty);

    /// <summary>
    /// Gets the total defense penalty from stress system.
    /// </summary>
    /// <remarks>
    /// Derived from stress threshold. Higher stress = higher penalty.
    /// </remarks>
    public int TotalDefensePenalty =>
        StressState.DefensePenalty;

    /// <summary>
    /// Gets the total skill penalty from stress and CPS combined.
    /// </summary>
    /// <remarks>
    /// Formula: StressSkillPenalty + CpsLogicDisadvantage
    /// Penalties stack as both systems contribute.
    /// </remarks>
    public int TotalSkillPenalty =>
        StressState.SkillPenalty + GetCpsLogicDisadvantage();

    /// <summary>
    /// Gets whether the character is in a critical system state.
    /// </summary>
    /// <remarks>
    /// True when any system (Stress or Corruption) is at 80 or higher.
    /// </remarks>
    public bool IsCriticalState =>
        StressState.CurrentStress >= 80 || CorruptionState.CurrentCorruption >= 80;

    /// <summary>
    /// Gets whether the character is in a terminal system state.
    /// </summary>
    /// <remarks>
    /// True when any system (Stress or Corruption) reaches 100.
    /// Character in terminal state requires survival check.
    /// </remarks>
    public bool IsTerminalState =>
        StressState.CurrentStress >= 100 || CorruptionState.CurrentCorruption >= 100;

    /// <summary>
    /// Gets the count of active traumas.
    /// </summary>
    public int TraumaCount =>
        Traumas?.Count ?? 0;

    /// <summary>
    /// Gets whether multiple trauma economy systems are simultaneously in critical state.
    /// </summary>
    /// <remarks>
    /// Occurs when 2+ of (Stress, Corruption) are at 80+. Indicates compound danger.
    /// </remarks>
    public bool HasMultipleCriticalSystems =>
        (StressState.CurrentStress >= 80 ? 1 : 0) +
        (CorruptionState.CurrentCorruption >= 80 ? 1 : 0) >= 2;

    #endregion

    #region Warning System

    /// <summary>
    /// Gets the list of active warning messages for this character's trauma economy state.
    /// </summary>
    /// <remarks>
    /// <para>
    /// Warnings indicate systems approaching or exceeding critical thresholds.
    /// Used for UI display and narrative prompting.
    /// </para>
    /// <para>
    /// Possible warnings:
    /// • "Stress approaching dangerous levels" (70-79)
    /// • "Corruption spreading through your form" (70-79)
    /// • "Stress at critical levels" (80+)
    /// • "Corruption consuming your body" (80+)
    /// • "Multiple systems failing" (2+ at 80+)
    /// • "Near terminal collapse" (any at 90+)
    /// </para>
    /// </remarks>
    public IReadOnlyList<string> ActiveWarnings
    {
        get
        {
            var warnings = new List<string>();

            // Stress warnings
            if (StressState.CurrentStress >= 90)
                warnings.Add("Your mind spirals toward total collapse.");
            else if (StressState.CurrentStress >= 80)
                warnings.Add("Your sanity fractures under the weight of reality.");
            else if (StressState.CurrentStress >= 70)
                warnings.Add("Your thoughts grow increasingly scattered.");

            // Corruption warnings
            if (CorruptionState.CurrentCorruption >= 90)
                warnings.Add("The Blight consumes your very essence.");
            else if (CorruptionState.CurrentCorruption >= 80)
                warnings.Add("Corruption ravages your form.");
            else if (CorruptionState.CurrentCorruption >= 70)
                warnings.Add("The taint spreads deeper within you.");

            // CPS warnings
            if (CpsState.RequiresPanicCheck)
                warnings.Add("Your grip on reality is slipping—Panic Table active.");

            // Combined warnings
            if (HasMultipleCriticalSystems)
                warnings.Add("Your body and mind fail in tandem.");

            if (TraumaCount > 0)
                warnings.Add($"You carry {TraumaCount} unhealed trauma{(TraumaCount > 1 ? "s" : "")}.");

            return warnings.AsReadOnly();
        }
    }

    /// <summary>
    /// Gets the list of active trauma effects applying to this character.
    /// </summary>
    /// <remarks>
    /// Each trauma has ongoing mechanical effects that are combined here.
    /// </remarks>
    public IReadOnlyList<TraumaEffect> ActiveTraumaEffects =>
        Traumas?.SelectMany(t => t.ActiveEffects).ToList().AsReadOnly() ??
        new List<TraumaEffect>().AsReadOnly();

    #endregion

    #region Query Methods

    /// <summary>
    /// Determines the overall warning level for UI/narrative purposes.
    /// </summary>
    /// <remarks>
    /// Returns: None, Warning, Critical, or Terminal
    /// </remarks>
    public WarningLevel GetWarningLevel()
    {
        if (IsTerminalState)
            return WarningLevel.Terminal;

        if (IsCriticalState || CpsState.RequiresPanicCheck)
            return WarningLevel.Critical;

        if (StressState.CurrentStress >= 70 || CorruptionState.CurrentCorruption >= 70)
            return WarningLevel.Warning;

        return WarningLevel.None;
    }

    /// <summary>
    /// Gets the highest stress level percentage (0-1) across all systems.
    /// </summary>
    public double GetHighestSystemPercentage() =>
        Math.Max(
            StressState.CurrentStress / 100.0,
            CorruptionState.CurrentCorruption / 100.0
        );

    #endregion

    #region Factory Methods

    /// <summary>
    /// Creates a new TraumaEconomyState from component states.
    /// </summary>
    /// <param name="characterId">The character's unique identifier.</param>
    /// <param name="stressState">The psychic stress state.</param>
    /// <param name="corruptionState">The corruption state.</param>
    /// <param name="cpsState">The CPS state (derived from stress).</param>
    /// <param name="traumas">The list of active traumas.</param>
    /// <param name="specializationResource">Optional specialization resource (polymorphic).</param>
    /// <param name="specializationType">Optional specialization type name.</param>
    /// <returns>A new TraumaEconomyState.</returns>
    public static TraumaEconomyState Create(
        Guid characterId,
        StressState stressState,
        CorruptionState corruptionState,
        CpsState cpsState,
        IReadOnlyList<CharacterTrauma> traumas,
        object? specializationResource = null,
        string? specializationType = null)
    {
        return new TraumaEconomyState
        {
            CharacterId = characterId,
            StressState = stressState,
            CorruptionState = corruptionState,
            CpsState = cpsState,
            Traumas = traumas ?? new List<CharacterTrauma>().AsReadOnly(),
            SpecializationResource = specializationResource,
            SpecializationType = specializationType
        };
    }

    #endregion

    #region Private Helpers

    private int BaseHp => 100; // TODO: Inject from character stats
    private int BaseAp => 50;  // TODO: Inject from character stats
    private int BaseResolve => 10; // TODO: Inject from character attributes

    private int GetCpsLogicDisadvantage() =>
        CpsState.Stage switch
        {
            CpsStage.None => 0,
            CpsStage.WeightOfKnowing => 0,
            CpsStage.GlimmerMadness => 1,
            CpsStage.RuinMadness => 2,
            CpsStage.HollowShell => 3,
            _ => 0
        };

    #endregion

    #region Display

    /// <inheritdoc/>
    public override string ToString() =>
        $"TraumaEconomy[{CharacterId}]: " +
        $"Stress={StressState.CurrentStress} " +
        $"Corruption={CorruptionState.CurrentCorruption} " +
        $"Traumas={TraumaCount}";

    #endregion

    // Private constructor for EF Core
    private TraumaEconomyState() { }
}

/// <summary>
/// Represents the warning level for trauma economy state.
/// </summary>
public enum WarningLevel
{
    /// <summary>All systems normal.</summary>
    None,

    /// <summary>Some systems approaching threshold.</summary>
    Warning,

    /// <summary>Systems at or exceeding 80.</summary>
    Critical,

    /// <summary>Systems at or exceeding 100.</summary>
    Terminal
}
```

---

## 6. TraumaEconomySnapshot Value Object

### 6.1 Purpose

Immutable point-in-time capture of trauma economy state for logging, comparison, or historical tracking.

### 6.2 Definition

**File:** `src/Core/RuneAndRust.Domain/ValueObjects/TraumaEconomySnapshot.cs`

```csharp
namespace RuneAndRust.Domain.ValueObjects;

using RuneAndRust.Domain.Enums;

/// <summary>
/// Immutable value object representing a point-in-time snapshot of trauma economy state.
/// </summary>
/// <remarks>
/// <para>
/// Snapshots capture key values from all trauma economy systems at a specific moment.
/// They are useful for:
/// • Logging state changes
/// • Comparing before/after effect application
/// • Historical tracking
/// • Serialization to JSON
/// </para>
/// <para>
/// Snapshots do not include derivative data (like warnings) to keep size minimal.
/// </para>
/// </remarks>
/// <example>
/// <code>
/// var snapshot = TraumaEconomySnapshot.Create(state);
/// if (snapshot.IsValid())
/// {
///     logger.LogInformation("Captured state: Stress={Stress} Corruption={Corruption}",
///         snapshot.Stress, snapshot.Corruption);
/// }
/// </code>
/// </example>
public readonly record struct TraumaEconomySnapshot(
    Guid CharacterId,
    DateTime CapturedAt,
    int Stress,
    string StressThreshold,
    int Corruption,
    string CorruptionThreshold,
    string CpsStage,
    int TraumaCount,
    IReadOnlyList<string> TraumaIds,
    string? SpecializationType,
    int? SpecializationValue,
    string? SpecializationThreshold)
{
    #region Factory Methods

    /// <summary>
    /// Creates a snapshot from a TraumaEconomyState.
    /// </summary>
    /// <param name="state">The trauma economy state to capture.</param>
    /// <returns>A new immutable snapshot.</returns>
    public static TraumaEconomySnapshot Create(TraumaEconomyState state)
    {
        var traumaIds = state.Traumas?.Select(t => t.TraumaId).ToList().AsReadOnly() ??
                        new List<string>().AsReadOnly();

        return new TraumaEconomySnapshot(
            CharacterId: state.CharacterId,
            CapturedAt: DateTime.UtcNow,
            Stress: state.StressState.CurrentStress,
            StressThreshold: state.StressState.CurrentThreshold.ToString(),
            Corruption: state.CorruptionState.CurrentCorruption,
            CorruptionThreshold: state.CorruptionState.CurrentThreshold.ToString(),
            CpsStage: state.CpsState.Stage.ToString(),
            TraumaCount: state.TraumaCount,
            TraumaIds: traumaIds,
            SpecializationType: state.SpecializationType,
            SpecializationValue: null, // TODO: Extract from resource
            SpecializationThreshold: null // TODO: Extract from resource
        );
    }

    #endregion

    #region Validation

    /// <summary>
    /// Validates the snapshot for internal consistency.
    /// </summary>
    /// <remarks>
    /// Checks:
    /// • Stress and Corruption in valid ranges
    /// • Threshold names are recognized
    /// • TraumaCount matches TraumaIds count
    /// • CapturedAt is reasonable
    /// </remarks>
    /// <returns>True if snapshot is valid.</returns>
    public bool IsValid()
    {
        // Check stress/corruption ranges
        if (Stress < 0 || Stress > 100)
            return false;
        if (Corruption < 0 || Corruption > 100)
            return false;

        // Check trauma consistency
        if (TraumaCount != (TraumaIds?.Count ?? 0))
            return false;

        // Check CPS stage is recognized
        if (!Enum.TryParse<CpsStage>(CpsStage, out _))
            return false;

        // Check captured time is reasonable (not in future)
        if (CapturedAt > DateTime.UtcNow)
            return false;

        return true;
    }

    #endregion

    #region Serialization

    /// <summary>
    /// Converts the snapshot to a JSON-serializable form.
    /// </summary>
    public string ToJson()
    {
        // TODO: Implement with System.Text.Json
        throw new NotImplementedException();
    }

    #endregion

    #region Display

    /// <inheritdoc/>
    public override string ToString() =>
        $"Snapshot[{CharacterId}] @ {CapturedAt:O}: " +
        $"Stress={Stress}({StressThreshold}) " +
        $"Corruption={Corruption}({CorruptionThreshold}) " +
        $"CPS={CpsStage} " +
        $"Traumas={TraumaCount}";

    #endregion
}
```

---

## 7. Cross-System Calculations

### 7.1 Calculation Formulas

| Calculation           | Formula                                      | Source Systems |
| --------------------- | -------------------------------------------- | -------------- |
| Effective Max HP      | BaseHP × (1 - CorruptionPenalty%)            | Corruption     |
| Effective Max AP      | BaseAP × (1 - CorruptionPenalty%)            | Corruption     |
| Effective Resolve     | BaseResolve - CorruptionDicePenalty          | Corruption     |
| Total Defense Penalty | StressDefensePenalty                         | Stress         |
| Total Skill Penalty   | StressSkillPenalty + CpsLogicDisadvantage    | Stress + CPS   |
| Is Critical           | Any(Stress, Corruption) ≥ 80                 | All            |
| Is Terminal           | Any(Stress, Corruption) ≥ 100                | All            |
| Highest System %      | max(Stress/100, Corruption/100)              | All            |

### 7.2 Penalty Stacking Rules

1. **Stress Penalties:** Defense and Skill penalties from Stress are always applied
2. **CPS Penalties:** Logic disadvantage adds to Skill penalty (not multiplicative)
3. **Corruption Penalties:** All corruption effects are percentage-based and subtractive
4. **No Double-Counting:** A system never applies penalties twice
5. **Minimum Values:** Effective values never drop below 1 (except for penalties which can be 0)

---

## 8. Logging Specifications

### 8.1 Domain Layer Logging

> **Note:** Entities and value objects do not log directly.
> All logging occurs in Application Layer services (v0.18.5e).

### 8.2 Expected Log Events (Future Implementation)

| Event                         | Level       | Template                                                          |
| ----------------------------- | ----------- | ----------------------------------------------------------------- |
| State Aggregated              | Debug       | `"TraumaEconomyState aggregated: {CharacterId}"`                  |
| Critical State Detected       | Warning     | `"Critical state detected: {CharacterId} {SystemInCritical}"`      |
| Terminal State Detected       | Error       | `"TERMINAL STATE: {CharacterId} system reached 100"`               |
| Snapshot Created              | Debug       | `"Snapshot created: {CharacterId} at {Time}"`                     |
| Multiple Critical Systems     | Warning     | `"Multiple critical systems: {CharacterId} Stress + Corruption"`   |

---

## 9. Unit Testing Requirements

### 9.1 Test File Location

**File:** `tests/RuneAndRust.Domain.UnitTests/Entities/TraumaEconomyStateTests.cs`

**File:** `tests/RuneAndRust.Domain.UnitTests/ValueObjects/TraumaEconomySnapshotTests.cs`

### 9.2 Required Tests

| Test Name                                              | Description                                    |
| ------------------------------------------------------ | ---------------------------------------------- |
| `Create_WithAllStates_ReturnsPopulatedState`           | State aggregates all components                 |
| `EffectiveMaxHp_WithCorruption_AppliesPenalty`         | HP penalty calculation correct                  |
| `TotalSkillPenalty_WithStressAndCps_StacksProperly`    | Skill penalties combine correctly               |
| `IsCriticalState_WithHighStress_ReturnsTrue`           | Critical state detection accurate               |
| `Snapshot_Create_CapturesAllValues`                    | Snapshot captures complete state                |
| `Snapshot_IsValid_DetectsInvalidData`                  | Snapshot validation works                       |
| `ActiveWarnings_WithCriticalSystems_ReturnsMessages`   | Warnings generated appropriately                |

### 9.3 Example Test

```csharp
[TestFixture]
public class TraumaEconomyStateTests
{
    [Test]
    public void EffectiveMaxHp_WithCorruption_AppliesPenalty()
    {
        // Arrange
        var stress = StressState.Create(40);
        var corruption = CorruptionState.Create(50); // 50% penalty at corruption=50
        var cps = CpsState.Create(40);
        var traumas = new List<CharacterTrauma>().AsReadOnly();

        var state = TraumaEconomyState.Create(
            Guid.NewGuid(), stress, corruption, cps, traumas);

        // Act
        var effectiveHp = state.EffectiveMaxHp;

        // Assert
        effectiveHp.Should().BeLessThan(100);
        effectiveHp.Should().Be((int)(100 * (1 - 0.5))); // 50
    }

    [Test]
    public void IsCriticalState_WithStressAtEightyOrAbove_ReturnsTrue()
    {
        // Arrange
        var stress = StressState.Create(80);
        var corruption = CorruptionState.Create(30);
        var cps = CpsState.Create(80);
        var traumas = new List<CharacterTrauma>().AsReadOnly();

        var state = TraumaEconomyState.Create(
            Guid.NewGuid(), stress, corruption, cps, traumas);

        // Act
        var isCritical = state.IsCriticalState;

        // Assert
        isCritical.Should().BeTrue();
    }

    [Test]
    public void Snapshot_IsValid_WithValidData_ReturnsTrue()
    {
        // Arrange
        var snapshot = new TraumaEconomySnapshot(
            CharacterId: Guid.NewGuid(),
            CapturedAt: DateTime.UtcNow,
            Stress: 50,
            StressThreshold: "Moderate",
            Corruption: 30,
            CorruptionThreshold: "Low",
            CpsStage: "GlimmerMadness",
            TraumaCount: 1,
            TraumaIds: new List<string> { "trauma-1" }.AsReadOnly(),
            SpecializationType: "rage",
            SpecializationValue: 50,
            SpecializationThreshold: "Active"
        );

        // Act
        var isValid = snapshot.IsValid();

        // Assert
        isValid.Should().BeTrue();
    }
}
```

---

## 10. Deliverable Checklist

### 10.1 Domain Layer

- [ ] `src/Core/RuneAndRust.Domain/Entities/TraumaEconomyState.cs`
- [ ] `src/Core/RuneAndRust.Domain/ValueObjects/TraumaEconomySnapshot.cs`
- [ ] `src/Core/RuneAndRust.Domain/Enums/WarningLevel.cs`

### 10.2 Tests

- [ ] `tests/RuneAndRust.Domain.UnitTests/Entities/TraumaEconomyStateTests.cs`
- [ ] `tests/RuneAndRust.Domain.UnitTests/ValueObjects/TraumaEconomySnapshotTests.cs`

### 10.3 Documentation

- [ ] Update scope breakdown (mark v0.18.5a complete)
- [ ] Create changelog for v0.18.5a

---

## 11. Acceptance Criteria

### 11.1 Build Verification

- [ ] Solution builds without errors
- [ ] Solution builds without warnings in new code

### 11.2 Test Verification

- [ ] All new unit tests pass
- [ ] All existing unit tests continue to pass

### 11.3 Functional Verification

- [ ] TraumaEconomyState aggregates all component states
- [ ] EffectiveMaxHp correctly applies Corruption penalty percentage
- [ ] EffectiveMaxAp correctly applies Corruption penalty percentage
- [ ] EffectiveResolve correctly applies Corruption dice penalty
- [ ] TotalDefensePenalty returns stress penalty value
- [ ] TotalSkillPenalty combines Stress and CPS penalties
- [ ] IsCriticalState triggers at ≥80 for any system
- [ ] IsTerminalState triggers at ≥100 for any system
- [ ] ActiveWarnings populated with appropriate messages
- [ ] TraumaEconomySnapshot.Create() captures all values
- [ ] TraumaEconomySnapshot.IsValid() validates data
- [ ] GetWarningLevel() returns correct enum values

---

## 12. Dependencies

### 12.1 Required Prerequisites

| Dependency                | Version | Status   | Notes                                  |
| ------------------------- | ------- | -------- | -------------------------------------- |
| Psychic Stress System     | v0.18.0 | Required | StressState and stress calculations    |
| Runic Blight/Corruption   | v0.18.1 | Required | CorruptionState and corruption effects |
| Cognitive Paradox Syndrome | v0.18.2 | Required | CpsState derived from stress           |
| Trauma System             | v0.18.3 | Required | CharacterTrauma and trauma effects     |
| Specialization Resources  | v0.18.4 | Required | Polymorphic specialization state       |

### 12.2 Provides to v0.18.5b-e

| Type                     | Usage                                      |
| ------------------------ | ------------------------------------------ |
| `TraumaEconomyState`     | Base for all integration handlers          |
| `TraumaEconomySnapshot`  | Logging and state comparison               |
| `WarningLevel`           | UI and narrative guidance                  |

---

## 13. Future Considerations

### 13.1 v0.18.5b (Damage Integration)

- `DamageIntegrationResult` value object for damage processing
- `UnifiedDamageHandler` service coordinating damage across systems
- Integration with stress, rage, and momentum resources

### 13.2 v0.18.5c (Rest Integration)

- `RestIntegrationResult` value object for rest processing
- `UnifiedRestHandler` service coordinating recovery
- Party effects (Rage bonuses, stress sharing)

### 13.3 v0.18.5d (Turn-Based Integration)

- `TurnIntegrationResult` value object for per-turn effects
- `UnifiedTurnHandler` service orchestrating turn processing
- Resource decay, Apotheosis stress cost, environmental effects

### 13.4 v0.18.5e (Service Layer)

- `ITraumaEconomyService` interface providing unified operations
- `TraumaEconomyService` implementation coordinating all handlers
- Configuration loading from `trauma-economy.json`

---

_This design specification provides the detailed blueprint for implementing v0.18.5a TraumaEconomyState aggregation. It forms the foundation upon which all subsequent integration phases (v0.18.5b-e) build._

---

## Changelog

| Version | Date       | Changes                          |
| ------- | ---------- | -------------------------------- |
| 1.0     | 2026-01-28 | Initial design specification     |
