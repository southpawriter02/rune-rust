# v0.6.2b Design Specification: Combat Animations

**Version:** 0.6.2b
**Parent:** v0.6.2 (Combat Display)
**Prerequisites:** v0.6.2a Complete (Combat Grid View)
**Status:** Design Complete

---

## Table of Contents

1. [Executive Summary](#1-executive-summary)
2. [Feature Overview](#2-feature-overview)
3. [Architecture Diagrams](#3-architecture-diagrams)
4. [ICombatAnimator Interface](#4-icombatanimator-interface)
5. [CombatAnimator Implementation](#5-combatanimator-implementation)
6. [Animation Definitions](#6-animation-definitions)
7. [Data Model](#7-data-model)
8. [Configuration](#8-configuration)
9. [Logging Specifications](#9-logging-specifications)
10. [Unit Testing Requirements](#10-unit-testing-requirements)
11. [Use Cases](#11-use-cases)
12. [Deliverable Checklist](#12-deliverable-checklist)
13. [Acceptance Criteria](#13-acceptance-criteria)
14. [Dependencies](#14-dependencies)
15. [Future Considerations](#15-future-considerations)

---

## 1. Executive Summary

### Purpose

The Combat Animations system implements text-based combat animations that provide visual feedback for combat actions. Animations are frame-based with configurable timing, supporting hit effects, miss effects, ability casting, damage numbers, healing effects, and death sequences. The system uses an animation queue for sequential playback with skip and speed control options.

### Key Deliverables

| Category | Items |
|----------|-------|
| **Interfaces** | ICombatAnimator |
| **Components** | CombatAnimator |
| **Value Objects** | AnimationDefinition, AnimationFrame |
| **Enums** | AnimationType |
| **Configuration** | animations.json |
| **Tests** | ~15 new unit tests |

### Architectural Significance

This version establishes the **Animation Playback Pattern** for visual combat feedback:
- Frame-based animation with configurable timing
- Animation queue for sequential playback
- Template-based text with variable substitution
- Speed multiplier and skip controls

---

## 2. Feature Overview

```
v0.6.2b Features
â”œâ”€â”€ ICombatAnimator Interface
â”‚   â”œâ”€â”€ QueueAnimation()
â”‚   â”œâ”€â”€ PlayQueuedAnimationsAsync()
â”‚   â”œâ”€â”€ SkipCurrent()
â”‚   â”œâ”€â”€ ClearQueue()
â”‚   â”œâ”€â”€ AnimationsEnabled property
â”‚   â””â”€â”€ SpeedMultiplier property
â”œâ”€â”€ CombatAnimator Implementation
â”‚   â”œâ”€â”€ Frame-based playback
â”‚   â”œâ”€â”€ Animation queue management
â”‚   â”œâ”€â”€ Template variable substitution
â”‚   â””â”€â”€ Color-coded output
â”œâ”€â”€ AnimationDefinition Value Object
â”‚   â”œâ”€â”€ Type (AttackHit, Miss, etc.)
â”‚   â”œâ”€â”€ Frames list
â”‚   â””â”€â”€ Default duration
â”œâ”€â”€ Animation Types
â”‚   â”œâ”€â”€ AttackHit - Normal hit effect
â”‚   â”œâ”€â”€ AttackMiss - Miss effect
â”‚   â”œâ”€â”€ CriticalHit - Critical hit effect
â”‚   â”œâ”€â”€ AbilityCast - Ability casting
â”‚   â”œâ”€â”€ AbilityEffect - Ability impact
â”‚   â”œâ”€â”€ Heal - Healing effect
â”‚   â”œâ”€â”€ DamageNumber - Floating damage
â”‚   â”œâ”€â”€ Death - Death sequence
â”‚   â”œâ”€â”€ StatusApplied - Status effect applied
â”‚   â””â”€â”€ StatusRemoved - Status effect removed
â””â”€â”€ Configuration
    â”œâ”€â”€ Animation templates
    â”œâ”€â”€ Timing settings
    â””â”€â”€ Skip key binding
```

---

## 3. Architecture Diagrams

### 3.1 Combat Animator Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  COMBAT ANIMATOR ARCHITECTURE                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

    Combat Events                Animation System                Display
    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                â”€â”€â”€â”€â”€â”€â”€

    [AttackHit] â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                         â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    [AttackMiss] â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â–¶â”‚      ICombatAnimator      â”‚
                         â”‚    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
    [AbilityUsed] â”€â”€â”€â”€â”€â”€â”€â”¤    â”‚ + QueueAnimation()        â”‚
                         â”‚    â”‚ + PlayQueuedAnimationsAsync()
    [EntityDied] â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚ + SkipCurrent()           â”‚
                              â”‚ + ClearQueue()            â”‚
                              â”‚ + AnimationsEnabled       â”‚
                              â”‚ + SpeedMultiplier         â”‚
                              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                          â”‚ implements
                                          â–¼
                              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                              â”‚      CombatAnimator       â”‚
                              â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
                              â”‚ _animationQueue           â”‚
                              â”‚ _isPlaying                â”‚
                              â”‚ _skipRequested            â”‚
                              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                          â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â–¼                     â–¼                     â–¼
           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
           â”‚AnimationDef   â”‚    â”‚   Timing      â”‚    â”‚   Renderer    â”‚
           â”‚(from config)  â”‚    â”‚   Control     â”‚    â”‚   (Display)   â”‚
           â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
           â”‚ Type          â”‚    â”‚ SpeedMult     â”‚    â”‚ RenderFrame() â”‚
           â”‚ Frames[]      â”‚    â”‚ FrameDelay    â”‚    â”‚ ClearFrame()  â”‚
           â”‚ DefaultDuration   â”‚ SkipCheck     â”‚    â”‚ WriteColored()â”‚
           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3.2 Animation Queue Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      ANIMATION QUEUE FLOW                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

    Combat Events            Animation Queue              Display
    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€            â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€              â”€â”€â”€â”€â”€â”€â”€
    
    AttackHit â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    CriticalHit â”€â”€â”€â”€â”€â”€â”€â”€â–¶   â”‚  Animation 1    â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶  Playing
    Death â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶   â”‚  Animation 2    â”‚            (wait...)
                            â”‚  Animation 3    â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶  Playing
                            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            (wait...)
                                                 â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶  Playing
                                                            (done)
    
    Skip Key (Space) â”€â”€â”€â”€â”€â”€â”€â–¶ Skip current, play next
    
    Speed = 2.0x â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶ Frame durations halved


    Queue Processing:
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ WHILE queue.Count > 0:                                          â”‚
    â”‚   animation = queue.Dequeue()                                   â”‚
    â”‚   FOR each frame in animation.Frames:                           â”‚
    â”‚     IF _skipRequested: BREAK                                    â”‚
    â”‚     RenderFrame(frame)                                          â”‚
    â”‚     await Delay(frame.Duration / SpeedMultiplier)              â”‚
    â”‚     IF frame.ClearPrevious: ClearFrame()                       â”‚
    â”‚   _skipRequested = false                                        â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3.3 Frame Rendering Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      FRAME RENDERING FLOW                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

    RenderFrame(frame, context)
              â”‚
              â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ 1. SUBSTITUTE TEMPLATE VARIABLES                               â”‚
    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
    â”‚ "{actor} strikes {target}!" â†’ "Hero strikes Skeleton!"         â”‚
    â”‚                                                                â”‚
    â”‚ Variables:                                                     â”‚
    â”‚   {actor}     â†’ context.ActorName                             â”‚
    â”‚   {target}    â†’ context.TargetName                            â”‚
    â”‚   {value}     â†’ context.Value                                 â”‚
    â”‚   {ability}   â†’ context.AbilityName                           â”‚
    â”‚   {damageType}â†’ context.DamageType                            â”‚
    â”‚   {status}    â†’ context.StatusName                            â”‚
    â”‚   {verb}      â†’ Random verb from animation's verb list        â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚
              â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ 2. DETERMINE POSITION                                          â”‚
    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
    â”‚ IF frame.Center:                                               â”‚
    â”‚   x = (panelWidth - text.Length) / 2                          â”‚
    â”‚ ELSE IF frame.PositionX.HasValue:                             â”‚
    â”‚   x = frame.PositionX.Value                                    â”‚
    â”‚ ELSE:                                                          â”‚
    â”‚   x = defaultX                                                 â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚
              â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ 3. RENDER WITH COLOR                                           â”‚
    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
    â”‚ IF frame.Color.HasValue:                                       â”‚
    â”‚   Console.ForegroundColor = frame.Color.Value                 â”‚
    â”‚                                                                â”‚
    â”‚ _terminal.SetCursorPosition(x, y)                              â”‚
    â”‚ _terminal.Write(processedText)                                 â”‚
    â”‚                                                                â”‚
    â”‚ Console.ResetColor()                                           â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 4. ICombatAnimator Interface

### 4.1 ICombatAnimator Interface

**File:** `src/Core/RuneAndRust.Application/Interfaces/ICombatAnimator.cs`

```csharp
namespace RuneAndRust.Application.Interfaces;

/// <summary>
/// Handles combat animation playback.
/// </summary>
public interface ICombatAnimator
{
    /// <summary>
    /// Queues an animation for playback.
    /// </summary>
    /// <param name="type">Type of animation to play.</param>
    /// <param name="context">Context for template variable substitution.</param>
    void QueueAnimation(AnimationType type, AnimationContext context);
    
    /// <summary>
    /// Plays all queued animations sequentially.
    /// </summary>
    /// <param name="ct">Cancellation token.</param>
    /// <returns>Task that completes when all animations finish.</returns>
    Task PlayQueuedAnimationsAsync(CancellationToken ct = default);
    
    /// <summary>
    /// Skips the currently playing animation.
    /// </summary>
    void SkipCurrent();
    
    /// <summary>
    /// Clears all queued animations.
    /// </summary>
    void ClearQueue();
    
    /// <summary>
    /// Gets or sets whether animations are enabled.
    /// </summary>
    bool AnimationsEnabled { get; set; }
    
    /// <summary>
    /// Gets or sets the animation speed multiplier.
    /// </summary>
    /// <remarks>
    /// 1.0 = normal speed, 2.0 = double speed, 0.5 = half speed.
    /// </remarks>
    float SpeedMultiplier { get; set; }
    
    /// <summary>
    /// Gets whether an animation is currently playing.
    /// </summary>
    bool IsPlaying { get; }
    
    /// <summary>
    /// Gets the number of animations in the queue.
    /// </summary>
    int QueueCount { get; }
}
```

### 4.2 AnimationType Enum

**File:** `src/Core/RuneAndRust.Domain/Enums/AnimationType.cs`

```csharp
namespace RuneAndRust.Domain.Enums;

/// <summary>
/// Types of combat animations.
/// </summary>
public enum AnimationType
{
    /// <summary>Normal attack hit.</summary>
    AttackHit,
    
    /// <summary>Attack missed.</summary>
    AttackMiss,
    
    /// <summary>Critical hit (enhanced hit animation).</summary>
    CriticalHit,
    
    /// <summary>Ability being cast.</summary>
    AbilityCast,
    
    /// <summary>Ability effect on target.</summary>
    AbilityEffect,
    
    /// <summary>Healing effect.</summary>
    Heal,
    
    /// <summary>Floating damage number.</summary>
    DamageNumber,
    
    /// <summary>Entity death sequence.</summary>
    Death,
    
    /// <summary>Status effect applied.</summary>
    StatusApplied,
    
    /// <summary>Status effect removed.</summary>
    StatusRemoved
}
```

### 4.3 AnimationContext Record

**File:** `src/Core/RuneAndRust.Application/DTOs/AnimationContext.cs`

```csharp
namespace RuneAndRust.Application.DTOs;

/// <summary>
/// Context for animation template variable substitution.
/// </summary>
/// <param name="ActorName">Name of the acting entity.</param>
/// <param name="TargetName">Name of the target entity.</param>
/// <param name="Value">Numeric value (damage, healing, etc.).</param>
/// <param name="AbilityName">Name of ability being used.</param>
/// <param name="DamageType">Type of damage dealt.</param>
/// <param name="StatusName">Name of status effect.</param>
public record AnimationContext(
    string ActorName,
    string? TargetName = null,
    int? Value = null,
    string? AbilityName = null,
    string? DamageType = null,
    string? StatusName = null);
```

---

## 5. CombatAnimator Implementation

### 5.1 CombatAnimator Class

**File:** `src/Presentation/RuneAndRust.TUI/UI/CombatAnimator.cs`

```csharp
namespace RuneAndRust.Presentation.UI;

/// <summary>
/// Plays text-based combat animations.
/// </summary>
public class CombatAnimator : ICombatAnimator
{
    private readonly ITerminalService _terminal;
    private readonly IAnimationProvider _animationProvider;
    private readonly ScreenLayout _layout;
    private readonly ILogger<CombatAnimator> _logger;
    
    private readonly Queue<(AnimationType Type, AnimationContext Context)> _animationQueue = new();
    private readonly Random _random = new();
    
    private bool _skipRequested;
    
    // Animation display area
    private int _animationAreaY;
    private int _animationAreaX;
    private int _animationAreaWidth;
    
    public bool AnimationsEnabled { get; set; } = true;
    public float SpeedMultiplier { get; set; } = 1.0f;
    public bool IsPlaying { get; private set; }
    public int QueueCount => _animationQueue.Count;
    
    public CombatAnimator(
        ITerminalService terminal,
        IAnimationProvider animationProvider,
        ScreenLayout layout,
        ILogger<CombatAnimator> logger)
    {
        _terminal = terminal;
        _animationProvider = animationProvider;
        _layout = layout;
        _logger = logger;
    }
    
    /// <inheritdoc />
    public void QueueAnimation(AnimationType type, AnimationContext context)
    {
        if (!AnimationsEnabled) return;
        
        _animationQueue.Enqueue((type, context));
        _logger.LogDebug("Queued animation {Type} for {Actor}", type, context.ActorName);
    }
    
    /// <inheritdoc />
    public async Task PlayQueuedAnimationsAsync(CancellationToken ct = default)
    {
        if (!AnimationsEnabled || _animationQueue.Count == 0) return;
        
        IsPlaying = true;
        SetupAnimationArea();
        
        _logger.LogDebug("Playing {Count} queued animations", _animationQueue.Count);
        
        try
        {
            while (_animationQueue.TryDequeue(out var item) && !ct.IsCancellationRequested)
            {
                await PlayAnimationAsync(item.Type, item.Context, ct);
                _skipRequested = false;
            }
        }
        finally
        {
            IsPlaying = false;
            ClearAnimationArea();
        }
    }
    
    /// <inheritdoc />
    public void SkipCurrent()
    {
        _skipRequested = true;
        _logger.LogDebug("Skip requested for current animation");
    }
    
    /// <inheritdoc />
    public void ClearQueue()
    {
        _animationQueue.Clear();
        _logger.LogDebug("Animation queue cleared");
    }
    
    private void SetupAnimationArea()
    {
        var panel = _layout.GetPanel(PanelPosition.MainContent);
        if (panel != null)
        {
            var area = panel.Value.ContentArea;
            _animationAreaX = area.X;
            _animationAreaY = area.Y + area.Height - 5; // Bottom of main content
            _animationAreaWidth = area.Width;
        }
    }
    
    private async Task PlayAnimationAsync(
        AnimationType type, 
        AnimationContext context,
        CancellationToken ct)
    {
        var definition = _animationProvider.GetAnimation(type);
        if (definition == null)
        {
            _logger.LogWarning("No animation definition found for {Type}", type);
            return;
        }
        
        foreach (var frame in definition.Frames)
        {
            if (_skipRequested || ct.IsCancellationRequested) break;
            
            RenderFrame(frame, context, definition);
            
            var delayMs = (int)(frame.DurationMs / SpeedMultiplier);
            await Task.Delay(delayMs, ct);
            
            if (frame.ClearPrevious)
            {
                ClearAnimationLine();
            }
        }
    }
    
    private void RenderFrame(
        AnimationFrame frame, 
        AnimationContext context,
        AnimationDefinition definition)
    {
        var text = SubstituteVariables(frame.TextTemplate, context, definition);
        
        var x = _animationAreaX;
        if (frame.Center)
        {
            x = _animationAreaX + (_animationAreaWidth - text.Length) / 2;
        }
        else if (frame.PositionX.HasValue)
        {
            x = _animationAreaX + frame.PositionX.Value;
        }
        
        var y = frame.PositionY.HasValue 
            ? _animationAreaY + frame.PositionY.Value 
            : _animationAreaY;
        
        _terminal.SetCursorPosition(Math.Max(0, x), y);
        
        if (frame.Color.HasValue)
        {
            WriteColored(text, frame.Color.Value);
        }
        else
        {
            _terminal.Write(text);
        }
    }
    
    private string SubstituteVariables(
        string template, 
        AnimationContext context,
        AnimationDefinition definition)
    {
        var result = template
            .Replace("{actor}", context.ActorName)
            .Replace("{target}", context.TargetName ?? "target")
            .Replace("{value}", context.Value?.ToString() ?? "0")
            .Replace("{ability}", context.AbilityName ?? "ability")
            .Replace("{damageType}", context.DamageType ?? "damage")
            .Replace("{status}", context.StatusName ?? "effect");
        
        // Handle {verb} with random selection from verbs list
        if (result.Contains("{verb}") && definition.Verbs?.Count > 0)
        {
            var verb = definition.Verbs[_random.Next(definition.Verbs.Count)];
            result = result.Replace("{verb}", verb);
        }
        
        return result;
    }
    
    private void ClearAnimationLine()
    {
        _terminal.SetCursorPosition(_animationAreaX, _animationAreaY);
        _terminal.Write(new string(' ', _animationAreaWidth));
    }
    
    private void ClearAnimationArea()
    {
        for (var i = 0; i < 4; i++)
        {
            _terminal.SetCursorPosition(_animationAreaX, _animationAreaY + i);
            _terminal.Write(new string(' ', _animationAreaWidth));
        }
    }
    
    private void WriteColored(string text, ConsoleColor color)
    {
        var prevColor = Console.ForegroundColor;
        Console.ForegroundColor = color;
        _terminal.Write(text);
        Console.ForegroundColor = prevColor;
    }
}
```

---

## 6. Animation Definitions

### 6.1 AnimationDefinition Record

**File:** `src/Core/RuneAndRust.Domain/ValueObjects/AnimationDefinition.cs`

```csharp
namespace RuneAndRust.Domain.ValueObjects;

/// <summary>
/// Defines an animation sequence with frames.
/// </summary>
/// <param name="Type">Type of animation.</param>
/// <param name="Frames">Ordered list of animation frames.</param>
/// <param name="DefaultDurationMs">Default frame duration if not specified.</param>
/// <param name="Verbs">Optional verbs for {verb} substitution.</param>
public record AnimationDefinition(
    AnimationType Type,
    IReadOnlyList<AnimationFrame> Frames,
    int DefaultDurationMs = 150,
    IReadOnlyList<string>? Verbs = null)
{
    /// <summary>
    /// Gets the total animation duration in milliseconds.
    /// </summary>
    public int TotalDurationMs => Frames.Sum(f => f.DurationMs);
}
```

### 6.2 AnimationFrame Record

**File:** `src/Core/RuneAndRust.Domain/ValueObjects/AnimationFrame.cs`

```csharp
namespace RuneAndRust.Domain.ValueObjects;

/// <summary>
/// Represents a single frame in an animation sequence.
/// </summary>
/// <param name="TextTemplate">Text to display with template variables.</param>
/// <param name="DurationMs">How long to display this frame.</param>
/// <param name="Color">Optional foreground color.</param>
/// <param name="PositionX">Optional X offset from animation area.</param>
/// <param name="PositionY">Optional Y offset from animation area.</param>
/// <param name="Center">Whether to center the text horizontally.</param>
/// <param name="ClearPrevious">Whether to clear before next frame.</param>
public record AnimationFrame(
    string TextTemplate,
    int DurationMs,
    ConsoleColor? Color = null,
    int? PositionX = null,
    int? PositionY = null,
    bool Center = false,
    bool ClearPrevious = true);
```

### 6.3 IAnimationProvider Interface

**File:** `src/Core/RuneAndRust.Application/Interfaces/IAnimationProvider.cs`

```csharp
namespace RuneAndRust.Application.Interfaces;

/// <summary>
/// Provides animation definitions from configuration.
/// </summary>
public interface IAnimationProvider
{
    /// <summary>
    /// Gets the animation definition for a type.
    /// </summary>
    /// <param name="type">Animation type.</param>
    /// <returns>Animation definition, or null if not found.</returns>
    AnimationDefinition? GetAnimation(AnimationType type);
    
    /// <summary>
    /// Gets all available animation types.
    /// </summary>
    IReadOnlyList<AnimationType> AvailableAnimations { get; }
}
```

### 6.4 Animation Examples

```
ATTACK HIT ANIMATION:
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
Frame 1 (100ms):  You strike the Skeleton!
Frame 2 (150ms):  * SLASH *                    [Red]
Frame 3 (200ms):  â”€â”€â”€â”€â”€â”€â–¶ -12                  [DarkRed]
Frame 4 (100ms):  The Skeleton reels!


ATTACK MISS ANIMATION:
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
Frame 1 (100ms):  You swing at the Skeleton...
Frame 2 (150ms):  * WHOOSH *                   [Gray]
Frame 3 (200ms):  MISS!                        [DarkGray]
Frame 4 (100ms):  The Skeleton dodges!


CRITICAL HIT ANIMATION:
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
Frame 1 (100ms):  You strike the Skeleton!
Frame 2 (200ms):  â˜… CRITICAL HIT! â˜…            [Magenta, centered]
Frame 3 (150ms):  â•â•â•â•â•â•â•â–¶ -24                 [DarkRed]
Frame 4 (100ms):  DEVASTATING BLOW!


ABILITY ANIMATION (Fireball):
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
Frame 1 (150ms):  You cast Fireball!
Frame 2 (100ms):      *
Frame 3 (100ms):     *.*
Frame 4 (100ms):    *.â˜¼.*                      [Yellow]
Frame 5 (100ms):     *.*
Frame 6 (100ms):      *
Frame 7 (200ms):  ğŸ”¥ 18 fire damage!           [Red]


HEALING ANIMATION:
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
Frame 1 (100ms):  You use Healing Potion!
Frame 2 (150ms):  âœ§ âœ§ âœ§                        [Green]
Frame 3 (200ms):  +25 HP                       [Green]
Frame 4 (100ms):  You feel restored!


DEATH ANIMATION:
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
Frame 1 (200ms):  The Skeleton collapses!
Frame 2 (300ms):  â˜                             [DarkGray]
Frame 3 (200ms):  [DEFEATED]


STATUS APPLIED:
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
Frame 1 (150ms):  The Skeleton is now Poisoned!  [Yellow]


DAMAGE NUMBER (Floating):
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
Frame 1:  -12                                  [Red, at Y+0]
Frame 2:  -12                                  [Red, at Y-1]
Frame 3:  -12                                  [DarkRed, at Y-2, fade]
Frame 4:  (clear)
```

---

## 7. Data Model

### 7.1 New Enums

| Enum | Layer | Description |
|------|-------|-------------|
| `AnimationType` | Domain | Types of combat animations |

### 7.2 New Value Objects

| Value Object | Layer | Description |
|--------------|-------|-------------|
| `AnimationDefinition` | Domain | Animation sequence definition |
| `AnimationFrame` | Domain | Single animation frame |

### 7.3 New Records

| Record | Layer | Description |
|--------|-------|-------------|
| `AnimationContext` | Application | Template variable context |

### 7.4 New Interfaces

| Interface | Layer | Description |
|-----------|-------|-------------|
| `ICombatAnimator` | Application | Animation playback interface |
| `IAnimationProvider` | Application | Animation definition provider |

### 7.5 New Components

| Component | Layer | Description |
|-----------|-------|-------------|
| `CombatAnimator` | Presentation | Animation playback implementation |

---

## 8. Configuration

### 8.1 animations.json

**File:** `config/animations.json`

```json
{
  "$schema": "./schemas/animations.schema.json",
  "settings": {
    "enabled": true,
    "speedMultiplier": 1.0,
    "showDamageNumbers": true,
    "skipKey": "Space"
  },
  "animations": {
    "attack-hit": {
      "frames": [
        { "text": "{actor} strikes {target}!", "duration": 100 },
        { "text": "* {verb} *", "duration": 150, "color": "Red" },
        { "text": "â”€â”€â”€â”€â”€â”€â–¶ -{value}", "duration": 200, "color": "DarkRed" },
        { "text": "{target} reels from the blow!", "duration": 100 }
      ],
      "verbs": ["SLASH", "STRIKE", "HIT", "BASH"]
    },
    "attack-miss": {
      "frames": [
        { "text": "{actor} swings at {target}...", "duration": 100 },
        { "text": "* WHOOSH *", "duration": 150, "color": "Gray" },
        { "text": "MISS!", "duration": 200, "color": "DarkGray" },
        { "text": "{target} dodges the attack!", "duration": 100 }
      ]
    },
    "critical-hit": {
      "frames": [
        { "text": "{actor} strikes {target}!", "duration": 100 },
        { "text": "â˜… CRITICAL HIT! â˜…", "duration": 200, "color": "Magenta", "center": true },
        { "text": "â•â•â•â•â•â•â•â–¶ -{value}", "duration": 150, "color": "DarkRed" },
        { "text": "DEVASTATING BLOW!", "duration": 100 }
      ]
    },
    "ability-cast": {
      "frames": [
        { "text": "{actor} casts {ability}!", "duration": 150 },
        { "text": "    *", "duration": 80 },
        { "text": "   *.*", "duration": 80 },
        { "text": "  *.â˜¼.*", "duration": 100, "color": "Yellow" },
        { "text": "   *.*", "duration": 80 },
        { "text": "    *", "duration": 80 }
      ]
    },
    "ability-effect": {
      "frames": [
        { "text": "ğŸ”¥ {value} {damageType} damage!", "duration": 200, "color": "Red" }
      ]
    },
    "heal": {
      "frames": [
        { "text": "{actor} uses {ability}!", "duration": 100 },
        { "text": "âœ§ âœ§ âœ§", "duration": 150, "color": "Green" },
        { "text": "+{value} HP", "duration": 200, "color": "Green" },
        { "text": "You feel restored!", "duration": 100 }
      ]
    },
    "damage-number": {
      "frames": [
        { "text": "-{value}", "duration": 100, "color": "Red", "positionY": 0 },
        { "text": "-{value}", "duration": 100, "color": "Red", "positionY": -1 },
        { "text": "-{value}", "duration": 100, "color": "DarkRed", "positionY": -2 }
      ]
    },
    "death": {
      "frames": [
        { "text": "{target} collapses!", "duration": 200 },
        { "text": "â˜ ", "duration": 300, "color": "DarkGray", "center": true },
        { "text": "[DEFEATED]", "duration": 200, "center": true }
      ]
    },
    "status-applied": {
      "frames": [
        { "text": "{target} is now {status}!", "duration": 150, "color": "Yellow" }
      ]
    },
    "status-removed": {
      "frames": [
        { "text": "{status} wears off from {target}.", "duration": 150, "color": "Gray" }
      ]
    }
  }
}
```

### 8.2 Configuration Schema

| Property | Type | Default | Description |
|----------|------|---------|-------------|
| `settings.enabled` | bool | true | Enable/disable animations |
| `settings.speedMultiplier` | float | 1.0 | Animation speed (0.5 = slow, 2.0 = fast) |
| `settings.showDamageNumbers` | bool | true | Show floating damage numbers |
| `settings.skipKey` | string | Space | Key to skip current animation |
| `animations.*.frames` | array | - | List of animation frames |
| `animations.*.frames[].text` | string | - | Template text with variables |
| `animations.*.frames[].duration` | int | 150 | Frame duration in ms |
| `animations.*.frames[].color` | string | null | ConsoleColor name |
| `animations.*.frames[].center` | bool | false | Center text horizontally |
| `animations.*.verbs` | array | null | Verbs for {verb} substitution |

---

## 9. Logging Specifications

### 9.1 Log Levels by Component

| Component | Level | Events |
|-----------|-------|--------|
| `CombatAnimator` | Debug | Queue, play, skip, clear |
| `CombatAnimator` | Warning | Missing animation definition |
| `AnimationProvider` | Information | Animations loaded |

### 9.2 Log Message Templates

```csharp
// CombatAnimator
_logger.LogDebug("Queued animation {Type} for {Actor}", type, actorName);
_logger.LogDebug("Playing {Count} queued animations", count);
_logger.LogDebug("Skip requested for current animation");
_logger.LogDebug("Animation queue cleared");
_logger.LogWarning("No animation definition found for {Type}", type);

// AnimationProvider
_logger.LogInformation("Loaded {Count} animation definitions", count);
```

---

## 10. Unit Testing Requirements

### 10.1 Test Count by Feature

| Feature | Test Count |
|---------|------------|
| CombatAnimator | 7 |
| AnimationDefinition | 2 |
| AnimationFrame | 2 |
| AnimationProvider | 2 |
| Template substitution | 2 |
| **Total** | **~15** |

### 10.2 Test Specifications

#### CombatAnimatorTests.cs

```csharp
[TestFixture]
public class CombatAnimatorTests
{
    [Test]
    public void QueueAnimation_AddsToQueue();
    
    [Test]
    public void QueueAnimation_WhenDisabled_DoesNotQueue();
    
    [Test]
    public async Task PlayQueuedAnimationsAsync_PlaysAllAnimations();
    
    [Test]
    public void SkipCurrent_SetsSkipFlag();
    
    [Test]
    public void ClearQueue_RemovesAllAnimations();
    
    [Test]
    public void SpeedMultiplier_AffectsFrameDuration();
    
    [Test]
    public void IsPlaying_TrueWhilePlaying();
}
```

#### AnimationDefinitionTests.cs

```csharp
[TestFixture]
public class AnimationDefinitionTests
{
    [Test]
    public void TotalDurationMs_SumsAllFrameDurations();
    
    [Test]
    public void Constructor_SetsAllProperties();
}
```

#### AnimationFrameTests.cs

```csharp
[TestFixture]
public class AnimationFrameTests
{
    [Test]
    public void DefaultValues_AreCorrect();
    
    [Test]
    public void Constructor_SetsAllProperties();
}
```

#### TemplateSubstitutionTests.cs

```csharp
[TestFixture]
public class TemplateSubstitutionTests
{
    [Test]
    public void SubstituteVariables_ReplacesAllPlaceholders();
    
    [Test]
    public void SubstituteVariables_WithVerb_SelectsRandomVerb();
}
```

---

## 11. Use Cases

### UC-001: Attack Hits
**Actor:** Combat System
**Flow:** Attack resolves as hit â†’ QueueAnimation(AttackHit, context) â†’ PlayQueuedAnimationsAsync() â†’ Frames display sequentially

### UC-002: Critical Strike
**Actor:** Combat System
**Flow:** Attack is critical â†’ QueueAnimation(CriticalHit, context) â†’ Enhanced animation with â˜… CRITICAL HIT! â˜…

### UC-003: Cast Ability
**Actor:** Combat System
**Flow:** Ability used â†’ QueueAnimation(AbilityCast) â†’ AbilityEffect queued â†’ Both play in sequence

### UC-004: Skip Animation
**Actor:** Player
**Flow:** Animation playing â†’ Press Space â†’ SkipCurrent() â†’ Current animation ends â†’ Next plays

### UC-005: Entity Death
**Actor:** Combat System
**Flow:** Entity HP reaches 0 â†’ QueueAnimation(Death, context) â†’ Death sequence plays â†’ â˜  displayed

---

## 12. Deliverable Checklist

### ICombatAnimator Interface
- [ ] `ICombatAnimator` interface created
- [ ] QueueAnimation() method defined
- [ ] PlayQueuedAnimationsAsync() method defined
- [ ] SkipCurrent() method defined
- [ ] ClearQueue() method defined
- [ ] AnimationsEnabled property defined
- [ ] SpeedMultiplier property defined
- [ ] IsPlaying property defined
- [ ] QueueCount property defined

### CombatAnimator Implementation
- [ ] `CombatAnimator` class created
- [ ] Animation queue implemented
- [ ] Frame playback implemented
- [ ] Template variable substitution implemented
- [ ] Color rendering implemented
- [ ] Skip functionality implemented
- [ ] Speed multiplier implemented
- [ ] Animation area calculation implemented

### Animation Definitions
- [ ] `AnimationDefinition` record created
- [ ] `AnimationFrame` record created
- [ ] `AnimationType` enum created
- [ ] `AnimationContext` record created
- [ ] `IAnimationProvider` interface created

### Configuration
- [ ] `config/animations.json` created
- [ ] All 10 animation types defined
- [ ] Settings section with defaults

### Testing
- [ ] ~15 unit tests implemented
- [ ] All tests passing

---

## 13. Acceptance Criteria

### Functional
- [ ] Attack hit animation plays with frames
- [ ] Attack miss animation displays correctly
- [ ] Critical hit has enhanced animation with centered text
- [ ] Ability cast shows expanding effect
- [ ] Ability effect shows damage with type
- [ ] Damage numbers display with value
- [ ] Healing shows positive numbers in green
- [ ] Death animation plays with â˜  symbol
- [ ] Status effect application animates
- [ ] Status effect removal animates
- [ ] Animations queue and play sequentially
- [ ] Skip key advances/completes current animation
- [ ] Speed multiplier affects frame timing
- [ ] Animations can be disabled
- [ ] Template variables substitute correctly
- [ ] Random verb selection works

### Quality
- [ ] Build succeeds with 0 errors
- [ ] Build succeeds with 0 warnings
- [ ] All ~15 unit tests pass
- [ ] XML documentation complete on all public members

---

## 14. Dependencies

### Required from v0.6.0a

| Type | Location | Usage in this phase |
|------|----------|---------------------|
| `ScreenLayout` | `Presentation/UI/ScreenLayout.cs` | Animation area position |
| `ITerminalService` | `Application/Interfaces/ITerminalService.cs` | Text output |

### Required from v0.6.2a

| Type | Location | Usage |
|------|----------|-------|
| `CombatGridView` | `Presentation/UI/CombatGridView.cs` | Display integration |
| Grid panel area | - | Animation rendering target |

### Required from Prior Versions

| Type | Location | Usage |
|------|----------|-------|
| `IGameConfigurationProvider` | `Application/Interfaces/` | Loading animations.json |

### Provides to Future

| Type | Usage |
|------|-------|
| `ICombatAnimator` | Combat service integration |
| Animation pattern | Extendable for new animations |

---

## 15. Future Considerations

### Deferred to v0.9.x
- **Sound Effects**: Audio tied to animations
- **Music Cues**: Combat music on animation events

### Deferred to v0.7.x (GUI)
- **Particle Effects**: True graphical particles
- **Sprite Animations**: Image-based animations
- **Smooth Movement**: Entity position lerping

### Out of Scope
- **3D Effects**: Camera shake, zoom
- **Video Cutscenes**: Pre-rendered sequences

---

*Document Version: 1.0*
*Last Updated: 2026-01-10*
*Author: Assistant*
