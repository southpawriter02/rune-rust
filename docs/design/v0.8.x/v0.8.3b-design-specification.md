# v0.8.3b Design Specification: Overlay Refinement

**Version:** 0.8.3b
**Parent:** v0.8.3 (Combat Enhancement)
**Prerequisites:** v0.8.3a Complete (Combat Visual Feedback)
**Status:** Design Complete
**Estimated Unit Tests:** ~10

---

## 1. Overview

### Purpose

Enhance combat grid overlays with improved visual clarity: gradient-based movement range (brighter near player, dimmer at edges), pulsing attack range, refined AoE previews, path previews on hover, and a quick-slot bar for ability/item shortcuts (1-8 keys). Action bar receives keyboard shortcut hints.

### Key Deliverables

| Category | Items |
|----------|-------|
| **Controls** | `QuickSlotBar`, `QuickSlotControl` |
| **ViewModels** | `QuickSlotBarViewModel`, `QuickSlotViewModel` |
| **Overlays** | `MovementRangeOverlay`, `AttackRangeOverlay`, `AoEPreviewOverlay` |
| **Styles** | `CombatOverlayStyles.axaml` |
| **Tests** | ~10 unit tests |

---

## 2. Feature Overview

```
v0.8.3b Features
â”œâ”€â”€ Enhanced Movement Range Overlay
â”‚   â”œâ”€â”€ Gradient opacity (bright center â†’ dim edges)
â”‚   â”œâ”€â”€ Distance-based coloring
â”‚   â””â”€â”€ Current path cost display
â”‚
â”œâ”€â”€ Attack Range Overlay
â”‚   â”œâ”€â”€ Subtle pulse animation
â”‚   â”œâ”€â”€ Melee vs ranged styling
â”‚   â””â”€â”€ Line-of-sight indicators
â”‚
â”œâ”€â”€ AoE Preview Overlay
â”‚   â”œâ”€â”€ Semi-transparent fill
â”‚   â”œâ”€â”€ Affected targets highlight
â”‚   â””â”€â”€ Center crosshair
â”‚
â”œâ”€â”€ Path Preview
â”‚   â”œâ”€â”€ Dotted line on hover
â”‚   â”œâ”€â”€ Movement cost display
â”‚   â””â”€â”€ Blocked path indicator
â”‚
â”œâ”€â”€ QuickSlotBar (1-8)
â”‚   â”œâ”€â”€ Ability assignment
â”‚   â”œâ”€â”€ Item assignment
â”‚   â”œâ”€â”€ Cooldown display
â”‚   â”œâ”€â”€ Keyboard activation
â”‚   â””â”€â”€ Drag-to-assign
â”‚
â”œâ”€â”€ Action Bar Polish
â”‚   â”œâ”€â”€ Keyboard hint labels
â”‚   â”œâ”€â”€ Icon refinement
â”‚   â””â”€â”€ Disabled state styling
â”‚
â””â”€â”€ Target Cycling
    â”œâ”€â”€ Tab key cycles targets
    â””â”€â”€ Visual indicator on selected
```

---

## 3. Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                       PRESENTATION LAYER                                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Controls                                                               â”‚
â”‚  â”œâ”€â”€ QuickSlotBar : UserControl                                        â”‚
â”‚  â”‚    â””â”€â”€ ItemsControl of QuickSlotControl                             â”‚
â”‚  â””â”€â”€ QuickSlotControl : TemplatedControl                               â”‚
â”‚       â”œâ”€â”€ int SlotNumber (1-8)                                         â”‚
â”‚       â”œâ”€â”€ string? Icon                                                 â”‚
â”‚       â”œâ”€â”€ string? Name                                                 â”‚
â”‚       â”œâ”€â”€ bool IsOnCooldown                                            â”‚
â”‚       â””â”€â”€ double CooldownRemaining                                     â”‚
â”‚                                                                         â”‚
â”‚  ViewModels                                                             â”‚
â”‚  â”œâ”€â”€ QuickSlotBarViewModel                                             â”‚
â”‚  â”‚    â”œâ”€â”€ ObservableCollection<QuickSlotViewModel> Slots               â”‚
â”‚  â”‚    â”œâ”€â”€ [RelayCommand] UseSlot(int)                                  â”‚
â”‚  â”‚    â””â”€â”€ [RelayCommand] AssignToSlot(int, object)                     â”‚
â”‚  â””â”€â”€ QuickSlotViewModel                                                â”‚
â”‚       â”œâ”€â”€ int SlotNumber                                               â”‚
â”‚       â”œâ”€â”€ AbilityDefinition? AssignedAbility                           â”‚
â”‚       â”œâ”€â”€ Item? AssignedItem                                           â”‚
â”‚       â””â”€â”€ bool CanUse                                                  â”‚
â”‚                                                                         â”‚
â”‚  Overlay Renderers                                                      â”‚
â”‚  â”œâ”€â”€ MovementRangeOverlay : Control                                    â”‚
â”‚  â”œâ”€â”€ AttackRangeOverlay : Control                                      â”‚
â”‚  â””â”€â”€ AoEPreviewOverlay : Control                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 4. Movement Range Overlay (Gradient)

**File:** `src/Presentation/RuneAndRust.Avalonia/Controls/MovementRangeOverlay.cs`

```csharp
namespace RuneAndRust.Avalonia.Controls;

public class MovementRangeOverlay : Control
{
    public static readonly StyledProperty<IReadOnlyList<GridPosition>> ReachablePositionsProperty =
        AvaloniaProperty.Register<MovementRangeOverlay, IReadOnlyList<GridPosition>>(nameof(ReachablePositions));
    public static readonly StyledProperty<GridPosition> OriginProperty =
        AvaloniaProperty.Register<MovementRangeOverlay, GridPosition>(nameof(Origin));
    public static readonly StyledProperty<int> MaxDistanceProperty =
        AvaloniaProperty.Register<MovementRangeOverlay, int>(nameof(MaxDistance));

    public IReadOnlyList<GridPosition> ReachablePositions { get => GetValue(ReachablePositionsProperty); set => SetValue(ReachablePositionsProperty, value); }
    public GridPosition Origin { get => GetValue(OriginProperty); set => SetValue(OriginProperty, value); }
    public int MaxDistance { get => GetValue(MaxDistanceProperty); set => SetValue(MaxDistanceProperty, value); }

    public override void Render(DrawingContext context)
    {
        if (ReachablePositions is null) return;

        foreach (var pos in ReachablePositions)
        {
            var distance = CalculateDistance(Origin, pos);
            var opacity = CalculateOpacity(distance, MaxDistance);
            var brush = new SolidColorBrush(Colors.DeepSkyBlue, opacity);
            var rect = GetCellRect(pos);
            context.FillRectangle(brush, rect);
        }
    }

    private double CalculateOpacity(int distance, int maxDistance)
    {
        // Gradient: 1 cell = 0.7, max = 0.2
        if (maxDistance == 0) return 0.5;
        return 0.7 - (0.5 * distance / maxDistance);
    }

    private int CalculateDistance(GridPosition a, GridPosition b) =>
        Math.Abs(a.X - b.X) + Math.Abs(a.Y - b.Y);

    private Rect GetCellRect(GridPosition pos) =>
        new Rect(pos.X * CellSize, pos.Y * CellSize, CellSize, CellSize);

    private const double CellSize = 48;
}
```

---

## 5. QuickSlotBar

**File:** `src/Presentation/RuneAndRust.Avalonia/Controls/QuickSlotBar.axaml`

```xml
<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:vm="using:RuneAndRust.Avalonia.ViewModels"
             xmlns:controls="using:RuneAndRust.Avalonia.Controls"
             x:Class="RuneAndRust.Avalonia.Controls.QuickSlotBar"
             x:DataType="vm:QuickSlotBarViewModel">
    
    <Border Classes="quickslot-bar" Padding="8,4">
        <StackPanel Orientation="Horizontal" Spacing="4">
            <ItemsControl ItemsSource="{Binding Slots}">
                <ItemsControl.ItemsPanel>
                    <ItemsPanelTemplate><StackPanel Orientation="Horizontal" Spacing="4" /></ItemsPanelTemplate>
                </ItemsControl.ItemsPanel>
                <ItemsControl.ItemTemplate>
                    <DataTemplate DataType="vm:QuickSlotViewModel">
                        <controls:QuickSlotControl
                            SlotNumber="{Binding SlotNumber}"
                            Icon="{Binding Icon}"
                            Name="{Binding Name}"
                            IsOnCooldown="{Binding IsOnCooldown}"
                            CooldownRemaining="{Binding CooldownRemaining}"
                            IsEnabled="{Binding CanUse}"
                            PointerPressed="OnSlotPressed" />
                    </DataTemplate>
                </ItemsControl.ItemTemplate>
            </ItemsControl>
        </StackPanel>
    </Border>
</UserControl>
```

### QuickSlotControl

```csharp
namespace RuneAndRust.Avalonia.Controls;

public class QuickSlotControl : TemplatedControl
{
    public static readonly StyledProperty<int> SlotNumberProperty = AvaloniaProperty.Register<QuickSlotControl, int>(nameof(SlotNumber));
    public static readonly StyledProperty<string?> IconProperty = AvaloniaProperty.Register<QuickSlotControl, string?>(nameof(Icon));
    public static readonly StyledProperty<string?> NameProperty = AvaloniaProperty.Register<QuickSlotControl, string?>(nameof(Name));
    public static readonly StyledProperty<bool> IsOnCooldownProperty = AvaloniaProperty.Register<QuickSlotControl, bool>(nameof(IsOnCooldown));
    public static readonly StyledProperty<double> CooldownRemainingProperty = AvaloniaProperty.Register<QuickSlotControl, double>(nameof(CooldownRemaining));

    public int SlotNumber { get => GetValue(SlotNumberProperty); set => SetValue(SlotNumberProperty, value); }
    public string? Icon { get => GetValue(IconProperty); set => SetValue(IconProperty, value); }
    public string? Name { get => GetValue(NameProperty); set => SetValue(NameProperty, value); }
    public bool IsOnCooldown { get => GetValue(IsOnCooldownProperty); set => SetValue(IsOnCooldownProperty, value); }
    public double CooldownRemaining { get => GetValue(CooldownRemainingProperty); set => SetValue(CooldownRemainingProperty, value); }

    public bool IsEmpty => string.IsNullOrEmpty(Icon);
    public string Keybind => SlotNumber.ToString();
}
```

---

## 6. QuickSlotBarViewModel

```csharp
namespace RuneAndRust.Avalonia.ViewModels;

public partial class QuickSlotBarViewModel : ViewModelBase
{
    private readonly IAbilityService _abilityService;
    private readonly IInventoryService _inventoryService;
    private readonly ILogger<QuickSlotBarViewModel> _logger;

    [ObservableProperty]
    private ObservableCollection<QuickSlotViewModel> _slots = new();

    public QuickSlotBarViewModel(IAbilityService abilityService, IInventoryService inventoryService, ILogger<QuickSlotBarViewModel> logger)
    {
        _abilityService = abilityService;
        _inventoryService = inventoryService;
        _logger = logger;
        for (int i = 1; i <= 8; i++) Slots.Add(new QuickSlotViewModel(i));
        LoadAssignments();
    }

    [RelayCommand]
    private void UseSlot(int slotNumber)
    {
        var slot = Slots.FirstOrDefault(s => s.SlotNumber == slotNumber);
        if (slot?.IsEmpty != false) return;

        if (slot.AssignedAbility is not null)
        {
            _abilityService.UseAbility(slot.AssignedAbility.AbilityId);
            _logger.LogDebug("Used ability from slot {Slot}: {Ability}", slotNumber, slot.AssignedAbility.Name);
        }
        else if (slot.AssignedItem is not null)
        {
            _inventoryService.UseItem(slot.AssignedItem.Id);
            _logger.LogDebug("Used item from slot {Slot}: {Item}", slotNumber, slot.AssignedItem.Name);
        }
    }

    [RelayCommand]
    private void AssignToSlot(int slotNumber, object item)
    {
        var slot = Slots.FirstOrDefault(s => s.SlotNumber == slotNumber);
        if (slot is null) return;

        if (item is AbilityDefinition ability) slot.AssignAbility(ability);
        else if (item is Item consumable) slot.AssignItem(consumable);
        SaveAssignments();
    }

    public void HandleKeyPress(Key key)
    {
        if (key >= Key.D1 && key <= Key.D8)
            UseSlotCommand.Execute(key - Key.D1 + 1);
        else if (key >= Key.NumPad1 && key <= Key.NumPad8)
            UseSlotCommand.Execute(key - Key.NumPad1 + 1);
    }

    private void LoadAssignments() { /* Load from settings */ }
    private void SaveAssignments() { /* Save to settings */ }
}

public partial class QuickSlotViewModel : ViewModelBase
{
    public int SlotNumber { get; }
    [ObservableProperty] private AbilityDefinition? _assignedAbility;
    [ObservableProperty] private Item? _assignedItem;
    [ObservableProperty] private bool _isOnCooldown;
    [ObservableProperty] private double _cooldownRemaining;

    public bool IsEmpty => AssignedAbility is null && AssignedItem is null;
    public string? Icon => AssignedAbility?.Icon ?? AssignedItem?.Icon;
    public string? Name => AssignedAbility?.Name ?? AssignedItem?.Name;
    public bool CanUse => !IsEmpty && !IsOnCooldown;

    public QuickSlotViewModel(int slotNumber) => SlotNumber = slotNumber;
    public void AssignAbility(AbilityDefinition ability) { AssignedAbility = ability; AssignedItem = null; }
    public void AssignItem(Item item) { AssignedItem = item; AssignedAbility = null; }
    public void Clear() { AssignedAbility = null; AssignedItem = null; }
}
```

---

## 7. Visual Designs

```
MOVEMENT RANGE (gradient opacity):
       1     2     3     4     5     6     7
    â”Œâ”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”
  B â”‚  â–‘  â”‚ â–’â–’â–’ â”‚ â–’â–’â–’ â”‚ â–’â–’â–’ â”‚  â–‘  â”‚  â–‘  â”‚  â–‘  â”‚  â–‘ = outside range
    â”œâ”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”¤  â–’ = 4+ cells (0.2 opacity)
  C â”‚  â–‘  â”‚ â–’â–’â–’ â”‚ â–“â–“â–“ â”‚ â–“â–“â–“ â”‚ â–’â–’â–’ â”‚  â–‘  â”‚  â–‘  â”‚  â–“ = 2-3 cells (0.45 opacity)
    â”œâ”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”¤  â–ˆ = 1 cell (0.7 opacity)
  D â”‚  â–‘  â”‚ â–“â–“â–“ â”‚ â–ˆâ–ˆâ–ˆ â”‚ [@] â”‚ â–ˆâ–ˆâ–ˆ â”‚ â–“â–“â–“ â”‚  â–‘  â”‚
    â”œâ”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”¤
  E â”‚  â–‘  â”‚ â–’â–’â–’ â”‚ â–“â–“â–“ â”‚ â–“â–“â–“ â”‚ â–’â–’â–’ â”‚  â–‘  â”‚  â–‘  â”‚
    â””â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”˜

PATH PREVIEW (on hover):
  D â”‚  â–‘  â”‚  â—â”€â”€â”‚â”€â”€â—â”€â”€â”‚â”€â”€â—  â”‚  â–‘  â”‚  â–‘  â”‚  â–‘  â”‚  â— = path nodes
    â”‚     â”‚     â”‚     â”‚  â”‚  â”‚     â”‚     â”‚     â”‚  [X] = target
  E â”‚  â–‘  â”‚ [@] â”‚  â–‘  â”‚ [X] â”‚  â–‘  â”‚  â–‘  â”‚  â–‘  â”‚  Cost: 3

QUICK-SLOT BAR:
â”Œâ”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”
â”‚ ğŸ”¥  â”‚ â”‚ â„   â”‚ â”‚ âš¡  â”‚ â”‚ ğŸ§ª  â”‚ â”‚     â”‚ â”‚     â”‚ â”‚     â”‚ â”‚     â”‚
â”‚  1  â”‚ â”‚  2  â”‚ â”‚  3  â”‚ â”‚  4  â”‚ â”‚  5  â”‚ â”‚  6  â”‚ â”‚  7  â”‚ â”‚  8  â”‚
â””â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”˜

ACTION BAR WITH HINTS:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚    âš”    â”‚ â”‚    ğŸƒ   â”‚ â”‚    âœ¨   â”‚ â”‚    ğŸ›¡   â”‚ â”‚    ğŸ“¦   â”‚
â”‚  Attack â”‚ â”‚   Move  â”‚ â”‚ Ability â”‚ â”‚  Defend â”‚ â”‚   Item  â”‚
â”‚   (A)   â”‚ â”‚   (M)   â”‚ â”‚   (B)   â”‚ â”‚   (D)   â”‚ â”‚   (I)   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   [ End Turn (Space) ]
```

---

## 8. Styles

**File:** `src/Presentation/RuneAndRust.Avalonia/Styles/CombatOverlayStyles.axaml`

```xml
<Styles xmlns="https://github.com/avaloniaui" xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml">
    <Style Selector="Border.quickslot-bar">
        <Setter Property="Background" Value="{StaticResource SurfaceDarkBrush}" />
        <Setter Property="CornerRadius" Value="4" />
    </Style>
    <Style Selector="controls|QuickSlotControl">
        <Setter Property="Width" Value="48" /><Setter Property="Height" Value="48" />
        <Setter Property="Cursor" Value="Hand" />
    </Style>
    <Style Selector="controls|QuickSlotControl:disabled">
        <Setter Property="Opacity" Value="0.5" />
    </Style>
    <Style Selector="controls|QuickSlotControl.cooldown">
        <Setter Property="Opacity" Value="0.6" />
    </Style>
    <Style Selector="TextBlock.keybind-hint">
        <Setter Property="FontSize" Value="10" />
        <Setter Property="Foreground" Value="{StaticResource MutedBrush}" />
    </Style>
</Styles>
```

---

## 9. Unit Testing Requirements (~10 tests)

| Feature | Tests |
|---------|-------|
| MovementRangeOverlay gradient calc | 2 |
| QuickSlotBar initialization | 1 |
| UseSlot ability activation | 1 |
| UseSlot item activation | 1 |
| AssignToSlot ability | 1 |
| AssignToSlot item | 1 |
| Keyboard 1-8 triggers slots | 1 |
| Tab target cycling | 1 |
| Path preview cost calculation | 1 |

---

## 10. Acceptance Criteria

- [ ] Movement range shows gradient (bright â†’ dim)
- [ ] Closer cells are brighter (0.7 opacity)
- [ ] Far cells are dimmer (0.2 opacity)
- [ ] Path preview shows on hover
- [ ] Path preview shows movement cost
- [ ] Attack range pulses subtly
- [ ] AoE preview shows filled area
- [ ] Quick-slot bar displays 8 slots
- [ ] 1-8 keys activate quick slots
- [ ] Drag to assign to quick slots
- [ ] Action buttons show keyboard hints
- [ ] Tab cycles through targets
- [ ] Target indicator shows on selected
- [ ] ~10 unit tests pass

---

## 11. Dependencies

| From | Required |
|------|----------|
| v0.8.3a | `AttackAnimationService` patterns |
| v0.7.4 | `CombatGridPanel`, `GridInteractionService` |
| Application | `IAbilityService`, `IInventoryService` |

---

*Document Version: 1.0 | Last Updated: 2026-01-10*
