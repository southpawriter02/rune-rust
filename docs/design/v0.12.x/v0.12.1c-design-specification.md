# v0.12.1c Design Specification: Leaderboards

**Version:** 0.12.1c
**Parent:** v0.12.1 (Achievements & Leaderboards)
**Prerequisites:** v0.12.1b Complete (Achievement Service)
**Status:** Design Complete

---

## Table of Contents

1. [Executive Summary](#1-executive-summary)
2. [Feature Overview](#2-feature-overview)
3. [Architecture Diagrams](#3-architecture-diagrams)
4. [LeaderboardCategory Enum](#4-leaderboardcategory-enum)
5. [LeaderboardEntry Entity](#5-leaderboardentry-entity)
6. [ILeaderboardService Interface](#6-ileaderboardservice-interface)
7. [LeaderboardService Implementation](#7-leaderboardservice-implementation)
8. [Leaderboard Persistence](#8-leaderboard-persistence)
9. [LeaderboardCommand](#9-leaderboardcommand)
10. [Leaderboard View UI](#10-leaderboard-view-ui)
11. [Score Calculation](#11-score-calculation)
12. [Logging Specifications](#12-logging-specifications)
13. [Unit Testing Requirements](#13-unit-testing-requirements)
14. [Use Cases](#14-use-cases)
15. [Deliverable Checklist](#15-deliverable-checklist)
16. [Acceptance Criteria](#16-acceptance-criteria)
17. [Dependencies](#17-dependencies)
18. [Future Considerations](#18-future-considerations)

---

## 1. Executive Summary

### Overview

Version 0.12.1c implements the local leaderboard system for the Achievements & Leaderboards feature. This includes the `LeaderboardEntry` entity for storing score records, the `LeaderboardCategory` enum with five categories (HighScore, Speedrun, NoDeath, AchievementPoints, BossSlayer), the `ILeaderboardService` interface and implementation for score submission and retrieval, local JSON persistence for leaderboard data, and the `LeaderboardCommand` with full leaderboard view UI. This completes the v0.12.1 Achievements & Leaderboards series.

### Key Deliverables

| Category | Items |
|----------|-------|
| **Domain Entities** | LeaderboardEntry |
| **Domain Enums** | LeaderboardCategory |
| **Interfaces** | ILeaderboardService |
| **Services** | LeaderboardService |
| **Persistence** | leaderboard.json |
| **Commands** | LeaderboardCommand |
| **Tests** | ~11 new unit tests |

### Architectural Significance

This version establishes the **Leaderboard Pattern** for competitive meta-progression:
- Local JSON persistence for offline play support
- Category-based score organization
- Maximum entry limits per category (100)
- Current player highlighting in rankings
- Integration with statistics and achievements for scoring

---

## 2. Feature Overview

```
v0.12.1c Leaderboard Features
├── LeaderboardCategory Enum
│   ├── HighScore (total score)
│   ├── Speedrun (fastest completion)
│   ├── NoDeath (highest level without dying)
│   ├── AchievementPoints (most achievement points)
│   └── BossSlayer (most bosses defeated)
│
├── LeaderboardEntry Entity
│   ├── Id (Guid)
│   ├── PlayerName
│   ├── ClassName
│   ├── Level
│   ├── Score
│   ├── Category
│   ├── AchievedAt
│   └── CompletionTime (for speedrun)
│
├── ILeaderboardService Interface
│   ├── SubmitScore(player, category)
│   ├── GetLeaderboard(category, count)
│   ├── GetPlayerRank(player, category)
│   ├── GetPlayerBest(player, category)
│   └── CalculateScore(player)
│
├── LeaderboardService Implementation
│   ├── Score submission
│   ├── Entry persistence
│   ├── Ranking calculation
│   ├── Max entries enforcement
│   └── Category filtering
│
├── Leaderboard Persistence
│   ├── leaderboard.json file
│   ├── Auto-save on submission
│   ├── Load on startup
│   └── 100 entries max per category
│
├── LeaderboardCommand
│   ├── leaderboard [category]
│   ├── Category tab navigation
│   └── Current player highlighting
│
└── Score Calculation
    ├── Base score from stats
    ├── Level multiplier
    ├── Achievement bonus
    └── Death penalty
```

---

## 3. Architecture Diagrams

### 3.1 Leaderboard Service Architecture

```
┌─────────────────────────────────────────────────────────────────────┐
│                   LEADERBOARD SERVICE ARCHITECTURE                   │
└─────────────────────────────────────────────────────────────────────┘

                    ┌───────────────────────────────┐
                    │         Game Systems          │
                    │   (Game Over, Completion)     │
                    └───────────────┬───────────────┘
                                    │ submit score
                                    ▼
                    ┌───────────────────────────────┐
                    │      ILeaderboardService       │
                    ├───────────────────────────────┤
                    │ + SubmitScore(player, cat)    │
                    │ + GetLeaderboard(cat, count)  │
                    │ + GetPlayerRank(player, cat)  │
                    │ + GetPlayerBest(player, cat)  │
                    │ + CalculateScore(player)      │
                    └───────────────┬───────────────┘
                                    │
                    ┌───────────────┴───────────────┐
                    │       LeaderboardService       │
                    ├───────────────────────────────┤
                    │ - _statisticsService          │
                    │ - _achievementService         │
                    │ - _persistenceService         │
                    │ - _entries: List<Entry>       │
                    │                               │
                    │ + CalculateHighScore()        │
                    │ + CalculateSpeedrunScore()    │
                    │ + EnforceMaxEntries()         │
                    │ + SaveLeaderboard()           │
                    └───────────────────────────────┘
                             │           │
                             ▼           ▼
            ┌─────────────────────┐  ┌─────────────────────────┐
            │  IStatisticsService │  │  IAchievementService    │
            │  (get player stats) │  │  (get achievement pts)  │
            └─────────────────────┘  └─────────────────────────┘
                                            │
                                            ▼
                            ┌───────────────────────────────┐
                            │    data/leaderboard.json      │
                            │   (local persistence)         │
                            └───────────────────────────────┘
```

### 3.2 Score Submission Flow

```
┌─────────────────────────────────────────────────────────────────────┐
│                      SCORE SUBMISSION FLOW                           │
└─────────────────────────────────────────────────────────────────────┘

    Trigger: Game Over / Run Completion
                    │
                    ▼
    ┌───────────────────────────────────────────────────────────────┐
    │                 1. CALCULATE SCORE                             │
    │                                                                │
    │   score = CalculateScore(player)                              │
    │   - Get base score from statistics                            │
    │   - Apply level multiplier                                     │
    │   - Add achievement point bonus                               │
    │   - Apply death penalty (if applicable)                       │
    └───────────────────────────────────────────────────────────────┘
                    │
                    ▼
    ┌───────────────────────────────────────────────────────────────┐
    │                 2. CREATE ENTRY                                │
    │                                                                │
    │   entry = LeaderboardEntry.Create(                            │
    │       playerName: player.Name,                                │
    │       className: player.Class.Name,                           │
    │       level: player.Level,                                    │
    │       score: score,                                           │
    │       category: LeaderboardCategory.HighScore,                │
    │       completionTime: runTime)                                │
    └───────────────────────────────────────────────────────────────┘
                    │
                    ▼
    ┌───────────────────────────────────────────────────────────────┐
    │                 3. CHECK IF QUALIFIES                          │
    │                                                                │
    │   existingEntries = GetEntriesForCategory(category)           │
    │                                                                │
    │   if entries.Count < MAX_ENTRIES:                             │
    │       ADD entry                                                │
    │   else if score > lowestScore:                                │
    │       REPLACE lowest entry                                     │
    │   else:                                                        │
    │       REJECT (doesn't qualify)                                │
    └───────────────────────────────────────────────────────────────┘
                    │
                    ▼
    ┌───────────────────────────────────────────────────────────────┐
    │                 4. PERSIST & LOG                               │
    │                                                                │
    │   SaveLeaderboard()                                           │
    │   _logger.LogInformation("Score submitted: {Score}", score)   │
    └───────────────────────────────────────────────────────────────┘
```

### 3.3 Leaderboard View Flow

```
┌─────────────────────────────────────────────────────────────────────┐
│                      LEADERBOARD VIEW FLOW                           │
└─────────────────────────────────────────────────────────────────────┘

    User enters: leaderboard [category]
                    │
                    ▼
    ┌───────────────────────────────────────────────────────────────┐
    │                 1. PARSE CATEGORY                              │
    │                                                                │
    │   category = argument ?? LeaderboardCategory.HighScore        │
    │   (default to HighScore if no argument)                       │
    └───────────────────────────────────────────────────────────────┘
                    │
                    ▼
    ┌───────────────────────────────────────────────────────────────┐
    │                 2. GET LEADERBOARD DATA                        │
    │                                                                │
    │   entries = leaderboardService.GetLeaderboard(category, 10)   │
    │   playerRank = leaderboardService.GetPlayerRank(player, cat)  │
    │   playerBest = leaderboardService.GetPlayerBest(player, cat)  │
    └───────────────────────────────────────────────────────────────┘
                    │
                    ▼
    ┌───────────────────────────────────────────────────────────────┐
    │                 3. RENDER VIEW                                 │
    │                                                                │
    │   - Show category tabs                                         │
    │   - Display ranked entries table                              │
    │   - Highlight current player's entry with ►                   │
    │   - Show player's best score and rank at bottom               │
    └───────────────────────────────────────────────────────────────┘
```

### 3.4 Category Scoring Rules

```
┌─────────────────────────────────────────────────────────────────────┐
│                      CATEGORY SCORING RULES                          │
└─────────────────────────────────────────────────────────────────────┘

    ┌────────────────────────────────────────────────────────────────┐
    │ Category          │ Sort Order │ Score Calculation             │
    ├───────────────────┼────────────┼───────────────────────────────┤
    │ HighScore         │ DESC       │ Composite score formula       │
    │ Speedrun          │ ASC        │ CompletionTime (fastest)      │
    │ NoDeath           │ DESC       │ Level reached with 0 deaths   │
    │ AchievementPoints │ DESC       │ Total achievement points      │
    │ BossSlayer        │ DESC       │ Total bosses killed           │
    └────────────────────────────────────────────────────────────────┘


    HIGH SCORE FORMULA
    ──────────────────

    baseScore = monstersKilled × 10
              + bossesKilled × 500
              + roomsDiscovered × 25
              + goldEarned

    levelMultiplier = 1.0 + (level × 0.1)

    achievementBonus = achievementPoints × 10

    deathPenalty = totalDeaths × 100

    finalScore = (baseScore × levelMultiplier) + achievementBonus - deathPenalty


    SPEEDRUN CATEGORY
    ─────────────────

    Score = CompletionTime (lower is better)
    Requirement: Game must be completed (victory)


    NO DEATH CATEGORY
    ─────────────────

    Score = Level reached
    Requirement: totalDeaths == 0
    If player dies, entry is for highest level reached before first death


    ACHIEVEMENT POINTS CATEGORY
    ───────────────────────────

    Score = achievementService.GetTotalPoints(player)


    BOSS SLAYER CATEGORY
    ────────────────────

    Score = statistics.BossesKilled
```

### 3.5 Clean Architecture Layer Diagram

```
┌─────────────────────────────────────────────────────────────────────┐
│                      CLEAN ARCHITECTURE LAYERS                       │
└─────────────────────────────────────────────────────────────────────┘

    ┌─────────────────────────────────────────────────────────────────┐
    │                      PRESENTATION LAYER                          │
    │                                                                  │
    │  ┌─────────────────────────────────────────────────────────┐    │
    │  │                  LeaderboardCommand                      │    │
    │  │                                                          │    │
    │  │ - Parse category argument                                │    │
    │  │ - Render category tabs                                   │    │
    │  │ - Display ranked entries table                          │    │
    │  │ - Highlight current player entry                        │    │
    │  │ - Show player's best score                              │    │
    │  └─────────────────────────────────────────────────────────┘    │
    └─────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
    ┌─────────────────────────────────────────────────────────────────┐
    │                      APPLICATION LAYER                           │
    │                                                                  │
    │  ┌─────────────────────────┐  ┌─────────────────────────────┐   │
    │  │  ILeaderboardService    │  │   LeaderboardOptions        │   │
    │  │  (interface)            │  │   (configuration)           │   │
    │  │                         │  │                             │   │
    │  │ + SubmitScore()         │  │ + MaxEntriesPerCategory     │   │
    │  │ + GetLeaderboard()      │  │ + DataFilePath              │   │
    │  │ + GetPlayerRank()       │  │                             │   │
    │  │ + GetPlayerBest()       │  │                             │   │
    │  │ + CalculateScore()      │  │                             │   │
    │  └─────────────────────────┘  └─────────────────────────────┘   │
    │                                                                  │
    │  ┌─────────────────────────────────────────────────────────┐    │
    │  │                  LeaderboardService                      │    │
    │  │                                                          │    │
    │  │ + SubmitScore(player, category)                         │    │
    │  │ + GetLeaderboard(category, count)                       │    │
    │  │ + CalculateHighScore(player)                            │    │
    │  │ - LoadLeaderboard()                                     │    │
    │  │ - SaveLeaderboard()                                     │    │
    │  │ - EnforceMaxEntries(category)                           │    │
    │  └─────────────────────────────────────────────────────────┘    │
    └─────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
    ┌─────────────────────────────────────────────────────────────────┐
    │                        DOMAIN LAYER                              │
    │                                                                  │
    │  ┌─────────────────────────┐  ┌─────────────────────────────┐   │
    │  │   LeaderboardEntry      │  │   LeaderboardCategory       │   │
    │  │   (entity)              │  │   (enum)                    │   │
    │  │                         │  │                             │   │
    │  │ + Id: Guid              │  │ HighScore                   │   │
    │  │ + PlayerName: string    │  │ Speedrun                    │   │
    │  │ + ClassName: string     │  │ NoDeath                     │   │
    │  │ + Level: int            │  │ AchievementPoints           │   │
    │  │ + Score: long           │  │ BossSlayer                  │   │
    │  │ + Category: enum        │  │                             │   │
    │  │ + AchievedAt: DateTime  │  │                             │   │
    │  │ + CompletionTime: TS?   │  │                             │   │
    │  └─────────────────────────┘  └─────────────────────────────┘   │
    └─────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
    ┌─────────────────────────────────────────────────────────────────┐
    │                    INFRASTRUCTURE LAYER                          │
    │                                                                  │
    │  ┌─────────────────────────────────────────────────────────┐    │
    │  │                  data/leaderboard.json                   │    │
    │  │                                                          │    │
    │  │  {                                                       │    │
    │  │    "entries": [                                          │    │
    │  │      { "playerName": "...", "score": ..., ... }         │    │
    │  │    ]                                                     │    │
    │  │  }                                                       │    │
    │  └─────────────────────────────────────────────────────────┘    │
    └─────────────────────────────────────────────────────────────────┘
```

---

## 4. LeaderboardCategory Enum

### 4.1 Enum Definition

**File:** `src/Core/RuneAndRust.Domain/Enums/LeaderboardCategory.cs`

```csharp
namespace RuneAndRust.Domain.Enums;

/// <summary>
/// Categories for leaderboard rankings.
/// </summary>
/// <remarks>
/// <para>Each category tracks different aspects of player performance:</para>
/// <list type="bullet">
///   <item><description>HighScore: Overall composite score based on all activities</description></item>
///   <item><description>Speedrun: Fastest game completion time</description></item>
///   <item><description>NoDeath: Highest level reached without dying</description></item>
///   <item><description>AchievementPoints: Most achievement points earned</description></item>
///   <item><description>BossSlayer: Most bosses defeated</description></item>
/// </list>
/// </remarks>
public enum LeaderboardCategory
{
    /// <summary>
    /// Total composite score based on all game activities.
    /// Sorted descending (highest score first).
    /// </summary>
    HighScore,

    /// <summary>
    /// Fastest game completion time.
    /// Sorted ascending (fastest time first).
    /// Requires game completion to qualify.
    /// </summary>
    Speedrun,

    /// <summary>
    /// Highest level reached without dying.
    /// Sorted descending (highest level first).
    /// Only counts levels before first death.
    /// </summary>
    NoDeath,

    /// <summary>
    /// Total achievement points earned.
    /// Sorted descending (most points first).
    /// </summary>
    AchievementPoints,

    /// <summary>
    /// Total bosses defeated.
    /// Sorted descending (most bosses first).
    /// </summary>
    BossSlayer
}
```

---

## 5. LeaderboardEntry Entity

### 5.1 Entity Definition

**File:** `src/Core/RuneAndRust.Domain/Entities/LeaderboardEntry.cs`

```csharp
namespace RuneAndRust.Domain.Entities;

using RuneAndRust.Domain.Enums;
using RuneAndRust.Domain.Interfaces;

/// <summary>
/// Represents a single entry on a leaderboard.
/// </summary>
/// <remarks>
/// <para>Leaderboard entries capture:</para>
/// <list type="bullet">
///   <item><description>Player identification (name, class)</description></item>
///   <item><description>Performance metrics (level, score)</description></item>
///   <item><description>Category classification</description></item>
///   <item><description>Timestamp for when the score was achieved</description></item>
///   <item><description>Optional completion time for speedrun category</description></item>
/// </list>
/// </remarks>
public class LeaderboardEntry : IEntity
{
    /// <summary>
    /// Gets the unique identifier for this leaderboard entry.
    /// </summary>
    public Guid Id { get; private set; }

    /// <summary>
    /// Gets the name of the player who achieved this score.
    /// </summary>
    public string PlayerName { get; private set; } = null!;

    /// <summary>
    /// Gets the class name of the player's character.
    /// </summary>
    public string ClassName { get; private set; } = null!;

    /// <summary>
    /// Gets the level the player reached.
    /// </summary>
    public int Level { get; private set; }

    /// <summary>
    /// Gets the score value for this entry.
    /// </summary>
    /// <remarks>
    /// Interpretation depends on category:
    /// - HighScore: Composite score
    /// - Speedrun: Completion time in seconds (lower is better)
    /// - NoDeath: Level reached before first death
    /// - AchievementPoints: Total achievement points
    /// - BossSlayer: Total bosses killed
    /// </remarks>
    public long Score { get; private set; }

    /// <summary>
    /// Gets the leaderboard category this entry belongs to.
    /// </summary>
    public LeaderboardCategory Category { get; private set; }

    /// <summary>
    /// Gets the timestamp when this score was achieved.
    /// </summary>
    public DateTime AchievedAt { get; private set; }

    /// <summary>
    /// Gets the completion time for speedrun entries.
    /// Null for non-speedrun categories.
    /// </summary>
    public TimeSpan? CompletionTime { get; private set; }

    /// <summary>
    /// Private constructor for EF Core and factory method.
    /// </summary>
    private LeaderboardEntry() { }

    /// <summary>
    /// Creates a new LeaderboardEntry.
    /// </summary>
    /// <param name="playerName">The player's name.</param>
    /// <param name="className">The player's class name.</param>
    /// <param name="level">The level reached.</param>
    /// <param name="score">The score value.</param>
    /// <param name="category">The leaderboard category.</param>
    /// <param name="completionTime">Optional completion time for speedrun.</param>
    /// <returns>A new LeaderboardEntry instance.</returns>
    /// <exception cref="ArgumentException">If playerName or className is null/empty.</exception>
    /// <exception cref="ArgumentOutOfRangeException">If level or score is negative.</exception>
    public static LeaderboardEntry Create(
        string playerName,
        string className,
        int level,
        long score,
        LeaderboardCategory category,
        TimeSpan? completionTime = null)
    {
        ArgumentException.ThrowIfNullOrWhiteSpace(playerName);
        ArgumentException.ThrowIfNullOrWhiteSpace(className);
        ArgumentOutOfRangeException.ThrowIfNegative(level);
        ArgumentOutOfRangeException.ThrowIfNegative(score);

        return new LeaderboardEntry
        {
            Id = Guid.NewGuid(),
            PlayerName = playerName,
            ClassName = className,
            Level = level,
            Score = score,
            Category = category,
            AchievedAt = DateTime.UtcNow,
            CompletionTime = completionTime
        };
    }

    /// <summary>
    /// Gets a display string for the score based on category.
    /// </summary>
    /// <returns>Formatted score string.</returns>
    public string GetScoreDisplay()
    {
        return Category switch
        {
            LeaderboardCategory.Speedrun when CompletionTime.HasValue =>
                $"{CompletionTime.Value:hh\\:mm\\:ss}",
            LeaderboardCategory.HighScore =>
                $"{Score:N0}",
            _ => Score.ToString("N0")
        };
    }
}
```

---

## 6. ILeaderboardService Interface

### 6.1 Interface Definition

**File:** `src/Core/RuneAndRust.Application/Interfaces/ILeaderboardService.cs`

```csharp
namespace RuneAndRust.Application.Interfaces;

using RuneAndRust.Domain.Entities;
using RuneAndRust.Domain.Enums;

/// <summary>
/// Service for managing leaderboard entries and score submission.
/// </summary>
/// <remarks>
/// <para>The leaderboard service provides:</para>
/// <list type="bullet">
///   <item><description>Score submission for completed runs</description></item>
///   <item><description>Leaderboard retrieval by category</description></item>
///   <item><description>Player ranking queries</description></item>
///   <item><description>Score calculation for different categories</description></item>
/// </list>
/// </remarks>
public interface ILeaderboardService
{
    /// <summary>
    /// Submits a score for a player in a specific category.
    /// </summary>
    /// <param name="player">The player submitting the score.</param>
    /// <param name="category">The leaderboard category.</param>
    /// <returns>The created entry, or null if score didn't qualify.</returns>
    LeaderboardEntry? SubmitScore(Player player, LeaderboardCategory category);

    /// <summary>
    /// Submits scores for all applicable categories.
    /// </summary>
    /// <param name="player">The player submitting scores.</param>
    /// <param name="isVictory">Whether the game was completed successfully.</param>
    /// <param name="completionTime">The total playtime if victory.</param>
    /// <returns>List of entries that qualified for the leaderboards.</returns>
    IReadOnlyList<LeaderboardEntry> SubmitAllScores(
        Player player,
        bool isVictory,
        TimeSpan? completionTime);

    /// <summary>
    /// Gets the leaderboard entries for a category.
    /// </summary>
    /// <param name="category">The category to retrieve.</param>
    /// <param name="count">Maximum number of entries to return.</param>
    /// <returns>Ranked list of leaderboard entries.</returns>
    IReadOnlyList<LeaderboardEntry> GetLeaderboard(
        LeaderboardCategory category,
        int count = 10);

    /// <summary>
    /// Gets the player's rank in a specific category.
    /// </summary>
    /// <param name="player">The player to look up.</param>
    /// <param name="category">The category to check.</param>
    /// <returns>The rank (1-based), or 0 if not on the leaderboard.</returns>
    int GetPlayerRank(Player player, LeaderboardCategory category);

    /// <summary>
    /// Gets the player's best entry in a category.
    /// </summary>
    /// <param name="player">The player to look up.</param>
    /// <param name="category">The category to check.</param>
    /// <returns>The player's best entry, or null if none exists.</returns>
    LeaderboardEntry? GetPlayerBest(Player player, LeaderboardCategory category);

    /// <summary>
    /// Calculates the high score for a player.
    /// </summary>
    /// <param name="player">The player to calculate score for.</param>
    /// <returns>The calculated high score.</returns>
    long CalculateScore(Player player);

    /// <summary>
    /// Gets the total number of entries across all categories.
    /// </summary>
    /// <returns>Total entry count.</returns>
    int GetTotalEntryCount();
}
```

---

## 7. LeaderboardService Implementation

### 7.1 Service Implementation

**File:** `src/Core/RuneAndRust.Application/Services/LeaderboardService.cs`

```csharp
namespace RuneAndRust.Application.Services;

using Microsoft.Extensions.Logging;
using Microsoft.Extensions.Options;
using RuneAndRust.Application.Interfaces;
using RuneAndRust.Domain.Entities;
using RuneAndRust.Domain.Enums;
using RuneAndRust.Infrastructure.Configuration;
using System.Text.Json;

/// <summary>
/// Service for managing leaderboards with local JSON persistence.
/// </summary>
/// <remarks>
/// <para>This service:</para>
/// <list type="bullet">
///   <item><description>Loads leaderboard data from JSON on first access</description></item>
///   <item><description>Saves leaderboard data after each submission</description></item>
///   <item><description>Enforces maximum entries per category (default 100)</description></item>
///   <item><description>Calculates scores based on player statistics</description></item>
/// </list>
/// </remarks>
public class LeaderboardService : ILeaderboardService
{
    private readonly IStatisticsService _statisticsService;
    private readonly IAchievementService _achievementService;
    private readonly LeaderboardOptions _options;
    private readonly ILogger<LeaderboardService> _logger;

    private List<LeaderboardEntry> _entries = new();
    private bool _isLoaded;

    private static readonly JsonSerializerOptions JsonOptions = new()
    {
        WriteIndented = true,
        PropertyNameCaseInsensitive = true
    };

    /// <summary>
    /// Initializes a new instance of the <see cref="LeaderboardService"/> class.
    /// </summary>
    public LeaderboardService(
        IStatisticsService statisticsService,
        IAchievementService achievementService,
        IOptions<LeaderboardOptions> options,
        ILogger<LeaderboardService> logger)
    {
        _statisticsService = statisticsService
            ?? throw new ArgumentNullException(nameof(statisticsService));
        _achievementService = achievementService
            ?? throw new ArgumentNullException(nameof(achievementService));
        _options = options?.Value
            ?? throw new ArgumentNullException(nameof(options));
        _logger = logger
            ?? throw new ArgumentNullException(nameof(logger));
    }

    /// <inheritdoc />
    public LeaderboardEntry? SubmitScore(Player player, LeaderboardCategory category)
    {
        ArgumentNullException.ThrowIfNull(player);
        EnsureLoaded();

        var score = CalculateScoreForCategory(player, category);
        var entry = LeaderboardEntry.Create(
            playerName: player.Name,
            className: player.Class?.Name ?? "Unknown",
            level: player.Level,
            score: score,
            category: category,
            completionTime: category == LeaderboardCategory.Speedrun
                ? GetCompletionTime(player)
                : null);

        if (!QualifiesForLeaderboard(entry, category))
        {
            _logger.LogDebug(
                "Score {Score} did not qualify for {Category} leaderboard",
                score,
                category);
            return null;
        }

        _entries.Add(entry);
        EnforceMaxEntries(category);
        SaveLeaderboard();

        _logger.LogInformation(
            "Score submitted: {PlayerName} scored {Score} in {Category}",
            player.Name,
            score,
            category);

        return entry;
    }

    /// <inheritdoc />
    public IReadOnlyList<LeaderboardEntry> SubmitAllScores(
        Player player,
        bool isVictory,
        TimeSpan? completionTime)
    {
        ArgumentNullException.ThrowIfNull(player);
        EnsureLoaded();

        var submittedEntries = new List<LeaderboardEntry>();

        // Always submit high score
        var highScoreEntry = SubmitScore(player, LeaderboardCategory.HighScore);
        if (highScoreEntry is not null)
        {
            submittedEntries.Add(highScoreEntry);
        }

        // Submit speedrun only on victory
        if (isVictory && completionTime.HasValue)
        {
            var speedrunEntry = SubmitSpeedrunScore(player, completionTime.Value);
            if (speedrunEntry is not null)
            {
                submittedEntries.Add(speedrunEntry);
            }
        }

        // Submit no-death if player hasn't died
        var statistics = _statisticsService.GetPlayerStatistics(player);
        if (statistics.TotalDeaths == 0)
        {
            var noDeathEntry = SubmitScore(player, LeaderboardCategory.NoDeath);
            if (noDeathEntry is not null)
            {
                submittedEntries.Add(noDeathEntry);
            }
        }

        // Achievement points
        var achievementEntry = SubmitScore(player, LeaderboardCategory.AchievementPoints);
        if (achievementEntry is not null)
        {
            submittedEntries.Add(achievementEntry);
        }

        // Boss slayer
        var bossEntry = SubmitScore(player, LeaderboardCategory.BossSlayer);
        if (bossEntry is not null)
        {
            submittedEntries.Add(bossEntry);
        }

        return submittedEntries.AsReadOnly();
    }

    /// <inheritdoc />
    public IReadOnlyList<LeaderboardEntry> GetLeaderboard(
        LeaderboardCategory category,
        int count = 10)
    {
        EnsureLoaded();

        var categoryEntries = _entries
            .Where(e => e.Category == category)
            .ToList();

        // Sort based on category rules
        var sorted = category == LeaderboardCategory.Speedrun
            ? categoryEntries.OrderBy(e => e.Score).ToList()
            : categoryEntries.OrderByDescending(e => e.Score).ToList();

        return sorted.Take(count).ToList().AsReadOnly();
    }

    /// <inheritdoc />
    public int GetPlayerRank(Player player, LeaderboardCategory category)
    {
        ArgumentNullException.ThrowIfNull(player);
        EnsureLoaded();

        var leaderboard = GetLeaderboard(category, _options.MaxEntriesPerCategory);
        var index = leaderboard.ToList().FindIndex(e =>
            e.PlayerName.Equals(player.Name, StringComparison.OrdinalIgnoreCase));

        return index >= 0 ? index + 1 : 0;
    }

    /// <inheritdoc />
    public LeaderboardEntry? GetPlayerBest(Player player, LeaderboardCategory category)
    {
        ArgumentNullException.ThrowIfNull(player);
        EnsureLoaded();

        var playerEntries = _entries
            .Where(e => e.Category == category &&
                        e.PlayerName.Equals(player.Name, StringComparison.OrdinalIgnoreCase))
            .ToList();

        if (playerEntries.Count == 0)
        {
            return null;
        }

        return category == LeaderboardCategory.Speedrun
            ? playerEntries.MinBy(e => e.Score)
            : playerEntries.MaxBy(e => e.Score);
    }

    /// <inheritdoc />
    public long CalculateScore(Player player)
    {
        ArgumentNullException.ThrowIfNull(player);

        var statistics = _statisticsService.GetPlayerStatistics(player);
        var achievementPoints = _achievementService.GetTotalPoints(player);

        // Base score from activities
        long baseScore = 0;
        baseScore += statistics.MonstersKilled * 10;
        baseScore += statistics.BossesKilled * 500;
        baseScore += statistics.RoomsDiscovered * 25;
        baseScore += statistics.TotalGoldEarned;

        // Level multiplier (10% bonus per level)
        var levelMultiplier = 1.0 + (player.Level * 0.1);

        // Achievement bonus
        var achievementBonus = achievementPoints * 10;

        // Death penalty
        var deathPenalty = statistics.TotalDeaths * 100;

        var finalScore = (long)((baseScore * levelMultiplier) + achievementBonus - deathPenalty);

        return Math.Max(0, finalScore);
    }

    /// <inheritdoc />
    public int GetTotalEntryCount()
    {
        EnsureLoaded();
        return _entries.Count;
    }

    /// <summary>
    /// Calculates the score for a specific category.
    /// </summary>
    private long CalculateScoreForCategory(Player player, LeaderboardCategory category)
    {
        var statistics = _statisticsService.GetPlayerStatistics(player);

        return category switch
        {
            LeaderboardCategory.HighScore => CalculateScore(player),
            LeaderboardCategory.Speedrun => (long)GetCompletionTime(player)?.TotalSeconds ?? long.MaxValue,
            LeaderboardCategory.NoDeath => player.Level,
            LeaderboardCategory.AchievementPoints => _achievementService.GetTotalPoints(player),
            LeaderboardCategory.BossSlayer => statistics.BossesKilled,
            _ => 0
        };
    }

    /// <summary>
    /// Submits a speedrun score with completion time.
    /// </summary>
    private LeaderboardEntry? SubmitSpeedrunScore(Player player, TimeSpan completionTime)
    {
        var entry = LeaderboardEntry.Create(
            playerName: player.Name,
            className: player.Class?.Name ?? "Unknown",
            level: player.Level,
            score: (long)completionTime.TotalSeconds,
            category: LeaderboardCategory.Speedrun,
            completionTime: completionTime);

        if (!QualifiesForLeaderboard(entry, LeaderboardCategory.Speedrun))
        {
            return null;
        }

        _entries.Add(entry);
        EnforceMaxEntries(LeaderboardCategory.Speedrun);
        SaveLeaderboard();

        _logger.LogInformation(
            "Speedrun submitted: {PlayerName} completed in {Time}",
            player.Name,
            completionTime);

        return entry;
    }

    /// <summary>
    /// Gets the completion time from player statistics.
    /// </summary>
    private TimeSpan? GetCompletionTime(Player player)
    {
        var statistics = _statisticsService.GetPlayerStatistics(player);
        return statistics.TotalPlaytimeMinutes > 0
            ? TimeSpan.FromMinutes(statistics.TotalPlaytimeMinutes)
            : null;
    }

    /// <summary>
    /// Checks if a score qualifies for the leaderboard.
    /// </summary>
    private bool QualifiesForLeaderboard(LeaderboardEntry entry, LeaderboardCategory category)
    {
        var categoryEntries = _entries
            .Where(e => e.Category == category)
            .ToList();

        if (categoryEntries.Count < _options.MaxEntriesPerCategory)
        {
            return true;
        }

        // For speedrun, lower is better
        if (category == LeaderboardCategory.Speedrun)
        {
            var highestTime = categoryEntries.Max(e => e.Score);
            return entry.Score < highestTime;
        }

        // For other categories, higher is better
        var lowestScore = categoryEntries.Min(e => e.Score);
        return entry.Score > lowestScore;
    }

    /// <summary>
    /// Enforces the maximum entries limit for a category.
    /// </summary>
    private void EnforceMaxEntries(LeaderboardCategory category)
    {
        var categoryEntries = _entries
            .Where(e => e.Category == category)
            .ToList();

        if (categoryEntries.Count <= _options.MaxEntriesPerCategory)
        {
            return;
        }

        // Sort and keep only top entries
        var sorted = category == LeaderboardCategory.Speedrun
            ? categoryEntries.OrderBy(e => e.Score).ToList()
            : categoryEntries.OrderByDescending(e => e.Score).ToList();

        var toRemove = sorted.Skip(_options.MaxEntriesPerCategory).ToList();

        foreach (var entry in toRemove)
        {
            _entries.Remove(entry);
        }

        _logger.LogDebug(
            "Enforced max entries for {Category}, removed {Count} entries",
            category,
            toRemove.Count);
    }

    /// <summary>
    /// Ensures leaderboard data is loaded.
    /// </summary>
    private void EnsureLoaded()
    {
        if (_isLoaded)
        {
            return;
        }

        LoadLeaderboard();
        _isLoaded = true;
    }

    /// <summary>
    /// Loads leaderboard data from JSON file.
    /// </summary>
    private void LoadLeaderboard()
    {
        var filePath = _options.DataFilePath;

        if (!File.Exists(filePath))
        {
            _logger.LogInformation(
                "Leaderboard file not found at {FilePath}, starting with empty leaderboard",
                filePath);
            _entries = new List<LeaderboardEntry>();
            return;
        }

        try
        {
            var json = File.ReadAllText(filePath);
            var data = JsonSerializer.Deserialize<LeaderboardData>(json, JsonOptions);

            _entries = data?.Entries ?? new List<LeaderboardEntry>();

            _logger.LogInformation(
                "Loaded {Count} leaderboard entries from {FilePath}",
                _entries.Count,
                filePath);
        }
        catch (JsonException ex)
        {
            _logger.LogError(ex, "Failed to parse leaderboard file");
            _entries = new List<LeaderboardEntry>();
        }
    }

    /// <summary>
    /// Saves leaderboard data to JSON file.
    /// </summary>
    private void SaveLeaderboard()
    {
        var filePath = _options.DataFilePath;

        try
        {
            var directory = Path.GetDirectoryName(filePath);
            if (!string.IsNullOrEmpty(directory) && !Directory.Exists(directory))
            {
                Directory.CreateDirectory(directory);
            }

            var data = new LeaderboardData { Entries = _entries };
            var json = JsonSerializer.Serialize(data, JsonOptions);

            File.WriteAllText(filePath, json);

            _logger.LogDebug("Saved {Count} leaderboard entries to {FilePath}",
                _entries.Count,
                filePath);
        }
        catch (IOException ex)
        {
            _logger.LogError(ex, "Failed to save leaderboard file");
        }
    }

    /// <summary>
    /// Data model for JSON serialization.
    /// </summary>
    private class LeaderboardData
    {
        public List<LeaderboardEntry> Entries { get; set; } = new();
    }
}
```

### 7.2 Configuration Options

**File:** `src/Infrastructure/RuneAndRust.Infrastructure/Configuration/LeaderboardOptions.cs`

```csharp
namespace RuneAndRust.Infrastructure.Configuration;

/// <summary>
/// Configuration options for the leaderboard system.
/// </summary>
public class LeaderboardOptions
{
    /// <summary>
    /// Gets or sets the maximum number of entries per category.
    /// Default is 100.
    /// </summary>
    public int MaxEntriesPerCategory { get; set; } = 100;

    /// <summary>
    /// Gets or sets the path to the leaderboard data file.
    /// </summary>
    public string DataFilePath { get; set; } = "data/leaderboard.json";
}
```

---

## 8. Leaderboard Persistence

### 8.1 Data File Structure

**File:** `data/leaderboard.json`

```json
{
  "entries": [
    {
      "id": "a1b2c3d4-e5f6-7890-abcd-ef1234567890",
      "playerName": "Thorin",
      "className": "Warrior",
      "level": 15,
      "score": 125430,
      "category": "HighScore",
      "achievedAt": "2026-01-05T14:32:00Z",
      "completionTime": null
    },
    {
      "id": "b2c3d4e5-f6a7-8901-bcde-f23456789012",
      "playerName": "Elara",
      "className": "Mage",
      "level": 12,
      "score": 98750,
      "category": "HighScore",
      "achievedAt": "2026-01-03T10:15:00Z",
      "completionTime": null
    },
    {
      "id": "c3d4e5f6-a7b8-9012-cdef-345678901234",
      "playerName": "Shadow",
      "className": "Rogue",
      "level": 10,
      "score": 1845,
      "category": "Speedrun",
      "achievedAt": "2026-01-08T22:45:00Z",
      "completionTime": "00:30:45"
    },
    {
      "id": "d4e5f6a7-b8c9-0123-def0-456789012345",
      "playerName": "Thorin",
      "className": "Warrior",
      "level": 8,
      "score": 8,
      "category": "NoDeath",
      "achievedAt": "2026-01-10T16:20:00Z",
      "completionTime": null
    },
    {
      "id": "e5f6a7b8-c9d0-1234-ef01-567890123456",
      "playerName": "Elara",
      "className": "Mage",
      "level": 12,
      "score": 185,
      "category": "AchievementPoints",
      "achievedAt": "2026-01-03T10:15:00Z",
      "completionTime": null
    },
    {
      "id": "f6a7b8c9-d0e1-2345-f012-678901234567",
      "playerName": "Shadow",
      "className": "Rogue",
      "level": 14,
      "score": 12,
      "category": "BossSlayer",
      "achievedAt": "2026-01-08T22:45:00Z",
      "completionTime": null
    }
  ]
}
```

### 8.2 Persistence Flow

```
┌─────────────────────────────────────────────────────────────────────┐
│                      PERSISTENCE FLOW                                │
└─────────────────────────────────────────────────────────────────────┘

    APPLICATION STARTUP
    ───────────────────

    LeaderboardService initialized
           │
           ▼
    First access to leaderboard data?
           │
           ├── YES → LoadLeaderboard()
           │         - Check if file exists
           │         - Parse JSON if exists
           │         - Initialize empty list if not
           │
           └── NO → Use cached _entries


    SCORE SUBMISSION
    ────────────────

    SubmitScore(player, category)
           │
           ▼
    Calculate score
           │
           ▼
    Check if qualifies
           │
           ├── NO → Return null
           │
           └── YES → Add entry to _entries
                     │
                     ▼
                     EnforceMaxEntries()
                     (remove lowest if > 100)
                     │
                     ▼
                     SaveLeaderboard()
                     │
                     ▼
                     Write to data/leaderboard.json
```

---

## 9. LeaderboardCommand

### 9.1 Command Definition

**File:** `src/Presentation/RuneAndRust.ConsoleUI/Commands/LeaderboardCommand.cs`

```csharp
namespace RuneAndRust.ConsoleUI.Commands;

using RuneAndRust.Application.Interfaces;
using RuneAndRust.Domain.Entities;
using RuneAndRust.Domain.Enums;
using Spectre.Console;

/// <summary>
/// Command for viewing leaderboards in the TUI.
/// </summary>
/// <remarks>
/// Usage: leaderboard [category]
/// Categories: highscore, speedrun, nodeath, achievementpoints, bossslayer
/// Default: highscore
/// </remarks>
public class LeaderboardCommand : IGameCommand
{
    private readonly ILeaderboardService _leaderboardService;

    /// <summary>
    /// Initializes a new instance of the <see cref="LeaderboardCommand"/> class.
    /// </summary>
    public LeaderboardCommand(ILeaderboardService leaderboardService)
    {
        _leaderboardService = leaderboardService;
    }

    /// <summary>
    /// Executes the leaderboard command.
    /// </summary>
    /// <param name="player">The current player.</param>
    /// <param name="argument">Optional category filter.</param>
    public void Execute(Player player, string? argument)
    {
        var category = ParseCategory(argument);
        RenderLeaderboard(player, category);
    }

    /// <summary>
    /// Parses a category from the argument string.
    /// </summary>
    private LeaderboardCategory ParseCategory(string? argument)
    {
        if (string.IsNullOrWhiteSpace(argument))
        {
            return LeaderboardCategory.HighScore;
        }

        return argument.ToLowerInvariant().Replace(" ", "").Replace("-", "") switch
        {
            "highscore" or "high" or "score" => LeaderboardCategory.HighScore,
            "speedrun" or "speed" or "fast" => LeaderboardCategory.Speedrun,
            "nodeath" or "deathless" or "hardcore" => LeaderboardCategory.NoDeath,
            "achievementpoints" or "achievement" or "achievements" or "points" =>
                LeaderboardCategory.AchievementPoints,
            "bossslayer" or "boss" or "bosses" => LeaderboardCategory.BossSlayer,
            _ => LeaderboardCategory.HighScore
        };
    }

    /// <summary>
    /// Renders the leaderboard view.
    /// </summary>
    private void RenderLeaderboard(Player player, LeaderboardCategory category)
    {
        // Header with category tabs
        RenderCategoryTabs(category);
        AnsiConsole.WriteLine();

        // Leaderboard title
        var title = GetCategoryTitle(category);
        AnsiConsole.MarkupLine($"[bold cyan]{title}[/]");
        AnsiConsole.MarkupLine(new string('─', title.Length));
        AnsiConsole.WriteLine();

        // Get leaderboard data
        var entries = _leaderboardService.GetLeaderboard(category, 10);
        var playerRank = _leaderboardService.GetPlayerRank(player, category);
        var playerBest = _leaderboardService.GetPlayerBest(player, category);

        if (entries.Count == 0)
        {
            AnsiConsole.MarkupLine("[grey]No entries yet. Be the first![/]");
            return;
        }

        // Render table
        var table = CreateLeaderboardTable(category);
        var rank = 1;

        foreach (var entry in entries)
        {
            var isCurrentPlayer = entry.PlayerName.Equals(
                player.Name,
                StringComparison.OrdinalIgnoreCase);

            AddEntryRow(table, entry, rank, isCurrentPlayer, category);
            rank++;
        }

        AnsiConsole.Write(table);
        AnsiConsole.WriteLine();

        // Player's best score
        if (playerBest is not null)
        {
            AnsiConsole.MarkupLine(
                $"[cyan]Your Best:[/] {playerBest.GetScoreDisplay()} [grey](Rank #{playerRank})[/]");
        }
        else
        {
            AnsiConsole.MarkupLine("[grey]You don't have an entry in this category yet.[/]");
        }
    }

    /// <summary>
    /// Renders the category tab bar.
    /// </summary>
    private void RenderCategoryTabs(LeaderboardCategory selected)
    {
        var tabs = new List<string>();

        foreach (var category in Enum.GetValues<LeaderboardCategory>())
        {
            var name = GetCategoryShortName(category);
            var tab = category == selected
                ? $"[bold white on blue] {name} [/]"
                : $"[grey] {name} [/]";
            tabs.Add(tab);
        }

        AnsiConsole.Markup(string.Join(" ", tabs));
        AnsiConsole.WriteLine();
    }

    /// <summary>
    /// Creates the leaderboard table with appropriate columns.
    /// </summary>
    private Table CreateLeaderboardTable(LeaderboardCategory category)
    {
        var table = new Table()
            .Border(TableBorder.Rounded)
            .AddColumn("Rank")
            .AddColumn("Name")
            .AddColumn("Class")
            .AddColumn("Level");

        // Add score column with category-appropriate header
        var scoreHeader = category switch
        {
            LeaderboardCategory.Speedrun => "Time",
            LeaderboardCategory.NoDeath => "Level",
            LeaderboardCategory.AchievementPoints => "Points",
            LeaderboardCategory.BossSlayer => "Bosses",
            _ => "Score"
        };

        table.AddColumn(scoreHeader);
        table.AddColumn("Date");

        return table;
    }

    /// <summary>
    /// Adds an entry row to the table.
    /// </summary>
    private void AddEntryRow(
        Table table,
        LeaderboardEntry entry,
        int rank,
        bool isCurrentPlayer,
        LeaderboardCategory category)
    {
        var rankDisplay = GetRankDisplay(rank, isCurrentPlayer);
        var nameDisplay = isCurrentPlayer
            ? $"[bold]{entry.PlayerName.EscapeMarkup()}[/] [cyan](You)[/]"
            : entry.PlayerName.EscapeMarkup();

        var scoreDisplay = entry.GetScoreDisplay();
        var dateDisplay = entry.AchievedAt.ToString("yyyy-MM-dd");

        table.AddRow(
            rankDisplay,
            nameDisplay,
            entry.ClassName,
            entry.Level.ToString(),
            scoreDisplay,
            dateDisplay);
    }

    /// <summary>
    /// Gets the display string for a rank.
    /// </summary>
    private string GetRankDisplay(int rank, bool isCurrentPlayer)
    {
        var prefix = isCurrentPlayer ? "[cyan]►[/] " : "   ";

        return rank switch
        {
            1 => $"{prefix}[gold1]🥇 1[/]",
            2 => $"{prefix}[silver]🥈 2[/]",
            3 => $"{prefix}[orange3]🥉 3[/]",
            _ => $"{prefix}[grey]{rank,4}[/]"
        };
    }

    /// <summary>
    /// Gets the full title for a category.
    /// </summary>
    private string GetCategoryTitle(LeaderboardCategory category)
    {
        return category switch
        {
            LeaderboardCategory.HighScore => "HIGH SCORE LEADERBOARD",
            LeaderboardCategory.Speedrun => "SPEEDRUN LEADERBOARD",
            LeaderboardCategory.NoDeath => "NO DEATH LEADERBOARD",
            LeaderboardCategory.AchievementPoints => "ACHIEVEMENT POINTS LEADERBOARD",
            LeaderboardCategory.BossSlayer => "BOSS SLAYER LEADERBOARD",
            _ => "LEADERBOARD"
        };
    }

    /// <summary>
    /// Gets the short name for category tabs.
    /// </summary>
    private string GetCategoryShortName(LeaderboardCategory category)
    {
        return category switch
        {
            LeaderboardCategory.HighScore => "High Score",
            LeaderboardCategory.Speedrun => "Speedrun",
            LeaderboardCategory.NoDeath => "No Death",
            LeaderboardCategory.AchievementPoints => "Achievements",
            LeaderboardCategory.BossSlayer => "Boss Slayer",
            _ => category.ToString()
        };
    }
}
```

---

## 10. Leaderboard View UI

### 10.1 Display Example

```
┌─────────────────────────────────────────────────────────────────────┐
│                          LEADERBOARDS                                │
├─────────────────────────────────────────────────────────────────────┤
│  [High Score]  Speedrun   No Death   Achievements   Boss Slayer     │
├─────────────────────────────────────────────────────────────────────┤
│                                                                      │
│  HIGH SCORE LEADERBOARD                                             │
│  ──────────────────────                                             │
│                                                                      │
│  ┌──────┬───────────────────┬─────────┬───────┬──────────┬─────────┐│
│  │ Rank │ Name              │ Class   │ Level │ Score    │ Date    ││
│  ├──────┼───────────────────┼─────────┼───────┼──────────┼─────────┤│
│  │ 🥇 1 │ Thorin            │ Warrior │    15 │ 125,430  │2026-01-05│
│  │ 🥈 2 │ Elara             │ Mage    │    12 │  98,750  │2026-01-03│
│  │ 🥉 3 │ Shadow            │ Rogue   │    14 │  87,320  │2026-01-08│
│  │    4 │ Grok              │ Warrior │    10 │  65,100  │2026-01-01│
│  │► 5   │ Hero (You)        │ Paladin │     8 │  52,340  │2026-01-10│
│  │    6 │ Luna              │ Cleric  │    11 │  48,900  │2026-01-09│
│  │    7 │ Blade             │ Rogue   │     9 │  42,100  │2026-01-07│
│  │    8 │ Storm             │ Mage    │     7 │  35,600  │2026-01-06│
│  │    9 │ Axel              │ Warrior │     6 │  28,400  │2026-01-04│
│  │   10 │ Frost             │ Mage    │     5 │  21,200  │2026-01-02│
│  └──────┴───────────────────┴─────────┴───────┴──────────┴─────────┘│
│                                                                      │
│  Your Best: 52,340 (Rank #5)                                        │
│                                                                      │
└─────────────────────────────────────────────────────────────────────┘
```

### 10.2 Speedrun View Example

```
┌─────────────────────────────────────────────────────────────────────┐
│                          LEADERBOARDS                                │
├─────────────────────────────────────────────────────────────────────┤
│   High Score  [Speedrun]  No Death   Achievements   Boss Slayer     │
├─────────────────────────────────────────────────────────────────────┤
│                                                                      │
│  SPEEDRUN LEADERBOARD                                               │
│  ────────────────────                                               │
│                                                                      │
│  ┌──────┬───────────────────┬─────────┬───────┬──────────┬─────────┐│
│  │ Rank │ Name              │ Class   │ Level │ Time     │ Date    ││
│  ├──────┼───────────────────┼─────────┼───────┼──────────┼─────────┤│
│  │ 🥇 1 │ Shadow            │ Rogue   │    10 │ 00:30:45 │2026-01-08│
│  │ 🥈 2 │ Elara             │ Mage    │    10 │ 00:35:12 │2026-01-03│
│  │ 🥉 3 │ Thorin            │ Warrior │    10 │ 00:42:30 │2026-01-05│
│  └──────┴───────────────────┴─────────┴───────┴──────────┴─────────┘│
│                                                                      │
│  You don't have an entry in this category yet.                      │
│                                                                      │
└─────────────────────────────────────────────────────────────────────┘
```

### 10.3 User Commands

| Command | Description | Example |
|---------|-------------|---------|
| `leaderboard` | View high score leaderboard | `leaderboard` |
| `leaderboard highscore` | View high score leaderboard | `leaderboard highscore` |
| `leaderboard speedrun` | View speedrun leaderboard | `leaderboard speedrun` |
| `leaderboard nodeath` | View no-death leaderboard | `leaderboard nodeath` |
| `leaderboard achievements` | View achievement points leaderboard | `leaderboard achievements` |
| `leaderboard boss` | View boss slayer leaderboard | `leaderboard boss` |

---

## 11. Score Calculation

### 11.1 High Score Formula

```csharp
/// <summary>
/// Calculates the high score for a player.
/// </summary>
/// <remarks>
/// <para>Score formula:</para>
/// <list type="bullet">
///   <item><description>Base: monsters×10 + bosses×500 + rooms×25 + gold</description></item>
///   <item><description>Level multiplier: 1.0 + (level × 0.1)</description></item>
///   <item><description>Achievement bonus: achievement_points × 10</description></item>
///   <item><description>Death penalty: deaths × 100</description></item>
/// </list>
/// <para>Final = (base × multiplier) + bonus - penalty</para>
/// </remarks>
public long CalculateScore(Player player)
{
    var statistics = _statisticsService.GetPlayerStatistics(player);
    var achievementPoints = _achievementService.GetTotalPoints(player);

    // Base score from activities
    long baseScore = 0;
    baseScore += statistics.MonstersKilled * 10;
    baseScore += statistics.BossesKilled * 500;
    baseScore += statistics.RoomsDiscovered * 25;
    baseScore += statistics.TotalGoldEarned;

    // Level multiplier (10% bonus per level)
    var levelMultiplier = 1.0 + (player.Level * 0.1);

    // Achievement bonus
    var achievementBonus = achievementPoints * 10;

    // Death penalty
    var deathPenalty = statistics.TotalDeaths * 100;

    var finalScore = (long)((baseScore * levelMultiplier) + achievementBonus - deathPenalty);

    return Math.Max(0, finalScore);
}
```

### 11.2 Score Calculation Example

```
EXAMPLE CALCULATION
───────────────────

Player Stats:
  - Level: 10
  - Monsters Killed: 150
  - Bosses Killed: 3
  - Rooms Discovered: 45
  - Gold Earned: 2,500
  - Deaths: 2
  - Achievement Points: 85

Base Score:
  = (150 × 10) + (3 × 500) + (45 × 25) + 2,500
  = 1,500 + 1,500 + 1,125 + 2,500
  = 6,625

Level Multiplier:
  = 1.0 + (10 × 0.1)
  = 2.0

Achievement Bonus:
  = 85 × 10
  = 850

Death Penalty:
  = 2 × 100
  = 200

Final Score:
  = (6,625 × 2.0) + 850 - 200
  = 13,250 + 850 - 200
  = 13,900
```

---

## 12. Logging Specifications

### 12.1 Log Levels by Component

| Component | Level | Events |
|-----------|-------|--------|
| `LeaderboardService` | Information | Score submitted, leaderboard loaded |
| `LeaderboardService` | Debug | Score calculation, max entries enforcement |
| `LeaderboardService` | Warning | Score didn't qualify |
| `LeaderboardService` | Error | File I/O failures |
| `LeaderboardCommand` | Debug | Command execution, category parsing |

### 12.2 Log Message Examples

```csharp
// LeaderboardService - Information
_logger.LogInformation(
    "Score submitted: {PlayerName} scored {Score} in {Category}",
    player.Name,
    score,
    category);

_logger.LogInformation(
    "Speedrun submitted: {PlayerName} completed in {Time}",
    player.Name,
    completionTime);

_logger.LogInformation(
    "Loaded {Count} leaderboard entries from {FilePath}",
    _entries.Count,
    filePath);

_logger.LogInformation(
    "Leaderboard file not found at {FilePath}, starting with empty leaderboard",
    filePath);

// LeaderboardService - Debug
_logger.LogDebug(
    "Score {Score} did not qualify for {Category} leaderboard",
    score,
    category);

_logger.LogDebug(
    "Enforced max entries for {Category}, removed {Count} entries",
    category,
    toRemove.Count);

_logger.LogDebug(
    "Saved {Count} leaderboard entries to {FilePath}",
    _entries.Count,
    filePath);

// LeaderboardService - Error
_logger.LogError(ex, "Failed to parse leaderboard file");

_logger.LogError(ex, "Failed to save leaderboard file");

// LeaderboardCommand - Debug
_logger.LogDebug(
    "Displaying leaderboard for category: {Category}",
    category);
```

---

## 13. Unit Testing Requirements

### 13.1 Test Count by Feature

| Feature | Test Count |
|---------|------------|
| LeaderboardEntry Entity | 2 |
| LeaderboardService | 6 |
| Score Calculation | 2 |
| LeaderboardCommand | 1 |
| **Total** | **~11** |

### 13.2 Test Specifications

**File:** `tests/RuneAndRust.Tests/Domain/LeaderboardEntryTests.cs`

```csharp
[TestFixture]
public class LeaderboardEntryTests
{
    [Test]
    public void Create_WithValidData_SetsAllProperties();

    [Test]
    public void GetScoreDisplay_SpeedrunCategory_FormatsAsTime();
}
```

**File:** `tests/RuneAndRust.Tests/Application/LeaderboardServiceTests.cs`

```csharp
[TestFixture]
public class LeaderboardServiceTests
{
    [Test]
    public void SubmitScore_NewEntry_AddsToLeaderboard();

    [Test]
    public void SubmitScore_BelowThreshold_DoesNotAdd();

    [Test]
    public void GetLeaderboard_ReturnsEntriesSortedCorrectly();

    [Test]
    public void GetLeaderboard_Speedrun_SortsAscending();

    [Test]
    public void EnforceMaxEntries_RemovesLowestScores();

    [Test]
    public void GetPlayerRank_ReturnsCorrectRank();
}
```

**File:** `tests/RuneAndRust.Tests/Application/ScoreCalculationTests.cs`

```csharp
[TestFixture]
public class ScoreCalculationTests
{
    [Test]
    public void CalculateScore_AppliesFormulaCorrectly();

    [Test]
    public void CalculateScore_NeverReturnsNegative();
}
```

**File:** `tests/RuneAndRust.Tests/Presentation/LeaderboardCommandTests.cs`

```csharp
[TestFixture]
public class LeaderboardCommandTests
{
    [Test]
    public void ParseCategory_ValidInput_ReturnsCorrectCategory();
}
```

---

## 14. Use Cases

### UC-001: Submit Score After Game Over

**Actor:** System (Game Over Handler)
**Flow:** Player dies/completes game → Game over triggered → LeaderboardService.SubmitAllScores() called → Calculate scores for each category → Create entries for qualifying scores → Save to leaderboard.json → Display any new entries to player

### UC-002: View Leaderboard

**Actor:** Player
**Flow:** Player enters "leaderboard" command → LeaderboardCommand parses optional category → GetLeaderboard(category, 10) called → Render category tabs → Display ranked entries table → Highlight current player → Show player's best score

### UC-003: View Specific Category

**Actor:** Player
**Flow:** Player enters "leaderboard speedrun" → Parse category as Speedrun → GetLeaderboard(Speedrun, 10) → Sort by time ascending → Render with "Time" column header → Display completion times

### UC-004: Check Player Rank

**Actor:** System (LeaderboardCommand)
**Flow:** Display leaderboard → GetPlayerRank(player, category) → Search for player's entry → Return 1-based rank or 0 → Display "Your Best: X (Rank #Y)" or "No entry yet"

### UC-005: Enforce Max Entries

**Actor:** System (LeaderboardService)
**Flow:** Score submitted → Entry count exceeds 100 → Sort entries by score → Remove entries beyond limit → Save updated leaderboard

---

## 15. Deliverable Checklist

### Domain Layer
- [ ] `LeaderboardCategory` enum created
- [ ] `LeaderboardEntry` entity created

### Application Layer
- [ ] `ILeaderboardService` interface created
- [ ] `LeaderboardService` implementation created
- [ ] `LeaderboardOptions` configuration class created

### Presentation Layer
- [ ] `LeaderboardCommand` command created

### Data Files
- [ ] `data/leaderboard.json` created (empty initial state)

### Testing
- [ ] ~11 unit tests implemented
- [ ] All tests passing

---

## 16. Acceptance Criteria

### Functional
- [ ] Score calculation formula works correctly
- [ ] Level multiplier applies correctly (10% per level)
- [ ] Achievement bonus calculated correctly
- [ ] Death penalty applied correctly
- [ ] Scores never negative (minimum 0)
- [ ] Leaderboard entries persist to JSON
- [ ] Leaderboard loads from JSON on startup
- [ ] Maximum 100 entries per category enforced
- [ ] Lowest scores removed when exceeding limit
- [ ] 5 categories supported (HighScore, Speedrun, NoDeath, AchievementPoints, BossSlayer)
- [ ] Speedrun sorted ascending (fastest first)
- [ ] Other categories sorted descending (highest first)
- [ ] Current player highlighted with ► in view
- [ ] Player's best score displayed at bottom
- [ ] Rank medals shown for top 3 (🥇, 🥈, 🥉)
- [ ] Speedrun only accepts completed games
- [ ] NoDeath only counts levels before first death

### Quality
- [ ] Build succeeds with 0 errors
- [ ] Build succeeds with 0 warnings
- [ ] All ~11 unit tests pass
- [ ] XML documentation complete on all public members

---

## 17. Dependencies

### Required from v0.12.1b

| Type | Location | Usage in this phase |
|------|----------|---------------------|
| `IAchievementService` | Application/Interfaces | Get achievement points |
| `PlayerAchievement` | Domain/Entities | Achievement data |

### Required from v0.12.0 (Statistics)

| Type | Location | Usage in this phase |
|------|----------|---------------------|
| `PlayerStatistics` | Domain/Entities | Get statistics for scoring |
| `IStatisticsService` | Application/Interfaces | Statistics access |

### Required from Prior Versions

| Type | Location | Usage in this phase |
|------|----------|---------------------|
| `Player` | Domain/Entities | Player data for entries |
| `IEntity` | Domain/Interfaces | Entity base interface |

### Provides to Future Versions

| Type | Usage |
|------|-------|
| `ILeaderboardService` | Leaderboard queries for UI |
| `LeaderboardEntry` | Score records |
| Score calculation | Basis for future scoring features |

---

## 18. Future Considerations

### Out of Scope
- **Online Leaderboards**: Cloud-synced leaderboards requiring server infrastructure
- **Friends Leaderboards**: Social features to compare with friends
- **Weekly/Monthly Resets**: Time-limited leaderboard seasons
- **Leaderboard Rewards**: Prizes for top rankings
- **Anti-Cheat**: Score validation and verification
- **Replay System**: Replays attached to leaderboard entries
- **Leaderboard Filters**: Filter by class, date range, etc.

### Potential Future Enhancements
- **More Categories**: Additional specialized leaderboards
- **Personal Records**: Track personal bests separately from global
- **Statistics Integration**: More detailed score breakdowns

---

*Document Version: 1.0*
*Last Updated: 2026-01-16*
*Author: Claude*
