# v0.4.3 Light & Environment Systems - Scope Breakdown

**Version:** 0.4.3
**Theme:** Light & Environment Systems
**Prerequisites:** v0.4.2 Complete (Puzzles & Riddles)
**Total Estimated Tests:** ~110 new tests

---

## Executive Summary

The Light & Environment Systems version introduces lighting mechanics and a foundational player skills system. Light levels affect gameplay through visibility penalties, creature behaviors, and puzzle interactions. Players can manage light sources and develop trainable skills that enhance their dungeon exploration capabilities. This version builds on previous interactive systems and integrates with combat, perception, and puzzle mechanics.

Key focus areas:
- **Light Level System**: Room illumination affecting visibility and gameplay
- **Light Sources**: Torches, lanterns, and magical light with duration/fuel
- **Darkness Penalties**: Reduced accuracy and perception in dark areas
- **Vision Types**: Normal, Dark Vision, and True Sight for players and creatures
- **Player Skills**: Trainable abilities like Stealth, Perception, and Lockpicking

The work is divided into **four sub-phases**:

| Phase | Name | Focus | Est. Tests |
|-------|------|-------|------------|
| v0.4.3a | Light Core | Light levels, room lighting, basic mechanics | ~30 |
| v0.4.3b | Light Sources & Vision | Torches, lanterns, vision types, light commands | ~30 |
| v0.4.3c | Skills Foundation | Skill entity, definitions, proficiency system | ~25 |
| v0.4.3d | Skills & Environment | Skill implementations, day/night, weather | ~25 |

---

## Existing Infrastructure

### Already Implemented (from v0.4.2)

| Feature | Location | Notes |
|---------|----------|-------|
| Puzzle entity | `Domain/Entities/Puzzle.cs` | Light-based puzzles |
| PuzzleService | `Application/Services/PuzzleService.cs` | Puzzle integration |
| PatternPuzzle | `Domain/ValueObjects/PatternPuzzle.cs` | Light pattern puzzles |
| PuzzleHint | `Domain/ValueObjects/PuzzleHint.cs` | Hint dice checks |

### Already Implemented (from v0.4.1)

| Feature | Location | Notes |
|---------|----------|-------|
| Trap entity | `Domain/Entities/Trap.cs` | Detection affected by light |
| TrapService | `Application/Services/TrapService.cs` | Trap detection |
| SavingThrow | `Domain/ValueObjects/SavingThrow.cs` | Attribute-based checks |
| HazardZone | `Domain/Entities/HazardZone.cs` | Environmental effects |

### Already Implemented (from v0.4.0)

| Feature | Location | Notes |
|---------|----------|-------|
| InteractiveObject | `Domain/Entities/InteractiveObject.cs` | Light source objects |
| ObjectState | `Domain/Enums/ObjectState.cs` | Active/Inactive |
| InteractionService | `Application/Services/InteractionService.cs` | Light interactions |

### Already Implemented (from prior versions)

| Feature | Location | Notes |
|---------|----------|-------|
| DiceService | `Application/Services/DiceService.cs` | Skill checks |
| SkillCheckService | `Application/Services/SkillCheckService.cs` | Existing skill checks |
| Player entity | `Domain/Entities/Player.cs` | Skill tracking |
| Monster entity | `Domain/Entities/Monster.cs` | Vision types |
| Room entity | `Domain/Entities/Room.cs` | Light level storage |
| Item entity | `Domain/Entities/Item.cs` | Light source items |
| ItemType enum | `Domain/Enums/ItemType.cs` | Item categorization |
| CombatService | `Application/Services/CombatService.cs` | Accuracy penalties |

### Needs Implementation (v0.4.3)

| Feature | Phase | Notes |
|---------|-------|-------|
| LightLevel enum | v0.4.3a | Bright, Dim, Dark, MagicalDarkness |
| Room.LightLevel | v0.4.3a | Per-room lighting |
| Darkness penalties | v0.4.3a | Combat/perception modifiers |
| LightSource entity | v0.4.3b | Active light sources |
| LightSourceDefinition | v0.4.3b | Configuration |
| Torch item | v0.4.3b | Consumable light |
| Lantern item | v0.4.3b | Reusable with fuel |
| VisionType enum | v0.4.3b | Normal, DarkVision, TrueSight |
| Player.VisionType | v0.4.3b | Player vision |
| Monster.VisionType | v0.4.3b | Creature vision |
| `light` command | v0.4.3b | Manage light sources |
| SkillDefinition | v0.4.3c | Skill configuration |
| PlayerSkill entity | v0.4.3c | Player skill tracking |
| Player.Skills | v0.4.3c | Skills collection |
| SkillService | v0.4.3c | Skill checks and progression |
| Skill implementations | v0.4.3d | Stealth, Perception, etc. |
| Day/Night cycle | v0.4.3d | Time-based light |
| Weather effects | v0.4.3d | Visibility modifiers |

---

## Feature Analysis & Categorization

### Light Core Features

| Feature | Complexity | Dependencies | Assigned Phase |
|---------|------------|--------------|----------------|
| LightLevel enum | Low | None | **v0.4.3a** |
| Room.LightLevel | Medium | Room | **v0.4.3a** |
| Darkness penalties (combat) | Medium | CombatService | **v0.4.3a** |
| Darkness penalties (perception) | Medium | TrapService | **v0.4.3a** |
| Light level display | Medium | GameRenderer | **v0.4.3a** |
| Light-based puzzle integration | Medium | PuzzleService | **v0.4.3a** |

### Light Source Features

| Feature | Complexity | Dependencies | Assigned Phase |
|---------|------------|--------------|----------------|
| LightSource entity | High | InteractiveObject | **v0.4.3b** |
| LightSourceDefinition | Medium | Configuration | **v0.4.3b** |
| Torch item | Medium | Item, LightSource | **v0.4.3b** |
| Lantern item | Medium | Item, LightSource | **v0.4.3b** |
| Fuel consumption | Medium | LightSource | **v0.4.3b** |
| VisionType enum | Low | None | **v0.4.3b** |
| Player.VisionType | Medium | Player | **v0.4.3b** |
| Monster.VisionType | Medium | Monster | **v0.4.3b** |
| Light sensitivity | Medium | Monster | **v0.4.3b** |
| `light` command | Medium | LightSource | **v0.4.3b** |
| `extinguish` command | Low | LightSource | **v0.4.3b** |

### Skill Foundation Features

| Feature | Complexity | Dependencies | Assigned Phase |
|---------|------------|--------------|----------------|
| SkillDefinition | Medium | Configuration | **v0.4.3c** |
| PlayerSkill entity | High | Player | **v0.4.3c** |
| Player.Skills collection | Medium | Player | **v0.4.3c** |
| Skill proficiency levels | Medium | PlayerSkill | **v0.4.3c** |
| SkillService | High | DiceService | **v0.4.3c** |
| ISkillService interface | Low | None | **v0.4.3c** |
| Skill progression | Medium | PlayerSkill | **v0.4.3c** |
| `skills` command | Medium | SkillService | **v0.4.3c** |

### Skill Implementation & Environment Features

| Feature | Complexity | Dependencies | Assigned Phase |
|---------|------------|--------------|----------------|
| Perception skill | Medium | SkillDefinition, Trap | **v0.4.3d** |
| Stealth skill | Medium | SkillDefinition, Monster | **v0.4.3d** |
| Lockpicking skill | Medium | SkillDefinition, Lock | **v0.4.3d** |
| Acrobatics skill | Medium | SkillDefinition | **v0.4.3d** |
| Field Medicine skill | Medium | SkillDefinition | **v0.4.3d** |
| Day/Night cycle | High | Room, LightLevel | **v0.4.3d** |
| Weather effects | Medium | Room | **v0.4.3d** |
| Outdoor areas | Medium | Room | **v0.4.3d** |

---

## Phase Definitions

---

## v0.4.3a: Light Core

[v0.4.3a Design Specification](v0.4.3a-design-specification.md)

### Overview

Establish the foundational light level system with room illumination tracking and gameplay penalties for darkness. This phase creates the core lighting mechanics that light sources and vision types will build upon.

### Scope

**In Scope:**
- `LightLevel` enum (Bright, Dim, Dark, MagicalDarkness)
- `Room.LightLevel` property
- Darkness combat penalties (accuracy reduction)
- Darkness perception penalties (trap detection DC increase)
- Light level display in room descriptions
- Light level display in UI
- Base light level configuration per room
- Light-based puzzle trigger support
- Integration with existing combat and detection systems

**Out of Scope:**
- Light source items (v0.4.3b)
- Vision types (v0.4.3b)
- Player skills (v0.4.3c)
- Day/night cycle (v0.4.3d)
- Weather effects (v0.4.3d)

### Key Deliverables

| Type | Count | Details |
|------|-------|---------|
| Domain Enums | 1 | `LightLevel` |
| Room Updates | 1 | Add LightLevel property |
| Service Updates | 2 | CombatService, TrapService |
| Renderer Updates | 1 | Light level display |
| Configuration | 1 | Update room definitions |
| Unit Tests | ~30 | Light level, penalty tests |

### LightLevel Enum

```csharp
namespace RuneAndRust.Domain.Enums;

/// <summary>
/// Represents the illumination level of an area.
/// </summary>
public enum LightLevel
{
    /// <summary>
    /// Fully illuminated - no penalties.
    /// </summary>
    Bright,

    /// <summary>
    /// Partially illuminated - minor penalties to perception.
    /// </summary>
    Dim,

    /// <summary>
    /// No illumination - significant penalties without dark vision.
    /// </summary>
    Dark,

    /// <summary>
    /// Supernatural darkness - even dark vision cannot penetrate.
    /// </summary>
    MagicalDarkness
}
```

### Room Modifications

```
MODIFY: Room
├── ADD: BaseLightLevel: LightLevel (default: Dim)
├── ADD: CurrentLightLevel: LightLevel (computed)
├── ADD: HasActiveLightSources: bool
├── ADD: IsOutdoor: bool (for day/night cycle)
├── ADD: SetBaseLightLevel(LightLevel): void
└── ADD: CalculateCurrentLightLevel(): LightLevel
```

### Light Penalty Constants

```csharp
namespace RuneAndRust.Domain.Constants;

/// <summary>
/// Constants for light-based penalties.
/// </summary>
public static class LightPenalties
{
    /// <summary>
    /// Accuracy penalty in dim light.
    /// </summary>
    public const int DimLightAccuracyPenalty = -1;

    /// <summary>
    /// Accuracy penalty in darkness.
    /// </summary>
    public const int DarkAccuracyPenalty = -3;

    /// <summary>
    /// Accuracy penalty in magical darkness.
    /// </summary>
    public const int MagicalDarknessAccuracyPenalty = -5;

    /// <summary>
    /// Perception DC modifier in dim light.
    /// </summary>
    public const int DimLightPerceptionDC = 2;

    /// <summary>
    /// Perception DC modifier in darkness.
    /// </summary>
    public const int DarkPerceptionDC = 5;

    /// <summary>
    /// Perception DC modifier in magical darkness.
    /// </summary>
    public const int MagicalDarknessPerceptionDC = 10;

    /// <summary>
    /// Gets the accuracy penalty for a light level.
    /// </summary>
    public static int GetAccuracyPenalty(LightLevel level) => level switch
    {
        LightLevel.Bright => 0,
        LightLevel.Dim => DimLightAccuracyPenalty,
        LightLevel.Dark => DarkAccuracyPenalty,
        LightLevel.MagicalDarkness => MagicalDarknessAccuracyPenalty,
        _ => 0
    };

    /// <summary>
    /// Gets the perception DC modifier for a light level.
    /// </summary>
    public static int GetPerceptionDCModifier(LightLevel level) => level switch
    {
        LightLevel.Bright => 0,
        LightLevel.Dim => DimLightPerceptionDC,
        LightLevel.Dark => DarkPerceptionDC,
        LightLevel.MagicalDarkness => MagicalDarknessPerceptionDC,
        _ => 0
    };
}
```

### CombatService Updates

```csharp
// In CombatService.CalculateHitChance or similar method:

/// <summary>
/// Applies light-based accuracy penalties to attack rolls.
/// </summary>
private int ApplyLightPenalty(int baseAccuracy, LightLevel lightLevel, VisionType attackerVision)
{
    // Dark vision negates penalties in Dark (but not MagicalDarkness)
    if (attackerVision == VisionType.DarkVision && lightLevel == LightLevel.Dark)
        return baseAccuracy;

    // True sight negates all light penalties
    if (attackerVision == VisionType.TrueSight)
        return baseAccuracy;

    return baseAccuracy + LightPenalties.GetAccuracyPenalty(lightLevel);
}
```

### User-Facing Changes

**Room Description with Light Level:**
```
The Ancient Crypt                        [Dark]
=========================================
You can barely make out the shapes of stone sarcophagi
in the oppressive darkness. The air is cold and still.

[DARKNESS PENALTIES ACTIVE]
  • Accuracy: -3
  • Perception: +5 DC

Exits: north (dim light visible), south
```

**Combat in Darkness:**
```
> attack skeleton

You swing at the Skeleton in the darkness...

[Light Penalty: -3 accuracy]
[Rolling Attack: DC 12]
Roll: 2d6 + 3 - 3 = [5, 4] + 3 - 3 = 9

Your attack misses in the darkness!
```

**Trap Detection in Darkness:**
```
You enter the Shadowy Corridor. Darkness fills
the passage ahead.

[Passive Perception check...]
[Base DC: 12, Darkness modifier: +5 = DC 17]
Roll: 2d6 + 3 = [4, 3] + 3 = 10

You don't notice anything unusual in the darkness.
```

### Configuration Example

```json
{
  "rooms": [
    {
      "id": "crypt-entrance",
      "name": "Crypt Entrance",
      "description": "Stone steps descend into darkness...",
      "baseLightLevel": "Dim",
      "isOutdoor": false
    },
    {
      "id": "ancient-crypt",
      "name": "The Ancient Crypt",
      "description": "Oppressive darkness fills this burial chamber...",
      "baseLightLevel": "Dark",
      "isOutdoor": false
    },
    {
      "id": "void-chamber",
      "name": "Chamber of the Void",
      "description": "Supernatural darkness consumes all light...",
      "baseLightLevel": "MagicalDarkness",
      "isOutdoor": false
    },
    {
      "id": "forest-clearing",
      "name": "Forest Clearing",
      "description": "A small clearing in the dense forest...",
      "baseLightLevel": "Bright",
      "isOutdoor": true
    }
  ]
}
```

### Acceptance Criteria

- [ ] LightLevel enum has all four levels defined
- [ ] Room.BaseLightLevel stores configured light level
- [ ] Room.CurrentLightLevel computes effective light
- [ ] Combat accuracy applies light penalties correctly
- [ ] Trap detection DC increases in darkness
- [ ] Light level displays in room descriptions
- [ ] Light level indicator shows in UI
- [ ] Bright light has no penalties
- [ ] Magical darkness has maximum penalties
- [ ] ~30 unit tests pass

---

## v0.4.3b: Light Sources & Vision

[v0.4.3b Design Specification](v0.4.3b-design-specification.md)

### Overview

Implement light source items and entities, vision types for players and creatures, and commands for managing illumination. Players can light torches, fuel lanterns, and creatures with dark vision can see in darkness without penalty.

### Scope

**In Scope:**
- `LightSource` entity with radius and duration
- `LightSourceDefinition` for configuration
- Torch item (consumable, limited duration)
- Lantern item (reusable, fuel-based)
- Fuel consumption mechanics
- `VisionType` enum (Normal, DarkVision, TrueSight)
- `Player.VisionType` property
- `Monster.VisionType` property
- Light sensitivity for creatures
- `light` command to activate light sources
- `extinguish` command to deactivate
- `refuel` command for lanterns
- Room light level calculation with active sources
- Light source duration tracking

**Out of Scope:**
- Player skills (v0.4.3c)
- Day/night cycle (v0.4.3d)
- Weather effects (v0.4.3d)

### Key Deliverables

| Type | Count | Details |
|------|-------|---------|
| Domain Entities | 1 | `LightSource` |
| Domain Enums | 1 | `VisionType` |
| Domain Definitions | 1 | `LightSourceDefinition` |
| Player Updates | 1 | Add VisionType |
| Monster Updates | 1 | Add VisionType, LightSensitivity |
| Room Updates | 1 | LightSources collection |
| Commands | 3 | `light`, `extinguish`, `refuel` |
| Service Updates | 1 | LightService |
| Configuration | 1 | `lightsources.json` |
| Unit Tests | ~30 | Light source, vision tests |

### VisionType Enum

```csharp
namespace RuneAndRust.Domain.Enums;

/// <summary>
/// Types of vision that affect light level perception.
/// </summary>
public enum VisionType
{
    /// <summary>
    /// Normal vision - affected by all light levels.
    /// </summary>
    Normal,

    /// <summary>
    /// Can see in darkness as if it were dim light.
    /// Does not help in magical darkness.
    /// </summary>
    DarkVision,

    /// <summary>
    /// Can see normally in all light conditions.
    /// Penetrates magical darkness.
    /// </summary>
    TrueSight
}
```

### LightSource Entity

```csharp
namespace RuneAndRust.Domain.Entities;

/// <summary>
/// Represents an active source of light in a room.
/// </summary>
public class LightSource : IEntity
{
    /// <summary>
    /// Gets the unique identifier for this light source.
    /// </summary>
    public Guid Id { get; private set; }

    /// <summary>
    /// Gets the definition ID from configuration.
    /// </summary>
    public string DefinitionId { get; private set; } = string.Empty;

    /// <summary>
    /// Gets the display name of this light source.
    /// </summary>
    public string Name { get; private set; } = string.Empty;

    /// <summary>
    /// Gets the light level this source provides.
    /// </summary>
    public LightLevel ProvidedLight { get; private set; } = LightLevel.Bright;

    /// <summary>
    /// Gets whether this light source is currently active.
    /// </summary>
    public bool IsActive { get; private set; }

    /// <summary>
    /// Gets whether this light source is portable (carried by player).
    /// </summary>
    public bool IsPortable { get; private set; }

    /// <summary>
    /// Gets the remaining duration in turns (-1 = permanent).
    /// </summary>
    public int RemainingDuration { get; private set; } = -1;

    /// <summary>
    /// Gets whether this light source has limited duration.
    /// </summary>
    public bool HasDuration => RemainingDuration >= 0;

    /// <summary>
    /// Gets whether this light source is permanent (no duration).
    /// </summary>
    public bool IsPermanent => RemainingDuration < 0;

    /// <summary>
    /// Gets whether this light source uses fuel.
    /// </summary>
    public bool UsesFuel { get; private set; }

    /// <summary>
    /// Gets the current fuel amount (for lanterns).
    /// </summary>
    public int CurrentFuel { get; private set; }

    /// <summary>
    /// Gets the maximum fuel capacity.
    /// </summary>
    public int MaxFuel { get; private set; }

    /// <summary>
    /// Gets whether this light source has fuel remaining.
    /// </summary>
    public bool HasFuel => !UsesFuel || CurrentFuel > 0;

    /// <summary>
    /// Gets the associated item ID (if this is an item-based light).
    /// </summary>
    public Guid? AssociatedItemId { get; private set; }

    /// <summary>
    /// Gets the owner player ID (for portable lights).
    /// </summary>
    public Guid? OwnerId { get; private set; }

    private LightSource() { }

    /// <summary>
    /// Creates a new light source.
    /// </summary>
    public static LightSource Create(
        string definitionId,
        string name,
        LightLevel providedLight,
        bool isPortable = false,
        int duration = -1,
        bool usesFuel = false,
        int maxFuel = 0,
        Guid? associatedItemId = null,
        Guid? ownerId = null)
    {
        ArgumentException.ThrowIfNullOrWhiteSpace(definitionId);
        ArgumentException.ThrowIfNullOrWhiteSpace(name);

        return new LightSource
        {
            Id = Guid.NewGuid(),
            DefinitionId = definitionId,
            Name = name,
            ProvidedLight = providedLight,
            IsPortable = isPortable,
            RemainingDuration = duration,
            UsesFuel = usesFuel,
            MaxFuel = maxFuel,
            CurrentFuel = maxFuel,
            AssociatedItemId = associatedItemId,
            OwnerId = ownerId
        };
    }

    /// <summary>
    /// Creates a torch light source.
    /// </summary>
    public static LightSource CreateTorch(int duration, Guid itemId, Guid ownerId) =>
        Create("torch", "Torch", LightLevel.Bright, true, duration, false, 0, itemId, ownerId);

    /// <summary>
    /// Creates a lantern light source.
    /// </summary>
    public static LightSource CreateLantern(int maxFuel, Guid itemId, Guid ownerId) =>
        Create("lantern", "Lantern", LightLevel.Bright, true, -1, true, maxFuel, itemId, ownerId);

    /// <summary>
    /// Activates this light source.
    /// </summary>
    public bool Activate()
    {
        if (IsActive)
            return false;

        if (UsesFuel && CurrentFuel <= 0)
            return false;

        IsActive = true;
        return true;
    }

    /// <summary>
    /// Deactivates this light source.
    /// </summary>
    public bool Deactivate()
    {
        if (!IsActive)
            return false;

        IsActive = false;
        return true;
    }

    /// <summary>
    /// Processes a turn tick, consuming duration or fuel.
    /// </summary>
    /// <returns>True if the light source burned out.</returns>
    public bool Tick()
    {
        if (!IsActive)
            return false;

        if (HasDuration)
        {
            RemainingDuration--;
            if (RemainingDuration <= 0)
            {
                IsActive = false;
                return true; // Burned out
            }
        }

        if (UsesFuel)
        {
            CurrentFuel--;
            if (CurrentFuel <= 0)
            {
                IsActive = false;
                return true; // Out of fuel
            }
        }

        return false;
    }

    /// <summary>
    /// Refuels this light source.
    /// </summary>
    /// <param name="fuelAmount">Amount of fuel to add.</param>
    /// <returns>Amount of fuel actually added.</returns>
    public int Refuel(int fuelAmount)
    {
        if (!UsesFuel)
            return 0;

        var spaceAvailable = MaxFuel - CurrentFuel;
        var actualFuel = Math.Min(fuelAmount, spaceAvailable);
        CurrentFuel += actualFuel;
        return actualFuel;
    }

    /// <summary>
    /// Gets the percentage of fuel remaining.
    /// </summary>
    public int GetFuelPercentage()
    {
        if (!UsesFuel || MaxFuel == 0)
            return 100;

        return (int)((CurrentFuel / (float)MaxFuel) * 100);
    }
}
```

### LightSourceDefinition

```csharp
namespace RuneAndRust.Domain.Definitions;

/// <summary>
/// Configuration for a type of light source.
/// </summary>
public class LightSourceDefinition
{
    /// <summary>
    /// Gets the unique identifier for this definition.
    /// </summary>
    public string Id { get; private set; } = string.Empty;

    /// <summary>
    /// Gets the display name.
    /// </summary>
    public string Name { get; private set; } = string.Empty;

    /// <summary>
    /// Gets the light level provided.
    /// </summary>
    public LightLevel ProvidedLight { get; private set; } = LightLevel.Bright;

    /// <summary>
    /// Gets whether this is a portable light source.
    /// </summary>
    public bool IsPortable { get; private set; }

    /// <summary>
    /// Gets the duration in turns (-1 = permanent).
    /// </summary>
    public int Duration { get; private set; } = -1;

    /// <summary>
    /// Gets whether this uses fuel.
    /// </summary>
    public bool UsesFuel { get; private set; }

    /// <summary>
    /// Gets the maximum fuel capacity.
    /// </summary>
    public int MaxFuel { get; private set; }

    /// <summary>
    /// Gets the associated item definition ID.
    /// </summary>
    public string? AssociatedItemId { get; private set; }

    /// <summary>
    /// Gets the fuel item definition ID (for refueling).
    /// </summary>
    public string? FuelItemId { get; private set; }

    private LightSourceDefinition() { }

    public static LightSourceDefinition Create(
        string id,
        string name,
        LightLevel providedLight,
        bool isPortable = false,
        int duration = -1,
        bool usesFuel = false,
        int maxFuel = 0,
        string? associatedItemId = null,
        string? fuelItemId = null)
    {
        return new LightSourceDefinition
        {
            Id = id,
            Name = name,
            ProvidedLight = providedLight,
            IsPortable = isPortable,
            Duration = duration,
            UsesFuel = usesFuel,
            MaxFuel = maxFuel,
            AssociatedItemId = associatedItemId,
            FuelItemId = fuelItemId
        };
    }
}
```

### Player/Monster Modifications

```
MODIFY: Player
├── ADD: VisionType: VisionType (default: Normal)
├── ADD: ActiveLightSource: LightSource?
├── ADD: SetVisionType(VisionType): void
├── ADD: SetActiveLightSource(LightSource?): void
└── ADD: GetEffectiveLightLevel(Room): LightLevel

MODIFY: Monster
├── ADD: VisionType: VisionType (default: Normal)
├── ADD: LightSensitivity: bool (default: false)
├── ADD: LightSensitivityPenalty: int (default: -2)
└── ADD: GetEffectiveLightLevel(Room): LightLevel
```

### Room Modifications

```
MODIFY: Room
├── ADD: _lightSources: List<LightSource>
├── ADD: LightSources: IReadOnlyList<LightSource>
├── ADD: AddLightSource(LightSource): void
├── ADD: RemoveLightSource(LightSource): bool
├── ADD: GetActiveLightSources(): IEnumerable<LightSource>
└── UPDATE: CalculateCurrentLightLevel(): LightLevel
```

### ILightService Interface

```csharp
namespace RuneAndRust.Application.Interfaces;

/// <summary>
/// Service for managing light sources and visibility.
/// </summary>
public interface ILightService
{
    /// <summary>
    /// Activates a light source for a player.
    /// </summary>
    LightResult ActivateLight(Player player, Item lightItem);

    /// <summary>
    /// Deactivates the player's active light source.
    /// </summary>
    LightResult DeactivateLight(Player player);

    /// <summary>
    /// Refuels a lantern with fuel item.
    /// </summary>
    RefuelResult RefuelLantern(Player player, Item lantern, Item fuelItem);

    /// <summary>
    /// Gets the effective light level for a player in a room.
    /// </summary>
    LightLevel GetEffectiveLightLevel(Player player, Room room);

    /// <summary>
    /// Gets the effective light level for a monster in a room.
    /// </summary>
    LightLevel GetEffectiveLightLevel(Monster monster, Room room);

    /// <summary>
    /// Processes light source ticks at end of turn.
    /// </summary>
    IEnumerable<LightSourceExpiredResult> ProcessLightSources(Player player, Room room);

    /// <summary>
    /// Checks if a creature has a combat penalty due to light sensitivity.
    /// </summary>
    int GetLightSensitivityPenalty(Monster monster, Room room);
}

public readonly record struct LightResult
{
    public bool Success { get; init; }
    public LightSource? LightSource { get; init; }
    public string Message { get; init; }
}

public readonly record struct RefuelResult
{
    public bool Success { get; init; }
    public int FuelAdded { get; init; }
    public int CurrentFuel { get; init; }
    public int MaxFuel { get; init; }
    public string Message { get; init; }
}

public readonly record struct LightSourceExpiredResult
{
    public LightSource LightSource { get; init; }
    public string Message { get; init; }
}
```

### User-Facing Changes

**Commands:**
```
> light <item>            # Light a torch or lantern
> light torch             # Light a torch from inventory
> extinguish              # Put out current light source
> refuel <lantern> <fuel> # Refuel lantern with oil
> inventory               # Shows light source status
```

**Lighting a Torch:**
```
> light torch

You strike the torch against the wall and it bursts
into flame, illuminating your surroundings.

[Torch lit - 10 turns remaining]
The room is now brightly lit.
```

**Torch Burning Out:**
```
=== END OF TURN ===

Your torch flickers and dies, plunging you into darkness.

[Torch burned out]
The room is now dark.
[DARKNESS PENALTIES ACTIVE]
```

**Using a Lantern:**
```
> light lantern

You open the lantern's shutter and the oil flame
casts a warm glow around you.

[Lantern lit - Fuel: 100%]
The room is now brightly lit.

---

> refuel lantern oil

You carefully pour lamp oil into the lantern.

[Refueled: +50 fuel]
[Lantern fuel: 80%]
```

**Dark Vision:**
```
You enter the Shadowy Passage. Darkness fills
the narrow corridor.

[Your dark vision allows you to see clearly]

You can make out the outline of a door to the north
and scratches on the stone floor.

[No darkness penalties - Dark Vision active]
```

**Light Sensitivity:**
```
> attack goblin

The Goblin Shield-Bearer squints in the bright light!

[Light Sensitivity: -2 accuracy for Goblin]
```

### Configuration Example

```json
{
  "$schema": "../schemas/lightsources.schema.json",
  "lightSources": [
    {
      "id": "torch",
      "name": "Torch",
      "providedLight": "Bright",
      "isPortable": true,
      "duration": 10,
      "usesFuel": false,
      "associatedItemId": "item-torch"
    },
    {
      "id": "lantern",
      "name": "Oil Lantern",
      "providedLight": "Bright",
      "isPortable": true,
      "duration": -1,
      "usesFuel": true,
      "maxFuel": 100,
      "associatedItemId": "item-lantern",
      "fuelItemId": "item-lamp-oil"
    },
    {
      "id": "magical-light",
      "name": "Magical Light",
      "providedLight": "Bright",
      "isPortable": true,
      "duration": 20,
      "usesFuel": false,
      "associatedItemId": "item-light-stone"
    },
    {
      "id": "wall-sconce",
      "name": "Wall Sconce",
      "providedLight": "Dim",
      "isPortable": false,
      "duration": -1,
      "usesFuel": false
    }
  ]
}
```

### Acceptance Criteria

- [ ] LightSource entity tracks active lights with duration/fuel
- [ ] VisionType enum has Normal, DarkVision, TrueSight
- [ ] Player.VisionType affects effective light level
- [ ] Monster.VisionType affects their perception
- [ ] Light sensitivity applies combat penalties in bright light
- [ ] Torch consumes duration and burns out
- [ ] Lantern consumes fuel and can be refueled
- [ ] `light` command activates light sources
- [ ] `extinguish` command deactivates light sources
- [ ] `refuel` command adds fuel to lanterns
- [ ] Room.CalculateCurrentLightLevel considers active sources
- [ ] Dark Vision negates Dark penalties (not MagicalDarkness)
- [ ] True Sight negates all light penalties
- [ ] ~30 unit tests pass

---

## v0.4.3c: Skills Foundation

[v0.4.3c Design Specification](v0.4.3c-design-specification.md)

### Overview

Establish the player skills system with skill definitions, proficiency tracking, and progression mechanics. This phase creates the foundation for specific skill implementations in the next phase.

### Scope

**In Scope:**
- `SkillDefinition` for skill configuration
- `PlayerSkill` entity for tracking player skill levels
- `Player.Skills` collection
- Skill proficiency levels (Untrained, Novice, Apprentice, Journeyman, Expert, Master)
- `SkillService` for skill checks
- `ISkillService` interface
- Skill progression from usage
- `skills` command to view skills
- `train` command foundation
- Skill check integration with DiceService
- Skill-based DC modifiers

**Out of Scope:**
- Specific skill implementations (v0.4.3d)
- Day/night cycle (v0.4.3d)
- Weather effects (v0.4.3d)

### Key Deliverables

| Type | Count | Details |
|------|-------|---------|
| Domain Entities | 1 | `PlayerSkill` |
| Domain Enums | 1 | `SkillProficiency` |
| Domain Definitions | 1 | `SkillDefinition` |
| Application Services | 1 | `SkillService` |
| Application Interfaces | 1 | `ISkillService` |
| Player Updates | 1 | Add Skills collection |
| Commands | 1 | `skills` |
| Configuration | 1 | `skills.json` |
| Unit Tests | ~25 | Skill, proficiency tests |

### SkillProficiency Enum

```csharp
namespace RuneAndRust.Domain.Enums;

/// <summary>
/// Proficiency levels for player skills.
/// </summary>
public enum SkillProficiency
{
    /// <summary>No training - cannot attempt skill checks.</summary>
    Untrained = 0,

    /// <summary>Basic training - can attempt simple checks.</summary>
    Novice = 1,

    /// <summary>Developing skill - moderate bonus.</summary>
    Apprentice = 2,

    /// <summary>Competent practitioner - good bonus.</summary>
    Journeyman = 3,

    /// <summary>Highly skilled - excellent bonus.</summary>
    Expert = 4,

    /// <summary>Mastery achieved - maximum bonus.</summary>
    Master = 5
}
```

### SkillDefinition

```csharp
namespace RuneAndRust.Domain.Definitions;

/// <summary>
/// Configuration for a trainable player skill.
/// </summary>
public class SkillDefinition
{
    /// <summary>
    /// Gets the unique identifier for this skill.
    /// </summary>
    public string Id { get; private set; } = string.Empty;

    /// <summary>
    /// Gets the display name.
    /// </summary>
    public string Name { get; private set; } = string.Empty;

    /// <summary>
    /// Gets the description of this skill.
    /// </summary>
    public string Description { get; private set; } = string.Empty;

    /// <summary>
    /// Gets the primary attribute associated with this skill.
    /// </summary>
    public string PrimaryAttribute { get; private set; } = string.Empty;

    /// <summary>
    /// Gets the category of this skill (e.g., "Physical", "Mental", "Social").
    /// </summary>
    public string Category { get; private set; } = string.Empty;

    /// <summary>
    /// Gets whether untrained characters can attempt this skill.
    /// </summary>
    public bool AllowUntrained { get; private set; }

    /// <summary>
    /// Gets the bonus per proficiency level.
    /// </summary>
    public int BonusPerLevel { get; private set; } = 1;

    /// <summary>
    /// Gets the experience required per proficiency level.
    /// </summary>
    public IReadOnlyDictionary<SkillProficiency, int> ExperienceThresholds { get; private set; }
        = new Dictionary<SkillProficiency, int>();

    private SkillDefinition() { }

    public static SkillDefinition Create(
        string id,
        string name,
        string description,
        string primaryAttribute,
        string category,
        bool allowUntrained = true,
        int bonusPerLevel = 1,
        IDictionary<SkillProficiency, int>? expThresholds = null)
    {
        return new SkillDefinition
        {
            Id = id,
            Name = name,
            Description = description,
            PrimaryAttribute = primaryAttribute,
            Category = category,
            AllowUntrained = allowUntrained,
            BonusPerLevel = bonusPerLevel,
            ExperienceThresholds = expThresholds?.ToDictionary(k => k.Key, k => k.Value)
                ?? GetDefaultThresholds()
        };
    }

    private static Dictionary<SkillProficiency, int> GetDefaultThresholds() => new()
    {
        { SkillProficiency.Novice, 0 },
        { SkillProficiency.Apprentice, 50 },
        { SkillProficiency.Journeyman, 150 },
        { SkillProficiency.Expert, 350 },
        { SkillProficiency.Master, 700 }
    };

    /// <summary>
    /// Gets the proficiency bonus for a given level.
    /// </summary>
    public int GetProficiencyBonus(SkillProficiency proficiency)
    {
        return (int)proficiency * BonusPerLevel;
    }

    /// <summary>
    /// Gets the proficiency level for given experience.
    /// </summary>
    public SkillProficiency GetProficiencyForExperience(int experience)
    {
        var result = SkillProficiency.Untrained;

        foreach (var kvp in ExperienceThresholds.OrderBy(k => k.Value))
        {
            if (experience >= kvp.Value)
                result = kvp.Key;
            else
                break;
        }

        return result;
    }
}
```

### PlayerSkill Entity

```csharp
namespace RuneAndRust.Domain.Entities;

/// <summary>
/// Represents a player's proficiency in a specific skill.
/// </summary>
public class PlayerSkill : IEntity
{
    /// <summary>
    /// Gets the unique identifier for this skill instance.
    /// </summary>
    public Guid Id { get; private set; }

    /// <summary>
    /// Gets the skill definition ID.
    /// </summary>
    public string SkillId { get; private set; } = string.Empty;

    /// <summary>
    /// Gets the owning player ID.
    /// </summary>
    public Guid PlayerId { get; private set; }

    /// <summary>
    /// Gets the current proficiency level.
    /// </summary>
    public SkillProficiency Proficiency { get; private set; } = SkillProficiency.Untrained;

    /// <summary>
    /// Gets the current skill experience.
    /// </summary>
    public int Experience { get; private set; }

    /// <summary>
    /// Gets the number of times this skill has been used.
    /// </summary>
    public int TimesUsed { get; private set; }

    /// <summary>
    /// Gets the number of successful skill checks.
    /// </summary>
    public int SuccessfulChecks { get; private set; }

    private PlayerSkill() { }

    /// <summary>
    /// Creates a new player skill.
    /// </summary>
    public static PlayerSkill Create(
        string skillId,
        Guid playerId,
        SkillProficiency startingProficiency = SkillProficiency.Untrained,
        int startingExp = 0)
    {
        ArgumentException.ThrowIfNullOrWhiteSpace(skillId);

        return new PlayerSkill
        {
            Id = Guid.NewGuid(),
            SkillId = skillId,
            PlayerId = playerId,
            Proficiency = startingProficiency,
            Experience = startingExp
        };
    }

    /// <summary>
    /// Adds experience and potentially levels up proficiency.
    /// </summary>
    /// <returns>True if proficiency increased.</returns>
    public bool AddExperience(int amount, SkillDefinition definition)
    {
        if (amount <= 0)
            return false;

        var oldProficiency = Proficiency;
        Experience += amount;
        Proficiency = definition.GetProficiencyForExperience(Experience);

        return Proficiency > oldProficiency;
    }

    /// <summary>
    /// Records a skill usage.
    /// </summary>
    public void RecordUsage(bool success)
    {
        TimesUsed++;
        if (success)
            SuccessfulChecks++;
    }

    /// <summary>
    /// Gets the success rate as a percentage.
    /// </summary>
    public int GetSuccessRate()
    {
        if (TimesUsed == 0)
            return 0;

        return (int)((SuccessfulChecks / (float)TimesUsed) * 100);
    }

    /// <summary>
    /// Sets proficiency directly (for training).
    /// </summary>
    public void SetProficiency(SkillProficiency proficiency, SkillDefinition definition)
    {
        Proficiency = proficiency;
        // Set experience to minimum for that level
        if (definition.ExperienceThresholds.TryGetValue(proficiency, out var exp))
            Experience = Math.Max(Experience, exp);
    }
}
```

### Player Modifications

```
MODIFY: Player
├── ADD: _skills: Dictionary<string, PlayerSkill>
├── ADD: Skills: IReadOnlyDictionary<string, PlayerSkill>
├── ADD: GetSkill(string skillId): PlayerSkill?
├── ADD: AddSkill(PlayerSkill): void
├── ADD: HasSkill(string skillId): bool
└── ADD: GetSkillProficiency(string skillId): SkillProficiency
```

### ISkillService Interface

```csharp
namespace RuneAndRust.Application.Interfaces;

/// <summary>
/// Service for managing player skills and skill checks.
/// </summary>
public interface ISkillService
{
    /// <summary>
    /// Performs a skill check.
    /// </summary>
    SkillCheckResult PerformSkillCheck(Player player, string skillId, int dc);

    /// <summary>
    /// Gets a player's total skill bonus.
    /// </summary>
    int GetSkillBonus(Player player, string skillId);

    /// <summary>
    /// Awards skill experience for usage.
    /// </summary>
    SkillExperienceResult AwardSkillExperience(Player player, string skillId, int amount);

    /// <summary>
    /// Gets all skills for a player.
    /// </summary>
    IEnumerable<PlayerSkillInfo> GetPlayerSkills(Player player);

    /// <summary>
    /// Gets all available skill definitions.
    /// </summary>
    IEnumerable<SkillDefinition> GetAllSkillDefinitions();

    /// <summary>
    /// Initializes default skills for a new player.
    /// </summary>
    void InitializePlayerSkills(Player player);
}

public readonly record struct SkillCheckResult
{
    public string SkillId { get; init; }
    public bool Success { get; init; }
    public int Roll { get; init; }
    public int SkillBonus { get; init; }
    public int Total { get; init; }
    public int DC { get; init; }
    public int Margin { get; init; }
    public string Message { get; init; }
}

public readonly record struct SkillExperienceResult
{
    public string SkillId { get; init; }
    public int ExperienceGained { get; init; }
    public int TotalExperience { get; init; }
    public bool LeveledUp { get; init; }
    public SkillProficiency NewProficiency { get; init; }
    public string Message { get; init; }
}

public readonly record struct PlayerSkillInfo
{
    public string SkillId { get; init; }
    public string Name { get; init; }
    public SkillProficiency Proficiency { get; init; }
    public int Experience { get; init; }
    public int ExperienceToNext { get; init; }
    public int Bonus { get; init; }
    public int TimesUsed { get; init; }
    public int SuccessRate { get; init; }
}
```

### User-Facing Changes

**Commands:**
```
> skills                  # View all player skills
> skills <skill>          # View details for specific skill
```

**Skills Display:**
```
> skills

Your Skills
===========

PHYSICAL
  Acrobatics      [Novice]     ████░░░░░░ +1    (32/50 to Apprentice)
  Stealth         [Apprentice] ██████░░░░ +2    (89/150 to Journeyman)

MENTAL
  Perception      [Journeyman] ████████░░ +3    (245/350 to Expert)
  Field Medicine  [Novice]     ██░░░░░░░░ +1    (15/50 to Apprentice)

TECHNICAL
  Lockpicking     [Untrained]  ░░░░░░░░░░ --    (Cannot use)

SOCIAL
  Rhetoric        [Novice]     ███░░░░░░░ +1    (28/50 to Apprentice)
```

**Skill Detail:**
```
> skills perception

Perception                           [Journeyman]
===============================================
The ability to notice details, spot hidden objects,
and detect traps and ambushes.

Primary Attribute: Wits
Category: Mental

Proficiency: ★★★☆☆ Journeyman (+3 bonus)
Experience: 245 / 350 (70% to Expert)

Statistics:
  Times Used: 47
  Successful: 31 (66% success rate)

Progression:
  Untrained  →  Novice     (0 exp)
  Novice     →  Apprentice (50 exp)    ✓
  Apprentice →  Journeyman (150 exp)   ✓
  Journeyman →  Expert     (350 exp)
  Expert     →  Master     (700 exp)
```

**Skill Check:**
```
> search

You carefully examine the room...

[Skill Check: Perception]
Roll: 2d6 = [4, 5] = 9
Skill Bonus: +3 (Journeyman)
Total: 12 vs DC 14

You don't notice anything unusual.
[+5 Perception experience]
```

**Skill Level Up:**
```
=== SKILL IMPROVED ===

Your Perception skill has improved!
Journeyman → Expert

[Perception bonus: +3 → +4]

Your keen senses are now finely honed.
```

### Configuration Example

```json
{
  "$schema": "../schemas/skills.schema.json",
  "skills": [
    {
      "id": "perception",
      "name": "Perception",
      "description": "The ability to notice details, spot hidden objects, and detect traps and ambushes.",
      "primaryAttribute": "Wits",
      "category": "Mental",
      "allowUntrained": true,
      "bonusPerLevel": 1,
      "experienceThresholds": {
        "Novice": 0,
        "Apprentice": 50,
        "Journeyman": 150,
        "Expert": 350,
        "Master": 700
      }
    },
    {
      "id": "stealth",
      "name": "Stealth",
      "description": "Moving silently, hiding in shadows, and avoiding detection.",
      "primaryAttribute": "Finesse",
      "category": "Physical",
      "allowUntrained": true,
      "bonusPerLevel": 1
    },
    {
      "id": "lockpicking",
      "name": "Lockpicking",
      "description": "Opening locks without the proper key using picks and skill.",
      "primaryAttribute": "Finesse",
      "category": "Technical",
      "allowUntrained": false,
      "bonusPerLevel": 1
    },
    {
      "id": "acrobatics",
      "name": "Acrobatics",
      "description": "Jumping, climbing, balancing, and tumbling.",
      "primaryAttribute": "Finesse",
      "category": "Physical",
      "allowUntrained": true,
      "bonusPerLevel": 1
    },
    {
      "id": "field-medicine",
      "name": "Field Medicine",
      "description": "Treating wounds, curing ailments, and stabilizing the injured.",
      "primaryAttribute": "Wits",
      "category": "Mental",
      "allowUntrained": true,
      "bonusPerLevel": 1
    },
    {
      "id": "rhetoric",
      "name": "Rhetoric",
      "description": "Persuasion, intimidation, and social manipulation.",
      "primaryAttribute": "Charisma",
      "category": "Social",
      "allowUntrained": true,
      "bonusPerLevel": 1
    },
    {
      "id": "wilderness-survival",
      "name": "Wilderness Survival",
      "description": "Foraging, tracking, and navigating wild terrain.",
      "primaryAttribute": "Wits",
      "category": "Physical",
      "allowUntrained": true,
      "bonusPerLevel": 1
    }
  ]
}
```

### Acceptance Criteria

- [ ] SkillDefinition configures all skill properties
- [ ] PlayerSkill tracks proficiency and experience
- [ ] SkillProficiency enum has all levels
- [ ] Player.Skills collection works correctly
- [ ] SkillService performs skill checks with bonuses
- [ ] Skill experience awards on usage
- [ ] Proficiency increases at thresholds
- [ ] Untrained skills cannot be used if configured
- [ ] `skills` command displays all skills
- [ ] Skill detail view shows progression
- [ ] Level up notification displays
- [ ] ~25 unit tests pass

---

## v0.4.3d: Skills & Environment

[v0.4.3d Design Specification](v0.4.3d-design-specification.md)

### Overview

Implement specific skill behaviors and integrate them with game systems. Add optional day/night cycle for outdoor areas and weather effects that affect visibility.

### Scope

**In Scope:**
- Perception skill integration with trap detection
- Stealth skill integration with monster detection
- Lockpicking skill integration with locks
- Acrobatics skill for movement checks
- Field Medicine skill for healing
- Wilderness Survival for outdoor areas
- Rhetoric skill for NPC interactions
- Day/Night cycle (optional, for outdoor rooms)
- Weather effects (rain, fog) affecting visibility
- Time tracking (GameTime)
- `time` command to check current time
- Weather display in room descriptions

**Out of Scope:**
- Complex weather systems (future)
- Seasons (future)
- Weather affecting combat (future)

### Key Deliverables

| Type | Count | Details |
|------|-------|---------|
| Service Updates | 5 | TrapService, CombatService, LockService, HealingService, NpcService |
| Domain Value Objects | 2 | `GameTime`, `Weather` |
| Enums | 1 | `WeatherType` |
| Room Updates | 1 | Weather tracking |
| Commands | 1 | `time` |
| Configuration | 1 | `time-weather.json` |
| Unit Tests | ~25 | Skill integration, time, weather tests |

### Skill Integrations

```csharp
// TrapService - Perception Integration
public IEnumerable<TrapDetectionResult> CheckPassiveDetection(Player player, Room room)
{
    var perceptionBonus = _skillService.GetSkillBonus(player, "perception");
    var lightPenalty = LightPenalties.GetPerceptionDCModifier(
        _lightService.GetEffectiveLightLevel(player, room));

    foreach (var trap in room.Traps.Where(t => t.IsHidden))
    {
        var roll = _diceService.Roll("2d6").Total;
        var total = roll + perceptionBonus - lightPenalty;

        var detected = total >= trap.DetectionDC;

        if (detected)
            trap.TryDetect(total);

        // Award experience for detection attempts
        _skillService.AwardSkillExperience(player, "perception",
            detected ? 10 : 5);

        yield return new TrapDetectionResult
        {
            Trap = trap,
            Detected = detected,
            RollResult = total,
            DC = trap.DetectionDC
        };
    }
}

// CombatService - Stealth Integration
public bool CheckSurpriseRound(Player player, Monster monster, Room room)
{
    if (!player.IsHiding)
        return false;

    var stealthBonus = _skillService.GetSkillBonus(player, "stealth");
    var lightModifier = GetStealthLightModifier(room);

    var stealthRoll = _diceService.Roll("2d6").Total + stealthBonus + lightModifier;
    var perceptionDC = 10 + monster.PerceptionModifier;

    var success = stealthRoll >= perceptionDC;

    _skillService.AwardSkillExperience(player, "stealth",
        success ? 15 : 5);

    return success;
}

private int GetStealthLightModifier(Room room)
{
    return room.CurrentLightLevel switch
    {
        LightLevel.Dark => 3,
        LightLevel.Dim => 1,
        LightLevel.Bright => -2,
        LightLevel.MagicalDarkness => 5,
        _ => 0
    };
}

// LockService - Lockpicking Integration
public LockpickResult AttemptLockpick(Player player, InteractiveObject lockedObject)
{
    var skill = player.GetSkill("lockpicking");
    if (skill == null || skill.Proficiency == SkillProficiency.Untrained)
    {
        return new LockpickResult
        {
            Success = false,
            Message = "You don't know how to pick locks."
        };
    }

    var lockpickBonus = _skillService.GetSkillBonus(player, "lockpicking");
    var roll = _diceService.Roll("2d6").Total;
    var total = roll + lockpickBonus;

    var lockDC = lockedObject.Lock?.LockpickDC ?? 15;
    var success = total >= lockDC;

    _skillService.AwardSkillExperience(player, "lockpicking",
        success ? 20 : 10);

    return new LockpickResult
    {
        Success = success,
        Roll = roll,
        Bonus = lockpickBonus,
        Total = total,
        DC = lockDC,
        Message = success
            ? "Click! The lock opens."
            : "The lock resists your attempts."
    };
}
```

### GameTime Value Object

```csharp
namespace RuneAndRust.Domain.ValueObjects;

/// <summary>
/// Tracks in-game time for day/night cycle.
/// </summary>
public class GameTime
{
    /// <summary>
    /// Gets the current hour (0-23).
    /// </summary>
    public int Hour { get; private set; }

    /// <summary>
    /// Gets the current day.
    /// </summary>
    public int Day { get; private set; } = 1;

    /// <summary>
    /// Gets whether it is currently daytime (6:00 - 18:00).
    /// </summary>
    public bool IsDaytime => Hour >= 6 && Hour < 18;

    /// <summary>
    /// Gets whether it is currently nighttime.
    /// </summary>
    public bool IsNighttime => !IsDaytime;

    /// <summary>
    /// Gets the time of day descriptor.
    /// </summary>
    public TimeOfDay TimeOfDay => Hour switch
    {
        >= 5 and < 7 => TimeOfDay.Dawn,
        >= 7 and < 12 => TimeOfDay.Morning,
        >= 12 and < 14 => TimeOfDay.Noon,
        >= 14 and < 17 => TimeOfDay.Afternoon,
        >= 17 and < 20 => TimeOfDay.Dusk,
        >= 20 and < 24 => TimeOfDay.Evening,
        _ => TimeOfDay.Night
    };

    private GameTime() { }

    public static GameTime Create(int hour = 8, int day = 1)
    {
        return new GameTime
        {
            Hour = Math.Clamp(hour, 0, 23),
            Day = Math.Max(1, day)
        };
    }

    /// <summary>
    /// Advances time by one turn (typically 10 minutes).
    /// </summary>
    public void AdvanceTurn(int turnsPerHour = 6)
    {
        // Track turns and advance hour when appropriate
        // Implementation depends on turn tracking
    }

    /// <summary>
    /// Advances time by specified hours.
    /// </summary>
    public void AdvanceHours(int hours)
    {
        Hour += hours;
        while (Hour >= 24)
        {
            Hour -= 24;
            Day++;
        }
    }

    /// <summary>
    /// Gets the display string for current time.
    /// </summary>
    public string GetDisplayString()
    {
        var period = Hour >= 12 ? "PM" : "AM";
        var displayHour = Hour > 12 ? Hour - 12 : (Hour == 0 ? 12 : Hour);
        return $"Day {Day}, {displayHour}:00 {period} ({TimeOfDay})";
    }

    /// <summary>
    /// Gets the light level modifier for outdoor areas.
    /// </summary>
    public LightLevel GetOutdoorLightLevel(WeatherType weather)
    {
        var baseLight = TimeOfDay switch
        {
            TimeOfDay.Night => LightLevel.Dark,
            TimeOfDay.Dawn or TimeOfDay.Dusk => LightLevel.Dim,
            _ => LightLevel.Bright
        };

        // Weather can reduce light
        if (weather == WeatherType.Fog || weather == WeatherType.HeavyRain)
        {
            return baseLight switch
            {
                LightLevel.Bright => LightLevel.Dim,
                LightLevel.Dim => LightLevel.Dark,
                _ => baseLight
            };
        }

        return baseLight;
    }
}

public enum TimeOfDay
{
    Dawn,
    Morning,
    Noon,
    Afternoon,
    Dusk,
    Evening,
    Night
}
```

### Weather Value Object

```csharp
namespace RuneAndRust.Domain.ValueObjects;

/// <summary>
/// Current weather conditions affecting outdoor areas.
/// </summary>
public class Weather
{
    /// <summary>
    /// Gets the current weather type.
    /// </summary>
    public WeatherType Type { get; private set; } = WeatherType.Clear;

    /// <summary>
    /// Gets the remaining duration in hours (-1 = indefinite).
    /// </summary>
    public int Duration { get; private set; } = -1;

    /// <summary>
    /// Gets visibility modifier (negative reduces visibility).
    /// </summary>
    public int VisibilityModifier => Type switch
    {
        WeatherType.Clear => 0,
        WeatherType.Cloudy => 0,
        WeatherType.LightRain => -1,
        WeatherType.HeavyRain => -3,
        WeatherType.Fog => -4,
        WeatherType.Storm => -5,
        _ => 0
    };

    /// <summary>
    /// Gets whether this weather affects light levels.
    /// </summary>
    public bool AffectsLight => Type is WeatherType.Fog or WeatherType.HeavyRain or WeatherType.Storm;

    private Weather() { }

    public static Weather Create(WeatherType type, int duration = -1)
    {
        return new Weather
        {
            Type = type,
            Duration = duration
        };
    }

    public static Weather Clear() => Create(WeatherType.Clear);

    /// <summary>
    /// Advances weather duration.
    /// </summary>
    /// <returns>True if weather ended.</returns>
    public bool AdvanceHour()
    {
        if (Duration < 0)
            return false;

        Duration--;
        return Duration <= 0;
    }

    /// <summary>
    /// Gets display description.
    /// </summary>
    public string GetDescription() => Type switch
    {
        WeatherType.Clear => "Clear skies",
        WeatherType.Cloudy => "Overcast",
        WeatherType.LightRain => "Light rain falls",
        WeatherType.HeavyRain => "Heavy rain pours down",
        WeatherType.Fog => "Thick fog blankets the area",
        WeatherType.Storm => "A violent storm rages",
        _ => "Unknown weather"
    };
}

public enum WeatherType
{
    Clear,
    Cloudy,
    LightRain,
    HeavyRain,
    Fog,
    Storm
}
```

### User-Facing Changes

**Time Command:**
```
> time

Current Time: Day 3, 2:00 PM (Afternoon)
Weather: Light rain falls

The afternoon sun is partially obscured by rain clouds.
```

**Outdoor Room with Day/Night:**
```
Forest Clearing                          [Dim]
=============================================
Day 3, 7:15 PM (Dusk)

The sun sets behind the trees, casting long shadows
across the clearing. A light rain patters on the leaves.

[Light rain: -1 visibility]

Exits: north (forest path), south (cave entrance)
```

**Night Time:**
```
Forest Clearing                          [Dark]
=============================================
Day 3, 11:00 PM (Night)

Darkness has fallen over the forest. The stars are
hidden behind thick clouds.

[DARKNESS PENALTIES ACTIVE]
Without a light source, you can barely see.

Exits: north, south (you can see dim light)
```

**Skill Check with Light/Weather:**
```
> search

You examine the area carefully...

[Skill Check: Perception]
Roll: 2d6 = [5, 3] = 8
Skill Bonus: +3 (Journeyman)
Weather Penalty: -1 (Light rain)
Total: 10 vs DC 12

The rain makes it difficult to spot details.
[+5 Perception experience]
```

### Configuration Example

```json
{
  "$schema": "../schemas/time-weather.schema.json",
  "timeSettings": {
    "startingHour": 8,
    "startingDay": 1,
    "turnsPerHour": 6,
    "enableDayNightCycle": true
  },
  "weatherPatterns": [
    {
      "id": "temperate-forest",
      "region": "Forest",
      "patterns": [
        { "type": "Clear", "weight": 40 },
        { "type": "Cloudy", "weight": 25 },
        { "type": "LightRain", "weight": 20 },
        { "type": "HeavyRain", "weight": 10 },
        { "type": "Fog", "weight": 5 }
      ]
    },
    {
      "id": "dungeon-interior",
      "region": "Dungeon",
      "patterns": [
        { "type": "Clear", "weight": 100 }
      ]
    }
  ]
}
```

### Acceptance Criteria

- [ ] Perception skill integrates with trap detection
- [ ] Stealth skill affects monster surprise
- [ ] Lockpicking skill unlocks objects
- [ ] Acrobatics skill affects movement checks
- [ ] Field Medicine skill provides healing
- [ ] Rhetoric skill affects NPC interactions
- [ ] GameTime tracks day/hour progression
- [ ] Day/night affects outdoor light levels
- [ ] Weather affects visibility in outdoor areas
- [ ] `time` command shows current time/weather
- [ ] Weather appears in room descriptions
- [ ] Indoor areas unaffected by time/weather
- [ ] ~25 unit tests pass

---

## Dependencies & Prerequisites

```
v0.4.2 (Puzzles & Riddles) - REQUIRED
    │
    ├── Puzzle entity ────────────────────┐
    ├── PuzzleService ────────────────────┤
    ├── PuzzleHint ───────────────────────┤
    └── RiddleNpc ────────────────────────┘
                                          │
v0.4.1 (Traps & Hazards) - REQUIRED       │
    │                                     │
    ├── Trap entity ──────────────────────┤
    ├── TrapService ──────────────────────┤
    └── SavingThrow ──────────────────────┘
                                          │
v0.4.0 (Interactive Objects) - REQUIRED   │
    │                                     │
    ├── InteractiveObject ────────────────┤
    ├── Lock mechanics ───────────────────┤
    └── InteractionService ───────────────┘
                                          │
                                          ▼
v0.4.3 (Light & Environment)
    │
    ├── v0.4.3a: Light Core ──────────────────────────────┐
    │       Dependencies: Room, CombatService, TrapService│
    │       Provides: LightLevel, light penalties         │
    │                                                     │
    ├── v0.4.3b: Light Sources & Vision ──────────────────┤
    │       Dependencies: v0.4.3a, Item, Player, Monster  │
    │       Provides: LightSource, VisionType, commands   │
    │                                                     │
    ├── v0.4.3c: Skills Foundation ───────────────────────┤
    │       Dependencies: v0.4.3a, Player, DiceService    │
    │       Provides: SkillDefinition, PlayerSkill        │
    │                                                     │
    └── v0.4.3d: Skills & Environment ────────────────────┘
            Dependencies: v0.4.3a, v0.4.3b, v0.4.3c
            Provides: Skill integrations, Day/Night, Weather
```

---

## Estimated Effort Summary

| Phase | New Files | Modified Files | Est. Tests | Complexity |
|-------|-----------|----------------|------------|------------|
| v0.4.3a | ~4 | ~5 | ~30 | Medium |
| v0.4.3b | ~6 | ~6 | ~30 | High |
| v0.4.3c | ~5 | ~4 | ~25 | High |
| v0.4.3d | ~4 | ~8 | ~25 | Medium |
| **Total** | **~19** | **~23** | **~110** | |

---

## Risk Assessment

| Risk | Impact | Probability | Mitigation |
|------|--------|-------------|------------|
| Light level balance | Medium | Medium | Configurable penalties |
| Torch duration tuning | Low | Medium | Adjustable in config |
| Skill progression rate | Medium | Medium | Configurable thresholds |
| Day/night complexity | Medium | Low | Optional feature |
| Weather randomness | Low | Low | Weighted patterns |
| Performance with many light sources | Low | Low | Limit active sources |

---

## Design Decisions (Confirmed)

### Light System

| Decision | Value | Notes |
|----------|-------|-------|
| **Light Levels** | 4 levels | Bright, Dim, Dark, MagicalDarkness |
| **Penalty Application** | Accuracy and Perception | Combat and detection |
| **Light Source Tracking** | Per-room collection | Plus player active light |
| **Vision Override** | Enum-based | DarkVision, TrueSight |

### Skill System

| Decision | Value | Notes |
|----------|-------|-------|
| **Proficiency Levels** | 6 levels | Untrained through Master |
| **Experience Model** | Usage-based | Awards on skill checks |
| **Bonus Calculation** | Per-level bonus | Configurable per skill |
| **Untrained Handling** | Configurable | Some skills require training |

### Environment System

| Decision | Value | Notes |
|----------|-------|-------|
| **Time Tracking** | Hour + Day | 24-hour cycle |
| **Day/Night** | Outdoor rooms only | Indoor unaffected |
| **Weather** | Outdoor rooms only | Visibility modifiers |
| **Weather Patterns** | Region-based | Weighted randomization |

---

## Integration Points

### From v0.4.0
- InteractiveObject for light source objects
- Lock mechanics for lockpicking skill

### From v0.4.1
- Trap detection for Perception skill
- HazardZone for environmental skill checks

### From v0.4.2
- Light-based puzzles (mirror puzzles, illuminate symbols)
- Puzzle hint dice checks using skills

### To Future Versions
- More complex skill trees
- Skill-based crafting
- Weather affecting combat
- Seasonal variations

---

## Next Steps

1. **Review & Approve** - Confirm scope breakdown
2. **v0.4.3a Design Spec** - Light core system
3. **Implement v0.4.3a** - Build light level mechanics
4. **v0.4.3b Design Spec** - Light sources and vision
5. **Implement v0.4.3b** - Build light source items
6. **v0.4.3c Design Spec** - Skills foundation
7. **Implement v0.4.3c** - Build skill system
8. **v0.4.3d Design Spec** - Skills integration and environment
9. **Implement v0.4.3d** - Complete skill implementations

---

*This scope breakdown provides a structured approach to implementing v0.4.3 Light & Environment Systems. Each sub-phase builds on the previous, creating comprehensive lighting and skill systems that add depth to dungeon exploration and character development.*
