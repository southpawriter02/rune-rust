# v0.15.0e Changelog

## Summary
Introduces structured dice roll logging system for history tracking, context-aware queries, debugging, and analytics foundation.

## Added

### Domain Layer - Records
- **`DiceRollLog`** in `Domain/Records/`:
  - Complete roll metadata record
  - Properties: RollId, Timestamp, Seed, PoolSize, Results, NetSuccesses, TotalSuccesses, TotalBotches, RawTotal
  - Context, ActorId, TargetId, IsFumble, IsCriticalSuccess
  - Factory method `FromRollResult()`
  - `ToString()` and `ToDetailedString()` formatting

### Domain Layer - Constants
- **`RollContexts`** in `Domain/Constants/`:
  - Combat contexts: CombatAttack, CombatDamage, CombatDefense, CombatInitiative, CombatResolve
  - Prefixes: SkillPrefix, DialoguePrefix, CraftingPrefix, ContestedPrefix, ExtendedPrefix, RandomPrefix
  - Helper methods: `Skill()`, `Dialogue()`, `Crafting()`, `Contested()`, `Extended()`
  - Utility methods: `MatchesPrefix()`, `GetCategory()`, `GetSubcategory()`, `IsValidContext()`

### Domain Layer - Interfaces
- **`IDiceRollLogger`** in `Domain/Interfaces/`:
  - `LogRoll(DiceRollLog)` - Store roll entry
  - `GetRollHistory(count)` - Retrieve recent rolls
  - `GetRollsByContext(prefix)` - Filter by context prefix
  - `ClearHistory()` - Clear all history
  - Properties: HistoryCount, MaxHistorySize

### Application Layer - Services
- **`InMemoryDiceRollLogger`** in `Application/Services/`:
  - Thread-safe ConcurrentQueue storage
  - Auto-trim when over capacity (default 1000)
  - Bonus methods: `GetFumbles()`, `GetCriticalSuccesses()`, `GetRollsByActor()`, `GetRollsByTimeRange()`, `GetStatistics()`
- **`RollStatistics`** record for aggregate statistics

## Changed

### Domain Layer - Interfaces
- **`IDiceService`**: Updated `Roll()` signature with new parameters:
  - `context` (string, default: "General")
  - `actorId` (Guid?, default: null)
  - `targetId` (Guid?, default: null)

### Application Layer - Services
- **`DiceService`**:
  - Added optional `IDiceRollLogger` constructor parameter
  - Roll method captures RNG seed before rolling
  - Logs rolls to structured roll history via `LogRollToHistory()`

### Unit Tests
- Updated mock setups in `CombatServiceDiceTests.cs` and `ComboServiceTests.cs` for new Roll signature

## Added Tests
- **`InMemoryDiceRollLoggerTests.cs`** - 13 tests covering:
  - Roll logging with correct data
  - History retrieval with count limiting
  - Context prefix filtering
  - Fumble/critical flag storage
  - History trimming when over capacity
  - Statistics calculation
  - Actor-based filtering

## Verification
- Build: **0 errors, 0 warnings**
- Tests: **13 passing** (InMemoryDiceRollLoggerTests)
