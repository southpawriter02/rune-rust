# Changelog: v0.17.3a - Archetype Enum & Definition

**Release Date:** 2026-01-30
**Phase:** Archetype System (1/6)
**Status:** Complete

---

## Overview

Implements the foundational types for the v0.17.3 Archetype System: the `Archetype` enum, `ResourceType` enum, and `ArchetypeDefinition` entity. These types define the four character combat role archetypes (Warrior, Skirmisher, Mystic, Adept) and the two primary resource pool types (Stamina, Aether Pool).

Archetype is a **permanent choice** made during character creation (Step 4) that cannot be changed afterward. Each archetype determines the character's combat role, primary resource pool, starting abilities (v0.17.3c), resource bonuses (v0.17.3b), and available specializations (v0.17.3d).

The legacy `archetypes.json` and `archetypes.schema.json` configuration files have been replaced with the v0.17.3a format aligned with the design specification, removing the old `id`/`name`/`statTendency`/`sortOrder` structure in favor of the full definition format with `archetypeId`, `displayName`, `tagline`, `description`, `selectionText`, `combatRole`, `primaryResource`, `playstyleDescription`, and `isPermanent` fields.

---

## Added

### Domain Layer

#### Enums

- **`Archetype`** (`Enums/Archetype.cs`)
    - Enum with 4 values: `Warrior` (0), `Skirmisher` (1), `Mystic` (2), `Adept` (3)
    - Explicit integer assignments (0-3) for stable serialization and database storage
    - Comprehensive XML documentation with `<summary>`, `<remarks>`, `<list>`, `<para>`, `<seealso>` tags
    - Per-value remarks detailing combat role, primary resource, key strengths, specialization count
    - `<seealso>` cross-references to `ArchetypeDefinition` and `ResourceType`

- **`ResourceType`** (`Enums/ResourceType.cs`)
    - Enum with 2 values: `Stamina` (0), `AetherPool` (1)
    - Explicit integer assignments (0-1) for stable serialization
    - XML documentation noting which archetypes use each resource type
    - Formula references for Max Stamina and Max Aether Pool calculations
    - `<seealso>` cross-references to `Archetype` and `ArchetypeDefinition`

#### Entities

- **`ArchetypeDefinition`** (`Entities/ArchetypeDefinition.cs`)
    - `sealed class` implementing `IEntity` for archetype core definition data
    - File header with `═══` borders, version `0.17.3a`
    - Section separators: PRIVATE FIELDS, PROPERTIES, CONSTRUCTORS, FACTORY METHODS, HELPER METHODS, DEBUGGING
    - Static `ILogger<ArchetypeDefinition>?` field for diagnostic output
    - Properties: `Id` (Guid), `ArchetypeId` (Archetype), `DisplayName`, `Tagline`, `Description`, `SelectionText`, `CombatRole`, `PrimaryResource` (ResourceType), `PlaystyleDescription`, `IsPermanent` (always true)
    - Each property with full XML docs (`<summary>`, `<value>`, `<remarks>`, `<example>` where applicable)
    - Private parameterless constructor for EF Core materialization
    - `Create()` static factory method with:
        - 8 required parameters + optional logger
        - `ArgumentException.ThrowIfNullOrWhiteSpace` for all 6 string parameters
        - Debug logging on entry and after validation
        - Information logging on successful creation with all properties
        - String trimming on all text properties
        - `IsPermanent = true` always set
        - `Guid.NewGuid()` for unique identifier
    - `GetSummary()`: Returns `"{DisplayName} ({CombatRole}) - {PrimaryResource}"`
    - `GetSelectionDisplay()`: Returns multi-line formatted string with name, tagline, and selection text
    - `ToString()`: Returns `"ArchetypeDefinition: {DisplayName} [{ArchetypeId}]"`

### Configuration Files

- **`config/archetypes.json`** — Replaced with v0.17.3a definition format
    - 4 archetype definitions: Warrior, Skirmisher, Mystic, Adept
    - New fields: `archetypeId`, `displayName`, `tagline`, `description`, `selectionText`, `combatRole`, `primaryResource`, `playstyleDescription`, `isPermanent`
    - `$schema` reference to `./schemas/archetypes.schema.json`

- **`config/schemas/archetypes.schema.json`** — Replaced with v0.17.3a schema
    - JSON Schema Draft-07 with `definitions` (matching existing codebase convention)
    - `archetypeDefinition` definition with all 9 required properties
    - `archetypeId` constrained to enum `["Warrior", "Skirmisher", "Mystic", "Adept"]`
    - `primaryResource` constrained to enum `["Stamina", "AetherPool"]`
    - `isPermanent` constrained to `const: true`
    - `minItems: 4, maxItems: 4` for archetypes array
    - `additionalProperties: false` at all levels

### Unit Tests

- **`ArchetypeTests`** (`Enums/ArchetypeTests.cs`) — 3 tests
    - `Archetype_HasFourValues`: Verifies exactly 4 enum values
    - `Archetype_ContainsAllExpectedValues`: Verifies Warrior, Skirmisher, Mystic, Adept present
    - `Archetype_HasCorrectIntegerValues`: Parameterized test (Warrior=0, Skirmisher=1, Mystic=2, Adept=3)

- **`ResourceTypeTests`** (`Enums/ResourceTypeTests.cs`) — 2 tests
    - `ResourceType_HasTwoValues`: Verifies exactly 2 enum values
    - `ResourceType_HasCorrectIntegerValues`: Parameterized test (Stamina=0, AetherPool=1)

- **`ArchetypeDefinitionTests`** (`Entities/ArchetypeDefinitionTests.cs`) — 13 tests
    - `Create_WithValidData_ReturnsDefinition`: Full Warrior definition with all property verification
    - `Create_WithNullDisplayName_ThrowsArgumentException`: Null display name rejection
    - `Create_WithWhitespaceTagline_ThrowsArgumentException`: Whitespace tagline rejection
    - `Create_WithNullDescription_ThrowsArgumentException`: Null description rejection
    - `Create_WithNullSelectionText_ThrowsArgumentException`: Null selection text rejection
    - `Create_WithNullCombatRole_ThrowsArgumentException`: Null combat role rejection
    - `Create_WithNullPlaystyleDescription_ThrowsArgumentException`: Null playstyle rejection
    - `IsPermanent_AlwaysReturnsTrue`: Permanent flag verified with Mystic archetype
    - `GetSummary_ReturnsFormattedString`: Summary format verification
    - `GetSelectionDisplay_ReturnsFormattedMultilineString`: Multi-line display format
    - `ToString_ReturnsFormattedString`: Debug string format
    - `Create_TrimsWhitespaceFromStrings`: Whitespace trimming on all string properties
    - `Create_GeneratesUniqueId`: Unique GUID generation per instance
    - `Create_MysticArchetype_HasAetherPoolResource`: Mystic resource type verification

### Glossary

- **`config/glossary.json`** — Added 6 archetype glossary entries
    - `archetype`: Permanent combat role choice (sortOrder: 21)
    - `warrior-archetype`: Tank / Melee DPS archetype (sortOrder: 22)
    - `skirmisher-archetype`: Mobile DPS archetype (sortOrder: 23)
    - `mystic-archetype`: Caster / Control archetype (sortOrder: 24)
    - `adept-archetype`: Support / Utility archetype (sortOrder: 25)
    - `resource-type`: Stamina vs Aether Pool distinction (sortOrder: 26)

---

## Changed

### Configuration Files

- **`config/archetypes.json`** — Replaced legacy format entirely
    - Removed legacy fields: `id`, `name`, `description`, `playstyleSummary`, `statTendency`, `sortOrder`
    - New structure with 9 required fields per archetype definition
    - Resource bonuses, starting abilities, and specialization mappings deferred to v0.17.3b-d

- **`config/schemas/archetypes.schema.json`** — Replaced legacy schema entirely
    - Removed legacy `ArchetypeDefinition` definition with `id`, `name`, `statTendency`, `sortOrder`
    - New `archetypeDefinition` definition with combat role, resource type, and permanence constraints
    - Updated from loose `minItems: 1` to strict `minItems: 4, maxItems: 4`

### Documentation

- **`docs/design/v0.17.x/v0.17.3-scope-breakdown.md`** — Checked off v0.17.3a unit test items
- **`docs/design/v0.17.x/v0.17.x-overview.md`** — Checked off `Archetype` enum and `ArchetypeDefinition` entity deliverables

---

## Design Decisions

### JSON Schema Draft-07 (Not Draft 2020-12)

The design specification uses Draft 2020-12 with `$defs`, but all existing schemas in the codebase use Draft-07 with `definitions`. Draft-07 was chosen for consistency with `backgrounds.schema.json`, `lineages.schema.json`, `attributes.schema.json`, and other established schemas.

### Optional Logger Parameter on Create()

The design specification's `ArchetypeDefinition.Create()` does not include a logger parameter, but the established codebase pattern (`LineageDefinition.Create()`, `BackgroundDefinition.Create()`) includes an optional `ILogger<T>?` parameter for diagnostic output. The codebase pattern was followed for consistency.

### Sealed Class Pattern

`ArchetypeDefinition` is declared as `sealed class` matching the `LineageDefinition` pattern. This prevents inheritance and signals that the entity is not designed to be extended.

### Replacing Legacy archetypes.json

The existing `archetypes.json` used a legacy format with `id`, `name`, `description`, `playstyleSummary`, `statTendency`, and `sortOrder` fields. The v0.17.3a design specification defines a completely different structure. The file was replaced entirely rather than extended because no fields from the legacy format are retained in the new design.

### IsPermanent as Explicit Property

The `IsPermanent` property always returns `true` and could theoretically be omitted. However, it is included explicitly to:
- Support configuration-driven permanence (loaded from JSON with `const: true` validation)
- Enable UI warning generation during character creation Step 4
- Provide a clear API signal to consuming services that this choice is irreversible

---

## Dependencies

### Prerequisites

| Type | Phase | Usage |
| ---- | ----- | ----- |
| `IEntity` | v0.0.x | Interface for domain entities |

### Provides to Future Phases

| Type | Phase | Usage |
| ---- | ----- | ----- |
| `Archetype` | v0.17.3b | Resource bonus mapping key |
| `Archetype` | v0.17.3c | Starting ability mapping key |
| `Archetype` | v0.17.3d | Specialization availability key |
| `Archetype` | v0.17.3e | Provider service lookup key |
| `Archetype` | v0.17.3f | Application service parameter |
| `ResourceType` | v0.17.3b | Resource bonus calculations |
| `ArchetypeDefinition` | v0.17.3e | Provider returns definitions |
| `ArchetypeDefinition` | v0.17.5 | Character creation UI display |

---

## Logging Strategy

| Level | When |
|-------|------|
| Debug | Entity creation entry with archetype ID, display name, combat role, primary resource; validation pass confirmation |
| Information | Successful entity creation with all property values |

---

## Files Created

| Path | Description |
|------|-------------|
| `src/Core/RuneAndRust.Domain/Enums/Archetype.cs` | Archetype enum with 4 combat roles |
| `src/Core/RuneAndRust.Domain/Enums/ResourceType.cs` | ResourceType enum with 2 resource pools |
| `src/Core/RuneAndRust.Domain/Entities/ArchetypeDefinition.cs` | ArchetypeDefinition entity |
| `tests/RuneAndRust.Domain.UnitTests/Enums/ArchetypeTests.cs` | Archetype enum unit tests |
| `tests/RuneAndRust.Domain.UnitTests/Enums/ResourceTypeTests.cs` | ResourceType enum unit tests |
| `tests/RuneAndRust.Domain.UnitTests/Entities/ArchetypeDefinitionTests.cs` | ArchetypeDefinition unit tests |

## Files Modified

| Path | Description |
|------|-------------|
| `config/archetypes.json` | Replaced with v0.17.3a definition format |
| `config/schemas/archetypes.schema.json` | Replaced with v0.17.3a schema |
| `config/glossary.json` | Added 6 archetype glossary terms |
| `docs/design/v0.17.x/v0.17.3-scope-breakdown.md` | Checked off v0.17.3a deliverables |
| `docs/design/v0.17.x/v0.17.x-overview.md` | Updated v0.17.3 deliverable checkboxes |

---

## Notes

- Total unit tests for v0.17.3a: 18 tests (3 + 2 + 13)
- The design specification estimated ~8 tests; 18 were implemented for comprehensive coverage of all validation paths, helper methods, and edge cases
- Mystic is the only archetype using `ResourceType.AetherPool`; all others use `ResourceType.Stamina`
- Adept receives 14 starting attribute points instead of the standard 15 (enforced in v0.17.2 allocation system)
- Resource bonuses, starting abilities, specialization mappings, and provider/application services are deferred to v0.17.3b-f
- The `archetypeId` field in configuration uses PascalCase (`"Warrior"`, not `"warrior"`) to match the C# enum naming convention
