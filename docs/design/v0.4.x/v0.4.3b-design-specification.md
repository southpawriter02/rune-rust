# v0.4.3b Design Specification: Light Sources & Vision

**Version:** 0.4.3b
**Phase Name:** Light Sources & Vision
**Parent Version:** v0.4.3 (Light & Environment Systems)
**Prerequisites:** v0.4.3a Complete (Light Core)
**Estimated Tests:** ~30 unit tests

---

## Table of Contents

1. [Executive Summary](#1-executive-summary)
2. [Feature Overview](#2-feature-overview)
3. [Architecture Diagrams](#3-architecture-diagrams)
4. [VisionType Enum](#4-visiontype-enum)
5. [LightSource Entity](#5-lightsource-entity)
6. [LightSourceDefinition](#6-lightsourcedefinition)
7. [Player Modifications](#7-player-modifications)
8. [Monster Modifications](#8-monster-modifications)
9. [Room Modifications](#9-room-modifications)
10. [LightService](#10-lightservice)
11. [User-Facing Commands](#11-user-facing-commands)
12. [Data Model Changes](#12-data-model-changes)
13. [Configuration File Schemas](#13-configuration-file-schemas)
14. [Logging Specifications](#14-logging-specifications)
15. [Unit Testing Requirements](#15-unit-testing-requirements)
16. [Use Cases](#16-use-cases)
17. [Deliverable Checklist](#17-deliverable-checklist)
18. [Acceptance Criteria](#18-acceptance-criteria)
19. [Dependencies](#19-dependencies)
20. [Future Considerations](#20-future-considerations)

---

## 1. Executive Summary

### 1.1 Purpose

This specification implements light source items, vision types, and light management commands. Building on the core light level system from v0.4.3a, this phase enables players to manage illumination through torches and lanterns, while creatures with special vision types can see through darkness.

Key features:
- **Light Sources**: Torches (duration-based) and lanterns (fuel-based)
- **Vision Types**: Normal, DarkVision, TrueSight affecting penalty mitigation
- **Light Sensitivity**: Creatures penalized in bright light
- **Light Commands**: `light`, `extinguish`, `refuel` for light management

### 1.2 Key Deliverables

| Category | Items |
|----------|-------|
| **Domain Entities** | `LightSource` |
| **Domain Enums** | `VisionType` |
| **Domain Definitions** | `LightSourceDefinition` |
| **Player Updates** | `VisionType`, `ActiveLightSource` |
| **Monster Updates** | `VisionType`, `LightSensitivity`, `LightSensitivityPenalty` |
| **Room Updates** | `LightSources` collection, updated `CalculateCurrentLightLevel()` |
| **Application Services** | `LightService`, `ILightService` |
| **Commands** | `light`, `extinguish`, `refuel` |
| **Configuration** | `lightsources.json` |
| **Tests** | ~30 unit tests |

### 1.3 Architectural Significance

This version establishes the **Light Source Pattern** and **Vision System**:

- **Portable vs Fixed Sources**: Player-carried torches/lanterns vs room fixtures
- **Duration vs Fuel**: Consumable torches vs refuelable lanterns
- **Vision Mitigation**: DarkVision negates Dark penalties, TrueSight negates all
- **Light Sensitivity**: Reverse penalty for light-averse creatures
- **Turn-Based Consumption**: Light sources tick each turn

---

## 2. Feature Overview

```
v0.4.3b Light Sources & Vision
├── VisionType Enum
│   ├── Normal (no mitigation)
│   ├── DarkVision (negates Dark)
│   └── TrueSight (negates all)
├── LightSource Entity
│   ├── Duration tracking
│   ├── Fuel management
│   ├── Activate/Deactivate
│   ├── Tick() consumption
│   └── Refuel() method
├── LightSourceDefinition
│   └── JSON configuration
├── Player Updates
│   ├── VisionType property
│   ├── ActiveLightSource property
│   └── GetEffectiveLightLevel()
├── Monster Updates
│   ├── VisionType property
│   ├── LightSensitivity flag
│   └── LightSensitivityPenalty
├── Room Updates
│   ├── LightSources collection
│   ├── AddLightSource()
│   ├── RemoveLightSource()
│   └── Updated CalculateCurrentLightLevel()
├── LightService
│   ├── ActivateLight()
│   ├── DeactivateLight()
│   ├── RefuelLantern()
│   ├── GetEffectiveLightLevel()
│   ├── ProcessLightSources()
│   └── GetLightSensitivityPenalty()
└── Commands
    ├── light <item>
    ├── extinguish
    └── refuel <lantern> <fuel>
```

### 2.1 Scope Alignment

**In Scope:**
- `LightSource` entity with duration/fuel tracking
- `LightSourceDefinition` for configuration
- `VisionType` enum (Normal, DarkVision, TrueSight)
- Torch item (consumable, limited duration)
- Lantern item (reusable, fuel-based)
- `Player.VisionType` and `ActiveLightSource`
- `Monster.VisionType` and light sensitivity
- `light`, `extinguish`, `refuel` commands
- Room light level calculation with active sources
- `LightService` and `ILightService`

**Out of Scope:**
- Player skills (v0.4.3c)
- Day/night cycle (v0.4.3d)
- Weather effects (v0.4.3d)

---

## 3. Architecture Diagrams

### 3.1 Light Source Lifecycle

```
┌─────────────────────────────────────────────────────────────────────┐
│                     LIGHT SOURCE LIFECYCLE                           │
└─────────────────────────────────────────────────────────────────────┘

    Player has           light <item>              End of Turn
    Light Item               │                          │
        │                    ▼                          ▼
        │           ┌───────────────┐          ┌───────────────┐
        │           │ LightService  │          │ ProcessLight  │
        │           │ ActivateLight │          │ Sources()     │
        │           └───────┬───────┘          └───────┬───────┘
        │                   │                          │
        │                   ▼                          ▼
        │           ┌───────────────┐          ┌───────────────┐
        │           │ LightSource   │          │ Tick()        │
        │           │ Create()      │          │ Consume dur/  │
        │           └───────┬───────┘          │ fuel          │
        │                   │                  └───────┬───────┘
        │                   ▼                          │
        │           ┌───────────────┐          ┌───────┴───────┐
        │           │ Activate()    │          │               │
        │           │ IsActive=true │     [Expired]       [Active]
        │           └───────┬───────┘          │               │
        │                   │                  ▼               ▼
        │                   ▼          ┌───────────────┐  Continue
        │           ┌───────────────┐  │ Deactivate    │
        │           │ Room.AddLight │  │ Remove source │
        │           │ Source()      │  │ Notify player │
        │           └───────────────┘  └───────────────┘
```

### 3.2 Vision Type Penalty Mitigation

```
┌─────────────────────────────────────────────────────────────────────┐
│                   VISION TYPE PENALTY MITIGATION                     │
└─────────────────────────────────────────────────────────────────────┘

                        Get Effective Light Level
                                  │
                                  ▼
                    ┌─────────────────────────┐
                    │  Room.CurrentLightLevel │
                    └────────────┬────────────┘
                                 │
            ┌────────────────────┼────────────────────┐
            │                    │                    │
      [Normal]              [DarkVision]         [TrueSight]
            │                    │                    │
            ▼                    ▼                    ▼
    ┌───────────────┐    ┌───────────────┐    ┌───────────────┐
    │ No mitigation │    │ Dark → Dim    │    │ All → Bright  │
    │ Return actual │    │ MagDark stays │    │ No penalties  │
    └───────────────┘    └───────────────┘    └───────────────┘
```

### 3.3 Layer Diagram

```
┌─────────────────────────────────────────────────────────────────────┐
│                        PRESENTATION LAYER                            │
├─────────────────────────────────────────────────────────────────────┤
│  LightCommand      ExtinguishCommand      RefuelCommand              │
│  "light <item>"    "extinguish"           "refuel <l> <f>"           │
└───────┬────────────────────┬─────────────────────┬──────────────────┘
        │                    │                     │
        ▼                    ▼                     ▼
┌─────────────────────────────────────────────────────────────────────┐
│                       APPLICATION LAYER                              │
├─────────────────────────────────────────────────────────────────────┤
│  ILightService / LightService                                        │
│  ├── ActivateLight(player, item): LightResult                       │
│  ├── DeactivateLight(player): LightResult                           │
│  ├── RefuelLantern(player, lantern, fuel): RefuelResult             │
│  ├── GetEffectiveLightLevel(player, room): LightLevel               │
│  ├── GetEffectiveLightLevel(monster, room): LightLevel              │
│  ├── ProcessLightSources(player, room): IEnumerable<Expired>        │
│  └── GetLightSensitivityPenalty(monster, room): int                 │
├─────────────────────────────────────────────────────────────────────┤
│  Result Types                                                        │
│  ├── LightResult { Success, LightSource?, Message }                 │
│  ├── RefuelResult { Success, FuelAdded, CurrentFuel, MaxFuel, Msg } │
│  └── LightSourceExpiredResult { LightSource, Message }              │
└───────┬─────────────────────────────────────────────────────────────┘
        │
        ▼
┌─────────────────────────────────────────────────────────────────────┐
│                         DOMAIN LAYER                                 │
├─────────────────────────────────────────────────────────────────────┤
│  ┌────────────────┐  ┌────────────────┐  ┌────────────────────────┐│
│  │   VisionType   │  │  LightSource   │  │ LightSourceDefinition ││
│  │     (Enum)     │  │   (Entity)     │  │    (Definition)        ││
│  ├────────────────┤  ├────────────────┤  ├────────────────────────┤│
│  │ Normal         │  │ Id             │  │ Id                     ││
│  │ DarkVision     │  │ DefinitionId   │  │ Name                   ││
│  │ TrueSight      │  │ Name           │  │ ProvidedLight          ││
│  └────────────────┘  │ ProvidedLight  │  │ IsPortable             ││
│                      │ IsActive       │  │ Duration               ││
│                      │ IsPortable     │  │ UsesFuel               ││
│                      │ RemainingDur   │  │ MaxFuel                ││
│                      │ UsesFuel       │  │ AssociatedItemId       ││
│                      │ CurrentFuel    │  │ FuelItemId             ││
│                      │ MaxFuel        │  └────────────────────────┘│
│                      │ OwnerId        │                            │
│                      ├────────────────┤                            │
│                      │ Activate()     │                            │
│                      │ Deactivate()   │                            │
│                      │ Tick()         │                            │
│                      │ Refuel()       │                            │
│                      └────────────────┘                            │
│                                                                      │
│  ┌─────────────────────────────────────────────────────────────────┐│
│  │ Player (Modified)                                               ││
│  ├─────────────────────────────────────────────────────────────────┤│
│  │ + VisionType: VisionType (default: Normal)                      ││
│  │ + ActiveLightSource: LightSource?                               ││
│  │ + SetVisionType(type): void                                     ││
│  │ + SetActiveLightSource(source): void                            ││
│  │ + GetEffectiveLightLevel(room): LightLevel                      ││
│  └─────────────────────────────────────────────────────────────────┘│
│                                                                      │
│  ┌─────────────────────────────────────────────────────────────────┐│
│  │ Monster (Modified)                                              ││
│  ├─────────────────────────────────────────────────────────────────┤│
│  │ + VisionType: VisionType (default: Normal)                      ││
│  │ + LightSensitivity: bool (default: false)                       ││
│  │ + LightSensitivityPenalty: int (default: -2)                    ││
│  │ + GetEffectiveLightLevel(room): LightLevel                      ││
│  └─────────────────────────────────────────────────────────────────┘│
│                                                                      │
│  ┌─────────────────────────────────────────────────────────────────┐│
│  │ Room (Modified)                                                 ││
│  ├─────────────────────────────────────────────────────────────────┤│
│  │ - _lightSources: List<LightSource>                              ││
│  │ + LightSources: IReadOnlyList<LightSource>                      ││
│  │ + HasActiveLightSources: bool (updated)                         ││
│  │ + AddLightSource(source): void                                  ││
│  │ + RemoveLightSource(source): bool                               ││
│  │ + GetActiveLightSources(): IEnumerable<LightSource>             ││
│  │ + CalculateCurrentLightLevel(): LightLevel (updated)            ││
│  └─────────────────────────────────────────────────────────────────┘│
└─────────────────────────────────────────────────────────────────────┘
```

---

## 4. VisionType Enum

### 4.1 Implementation

**File:** `src/Core/RuneAndRust.Domain/Enums/VisionType.cs`

```csharp
namespace RuneAndRust.Domain.Enums;

/// <summary>
/// Types of vision that affect light level perception.
/// </summary>
/// <remarks>
/// Vision types determine how creatures perceive light levels
/// and whether they receive penalties from darkness.
/// </remarks>
public enum VisionType
{
    /// <summary>
    /// Normal vision - affected by all light levels.
    /// </summary>
    /// <remarks>
    /// No mitigation of light penalties.
    /// </remarks>
    Normal = 0,

    /// <summary>
    /// Can see in darkness as if it were dim light.
    /// </summary>
    /// <remarks>
    /// Dark → treated as Dim (reduced penalties).
    /// Does not help in magical darkness.
    /// </remarks>
    DarkVision = 1,

    /// <summary>
    /// Can see normally in all light conditions.
    /// </summary>
    /// <remarks>
    /// All light levels → treated as Bright.
    /// Penetrates magical darkness.
    /// </remarks>
    TrueSight = 2
}
```

### 4.2 Vision Mitigation Table

| Vision Type | Bright | Dim | Dark | MagicalDarkness |
|-------------|--------|-----|------|-----------------|
| Normal | Bright | Dim | Dark | MagicalDarkness |
| DarkVision | Bright | Dim | **Dim** | MagicalDarkness |
| TrueSight | Bright | Bright | Bright | **Bright** |

---

## 5. LightSource Entity

### 5.1 Implementation

**File:** `src/Core/RuneAndRust.Domain/Entities/LightSource.cs`

```csharp
namespace RuneAndRust.Domain.Entities;

/// <summary>
/// Represents an active source of light in a room.
/// </summary>
public class LightSource : IEntity
{
    public Guid Id { get; private set; }
    public string DefinitionId { get; private set; } = string.Empty;
    public string Name { get; private set; } = string.Empty;
    public LightLevel ProvidedLight { get; private set; } = LightLevel.Bright;
    public bool IsActive { get; private set; }
    public bool IsPortable { get; private set; }
    public int RemainingDuration { get; private set; } = -1;
    public bool UsesFuel { get; private set; }
    public int CurrentFuel { get; private set; }
    public int MaxFuel { get; private set; }
    public Guid? AssociatedItemId { get; private set; }
    public Guid? OwnerId { get; private set; }

    public bool HasDuration => RemainingDuration >= 0;
    public bool IsPermanent => RemainingDuration < 0;
    public bool HasFuel => !UsesFuel || CurrentFuel > 0;
    public bool IsExpired => (HasDuration && RemainingDuration <= 0) || (UsesFuel && CurrentFuel <= 0);

    private LightSource() { }

    public static LightSource Create(
        string definitionId, string name, LightLevel providedLight,
        bool isPortable = false, int duration = -1, bool usesFuel = false,
        int maxFuel = 0, Guid? associatedItemId = null, Guid? ownerId = null)
    {
        ArgumentException.ThrowIfNullOrWhiteSpace(definitionId);
        ArgumentException.ThrowIfNullOrWhiteSpace(name);

        return new LightSource
        {
            Id = Guid.NewGuid(),
            DefinitionId = definitionId,
            Name = name,
            ProvidedLight = providedLight,
            IsPortable = isPortable,
            RemainingDuration = duration,
            UsesFuel = usesFuel,
            MaxFuel = maxFuel,
            CurrentFuel = maxFuel,
            AssociatedItemId = associatedItemId,
            OwnerId = ownerId
        };
    }

    public static LightSource CreateTorch(int duration, Guid itemId, Guid ownerId) =>
        Create("torch", "Torch", LightLevel.Bright, true, duration, false, 0, itemId, ownerId);

    public static LightSource CreateLantern(int maxFuel, Guid itemId, Guid ownerId) =>
        Create("lantern", "Lantern", LightLevel.Bright, true, -1, true, maxFuel, itemId, ownerId);

    public bool Activate()
    {
        if (IsActive) return false;
        if (UsesFuel && CurrentFuel <= 0) return false;
        IsActive = true;
        return true;
    }

    public bool Deactivate()
    {
        if (!IsActive) return false;
        IsActive = false;
        return true;
    }

    public bool Tick()
    {
        if (!IsActive) return false;

        if (HasDuration)
        {
            RemainingDuration--;
            if (RemainingDuration <= 0) { IsActive = false; return true; }
        }

        if (UsesFuel)
        {
            CurrentFuel--;
            if (CurrentFuel <= 0) { IsActive = false; return true; }
        }

        return false;
    }

    public int Refuel(int fuelAmount)
    {
        if (!UsesFuel) return 0;
        var spaceAvailable = MaxFuel - CurrentFuel;
        var actualFuel = Math.Min(fuelAmount, spaceAvailable);
        CurrentFuel += actualFuel;
        return actualFuel;
    }

    public int GetFuelPercentage() =>
        (!UsesFuel || MaxFuel == 0) ? 100 : (int)((CurrentFuel / (float)MaxFuel) * 100);
}
```

---

## 6. LightSourceDefinition

### 6.1 Implementation

**File:** `src/Core/RuneAndRust.Domain/Definitions/LightSourceDefinition.cs`

```csharp
namespace RuneAndRust.Domain.Definitions;

/// <summary>
/// Configuration for a type of light source.
/// </summary>
public class LightSourceDefinition
{
    public string Id { get; private set; } = string.Empty;
    public string Name { get; private set; } = string.Empty;
    public LightLevel ProvidedLight { get; private set; } = LightLevel.Bright;
    public bool IsPortable { get; private set; }
    public int Duration { get; private set; } = -1;
    public bool UsesFuel { get; private set; }
    public int MaxFuel { get; private set; }
    public string? AssociatedItemId { get; private set; }
    public string? FuelItemId { get; private set; }

    private LightSourceDefinition() { }

    public static LightSourceDefinition Create(
        string id, string name, LightLevel providedLight,
        bool isPortable = false, int duration = -1, bool usesFuel = false,
        int maxFuel = 0, string? associatedItemId = null, string? fuelItemId = null)
    {
        return new LightSourceDefinition
        {
            Id = id, Name = name, ProvidedLight = providedLight,
            IsPortable = isPortable, Duration = duration,
            UsesFuel = usesFuel, MaxFuel = maxFuel,
            AssociatedItemId = associatedItemId, FuelItemId = fuelItemId
        };
    }
}
```

---

## 7. Player Modifications

**File:** `src/Core/RuneAndRust.Domain/Entities/Player.cs`

```csharp
// Add to Player entity:

#region Vision and Light Properties

public VisionType VisionType { get; private set; } = VisionType.Normal;
public LightSource? ActiveLightSource { get; private set; }

public void SetVisionType(VisionType visionType) => VisionType = visionType;

public void SetActiveLightSource(LightSource? lightSource) => ActiveLightSource = lightSource;

/// <summary>
/// Gets the effective light level considering vision type.
/// </summary>
public LightLevel GetEffectiveLightLevel(Room room)
{
    var roomLight = room.CurrentLightLevel;
    
    return VisionType switch
    {
        VisionType.TrueSight => LightLevel.Bright,
        VisionType.DarkVision when roomLight == LightLevel.Dark => LightLevel.Dim,
        _ => roomLight
    };
}

#endregion
```

---

## 8. Monster Modifications

**File:** `src/Core/RuneAndRust.Domain/Entities/Monster.cs`

```csharp
// Add to Monster entity:

#region Vision and Light Properties

public VisionType VisionType { get; private set; } = VisionType.Normal;
public bool LightSensitivity { get; private set; }
public int LightSensitivityPenalty { get; private set; } = -2;

public void SetVisionType(VisionType visionType) => VisionType = visionType;
public void SetLightSensitivity(bool sensitive, int penalty = -2)
{
    LightSensitivity = sensitive;
    LightSensitivityPenalty = penalty;
}

public LightLevel GetEffectiveLightLevel(Room room)
{
    var roomLight = room.CurrentLightLevel;
    
    return VisionType switch
    {
        VisionType.TrueSight => LightLevel.Bright,
        VisionType.DarkVision when roomLight == LightLevel.Dark => LightLevel.Dim,
        _ => roomLight
    };
}

#endregion
```

---

## 9. Room Modifications

**File:** `src/Core/RuneAndRust.Domain/Entities/Room.cs`

```csharp
// Update Room entity:

private readonly List<LightSource> _lightSources = [];

public IReadOnlyList<LightSource> LightSources => _lightSources.AsReadOnly();

public bool HasActiveLightSources => _lightSources.Any(ls => ls.IsActive);

public void AddLightSource(LightSource lightSource)
{
    ArgumentNullException.ThrowIfNull(lightSource);
    _lightSources.Add(lightSource);
}

public bool RemoveLightSource(LightSource lightSource)
{
    return _lightSources.Remove(lightSource);
}

public IEnumerable<LightSource> GetActiveLightSources()
{
    return _lightSources.Where(ls => ls.IsActive);
}

/// <summary>
/// Calculates current light level considering active sources.
/// </summary>
public LightLevel CalculateCurrentLightLevel()
{
    if (!HasActiveLightSources)
        return BaseLightLevel;

    // Get the brightest active light source
    var brightestSource = _lightSources
        .Where(ls => ls.IsActive)
        .OrderBy(ls => ls.ProvidedLight)
        .FirstOrDefault();

    if (brightestSource == null)
        return BaseLightLevel;

    // Light can only make rooms brighter, not darker
    return brightestSource.ProvidedLight < BaseLightLevel
        ? brightestSource.ProvidedLight
        : BaseLightLevel;
}
```

---

## 10. LightService

### 10.1 Interface

**File:** `src/Core/RuneAndRust.Application/Interfaces/ILightService.cs`

```csharp
namespace RuneAndRust.Application.Interfaces;

public interface ILightService
{
    LightResult ActivateLight(Player player, Item lightItem);
    LightResult DeactivateLight(Player player);
    RefuelResult RefuelLantern(Player player, Item lantern, Item fuelItem);
    LightLevel GetEffectiveLightLevel(Player player, Room room);
    LightLevel GetEffectiveLightLevel(Monster monster, Room room);
    IEnumerable<LightSourceExpiredResult> ProcessLightSources(Player player, Room room);
    int GetLightSensitivityPenalty(Monster monster, Room room);
}

public readonly record struct LightResult(bool Success, LightSource? LightSource, string Message);
public readonly record struct RefuelResult(bool Success, int FuelAdded, int CurrentFuel, int MaxFuel, string Message);
public readonly record struct LightSourceExpiredResult(LightSource LightSource, string Message);
```

### 10.2 Implementation

**File:** `src/Core/RuneAndRust.Application/Services/LightService.cs`

```csharp
namespace RuneAndRust.Application.Services;

public class LightService : ILightService
{
    private readonly IGameConfigurationProvider _config;
    private readonly ILogger<LightService> _logger;

    public LightService(IGameConfigurationProvider config, ILogger<LightService> logger)
    {
        _config = config;
        _logger = logger;
    }

    public LightResult ActivateLight(Player player, Item lightItem)
    {
        var definition = _config.GetLightSourceDefinition(lightItem.DefinitionId);
        if (definition == null)
            return new LightResult(false, null, "This item cannot produce light.");

        var lightSource = LightSource.Create(
            definition.Id, definition.Name, definition.ProvidedLight,
            definition.IsPortable, definition.Duration,
            definition.UsesFuel, definition.MaxFuel,
            lightItem.Id, player.Id);

        if (!lightSource.Activate())
            return new LightResult(false, null, "Cannot light this item.");

        player.SetActiveLightSource(lightSource);
        _logger.LogInformation("Player {Name} lit {Light}", player.Name, lightSource.Name);
        
        return new LightResult(true, lightSource, $"You light the {lightSource.Name}.");
    }

    public LightResult DeactivateLight(Player player)
    {
        if (player.ActiveLightSource == null)
            return new LightResult(false, null, "You have no active light source.");

        var source = player.ActiveLightSource;
        source.Deactivate();
        player.SetActiveLightSource(null);
        
        _logger.LogInformation("Player {Name} extinguished {Light}", player.Name, source.Name);
        return new LightResult(true, source, $"You extinguish the {source.Name}.");
    }

    public RefuelResult RefuelLantern(Player player, Item lantern, Item fuelItem)
    {
        if (player.ActiveLightSource?.AssociatedItemId != lantern.Id)
            return new RefuelResult(false, 0, 0, 0, "That lantern is not active.");

        var source = player.ActiveLightSource;
        if (!source.UsesFuel)
            return new RefuelResult(false, 0, 0, 0, "This light source doesn't use fuel.");

        var fuelAdded = source.Refuel(50); // Default fuel amount
        _logger.LogInformation("Refueled {Light} with {Fuel} fuel", source.Name, fuelAdded);
        
        return new RefuelResult(true, fuelAdded, source.CurrentFuel, source.MaxFuel,
            $"Added {fuelAdded} fuel to {source.Name}.");
    }

    public LightLevel GetEffectiveLightLevel(Player player, Room room) =>
        player.GetEffectiveLightLevel(room);

    public LightLevel GetEffectiveLightLevel(Monster monster, Room room) =>
        monster.GetEffectiveLightLevel(room);

    public IEnumerable<LightSourceExpiredResult> ProcessLightSources(Player player, Room room)
    {
        var expired = new List<LightSourceExpiredResult>();

        if (player.ActiveLightSource?.Tick() == true)
        {
            var source = player.ActiveLightSource;
            var msg = source.UsesFuel
                ? $"Your {source.Name} runs out of fuel!"
                : $"Your {source.Name} burns out!";
            
            expired.Add(new LightSourceExpiredResult(source, msg));
            player.SetActiveLightSource(null);
            _logger.LogInformation("{Light} expired for player {Name}", source.Name, player.Name);
        }

        foreach (var source in room.LightSources.Where(ls => ls.IsActive))
        {
            if (source.Tick())
            {
                expired.Add(new LightSourceExpiredResult(source, $"The {source.Name} goes dark."));
            }
        }

        return expired;
    }

    public int GetLightSensitivityPenalty(Monster monster, Room room)
    {
        if (!monster.LightSensitivity)
            return 0;

        var lightLevel = room.CurrentLightLevel;
        return lightLevel == LightLevel.Bright ? monster.LightSensitivityPenalty : 0;
    }
}
```

---

## 11. User-Facing Commands

### 11.1 Light Command

```
> light torch

You strike the torch against the wall and it bursts
into flame, illuminating your surroundings.

[Torch lit - 10 turns remaining]
The room is now brightly lit.
```

### 11.2 Extinguish Command

```
> extinguish

You carefully extinguish your torch.

[Torch extinguished]
The room returns to darkness.
[DARKNESS PENALTIES ACTIVE]
```

### 11.3 Refuel Command

```
> refuel lantern oil

You carefully pour lamp oil into the lantern.

[Refueled: +50 fuel]
[Lantern fuel: 80%]
```

### 11.4 Vision Type Display

```
You enter the Shadowy Corridor.

[Your dark vision allows you to see clearly]
[No darkness penalties - Dark Vision active]
```

### 11.5 Light Sensitivity Display

```
> attack goblin

The Goblin Shield-Bearer squints in the bright light!
[Light Sensitivity: -2 accuracy for Goblin]
```

---

## 12. Data Model Changes

| Type | Layer | Description |
|------|-------|-------------|
| `VisionType` | Domain/Enums | Vision type classification |
| `LightSource` | Domain/Entities | Active light source tracking |
| `LightSourceDefinition` | Domain/Definitions | Light source configuration |
| `Player` | Domain/Entities | Add VisionType, ActiveLightSource |
| `Monster` | Domain/Entities | Add VisionType, LightSensitivity |
| `Room` | Domain/Entities | Add LightSources collection |
| `ILightService` | Application/Interfaces | Light management interface |
| `LightService` | Application/Services | Light management implementation |

---

## 13. Configuration File Schemas

**File:** `config/lightsources.json`

```json
{
  "$schema": "./schemas/lightsources.schema.json",
  "lightSources": [
    {
      "id": "torch",
      "name": "Torch",
      "providedLight": "Bright",
      "isPortable": true,
      "duration": 10,
      "usesFuel": false,
      "associatedItemId": "item-torch"
    },
    {
      "id": "lantern",
      "name": "Oil Lantern",
      "providedLight": "Bright",
      "isPortable": true,
      "duration": -1,
      "usesFuel": true,
      "maxFuel": 100,
      "associatedItemId": "item-lantern",
      "fuelItemId": "item-lamp-oil"
    },
    {
      "id": "magical-light",
      "name": "Magical Light",
      "providedLight": "Bright",
      "isPortable": true,
      "duration": 20,
      "usesFuel": false,
      "associatedItemId": "item-light-stone"
    },
    {
      "id": "wall-sconce",
      "name": "Wall Sconce",
      "providedLight": "Dim",
      "isPortable": false,
      "duration": -1,
      "usesFuel": false
    }
  ]
}
```

---

## 14. Logging Specifications

| Component | Level | Events |
|-----------|-------|--------|
| `LightService` | Information | Light activated/deactivated, refueled, expired |
| `LightService` | Debug | Vision type calculations |
| `CombatService` | Information | Light sensitivity penalty applied |
| `GameSessionService` | Information | Light level changes |

---

## 15. Unit Testing Requirements

### Test Count by Feature

| Feature | Test Count |
|---------|------------|
| VisionType Enum | ~3 |
| LightSource Entity | ~10 |
| LightSourceDefinition | ~3 |
| Player Vision | ~4 |
| Monster Vision/Sensitivity | ~4 |
| Room Light Calculation | ~3 |
| LightService | ~3 |
| **Total** | **~30** |

---

## 16. Use Cases

### UC-001: Light Torch
**Actor:** Player
**Flow:** Player has torch → `light torch` → Create LightSource → Activate → Update room light

### UC-002: Torch Burns Out
**Actor:** System
**Flow:** End of turn → Tick() → Duration = 0 → Deactivate → Notify player

### UC-003: Refuel Lantern
**Actor:** Player
**Flow:** Player has lantern + oil → `refuel lantern oil` → Add fuel → Consume oil item

### UC-004: Dark Vision Mitigation
**Actor:** System
**Flow:** Player with DarkVision enters Dark room → GetEffectiveLightLevel → Return Dim → No penalties

### UC-005: Light Sensitivity Penalty
**Actor:** System
**Flow:** Monster with LightSensitivity in Bright room → Apply penalty to attacks

---

## 17. Deliverable Checklist

### Domain Layer
- [ ] `VisionType` enum
- [ ] `LightSource` entity
- [ ] `LightSourceDefinition` class
- [ ] Player vision properties
- [ ] Monster vision/sensitivity properties
- [ ] Room light sources collection

### Application Layer
- [ ] `ILightService` interface
- [ ] `LightService` implementation
- [ ] Result types (LightResult, RefuelResult, LightSourceExpiredResult)

### Presentation Layer
- [ ] `light` command
- [ ] `extinguish` command
- [ ] `refuel` command
- [ ] Light status in inventory display

### Configuration
- [ ] `lightsources.json`
- [ ] `lightsources.schema.json`

### Testing
- [ ] ~30 unit tests
- [ ] All tests passing

---

## 18. Acceptance Criteria

### Functional
- [ ] LightSource entity tracks active lights with duration/fuel
- [ ] VisionType enum has Normal, DarkVision, TrueSight
- [ ] Player.VisionType affects effective light level
- [ ] Monster.VisionType affects their perception
- [ ] Light sensitivity applies combat penalties in bright light
- [ ] Torch consumes duration and burns out
- [ ] Lantern consumes fuel and can be refueled
- [ ] `light` command activates light sources
- [ ] `extinguish` command deactivates light sources
- [ ] `refuel` command adds fuel to lanterns
- [ ] Room.CalculateCurrentLightLevel considers active sources
- [ ] Dark Vision negates Dark penalties (not MagicalDarkness)
- [ ] True Sight negates all light penalties

### Quality
- [ ] Build succeeds with 0 errors/warnings
- [ ] ~30 unit tests pass
- [ ] Configuration validates against schema
- [ ] XML documentation complete

---

## 19. Dependencies

### Required from v0.4.3a

| Type | Location | Usage |
|------|----------|-------|
| `LightLevel` | `Domain/Enums` | Light source output level |
| `LightPenalties` | `Domain/Constants` | Penalty calculations |
| `Room.BaseLightLevel` | `Domain/Entities` | Base room lighting |

### Provides to v0.4.3c
- Light service for skill check visibility modifiers

### Provides to v0.4.3d
- Foundation for day/night outdoor light calculations

---

## 20. Future Considerations

### Deferred to v0.4.3c
- Perception skill affecting trap detection in darkness
- Stealth skill interaction with light levels

### Deferred to v0.4.3d
- Day/night cycle for outdoor areas
- Weather affecting light levels

### Out of Scope for v0.4.3
- Light-based puzzles
- Monster light-seeking/avoiding behaviors

---

*Document Version: 1.0*
*Last Updated: 2026-01-10*
*Author: AI Assistant*
