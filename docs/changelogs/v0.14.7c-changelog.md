# v0.14.7c Changelog - Environment Descriptor Schema

**Release Date:** 2026-01-21
**Version:** v0.14.7c
**Phase:** Configuration Consolidation (v0.14.x)
**Sub-Phase:** Descriptor Configuration (v0.14.7)

---

## Summary

Implemented the **Environment Descriptor Schema** (`environment-descriptors.schema.json`) for environment-specific descriptor configuration files. This schema provides specialized validation for sensory atmosphere (lighting, sounds, smells, temperature), weather effects with indoor/outdoor variants, and ambient events organized by biome type.

The environment schema validates 3 existing configuration files:
- `environmental.json` (4 sensory pools with ~23 descriptors)
- `weather.json` (10 weather pools with ~40 descriptors)
- `ambient-events.json` (15 ambient pools with ~81 descriptors)

The schema introduces **temporal filtering** via `timeOfDay` and `season` properties for time-based and seasonal atmosphere variation.

---

## Added

### Schema Files

| File | Description |
|------|-------------|
| `config/schemas/environment-descriptors.schema.json` | Environment-specific JSON Schema for sensory/weather/ambient descriptor validation |

### Schema Definitions

| Definition | Type | Count | Description |
|------------|------|-------|-------------|
| `EnvironmentCategory` | enum | 4 | Valid environment categories: `environmental`, `weather`, `ambient`, `objects` |
| `SensoryCategory` | enum | 4 | Sensory pool types: `lighting`, `sounds`, `smells`, `temperature` |
| `WeatherPoolTypes` | enum | 10 | Weather pools with indoor/outdoor variants |
| `AmbientPoolTypes` | enum | 15 | Ambient event pools by biome type |
| `TimeOfDayValue` | enum | 4 | Temporal filter: `dawn`, `day`, `dusk`, `night` |
| `SeasonValue` | enum | 4 | Seasonal filter: `spring`, `summer`, `autumn`, `winter` |
| `EnvironmentDescriptorPool` | object | — | Pool structure with environment descriptors |
| `EnvironmentDescriptor` | object | — | Extended descriptor with temporal filtering |
| `LocationTag` | documentation | — | Common location tag values |
| `ThemeTag` | documentation | — | Common theme tag values |
| `VariablePattern` | documentation | — | Variable substitution syntax |

### SensoryCategory Enum Values (4 total)

| Pool ID | Description |
|---------|-------------|
| `lighting` | Visual lighting/brightness descriptions |
| `sounds` | Audio/ambient sound descriptions |
| `smells` | Olfactory/scent descriptions |
| `temperature` | Tactile temperature sensations |

### WeatherPoolTypes Enum Values (10 total)

| Pool ID | Description |
|---------|-------------|
| `weather_rain_indoor` | Rain sounds/effects from inside |
| `weather_rain_outdoor` | Rain sounds/effects when exposed |
| `weather_storm_indoor` | Storm sounds/effects from inside |
| `weather_storm_outdoor` | Storm sounds/effects when exposed |
| `weather_snow_indoor` | Snow effects seen from inside |
| `weather_snow_outdoor` | Snow effects when exposed |
| `weather_fog_indoor` | Fog/mist effects from inside |
| `weather_fog_outdoor` | Fog/mist effects when exposed |
| `weather_wind_indoor` | Wind effects heard from inside |
| `weather_wind_outdoor` | Wind effects when exposed |

### AmbientPoolTypes Enum Values (15 total)

| Category | Pools |
|----------|-------|
| **Sound** | `sound`, `sound_cave`, `sound_dungeon`, `sound_forest` |
| **Visual** | `visual`, `visual_volcanic`, `visual_ruins` |
| **Creature** | `creature`, `creature_cave`, `creature_swamp`, `creature_forest` |
| **Environmental** | `environmental`, `environmental_frozen`, `environmental_volcanic`, `environmental_swamp` |

### Environment-Specific Descriptor Properties

| Property | Type | Description |
|----------|------|-------------|
| `timeOfDay` | `string[]` | Temporal filter: dawn, day, dusk, night |
| `season` | `string[]` | Seasonal filter: spring, summer, autumn, winter |

---

## Modified

### Configuration Files Updated

| File | Change |
|------|--------|
| `config/descriptors/environmental.json` | Updated `$schema` reference to `environment-descriptors.schema.json` |
| `config/descriptors/weather.json` | Updated `$schema` reference to `environment-descriptors.schema.json` |
| `config/descriptors/ambient-events.json` | Updated `$schema` reference to `environment-descriptors.schema.json` |

---

## Unit Tests

### Test File

`tests/RuneAndRust.Infrastructure.IntegrationTests/Schemas/EnvironmentDescriptorSchemaTests.cs`

### Test Summary

| Test ID | Test Name | Description |
|---------|-----------|-------------|
| ESC-001 | `EnvironmentDescriptorSchema_LoadsSuccessfully_ReturnsValidSchema` | Verifies schema loads with expected definitions |
| ESC-002 | `EnvironmentDescriptorSchema_InvalidCategory_FailsValidation` | Verifies non-environment categories rejected |
| ESC-002 | `EnvironmentDescriptorSchema_ValidCategory_PassesValidation` | Parameterized test for all 4 valid categories |
| ESC-003 | `EnvironmentalJson_ValidatesAgainstSchema_Succeeds` | Validates environmental.json (4 pools) |
| ESC-004 | `WeatherJson_ValidatesAgainstSchema_Succeeds` | Validates weather.json (10 pools) |
| ESC-005 | `AmbientEventsJson_ValidatesAgainstSchema_Succeeds` | Validates ambient-events.json (15 pools) |
| ESC-006 | `EnvironmentDescriptor_TagsAndThemes_ValidatesAsStringArrays` | Verifies tag/theme arrays validate |
| — | `EnvironmentDescriptor_TemporalFiltering_PassesValidation` | Verifies timeOfDay/season work correctly |
| — | `EnvironmentDescriptor_InvalidTimeOfDay_FailsValidation` | Verifies invalid timeOfDay rejected |
| — | `EnvironmentDescriptor_InvalidSeason_FailsValidation` | Verifies invalid season rejected |
| — | `WeatherDescriptor_IndoorOutdoorPools_PassesValidation` | Verifies weather pool pattern |
| — | `AmbientDescriptor_BiomeSpecificPools_PassesValidation` | Verifies ambient pool pattern |
| — | `EnvironmentDescriptor_UnknownProperty_FailsValidation` | Verifies unknown props rejected |

**Total Tests:** 16 (all passing)

---

## Files Created

| File | Lines | Description |
|------|-------|-------------|
| `config/schemas/environment-descriptors.schema.json` | ~260 | Environment descriptor JSON Schema |
| `tests/.../Schemas/EnvironmentDescriptorSchemaTests.cs` | ~470 | Unit tests for environment schema |
| `docs/changelogs/v0.14.7c-changelog.md` | — | This changelog |

---

## Files Modified

| File | Change |
|------|--------|
| `config/descriptors/environmental.json` | Schema reference updated |
| `config/descriptors/weather.json` | Schema reference updated |
| `config/descriptors/ambient-events.json` | Schema reference updated |
| `docs/design/v0.14.x/v0.14.7-scope-breakdown.md` | Acceptance criteria marked complete |
| `docs/design/v0.14.x/v0.14.x-overview.md` | Checklist items marked complete |

---

## Schema Structure

```
environment-descriptors.schema.json
├── $schema: "http://json-schema.org/draft-07/schema#"
├── $id: "environment-descriptors.schema.json"
├── title: "Environment Descriptor Configuration Schema"
├── type: object
├── properties:
│   ├── $schema (string)
│   ├── version (string, optional)
│   ├── category → $ref: EnvironmentCategory
│   └── pools → additionalProperties → $ref: EnvironmentDescriptorPool
├── required: [category, pools]
├── additionalProperties: false
└── definitions:
    ├── EnvironmentCategory (enum: 4 values)
    ├── SensoryCategory (enum: 4 values)
    ├── WeatherPoolTypes (enum: 10 values)
    ├── AmbientPoolTypes (enum: 15 values)
    ├── TimeOfDayValue (enum: 4 values)
    ├── SeasonValue (enum: 4 values)
    ├── LocationTag (documentation)
    ├── ThemeTag (documentation)
    ├── EnvironmentDescriptorPool
    │   ├── id (string, pattern)
    │   ├── name (string)
    │   ├── description (string, optional)
    │   └── descriptors → items → $ref: EnvironmentDescriptor
    ├── EnvironmentDescriptor
    │   ├── id (string, pattern)
    │   ├── text (string)
    │   ├── weight (integer, min: 1, default: 100)
    │   ├── tags (string[], uniqueItems)
    │   ├── themes (string[], uniqueItems)
    │   ├── variables (string[], uniqueItems)
    │   ├── minDamagePercent (number, 0-1)
    │   ├── maxDamagePercent (number, 0-1)
    │   ├── minHealthPercent (number, 0-1)
    │   ├── maxHealthPercent (number, 0-1)
    │   ├── fallbackId (string, pattern)
    │   ├── timeOfDay (TimeOfDayValue[], uniqueItems) ← ENVIRONMENT-SPECIFIC
    │   └── season (SeasonValue[], uniqueItems) ← ENVIRONMENT-SPECIFIC
    └── VariablePattern (documentation)
```

---

## Key Design Decisions

### 1. Standalone Schema (No allOf Inheritance)

**Decision:** The environment schema is a complete standalone schema rather than using `allOf` to inherit from the master `descriptors.schema.json`.

**Rationale:** Using `allOf` with the base schema caused `additionalProperties: false` conflicts where the base schema's Descriptor definition would reject the environment-specific properties (`timeOfDay`, `season`). By defining a complete `EnvironmentDescriptor` that includes all base properties plus environment-specific extensions, we achieve the same validation goals without inheritance conflicts.

### 2. Temporal Filtering Properties

**Decision:** Added `timeOfDay` and `season` arrays as environment-specific extensions.

**Rationale:** Environment descriptors often need to vary based on time (dawn mist, night stars) and season (winter snow, summer heat). These filters enable rich, contextual atmosphere generation.

### 3. Pool Type Enums as Documentation

**Decision:** `SensoryCategory`, `WeatherPoolTypes`, and `AmbientPoolTypes` are defined as enum definitions within the schema but are not enforced on pool keys.

**Rationale:** Enforcing pool key validation would break flexibility for future sensory/weather/biome types. The enums serve as documentation of expected pool IDs while allowing configuration files to define additional pools if needed.

---

## Validation Rules Summary

| Rule | Validation |
|------|------------|
| Category | Must be one of: `environmental`, `weather`, `ambient`, `objects` |
| Pool ID pattern | `^[a-z][a-z0-9_]*$` (snake_case) |
| Descriptor ID pattern | `^[a-z][a-z0-9_]*$` (snake_case) |
| Weight | Integer, minimum 1 |
| Damage/health percentages | Number, 0-1 range |
| Arrays (tags, themes, etc.) | uniqueItems: true, minLength: 1 per item |
| timeOfDay | Array of: dawn, day, dusk, night |
| season | Array of: spring, summer, autumn, winter |
| additionalProperties | false on pools, descriptors (strict validation) |

---

## Example: Valid Environmental Entry with Temporal Filtering

```json
{
  "$schema": "../schemas/environment-descriptors.schema.json",
  "category": "environmental",
  "pools": {
    "lighting": {
      "id": "lighting",
      "name": "Lighting Descriptions",
      "descriptors": [
        {
          "id": "morning_mist",
          "text": "Morning mist clings to the ground, slowly burning off",
          "weight": 20,
          "tags": ["outdoor", "forest"],
          "timeOfDay": ["dawn"]
        },
        {
          "id": "winter_twilight",
          "text": "Long shadows stretch across the snow as the sun sets",
          "weight": 15,
          "tags": ["outdoor", "frozen"],
          "timeOfDay": ["dusk"],
          "season": ["winter"]
        }
      ]
    }
  }
}
```

---

## Example: Valid Weather Entry with Indoor/Outdoor Variants

```json
{
  "$schema": "../schemas/environment-descriptors.schema.json",
  "category": "weather",
  "pools": {
    "weather_storm_outdoor": {
      "id": "weather_storm_outdoor",
      "name": "Storm (Outdoor)",
      "descriptors": [
        {
          "id": "lightning_strike",
          "text": "Lightning splits the sky, briefly turning night to day",
          "weight": 25
        }
      ]
    }
  }
}
```

---

## Dependencies

### Required from v0.14.7a

| Artifact | Usage |
|----------|-------|
| `descriptors.schema.json` | Reference for base descriptor properties (not inherited via allOf) |
| ID pattern conventions | Same patterns used in environment schema |
| Weight/percentage validation | Same rules applied in environment schema |

### Parallel with v0.14.7b

| Artifact | Relationship |
|----------|--------------|
| Schema extension pattern | Same standalone pattern, different domain |
| Category enum approach | Same approach, different values |

---

## Acceptance Criteria Status

| Criteria | Status |
|----------|--------|
| `environment-descriptors.schema.json` created in `config/schemas/` | ✅ Complete |
| Schema validates existing `environmental.json` (4 pools) | ✅ Complete |
| Schema validates existing `weather.json` (10 pools) | ✅ Complete |
| Schema validates existing `ambient-events.json` (15 pools) | ✅ Complete |
| Category enum validates: environmental, weather, ambient, objects | ✅ Complete |
| SensoryCategory enum defines 4 pool IDs | ✅ Complete |
| WeatherPoolTypes enum defines 10 pool IDs | ✅ Complete |
| AmbientPoolTypes enum defines 15 pool IDs | ✅ Complete |
| Location tags validated as string arrays | ✅ Complete |
| Theme tags validated as string arrays | ✅ Complete |
| Build completes with 0 errors | ✅ Complete |
| ~6 unit tests pass (16 tests implemented) | ✅ Complete |
| Schema follows JSON Schema Draft-07 | ✅ Complete |

---

*Document Version: 1.0*
*Last Updated: 2026-01-21*
*Author: Claude (AI Assistant)*
