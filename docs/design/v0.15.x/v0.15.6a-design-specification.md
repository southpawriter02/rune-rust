# v0.15.6a Design Specification: Passive Perception System

**Version:** 0.15.6a
**Phase Name:** Passive Perception System
**Parent Version:** v0.15.6 (Advanced Perception System)
**Prerequisites:** v0.15.1 Complete (Skill Infrastructure), v0.15.0 Complete (Dice Pool Refactor)
**Estimated Tests:** ~4 unit tests

---

## Table of Contents

1. [Executive Summary](#1-executive-summary)
2. [Feature Overview](#2-feature-overview)
3. [Architecture Diagrams](#3-architecture-diagrams)
4. [PassivePerception Value Object](#4-passiveperception-value-object)
5. [PerceptionModifier Value Object](#5-perceptionmodifier-value-object)
6. [HiddenElement Entity](#6-hiddenelement-entity)
7. [HiddenElementType Enum](#7-hiddenelementtype-enum)
8. [PassivePerceptionResult Value Object](#8-passiveperceptionresult-value-object)
9. [IPassivePerceptionService Interface](#9-ipassiveperceptionservice-interface)
10. [Data Model Changes](#10-data-model-changes)
11. [Configuration File Schemas](#11-configuration-file-schemas)
12. [Logging Specifications](#12-logging-specifications)
13. [Unit Testing Requirements](#13-unit-testing-requirements)
14. [Use Cases](#14-use-cases)
15. [Deliverable Checklist](#15-deliverable-checklist)
16. [Acceptance Criteria](#16-acceptance-criteria)
17. [Dependencies](#17-dependencies)
18. [Future Considerations](#18-future-considerations)

---

## 1. Executive Summary

### 1.1 Purpose

This specification defines the Passive Perception System, which enables automatic detection of hidden elements when characters enter rooms. Unlike active perception checks that require player input, passive perception operates automatically based on a character's WITS attribute, revealing traps, secret doors, hidden caches, and other concealed elements without explicit player action.

The system introduces a fundamental gameplay mechanic where high-WITS characters gain situational awareness advantages, discovering dangers and opportunities that less perceptive characters miss entirely. This establishes the foundation for the three-layer examination system (v0.15.6b) and creates meaningful differentiation between character builds.

### 1.2 Key Deliverables

| Category | Items |
|----------|-------|
| **Value Objects** | `PassivePerception`, `PerceptionModifier`, `PassivePerceptionResult` |
| **Entities** | `HiddenElement` |
| **Enums** | `HiddenElementType` |
| **Services** | `IPassivePerceptionService`, `PassivePerceptionService` |
| **Configuration** | `hidden-elements.json`, `perception-modifiers.json` |
| **Tests** | ~4 unit tests |

### 1.3 Architectural Significance

This version establishes the **Passive Perception Pattern** that will be used throughout the game:

- **Automatic Triggering**: Perception checks occur on room entry without player input
- **DC-Based Revelation**: Hidden elements reveal when passive perception >= element DC
- **Modifier Stacking**: Status effects, equipment, and environmental factors modify perception
- **Progressive Discovery**: Characters discover more elements as their WITS improves
- **Room Integration**: Hidden elements are tied to specific rooms and persist across sessions

---

## 2. Feature Overview

```
v0.15.6a Passive Perception System
├── PassivePerception Value Object
│   ├── CharacterId tracking
│   ├── WitsAttribute base value
│   ├── PassiveValue calculation (WITS ÷ 2, round up)
│   ├── ModifierBreakdown list
│   └── EffectiveValue with modifiers
├── PerceptionModifier Value Object
│   ├── ModifierId identifier
│   ├── Source type (equipment, status, specialization)
│   ├── Value (positive or negative)
│   └── Description for display
├── HiddenElement Entity
│   ├── ElementId unique identifier
│   ├── RoomId association
│   ├── ElementType categorization
│   ├── DiscoveryDc threshold
│   ├── IsRevealed state tracking
│   ├── RevealedBy character tracking
│   ├── RevealedAt timestamp
│   ├── DiscoveryText flavor
│   └── InteractionData payload
├── HiddenElementType Enum
│   ├── Trap (pressure plates, tripwires)
│   ├── SecretDoor (concealed passages)
│   ├── HiddenCache (loot containers)
│   ├── SecretCompartment (hidden storage)
│   ├── AmbushSite (enemy hiding spots)
│   └── ClueElement (investigation clues)
├── PassivePerceptionResult Value Object
│   ├── RoomId checked
│   ├── PassiveValue used
│   ├── ElementsChecked count
│   ├── ElementsRevealed list
│   └── ElementsMissed count (no details)
└── IPassivePerceptionService Interface
    ├── CalculatePassivePerception()
    ├── CheckRoomEntry()
    └── RevealElement()
```

### 2.1 Scope Alignment

**In Scope:**
- `PassivePerception` value object with WITS-based calculation
- `PerceptionModifier` value object for modifier tracking
- `HiddenElement` entity for room hidden elements
- `HiddenElementType` enum with six element types
- `PassivePerceptionResult` value object for check results
- `IPassivePerceptionService` interface definition
- `PassivePerceptionService` implementation
- Passive perception calculation formula (WITS ÷ 2, round up)
- Status effect modifiers ([Alert], [Fatigued], [Exhausted])
- Room entry automatic perception check
- Hidden element revelation based on DC comparison
- Configuration schemas for hidden elements and modifiers

**Out of Scope:**
- Three-layer examination system (v0.15.6b)
- Object category descriptors (v0.15.6c)
- Flora & fauna observation (v0.15.6d)
- Puzzle hint integration (v0.15.6e)
- Search command enhancement (v0.15.6f)
- Investigation command (v0.15.6g)
- Specialization perception bonuses (v0.15.6h)
- Room entry integration with descriptions (v0.15.6i)

---

## 3. Architecture Diagrams

### 3.1 Passive Perception System Flow

```
┌─────────────────────────────────────────────────────────────────────┐
│                    PASSIVE PERCEPTION SYSTEM FLOW                    │
└─────────────────────────────────────────────────────────────────────┘

    Character Enters Room
           │
           ▼
┌─────────────────────────────────────────────────────────────────────┐
│                     CALCULATE PASSIVE PERCEPTION                     │
├─────────────────────────────────────────────────────────────────────┤
│  1. Get Character WITS attribute                                    │
│  2. Calculate base: WITS ÷ 2 (round up)                             │
│  3. Gather active modifiers:                                        │
│     - Status effects ([Alert], [Fatigued], [Exhausted])             │
│     - Environmental (lighting, zone effects)                        │
│     - Equipment bonuses (future: perception items)                  │
│  4. Sum modifiers to get EffectiveValue                             │
└─────────────────────────────────────────────────────────────────────┘
           │
           ▼
┌─────────────────────────────────────────────────────────────────────┐
│                      GET ROOM HIDDEN ELEMENTS                        │
├─────────────────────────────────────────────────────────────────────┤
│  1. Query all HiddenElements for RoomId                             │
│  2. Filter to unrevealed elements (IsRevealed = false)              │
│  3. Return list for DC comparison                                   │
└─────────────────────────────────────────────────────────────────────┘
           │
           ▼
┌─────────────────────────────────────────────────────────────────────┐
│                    COMPARE PASSIVE VS ELEMENT DCs                    │
├─────────────────────────────────────────────────────────────────────┤
│  For each unrevealed element:                                       │
│    IF PassiveValue >= Element.DiscoveryDc THEN                      │
│      - Mark element as revealed                                     │
│      - Set RevealedBy to character ID                               │
│      - Set RevealedAt to current time                               │
│      - Add to ElementsRevealed list                                 │
│    ELSE                                                             │
│      - Increment ElementsMissed count                               │
│      - Element remains hidden (no details exposed)                  │
└─────────────────────────────────────────────────────────────────────┘
           │
           ▼
┌─────────────────────────────────────────────────────────────────────┐
│                      RETURN PERCEPTION RESULT                        │
├─────────────────────────────────────────────────────────────────────┤
│  PassivePerceptionResult:                                           │
│    - RoomId                                                         │
│    - PassiveValue used                                              │
│    - ElementsChecked (total)                                        │
│    - ElementsRevealed (list with details)                           │
│    - ElementsMissed (count only, no details)                        │
└─────────────────────────────────────────────────────────────────────┘
```

### 3.2 Layer Diagram

```
┌─────────────────────────────────────────────────────────────────────┐
│                        PRESENTATION LAYER                            │
├─────────────────────────────────────────────────────────────────────┤
│  IGameRenderer                                                       │
│  └── RenderPassivePerceptionResultAsync() - displays discoveries    │
│                                                                      │
│  Room Description Composer (v0.15.6i)                                │
│  └── Integrates revealed elements into room text                    │
└───────┬─────────────────────────────────────────────────────────────┘
        │
        ▼
┌─────────────────────────────────────────────────────────────────────┐
│                       APPLICATION LAYER                              │
├─────────────────────────────────────────────────────────────────────┤
│  ┌───────────────────────────────────────────────────────────────┐  │
│  │               PassivePerceptionService                         │  │
│  ├───────────────────────────────────────────────────────────────┤  │
│  │  + CalculatePassivePerception(characterId): PassivePerception │  │
│  │  + CheckRoomEntry(characterId, roomId): PassivePerceptionResult│ │
│  │  + RevealElement(elementId, characterId): void                │  │
│  │                                                               │  │
│  │  - GetActiveModifiers(characterId): List<PerceptionModifier>  │  │
│  │  - GetUnrevealedElements(roomId): List<HiddenElement>         │  │
│  │  - CompareAndReveal(passive, elements): List<HiddenElement>   │  │
│  └───────────────────────────────────────────────────────────────┘  │
│                                                                      │
│  GameSessionService                                                  │
│  └── Calls CheckRoomEntry() on room transitions                     │
└───────┬─────────────────────────────────────────────────────────────┘
        │
        ▼
┌─────────────────────────────────────────────────────────────────────┐
│                         DOMAIN LAYER                                 │
├─────────────────────────────────────────────────────────────────────┤
│  ┌─────────────────────┐  ┌────────────────────────────────────┐   │
│  │  HiddenElementType  │  │         PerceptionModifier         │   │
│  │       (Enum)        │  │         (Value Object)             │   │
│  ├─────────────────────┤  ├────────────────────────────────────┤   │
│  │ Trap                │  │ ModifierId: string                 │   │
│  │ SecretDoor          │  │ Source: string                     │   │
│  │ HiddenCache         │  │ Value: int                         │   │
│  │ SecretCompartment   │  │ Description: string                │   │
│  │ AmbushSite          │  └────────────────────────────────────┘   │
│  │ ClueElement         │                                           │
│  └─────────────────────┘  ┌────────────────────────────────────┐   │
│                           │        PassivePerception           │   │
│  ┌─────────────────────┐  │         (Value Object)             │   │
│  │   HiddenElement     │  ├────────────────────────────────────┤   │
│  │     (Entity)        │  │ CharacterId: string                │   │
│  ├─────────────────────┤  │ WitsAttribute: int                 │   │
│  │ ElementId: string   │  │ PassiveValue: int (WITS ÷ 2)       │   │
│  │ RoomId: string      │  │ ModifierBreakdown: List<Modifier>  │   │
│  │ ElementType: enum   │  │ EffectiveValue: int                │   │
│  │ DiscoveryDc: int    │  └────────────────────────────────────┘   │
│  │ IsRevealed: bool    │                                           │
│  │ RevealedBy: string? │  ┌────────────────────────────────────┐   │
│  │ RevealedAt: DateTime│  │     PassivePerceptionResult        │   │
│  │ DiscoveryText: str  │  │         (Value Object)             │   │
│  │ InteractionData: obj│  ├────────────────────────────────────┤   │
│  └─────────────────────┘  │ RoomId: string                     │   │
│                           │ PassiveValue: int                  │   │
│                           │ ElementsChecked: int               │   │
│                           │ ElementsRevealed: List<Hidden...>  │   │
│                           │ ElementsMissed: int                │   │
│                           └────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────────┘
```

### 3.3 Passive Perception Calculation Flow

```
┌─────────────────────────────────────────────────────────────────────┐
│                 PASSIVE PERCEPTION CALCULATION                       │
└─────────────────────────────────────────────────────────────────────┘

    Character
       │
       │  GetEffectiveAttributes()
       ▼
┌───────────────┐
│ WITS Attribute│──────────────────────────────────────────────┐
│   (e.g., 7)   │                                              │
└───────────────┘                                              │
       │                                                       │
       │  Formula: WITS ÷ 2 (round up)                         │
       ▼                                                       │
┌───────────────┐                                              │
│ Base Passive  │                                              │
│   Value: 4    │  (7 ÷ 2 = 3.5 → round up → 4)                │
└───────────────┘                                              │
       │                                                       │
       │  Gather Active Modifiers                              │
       ▼                                                       │
┌─────────────────────────────────────────────────┐            │
│              MODIFIER SOURCES                    │            │
├─────────────────────────────────────────────────┤            │
│  Status Effects:                                │            │
│    [Alert]     → +2                             │            │
│    [Fatigued]  → -1                             │            │
│    [Exhausted] → -2                             │            │
│                                                 │            │
│  Environmental:                                 │            │
│    Familiar territory → +1                      │            │
│    Dim lighting → -1                            │            │
│    Total darkness → -3                          │            │
│    [Psychic Resonance] zone → -2                │            │
│                                                 │            │
│  Equipment (future v0.15.6h):                   │            │
│    Perception items → variable                  │            │
│                                                 │            │
│  Specialization (v0.15.6h):                     │            │
│    Ruin-Stalker [Trap Sense] → +2 vs traps     │            │
│    Veiðimaðr [Keen Senses] → +1 always         │            │
└─────────────────────────────────────────────────┘            │
       │                                                       │
       │  Sum all applicable modifiers                         │
       ▼                                                       │
┌───────────────┐                                              │
│ Total Modifier│                                              │
│   (e.g., +1)  │  ([Alert] +2, Dim light -1 = +1)             │
└───────────────┘                                              │
       │                                                       │
       │  Add to base value                                    │
       ▼                                                       │
┌───────────────┐                                              │
│  Effective    │                                              │
│ Passive: 5    │  (Base 4 + Modifier 1 = 5)                   │
└───────────────┘                                              │
       │                                                       │
       │  Compare vs Hidden Element DCs                        │
       ▼                                                       │
┌─────────────────────────────────────────────────┐            │
│              DC COMPARISON                       │            │
├─────────────────────────────────────────────────┤            │
│  Pressure Plate (DC 4)  → 5 >= 4 ✓ REVEALED    │            │
│  Secret Door (DC 6)     → 5 >= 6 ✗ HIDDEN      │            │
│  Hidden Cache (DC 3)    → 5 >= 3 ✓ REVEALED    │            │
└─────────────────────────────────────────────────┘            │
```

### 3.4 Room Entry Integration Sequence

```
┌─────────────────────────────────────────────────────────────────────┐
│                    ROOM ENTRY INTEGRATION SEQUENCE                   │
└─────────────────────────────────────────────────────────────────────┘

    Player              GameSession           PassivePerception          Room
       │                  Service                  Service               │
       │                    │                        │                   │
       │  move north        │                        │                   │
       ├───────────────────▶│                        │                   │
       │                    │                        │                   │
       │                    │  ValidateMovement()    │                   │
       │                    ├───────────────────────────────────────────▶│
       │                    │                        │                   │
       │                    │  ◀─── Movement valid   │                   │
       │                    │                        │                   │
       │                    │  CheckRoomEntry(       │                   │
       │                    │    characterId,        │                   │
       │                    │    newRoomId)          │                   │
       │                    ├───────────────────────▶│                   │
       │                    │                        │                   │
       │                    │                        │  GetHiddenElements()
       │                    │                        ├──────────────────▶│
       │                    │                        │                   │
       │                    │                        │  ◀── elements     │
       │                    │                        │                   │
       │                    │                        │  CalculatePassive()
       │                    │                        │  (internal)       │
       │                    │                        │                   │
       │                    │                        │  CompareAndReveal()
       │                    │                        │  (internal)       │
       │                    │                        │                   │
       │                    │  ◀── PassivePerceptionResult               │
       │                    │       - revealed: [trap, cache]            │
       │                    │       - missed: 1                          │
       │                    │                        │                   │
       │                    │  ComposeRoomDescription()                  │
       │                    │  (includes revealed elements)              │
       │                    │                        │                   │
       │  ◀─────────────────│                        │                   │
       │  Room description  │                        │                   │
       │  + discovery text  │                        │                   │
       ▼                    ▼                        ▼                   ▼
```

---

## 4. PassivePerception Value Object

### 4.1 Purpose

The `PassivePerception` value object encapsulates a character's passive perception calculation, including the base WITS-derived value and all active modifiers. This provides a complete breakdown of how the final effective value was determined.

### 4.2 Implementation

**File:** `src/Core/RuneAndRust.Domain/ValueObjects/PassivePerception.cs`

```csharp
namespace RuneAndRust.Domain.ValueObjects;

/// <summary>
/// Represents a character's calculated passive perception value.
/// </summary>
/// <remarks>
/// <para>
/// Passive perception is calculated as WITS ÷ 2 (round up), then modified
/// by status effects, environmental factors, and equipment bonuses.
/// </para>
/// <para>
/// This value is used for automatic detection of hidden elements on room entry.
/// Higher passive perception reveals more hidden elements without active checks.
/// </para>
/// </remarks>
/// <param name="CharacterId">The ID of the character this perception belongs to.</param>
/// <param name="WitsAttribute">The character's WITS attribute value (1-30).</param>
/// <param name="PassiveValue">The base passive value (WITS ÷ 2, rounded up).</param>
/// <param name="ModifierBreakdown">List of all active modifiers affecting perception.</param>
public readonly record struct PassivePerception(
    string CharacterId,
    int WitsAttribute,
    int PassiveValue,
    IReadOnlyList<PerceptionModifier> ModifierBreakdown)
{
    /// <summary>
    /// Gets the effective passive perception after all modifiers.
    /// </summary>
    /// <remarks>
    /// This is the value compared against hidden element DCs.
    /// Minimum effective value is 0 (negative results clamp to 0).
    /// </remarks>
    public int EffectiveValue
    {
        get
        {
            var totalModifier = ModifierBreakdown.Sum(m => m.Value);
            return Math.Max(0, PassiveValue + totalModifier);
        }
    }

    /// <summary>
    /// Gets the total modifier value from all sources.
    /// </summary>
    public int TotalModifier => ModifierBreakdown.Sum(m => m.Value);

    /// <summary>
    /// Gets whether any modifiers are currently active.
    /// </summary>
    public bool HasModifiers => ModifierBreakdown.Count > 0;

    /// <summary>
    /// Gets whether the effective value differs from the base passive value.
    /// </summary>
    public bool IsModified => TotalModifier != 0;

    /// <summary>
    /// Calculates passive perception for a character with the given WITS value.
    /// </summary>
    /// <param name="characterId">The character's unique identifier.</param>
    /// <param name="witsAttribute">The character's WITS attribute (1-30).</param>
    /// <param name="modifiers">Active modifiers to apply.</param>
    /// <returns>A new PassivePerception with calculated values.</returns>
    /// <exception cref="ArgumentException">Thrown when characterId is null or empty.</exception>
    /// <exception cref="ArgumentOutOfRangeException">Thrown when witsAttribute is out of range.</exception>
    public static PassivePerception Calculate(
        string characterId,
        int witsAttribute,
        IReadOnlyList<PerceptionModifier>? modifiers = null)
    {
        ArgumentException.ThrowIfNullOrWhiteSpace(characterId);
        ArgumentOutOfRangeException.ThrowIfLessThan(witsAttribute, 1);
        ArgumentOutOfRangeException.ThrowIfGreaterThan(witsAttribute, 30);

        // Formula: WITS ÷ 2, round up
        var passiveValue = (int)Math.Ceiling(witsAttribute / 2.0);

        return new PassivePerception(
            characterId,
            witsAttribute,
            passiveValue,
            modifiers ?? Array.Empty<PerceptionModifier>());
    }

    /// <summary>
    /// Creates a display string showing the calculation breakdown.
    /// </summary>
    /// <returns>A formatted string showing base value and modifiers.</returns>
    public string ToDisplayString()
    {
        if (!HasModifiers)
        {
            return $"Passive Perception: {PassiveValue} (WITS {WitsAttribute} ÷ 2)";
        }

        var modifierText = string.Join(", ",
            ModifierBreakdown.Select(m =>
                $"{(m.Value >= 0 ? "+" : "")}{m.Value} ({m.Description})"));

        return $"Passive Perception: {EffectiveValue} (base {PassiveValue} {modifierText})";
    }
}
```

### 4.3 Passive Perception Formula Reference

| WITS | Passive Value | Calculation |
|------|---------------|-------------|
| 1 | 1 | 1 ÷ 2 = 0.5 → round up → 1 |
| 2 | 1 | 2 ÷ 2 = 1 → 1 |
| 3 | 2 | 3 ÷ 2 = 1.5 → round up → 2 |
| 4 | 2 | 4 ÷ 2 = 2 → 2 |
| 5 | 3 | 5 ÷ 2 = 2.5 → round up → 3 |
| 6 | 3 | 6 ÷ 2 = 3 → 3 |
| 7 | 4 | 7 ÷ 2 = 3.5 → round up → 4 |
| 8 | 4 | 8 ÷ 2 = 4 → 4 |
| 9 | 5 | 9 ÷ 2 = 4.5 → round up → 5 |
| 10 | 5 | 10 ÷ 2 = 5 → 5 |
| 12 | 6 | 12 ÷ 2 = 6 → 6 |
| 14 | 7 | 14 ÷ 2 = 7 → 7 |
| 16 | 8 | 16 ÷ 2 = 8 → 8 |
| 18 | 9 | 18 ÷ 2 = 9 → 9 |
| 20 | 10 | 20 ÷ 2 = 10 → 10 |

---

## 5. PerceptionModifier Value Object

### 5.1 Purpose

The `PerceptionModifier` value object represents a single modifier to passive perception from any source. This allows tracking and displaying exactly what factors affect a character's perception.

### 5.2 Implementation

**File:** `src/Core/RuneAndRust.Domain/ValueObjects/PerceptionModifier.cs`

```csharp
namespace RuneAndRust.Domain.ValueObjects;

/// <summary>
/// Represents a modifier to passive perception from a specific source.
/// </summary>
/// <remarks>
/// <para>
/// Modifiers can come from various sources:
/// - Status effects ([Alert], [Fatigued], [Exhausted])
/// - Environmental factors (lighting, zone effects)
/// - Equipment bonuses (perception-enhancing items)
/// - Specialization abilities (Ruin-Stalker, Veiðimaðr)
/// </para>
/// <para>
/// Positive values increase perception, negative values decrease it.
/// </para>
/// </remarks>
/// <param name="ModifierId">Unique identifier for this modifier instance.</param>
/// <param name="Source">The source granting this modifier (e.g., "status:alert", "equipment:spy-glass").</param>
/// <param name="Value">The modifier value (positive for bonuses, negative for penalties).</param>
/// <param name="Description">Human-readable description for display.</param>
public readonly record struct PerceptionModifier(
    string ModifierId,
    string Source,
    int Value,
    string Description)
{
    /// <summary>
    /// Gets whether this modifier is a bonus (positive value).
    /// </summary>
    public bool IsBonus => Value > 0;

    /// <summary>
    /// Gets whether this modifier is a penalty (negative value).
    /// </summary>
    public bool IsPenalty => Value < 0;

    /// <summary>
    /// Gets whether this modifier has no effect (zero value).
    /// </summary>
    public bool IsNeutral => Value == 0;

    /// <summary>
    /// Creates an [Alert] status effect modifier.
    /// </summary>
    public static PerceptionModifier Alert() =>
        new("status-alert", "status:alert", 2, "[Alert] heightened awareness");

    /// <summary>
    /// Creates a [Fatigued] status effect modifier.
    /// </summary>
    public static PerceptionModifier Fatigued() =>
        new("status-fatigued", "status:fatigued", -1, "[Fatigued] dulled senses");

    /// <summary>
    /// Creates an [Exhausted] status effect modifier.
    /// </summary>
    public static PerceptionModifier Exhausted() =>
        new("status-exhausted", "status:exhausted", -2, "[Exhausted] severely impaired");

    /// <summary>
    /// Creates a familiar territory modifier.
    /// </summary>
    public static PerceptionModifier FamiliarTerritory() =>
        new("env-familiar", "environment:familiar", 1, "Familiar territory");

    /// <summary>
    /// Creates a dim lighting modifier.
    /// </summary>
    public static PerceptionModifier DimLighting() =>
        new("env-dim-light", "environment:dim", -1, "Dim lighting");

    /// <summary>
    /// Creates a total darkness modifier.
    /// </summary>
    public static PerceptionModifier TotalDarkness() =>
        new("env-darkness", "environment:dark", -3, "Total darkness");

    /// <summary>
    /// Creates a [Psychic Resonance] zone modifier.
    /// </summary>
    public static PerceptionModifier PsychicResonanceZone() =>
        new("zone-psychic", "zone:psychic-resonance", -2, "[Psychic Resonance] interference");

    /// <summary>
    /// Creates a custom modifier from configuration.
    /// </summary>
    /// <param name="id">The modifier ID.</param>
    /// <param name="source">The source type.</param>
    /// <param name="value">The modifier value.</param>
    /// <param name="description">The display description.</param>
    /// <returns>A new PerceptionModifier instance.</returns>
    public static PerceptionModifier Custom(string id, string source, int value, string description) =>
        new(id, source, value, description);
}
```

### 5.3 Modifier Sources Reference

| Source | Modifier | Description |
|--------|----------|-------------|
| [Alert] status | +2 | Heightened awareness from status effect |
| [Fatigued] status | -1 | Dulled senses from fatigue |
| [Exhausted] status | -2 | Severely impaired from exhaustion |
| Familiar territory | +1 | Character has visited this area before |
| Dim lighting | -1 | Reduced visibility in low light |
| Total darkness | -3 | Cannot see in complete darkness |
| [Psychic Resonance] zone | -2 | Mental interference from corrupted area |

---

## 6. HiddenElement Entity

### 6.1 Purpose

The `HiddenElement` entity represents something concealed within a room that can be discovered through passive or active perception. Each hidden element has a discovery DC that determines the minimum passive perception needed to automatically detect it.

### 6.2 Implementation

**File:** `src/Core/RuneAndRust.Domain/Entities/HiddenElement.cs`

```csharp
namespace RuneAndRust.Domain.Entities;

using RuneAndRust.Domain.Enums;
using RuneAndRust.Domain.Interfaces;

/// <summary>
/// Represents a hidden element within a room that can be discovered through perception.
/// </summary>
/// <remarks>
/// <para>
/// Hidden elements are automatically checked against passive perception when a character
/// enters a room. If passive perception >= DiscoveryDc, the element is revealed.
/// </para>
/// <para>
/// Once revealed, hidden elements remain discovered for that character. Different
/// characters may discover different elements based on their perception values.
/// </para>
/// <para>
/// The InteractionData property contains element-specific data such as trap trigger
/// information, door destination IDs, or cache contents.
/// </para>
/// </remarks>
public class HiddenElement : IEntity
{
    /// <summary>
    /// Gets the unique identifier for this hidden element.
    /// </summary>
    public Guid Id { get; private set; }

    /// <summary>
    /// Gets the definition ID for this hidden element (from configuration).
    /// </summary>
    public string ElementId { get; private set; } = string.Empty;

    /// <summary>
    /// Gets the ID of the room containing this hidden element.
    /// </summary>
    public string RoomId { get; private set; } = string.Empty;

    /// <summary>
    /// Gets the type of hidden element.
    /// </summary>
    public HiddenElementType ElementType { get; private set; }

    /// <summary>
    /// Gets the difficulty class required to discover this element.
    /// </summary>
    /// <remarks>
    /// Passive perception must be >= this value for automatic discovery.
    /// Active search checks roll against this DC.
    /// </remarks>
    public int DiscoveryDc { get; private set; }

    /// <summary>
    /// Gets whether this element has been revealed.
    /// </summary>
    public bool IsRevealed { get; private set; }

    /// <summary>
    /// Gets the ID of the character who revealed this element (if revealed).
    /// </summary>
    public string? RevealedBy { get; private set; }

    /// <summary>
    /// Gets the timestamp when this element was revealed (if revealed).
    /// </summary>
    public DateTime? RevealedAt { get; private set; }

    /// <summary>
    /// Gets the flavor text displayed when this element is discovered.
    /// </summary>
    public string DiscoveryText { get; private set; } = string.Empty;

    /// <summary>
    /// Gets the element-specific interaction data.
    /// </summary>
    /// <remarks>
    /// Contains data relevant to the element type:
    /// - Trap: trigger type, damage, disarm DC
    /// - SecretDoor: destination room ID, unlock requirements
    /// - HiddenCache: loot table ID, container type
    /// - AmbushSite: enemy IDs, trigger conditions
    /// - ClueElement: clue ID, related puzzle ID
    /// </remarks>
    public Dictionary<string, object>? InteractionData { get; private set; }

    /// <summary>
    /// Private constructor for EF Core.
    /// </summary>
    private HiddenElement() { }

    /// <summary>
    /// Creates a new hidden element.
    /// </summary>
    /// <param name="elementId">The definition ID.</param>
    /// <param name="roomId">The containing room ID.</param>
    /// <param name="elementType">The type of hidden element.</param>
    /// <param name="discoveryDc">The DC required for discovery.</param>
    /// <param name="discoveryText">The flavor text when discovered.</param>
    /// <param name="interactionData">Optional element-specific data.</param>
    /// <returns>A new HiddenElement instance.</returns>
    /// <exception cref="ArgumentException">Thrown when IDs are null or empty.</exception>
    /// <exception cref="ArgumentOutOfRangeException">Thrown when DC is less than 1.</exception>
    public static HiddenElement Create(
        string elementId,
        string roomId,
        HiddenElementType elementType,
        int discoveryDc,
        string discoveryText,
        Dictionary<string, object>? interactionData = null)
    {
        ArgumentException.ThrowIfNullOrWhiteSpace(elementId);
        ArgumentException.ThrowIfNullOrWhiteSpace(roomId);
        ArgumentOutOfRangeException.ThrowIfLessThan(discoveryDc, 1);

        return new HiddenElement
        {
            Id = Guid.NewGuid(),
            ElementId = elementId,
            RoomId = roomId,
            ElementType = elementType,
            DiscoveryDc = discoveryDc,
            DiscoveryText = discoveryText ?? string.Empty,
            InteractionData = interactionData,
            IsRevealed = false,
            RevealedBy = null,
            RevealedAt = null
        };
    }

    /// <summary>
    /// Reveals this hidden element.
    /// </summary>
    /// <param name="characterId">The ID of the character who discovered it.</param>
    /// <exception cref="InvalidOperationException">Thrown if already revealed.</exception>
    public void Reveal(string characterId)
    {
        if (IsRevealed)
        {
            throw new InvalidOperationException(
                $"Hidden element '{ElementId}' has already been revealed.");
        }

        ArgumentException.ThrowIfNullOrWhiteSpace(characterId);

        IsRevealed = true;
        RevealedBy = characterId;
        RevealedAt = DateTime.UtcNow;
    }

    /// <summary>
    /// Checks whether a given passive perception can discover this element.
    /// </summary>
    /// <param name="passivePerception">The passive perception value to check.</param>
    /// <returns>True if passive perception >= DiscoveryDc and element is not already revealed.</returns>
    public bool CanBeDiscoveredBy(int passivePerception)
    {
        return !IsRevealed && passivePerception >= DiscoveryDc;
    }

    /// <summary>
    /// Gets interaction data of the specified type.
    /// </summary>
    /// <typeparam name="T">The expected type of the data.</typeparam>
    /// <param name="key">The data key.</param>
    /// <returns>The typed data value, or default if not found.</returns>
    public T? GetInteractionData<T>(string key)
    {
        if (InteractionData == null || !InteractionData.TryGetValue(key, out var value))
        {
            return default;
        }

        if (value is T typedValue)
        {
            return typedValue;
        }

        // Handle JSON deserialization producing different numeric types
        try
        {
            return (T)Convert.ChangeType(value, typeof(T));
        }
        catch
        {
            return default;
        }
    }
}
```

---

## 7. HiddenElementType Enum

### 7.1 Purpose

The `HiddenElementType` enum categorizes hidden elements for filtering, display, and behavior differentiation.

### 7.2 Implementation

**File:** `src/Core/RuneAndRust.Domain/Enums/HiddenElementType.cs`

```csharp
namespace RuneAndRust.Domain.Enums;

/// <summary>
/// Categorizes types of hidden elements that can be discovered through perception.
/// </summary>
/// <remarks>
/// <para>
/// Each type has distinct gameplay implications:
/// - Traps deal damage or apply effects when triggered
/// - Secret doors provide alternate routes
/// - Hidden caches contain valuable loot
/// - Secret compartments offer smaller storage finds
/// - Ambush sites warn of enemy presence
/// - Clue elements advance investigation objectives
/// </para>
/// </remarks>
public enum HiddenElementType
{
    /// <summary>
    /// A concealed trap mechanism (pressure plate, tripwire, magical glyph).
    /// </summary>
    /// <remarks>
    /// Discovering a trap allows the character to avoid or disarm it.
    /// Interaction data typically includes: triggerType, damage, disarmDc.
    /// </remarks>
    Trap = 0,

    /// <summary>
    /// A concealed passage or doorway.
    /// </summary>
    /// <remarks>
    /// Discovering a secret door reveals a new exit from the room.
    /// Interaction data typically includes: destinationRoomId, unlockRequirements.
    /// </remarks>
    SecretDoor = 1,

    /// <summary>
    /// A hidden container with valuable contents.
    /// </summary>
    /// <remarks>
    /// Caches contain loot that can be collected.
    /// Interaction data typically includes: lootTableId, containerType.
    /// </remarks>
    HiddenCache = 2,

    /// <summary>
    /// A small hidden storage space within furniture or walls.
    /// </summary>
    /// <remarks>
    /// Smaller than caches, often containing single items or notes.
    /// Interaction data typically includes: contents, openMethod.
    /// </remarks>
    SecretCompartment = 3,

    /// <summary>
    /// A location where enemies are hiding in wait.
    /// </summary>
    /// <remarks>
    /// Discovering an ambush site allows preparation or avoidance.
    /// Interaction data typically includes: enemyIds, triggerConditions.
    /// </remarks>
    AmbushSite = 4,

    /// <summary>
    /// An element relevant to an ongoing investigation.
    /// </summary>
    /// <remarks>
    /// Clues contribute to solving mysteries or puzzles.
    /// Interaction data typically includes: clueId, relatedPuzzleId.
    /// </remarks>
    ClueElement = 5
}
```

### 7.3 Hidden Element Type Reference

| Type | Discovery Effect | Typical DC Range | Example |
|------|------------------|------------------|---------|
| Trap | Can avoid/disarm | 8-18 | Pressure plate under dust |
| SecretDoor | New exit available | 12-20 | Bookshelf with hidden lever |
| HiddenCache | Loot container revealed | 10-16 | Loose stone in wall |
| SecretCompartment | Small storage found | 10-14 | False bottom in drawer |
| AmbushSite | Enemy warning | 14-20 | Shadows with movement |
| ClueElement | Investigation progress | 12-18 | Scratched message |

---

## 8. PassivePerceptionResult Value Object

### 8.1 Purpose

The `PassivePerceptionResult` value object encapsulates the results of a passive perception check on room entry, including all revealed elements and the count of missed elements (without revealing what was missed).

### 8.2 Implementation

**File:** `src/Core/RuneAndRust.Domain/ValueObjects/PassivePerceptionResult.cs`

```csharp
namespace RuneAndRust.Domain.ValueObjects;

using RuneAndRust.Domain.Entities;

/// <summary>
/// Represents the result of a passive perception check on room entry.
/// </summary>
/// <remarks>
/// <para>
/// Contains the revealed elements with full details, but only a count
/// of missed elements to avoid revealing what the character didn't notice.
/// </para>
/// <para>
/// This separation ensures players don't know exactly what they're missing,
/// maintaining the mystery of undiscovered content.
/// </para>
/// </remarks>
/// <param name="RoomId">The ID of the room that was checked.</param>
/// <param name="PassiveValue">The passive perception value used for the check.</param>
/// <param name="ElementsChecked">Total number of hidden elements in the room.</param>
/// <param name="ElementsRevealed">List of elements that were discovered.</param>
/// <param name="ElementsMissed">Count of elements not discovered (no details).</param>
public readonly record struct PassivePerceptionResult(
    string RoomId,
    int PassiveValue,
    int ElementsChecked,
    IReadOnlyList<HiddenElement> ElementsRevealed,
    int ElementsMissed)
{
    /// <summary>
    /// Gets whether any elements were revealed.
    /// </summary>
    public bool HasDiscoveries => ElementsRevealed.Count > 0;

    /// <summary>
    /// Gets whether any elements remain hidden.
    /// </summary>
    public bool HasMissedElements => ElementsMissed > 0;

    /// <summary>
    /// Gets whether all hidden elements were revealed.
    /// </summary>
    public bool AllRevealed => ElementsMissed == 0 && ElementsRevealed.Count > 0;

    /// <summary>
    /// Gets whether the room had no hidden elements.
    /// </summary>
    public bool NoHiddenElements => ElementsChecked == 0;

    /// <summary>
    /// Gets the count of revealed elements.
    /// </summary>
    public int RevealedCount => ElementsRevealed.Count;

    /// <summary>
    /// Creates an empty result for a room with no hidden elements.
    /// </summary>
    /// <param name="roomId">The room ID.</param>
    /// <param name="passiveValue">The passive perception value used.</param>
    /// <returns>A result indicating no hidden elements existed.</returns>
    public static PassivePerceptionResult Empty(string roomId, int passiveValue) =>
        new(roomId, passiveValue, 0, Array.Empty<HiddenElement>(), 0);

    /// <summary>
    /// Creates a result from the check operation.
    /// </summary>
    /// <param name="roomId">The room ID.</param>
    /// <param name="passiveValue">The passive perception value used.</param>
    /// <param name="revealed">Elements that were revealed.</param>
    /// <param name="totalChecked">Total elements checked.</param>
    /// <returns>A new PassivePerceptionResult.</returns>
    public static PassivePerceptionResult Create(
        string roomId,
        int passiveValue,
        IReadOnlyList<HiddenElement> revealed,
        int totalChecked)
    {
        var missed = totalChecked - revealed.Count;
        return new PassivePerceptionResult(
            roomId,
            passiveValue,
            totalChecked,
            revealed,
            missed);
    }
}
```

---

## 9. IPassivePerceptionService Interface

### 9.1 Purpose

The `IPassivePerceptionService` interface defines the contract for passive perception operations, enabling dependency injection and testability.

### 9.2 Interface Definition

**File:** `src/Core/RuneAndRust.Application/Interfaces/IPassivePerceptionService.cs`

```csharp
namespace RuneAndRust.Application.Interfaces;

using RuneAndRust.Domain.ValueObjects;

/// <summary>
/// Service for calculating and applying passive perception checks.
/// </summary>
/// <remarks>
/// <para>
/// Passive perception is calculated from a character's WITS attribute
/// and modified by status effects, environmental factors, and equipment.
/// </para>
/// <para>
/// The service automatically checks hidden elements when characters enter
/// rooms, revealing those with DC at or below the effective passive value.
/// </para>
/// </remarks>
public interface IPassivePerceptionService
{
    /// <summary>
    /// Calculates passive perception for a character.
    /// </summary>
    /// <param name="characterId">The character's unique identifier.</param>
    /// <returns>The calculated passive perception with breakdown.</returns>
    /// <exception cref="ArgumentException">Thrown when characterId is invalid.</exception>
    /// <exception cref="InvalidOperationException">Thrown when character not found.</exception>
    PassivePerception CalculatePassivePerception(string characterId);

    /// <summary>
    /// Checks passive perception against all hidden elements in a room.
    /// </summary>
    /// <param name="characterId">The character entering the room.</param>
    /// <param name="roomId">The room being entered.</param>
    /// <returns>Result containing revealed and missed element counts.</returns>
    /// <remarks>
    /// Called automatically on room entry. Elements with DC at or below
    /// the character's effective passive perception are revealed.
    /// </remarks>
    /// <exception cref="ArgumentException">Thrown when IDs are invalid.</exception>
    PassivePerceptionResult CheckRoomEntry(string characterId, string roomId);

    /// <summary>
    /// Reveals a specific hidden element (for active search or special abilities).
    /// </summary>
    /// <param name="elementId">The hidden element's unique identifier.</param>
    /// <param name="characterId">The character revealing the element.</param>
    /// <exception cref="ArgumentException">Thrown when IDs are invalid.</exception>
    /// <exception cref="InvalidOperationException">Thrown when element not found or already revealed.</exception>
    void RevealElement(string elementId, string characterId);
}
```

### 9.3 Service Implementation

**File:** `src/Core/RuneAndRust.Application/Services/PassivePerceptionService.cs`

```csharp
namespace RuneAndRust.Application.Services;

using Microsoft.Extensions.Logging;
using RuneAndRust.Application.Interfaces;
using RuneAndRust.Domain.Entities;
using RuneAndRust.Domain.Enums;
using RuneAndRust.Domain.ValueObjects;

/// <summary>
/// Implementation of passive perception calculation and room entry checks.
/// </summary>
public class PassivePerceptionService : IPassivePerceptionService
{
    private readonly IPlayerRepository _playerRepository;
    private readonly IHiddenElementRepository _hiddenElementRepository;
    private readonly IStatusEffectService _statusEffectService;
    private readonly IRoomRepository _roomRepository;
    private readonly ILogger<PassivePerceptionService> _logger;

    /// <summary>
    /// Initializes a new instance of PassivePerceptionService.
    /// </summary>
    public PassivePerceptionService(
        IPlayerRepository playerRepository,
        IHiddenElementRepository hiddenElementRepository,
        IStatusEffectService statusEffectService,
        IRoomRepository roomRepository,
        ILogger<PassivePerceptionService> logger)
    {
        _playerRepository = playerRepository;
        _hiddenElementRepository = hiddenElementRepository;
        _statusEffectService = statusEffectService;
        _roomRepository = roomRepository;
        _logger = logger;
    }

    /// <inheritdoc />
    public PassivePerception CalculatePassivePerception(string characterId)
    {
        ArgumentException.ThrowIfNullOrWhiteSpace(characterId);

        var player = _playerRepository.GetById(characterId)
            ?? throw new InvalidOperationException($"Character '{characterId}' not found.");

        var wits = player.GetEffectiveAttributes().Wits;
        var modifiers = GetActiveModifiers(characterId, player);

        var passive = PassivePerception.Calculate(characterId, wits, modifiers);

        _logger.LogDebug(
            "Calculated passive perception for {CharacterId}: WITS {Wits} → base {Base}, effective {Effective}",
            characterId,
            wits,
            passive.PassiveValue,
            passive.EffectiveValue);

        return passive;
    }

    /// <inheritdoc />
    public PassivePerceptionResult CheckRoomEntry(string characterId, string roomId)
    {
        ArgumentException.ThrowIfNullOrWhiteSpace(characterId);
        ArgumentException.ThrowIfNullOrWhiteSpace(roomId);

        var passive = CalculatePassivePerception(characterId);
        var hiddenElements = _hiddenElementRepository.GetUnrevealedByRoomId(roomId);

        if (hiddenElements.Count == 0)
        {
            _logger.LogDebug(
                "Room {RoomId} has no unrevealed hidden elements",
                roomId);
            return PassivePerceptionResult.Empty(roomId, passive.EffectiveValue);
        }

        var revealed = new List<HiddenElement>();

        foreach (var element in hiddenElements)
        {
            if (element.CanBeDiscoveredBy(passive.EffectiveValue))
            {
                element.Reveal(characterId);
                revealed.Add(element);

                _logger.LogInformation(
                    "Character {CharacterId} discovered {ElementType} '{ElementId}' (DC {DC} vs Passive {Passive})",
                    characterId,
                    element.ElementType,
                    element.ElementId,
                    element.DiscoveryDc,
                    passive.EffectiveValue);
            }
        }

        var result = PassivePerceptionResult.Create(
            roomId,
            passive.EffectiveValue,
            revealed,
            hiddenElements.Count);

        if (result.HasMissedElements)
        {
            _logger.LogDebug(
                "Character {CharacterId} missed {Count} hidden elements in room {RoomId}",
                characterId,
                result.ElementsMissed,
                roomId);
        }

        return result;
    }

    /// <inheritdoc />
    public void RevealElement(string elementId, string characterId)
    {
        ArgumentException.ThrowIfNullOrWhiteSpace(elementId);
        ArgumentException.ThrowIfNullOrWhiteSpace(characterId);

        var element = _hiddenElementRepository.GetByElementId(elementId)
            ?? throw new InvalidOperationException($"Hidden element '{elementId}' not found.");

        element.Reveal(characterId);

        _logger.LogInformation(
            "Element '{ElementId}' manually revealed by character {CharacterId}",
            elementId,
            characterId);
    }

    /// <summary>
    /// Gathers all active perception modifiers for a character.
    /// </summary>
    private List<PerceptionModifier> GetActiveModifiers(string characterId, Player player)
    {
        var modifiers = new List<PerceptionModifier>();

        // Check status effects
        var statusEffects = _statusEffectService.GetActiveEffects(characterId);

        foreach (var effect in statusEffects)
        {
            var modifier = effect.EffectType switch
            {
                StatusEffectType.Alert => PerceptionModifier.Alert(),
                StatusEffectType.Fatigued => PerceptionModifier.Fatigued(),
                StatusEffectType.Exhausted => PerceptionModifier.Exhausted(),
                _ => (PerceptionModifier?)null
            };

            if (modifier.HasValue)
            {
                modifiers.Add(modifier.Value);
            }
        }

        // Check environmental factors
        var room = _roomRepository.GetByPosition(player.Position);
        if (room != null)
        {
            // Light level modifiers
            var lightModifier = room.CurrentLightLevel switch
            {
                LightLevel.Dim => PerceptionModifier.DimLighting(),
                LightLevel.Dark => PerceptionModifier.TotalDarkness(),
                LightLevel.MagicalDarkness => PerceptionModifier.TotalDarkness(), // Same penalty
                _ => (PerceptionModifier?)null
            };

            if (lightModifier.HasValue)
            {
                modifiers.Add(lightModifier.Value);
            }

            // Zone effects (e.g., Psychic Resonance)
            // This would check room.ZoneEffects when implemented
        }

        return modifiers;
    }
}
```

---

## 10. Data Model Changes

### 10.1 New Enums

| Enum | Layer | Description |
|------|-------|-------------|
| `HiddenElementType` | Domain | Categorizes hidden element types |

### 10.2 New Value Objects

| Value Object | Layer | Description |
|--------------|-------|-------------|
| `PassivePerception` | Domain | Character's passive perception calculation |
| `PerceptionModifier` | Domain | Individual modifier to perception |
| `PassivePerceptionResult` | Domain | Result of room entry perception check |

### 10.3 New Entities

| Entity | Layer | Description |
|--------|-------|-------------|
| `HiddenElement` | Domain | A discoverable hidden element in a room |

### 10.4 New Interfaces

| Interface | Layer | Description |
|-----------|-------|-------------|
| `IPassivePerceptionService` | Application | Passive perception service contract |
| `IHiddenElementRepository` | Application | Hidden element data access |

### 10.5 New Services

| Service | Layer | Description |
|---------|-------|-------------|
| `PassivePerceptionService` | Application | Passive perception implementation |

---

## 11. Configuration File Schemas

### 11.1 Hidden Elements Schema

**File:** `config/schemas/hidden-elements.schema.json`

```json
{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "hidden-elements.schema.json",
  "title": "Hidden Elements Configuration",
  "description": "Defines hidden elements that can be discovered through perception.",
  "type": "object",
  "properties": {
    "hiddenElements": {
      "type": "array",
      "items": {
        "type": "object",
        "properties": {
          "elementId": {
            "type": "string",
            "description": "Unique identifier for this hidden element."
          },
          "roomId": {
            "type": "string",
            "description": "The room containing this element."
          },
          "elementType": {
            "type": "string",
            "enum": ["Trap", "SecretDoor", "HiddenCache", "SecretCompartment", "AmbushSite", "ClueElement"],
            "description": "The type of hidden element."
          },
          "discoveryDc": {
            "type": "integer",
            "minimum": 1,
            "maximum": 30,
            "description": "DC required to discover this element."
          },
          "discoveryText": {
            "type": "string",
            "description": "Flavor text displayed when discovered."
          },
          "interactionData": {
            "type": "object",
            "description": "Element-specific interaction data.",
            "additionalProperties": true
          }
        },
        "required": ["elementId", "roomId", "elementType", "discoveryDc", "discoveryText"]
      }
    }
  },
  "required": ["hiddenElements"]
}
```

### 11.2 Hidden Elements Configuration Example

**File:** `config/hidden-elements.json`

```json
{
  "$schema": "./schemas/hidden-elements.schema.json",
  "hiddenElements": [
    {
      "elementId": "crypt-pressure-plate-01",
      "roomId": "ancient-crypt",
      "elementType": "Trap",
      "discoveryDc": 12,
      "discoveryText": "Your trained eye catches a discrepancy—a pressure plate, barely visible beneath the dust!",
      "interactionData": {
        "triggerType": "pressure",
        "damage": "2d6",
        "damageType": "piercing",
        "disarmDc": 14,
        "triggerDescription": "Poison darts shoot from the walls."
      }
    },
    {
      "elementId": "crypt-secret-door-01",
      "roomId": "ancient-crypt",
      "elementType": "SecretDoor",
      "discoveryDc": 16,
      "discoveryText": "Behind a crumbling relief, you notice the outline of a concealed passage.",
      "interactionData": {
        "destinationRoomId": "hidden-vault",
        "openMethod": "push",
        "unlockRequirements": null
      }
    },
    {
      "elementId": "corridor-cache-01",
      "roomId": "shadowy-corridor",
      "elementType": "HiddenCache",
      "discoveryDc": 10,
      "discoveryText": "A loose stone in the wall catches your attention. Behind it, a small cache!",
      "interactionData": {
        "lootTableId": "minor-cache",
        "containerType": "wall-cache"
      }
    },
    {
      "elementId": "barracks-compartment-01",
      "roomId": "abandoned-barracks",
      "elementType": "SecretCompartment",
      "discoveryDc": 14,
      "discoveryText": "The desk drawer has a false bottom. Something is hidden beneath.",
      "interactionData": {
        "contents": ["iron-key-07", "crumpled-note-03"],
        "openMethod": "lift"
      }
    },
    {
      "elementId": "hall-ambush-01",
      "roomId": "great-hall",
      "elementType": "AmbushSite",
      "discoveryDc": 18,
      "discoveryText": "Movement in the shadows near the pillars—something is waiting in ambush!",
      "interactionData": {
        "enemyIds": ["rust-lurker-01", "rust-lurker-02"],
        "triggerCondition": "approach-throne",
        "warningGiven": true
      }
    },
    {
      "elementId": "library-clue-01",
      "roomId": "ruined-library",
      "elementType": "ClueElement",
      "discoveryDc": 15,
      "discoveryText": "Scratched into the wall near the floor: a series of symbols that might be a code.",
      "interactionData": {
        "clueId": "symbol-sequence-01",
        "relatedPuzzleId": "archive-lock-puzzle",
        "clueText": "The symbols form a repeating pattern: circle, triangle, square, circle."
      }
    }
  ]
}
```

### 11.3 Perception Modifiers Schema

**File:** `config/schemas/perception-modifiers.schema.json`

```json
{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "perception-modifiers.schema.json",
  "title": "Perception Modifiers Configuration",
  "description": "Defines modifiers that affect passive perception.",
  "type": "object",
  "properties": {
    "statusEffectModifiers": {
      "type": "array",
      "items": {
        "type": "object",
        "properties": {
          "statusEffectType": {
            "type": "string",
            "description": "The status effect type that grants this modifier."
          },
          "modifierId": {
            "type": "string",
            "description": "Unique identifier for this modifier."
          },
          "value": {
            "type": "integer",
            "description": "The modifier value (positive for bonus, negative for penalty)."
          },
          "description": {
            "type": "string",
            "description": "Display description for this modifier."
          }
        },
        "required": ["statusEffectType", "modifierId", "value", "description"]
      }
    },
    "environmentalModifiers": {
      "type": "array",
      "items": {
        "type": "object",
        "properties": {
          "condition": {
            "type": "string",
            "description": "The environmental condition that triggers this modifier."
          },
          "modifierId": {
            "type": "string",
            "description": "Unique identifier for this modifier."
          },
          "value": {
            "type": "integer",
            "description": "The modifier value."
          },
          "description": {
            "type": "string",
            "description": "Display description for this modifier."
          }
        },
        "required": ["condition", "modifierId", "value", "description"]
      }
    }
  },
  "required": ["statusEffectModifiers", "environmentalModifiers"]
}
```

### 11.4 Perception Modifiers Configuration Example

**File:** `config/perception-modifiers.json`

```json
{
  "$schema": "./schemas/perception-modifiers.schema.json",
  "statusEffectModifiers": [
    {
      "statusEffectType": "Alert",
      "modifierId": "status-alert",
      "value": 2,
      "description": "[Alert] heightened awareness"
    },
    {
      "statusEffectType": "Fatigued",
      "modifierId": "status-fatigued",
      "value": -1,
      "description": "[Fatigued] dulled senses"
    },
    {
      "statusEffectType": "Exhausted",
      "modifierId": "status-exhausted",
      "value": -2,
      "description": "[Exhausted] severely impaired"
    }
  ],
  "environmentalModifiers": [
    {
      "condition": "familiar-territory",
      "modifierId": "env-familiar",
      "value": 1,
      "description": "Familiar territory"
    },
    {
      "condition": "dim-lighting",
      "modifierId": "env-dim-light",
      "value": -1,
      "description": "Dim lighting"
    },
    {
      "condition": "total-darkness",
      "modifierId": "env-darkness",
      "value": -3,
      "description": "Total darkness"
    },
    {
      "condition": "psychic-resonance-zone",
      "modifierId": "zone-psychic",
      "value": -2,
      "description": "[Psychic Resonance] interference"
    }
  ]
}
```

---

## 12. Logging Specifications

### 12.1 Log Levels by Component

| Component | Level | Events |
|-----------|-------|--------|
| `PassivePerceptionService` | Information | Element discovered, element manually revealed |
| `PassivePerceptionService` | Debug | Passive calculation, no elements in room, elements missed |
| `PassivePerceptionService` | Warning | Character not found, element not found |
| `HiddenElement` | Debug | Reveal state changes |

### 12.2 Example Log Messages

```
[INF] PassivePerceptionService: Character 'player-1' discovered Trap 'crypt-pressure-plate-01' (DC 12 vs Passive 14)
[INF] PassivePerceptionService: Character 'player-1' discovered HiddenCache 'corridor-cache-01' (DC 10 vs Passive 14)
[DBG] PassivePerceptionService: Calculated passive perception for player-1: WITS 8 → base 4, effective 5
[DBG] PassivePerceptionService: Room 'entrance-hall' has no unrevealed hidden elements
[DBG] PassivePerceptionService: Character 'player-1' missed 2 hidden elements in room 'ancient-crypt'
[INF] PassivePerceptionService: Element 'secret-door-01' manually revealed by character 'player-1'
```

---

## 13. Unit Testing Requirements

### 13.1 Test Count by Feature

| Feature | Test Count |
|---------|------------|
| PassivePerception calculation | ~4 |
| **Total** | **~4** |

### 13.2 Test Specifications

#### PassivePerceptionTests.cs

**File:** `tests/RuneAndRust.Domain.Tests/ValueObjects/PassivePerceptionTests.cs`

```csharp
[TestFixture]
public class PassivePerceptionTests
{
    [Test]
    public void Calculate_WitsValueSix_ReturnsPassiveThree()
    {
        // WITS 6 ÷ 2 = 3.0 → 3
        var result = PassivePerception.Calculate("char-1", 6);
        Assert.That(result.PassiveValue, Is.EqualTo(3));
    }

    [Test]
    public void Calculate_WitsValueSeven_ReturnsPassiveFour()
    {
        // WITS 7 ÷ 2 = 3.5 → round up → 4
        var result = PassivePerception.Calculate("char-1", 7);
        Assert.That(result.PassiveValue, Is.EqualTo(4));
    }

    [Test]
    public void Calculate_WitsValueTen_ReturnsPassiveFive()
    {
        // WITS 10 ÷ 2 = 5.0 → 5
        var result = PassivePerception.Calculate("char-1", 10);
        Assert.That(result.PassiveValue, Is.EqualTo(5));
    }

    [Test]
    public void EffectiveValue_WithModifiers_AppliesCorrectly()
    {
        var modifiers = new List<PerceptionModifier>
        {
            PerceptionModifier.Alert(),      // +2
            PerceptionModifier.DimLighting() // -1
        };

        var result = PassivePerception.Calculate("char-1", 8, modifiers);

        // Base: 8 ÷ 2 = 4, Modifiers: +2 + -1 = +1, Effective: 4 + 1 = 5
        Assert.That(result.PassiveValue, Is.EqualTo(4));
        Assert.That(result.EffectiveValue, Is.EqualTo(5));
    }
}
```

---

## 14. Use Cases

### UC-001: Enter Room with Hidden Elements

**Actor:** Player
**Flow:** Player moves → Room has hidden elements → Calculate passive perception → Compare vs DCs → Reveal qualifying elements → Display discovery text

### UC-002: High-WITS Character Detects Trap

**Actor:** Player
**Flow:** Player enters room → High WITS gives passive 6 → Trap DC is 5 → Passive >= DC → Trap revealed → Player warned before triggering

### UC-003: Low-WITS Character Misses Secret Door

**Actor:** Player
**Flow:** Player enters room → Low WITS gives passive 3 → Secret door DC is 6 → Passive < DC → Door remains hidden → No indication given

### UC-004: Status Effect Reduces Perception

**Actor:** System
**Flow:** Player has [Fatigued] status → Calculate passive perception → Apply -1 modifier → Reduced effective value → May miss elements previously detectable

### UC-005: Manually Reveal Element

**Actor:** System (via active search)
**Flow:** Player uses search command → Active check succeeds → Call RevealElement() → Element marked as revealed → Discovery text displayed

---

## 15. Deliverable Checklist

### Domain Layer

- [ ] `HiddenElementType` enum with six values
- [ ] `PerceptionModifier` value object with factory methods
- [ ] `PassivePerception` value object with calculation
- [ ] `PassivePerceptionResult` value object
- [ ] `HiddenElement` entity with reveal logic

### Application Layer

- [ ] `IPassivePerceptionService` interface
- [ ] `PassivePerceptionService` implementation
- [ ] `IHiddenElementRepository` interface

### Configuration

- [ ] `hidden-elements.schema.json` created
- [ ] `perception-modifiers.schema.json` created
- [ ] `hidden-elements.json` with sample elements
- [ ] `perception-modifiers.json` with modifier definitions

### Testing

- [ ] ~4 unit tests implemented
- [ ] All tests passing

---

## 16. Acceptance Criteria

### Functional

- [ ] Passive perception calculates correctly (WITS ÷ 2, round up)
- [ ] Status effect modifiers apply correctly ([Alert] +2, [Fatigued] -1, [Exhausted] -2)
- [ ] Room entry triggers automatic passive perception check
- [ ] Hidden elements reveal when passive >= DC
- [ ] Elements above passive DC remain hidden
- [ ] Revealed elements track who discovered them and when
- [ ] Discovery text displays for revealed elements
- [ ] Missed element count provided without details
- [ ] HiddenElementType enum has all six types
- [ ] PerceptionModifier tracks source and value
- [ ] PassivePerceptionResult contains revealed list and missed count

### Quality

- [ ] Build succeeds with 0 errors
- [ ] Build succeeds with 0 warnings
- [ ] ~4 unit tests pass
- [ ] Configuration files validate against schemas
- [ ] XML documentation complete for all public members

---

## 17. Dependencies

### 17.1 Required from Previous Versions

| Type | Location | Usage in this phase |
|------|----------|---------------------|
| `Player.GetEffectiveAttributes()` | `Domain/Entities/Player.cs` | Get WITS for passive calculation |
| `StatusEffectType` | `Domain/Enums/StatusEffectType.cs` | Check for Alert/Fatigued/Exhausted |
| `IStatusEffectService` | `Application/Interfaces/IStatusEffectService.cs` | Get active status effects |
| `LightLevel` | `Domain/Enums/LightLevel.cs` | Environmental modifiers |
| `Room.CurrentLightLevel` | `Domain/Entities/Room.cs` | Check room lighting |
| v0.15.0 Dice System | Various | Success-counting for future active checks |
| v0.15.1 Skill Infrastructure | Various | SkillContext integration (future) |

### 17.2 Provides to v0.15.6b

| Type | Usage |
|------|-------|
| `PassivePerception` | Used in examination layer unlocking |
| `HiddenElement` | Foundation for examination targets |
| `IPassivePerceptionService` | Called during room description composition |

### 17.3 Provides to v0.15.6f

| Type | Usage |
|------|-------|
| `HiddenElement` | Search command targets these elements |
| `PassivePerceptionResult` | Search results build on this structure |

### 17.4 Provides to v0.15.6h

| Type | Usage |
|------|-------|
| `PerceptionModifier` | Specialization bonuses add custom modifiers |
| `PassivePerceptionService.GetActiveModifiers()` | Extended to include specialization bonuses |

### 17.5 Provides to v0.15.6i

| Type | Usage |
|------|-------|
| `PassivePerceptionResult` | Integrated into room entry description flow |
| `HiddenElement.DiscoveryText` | Added to room description when revealed |

---

## 18. Future Considerations

### Deferred to v0.15.6b

- **Three-layer examination system** - Layered detail depth on active examination
- **ExaminationContext** - Context for examination checks
- **Layer DC requirements** - DC 12 for Layer 2, DC 18 for Layer 3

### Deferred to v0.15.6f

- **Search command enhancement** - Active search with +2 perception bonus
- **SearchResult value object** - Results from active searching
- **Time cost for searching** - Search actions take time

### Deferred to v0.15.6h

- **Specialization perception bonuses** - Ruin-Stalker trap bonus, Veiðimaðr keen senses
- **Equipment perception modifiers** - Items that boost perception
- **Type-specific bonuses** - Bonuses that only apply to certain element types

### Deferred to v0.15.6i

- **Room entry integration** - Full integration with room description composition
- **Perception-gated descriptions** - Room text that varies by passive perception
- **Discovery text integration** - Seamless inclusion in room narrative

### Out of Scope for v0.15.6

- **Vision type perception modifiers** - DarkVision/TrueSight affecting perception
- **Party perception (highest)** - Using best party member's perception
- **Perception skills** - Dedicated perception skill proficiency

---

*Document Version: 1.0*
*Last Updated: 2026-01-18*
*Author: AI Assistant*
