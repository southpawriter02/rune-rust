# v0.0.8b Changelog - Level-Up Mechanics

**Date:** 2026-01-08

## Summary

Implements level-up detection and application, stat increases on level-up, full heal on level-up, multi-level gain support, and level-up UI notifications. Builds on v0.0.8a XP tracking and integrates with existing ability unlock system.

## Added

### Domain Layer - Value Objects (New)

- `LevelStatModifiers` readonly record struct:
  - Properties: MaxHealth, Attack, Defense
  - `Zero` static readonly - no modifications
  - `DefaultLevelUp` static readonly - +5 HP, +1 ATK, +1 DEF per level
  - `HasModifications` computed property
  - `Add()`, `Multiply()` methods for combining/scaling
  - `ForLevels(int)` factory method for multi-level gains

- `LevelUpResult` readonly record struct:
  - Properties: OldLevel, NewLevel, StatIncreases, NewAbilities
  - Computed: LevelsGained, IsMultiLevel, HasNewAbilities, DidLevelUp
  - Factory methods: `None()`, `SingleLevel()`, `MultiLevel()`

### Domain Layer - Entities (Modified)

- `Player` entity enhancements:
  - `GetExperienceForLevel(int level)` static method - XP threshold calculation
  - `GetLevelForExperience(int experience)` static method - level calculation from XP
  - `ApplyLevelStatModifiers(modifiers, healToNewMax)` method - stat application

### Domain Layer - Services (New)

- `ProgressionService` class:
  - `CheckForLevelUp(Player)` - detects pending level-up
  - `ApplyLevelUp(Player, LevelUpResult, getAbilitiesAtLevel?)` - applies level-up
  - `CheckAndApplyLevelUp(Player, getAbilitiesAtLevel?)` - combined operation
  - `GetStatIncreasesForLevels(int)` static helper
  - `GetExperienceForNextLevel(int)` static helper
  - `GetExperienceUntilNextLevel(Player)` static helper

### Application Layer - DTOs (New)

- `LevelUpDto` record:
  - Properties: OldLevel, NewLevel, LevelsGained, Old/New MaxHealth/Attack/Defense, UnlockedAbilityNames, XpToNextLevel
  - Computed: IsMultiLevel, HasUnlockedAbilities, HealthIncrease, AttackIncrease, DefenseIncrease
  - Factory method: `FromResult()`

### Application Layer - Interfaces (Modified)

- `IGameRenderer` interface:
  - Added `RenderLevelUpAsync(LevelUpDto, CancellationToken)` method

### Application Layer - Services (Modified)

- `GameSessionService` enhancements:
  - Added `ProgressionService` dependency
  - `TryAttack()` now returns `(bool, string, ExperienceGainDto?, LevelUpDto?)`
  - Added `CheckAndHandleLevelUp()` private method
  - Level-up check triggered after XP gain

### Presentation Layer - Adapters (Modified)

- `SpectreGameRenderer` enhancements:
  - Implemented `RenderLevelUpAsync()`:
    - Yellow double-border panel with star header
    - Single/multi-level message support
    - Stat increase display with before/after values
    - Unlocked abilities section (if any)
    - Next level XP requirement

### Presentation Layer - Views (Modified)

- `GameView` enhancements:
  - `HandleAttackAsync()` now handles 4-element tuple from TryAttack
  - Renders level-up notification after experience gain

### Infrastructure Layer (Modified)

- `DependencyInjection` enhancements:
  - Registered `ProgressionService` as scoped service

## Tests Added

| Test File | Count |
|-----------|-------|
| `LevelStatModifiersTests.cs` | 10 |
| `LevelUpResultTests.cs` | 13 |
| `PlayerLevelUpTests.cs` | 16 |
| `ProgressionServiceTests.cs` | 18 |
| **Total New** | 57 |

## Test Results

```
Domain Tests:      455 passed (+57)
Application Tests: 117 passed
Architecture Tests:  8 passed
Total:             580 passed
```

## Level-Up System Design

### Stat Increases Per Level
```
MaxHealth: +5
Attack: +1
Defense: +1
```

### XP Thresholds
```
Level 2: 200 XP
Level 3: 300 XP
Level 4: 400 XP
Level 5: 500 XP
...
Level N: N * 100 XP
```

### Level-Up Behavior
- Automatic detection when XP exceeds threshold
- Multi-level support (one XP gain can trigger multiple levels)
- Full heal to new maximum on level-up
- Ability unlock integration (via callback to AbilityService)

## UI Display

### Level-Up Panel (Single Level)
```
╔══════════════════════════════════════════╗
║           ★ LEVEL UP! ★                  ║
╠══════════════════════════════════════════╣
║ You have reached Level 2!                ║
║                                          ║
║ Stat Increases:                          ║
║   Max Health: 100 → 105 (+5)             ║
║   Attack: 10 → 11 (+1)                   ║
║   Defense: 5 → 6 (+1)                    ║
║                                          ║
║ Next Level: 100 XP needed (Level 3)      ║
╚══════════════════════════════════════════╝
```

### Level-Up Panel (Multi-Level)
```
╔══════════════════════════════════════════╗
║           ★ LEVEL UP! ★                  ║
╠══════════════════════════════════════════╣
║ You gained 4 levels!                     ║
║ Level 1 → Level 5                        ║
║                                          ║
║ Stat Increases:                          ║
║   Max Health: 100 → 120 (+20)            ║
║   Attack: 10 → 14 (+4)                   ║
║   Defense: 5 → 9 (+4)                    ║
║                                          ║
║ New Abilities Unlocked:                  ║
║   • Power Strike                         ║
║   • Shield Bash                          ║
║                                          ║
║ Next Level: 100 XP needed (Level 6)      ║
╚══════════════════════════════════════════╝
```

## Files Summary

### New Files (6)
| File | Purpose |
|------|---------|
| `Domain/ValueObjects/LevelStatModifiers.cs` | Stat modification value object |
| `Domain/ValueObjects/LevelUpResult.cs` | Level-up result value object |
| `Domain/Services/ProgressionService.cs` | Level-up detection and application |
| `Application/DTOs/LevelUpDto.cs` | Level-up display DTO |
| `Domain.UnitTests/ValueObjects/LevelStatModifiersTests.cs` | Modifier tests |
| `Domain.UnitTests/ValueObjects/LevelUpResultTests.cs` | Result tests |
| `Domain.UnitTests/Entities/PlayerLevelUpTests.cs` | Player level-up tests |
| `Domain.UnitTests/Services/ProgressionServiceTests.cs` | Service tests |

### Modified Files (8)
| File | Changes |
|------|---------|
| `Domain/Entities/Player.cs` | GetExperienceForLevel, GetLevelForExperience, ApplyLevelStatModifiers |
| `Application/Interfaces/IGameRenderer.cs` | RenderLevelUpAsync method |
| `Application/Services/GameSessionService.cs` | ProgressionService dependency, level-up handling |
| `Presentation.Tui/Adapters/SpectreGameRenderer.cs` | RenderLevelUpAsync implementation |
| `Presentation.Tui/Views/GameView.cs` | Handle level-up in attack result |
| `Infrastructure/DependencyInjection.cs` | Register ProgressionService |
| `Application.UnitTests/Services/GameSessionServiceTests.cs` | ProgressionService in tests |
| `Application.UnitTests/Services/TurnProcessingTests.cs` | ProgressionService in tests |

## v0.0.8b Complete

This completes the level-up mechanics system:
- Level-up detection based on XP thresholds
- Stat increases (+5 HP, +1 ATK, +1 DEF per level)
- Full heal on level-up
- Multi-level gain support
- Ability unlock integration
- Rich UI notifications
- Ready for v0.0.8c: XP Configuration & Polish
