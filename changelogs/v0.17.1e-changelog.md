# Changelog: v0.17.1e - Background Application Service

**Release Date:** 2026-01-29
**Phase:** Background System (5/5)
**Status:** Complete

---

## Overview

Implements the Background Application Service that applies background grants to characters during creation. This is the culmination of the v0.17.1 Background System, bringing together all prior components (Background enum, definitions, skill grants, equipment grants, and the provider service) to deliver a complete background application workflow.

The application service provides:

- **Grant Application**: Applies skill and equipment grants to characters via `ApplyBackgroundToCharacter`
- **Preview Generation**: Creates formatted previews for UI display before selection via `GetBackgroundPreview` and `GetAllBackgroundPreviews`
- **Validation**: Checks background existence via `CanApplyBackground`
- **Result Tracking**: Returns `BackgroundApplicationResult` with detailed grant summaries

---

## Added

### Domain Layer

#### Entity Extensions

- **`Player`** (`Entities/Player.cs`) — Extended with Background System support
    - Added `SelectedBackground` property (`Background?`) — nullable, private set
    - Added `HasBackground` computed property — returns true if background is assigned
    - Added `SetBackground(Background)` method — one-time assignment during creation
    - Throws `InvalidOperationException` if called when background already set
    - Follows the same pattern as `SetLineage`/`HasLineage`/`SelectedLineage` (v0.17.0)

### Application Layer

#### Interfaces

- **`IBackgroundApplicationService`** (`Interfaces/IBackgroundApplicationService.cs`)
    - Interface defining the contract for background application during creation
    - Methods:
        - `ApplyBackgroundToCharacter(Player, Background)`: Applies all grants and sets background
        - `GetBackgroundPreview(Background)`: Returns formatted preview for UI
        - `GetAllBackgroundPreviews()`: Returns previews for all 6 backgrounds
        - `CanApplyBackground(Background)`: Validates background exists in provider
    - Comprehensive XML documentation with examples, remarks, and seealso tags
    - Designed for scoped DI registration (per-request lifetime)

#### Value Objects

- **`BackgroundApplicationResult`** (`ValueObjects/BackgroundApplicationResult.cs`)
    - `readonly record struct` capturing the outcome of applying a background
    - Properties: Success, BackgroundId, SkillsGranted, EquipmentGranted, Messages
    - Factory methods: `Succeeded(...)` and `Failed(...)` for consistent initialization
    - Summary methods: `GetSkillSummary()` and `GetEquipmentSummary()` for display
    - Full XML documentation with usage examples

- **`GrantedSkill`** (`ValueObjects/BackgroundApplicationResult.cs`)
    - `readonly record struct` tracking a skill grant: SkillId, Amount, GrantType
    - `ToString()` formats as "craft +2", "craft +2 (starting)", or "craft (proficient)"

- **`GrantedEquipment`** (`ValueObjects/BackgroundApplicationResult.cs`)
    - `readonly record struct` tracking an equipment grant: ItemId, Quantity, WasEquipped, Slot
    - `ToString()` formats as "spear (Weapon)", "bandages ×5", or "lockpicks"

- **`BackgroundPreview`** (`ValueObjects/BackgroundPreview.cs`)
    - `readonly record struct` providing UI-ready preview data
    - Properties: BackgroundId, DisplayName, Description, SelectionText, ProfessionBefore, SocialStanding, SkillSummary, EquipmentSummary, NarrativeHookCount
    - Factory method: `Empty(Background)` for not-found placeholder

#### Services

- **`BackgroundApplicationService`** (`Services/BackgroundApplicationService.cs`)
    - Implements `IBackgroundApplicationService` in the Application layer
    - Dependencies: `IBackgroundProvider`, `ILogger<BackgroundApplicationService>`
    - Constructor validates non-null dependencies with `ArgumentNullException.ThrowIfNull`
    - `ApplyBackgroundToCharacter` flow:
        1. Validates character is not null
        2. Retrieves definition from `IBackgroundProvider`
        3. Applies skill grants via `Player.ModifySkill` for Permanent/StartingBonus types
        4. Creates `Item` instances for equipment, adds to `Inventory.TryAdd`, auto-equips via `Player.TryEquip`
        5. Sets background on character via `Player.SetBackground`
        6. Returns detailed `BackgroundApplicationResult`
    - `GetBackgroundPreview` builds preview from definition's helper methods
    - `GetAllBackgroundPreviews` iterates all backgrounds from provider
    - `CanApplyBackground` delegates to `IBackgroundProvider.HasBackground`
    - Private helper methods:
        - `ApplySkillGrant`: Switch on GrantType (Permanent, StartingBonus, Proficiency)
        - `ApplyEquipmentGrant`: Creates Item, adds to inventory, auto-equips if needed
        - `DetermineItemType`: Maps EquipmentSlot to ItemType
        - `FormatItemName`: Converts kebab-case to title case for display names
    - Exhaustive structured logging at all levels:
        - **Information**: Application start/success with grant summaries
        - **Debug**: Individual grant applications, preview generation, provider queries
        - **Warning**: Background not found, null character, failed equip/inventory

### Dependency Injection

- **`DependencyInjection.cs`** — Updated
    - Added scoped registration for `IBackgroundApplicationService` → `BackgroundApplicationService`
    - Follows same pattern as `ILineageApplicationService` registration (v0.17.0f)

### Unit Tests

- **`BackgroundApplicationResultTests`** (`ValueObjects/BackgroundApplicationResultTests.cs`) — 12 tests
    - `Succeeded_CreatesSuccessfulResult`: Full creation with all properties
    - `Succeeded_WithoutMessage_HasEmptyMessagesList`: Optional message handling
    - `Failed_CreatesFailedResult`: Failure result with error message
    - `GetSkillSummary_WithSkills_FormatsCorrectly`: Comma-separated skill summary
    - `GetSkillSummary_WithNoSkills_ReturnsFallbackText`: Empty list fallback
    - `GetEquipmentSummary_WithEquipment_FormatsCorrectly`: Comma-separated equipment summary
    - `GetEquipmentSummary_WithNoEquipment_ReturnsFallbackText`: Empty list fallback
    - `GrantedSkill_ToString_FormatsCorrectlyByGrantType`: 3 test cases (Permanent, StartingBonus, Proficiency)
    - `GrantedEquipment_ToString_EquippedItem_IncludesSlot`: Equipped format
    - `GrantedEquipment_ToString_StackableItem_IncludesQuantity`: Stackable format
    - `GrantedEquipment_ToString_SingleInventoryItem_JustName`: Single inventory format

- **`BackgroundPreviewTests`** (`ValueObjects/BackgroundPreviewTests.cs`) — 3 tests
    - `Empty_CreatesEmptyPreview`: Placeholder values for not-found case
    - `Properties_SetCorrectly`: All properties set and retrievable
    - `BackgroundPreview_SupportsStructuralEquality`: Value type equality

- **`BackgroundApplicationServiceTests`** (`Services/BackgroundApplicationServiceTests.cs`) — 15 tests
    - `Constructor_NullProvider_ThrowsArgumentNullException`: Null provider validation
    - `Constructor_NullLogger_ThrowsArgumentNullException`: Null logger validation
    - `ApplyBackgroundToCharacter_VillageSmith_AppliesSkillGrants`: Skill application verification
    - `ApplyBackgroundToCharacter_VillageSmith_AppliesEquipmentGrants`: Equipment creation verification
    - `ApplyBackgroundToCharacter_ClanGuard_EquipsAutoEquipItems`: Auto-equip to slots verification
    - `ApplyBackgroundToCharacter_InvalidBackground_ReturnsFailure`: Not-found failure handling
    - `ApplyBackgroundToCharacter_NullCharacter_ReturnsFailure`: Null character failure handling
    - `ApplyBackgroundToCharacter_SetsBackgroundOnCharacter`: Background property set verification
    - `ApplyBackgroundToCharacter_ResultSkillSummary_FormatsCorrectly`: Result summary formatting
    - `GetBackgroundPreview_ValidBackground_ReturnsCorrectPreview`: Preview data verification
    - `GetBackgroundPreview_InvalidBackground_ReturnsEmptyPreview`: Empty preview fallback
    - `GetAllBackgroundPreviews_ReturnsAllSixPreviews`: All 6 backgrounds covered
    - `CanApplyBackground_ValidBackground_ReturnsTrue`: Existence check positive
    - `CanApplyBackground_InvalidBackground_ReturnsFalse`: Existence check negative

---

## Design Decisions

### Application Layer Placement

The design specification suggested placing `BackgroundApplicationService` in the Infrastructure layer. However, following the established `LineageApplicationService` pattern (v0.17.0f), the service is placed in the Application layer (`Application.Services` namespace). This is consistent with the codebase convention where orchestration services that coordinate between providers and domain entities reside in the Application layer.

### No IItemFactory Dependency

The design specification referenced an `IItemFactory` interface that does not exist in the codebase. Items are created directly using the `Item` constructor, consistent with how items are created elsewhere in the codebase (e.g., `Item.CreateSword()`, `Item.CreateHealthPotion()`). Equipment grants create `Item` instances with:
- Name derived from kebab-case item ID via `FormatItemName`
- ItemType inferred from EquipmentSlot via `DetermineItemType`
- Minimal properties (no damage dice, weapon bonuses, etc.)

### Player Entity vs PlayerCharacter

The design specification referenced `PlayerCharacter` which does not exist. The actual entity is `Player`. All methods were adapted accordingly:
- `character.SetBackground(background)` → Added to Player (new method)
- `character.AddSkillBonus(...)` → `character.ModifySkill(skillId, amount)` (existing)
- `character.Inventory.AddItem(item)` → `character.Inventory.TryAdd(item)` (existing)
- `character.EquipItem(item, slot)` → `character.TryEquip(item)` (existing, uses item's built-in slot)

### Skill Grant Application

All current background skill grants use the `Permanent` grant type. The service handles all three types via a switch statement:
- `Permanent`: Calls `Player.ModifySkill` to add the bonus
- `StartingBonus`: Also calls `Player.ModifySkill` (distinction tracked for future mechanics)
- `Proficiency`: Logged but not mechanically applied (no proficiency system implemented yet)

### Equipment Creation Pattern

For stackable items (quantity > 1), individual `Item` instances are created and added separately. This matches the existing `Inventory` model which tracks individual item instances. Only the first item in a stack is auto-equipped if the grant specifies equipped status.

---

## Dependencies

### Prerequisites

- v0.17.1a (Background Enum & Definition) — Complete
- v0.17.1b (Skill Grants) — Complete
- v0.17.1c (Equipment Grants) — Complete
- v0.17.1d (Background Provider) — Complete

### Provides to v0.17.5

| Type | Usage |
| ---- | ----- |
| `IBackgroundApplicationService` | Used by character creation workflow for background step |
| `BackgroundPreview` | Displayed in background selection panel |
| `BackgroundApplicationResult` | Shown as confirmation after background selection |
| `GetAllBackgroundPreviews()` | Populates background selection screen |
| `ApplyBackgroundToCharacter()` | Called when player confirms background choice |
