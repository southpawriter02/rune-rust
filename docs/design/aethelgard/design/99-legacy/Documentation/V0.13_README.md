# v0.13: Persistent World State System

## Quick Start

**Status:** âœ… Core Implementation Complete | â³ Integration Required

v0.13 adds persistent world state modification to RUNE & RUST. Player actions now permanently alter generated Sectors through delta-based state recording and reconstruction.

---

## What v0.13 Adds

### ğŸ¯ Core Features
- **World State Recording** - Track player-driven modifications
- **Destructible Environment** - 6+ terrain types, 4+ hazards
- **Persistent Changes** - Survive save/load cycles
- **Enemy Defeat Persistence** - Defeated enemies never respawn
- **Player Commands** - `destroy`, `smash`, `break`, `clear`, `history`

### ğŸ’¥ The Difference
- **Before:** Destroy a pillar â†’ It's back next session
- **After:** Destroy a pillar â†’ Stays destroyed forever in your Saga

---

## File Structure

```
RuneAndRust.Core/
â”œâ”€â”€ WorldStateChange.cs          # Change recording model
â””â”€â”€ DestructibleElement.cs       # Destruction mechanics

RuneAndRust.Persistence/
â””â”€â”€ WorldStateRepository.cs      # Database persistence

RuneAndRust.Engine/
â”œâ”€â”€ DestructionService.cs        # Core destruction logic
â””â”€â”€ CommandParser.cs             # Updated with destroy/history commands

RuneAndRust.Tests/
â”œâ”€â”€ WorldStateRepositoryTests.cs  # Repository tests (13 tests)
â””â”€â”€ DestructionServiceTests.cs    # Service tests (11 tests)

Documentation/
â”œâ”€â”€ V0.13_INTEGRATION_GUIDE.md   # Step-by-step integration
â”œâ”€â”€ CHANGELOG_v0.13.md           # Complete changelog
â””â”€â”€ V0.13_README.md              # This file
```

---

## Quick Integration Checklist

### 1. Services (Program.cs)
```csharp
private static WorldStateRepository _worldStateRepository = new();
private static DestructionService _destructionService =
    new(_worldStateRepository, _diceService);
```

### 2. Command Handlers (Program.cs)
- [ ] Add `case CommandType.Destroy: HandleDestroy(parsed.Target);`
- [ ] Add `case CommandType.History: HandleHistory();`
- [ ] Implement `HandleDestroy()` (see integration guide)
- [ ] Implement `HandleHistory()` (see integration guide)

### 3. Room Loading (GameWorld.cs or equivalent)
- [ ] After room generation, query changes
- [ ] Apply changes via `_destructionService.ApplyWorldStateChanges()`
- [ ] Initialize HP tracking via `_destructionService.InitializeRoomElements()`

### 4. Combat Integration (CombatEngine.cs)
- [ ] On enemy defeat, call `_destructionService.RecordEnemyDefeat()`

---

## Example Commands

```
> destroy pillar
The corroded pillar groans under centuries of stress. Your assault is the
final strainâ€”it collapses in a cloud of rust and debris.
A pile of rubble now occupies the space.

> smash grating
The weakened grating gives way with a metallic shriek, plunging into the
darkness below.

> history
**Room History: The Collapsed Entry Hall**
Total modifications: 2

- Destroyed Collapsed Pillar (2 min ago)
- Destroyed Corroded Grating (just now)
```

---

## Database Schema

**New Table:** `world_state_changes`
- Auto-created on first run
- Indexed for fast queries
- Cascading delete with saves
- Delta-based storage (efficient)

---

## Testing

### Run Unit Tests
```bash
dotnet test --filter "FullyQualifiedName~WorldState"
```

**Test Coverage:** 85%
- 13 repository tests
- 11 service tests
- All passing âœ…

---

## Performance Targets

| Scenario | Target | Acceptable | Unacceptable |
|----------|--------|------------|--------------|
| 0-10 changes | < 10ms | < 20ms | > 30ms |
| 11-50 changes | < 30ms | < 60ms | > 100ms |
| 51+ changes | < 50ms | < 100ms | > 150ms |

---

## Destructible Elements Reference

### Terrain
- **Collapsed Pillar** (30 HP) â†’ Spawns rubble
- **Rusted Bulkhead** (40 HP) â†’ Opens path
- **Rubble Pile** (15 HP) â†’ Can be cleared
- **Corroded Grating** (10 HP) â†’ Falls into chasm
- **Steel Barricade** (35 HP) â†’ Heavy cover
- **Broken Gantry** (25 HP) â†’ Partial bridge

### Hazards
- **Steam Vent** (20 HP) â†’ Can be sealed
- **Live Power Conduit** (15 HP) â†’ Can be severed
- **Leaking Coolant** (12 HP) â†’ Can be ruptured
- **Pressurized Pipe** (18 HP) â†’ Explodes on destruction

---

## Documentation

ğŸ“– **[Integration Guide](V0.13_INTEGRATION_GUIDE.md)** - Complete step-by-step instructions
ğŸ“‹ **[Changelog](CHANGELOG_v0.13.md)** - Full feature documentation
ğŸ“ **[Original Spec](../README.md)** - Design philosophy and architecture

---

## Troubleshooting

### Changes not persisting?
1. Check `WorldStateRepository` is initialized
2. Verify save ID is retrieved correctly
3. Confirm `world_state_changes` table exists

### Room state not applying?
1. Verify `ApplyWorldStateChanges()` called after generation
2. Check sector seed extraction is correct
3. Ensure changes queried for correct save ID

### Performance issues?
1. Check change count per room (should be < 50)
2. Consider implementing `WorldStateCache` (future)
3. Run compaction periodically (future)

---

## Future Enhancements (Post-v0.13)

- [ ] WorldStateCache (LRU cache for hot rooms)
- [ ] WorldStateCompactor (reduce redundant changes)
- [ ] Partial damage states (terrain at 50% HP)
- [ ] Settlement building (create new terrain)
- [ ] Environmental puzzles (destruction-based)
- [ ] Time-based decay (regeneration?)

---

## Lore Compliance âœ…

All destruction respects **v5.0 Aethelgard Setting:**
- 800 years of decay = everything is already failing
- Player just accelerates existing collapse
- Layer 2 diagnostic voice for destruction events
- No "magic" - only physical deterioration

---

## Status

**Core Implementation:** âœ… Complete
**Unit Tests:** âœ… Passing (85% coverage)
**Integration:** â³ Required (see guide)
**Ready for:** Main game loop integration

---

## Next Step

ğŸ‘‰ **[Read the Integration Guide](V0.13_INTEGRATION_GUIDE.md)** to complete the implementation.

---

**v0.13: Making player choices matter through persistent environmental change.**
