# Changelog: v0.18.0e - Configuration & Schema

**Release Date:** 2026-01-31
**Phase:** Psychic Stress System (5/6)
**Status:** Complete

---

## Overview

Implements the JSON configuration infrastructure for the Psychic Stress system — the schema, configuration file, and application DTOs that define stress source events, recovery rates, and trauma reset values in a data-driven format. This is the fifth phase of v0.18.0 (Psychic Stress System), establishing the **Configuration Pattern** that allows game designers to define and balance stress-inducing events without code changes.

The JSON Schema (`stress-sources.schema.json`, Draft-07) validates all configuration with strict constraints: kebab-case ID patterns, numeric range enforcement (baseStress 1-100, resistDc 0-10, trauma reset 0-100), required field presence, and `additionalProperties: false` at all levels to prevent configuration drift.

The configuration file (`stress-sources.json`) defines 24 stress sources across 6 categories (4 per category), 4 recovery rate formulas, and trauma check reset values (passed: 75, failed: 50).

Three sealed record DTOs provide the application layer deserialization target: `StressSourceDefinitionDto` for individual stress events, `StressRecoveryConfigDto` + `RecoveryRateDto` for recovery formulas, and `StressConfigurationDto` + `StressSourcesDto` + `TraumaResetConfigDto` for the complete configuration hierarchy.

---

## Added

### Configuration Layer — JSON Schema

- **`stress-sources.schema.json`** (`config/schemas/stress-sources.schema.json`)
    - JSON Schema Draft-07 with `$id: "stress-sources.schema.json"`
    - Title: "Stress Sources Configuration"
    - 4 required root properties: `version`, `stressSources`, `recoveryRates`, `traumaCheckReset`
    - `$schema` property accepted but not required (for editor tooling)
    - `additionalProperties: false` at root, stressSources, recoveryRates, traumaCheckReset, and all definitions
    - **StressSourceDefinition** definition:
        - `id` — string, pattern `^[a-z][a-z0-9-]*$` (kebab-case)
        - `baseStress` — integer, minimum 1, maximum 100
        - `resistDc` — integer, minimum 0, maximum 10
        - `description` — string, optional
    - **RecoveryRate** definition:
        - `formula` — string, required
    - `stressSources` object: 6 category arrays (combat, exploration, narrative, heretical, environmental, corruption)
    - `recoveryRates` object: 4 required properties (shortRest, longRest, sanctuary, milestone)
    - `traumaCheckReset` object: `passed` and `failed` integers (0-100)
    - `version` property: pattern `^\d+\.\d+$` (MAJOR.MINOR format)

### Configuration Layer — Configuration File

- **`stress-sources.json`** (`config/stress-sources.json`)
    - Schema reference: `"$schema": "./schemas/stress-sources.schema.json"`
    - Version: `"1.0"`
    - **24 stress sources** (4 per category):
        - **Combat:** enemy-fear-aura (15/DC2), overwhelming-odds (10/DC1), ally-down (20/DC2), near-death-experience (25/DC3)
        - **Exploration:** darkness-isolation (8/DC1), strange-sounds (5/DC1), corpse-discovery (12/DC2), impossible-architecture (15/DC2)
        - **Narrative:** ally-betrayal (30/DC3), loved-one-death (40/DC4), moral-dilemma (15/DC2), dark-secret-revealed (20/DC2)
        - **Heretical:** forbidden-text (25/DC3), eldritch-symbol (20/DC2), void-whispers (30/DC3), reality-tear (35/DC4)
        - **Environmental:** extreme-cold (10/DC1), toxic-atmosphere (15/DC2), unstable-ground (12/DC1), lightning-storm (8/DC1)
        - **Corruption:** blight-exposure (20/DC2), corruption-touch (25/DC3), mutation-pain (30/DC3), blight-resonance (15/DC2)
    - **4 recovery rates:** Short Rest (WILL × 2), Long Rest (WILL × 5), Sanctuary (FULL_RESET), Milestone (25)
    - **Trauma reset:** passed = 75, failed = 50

### Application Layer — DTOs

- **`StressSourceDefinitionDto`** (`Application/DTOs/StressSourceDefinitionDto.cs`)
    - `sealed record` with private constructor enforcing factory pattern via `required init`
    - Properties: `Id` (required string), `BaseStress` (required int), `ResistDc` (required int), `Description` (string?)
    - All properties use `[JsonPropertyName]` attributes for explicit JSON key mapping
    - Comprehensive XML documentation with `<summary>`, `<remarks>`, `<value>`, `<list>`, `<seealso>`
    - Box comment header (═══ style), version 0.18.0e

- **`StressRecoveryConfigDto`** (`Application/DTOs/StressRecoveryConfigDto.cs`)
    - Two `sealed record` types in one file:
        - `StressRecoveryConfigDto` — 4 required `RecoveryRateDto` properties: `ShortRest`, `LongRest`, `Sanctuary`, `Milestone`
        - `RecoveryRateDto` — single required `Formula` string property
    - XML documentation includes recovery formula table and supported format list
    - Box comment header (═══ style), version 0.18.0e

- **`StressConfigurationDto`** (`Application/DTOs/StressConfigurationDto.cs`)
    - Three `sealed record` types in one file:
        - `StressConfigurationDto` — root DTO with `Version`, `StressSources`, `RecoveryRates`, `TraumaCheckReset`
        - `StressSourcesDto` — 6 array properties (Combat through Corruption) defaulting to `[]`
        - `TraumaResetConfigDto` — `Passed` and `Failed` integer properties
    - XML documentation includes complete configuration example and category descriptions
    - Box comment header (═══ style), version 0.18.0e

### Integration Tests

- **`StressSourcesSchemaTests`** (`Infrastructure.IntegrationTests/Schemas/StressSourcesSchemaTests.cs`) — 19 test methods
    - **SSS-001: Schema Structure** (2 tests):
        - Schema loads with correct title and definitions (StressSourceDefinition, RecoveryRate)
        - Existing `stress-sources.json` validates against schema
    - **SSS-002: Value Validation** (4 tests):
        - Rejects baseStress > 100 (150)
        - Rejects baseStress < 1 (0)
        - Rejects resistDc > 10 (15)
        - Rejects resistDc < 0 (-1)
    - **SSS-003: ID Pattern Validation** (2 tests):
        - Rejects uppercase/spaces ("Invalid Source ID")
        - Rejects IDs starting with number ("1-invalid-id")
    - **SSS-004: Required Fields** (4 tests):
        - Rejects missing version
        - Rejects missing recoveryRates
        - Rejects missing traumaCheckReset
        - Rejects missing baseStress on stress source
    - **SSS-005: Version Format** (1 test):
        - Rejects semantic versioning format ("1.0.0" vs "1.0")
    - **SSS-006: Additional Properties** (2 tests):
        - Rejects unknown root properties
        - Rejects unknown stress source properties
    - **SSS-007: Trauma Reset Values** (2 tests):
        - Rejects passed > 100 (150)
        - Rejects failed < 0 (-10)
    - **SSS-008: DTO Deserialization** (2 tests):
        - Full configuration deserializes to StressConfigurationDto with correct counts and values
        - Individual stress source properties deserialize correctly (enemy-fear-aura spot check)

### Glossary

- **`config/glossary.json`** — Added 3 glossary entries (sortOrder 84-86)
    - `stress-source-config`: JSON configuration file defining stress sources, recovery rates, and trauma reset values
    - `stress-source-definition-dto`: Sealed record DTO for individual stress source events
    - `stress-recovery-config-dto`: Sealed record DTO for recovery rate formulas

---

## Design Decisions

### Test Location: Infrastructure.IntegrationTests vs Application.UnitTests

The design specification places tests at `tests/RuneAndRust.Application.UnitTests/Schemas/StressSourcesSchemaTests.cs`. The codebase has 46+ existing schema validation test files in `tests/RuneAndRust.Infrastructure.IntegrationTests/Schemas/`. Codebase convention was followed — tests are in `Infrastructure.IntegrationTests/Schemas/`.

### Schema Validation Library: NJsonSchema vs Json.Schema

The design specification uses `Json.Schema` with `JsonSchema.FromText()` and `.Evaluate()` returning `result.IsValid`. The codebase uses `NJsonSchema` v11.0.2 with `JsonSchema.FromFileAsync()` and `.Validate()` returning an `ICollection<ValidationError>`. Codebase convention was followed — all tests use NJsonSchema API patterns.

### Test Setup Pattern: Async vs Synchronous

The design specification uses `[OneTimeSetUp]` with synchronous `File.ReadAllText` + `JsonSchema.FromText`. The codebase uses `[SetUp] async Task SetUp()` with `Path.GetFullPath()` + `JsonSchema.FromFileAsync()`. Codebase convention was followed.

### Test File Header: Copyright vs Box Comment

The design specification implies the `═══` box comment header used by domain layer files. Schema test files in `Infrastructure.IntegrationTests/Schemas/` use the `// ---` copyright header pattern with `<copyright>` and `<summary>` XML elements. Codebase convention was followed for the test file.

### DTO [JsonPropertyName] Attributes

The design specification explicitly includes `[JsonPropertyName]` attributes on every property. Older codebase DTOs rely on default case-insensitive matching without explicit attributes. The design specification was followed because the JSON keys (camelCase: `baseStress`, `resistDc`) need explicit mapping to PascalCase C# properties (`BaseStress`, `ResistDc`), and explicit attributes make the mapping self-documenting.

### DTO Type: Sealed Record with Required Init

The design specification defines DTOs as `sealed record` with `required init` properties. Older configuration DTOs in the codebase use `class` with `get; set;`. The design specification was followed, consistent with the v0.18.0a-d pattern where new code uses `sealed record` / `readonly record struct` types.

### Test Count Expansion

The design specification estimated ~3 tests (schema validation + DTO deserialization). The implementation includes 19 test methods across 8 test regions, consistent with v0.18.0a's pattern (66 tests vs ~4 estimated), v0.18.0b's pattern (84 tests vs ~3 estimated), and v0.18.0d's pattern (85 tests vs ~8 estimated). The expanded coverage includes boundary conditions for all numeric constraints, ID pattern validation, required field enforcement, additional property rejection, version format validation, and DTO deserialization verification.

---

## Dependencies

### Prerequisites

| Type | Phase | Usage |
| --- | --- | --- |
| `StressSource` enum | v0.18.0a | Category alignment (6 categories match 6 enum values) |
| `RestType` enum | v0.18.0a | Recovery rate alignment (4 rest types match 4 enum values) |
| `NJsonSchema` v11.0.2 | Infrastructure | Schema validation in integration tests |

### Provides to Future Phases

| Type | Phase | Usage |
| --- | --- | --- |
| `StressSourceDefinitionDto` | v0.18.0f | Lookup stress values by ID for StressService config integration |
| `StressRecoveryConfigDto` | v0.18.0f | Recovery formula retrieval for configuration-aware recovery |
| `TraumaResetConfigDto` | v0.18.0f | Reset value retrieval for configurable trauma check behavior |
| `StressConfigurationDto` | DI Container | Root configuration object for dependency injection registration |
| `stress-sources.schema.json` | CI/CD | Configuration validation in build pipeline |

---

## Logging Strategy

No runtime logging in v0.18.0e — all deliverables are configuration files, JSON schemas, and immutable DTOs with no executable code. The design specification documents recommended log event templates in section 8 for future use when configuration is loaded at application startup:

| Event | Level | Template |
| --- | --- | --- |
| Config Loaded | Information | `"Stress configuration loaded: {SourceCount} sources, version {Version}"` |
| Category Loaded | Debug | `"Loaded {Count} stress sources for category {Category}"` |
| Validation Error | Error | `"Stress configuration validation failed: {Error}"` |
| Source Lookup | Debug | `"Looking up stress source '{SourceId}' in category '{Category}'"` |
| Source Not Found | Warning | `"Stress source '{SourceId}' not found in category '{Category}'"` |

---

## Files Created

| Path | Description |
|------|-------------|
| `config/schemas/stress-sources.schema.json` | JSON Schema (Draft-07) for stress configuration validation |
| `config/stress-sources.json` | Stress sources configuration (24 sources, 4 recovery rates, trauma reset) |
| `src/Core/RuneAndRust.Application/DTOs/StressSourceDefinitionDto.cs` | Individual stress source DTO (sealed record) |
| `src/Core/RuneAndRust.Application/DTOs/StressRecoveryConfigDto.cs` | Recovery rate DTOs (StressRecoveryConfigDto + RecoveryRateDto) |
| `src/Core/RuneAndRust.Application/DTOs/StressConfigurationDto.cs` | Root configuration DTOs (StressConfigurationDto + StressSourcesDto + TraumaResetConfigDto) |
| `tests/RuneAndRust.Infrastructure.IntegrationTests/Schemas/StressSourcesSchemaTests.cs` | Schema validation and DTO deserialization tests (19 tests) |
| `changelogs/v0.18.0e-changelog.md` | This changelog |

## Files Modified

| Path | Description |
|------|-------------|
| `config/glossary.json` | Added 3 glossary entries (sortOrder 84-86) |
| `docs/design/v0.18.x/v0.18.0-scope-breakdown.md` | Checked off v0.18.0e acceptance criteria |
| `docs/design/v0.18.x/v0.18.0e-design-specification.md` | Checked off deliverable and acceptance criteria |

---

## Notes

- Total tests for v0.18.0e: 19 test methods in 1 test file (exceeding the ~3 estimate)
- All 19 new tests pass; all existing tests unaffected (0 regressions)
- Build succeeds with 0 errors, 0 warnings
- All new files follow established codebase patterns: `═══════` box comment headers for DTOs, copyright headers for integration tests, file-scoped namespaces, comprehensive XML documentation
- Schema tests placed in `Infrastructure.IntegrationTests/Schemas/` following codebase convention (46+ existing schema test files) rather than design spec's `Application.UnitTests/Schemas/`
- NJsonSchema v11.0.2 used for schema validation (codebase standard) rather than design spec's `Json.Schema`
- DTOs use `[JsonPropertyName]` attributes per design spec for explicit camelCase-to-PascalCase mapping
- Pre-existing glossary schema validation failure at term #88 remains (unrelated to v0.18.0e changes)
