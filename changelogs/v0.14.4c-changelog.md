# v0.14.4c Changelog - Terrain Schema Expansion

## Summary

Expanded the existing `terrain.schema.json` to add cover associations, visibility modifiers, hazard triggers, status effect application, terrain tags, and biome associations. This schema expansion enhances the terrain system to support tactical combat mechanics like cover bonuses, line-of-sight modifiers, and sophisticated hazard behaviors without code changes. The expansion is fully backward compatible with the existing 10 terrain definitions. This is the third schema in the v0.14.4 Environment Configuration Schemas series.

## Added

### Schema Definitions (3 Total)

| Definition | Description | Required Fields |
|------------|-------------|-----------------|
| `TerrainDefinition` | Expanded with new tactical properties | id, name, type |
| `HazardEffect` | Detailed hazard configuration with triggers | triggerType, damage, damageType |
| `SavingThrow` | Saving throw configuration for avoidance | attribute, dc |

### New TerrainDefinition Properties
| Property | Type | Constraint | Description |
|----------|------|------------|-------------|
| `coverLevel` | enum | None/Half/ThreeQuarters/Full | Defense cover provided |
| `visibilityModifier` | number | 0-1, default: 1.0 | LOS obscuring (0=opaque, 1=clear) |
| `providesConcealment` | boolean | default: false | Enables hiding/stealth |
| `hazardEffect` | HazardEffect | (optional) | Detailed hazard with triggers |
| `appliesStatusEffect` | string | Pattern validated | Status effect ID to apply |
| `statusEffectChance` | number | 0-1, default: 1.0 | Status effect probability |
| `tags` | array | (optional) | Categorical terrain tags |
| `biomeAssociations` | array | (optional) | Associated biome IDs |

### HazardEffect Properties
| Property | Type | Constraint | Description |
|----------|------|------------|-------------|
| `triggerType` | enum | OnEntry/PerTurn/OnExit | When hazard triggers |
| `damage` | string | Dice pattern required | Damage dice expression |
| `damageType` | string | Pattern validated (required) | Damage type ID |
| `savingThrow` | SavingThrow | (optional) | Avoidance check |
| `description` | string | (optional) | Flavor text on trigger |

### SavingThrow Properties
| Property | Type | Constraint | Description |
|----------|------|------------|-------------|
| `attribute` | enum | might/fortitude/will/wits/finesse | Attribute to roll |
| `dc` | integer | >= 1 (required) | Difficulty class |
| `halfOnSuccess` | boolean | default: true | Half damage on success |

### Cover Level Enumeration (4 values)
| Cover | Defense | Example Terrain |
|-------|---------|-----------------|
| `None` | +0 | Open floor, water, fire |
| `Half` | +2 | Low wall, rubble, crates |
| `ThreeQuarters` | +4 | Pillar, deep pit, corner |
| `Full` | +6/Blocked | Solid wall, closed door |

### Hazard Trigger Enumeration (3 values)
| Trigger | When Applied | Example |
|---------|--------------|---------|
| `OnEntry` | Stepping onto tile | Spike trap, fire |
| `PerTurn` | Each turn on tile | Lava, acid pool |
| `OnExit` | Leaving tile | Tar pit, web |

### Saving Throw Attribute Enumeration (5 values)
| Attribute | Use Case |
|-----------|----------|
| `might` | Physical hazards, brute force |
| `fortitude` | Poison, disease, temperatures |
| `will` | Mental effects, fear |
| `wits` | Noticing traps, reactions |
| `finesse` | Dodging, acrobatics |

### Unit Tests
- **[TerrainSchemaTests.cs](file:///Volumes/GitHub/github/southpawriter02/rune-rust/tests/RuneAndRust.Infrastructure.IntegrationTests/Schemas/TerrainSchemaTests.cs)** - 10 tests
  - `Schema_IsValidJsonSchemaDraft07` - Schema structure validation (3 definitions)
  - `TerrainJson_ValidatesAgainstExpandedSchema` - Backwards compatibility (10 terrain types)
  - `CoverLevel_InvalidEnum_FailsValidation` - Cover level enum (4 values)
  - `VisibilityModifier_OutOfRange_FailsValidation` - Visibility 0-1 range
  - `HazardEffectTriggerType_InvalidEnum_FailsValidation` - Trigger type enum (3 values)
  - `SavingThrowAttribute_InvalidEnum_FailsValidation` - Attribute enum (5 values)
  - `StatusEffectChance_OutOfRange_FailsValidation` - Probability 0-1 range
  - `SavingThrowDC_LessThanOne_FailsValidation` - DC >= 1 validation
  - `TerrainId_InvalidPattern_FailsValidation` - Kebab-case pattern
  - `HazardDamage_InvalidDicePattern_FailsValidation` - Dice expression pattern

## Changed

### Schema Files
- **[config/schemas/terrain.schema.json](file:///Volumes/GitHub/github/southpawriter02/rune-rust/config/schemas/terrain.schema.json)** - Expanded with new properties and definitions

## Files Changed

| File | Change Type |
|------|-------------|
| `config/schemas/terrain.schema.json` | Expanded |
| `tests/.../Schemas/TerrainSchemaTests.cs` | Added |
| `changelogs/v0.14.4c-changelog.md` | Added |

## Test Results

```
Test summary: total: 10, failed: 0, succeeded: 10, skipped: 0
Build succeeded with 0 errors
```

## Backward Compatibility

The schema expansion is **fully backward compatible**. All 10 existing terrain types validate without modification:
- `normal-floor` - Stone Floor (Normal)
- `rubble` - Rubble (Difficult)
- `shallow-water` - Shallow Water (Difficult)
- `mud` - Thick Mud (Difficult)
- `pit` - Pit (Impassable)
- `wall` - Wall (Impassable, blocksLOS)
- `fire` - Fire (Hazardous, 1d6 fire)
- `acid-pool` - Acid Pool (Hazardous, 1d4 acid)
- `spike-trap` - Spike Trap (Hazardous, 1d8 piercing)
- `lava` - Lava (Hazardous, 2d6 fire)

## Example Enhanced Terrain

```json
{
    "id": "fire",
    "name": "Fire",
    "type": "Hazardous",
    "movementCostMultiplier": 1.0,
    "displayChar": "▲",
    "description": "Flames - 1d6 fire damage on entry",
    "coverLevel": "None",
    "visibilityModifier": 0.8,
    "providesConcealment": false,
    "hazardEffect": {
        "triggerType": "OnEntry",
        "damage": "1d6",
        "damageType": "fire",
        "savingThrow": {
            "attribute": "finesse",
            "dc": 12,
            "halfOnSuccess": true
        },
        "description": "The flames sear your flesh."
    },
    "appliesStatusEffect": "burning",
    "statusEffectChance": 0.5,
    "tags": ["hazardous", "fire", "light-source", "warm"],
    "biomeAssociations": ["volcanic", "dungeon"]
}
```

## Cover Level System

```
┌────────────────────────────────────────────────────────────────┐
│  Cover Level    │ Defense │ Visual Representation              │
│  ───────────────┼─────────┼─────────────────────────────────── │
│  None           │   +0    │  ░ ░ ░ (open ground)               │
│  Half           │   +2    │  ▄▄▄░░ (low wall, crates)          │
│  ThreeQuarters  │   +4    │  ██▄░░ (pillar, corner)            │
│  Full           │   +6    │  █████ (solid wall)                │
└────────────────────────────────────────────────────────────────┘
```

## Hazard Trigger Timing

```
┌─────────────────────────────────────────────────────────────────┐
│  Turn 1                 Turn 2                 Turn 3           │
│  ┌───────────────┐     ┌───────────────┐     ┌───────────────┐ │
│  │ Enter Lava    │     │ Stand in Lava │     │ Exit Lava     │ │
│  │   ▼           │     │   ▼           │     │   ▼           │ │
│  │ [PerTurn]     │     │ [PerTurn]     │     │ No damage     │ │
│  │  2d6 fire     │     │  2d6 fire     │     │ (on exit)     │ │
│  └───────────────┘     └───────────────┘     └───────────────┘ │
└─────────────────────────────────────────────────────────────────┘
```

## Modding Scenarios Enabled

After this implementation, modders can:
- Define cover levels for tactical combat
- Configure visibility modifiers for LOS mechanics
- Enable concealment for stealth gameplay
- Create sophisticated hazards with saving throws
- Apply status effects from terrain (burning, poisoned)
- Tag terrain for filtering and queries
- Associate terrain with biomes for level generation

---

*Third entry in v0.14.4 Environment Configuration Schemas series. See also: v0.14.4a (Biome Schema), v0.14.4b (Room Type Schema), v0.14.4d (Interactive Object Schema).*
