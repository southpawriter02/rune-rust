# Changelog: v0.4.1d - The Grid

**Release Date:** 2025-12-30

---

## Summary

v0.4.1d implements the **Grid-Based Specialization UI Rewrite**, replacing v0.4.1c's two-panel modal layout with a cleaner 4-column tier grid architecture. This release introduces the **ViewModel Builder Pattern** for better separation of concerns, extracting ViewModel construction logic from the GameService into a dedicated `ISpecializationGridViewModelBuilder`. Key architectural changes include: replacing immutable records with a mutable `SpecializationGridViewModel` class, renaming `NodeStatus.InsufficientPP` to `NodeStatus.Affordable`, reordering enum values for semantic priority, and creating an `ISpecializationController` interface to break circular dependencies between Engine and Terminal layers. The implementation touches the **Core Layer** (ViewModels, Enums, Interfaces), **Engine Layer** (ViewModelBuilder), **Terminal Layer** (Rendering, Controllers), and **Test Layer** (43 new tests replacing 102 v0.4.1c tests with equivalent coverage).

---

## Breaking Changes

### NodeStatus Enum Reordering

**Previous (v0.4.1c):**
```csharp
public enum NodeStatus
{
    Locked = 0,
    InsufficientPP = 1,
    Available = 2,
    Unlocked = 3
}
```

**New (v0.4.1d):**
```csharp
public enum NodeStatus
{
    Locked = 0,      // Prerequisites not met
    Available = 1,   // Can purchase now (prereqs met, PP sufficient)
    Unlocked = 2,    // Already purchased
    Affordable = 3   // Prerequisites met but insufficient PP (renamed from InsufficientPP)
}
```

**Rationale:**
- `InsufficientPP` renamed to `Affordable` for clearer semantics ("you can afford to save up for this")
- Reordered so `Available` comes before `Unlocked` (semantic priority: action states before completion states)

---

## New Files Created

### Core Layer

| File | Purpose |
|------|---------|
| `RuneAndRust.Core/ViewModels/NodeViewModel.cs` | Node display record with `CostDisplay` and `StatusMarkup` computed properties |
| `RuneAndRust.Core/ViewModels/SpecializationGridViewModel.cs` | Mutable grid ViewModel with `NodesByTier` dictionary and selection state |
| `RuneAndRust.Core/Interfaces/ISpecializationGridRenderer.cs` | Grid renderer interface with single `Render(SpecializationGridViewModel)` method |
| `RuneAndRust.Core/Interfaces/ISpecializationGridViewModelBuilder.cs` | Builder interface with `BuildAsync` and `RefreshAsync` methods |
| `RuneAndRust.Core/Interfaces/ISpecializationController.cs` | Controller interface to break Engine-Terminal circular dependency |

### Engine Layer

| File | Purpose |
|------|---------|
| `RuneAndRust.Engine/ViewModels/SpecializationGridViewModelBuilder.cs` | Builder implementation extracting ViewModel construction from GameService |

### Terminal Layer

| File | Purpose |
|------|---------|
| `RuneAndRust.Terminal/Rendering/SpecializationGridRenderer.cs` | 4-column tier table renderer using Spectre.Console Tables |

### Test Layer

| File | Purpose |
|------|---------|
| `RuneAndRust.Tests/Terminal/SpecializationControllerTests.cs` | 17 unit tests for controller navigation, unlocking, and state management |
| `RuneAndRust.Tests/Engine/SpecializationGridViewModelBuilderTests.cs` | 16 unit tests for builder logic, status computation, and refresh behavior |
| `RuneAndRust.Tests/Terminal/SpecializationGridRendererTests.cs` | 10 unit tests for renderer edge cases and markup handling |

---

## Files Modified

| File | Change |
|------|--------|
| `RuneAndRust.Core/Enums/NodeStatus.cs` | Reordered values: Locked=0, Available=1, Unlocked=2, Affordable=3; renamed `InsufficientPP` to `Affordable` |
| `RuneAndRust.Terminal/Controllers/SpecializationController.cs` | **REWRITTEN** to implement `ISpecializationController` with builder dependency and tier navigation |
| `RuneAndRust.Engine/Services/GameService.cs` | Removed ~200 lines of inline ViewModel building; changed dependencies to interfaces |
| `RuneAndRust.Terminal/Program.cs` | Updated DI registrations for v0.4.1d services |
| `RuneAndRust.Tests/Core/NodeStatusTests.cs` | Updated for new enum values (Affordable replaces InsufficientPP, new ordering) |

---

## Files Deleted (v0.4.1c Artifacts)

| File | Reason |
|------|--------|
| `RuneAndRust.Core/ViewModels/SpecializationViewModel.cs` | Replaced by `SpecializationGridViewModel` + `NodeViewModel` |
| `RuneAndRust.Core/Enums/SpecializationViewMode.cs` | No panel switching in grid layout (single unified view) |
| `RuneAndRust.Core/Interfaces/ISpecializationScreenRenderer.cs` | Replaced by `ISpecializationGridRenderer` |
| `RuneAndRust.Terminal/Rendering/SpecializationScreenRenderer.cs` | Replaced by `SpecializationGridRenderer` |
| `RuneAndRust.Tests/Core/SpecializationViewModelTests.cs` | Obsolete - tested deleted ViewModel records |
| `RuneAndRust.Tests/Core/SpecializationViewModeTests.cs` | Obsolete - tested deleted enum |
| `RuneAndRust.Tests/Terminal/SpecializationScreenRendererTests.cs` | Replaced by `SpecializationGridRendererTests` |

---

## Code Implementation Details

### Enums

#### NodeStatus (4 values - MODIFIED)
```csharp
public enum NodeStatus
{
    Locked = 0,      // Prerequisites not met
    Available = 1,   // Can purchase now
    Unlocked = 2,    // Already purchased
    Affordable = 3   // Prerequisites met but insufficient PP
}
```

**Behavior:**
- Default value: `Locked` (0)
- `InsufficientPP` renamed to `Affordable` for clearer UX semantics
- Reordered for semantic priority (action-oriented states first)
- Used for color-coded rendering in UI:
  - `Unlocked`: `[green](INSCRIBED)[/]`
  - `Available`: `[cyan](AVAILABLE)[/]`
  - `Affordable`: `[yellow](SAVE UP)[/]`
  - `Locked`: `[red](LOCKED)[/]`

### ViewModels

#### NodeViewModel (Record)
```csharp
public record NodeViewModel(
    Guid NodeId,
    Guid AbilityId,
    string Name,
    string Description,
    int Tier,
    int CostPP,
    NodeStatus Status,
    int PositionX,
    int PositionY,
    bool IsCapstone,
    IReadOnlyList<Guid> ParentNodeIds)
{
    public string CostDisplay => Status == NodeStatus.Unlocked ? "-" : $"{CostPP} PP";
    public string StatusMarkup => Status switch
    {
        NodeStatus.Unlocked => "[green](INSCRIBED)[/]",
        NodeStatus.Available => "[cyan](AVAILABLE)[/]",
        NodeStatus.Affordable => "[yellow](SAVE UP)[/]",
        NodeStatus.Locked => "[red](LOCKED)[/]",
        _ => "[grey](UNKNOWN)[/]"
    };
}
```

**Key Design Decisions:**
- Uses parentheses `()` instead of brackets `[]` in display values to avoid Spectre.Console markup parsing issues
- Computed properties for UI display (`CostDisplay`, `StatusMarkup`)
- Immutable record for data integrity

#### SpecializationGridViewModel (Mutable Class)
```csharp
public class SpecializationGridViewModel
{
    public Guid SpecializationId { get; init; }
    public required string SpecializationName { get; init; }
    public string? SpecializationDescription { get; init; }
    public required int ProgressionPoints { get; init; }
    public required string CharacterName { get; init; }
    public required IReadOnlyDictionary<int, IReadOnlyList<NodeViewModel>> NodesByTier { get; init; }
    public required IReadOnlyList<NodeViewModel> AllNodes { get; init; }

    // Mutable state
    public int SelectedNodeIndex { get; set; }
    public int CurrentSpecIndex { get; set; }
    public int TotalSpecCount { get; set; }
    public string? FeedbackMessage { get; set; }
    public bool FeedbackIsSuccess { get; set; }

    // Computed properties
    public int TotalNodes => AllNodes.Count;
    public int UnlockedNodes => AllNodes.Count(n => n.Status == NodeStatus.Unlocked);
    public NodeViewModel? SelectedNode =>
        AllNodes.Count > 0 && SelectedNodeIndex < AllNodes.Count
            ? AllNodes[SelectedNodeIndex]
            : null;
}
```

**Key Design Decisions:**
- Mutable class (not record) to allow UI state updates without reconstruction
- `NodesByTier` dictionary for 4-column tier layout rendering
- `SelectedNodeIndex` and `FeedbackMessage` are mutable for controller updates
- `init` accessors for data properties that shouldn't change after construction

### Interfaces

#### ISpecializationController
```csharp
public interface ISpecializationController
{
    SpecializationGridViewModel? CurrentViewModel { get; }
    bool IsInitialized { get; }
    Task InitializeAsync(Character character, Guid specializationId);
    Task<GamePhase> HandleInputAsync(ConsoleKey key);
    void Reset();
}
```

**Purpose:** Break circular dependency between Engine (needs controller) and Terminal (implements controller).

#### ISpecializationGridViewModelBuilder
```csharp
public interface ISpecializationGridViewModelBuilder
{
    Task<SpecializationGridViewModel> BuildAsync(Character character, Guid specializationId);
    Task<SpecializationGridViewModel> RefreshAsync(SpecializationGridViewModel existing, Character character);
}
```

**Purpose:** Extract ViewModel construction from GameService for testability and separation of concerns.

#### ISpecializationGridRenderer
```csharp
public interface ISpecializationGridRenderer
{
    void Render(SpecializationGridViewModel viewModel);
}
```

**Purpose:** Render the 4-column tier grid using Spectre.Console.

### Services

#### SpecializationGridViewModelBuilder
**Key Methods:**
```csharp
public async Task<SpecializationGridViewModel> BuildAsync(Character character, Guid specializationId)
public async Task<SpecializationGridViewModel> RefreshAsync(SpecializationGridViewModel existing, Character character)
```

**Behaviors:**
- Loads specialization and nodes from `ISpecializationRepository`
- Computes `NodeStatus` for each node based on:
  1. Is node already unlocked? → `Unlocked`
  2. Are prerequisites met? (via `ISpecializationService.ValidatePrerequisitesAsync`)
     - No → `Locked`
     - Yes, and sufficient PP → `Available`
     - Yes, but insufficient PP → `Affordable`
- Groups nodes by tier for UI rendering
- `RefreshAsync` preserves `SelectedNodeIndex` (clamped to valid range) and `FeedbackMessage`

#### SpecializationController
**Key Methods:**
```csharp
public async Task InitializeAsync(Character character, Guid specializationId)
public async Task<GamePhase> HandleInputAsync(ConsoleKey key)
public void Reset()
```

**Behaviors:**
- **Initialization:** Stores character reference, builds ViewModel via builder
- **Navigation:**
  - Up/Down arrows: Navigate nodes within tier (vertical)
  - Left/Right arrows: Navigate between tiers (horizontal) - *conceptual, maps to AllNodes order*
  - Tab: Cycle through multiple specializations (if character has more than one)
- **Unlock Actions:** Enter/Spacebar triggers unlock based on selected node status:
  - `Available`: Calls `ISpecializationService.UnlockNodeAsync`, refreshes ViewModel
  - `Unlocked`: Sets feedback "This rune is already inscribed"
  - `Affordable`: Sets feedback "Insufficient PP - need X more"
  - `Locked`: Sets feedback "Prerequisites not met"
- **Exit:** Escape/Q returns to Exploration phase, resets controller

#### SpecializationGridRenderer
**Key Methods:**
```csharp
public void Render(SpecializationGridViewModel viewModel)
```

**Layout:**
```
+----------------------------------------------------------------------+
| ✦ IRON WARDEN (1/3) ✦                                                |
+----------------------------------------------------------------------+
| TestChar    Progression Points: (15)    Progress: 3/12               |
+----------+----------+----------+----------+
| TIER 1   | TIER 2   | TIER 3   | CAPSTONE |
+----------+----------+----------+----------+
| ▶ ◆ Node |   ○ Node |   × Node |   × Node |
|   ◆ Node |   ○ Node |   × Node |          |
|   ○ Node |          |          |          |
+----------+----------+----------+----------+
+----------------------------------------------------------------------+
| ◈ Shield Bash (Tier 1)                                               |
| Deal damage with shield.                                             |
| Cost: 1 PP  |  Status: (AVAILABLE)                                   |
+----------------------------------------------------------------------+
↑↓ Navigate  │  ←→ Tier  │  Enter: Inscribe  │  Tab: Switch Spec  │  Esc: Return
```

**Key Implementation Notes:**
- Uses Spectre.Console `Table` for tier columns
- Node symbols: `◆` (unlocked), `○` (available), `~` (affordable), `×` (locked)
- Selection indicator: `▶` prefix on selected node
- Feedback message displayed with color (green for success, red for error)
- Uses parentheses `()` for numeric displays to avoid Spectre.Console markup conflicts

---

## Logging Matrix

### SpecializationGridViewModelBuilder

| Event | Level | Template |
|-------|-------|----------|
| BuildAsync entry | Debug | `"[SpecGridBuilder] Building ViewModel for character {CharId}, spec {SpecId}"` |
| Specialization not found | Warning | `"[SpecGridBuilder] Specialization {SpecId} not found"` |
| Node status computed | Trace | `"[SpecGridBuilder] Node {NodeId}: Status={Status}"` |
| BuildAsync complete | Debug | `"[SpecGridBuilder] Built ViewModel with {NodeCount} nodes in {TierCount} tiers"` |
| RefreshAsync entry | Debug | `"[SpecGridBuilder] Refreshing ViewModel for spec {SpecId}"` |
| RefreshAsync complete | Debug | `"[SpecGridBuilder] Refresh complete, preserved selection at index {Index}"` |

### SpecializationController

| Event | Level | Template |
|-------|-------|----------|
| InitializeAsync entry | Debug | `"[SpecController] Initializing for character {CharName}, spec {SpecId}"` |
| InitializeAsync complete | Debug | `"[SpecController] Initialized with {NodeCount} nodes"` |
| HandleInputAsync entry | Trace | `"[SpecController] HandleInputAsync: Key={Key}"` |
| Exit requested | Debug | `"[SpecController] Exit requested, returning to Exploration"` |
| Navigation up | Trace | `"[SpecController] Navigate up: Index {OldIdx} -> {NewIdx}"` |
| Navigation down | Trace | `"[SpecController] Navigate down: Index {OldIdx} -> {NewIdx}"` |
| Tab cycle | Debug | `"[SpecController] Tab cycle: Spec {OldIdx} -> {NewIdx}"` |
| Unlock attempt | Debug | `"[SpecController] Attempting unlock for node {NodeId}"` |
| Unlock success | Information | `"[SpecController] Node unlocked: {NodeName} (Tier {Tier})"` |
| Unlock blocked | Debug | `"[SpecController] Unlock blocked: {Reason}"` |
| State reset | Debug | `"[SpecController] State reset"` |

### SpecializationGridRenderer

| Event | Level | Template |
|-------|-------|----------|
| Render entry | Debug | `"[SpecGridRenderer] Rendering grid: {SpecName}, {NodeCount} nodes, selected={SelectedIdx}"` |
| Render complete | Trace | `"[SpecGridRenderer] Render complete"` |
| Empty nodes | Debug | `"[SpecGridRenderer] Rendering empty grid (no nodes)"` |

---

## Test Coverage

**Total New Tests:** 43 tests | **Passed:** 43 | **Failed:** 0 | **Duration:** ~3s

### Summary by Test Class

| Test Class | Test Count | Focus Area |
|------------|-----------|------------|
| SpecializationControllerTests | 17 | Controller initialization, navigation, unlock operations, exit handling |
| SpecializationGridViewModelBuilderTests | 16 | Build logic, status computation, tier grouping, refresh behavior |
| SpecializationGridRendererTests | 10 | Rendering edge cases, empty states, feedback display |

### Complete Test Inventory

#### SpecializationControllerTests (17 tests)

| Test Name | Description |
|-----------|-------------|
| `IsInitialized_WhenNotInitialized_ReturnsFalse` | Validates initial state is not initialized |
| `InitializeAsync_SetsIsInitializedToTrue` | Initialize sets IsInitialized flag |
| `InitializeAsync_SetsCurrentViewModel` | Initialize stores ViewModel reference |
| `HandleInputAsync_Escape_ReturnsExploration` | Escape key exits to Exploration phase |
| `HandleInputAsync_Q_ReturnsExploration` | Q key exits to Exploration phase |
| `HandleInputAsync_Escape_ResetsController` | Escape clears ViewModel and resets state |
| `HandleInputAsync_DownArrow_StaysInSpecializationMenu` | Down arrow stays in menu |
| `HandleInputAsync_UpArrow_StaysInSpecializationMenu` | Up arrow stays in menu |
| `HandleInputAsync_LeftArrow_StaysInSpecializationMenu` | Left arrow stays in menu |
| `HandleInputAsync_RightArrow_StaysInSpecializationMenu` | Right arrow stays in menu |
| `HandleInputAsync_Enter_OnAvailableNode_CallsUnlockNodeAsync` | Enter on Available calls unlock |
| `HandleInputAsync_Spacebar_OnAvailableNode_CallsUnlockNodeAsync` | Spacebar on Available calls unlock |
| `HandleInputAsync_Enter_OnLockedNode_DoesNotCallUnlockNodeAsync` | Enter on Locked shows error |
| `HandleInputAsync_Enter_OnUnlockedNode_DoesNotCallUnlockNodeAsync` | Enter on Unlocked shows "already inscribed" |
| `HandleInputAsync_Enter_OnAffordableNode_ShowsInsufficientPP` | Enter on Affordable shows PP needed |
| `Reset_ClearsCurrentViewModel` | Reset clears ViewModel and IsInitialized |
| `HandleInputAsync_WhenNotInitialized_ReturnsExploration` | Uninitialized controller returns Exploration |

#### SpecializationGridViewModelBuilderTests (16 tests)

| Test Name | Description |
|-----------|-------------|
| `BuildAsync_ReturnsViewModelWithCorrectSpecName` | ViewModel has correct specialization name |
| `BuildAsync_ReturnsViewModelWithCorrectCharacterName` | ViewModel has correct character name |
| `BuildAsync_ReturnsViewModelWithCorrectProgressionPoints` | ViewModel has correct PP from character |
| `BuildAsync_GroupsNodesByTier` | Nodes grouped into tier dictionary |
| `BuildAsync_SetsCorrectTotalNodeCount` | TotalNodes computed correctly |
| `BuildAsync_SetsCorrectSpecIndexForMultiSpec` | CurrentSpecIndex set for multi-spec characters |
| `BuildAsync_ThrowsWhenSpecializationNotFound` | ArgumentException when spec not found |
| `BuildAsync_MarksTier4NodesAsCapstone` | Tier 4 nodes have IsCapstone=true |
| `BuildAsync_UnlockedNode_HasUnlockedStatus` | Nodes in SpecializationProgress are Unlocked |
| `BuildAsync_LockedNode_HasLockedStatus` | Nodes with failed prereqs are Locked |
| `BuildAsync_AvailableNode_HasAvailableStatus` | Nodes with prereqs and PP are Available |
| `BuildAsync_AffordableNode_HasAffordableStatus` | Nodes with prereqs but no PP are Affordable |
| `RefreshAsync_PreservesSelectedNodeIndex` | Refresh keeps selection position |
| `RefreshAsync_ClampsSelectedNodeIndex_WhenOutOfBounds` | Refresh clamps invalid selection |
| `RefreshAsync_PreservesFeedbackMessage` | Refresh preserves feedback text |
| `BuildAsync_WithNoNodes_ReturnsEmptyNodesByTier` | Empty spec handled gracefully |

#### SpecializationGridRendererTests (10 tests)

| Test Name | Description |
|-----------|-------------|
| `Constructor_WithValidDependencies_CreatesInstance` | Constructor creates renderer |
| `Render_WithValidViewModel_DoesNotThrow` | Render with valid VM succeeds |
| `Render_WithEmptyNodes_DoesNotThrow` | Render with empty nodes succeeds |
| `Render_WithNullSelectedNode_DoesNotThrow` | Render with no selection succeeds |
| `Render_WithFeedbackMessage_DoesNotThrow` | Render with success feedback succeeds |
| `Render_WithErrorFeedbackMessage_DoesNotThrow` | Render with error feedback succeeds |
| `Render_WithMultiSpec_DoesNotThrow` | Render with multi-spec indicator succeeds |
| `Render_WithLongNodeName_DoesNotThrow` | Long names truncated correctly |
| `Render_WithAllNodeStatuses_DoesNotThrow` | All status colors render correctly |
| `Render_WithCapstoneNode_DoesNotThrow` | Capstone tier renders correctly |

#### NodeStatusTests (Updated - 10 tests)

| Test Name | Description |
|-----------|-------------|
| `NodeStatus_ShouldHaveExactlyFourValues` | Enum has exactly 4 values |
| `NodeStatus_ShouldContain_Locked` | Locked value exists |
| `NodeStatus_ShouldContain_Available` | Available value exists (now value 1) |
| `NodeStatus_ShouldContain_Unlocked` | Unlocked value exists (now value 2) |
| `NodeStatus_ShouldContain_Affordable` | Affordable value exists (renamed from InsufficientPP) |
| `NodeStatus_DefaultValue_ShouldBeLocked` | Default is Locked (0) |
| `NodeStatus_ToString_ReturnsExpectedName` | ToString returns correct names |
| `NodeStatus_FromInt_ReturnsCorrectStatus` | Int cast returns correct values |
| `NodeStatus_Locked_HasValue0` | Locked = 0 |
| `NodeStatus_Available_HasValue1` | Available = 1 |

---

## DI Registration

**File:** `RuneAndRust.Terminal/Program.cs`

```csharp
// Register Specialization Grid UI (v0.4.1d - The Grid)
services.AddSingleton<ISpecializationGridRenderer, SpecializationGridRenderer>();
services.AddScoped<ISpecializationGridViewModelBuilder, SpecializationGridViewModelBuilder>();
services.AddScoped<ISpecializationController, SpecializationController>();
```

**Rationale:**
- `ISpecializationGridRenderer` registered as **Singleton** - stateless rendering service
- `ISpecializationGridViewModelBuilder` registered as **Scoped** - may cache repository data within scope
- `ISpecializationController` registered as **Scoped** - maintains navigation state within service scope

**Removed Registrations (v0.4.1c):**
- `ISpecializationScreenRenderer` (replaced by `ISpecializationGridRenderer`)
- `SpecializationController` concrete type (now registered via interface)

---

## Architecture Changes

### Layer Dependency Resolution

**Problem:** v0.4.1c had Engine referencing Terminal's `SpecializationController` directly, creating a circular dependency risk.

**Solution:** Introduced `ISpecializationController` in Core layer:

```
Before (v0.4.1c):
Engine/GameService.cs → Terminal/Controllers/SpecializationController.cs (direct reference)

After (v0.4.1d):
Core/Interfaces/ISpecializationController.cs ← Engine/GameService.cs (interface dependency)
                                             ← Terminal/Controllers/SpecializationController.cs (implements)
```

### ViewModel Construction Extraction

**Problem:** v0.4.1c built ViewModels inline in GameService (~200 lines), mixing orchestration with construction logic.

**Solution:** Extracted to dedicated `ISpecializationGridViewModelBuilder`:

```
Before (v0.4.1c):
GameService.BuildSpecializationViewModelAsync() - inline construction

After (v0.4.1d):
ISpecializationGridViewModelBuilder.BuildAsync() - dedicated service
ISpecializationGridViewModelBuilder.RefreshAsync() - preserves UI state
```

### Markup Safety

**Problem:** Spectre.Console interprets `[text]` as markup tags, causing runtime errors when displaying values like `[15]` for PP.

**Solution:** Changed display format from brackets to parentheses:

```csharp
// Before (v0.4.1c) - BROKEN
$"[{vm.ProgressionPoints}]"  // Interpreted as markup tag

// After (v0.4.1d) - SAFE
$"({vm.ProgressionPoints})"  // Literal parentheses
```

Applied to:
- `NodeViewModel.StatusMarkup`: `[INSCRIBED]` → `(INSCRIBED)`
- `SpecializationGridRenderer`: PP display, tab indicator

---

## Verification Results

### Build Output
```
Build succeeded.
    0 Error(s)
    77 Warning(s)

Time Elapsed 00:00:03.45
```

**Note:** 77 warnings are pre-existing (nullable reference warnings, XML doc warnings) and unrelated to this release.

### Test Output
```
Starting test execution, please wait...
A total of 1 test files matched the specified pattern.

Passed!  - Failed:     0, Passed:  3468, Skipped:     0, Total:  3468, Duration: 8 s
```

**Note:** Total test count decreased from 3527 (v0.4.1c) to 3468 due to:
- Removed: 102 v0.4.1c tests (SpecializationViewModelTests, SpecializationViewModeTests, SpecializationScreenRendererTests, old SpecializationControllerTests)
- Added: 43 v0.4.1d tests (new controller, builder, renderer tests)
- Net change: -59 tests (equivalent coverage with more focused tests)

---

## Directory Structure After Release

```
RuneAndRust/
├── RuneAndRust.Core/
│   ├── Enums/
│   │   ├── GamePhase.cs
│   │   └── NodeStatus.cs [MODIFIED - reordered, renamed Affordable]
│   ├── Interfaces/
│   │   ├── ISpecializationController.cs [NEW - layer separation interface]
│   │   ├── ISpecializationGridRenderer.cs [NEW - replaces ISpecializationScreenRenderer]
│   │   ├── ISpecializationGridViewModelBuilder.cs [NEW - builder interface]
│   │   ├── ISpecializationRepository.cs
│   │   └── ISpecializationService.cs
│   └── ViewModels/
│       ├── NodeViewModel.cs [NEW - node display record]
│       └── SpecializationGridViewModel.cs [NEW - mutable grid ViewModel]
├── RuneAndRust.Engine/
│   ├── Services/
│   │   └── GameService.cs [MODIFIED - uses interfaces, removed inline building]
│   └── ViewModels/
│       └── SpecializationGridViewModelBuilder.cs [NEW - builder implementation]
├── RuneAndRust.Terminal/
│   ├── Controllers/
│   │   └── SpecializationController.cs [REWRITTEN - implements ISpecializationController]
│   ├── Rendering/
│   │   └── SpecializationGridRenderer.cs [NEW - 4-column tier renderer]
│   └── Program.cs [MODIFIED - updated DI registrations]
└── RuneAndRust.Tests/
    ├── Core/
    │   └── NodeStatusTests.cs [MODIFIED - updated for new enum values]
    ├── Engine/
    │   └── SpecializationGridViewModelBuilderTests.cs [NEW - 16 tests]
    └── Terminal/
        ├── SpecializationControllerTests.cs [REWRITTEN - 17 tests]
        └── SpecializationGridRendererTests.cs [NEW - 10 tests]
```

**Deleted Files:**
- `RuneAndRust.Core/ViewModels/SpecializationViewModel.cs`
- `RuneAndRust.Core/Enums/SpecializationViewMode.cs`
- `RuneAndRust.Core/Interfaces/ISpecializationScreenRenderer.cs`
- `RuneAndRust.Terminal/Rendering/SpecializationScreenRenderer.cs`
- `RuneAndRust.Tests/Core/SpecializationViewModelTests.cs`
- `RuneAndRust.Tests/Core/SpecializationViewModeTests.cs`
- `RuneAndRust.Tests/Terminal/SpecializationScreenRendererTests.cs`

---

## Running Tests

### Full Test Suite
```bash
dotnet test
```

### Specialization Grid Tests
```bash
# All v0.4.1d specialization tests (43 tests)
dotnet test --filter "FullyQualifiedName~SpecializationGrid | FullyQualifiedName~SpecializationController"

# Builder tests only (16 tests)
dotnet test --filter "FullyQualifiedName~SpecializationGridViewModelBuilderTests"

# Controller tests only (17 tests)
dotnet test --filter "FullyQualifiedName~SpecializationControllerTests"

# Renderer tests only (10 tests)
dotnet test --filter "FullyQualifiedName~SpecializationGridRendererTests"

# NodeStatus enum tests (10 tests)
dotnet test --filter "FullyQualifiedName~NodeStatusTests"
```

---

## Migration Guide

### For Code Depending on NodeStatus

```csharp
// Before (v0.4.1c)
if (status == NodeStatus.InsufficientPP) { ... }

// After (v0.4.1d)
if (status == NodeStatus.Affordable) { ... }
```

### For Code Using Enum Values

```csharp
// Before (v0.4.1c)
// Locked=0, InsufficientPP=1, Available=2, Unlocked=3

// After (v0.4.1d)
// Locked=0, Available=1, Unlocked=2, Affordable=3
```

### For Code Referencing Old Interfaces

```csharp
// Before (v0.4.1c)
ISpecializationScreenRenderer renderer;
SpecializationController controller;

// After (v0.4.1d)
ISpecializationGridRenderer renderer;
ISpecializationController controller;
```

---

## Next Steps

Planned for **v0.4.1e - The Grimoire** (Ability Catalog):
- Implement ability detail panel with full ability information
- Add tooltip rendering for node hover
- Create ability comparison view for unlocked vs. available nodes
- Add keyboard shortcut for "quick unlock" (hold Shift + Enter to skip confirmation)

Planned for **v0.4.2 - The Forge** (Equipment Specialization):
- Equipment specialization trees (weapon/armor paths)
- Passive bonuses from unlocked nodes
- Synergy detection between active and equipment specializations
- UI badges for active synergies in specialization grid

---

**Document Version:** 1.0
**Generated:** 2025-12-30
**Implementation Reference:** v0.4.1d "The Grid"
