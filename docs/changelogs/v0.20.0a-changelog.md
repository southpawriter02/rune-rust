# v0.20.0a Changelog — Legacy Class Removal & Migration Infrastructure

**Version**: 0.20.0a  
**Date**: 2026-02-09  
**Category**: Domain / Application Layer — Migration System

---

## Summary

Removes all placeholder/generic class definitions and establishes the character migration infrastructure for transitioning existing characters from legacy classes to Aethelgard-specific archetypes and specializations. This is a foundational cleanup release that prepares the system for specialization implementations in v0.20.1–v0.20.8.

---

## Added

### Domain Layer — Enumerations

| File                       | Purpose                                                                                  |
| -------------------------- | ---------------------------------------------------------------------------------------- |
| `Enums/LegacyClassId.cs`   | Identifies 6 deprecated generic classes (Rogue, Fighter, Mage, Healer, Scholar, Crafter) |
| `Enums/MigrationStatus.cs` | Tracks migration lifecycle (Pending, InProgress, Completed, Failed)                      |

### Domain Layer — Value Objects

| File                                         | Purpose                                                                           |
| -------------------------------------------- | --------------------------------------------------------------------------------- |
| `ValueObjects/LegacyClassMapping.cs`         | Maps legacy class → target archetype with suggested specializations               |
| `ValueObjects/MigrationResult.cs`            | Outcome record for completed migrations (PP refunds, preserved/removed abilities) |
| `ValueObjects/AbilitySlotPreparation.cs`     | Tiered ability slot configuration (3+3+2+1 = 9 slots, 35 PP max)                  |
| `ValueObjects/SpecializationPrerequisite.cs` | Validation rules for specialization selection (archetype, PP cost, dependencies)  |

### Domain Layer — Entities

| File                             | Purpose                                                        |
| -------------------------------- | -------------------------------------------------------------- |
| `Entities/CharacterMigration.cs` | State machine tracking migration lifecycle with domain methods |
| `Entities/MigrationLog.cs`       | Immutable audit trail entries for all migration actions        |

### Application Layer — Interfaces

| File                                               | Purpose                                             |
| -------------------------------------------------- | --------------------------------------------------- |
| `Interfaces/ILegacyClassDetectionService.cs`       | Identifies characters with legacy class assignments |
| `Interfaces/ICharacterMigrationService.cs`         | Orchestrates the full migration workflow            |
| `Interfaces/ISpecializationPrerequisiteService.cs` | Validates specialization selection prerequisites    |
| `Interfaces/IAbilitySlotService.cs`                | Manages tiered ability slot preparation             |

### Application Layer — Services

| File                                            | Purpose                                              |
| ----------------------------------------------- | ---------------------------------------------------- |
| `Services/LegacyClassDetectionService.cs`       | Scans for legacy class usage in characters           |
| `Services/CharacterMigrationService.cs`         | Executes migration workflow with logging and refunds |
| `Services/SpecializationPrerequisiteService.cs` | Enforces archetype–specialization relationships      |
| `Services/AbilitySlotService.cs`                | Initializes tiered ability slot structures           |

### Configuration

| File                                       | Purpose                                       |
| ------------------------------------------ | --------------------------------------------- |
| `config/legacy-class-mappings.json`        | 6 legacy class → archetype migration mappings |
| `config/legacy-class-mappings.schema.json` | JSON Schema validation for mappings           |

### Unit Tests

| File                                                       | Tests    |
| ---------------------------------------------------------- | -------- |
| `Entities/CharacterMigrationTests.cs` (Domain)             | 15 tests |
| `Services/CharacterMigrationServiceTests.cs` (Application) | 11 tests |
| `Services/AbilitySlotServiceTests.cs` (Application)        | 10 tests |

---

## Technical Details

### Migration Mappings

| Legacy Class | Target Archetype | Suggested Specializations |
| ------------ | ---------------- | ------------------------- |
| Rogue        | Skirmisher       | Myrk-gengr, Strandhögg    |
| Fighter      | Warrior          | Skjaldmær, Berserkr       |
| Mage         | Mystic           | Seiðkona                  |
| Healer       | Adept            | Bone-Setter               |
| Scholar      | Adept            | Jötun-Reader              |
| Crafter      | Adept            | Rúnasmiðr, Scrap-Tinker   |

### CharacterMigration Entity

- State machine: `Pending → InProgress → Completed` (or `Failed`)
- Domain methods: `BeginMigration()`, `SelectSpecialization()`, `RecordRefund()`, `Complete()`, `Fail()`
- Validation: State-dependent transitions, non-negative PP refunds, specialization required before completion

### Ability Slot Structure

- Tier 1: 3 slots @ 0 PP each (unlocked immediately)
- Tier 2: 3 slots @ 4 PP each (requires 8 PP invested)
- Tier 3: 2 slots @ 5 PP each (requires 16 PP invested)
- Capstone: 1 slot @ 6 PP (requires 24 PP invested)
- Total: 9 slots, 35 PP maximum investment

### Refund Policy

- Incompatible abilities: Full PP refund
- Partially compatible abilities: 50% PP refund
- Fully compatible abilities: No refund, ability preserved

---

## Verification

| Metric         | Result |
| -------------- | ------ |
| Build Errors   | 0      |
| Build Warnings | 0      |
| New Tests      | 36     |
| All Tests Pass | ✓      |

---

## Dependencies

- **Depends on**: v0.17.3 (Archetype enum), v0.17.4 (SpecializationId, PP system)
- **Required by**: v0.20.1–v0.20.8 (individual specialization ability implementations)
