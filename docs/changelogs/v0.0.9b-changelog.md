# v0.0.9b Changelog - Damage Types & Resistances

**Date:** 2026-01-08

## Summary

Introduces a damage type system with resistance and vulnerability mechanics. Monsters can now have resistances to specific damage types (fire, ice, poison, etc.), creating strategic depth in combat. Damage calculations account for these resistances with a percentage-based system.

## Added

### Domain Layer - Definitions (New)

- `DamageTypeDefinition` class:
  - Properties: Id, Name, Description, Color, Icon, SortOrder
  - `Create()` factory method with validation
  - Static `Physical` property for default damage type

### Domain Layer - Value Objects (New)

- `DamageResistances` value object:
  - Stores resistance percentages per damage type (-100 to +100)
  - `GetResistance()` - get resistance for a damage type
  - `GetMultiplier()` - convert resistance to damage multiplier (0.0 to 2.0)
  - `IsImmune()`, `IsResistant()`, `IsVulnerable()` - status checks
  - `CombineWith()` - combine resistance sets (takes higher value)
  - `GetSignificantResistances()` - get non-zero resistances
  - Static `None` property for empty resistances

- `DamageInstance` value object:
  - Properties: BaseDamage, DamageTypeId, FinalDamage, ResistanceApplied, WasResisted, WasVulnerable, WasImmune
  - `GetResistanceDescription()` - human-readable effect text
  - `HadResistanceEffect` - quick check for any effect
  - Static factories: `Normal()`, `Immune()`

### Application Layer - Interfaces (New)

- `IDamageCalculationService` interface:
  - `CalculateDamage()` - apply resistances to damage
  - `GetResistanceDescription()` - describe resistance for display
  - `GetResistanceLabel()` - get label (Immune, Resistant, Normal, Vulnerable)
  - `DefaultDamageType` constant ("physical")

### Application Layer - Services (New)

- `DamageCalculationService` class:
  - Implements `IDamageCalculationService`
  - Calculates final damage with resistance multipliers
  - Logs calculation details at Debug level
  - Handles edge cases (null type, negative damage)

### Domain Layer - Entities (Modified)

- `Monster` entity:
  - Added `Resistances` property (type: `DamageResistances`)
  - Updated constructor to accept optional resistances parameter

- `Player` entity:
  - Added `Resistances` property (type: `DamageResistances`, default: None)
  - Added `SetResistances()` method for future equipment/buff integration

### Domain Layer - Definitions (Modified)

- `MonsterDefinition` class:
  - Added `BaseResistances` property (type: `DamageResistances`)
  - Updated `Create()` factory with optional baseResistances parameter
  - Updated `CreateMonster()` to pass resistances to Monster

### Application Layer - Interfaces (Modified)

- `IGameConfigurationProvider` interface:
  - Added `GetDamageTypes()` method
  - Added `GetDamageTypeById()` method

### Infrastructure Layer - Configuration (Modified)

- `JsonConfigurationProvider` enhancements:
  - Added `_damageTypes` caching field
  - Added `GetDamageTypes()` implementation
  - Added `GetDamageTypeById()` implementation
  - Added `ToDamageTypeDefinition()` mapping method
  - Added `DamageTypesJsonConfig` and `DamageTypeJsonConfig` internal classes
  - Updated `MonsterDefinitionJsonConfig` with `BaseResistances` dictionary
  - Updated `ToMonsterDefinition()` to parse and pass resistances
  - Added `GetDefaultDamageTypes()` fallback

### Infrastructure Layer - DI (Modified)

- `DependencyInjection` enhancements:
  - Registered `IDamageCalculationService` -> `DamageCalculationService` as scoped service

### Configuration (New)

- `config/damage-types.json`:
  - 7 damage types defined: physical, fire, ice, lightning, poison, holy, dark
  - Each with id, name, description, color, sortOrder

### Configuration (Modified)

- `config/monsters.json`:
  - Added `baseResistances` dictionary to all monsters
  - Skeleton: +25 physical, -50 fire, +100 poison (immune), -50 holy, +50 dark
  - Slime: +50 physical, -25 fire, -25 ice, -50 lightning, +100 poison (immune)
  - Goblin, Orc, Goblin Shaman: no special resistances

## Tests Added

| Test File | Count |
|-----------|-------|
| `DamageResistancesTests.cs` | 15 |
| `DamageInstanceTests.cs` | 8 |
| `DamageCalculationServiceTests.cs` | 13 |
| **Total New** | 36 |

## Test Results

```
Domain Tests:      564 passed (+23)
Application Tests: 130 passed (+13)
Architecture Tests:  8 passed
Total:             702 passed (+36)
```

## Resistance System

### Resistance Values

| Value | Effect | Multiplier |
|-------|--------|------------|
| +100 | Immune | 0.0x |
| +50 | Resistant | 0.5x |
| +25 | Slightly Resistant | 0.75x |
| 0 | Normal | 1.0x |
| -25 | Slightly Vulnerable | 1.25x |
| -50 | Vulnerable | 1.5x |
| -100 | Extremely Vulnerable | 2.0x |

### Damage Types

| ID | Name | Color | Description |
|----|------|-------|-------------|
| physical | Physical | white | Standard weapon damage |
| fire | Fire | red | Burning damage |
| ice | Ice | cyan | Freezing damage |
| lightning | Lightning | yellow | Electrical damage |
| poison | Poison | green | Toxic damage |
| holy | Holy | gold1 | Radiant/divine damage |
| dark | Dark | purple | Necrotic/shadow damage |

### Monster Resistances

| Monster | Resistances |
|---------|-------------|
| Skeleton | +25 physical, -50 fire, +100 poison, -50 holy, +50 dark |
| Slime | +50 physical, -25 fire/ice, -50 lightning, +100 poison |
| Goblin | None |
| Orc | None |
| Goblin Shaman | None |

## Files Summary

### New Files (6)
| File | Purpose |
|------|---------|
| `Domain/Definitions/DamageTypeDefinition.cs` | Damage type entity |
| `Domain/ValueObjects/DamageResistances.cs` | Resistance storage |
| `Domain/ValueObjects/DamageInstance.cs` | Calculation result |
| `Application/Interfaces/IDamageCalculationService.cs` | Service interface |
| `Application/Services/DamageCalculationService.cs` | Service implementation |
| `config/damage-types.json` | Damage type definitions |

### Modified Files (7)
| File | Changes |
|------|---------|
| `Domain/Definitions/MonsterDefinition.cs` | Added BaseResistances property |
| `Domain/Entities/Monster.cs` | Added Resistances property |
| `Domain/Entities/Player.cs` | Added Resistances property, SetResistances() |
| `Application/Interfaces/IConfigurationProvider.cs` | Added damage type methods |
| `Infrastructure/Configuration/JsonConfigurationProvider.cs` | Damage type loading |
| `Infrastructure/DependencyInjection.cs` | Register DamageCalculationService |
| `config/monsters.json` | Added baseResistances to monsters |

### Test Files (3)
| File | Tests |
|------|-------|
| `Domain.UnitTests/ValueObjects/DamageResistancesTests.cs` | 15 |
| `Domain.UnitTests/ValueObjects/DamageInstanceTests.cs` | 8 |
| `Application.UnitTests/Services/DamageCalculationServiceTests.cs` | 13 |

## Usage Example

```csharp
// Using the damage calculation service
var damageService = serviceProvider.GetRequiredService<IDamageCalculationService>();

// Calculate fire damage against a skeleton
var skeleton = monsterService.SpawnMonster("skeleton");
var result = damageService.CalculateDamage(100, "fire", skeleton.Resistances);

// result.BaseDamage = 100
// result.FinalDamage = 150 (skeleton is -50% vulnerable to fire)
// result.GetResistanceDescription() = "Vulnerable! (50% extra damage)"

// Poison damage against slime
var slime = monsterService.SpawnMonster("slime");
var poisonResult = damageService.CalculateDamage(50, "poison", slime.Resistances);

// poisonResult.FinalDamage = 0 (slime is immune to poison)
// poisonResult.WasImmune = true
// poisonResult.GetResistanceDescription() = "Immune!"
```

## v0.0.9b Complete

This completes the Damage Types & Resistances system:
- Data-driven damage type configuration via JSON
- Percentage-based resistance/vulnerability system
- Integration with Monster and Player entities
- Centralized damage calculation service
- Ready for v0.0.9c: Loot Tables & Drops
