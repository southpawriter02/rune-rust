# v0.5.3c Design Specification: Area Effects

**Version:** 0.5.3c
**Phase Name:** Area Effects
**Parent Version:** v0.5.3 (Tactical Positioning)
**Prerequisites:** v0.5.3b Complete (Opportunity Attacks)
**Estimated Tests:** ~30 unit tests

---

## Table of Contents

1. [Executive Summary](#1-executive-summary)
2. [Feature Overview](#2-feature-overview)
3. [Architecture Diagrams](#3-architecture-diagrams)
4. [AreaEffectShape Enum](#4-areaeffectshape-enum)
5. [AreaEffect Value Object](#5-areaeffect-value-object)
6. [AbilityDefinition Modifications](#6-abilitydefinition-modifications)
7. [AreaEffectService](#7-areaeffectservice)
8. [AbilityService Integration](#8-abilityservice-integration)
9. [Grid AoE Preview Display](#9-grid-aoe-preview-display)
10. [User-Facing Commands](#10-user-facing-commands)
11. [Data Model Changes](#11-data-model-changes)
12. [Configuration File Schemas](#12-configuration-file-schemas)
13. [Logging Specifications](#13-logging-specifications)
14. [Unit Testing Requirements](#14-unit-testing-requirements)
15. [Use Cases](#15-use-cases)
16. [Deliverable Checklist](#16-deliverable-checklist)
17. [Acceptance Criteria](#17-acceptance-criteria)
18. [Dependencies](#18-dependencies)
19. [Future Considerations](#19-future-considerations)

---

## 1. Executive Summary

### 1.1 Purpose

This specification implements area effect targeting and resolution for abilities that affect multiple grid cells. Abilities can define area effects with various shapes (circle, cone, line, square). The UI shows affected cells during targeting, and damage is applied to all entities within the area.

Key mechanics:
- **Shape Types**: Circle, Cone, Line, Square
- **AoE Targeting**: Select center point or direction
- **Preview Display**: Show affected cells before casting
- **Damage Resolution**: Apply damage to all entities in area
- **Ally/Enemy Filtering**: Configure which entities are affected

### 1.2 Key Deliverables

| Category | Items |
|----------|-------|
| **Domain Enums** | `AreaEffectShape` |
| **Domain Value Objects** | `AreaEffect` |
| **AbilityDefinition Updates** | Add AreaEffect property |
| **Application Interfaces** | `IAreaEffectService` |
| **Application Services** | `AreaEffectService` |
| **Result Types** | `AreaEffectPreview`, `AffectedEntityInfo`, `AreaEffectValidation` |
| **AbilityService Updates** | AoE ability execution |
| **GridRenderer Updates** | AoE preview display |
| **Configuration** | AoE abilities in JSON |
| **Tests** | ~30 unit tests |

### 1.3 Architectural Significance

This version completes the **Tactical Positioning** system with **Multi-Target Combat**:

- **Spatial Control**: AoE abilities affect multiple cells at once
- **Tactical Targeting**: Position matters for maximizing effect
- **Shape Variety**: Different shapes for different tactical situations
- **Visual Feedback**: Preview before committing to cast

---

## 2. Feature Overview

```
v0.5.3c Area Effects
├── AreaEffectShape Enum
│   ├── None (single target)
│   ├── Circle (radius from center)
│   ├── Cone (direction + angle)
│   ├── Line (origin to target)
│   └── Square (size centered on point)
├── AreaEffect Value Object
│   ├── Shape, Radius, Length, Width
│   ├── IncludesCaster, AffectsAllies, AffectsEnemies
│   ├── Circle(), Cone(), Line(), Square() factory methods
│   └── Configuration properties
├── AbilityDefinition Updates
│   ├── AreaEffect: AreaEffect? (nullable)
│   ├── IsAreaEffect: bool
│   └── HasAreaEffect: bool
├── AreaEffectService
│   ├── GetAffectedCells(effect, origin, target, dir): positions
│   ├── GetAffectedEntities(): entityIds
│   ├── GetPreview(): AreaEffectPreview
│   ├── ValidateTarget(): AreaEffectValidation
│   ├── GetCircleCells(), GetConeCells()
│   ├── GetLineCells(), GetSquareCells()
│   └── Shape calculation algorithms
├── AbilityService Integration
│   ├── Detect AoE abilities
│   ├── Prompt for target/direction
│   ├── Show preview
│   └── Apply damage to all targets
└── Grid AoE Preview Display
    ├── Show affected cells (○)
    ├── Show enemies in area
    ├── Show allies in area (if affected)
    └── Confirm/cancel options
```

### 2.1 Scope Alignment

**In Scope:**
- `AreaEffectShape` enum (Circle, Cone, Line, Square)
- `AreaEffect` value object with shape and dimensions
- `IAreaEffectService` interface
- `AreaEffectService` for AoE calculations
- Circle shape (radius from center)
- Cone shape (direction and spread angle)
- Line shape (direction and length)
- Square shape (size centered on point)
- AoE targeting UI (select center point)
- AoE preview display on grid
- AbilityDefinition.AreaEffect property
- AoE damage resolution
- AoE ability configuration

**Out of Scope:**
- AoE with friendly fire options (future enhancement)
- Moving AoE effects (future enhancement)

---

## 3. Architecture Diagrams

### 3.1 AoE Shape Types

```
┌─────────────────────────────────────────────────────────────────────┐
│                        AOE SHAPE TYPES                               │
└─────────────────────────────────────────────────────────────────────┘

    CIRCLE (radius = 2)              CONE (length = 3, angle = 90°)
    ┌───┬───┬───┬───┬───┐            ┌───┬───┬───┬───┬───┐
    │   │ ○ │ ○ │ ○ │   │            │   │   │ ○ │ ○ │ ○ │
    ├───┼───┼───┼───┼───┤            ├───┼───┼───┼───┼───┤
    │ ○ │ ○ │ ○ │ ○ │ ○ │            │   │ ○ │ ○ │ ○ │   │
    ├───┼───┼───┼───┼───┤            ├───┼───┼───┼───┼───┤
    │ ○ │ ○ │ ● │ ○ │ ○ │            │ @ │ ○ │   │   │   │
    ├───┼───┼───┼───┼───┤            ├───┼───┼───┼───┼───┤
    │ ○ │ ○ │ ○ │ ○ │ ○ │            │   │   │   │   │   │
    ├───┼───┼───┼───┼───┤            └───┴───┴───┴───┴───┘
    │   │ ○ │ ○ │ ○ │   │            @ = Caster, ○ = Affected
    └───┴───┴───┴───┴───┘
    ● = Center, ○ = Affected

    LINE (length = 6, width = 1)     SQUARE (size = 3x3)
    ┌───┬───┬───┬───┬───┬───┬───┐    ┌───┬───┬───┬───┬───┐
    │   │   │   │   │   │   │   │    │   │   │   │   │   │
    ├───┼───┼───┼───┼───┼───┼───┤    ├───┼───┼───┼───┼───┤
    │ @ │ ─ │ ─ │ ─ │ ─ │ ─ │ ─ │    │   │ ○ │ ○ │ ○ │   │
    ├───┼───┼───┼───┼───┼───┼───┤    ├───┼───┼───┼───┼───┤
    │   │   │   │   │   │   │   │    │   │ ○ │ ● │ ○ │   │
    └───┴───┴───┴───┴───┴───┴───┘    ├───┼───┼───┼───┼───┤
    @ = Caster, ─ = Bolt path        │   │ ○ │ ○ │ ○ │   │
                                     └───┴───┴───┴───┴───┘
                                     ● = Center, ○ = Affected
```

### 3.2 AoE Targeting Flow

```
┌─────────────────────────────────────────────────────────────────────┐
│                       AOE TARGETING FLOW                             │
└─────────────────────────────────────────────────────────────────────┘

    Use AoE Ability Command
              │
              ▼
    ┌───────────────────┐
    │ Get AbilityDef    │
    │ Check AreaEffect  │
    └────────┬──────────┘
             │
             ▼
    ┌───────────────────┐
    │ Determine Input   │
    │ Shape → Input     │
    └────────┬──────────┘
             │
    ┌────────┼────────────────────┐
    │        │                    │
    ▼        ▼                    ▼
  Circle   Cone/Line            Square
  Square    │                     │
    │       │                     │
    ▼       ▼                     ▼
  Select   Select              Select
  Target   Direction           Target
  Point    + Target            Point
             │
             ▼
    ┌───────────────────┐
    │ Calculate Cells   │
    │ GetAffectedCells  │
    └────────┬──────────┘
             │
             ▼
    ┌───────────────────┐
    │ Show Preview      │
    │ Affected cells    │
    │ Affected entities │
    └────────┬──────────┘
             │
             ▼
    ┌───────────────────┐
    │ Confirm Cast?     │──No──▶ Cancel
    └────────┬──────────┘
             │Yes
             ▼
    ┌───────────────────┐
    │ Apply Damage      │
    │ To all targets    │
    └────────┬──────────┘
             │
             ▼
    ┌───────────────────┐
    │ Show Results      │
    └───────────────────┘
```

### 3.3 Circle Calculation

```
┌─────────────────────────────────────────────────────────────────────┐
│                     CIRCLE CALCULATION                               │
└─────────────────────────────────────────────────────────────────────┘

    For Circle(center, radius):
    ┌─────────────────────────────────────────────────────────────┐
    │ for x = (center.X - radius) to (center.X + radius):        │
    │   for y = (center.Y - radius) to (center.Y + radius):      │
    │     if distance(x, y, center) <= radius:                   │
    │       add (x, y) to affected cells                         │
    └─────────────────────────────────────────────────────────────┘

    Example: radius = 2, center = (3, 3)
    ┌───┬───┬───┬───┬───┬───┬───┐
    │   │ 1 │ 2 │ 3 │ 4 │ 5 │   │   Distance from center:
    ├───┼───┼───┼───┼───┼───┼───┤     (1,3)=2 ✓  (3,1)=2 ✓
    │ 1 │   │ ○ │ ○ │ ○ │   │   │     (2,2)≈1.4 ✓  (4,4)≈1.4 ✓
    ├───┼───┼───┼───┼───┼───┼───┤     (1,1)≈2.8 ✗
    │ 2 │ ○ │ ○ │ ○ │ ○ │ ○ │   │
    ├───┼───┼───┼───┼───┼───┼───┤
    │ 3 │ ○ │ ○ │ ● │ ○ │ ○ │   │   Chebyshev distance used
    ├───┼───┼───┼───┼───┼───┼───┤   (grid-based, not Euclidean)
    │ 4 │ ○ │ ○ │ ○ │ ○ │ ○ │   │
    ├───┼───┼───┼───┼───┼───┼───┤
    │ 5 │   │ ○ │ ○ │ ○ │   │   │
    └───┴───┴───┴───┴───┴───┴───┘
```

### 3.4 Layer Diagram

```
┌─────────────────────────────────────────────────────────────────────┐
│                        PRESENTATION LAYER                            │
├─────────────────────────────────────────────────────────────────────┤
│  GridRenderer (Extended)                                             │
│  ├── RenderAoEPreview(preview): display affected cells              │
│  ├── GetAoECellChar(): return '○' for affected cells                │
│  └── RenderAoELegend(): show shape info and targets                 │
├─────────────────────────────────────────────────────────────────────┤
│  UseAbilityCommand (Extended)                                        │
│  ├── Detect AoE ability                                             │
│  ├── Prompt for target/direction                                    │
│  ├── Show preview and confirm                                       │
│  └── Display results                                                │
└───────┬─────────────────────────────────────────────────────────────┘
        │
        ▼
┌─────────────────────────────────────────────────────────────────────┐
│                       APPLICATION LAYER                              │
├─────────────────────────────────────────────────────────────────────┤
│  IAreaEffectService / AreaEffectService                              │
│  ├── GetAffectedCells(effect, origin, target, dir): positions       │
│  ├── GetAffectedEntities(effect, origin, ...): entityIds            │
│  ├── GetPreview(effect, origin, ...): AreaEffectPreview             │
│  ├── ValidateTarget(effect, origin, target, range): validation      │
│  ├── GetCircleCells(center, radius): positions                      │
│  ├── GetConeCells(origin, direction, length, angle): positions      │
│  ├── GetLineCells(origin, target, width): positions                 │
│  └── GetSquareCells(center, size): positions                        │
├─────────────────────────────────────────────────────────────────────┤
│  AreaEffectPreview                                                   │
│  ├── AffectedCells: IReadOnlyList<GridPosition>                     │
│  ├── AffectedEnemies: IReadOnlyList<AffectedEntityInfo>             │
│  ├── AffectedAllies: IReadOnlyList<AffectedEntityInfo>              │
│  ├── TotalAffected: int                                             │
│  └── Description: string                                            │
├─────────────────────────────────────────────────────────────────────┤
│  AffectedEntityInfo                                                  │
│  ├── Id: Guid                                                       │
│  ├── Name: string                                                   │
│  ├── Position: GridPosition                                         │
│  └── IsAlly: bool                                                   │
├─────────────────────────────────────────────────────────────────────┤
│  AreaEffectValidation                                                │
│  ├── IsValid: bool                                                  │
│  ├── Message: string                                                │
│  ├── InRange: bool                                                  │
│  └── HasLineOfSight: bool                                           │
├─────────────────────────────────────────────────────────────────────┤
│  AbilityService (Extended)                                           │
│  ├── UseAbility: detect AoE and delegate to AoE handling            │
│  ├── ExecuteAoEAbility(ability, caster, target/dir): result         │
│  └── ApplyAoEDamage(preview, damage): apply to all targets          │
└───────┬─────────────────────────────────────────────────────────────┘
        │
        ▼
┌─────────────────────────────────────────────────────────────────────┐
│                         DOMAIN LAYER                                 │
├─────────────────────────────────────────────────────────────────────┤
│  ┌────────────────────┐  ┌──────────────────────────────────────┐  │
│  │  AreaEffectShape   │  │      AreaEffect (Value Object)       │  │
│  │      (Enum)        │  │                                      │  │
│  ├────────────────────┤  ├──────────────────────────────────────┤  │
│  │ None   = 0         │  │ + Shape: AreaEffectShape             │  │
│  │ Circle = 1         │  │ + Radius: int                        │  │
│  │ Cone   = 2         │  │ + Length: int                        │  │
│  │ Line   = 3         │  │ + Width: int                         │  │
│  │ Square = 4         │  │ + IncludesCaster: bool               │  │
│  └────────────────────┘  │ + AffectsAllies: bool                │  │
│                          │ + AffectsEnemies: bool               │  │
│                          │ + Circle(radius): AreaEffect         │  │
│                          │ + Cone(length, angle): AreaEffect    │  │
│                          │ + Line(length, width): AreaEffect    │  │
│                          │ + Square(size): AreaEffect           │  │
│                          └──────────────────────────────────────┘  │
│                                                                      │
│  ┌─────────────────────────────────────────────────────────────┐   │
│  │            AbilityDefinition (Extended)                     │   │
│  ├─────────────────────────────────────────────────────────────┤   │
│  │ [EXISTING] Id, Name, Damage, DamageType, Range, etc.        │   │
│  │ [NEW] AreaEffect: AreaEffect?                               │   │
│  │ [NEW] IsAreaEffect: bool (getter, AreaEffect != null)       │   │
│  │ [NEW] HasAreaEffect: bool                                   │   │
│  └─────────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────────┘
```

---

## 4. AreaEffectShape Enum

### 4.1 Implementation

**File:** `src/Core/RuneAndRust.Domain/Enums/AreaEffectShape.cs`

```csharp
namespace RuneAndRust.Domain.Enums;

/// <summary>
/// Shapes for area effect abilities.
/// </summary>
public enum AreaEffectShape
{
    /// <summary>No area effect - single target.</summary>
    None = 0,

    /// <summary>Circle centered on target point.</summary>
    Circle = 1,

    /// <summary>Cone spreading from caster in a direction.</summary>
    Cone = 2,

    /// <summary>Line from caster to target point.</summary>
    Line = 3,

    /// <summary>Square centered on target point.</summary>
    Square = 4
}
```

### 4.2 Shape Properties

| Shape | Parameters | Input Required | Example |
|-------|------------|----------------|---------|
| Circle | Radius | Target point | Fireball |
| Cone | Length, Angle | Direction | Breath weapon |
| Line | Length, Width | Target point | Lightning bolt |
| Square | Size | Target point | Earthquake |

---

## 5. AreaEffect Value Object

**File:** `src/Core/RuneAndRust.Domain/ValueObjects/AreaEffect.cs`

```csharp
namespace RuneAndRust.Domain.ValueObjects;

/// <summary>
/// Defines an area effect for an ability.
/// </summary>
public readonly record struct AreaEffect
{
    public AreaEffectShape Shape { get; init; }
    public int Radius { get; init; }
    public int Length { get; init; }
    public int Width { get; init; }
    public bool IncludesCaster { get; init; }
    public bool AffectsAllies { get; init; }
    public bool AffectsEnemies { get; init; }

    /// <summary>Creates a circle area effect.</summary>
    public static AreaEffect Circle(int radius, bool affectsAllies = false) =>
        new()
        {
            Shape = AreaEffectShape.Circle,
            Radius = radius,
            AffectsAllies = affectsAllies,
            AffectsEnemies = true
        };

    /// <summary>Creates a cone area effect.</summary>
    public static AreaEffect Cone(int length, int angleDegrees = 90, bool affectsAllies = false) =>
        new()
        {
            Shape = AreaEffectShape.Cone,
            Length = length,
            Width = angleDegrees,
            AffectsAllies = affectsAllies,
            AffectsEnemies = true
        };

    /// <summary>Creates a line area effect.</summary>
    public static AreaEffect Line(int length, int width = 1, bool affectsAllies = false) =>
        new()
        {
            Shape = AreaEffectShape.Line,
            Length = length,
            Width = width,
            AffectsAllies = affectsAllies,
            AffectsEnemies = true
        };

    /// <summary>Creates a square area effect.</summary>
    public static AreaEffect Square(int size, bool affectsAllies = false) =>
        new()
        {
            Shape = AreaEffectShape.Square,
            Radius = size / 2,
            AffectsAllies = affectsAllies,
            AffectsEnemies = true
        };
}
```

---

## 6. AbilityDefinition Modifications

**File:** `src/Core/RuneAndRust.Domain/Definitions/AbilityDefinition.cs`

```csharp
// Add to AbilityDefinition:

/// <summary>Gets the area effect configuration (null for single-target).</summary>
public AreaEffect? AreaEffect { get; private set; }

/// <summary>Gets whether this ability has an area effect.</summary>
public bool IsAreaEffect => AreaEffect.HasValue && AreaEffect.Value.Shape != AreaEffectShape.None;

/// <summary>Gets whether this ability has an area effect (alias).</summary>
public bool HasAreaEffect => IsAreaEffect;

// Update Create factory method:
public static AbilityDefinition Create(
    string id, string name, string description,
    /* ... existing params ... */,
    AreaEffect? areaEffect = null)
{
    return new AbilityDefinition
    {
        // ... existing assignments ...
        AreaEffect = areaEffect
    };
}
```

---

## 7. AreaEffectService

### 7.1 Interface

**File:** `src/Core/RuneAndRust.Application/Interfaces/IAreaEffectService.cs`

```csharp
namespace RuneAndRust.Application.Interfaces;

public interface IAreaEffectService
{
    IEnumerable<GridPosition> GetAffectedCells(
        AreaEffect areaEffect, GridPosition origin,
        GridPosition? targetPoint = null, FacingDirection? direction = null);

    IEnumerable<Guid> GetAffectedEntities(
        AreaEffect areaEffect, GridPosition origin,
        GridPosition? targetPoint = null, FacingDirection? direction = null,
        Guid? casterId = null);

    AreaEffectPreview GetPreview(
        AreaEffect areaEffect, GridPosition origin,
        GridPosition? targetPoint = null, FacingDirection? direction = null,
        Guid? casterId = null);

    AreaEffectValidation ValidateTarget(
        AreaEffect areaEffect, GridPosition origin,
        GridPosition targetPoint, int range);

    IEnumerable<GridPosition> GetCircleCells(GridPosition center, int radius);
    IEnumerable<GridPosition> GetConeCells(GridPosition origin, FacingDirection direction, int length, int angleDegrees);
    IEnumerable<GridPosition> GetLineCells(GridPosition origin, GridPosition target, int width);
    IEnumerable<GridPosition> GetSquareCells(GridPosition center, int size);
}

public readonly record struct AreaEffectPreview(
    IReadOnlyList<GridPosition> AffectedCells,
    IReadOnlyList<AffectedEntityInfo> AffectedEnemies,
    IReadOnlyList<AffectedEntityInfo> AffectedAllies,
    string Description)
{
    public int TotalAffected => AffectedEnemies.Count + AffectedAllies.Count;
}

public readonly record struct AffectedEntityInfo(
    Guid Id, string Name, GridPosition Position, bool IsAlly);

public readonly record struct AreaEffectValidation(
    bool IsValid, string Message, bool InRange, bool HasLineOfSight);
```

### 7.2 Implementation

**File:** `src/Core/RuneAndRust.Application/Services/AreaEffectService.cs`

```csharp
namespace RuneAndRust.Application.Services;

public class AreaEffectService : IAreaEffectService
{
    private readonly ICombatGridService _gridService;
    private readonly ICombatStateService _combatStateService;
    private readonly ILineOfSightService _losService;
    private readonly ILogger<AreaEffectService> _logger;

    public AreaEffectService(
        ICombatGridService gridService,
        ICombatStateService combatStateService,
        ILineOfSightService losService,
        ILogger<AreaEffectService> logger)
    {
        _gridService = gridService;
        _combatStateService = combatStateService;
        _losService = losService;
        _logger = logger;
    }

    public IEnumerable<GridPosition> GetAffectedCells(
        AreaEffect areaEffect, GridPosition origin,
        GridPosition? targetPoint = null, FacingDirection? direction = null)
    {
        var grid = _gridService.GetActiveGrid();
        if (grid == null) yield break;

        var cells = areaEffect.Shape switch
        {
            AreaEffectShape.Circle => GetCircleCells(targetPoint ?? origin, areaEffect.Radius),
            AreaEffectShape.Cone => GetConeCells(origin, direction ?? FacingDirection.North,
                areaEffect.Length, areaEffect.Width),
            AreaEffectShape.Line => GetLineCells(origin, targetPoint ?? origin, areaEffect.Width),
            AreaEffectShape.Square => GetSquareCells(targetPoint ?? origin, areaEffect.Radius * 2 + 1),
            _ => Enumerable.Empty<GridPosition>()
        };

        foreach (var cell in cells)
        {
            if (grid.IsValidPosition(cell))
                yield return cell;
        }
    }

    public IEnumerable<GridPosition> GetCircleCells(GridPosition center, int radius)
    {
        for (var x = center.X - radius; x <= center.X + radius; x++)
        {
            for (var y = center.Y - radius; y <= center.Y + radius; y++)
            {
                var pos = GridPosition.Create(x, y);
                if (pos.DistanceTo(center) <= radius)
                    yield return pos;
            }
        }
    }

    public IEnumerable<GridPosition> GetConeCells(
        GridPosition origin, FacingDirection direction, int length, int angleDegrees)
    {
        var (dx, dy) = GetDirectionVector(direction);

        for (var dist = 1; dist <= length; dist++)
        {
            var halfAngleRad = (angleDegrees / 2.0) * Math.PI / 180.0;
            var spread = (int)Math.Ceiling(dist * Math.Tan(halfAngleRad));

            var centerX = origin.X + dx * dist;
            var centerY = origin.Y + dy * dist;

            for (var s = -spread; s <= spread; s++)
            {
                int px, py;
                if (dx == 0)
                {
                    px = centerX + s;
                    py = centerY;
                }
                else if (dy == 0)
                {
                    px = centerX;
                    py = centerY + s;
                }
                else
                {
                    px = centerX + s * (dy == dx ? -1 : 1);
                    py = centerY + s;
                }

                yield return GridPosition.Create(px, py);
            }
        }
    }

    public IEnumerable<GridPosition> GetLineCells(
        GridPosition origin, GridPosition target, int width)
    {
        var lineCells = _losService.GetLineCells(origin, target).ToList();

        if (width <= 1)
        {
            foreach (var cell in lineCells)
                yield return cell;
            yield break;
        }

        var halfWidth = width / 2;
        var dx = target.X - origin.X;
        var dy = target.Y - origin.Y;
        var length = Math.Sqrt(dx * dx + dy * dy);

        if (length == 0) yield break;

        var perpX = -dy / length;
        var perpY = dx / length;

        foreach (var cell in lineCells)
        {
            for (var w = -halfWidth; w <= halfWidth; w++)
            {
                var offsetX = (int)Math.Round(perpX * w);
                var offsetY = (int)Math.Round(perpY * w);
                yield return GridPosition.Create(cell.X + offsetX, cell.Y + offsetY);
            }
        }
    }

    public IEnumerable<GridPosition> GetSquareCells(GridPosition center, int size)
    {
        var halfSize = size / 2;
        for (var x = center.X - halfSize; x <= center.X + halfSize; x++)
        {
            for (var y = center.Y - halfSize; y <= center.Y + halfSize; y++)
            {
                yield return GridPosition.Create(x, y);
            }
        }
    }

    public IEnumerable<Guid> GetAffectedEntities(
        AreaEffect areaEffect, GridPosition origin,
        GridPosition? targetPoint = null, FacingDirection? direction = null,
        Guid? casterId = null)
    {
        var grid = _gridService.GetActiveGrid();
        if (grid == null) yield break;

        var caster = casterId.HasValue ? _combatStateService.GetCombatant(casterId.Value) : null;
        var cells = GetAffectedCells(areaEffect, origin, targetPoint, direction);

        foreach (var cell in cells)
        {
            var gridCell = grid.GetCell(cell);
            if (gridCell.OccupantId.HasValue)
            {
                var occupant = _combatStateService.GetCombatant(gridCell.OccupantId.Value);
                if (occupant == null) continue;

                if (!areaEffect.IncludesCaster && gridCell.OccupantId == casterId)
                    continue;

                var isAlly = caster != null && occupant.IsPlayer == caster.IsPlayer;
                if (isAlly && !areaEffect.AffectsAllies) continue;
                if (!isAlly && !areaEffect.AffectsEnemies) continue;

                yield return gridCell.OccupantId.Value;
            }
        }
    }

    public AreaEffectPreview GetPreview(
        AreaEffect areaEffect, GridPosition origin,
        GridPosition? targetPoint = null, FacingDirection? direction = null,
        Guid? casterId = null)
    {
        var cells = GetAffectedCells(areaEffect, origin, targetPoint, direction).ToList();
        var enemies = new List<AffectedEntityInfo>();
        var allies = new List<AffectedEntityInfo>();

        var grid = _gridService.GetActiveGrid();
        var caster = casterId.HasValue ? _combatStateService.GetCombatant(casterId.Value) : null;

        foreach (var cell in cells)
        {
            var gridCell = grid?.GetCell(cell);
            if (gridCell?.OccupantId.HasValue == true)
            {
                var occupant = _combatStateService.GetCombatant(gridCell.OccupantId.Value);
                if (occupant == null) continue;

                var isAlly = caster != null && occupant.IsPlayer == caster.IsPlayer;
                var info = new AffectedEntityInfo(gridCell.OccupantId.Value, occupant.Name, cell, isAlly);

                if (isAlly)
                    allies.Add(info);
                else
                    enemies.Add(info);
            }
        }

        return new AreaEffectPreview(
            cells, enemies, allies,
            $"{areaEffect.Shape} affects {cells.Count} cells, {enemies.Count} enemies");
    }

    public AreaEffectValidation ValidateTarget(
        AreaEffect areaEffect, GridPosition origin, GridPosition targetPoint, int range)
    {
        var distance = origin.DistanceTo(targetPoint);
        var inRange = distance <= range;

        var losResult = _losService.CheckLineOfSight(origin, targetPoint);
        var hasLos = losResult.HasLineOfSight;

        if (!inRange)
            return new AreaEffectValidation(false, "Target out of range", false, hasLos);

        if (!hasLos)
            return new AreaEffectValidation(false, "No line of sight to target", inRange, false);

        return new AreaEffectValidation(true, "Valid target", true, true);
    }

    private (int dx, int dy) GetDirectionVector(FacingDirection direction) =>
        direction switch
        {
            FacingDirection.North => (0, -1),
            FacingDirection.NorthEast => (1, -1),
            FacingDirection.East => (1, 0),
            FacingDirection.SouthEast => (1, 1),
            FacingDirection.South => (0, 1),
            FacingDirection.SouthWest => (-1, 1),
            FacingDirection.West => (-1, 0),
            FacingDirection.NorthWest => (-1, -1),
            _ => (0, -1)
        };
}
```

---

## 8. AbilityService Integration

**File:** `src/Core/RuneAndRust.Application/Services/AbilityService.cs`

```csharp
// Update AbilityService for AoE abilities:

public AbilityResult UseAbility(Guid casterId, string abilityId, AbilityTargetInfo target)
{
    var ability = GetAbility(abilityId);
    if (ability == null)
        return AbilityResult.Fail("Unknown ability.");

    // ... existing validation (resources, cooldown, etc.) ...

    if (ability.IsAreaEffect)
    {
        return ExecuteAoEAbility(casterId, ability, target);
    }

    return ExecuteSingleTargetAbility(casterId, ability, target);
}

private AbilityResult ExecuteAoEAbility(
    Guid casterId, AbilityDefinition ability, AbilityTargetInfo target)
{
    var casterPos = _gridService.GetActiveGrid()?.GetEntityPosition(casterId);
    if (!casterPos.HasValue)
        return AbilityResult.Fail("Caster not on grid.");

    var areaEffect = ability.AreaEffect!.Value;
    var preview = _areaEffectService.GetPreview(
        areaEffect, casterPos.Value, target.TargetPosition,
        target.Direction, casterId);

    if (preview.AffectedEnemies.Count == 0 && !areaEffect.AffectsAllies)
    {
        _logger.LogDebug("AoE ability {Id} has no targets", ability.Id);
    }

    // Roll damage once for all targets
    var damageRoll = _diceService.Roll(ability.Damage);
    var totalDamage = damageRoll.Total;

    // Apply damage to all affected entities
    var results = new List<AoETargetResult>();
    var affectedIds = _areaEffectService.GetAffectedEntities(
        areaEffect, casterPos.Value, target.TargetPosition,
        target.Direction, casterId);

    foreach (var entityId in affectedIds)
    {
        var entity = _combatStateService.GetCombatant(entityId);
        if (entity == null) continue;

        entity.TakeDamage(totalDamage);
        results.Add(new AoETargetResult(entityId, entity.Name, totalDamage, entity.CurrentHp <= 0));

        _logger.LogInformation("AoE {Ability} dealt {Damage} to {Target}",
            ability.Name, totalDamage, entity.Name);
    }

    return AbilityResult.AoESuccess(ability, damageRoll, preview, results);
}
```

---

## 9. Grid AoE Preview Display

**File:** `src/Presentation/RuneAndRust.Presentation/Adapters/GridRenderer.cs`

```csharp
// Add AoE preview rendering:

public string RenderAoEPreview(CombatGrid grid, AreaEffectPreview preview, Guid playerId)
{
    var sb = new StringBuilder();
    var affectedSet = new HashSet<GridPosition>(preview.AffectedCells);

    sb.AppendLine($"AoE Preview ({preview.Description})");
    sb.AppendLine(new string('=', 50));

    // Render grid with AoE overlay
    for (int y = 0; y < grid.Height; y++)
    {
        sb.Append($"{y + 1} ");
        for (int x = 0; x < grid.Width; x++)
        {
            var pos = new GridPosition(x, y);
            var cell = grid.GetCell(pos);

            if (cell.OccupantId == playerId)
                sb.Append(" @ ");
            else if (affectedSet.Contains(pos))
            {
                if (cell.IsOccupied)
                    sb.Append(" M "); // Monster in AoE
                else
                    sb.Append(" ○ "); // Empty cell in AoE
            }
            else
                sb.Append(RenderCell(cell, grid.GetCover(pos), playerId));
        }
        sb.AppendLine();
    }

    // Legend
    sb.AppendLine();
    sb.AppendLine($"@ = You   M = Enemy in area   ○ = Affected cell");
    sb.AppendLine();
    sb.AppendLine($"Targets: {preview.AffectedEnemies.Count} enemies");

    foreach (var enemy in preview.AffectedEnemies)
        sb.AppendLine($"  - {enemy.Name} at {enemy.Position}");

    if (preview.AffectedAllies.Count > 0)
    {
        sb.AppendLine($"Allies in area: {preview.AffectedAllies.Count}");
        foreach (var ally in preview.AffectedAllies)
            sb.AppendLine($"  - {ally.Name} at {ally.Position}");
    }

    return sb.ToString();
}
```

---

## 10. User-Facing Commands

### 10.1 AoE Targeting (Fireball)

```
> use fireball

Select target point for Fireball (2-cell radius):
Current grid position: D4

  A B C D E F G H
1 . . . . . . . .
2 . . M . . M . .
3 . . . . . . . .
4 . . . @ . . . .
5 . . . . . . . .

Enter target position (e.g., C2):
> D2

Fireball Preview:
  A B C D E F G H
1 . . ○ ○ ○ . . .
2 . ○ ○ M ○ ○ . .     ○ = Blast area
3 . . ○ ○ ○ . . .     M = Enemy in area
4 . . . @ . . . .

Targets: 1 enemy (Skeleton at D2)
Cast Fireball? (yes/no)
```

### 10.2 Fireball Execution

```
> yes

You hurl a ball of fire at D2!

[FIREBALL - 2-cell radius]
[Affected cells: 13]
[Targets: Skeleton at D2]

Damage Roll: 3d6 = 12 fire damage

Results:
  Skeleton at D2: 12 damage → Defeated!

The flames engulf the area!
```

### 10.3 Cone Attack (Breath Weapon)

```
> use dragon-breath

Select direction for Dragon Breath (4-cell cone):
  N  NE  E  SE  S  SW  W  NW

> NE

Dragon Breath Preview:
  A B C D E F G H
1 . . . . ○ ○ . .
2 . . . ○ ○ M . .     ○ = Breath area
3 . . ○ ○ . . . .     M = Enemy in area
4 . . @ . . . . .

Targets: 1 enemy (Goblin at F2)
Use Dragon Breath? (yes/no)
```

### 10.4 Line Attack (Lightning Bolt)

```
> use lightning-bolt

Select end point for Lightning Bolt (8-cell line):

> H4

Lightning Bolt Preview:
  A B C D E F G H
1 . . . . . . . .
2 . . . . . . . .
3 . . . . . . . .
4 . . . @ ─ ─ M ─     ─ = Bolt path
5 . . . . . . . .     M = Enemy in path

Targets: 1 enemy (Skeleton at G4)
Cast Lightning Bolt? (yes/no)
```

---

## 11. Data Model Changes

| Type | Layer | Description |
|------|-------|-------------|
| `AreaEffectShape` | Domain/Enums | None, Circle, Cone, Line, Square |
| `AreaEffect` | Domain/ValueObjects | Shape, dimensions, filtering |
| `AbilityDefinition` | Domain/Definitions | Add AreaEffect property |
| `IAreaEffectService` | Application/Interfaces | AoE service interface |
| `AreaEffectService` | Application/Services | AoE calculations |
| `AreaEffectPreview` | Application/DTOs | Preview info |
| `AffectedEntityInfo` | Application/DTOs | Entity in AoE |
| `AreaEffectValidation` | Application/DTOs | Target validation |
| `AbilityResult` | Application/DTOs | Add AoE result properties |

---

## 12. Configuration File Schemas

**File:** `config/abilities.json` (AoE abilities)

```json
{
  "$schema": "./schemas/abilities.schema.json",
  "abilities": [
    {
      "id": "fireball",
      "name": "Fireball",
      "description": "Hurl a ball of fire that explodes on impact",
      "resourceType": "Mana",
      "resourceCost": 15,
      "damage": "3d6",
      "damageType": "Fire",
      "range": 6,
      "areaEffect": {
        "shape": "Circle",
        "radius": 2,
        "affectsAllies": false,
        "affectsEnemies": true
      }
    },
    {
      "id": "cone-of-cold",
      "name": "Cone of Cold",
      "description": "Blast of freezing air in a cone",
      "resourceType": "Mana",
      "resourceCost": 12,
      "damage": "2d8",
      "damageType": "Cold",
      "areaEffect": {
        "shape": "Cone",
        "length": 4,
        "width": 90,
        "affectsAllies": false,
        "affectsEnemies": true
      }
    },
    {
      "id": "lightning-bolt",
      "name": "Lightning Bolt",
      "description": "A bolt of lightning streaks toward a target",
      "resourceType": "Mana",
      "resourceCost": 10,
      "damage": "4d6",
      "damageType": "Lightning",
      "range": 8,
      "areaEffect": {
        "shape": "Line",
        "length": 8,
        "width": 1,
        "affectsAllies": false,
        "affectsEnemies": true
      }
    },
    {
      "id": "earthquake",
      "name": "Earthquake",
      "description": "Shake the ground in an area",
      "resourceType": "Mana",
      "resourceCost": 20,
      "damage": "2d10",
      "damageType": "Bludgeoning",
      "range": 6,
      "areaEffect": {
        "shape": "Square",
        "radius": 2,
        "affectsAllies": true,
        "affectsEnemies": true,
        "includesCaster": false
      }
    }
  ]
}
```

---

## 13. Logging Specifications

| Component | Level | Events |
|-----------|-------|--------|
| `AreaEffectService` | Debug | Shape calculations, cell enumeration |
| `AreaEffectService` | Information | Preview generated, targets found |
| `AbilityService` | Information | AoE ability used, damage applied |
| `AbilityService` | Debug | Per-target damage application |

---

## 14. Unit Testing Requirements

| Feature | Test Count |
|---------|------------|
| AreaEffectShape enum | ~2 |
| AreaEffect factory methods | ~4 |
| AreaEffectService.GetCircleCells | ~4 |
| AreaEffectService.GetConeCells | ~4 |
| AreaEffectService.GetLineCells | ~4 |
| AreaEffectService.GetSquareCells | ~3 |
| AreaEffectService.GetAffectedEntities | ~4 |
| AreaEffectService.GetPreview | ~3 |
| AbilityService AoE execution | ~2 |
| **Total** | **~30** |

---

## 15. Use Cases

### UC-001: Circle AoE (Fireball)
**Flow:** Select target point → Calculate radius cells → Preview → Cast → Damage all

### UC-002: Cone AoE (Breath Weapon)
**Flow:** Select direction → Calculate cone cells → Preview → Cast → Damage all

### UC-003: Line AoE (Lightning Bolt)
**Flow:** Select end point → Calculate line cells → Preview → Cast → Damage all

### UC-004: Square AoE (Earthquake)
**Flow:** Select center → Calculate square cells → Preview → Cast → Damage all

### UC-005: AoE Affects Allies
**Flow:** Cast earthquake (affectsAllies=true) → Allies in area also take damage

---

## 16. Deliverable Checklist

### Domain Layer
- [ ] `AreaEffectShape` enum
- [ ] `AreaEffect` value object
- [ ] AbilityDefinition.AreaEffect property

### Application Layer
- [ ] `IAreaEffectService` interface
- [ ] `AreaEffectService` implementation
- [ ] `AreaEffectPreview`, `AffectedEntityInfo`, `AreaEffectValidation`
- [ ] AbilityService AoE integration

### Presentation Layer
- [ ] GridRenderer AoE preview
- [ ] UseAbilityCommand AoE targeting

### Configuration
- [ ] AoE abilities in `abilities.json`

### Testing
- [ ] ~30 unit tests
- [ ] All tests passing

---

## 17. Acceptance Criteria

### Functional
- [ ] AreaEffectShape enum has None, Circle, Cone, Line, Square
- [ ] AreaEffect value object stores shape and dimensions
- [ ] AbilityDefinition.AreaEffect stores AoE configuration
- [ ] Circle shape calculates cells within radius correctly
- [ ] Cone shape spreads from origin in direction correctly
- [ ] Line shape follows path correctly
- [ ] Square shape fills area correctly
- [ ] AoE targeting UI shows preview
- [ ] Grid displays affected cells
- [ ] AoE abilities damage all targets in area
- [ ] Ally/enemy filtering works correctly
- [ ] AoE configuration loads from JSON

### Quality
- [ ] Build succeeds with 0 errors/warnings
- [ ] ~30 unit tests pass
- [ ] XML documentation complete

---

## 18. Dependencies

### Required from v0.5.3a

| Type | Usage |
|------|-------|
| `FacingDirection` | Cone direction |
| Direction vector calculation | Cone shape algorithm |

### Required from v0.5.1c

| Type | Usage |
|------|-------|
| `LineOfSightService` | Line shape algorithm |
| `GetLineCells` | Bresenham's for line AoE |

### Required from v0.5.0a

| Type | Usage |
|------|-------|
| `GridPosition` | Cell calculations |
| `CombatGrid` | Valid position checks |

---

## 19. Future Considerations

### Deferred
- AoE with friendly fire toggle (selective)
- Moving AoE effects (cloud that drifts)
- Persistent AoE zones (wall of fire)
- AoE that requires saving throws

### Out of Scope
- AoE combo effects
- AoE terrain interaction (fire spreads)
- Environmental AoE (natural hazards)

---

*Document Version: 1.0*
*Last Updated: 2026-01-10*
*Author: AI Assistant*
