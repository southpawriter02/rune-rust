> **Archived** - This plan has been consolidated. See the complete version at [v0.3.15](../v0.3.x/v0.3.15.md).

# v0.3.15a: The Lexicon (String Extraction)

This version establishes the data structures and standards for the localization system. It focuses on removing hardcoded strings from the Terminal layer, defining the JSON resource schema, and creating the key constants that ensure type safety when requesting text.

Goal: Establish the data/locales/ directory structure, define the en-US.json schema, and refactor the Main Menu and Options screens to use LocalizationKey constants instead of string literals.
1. Architecture & Data Flow
The Key-Value Pipeline
	1	Source: Strings are moved from C# files to data/locales/en-US.json.
	2	Definition: Keys are defined as constants in RuneAndRust.Core.Constants.LocKeys to prevent "magic string" errors.
	3	Reference: The UI code references LocKeys.UI_MainMenu_NewGame instead of "New Game".
	4	Interface: We define ILocalizationService (to be implemented in v0.3.15b) so we can inject it into controllers now.
2. Logic Decision Trees
A. Key Naming Logic Input: Hardcoded string found in code (e.g., "Press any key to continue...")
	1	Determine Context:
	◦	Is it a specific Menu? -> UI.{MenuName}.{Action}
	◦	Is it a Message Log? -> Log.{Category}.{Event}
	◦	Is it an Entity Name? -> Entity.{Type}.{Name}
	◦	Is it shared (e.g., "Cancel")? -> Common.{Action}
	2	Determine Parameterization:
	◦	Does it use variables? (e.g., "Damage: 50") -> Ensure the value in JSON uses indexed placeholders: "Damage: {0}".
	3	Create Key: UI.Common.PressAnyKey.
B. Extraction Workflow Input: Console.WriteLine("Welcome!");
	1	Add to JSON: Insert "UI.Title.Welcome": "Welcome!" into en-US.json.
	2	Add to Constants: Add public const string UI_Title_Welcome = "UI.Title.Welcome"; to LocKeys.cs.
	3	Refactor Code: Change to _loc.Get(LocKeys.UI_Title_Welcome);.
3. Deliverable Checklist
	•	Core:
	◦	[ ] Create Constants/LocKeys.cs static class.
	◦	[ ] Define Interfaces/ILocalizationService.cs (Contract).
	•	Data:
	◦	[ ] Create directory data/locales/.
	◦	[ ] Create data/locales/en-US.json (The Master Locale).
	•	Terminal (Refactoring):
	◦	[ ] Refactor TitleScreenService.cs.
	◦	[ ] Refactor MainMenuController.cs.
	◦	[ ] Refactor OptionsScreenRenderer.cs.
	◦	[ ] Refactor CreationWizard.cs (Step prompts only).
	•	Tests:
	◦	[ ] LocalizationKeyTests.cs: Ensure no duplicate keys in constants.
4. Code Implementation
A. The Schema (data/locales/en-US.json) We use a flat JSON structure for easier parsing, or nested for organization. Decision: Hierarchical (Nested) JSON is preferred for readability, flattened by the loader.
{
  "UI": {
    "Common": {
      "Back": "[ESC] Back",
      "Confirm": "[ENTER] Confirm",
      "PressAnyKey": "Press any key to continue..."
    },
    "MainMenu": {
      "Title": "Rune & Rust",
      "NewGame": "New Game",
      "LoadGame": "Load Game",
      "Options": "Options",
      "Quit": "Quit"
    },
    "Options": {
      "Header": "SETTINGS",
      "Saved": "Settings saved successfully."
    }
  },
  "Log": {
    "Combat": {
      "Hit": "{0} hits {1} for {2} damage!",
      "Miss": "{0} attacks {1} but misses."
    }
  }
}
B. The Constants (RuneAndRust.Core/Constants/LocKeys.cs) This prevents typos in string keys.
namespace RuneAndRust.Core.Constants;

public static class LocKeys
{
    // UI - Common
    public const string UI_Common_Back = "UI.Common.Back";
    public const string UI_Common_Confirm = "UI.Common.Confirm";
    public const string UI_Common_PressAnyKey = "UI.Common.PressAnyKey";

    // UI - Main Menu
    public const string UI_MainMenu_NewGame = "UI.MainMenu.NewGame";
    public const string UI_MainMenu_LoadGame = "UI.MainMenu.LoadGame";
    public const string UI_MainMenu_Quit = "UI.MainMenu.Quit";

    // Log - Combat
    public const string Log_Combat_Hit = "Log.Combat.Hit"; // Expects {0}=Attacker, {1}=Target, {2}=Dmg
}
C. The Contract (RuneAndRust.Core/Interfaces/ILocalizationService.cs)
public interface ILocalizationService
{
    // Get simple string
    string Get(string key);

    // Get formatted string (e.g., string.Format)
    string Get(string key, params object[] args);

    // Switch language at runtime
    Task LoadLocaleAsync(string cultureCode);
}
5. Logging Requirements
Since this version is primarily data setup, logging focuses on the absence of keys during the refactor testing (simulated by a Mock service until v0.3.15b).
System
Event
Level
Message Template
Properties
Loc
Key Missing
Warning
"[Loc] Key not found in dictionary: {Key}"
Key
Loc
Init
Info
"[Loc] Data structure initialized for extraction."
-
6. Testing Strategy
Unit Tests (LocalizationArchitectureTests.cs)
	•	Key_Format_Validation:
	◦	Use Reflection to iterate all string constants in LocKeys.
	◦	Assert that every value matches the pattern Category.SubCategory.Key.
	•	JSON_Integrity:
	◦	Load en-US.json.
	◦	Flatten the JSON keys.
	◦	Assert that every constant in LocKeys exists as a key in the JSON file. (This ensures we don't define a constant in C# that is missing from the data).
Example Test:
[Fact]
public void All_Constants_Have_Entries_In_JSON()
{
    var json = File.ReadAllText("data/locales/en-US.json");
    var data = JsonSerializer.Deserialize<Dictionary<string, object>>(json);
    var flatKeys = FlattenKeys(data); // Helper to flatten hierarchy

    var constantKeys = typeof(LocKeys)
        .GetFields(BindingFlags.Public | BindingFlags.Static | BindingFlags.FlattenHierarchy)
        .Select(f => f.GetRawConstantValue().ToString());

    foreach (var key in constantKeys)
    {
        flatKeys.Should().Contain(key, $"LocKeys.{key} is missing from en-US.json");
    }
}
7. Draft Changelog (v0.3.15a)
# v0.3.15a Changelog: The Lexicon
**Release Date:** 2026-02-25

## Summary
This release lays the foundation for the Localization System. We have extracted hardcoded strings from the Main Menu and Options screens into a structured JSON resource file (`en-US.json`) and established the `LocKeys` constant system to ensure type-safe text retrieval.

## New Features
*   **Locale Data Structure:** Implemented hierarchical JSON format for game strings.
*   **Localization Keys:** Added `LocKeys` static class to map code constants to JSON keys.

## Technical Changes
*   Created `data/locales/en-US.json` containing initial UI strings.
*   Refactored `TitleScreenService` and `MainMenuController` to prepare for `ILocalizationService` injection.
*   Added `ILocalizationService` interface definition.
