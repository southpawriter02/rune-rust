# Changelog: v0.17.2e - Attribute Provider Service

**Release Date:** 2026-01-30
**Phase:** Attribute System (5/7)
**Status:** Complete

---

## Overview

Implements the Attribute Provider Service for the v0.17.2 Attribute System: the `IAttributeProvider` interface and `AttributeProvider` implementation. This service is the centralized access point for all attribute-related data during character creation, loading and caching attribute descriptions, archetype-recommended builds, and point-buy configuration from `config/attributes.json`.

The provider follows the established double-checked locking pattern from `BackgroundProvider` (v0.17.1d) and `LineageProvider` (v0.17.0e), ensuring thread-safe lazy initialization with lock-free reads after initialization. Configuration is validated on first access with detailed error reporting via `AttributeConfigurationException`.

This phase establishes the data access layer that all subsequent v0.17.2x phases depend upon for attribute allocation services (v0.17.2f) and character creation UI (v0.17.5).

---

## Added

### Application Layer

#### Interfaces

- **`IAttributeProvider`** (`Interfaces/IAttributeProvider.cs`)
    - Interface with 5 methods providing centralized attribute data access
    - `GetAttributeDescription(CoreAttribute)`: Returns description for a single attribute
    - `GetAllAttributeDescriptions()`: Returns all 5 attribute descriptions
    - `GetRecommendedBuild(string archetypeId)`: Returns Simple mode build for an archetype (case-insensitive)
    - `GetPointBuyConfiguration()`: Returns full point-buy configuration for Advanced mode
    - `GetStartingPoints(string? archetypeId)`: Returns starting point pool (14 for Adept, 15 for others)
    - Comprehensive XML documentation with `<summary>`, `<remarks>`, `<param>`, `<returns>`, `<exception>`, `<example>` tags
    - `<seealso>` cross-references to `AttributeDescription`, `AttributeAllocationState`, `PointBuyConfiguration`, `CoreAttribute`

#### Exceptions

- **`AttributeConfigurationException`** (`Exceptions/AttributeConfigurationException.cs`)
    - Exception for attribute configuration loading and validation failures
    - Two constructors: message-only and message+innerException
    - XML documentation listing all possible causes (file not found, invalid JSON, wrong count, duplicates, missing point-buy config)

#### DTOs

- **`AttributeConfigurationDto`** (`DTOs/AttributeConfigurationDto.cs`) — 5 DTO classes for JSON deserialization
    - `AttributeConfigurationDto`: Root DTO with Schema, Attributes, RecommendedBuilds, PointBuy
    - `AttributeDefinitionDto`: Attribute, DisplayName, ShortDescription, DetailedDescription, AffectedStats, AffectedSkills
    - `RecommendedBuildDto`: ArchetypeId, Might, Finesse, Wits, Will, Sturdiness, TotalPoints
    - `PointBuyConfigurationDto`: StartingPoints, AdeptStartingPoints, MinAttributeValue, MaxAttributeValue, CostTable
    - `PointBuyCostEntryDto`: TargetValue, IndividualCost, CumulativeCost
    - Note: `derivedStats` section intentionally excluded — loaded separately by v0.17.2d

### Infrastructure Layer

#### Services

- **`AttributeProvider`** (`Services/AttributeProvider.cs`)
    - Implements `IAttributeProvider` with thread-safe lazy initialization
    - Three in-memory caches:
        - `Dictionary<CoreAttribute, AttributeDescription>` for attribute descriptions
        - `Dictionary<string, AttributeAllocationState>` (OrdinalIgnoreCase) for recommended builds
        - `PointBuyConfiguration?` for point-buy configuration
    - Double-checked locking via `_initLock` + `_isInitialized` pattern
    - Constants: `ExpectedAttributeCount = 5`, `ExpectedRecommendedBuildCount = 4`
    - Constructor: `(ILogger<AttributeProvider> logger, string? configPath = null)` with null validation
    - Private initialization methods: `EnsureInitialized()`, `LoadConfiguration()`, `ValidateConfiguration()`, `BuildCaches()`, `BuildDescriptionCache()`, `BuildRecommendedBuildCache()`, `BuildPointBuyConfig()`
    - Validation checks: exact attribute count, no duplicate IDs, all CoreAttribute values present, exact build count, non-empty archetype IDs, no duplicate archetypes, point-buy config present with valid starting points and non-empty cost table
    - Exhaustive structured logging at all levels:
        - Information: initialization start/completion with cache statistics
        - Debug: individual item loading, method calls with parameters, cache lookups
        - Warning: not-found lookups with available alternatives
        - Error: validation failures, file not found, JSON parse errors

#### Dependency Injection

- **`DependencyInjection.cs`** — Added `IAttributeProvider` registration
    - `AddSingleton<IAttributeProvider>` with factory lambda
    - `Path.Combine(configPath, "attributes.json")` for config path
    - Version comment: `// Attribute provider (v0.17.2e)`

### Unit Tests

- **`AttributeProviderTests`** (`Providers/AttributeProviderTests.cs`) — 26 tests
    - `Constructor_NullLogger_ThrowsArgumentNullException`: Null logger rejection
    - `Constructor_WithValidParameters_CreatesInstance`: Valid construction
    - `GetAttributeDescription_ValidAttribute_ReturnsDescription`: MIGHT description with display name, short description, stats, skills
    - `GetAttributeDescription_AllAttributes_HaveCorrectDisplayNames`: Parameterized for all 5 attributes (MIGHT, FINESSE, WITS, WILL, STURDINESS)
    - `GetAllAttributeDescriptions_ReturnsFiveDescriptions`: Exact count verification
    - `GetAllAttributeDescriptions_AllHaveAffectedStatsAndSkills`: All descriptions have populated stats, skills, and descriptions
    - `GetRecommendedBuild_Warrior_ReturnsCorrectValues`: Full Warrior build (M4 F3 Wi2 Wl2 S4, 15 pts, complete, Simple mode)
    - `GetRecommendedBuild_AllArchetypes_ReturnComplete`: Parameterized for warrior, skirmisher, mystic, adept
    - `GetRecommendedBuild_UnknownArchetype_ThrowsArgumentException`: Unknown archetype rejection
    - `GetRecommendedBuild_CaseInsensitive_ReturnsCorrectBuild`: WARRIOR, Warrior, warrior, WaRrIoR all resolve
    - `GetStartingPoints_Adept_Returns14`: Adept gets 14 points
    - `GetStartingPoints_Warrior_Returns15`: Warrior gets 15 points
    - `GetStartingPoints_Null_Returns15`: Null returns default 15
    - `GetPointBuyConfiguration_ReturnsValidConfig`: Full config verification (15/14 pts, 1-10 range, 9 entries, max cumulative 11)
    - `GetAllAttributeDescriptions_WithMissingFile_ThrowsAttributeConfigurationException`: Missing file error
    - `GetAttributeDescription_IsCachedAfterFirstAccess`: Cache consistency check

---

## Changed

### Infrastructure Layer

- **`DependencyInjection.cs`** (`DependencyInjection.cs`)
    - Added `IAttributeProvider` singleton registration after `IBackgroundProvider` block
    - Uses same factory lambda pattern as other provider registrations

---

## Design Decisions

### Following BackgroundProvider Pattern

The `AttributeProvider` follows the exact same pattern as `BackgroundProvider` (v0.17.1d): double-checked locking, separate Load/Validate/Build phases, detailed structured logging, and `File.Exists` guard in tests. This ensures consistency across all provider implementations.

### Three Separate Caches

The provider maintains three separate caches (`_descriptionCache`, `_buildCache`, `_pointBuyConfig`) rather than a single combined structure. This matches the three distinct data categories in `attributes.json` and allows each to use its optimal key type (enum for descriptions, case-insensitive string for builds, direct value for point-buy config).

### Case-Insensitive Archetype Lookup

The build cache uses `StringComparer.OrdinalIgnoreCase` to support case-insensitive archetype lookups. This matches the behavior specified in the design specification and ensures consistent behavior regardless of how archetype IDs are passed from UI or other services.

### DerivedStats Section Excluded from DTOs

The `AttributeConfigurationDto` intentionally does not include a property for the `derivedStats` section of `attributes.json`. Derived stat formulas are loaded separately by the v0.17.2d system. The JSON deserializer with `PropertyNameCaseInsensitive = true` silently ignores unrecognized properties.

---

## Dependencies

### Prerequisites

- v0.17.2a (CoreAttribute Enum & Description) — Provides `CoreAttribute` enum and `AttributeDescription` value object
- v0.17.2b (Allocation Mode System) — Provides `AttributeAllocationMode` enum and `AttributeAllocationState` value object
- v0.17.2c (Point-Buy Cost System) — Provides `PointBuyConfiguration` and `PointBuyCost` value objects

### Provides to Future Phases

| Type | Phase | Usage |
| ---- | ----- | ----- |
| `IAttributeProvider` | v0.17.2f | Injected into AttributeAllocationService for data access |
| `IAttributeProvider` | v0.17.5 | Used by character creation UI for attribute step display |
