# v0.4.1b Changelog: Trap Mechanics

**Release Date:** 2026-01-12  
**Parent:** v0.4.1 (Traps & Environmental Hazards)  
**Prerequisites:** v0.4.1a (Core Trap System)

---

## Summary

v0.4.1b brings the trap system to full functionality with Perception-based detection, skill-based disarm attempts, automatic triggering on player actions, trap effects (damage, status effects, alerts), and saving throws. This phase integrates with DiceService, SkillCheckService, and StatusEffectService to provide complete trap mechanics.

---

## New Features

### TrapEffect Value Object
Represents the effect that occurs when a trap is triggered.

**Damage Properties:**
- `DamageDice` - Damage dice expression (e.g., "2d6")
- `DamageType` - Damage type (e.g., "piercing", "fire")

**Status Effect Properties:**
- `StatusEffects` - List of status effects to apply
- `StatusDuration` - Duration in turns (default: 3)

**Saving Throw Properties:**
- `SaveDC` - Difficulty class for the save
- `SaveAttribute` - Attribute used for save (e.g., "Agility", "Fortitude")
- `SaveHalvesDamage` - Whether successful save halves damage (true) or negates it (false)

**Alert Properties:**
- `TriggerMessage` - Custom message displayed on trigger
- `AlertsMonsters` - Whether trap alerts nearby monsters
- `AlertRadius` - Alert radius in rooms (0 = current room only)

**Computed Properties:**
- `DealsDamage` - Whether effect deals damage
- `AppliesStatus` - Whether effect applies status effects
- `HasSave` - Whether effect has a saving throw

**Factory Methods:**
- `FromDefinition()` - Creates from TrapEffectDefinition
- `Damage()` - Damage-only effect
- `Status()` - Status-only effect
- `Alert()` - Alert-only effect
- `DamageAndStatus()` - Combined damage and status effect

### TrapEffectResult Value Object
Captures the result of applying a trap's effect to a target.

**Properties:**
- `DamageDealt` - Total damage dealt
- `DamageType` - Type of damage dealt
- `DamageRolls` - Individual dice rolls for damage
- `SaveAttempted` - Whether a save was attempted
- `SaveSucceeded` - Whether the save was successful
- `SaveRoll` - The save roll total
- `SaveDC` - The difficulty class
- `StatusEffectsApplied` - List of applied status effects
- `MonstersAlerted` - Whether monsters were alerted
- `Message` - Message to display

**Factory Methods:**
- `DamageResult()` - Result for damage dealt
- `StatusResult()` - Result for status effects applied
- `AlertResult()` - Result for alert effect
- `Combined()` - Combined result with damage, status, and alert
- `SavedCompletely()` - Result where save completely negated effect

### TrapDisarmResult Value Object
Captures the result of attempting to disarm a trap.

**Properties:**
- `Success` - Whether disarm was successful
- `Message` - Message to display
- `RollTotal` - Skill check roll total
- `DisarmDC` - Difficulty class for disarm
- `Rolls` - Individual dice rolls
- `SkillModifier` - Skill modifier applied
- `TriggeredTrap` - Whether failure triggered the trap
- `TrapEffect` - Effect result if trap was triggered
- `CanRetry` - Whether the trap can be retried

**Factory Methods:**
- `Succeeded()` - Successful disarm
- `FailedSafely()` - Failed but didn't trigger
- `FailedAndTriggered()` - Failed and triggered the trap
- `CannotDisarm()` - Trap cannot be disarmed
- `NotDetected()` - Trap is not detected
- `AlreadyDisarmed()` - Trap is already disarmed

### TrapEffectDefinition Updates
Enhanced placeholder definition with full effect configuration:
- `DamageDice` - Damage dice expression
- `DamageType` - Damage type
- `StatusEffects` - Status effects list
- `StatusDuration` - Duration in turns
- `SaveDC` - Save difficulty class
- `SaveType` - Save attribute
- `SaveHalvesDamage` - Save halves vs negates damage
- `TriggerMessage` - Custom trigger message
- `AlertsMonsters` - Monster alert flag
- `AlertRadius` - Alert radius in rooms

### Trap Entity Updates
Added Effect property and updated FromDefinition:
- `Effect` - TrapEffect that occurs on trigger
- `HasEffect` - Whether trap has an effect configured
- `SetEffect()` - Sets the trap effect
- Updated `FromDefinition()` to load effects from definition

### InteractiveObject Updates (Trapped Containers)
Added trap attachment support for containers and doors:
- `AttachedTrapId` - ID of attached trap definition
- `HasAttachedTrap` - Whether object has attached trap
- `AttachTrap()` - Attaches a trap to the object
- `RemoveAttachedTrap()` - Removes attached trap

### ITrapService Interface Expansion
New methods for full trap mechanics:

**Detection Methods:**
- `SearchForTraps(Room, Player)` - Active Perception check vs trap DCs
- `PassivePerceptionCheck(Room, Player)` - Automatic check on room entry
- `GetPassivePerception(Player)` - Calculate passive Perception score

**Disarm Methods:**
- `AttemptDisarm(Room, string, Player)` - Skill check to disarm trap

**Effect Methods:**
- `ApplyTrapEffect(Trap, Player)` - Apply damage, status, and alerts
- `CheckEntryTraps(Room, Player)` - Check Step/Proximity traps on entry
- `CheckOpenTraps(Room, string, Player)` - Check Open/Touch traps on interaction

### TrapService Implementation Updates
Full implementation of trap mechanics:

**Detection Logic:**
- Active search uses Perception skill check against trap DetectionDC
- Passive Perception = 10 + Wits modifier + Perception skill bonus
- Multiple traps tested independently
- Only detected traps revealed on success

**Disarm Logic:**
- Uses DisableDevice (Finesse-based) skill check
- Success: Trap state -> Disarmed
- Fail by 1-4: Safe failure, can retry
- Fail by 5+: Triggers the trap
- Cannot disarm if not detected or CanBeDisarmed=false

**Effect Application:**
- Damage calculated via DiceService
- Saving throws use attribute + 1d20 vs SaveDC
- Save success: Halves damage (if SaveHalvesDamage=true) or negates
- Save success: Avoids status effects
- Status effects applied via StatusEffectService
- Monster alert flags set for AlertsMonsters=true

**Trigger Checks:**
- `CheckEntryTraps()` - Called on room entry
  - Step traps trigger if player enters trap location
  - Proximity traps trigger if within range
  - Detected traps auto-avoided
- `CheckOpenTraps()` - Called on container/door open
  - Open traps trigger on container open
  - Touch traps trigger on interaction
  - Checks AttachedTrapId match

### InteractionService Updates
Integration with trap checking:
- `Open(InteractiveObject, Room, Player)` - Now checks for attached traps before opening
- Returns trap effect results if trap triggers

### Configuration Updates
Enhanced trap definition schema with effects:

```json
{
  "traps": [
    {
      "id": "pressure-plate-dart",
      "name": "Dart Trap",
      "description": "A pressure plate connected to hidden dart launchers.",
      "triggerType": "Step",
      "detectionDC": 12,
      "disarmDC": 14,
      "canBeDisarmed": true,
      "resets": true,
      "resetDelay": 3,
      "effect": {
        "damageDice": "1d6",
        "damageType": "piercing",
        "saveDC": 12,
        "saveType": "Agility",
        "saveHalvesDamage": false,
        "triggerMessage": "Darts fly from hidden holes in the wall!"
      }
    }
  ]
}
```

---

## Modified Files

### Domain Layer
- `src/Core/RuneAndRust.Domain/ValueObjects/TrapEffect.cs` [NEW]
- `src/Core/RuneAndRust.Domain/ValueObjects/TrapEffectResult.cs` [NEW]
- `src/Core/RuneAndRust.Domain/ValueObjects/TrapDisarmResult.cs` [NEW]
- `src/Core/RuneAndRust.Domain/Definitions/TrapDefinition.cs` [MODIFIED]
- `src/Core/RuneAndRust.Domain/Entities/Trap.cs` [MODIFIED]
- `src/Core/RuneAndRust.Domain/Entities/InteractiveObject.cs` [MODIFIED]

### Application Layer
- `src/Core/RuneAndRust.Application/Interfaces/ITrapService.cs` [MODIFIED]
- `src/Core/RuneAndRust.Application/Services/TrapService.cs` [MODIFIED]
- `src/Core/RuneAndRust.Application/Interfaces/IInteractionService.cs` [MODIFIED]
- `src/Core/RuneAndRust.Application/Services/InteractionService.cs` [MODIFIED]

### Configuration
- `config/traps.json` [MODIFIED - Added effect definitions]
- `config/schemas/traps.schema.json` [MODIFIED - Effect schema]

### Tests
- `tests/RuneAndRust.Domain.UnitTests/ValueObjects/TrapEffectTests.cs` [NEW]
- `tests/RuneAndRust.Domain.UnitTests/ValueObjects/TrapEffectResultTests.cs` [NEW]
- `tests/RuneAndRust.Domain.UnitTests/ValueObjects/TrapDisarmResultTests.cs` [NEW]
- `tests/RuneAndRust.Domain.UnitTests/Entities/TrapEffectsTests.cs` [NEW]
- `tests/RuneAndRust.Domain.UnitTests/Entities/InteractiveObjectTrapTests.cs` [NEW]
- `tests/RuneAndRust.Application.UnitTests/Services/TrapServiceDetectionTests.cs` [NEW]
- `tests/RuneAndRust.Application.UnitTests/Services/TrapServiceDisarmTests.cs` [NEW]
- `tests/RuneAndRust.Application.UnitTests/Services/TrapServiceEffectTests.cs` [NEW]

---

## Test Results

```
Passed! - Failed: 0, Passed: 1073, Skipped: 0 - RuneAndRust.Domain.UnitTests.dll
Passed! - Failed: 0, Passed:  454, Skipped: 0 - RuneAndRust.Application.UnitTests.dll
Passed! - Failed: 0, Passed:    8, Skipped: 0 - RuneAndRust.Architecture.Tests.dll

Total: 1535 tests passed
New tests added: ~35
```

---

## Usage Examples

### Active Trap Detection (Search Command)
```csharp
// Player searches for traps
var result = trapService.SearchForTraps(room, player);

if (result.DetectedAny)
{
    Console.WriteLine(result.Message);
    // "You detect a Dart Trap hidden in the floor!"
    foreach (var trapName in result.DetectedTrapNames)
    {
        Console.WriteLine($"  - {trapName}");
    }
}
else
{
    Console.WriteLine("You don't find any hidden dangers.");
}
```

### Passive Perception on Room Entry
```csharp
// Called automatically when player enters room
var result = trapService.PassivePerceptionCheck(room, player);

if (result.DetectedAny)
{
    Console.WriteLine("Your keen senses alert you to danger!");
    Console.WriteLine(result.Message);
}
```

### Disarm Attempt
```csharp
// Player attempts to disarm a detected trap
var result = trapService.AttemptDisarm(room, "dart trap", player);

Console.WriteLine(result.Message);
// Success: "You carefully disable the Dart Trap. (Roll: 18 vs DC 14)"
// Safe fail: "You fumble with the mechanism but nothing happens. (Roll: 12 vs DC 14)"
// Triggered: "You trigger the trap! Darts fly from hidden holes in the wall!"

if (result.TriggeredTrap && result.TrapEffect.HasValue)
{
    Console.WriteLine($"You take {result.TrapEffect.Value.DamageDealt} {result.TrapEffect.Value.DamageType} damage!");
}
```

### Trap Effects
```csharp
// Creating effects
var dartEffect = TrapEffect.Damage(
    damageDice: "1d6",
    damageType: "piercing",
    saveDC: 12,
    saveAttribute: "Agility");

var poisonEffect = TrapEffect.DamageAndStatus(
    damageDice: "1d4",
    damageType: "poison",
    statusEffects: new[] { "poisoned" },
    saveDC: 13,
    saveAttribute: "Fortitude");

var alarmEffect = TrapEffect.Alert(
    message: "A loud gong sounds throughout the dungeon!",
    alertRadius: 3);
```

### Trapped Container
```csharp
// Create trapped chest
var chest = InteractiveObject.Create("trapped-chest", "Ornate Chest", "An decorated chest...",
    InteractiveObjectType.Chest, ObjectState.Closed);
chest.AttachTrap("poison-needle-trap");

// When player opens the chest
var openResult = interactionService.Open(chest, room, player);

if (openResult.TrapTriggered)
{
    Console.WriteLine(openResult.TrapEffectResult.Message);
    // "A poisoned needle springs from the lock! You take 3 poison damage!"
}
```

### Checking Entry Traps
```csharp
// Called when player moves into a room
var results = trapService.CheckEntryTraps(room, player);

foreach (var result in results)
{
    if (result.Triggered)
    {
        player.TakeDamage(result.DamageDealt);
        Console.WriteLine(result.Message);
    }
}
```

---

## Key Design Decisions

| Decision | Choice | Rationale |
|----------|--------|-----------|
| Passive Perception | 10 + Wits + Skill | Standard D&D formula |
| Disarm trigger threshold | Fail by 5+ | Balances risk/reward |
| Save halves vs negates | Configurable | Flexibility per trap type |
| Disarm skill | DisableDevice (Finesse) | Thematically appropriate |
| Detection on entry | Passive only | No slowdown, rewards Perception builds |
| Detected trap avoidance | Auto-avoid Step traps | Reward for detection |

---

## Breaking Changes

- `Open()` method on InteractionService now accepts optional `Room` and `Player` parameters for trap checking
- Existing code calling `Open(InteractiveObject)` continues to work but won't check for traps

---

## Metrics Summary

| Category | Before | After |
|----------|--------|-------|
| Domain Value Objects | 26 | 29 |
| TrapService methods | 10 | 17 |
| InteractiveObject properties | 15 | 17 |
| TrapEffectDefinition properties | 5 | 10 |
| Unit Tests | ~1500 | ~1535 |

---

## v0.4.1 Milestone Progress

| Sub-Version | Focus | Status |
|-------------|-------|--------|
| v0.4.1a | Core Trap System | âœ… Complete |
| v0.4.1b | Trap Mechanics | âœ… Complete |
| v0.4.1c | Environmental Hazards | ðŸ”² Pending |

---

## Future Work

- **v0.4.1c**: Environmental hazards (poison gas, fire, ice), hazard zones with ongoing damage, periodic dice saves for zone effects
- **Future**: Trap creation by players, trap respawning on room reset, complex multi-trigger traps
