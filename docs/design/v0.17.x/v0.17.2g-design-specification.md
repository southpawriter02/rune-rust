# v0.17.2g Design Specification: Derived Stat Calculator Service

**Version:** 0.17.2g  
**Phase Name:** Derived Stat Calculator Service  
**Parent Version:** v0.17.2 (Attribute System)  
**Prerequisites:** v0.17.2f Complete (Attribute Allocation Service)  
**Estimated Tests:** ~10 unit tests

---

## Table of Contents

1. [Executive Summary](#1-executive-summary)
2. [Feature Overview](#2-feature-overview)
3. [Architecture Diagrams](#3-architecture-diagrams)
4. [IDerivedStatCalculator Interface](#4-iderivedstatcalculator-interface)
5. [DerivedStatCalculator Implementation](#5-derivedstatcalculator-implementation)
6. [Data Model Changes](#6-data-model-changes)
7. [Logging Specifications](#7-logging-specifications)
8. [Unit Testing Requirements](#8-unit-testing-requirements)
9. [Use Cases](#9-use-cases)
10. [User Stories](#10-user-stories)
11. [Deliverable Checklist](#11-deliverable-checklist)
12. [Acceptance Criteria](#12-acceptance-criteria)
13. [Dependencies](#13-dependencies)
14. [Future Considerations](#14-future-considerations)

---

## 1. Executive Summary

### 1.1 Purpose

This specification defines the `IDerivedStatCalculator` interface and its implementation for calculating derived statistics from character attributes, archetype bonuses, and lineage bonuses. This service provides both final calculations and real-time previews during attribute allocation.

### 1.2 Key Deliverables

| Category       | Items                    |
| -------------- | ------------------------ |
| **Interfaces** | `IDerivedStatCalculator` |
| **Services**   | `DerivedStatCalculator`  |
| **Tests**      | ~10 unit tests           |

### 1.3 Architectural Significance

- **Formula-Driven**: Uses `DerivedStatFormula` definitions from configuration
- **Real-Time Preview**: Supports live stat updates during allocation
- **Multi-Source Bonuses**: Combines attribute scaling, archetype, and lineage bonuses
- **Single Stat Calculation**: Supports calculating individual stats for efficiency

---

## 2. Feature Overview

```
v0.17.2g Derived Stat Calculator Service
├── IDerivedStatCalculator Interface
│   ├── CalculateDerivedStats(attributes, archetypeId, lineageId)
│   ├── CalculateStat(statName, attributes, archetypeId, lineageId)
│   └── GetPreview(allocationState, archetypeId, lineageId)
├── DerivedStatCalculator Implementation
│   ├── Formula loading from configuration
│   ├── Attribute value extraction
│   ├── Bonus application (archetype + lineage)
│   └── Multiplier application
└── Calculated Stats
    ├── MaxHp, MaxStamina, MaxAetherPool
    ├── Initiative, Soak
    └── MovementSpeed, CarryingCapacity
```

### 2.1 Scope Alignment

**In Scope:**

- `IDerivedStatCalculator` interface with 3 methods
- `DerivedStatCalculator` implementation
- Formula application for all 7 derived stats
- Preview support from `AttributeAllocationState`
- Archetype and lineage bonus application

**Out of Scope:**

- UI integration → v0.17.5
- Equipment modifiers → future version
- Buff/debuff effects → future version

---

## 3. Architecture Diagrams

### 3.1 Calculator Service Overview

```
┌─────────────────────────────────────────────────────────────────────┐
│              DERIVED STAT CALCULATOR SERVICE OVERVIEW                │
└─────────────────────────────────────────────────────────────────────┘

    Character Creation UI / Combat System
           │
           │  Request derived stats
           ▼
┌─────────────────────────────────────────────────────────────────────┐
│                   IDerivedStatCalculator                             │
├─────────────────────────────────────────────────────────────────────┤
│  + CalculateDerivedStats(attributes, archetypeId, lineageId)        │
│  + CalculateStat(statName, attributes, archetypeId, lineageId)      │
│  + GetPreview(allocationState, archetypeId, lineageId)              │
└─────────────────────────────────────────────────────────────────────┘
           │
           │  Uses
           ▼
┌─────────────────────────────────────────────────────────────────────┐
│                     Formula Definitions                              │
├─────────────────────────────────────────────────────────────────────┤
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐                  │
│  │ Max HP      │  │ Max Stamina │  │ Max Aether  │                  │
│  │ Formula     │  │ Formula     │  │ Pool Formula│                  │
│  ├─────────────┤  ├─────────────┤  ├─────────────┤                  │
│  │ Base: 50    │  │ Base: 20    │  │ Base: 0     │                  │
│  │ STURD × 10  │  │ FIN × 5     │  │ WILL × 10   │                  │
│  │ + Arch bonus│  │ MIG × 5     │  │ WITS × 5    │                  │
│  │ + Lin bonus │  │ + Arch bonus│  │ + Arch bonus│                  │
│  └─────────────┘  └─────────────┘  └─────────────┘                  │
└─────────────────────────────────────────────────────────────────────┘
           │
           ▼
┌─────────────────────────────────────────────────────────────────────┐
│                        DerivedStats                                  │
├─────────────────────────────────────────────────────────────────────┤
│  MaxHp: 139, MaxStamina: 60, MaxAetherPool: 30, ...                 │
└─────────────────────────────────────────────────────────────────────┘
```

### 3.2 Calculation Flow

```
┌─────────────────────────────────────────────────────────────────────┐
│                     CALCULATION FLOW                                 │
└─────────────────────────────────────────────────────────────────────┘

    CalculateDerivedStats(attributes, archetypeId, lineageId)
           │
           ▼
    ┌──────────────────────────────────────────────────────────────────┐
    │ 1. Build attribute value dictionary                              │
    │    Map<CoreAttribute, int> from attributes parameter             │
    └──────────────────────────────────────────────────────────────────┘
           │
           ▼
    ┌──────────────────────────────────────────────────────────────────┐
    │ 2. For each derived stat formula:                                │
    │    a. Start with BaseValue                                       │
    │    b. Apply attribute scaling                                    │
    │       For each (attr, scale) in AttributeScaling:                │
    │         value += attributes[attr] × scale                        │
    │    c. Apply archetype bonus (if exists)                          │
    │    d. Apply lineage bonus (if exists)                            │
    │    e. Apply lineage multiplier (if exists)                       │
    │    f. Convert to int                                             │
    └──────────────────────────────────────────────────────────────────┘
           │
           ▼
    ┌──────────────────────────────────────────────────────────────────┐
    │ 3. Assemble DerivedStats value object                            │
    │    Return new DerivedStats(maxHp, maxStamina, ...)              │
    └──────────────────────────────────────────────────────────────────┘
```

### 3.3 Preview Flow

```
┌─────────────────────────────────────────────────────────────────────┐
│                       PREVIEW FLOW                                   │
└─────────────────────────────────────────────────────────────────────┘

    GetPreview(allocationState, archetypeId, lineageId)
           │
           ▼
    ┌──────────────────────────────────────────────────────────────────┐
    │ 1. Extract attribute values from AllocationState                 │
    │    Might = state.CurrentMight                                    │
    │    Finesse = state.CurrentFinesse                                │
    │    Wits = state.CurrentWits                                      │
    │    Will = state.CurrentWill                                      │
    │    Sturdiness = state.CurrentSturdiness                          │
    └──────────────────────────────────────────────────────────────────┘
           │
           ▼
    ┌──────────────────────────────────────────────────────────────────┐
    │ 2. Build attribute dictionary                                    │
    │    { Might: value, Finesse: value, ... }                        │
    └──────────────────────────────────────────────────────────────────┘
           │
           ▼
    ┌──────────────────────────────────────────────────────────────────┐
    │ 3. Call CalculateDerivedStats(attributes, archetypeId, lineageId)│
    └──────────────────────────────────────────────────────────────────┘
           │
           ▼
    Return DerivedStats (preview for UI display)
```

### 3.4 Stat Calculation Examples

```
┌─────────────────────────────────────────────────────────────────────┐
│                 STAT CALCULATION EXAMPLES                            │
└─────────────────────────────────────────────────────────────────────┘

    Example: Warrior (M4, F3, Wi2, Wl2, S4)
    ┌─────────────────────────────────────────────────────────────────┐
    │  MAX HP:                                                        │
    │    Base: 50                                                     │
    │    + Sturdiness (4) × 10 = 40                                   │
    │    + Warrior bonus = 49                                         │
    │    = 139                                                        │
    ├─────────────────────────────────────────────────────────────────┤
    │  MAX STAMINA:                                                   │
    │    Base: 20                                                     │
    │    + Finesse (3) × 5 = 15                                       │
    │    + Might (4) × 5 = 20                                         │
    │    + Warrior bonus = 5                                          │
    │    = 60                                                         │
    ├─────────────────────────────────────────────────────────────────┤
    │  MAX AETHER POOL:                                               │
    │    Base: 0                                                      │
    │    + Will (2) × 10 = 20                                         │
    │    + Wits (2) × 5 = 10                                          │
    │    + Warrior bonus = 0                                          │
    │    = 30                                                         │
    ├─────────────────────────────────────────────────────────────────┤
    │  INITIATIVE:                                                    │
    │    Base: 0                                                      │
    │    + Finesse (3) × 1 = 3                                        │
    │    + Wits (2) × 0.5 = 1                                         │
    │    = 4                                                          │
    └─────────────────────────────────────────────────────────────────┘

    Example: Mystic + Rune-Marked (M2, F3, Wi4, Wl4, S2)
    ┌─────────────────────────────────────────────────────────────────┐
    │  MAX AETHER POOL (with multiplier):                             │
    │    Base: 0                                                      │
    │    + Will (4) × 10 = 40                                         │
    │    + Wits (4) × 5 = 20                                          │
    │    + Mystic bonus = 20                                          │
    │    + Rune-Marked bonus = 5                                      │
    │    = 85                                                         │
    │    × Rune-Marked multiplier (1.10)                              │
    │    = 93 (rounded down)                                          │
    └─────────────────────────────────────────────────────────────────┘
```

---

## 4. IDerivedStatCalculator Interface

### 4.1 Purpose

The `IDerivedStatCalculator` interface defines the contract for calculating derived statistics from attributes and bonuses.

### 4.2 Implementation

**File:** `src/Core/RuneAndRust.Application/Interfaces/IDerivedStatCalculator.cs`

```csharp
namespace RuneAndRust.Application.Interfaces;

using RuneAndRust.Domain.Enums;
using RuneAndRust.Domain.ValueObjects;

/// <summary>
/// Calculates derived statistics from character attributes.
/// </summary>
/// <remarks>
/// <para>
/// This service computes secondary stats (HP, Stamina, Aether Pool, etc.)
/// from core attributes, applying archetype and lineage bonuses.
/// </para>
/// <para>
/// The GetPreview method supports real-time feedback during attribute
/// allocation, allowing players to see how changes affect their stats.
/// </para>
/// </remarks>
public interface IDerivedStatCalculator
{
    /// <summary>
    /// Calculates all derived stats from attribute values.
    /// </summary>
    /// <param name="attributes">Dictionary of attribute values.</param>
    /// <param name="archetypeId">The character's archetype ID.</param>
    /// <param name="lineageId">The character's lineage ID.</param>
    /// <returns>Complete derived statistics.</returns>
    DerivedStats CalculateDerivedStats(
        IReadOnlyDictionary<CoreAttribute, int> attributes,
        string archetypeId,
        string? lineageId);

    /// <summary>
    /// Calculates a single derived stat.
    /// </summary>
    /// <param name="statName">The stat to calculate (e.g., "MaxHp").</param>
    /// <param name="attributes">Dictionary of attribute values.</param>
    /// <param name="archetypeId">The character's archetype ID.</param>
    /// <param name="lineageId">The character's lineage ID.</param>
    /// <returns>The calculated stat value.</returns>
    int CalculateStat(
        string statName,
        IReadOnlyDictionary<CoreAttribute, int> attributes,
        string archetypeId,
        string? lineageId);

    /// <summary>
    /// Gets a preview of derived stats from allocation state.
    /// </summary>
    /// <param name="state">The current allocation state.</param>
    /// <param name="archetypeId">The character's archetype ID.</param>
    /// <param name="lineageId">The character's lineage ID.</param>
    /// <returns>Preview of derived statistics.</returns>
    /// <remarks>
    /// Use this during attribute allocation to show real-time
    /// feedback as the player adjusts attribute values.
    /// </remarks>
    DerivedStats GetPreview(
        AttributeAllocationState state,
        string archetypeId,
        string? lineageId);
}
```

---

## 5. DerivedStatCalculator Implementation

### 5.1 Purpose

The `DerivedStatCalculator` applies formula definitions to compute derived statistics.

### 5.2 Implementation

**File:** `src/Core/RuneAndRust.Application/Services/DerivedStatCalculator.cs`

```csharp
namespace RuneAndRust.Application.Services;

using Microsoft.Extensions.Logging;
using RuneAndRust.Application.Interfaces;
using RuneAndRust.Domain.Enums;
using RuneAndRust.Domain.ValueObjects;

/// <summary>
/// Calculates derived statistics from attributes and bonuses.
/// </summary>
public class DerivedStatCalculator : IDerivedStatCalculator
{
    private readonly IReadOnlyDictionary<string, DerivedStatFormula> _formulas;
    private readonly ILogger<DerivedStatCalculator> _logger;

    public DerivedStatCalculator(
        IReadOnlyDictionary<string, DerivedStatFormula> formulas,
        ILogger<DerivedStatCalculator> logger)
    {
        _formulas = formulas;
        _logger = logger;

        _logger.LogInformation(
            "DerivedStatCalculator initialized with {Count} formulas",
            _formulas.Count);
    }

    /// <inheritdoc />
    public DerivedStats CalculateDerivedStats(
        IReadOnlyDictionary<CoreAttribute, int> attributes,
        string archetypeId,
        string? lineageId)
    {
        _logger.LogDebug(
            "Calculating derived stats for Archetype={Archetype}, Lineage={Lineage}",
            archetypeId, lineageId);

        var maxHp = CalculateStatInternal("maxHp", attributes, archetypeId, lineageId);
        var maxStamina = CalculateStatInternal("maxStamina", attributes, archetypeId, lineageId);
        var maxAetherPool = CalculateStatInternal("maxAetherPool", attributes, archetypeId, lineageId);
        var initiative = CalculateStatInternal("initiative", attributes, archetypeId, lineageId);
        var soak = CalculateStatInternal("soak", attributes, archetypeId, lineageId);
        var movementSpeed = CalculateStatInternal("movementSpeed", attributes, archetypeId, lineageId);
        var carryingCapacity = CalculateStatInternal("carryingCapacity", attributes, archetypeId, lineageId);

        var stats = DerivedStats.Create(
            maxHp, maxStamina, maxAetherPool,
            initiative, soak, movementSpeed, carryingCapacity);

        _logger.LogDebug("Calculated derived stats: {Stats}", stats.GetSummary());

        return stats;
    }

    /// <inheritdoc />
    public int CalculateStat(
        string statName,
        IReadOnlyDictionary<CoreAttribute, int> attributes,
        string archetypeId,
        string? lineageId)
    {
        return CalculateStatInternal(
            statName.ToLowerInvariant(),
            attributes,
            archetypeId,
            lineageId);
    }

    /// <inheritdoc />
    public DerivedStats GetPreview(
        AttributeAllocationState state,
        string archetypeId,
        string? lineageId)
    {
        _logger.LogDebug("Generating preview from allocation state");

        var attributes = ExtractAttributesFromState(state);
        return CalculateDerivedStats(attributes, archetypeId, lineageId);
    }

    private int CalculateStatInternal(
        string statName,
        IReadOnlyDictionary<CoreAttribute, int> attributes,
        string archetypeId,
        string? lineageId)
    {
        if (!_formulas.TryGetValue(statName, out var formula))
        {
            _logger.LogWarning("Unknown stat requested: {StatName}", statName);
            return 0;
        }

        var result = formula.Calculate(attributes, archetypeId, lineageId);

        _logger.LogDebug(
            "Calculated {StatName}={Value} (arch={Archetype}, lineage={Lineage})",
            statName, result, archetypeId, lineageId);

        return result;
    }

    private static Dictionary<CoreAttribute, int> ExtractAttributesFromState(
        AttributeAllocationState state) =>
        new()
        {
            { CoreAttribute.Might, state.CurrentMight },
            { CoreAttribute.Finesse, state.CurrentFinesse },
            { CoreAttribute.Wits, state.CurrentWits },
            { CoreAttribute.Will, state.CurrentWill },
            { CoreAttribute.Sturdiness, state.CurrentSturdiness }
        };

    /// <summary>
    /// Creates a calculator with default formulas.
    /// </summary>
    public static DerivedStatCalculator CreateWithDefaultFormulas(
        ILogger<DerivedStatCalculator> logger)
    {
        var formulas = CreateDefaultFormulas();
        return new DerivedStatCalculator(formulas, logger);
    }

    private static Dictionary<string, DerivedStatFormula> CreateDefaultFormulas() =>
        new()
        {
            ["maxHp"] = DerivedStatFormula.Create(
                "MaxHp",
                baseValue: 50,
                attributeScaling: new Dictionary<CoreAttribute, float>
                    { { CoreAttribute.Sturdiness, 10f } },
                archetypeBonuses: new Dictionary<string, int>
                    { { "warrior", 49 }, { "skirmisher", 30 }, { "mystic", 20 }, { "adept", 30 } },
                lineageBonuses: new Dictionary<string, int>
                    { { "clan-born", 5 } }),

            ["maxStamina"] = DerivedStatFormula.Create(
                "MaxStamina",
                baseValue: 20,
                attributeScaling: new Dictionary<CoreAttribute, float>
                    { { CoreAttribute.Finesse, 5f }, { CoreAttribute.Might, 5f } },
                archetypeBonuses: new Dictionary<string, int>
                    { { "warrior", 5 }, { "skirmisher", 5 } }),

            ["maxAetherPool"] = DerivedStatFormula.Create(
                "MaxAetherPool",
                baseValue: 0,
                attributeScaling: new Dictionary<CoreAttribute, float>
                    { { CoreAttribute.Will, 10f }, { CoreAttribute.Wits, 5f } },
                archetypeBonuses: new Dictionary<string, int>
                    { { "mystic", 20 } },
                lineageBonuses: new Dictionary<string, int>
                    { { "rune-marked", 5 } },
                lineageMultipliers: new Dictionary<string, float>
                    { { "rune-marked", 1.10f } }),

            ["initiative"] = DerivedStatFormula.Create(
                "Initiative",
                baseValue: 0,
                attributeScaling: new Dictionary<CoreAttribute, float>
                    { { CoreAttribute.Finesse, 1f }, { CoreAttribute.Wits, 0.5f } }),

            ["soak"] = DerivedStatFormula.Create(
                "Soak",
                baseValue: 0,
                attributeScaling: new Dictionary<CoreAttribute, float>
                    { { CoreAttribute.Sturdiness, 0.5f } },
                lineageBonuses: new Dictionary<string, int>
                    { { "iron-blooded", 2 } }),

            ["movementSpeed"] = DerivedStatFormula.Create(
                "MovementSpeed",
                baseValue: 5,
                attributeScaling: new Dictionary<CoreAttribute, float>(),
                lineageBonuses: new Dictionary<string, int>
                    { { "vargr-kin", 1 } }),

            ["carryingCapacity"] = DerivedStatFormula.Create(
                "CarryingCapacity",
                baseValue: 0,
                attributeScaling: new Dictionary<CoreAttribute, float>
                    { { CoreAttribute.Might, 10f } })
        };
}
```

---

## 6. Data Model Changes

### 6.1 New Types Summary

| Type                     | Layer       | Category  | Description                  |
| ------------------------ | ----------- | --------- | ---------------------------- |
| `IDerivedStatCalculator` | Application | Interface | Stat calculation contract    |
| `DerivedStatCalculator`  | Application | Service   | Implementation with formulas |

### 6.2 File Locations

```
src/Core/RuneAndRust.Application/
├── Interfaces/
│   └── IDerivedStatCalculator.cs            ← NEW
├── Services/
│   └── DerivedStatCalculator.cs             ← NEW
```

---

## 7. Logging Specifications

| Event                  | Level       | Template                                                        |
| ---------------------- | ----------- | --------------------------------------------------------------- |
| Calculator initialized | Information | "DerivedStatCalculator initialized with {Count} formulas"       |
| Stats calculated       | Debug       | "Calculating derived stats for Archetype={Arch}, Lineage={Lin}" |
| Single stat calculated | Debug       | "Calculated {StatName}={Value}"                                 |
| Preview generated      | Debug       | "Generating preview from allocation state"                      |
| Unknown stat requested | Warning     | "Unknown stat requested: {StatName}"                            |
| Final stats            | Debug       | "Calculated derived stats: {Stats}"                             |

---

## 8. Unit Testing Requirements

### 8.1 Test Count: ~10 tests

```csharp
[TestFixture]
public class DerivedStatCalculatorTests
{
    private IDerivedStatCalculator _calculator;

    [SetUp]
    public void Setup()
    {
        var loggerMock = new Mock<ILogger<DerivedStatCalculator>>();
        _calculator = DerivedStatCalculator.CreateWithDefaultFormulas(loggerMock.Object);
    }

    [Test]
    public void CalculateDerivedStats_WarriorBuild_ReturnsCorrectHp()
    {
        var attributes = CreateWarriorAttributes();

        var stats = _calculator.CalculateDerivedStats(attributes, "warrior", null);

        stats.MaxHp.Should().Be(139); // (4×10) + 50 + 49
    }

    [Test]
    public void CalculateDerivedStats_WarriorBuild_ReturnsCorrectStamina()
    {
        var attributes = CreateWarriorAttributes();

        var stats = _calculator.CalculateDerivedStats(attributes, "warrior", null);

        stats.MaxStamina.Should().Be(60); // (3×5) + (4×5) + 20 + 5
    }

    [Test]
    public void CalculateDerivedStats_MysticBuild_ReturnsCorrectAetherPool()
    {
        var attributes = CreateMysticAttributes();

        var stats = _calculator.CalculateDerivedStats(attributes, "mystic", null);

        stats.MaxAetherPool.Should().Be(80); // (4×10) + (4×5) + 20
    }

    [Test]
    public void CalculateDerivedStats_WithClanBornLineage_AddsHpBonus()
    {
        var attributes = CreateWarriorAttributes();

        var stats = _calculator.CalculateDerivedStats(attributes, "warrior", "clan-born");

        stats.MaxHp.Should().Be(144); // 139 + 5
    }

    [Test]
    public void CalculateDerivedStats_RuneMarkedMystic_AppliesMultiplier()
    {
        var attributes = CreateMysticAttributes();

        var stats = _calculator.CalculateDerivedStats(attributes, "mystic", "rune-marked");

        // (40 + 20 + 20 + 5) × 1.10 = 93.5 → 93
        stats.MaxAetherPool.Should().Be(93);
    }

    [Test]
    public void CalculateDerivedStats_IronBlooded_AddsSoakBonus()
    {
        var attributes = CreateWarriorAttributes();

        var stats = _calculator.CalculateDerivedStats(attributes, "warrior", "iron-blooded");

        stats.Soak.Should().Be(4); // (4÷2) + 2
    }

    [Test]
    public void CalculateDerivedStats_VargrKin_AddsMovementSpeed()
    {
        var attributes = CreateWarriorAttributes();

        var stats = _calculator.CalculateDerivedStats(attributes, "warrior", "vargr-kin");

        stats.MovementSpeed.Should().Be(6); // 5 + 1
    }

    [Test]
    public void GetPreview_FromAllocationState_CalculatesCorrectly()
    {
        var state = AttributeAllocationState.CreateFromRecommendedBuild(
            "warrior", 4, 3, 2, 2, 4, 15);

        var preview = _calculator.GetPreview(state, "warrior", null);

        preview.MaxHp.Should().Be(139);
        preview.MaxStamina.Should().Be(60);
    }

    [Test]
    public void CalculateStat_SingleStat_ReturnsCorrectValue()
    {
        var attributes = CreateWarriorAttributes();

        var hp = _calculator.CalculateStat("MaxHp", attributes, "warrior", null);

        hp.Should().Be(139);
    }

    [Test]
    public void CalculateStat_UnknownStat_ReturnsZero()
    {
        var attributes = CreateWarriorAttributes();

        var result = _calculator.CalculateStat("UnknownStat", attributes, "warrior", null);

        result.Should().Be(0);
    }

    private static Dictionary<CoreAttribute, int> CreateWarriorAttributes() =>
        new()
        {
            { CoreAttribute.Might, 4 },
            { CoreAttribute.Finesse, 3 },
            { CoreAttribute.Wits, 2 },
            { CoreAttribute.Will, 2 },
            { CoreAttribute.Sturdiness, 4 }
        };

    private static Dictionary<CoreAttribute, int> CreateMysticAttributes() =>
        new()
        {
            { CoreAttribute.Might, 2 },
            { CoreAttribute.Finesse, 3 },
            { CoreAttribute.Wits, 4 },
            { CoreAttribute.Will, 4 },
            { CoreAttribute.Sturdiness, 2 }
        };
}
```

---

## 9. Use Cases

| ID     | Use Case                  | Flow                                                                 |
| ------ | ------------------------- | -------------------------------------------------------------------- |
| UC-001 | Preview During Allocation | Player changes attribute → `GetPreview()` → Update stat display      |
| UC-002 | Finalize Character Stats  | Complete allocation → `CalculateDerivedStats()` → Store on character |
| UC-003 | Calculate Single Stat     | Check specific stat → `CalculateStat()` → Return value               |

---

## 10. User Stories

**US-001:** As a player, I want to see my HP, Stamina, and AP update in real-time as I allocate attributes.

**US-002:** As a Clan-Born character, I want my +5 HP bonus reflected in my derived stats.

**US-003:** As a Rune-Marked Mystic, I want my enhanced Aether Pool calculated with the 1.10 multiplier.

---

## 11. Deliverable Checklist

- [ ] `IDerivedStatCalculator` interface with 3 methods
- [ ] `DerivedStatCalculator` implementation
- [ ] Default formula factory method
- [ ] All 7 derived stat formulas implemented
- [ ] Lineage multiplier support (Rune-Marked)
- [ ] ~10 unit tests implemented and passing
- [ ] XML documentation complete

---

## 12. Acceptance Criteria

### Functional

- [ ] Warrior HP = 139 with standard build
- [ ] Warrior Stamina = 60 with standard build
- [ ] Mystic AP = 80 with standard build
- [ ] Clan-Born adds +5 HP
- [ ] Rune-Marked applies +5 then ×1.10 to AP (result = 93)
- [ ] Iron-Blooded adds +2 Soak
- [ ] Vargr-Kin adds +1 Movement Speed
- [ ] `GetPreview()` matches `CalculateDerivedStats()`

### Quality

- [ ] Build succeeds with 0 errors/warnings
- [ ] All ~10 unit tests pass
- [ ] XML documentation complete

---

## 13. Dependencies

### Required from Previous Phases

| Type                       | Phase    | Usage                 |
| -------------------------- | -------- | --------------------- |
| `CoreAttribute`            | v0.17.2a | Attribute identifiers |
| `AttributeAllocationState` | v0.17.2b | Preview input         |
| `DerivedStats`             | v0.17.2d | Return type           |
| `DerivedStatFormula`       | v0.17.2d | Formula definitions   |

### Provides to Future Phases

| Type                     | Phase   | Usage                         |
| ------------------------ | ------- | ----------------------------- |
| `IDerivedStatCalculator` | v0.17.5 | Character creation UI preview |
| `IDerivedStatCalculator` | v0.18.x | Combat system stat access     |

---

## 14. Future Considerations

### Deferred to v0.17.5

- UI integration for real-time preview display

### Deferred to Future Versions

- Equipment modifiers to derived stats
- Buff/debuff effects
- Level-based stat scaling
- Formula caching optimization

### Out of Scope for v0.17.2

- Temporary stat modifications
- Stat change events/notifications

---

## 15. Version Completion Summary

This phase (v0.17.2g) completes the **v0.17.2 Attribute System**. All 7 sub-phases are now defined:

| Phase    | Name                            | Status |
| -------- | ------------------------------- | ------ |
| v0.17.2a | Core Attribute Enum             | ✅     |
| v0.17.2b | Allocation Mode System          | ✅     |
| v0.17.2c | Point-Buy Cost System           | ✅     |
| v0.17.2d | Derived Stat Calculation        | ✅     |
| v0.17.2e | Attribute Provider Service      | ✅     |
| v0.17.2f | Attribute Allocation Service    | ✅     |
| v0.17.2g | Derived Stat Calculator Service | ✅     |

**Total Estimated Tests:** ~56 unit tests

---

_Document Version: 1.0_  
_Last Updated: 2025-01-27_
