## Phase 5d: Configuration & Polish

[Implementation Plan](v0.0.5d-implementation-plan.md)

### Overview
Complete the presentation layer integration, add commands, and polish the dice display.

### Files to Create/Modify

#### 1. Input Handling

**Commands to Add:**
- `roll <notation>` - Roll dice directly (e.g., "roll 3d6+5")
- `check <skill> [difficulty]` - Perform skill check

**File:** `src/Core/RuneAndRust.Application/Interfaces/IInputHandler.cs` (MODIFY)
```csharp
public record RollCommand(string Notation) : ICommand;
public record SkillCheckCommand(string SkillId, string? DifficultyId = null) : ICommand;
```

#### 2. Rendering

**File:** `src/Core/RuneAndRust.Application/Interfaces/IGameRenderer.cs` (MODIFY)
```csharp
Task RenderDiceRollAsync(DiceRollDto roll, CancellationToken ct = default);
Task RenderSkillCheckAsync(SkillCheckResultDto result, CancellationToken ct = default);
Task RenderCombatRoundAsync(CombatRoundResultDto result, CancellationToken ct = default);
```

**File:** `src/Presentation/RuneAndRust.Presentation.Tui/Adapters/SpectreGameRenderer.cs` (MODIFY)

```csharp
public Task RenderDiceRollAsync(DiceRollDto roll, CancellationToken ct = default)
{
    var table = new Table()
        .Border(TableBorder.Rounded)
        .AddColumn("Dice")
        .AddColumn("Rolls")
        .AddColumn("Total");

    var rollsDisplay = string.Join(", ", roll.Rolls);
    if (roll.HadExplosions)
    {
        rollsDisplay += $" [yellow]+ explosions: {string.Join(", ", roll.ExplosionRolls)}[/]";
    }

    var totalColor = roll.IsNaturalMax ? "green" : roll.IsNaturalOne ? "red" : "white";
    var totalDisplay = $"[{totalColor}]{roll.Total}[/]";

    if (roll.IsNaturalMax)
        totalDisplay += " [green bold]CRITICAL![/]";
    else if (roll.IsNaturalOne)
        totalDisplay += " [red bold]FUMBLE![/]";

    table.AddRow(
        roll.Notation,
        $"[{rollsDisplay}] {(roll.Modifier != 0 ? $"+ {roll.Modifier}" : "")}",
        totalDisplay);

    if (roll.Descriptor != null)
    {
        AnsiConsole.MarkupLine($"[italic]{roll.Descriptor}[/]");
    }

    AnsiConsole.Write(table);
    return Task.CompletedTask;
}
```

#### 3. View Handling

**File:** `src/Presentation/RuneAndRust.Presentation.Tui/Views/GameView.cs` (MODIFY)

```csharp
private async Task HandleRollCommandAsync(string notation, CancellationToken ct)
{
    try
    {
        var result = _diceService.Roll(notation);
        var descriptor = GetDiceDescriptor(result);
        var dto = DiceRollDto.FromDomainResult(result, descriptor);
        await _renderer.RenderDiceRollAsync(dto, ct);
    }
    catch (FormatException ex)
    {
        await _renderer.RenderMessageAsync($"Invalid dice notation: {ex.Message}", MessageType.Error, ct);
    }
}

private string? GetDiceDescriptor(DiceRollResult result)
{
    if (result.IsNaturalMax)
        return _descriptorService.GetDescriptor("dice.natural_max");
    if (result.IsNaturalOne)
        return _descriptorService.GetDescriptor("dice.natural_one");
    // Use percentage of max for high/low rolls
    var percentage = (float)result.DiceTotal / result.Pool.MaximumResult;
    if (percentage >= 0.75f)
        return _descriptorService.GetDescriptor("dice.high_rolls");
    if (percentage <= 0.25f)
        return _descriptorService.GetDescriptor("dice.low_rolls");
    return null;
}
```

### Phase 5d Tests (~9 tests)

**File:** `tests/RuneAndRust.Application.UnitTests/Services/DiceDescriptorTests.cs` (~3 tests)

**File:** Integration tests for roll and check commands (~6 tests)

### Phase 5d Deliverables Checklist

- [ ] Add `roll` command to input handler
- [ ] Add `check` command to input handler
- [ ] Implement `RenderDiceRollAsync` in SpectreGameRenderer
- [ ] Implement `RenderSkillCheckAsync` in SpectreGameRenderer
- [ ] Implement `RenderCombatRoundAsync` in SpectreGameRenderer
- [ ] Add `HandleRollCommandAsync` to GameView
- [ ] Add `HandleSkillCheckCommandAsync` to GameView
- [ ] Integrate descriptors with dice rolls
- [ ] 9 new tests
- [ ] All tests pass
- [ ] Build with 0 errors/warnings

---

## Testing Strategy

### Test Categories

| Category | Location | Count | Coverage |
|----------|----------|-------|----------|
| Domain Value Objects | Domain.UnitTests/ValueObjects/ | ~20 | DicePool, DiceRollResult, SkillCheckResult |
| Domain Definitions | Domain.UnitTests/Definitions/ | ~8 | SkillDefinition, DifficultyClassDefinition |
| Application Services | Application.UnitTests/Services/ | ~25 | DiceService, SkillCheckService |
| Integration | Application.UnitTests/Integration/ | ~9 | Command handling, rendering |

### Test Patterns

```csharp
// Pattern 1: Deterministic Testing with Seeded Random
[Test]
public void Roll_WithSeededRandom_ProducesExpectedResult()
{
    var seededRandom = new Random(42); // Fixed seed
    var service = new DiceService(_mockLogger.Object, seededRandom);

    var result = service.Roll(DicePool.D20());

    result.Rolls[0].Should().Be(/* expected value for seed 42 */);
}

// Pattern 2: Statistical Testing
[Test]
public void Roll_ManyTimes_ProducesUniformDistribution()
{
    var results = Enumerable.Range(0, 10000)
        .Select(_ => _service.Roll(DicePool.D6()))
        .GroupBy(r => r.Total)
        .ToDictionary(g => g.Key, g => g.Count());

    // Each face should appear roughly 1666 times (10000/6)
    foreach (var count in results.Values)
    {
        count.Should().BeInRange(1400, 1900);
    }
}

// Pattern 3: Boundary Testing
[Test]
public void Roll_NeverExceedsMaximum()
{
    var pool = new DicePool(3, DiceType.D6, 5);
    var results = Enumerable.Range(0, 1000).Select(_ => _service.Roll(pool));

    results.Should().AllSatisfy(r => r.Total.Should().BeLessThanOrEqualTo(23));
}
```

### Mock Configurations

```csharp
// IGameConfigurationProvider mock for skills
_mockConfig.Setup(c => c.GetSkillById("perception"))
    .Returns(SkillDefinition.Create(
        "perception", "Perception", "Notice things",
        "wits", null, "1d20"));

_mockConfig.Setup(c => c.GetDifficultyClassById("moderate"))
    .Returns(DifficultyClassDefinition.Create(
        "moderate", "Moderate", "Requires effort", 12));
```

---

## Logging Strategy

### Log Levels by Operation

| Operation | Level | Example |
|-----------|-------|---------|
| Service initialization | Information | "DiceService initialized" |
| Roll request | Debug | "Rolling 3d6+5 with Advantage" |
| Individual die | Debug | "Die 1: rolled 4 on d6" |
| Explosion | Debug | "Die exploded! Roll 6 on d6" |
| Roll complete | Information | "Roll 3d6+5: [4,2,6]+5=17" |
| Skill check request | Debug | "Skill check: perception vs DC 15" |
| Skill check complete | Information | "Skill check: 18 vs DC 15 = Success" |
| Critical result | Information | "Critical success on perception!" |
| Parse error | Warning | "Invalid dice notation: xyz" |

### Structured Logging Format

```csharp
_logger.LogInformation(
    "Dice roll complete: Pool={Pool} Rolls={@Rolls} Explosions={@Explosions} Total={Total}",
    pool.ToString(),
    rolls,
    explosions,
    total);

_logger.LogInformation(
    "Skill check: Skill={Skill} Roll={Roll} Bonus={Bonus} Total={Total} DC={DC} Result={Result}",
    skillId,
    rollResult.Total,
    attributeBonus,
    totalResult,
    difficultyClass,
    successLevel);
```

---

## Acceptance Criteria

### Phase 5a: Core Dice Engine
- [ ] Can roll any standard dice type (d4, d6, d8, d10, d12, d20, d100)
- [ ] Dice notation parsing works (e.g., "3d6+5", "1d20-2", "2d8!")
- [ ] Exploding dice trigger on maximum value
- [ ] Advantage rolls twice and takes higher
- [ ] Disadvantage rolls twice and takes lower
- [ ] Roll results include individual die values
- [ ] 18 new tests pass

### Phase 5b: Skill Check System
- [ ] 10 skills defined in configuration
- [ ] 8 difficulty classes defined
- [ ] Skill checks use player attributes
- [ ] Critical success on natural max
- [ ] Critical failure on natural 1
- [ ] Skill check results include full breakdown
- [ ] 20 new tests pass

### Phase 5c: Combat Integration
- [ ] Attack rolls determine hit/miss
- [ ] Critical hits double damage dice
- [ ] Critical misses always miss
- [ ] Damage rolls include weapon dice
- [ ] Monster counterattacks use dice
- [ ] Combat results show full dice breakdown
- [ ] 15 new tests pass

### Phase 5d: Configuration & Polish
- [ ] `roll <notation>` command works
- [ ] `check <skill>` command works
- [ ] Dice rolls display with formatting
- [ ] Descriptors appear for critical rolls
- [ ] Combat round displays dice breakdown
- [ ] 9 new tests pass
- [ ] All 260 tests pass
- [ ] Build: 0 errors, 0 warnings

---

## Risk Assessment

| Risk | Impact | Probability | Mitigation |
|------|--------|-------------|------------|
| Combat balance disruption | High | Medium | Keep variance similar to current system initially |
| Infinite explosion loops | Medium | Low | MaxExplosions cap (default 10) |
| Random test flakiness | Medium | Medium | Use seeded Random for deterministic tests |
| Performance with many dice | Low | Low | Dice pools limited by game design |
| Breaking existing tests | High | Medium | Phase-by-phase integration with regression testing |

---

## Summary

### Files to Modify

| Phase | File | Changes |
|-------|------|---------|
| 5d | `IInputHandler.cs` | Add roll/check commands |
| 5d | `ConsoleInputHandler.cs` | Parse roll/check |
| 5d | `IGameRenderer.cs` | Add dice rendering |
| 5d | `SpectreGameRenderer.cs` | Implement rendering |
| 5d | `GameView.cs` | Handle roll/check commands |

### Test Files to Create

| Phase | File | Count |
|-------|------|-------|
| 5d | `DiceDescriptorTests.cs` | 3 |
| 5d | `CommandIntegrationTests.cs` | 6 |