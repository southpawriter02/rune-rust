# v0.18.5 Scope Breakdown: Resource Integration

## Overview

v0.18.5 implements **Resource Integration** — the coordination layer that connects all Trauma Economy resources and ensures proper interaction between Stress, Corruption, CPS, Trauma, and specialization resources during combat and rest.

---

## Feature Tree

```
v0.18.5 — Resource Integration
├── Domain Layer
│   ├── TraumaEconomyState (aggregate)
│   ├── ResourceInteraction (enum)
│   └── RestRecoveryResult (record)
│
├── Application Layer
│   ├── ITraumaEconomyService (interface)
│   └── TraumaEconomyService (implementation)
│
├── Integration Points
│   ├── Stress → Corruption penalty
│   ├── Corruption → Stress resistance penalty
│   ├── Combat damage → Stress/Rage triggers
│   ├── Rest → Multi-resource recovery
│   └── Specialization → Party buff distribution
│
├── Configuration
│   └── resource_integration.json
│
└── Tests (~15 unit tests)
```

---

## In Scope

### Domain Layer

#### TraumaEconomyState Aggregate

```csharp
/// <summary>
/// Aggregate view of all Trauma Economy resources for a character.
/// Provides unified access to stress, corruption, traumas, and spec resources.
/// </summary>
public sealed class TraumaEconomyState
{
    /// <summary>Character this state represents.</summary>
    public Guid CharacterId { get; init; }

    /// <summary>Current Psychic Stress state.</summary>
    public StressState Stress { get; init; } = new();

    /// <summary>Current Corruption state.</summary>
    public CorruptionState Corruption { get; init; } = new();

    /// <summary>Current CPS stage derived from stress.</summary>
    public CpsState Cps => new() { CurrentStress = Stress.CurrentStress };

    /// <summary>List of permanent traumas.</summary>
    public IReadOnlyList<CharacterTrauma> Traumas { get; init; } = Array.Empty<CharacterTrauma>();

    /// <summary>Specialization resource (if applicable).</summary>
    public SpecializationResourceState? SpecResource { get; init; }

    /// <summary>Gets the effective Stress resistance dice after penalties.</summary>
    public int EffectiveStressResistDice(int baseWill)
    {
        var corruptionPenalty = Corruption.ResolveDicePenalty;
        return Math.Max(0, baseWill - corruptionPenalty);
    }

    /// <summary>Gets the total Defense penalty from all sources.</summary>
    public int TotalDefensePenalty
    {
        get
        {
            var stressPenalty = Stress.DefensePenalty;
            // Additional penalties from traumas, etc. would be added here
            return stressPenalty;
        }
    }

    /// <summary>Gets the Max HP penalty percentage from corruption.</summary>
    public int MaxHpPenaltyPercent => Corruption.MaxHpPenaltyPercent;

    /// <summary>Gets the Max AP penalty percentage from corruption.</summary>
    public int MaxApPenaltyPercent => Corruption.MaxApPenaltyPercent;

    /// <summary>Whether character is in a critical psychological state.</summary>
    public bool IsPsychologicallyCritical =>
        Stress.RequiresTraumaCheck ||
        Cps.Stage >= CpsStage.RuinMadness ||
        Corruption.IsTerminalError;

    /// <summary>Gets the trauma count (severe = 2).</summary>
    public int TraumaCount => Traumas.Sum(t => t.IsSevere ? 2 : 1);

    /// <summary>Whether character is retired (too many traumas).</summary>
    public bool IsRetired => TraumaCount >= 5;
}
```

#### SpecializationResourceState Union

```csharp
/// <summary>
/// Polymorphic container for specialization resources.
/// </summary>
public abstract record SpecializationResourceState
{
    public abstract string ResourceType { get; }
    public abstract int CurrentValue { get; }
    public abstract int MaxValue { get; }
}

public sealed record RageResourceState : SpecializationResourceState
{
    public override string ResourceType => "Rage";
    public override int CurrentValue => Rage.CurrentRage;
    public override int MaxValue => RageState.MaxRage;
    public RageState Rage { get; init; } = new();
}

public sealed record MomentumResourceState : SpecializationResourceState
{
    public override string ResourceType => "Momentum";
    public override int CurrentValue => Momentum.CurrentMomentum;
    public override int MaxValue => MomentumState.MaxMomentum;
    public MomentumState Momentum { get; init; } = new();
}

public sealed record CoherenceResourceState : SpecializationResourceState
{
    public override string ResourceType => "Coherence";
    public override int CurrentValue => Coherence.CurrentCoherence;
    public override int MaxValue => CoherenceState.MaxCoherence;
    public CoherenceState Coherence { get; init; } = new();
}
```

#### ResourceInteraction Enum

```csharp
/// <summary>
/// Types of resource interactions that occur during gameplay.
/// </summary>
public enum ResourceInteraction
{
    /// <summary>Taking damage triggers stress gain.</summary>
    DamageToStress,

    /// <summary>Corruption reduces stress resistance.</summary>
    CorruptionToStressResist,

    /// <summary>High stress triggers CPS symptoms.</summary>
    StressToCps,

    /// <summary>Breaking Point triggers Trauma Check.</summary>
    StressToTrauma,

    /// <summary>Taking damage builds Rage.</summary>
    DamageToRage,

    /// <summary>Dealing damage builds Rage/Momentum.</summary>
    AttackToSpecResource,

    /// <summary>Coherence provides party stress resistance.</summary>
    CoherenceToPartyStress,

    /// <summary>Rest recovers multiple resources.</summary>
    RestRecovery
}
```

#### RestRecoveryResult Record

```csharp
/// <summary>
/// Result of rest recovery across all resources.
/// </summary>
public sealed record RestRecoveryResult
{
    /// <summary>Type of rest taken.</summary>
    public RestType RestType { get; init; }

    /// <summary>Stress recovered.</summary>
    public int StressRecovered { get; init; }

    /// <summary>New stress total.</summary>
    public int NewStress { get; init; }

    /// <summary>Whether stress was fully cleared.</summary>
    public bool StressFullyCleared { get; init; }

    /// <summary>Specialization resource reset status.</summary>
    public string? SpecResourceStatus { get; init; }

    /// <summary>Whether Nightmare trauma affected recovery.</summary>
    public bool NightmareAffectedRecovery { get; init; }

    /// <summary>Reduced recovery percentage (if nightmare).</summary>
    public int? ReducedRecoveryPercent { get; init; }

    /// <summary>CPS stage after recovery.</summary>
    public CpsStage NewCpsStage { get; init; }
}
```

### Application Layer

#### ITraumaEconomyService Interface

```csharp
/// <summary>
/// Unified service for managing all Trauma Economy interactions.
/// Coordinates between stress, corruption, CPS, trauma, and spec resources.
/// </summary>
public interface ITraumaEconomyService
{
    /// <summary>Gets the complete Trauma Economy state for a character.</summary>
    TraumaEconomyState GetTraumaEconomyState(Guid characterId);

    /// <summary>
    /// Processes damage taken, including stress and spec resource effects.
    /// </summary>
    DamageProcessingResult ProcessDamageTaken(
        Guid characterId,
        int damageAmount,
        DamageType damageType,
        bool isPsychic = false);

    /// <summary>
    /// Processes damage dealt, including spec resource generation.
    /// </summary>
    DamageProcessingResult ProcessDamageDealt(
        Guid characterId,
        int damageAmount,
        bool wasKill = false);

    /// <summary>
    /// Performs rest recovery for all applicable resources.
    /// </summary>
    RestRecoveryResult PerformRestRecovery(
        Guid characterId,
        RestType restType);

    /// <summary>
    /// Applies turn-start effects (decay, passive effects, etc.).
    /// </summary>
    TurnStartResult ApplyTurnStartEffects(
        Guid characterId,
        bool inCombat);

    /// <summary>
    /// Applies turn-end effects (momentum decay, etc.).
    /// </summary>
    TurnEndResult ApplyTurnEndEffects(
        Guid characterId,
        bool attacked,
        bool moved,
        bool usedDefend);

    /// <summary>
    /// Gets the effective stress resistance dice after all penalties.
    /// </summary>
    int GetEffectiveStressResistDice(Guid characterId);

    /// <summary>
    /// Distributes Coherence party buffs.
    /// </summary>
    PartyBuffResult ApplyCoherencePartyBuffs(
        Guid narratorId,
        IEnumerable<Guid> partyMemberIds);

    /// <summary>
    /// Processes entering a zone with stress effects.
    /// </summary>
    ZoneEntryResult ProcessZoneEntry(
        Guid characterId,
        string zoneId,
        int baseStress,
        int resistDc);

    /// <summary>
    /// Checks all trauma triggers for a condition.
    /// </summary>
    IReadOnlyList<TraumaTriggerResult> CheckAllTraumaTriggers(
        Guid characterId,
        string triggerCondition);
}
```

#### DamageProcessingResult Record

```csharp
/// <summary>
/// Result of processing damage through the Trauma Economy.
/// </summary>
public sealed record DamageProcessingResult
{
    /// <summary>Original damage amount.</summary>
    public int DamageAmount { get; init; }

    /// <summary>Stress gained from damage (if any).</summary>
    public int StressGained { get; init; }

    /// <summary>Whether stress was applied.</summary>
    public bool StressApplied { get; init; }

    /// <summary>Spec resource change (if any).</summary>
    public int SpecResourceChange { get; init; }

    /// <summary>Type of spec resource affected.</summary>
    public string? SpecResourceType { get; init; }

    /// <summary>Whether Breaking Point triggered.</summary>
    public bool BreakingPointTriggered { get; init; }

    /// <summary>Trauma Check result (if triggered).</summary>
    public TraumaCheckResult? TraumaCheckResult { get; init; }

    /// <summary>CPS stage change (if any).</summary>
    public CpsStageChangeResult? CpsStageChange { get; init; }

    /// <summary>Panic result (if CPS Stage 3).</summary>
    public PanicResult? PanicResult { get; init; }
}
```

#### TurnStartResult Record

```csharp
/// <summary>
/// Result of turn-start resource processing.
/// </summary>
public sealed record TurnStartResult
{
    /// <summary>Coherence passive decay amount.</summary>
    public int CoherenceDecay { get; init; }

    /// <summary>Current party stress resistance bonus.</summary>
    public int PartyStressResistBonus { get; init; }

    /// <summary>Whether party has Fear Immunity.</summary>
    public bool PartyFearImmunity { get; init; }

    /// <summary>Environmental stress effects applied.</summary>
    public int EnvironmentalStress { get; init; }

    /// <summary>Any CPS stage changes.</summary>
    public CpsStageChangeResult? CpsChange { get; init; }
}
```

#### TurnEndResult Record

```csharp
/// <summary>
/// Result of turn-end resource processing.
/// </summary>
public sealed record TurnEndResult
{
    /// <summary>Momentum decay applied.</summary>
    public int MomentumDecay { get; init; }

    /// <summary>Reason for momentum decay.</summary>
    public MomentumDecayReason? MomentumDecayReason { get; init; }

    /// <summary>Whether Cascade state ended.</summary>
    public bool CascadeEnded { get; init; }

    /// <summary>Rage decay (if out of combat).</summary>
    public int RageDecay { get; init; }

    /// <summary>New spec resource value.</summary>
    public int NewSpecResourceValue { get; init; }
}
```

#### PartyBuffResult Record

```csharp
/// <summary>
/// Result of applying Coherence party buffs.
/// </summary>
public sealed record PartyBuffResult
{
    /// <summary>Narrator providing the buff.</summary>
    public Guid NarratorId { get; init; }

    /// <summary>Current Coherence level.</summary>
    public int CoherenceLevel { get; init; }

    /// <summary>Stress resistance bonus applied.</summary>
    public int StressResistBonus { get; init; }

    /// <summary>Whether Fear Immunity was granted.</summary>
    public bool FearImmunityGranted { get; init; }

    /// <summary>Whether Anti-Corruption aura is active.</summary>
    public bool AntiCorruptionAura { get; init; }

    /// <summary>Party members affected.</summary>
    public IReadOnlyList<Guid> AffectedMembers { get; init; } = Array.Empty<Guid>();
}
```

### Configuration

#### resource_integration.json

```json
{
  "version": "1.0",
  "interactions": {
    "damageToStress": {
      "enabled": true,
      "psychicDamageMultiplier": 1.0,
      "physicalDamageMultiplier": 0.0,
      "description": "Psychic damage converts directly to stress"
    },
    "corruptionToStressResist": {
      "enabled": true,
      "penaltyPer20Corruption": 1,
      "description": "-1 die per 20 corruption on stress resistance"
    },
    "damageToRage": {
      "enabled": true,
      "dealDamagePer10": 5,
      "takeDamagePer10": 10,
      "description": "+5 Rage per 10 damage dealt, +10 per 10 received"
    },
    "attackToMomentum": {
      "enabled": true,
      "hitBonus": 10,
      "killBonus": 20,
      "moveAttackBonus": 15,
      "description": "Momentum from combat actions"
    },
    "coherenceToParty": {
      "enabled": true,
      "stressResistAt25": 1,
      "stressResistAt50": 2,
      "fearImmunityAt75": true,
      "antiCorruptionAt100": true,
      "description": "Party buffs from narrator Coherence"
    }
  },
  "restRecovery": {
    "shortRest": {
      "stressFormula": "WILL × 2",
      "specResourceReset": false,
      "nightmareCheck": false
    },
    "longRest": {
      "stressFormula": "WILL × 5",
      "specResourceReset": true,
      "nightmareCheck": true,
      "nightmareReducedRecovery": 50
    },
    "sanctuary": {
      "stressReset": true,
      "specResourceReset": true,
      "nightmareBypass": true
    },
    "milestone": {
      "stressRecovery": 25,
      "specResourceReset": false,
      "nightmareBypass": true
    }
  },
  "combatTurnEffects": {
    "turnStart": {
      "coherencePassiveDecay": 5,
      "environmentalStressCheck": true
    },
    "turnEnd": {
      "momentumNoAttackDecay": 20,
      "momentumDefendDecay": 15,
      "momentumHitDecay": 10,
      "rageDecayOutOfCombat": 10,
      "rageDecayGracePeriod": 3
    }
  }
}
```

---

## Out of Scope

| Feature | Deferred To | Reason |
|---------|-------------|--------|
| Combat event hooks | v0.19.x | Combat system version |
| UI resource display | v0.19.x | UI version |
| Sound triggers | v0.19.x | Audio version |
| Save/Load integration | v0.19.x | Persistence version |
| Network sync | v0.25.x | Multiplayer version |

---

## Unit Tests (~15 tests)

### TraumaEconomyState Tests

| Test | Description |
|------|-------------|
| `TraumaEconomyState_EffectiveStressResist_AppliesCorruptionPenalty` | Corruption reduces dice |
| `TraumaEconomyState_TotalDefensePenalty_IncludesStress` | Penalty calculation |
| `TraumaEconomyState_IsCritical_DetectsAllConditions` | Critical state detection |
| `TraumaEconomyState_TraumaCount_CountsSevereAsTwo` | Severe trauma counting |

### TraumaEconomyService Tests

| Test | Description |
|------|-------------|
| `ProcessDamageTaken_AppliesPsychicStress` | Psychic damage → stress |
| `ProcessDamageTaken_BuildsRageForBerserker` | Damage → rage |
| `ProcessDamageDealt_BuildsMomentumForSkirmisher` | Attack → momentum |
| `ProcessDamageDealt_KillBonusApplied` | Kill bonus works |
| `PerformRestRecovery_ShortRest_UsesWillFormula` | Short rest recovery |
| `PerformRestRecovery_Sanctuary_FullReset` | Sanctuary full clear |
| `PerformRestRecovery_NightmareReducesRecovery` | Nightmare trauma effect |
| `ApplyTurnEndEffects_DecaysMomentumNoAttack` | No attack decay |
| `ApplyCoherencePartyBuffs_DistributesCorrectly` | Party buff distribution |
| `GetEffectiveStressResistDice_AppliesAllPenalties` | Combined penalty calculation |
| `CheckAllTraumaTriggers_FindsMatchingTraumas` | Trigger detection |

---

## Acceptance Criteria

### Functional Requirements

- [ ] Corruption penalty applied to stress resistance checks
- [ ] Psychic damage converts to stress correctly
- [ ] Spec resources build from combat events
- [ ] Rest recovery respects all resource rules
- [ ] Nightmare trauma affects long rest
- [ ] Coherence party buffs distribute correctly
- [ ] Turn-based decay applies at correct timing
- [ ] All resource interactions chainable

### Quality Requirements

- [ ] All public methods have XML documentation
- [ ] Configuration externalized to JSON
- [ ] Unit test coverage ≥ 90%
- [ ] No circular dependencies between services

---

## Integration Matrix

| Source | Target | Effect |
|--------|--------|--------|
| Damage Taken | Stress | Psychic damage = stress gain |
| Damage Taken | Rage | +10 per 10 damage (Berserker) |
| Damage Dealt | Rage | +5 per 10 damage (Berserker) |
| Damage Dealt | Momentum | +10 per hit (Skirmisher) |
| Kill | Rage | +15 (Berserker) |
| Kill | Momentum | +20 (Skirmisher) |
| Corruption 20+ | Stress Resist | -1 die per 20 |
| Coherence 25+ | Party Stress | +1 resistance |
| Coherence 50+ | Party Stress | +2 resistance |
| Coherence 75+ | Party Fear | Immunity |
| Coherence 100 | Party Corruption | Anti-aura |
| Long Rest | Stress | WILL × 5 recovery |
| Sanctuary | All | Full reset |
| Turn End (no attack) | Momentum | -20 decay |
| Turn Start (combat) | Coherence | -5 decay |

---

## Dependencies

### Requires

| Dependency | Purpose |
|------------|---------|
| Stress System (v0.18.0) | Stress management |
| Corruption System (v0.18.1) | Corruption state |
| CPS System (v0.18.2) | Stage tracking |
| Trauma System (v0.18.3) | Trauma triggers |
| Spec Resources (v0.18.4) | Rage/Momentum/Coherence |
| Attribute System (v0.17.2) | WILL for formulas |

### Provides

| Feature | Consumer |
|---------|----------|
| `TraumaEconomyState` | Character sheet display |
| `ProcessDamageTaken` | Combat system |
| `PerformRestRecovery` | Rest system |
| Party buffs | Combat system |

---

## Changelog

| Version | Date | Changes |
|---------|------|---------|
| 1.0 | 2026-01-17 | Initial scope breakdown |
