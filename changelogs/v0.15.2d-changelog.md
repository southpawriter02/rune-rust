# v0.15.2d Changelog - Stealth Movement System

**Release Date:** 2026-01-23
**Focus:** Stealth mechanics with surface-based DCs, [Hidden] status, and party stealth

---

## Summary

This release implements the stealth movement system, enabling characters to attempt stealth checks based on surface types and environmental conditions. The system uses the success-counting mechanics established in v0.15.0c and integrates with the fumble consequence system from v0.15.1b.

---

## Added

### Domain Layer

#### Enums
- **`StealthSurface`**: Surface types affecting stealth DC
  - `Silent` (DC 2): Carpet, moss, sand
  - `Normal` (DC 3): Concrete, dirt, wood
  - `Noisy` (DC 4): Rubble, gravel, leaves
  - `VeryNoisy` (DC 5): Scrap metal, glass, chains

- **`HiddenBreakCondition`**: Conditions that break [Hidden] status
  - `Attack`: Making any attack
  - `LoudAction`: Yelling, breaking objects
  - `EnemyCriticalPerception`: Enemy rolls ≥5 on Perception
  - `LeaveZone`: Leaving zone that granted [Hidden]
  - `FastMovement`: Moving faster than half speed
  - `EnterLight`: Entering bright light
  - `EncounterEnd`: Combat/encounter ends

#### Extensions
- **`StealthSurfaceExtensions`**: Helper methods for surface types
  - `GetBaseDc()`: Get DC for surface
  - `GetDescription()`: Human-readable description
  - `GetExamples()`: Example materials
  - `IsNaturallySilent()`: Check if DC ≤ 2
  - `IsDifficultSurface()`: Check if DC ≥ 4

#### Entities
- **`HiddenStatus`**: Tracks [Hidden] state for characters
  - `CharacterId`: Who is hidden
  - `IsHidden`: Current state
  - `HiddenSince`: Timestamp
  - `BreakConditions`: What will reveal them
  - `DetectionModifier`: Difficulty for enemies to spot
  - Factory methods: `FromStealthCheck`, `FromSlipIntoShadow`, `FromOneWithTheStatic`

#### Value Objects
- **`StealthContext`**: Encapsulates stealth check parameters
  - Surface type and base DC
  - Lighting modifiers (-1 dim, +2 illuminated)
  - Alert status (+1 if enemies alerted)
  - Zone modifiers (-2 for [Psychic Resonance])
  - Party check coordination

- **`StealthCheckResult`**: Individual stealth check outcome
  - Success/failure with margin
  - [Hidden] status if successful
  - Fumble detection for [System-Wide Alert]

- **`PartyStealthResult`**: Party stealth with weakest-link rule
  - Identifies weakest party member
  - Single roll determines party outcome
  - Party-wide [Hidden] on success

### Application Layer

#### Interfaces
- **`IStealthService`**: Contract for stealth operations
  - `AttemptStealth()`: Individual stealth check
  - `AttemptPartyStealth()`: Party stealth (weakest-link)
  - `IsHidden()` / `GetHiddenStatus()`: Query [Hidden] state
  - `BreakHidden()`: Break [Hidden] by condition
  - `ApplyHiddenStatus()`: Apply via ability
  - `GetStealthDc()`: Calculate DC with modifiers
  - `FindWeakestMember()`: Find party's weakest link

#### Services
- **`StealthService`**: Full implementation of stealth mechanics
  - Uses `IDiceService` for d10 pool rolls
  - Tracks [Hidden] statuses in memory
  - Logs stealth attempts with structured logging
  - Integrates with skill outcome classification

### Configuration

- **`config/stealth-surfaces.json`**: Data-driven surface configuration
  - Surface definitions with DCs and examples
  - Modifier definitions for lighting, alert, zones
  - [Hidden] status effects and break conditions
  - Fumble consequence ([System-Wide Alert])

- **`config/schemas/stealth-surfaces.schema.json`**: JSON Schema validation

---

## Mechanics

### Stealth Check
```
DC = BaseSurfaceDC + LightingMod + AlertMod + ZoneMod (minimum 1)

Example: Normal surface (3) + Illuminated (+2) + Alerted (+1) = DC 6
Example: Silent surface (2) + Dim light (-1) + Psychic Resonance (-2) = DC 1
```

### [Hidden] Status Effects
- Cannot be directly targeted by single-target attacks
- Can still be hit by AoE abilities
- First attack from hiding grants advantage

### Break Conditions
- **Attack**: Any attack (exception: [Ghostly Form])
- **Loud Action**: Yelling, breaking objects
- **Enemy Critical Perception**: Net ≥5 on Perception check
- **Leave Zone**: For zone-granted [Hidden]

### Party Stealth (Weakest Link Rule)
- "A chain is only as strong as its weakest link"
- Member with lowest Acrobatics pool rolls for party
- Failure exposes entire party
- Success hides entire party

### Fumble Consequence
- **[System-Wide Alert]**: 0 successes + ≥1 botch
- All adjacent rooms alerted
- +2 DC to stealth checks for 10 minutes
- Enemies move to investigate

---

## Testing

Added 30 unit tests in `StealthServiceTests`:
- Surface DC calculations (8 tests)
- Individual stealth checks (5 tests)
- [Hidden] status tracking (7 tests)
- Party stealth mechanics (6 tests)
- StealthContext creation (4 tests)

---

## Dependencies

- **v0.15.0c**: Success-counting dice mechanics
- **v0.15.1b**: Fumble consequence system ([System-Wide Alert])
- **v0.15.2a**: Climbing service patterns (used as reference)

---

## Files Changed

### Added
- `src/Core/RuneAndRust.Domain/Enums/StealthSurface.cs`
- `src/Core/RuneAndRust.Domain/Enums/HiddenBreakCondition.cs`
- `src/Core/RuneAndRust.Domain/Extensions/StealthSurfaceExtensions.cs`
- `src/Core/RuneAndRust.Domain/Entities/HiddenStatus.cs`
- `src/Core/RuneAndRust.Domain/ValueObjects/StealthContext.cs`
- `src/Core/RuneAndRust.Domain/ValueObjects/StealthCheckResult.cs`
- `src/Core/RuneAndRust.Domain/ValueObjects/PartyStealthResult.cs`
- `src/Core/RuneAndRust.Application/Interfaces/IStealthService.cs`
- `src/Core/RuneAndRust.Application/Services/StealthService.cs`
- `config/stealth-surfaces.json`
- `config/schemas/stealth-surfaces.schema.json`
- `tests/RuneAndRust.Application.UnitTests/Services/StealthServiceTests.cs`
- `changelogs/v0.15.2d-changelog.md`

---

## Breaking Changes

None.

---

## Migration Guide

No migration required. New stealth service is opt-in via dependency injection.
