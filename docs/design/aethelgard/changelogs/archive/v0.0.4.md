> **Archived** - This changelog has been consolidated. See the complete version at [v0.0.4](../v0.0.x/v0.0.4.md).

# v0.0.4 Changelog: The Persistence (Database Integration)

**Release Date:** December 18, 2025
**Total Tests:** 233 (65 new tests added)

---

## Summary

Version 0.0.4 establishes the **data persistence layer** using Entity Framework Core and PostgreSQL. This release enables the application to serialize runtime `GameState` into persistent `SaveGame` records and retrieve them, ensuring player progress survives application restart.

---

## New Features

### Database Integration
- **Entity Framework Core**: Full ORM integration with PostgreSQL via Npgsql
- **SaveGame Entity**: Persistent storage of game state with slot-based management
- **Repository Pattern**: Generic repository with specialized SaveGame repository

### Save/Load System
- **SaveManager Service**: Handles serialization/deserialization of GameState to JSON
- **Slot-based Saves**: Support for multiple save slots (1-3)
- **Save Commands**: New `save` and `load` commands in Exploration and MainMenu phases
- **PendingGameAction Enum**: Signal async save/load operations from synchronous command parser

---

## Files Created

### Core Layer

#### `RuneAndRust.Core/Entities/SaveGame.cs`
Persistent save game entity:
```csharp
public class SaveGame
{
    public Guid Id { get; set; }
    public int SlotNumber { get; set; }
    public string CharacterName { get; set; }
    public DateTime CreatedAt { get; set; }
    public DateTime LastPlayed { get; set; }
    public string SerializedState { get; set; }  // JSONB in PostgreSQL
}
```

#### `RuneAndRust.Core/Interfaces/IRepository.cs`
Generic repository interface:
```csharp
public interface IRepository<T> where T : class
{
    Task<T?> GetByIdAsync(Guid id);
    Task<IEnumerable<T>> GetAllAsync();
    Task AddAsync(T entity);
    Task UpdateAsync(T entity);
    Task DeleteAsync(Guid id);
    Task SaveChangesAsync();
}
```

#### `RuneAndRust.Core/Interfaces/ISaveGameRepository.cs`
SaveGame-specific repository with slot-based lookups:
- `GetBySlotAsync(int slotNumber)` - Find save by slot
- `SlotExistsAsync(int slotNumber)` - Check if slot is occupied
- `GetAllOrderedByLastPlayedAsync()` - Get saves sorted by recency

#### `RuneAndRust.Core/Enums/PendingGameAction.cs`
Signals async operations from command parser:
```csharp
public enum PendingGameAction
{
    None = 0,
    Save = 1,
    Load = 2
}
```

### Persistence Layer

#### `RuneAndRust.Persistence/Data/RuneAndRustDbContext.cs`
EF Core database context:
- SaveGames DbSet with unique SlotNumber index
- JSONB column type for SerializedState

#### `RuneAndRust.Persistence/Repositories/GenericRepository.cs`
Generic repository implementation:
- CRUD operations with logging
- Entity change tracking
- Async operations throughout

#### `RuneAndRust.Persistence/Repositories/SaveGameRepository.cs`
Specialized SaveGame repository:
- Slot-based queries
- Ordered results by LastPlayed
- Existence checks

### Engine Layer

#### `RuneAndRust.Engine/Services/SaveManager.cs`
Save/Load orchestration service:
```csharp
public class SaveManager
{
    Task<bool> SaveGameAsync(int slot, GameState currentState);
    Task<GameState?> LoadGameAsync(int slot);
    Task<IEnumerable<SaveGameSummary>> GetSaveSlotSummariesAsync();
    Task<bool> DeleteSaveAsync(int slot);
    Task<bool> SaveExistsAsync(int slot);
}
```

**SaveGameSummary** - Summary information for UI display:
- SlotNumber, CharacterName, LastPlayed, IsEmpty

### Test Layer

#### `RuneAndRust.Tests/Integration/PersistenceTests.cs`
Integration tests (17 tests):
- CRUD operations validation
- Slot-based queries
- Timestamp preservation
- Large JSON storage
- Default value verification

#### `RuneAndRust.Tests/Engine/SaveManagerTests.cs`
SaveManager unit tests (19 tests):
- Save to new and existing slots
- Load from valid/invalid slots
- JSON serialization/deserialization
- Error handling
- Summary generation

#### `RuneAndRust.Tests/Core/PendingGameActionTests.cs`
Enum validation tests (7 tests):
- Value count and existence
- Sequential numbering
- Default value verification

---

## Files Modified

### `RuneAndRust.Core/Models/GameState.cs`
Added PendingAction property:
```csharp
[JsonIgnore]
public PendingGameAction PendingAction { get; set; } = PendingGameAction.None;
```
- Reset() now clears PendingAction to None

### `RuneAndRust.Engine/Services/CommandParser.cs`
New commands added:

**MainMenu Phase:**
| Command | Action |
|---------|--------|
| load | Set PendingAction to Load |

**Exploration Phase:**
| Command | Action |
|---------|--------|
| save | Set PendingAction to Save |
| load | Set PendingAction to Load |

Updated help text to include save/load commands.

### `RuneAndRust.Terminal/Program.cs`
New DI registrations:
```csharp
// Database Context
services.AddDbContext<RuneAndRustDbContext>(options =>
    options.UseNpgsql(connectionString));

// Repositories
services.AddScoped(typeof(IRepository<>), typeof(GenericRepository<>));
services.AddScoped<ISaveGameRepository, SaveGameRepository>();

// Save Manager
services.AddScoped<SaveManager>();
```

### `RuneAndRust.Tests/Engine/CommandParserTests.cs`
Added 3 new tests:
- MainMenu load command test
- Exploration save command test
- Exploration load command test

### `RuneAndRust.Tests/Core/GameStateTests.cs`
Added 6 new tests:
- Default PendingAction test
- PendingAction setter tests (including Theory with all values)
- Reset PendingAction test
- Updated Reset_ShouldResetAllProperties test

---

## Package Updates

### RuneAndRust.Persistence
```xml
<PackageReference Include="Microsoft.EntityFrameworkCore.Design" Version="9.0.4" />
<PackageReference Include="Npgsql.EntityFrameworkCore.PostgreSQL" Version="9.0.4" />
```

### RuneAndRust.Terminal
```xml
<PackageReference Include="Microsoft.EntityFrameworkCore.Design" Version="9.0.4" />
```

### RuneAndRust.Tests
```xml
<PackageReference Include="Microsoft.EntityFrameworkCore.InMemory" Version="9.0.4" />
```

---

## Complete Test Inventory

### Core/PendingGameActionTests.cs (7 tests)
| Test Name | Description |
|-----------|-------------|
| `PendingGameAction_ShouldHaveExactlyThreeValues` | Validates enum has 3 values |
| `PendingGameAction_ShouldContain_None` | None value exists |
| `PendingGameAction_ShouldContain_Save` | Save value exists |
| `PendingGameAction_ShouldContain_Load` | Load value exists |
| `PendingGameAction_ToString_ReturnsExpectedName` | ToString returns name (3 cases) |
| `PendingGameAction_DefaultValue_ShouldBeNone` | default is None |
| `PendingGameAction_EnumValues_ShouldBeSequential` | Values are 0,1,2 |

### Integration/PersistenceTests.cs (17 tests)
| Test Name | Description |
|-----------|-------------|
| `AddAsync_ShouldPersistSaveGame` | Add and retrieve save |
| `GetByIdAsync_ExistingSaveGame_ReturnsSaveGame` | Find by ID |
| `GetByIdAsync_NonExistentId_ReturnsNull` | Non-existent ID |
| `GetAllAsync_MultipleSaveGames_ReturnsAll` | Retrieve all saves |
| `UpdateAsync_ShouldUpdateExistingSaveGame` | Update character name |
| `DeleteAsync_ShouldRemoveSaveGame` | Delete by ID |
| `DeleteAsync_NonExistentId_DoesNotThrow` | Delete non-existent |
| `GetBySlotAsync_ExistingSlot_ReturnsSaveGame` | Find by slot |
| `GetBySlotAsync_NonExistentSlot_ReturnsNull` | Non-existent slot |
| `SlotExistsAsync_ExistingSlot_ReturnsTrue` | Slot exists check |
| `SlotExistsAsync_NonExistentSlot_ReturnsFalse` | Slot not exists |
| `GetAllOrderedByLastPlayedAsync_ReturnsOrderedByMostRecent` | Ordering test |
| `SaveGame_SerializedState_CanStoreLargeJson` | 10KB+ JSON storage |
| `SaveGame_DefaultValues_AreSetCorrectly` | Entity defaults |
| `SaveGame_Timestamps_ArePreservedOnSave` | Timestamp preservation |

### Engine/SaveManagerTests.cs (19 tests)
| Test Name | Description |
|-----------|-------------|
| `SaveGameAsync_NewSlot_CreatesSaveGame` | Create new save |
| `SaveGameAsync_ExistingSlot_UpdatesSaveGame` | Update existing save |
| `SaveGameAsync_NoCharacter_UsesUnknownName` | Unknown character name |
| `SaveGameAsync_RepoThrowsException_ReturnsFalse` | Error handling |
| `SaveGameAsync_SerializesGameState` | JSON serialization |
| `LoadGameAsync_ExistingSlot_ReturnsGameState` | Load valid save |
| `LoadGameAsync_NonExistentSlot_ReturnsNull` | Load empty slot |
| `LoadGameAsync_InvalidJson_ReturnsNull` | Invalid JSON handling |
| `LoadGameAsync_RepoThrowsException_ReturnsNull` | Error handling |
| `GetSaveSlotSummariesAsync_ReturnsSummaries` | Summary generation |
| `GetSaveSlotSummariesAsync_EmptyDatabase_ReturnsEmptyList` | Empty summaries |
| `DeleteSaveAsync_ExistingSlot_ReturnsTrue` | Delete existing save |
| `DeleteSaveAsync_NonExistentSlot_ReturnsFalse` | Delete non-existent |
| `DeleteSaveAsync_RepoThrowsException_ReturnsFalse` | Error handling |
| `SaveExistsAsync_SlotExists_ReturnsTrue` | Exists check true |
| `SaveExistsAsync_SlotDoesNotExist_ReturnsFalse` | Exists check false |
| `SaveGameSummary_DefaultValues_AreCorrect` | Summary defaults |
| `SaveGameSummary_CanSetAllProperties` | Summary setters |

---

## Logging Matrix (v0.0.4)

| System | Event | Level | Template |
|--------|-------|-------|----------|
| SaveManager | Save Start | Info | `"Starting save to slot {Slot} ('{SaveName}')"` |
| SaveManager | Save Complete | Info | `"Save completed in {Duration}ms (ID: {SaveId})"` |
| SaveManager | Save Failed | Error | `"Save failed: {Error}"` |
| SaveManager | Load Start | Info | `"Starting load from slot {Slot}"` |
| SaveManager | Load Complete | Info | `"Load completed in {Duration}ms from slot {Slot} ('{CharacterName}')"` |
| SaveManager | Load Failed | Error | `"Load failed: {Error}"` |
| SaveManager | No Save Found | Warning | `"No save found in slot {Slot}"` |
| GenericRepository | Fetch | Debug | `"Fetching {EntityType} with ID {Id}"` |
| GenericRepository | Not Found | Debug | `"{EntityType} with ID {Id} not found"` |
| GenericRepository | Add | Debug | `"Adding new {EntityType} entity"` |
| GenericRepository | Update | Debug | `"Updating {EntityType} entity"` |
| GenericRepository | Delete | Debug | `"Deleting {EntityType} with ID {Id}"` |
| GenericRepository | Delete Missing | Warning | `"Attempted to delete non-existent {EntityType}"` |
| GenericRepository | Save Changes | Debug | `"Saved {ChangeCount} changes to database"` |
| SaveGameRepository | Slot Query | Debug | `"Fetching SaveGame for slot {SlotNumber}"` |
| SaveGameRepository | Slot Check | Debug | `"Checking if slot {SlotNumber} exists"` |

---

## Test Summary by Category

| Category | Test Count |
|----------|------------|
| Core/AttributeTests | 12 |
| Core/CharacterTests | 10 |
| Core/GamePhaseTests | 9 |
| Core/GameStateTests | 29 |
| Core/PendingGameActionTests | 7 |
| Engine/CommandParserTests | 39 |
| Engine/DiceServiceTests | 24 |
| Engine/GameLoopTests | 18 |
| Engine/GameServiceTests | 5 |
| Engine/SaveManagerTests | 19 |
| Engine/StatCalculationServiceTests | 35 |
| Integration/PersistenceTests | 17 |
| **Total** | **233** |

---

## Build Verification

```
Build succeeded.
    1 Warning(s) (EF Core version conflict - benign)
    0 Error(s)

Test run:
  Passed: 233
  Failed: 0
  Skipped: 0
```

---

## Directory Structure After v0.0.4

```
RuneAndRust/
├── RuneAndRust.Core/
│   ├── Entities/
│   │   └── SaveGame.cs           # NEW
│   ├── Enums/
│   │   ├── Attribute.cs
│   │   ├── GamePhase.cs
│   │   └── PendingGameAction.cs  # NEW
│   ├── Interfaces/
│   │   ├── IDiceService.cs
│   │   ├── IGameService.cs
│   │   ├── IInputHandler.cs
│   │   ├── IRepository.cs        # NEW
│   │   ├── ISaveGameRepository.cs # NEW
│   │   └── IStatCalculationService.cs
│   └── Models/
│       ├── Character.cs
│       └── GameState.cs          # MODIFIED
├── RuneAndRust.Engine/
│   └── Services/
│       ├── CommandParser.cs      # MODIFIED
│       ├── DiceService.cs
│       ├── GameService.cs
│       ├── SaveManager.cs        # NEW
│       └── StatCalculationService.cs
├── RuneAndRust.Persistence/
│   ├── Data/
│   │   └── RuneAndRustDbContext.cs # NEW
│   └── Repositories/
│       ├── GenericRepository.cs  # NEW
│       └── SaveGameRepository.cs # NEW
├── RuneAndRust.Terminal/
│   ├── Program.cs                # MODIFIED
│   └── Services/
│       └── TerminalInputHandler.cs
├── RuneAndRust.Tests/
│   ├── Core/
│   │   ├── AttributeTests.cs
│   │   ├── CharacterTests.cs
│   │   ├── GamePhaseTests.cs
│   │   ├── GameStateTests.cs     # MODIFIED
│   │   └── PendingGameActionTests.cs # NEW
│   ├── Engine/
│   │   ├── CommandParserTests.cs # MODIFIED
│   │   ├── DiceServiceTests.cs
│   │   ├── GameLoopTests.cs
│   │   ├── GameServiceTests.cs
│   │   ├── SaveManagerTests.cs   # NEW
│   │   └── StatCalculationServiceTests.cs
│   └── Integration/
│       └── PersistenceTests.cs   # NEW
└── docs/
    └── changelogs/
        ├── v0.0.2.md
        ├── v0.0.3.md
        └── v0.0.4.md             # NEW
```

---

## Database Schema

### SaveGames Table
```sql
CREATE TABLE "SaveGames" (
    "Id" uuid NOT NULL PRIMARY KEY,
    "SlotNumber" integer NOT NULL,
    "CharacterName" character varying(100) NOT NULL,
    "CreatedAt" timestamp with time zone NOT NULL,
    "LastPlayed" timestamp with time zone NOT NULL,
    "SerializedState" jsonb NOT NULL
);

CREATE UNIQUE INDEX "IX_SaveGames_SlotNumber" ON "SaveGames" ("SlotNumber");
```

---

## Database Setup Instructions

### Prerequisites
1. PostgreSQL 16 running locally
2. Create database: `CREATE DATABASE "RuneAndRust";`

### Connection String
Set environment variable (or use default for development):
```bash
export RUNEANDRUST_CONNECTION_STRING="Host=localhost;Database=RuneAndRust;Username=postgres;Password=password"
```

### Apply Migrations
```bash
# From solution root
dotnet ef migrations add InitialCreate --project RuneAndRust.Persistence --startup-project RuneAndRust.Terminal
dotnet ef database update --project RuneAndRust.Persistence --startup-project RuneAndRust.Terminal
```

---

## Commands Reference (Updated)

### MainMenu Phase
```
start, new, play  - Begin a new game session
load              - Load a saved game (NEW)
quit, exit, q     - Exit the application
help, ?           - Display available commands
```

### Exploration Phase
```
look, l           - Observe your surroundings
status, stats     - Display current game status
save              - Save your progress (NEW)
load              - Load a saved game (NEW)
menu, mainmenu    - Return to main menu
quit, exit, q     - Exit the application
help, ?           - Display available commands
```

---

## Next Steps (v0.0.5: The Spatial Core)

Potential features for the next release:
- Room graph and navigation system
- Movement commands (north, south, east, west)
- Room descriptions and connections
- Location persistence in save files
