> **Archived** - This changelog has been consolidated. See the complete version at [v0.3.1](../v0.3.x/v0.3.1.md).

# v0.3.1d Changelog: Database Infrastructure

**Release Date:** December 20, 2025
**Total Tests:** 1704 (all passing)

---

## Summary

Version 0.3.1d establishes **Docker-based PostgreSQL infrastructure** for the Rune & Rust project. This release adds containerized database support, EF Core migrations, and design-time tooling to enable persistent game state and full integration testing.

Key additions:
- **Docker Compose Configuration**: PostgreSQL 16 container with health checks
- **EF Core Migrations**: Initial schema creation for all 11 database tables
- **Design-Time Factory**: Enables EF tooling without running the full application
- **ItemProperty Persistence**: DbContext configuration for v0.3.1c runeforging system
- **Connection String Updates**: Default configuration for Docker container

---

## New Features

### Docker PostgreSQL Container

A `docker-compose.yml` configuration provides a ready-to-use PostgreSQL 16 instance:

- **Container Name**: `runeandrust-db`
- **Database**: `RuneAndRust`
- **Port**: 5433 (avoids conflict with existing PostgreSQL instances on 5432)
- **Health Check**: Automatic readiness verification
- **Persistent Volume**: Data survives container restarts

### EF Core Migration Support

Initial migration creates the complete database schema:

| Table | Purpose |
|-------|---------|
| `SaveGames` | Persisted game saves with JSONB state |
| `Rooms` | World locations with position coordinates |
| `Characters` | Player characters with attributes and stats |
| `InteractableObjects` | Containers, doors, and examinable objects |
| `Items` | Base item table (TPH inheritance) |
| `Equipment` | Weapons and armor (inherits from Items) |
| `ItemProperties` | Runic enchantments with stat modifiers |
| `InventoryItems` | Character-Item join table |
| `CodexEntries` | Scavenger's Journal lore entries |
| `DataCaptures` | Player-discovered knowledge fragments |
| `ActiveAbilities` | Combat abilities by archetype |

### Design-Time DbContext Factory

Enables EF Core CLI tools to create migrations without starting the application:

```bash
# Create a new migration
dotnet ef migrations add MigrationName --project RuneAndRust.Persistence --startup-project RuneAndRust.Persistence

# Apply migrations to database
dotnet ef database update --project RuneAndRust.Persistence --startup-project RuneAndRust.Persistence
```

---

## Files Created

| File | Purpose |
|------|---------|
| `docker-compose.yml` | PostgreSQL 16 container configuration |
| `RuneAndRust.Persistence/Data/DesignTimeDbContextFactory.cs` | EF Core design-time factory |
| `RuneAndRust.Persistence/Migrations/20251220231703_InitialCreate.cs` | Initial schema migration |
| `docs/changelogs/v0.3.1d.md` | This changelog |

---

## Files Modified

| File | Change |
|------|--------|
| `RuneAndRust.Persistence/Data/RuneAndRustDbContext.cs` | Added ItemProperties DbSet and entity configuration |
| `RuneAndRust.Terminal/Program.cs` | Updated default connection string to use port 5433 |

---

## Code Implementation Details

### Docker Compose Configuration

```yaml
services:
  postgres:
    image: postgres:16
    container_name: runeandrust-db
    environment:
      POSTGRES_DB: RuneAndRust
      POSTGRES_USER: postgres
    ports:
      - "5433:5432"
    volumes:
      - runeandrust_pgdata:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres -d RuneAndRust"]
      interval: 5s
      timeout: 5s
      retries: 5

volumes:
  runeandrust_pgdata:
```

### Design-Time Factory

```csharp
public class DesignTimeDbContextFactory : IDesignTimeDbContextFactory<RuneAndRustDbContext>
{
    public RuneAndRustDbContext CreateDbContext(string[] args)
    {
        var connectionString = Environment.GetEnvironmentVariable("RUNEANDRUST_CONNECTION_STRING")
            ?? "Host=localhost;Port=5433;Database=RuneAndRust;Username=postgres;Password=...";

        var optionsBuilder = new DbContextOptionsBuilder<RuneAndRustDbContext>();
        optionsBuilder.UseNpgsql(connectionString);

        return new RuneAndRustDbContext(optionsBuilder.Options);
    }
}
```

### ItemProperty Entity Configuration

```csharp
modelBuilder.Entity<ItemProperty>(entity =>
{
    entity.ToTable("ItemProperties");
    entity.HasKey(p => p.Id);

    entity.Property(p => p.Name)
        .HasMaxLength(100)
        .IsRequired();

    entity.Property(p => p.StatModifiers)
        .HasColumnType("jsonb")
        .HasConversion(
            v => JsonSerializer.Serialize(v, (JsonSerializerOptions?)null),
            v => JsonSerializer.Deserialize<Dictionary<string, int>>(v, (JsonSerializerOptions?)null)
                ?? new Dictionary<string, int>()
        )
        .IsRequired();

    entity.Property(p => p.AppliedAt).IsRequired();
});
```

### Item-to-Properties Relationship

```csharp
modelBuilder.Entity<Item>(entity =>
{
    // ... existing configuration ...

    entity.HasMany(i => i.Properties)
        .WithOne()
        .HasForeignKey("ItemId")
        .OnDelete(DeleteBehavior.Cascade);
});
```

---

## Quick Start Commands

```bash
# Start the database container
docker-compose up -d

# Verify container is running
docker ps --filter "name=runeandrust-db"

# Apply database migrations
dotnet ef database update --project RuneAndRust.Persistence --startup-project RuneAndRust.Persistence

# Run the game (connects to Docker database)
dotnet run --project RuneAndRust.Terminal

# Stop the database container
docker-compose down

# Stop and remove all data
docker-compose down -v
```

---

## Environment Variables

| Variable | Purpose | Default |
|----------|---------|---------|
| `RUNEANDRUST_CONNECTION_STRING` | Override database connection | `Host=localhost;Port=5433;Database=RuneAndRust;...` |

---

## Database Schema Overview

### JSONB Columns

PostgreSQL's JSONB type is used for complex data structures:

| Table | Column | Content |
|-------|--------|---------|
| `SaveGames` | `SerializedState` | Complete game state snapshot |
| `Rooms` | `Exits` | Direction-to-RoomId mappings |
| `Characters` | `EquipmentBonuses` | Attribute-to-bonus mappings |
| `Equipment` | `AttributeBonuses` | Stat bonuses from gear |
| `Equipment` | `Requirements` | Attribute requirements to equip |
| `CodexEntries` | `UnlockThresholds` | Fragment count to text mappings |
| `ItemProperties` | `StatModifiers` | Runic buff values |

### Table Relationships

```
Characters ─┬─< InventoryItems >─── Items (TPH: Item/Equipment)
            │                            │
            │                            └─< ItemProperties
            │
            └─< DataCaptures >─── CodexEntries

Rooms ─< InteractableObjects

SaveGames (standalone)
ActiveAbilities (standalone)
```

---

## Build Verification

```
Build succeeded.
    0 Error(s)

Test Results:
  Passed: 1704
  Failed: 0
  Skipped: 0

Docker Container:
  Status: Running (healthy)
  Port: 5433
  Database: RuneAndRust (schema applied)
```

---

## Directory Structure After v0.3.1d

```
RuneAndRust/
├── docker-compose.yml                              [NEW]
├── RuneAndRust.Persistence/
│   ├── Data/
│   │   ├── RuneAndRustDbContext.cs                 [MODIFIED]
│   │   └── DesignTimeDbContextFactory.cs           [NEW]
│   └── Migrations/
│       ├── 20251220231703_InitialCreate.cs         [NEW]
│       └── RuneAndRustDbContextModelSnapshot.cs    [NEW]
├── RuneAndRust.Terminal/
│   └── Program.cs                                  [MODIFIED]
└── docs/
    └── changelogs/
        ├── v0.3.1a.md
        ├── v0.3.1b.md
        ├── v0.3.1c.md
        └── v0.3.1d.md                              [NEW]
```

---

## Migration Notes

- **Port 5433**: The Docker container uses port 5433 to avoid conflicts with existing PostgreSQL installations on the default port 5432
- **Credentials**: Default development credentials are used; production deployments should use environment variables
- **Data Persistence**: The `runeandrust_pgdata` volume persists data across container restarts
- **InMemory Tests**: Integration tests continue to use EF Core's InMemory provider for speed; they do not require the Docker container

---

## Test Architecture

| Test Type | Count | Database |
|-----------|-------|----------|
| Unit Tests | 1567 | Mocked dependencies |
| Integration Tests | 137 | EF Core InMemory provider |
| **Total** | **1704** | All passing |

---

## Prerequisites

- Docker Desktop or Docker Engine
- .NET 9.0 SDK
- EF Core CLI tools (`dotnet tool install --global dotnet-ef`)

---

## Troubleshooting

### Container Name Conflict

If you see "container name already in use":

```bash
docker rm runeandrust-db
docker-compose up -d
```

### Port Already in Use

If port 5433 is occupied, modify `docker-compose.yml`:

```yaml
ports:
  - "5434:5432"  # Use a different host port
```

Then update the connection string in `Program.cs` or set the environment variable.

### Migration Errors

If migrations fail, ensure the container is running and healthy:

```bash
docker ps --filter "name=runeandrust-db"
docker logs runeandrust-db
```

---

## Next Steps (v0.3.2)

Potential features for the next release:
- Database seeding with starter content (rooms, items, codex entries)
- Save/Load game functionality using PostgreSQL persistence
- PostgreSQL-specific integration tests for JSONB queries
- Connection pooling configuration for production

---

## Dependencies

| Package | Version | Purpose |
|---------|---------|---------|
| Npgsql.EntityFrameworkCore.PostgreSQL | 9.0.4 | PostgreSQL EF Core provider |
| Microsoft.EntityFrameworkCore.Design | 9.0.4 | EF Core CLI tooling |
| Microsoft.EntityFrameworkCore.InMemory | 9.0.1 | In-memory testing |

---

## Running Tests

```bash
# Run all tests (does not require Docker)
dotnet test RuneAndRust.Tests

# Run only unit tests
dotnet test RuneAndRust.Tests --filter "FullyQualifiedName!~Integration"

# Run only integration tests
dotnet test RuneAndRust.Tests --filter "FullyQualifiedName~Integration"
```
