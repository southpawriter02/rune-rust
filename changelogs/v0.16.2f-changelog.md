# v0.16.2f Changelog - Combat Integration

## Overview

Implements the `IArmorCombatModifierService` for applying armor penalties to combat actions and determining Galdr casting eligibility. This is the final phase (f) of the Armor Proficiency System (v0.16.2).

## Added

### Value Objects

- **`CombatArmorState`** (`src/Core/RuneAndRust.Domain/ValueObjects/CombatArmorState.cs`)
    - Aggregates all armor-related combat modifiers into immutable snapshot
    - Properties: `EffectivePenalties`, `GaldrBlocked`, `GaldrPenalty`, `StealthDisadvantage`, `DisplayWarnings`
    - Computed: `HasAnyPenalty`, `HasAnyBonus`, `CanCastGaldr`, `AttackModifier`, `DefenseModifier`
    - Factory method: `Create()` with null-validation
    - Formatting: `FormatForCombatLog()`, `FormatDetailedSummary()`
    - Static: `CombatArmorState.None` for default/empty state

### Interfaces

- **`IArmorCombatModifierService`** (`src/Core/RuneAndRust.Application/Interfaces/IArmorCombatModifierService.cs`)
    - `GetCombatState(archetypeId, armorCategory)` - Complete combat state
    - `CanCastGaldr(archetypeId, armorCategory)` - Galdr casting check
    - `GetGaldrPenalty(archetypeId, armorCategory)` - Numerical Galdr penalty
    - `GetAgilityModifier(category, proficiency)` - Agility dice penalty
    - `GetStaminaCostModifier(category, proficiency)` - Stamina cost increase
    - `GetMovementModifier(category, proficiency)` - Movement penalty
    - `GetAttackModifier(category, proficiency)` - Attack roll modifier
    - `GetDefenseModifier(category, proficiency)` - Defense modifier
    - `HasStealthDisadvantage(category, proficiency)` - Stealth check

### Services

- **`ArmorCombatModifierService`** (`src/Core/RuneAndRust.Application/Services/ArmorCombatModifierService.cs`)
    - Injects `IArmorPenaltyCalculator`, `IArchetypeArmorProficiencyProvider`, `ILogger`
    - Integrates penalty calculations with archetype proficiency data
    - Generates display warnings for UI feedback
    - Comprehensive structured logging with Serilog patterns

### Unit Tests

- **`ArmorCombatModifierServiceTests.cs`** (10 tests)
    - `Constructor_WithNullPenaltyCalculator_ThrowsArgumentNullException`
    - `Constructor_WithNullArchetypeProvider_ThrowsArgumentNullException`
    - `GetCombatState_MysticInHeavyArmor_BlocksGaldr`
    - `GetGaldrPenalty_AdeptInMediumArmor_ReturnsMinusTwo`
    - `GetAttackModifier_NonProficientInHeavy_ReturnsNegativeTwo`
    - `GetDefenseModifier_MasterInHeavy_ReturnsPlusOne`
    - `CanCastGaldr_WarriorInAnyArmor_ReturnsTrue`
    - `CanCastGaldr_MysticWithShield_ReturnsFalse`
    - `GetCombatState_WithNullArchetypeId_ThrowsArgumentException`
    - `GetCombatState_WithEmptyArchetypeId_ThrowsArgumentException`

## Design Notes

### Interface Parameterization

The `IArmorCombatModifierService` interface accepts explicit `archetypeId` and `ArmorCategory` parameters rather than a `Player` entity. This design decision was made because:

1. The `Item` entity does not currently have an `ArmorCategory` property
2. Maintains loose coupling between combat and player systems
3. Allows calling services to provide armor context directly

### Galdr Interference Logic

- Mystic: Heavy armor and Shields **block** Galdr completely
- Adept: Shields block WITS abilities; Medium (-2) and Heavy (-4) impose penalties
- Warrior/Skirmisher: Never blocked, no Galdr penalties

### Display Warnings

The service generates contextual warnings for UI:

- "Galdr casting is BLOCKED by your armor"
- "Galdr casting penalty: -2"
- "Attack penalty: -2"
- "Penalties DOUBLED due to lack of proficiency"
- "Defense bonus: +1"

## Dependencies

- v0.16.2c: `IArchetypeArmorProficiencyProvider`, `GaldrInterference`
- v0.16.2d: `IArmorPenaltyCalculator`, `EffectiveArmorPenalties`

## Testing

```bash
dotnet test tests/RuneAndRust.Application.UnitTests \
  --filter "ArmorCombatModifierServiceTests" \
  --verbosity normal
```

All 10 tests pass.
