# v0.13.5c Design Specification: Service Integration Patterns

**Version:** 0.13.5c
**Theme:** Service Integration Patterns
**Author:** Claude
**Created:** 2026-01-16
**Status:** Draft
**Prerequisites:** v0.13.5b Complete (Theme Consolidation)

---

## Table of Contents

1. [Overview](#1-overview)
2. [Dependencies](#2-dependencies)
3. [Architecture Diagrams](#3-architecture-diagrams)
4. [Base Class Definitions](#4-base-class-definitions)
5. [Dependency Injection Patterns](#5-dependency-injection-patterns)
6. [Component Migration Plan](#6-component-migration-plan)
7. [Service Registration Standards](#7-service-registration-standards)
8. [Data Model Changes](#8-data-model-changes)
9. [Configuration](#9-configuration)
10. [Commands](#10-commands)
11. [User-Facing Changes](#11-user-facing-changes)
12. [Logging Specifications](#12-logging-specifications)
13. [Unit Testing Requirements](#13-unit-testing-requirements)
14. [Use Cases](#14-use-cases)
15. [Deliverable Checklist](#15-deliverable-checklist)
16. [Acceptance Criteria](#16-acceptance-criteria)
17. [Future Considerations](#17-future-considerations)
18. [Implementation Notes](#18-implementation-notes)
19. [Document Metadata](#19-document-metadata)

---

## 1. Overview

### 1.1 Purpose

This document provides a comprehensive design specification for v0.13.5c, the Service Integration Patterns implementation. This part focuses on establishing standardized dependency injection patterns and creating base classes for presentation components to ensure consistent service access, initialization, and lifecycle management across TUI and GUI layers.

### 1.2 Scope

**In Scope:**
- Define standard DI registration patterns for presentation services
- Standardize required vs optional dependency conventions
- Create `TuiComponentBase` abstract base class
- Create `GuiControlBase` abstract base class
- Create `IComponentLifecycle` interface for lifecycle management
- Update existing components to use base class patterns
- Document service integration guidelines

**Out of Scope:**
- Theme consolidation (v0.13.5b - completed)
- Naming convention changes (v0.13.5a - completed)
- Error handling and logging (v0.13.5d)
- Shared layer refactoring (v0.13.5e)
- Accessibility and performance (v0.13.5f)

### 1.3 Key Deliverables

| Type | Count | Details |
|------|-------|---------|
| Abstract Base Classes | 2 | `TuiComponentBase`, `GuiControlBase` |
| Interfaces | 1 | `IComponentLifecycle` |
| Service Extension Classes | 2 | `TuiServiceCollectionExtensions`, `GuiServiceCollectionExtensions` |
| Documentation | 1 | `ServiceIntegrationGuidelines.md` in `/docs/guidelines/` |
| Updated Components | ~10 | Existing components migrated to base classes |
| Unit Tests | ~6 | Base class, DI registration, lifecycle tests |

---

## 2. Dependencies

### 2.1 Required from v0.13.5b (Theme Consolidation)

| Component | Location | Usage |
|-----------|----------|-------|
| `IThemeService` | `Presentation.Shared/Interfaces/IThemeService.cs` | Required dependency in base classes |
| `ThemeColor` | `Presentation.Shared/ValueObjects/ThemeColor.cs` | Color representation for components |
| `ColorKey` | `Presentation.Shared/Enums/ColorKey.cs` | Type-safe color access |
| `TuiThemeAdapter` | `Presentation.Tui/Services/TuiThemeAdapter.cs` | TUI theme implementation |
| `GuiThemeAdapter` | `Presentation.Gui/Services/GuiThemeAdapter.cs` | GUI theme implementation |

### 2.2 Required from v0.13.5a (Naming Convention Alignment)

| Component | New Name | Location |
|-----------|----------|----------|
| `HealthBarDisplay` | Renamed from `HealthBar` | `Presentation.Tui/Displays/HealthBarDisplay.cs` |
| `ResourceBarDisplay` | Renamed from `ResourceBar` | `Presentation.Tui/Displays/ResourceBarDisplay.cs` |
| `CombatGridPanel` | Renamed from `CombatGridView` | `Presentation.Tui/Panels/CombatGridPanel.cs` |
| `ColoredTextRenderer` | Renamed from `ColoredText` | `Presentation.Tui/Renderers/ColoredTextRenderer.cs` |
| `BossHealthBarDisplay` | Renamed from `BossHealthBar` | `Presentation.Tui/Displays/BossHealthBarDisplay.cs` |

### 2.3 Existing Components Requiring Migration

| Component | Layer | Current State | Migration Target |
|-----------|-------|---------------|------------------|
| `HealthBarDisplay` | TUI | No base class, direct DI | Extend `TuiComponentBase` |
| `ResourceBarDisplay` | TUI | No base class, direct DI | Extend `TuiComponentBase` |
| `CombatGridPanel` | TUI | No base class, direct DI | Extend `TuiComponentBase` |
| `SpectreGameRenderer` | TUI | No base class, direct DI | Extend `TuiComponentBase` |
| `ColoredTextRenderer` | TUI | No base class, static methods | Extend `TuiComponentBase` |
| `HealthBarControl` | GUI | Extends `UserControl` | Extend `GuiControlBase` |
| `GridCellControl` | GUI | Extends `UserControl` | Extend `GuiControlBase` |
| `EntityTokenControl` | GUI | Extends `UserControl` | Extend `GuiControlBase` |
| `DamagePopupControl` | GUI | Extends `UserControl` | Extend `GuiControlBase` |
| `StatusEffectPanel` | TUI | v0.13.0, no base class | Extend `TuiComponentBase` |

### 2.4 Provides to v0.13.5d (Error Handling & Logging)

| Type | Usage |
|------|-------|
| `TuiComponentBase` | Foundation for SafeRender pattern |
| `GuiControlBase` | Foundation for SafeRender pattern |
| `IComponentLifecycle` | Lifecycle hooks for error recovery |

---

## 3. Architecture Diagrams

### 3.1 Service Integration Architecture

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                  SERVICE INTEGRATION ARCHITECTURE                            │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│                         Presentation.Shared                                  │
│                         ───────────────────                                  │
│                                                                              │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │              IComponentLifecycle (Interface)                         │    │
│  ├─────────────────────────────────────────────────────────────────────┤    │
│  │ + Initialize() : void                                                │    │
│  │ + Activate() : void                                                  │    │
│  │ + Deactivate() : void                                                │    │
│  │ + Dispose() : void                                                   │    │
│  │ + IsInitialized : bool { get; }                                      │    │
│  │ + IsActive : bool { get; }                                           │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
│                                    ▲                                         │
│                                    │ implements                              │
│                    ┌───────────────┴───────────────┐                        │
│                    │                               │                        │
├────────────────────┼───────────────────────────────┼────────────────────────┤
│    Presentation.Tui│                               │    Presentation.Gui    │
│    ───────────────┐│                               │    ───────────────┐    │
│                   ││                               │                   │    │
│  ┌────────────────▼┴───────────────┐  ┌───────────▼────────────────┐  │    │
│  │    TuiComponentBase             │  │    GuiControlBase          │  │    │
│  │    (Abstract Class)             │  │    (Abstract Class)        │  │    │
│  ├─────────────────────────────────┤  ├────────────────────────────┤  │    │
│  │ # Theme: IThemeService          │  │ # Theme: IThemeService     │  │    │
│  │ # Logger: ILogger               │  │ # Logger: ILogger          │  │    │
│  │ + Accessibility: IAccess...?    │  │ + Accessibility: IAccess..?│  │    │
│  │ # ComponentName: string         │  │ # ControlName: string      │  │    │
│  │ + IsInitialized: bool           │  │ + IsInitialized: bool      │  │    │
│  │ + IsActive: bool                │  │ + IsActive: bool           │  │    │
│  │ # Initialize(): void            │  │ # OnAttachedToVisualTree() │  │    │
│  │ # Activate(): void              │  │ # OnDetachedFromVisualTree │  │    │
│  │ # Deactivate(): void            │  │ # Dispose(): void          │  │    │
│  │ # Dispose(): void               │  │ + GetColor(ColorKey): Brush│  │    │
│  │ + GetColor(ColorKey): Consol... │  │ + GetIcon(IconKey): string │  │    │
│  │ + GetIcon(IconKey): string      │  └────────────────────────────┘  │    │
│  └─────────────────────────────────┘               ▲                  │    │
│               ▲                                    │ extends          │    │
│               │ extends                    ┌───────┴────────┐         │    │
│       ┌───────┴────────┐                   │                │         │    │
│       │                │           ┌───────▼──────┐ ┌───────▼──────┐  │    │
│ ┌─────▼──────┐  ┌──────▼─────┐     │ HealthBar    │ │ GridCell     │  │    │
│ │HealthBar  │  │ResourceBar │     │ Control      │ │ Control      │  │    │
│ │Display    │  │Display     │     └──────────────┘ └──────────────┘  │    │
│ └───────────┘  └────────────┘                                        │    │
│                                                                       │    │
└───────────────────────────────────────────────────────────────────────┴────┘
```

### 3.2 Dependency Injection Flow

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                    DEPENDENCY INJECTION FLOW                                 │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │                    IServiceCollection                                │    │
│  │                    ───────────────────                                │    │
│  │                                                                       │    │
│  │  services.AddRuneRustTuiServices()                                   │    │
│  │      │                                                                │    │
│  │      ├── AddSingleton<IThemeService, TuiThemeAdapter>()              │    │
│  │      ├── AddSingleton<ILogger, ConsoleLogger>()                      │    │
│  │      ├── AddTransient<HealthBarDisplay>()                            │    │
│  │      ├── AddTransient<ResourceBarDisplay>()                          │    │
│  │      ├── AddTransient<CombatGridPanel>()                             │    │
│  │      ├── AddTransient<SpectreGameRenderer>()                         │    │
│  │      └── AddTransient<ColoredTextRenderer>()                         │    │
│  │                                                                       │    │
│  │  services.AddRuneRustGuiServices()                                   │    │
│  │      │                                                                │    │
│  │      ├── AddSingleton<IThemeService, GuiThemeAdapter>()              │    │
│  │      ├── AddSingleton<ILogger, AvaloniaLogger>()                     │    │
│  │      └── ... (controls registered via Avalonia DI)                   │    │
│  │                                                                       │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
│                                                                              │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │                    Resolution Flow                                    │    │
│  │                    ───────────────                                    │    │
│  │                                                                       │    │
│  │  1. Component Requested                                               │    │
│  │     │                                                                 │    │
│  │     ▼                                                                 │    │
│  │  2. Constructor Injection (Required Dependencies)                     │    │
│  │     ├── IThemeService theme  ←── Resolved from container             │    │
│  │     └── ILogger logger       ←── Resolved from container             │    │
│  │     │                                                                 │    │
│  │     ▼                                                                 │    │
│  │  3. Property Injection (Optional Dependencies)                        │    │
│  │     └── IAccessibilityService? Accessibility ←── Set if registered   │    │
│  │     │                                                                 │    │
│  │     ▼                                                                 │    │
│  │  4. Component Ready                                                   │    │
│  │                                                                       │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 3.3 Component Lifecycle State Machine

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                    COMPONENT LIFECYCLE STATE MACHINE                         │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│                          ┌──────────────┐                                   │
│                          │   Created    │                                   │
│                          │ (via DI)     │                                   │
│                          └──────┬───────┘                                   │
│                                 │                                            │
│                                 │ Initialize()                               │
│                                 ▼                                            │
│                          ┌──────────────┐                                   │
│                          │ Initialized  │                                   │
│                          │ (IsInit=true)│                                   │
│                          └──────┬───────┘                                   │
│                                 │                                            │
│                                 │ Activate()                                 │
│                                 ▼                                            │
│                    ┌────────────────────────┐                               │
│                    │       Active           │                               │
│           ┌───────▶│   (IsActive=true)      │◀───────┐                      │
│           │        └───────────┬────────────┘        │                      │
│           │                    │                     │                      │
│           │ Activate()         │ Deactivate()        │ Activate()           │
│           │                    ▼                     │                      │
│           │        ┌────────────────────────┐        │                      │
│           │        │      Inactive          │        │                      │
│           └────────│   (IsActive=false)     │────────┘                      │
│                    └───────────┬────────────┘                               │
│                                │                                            │
│                                │ Dispose()                                   │
│                                ▼                                            │
│                          ┌──────────────┐                                   │
│                          │   Disposed   │                                   │
│                          │              │                                   │
│                          └──────────────┘                                   │
│                                                                              │
│  Lifecycle Events:                                                           │
│  ─────────────────                                                           │
│  • Initialize(): Called once after construction, before first use            │
│  • Activate(): Called when component becomes visible/active                  │
│  • Deactivate(): Called when component is hidden/backgrounded               │
│  • Dispose(): Called when component is being destroyed                       │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 4. Base Class Definitions

### 4.1 IComponentLifecycle Interface

```
┌─────────────────────────────────────────────────────────────────────────────┐
│  IComponentLifecycle (Interface - Presentation.Shared)                       │
│  ─────────────────────────────────────────────────────                       │
│                                                                              │
│  Location: Presentation.Shared/Interfaces/IComponentLifecycle.cs             │
│                                                                              │
│  public interface IComponentLifecycle : IDisposable                          │
│  {                                                                           │
│      /// <summary>                                                           │
│      /// Performs one-time initialization after construction.                │
│      /// Called before first use of the component.                           │
│      /// </summary>                                                          │
│      void Initialize();                                                      │
│                                                                              │
│      /// <summary>                                                           │
│      /// Called when component becomes active/visible.                       │
│      /// May be called multiple times during component lifetime.             │
│      /// </summary>                                                          │
│      void Activate();                                                        │
│                                                                              │
│      /// <summary>                                                           │
│      /// Called when component becomes inactive/hidden.                      │
│      /// May be called multiple times during component lifetime.             │
│      /// </summary>                                                          │
│      void Deactivate();                                                      │
│                                                                              │
│      /// <summary>                                                           │
│      /// Indicates whether Initialize() has been called.                     │
│      /// </summary>                                                          │
│      bool IsInitialized { get; }                                             │
│                                                                              │
│      /// <summary>                                                           │
│      /// Indicates whether component is currently active.                    │
│      /// </summary>                                                          │
│      bool IsActive { get; }                                                  │
│  }                                                                           │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 4.2 TuiComponentBase Abstract Class

```
┌─────────────────────────────────────────────────────────────────────────────┐
│  TuiComponentBase (Abstract Class - Presentation.Tui)                        │
│  ────────────────────────────────────────────────────                        │
│                                                                              │
│  Location: Presentation.Tui/Base/TuiComponentBase.cs                         │
│                                                                              │
│  public abstract class TuiComponentBase : IComponentLifecycle                │
│  {                                                                           │
│      // ═══════════════════════════════════════════════════════════════════ │
│      // REQUIRED DEPENDENCIES (Constructor Injection)                        │
│      // ═══════════════════════════════════════════════════════════════════ │
│                                                                              │
│      /// <summary>                                                           │
│      /// Theme service for consistent color and icon access.                 │
│      /// </summary>                                                          │
│      protected readonly IThemeService Theme;                                 │
│                                                                              │
│      /// <summary>                                                           │
│      /// Logger for diagnostic output.                                       │
│      /// </summary>                                                          │
│      protected readonly ILogger Logger;                                      │
│                                                                              │
│      // ═══════════════════════════════════════════════════════════════════ │
│      // OPTIONAL DEPENDENCIES (Property Injection)                           │
│      // ═══════════════════════════════════════════════════════════════════ │
│                                                                              │
│      /// <summary>                                                           │
│      /// Optional accessibility service for screen reader support.           │
│      /// Set via property injection if registered in DI container.           │
│      /// </summary>                                                          │
│      public IAccessibilityService? Accessibility { get; set; }               │
│                                                                              │
│      // ═══════════════════════════════════════════════════════════════════ │
│      // COMPONENT METADATA                                                   │
│      // ═══════════════════════════════════════════════════════════════════ │
│                                                                              │
│      /// <summary>                                                           │
│      /// Human-readable name for logging and diagnostics.                    │
│      /// </summary>                                                          │
│      protected abstract string ComponentName { get; }                        │
│                                                                              │
│      // ═══════════════════════════════════════════════════════════════════ │
│      // LIFECYCLE STATE                                                      │
│      // ═══════════════════════════════════════════════════════════════════ │
│                                                                              │
│      public bool IsInitialized { get; private set; }                         │
│      public bool IsActive { get; private set; }                              │
│      private bool _isDisposed;                                               │
│                                                                              │
│      // ═══════════════════════════════════════════════════════════════════ │
│      // CONSTRUCTOR                                                          │
│      // ═══════════════════════════════════════════════════════════════════ │
│                                                                              │
│      protected TuiComponentBase(IThemeService theme, ILogger logger)         │
│      {                                                                       │
│          Theme = theme ?? throw new ArgumentNullException(nameof(theme));    │
│          Logger = logger ?? throw new ArgumentNullException(nameof(logger)); │
│      }                                                                       │
│                                                                              │
│      // ═══════════════════════════════════════════════════════════════════ │
│      // LIFECYCLE METHODS                                                    │
│      // ═══════════════════════════════════════════════════════════════════ │
│                                                                              │
│      public void Initialize()                                                │
│      {                                                                       │
│          if (IsInitialized) return;                                          │
│          Logger.LogDebug("Initializing {Component}", ComponentName);         │
│          OnInitialize();                                                     │
│          IsInitialized = true;                                               │
│          Logger.LogDebug("Initialized {Component}", ComponentName);          │
│      }                                                                       │
│                                                                              │
│      public void Activate()                                                  │
│      {                                                                       │
│          if (!IsInitialized) Initialize();                                   │
│          if (IsActive) return;                                               │
│          Logger.LogDebug("Activating {Component}", ComponentName);           │
│          OnActivate();                                                       │
│          IsActive = true;                                                    │
│      }                                                                       │
│                                                                              │
│      public void Deactivate()                                                │
│      {                                                                       │
│          if (!IsActive) return;                                              │
│          Logger.LogDebug("Deactivating {Component}", ComponentName);         │
│          OnDeactivate();                                                     │
│          IsActive = false;                                                   │
│      }                                                                       │
│                                                                              │
│      public void Dispose()                                                   │
│      {                                                                       │
│          if (_isDisposed) return;                                            │
│          Deactivate();                                                       │
│          Logger.LogDebug("Disposing {Component}", ComponentName);            │
│          OnDispose();                                                        │
│          _isDisposed = true;                                                 │
│      }                                                                       │
│                                                                              │
│      // ═══════════════════════════════════════════════════════════════════ │
│      // OVERRIDABLE LIFECYCLE HOOKS                                          │
│      // ═══════════════════════════════════════════════════════════════════ │
│                                                                              │
│      protected virtual void OnInitialize() { }                               │
│      protected virtual void OnActivate() { }                                 │
│      protected virtual void OnDeactivate() { }                               │
│      protected virtual void OnDispose() { }                                  │
│                                                                              │
│      // ═══════════════════════════════════════════════════════════════════ │
│      // THEME HELPER METHODS                                                 │
│      // ═══════════════════════════════════════════════════════════════════ │
│                                                                              │
│      /// <summary>                                                           │
│      /// Gets a ConsoleColor for the specified color key.                    │
│      /// </summary>                                                          │
│      protected ConsoleColor GetColor(ColorKey key)                           │
│      {                                                                       │
│          var themeColor = Theme.GetColor(key);                               │
│          return ((TuiThemeAdapter)Theme).ToConsoleColor(themeColor);         │
│      }                                                                       │
│                                                                              │
│      /// <summary>                                                           │
│      /// Gets a Spectre.Console Color for the specified color key.           │
│      /// </summary>                                                          │
│      protected Color GetSpectreColor(ColorKey key)                           │
│      {                                                                       │
│          var themeColor = Theme.GetColor(key);                               │
│          return ((TuiThemeAdapter)Theme).ToSpectreColor(themeColor);         │
│      }                                                                       │
│                                                                              │
│      /// <summary>                                                           │
│      /// Gets the icon string for the specified icon key.                    │
│      /// Falls back to ASCII if Unicode not supported.                       │
│      /// </summary>                                                          │
│      protected string GetIcon(IconKey key)                                   │
│      {                                                                       │
│          return Theme.GetIcon(key);                                          │
│      }                                                                       │
│                                                                              │
│      /// <summary>                                                           │
│      /// Gets the health color based on percentage (0.0 to 1.0).             │
│      /// </summary>                                                          │
│      protected ConsoleColor GetHealthColor(double percentage)                │
│      {                                                                       │
│          var themeColor = Theme.GetHealthColor(percentage);                  │
│          return ((TuiThemeAdapter)Theme).ToConsoleColor(themeColor);         │
│      }                                                                       │
│  }                                                                           │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 4.3 GuiControlBase Abstract Class

```
┌─────────────────────────────────────────────────────────────────────────────┐
│  GuiControlBase (Abstract Class - Presentation.Gui)                          │
│  ──────────────────────────────────────────────────                          │
│                                                                              │
│  Location: Presentation.Gui/Base/GuiControlBase.cs                           │
│                                                                              │
│  public abstract class GuiControlBase : UserControl, IComponentLifecycle     │
│  {                                                                           │
│      // ═══════════════════════════════════════════════════════════════════ │
│      // REQUIRED DEPENDENCIES (Constructor Injection)                        │
│      // ═══════════════════════════════════════════════════════════════════ │
│                                                                              │
│      /// <summary>                                                           │
│      /// Theme service for consistent color and icon access.                 │
│      /// </summary>                                                          │
│      protected readonly IThemeService Theme;                                 │
│                                                                              │
│      /// <summary>                                                           │
│      /// Logger for diagnostic output.                                       │
│      /// </summary>                                                          │
│      protected readonly ILogger Logger;                                      │
│                                                                              │
│      // ═══════════════════════════════════════════════════════════════════ │
│      // OPTIONAL DEPENDENCIES (Property Injection)                           │
│      // ═══════════════════════════════════════════════════════════════════ │
│                                                                              │
│      /// <summary>                                                           │
│      /// Optional accessibility service for screen reader support.           │
│      /// </summary>                                                          │
│      public IAccessibilityService? Accessibility { get; set; }               │
│                                                                              │
│      // ═══════════════════════════════════════════════════════════════════ │
│      // COMPONENT METADATA                                                   │
│      // ═══════════════════════════════════════════════════════════════════ │
│                                                                              │
│      /// <summary>                                                           │
│      /// Human-readable name for logging and diagnostics.                    │
│      /// </summary>                                                          │
│      protected abstract string ControlName { get; }                          │
│                                                                              │
│      // ═══════════════════════════════════════════════════════════════════ │
│      // LIFECYCLE STATE                                                      │
│      // ═══════════════════════════════════════════════════════════════════ │
│                                                                              │
│      public bool IsInitialized { get; private set; }                         │
│      public bool IsActive { get; private set; }                              │
│      private bool _isDisposed;                                               │
│                                                                              │
│      // ═══════════════════════════════════════════════════════════════════ │
│      // BRUSH CACHE                                                          │
│      // ═══════════════════════════════════════════════════════════════════ │
│                                                                              │
│      private readonly Dictionary<ColorKey, IBrush> _brushCache = new();      │
│                                                                              │
│      // ═══════════════════════════════════════════════════════════════════ │
│      // CONSTRUCTOR                                                          │
│      // ═══════════════════════════════════════════════════════════════════ │
│                                                                              │
│      protected GuiControlBase(IThemeService theme, ILogger logger)           │
│      {                                                                       │
│          Theme = theme ?? throw new ArgumentNullException(nameof(theme));    │
│          Logger = logger ?? throw new ArgumentNullException(nameof(logger)); │
│      }                                                                       │
│                                                                              │
│      // ═══════════════════════════════════════════════════════════════════ │
│      // AVALONIA LIFECYCLE INTEGRATION                                       │
│      // ═══════════════════════════════════════════════════════════════════ │
│                                                                              │
│      protected override void OnAttachedToVisualTree(VisualTreeAttachmentEv..│
│      {                                                                       │
│          base.OnAttachedToVisualTree(e);                                     │
│          if (!IsInitialized) Initialize();                                   │
│          Activate();                                                         │
│      }                                                                       │
│                                                                              │
│      protected override void OnDetachedFromVisualTree(VisualTreeAttachment..│
│      {                                                                       │
│          Deactivate();                                                       │
│          base.OnDetachedFromVisualTree(e);                                   │
│      }                                                                       │
│                                                                              │
│      // ═══════════════════════════════════════════════════════════════════ │
│      // LIFECYCLE METHODS                                                    │
│      // ═══════════════════════════════════════════════════════════════════ │
│                                                                              │
│      public void Initialize()                                                │
│      {                                                                       │
│          if (IsInitialized) return;                                          │
│          Logger.LogDebug("Initializing {Control}", ControlName);             │
│          OnControlInitialize();                                              │
│          IsInitialized = true;                                               │
│      }                                                                       │
│                                                                              │
│      public void Activate()                                                  │
│      {                                                                       │
│          if (!IsInitialized) Initialize();                                   │
│          if (IsActive) return;                                               │
│          Logger.LogDebug("Activating {Control}", ControlName);               │
│          OnControlActivate();                                                │
│          IsActive = true;                                                    │
│      }                                                                       │
│                                                                              │
│      public void Deactivate()                                                │
│      {                                                                       │
│          if (!IsActive) return;                                              │
│          Logger.LogDebug("Deactivating {Control}", ControlName);             │
│          OnControlDeactivate();                                              │
│          IsActive = false;                                                   │
│      }                                                                       │
│                                                                              │
│      public new void Dispose()                                               │
│      {                                                                       │
│          if (_isDisposed) return;                                            │
│          Deactivate();                                                       │
│          Logger.LogDebug("Disposing {Control}", ControlName);                │
│          _brushCache.Clear();                                                │
│          OnControlDispose();                                                 │
│          _isDisposed = true;                                                 │
│          base.Dispose();                                                     │
│      }                                                                       │
│                                                                              │
│      // ═══════════════════════════════════════════════════════════════════ │
│      // OVERRIDABLE LIFECYCLE HOOKS                                          │
│      // ═══════════════════════════════════════════════════════════════════ │
│                                                                              │
│      protected virtual void OnControlInitialize() { }                        │
│      protected virtual void OnControlActivate() { }                          │
│      protected virtual void OnControlDeactivate() { }                        │
│      protected virtual void OnControlDispose() { }                           │
│                                                                              │
│      // ═══════════════════════════════════════════════════════════════════ │
│      // THEME HELPER METHODS                                                 │
│      // ═══════════════════════════════════════════════════════════════════ │
│                                                                              │
│      /// <summary>                                                           │
│      /// Gets a cached Brush for the specified color key.                    │
│      /// </summary>                                                          │
│      protected IBrush GetBrush(ColorKey key)                                 │
│      {                                                                       │
│          if (!_brushCache.TryGetValue(key, out var brush))                   │
│          {                                                                   │
│              var themeColor = Theme.GetColor(key);                           │
│              brush = ((GuiThemeAdapter)Theme).ToBrush(themeColor);           │
│              _brushCache[key] = brush;                                       │
│          }                                                                   │
│          return brush;                                                       │
│      }                                                                       │
│                                                                              │
│      /// <summary>                                                           │
│      /// Gets a Brush for health color based on percentage (0.0 to 1.0).     │
│      /// Not cached due to dynamic nature.                                   │
│      /// </summary>                                                          │
│      protected IBrush GetHealthBrush(double percentage)                      │
│      {                                                                       │
│          var themeColor = Theme.GetHealthColor(percentage);                  │
│          return ((GuiThemeAdapter)Theme).ToBrush(themeColor);                │
│      }                                                                       │
│                                                                              │
│      /// <summary>                                                           │
│      /// Gets the icon string for the specified icon key.                    │
│      /// </summary>                                                          │
│      protected string GetIcon(IconKey key)                                   │
│      {                                                                       │
│          return Theme.GetIcon(key);                                          │
│      }                                                                       │
│                                                                              │
│      /// <summary>                                                           │
│      /// Invalidates the brush cache, forcing colors to be re-fetched.       │
│      /// Call when theme changes.                                            │
│      /// </summary>                                                          │
│      protected void InvalidateBrushCache()                                   │
│      {                                                                       │
│          _brushCache.Clear();                                                │
│      }                                                                       │
│  }                                                                           │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 5. Dependency Injection Patterns

### 5.1 Required vs Optional Dependencies

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                    DEPENDENCY INJECTION PATTERNS                             │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │  REQUIRED DEPENDENCIES (Constructor Injection)                       │    │
│  │  ──────────────────────────────────────────────                       │    │
│  │                                                                       │    │
│  │  • MUST be provided at construction time                              │    │
│  │  • Null values throw ArgumentNullException                            │    │
│  │  • Stored in readonly fields                                          │    │
│  │  • Component cannot function without them                             │    │
│  │                                                                       │    │
│  │  Standard Required Dependencies:                                      │    │
│  │  ├── IThemeService theme    (colors, icons, animations)              │    │
│  │  └── ILogger logger         (diagnostics, debugging)                 │    │
│  │                                                                       │    │
│  │  Example:                                                             │    │
│  │  ┌────────────────────────────────────────────────────────────────┐  │    │
│  │  │ protected readonly IThemeService Theme;                         │  │    │
│  │  │ protected readonly ILogger Logger;                              │  │    │
│  │  │                                                                  │  │    │
│  │  │ protected TuiComponentBase(IThemeService theme, ILogger logger) │  │    │
│  │  │ {                                                                │  │    │
│  │  │     Theme = theme ?? throw new ArgumentNullException(...);      │  │    │
│  │  │     Logger = logger ?? throw new ArgumentNullException(...);    │  │    │
│  │  │ }                                                                │  │    │
│  │  └────────────────────────────────────────────────────────────────┘  │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
│                                                                              │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │  OPTIONAL DEPENDENCIES (Property Injection)                          │    │
│  │  ──────────────────────────────────────────                          │    │
│  │                                                                       │    │
│  │  • MAY be set after construction                                      │    │
│  │  • Null values are valid (feature disabled)                           │    │
│  │  • Stored in nullable properties with setters                         │    │
│  │  • Component functions without them (degraded mode)                   │    │
│  │                                                                       │    │
│  │  Standard Optional Dependencies:                                      │    │
│  │  ├── IAccessibilityService?   (screen reader, color blind mode)      │    │
│  │  ├── IPerformanceMonitor?     (perf tracking, metrics)               │    │
│  │  └── IAnimationService?       (animation control, reduced motion)    │    │
│  │                                                                       │    │
│  │  Example:                                                             │    │
│  │  ┌────────────────────────────────────────────────────────────────┐  │    │
│  │  │ public IAccessibilityService? Accessibility { get; set; }       │  │    │
│  │  │                                                                  │  │    │
│  │  │ // Usage with null check:                                        │  │    │
│  │  │ if (Accessibility?.IsScreenReaderActive == true)                 │  │    │
│  │  │ {                                                                │  │    │
│  │  │     // Provide screen reader text                                │  │    │
│  │  │ }                                                                │  │    │
│  │  └────────────────────────────────────────────────────────────────┘  │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 5.2 Dependency Classification Matrix

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                    DEPENDENCY CLASSIFICATION MATRIX                          │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  ┌────────────────────┬──────────────┬──────────────┬──────────────────┐    │
│  │ Dependency         │ Injection    │ Nullability  │ Reason           │    │
│  ├────────────────────┼──────────────┼──────────────┼──────────────────┤    │
│  │ IThemeService      │ Constructor  │ Not nullable │ Core rendering   │    │
│  │ ILogger            │ Constructor  │ Not nullable │ Core diagnostics │    │
│  │ IAccessibilityServ │ Property     │ Nullable     │ Optional feature │    │
│  │ IPerformanceMonitor│ Property     │ Nullable     │ Optional metrics │    │
│  │ IAnimationService  │ Property     │ Nullable     │ Optional anims   │    │
│  │ IEventBus          │ Constructor* │ Not nullable │ Event handling   │    │
│  │ IGameStateProvider │ Constructor* │ Not nullable │ State access     │    │
│  └────────────────────┴──────────────┴──────────────┴──────────────────┘    │
│                                                                              │
│  * = Only for components that require event/state access                     │
│                                                                              │
│  Decision Criteria:                                                          │
│  ──────────────────                                                          │
│  Constructor Injection when:                                                 │
│  • Component cannot function without dependency                              │
│  • Dependency must be available before first use                             │
│  • Dependency is used in most/all component methods                          │
│                                                                              │
│  Property Injection when:                                                    │
│  • Feature is optional/enhancement only                                      │
│  • Component has graceful degradation without it                             │
│  • Dependency may not be registered in all contexts                          │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 6. Component Migration Plan

### 6.1 TUI Component Migration

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                    TUI COMPONENT MIGRATION PLAN                              │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  Priority 1: Core Display Components                                         │
│  ────────────────────────────────────                                        │
│                                                                              │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │  HealthBarDisplay Migration                                          │    │
│  │  ─────────────────────────────                                        │    │
│  │  File: Presentation.Tui/Displays/HealthBarDisplay.cs                  │    │
│  │                                                                       │    │
│  │  BEFORE:                                                              │    │
│  │  ┌────────────────────────────────────────────────────────────────┐  │    │
│  │  │ public class HealthBarDisplay                                   │  │    │
│  │  │ {                                                                │  │    │
│  │  │     private readonly HealthBarConfig _config;                   │  │    │
│  │  │                                                                  │  │    │
│  │  │     public HealthBarDisplay(HealthBarConfig config)             │  │    │
│  │  │     {                                                            │  │    │
│  │  │         _config = config;                                        │  │    │
│  │  │     }                                                            │  │    │
│  │  │                                                                  │  │    │
│  │  │     public void Render(int current, int max)                     │  │    │
│  │  │     {                                                            │  │    │
│  │  │         var color = GetColorForPercentage(current / max);        │  │    │
│  │  │         // ... render logic                                      │  │    │
│  │  │     }                                                            │  │    │
│  │  │ }                                                                │  │    │
│  │  └────────────────────────────────────────────────────────────────┘  │    │
│  │                                                                       │    │
│  │  AFTER:                                                               │    │
│  │  ┌────────────────────────────────────────────────────────────────┐  │    │
│  │  │ public class HealthBarDisplay : TuiComponentBase                │  │    │
│  │  │ {                                                                │  │    │
│  │  │     protected override string ComponentName => "HealthBar";     │  │    │
│  │  │                                                                  │  │    │
│  │  │     public HealthBarDisplay(IThemeService theme, ILogger log)   │  │    │
│  │  │         : base(theme, log)                                       │  │    │
│  │  │     { }                                                          │  │    │
│  │  │                                                                  │  │    │
│  │  │     public void Render(int current, int max)                     │  │    │
│  │  │     {                                                            │  │    │
│  │  │         var percentage = (double)current / max;                  │  │    │
│  │  │         var color = GetHealthColor(percentage);                  │  │    │
│  │  │         // ... render logic using base class helpers             │  │    │
│  │  │     }                                                            │  │    │
│  │  │ }                                                                │  │    │
│  │  └────────────────────────────────────────────────────────────────┘  │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
│                                                                              │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │  ResourceBarDisplay Migration                                         │    │
│  │  ────────────────────────────────                                     │    │
│  │  File: Presentation.Tui/Displays/ResourceBarDisplay.cs                │    │
│  │                                                                       │    │
│  │  BEFORE:                                                              │    │
│  │  ┌────────────────────────────────────────────────────────────────┐  │    │
│  │  │ public class ResourceBarDisplay                                 │  │    │
│  │  │ {                                                                │  │    │
│  │  │     private static readonly Dictionary<string, ConsoleColor>    │  │    │
│  │  │         ResourceColors = new()                                   │  │    │
│  │  │     {                                                            │  │    │
│  │  │         ["Mana"] = ConsoleColor.Blue,                            │  │    │
│  │  │         ["Rage"] = ConsoleColor.Red,                             │  │    │
│  │  │         // ...                                                   │  │    │
│  │  │     };                                                           │  │    │
│  │  │ }                                                                │  │    │
│  │  └────────────────────────────────────────────────────────────────┘  │    │
│  │                                                                       │    │
│  │  AFTER:                                                               │    │
│  │  ┌────────────────────────────────────────────────────────────────┐  │    │
│  │  │ public class ResourceBarDisplay : TuiComponentBase              │  │    │
│  │  │ {                                                                │  │    │
│  │  │     protected override string ComponentName => "ResourceBar";   │  │    │
│  │  │                                                                  │  │    │
│  │  │     public ResourceBarDisplay(IThemeService theme, ILogger log) │  │    │
│  │  │         : base(theme, log)                                       │  │    │
│  │  │     { }                                                          │  │    │
│  │  │                                                                  │  │    │
│  │  │     public void Render(ResourceType type, int current, int max) │  │    │
│  │  │     {                                                            │  │    │
│  │  │         var themeColor = Theme.GetResourceColor(type);           │  │    │
│  │  │         var consoleColor = GetColor(ColorKeyFor(type));          │  │    │
│  │  │         // ... render logic                                      │  │    │
│  │  │     }                                                            │  │    │
│  │  │ }                                                                │  │    │
│  │  └────────────────────────────────────────────────────────────────┘  │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
│                                                                              │
│  Priority 2: Panel Components                                                │
│  ────────────────────────────                                                │
│                                                                              │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │  CombatGridPanel Migration                                            │    │
│  │  ─────────────────────────────                                        │    │
│  │  File: Presentation.Tui/Panels/CombatGridPanel.cs                     │    │
│  │                                                                       │    │
│  │  BEFORE:                                                              │    │
│  │  ┌────────────────────────────────────────────────────────────────┐  │    │
│  │  │ public class CombatGridPanel                                    │  │    │
│  │  │ {                                                                │  │    │
│  │  │     public CombatGridPanel() { }                                 │  │    │
│  │  │                                                                  │  │    │
│  │  │     private ConsoleColor GetTerrainColor(TerrainType type)       │  │    │
│  │  │         => type switch                                           │  │    │
│  │  │         {                                                        │  │    │
│  │  │             TerrainType.Floor => ConsoleColor.Gray,              │  │    │
│  │  │             TerrainType.Wall => ConsoleColor.DarkGray,           │  │    │
│  │  │             // ...                                               │  │    │
│  │  │         };                                                       │  │    │
│  │  │ }                                                                │  │    │
│  │  └────────────────────────────────────────────────────────────────┘  │    │
│  │                                                                       │    │
│  │  AFTER:                                                               │    │
│  │  ┌────────────────────────────────────────────────────────────────┐  │    │
│  │  │ public class CombatGridPanel : TuiComponentBase                 │  │    │
│  │  │ {                                                                │  │    │
│  │  │     protected override string ComponentName => "CombatGrid";    │  │    │
│  │  │                                                                  │  │    │
│  │  │     public CombatGridPanel(IThemeService theme, ILogger log)    │  │    │
│  │  │         : base(theme, log)                                       │  │    │
│  │  │     { }                                                          │  │    │
│  │  │                                                                  │  │    │
│  │  │     private ConsoleColor GetTerrainColor(TerrainType type)       │  │    │
│  │  │     {                                                            │  │    │
│  │  │         var themeColor = Theme.GetTerrainColor(type);            │  │    │
│  │  │         return ((TuiThemeAdapter)Theme).ToConsoleColor(theme...);│  │    │
│  │  │     }                                                            │  │    │
│  │  │ }                                                                │  │    │
│  │  └────────────────────────────────────────────────────────────────┘  │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
│                                                                              │
│  Priority 3: Renderer Components                                             │
│  ───────────────────────────────                                             │
│                                                                              │
│  Components to migrate:                                                      │
│  • SpectreGameRenderer → extend TuiComponentBase                             │
│  • ColoredTextRenderer → extend TuiComponentBase                             │
│                                                                              │
│  Priority 4: v0.13.0+ Components                                             │
│  ───────────────────────────────                                             │
│                                                                              │
│  Components to migrate:                                                      │
│  • StatusEffectPanel (v0.13.0)                                               │
│  • BossHealthBarDisplay (v0.13.1)                                            │
│  • AchievementPanel (v0.13.4a)                                               │
│  • DiceHistoryPanel (v0.13.4d)                                               │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 6.2 GUI Component Migration

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                    GUI COMPONENT MIGRATION PLAN                              │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  Priority 1: Core Control Components                                         │
│  ────────────────────────────────────                                        │
│                                                                              │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │  HealthBarControl Migration                                           │    │
│  │  ──────────────────────────────                                       │    │
│  │  File: Presentation.Gui/Controls/HealthBarControl.axaml.cs            │    │
│  │                                                                       │    │
│  │  BEFORE:                                                              │    │
│  │  ┌────────────────────────────────────────────────────────────────┐  │    │
│  │  │ public class HealthBarControl : UserControl                     │  │    │
│  │  │ {                                                                │  │    │
│  │  │     public HealthBarControl()                                    │  │    │
│  │  │     {                                                            │  │    │
│  │  │         InitializeComponent();                                   │  │    │
│  │  │     }                                                            │  │    │
│  │  │                                                                  │  │    │
│  │  │     private IBrush GetHealthBrush(double percentage)             │  │    │
│  │  │     {                                                            │  │    │
│  │  │         if (percentage > 0.75) return Brushes.Green;             │  │    │
│  │  │         if (percentage > 0.50) return Brushes.Yellow;            │  │    │
│  │  │         if (percentage > 0.25) return Brushes.Orange;            │  │    │
│  │  │         return Brushes.Red;                                      │  │    │
│  │  │     }                                                            │  │    │
│  │  │ }                                                                │  │    │
│  │  └────────────────────────────────────────────────────────────────┘  │    │
│  │                                                                       │    │
│  │  AFTER:                                                               │    │
│  │  ┌────────────────────────────────────────────────────────────────┐  │    │
│  │  │ public class HealthBarControl : GuiControlBase                  │  │    │
│  │  │ {                                                                │  │    │
│  │  │     protected override string ControlName => "HealthBar";       │  │    │
│  │  │                                                                  │  │    │
│  │  │     public HealthBarControl(IThemeService theme, ILogger log)   │  │    │
│  │  │         : base(theme, log)                                       │  │    │
│  │  │     {                                                            │  │    │
│  │  │         InitializeComponent();                                   │  │    │
│  │  │     }                                                            │  │    │
│  │  │                                                                  │  │    │
│  │  │     private IBrush GetHealthBrush(double percentage)             │  │    │
│  │  │     {                                                            │  │    │
│  │  │         return base.GetHealthBrush(percentage);                  │  │    │
│  │  │     }                                                            │  │    │
│  │  │ }                                                                │  │    │
│  │  └────────────────────────────────────────────────────────────────┘  │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
│                                                                              │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │  GridCellControl Migration                                            │    │
│  │  ─────────────────────────────                                        │    │
│  │  File: Presentation.Gui/Controls/GridCellControl.axaml.cs             │    │
│  │                                                                       │    │
│  │  BEFORE:                                                              │    │
│  │  ┌────────────────────────────────────────────────────────────────┐  │    │
│  │  │ public class GridCellControl : UserControl                      │  │    │
│  │  │ {                                                                │  │    │
│  │  │     private static readonly IBrush FloorBrush =                  │  │    │
│  │  │         new SolidColorBrush(Color.FromRgb(64, 64, 64));          │  │    │
│  │  │     private static readonly IBrush WallBrush =                   │  │    │
│  │  │         new SolidColorBrush(Color.FromRgb(32, 32, 32));          │  │    │
│  │  │ }                                                                │  │    │
│  │  └────────────────────────────────────────────────────────────────┘  │    │
│  │                                                                       │    │
│  │  AFTER:                                                               │    │
│  │  ┌────────────────────────────────────────────────────────────────┐  │    │
│  │  │ public class GridCellControl : GuiControlBase                   │  │    │
│  │  │ {                                                                │  │    │
│  │  │     protected override string ControlName => "GridCell";        │  │    │
│  │  │                                                                  │  │    │
│  │  │     public GridCellControl(IThemeService theme, ILogger log)    │  │    │
│  │  │         : base(theme, log)                                       │  │    │
│  │  │     { }                                                          │  │    │
│  │  │                                                                  │  │    │
│  │  │     private IBrush GetTerrainBrush(TerrainType type)             │  │    │
│  │  │     {                                                            │  │    │
│  │  │         return type switch                                       │  │    │
│  │  │         {                                                        │  │    │
│  │  │             TerrainType.Floor => GetBrush(ColorKey.Floor),       │  │    │
│  │  │             TerrainType.Wall => GetBrush(ColorKey.Wall),         │  │    │
│  │  │             _ => GetBrush(ColorKey.Surface)                      │  │    │
│  │  │         };                                                       │  │    │
│  │  │     }                                                            │  │    │
│  │  │ }                                                                │  │    │
│  │  └────────────────────────────────────────────────────────────────┘  │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
│                                                                              │
│  Priority 2: Additional Controls                                             │
│  ───────────────────────────────                                             │
│                                                                              │
│  Components to migrate:                                                      │
│  • EntityTokenControl → extend GuiControlBase                                │
│  • DamagePopupControl → extend GuiControlBase                                │
│  • StatusEffectControl → extend GuiControlBase                               │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 7. Service Registration Standards

### 7.1 TUI Service Registration

```
┌─────────────────────────────────────────────────────────────────────────────┐
│  TuiServiceCollectionExtensions (Static Class - Presentation.Tui)            │
│  ────────────────────────────────────────────────────────────────            │
│                                                                              │
│  Location: Presentation.Tui/Extensions/TuiServiceCollectionExtensions.cs     │
│                                                                              │
│  public static class TuiServiceCollectionExtensions                          │
│  {                                                                           │
│      /// <summary>                                                           │
│      /// Registers all TUI presentation services with standard patterns.     │
│      /// </summary>                                                          │
│      public static IServiceCollection AddRuneRustTuiServices(                │
│          this IServiceCollection services)                                   │
│      {                                                                       │
│          // ═══════════════════════════════════════════════════════════════ │
│          // CORE SERVICES (Singleton - shared across components)             │
│          // ═══════════════════════════════════════════════════════════════ │
│          services.AddSingleton<IThemeService, TuiThemeAdapter>();            │
│          services.AddSingleton<ILogger, ConsoleLogger>();                    │
│                                                                              │
│          // ═══════════════════════════════════════════════════════════════ │
│          // OPTIONAL SERVICES (Singleton - may not always be needed)         │
│          // ═══════════════════════════════════════════════════════════════ │
│          // These are registered but consumers use property injection        │
│          // services.AddSingleton<IAccessibilityService, ...>();             │
│                                                                              │
│          // ═══════════════════════════════════════════════════════════════ │
│          // DISPLAY COMPONENTS (Transient - new instance per request)        │
│          // ═══════════════════════════════════════════════════════════════ │
│          services.AddTransient<HealthBarDisplay>();                          │
│          services.AddTransient<ResourceBarDisplay>();                        │
│          services.AddTransient<BossHealthBarDisplay>();                      │
│                                                                              │
│          // ═══════════════════════════════════════════════════════════════ │
│          // PANEL COMPONENTS (Transient - new instance per request)          │
│          // ═══════════════════════════════════════════════════════════════ │
│          services.AddTransient<CombatGridPanel>();                           │
│          services.AddTransient<StatusEffectPanel>();                         │
│          services.AddTransient<AchievementPanel>();                          │
│          services.AddTransient<DiceHistoryPanel>();                          │
│                                                                              │
│          // ═══════════════════════════════════════════════════════════════ │
│          // RENDERER COMPONENTS (Transient - new instance per request)       │
│          // ═══════════════════════════════════════════════════════════════ │
│          services.AddTransient<SpectreGameRenderer>();                       │
│          services.AddTransient<ColoredTextRenderer>();                       │
│                                                                              │
│          return services;                                                    │
│      }                                                                       │
│  }                                                                           │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 7.2 GUI Service Registration

```
┌─────────────────────────────────────────────────────────────────────────────┐
│  GuiServiceCollectionExtensions (Static Class - Presentation.Gui)            │
│  ────────────────────────────────────────────────────────────────            │
│                                                                              │
│  Location: Presentation.Gui/Extensions/GuiServiceCollectionExtensions.cs     │
│                                                                              │
│  public static class GuiServiceCollectionExtensions                          │
│  {                                                                           │
│      /// <summary>                                                           │
│      /// Registers all GUI presentation services with standard patterns.     │
│      /// </summary>                                                          │
│      public static IServiceCollection AddRuneRustGuiServices(                │
│          this IServiceCollection services)                                   │
│      {                                                                       │
│          // ═══════════════════════════════════════════════════════════════ │
│          // CORE SERVICES (Singleton - shared across controls)               │
│          // ═══════════════════════════════════════════════════════════════ │
│          services.AddSingleton<IThemeService, GuiThemeAdapter>();            │
│          services.AddSingleton<ILogger, AvaloniaLogger>();                   │
│                                                                              │
│          // ═══════════════════════════════════════════════════════════════ │
│          // VIEW MODELS (Transient - new instance per view)                  │
│          // ═══════════════════════════════════════════════════════════════ │
│          // View models follow same DI pattern as controls                   │
│          services.AddTransient<CombatViewModel>();                           │
│          services.AddTransient<CharacterViewModel>();                        │
│          services.AddTransient<InventoryViewModel>();                        │
│                                                                              │
│          // Note: Controls are typically resolved via Avalonia's             │
│          // DataContext binding rather than direct DI resolution.            │
│          // ViewLocator pattern handles control instantiation.               │
│                                                                              │
│          return services;                                                    │
│      }                                                                       │
│                                                                              │
│      /// <summary>                                                           │
│      /// Configures Avalonia to use DI for control resolution.               │
│      /// </summary>                                                          │
│      public static AppBuilder UseRuneRustDependencyInjection(                │
│          this AppBuilder builder,                                            │
│          IServiceProvider serviceProvider)                                   │
│      {                                                                       │
│          return builder.AfterSetup(_ =>                                      │
│          {                                                                   │
│              // Configure ViewLocator to use DI                               │
│              Locator.CurrentMutable.RegisterConstant(                        │
│                  new DiViewLocator(serviceProvider));                        │
│          });                                                                 │
│      }                                                                       │
│  }                                                                           │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 7.3 Service Lifetime Guidelines

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                    SERVICE LIFETIME GUIDELINES                               │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  ┌────────────────────┬──────────────┬─────────────────────────────────┐    │
│  │ Service Type       │ Lifetime     │ Reason                          │    │
│  ├────────────────────┼──────────────┼─────────────────────────────────┤    │
│  │ IThemeService      │ Singleton    │ Shared state, expensive init    │    │
│  │ ILogger            │ Singleton    │ Shared output, thread-safe      │    │
│  │ IAccessibility...  │ Singleton    │ Shared settings, user prefs     │    │
│  │ IEventBus          │ Singleton    │ Central event coordination      │    │
│  │ IGameStateProvider │ Singleton    │ Single source of truth          │    │
│  ├────────────────────┼──────────────┼─────────────────────────────────┤    │
│  │ *Display           │ Transient    │ Lightweight, stateless render   │    │
│  │ *Panel             │ Transient    │ May hold view-specific state    │    │
│  │ *Control           │ Transient    │ Per-instance visual tree        │    │
│  │ *Renderer          │ Transient    │ Per-render context              │    │
│  │ *ViewModel         │ Transient    │ Per-view state management       │    │
│  ├────────────────────┼──────────────┼─────────────────────────────────┤    │
│  │ IConfiguration     │ Singleton    │ App-wide settings               │    │
│  │ Factory<T>         │ Singleton    │ Creates transient instances     │    │
│  └────────────────────┴──────────────┴─────────────────────────────────┘    │
│                                                                              │
│  Decision Tree:                                                              │
│  ──────────────                                                              │
│  1. Does it hold shared state? → Singleton                                   │
│  2. Is initialization expensive? → Singleton                                 │
│  3. Is it stateless? → Transient                                             │
│  4. Does each consumer need their own instance? → Transient                  │
│  5. Is it a UI component? → Transient (usually)                              │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 8. Data Model Changes

### 8.1 New Types Summary

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                         DATA MODEL CHANGES                                   │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  NEW: IComponentLifecycle (Interface - Presentation.Shared)                  │
│  ├── Initialize() : void                                                     │
│  ├── Activate() : void                                                       │
│  ├── Deactivate() : void                                                     │
│  ├── IsInitialized : bool { get; }                                           │
│  ├── IsActive : bool { get; }                                                │
│  └── Inherits: IDisposable                                                   │
│                                                                              │
│  NEW: TuiComponentBase (Abstract Class - Presentation.Tui)                   │
│  ├── Theme : IThemeService { get; } (protected, readonly)                    │
│  ├── Logger : ILogger { get; } (protected, readonly)                         │
│  ├── Accessibility : IAccessibilityService? { get; set; } (public)           │
│  ├── ComponentName : string { get; } (protected, abstract)                   │
│  ├── IsInitialized : bool { get; }                                           │
│  ├── IsActive : bool { get; }                                                │
│  ├── Initialize() : void                                                     │
│  ├── Activate() : void                                                       │
│  ├── Deactivate() : void                                                     │
│  ├── Dispose() : void                                                        │
│  ├── OnInitialize() : void (protected, virtual)                              │
│  ├── OnActivate() : void (protected, virtual)                                │
│  ├── OnDeactivate() : void (protected, virtual)                              │
│  ├── OnDispose() : void (protected, virtual)                                 │
│  ├── GetColor(ColorKey) : ConsoleColor (protected)                           │
│  ├── GetSpectreColor(ColorKey) : Color (protected)                           │
│  ├── GetIcon(IconKey) : string (protected)                                   │
│  ├── GetHealthColor(double) : ConsoleColor (protected)                       │
│  └── Implements: IComponentLifecycle                                         │
│                                                                              │
│  NEW: GuiControlBase (Abstract Class - Presentation.Gui)                     │
│  ├── Theme : IThemeService { get; } (protected, readonly)                    │
│  ├── Logger : ILogger { get; } (protected, readonly)                         │
│  ├── Accessibility : IAccessibilityService? { get; set; } (public)           │
│  ├── ControlName : string { get; } (protected, abstract)                     │
│  ├── IsInitialized : bool { get; }                                           │
│  ├── IsActive : bool { get; }                                                │
│  ├── Initialize() : void                                                     │
│  ├── Activate() : void                                                       │
│  ├── Deactivate() : void                                                     │
│  ├── Dispose() : void                                                        │
│  ├── OnControlInitialize() : void (protected, virtual)                       │
│  ├── OnControlActivate() : void (protected, virtual)                         │
│  ├── OnControlDeactivate() : void (protected, virtual)                       │
│  ├── OnControlDispose() : void (protected, virtual)                          │
│  ├── GetBrush(ColorKey) : IBrush (protected)                                 │
│  ├── GetHealthBrush(double) : IBrush (protected)                             │
│  ├── GetIcon(IconKey) : string (protected)                                   │
│  ├── InvalidateBrushCache() : void (protected)                               │
│  ├── Inherits: UserControl                                                   │
│  └── Implements: IComponentLifecycle                                         │
│                                                                              │
│  NEW: TuiServiceCollectionExtensions (Static Class - Presentation.Tui)       │
│  └── AddRuneRustTuiServices(IServiceCollection) : IServiceCollection         │
│                                                                              │
│  NEW: GuiServiceCollectionExtensions (Static Class - Presentation.Gui)       │
│  ├── AddRuneRustGuiServices(IServiceCollection) : IServiceCollection         │
│  └── UseRuneRustDependencyInjection(AppBuilder, IServiceProvider) : AppBld   │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 8.2 Modified Types

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                         MODIFIED TYPES                                       │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  MODIFIED: HealthBarDisplay (Presentation.Tui)                               │
│  ├── BEFORE: public class HealthBarDisplay                                   │
│  ├── AFTER:  public class HealthBarDisplay : TuiComponentBase                │
│  ├── REMOVED: HealthBarConfig dependency                                     │
│  ├── ADDED: IThemeService, ILogger constructor parameters                    │
│  └── ADDED: ComponentName property override                                  │
│                                                                              │
│  MODIFIED: ResourceBarDisplay (Presentation.Tui)                             │
│  ├── BEFORE: public class ResourceBarDisplay                                 │
│  ├── AFTER:  public class ResourceBarDisplay : TuiComponentBase              │
│  ├── REMOVED: static Dictionary<string, ConsoleColor>                        │
│  ├── ADDED: IThemeService, ILogger constructor parameters                    │
│  └── ADDED: ComponentName property override                                  │
│                                                                              │
│  MODIFIED: CombatGridPanel (Presentation.Tui)                                │
│  ├── BEFORE: public class CombatGridPanel                                    │
│  ├── AFTER:  public class CombatGridPanel : TuiComponentBase                 │
│  ├── REMOVED: switch expression for terrain colors                          │
│  ├── ADDED: IThemeService, ILogger constructor parameters                    │
│  └── ADDED: ComponentName property override                                  │
│                                                                              │
│  MODIFIED: SpectreGameRenderer (Presentation.Tui)                            │
│  ├── BEFORE: public class SpectreGameRenderer                                │
│  ├── AFTER:  public class SpectreGameRenderer : TuiComponentBase             │
│  ├── REMOVED: inline string color definitions                               │
│  ├── ADDED: IThemeService, ILogger constructor parameters                    │
│  └── ADDED: ComponentName property override                                  │
│                                                                              │
│  MODIFIED: ColoredTextRenderer (Presentation.Tui)                            │
│  ├── BEFORE: public class ColoredTextRenderer                                │
│  ├── AFTER:  public class ColoredTextRenderer : TuiComponentBase             │
│  ├── REMOVED: factory-based color creation                                  │
│  ├── ADDED: IThemeService, ILogger constructor parameters                    │
│  └── ADDED: ComponentName property override                                  │
│                                                                              │
│  MODIFIED: HealthBarControl (Presentation.Gui)                               │
│  ├── BEFORE: public class HealthBarControl : UserControl                     │
│  ├── AFTER:  public class HealthBarControl : GuiControlBase                  │
│  ├── REMOVED: hardcoded Brushes.* values                                    │
│  ├── ADDED: IThemeService, ILogger constructor parameters                    │
│  └── ADDED: ControlName property override                                    │
│                                                                              │
│  MODIFIED: GridCellControl (Presentation.Gui)                                │
│  ├── BEFORE: public class GridCellControl : UserControl                      │
│  ├── AFTER:  public class GridCellControl : GuiControlBase                   │
│  ├── REMOVED: static IBrush field definitions                               │
│  ├── ADDED: IThemeService, ILogger constructor parameters                    │
│  └── ADDED: ControlName property override                                    │
│                                                                              │
│  MODIFIED: EntityTokenControl (Presentation.Gui)                             │
│  ├── BEFORE: public class EntityTokenControl : UserControl                   │
│  ├── AFTER:  public class EntityTokenControl : GuiControlBase                │
│  ├── REMOVED: inconsistent green value definitions                          │
│  ├── ADDED: IThemeService, ILogger constructor parameters                    │
│  └── ADDED: ControlName property override                                    │
│                                                                              │
│  MODIFIED: DamagePopupControl (Presentation.Gui)                             │
│  ├── BEFORE: public class DamagePopupControl : UserControl                   │
│  ├── AFTER:  public class DamagePopupControl : GuiControlBase                │
│  ├── REMOVED: hardcoded popup color values                                  │
│  ├── ADDED: IThemeService, ILogger constructor parameters                    │
│  └── ADDED: ControlName property override                                    │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 9. Configuration

### 9.1 No New Configuration

This part does not introduce new configuration files. The service integration patterns use the existing dependency injection configuration through the extension methods defined in Section 7.

### 9.2 Program.cs Integration

```csharp
// Program.cs (TUI application)
var services = new ServiceCollection();
services.AddRuneRustTuiServices();
var serviceProvider = services.BuildServiceProvider();

// Program.cs (GUI application)
var services = new ServiceCollection();
services.AddRuneRustGuiServices();
var serviceProvider = services.BuildServiceProvider();

AppBuilder.Configure<App>()
    .UseRuneRustDependencyInjection(serviceProvider)
    .StartWithClassicDesktopLifetime(args);
```

---

## 10. Commands

This part does not introduce new user-facing commands. The service integration patterns are internal implementation details that do not affect the command interface.

---

## 11. User-Facing Changes

### 11.1 No Visible Changes

This part focuses on internal architecture improvements. Users will not notice any changes to the application's behavior or appearance. The benefits are:

- Improved code maintainability
- Consistent service access patterns
- Better testability of components
- Foundation for error handling (v0.13.5d)

---

## 12. Logging Specifications

### 12.1 Lifecycle Logging

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                    LIFECYCLE LOGGING SPECIFICATIONS                          │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  Log Level: Debug                                                            │
│  ──────────────                                                              │
│                                                                              │
│  Initialize:                                                                 │
│  ├── Start: "Initializing {ComponentName}"                                   │
│  └── End:   "Initialized {ComponentName}"                                    │
│                                                                              │
│  Activate:                                                                   │
│  └── "Activating {ComponentName}"                                            │
│                                                                              │
│  Deactivate:                                                                 │
│  └── "Deactivating {ComponentName}"                                          │
│                                                                              │
│  Dispose:                                                                    │
│  └── "Disposing {ComponentName}"                                             │
│                                                                              │
│  Example Output:                                                             │
│  ───────────────                                                             │
│  [DEBUG] Initializing HealthBar                                              │
│  [DEBUG] Initialized HealthBar                                               │
│  [DEBUG] Activating HealthBar                                                │
│  [DEBUG] Deactivating HealthBar                                              │
│  [DEBUG] Disposing HealthBar                                                 │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 12.2 Error Logging (Preparation for v0.13.5d)

The base classes establish the Logger dependency that will be used by v0.13.5d for error handling. No specific error logging patterns are implemented in this part.

---

## 13. Unit Testing Requirements

### 13.1 Test Categories

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                    UNIT TESTING REQUIREMENTS (~6 tests)                      │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  Category 1: IComponentLifecycle Interface Tests (1 test)                    │
│  ────────────────────────────────────────────────────────                    │
│                                                                              │
│  Test: ComponentLifecycle_InterfaceContract_VerifiesSignatures               │
│  ├── Verify: Interface defines Initialize(), Activate(), Deactivate()       │
│  ├── Verify: Interface defines IsInitialized, IsActive properties           │
│  └── Verify: Interface inherits from IDisposable                            │
│                                                                              │
│  Category 2: TuiComponentBase Tests (2 tests)                                │
│  ────────────────────────────────────────────                                │
│                                                                              │
│  Test: TuiComponentBase_Constructor_ThrowsOnNullTheme                        │
│  ├── Given: null IThemeService                                               │
│  ├── When: Constructor called                                                │
│  └── Then: ArgumentNullException thrown                                      │
│                                                                              │
│  Test: TuiComponentBase_Lifecycle_TransitionsCorrectly                       │
│  ├── Given: New TuiComponentBase instance                                    │
│  ├── When: Initialize() → Activate() → Deactivate() → Dispose()             │
│  └── Then: IsInitialized and IsActive reflect correct states                │
│                                                                              │
│  Category 3: GuiControlBase Tests (2 tests)                                  │
│  ────────────────────────────────────────────                                │
│                                                                              │
│  Test: GuiControlBase_Constructor_ThrowsOnNullLogger                         │
│  ├── Given: null ILogger                                                     │
│  ├── When: Constructor called                                                │
│  └── Then: ArgumentNullException thrown                                      │
│                                                                              │
│  Test: GuiControlBase_BrushCache_CachesCorrectly                             │
│  ├── Given: GuiControlBase with theme                                        │
│  ├── When: GetBrush() called twice with same ColorKey                        │
│  └── Then: Same IBrush instance returned (cached)                            │
│                                                                              │
│  Category 4: Service Registration Tests (1 test)                             │
│  ───────────────────────────────────────────────                             │
│                                                                              │
│  Test: TuiServiceCollectionExtensions_RegistersAllServices                   │
│  ├── Given: Empty IServiceCollection                                         │
│  ├── When: AddRuneRustTuiServices() called                                   │
│  └── Then: IThemeService, ILogger, components resolvable                     │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 13.2 Test File Locations

```
Tests/
├── Presentation.Shared.Tests/
│   └── Interfaces/
│       └── IComponentLifecycleTests.cs
├── Presentation.Tui.Tests/
│   ├── Base/
│   │   └── TuiComponentBaseTests.cs
│   └── Extensions/
│       └── TuiServiceCollectionExtensionsTests.cs
└── Presentation.Gui.Tests/
    └── Base/
        └── GuiControlBaseTests.cs
```

---

## 14. Use Cases

### 14.1 UC-5c-01: Create New TUI Component

```
┌─────────────────────────────────────────────────────────────────────────────┐
│  USE CASE: UC-5c-01 - Create New TUI Component                               │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  Actor: Developer                                                            │
│  Goal: Create a new TUI component following standard patterns                │
│                                                                              │
│  Preconditions:                                                              │
│  • TuiComponentBase exists                                                   │
│  • IThemeService is registered in DI                                         │
│                                                                              │
│  Steps:                                                                      │
│  1. Developer creates new class extending TuiComponentBase                   │
│  2. Developer implements ComponentName property                              │
│  3. Developer adds constructor with IThemeService and ILogger                │
│  4. Developer overrides lifecycle hooks as needed (OnInitialize, etc.)       │
│  5. Developer uses base class helpers (GetColor, GetIcon, GetHealthColor)    │
│  6. Developer registers component in DI via extension method                 │
│                                                                              │
│  Postconditions:                                                             │
│  • Component follows standard DI patterns                                    │
│  • Component has consistent lifecycle management                             │
│  • Component uses theme service for colors                                   │
│                                                                              │
│  Example:                                                                    │
│  ┌────────────────────────────────────────────────────────────────────────┐ │
│  │ public class StaminaBarDisplay : TuiComponentBase                       │ │
│  │ {                                                                        │ │
│  │     protected override string ComponentName => "StaminaBar";            │ │
│  │                                                                          │ │
│  │     public StaminaBarDisplay(IThemeService theme, ILogger logger)       │ │
│  │         : base(theme, logger) { }                                        │ │
│  │                                                                          │ │
│  │     protected override void OnInitialize()                               │ │
│  │     {                                                                    │ │
│  │         // One-time setup                                                │ │
│  │     }                                                                    │ │
│  │                                                                          │ │
│  │     public void Render(int current, int max)                             │ │
│  │     {                                                                    │ │
│  │         var color = GetColor(ColorKey.Stamina);                          │ │
│  │         // Render logic...                                               │ │
│  │     }                                                                    │ │
│  │ }                                                                        │ │
│  └────────────────────────────────────────────────────────────────────────┘ │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 14.2 UC-5c-02: Migrate Existing Component

```
┌─────────────────────────────────────────────────────────────────────────────┐
│  USE CASE: UC-5c-02 - Migrate Existing Component to Base Class               │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  Actor: Developer                                                            │
│  Goal: Migrate existing component to use TuiComponentBase                    │
│                                                                              │
│  Preconditions:                                                              │
│  • Existing component has custom color/service handling                      │
│  • TuiComponentBase is available                                             │
│                                                                              │
│  Steps:                                                                      │
│  1. Developer changes base class to TuiComponentBase                         │
│  2. Developer updates constructor to call base(theme, logger)                │
│  3. Developer implements ComponentName property                              │
│  4. Developer removes custom color dictionaries/configs                      │
│  5. Developer replaces color lookups with base class helpers                 │
│  6. Developer updates DI registration                                        │
│  7. Developer runs tests to verify behavior unchanged                        │
│                                                                              │
│  Postconditions:                                                             │
│  • Component uses standardized patterns                                      │
│  • Component behavior is unchanged                                           │
│  • Color handling centralized through theme service                          │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 14.3 UC-5c-03: Access Optional Service

```
┌─────────────────────────────────────────────────────────────────────────────┐
│  USE CASE: UC-5c-03 - Access Optional Accessibility Service                  │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  Actor: Component at runtime                                                 │
│  Goal: Use accessibility features when available                             │
│                                                                              │
│  Preconditions:                                                              │
│  • Component extends TuiComponentBase/GuiControlBase                         │
│  • IAccessibilityService may or may not be registered                        │
│                                                                              │
│  Steps:                                                                      │
│  1. Component checks if Accessibility property is non-null                   │
│  2. If available, component uses accessibility features                      │
│  3. If null, component continues with default behavior                       │
│                                                                              │
│  Example:                                                                    │
│  ┌────────────────────────────────────────────────────────────────────────┐ │
│  │ protected override void OnActivate()                                    │ │
│  │ {                                                                        │ │
│  │     if (Accessibility?.IsScreenReaderActive == true)                     │ │
│  │     {                                                                    │ │
│  │         // Announce component activation to screen reader                │ │
│  │         Accessibility.Announce($"{ComponentName} activated");            │ │
│  │     }                                                                    │ │
│  │ }                                                                        │ │
│  └────────────────────────────────────────────────────────────────────────┘ │
│                                                                              │
│  Postconditions:                                                             │
│  • Accessibility features used when available                                │
│  • No errors when accessibility not registered                               │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 15. Deliverable Checklist

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                         DELIVERABLE CHECKLIST                                │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  Interfaces                                                                  │
│  ──────────                                                                  │
│  [ ] IComponentLifecycle in Presentation.Shared/Interfaces/                  │
│                                                                              │
│  Base Classes                                                                │
│  ────────────                                                                │
│  [ ] TuiComponentBase in Presentation.Tui/Base/                              │
│  [ ] GuiControlBase in Presentation.Gui/Base/                                │
│                                                                              │
│  Extension Classes                                                           │
│  ─────────────────                                                           │
│  [ ] TuiServiceCollectionExtensions in Presentation.Tui/Extensions/          │
│  [ ] GuiServiceCollectionExtensions in Presentation.Gui/Extensions/          │
│                                                                              │
│  Migrated TUI Components                                                     │
│  ───────────────────────                                                     │
│  [ ] HealthBarDisplay extends TuiComponentBase                               │
│  [ ] ResourceBarDisplay extends TuiComponentBase                             │
│  [ ] CombatGridPanel extends TuiComponentBase                                │
│  [ ] SpectreGameRenderer extends TuiComponentBase                            │
│  [ ] ColoredTextRenderer extends TuiComponentBase                            │
│                                                                              │
│  Migrated GUI Components                                                     │
│  ───────────────────────                                                     │
│  [ ] HealthBarControl extends GuiControlBase                                 │
│  [ ] GridCellControl extends GuiControlBase                                  │
│  [ ] EntityTokenControl extends GuiControlBase                               │
│  [ ] DamagePopupControl extends GuiControlBase                               │
│                                                                              │
│  Documentation                                                               │
│  ─────────────                                                               │
│  [ ] ServiceIntegrationGuidelines.md in /docs/guidelines/                    │
│                                                                              │
│  Unit Tests                                                                  │
│  ──────────                                                                  │
│  [ ] IComponentLifecycleTests.cs (~1 test)                                   │
│  [ ] TuiComponentBaseTests.cs (~2 tests)                                     │
│  [ ] GuiControlBaseTests.cs (~2 tests)                                       │
│  [ ] TuiServiceCollectionExtensionsTests.cs (~1 test)                        │
│                                                                              │
│  Total: ~6 unit tests                                                        │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 16. Acceptance Criteria

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                         ACCEPTANCE CRITERIA                                  │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  Base Classes                                                                │
│  ────────────                                                                │
│  [ ] TuiComponentBase created with IThemeService, ILogger dependencies       │
│  [ ] GuiControlBase created with IThemeService, ILogger dependencies         │
│  [ ] IComponentLifecycle interface defined with lifecycle methods            │
│  [ ] Both base classes implement IComponentLifecycle                         │
│                                                                              │
│  Dependency Injection                                                        │
│  ────────────────────                                                        │
│  [ ] Required dependencies use constructor injection                         │
│  [ ] Optional dependencies use property injection                            │
│  [ ] Null checks throw ArgumentNullException for required deps               │
│  [ ] DI extension methods register all services                              │
│                                                                              │
│  Component Migration                                                         │
│  ───────────────────                                                         │
│  [ ] At least 5 TUI components updated to use TuiComponentBase               │
│  [ ] At least 4 GUI components updated to use GuiControlBase                 │
│  [ ] Migrated components have unchanged behavior                             │
│  [ ] Migrated components use base class theme helpers                        │
│                                                                              │
│  Lifecycle Management                                                        │
│  ────────────────────                                                        │
│  [ ] Initialize() called before first use                                    │
│  [ ] Activate()/Deactivate() track active state                              │
│  [ ] Dispose() cleans up resources                                           │
│  [ ] Lifecycle methods logged at Debug level                                 │
│                                                                              │
│  Documentation                                                               │
│  ─────────────                                                               │
│  [ ] Service integration guidelines created                                  │
│  [ ] Required vs optional dependency pattern documented                      │
│  [ ] Component migration steps documented                                    │
│                                                                              │
│  Testing                                                                     │
│  ───────                                                                     │
│  [ ] ~6 unit tests pass                                                      │
│  [ ] All existing tests continue to pass                                     │
│  [ ] No compilation errors                                                   │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 17. Future Considerations

### 17.1 v0.13.5d Integration (Error Handling & Logging)

The base classes established in this part provide the foundation for SafeRender patterns in v0.13.5d:

```csharp
// Future addition in v0.13.5d
protected void SafeRender(Action renderAction)
{
    try
    {
        renderAction();
    }
    catch (Exception ex)
    {
        Logger.LogWarning(ex, "Render failed for {Component}", ComponentName);
        RenderFallback();
    }
}
```

### 17.2 v0.13.5f Integration (Accessibility)

The optional `IAccessibilityService` property injection pattern prepares for v0.13.5f:

```csharp
// Future usage in v0.13.5f
if (Accessibility?.ColorBlindMode != ColorBlindMode.None)
{
    color = Accessibility.GetAccessibleColor(color);
}
```

### 17.3 Potential Enhancements

- **Factory Pattern**: Consider adding component factories for complex initialization
- **Pooling**: For frequently created/destroyed components, consider object pooling
- **Async Lifecycle**: Future versions may need async Initialize/Activate methods
- **State Persistence**: Consider adding state save/restore for component state

---

## 18. Implementation Notes

### 18.1 Migration Order

1. **Phase 1**: Create base classes and interfaces
2. **Phase 2**: Create extension methods for DI registration
3. **Phase 3**: Migrate TUI display components (HealthBarDisplay, ResourceBarDisplay)
4. **Phase 4**: Migrate TUI panel components (CombatGridPanel)
5. **Phase 5**: Migrate TUI renderer components (SpectreGameRenderer, ColoredTextRenderer)
6. **Phase 6**: Migrate GUI controls (HealthBarControl, GridCellControl, etc.)
7. **Phase 7**: Update Program.cs to use extension methods
8. **Phase 8**: Create documentation
9. **Phase 9**: Write and run tests

### 18.2 Backward Compatibility

During migration, components can be updated incrementally:
- New components should always use base classes
- Existing components can be migrated one at a time
- No breaking changes to public APIs

### 18.3 Testing Strategy

- Unit test base classes in isolation with mocks
- Integration test DI registration with real container
- Verify migrated components maintain existing behavior
- Use snapshot testing for rendered output comparison

---

## 19. Document Metadata

| Field | Value |
|-------|-------|
| **Document Version** | 1.0 |
| **Created** | 2026-01-16 |
| **Last Updated** | 2026-01-16 |
| **Author** | Claude |
| **Status** | Draft |
| **Related Documents** | v0.13.5-scope-breakdown.md, v0.13.5a-design-specification.md, v0.13.5b-design-specification.md |

### Change History

| Version | Date | Author | Changes |
|---------|------|--------|---------|
| 1.0 | 2026-01-16 | Claude | Initial draft |

---

*This design specification provides a comprehensive blueprint for implementing v0.13.5c Service Integration Patterns. The base classes and DI patterns established here will serve as the foundation for error handling (v0.13.5d), shared layer utilization (v0.13.5e), and accessibility features (v0.13.5f).*
