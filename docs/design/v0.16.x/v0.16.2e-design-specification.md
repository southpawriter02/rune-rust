# v0.16.2e Design Specification: Proficiency Acquisition

**Version:** 0.16.2e  
**Phase Name:** Proficiency Acquisition  
**Parent Version:** v0.16.2 (Armor Proficiency System)  
**Prerequisites:** v0.16.2a-d Complete  
**Estimated Tests:** ~3 unit tests

---

## Table of Contents

1. [Executive Summary](#1-executive-summary)
2. [Feature Overview](#2-feature-overview)
3. [Architecture Diagrams](#3-architecture-diagrams)
4. [ArmorTrainingRequirement Value Object](#4-armortrainingrequirement-value-object)
5. [ArmorTrainingResult Value Object](#5-armortrainingresult-value-object)
6. [IArmorProficiencyAcquisitionService Interface](#6-iarmorproficiencyacquisitionservice-interface)
7. [ArmorProficiencyAcquisitionService Implementation](#7-armorproficiencyacquisitionservice-implementation)
8. [Configuration File Schemas](#8-configuration-file-schemas)
9. [Data Model Changes](#9-data-model-changes)
10. [Logging Specifications](#10-logging-specifications)
11. [Unit Testing Requirements](#11-unit-testing-requirements)
12. [Use Cases](#12-use-cases)
13. [Deliverable Checklist](#13-deliverable-checklist)
14. [Acceptance Criteria](#14-acceptance-criteria)
15. [Dependencies](#15-dependencies)
16. [Future Considerations](#16-future-considerations)

---

## 1. Executive Summary

### 1.1 Purpose

This specification defines the proficiency acquisition service that allows characters to train and improve their armor proficiency levels. Characters can progress through the proficiency tiers (NonProficient → Proficient → Expert → Master) by meeting prerequisites and paying training costs.

**Proficiency Progression Path:**

```
NonProficient → Proficient → Expert → Master
     ↓              ↓           ↓         ↓
  (Base)       (Training)  (Advanced)  (Mastery)
   Free         100 gold    500 gold   1000 gold
   None        Level 1     Level 5     Level 10
```

**Key Training Rules:**

1. **Archetype Proficiency**: Starting proficiency is determined by archetype (v0.16.2c)
2. **Sequential Progression**: Must progress through each level in order
3. **Prerequisites**: Each level requires minimum character level
4. **Training Costs**: Gold cost increases with proficiency level
5. **Trainer Required**: Training requires visiting appropriate trainer NPC

### 1.2 Key Deliverables

| Category          | Items                                             |
| ----------------- | ------------------------------------------------- |
| **Value Objects** | `ArmorTrainingRequirement`, `ArmorTrainingResult` |
| **Interfaces**    | `IArmorProficiencyAcquisitionService`             |
| **Services**      | `ArmorProficiencyAcquisitionService`              |
| **Configuration** | `armor-training-requirements.json`, schema        |
| **Tests**         | ~3 unit tests                                     |

### 1.3 Architectural Significance

This version establishes the **Training Acquisition Pattern**:

- **Prerequisites Validation**: Level, gold, and current proficiency checks
- **Cost Calculation**: Configurable training costs per level
- **Result Reporting**: Detailed success/failure information
- **Configuration-Driven**: All requirements externalized to JSON

---

## 2. Feature Overview

```
v0.16.2e Proficiency Acquisition
├── ArmorTrainingRequirement Value Object
│   ├── TargetLevel: ArmorProficiencyLevel
│   ├── MinimumCharacterLevel: int
│   ├── GoldCost: int
│   ├── RequiredCurrentLevel: ArmorProficiencyLevel
│   ├── TrainerTypeRequired: string
│   ├── TrainingDurationHours: int
│   └── Description: string
├── ArmorTrainingResult Value Object
│   ├── Success: bool
│   ├── NewLevel: ArmorProficiencyLevel
│   ├── GoldSpent: int
│   ├── FailureReason: string?
│   └── TrainingMessage: string
├── IArmorProficiencyAcquisitionService Interface
│   ├── CanTrain(character, category, targetLevel): TrainingEligibility
│   ├── GetRequirements(targetLevel): ArmorTrainingRequirement
│   ├── Train(character, category, targetLevel): ArmorTrainingResult
│   ├── GetNextAvailableLevel(character, category): ArmorProficiencyLevel?
│   └── GetTrainingCost(targetLevel): int
└── ArmorProficiencyAcquisitionService
    ├── Dependencies: IArchetypeArmorProficiencyProvider
    ├── ValidatePrerequisites(): Check level, gold, current proficiency
    ├── ProcessTraining(): Deduct gold, update proficiency
    └── LoadRequirements(): From configuration
```

### 2.1 Training Requirements Matrix

| Target Level | Required Current | Min Char Level | Gold Cost | Trainer Type    |
| ------------ | ---------------- | -------------- | --------- | --------------- |
| Proficient   | NonProficient    | 1              | 100       | Armor Trainer   |
| Expert       | Proficient       | 5              | 500       | Master Armorer  |
| Master       | Expert           | 10             | 1000      | Legendary Smith |

### 2.2 Scope Alignment

**In Scope:**

- `ArmorTrainingRequirement` value object for training prerequisites
- `ArmorTrainingResult` value object for training outcomes
- `IArmorProficiencyAcquisitionService` interface
- `ArmorProficiencyAcquisitionService` implementation
- `armor-training-requirements.json` configuration
- Prerequisite validation (level, gold, current proficiency)
- Training cost deduction

**Out of Scope:**

- Combat integration (v0.16.2f)
- Actual trainer NPC implementation
- Training duration/time passage mechanics
- Specialized armor training (requires separate feats)

---

## 3. Architecture Diagrams

### 3.1 Proficiency Acquisition System Overview

```
┌─────────────────────────────────────────────────────────────────────┐
│              PROFICIENCY ACQUISITION SYSTEM OVERVIEW                 │
└─────────────────────────────────────────────────────────────────────┘

    Character Requests Training
           │
           │  Category + Target Level
           ▼
┌─────────────────────────────────────────────────────────────────────┐
│               IArmorProficiencyAcquisitionService                    │
├─────────────────────────────────────────────────────────────────────┤
│  + CanTrain(character, category, level): TrainingEligibility        │
│  + GetRequirements(level): ArmorTrainingRequirement                 │
│  + Train(character, category, level): ArmorTrainingResult           │
│  + GetNextAvailableLevel(character, category): Level?               │
│  + GetTrainingCost(level): int                                      │
└─────────────────────────────────────────────────────────────────────┘
           │
           │  Validation
           ▼
┌─────────────────────────────────────────────────────────────────────┐
│                  PREREQUISITE VALIDATION                             │
├─────────────────────────────────────────────────────────────────────┤
│  1. Current Proficiency Check                                        │
│     └── Must be at required level (e.g., Proficient for Expert)     │
│                                                                      │
│  2. Character Level Check                                            │
│     └── Must meet minimum level requirement                         │
│                                                                      │
│  3. Gold Check                                                       │
│     └── Must have sufficient gold for training cost                 │
│                                                                      │
│  4. Trainer Access Check (informational)                             │
│     └── Indicates required trainer type                             │
└─────────────────────────────────────────────────────────────────────┘
           │
           │  All checks pass?
           ▼
┌─────────────────────────────────────────────────────────────────────┐
│                      TRAINING RESULT                                 │
├─────────────────────────────────────────────────────────────────────┤
│  SUCCESS:                                                            │
│  ├── Deduct gold cost                                                │
│  ├── Update proficiency level                                        │
│  └── Return success message                                          │
│                                                                      │
│  FAILURE:                                                            │
│  ├── Identify specific failure reason                                │
│  └── Return helpful error message                                    │
└─────────────────────────────────────────────────────────────────────┘
```

### 3.2 Training Eligibility Decision Tree

```
┌─────────────────────────────────────────────────────────────────────┐
│               TRAINING ELIGIBILITY DECISION TREE                     │
└─────────────────────────────────────────────────────────────────────┘

    Character Requests Training for Category + Target Level
           │
           ▼
    ┌──────────────────────────────────────────────────────────────────┐
    │  IS TARGET LEVEL VALID?                                          │
    ├──────────────────────────────────────────────────────────────────┤
    │    Target == NonProficient? → INVALID (cannot train down)        │
    │    Target == Master + Already Master? → INVALID (already max)    │
    └──────────────────────────────────────────────────────────────────┘
           │ Valid
           ▼
    ┌──────────────────────────────────────────────────────────────────┐
    │  CHECK CURRENT PROFICIENCY                                       │
    ├──────────────────────────────────────────────────────────────────┤
    │    Get current level from character or archetype default         │
    │    Is current level == required prerequisite level?              │
    │                                                                  │
    │    Example: Training to Expert requires Proficient               │
    │    Current: NonProficient → FAIL: "Must be Proficient first"     │
    │    Current: Proficient → PASS                                    │
    └──────────────────────────────────────────────────────────────────┘
           │ Pass
           ▼
    ┌──────────────────────────────────────────────────────────────────┐
    │  CHECK CHARACTER LEVEL                                           │
    ├──────────────────────────────────────────────────────────────────┤
    │    Character.Level >= RequiredMinimumLevel?                      │
    │                                                                  │
    │    Example: Expert requires Level 5                              │
    │    Character Level 3 → FAIL: "Requires Level 5"                  │
    │    Character Level 5 → PASS                                      │
    └──────────────────────────────────────────────────────────────────┘
           │ Pass
           ▼
    ┌──────────────────────────────────────────────────────────────────┐
    │  CHECK GOLD                                                      │
    ├──────────────────────────────────────────────────────────────────┤
    │    Character.Gold >= TrainingCost?                               │
    │                                                                  │
    │    Example: Expert costs 500 gold                                │
    │    Character Gold: 300 → FAIL: "Insufficient gold (need 500)"    │
    │    Character Gold: 500 → PASS                                    │
    └──────────────────────────────────────────────────────────────────┘
           │ Pass
           ▼
    ┌──────────────────────────────────────────────────────────────────┐
    │  ELIGIBLE FOR TRAINING                                           │
    ├──────────────────────────────────────────────────────────────────┤
    │  Return TrainingEligibility {                                    │
    │    IsEligible: true                                              │
    │    Cost: 500                                                     │
    │    TrainerRequired: "Master Armorer"                             │
    │  }                                                               │
    └──────────────────────────────────────────────────────────────────┘
```

### 3.3 Proficiency Progression Flow

```
┌─────────────────────────────────────────────────────────────────────┐
│                 PROFICIENCY PROGRESSION FLOW                         │
└─────────────────────────────────────────────────────────────────────┘

    CHARACTER START
         │
         ▼
    ┌────────────────────────────────────────────────────────────────┐
    │  ARCHETYPE DETERMINES STARTING PROFICIENCY                     │
    ├────────────────────────────────────────────────────────────────┤
    │  Warrior + Heavy Armor → Starts Proficient                     │
    │  Mystic + Heavy Armor → Starts NonProficient                   │
    │  (From v0.16.2c archetype matrix)                              │
    └────────────────────────────────────────────────────────────────┘
         │
         ▼
┌─────────────────────────────────────────────────────────────────────┐
│                    PROGRESSION PATH                                  │
├─────────────────────────────────────────────────────────────────────┤
│                                                                      │
│  NonProficient ──────► Proficient ──────► Expert ──────► Master     │
│       │                    │                │              │        │
│       │                    │                │              │        │
│    (Start)             (Train)          (Train)        (Train)      │
│    No cost             100 gold         500 gold       1000 gold    │
│    Level 0             Level 1          Level 5        Level 10     │
│                                                                      │
├─────────────────────────────────────────────────────────────────────┤
│  NOTES:                                                              │
│  - Can only train one level at a time                               │
│  - NonProficient characters can train to Proficient                 │
│  - Specialized armor requires feat, not just training               │
└─────────────────────────────────────────────────────────────────────┘
```

### 3.4 Layer Diagram

```
┌─────────────────────────────────────────────────────────────────────┐
│                        PRESENTATION LAYER                            │
├─────────────────────────────────────────────────────────────────────┤
│  TrainerNPCDialog                                                    │
│  └── Shows available training options                               │
│  └── Displays costs and requirements                                │
│  └── Confirms training purchase                                     │
│                                                                      │
│  CharacterSheet                                                      │
│  └── Shows current proficiency levels per category                  │
│  └── Indicates upgradeable proficiencies                            │
└───────┬─────────────────────────────────────────────────────────────┘
        │
        ▼
┌─────────────────────────────────────────────────────────────────────┐
│                       APPLICATION LAYER                              │
├─────────────────────────────────────────────────────────────────────┤
│  ┌───────────────────────────────────────────────────────────────┐  │
│  │          ArmorProficiencyAcquisitionService                    │  │
│  │     (implements IArmorProficiencyAcquisitionService)           │  │
│  ├───────────────────────────────────────────────────────────────┤  │
│  │  Dependencies:                                                │  │
│  │  - IArchetypeArmorProficiencyProvider (v0.16.2c)              │  │
│  │  - IArmorCategoryProvider (v0.16.2b)                          │  │
│  │                                                               │  │
│  │  + CanTrain(character, category, targetLevel)                 │  │
│  │  + GetRequirements(targetLevel)                               │  │
│  │  + Train(character, category, targetLevel)                    │  │
│  │  + GetNextAvailableLevel(character, category)                 │  │
│  │  + GetTrainingCost(targetLevel)                               │  │
│  │                                                               │  │
│  │  - ValidatePrerequisites(character, requirement)              │  │
│  │  - LoadRequirements() (from JSON config)                      │  │
│  │  - _requirements: Dictionary<Level, Requirement>              │  │
│  └───────────────────────────────────────────────────────────────┘  │
└───────┬─────────────────────────────────────────────────────────────┘
        │
        ▼
┌─────────────────────────────────────────────────────────────────────┐
│                         DOMAIN LAYER                                 │
├─────────────────────────────────────────────────────────────────────┤
│  ┌─────────────────────────────┐  ┌─────────────────────────────┐   │
│  │   ArmorTrainingRequirement  │  │    ArmorTrainingResult      │   │
│  │       (Value Object)        │  │      (Value Object)         │   │
│  ├─────────────────────────────┤  ├─────────────────────────────┤   │
│  │ TargetLevel: Level          │  │ Success: bool               │   │
│  │ MinimumCharacterLevel: int  │  │ NewLevel: Level?            │   │
│  │ GoldCost: int               │  │ GoldSpent: int              │   │
│  │ RequiredCurrentLevel: Level │  │ FailureReason: string?      │   │
│  │ TrainerTypeRequired: string │  │ TrainingMessage: string     │   │
│  │ Description: string         │  └─────────────────────────────┘   │
│  └─────────────────────────────┘                                     │
│                                                                      │
│  ┌─────────────────────────────┐                                     │
│  │    TrainingEligibility      │                                     │
│  │      (Value Object)         │                                     │
│  ├─────────────────────────────┤                                     │
│  │ IsEligible: bool            │                                     │
│  │ FailureReasons: List        │                                     │
│  │ Cost: int                   │                                     │
│  │ TrainerRequired: string     │                                     │
│  └─────────────────────────────┘                                     │
└─────────────────────────────────────────────────────────────────────┘
```

---

## 4. ArmorTrainingRequirement Value Object

### 4.1 Purpose

The `ArmorTrainingRequirement` value object defines the prerequisites and costs for training to a specific proficiency level.

### 4.2 Implementation

**File:** `src/Core/RuneAndRust.Domain/ValueObjects/ArmorTrainingRequirement.cs`

```csharp
namespace RuneAndRust.Domain.ValueObjects;

using RuneAndRust.Domain.Enums;

/// <summary>
/// Defines requirements for training to a proficiency level.
/// </summary>
/// <remarks>
/// <para>
/// ArmorTrainingRequirement specifies the prerequisites (current level,
/// character level) and costs (gold) for acquiring a proficiency level.
/// </para>
/// <para>
/// Requirements are loaded from configuration, allowing balance adjustments
/// without code changes.
/// </para>
/// </remarks>
/// <param name="TargetLevel">The proficiency level this training provides.</param>
/// <param name="RequiredCurrentLevel">The proficiency level required to begin training.</param>
/// <param name="MinimumCharacterLevel">The minimum character level required.</param>
/// <param name="GoldCost">The gold cost for training.</param>
/// <param name="TrainerTypeRequired">The type of trainer NPC required.</param>
/// <param name="TrainingDurationHours">Flavor: training duration in game hours.</param>
/// <param name="Description">Flavor text describing the training.</param>
public readonly record struct ArmorTrainingRequirement(
    ArmorProficiencyLevel TargetLevel,
    ArmorProficiencyLevel RequiredCurrentLevel,
    int MinimumCharacterLevel,
    int GoldCost,
    string TrainerTypeRequired,
    int TrainingDurationHours,
    string Description)
{
    /// <summary>
    /// Gets whether this is training to the maximum level.
    /// </summary>
    public bool IsMasteryTraining => TargetLevel == ArmorProficiencyLevel.Master;

    /// <summary>
    /// Gets whether this is basic proficiency training.
    /// </summary>
    public bool IsBasicTraining => TargetLevel == ArmorProficiencyLevel.Proficient;

    /// <summary>
    /// Gets whether this is advanced training (Expert or Master).
    /// </summary>
    public bool IsAdvancedTraining =>
        TargetLevel is ArmorProficiencyLevel.Expert or ArmorProficiencyLevel.Master;

    /// <summary>
    /// Creates ArmorTrainingRequirement with validation.
    /// </summary>
    public static ArmorTrainingRequirement Create(
        ArmorProficiencyLevel targetLevel,
        ArmorProficiencyLevel requiredCurrentLevel,
        int minimumCharacterLevel,
        int goldCost,
        string trainerTypeRequired,
        int trainingDurationHours,
        string description)
    {
        if (targetLevel == ArmorProficiencyLevel.NonProficient)
            throw new ArgumentException("Cannot train to NonProficient level", nameof(targetLevel));

        ArgumentOutOfRangeException.ThrowIfLessThan(minimumCharacterLevel, 1);
        ArgumentOutOfRangeException.ThrowIfNegative(goldCost);
        ArgumentException.ThrowIfNullOrWhiteSpace(trainerTypeRequired);
        ArgumentException.ThrowIfNullOrWhiteSpace(description);
        ArgumentOutOfRangeException.ThrowIfNegative(trainingDurationHours);

        return new ArmorTrainingRequirement(
            targetLevel,
            requiredCurrentLevel,
            minimumCharacterLevel,
            goldCost,
            trainerTypeRequired,
            trainingDurationHours,
            description);
    }

    /// <summary>
    /// Formats the gold cost for display.
    /// </summary>
    public string FormatCost() => $"{GoldCost:N0} gold";

    /// <summary>
    /// Formats the level requirement for display.
    /// </summary>
    public string FormatLevelReq() => $"Level {MinimumCharacterLevel}+";

    /// <summary>
    /// Creates a display string for debug/logging.
    /// </summary>
    public override string ToString() =>
        $"Train to {TargetLevel}: {FormatCost()}, {FormatLevelReq()}, " +
        $"requires {RequiredCurrentLevel}";
}
```

---

## 5. ArmorTrainingResult Value Object

### 5.1 Purpose

The `ArmorTrainingResult` value object represents the outcome of a training attempt.

### 5.2 Implementation

**File:** `src/Core/RuneAndRust.Domain/ValueObjects/ArmorTrainingResult.cs`

```csharp
namespace RuneAndRust.Domain.ValueObjects;

using RuneAndRust.Domain.Enums;

/// <summary>
/// Represents the result of a training attempt.
/// </summary>
/// <remarks>
/// <para>
/// ArmorTrainingResult captures whether training succeeded, the new
/// proficiency level, gold spent, and any failure reason.
/// </para>
/// </remarks>
/// <param name="Success">Whether training completed successfully.</param>
/// <param name="NewLevel">The new proficiency level if successful.</param>
/// <param name="PreviousLevel">The level before training.</param>
/// <param name="GoldSpent">The gold deducted (0 if failed).</param>
/// <param name="FailureReason">The reason for failure, if any.</param>
/// <param name="TrainingMessage">Descriptive message for UI.</param>
public readonly record struct ArmorTrainingResult(
    bool Success,
    ArmorProficiencyLevel? NewLevel,
    ArmorProficiencyLevel PreviousLevel,
    int GoldSpent,
    string? FailureReason,
    string TrainingMessage)
{
    /// <summary>
    /// Gets whether this was a failed attempt.
    /// </summary>
    public bool Failed => !Success;

    /// <summary>
    /// Gets whether gold was spent.
    /// </summary>
    public bool GoldWasSpent => GoldSpent > 0;

    /// <summary>
    /// Gets whether the character reached mastery.
    /// </summary>
    public bool AchievedMastery => Success && NewLevel == ArmorProficiencyLevel.Master;

    /// <summary>
    /// Creates a successful training result.
    /// </summary>
    public static ArmorTrainingResult Succeeded(
        ArmorProficiencyLevel newLevel,
        ArmorProficiencyLevel previousLevel,
        int goldSpent,
        string message)
    {
        return new ArmorTrainingResult(
            true,
            newLevel,
            previousLevel,
            goldSpent,
            null,
            message);
    }

    /// <summary>
    /// Creates a failed training result.
    /// </summary>
    public static ArmorTrainingResult Failed(
        ArmorProficiencyLevel currentLevel,
        string failureReason)
    {
        return new ArmorTrainingResult(
            false,
            null,
            currentLevel,
            0,
            failureReason,
            $"Training failed: {failureReason}");
    }

    /// <summary>
    /// Formats the level change for display.
    /// </summary>
    public string FormatLevelChange() =>
        Success && NewLevel.HasValue
            ? $"{PreviousLevel} → {NewLevel.Value}"
            : "No change";

    /// <summary>
    /// Creates a display string for debug/logging.
    /// </summary>
    public override string ToString() =>
        Success
            ? $"Training succeeded: {FormatLevelChange()}, spent {GoldSpent} gold"
            : $"Training failed: {FailureReason}";
}
```

---

## 6. IArmorProficiencyAcquisitionService Interface

### 6.1 Purpose

The `IArmorProficiencyAcquisitionService` interface defines the contract for training and acquiring armor proficiencies.

### 6.2 Implementation

**File:** `src/Core/RuneAndRust.Application/Interfaces/IArmorProficiencyAcquisitionService.cs`

```csharp
namespace RuneAndRust.Application.Interfaces;

using RuneAndRust.Domain.Entities;
using RuneAndRust.Domain.Enums;
using RuneAndRust.Domain.ValueObjects;

/// <summary>
/// Handles armor proficiency training and acquisition.
/// </summary>
/// <remarks>
/// <para>
/// This service validates training prerequisites, calculates costs,
/// and processes proficiency level upgrades.
/// </para>
/// </remarks>
public interface IArmorProficiencyAcquisitionService
{
    /// <summary>
    /// Checks if a character can train to a target proficiency level.
    /// </summary>
    /// <param name="character">The character attempting training.</param>
    /// <param name="category">The armor category to train.</param>
    /// <param name="targetLevel">The target proficiency level.</param>
    /// <returns>Eligibility status with reasons if ineligible.</returns>
    TrainingEligibility CanTrain(
        Player character,
        ArmorCategory category,
        ArmorProficiencyLevel targetLevel);

    /// <summary>
    /// Gets the requirements for training to a specific level.
    /// </summary>
    /// <param name="targetLevel">The target proficiency level.</param>
    /// <returns>The training requirements.</returns>
    ArmorTrainingRequirement GetRequirements(ArmorProficiencyLevel targetLevel);

    /// <summary>
    /// Attempts to train a character to a new proficiency level.
    /// </summary>
    /// <param name="character">The character to train.</param>
    /// <param name="category">The armor category to train.</param>
    /// <param name="targetLevel">The target proficiency level.</param>
    /// <returns>The training result.</returns>
    ArmorTrainingResult Train(
        Player character,
        ArmorCategory category,
        ArmorProficiencyLevel targetLevel);

    /// <summary>
    /// Gets the next available training level for a character + category.
    /// </summary>
    /// <param name="character">The character.</param>
    /// <param name="category">The armor category.</param>
    /// <returns>The next trainable level, or null if maxed.</returns>
    ArmorProficiencyLevel? GetNextAvailableLevel(
        Player character,
        ArmorCategory category);

    /// <summary>
    /// Gets the gold cost for training to a level.
    /// </summary>
    /// <param name="targetLevel">The target level.</param>
    /// <returns>The gold cost.</returns>
    int GetTrainingCost(ArmorProficiencyLevel targetLevel);

    /// <summary>
    /// Gets all training requirements.
    /// </summary>
    IReadOnlyList<ArmorTrainingRequirement> GetAllRequirements();

    /// <summary>
    /// Gets the character's current proficiency level for a category.
    /// </summary>
    ArmorProficiencyLevel GetCurrentLevel(Player character, ArmorCategory category);
}
```

### 6.3 TrainingEligibility Value Object

**File:** `src/Core/RuneAndRust.Domain/ValueObjects/TrainingEligibility.cs`

```csharp
namespace RuneAndRust.Domain.ValueObjects;

/// <summary>
/// Represents whether a character is eligible for training.
/// </summary>
public readonly record struct TrainingEligibility(
    bool IsEligible,
    IReadOnlyList<string> FailureReasons,
    int Cost,
    string TrainerRequired)
{
    /// <summary>
    /// Gets a single failure reason (first in list).
    /// </summary>
    public string? PrimaryFailureReason =>
        FailureReasons.Count > 0 ? FailureReasons[0] : null;

    /// <summary>
    /// Gets whether there are multiple failure reasons.
    /// </summary>
    public bool HasMultipleIssues => FailureReasons.Count > 1;

    /// <summary>
    /// Creates an eligible result.
    /// </summary>
    public static TrainingEligibility Eligible(int cost, string trainerRequired) =>
        new(true, Array.Empty<string>(), cost, trainerRequired);

    /// <summary>
    /// Creates an ineligible result.
    /// </summary>
    public static TrainingEligibility Ineligible(IReadOnlyList<string> reasons) =>
        new(false, reasons, 0, string.Empty);

    /// <summary>
    /// Creates an ineligible result with single reason.
    /// </summary>
    public static TrainingEligibility Ineligible(string reason) =>
        new(false, new[] { reason }, 0, string.Empty);

    /// <summary>
    /// Formats all failure reasons for display.
    /// </summary>
    public string FormatFailureReasons() =>
        string.Join("; ", FailureReasons);
}
```

---

## 7. ArmorProficiencyAcquisitionService Implementation

### 7.1 Implementation

**File:** `src/Core/RuneAndRust.Application/Services/ArmorProficiencyAcquisitionService.cs`

```csharp
namespace RuneAndRust.Application.Services;

using Microsoft.Extensions.Logging;
using RuneAndRust.Application.Interfaces;
using RuneAndRust.Domain.Entities;
using RuneAndRust.Domain.Enums;
using RuneAndRust.Domain.ValueObjects;

/// <summary>
/// Handles armor proficiency training and acquisition.
/// </summary>
public class ArmorProficiencyAcquisitionService : IArmorProficiencyAcquisitionService
{
    private readonly IArchetypeArmorProficiencyProvider _archetypeProvider;
    private readonly Dictionary<ArmorProficiencyLevel, ArmorTrainingRequirement> _requirements;
    private readonly ILogger<ArmorProficiencyAcquisitionService> _logger;

    /// <summary>
    /// Initializes a new instance of the service.
    /// </summary>
    public ArmorProficiencyAcquisitionService(
        IArchetypeArmorProficiencyProvider archetypeProvider,
        ILogger<ArmorProficiencyAcquisitionService> logger)
    {
        _archetypeProvider = archetypeProvider ?? throw new ArgumentNullException(nameof(archetypeProvider));
        _logger = logger ?? throw new ArgumentNullException(nameof(logger));
        _requirements = LoadRequirements();
    }

    /// <inheritdoc />
    public TrainingEligibility CanTrain(
        Player character,
        ArmorCategory category,
        ArmorProficiencyLevel targetLevel)
    {
        ArgumentNullException.ThrowIfNull(character);

        var failures = new List<string>();

        // Check if target is trainable
        if (targetLevel == ArmorProficiencyLevel.NonProficient)
        {
            return TrainingEligibility.Ineligible("Cannot train to NonProficient");
        }

        // Get requirements
        if (!_requirements.TryGetValue(targetLevel, out var requirement))
        {
            return TrainingEligibility.Ineligible($"No training available for {targetLevel}");
        }

        // Check current proficiency
        var currentLevel = GetCurrentLevel(character, category);
        if (currentLevel != requirement.RequiredCurrentLevel)
        {
            failures.Add($"Requires {requirement.RequiredCurrentLevel} proficiency " +
                        $"(current: {currentLevel})");
        }

        // Check character level
        if (character.Level < requirement.MinimumCharacterLevel)
        {
            failures.Add($"Requires level {requirement.MinimumCharacterLevel} " +
                        $"(current: {character.Level})");
        }

        // Check gold
        if (character.Gold < requirement.GoldCost)
        {
            failures.Add($"Requires {requirement.GoldCost} gold " +
                        $"(current: {character.Gold})");
        }

        if (failures.Count > 0)
        {
            _logger.LogDebug(
                "Training ineligible for {Character} to {Level}: {Reasons}",
                character.Name, targetLevel, string.Join(", ", failures));

            return TrainingEligibility.Ineligible(failures);
        }

        _logger.LogDebug(
            "Training eligible for {Character} to {Level}, cost: {Cost}",
            character.Name, targetLevel, requirement.GoldCost);

        return TrainingEligibility.Eligible(
            requirement.GoldCost,
            requirement.TrainerTypeRequired);
    }

    /// <inheritdoc />
    public ArmorTrainingResult Train(
        Player character,
        ArmorCategory category,
        ArmorProficiencyLevel targetLevel)
    {
        ArgumentNullException.ThrowIfNull(character);

        var eligibility = CanTrain(character, category, targetLevel);
        if (!eligibility.IsEligible)
        {
            _logger.LogWarning(
                "Training attempt failed for {Character}: {Reason}",
                character.Name, eligibility.PrimaryFailureReason);

            return ArmorTrainingResult.Failed(
                GetCurrentLevel(character, category),
                eligibility.PrimaryFailureReason!);
        }

        var requirement = _requirements[targetLevel];
        var previousLevel = GetCurrentLevel(character, category);

        // Deduct gold
        character.SpendGold(requirement.GoldCost);

        // Update proficiency (character entity method)
        character.SetArmorProficiency(category, targetLevel);

        _logger.LogInformation(
            "Character {Character} trained {Category} proficiency: {Previous} → {New}, spent {Gold} gold",
            character.Name, category, previousLevel, targetLevel, requirement.GoldCost);

        var message = targetLevel == ArmorProficiencyLevel.Master
            ? $"You have achieved mastery in {category} armor!"
            : $"You are now {targetLevel} with {category} armor.";

        return ArmorTrainingResult.Succeeded(
            targetLevel,
            previousLevel,
            requirement.GoldCost,
            message);
    }

    /// <inheritdoc />
    public ArmorProficiencyLevel? GetNextAvailableLevel(
        Player character,
        ArmorCategory category)
    {
        var currentLevel = GetCurrentLevel(character, category);

        return currentLevel switch
        {
            ArmorProficiencyLevel.NonProficient => ArmorProficiencyLevel.Proficient,
            ArmorProficiencyLevel.Proficient => ArmorProficiencyLevel.Expert,
            ArmorProficiencyLevel.Expert => ArmorProficiencyLevel.Master,
            ArmorProficiencyLevel.Master => null, // Already maxed
            _ => null
        };
    }

    /// <inheritdoc />
    public ArmorTrainingRequirement GetRequirements(ArmorProficiencyLevel targetLevel) =>
        _requirements.TryGetValue(targetLevel, out var req)
            ? req
            : throw new ArgumentException($"No requirements for {targetLevel}");

    /// <inheritdoc />
    public int GetTrainingCost(ArmorProficiencyLevel targetLevel) =>
        _requirements.TryGetValue(targetLevel, out var req)
            ? req.GoldCost
            : 0;

    /// <inheritdoc />
    public IReadOnlyList<ArmorTrainingRequirement> GetAllRequirements() =>
        _requirements.Values.ToList();

    /// <inheritdoc />
    public ArmorProficiencyLevel GetCurrentLevel(Player character, ArmorCategory category)
    {
        // Check if character has trained proficiency
        if (character.ArmorProficiencies.TryGetValue(category, out var trainedLevel))
        {
            return trainedLevel;
        }

        // Fall back to archetype default
        return _archetypeProvider.GetStartingProficiency(
            character.ArchetypeId,
            category);
    }

    private Dictionary<ArmorProficiencyLevel, ArmorTrainingRequirement> LoadRequirements()
    {
        // In real implementation, load from JSON configuration
        return new Dictionary<ArmorProficiencyLevel, ArmorTrainingRequirement>
        {
            [ArmorProficiencyLevel.Proficient] = ArmorTrainingRequirement.Create(
                ArmorProficiencyLevel.Proficient,
                ArmorProficiencyLevel.NonProficient,
                1, 100, "Armor Trainer", 2,
                "Learn the basics of wearing this armor type effectively."),

            [ArmorProficiencyLevel.Expert] = ArmorTrainingRequirement.Create(
                ArmorProficiencyLevel.Expert,
                ArmorProficiencyLevel.Proficient,
                5, 500, "Master Armorer", 8,
                "Advanced training to move naturally in bulky armor."),

            [ArmorProficiencyLevel.Master] = ArmorTrainingRequirement.Create(
                ArmorProficiencyLevel.Master,
                ArmorProficiencyLevel.Expert,
                10, 1000, "Legendary Smith", 24,
                "Achieve complete mastery, turning heavy armor into a second skin.")
        };
    }
}
```

---

## 8. Configuration File Schemas

### 8.1 armor-training-requirements.json

**File:** `config/armor-training-requirements.json`

```json
{
    "$schema": "./schemas/armor-training-requirements.schema.json",
    "requirements": [
        {
            "targetLevel": "Proficient",
            "requiredCurrentLevel": "NonProficient",
            "minimumCharacterLevel": 1,
            "goldCost": 100,
            "trainerTypeRequired": "Armor Trainer",
            "trainingDurationHours": 2,
            "description": "Learn the basics of wearing this armor type effectively."
        },
        {
            "targetLevel": "Expert",
            "requiredCurrentLevel": "Proficient",
            "minimumCharacterLevel": 5,
            "goldCost": 500,
            "trainerTypeRequired": "Master Armorer",
            "trainingDurationHours": 8,
            "description": "Advanced training to move naturally in bulky armor."
        },
        {
            "targetLevel": "Master",
            "requiredCurrentLevel": "Expert",
            "minimumCharacterLevel": 10,
            "goldCost": 1000,
            "trainerTypeRequired": "Legendary Smith",
            "trainingDurationHours": 24,
            "description": "Achieve complete mastery, turning heavy armor into a second skin."
        }
    ]
}
```

### 8.2 armor-training-requirements.schema.json

**File:** `config/schemas/armor-training-requirements.schema.json`

```json
{
    "$schema": "http://json-schema.org/draft-07/schema#",
    "$id": "armor-training-requirements.schema.json",
    "title": "Armor Training Requirements Configuration",
    "description": "Defines requirements for armor proficiency training",
    "type": "object",
    "required": ["requirements"],
    "properties": {
        "$schema": { "type": "string" },
        "requirements": {
            "type": "array",
            "minItems": 3,
            "maxItems": 3,
            "items": { "$ref": "#/$defs/requirement" }
        }
    },
    "$defs": {
        "requirement": {
            "type": "object",
            "required": [
                "targetLevel",
                "requiredCurrentLevel",
                "minimumCharacterLevel",
                "goldCost",
                "trainerTypeRequired",
                "trainingDurationHours",
                "description"
            ],
            "properties": {
                "targetLevel": {
                    "type": "string",
                    "enum": ["Proficient", "Expert", "Master"]
                },
                "requiredCurrentLevel": {
                    "type": "string",
                    "enum": ["NonProficient", "Proficient", "Expert"]
                },
                "minimumCharacterLevel": {
                    "type": "integer",
                    "minimum": 1,
                    "maximum": 50
                },
                "goldCost": {
                    "type": "integer",
                    "minimum": 0,
                    "maximum": 100000
                },
                "trainerTypeRequired": {
                    "type": "string",
                    "minLength": 1,
                    "maxLength": 50
                },
                "trainingDurationHours": {
                    "type": "integer",
                    "minimum": 0,
                    "maximum": 168
                },
                "description": {
                    "type": "string",
                    "minLength": 10,
                    "maxLength": 300
                }
            }
        }
    }
}
```

---

## 9. Data Model Changes

### 9.1 New Types Summary

| Type                                  | Layer       | Category     | Description                  |
| ------------------------------------- | ----------- | ------------ | ---------------------------- |
| `ArmorTrainingRequirement`            | Domain      | Value Object | Training prerequisites/costs |
| `ArmorTrainingResult`                 | Domain      | Value Object | Training outcome             |
| `TrainingEligibility`                 | Domain      | Value Object | Eligibility check result     |
| `IArmorProficiencyAcquisitionService` | Application | Interface    | Training service contract    |
| `ArmorProficiencyAcquisitionService`  | Application | Service      | Training implementation      |

### 9.2 File Locations

```
src/Core/RuneAndRust.Domain/
└── ValueObjects/
    ├── ArmorTrainingRequirement.cs       ← NEW
    ├── ArmorTrainingResult.cs            ← NEW
    └── TrainingEligibility.cs            ← NEW

src/Core/RuneAndRust.Application/
├── Interfaces/
│   └── IArmorProficiencyAcquisitionService.cs  ← NEW
└── Services/
    └── ArmorProficiencyAcquisitionService.cs   ← NEW

config/
├── armor-training-requirements.json            ← NEW
└── schemas/
    └── armor-training-requirements.schema.json ← NEW
```

---

## 10. Logging Specifications

### 10.1 Log Levels by Component

| Component                            | Level       | Events                      |
| ------------------------------------ | ----------- | --------------------------- |
| `ArmorProficiencyAcquisitionService` | Information | Training completed          |
| `ArmorProficiencyAcquisitionService` | Debug       | Eligibility check performed |
| `ArmorProficiencyAcquisitionService` | Warning     | Training attempt failed     |

### 10.2 Log Message Templates

```csharp
// Information - Training succeeded
_logger.LogInformation(
    "Character {Character} trained {Category}: {Previous} → {New}, spent {Gold} gold",
    character.Name, category, previousLevel, targetLevel, requirement.GoldCost);

// Debug - Eligibility check
_logger.LogDebug(
    "Training eligible for {Character} to {Level}, cost: {Cost}",
    character.Name, targetLevel, requirement.GoldCost);

// Warning - Training failed
_logger.LogWarning(
    "Training attempt failed for {Character}: {Reason}",
    character.Name, eligibility.PrimaryFailureReason);
```

---

## 11. Unit Testing Requirements

### 11.1 Test Count by Feature

| Feature                  | Test Count |
| ------------------------ | ---------- |
| ArmorTrainingRequirement | ~1         |
| Training Eligibility     | ~1         |
| Training Execution       | ~1         |
| **Total**                | **~3**     |

### 11.2 Test Specifications

**File:** `tests/RuneAndRust.Application.UnitTests/Services/ArmorProficiencyAcquisitionServiceTests.cs`

```csharp
[TestFixture]
public class ArmorProficiencyAcquisitionServiceTests
{
    [Test]
    public void CanTrain_WithSufficientResources_ReturnsEligible()
    {
        // Arrange
        var character = CreateTestCharacter(level: 5, gold: 600);
        var service = CreateService();

        // Act
        var result = service.CanTrain(
            character,
            ArmorCategory.Heavy,
            ArmorProficiencyLevel.Expert);

        // Assert
        result.IsEligible.Should().BeTrue();
        result.Cost.Should().Be(500);
    }

    [Test]
    public void CanTrain_WithInsufficientGold_ReturnsIneligible()
    {
        // Arrange
        var character = CreateTestCharacter(level: 5, gold: 100);
        var service = CreateService();

        // Act
        var result = service.CanTrain(
            character,
            ArmorCategory.Heavy,
            ArmorProficiencyLevel.Expert);

        // Assert
        result.IsEligible.Should().BeFalse();
        result.FailureReasons.Should().Contain(r => r.Contains("gold"));
    }

    [Test]
    public void Train_WithValidRequest_DeductsGoldAndUpgradesLevel()
    {
        // Arrange
        var character = CreateTestCharacter(level: 5, gold: 600);
        character.SetArmorProficiency(ArmorCategory.Heavy, ArmorProficiencyLevel.Proficient);
        var service = CreateService();

        // Act
        var result = service.Train(
            character,
            ArmorCategory.Heavy,
            ArmorProficiencyLevel.Expert);

        // Assert
        result.Success.Should().BeTrue();
        result.NewLevel.Should().Be(ArmorProficiencyLevel.Expert);
        result.GoldSpent.Should().Be(500);
        character.Gold.Should().Be(100);
    }

    private Player CreateTestCharacter(int level, int gold) { /* ... */ }
    private ArmorProficiencyAcquisitionService CreateService() { /* ... */ }
}
```

---

## 12. Use Cases

### UC-001: Check Training Eligibility

**Actor:** Player  
**Flow:** Player visits trainer → System checks eligibility → UI shows available trainings

### UC-002: Train to Proficient

**Actor:** Player (NonProficient)  
**Flow:** Player selects training → System validates → Gold deducted → Level upgraded

### UC-003: View Training Progress

**Actor:** Player  
**Flow:** Player opens character sheet → System shows current/next levels → UI displays costs

---

## 13. Deliverable Checklist

### Domain Layer

- [ ] `ArmorTrainingRequirement` value object created
- [ ] `ArmorTrainingResult` value object created
- [ ] `TrainingEligibility` value object created

### Application Layer

- [ ] `IArmorProficiencyAcquisitionService` interface created
- [ ] `ArmorProficiencyAcquisitionService` service created

### Configuration Files

- [ ] `config/armor-training-requirements.json` created
- [ ] `config/schemas/armor-training-requirements.schema.json` created

### Testing

- [ ] ~3 unit tests implemented
- [ ] All tests passing

---

## 14. Acceptance Criteria

### Functional

- [ ] Proficient training costs 100 gold, requires Level 1
- [ ] Expert training costs 500 gold, requires Level 5
- [ ] Master training costs 1000 gold, requires Level 10
- [ ] Training requires correct current proficiency level
- [ ] Gold is deducted on successful training
- [ ] Failed training does not deduct gold
- [ ] Cannot train to NonProficient

### Quality

- [ ] Build succeeds with 0 errors/warnings
- [ ] All ~3 tests pass
- [ ] XML documentation complete

---

## 15. Dependencies

### 15.1 Required from Previous Phases

| Type                                 | Source   | Usage                      |
| ------------------------------------ | -------- | -------------------------- |
| `ArmorProficiencyLevel`              | v0.16.2a | Target/current level       |
| `ArmorCategory`                      | v0.16.2b | Category being trained     |
| `IArchetypeArmorProficiencyProvider` | v0.16.2c | Default proficiency lookup |

### 15.2 Provides to Future Phases

| Type                                  | Usage                              |
| ------------------------------------- | ---------------------------------- |
| `IArmorProficiencyAcquisitionService` | v0.16.2f: Training during gameplay |
| `ArmorTrainingResult`                 | v0.16.2f: UI feedback              |

---

## 16. Future Considerations

### 16.1 Deferred to v0.16.2f

- **Combat Integration**: Using trained proficiencies in combat

### 16.2 Out of Scope

- **Trainer NPC Implementation**: Actual trainer interactions
- **Training Time Passage**: Real-time training duration
- **Feat-based Proficiency**: Gaining proficiency through feats

---

_Document Version: 1.0_  
_Last Updated: 2026-01-27_  
_Author: Assistant_
