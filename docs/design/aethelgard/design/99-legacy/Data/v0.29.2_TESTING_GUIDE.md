# v0.29.2 Testing & Validation Guide
## Environmental Hazards & Ambient Conditions

### Prerequisites
- v0.29.1 completed (Database Schema & Room Templates)
- .NET SDK installed
- Access to runeandrust.db database

### Changes Summary

**New Classes:**
1. `IntenseHeatCondition.cs` - [Intense Heat] ambient condition class
2. `IntenseHeatService.cs` - Service for processing heat checks

**Enum Updates:**
1. `AmbientConditionType` - Added IntenseHeat
2. `DynamicHazardType` - Added 8 Muspelheim hazard types

**Database Seeding:**
- 8 environmental hazards added to `Biome_EnvironmentalFeatures` table

### Database Validation

#### Test 1: Verify all 8 hazards inserted
```sql
SELECT COUNT(*) as hazard_count
FROM Biome_EnvironmentalFeatures
WHERE biome_id = 4;
```
**Expected:** hazard_count = 8

#### Test 2: View hazard details
```sql
SELECT
    feature_name,
    feature_type,
    hazard_density_category,
    damage_per_turn,
    damage_type,
    tile_coverage_percent,
    special_rules
FROM Biome_EnvironmentalFeatures
WHERE biome_id = 4
ORDER BY hazard_density_category, feature_name;
```
**Expected:** 8 rows with varying properties

#### Test 3: Check hazard type distribution
```sql
SELECT
    feature_type,
    COUNT(*) as count
FROM Biome_EnvironmentalFeatures
WHERE biome_id = 4
GROUP BY feature_type;
```
**Expected:**
- Terrain: 3 ([Burning Ground], [Scorched Metal Plating], [Molten Slag Pool])
- Obstacle: 1 ([Chasm/Lava River])
- Dynamic: 2 ([High-Pressure Steam Vent], [Collapsing Catwalk])
- Explosive: 1 ([Volatile Gas Pocket])
- Vision: 1 ([Thermal Mirage])

#### Test 4: Verify instant death hazard
```sql
SELECT
    feature_name,
    damage_per_turn,
    special_rules
FROM Biome_EnvironmentalFeatures
WHERE biome_id = 4
  AND damage_per_turn = 999;
```
**Expected:** 2 rows ([Chasm/Lava River], [Collapsing Catwalk])

#### Test 5: Check damage type distribution
```sql
SELECT
    damage_type,
    COUNT(*) as count
FROM Biome_EnvironmentalFeatures
WHERE biome_id = 4
GROUP BY damage_type;
```
**Expected:**
- Fire: 6 hazards
- Physical: 1 hazard
- NULL: 2 hazards (no damage types)

### Code Integration Testing

#### Test 6: IntenseHeatCondition instantiation
```csharp
var condition = new IntenseHeatCondition();

Assert.AreEqual("[Intense Heat]", condition.ConditionName);
Assert.AreEqual(AmbientConditionType.IntenseHeat, condition.Type);
Assert.AreEqual(12, condition.ResolveCheckDC);
Assert.AreEqual("STURDINESS", condition.ResolveCheckAttribute);
Assert.AreEqual(2, condition.DamageDiceCount);
Assert.AreEqual(6, condition.DamageDieSize);
Assert.AreEqual("Fire", condition.DamageType);
Assert.IsFalse(condition.IsRemovable);
Assert.IsTrue(condition.CanBeResisted);
```

#### Test 7: IntenseHeatService STURDINESS check (success)
```csharp
var mockDiceService = new Mock<DiceService>();
var mockResolveService = new Mock<ResolveCheckService>();
var mockTraumaService = new Mock<TraumaEconomyService>();

var service = new IntenseHeatService(
    mockDiceService.Object,
    mockResolveService.Object,
    mockTraumaService.Object
);

var character = CreateTestCharacter(sturdiness: 4);
var room = CreateRoomWithIntenseHeat();

// Mock successful STURDINESS check (4 dice → 3 successes)
mockDiceService
    .Setup(d => d.Roll(4))
    .Returns(new DiceResult { Successes = 3, Rolls = new[] { 4, 5, 6, 2 } });

var results = service.ProcessEndOfTurnHeat(new List<PlayerCharacter> { character }, room);

Assert.AreEqual(1, results.Count);
Assert.AreEqual(0, results[0].DamageDealt); // No damage on success
```

#### Test 8: IntenseHeatService STURDINESS check (failure)
```csharp
var character = CreateTestCharacter(sturdiness: 2);
var room = CreateRoomWithIntenseHeat();

// Mock failed STURDINESS check (2 dice → 1 success)
mockDiceService
    .Setup(d => d.Roll(2))
    .Returns(new DiceResult { Successes = 1, Rolls = new[] { 2, 3 } });

// Mock 2d6 damage roll (7 damage)
mockDiceService
    .Setup(d => d.RollDamage(2, 6))
    .Returns(7);

var results = service.ProcessEndOfTurnHeat(new List<PlayerCharacter> { character }, room);

Assert.AreEqual(1, results.Count);
Assert.AreEqual(7, results[0].DamageDealt); // Full damage (no resistance)
```

#### Test 9: Fire Resistance application
```csharp
var service = new IntenseHeatService(diceService, resolveService, traumaService);
var character = CreateTestCharacter();

// Test 0% resistance
int damage1 = service.ApplyFireResistance(character, 10);
Assert.AreEqual(10, damage1);

// Test 50% resistance (would need equipment/ability system)
// character.SetFireResistance(50);
// int damage2 = service.ApplyFireResistance(character, 10);
// Assert.AreEqual(5, damage2);

// Test 100% resistance (immunity)
// character.SetFireResistance(100);
// int damage3 = service.ApplyFireResistance(character, 10);
// Assert.AreEqual(0, damage3);
```

### v5.0 Setting Compliance

#### Test 10: Technology language verification
Verify all hazard descriptions use technological/industrial language:

```sql
SELECT feature_name, feature_description
FROM Biome_EnvironmentalFeatures
WHERE biome_id = 4
  AND (
    feature_description LIKE '%magic%'
    OR feature_description LIKE '%curse%'
    OR feature_description LIKE '%supernatural%'
    OR feature_description LIKE '%elemental spirit%'
  );
```
**Expected:** 0 rows (no magical language)

**Keywords that SHOULD appear:**
- "superheated steam" ✅
- "thermal" ✅
- "pressure valve" ✅
- "combustible gas" ✅
- "molten slag" ✅
- "heat-warped" ✅
- "structural" ✅

#### Test 11: ASCII-only entity names
All feature names should use only ASCII characters:

```sql
SELECT feature_name
FROM Biome_EnvironmentalFeatures
WHERE biome_id = 4;
```

**Verify all names are ASCII-compliant:**
- ✅ [Burning Ground]
- ✅ [Chasm/Lava River]
- ✅ [High-Pressure Steam Vent]
- ✅ [Volatile Gas Pocket]
- ✅ [Scorched Metal Plating]
- ✅ [Molten Slag Pool]
- ✅ [Collapsing Catwalk]
- ✅ [Thermal Mirage]

### Balance Validation

#### Test 12: Damage distribution feels appropriate
```sql
SELECT
    feature_name,
    damage_per_turn,
    hazard_density_category,
    tile_coverage_percent
FROM Biome_EnvironmentalFeatures
WHERE biome_id = 4
  AND damage_per_turn > 0
  AND damage_per_turn < 999
ORDER BY damage_per_turn DESC;
```

**Verify progression:**
- Highest: [Volatile Gas Pocket] (24 damage, 3% coverage, Extreme)
- High: [High-Pressure Steam Vent] (16 damage, 5% coverage, High)
- Medium: [Burning Ground] (8 damage, 15% coverage, Medium)
- Low: [Molten Slag Pool] (4 damage, 8% coverage, Medium)

**Balance reasoning:**
- Rare hazards (Explosive) deal more damage to justify risk
- Common hazards ([Burning Ground]) have moderate damage with high coverage
- Movement impediments have lower/no damage ([Scorched Metal Plating])

#### Test 13: Total hazard coverage per room
```sql
SELECT
    SUM(tile_coverage_percent) as total_coverage_percent
FROM Biome_EnvironmentalFeatures
WHERE biome_id = 4;
```
**Expected:** ~99% total coverage

**Note:** This is theoretical maximum. Actual rooms will filter hazards by `hazard_density_category`.

### Integration Points

#### Test 14: [Intense Heat] affects all combatants
**Manual test scenario:**
1. Create a Muspelheim room with [Intense Heat] condition
2. Place 3 characters with varying STURDINESS (2, 3, 4)
3. Call `IntenseHeatService.ProcessEndOfTurnHeat()`
4. Verify each character makes separate STURDINESS check
5. Verify damage applied based on individual check results

#### Test 15: Hazard placement respects density
**Manual test scenario:**
1. Generate room with `hazard_density = "Low"`
2. Verify only Low-density hazards placed ([Scorched Metal Plating], [Thermal Mirage])
3. Generate room with `hazard_density = "Extreme"`
4. Verify Extreme hazards can appear ([Volatile Gas Pocket], [Collapsing Catwalk])

### Known Limitations (v0.29.2)

1. **No Fire Resistance Equipment System Yet**
   - `GetFireResistancePercent()` returns 0 for all characters
   - Will be implemented when equipment system is expanded
   - Manual workaround: Modify method to return test values

2. **No Biome Statistics Tracking Yet**
   - `Characters_BiomeStatus` table exists but not yet populated
   - `heat_damage_taken` and `times_died_to_heat` not tracked
   - Will be integrated in v0.29.4 (Service Implementation)

3. **No Hazard Placement Algorithm Yet**
   - Hazards defined but not yet placed in procedural rooms
   - Placement logic deferred to v0.29.4

4. **No Enemy Integration Yet**
   - Enemies don't yet trigger heat checks
   - Enemy Fire Resistance not defined (v0.29.3)

### Success Criteria

✅ All 8 environmental hazards seeded to database
✅ IntenseHeatCondition class created
✅ IntenseHeatService implemented
✅ Enum types updated (AmbientConditionType, DynamicHazardType)
✅ v5.0 setting compliance verified (technology language)
✅ ASCII-only entity names confirmed
✅ Database queries return expected results
✅ No compilation errors

### Next Steps After v0.29.2

Once all tests pass, proceed to:
- **v0.29.3:** Enemy Definitions & Spawn System
- **v0.29.4:** Service Implementation & Testing (full integration)

### Troubleshooting

#### Issue: Hazards not appearing in database
**Solution:** Ensure v0.29.1 completed successfully. Check that `Biome_EnvironmentalFeatures` table exists:
```sql
SELECT name FROM sqlite_master WHERE type='table' AND name='Biome_EnvironmentalFeatures';
```

#### Issue: IntenseHeatService not compiling
**Solution:** Verify all dependencies are referenced:
- `using RuneAndRust.Core;`
- `using RuneAndRust.Core.Population;`
- `using Serilog;`

#### Issue: STURDINESS checks always fail
**Solution:** Check character STURDINESS attribute value. Ensure `GetAttributeValue("STURDINESS")` returns expected value (1-6 typically).

### Example Test Character Setup

```csharp
private PlayerCharacter CreateTestCharacter(int sturdiness = 3)
{
    return new PlayerCharacter
    {
        CharacterId = 1,
        Name = "Test Warrior",
        HP = 50,
        MaxHP = 50,
        Class = "Warrior",
        // Set STURDINESS attribute
        // (Implementation depends on character attribute system)
    };
}

private Room CreateRoomWithIntenseHeat()
{
    var room = new Room
    {
        Name = "Muspelheim Test Room",
        Description = "A test room with intense heat."
    };

    room.AmbientConditions.Add(new IntenseHeatCondition());

    return room;
}
```

---

**Implementation Time:** ~6 hours
**Specification Estimate:** 8-12 hours
**Status:** Phase 2 (Environmental Systems) Complete ✓
**Ready for:** Phase 3 (Enemy Definitions v0.29.3)
