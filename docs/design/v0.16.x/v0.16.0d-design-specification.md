# v0.16.0d Design Specification: Loot Service Integration

**Version:** 0.16.0d  
**Phase Name:** Loot Service Integration  
**Parent Version:** v0.16.0 (Quality Tier System)  
**Prerequisites:** v0.16.0a (Quality Tier Enum), v0.16.0b (Stat Scaling), v0.16.0c (Drop Tables)  
**Estimated Tests:** ~5 unit tests

---

## Table of Contents

1. [Executive Summary](#1-executive-summary)
2. [Feature Overview](#2-feature-overview)
3. [Architecture Diagrams](#3-architecture-diagrams)
4. [ILootService Interface Enhancement](#4-ilootservice-interface-enhancement)
5. [LootDrop Value Object Enhancement](#5-lootdrop-value-object-enhancement)
6. [DroppedItem Value Object Enhancement](#6-droppeditem-value-object-enhancement)
7. [MonsterDropClassMapping Value Object](#7-monsterdropclassmapping-value-object)
8. [Data Model Changes](#8-data-model-changes)
9. [Logging Specifications](#9-logging-specifications)
10. [Unit Testing Requirements](#10-unit-testing-requirements)
11. [Use Cases](#11-use-cases)
12. [Deliverable Checklist](#12-deliverable-checklist)
13. [Acceptance Criteria](#13-acceptance-criteria)
14. [Dependencies](#14-dependencies)
15. [Future Considerations](#15-future-considerations)

---

## 1. Executive Summary

### 1.1 Purpose

This specification defines the integration of the quality tier system into the existing loot service. This is the culminating phase of v0.16.0 that brings together all previous components (QualityTier enum, stat scaling, and drop tables) into a working loot generation system.

When an enemy is defeated:

1. The monster's drop class is determined via `MonsterDropClassMapping`
2. A quality tier is rolled using `IDropTableProvider`
3. Stats are applied via `ITierScalingService`
4. A `DroppedItem` is generated with tier-appropriate values
5. A `LootDrop` aggregates all items with tier tracking

Key enhancements:

- **ILootService Enhancement**: New `GenerateTieredLoot()` method
- **LootDrop Enhancement**: Tracks highest tier and Myth-Forged presence
- **DroppedItem Enhancement**: Stores tier, attribute bonus, and bonus attribute
- **MonsterDropClassMapping**: Maps monster types to enemy drop classes

### 1.2 Key Deliverables

| Category                       | Items                                     |
| ------------------------------ | ----------------------------------------- |
| **Interface Modifications**    | `ILootService` enhanced with tier support |
| **Value Object Modifications** | `LootDrop`, `DroppedItem` enhanced        |
| **New Value Objects**          | `MonsterDropClassMapping`                 |
| **Tests**                      | ~5 unit tests                             |

### 1.3 Architectural Significance

This version establishes the **Tier-Integrated Loot Generation Pattern**:

- **End-to-End Integration**: Connects all v0.16.0 components
- **Backward Compatibility**: Existing loot service usage unchanged
- **Enhancement Pattern**: Adds tier features without breaking changes
- **Monster Classification**: Explicit mapping of monsters to drop classes

---

## 2. Feature Overview

```
v0.16.0d Loot Service Integration
├── ILootService Interface Enhancement
│   ├── GenerateTieredLoot(monster, random): LootDrop
│   ├── GenerateItemForTier(tier, category, random): DroppedItem
│   └── GetDropClassForMonster(monster): EnemyDropClass
├── LootDrop Enhancement
│   ├── ADD: HighestTier: QualityTier?
│   ├── ADD: HasMythForged: bool
│   └── ADD: TierCounts: Dictionary<QualityTier, int>
├── DroppedItem Enhancement
│   ├── ADD: QualityTier: QualityTier
│   ├── ADD: AttributeBonus: int?
│   ├── ADD: BonusAttribute: string?
│   └── ADD: FormattedName: string (with tier prefix)
└── MonsterDropClassMapping
    ├── MonsterTypeId: string
    ├── DropClass: EnemyDropClass
    └── DropCount: int (items per kill)
```

### 2.1 Scope Alignment

**In Scope:**

- Enhanced `ILootService` interface with tier-aware methods
- Enhanced `LootDrop` with tier tracking
- Enhanced `DroppedItem` with tier and attribute bonus
- `MonsterDropClassMapping` value object
- Monster type to `EnemyDropClass` mapping
- Integration of `IDropTableProvider` and `ITierScalingService`

**Out of Scope:**

- Smart loot filtering by player class (v0.16.3)
- Container loot generation (v0.16.4)
- Unique/Myth-Forged special items (v0.16.5)
- Weapon proficiency effects (v0.16.1)
- Armor proficiency effects (v0.16.2)

---

## 3. Architecture Diagrams

### 3.1 Loot Generation Integration Flow

```
┌─────────────────────────────────────────────────────────────────────┐
│                  LOOT GENERATION INTEGRATION FLOW                    │
└─────────────────────────────────────────────────────────────────────┘

    Enemy Defeated
         │
         ▼
┌─────────────────────────────────────────────────────────────────────┐
│  1. GET MONSTER DROP CLASS MAPPING                                  │
├─────────────────────────────────────────────────────────────────────┤
│  MonsterDropClassMapping.GetDropClass(monster.TypeId)               │
│                                                                      │
│  Monster "skeletal_warrior" → EnemyDropClass.Trash                  │
│  Monster "drone_alpha" → EnemyDropClass.Standard                    │
│  Monster "warden_prime" → EnemyDropClass.Elite                      │
│  Monster "chamber_guardian" → EnemyDropClass.MiniBoss               │
│  Monster "dungeon_lord" → EnemyDropClass.Boss                       │
└─────────────────────────────────────────────────────────────────────┘
         │
         ▼
┌─────────────────────────────────────────────────────────────────────┐
│  2. ROLL DROP TIER (from v0.16.0c)                                  │
├─────────────────────────────────────────────────────────────────────┤
│  IDropTableProvider.RollDrop(enemyClass, random)                    │
│                                                                      │
│  Returns: DropRollResult { Tier: Scavenged, IsNoDrop: false }       │
│                                                                      │
│  If IsNoDrop == true:                                               │
│    → Return empty LootDrop                                          │
└─────────────────────────────────────────────────────────────────────┘
         │
         ▼
┌─────────────────────────────────────────────────────────────────────┐
│  3. DETERMINE ITEM CATEGORY                                         │
├─────────────────────────────────────────────────────────────────────┤
│  Roll random item category:                                         │
│    - Weapon (50%)                                                   │
│    - Armor (40%)                                                    │
│    - Accessory (10%)                                                │
└─────────────────────────────────────────────────────────────────────┘
         │
         ▼
┌─────────────────────────────────────────────────────────────────────┐
│  4. APPLY TIER SCALING (from v0.16.0b)                              │
├─────────────────────────────────────────────────────────────────────┤
│  IF Weapon:                                                         │
│    WeaponTierScaling = ITierScalingService.GetWeaponScaling(tier)   │
│    DamageDice = scaling.DamageDice       // "1d6+1"                 │
│    AccuracyMod = scaling.AccuracyModifier // 0                      │
│    AttrBonus = scaling.RollAttributeBonus(random)  // null or +1    │
│                                                                      │
│  IF Armor:                                                          │
│    ArmorTierScaling = ITierScalingService.GetArmorScaling(tier)     │
│    HpBonus = scaling.HpBonus             // +10                     │
│    DefenseBonus = scaling.DefenseBonus   // +1                      │
│    AttrBonus = scaling.RollAttributeBonus(random)  // null or +1    │
└─────────────────────────────────────────────────────────────────────┘
         │
         ▼
┌─────────────────────────────────────────────────────────────────────┐
│  5. CREATE DROPPED ITEM                                             │
├─────────────────────────────────────────────────────────────────────┤
│  DroppedItem.Create(                                                │
│    itemId: "iron_sword",                                            │
│    displayName: "Iron Sword",                                       │
│    qualityTier: QualityTier.Scavenged,                              │
│    damageDice: "1d6+1",                                             │
│    accuracyModifier: 0,                                             │
│    attributeBonus: null,                                            │
│    bonusAttribute: null                                             │
│  )                                                                  │
│                                                                      │
│  → FormattedName: "[Scavenged] Iron Sword"                          │
└─────────────────────────────────────────────────────────────────────┘
         │
         ▼
┌─────────────────────────────────────────────────────────────────────┐
│  6. CREATE LOOT DROP                                                │
├─────────────────────────────────────────────────────────────────────┤
│  LootDrop.Create(                                                   │
│    items: [ DroppedItem, ... ],                                     │
│    sourceMonster: monster                                           │
│  )                                                                  │
│                                                                      │
│  Auto-calculated:                                                   │
│    - HighestTier: QualityTier.Scavenged                             │
│    - HasMythForged: false                                           │
│    - TierCounts: { Scavenged: 1 }                                   │
└─────────────────────────────────────────────────────────────────────┘
```

### 3.2 Service Dependency Diagram

```
┌─────────────────────────────────────────────────────────────────────┐
│                    SERVICE DEPENDENCY DIAGRAM                        │
└─────────────────────────────────────────────────────────────────────┘

                      ┌─────────────────────────────────┐
                      │        Combat System            │
                      │   (calls on enemy defeat)       │
                      └───────────────┬─────────────────┘
                                      │
                                      ▼
┌─────────────────────────────────────────────────────────────────────┐
│                         ILootService                                 │
│                    (enhanced in v0.16.0d)                            │
├─────────────────────────────────────────────────────────────────────┤
│  + GenerateTieredLoot(monster, random): LootDrop                    │
│  + GenerateItemForTier(tier, category, random): DroppedItem         │
│  + GetDropClassForMonster(monster): EnemyDropClass                  │
└───────┬─────────────────────────┬─────────────────────┬─────────────┘
        │                         │                     │
        │                         │                     │
        ▼                         ▼                     ▼
┌───────────────────┐  ┌───────────────────┐  ┌───────────────────────┐
│ IDropTableProvider│  │ITierScalingService│  │ ITierMetadataProvider │
│   (v0.16.0c)      │  │    (v0.16.0b)     │  │     (v0.16.0a)        │
├───────────────────┤  ├───────────────────┤  ├───────────────────────┤
│ GetDropEntry()    │  │ GetWeaponScaling()│  │ GetMetadata()         │
│ RollDrop()        │  │ GetArmorScaling() │  │ GetTierDisplayName()  │
│                   │  │ RollAttrBonus()   │  │ FormatItemName()      │
└───────────────────┘  └───────────────────┘  └───────────────────────┘
        │                         │                     │
        ▼                         ▼                     ▼
┌───────────────────┐  ┌───────────────────┐  ┌───────────────────────┐
│DropProbabilityEntry│ │ WeaponTierScaling │  │    TierMetadata       │
│   DropRollResult  │  │ ArmorTierScaling  │  │ TierColorDefinition   │
│                   │  │AttributeBonusRange│  │                       │
└───────────────────┘  └───────────────────┘  └───────────────────────┘
```

### 3.3 Enhanced LootDrop Aggregation

```
┌─────────────────────────────────────────────────────────────────────┐
│                   ENHANCED LOOT DROP AGGREGATION                     │
└─────────────────────────────────────────────────────────────────────┘

    Multiple Items Generated
         │
         ├── DroppedItem: [Scavenged] Iron Sword
         ├── DroppedItem: [ClanForged] Leather Boots     ← attr +1 FINESSE
         └── DroppedItem: [Scavenged] Health Potion
                │
                ▼
┌─────────────────────────────────────────────────────────────────────┐
│                         LootDrop                                     │
├─────────────────────────────────────────────────────────────────────┤
│  Items: [                                                           │
│    { Name: "[Scavenged] Iron Sword", Tier: 1 }                      │
│    { Name: "[ClanForged] Leather Boots +1 FIN", Tier: 2 }           │
│    { Name: "[Scavenged] Health Potion", Tier: 1 }                   │
│  ]                                                                  │
│                                                                      │
│  HighestTier: ClanForged (2)   ← Calculated from items              │
│  HasMythForged: false          ← No Tier 4 items                    │
│  TierCounts: {                                                      │
│    Scavenged: 2,                                                    │
│    ClanForged: 1                                                    │
│  }                                                                  │
│  TotalItems: 3                                                      │
│  SourceMonster: "Drone Alpha"                                       │
└─────────────────────────────────────────────────────────────────────┘
```

### 3.4 Monster to Drop Class Mapping

```
┌─────────────────────────────────────────────────────────────────────┐
│                 MONSTER TO DROP CLASS MAPPING                        │
└─────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────┐
│  MonsterDropClassMapping Configuration                              │
├─────────────────────────────────────────────────────────────────────┤
│                                                                      │
│  ┌─────────────────────┬──────────────────┬────────────────────┐    │
│  │    Monster Type     │   Drop Class     │   Drop Count       │    │
│  ├─────────────────────┼──────────────────┼────────────────────┤    │
│  │ skeletal_warrior    │ Trash            │ 1                  │    │
│  │ servitor_drone      │ Trash            │ 1                  │    │
│  │ plague_rat          │ Trash            │ 1                  │    │
│  ├─────────────────────┼──────────────────┼────────────────────┤    │
│  │ drone_alpha         │ Standard         │ 1                  │    │
│  │ corrupted_guard     │ Standard         │ 1                  │    │
│  │ shadow_stalker      │ Standard         │ 1                  │    │
│  ├─────────────────────┼──────────────────┼────────────────────┤    │
│  │ warden_prime        │ Elite            │ 2                  │    │
│  │ crystal_golem       │ Elite            │ 2                  │    │
│  │ death_knight        │ Elite            │ 2                  │    │
│  ├─────────────────────┼──────────────────┼────────────────────┤    │
│  │ chamber_guardian    │ MiniBoss         │ 2                  │    │
│  │ gate_keeper         │ MiniBoss         │ 2                  │    │
│  ├─────────────────────┼──────────────────┼────────────────────┤    │
│  │ dungeon_lord        │ Boss             │ 3                  │    │
│  │ world_boss          │ Boss             │ 3                  │    │
│  └─────────────────────┴──────────────────┴────────────────────┘    │
│                                                                      │
│  Default Fallback: Standard (if monster not in mapping)             │
└─────────────────────────────────────────────────────────────────────┘
```

### 3.5 Layer Diagram

```
┌─────────────────────────────────────────────────────────────────────┐
│                        PRESENTATION LAYER                            │
├─────────────────────────────────────────────────────────────────────┤
│  LootNotificationView                                                │
│  └── Displays "[MythForged] Dvergr Maul +3 MIGHT" in gold           │
│                                                                      │
│  InventoryView                                                       │
│  └── Shows tier icons and colored item names                        │
│                                                                      │
│  CombatResultView                                                    │
│  └── Shows LootDrop summary with HighestTier indicator              │
└───────┬─────────────────────────────────────────────────────────────┘
        │
        ▼
┌─────────────────────────────────────────────────────────────────────┐
│                       APPLICATION LAYER                              │
├─────────────────────────────────────────────────────────────────────┤
│  ┌───────────────────────────────────────────────────────────────┐  │
│  │                    LootService                                 │  │
│  │              (implements ILootService)                         │  │
│  ├───────────────────────────────────────────────────────────────┤  │
│  │  + GenerateTieredLoot(monster, random): LootDrop              │  │
│  │  + GenerateItemForTier(tier, category, random): DroppedItem   │  │
│  │  + GetDropClassForMonster(monster): EnemyDropClass            │  │
│  │                                                               │  │
│  │  Dependencies:                                                │  │
│  │  - IDropTableProvider (v0.16.0c)                              │  │
│  │  - ITierScalingService (v0.16.0b)                             │  │
│  │  - ITierMetadataProvider (v0.16.0a)                           │  │
│  │  - IMonsterDropClassProvider (new)                            │  │
│  └───────────────────────────────────────────────────────────────┘  │
│                                                                      │
│  ┌───────────────────────────────────────────────────────────────┐  │
│  │                IMonsterDropClassProvider                       │  │
│  │                     (new interface)                            │  │
│  ├───────────────────────────────────────────────────────────────┤  │
│  │  + GetDropClass(monsterTypeId): EnemyDropClass                │  │
│  │  + GetDropCount(monsterTypeId): int                           │  │
│  │  + GetMapping(monsterTypeId): MonsterDropClassMapping         │  │
│  └───────────────────────────────────────────────────────────────┘  │
└───────┬─────────────────────────────────────────────────────────────┘
        │
        ▼
┌─────────────────────────────────────────────────────────────────────┐
│                         DOMAIN LAYER                                 │
├─────────────────────────────────────────────────────────────────────┤
│  ┌─────────────────────────────────────────────────────────────┐   │
│  │              DroppedItem (ENHANCED)                          │   │
│  │                (Value Object)                                │   │
│  ├─────────────────────────────────────────────────────────────┤   │
│  │  Existing:                    New:                           │   │
│  │  ItemId: string              QualityTier: QualityTier        │   │
│  │  DisplayName: string         AttributeBonus: int?            │   │
│  │  ItemCategory: enum          BonusAttribute: string?         │   │
│  │  BaseStats: ...              FormattedName: string (computed)│   │
│  └─────────────────────────────────────────────────────────────┘   │
│                                                                      │
│  ┌─────────────────────────────────────────────────────────────┐   │
│  │               LootDrop (ENHANCED)                            │   │
│  │                (Value Object)                                │   │
│  ├─────────────────────────────────────────────────────────────┤   │
│  │  Existing:                    New:                           │   │
│  │  Items: List<DroppedItem>    HighestTier: QualityTier?       │   │
│  │  SourceMonster: string       HasMythForged: bool             │   │
│  │  TotalValue: int             TierCounts: Dict<Tier, int>     │   │
│  └─────────────────────────────────────────────────────────────┘   │
│                                                                      │
│  ┌─────────────────────────────────────────────────────────────┐   │
│  │            MonsterDropClassMapping (NEW)                     │   │
│  │                (Value Object)                                │   │
│  ├─────────────────────────────────────────────────────────────┤   │
│  │  MonsterTypeId: string                                       │   │
│  │  DropClass: EnemyDropClass                                   │   │
│  │  DropCount: int                                              │   │
│  └─────────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────────┘
```

---

## 4. ILootService Interface Enhancement

### 4.1 Purpose

The `ILootService` interface is enhanced with tier-aware loot generation methods. This allows the combat system to generate quality-tiered loot when enemies are defeated.

### 4.2 Implementation

**File:** `src/Core/RuneAndRust.Application/Interfaces/ILootService.cs`

```csharp
namespace RuneAndRust.Application.Interfaces;

using RuneAndRust.Domain.Enums;
using RuneAndRust.Domain.ValueObjects;

/// <summary>
/// Service interface for generating loot drops from defeated enemies.
/// </summary>
/// <remarks>
/// <para>
/// The loot service integrates the quality tier system (v0.16.0) to generate
/// appropriately scaled equipment based on enemy class and tier probabilities.
/// </para>
/// <para>
/// Higher-tier enemies have better drop tables, and generated items are
/// automatically scaled with tier-appropriate stats and potential attribute bonuses.
/// </para>
/// </remarks>
public interface ILootService
{
    // Existing methods remain unchanged for backward compatibility

    /// <summary>
    /// Generates tiered loot from a defeated monster.
    /// </summary>
    /// <param name="monster">The defeated monster entity.</param>
    /// <param name="random">Random number generator for rolling.</param>
    /// <returns>A LootDrop containing tier-scaled items.</returns>
    /// <remarks>
    /// This method:
    /// 1. Maps the monster to an EnemyDropClass
    /// 2. Rolls for quality tier(s) using drop probability tables
    /// 3. Applies tier scaling to generated items
    /// 4. Aggregates results into a LootDrop with tier tracking
    /// </remarks>
    LootDrop GenerateTieredLoot(Monster monster, Random random);

    /// <summary>
    /// Generates a single item for a specific quality tier.
    /// </summary>
    /// <param name="tier">The quality tier for the item.</param>
    /// <param name="category">The item category (Weapon, Armor, Accessory).</param>
    /// <param name="random">Random number generator.</param>
    /// <returns>A DroppedItem with tier-appropriate stats.</returns>
    DroppedItem GenerateItemForTier(QualityTier tier, ItemCategory category, Random random);

    /// <summary>
    /// Gets the drop class for a monster type.
    /// </summary>
    /// <param name="monster">The monster to classify.</param>
    /// <returns>The EnemyDropClass for the monster.</returns>
    EnemyDropClass GetDropClassForMonster(Monster monster);

    /// <summary>
    /// Gets the number of items dropped by a monster type.
    /// </summary>
    /// <param name="monster">The monster to check.</param>
    /// <returns>The number of items this monster drops.</returns>
    int GetDropCountForMonster(Monster monster);
}
```

---

## 5. LootDrop Value Object Enhancement

### 5.1 Purpose

The `LootDrop` value object is enhanced to track quality tier information for all items in the drop. This enables UI display of drop quality and statistics tracking.

### 5.2 Implementation

**File:** `src/Core/RuneAndRust.Domain/ValueObjects/LootDrop.cs` (Enhanced)

```csharp
namespace RuneAndRust.Domain.ValueObjects;

using RuneAndRust.Domain.Enums;

/// <summary>
/// Represents a collection of items dropped by a defeated monster.
/// </summary>
/// <remarks>
/// <para>
/// LootDrop aggregates all items from a single enemy defeat and provides
/// tier-based statistics for UI display and achievement tracking.
/// </para>
/// <para>
/// The HighestTier and HasMythForged properties are automatically calculated
/// from the contained items.
/// </para>
/// </remarks>
public sealed class LootDrop
{
    /// <summary>
    /// Gets the items in this loot drop.
    /// </summary>
    public IReadOnlyList<DroppedItem> Items { get; }

    /// <summary>
    /// Gets the source monster identifier.
    /// </summary>
    public string SourceMonster { get; }

    /// <summary>
    /// Gets the total gold value of all items.
    /// </summary>
    public int TotalValue { get; }

    // NEW PROPERTIES (v0.16.0d)

    /// <summary>
    /// Gets the highest quality tier among dropped items.
    /// </summary>
    /// <remarks>
    /// Returns null if no items were dropped.
    /// </remarks>
    public QualityTier? HighestTier { get; }

    /// <summary>
    /// Gets whether this drop contains a Myth-Forged (Tier 4) item.
    /// </summary>
    public bool HasMythForged { get; }

    /// <summary>
    /// Gets the count of items per quality tier.
    /// </summary>
    public IReadOnlyDictionary<QualityTier, int> TierCounts { get; }

    /// <summary>
    /// Gets the total number of items in this drop.
    /// </summary>
    public int TotalItems => Items.Count;

    /// <summary>
    /// Gets whether this loot drop is empty (no items).
    /// </summary>
    public bool IsEmpty => Items.Count == 0;

    // Private constructor for factory method
    private LootDrop(
        IReadOnlyList<DroppedItem> items,
        string sourceMonster,
        int totalValue,
        QualityTier? highestTier,
        bool hasMythForged,
        IReadOnlyDictionary<QualityTier, int> tierCounts)
    {
        Items = items;
        SourceMonster = sourceMonster;
        TotalValue = totalValue;
        HighestTier = highestTier;
        HasMythForged = hasMythForged;
        TierCounts = tierCounts;
    }

    /// <summary>
    /// Creates a new LootDrop with automatic tier calculation.
    /// </summary>
    /// <param name="items">The dropped items.</param>
    /// <param name="sourceMonster">The monster that dropped the loot.</param>
    /// <returns>A new LootDrop instance.</returns>
    public static LootDrop Create(IReadOnlyList<DroppedItem> items, string sourceMonster)
    {
        ArgumentNullException.ThrowIfNull(items);
        ArgumentException.ThrowIfNullOrWhiteSpace(sourceMonster);

        // Calculate tier statistics
        var tierCounts = items
            .GroupBy(i => i.QualityTier)
            .ToDictionary(g => g.Key, g => g.Count());

        var highestTier = items.Count > 0
            ? items.Max(i => i.QualityTier)
            : (QualityTier?)null;

        var hasMythForged = items.Any(i => i.QualityTier == QualityTier.MythForged);

        var totalValue = items.Sum(i => i.GoldValue);

        return new LootDrop(
            items,
            sourceMonster,
            totalValue,
            highestTier,
            hasMythForged,
            tierCounts);
    }

    /// <summary>
    /// Creates an empty loot drop (monster dropped nothing).
    /// </summary>
    /// <param name="sourceMonster">The monster that dropped nothing.</param>
    /// <returns>An empty LootDrop instance.</returns>
    public static LootDrop Empty(string sourceMonster)
    {
        ArgumentException.ThrowIfNullOrWhiteSpace(sourceMonster);

        return new LootDrop(
            Array.Empty<DroppedItem>(),
            sourceMonster,
            totalValue: 0,
            highestTier: null,
            hasMythForged: false,
            new Dictionary<QualityTier, int>());
    }

    /// <summary>
    /// Gets a summary string for logging.
    /// </summary>
    public override string ToString()
    {
        if (IsEmpty)
            return $"LootDrop from {SourceMonster}: (empty)";

        var tierStr = HighestTier.HasValue
            ? $"Best: {HighestTier.Value}"
            : "No items";
        var mythStr = HasMythForged ? " [MYTH-FORGED!]" : "";

        return $"LootDrop from {SourceMonster}: {TotalItems} items, {tierStr}{mythStr}";
    }
}
```

---

## 6. DroppedItem Value Object Enhancement

### 6.1 Purpose

The `DroppedItem` value object is enhanced to track quality tier and attribute bonuses. This enables proper display of tiered equipment with stat modifiers.

### 6.2 Implementation

**File:** `src/Core/RuneAndRust.Domain/ValueObjects/DroppedItem.cs` (Enhanced)

```csharp
namespace RuneAndRust.Domain.ValueObjects;

using RuneAndRust.Domain.Enums;

/// <summary>
/// Represents an item dropped by a defeated enemy.
/// </summary>
/// <remarks>
/// <para>
/// DroppedItem contains all the information needed to display and add
/// an item to the player's inventory, including tier-based stats and
/// potential attribute bonuses.
/// </para>
/// <para>
/// The FormattedName property returns the display name with tier prefix
/// and attribute bonus (e.g., "[ClanForged] Iron Sword +1 MIGHT").
/// </para>
/// </remarks>
public readonly record struct DroppedItem
{
    /// <summary>
    /// Gets the unique item identifier.
    /// </summary>
    public string ItemId { get; init; }

    /// <summary>
    /// Gets the base display name (without tier prefix).
    /// </summary>
    public string DisplayName { get; init; }

    /// <summary>
    /// Gets the item category.
    /// </summary>
    public ItemCategory Category { get; init; }

    /// <summary>
    /// Gets the gold value of this item.
    /// </summary>
    public int GoldValue { get; init; }

    // NEW PROPERTIES (v0.16.0d)

    /// <summary>
    /// Gets the quality tier of this item.
    /// </summary>
    public QualityTier QualityTier { get; init; }

    /// <summary>
    /// Gets the attribute bonus, if any.
    /// </summary>
    /// <remarks>
    /// Only Tier 2+ items have attribute bonuses.
    /// </remarks>
    public int? AttributeBonus { get; init; }

    /// <summary>
    /// Gets the attribute that receives the bonus.
    /// </summary>
    /// <remarks>
    /// Examples: "MIGHT", "FINESSE", "WILL", "STURDINESS"
    /// </remarks>
    public string? BonusAttribute { get; init; }

    // WEAPON-SPECIFIC PROPERTIES

    /// <summary>
    /// Gets the damage dice for weapons.
    /// </summary>
    public string? DamageDice { get; init; }

    /// <summary>
    /// Gets the accuracy modifier for weapons.
    /// </summary>
    public int? AccuracyModifier { get; init; }

    // ARMOR-SPECIFIC PROPERTIES

    /// <summary>
    /// Gets the HP bonus for armor.
    /// </summary>
    public int? HpBonus { get; init; }

    /// <summary>
    /// Gets the defense bonus for armor.
    /// </summary>
    public int? DefenseBonus { get; init; }

    // COMPUTED PROPERTIES

    /// <summary>
    /// Gets whether this item has an attribute bonus.
    /// </summary>
    public bool HasAttributeBonus => AttributeBonus.HasValue && !string.IsNullOrEmpty(BonusAttribute);

    /// <summary>
    /// Gets whether this is a legendary (Myth-Forged) item.
    /// </summary>
    public bool IsLegendary => QualityTier == QualityTier.MythForged;

    /// <summary>
    /// Gets the tier as an integer value.
    /// </summary>
    public int TierValue => (int)QualityTier;

    /// <summary>
    /// Gets the fully formatted item name with tier prefix and attribute bonus.
    /// </summary>
    /// <example>
    /// "[Scavenged] Iron Sword"
    /// "[ClanForged] Leather Boots +1 FIN"
    /// "[MythForged] Dvergr Maul +4 MIGHT"
    /// </example>
    public string FormattedName
    {
        get
        {
            var tierPrefix = $"[{QualityTier}]";
            var attrSuffix = HasAttributeBonus
                ? $" +{AttributeBonus} {GetAttributeAbbreviation(BonusAttribute!)}"
                : "";
            return $"{tierPrefix} {DisplayName}{attrSuffix}";
        }
    }

    /// <summary>
    /// Creates a weapon DroppedItem with tier scaling applied.
    /// </summary>
    public static DroppedItem CreateWeapon(
        string itemId,
        string displayName,
        QualityTier tier,
        string damageDice,
        int accuracyModifier,
        int? attributeBonus,
        string? bonusAttribute,
        int goldValue)
    {
        ArgumentException.ThrowIfNullOrWhiteSpace(itemId);
        ArgumentException.ThrowIfNullOrWhiteSpace(displayName);
        ArgumentException.ThrowIfNullOrWhiteSpace(damageDice);

        return new DroppedItem
        {
            ItemId = itemId,
            DisplayName = displayName,
            Category = ItemCategory.Weapon,
            QualityTier = tier,
            DamageDice = damageDice,
            AccuracyModifier = accuracyModifier,
            AttributeBonus = attributeBonus,
            BonusAttribute = bonusAttribute,
            GoldValue = goldValue
        };
    }

    /// <summary>
    /// Creates an armor DroppedItem with tier scaling applied.
    /// </summary>
    public static DroppedItem CreateArmor(
        string itemId,
        string displayName,
        QualityTier tier,
        int hpBonus,
        int defenseBonus,
        int? attributeBonus,
        string? bonusAttribute,
        int goldValue)
    {
        ArgumentException.ThrowIfNullOrWhiteSpace(itemId);
        ArgumentException.ThrowIfNullOrWhiteSpace(displayName);

        return new DroppedItem
        {
            ItemId = itemId,
            DisplayName = displayName,
            Category = ItemCategory.Armor,
            QualityTier = tier,
            HpBonus = hpBonus,
            DefenseBonus = defenseBonus,
            AttributeBonus = attributeBonus,
            BonusAttribute = bonusAttribute,
            GoldValue = goldValue
        };
    }

    /// <summary>
    /// Gets the 3-4 character abbreviation for an attribute.
    /// </summary>
    private static string GetAttributeAbbreviation(string attribute)
    {
        return attribute.ToUpperInvariant() switch
        {
            "MIGHT" => "MIG",
            "FINESSE" => "FIN",
            "WILL" => "WIL",
            "WITS" => "WIT",
            "STURDINESS" => "STU",
            "SPIRIT" => "SPI",
            _ => attribute[..Math.Min(3, attribute.Length)].ToUpperInvariant()
        };
    }

    /// <summary>
    /// Returns the formatted name for display.
    /// </summary>
    public override string ToString() => FormattedName;
}
```

---

## 7. MonsterDropClassMapping Value Object

### 7.1 Purpose

The `MonsterDropClassMapping` value object maps monster type identifiers to their corresponding enemy drop classes. This determines what quality tier of loot a monster can drop.

### 7.2 Implementation

**File:** `src/Core/RuneAndRust.Domain/ValueObjects/MonsterDropClassMapping.cs`

```csharp
namespace RuneAndRust.Domain.ValueObjects;

using RuneAndRust.Domain.Enums;

/// <summary>
/// Maps a monster type to its drop class and drop count.
/// </summary>
/// <remarks>
/// <para>
/// This mapping determines the loot potential of each monster type.
/// Stronger monsters have higher drop classes (better tier chances)
/// and may drop multiple items per kill.
/// </para>
/// <para>
/// Monster type IDs should use lowercase kebab-case (e.g., "skeletal-warrior").
/// </para>
/// </remarks>
/// <param name="MonsterTypeId">The unique monster type identifier.</param>
/// <param name="DropClass">The enemy drop class for this monster.</param>
/// <param name="DropCount">Number of items this monster drops per kill.</param>
public readonly record struct MonsterDropClassMapping(
    string MonsterTypeId,
    EnemyDropClass DropClass,
    int DropCount)
{
    /// <summary>
    /// Gets whether this monster can drop multiple items.
    /// </summary>
    public bool DropsMultipleItems => DropCount > 1;

    /// <summary>
    /// Gets whether this is a boss-tier monster.
    /// </summary>
    public bool IsBoss => DropClass == EnemyDropClass.Boss;

    /// <summary>
    /// Gets whether this is a miniboss monster.
    /// </summary>
    public bool IsMiniBoss => DropClass == EnemyDropClass.MiniBoss;

    /// <summary>
    /// Gets a description of the monster's loot potential.
    /// </summary>
    public string LootPotentialDescription => DropClass switch
    {
        EnemyDropClass.Trash => "Low quality drops",
        EnemyDropClass.Standard => "Standard drops",
        EnemyDropClass.Elite => "Quality drops with legendary chance",
        EnemyDropClass.MiniBoss => "Excellent drops, high legendary chance",
        EnemyDropClass.Boss => "Best drops, very high legendary chance",
        _ => "Unknown loot potential"
    };

    /// <summary>
    /// Creates a new MonsterDropClassMapping with validation.
    /// </summary>
    /// <param name="monsterTypeId">Monster type identifier.</param>
    /// <param name="dropClass">Drop class.</param>
    /// <param name="dropCount">Items per kill (default 1).</param>
    /// <returns>A new MonsterDropClassMapping instance.</returns>
    public static MonsterDropClassMapping Create(
        string monsterTypeId,
        EnemyDropClass dropClass,
        int dropCount = 1)
    {
        ArgumentException.ThrowIfNullOrWhiteSpace(monsterTypeId);
        ArgumentOutOfRangeException.ThrowIfNegativeOrZero(dropCount);
        ArgumentOutOfRangeException.ThrowIfGreaterThan(dropCount, 5);

        return new MonsterDropClassMapping(
            monsterTypeId.ToLowerInvariant(),
            dropClass,
            dropCount);
    }

    /// <summary>
    /// Creates a default mapping (Standard class, 1 drop) for unknown monsters.
    /// </summary>
    /// <param name="monsterTypeId">Monster type identifier.</param>
    /// <returns>A default MonsterDropClassMapping.</returns>
    public static MonsterDropClassMapping Default(string monsterTypeId)
    {
        return Create(monsterTypeId, EnemyDropClass.Standard, 1);
    }

    /// <summary>
    /// Returns a display string for debugging.
    /// </summary>
    public override string ToString() =>
        $"{MonsterTypeId} → {DropClass} ({DropCount} drop{(DropCount > 1 ? "s" : "")})";
}
```

### 7.3 IMonsterDropClassProvider Interface

**File:** `src/Core/RuneAndRust.Application/Interfaces/IMonsterDropClassProvider.cs`

```csharp
namespace RuneAndRust.Application.Interfaces;

using RuneAndRust.Domain.Enums;
using RuneAndRust.Domain.ValueObjects;

/// <summary>
/// Provides monster type to drop class mappings.
/// </summary>
/// <remarks>
/// <para>
/// This interface abstracts the source of monster-to-drop-class mappings,
/// allowing them to be loaded from configuration or derived from monster data.
/// </para>
/// </remarks>
public interface IMonsterDropClassProvider
{
    /// <summary>
    /// Gets the drop class for a monster type.
    /// </summary>
    /// <param name="monsterTypeId">The monster type identifier.</param>
    /// <returns>The EnemyDropClass for the monster.</returns>
    EnemyDropClass GetDropClass(string monsterTypeId);

    /// <summary>
    /// Gets the number of items dropped by a monster type.
    /// </summary>
    /// <param name="monsterTypeId">The monster type identifier.</param>
    /// <returns>The number of items per kill.</returns>
    int GetDropCount(string monsterTypeId);

    /// <summary>
    /// Gets the complete mapping for a monster type.
    /// </summary>
    /// <param name="monsterTypeId">The monster type identifier.</param>
    /// <returns>The full MonsterDropClassMapping.</returns>
    MonsterDropClassMapping GetMapping(string monsterTypeId);

    /// <summary>
    /// Gets all configured monster mappings.
    /// </summary>
    /// <returns>A read-only list of all mappings.</returns>
    IReadOnlyList<MonsterDropClassMapping> GetAllMappings();

    /// <summary>
    /// Checks if a monster type has an explicit mapping.
    /// </summary>
    /// <param name="monsterTypeId">The monster type identifier.</param>
    /// <returns>True if explicitly mapped, false if using default.</returns>
    bool HasMapping(string monsterTypeId);
}
```

---

## 8. Data Model Changes

### 8.1 Types Summary

| Type                        | Layer       | Category     | Change Type |
| --------------------------- | ----------- | ------------ | ----------- |
| `ILootService`              | Application | Interface    | MODIFIED    |
| `IMonsterDropClassProvider` | Application | Interface    | NEW         |
| `LootDrop`                  | Domain      | Value Object | MODIFIED    |
| `DroppedItem`               | Domain      | Value Object | MODIFIED    |
| `MonsterDropClassMapping`   | Domain      | Value Object | NEW         |

### 8.2 File Locations

```
src/Core/RuneAndRust.Domain/
└── ValueObjects/
    ├── LootDrop.cs                          ← MODIFIED
    ├── DroppedItem.cs                       ← MODIFIED
    └── MonsterDropClassMapping.cs           ← NEW

src/Core/RuneAndRust.Application/
└── Interfaces/
    ├── ILootService.cs                      ← MODIFIED
    └── IMonsterDropClassProvider.cs         ← NEW

config/
└── monster-drop-classes.json                ← NEW (optional)
```

### 8.3 Property Changes Summary

**LootDrop Additions:**
| Property | Type | Description |
|----------|------|-------------|
| `HighestTier` | `QualityTier?` | Highest tier among dropped items |
| `HasMythForged` | `bool` | Whether any item is Tier 4 |
| `TierCounts` | `Dictionary<QualityTier, int>` | Count per tier |
| `TotalItems` | `int` | Total item count |
| `IsEmpty` | `bool` | True if no items dropped |

**DroppedItem Additions:**
| Property | Type | Description |
|----------|------|-------------|
| `QualityTier` | `QualityTier` | The item's quality tier |
| `AttributeBonus` | `int?` | Bonus value (+1 to +4) |
| `BonusAttribute` | `string?` | Attribute name (MIGHT, etc.) |
| `FormattedName` | `string` | Full display name with tier and bonus |
| `HasAttributeBonus` | `bool` | Whether bonus is present |
| `IsLegendary` | `bool` | True if Tier 4 |

---

## 9. Logging Specifications

### 9.1 Log Levels by Component

| Component     | Level       | Events                                   |
| ------------- | ----------- | ---------------------------------------- |
| `LootService` | Information | Loot generated, Myth-Forged dropped      |
| `LootService` | Debug       | Tier rolled, item created, stats applied |
| `LootService` | Warning     | Monster mapping not found, using default |
| `LootService` | Error       | Generation failed, invalid configuration |

### 9.2 Structured Logging Templates

```csharp
// Information - Loot generated
_logger.LogInformation(
    "Loot generated. Monster={Monster}, ItemCount={Count}, HighestTier={Tier}",
    monster.TypeId,
    lootDrop.TotalItems,
    lootDrop.HighestTier);

// Information - Myth-Forged dropped (special event)
_logger.LogInformation(
    "LEGENDARY DROP! Monster={Monster}, Item={ItemName}, Tier={Tier}",
    monster.TypeId,
    item.FormattedName,
    QualityTier.MythForged);

// Debug - Tier rolled
_logger.LogDebug(
    "Drop tier rolled. Monster={Monster}, DropClass={Class}, RolledTier={Tier}",
    monster.TypeId,
    dropClass,
    rollResult.DroppedTier);

// Debug - Item created with scaling
_logger.LogDebug(
    "Item created. ItemId={ItemId}, Tier={Tier}, Damage={Damage}, AttrBonus={Bonus}",
    item.ItemId,
    item.QualityTier,
    item.DamageDice,
    item.AttributeBonus);

// Warning - Using default mapping
_logger.LogWarning(
    "Monster drop class mapping not found, using default. MonsterTypeId={TypeId}",
    monster.TypeId);

// Error - Generation failure
_logger.LogError(
    "Failed to generate loot. Monster={Monster}, Error={Error}",
    monster.TypeId,
    exception.Message);
```

---

## 10. Unit Testing Requirements

### 10.1 Test Count by Feature

| Feature                  | Test Count |
| ------------------------ | ---------- |
| ILootService enhancement | ~2         |
| LootDrop enhancement     | ~1         |
| DroppedItem enhancement  | ~1         |
| MonsterDropClassMapping  | ~1         |
| **Total**                | **~5**     |

### 10.2 Test Specifications

#### LootServiceIntegrationTests.cs

**File:** `tests/RuneAndRust.Application.UnitTests/Services/LootServiceIntegrationTests.cs`

```csharp
[TestFixture]
public class LootServiceIntegrationTests
{
    [Test]
    public void GenerateTieredLoot_FromStandardEnemy_ReturnsLootDropWithTierTracking();

    [Test]
    public void GenerateTieredLoot_FromBossEnemy_HasMythForgedTrue();

    [Test]
    public void GenerateItemForTier_WithTier2_HasAttributeBonus();

    [Test]
    public void GenerateItemForTier_WithTier0_HasNoAttributeBonus();

    [Test]
    public void GetDropClassForMonster_WithKnownType_ReturnsCorrectClass();

    [Test]
    public void GetDropClassForMonster_WithUnknownType_ReturnsDefaultStandard();
}
```

#### LootDropTests.cs

**File:** `tests/RuneAndRust.Domain.UnitTests/ValueObjects/LootDropTests.cs`

```csharp
[TestFixture]
public class LootDropTests
{
    [Test]
    public void Create_WithMixedTiers_CalculatesHighestTierCorrectly();

    [Test]
    public void Create_WithMythForgedItem_SetHasMythForgedTrue();

    [Test]
    public void Create_WithNoItems_ReturnsEmptyDrop();

    [Test]
    public void TierCounts_ReturnsCorrectCountPerTier();

    [Test]
    public void Empty_CreatesEmptyLootDrop();
}
```

#### DroppedItemTests.cs

**File:** `tests/RuneAndRust.Domain.UnitTests/ValueObjects/DroppedItemTests.cs`

```csharp
[TestFixture]
public class DroppedItemTests
{
    [Test]
    public void CreateWeapon_WithTierAndBonus_SetsAllProperties();

    [Test]
    public void FormattedName_WithoutBonus_ReturnsBasicFormat();

    [Test]
    public void FormattedName_WithBonus_IncludesAttributeSuffix();

    [Test]
    public void IsLegendary_ForMythForged_ReturnsTrue();

    [Test]
    public void HasAttributeBonus_WhenSet_ReturnsTrue();
}
```

#### MonsterDropClassMappingTests.cs

**File:** `tests/RuneAndRust.Domain.UnitTests/ValueObjects/MonsterDropClassMappingTests.cs`

```csharp
[TestFixture]
public class MonsterDropClassMappingTests
{
    [Test]
    public void Create_WithValidParameters_CreatesMapping();

    [Test]
    public void Create_NormalizesMonsterTypeId_ToLowercase();

    [Test]
    public void Default_ReturnsStandardClassWithOneDrops();

    [Test]
    public void IsBoss_ForBossClass_ReturnsTrue();
}
```

---

## 11. Use Cases

### UC-001: Generate Loot from Defeated Enemy

**Actor:** Combat System  
**Flow:** Enemy defeated → Get monster type → Get drop class → Roll tier → Generate items → Apply scaling → Create LootDrop → Present to player

### UC-002: Display Tiered Item in Inventory

**Actor:** Inventory View  
**Flow:** Select item → Get DroppedItem → Display FormattedName → Apply tier color → Show attribute bonus

### UC-003: Track Legendary Item Discovery

**Actor:** Achievement System  
**Flow:** Check LootDrop.HasMythForged → If true, trigger "First Legendary" achievement → Log special event

### UC-004: Show Monster Loot Potential

**Actor:** Bestiary / Monster Info  
**Flow:** Select monster → Get drop class mapping → Display loot potential description → Show possible tier range

---

## 12. Deliverable Checklist

### Application Layer

- [ ] `ILootService.cs` enhanced with tier-aware methods
- [ ] `IMonsterDropClassProvider.cs` interface created
- [ ] All interfaces have complete XML documentation

### Domain Layer

- [ ] `LootDrop.cs` enhanced with tier tracking properties
- [ ] `DroppedItem.cs` enhanced with tier and bonus properties
- [ ] `MonsterDropClassMapping.cs` value object created
- [ ] All types have complete XML documentation

### Testing

- [ ] `LootServiceIntegrationTests.cs` created
- [ ] `LootDropTests.cs` created or enhanced
- [ ] `DroppedItemTests.cs` created or enhanced
- [ ] `MonsterDropClassMappingTests.cs` created
- [ ] ~5 unit tests passing

### Documentation

- [ ] `v0.16.0d-changelog.md` created
- [ ] Inline code comments complete

---

## 13. Acceptance Criteria

### Functional

- [ ] `ILootService.GenerateTieredLoot()` returns LootDrop with tier info
- [ ] `LootDrop.HighestTier` correctly identifies highest tier item
- [ ] `LootDrop.HasMythForged` is true when Tier 4 item present
- [ ] `LootDrop.TierCounts` accurately counts items per tier
- [ ] `DroppedItem.QualityTier` is set from drop roll
- [ ] `DroppedItem.AttributeBonus` is set for Tier 2+ items
- [ ] `DroppedItem.FormattedName` includes tier prefix and bonus suffix
- [ ] Monster types map to correct drop classes
- [ ] Unknown monster types use default (Standard) mapping
- [ ] Generated items have tier-appropriate stats from v0.16.0b

### Quality

- [ ] Build succeeds with 0 errors
- [ ] Build succeeds with 0 warnings
- [ ] ~5 unit tests pass
- [ ] All public types have XML documentation
- [ ] Integration tests verify end-to-end flow

---

## 14. Dependencies

### Required from v0.16.0a

| Type                    | Location                  | Usage                            |
| ----------------------- | ------------------------- | -------------------------------- |
| `QualityTier`           | `Domain/Enums/`           | Tier tracking in items and drops |
| `ITierMetadataProvider` | `Application/Interfaces/` | Display name formatting          |

### Required from v0.16.0b

| Type                  | Location                  | Usage                   |
| --------------------- | ------------------------- | ----------------------- |
| `WeaponTierScaling`   | `Domain/ValueObjects/`    | Stat values for weapons |
| `ArmorTierScaling`    | `Domain/ValueObjects/`    | Stat values for armor   |
| `ITierScalingService` | `Application/Interfaces/` | Scaling lookups         |

### Required from v0.16.0c

| Type                   | Location                  | Usage                  |
| ---------------------- | ------------------------- | ---------------------- |
| `EnemyDropClass`       | `Domain/Enums/`           | Monster classification |
| `DropProbabilityEntry` | `Domain/ValueObjects/`    | Tier rolling           |
| `DropRollResult`       | `Domain/ValueObjects/`    | Roll results           |
| `IDropTableProvider`   | `Application/Interfaces/` | Drop table lookups     |

### Provides to v0.16.1+

| Type          | Usage                                  |
| ------------- | -------------------------------------- |
| `DroppedItem` | Extended with proficiency requirements |
| `LootDrop`    | Used in proficiency-aware loot display |

---

## 15. Future Considerations

### Deferred to v0.16.1

- **Weapon Proficiency Integration**: Showing proficiency requirements on dropped weapons
- **Proficiency-Gated Effects**: Special properties only usable when proficient

### Deferred to v0.16.3

- **Smart Loot Filtering**: Biasing drops toward player class preferences
- **Weighted Item Pools**: Category weighting based on player archetype

### Deferred to v0.16.4

- **Container Loot Integration**: Using same tier system for containers
- **Biome Modifiers**: Area-based drop rate adjustments

### Deferred to v0.16.5

- **Unique Item Registry**: Tracking Myth-Forged items for uniqueness
- **Special Effects**: Tier 4 legendary special abilities
- **Legendary Presentation**: Special UI/audio for legendary drops

### Out of Scope

- **Loot Tables Per Monster**: All monsters use class-based tables
- **Per-Item Drop Rates**: Handled by v0.16.3 smart loot
- **Trading/Selling**: Economy system not in v0.16.x scope

---

_Document Version: 1.0_  
_Last Updated: 2026-01-27_  
_Author: AI Assistant_
