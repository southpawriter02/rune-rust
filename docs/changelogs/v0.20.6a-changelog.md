# v0.20.6a Changelog — Bone-Setter Framework & Tier 1 Abilities

## Version: 0.20.6a

## Date: 2026-02-16

## Focus: Bone-Setter Specialization — Framework & Tier 1 Abilities (Field Dressing, Diagnose, Steady Hands)

---

## Added

### Domain Layer — Enums

- **`BoneSetterAbilityId`** — 9 ability identifiers across 4 tiers: FieldDressing (600), Diagnose (601), SteadyHands (602), EmergencySurgery (603), AntidoteCraft (604), Triage (605), Resuscitate (606), PreventiveCare (607), MiracleWorker (608)
- **`MedicalSupplyType`** — 7 supply type classifications: Bandage, Salve, Splint, Suture, Herbs, Antidote, Stimulant
- **`WoundSeverity`** — 6 wound severity levels with HP% thresholds: Minor (90-100%), Light (70-89%), Moderate (40-69%), Serious (15-39%), Critical (1-14%), Unconscious (0%)

### Domain Layer — Value Objects

- **`MedicalSupplyItem`** — Individual supply item with type, quality (1-5), and source tracking. Factory method `Create(MedicalSupplyType, string, string, int, string)` with validation. Healing bonus formula: `Quality - 1` (range 0-4). Display via `GetFormattedDescription()` with star notation.
- **`MedicalSuppliesResource`** — Immutable supply inventory with `IReadOnlyList<MedicalSupplyItem>` and carry capacity. Factory methods `Create()` (empty) and `Create(IEnumerable<MedicalSupplyItem>, int)`. Immutable operations: `SpendSupply(MedicalSupplyType)`, `SpendAnySupply()` (lowest quality first), `AddSupply(MedicalSupplyItem)` — all return new instances. Query methods: `GetTotalSupplyCount()`, `GetCountByType()`, `HasSupply()`, `CanCarryMore()`, `GetHighestQualitySupply()`. Display: `GetInventorySummary()`, `GetFormattedValue()`.
- **`FieldDressingResult`** — Healing outcome with full breakdown: dice roll (2d6), quality bonus, Steady Hands bonus, computed `TotalHealing`, HP before/after, supply consumed. Display methods: `GetHealingBreakdown()`, `GetStatusMessage()`.
- **`DiagnoseResult`** — Diagnostic report with computed `HpPercentage`, `IsBloodied` (≤50%), wound severity classification, status effects, vulnerabilities, and resistances. Display methods: `GetHealthDescription()`, `GetStatusSummary()`, `GetFormattedOutput()` (multi-line).

### Application Layer — Interfaces

- **`IBoneSetterMedicalSuppliesService`** — Supply management contract with 10 methods: `InitializeSupplies`, `GetSupplies`, `ValidateSupplyAvailability` (2 overloads), `SpendSupply` (2 overloads), `AddSupply`, `CalculateQualityBonus`, `GetHighestQualitySupply` (2 overloads)
- **`IBoneSetterAbilityService`** — Ability execution contract with Tier 1 methods: `ExecuteFieldDressing` (active heal), `ExecuteDiagnose` (information). Utility methods: `GetAbilityReadiness`, `CanUnlockTier2/3/Capstone`, `GetPPInvested`

### Application Layer — Services

- **`BoneSetterMedicalSuppliesService`** — Supply management implementation:
  - Immutable inventory operations with `Player.SetMedicalSupplies()` reference swap
  - `SpendSupply()`: lowest quality first via `SpendAnySupply()`, or by specific type
  - `AddSupply()`: capacity validation before adding
  - `CalculateQualityBonus()`: delegates to `MedicalSupplyItem.GetHealingBonus()`
  - Exhaustive logging: LogInformation for all successful operations, LogWarning for all failures
- **`BoneSetterAbilityService`** — Ability execution implementation:
  - Guard-clause chain: null → spec → ability unlocked → AP → supply → execute (no Corruption step)
  - Field Dressing: 2 AP + 1 supply, rolls 2d6 + quality bonus + Steady Hands, healing capped at max HP
  - Diagnose: 1 AP (no supply), classifies wound severity from HP percentage thresholds
  - Steady Hands: passive +2 bonus checked inline via `HasBoneSetterAbilityUnlocked(SteadyHands)`
  - `internal virtual int Roll2D6()` for deterministic test overriding
  - `private static WoundSeverity ClassifyWoundSeverity(int, int)` with 6 threshold ranges
  - `GetAbilityReadiness`: Field Dressing checks AP + supplies, Diagnose checks AP, SteadyHands always ready
  - 8 constants: FieldDressingApCost, FieldDressingSupplyCost, DiagnoseApCost, SteadyHandsHealingBonus, Tier2/3/CapstonePpRequirement, wound severity thresholds

### Entity Extensions

- **`Player.cs`** — Bone-Setter section added after Berserkr section:
  - `MedicalSuppliesResource? MedicalSupplies` — Nullable immutable supply resource
  - `HashSet<BoneSetterAbilityId> _unlockedBoneSetterAbilities` — Private backing set
  - `UnlockedBoneSetterAbilities` — Read-only collection accessor
  - `InitializeMedicalSupplies()` — 2 overloads (empty / with supplies and capacity)
  - `SetMedicalSupplies(MedicalSuppliesResource)` — Swaps immutable reference after spend/add
  - `HasBoneSetterAbilityUnlocked(BoneSetterAbilityId)` — Ability check
  - `UnlockBoneSetterAbility(BoneSetterAbilityId)` — Ability unlock
  - `GetBoneSetterPPInvested()` — PP calculation: T1=0, T2=4, T3=5, Capstone=6

### Configuration

- Updated `config/specializations.json` with bone-setter entry:
  - Adept archetype, Coherent path
  - Special resource: medical-supplies (max 10, start 5, quality 1-5, acquisition-based)
  - 4 tiers: Foundation (3), Discipline (3), Mastery (2), Capstone (1) = 9 abilities total
- Updated `config/abilities.json` with 3 Tier 1 abilities:
  - `field-dressing`: Active heal, 2 AP + 1 supply, 2d6 + quality bonus, Steady Hands interaction
  - `diagnose`: Active info, 1 AP (no supply), reveals HP/severity/effects/vulnerabilities/resistances
  - `steady-hands`: Passive, +2 to all healing roll totals

### Unit Tests

- **`MedicalSuppliesResourceTests`** — 19 domain tests: factory (empty, with supplies, custom capacity, exceeding capacity, zero capacity), AddSupply (within capacity, at capacity throws), SpendSupply (by type removes item, type unavailable throws), SpendAnySupply (lowest quality first, empty throws), query (HasSupply, CanCarryMore below/at capacity, GetHighestQualitySupply by type/not present), display (GetInventorySummary mixed/empty, GetFormattedValue)
- **`BoneSetterAbilityServiceTests`** — 16 application tests: Field Dressing (valid prereqs, Steady Hands bonus, capped at max HP, insufficient AP, no supplies, wrong spec, ability not unlocked), Diagnose (valid prereqs, insufficient AP, wound severity classification across all 6 levels), GetAbilityReadiness (Field Dressing ready, SteadyHands always ready, non-Bone-Setter empty), PP investment (Tier 1 returns zero, CanUnlockTier2 insufficient PP, CanUnlockTier2 wrong spec)

## Design Decisions

- **Immutable resource model**: Unlike `RageResource` which uses mutable in-place updates (`Gain()`, `Spend()`), `MedicalSuppliesResource` is fully immutable — all modification operations (`SpendSupply`, `AddSupply`) return new instances. The `Player.SetMedicalSupplies()` method swaps the reference. This ensures thread safety and simplifies state management for a consumable inventory.
- **No Corruption path**: The Bone-Setter is the first Coherent specialization — no Corruption service dependency, no risk evaluation step in the guard-clause chain. This is an intentional simplification, not an oversight.
- **Lowest quality first**: `SpendAnySupply()` consumes the lowest-quality supply first to preserve higher-quality items for critical healing situations. This matches real-world triage behavior.
- **Steady Hands inline check**: Rather than a separate passive processing method (like Berserkr's `CheckPainIsFuel`), Steady Hands is checked inline via `player.HasBoneSetterAbilityUnlocked(SteadyHands)` during Field Dressing execution. This is simpler because the bonus is always additive and doesn't require complex state tracking.
- **Target data as parameters**: Healing target HP and status information are passed as method parameters rather than loaded from a repository, matching the Berserkr pattern and keeping services pure.
- **Wound severity thresholds**: Implemented as `private const float` values in the service rather than on the enum itself, following the convention that enums are pure identifiers while services contain business logic.

## Test Results

```
Bone-Setter tests: 35
     Passed: 35
     Failed: 0

Breakdown:
  MedicalSuppliesResourceTests:       19 domain tests
  BoneSetterAbilityServiceTests:      16 application tests
```
