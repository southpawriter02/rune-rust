# v0.8.2b Design Specification: Dialogue Window

**Version:** 0.8.2b
**Parent:** v0.8.2 (Interaction Windows)
**Prerequisites:** v0.8.2a Complete (Shop Window)
**Status:** Design Complete
**Estimated Unit Tests:** ~13

---

## Table of Contents

1. [Overview](#1-overview)
2. [Feature Overview](#2-feature-overview)
3. [Architecture](#3-architecture)
4. [Dialogue Window](#4-dialogue-window)
5. [Dialogue Choice Control](#5-dialogue-choice-control)
6. [Typing Animation](#6-typing-animation)
7. [View Models](#7-view-models)
8. [Dialogue Navigation](#8-dialogue-navigation)
9. [Action Handling](#9-action-handling)
10. [Styles](#10-styles)
11. [Data Model Changes](#11-data-model-changes)
12. [Logging Specifications](#12-logging-specifications)
13. [Unit Testing Requirements](#13-unit-testing-requirements)
14. [Use Cases](#14-use-cases)
15. [Deliverable Checklist](#15-deliverable-checklist)
16. [Acceptance Criteria](#16-acceptance-criteria)
17. [Dependencies](#17-dependencies)
18. [Future Considerations](#18-future-considerations)

---

## 1. Overview

### Purpose

Implement a dialogue window for NPC conversations featuring NPC portrait display, typed text animation (typewriter effect), and clickable response choices that branch the conversation. The window supports quest acceptance, shop triggers, and other dialogue outcomes. Players can click to skip typing animation, and responses can be selected by clicking or pressing number keys (1-9).

### Key Deliverables

| Category | Items |
|----------|-------|
| **Windows** | `DialogueWindow` |
| **ViewModels** | `DialogueWindowViewModel`, `DialogueChoiceViewModel` |
| **Controls** | `DialogueChoiceControl` |
| **Animations** | Typing animation system |
| **Styles** | `DialogueWindowStyles.axaml` |
| **Tests** | ~13 unit tests |

### Design Principles

1. **Immersive Text**: Typewriter animation brings NPC speech to life
2. **Skip-Friendly**: Click or keypress skips to full text
3. **Clear Choices**: Numbered responses with action badges
4. **Branching Support**: Navigate dialogue tree seamlessly
5. **Action Integration**: Trigger quests, shops, and other systems

---

## 2. Feature Overview

```
v0.8.2b Features
├── DialogueWindow (Modal)
│   ├── NPC portrait display
│   ├── NPC name header
│   ├── Dialogue text area
│   ├── Typing animation
│   ├── Response choices panel
│   └── Auto-close on end
│
├── Typing Animation System
│   ├── Character-by-character reveal
│   ├── Configurable speed (~33 chars/sec)
│   ├── Click to skip to full text
│   ├── Cursor indicator (█) while typing
│   └── "[Click to continue...]" prompt
│
├── DialogueChoiceControl
│   ├── Choice number (1-9)
│   ├── Choice text
│   ├── Action badge ([ACCEPT QUEST], [SHOP], [LEAVE])
│   ├── Hover highlighting
│   └── Click selection
│
├── DialogueWindowViewModel
│   ├── Current node tracking
│   ├── NPC portrait/name binding
│   ├── Displayed text (animated)
│   ├── Full text reference
│   ├── Is typing state
│   ├── Choices collection
│   ├── Typing speed setting
│   ├── ClickText command (skip/advance)
│   └── SelectChoice command
│
├── DialogueChoiceViewModel
│   ├── Choice index (1-9)
│   ├── Display text
│   ├── Action type (Quest, Shop, Leave, etc.)
│   ├── Action data (QuestId, ShopId, etc.)
│   ├── Next node reference
│   └── Action badge text
│
├── Dialogue Actions
│   ├── AcceptQuest → IQuestService.AcceptQuest()
│   ├── DeclineQuest → Continue dialogue
│   ├── OpenShop → Show ShopWindow (v0.8.2a)
│   ├── Leave → Close dialogue
│   ├── GiveItem → Add item to player
│   └── TakeItem → Remove item from player
│
├── Branching Navigation
│   ├── Choice → NextNodeId
│   ├── Auto-advance (no choices)
│   ├── Conditional choices
│   └── End node handling
│
└── Keyboard Support
    ├── 1-9 keys select choices
    ├── Space/Enter skips typing
    └── Escape closes dialogue
```

---

## 3. Architecture

### Component Diagram

```
┌─────────────────────────────────────────────────────────────────────────┐
│                       PRESENTATION LAYER                                │
├─────────────────────────────────────────────────────────────────────────┤
│  Windows                                                                │
│  └── DialogueWindow : Window                                           │
│       ├── NPC Portrait (Image)                                         │
│       ├── NPC Name (TextBlock)                                         │
│       ├── Dialogue Text Panel (TextBlock + typing)                     │
│       ├── Typing Indicator ("[Click to skip...]")                      │
│       └── Choices Panel (ItemsControl)                                 │
│                                                                         │
│  Controls                                                               │
│  └── DialogueChoiceControl : TemplatedControl                          │
│       ├── int Index (1-9)                                              │
│       ├── string Text                                                  │
│       ├── string? ActionBadge                                          │
│       ├── bool IsHovered                                               │
│       └── event Clicked                                                │
│                                                                         │
│  ViewModels                                                             │
│  ├── DialogueWindowViewModel : ViewModelBase                           │
│  │    ├── string NpcName                                               │
│  │    ├── IImage? NpcPortrait                                          │
│  │    ├── string DisplayedText (animated)                              │
│  │    ├── string FullText                                              │
│  │    ├── bool IsTyping                                                │
│  │    ├── bool HasChoices                                              │
│  │    ├── ObservableCollection<DialogueChoiceViewModel> Choices        │
│  │    ├── int TypingSpeedMs (default 30)                               │
│  │    ├── [RelayCommand] ClickText()                                   │
│  │    ├── [RelayCommand] SelectChoice(choice)                          │
│  │    ├── [RelayCommand] HandleKeyPress(key)                           │
│  │    ├── Task StartDialogueAsync(Npc)                                 │
│  │    └── event RequestClose                                           │
│  │                                                                     │
│  └── DialogueChoiceViewModel : ViewModelBase                           │
│       ├── int Index                                                    │
│       ├── string Text                                                  │
│       ├── DialogueAction Action                                        │
│       ├── string? QuestId                                              │
│       ├── string? ShopId                                               │
│       ├── string? NextNodeId                                           │
│       ├── string DisplayText ("1. Choice text")                        │
│       ├── string? ActionBadge ("[ACCEPT QUEST]")                       │
│       └── bool HasActionBadge                                          │
└────────────────────────────────────────────────────────────────────────┘
                                     │
                                     ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                       APPLICATION LAYER                                 │
├─────────────────────────────────────────────────────────────────────────┤
│  Services                                                               │
│  ├── IDialogueService                                                  │
│  │    ├── StartDialogue(Npc): Dialogue                                 │
│  │    ├── GetNode(nodeId): DialogueNode                                │
│  │    ├── IsChoiceAvailable(choice): bool                              │
│  │    └── EndDialogue()                                                │
│  │                                                                     │
│  ├── IQuestService                                                     │
│  │    └── AcceptQuest(questId)                                         │
│  │                                                                     │
│  └── INavigationService                                                │
│       ├── ShowDialog<ShopWindow>(shopId)                               │
│       └── CloseDialog()                                                │
└─────────────────────────────────────────────────────────────────────────┘
                                     │
                                     ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                         DOMAIN LAYER                                    │
├─────────────────────────────────────────────────────────────────────────┤
│  Entities                                                               │
│  ├── Dialogue                                                          │
│  │    ├── Guid Id                                                      │
│  │    ├── DialogueNode StartNode                                       │
│  │    └── IReadOnlyDictionary<string, DialogueNode> Nodes              │
│  │                                                                     │
│  ├── DialogueNode                                                      │
│  │    ├── string Id                                                    │
│  │    ├── string Text                                                  │
│  │    ├── IReadOnlyList<DialogueChoice> Choices                        │
│  │    └── string? AutoAdvanceNodeId                                    │
│  │                                                                     │
│  ├── DialogueChoice                                                    │
│  │    ├── string Text                                                  │
│  │    ├── string? NextNodeId                                           │
│  │    ├── DialogueAction Action                                        │
│  │    ├── string? ActionData (QuestId, ShopId, etc.)                   │
│  │    └── Func<Player, bool>? Condition                                │
│  │                                                                     │
│  └── Npc                                                               │
│       ├── Guid Id                                                      │
│       ├── string Name                                                  │
│       ├── string PortraitPath                                          │
│       └── Dialogue? Dialogue                                           │
│                                                                         │
│  Enums                                                                  │
│  └── DialogueAction                                                    │
│       ├── None                                                         │
│       ├── AcceptQuest                                                  │
│       ├── DeclineQuest                                                 │
│       ├── OpenShop                                                     │
│       ├── Leave                                                        │
│       ├── GiveItem                                                     │
│       └── TakeItem                                                     │
└─────────────────────────────────────────────────────────────────────────┘
```

### Dialogue Flow

```
┌─────────────────────────────────────────────────────────────────────────┐
│                        DIALOGUE CONVERSATION FLOW                       │
└─────────────────────────────────────────────────────────────────────────┘

    Player Interacts with NPC
                        │
                        ▼
┌────────────────────────────────────────────────────────────────────────┐
│              DialogueWindow.StartDialogueAsync(npc)                    │
├────────────────────────────────────────────────────────────────────────┤
│  1. Set NpcName, NpcPortrait                                           │
│  2. Get Dialogue from IDialogueService.StartDialogue(npc)              │
│  3. Navigate to StartNode                                              │
│  4. Call ShowNodeAsync(StartNode)                                      │
└────────────────────────────────────────────────────────────────────────┘
                        │
                        ▼
┌────────────────────────────────────────────────────────────────────────┐
│                    ShowNodeAsync(node)                                 │
├────────────────────────────────────────────────────────────────────────┤
│  1. Set FullText = node.Text                                           │
│  2. Clear DisplayedText                                                │
│  3. Clear Choices                                                      │
│  4. Start TypeTextAsync(node.Text)                                     │
│     → Reveal characters one-by-one                                     │
│     → Show cursor (█) at end                                           │
│  5. When complete: ShowChoices()                                       │
└────────────────────────────────────────────────────────────────────────┘
                        │
         ┌──────────────┴──────────────┐
         ▼                             ▼
    [Has Choices]               [No Choices]
         │                             │
         ▼                             ▼
┌─────────────────────┐    ┌─────────────────────────────┐
│  ShowChoices()      │    │  Show "[Click to continue]" │
│  - Build choice VMs │    │  Wait for click/key         │
│  - Number 1-9       │    │  Auto-advance to next node  │
│  - Show action badges│    └─────────────────────────────┘
└─────────────────────┘
         │
         ▼ (Player clicks choice or presses 1-9)
┌────────────────────────────────────────────────────────────────────────┐
│              SelectChoiceAsync(choice)                                 │
├────────────────────────────────────────────────────────────────────────┤
│  1. Handle action:                                                     │
│     - AcceptQuest → IQuestService.AcceptQuest(questId)                 │
│     - OpenShop → INavigationService.ShowDialog<ShopWindow>()           │
│     - Leave → Close dialogue                                           │
│                                                                        │
│  2. If choice.NextNodeId is not null:                                  │
│     → Navigate to next node                                            │
│     → Call ShowNodeAsync(nextNode)                                     │
│                                                                        │
│  3. Else:                                                              │
│     → End dialogue (close window)                                      │
└────────────────────────────────────────────────────────────────────────┘
```

---

## 4. Dialogue Window

### DialogueWindow.axaml

**File:** `src/Presentation/RuneAndRust.Avalonia/Views/DialogueWindow.axaml`

```xml
<Window xmlns="https://github.com/avaloniaui"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:vm="using:RuneAndRust.Avalonia.ViewModels"
        xmlns:controls="using:RuneAndRust.Avalonia.Controls"
        x:Class="RuneAndRust.Avalonia.Views.DialogueWindow"
        x:DataType="vm:DialogueWindowViewModel"
        Title="Dialogue"
        Width="700" Height="500"
        WindowStartupLocation="CenterOwner"
        CanResize="False"
        ShowInTaskbar="False"
        KeyDown="OnKeyDown">
    
    <Grid RowDefinitions="*,Auto">
        
        <!-- Main Dialogue Area -->
        <Border Grid.Row="0" Classes="dialogue-main" Padding="20">
            <Grid ColumnDefinitions="Auto,*">
                
                <!-- NPC Portrait -->
                <Border Grid.Column="0" 
                        Classes="portrait-frame"
                        Width="120" Height="120"
                        Margin="0,0,20,0"
                        VerticalAlignment="Top">
                    <Panel>
                        <!-- Portrait Image -->
                        <Image Source="{Binding NpcPortrait}"
                               Stretch="UniformToFill"
                               IsVisible="{Binding NpcPortrait, Converter={x:Static ObjectConverters.IsNotNull}}" />
                        
                        <!-- Fallback Icon -->
                        <TextBlock Text="☺"
                                   FontSize="48"
                                   HorizontalAlignment="Center"
                                   VerticalAlignment="Center"
                                   IsVisible="{Binding NpcPortrait, Converter={x:Static ObjectConverters.IsNull}}" />
                    </Panel>
                </Border>
                
                <!-- Dialogue Content -->
                <StackPanel Grid.Column="1">
                    
                    <!-- NPC Name -->
                    <TextBlock Text="{Binding NpcName}" 
                               Classes="npc-name" 
                               Margin="0,0,0,4" />
                    
                    <Border Classes="name-separator" Margin="0,0,0,12" />
                    
                    <!-- Dialogue Text (clickable area) -->
                    <Border Classes="dialogue-text-area"
                            Padding="0"
                            PointerPressed="OnDialogueTextPressed"
                            Cursor="Hand">
                        <StackPanel>
                            <!-- Animated Text with Cursor -->
                            <TextBlock Classes="dialogue-text" TextWrapping="Wrap">
                                <Run Text="{Binding DisplayedText}" />
                                <Run Text="█" 
                                     Classes="typing-cursor"
                                     IsVisible="{Binding IsTyping}" />
                            </TextBlock>
                            
                            <!-- Skip/Continue Hint -->
                            <TextBlock Classes="dialogue-hint"
                                       Margin="0,12,0,0"
                                       HorizontalAlignment="Right">
                                <TextBlock.Text>
                                    <MultiBinding StringFormat="{}{0}">
                                        <Binding Path="IsTyping" 
                                                 Converter="{StaticResource BoolToTextConverter}"
                                                 ConverterParameter="[Click to skip...]|[Click to continue...]" />
                                    </MultiBinding>
                                </TextBlock.Text>
                                <TextBlock.IsVisible>
                                    <MultiBinding Converter="{x:Static BoolConverters.Or}">
                                        <Binding Path="IsTyping" />
                                        <Binding Path="!HasChoices" />
                                    </MultiBinding>
                                </TextBlock.IsVisible>
                            </TextBlock>
                        </StackPanel>
                    </Border>
                    
                </StackPanel>
            </Grid>
        </Border>
        
        <!-- Response Choices -->
        <Border Grid.Row="1" 
                Classes="choices-panel"
                Padding="20,12"
                IsVisible="{Binding HasChoices}">
            <ItemsControl ItemsSource="{Binding Choices}">
                <ItemsControl.ItemTemplate>
                    <DataTemplate DataType="vm:DialogueChoiceViewModel">
                        <controls:DialogueChoiceControl
                            Index="{Binding Index}"
                            Text="{Binding Text}"
                            ActionBadge="{Binding ActionBadge}"
                            PointerPressed="OnChoicePressed" />
                    </DataTemplate>
                </ItemsControl.ItemTemplate>
            </ItemsControl>
        </Border>
        
    </Grid>
</Window>
```

### DialogueWindow Code-Behind

**File:** `src/Presentation/RuneAndRust.Avalonia/Views/DialogueWindow.axaml.cs`

```csharp
namespace RuneAndRust.Avalonia.Views;

public partial class DialogueWindow : Window
{
    public DialogueWindow()
    {
        InitializeComponent();
    }

    private void OnDialogueTextPressed(object? sender, PointerPressedEventArgs e)
    {
        if (DataContext is DialogueWindowViewModel vm)
        {
            vm.ClickTextCommand.Execute(null);
        }
    }

    private void OnChoicePressed(object? sender, PointerPressedEventArgs e)
    {
        if (sender is DialogueChoiceControl control &&
            DataContext is DialogueWindowViewModel vm &&
            control.DataContext is DialogueChoiceViewModel choice)
        {
            vm.SelectChoiceCommand.Execute(choice);
        }
    }

    private void OnKeyDown(object? sender, KeyEventArgs e)
    {
        if (DataContext is not DialogueWindowViewModel vm) return;

        // Number keys 1-9 select choices
        if (e.Key >= Key.D1 && e.Key <= Key.D9)
        {
            var index = e.Key - Key.D1 + 1;
            var choice = vm.Choices.FirstOrDefault(c => c.Index == index);
            if (choice is not null)
            {
                vm.SelectChoiceCommand.Execute(choice);
                e.Handled = true;
            }
        }
        // NumPad 1-9
        else if (e.Key >= Key.NumPad1 && e.Key <= Key.NumPad9)
        {
            var index = e.Key - Key.NumPad1 + 1;
            var choice = vm.Choices.FirstOrDefault(c => c.Index == index);
            if (choice is not null)
            {
                vm.SelectChoiceCommand.Execute(choice);
                e.Handled = true;
            }
        }
        // Space or Enter to skip/continue
        else if (e.Key == Key.Space || e.Key == Key.Enter)
        {
            vm.ClickTextCommand.Execute(null);
            e.Handled = true;
        }
        // Escape to close
        else if (e.Key == Key.Escape)
        {
            Close();
            e.Handled = true;
        }
    }
}
```

---

## 5. Dialogue Choice Control

### DialogueChoiceControl

**File:** `src/Presentation/RuneAndRust.Avalonia/Controls/DialogueChoiceControl.cs`

```csharp
namespace RuneAndRust.Avalonia.Controls;

/// <summary>
/// Displays a dialogue response choice.
/// </summary>
/// <remarks>
/// Shows numbered choice with optional action badge.
/// Supports hover highlighting and click selection.
/// </remarks>
public class DialogueChoiceControl : TemplatedControl
{
    public static readonly StyledProperty<int> IndexProperty =
        AvaloniaProperty.Register<DialogueChoiceControl, int>(nameof(Index), 1);

    public static readonly StyledProperty<string> TextProperty =
        AvaloniaProperty.Register<DialogueChoiceControl, string>(nameof(Text), "");

    public static readonly StyledProperty<string?> ActionBadgeProperty =
        AvaloniaProperty.Register<DialogueChoiceControl, string?>(nameof(ActionBadge));

    /// <summary>
    /// Gets or sets the choice number (1-9).
    /// </summary>
    public int Index
    {
        get => GetValue(IndexProperty);
        set => SetValue(IndexProperty, value);
    }

    /// <summary>
    /// Gets or sets the choice text.
    /// </summary>
    public string Text
    {
        get => GetValue(TextProperty);
        set => SetValue(TextProperty, value);
    }

    /// <summary>
    /// Gets or sets the action badge text (e.g., "[ACCEPT QUEST]").
    /// </summary>
    public string? ActionBadge
    {
        get => GetValue(ActionBadgeProperty);
        set => SetValue(ActionBadgeProperty, value);
    }

    /// <summary>
    /// Gets whether the choice has an action badge.
    /// </summary>
    public bool HasActionBadge => !string.IsNullOrEmpty(ActionBadge);

    /// <summary>
    /// Gets the formatted display text.
    /// </summary>
    public string DisplayText => $"{Index}. \"{Text}\"";
}
```

### DialogueChoiceControl Template

**File:** `src/Presentation/RuneAndRust.Avalonia/Controls/DialogueChoiceControl.axaml`

```xml
<ResourceDictionary xmlns="https://github.com/avaloniaui"
                    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
                    xmlns:controls="using:RuneAndRust.Avalonia.Controls">
    
    <ControlTheme x:Key="{x:Type controls:DialogueChoiceControl}" 
                  TargetType="controls:DialogueChoiceControl">
        
        <Setter Property="Cursor" Value="Hand" />
        <Setter Property="Margin" Value="0,4" />
        
        <Setter Property="Template">
            <ControlTemplate>
                <Border x:Name="ChoiceBorder"
                        Padding="12,8"
                        CornerRadius="4"
                        Background="{StaticResource SurfaceBrush}"
                        BorderThickness="1"
                        BorderBrush="{StaticResource BorderBrush}">
                    <Grid ColumnDefinitions="*,Auto">
                        
                        <!-- Choice Text -->
                        <TextBlock Grid.Column="0"
                                   Text="{TemplateBinding DisplayText}"
                                   Classes="choice-text"
                                   TextWrapping="Wrap" />
                        
                        <!-- Action Badge -->
                        <Border Grid.Column="1"
                                Classes="action-badge"
                                IsVisible="{TemplateBinding HasActionBadge}"
                                Margin="12,0,0,0"
                                Padding="8,4"
                                CornerRadius="3">
                            <TextBlock Text="{TemplateBinding ActionBadge}"
                                       Classes="action-badge-text" />
                        </Border>
                        
                    </Grid>
                </Border>
            </ControlTemplate>
        </Setter>
        
        <!-- Hover Style -->
        <Style Selector="^:pointerover /template/ Border#ChoiceBorder">
            <Setter Property="Background" Value="{StaticResource HoverBackgroundBrush}" />
            <Setter Property="BorderBrush" Value="{StaticResource AccentBrush}" />
        </Style>
        
    </ControlTheme>
    
</ResourceDictionary>
```

---

## 6. Typing Animation

### Typing Animation System

The typing animation is implemented within the `DialogueWindowViewModel` using async/await and a cancellation token for skip functionality.

```csharp
/// <summary>
/// Types out text character-by-character.
/// </summary>
/// <param name="text">The full text to type.</param>
/// <returns>Task that completes when typing finishes or is cancelled.</returns>
private async Task TypeTextAsync(string text)
{
    IsTyping = true;
    _typingCts = new CancellationTokenSource();
    
    try
    {
        for (int i = 0; i <= text.Length; i++)
        {
            DisplayedText = text[..i];
            await Task.Delay(TypingSpeedMs, _typingCts.Token);
        }
    }
    catch (TaskCanceledException)
    {
        // Typing was skipped - show full text
        DisplayedText = FullText;
    }
    
    IsTyping = false;
}

/// <summary>
/// Skips typing animation or advances to next node.
/// </summary>
private async Task ClickTextAsync()
{
    if (IsTyping)
    {
        // Skip to full text
        _typingCts?.Cancel();
        DisplayedText = FullText;
        IsTyping = false;
        ShowChoices();
    }
    else if (!HasChoices && _currentNode.AutoAdvanceNodeId is not null)
    {
        // Auto-advance to next node
        var nextNode = _dialogueService.GetNode(_currentNode.AutoAdvanceNodeId);
        await ShowNodeAsync(nextNode);
    }
}
```

### Typing Animation Timing

| Setting | Value | Description |
|---------|-------|-------------|
| Default Speed | 30ms/char | ~33 characters per second |
| Fast Speed | 15ms/char | ~67 characters per second |
| Slow Speed | 50ms/char | ~20 characters per second |

---

## 7. View Models

### DialogueWindowViewModel

**File:** `src/Presentation/RuneAndRust.Avalonia/ViewModels/DialogueWindowViewModel.cs`

```csharp
namespace RuneAndRust.Avalonia.ViewModels;

/// <summary>
/// ViewModel for the dialogue window.
/// </summary>
/// <remarks>
/// Manages NPC dialogue display, typing animation, choice selection,
/// and dialogue action execution.
/// </remarks>
public partial class DialogueWindowViewModel : ViewModelBase
{
    private readonly IDialogueService _dialogueService;
    private readonly IQuestService _questService;
    private readonly INavigationService _navigation;
    private readonly ILogger<DialogueWindowViewModel> _logger;
    
    private DialogueNode _currentNode = null!;
    private CancellationTokenSource? _typingCts;

    [ObservableProperty]
    private string _npcName = "";

    [ObservableProperty]
    private IImage? _npcPortrait;

    [ObservableProperty]
    private string _displayedText = "";

    [ObservableProperty]
    private string _fullText = "";

    [ObservableProperty]
    private bool _isTyping;

    [ObservableProperty]
    private ObservableCollection<DialogueChoiceViewModel> _choices = new();

    [ObservableProperty]
    private bool _hasChoices;

    [ObservableProperty]
    private int _typingSpeedMs = 30;

    /// <summary>
    /// Event raised when the dialogue should close.
    /// </summary>
    public event Action? RequestClose;

    public DialogueWindowViewModel(
        IDialogueService dialogueService,
        IQuestService questService,
        INavigationService navigation,
        ILogger<DialogueWindowViewModel> logger)
    {
        _dialogueService = dialogueService;
        _questService = questService;
        _navigation = navigation;
        _logger = logger;
    }

    /// <summary>
    /// Starts a dialogue with an NPC.
    /// </summary>
    public async Task StartDialogueAsync(Npc npc)
    {
        ArgumentNullException.ThrowIfNull(npc);

        NpcName = npc.Name;
        NpcPortrait = LoadPortrait(npc.PortraitPath);

        var dialogue = _dialogueService.StartDialogue(npc);
        _currentNode = dialogue.StartNode;

        _logger.LogDebug("Starting dialogue with {NpcName}", npc.Name);

        await ShowNodeAsync(_currentNode);
    }

    /// <summary>
    /// Handles click on dialogue text area.
    /// </summary>
    [RelayCommand]
    private async Task ClickTextAsync()
    {
        if (IsTyping)
        {
            // Skip to full text
            _typingCts?.Cancel();
            DisplayedText = FullText;
            IsTyping = false;
            ShowChoices();

            _logger.LogDebug("Skipped typing animation");
        }
        else if (!HasChoices && _currentNode.AutoAdvanceNodeId is not null)
        {
            // Auto-advance to next node
            var nextNode = _dialogueService.GetNode(_currentNode.AutoAdvanceNodeId);
            await AdvanceToNodeAsync(nextNode);
        }
    }

    /// <summary>
    /// Handles selection of a dialogue choice.
    /// </summary>
    [RelayCommand]
    private async Task SelectChoiceAsync(DialogueChoiceViewModel choice)
    {
        ArgumentNullException.ThrowIfNull(choice);

        _logger.LogDebug("Selected choice {Index}: {Text}", choice.Index, choice.Text);

        // Handle special actions
        await ExecuteDialogueAction(choice);

        // Navigate to next node or end dialogue
        if (choice.NextNodeId is not null)
        {
            var nextNode = _dialogueService.GetNode(choice.NextNodeId);
            await AdvanceToNodeAsync(nextNode);
        }
        else
        {
            CloseDialogue();
        }
    }

    private async Task ShowNodeAsync(DialogueNode node)
    {
        _currentNode = node;
        FullText = node.Text;
        DisplayedText = "";
        HasChoices = false;
        Choices.Clear();

        _logger.LogDebug("Showing node: {NodeId}", node.Id);

        await TypeTextAsync(node.Text);
        ShowChoices();
    }

    private async Task AdvanceToNodeAsync(DialogueNode node)
    {
        await ShowNodeAsync(node);
    }

    private async Task TypeTextAsync(string text)
    {
        IsTyping = true;
        _typingCts = new CancellationTokenSource();

        try
        {
            for (int i = 0; i <= text.Length; i++)
            {
                DisplayedText = text[..i];
                await Task.Delay(TypingSpeedMs, _typingCts.Token);
            }
        }
        catch (TaskCanceledException)
        {
            // Typing was skipped
            DisplayedText = FullText;
        }

        IsTyping = false;
    }

    private void ShowChoices()
    {
        Choices.Clear();

        int index = 1;
        foreach (var choice in _currentNode.Choices)
        {
            if (_dialogueService.IsChoiceAvailable(choice))
            {
                Choices.Add(new DialogueChoiceViewModel(choice, index++));
            }
        }

        HasChoices = Choices.Count > 0;

        _logger.LogDebug("Showing {Count} choices", Choices.Count);
    }

    private async Task ExecuteDialogueAction(DialogueChoiceViewModel choice)
    {
        switch (choice.Action)
        {
            case DialogueAction.AcceptQuest when choice.QuestId is not null:
                _questService.AcceptQuest(choice.QuestId);
                _logger.LogInformation("Accepted quest: {QuestId}", choice.QuestId);
                break;

            case DialogueAction.DeclineQuest:
                _logger.LogDebug("Declined quest");
                break;

            case DialogueAction.OpenShop when choice.ShopId is not null:
                _navigation.ShowDialog<ShopWindow>(choice.ShopId);
                _logger.LogDebug("Opening shop: {ShopId}", choice.ShopId);
                break;

            case DialogueAction.Leave:
                CloseDialogue();
                return; // Exit early, don't navigate

            case DialogueAction.GiveItem when choice.ItemId is not null:
                // TODO: Implement item giving
                _logger.LogDebug("Giving item: {ItemId}", choice.ItemId);
                break;

            case DialogueAction.TakeItem when choice.ItemId is not null:
                // TODO: Implement item taking
                _logger.LogDebug("Taking item: {ItemId}", choice.ItemId);
                break;
        }
    }

    private void CloseDialogue()
    {
        _dialogueService.EndDialogue();
        RequestClose?.Invoke();

        _logger.LogDebug("Dialogue ended with {NpcName}", NpcName);
    }

    private IImage? LoadPortrait(string? portraitPath)
    {
        if (string.IsNullOrEmpty(portraitPath)) return null;

        try
        {
            // Load portrait from assets
            return new Bitmap(portraitPath);
        }
        catch (Exception ex)
        {
            _logger.LogWarning(ex, "Failed to load portrait: {Path}", portraitPath);
            return null;
        }
    }
}
```

### DialogueChoiceViewModel

**File:** `src/Presentation/RuneAndRust.Avalonia/ViewModels/DialogueChoiceViewModel.cs`

```csharp
namespace RuneAndRust.Avalonia.ViewModels;

/// <summary>
/// ViewModel for a dialogue response choice.
/// </summary>
public class DialogueChoiceViewModel : ViewModelBase
{
    /// <summary>
    /// Gets the choice index (1-9).
    /// </summary>
    public int Index { get; }

    /// <summary>
    /// Gets the choice text.
    /// </summary>
    public string Text { get; }

    /// <summary>
    /// Gets the dialogue action type.
    /// </summary>
    public DialogueAction Action { get; }

    /// <summary>
    /// Gets the quest ID if action is AcceptQuest.
    /// </summary>
    public string? QuestId { get; }

    /// <summary>
    /// Gets the shop ID if action is OpenShop.
    /// </summary>
    public string? ShopId { get; }

    /// <summary>
    /// Gets the item ID if action is GiveItem or TakeItem.
    /// </summary>
    public string? ItemId { get; }

    /// <summary>
    /// Gets the next dialogue node ID.
    /// </summary>
    public string? NextNodeId { get; }

    /// <summary>
    /// Gets the formatted display text.
    /// </summary>
    public string DisplayText => $"{Index}. \"{Text}\"";

    /// <summary>
    /// Gets the action badge text.
    /// </summary>
    public string? ActionBadge => Action switch
    {
        DialogueAction.AcceptQuest => "[ACCEPT QUEST]",
        DialogueAction.DeclineQuest => "[DECLINE]",
        DialogueAction.OpenShop => "[SHOP]",
        DialogueAction.Leave => "[LEAVE]",
        DialogueAction.GiveItem => "[RECEIVE ITEM]",
        DialogueAction.TakeItem => "[GIVE ITEM]",
        _ => null
    };

    /// <summary>
    /// Gets whether the choice has an action badge.
    /// </summary>
    public bool HasActionBadge => ActionBadge is not null;

    public DialogueChoiceViewModel(DialogueChoice choice, int index)
    {
        ArgumentNullException.ThrowIfNull(choice);

        Index = index;
        Text = choice.Text;
        Action = choice.Action;
        NextNodeId = choice.NextNodeId;

        // Parse action data based on action type
        switch (choice.Action)
        {
            case DialogueAction.AcceptQuest:
            case DialogueAction.DeclineQuest:
                QuestId = choice.ActionData;
                break;
            case DialogueAction.OpenShop:
                ShopId = choice.ActionData;
                break;
            case DialogueAction.GiveItem:
            case DialogueAction.TakeItem:
                ItemId = choice.ActionData;
                break;
        }
    }
}
```

---

## 8. Dialogue Navigation

### Dialogue Tree Structure

```
┌─────────────────────────────────────────────────────────────────────────┐
│                      DIALOGUE TREE EXAMPLE                              │
└─────────────────────────────────────────────────────────────────────────┘

    StartNode: "greeting"
          │
          ▼
    ┌───────────────────────────────────────────────────────────────────┐
    │ Node: "greeting"                                                  │
    │ Text: "Ah, a brave adventurer! I've been waiting for someone     │
    │        like you. The skeleton in the cave has been causing us    │
    │        trouble for too long."                                    │
    │                                                                   │
    │ Choices:                                                          │
    │   [1] "Tell me more." → next: "more_info"                        │
    │   [2] "What's in it for me?" → next: "reward_info"               │
    │   [3] "I'll take care of it." → action: AcceptQuest, next: "accepted" │
    │   [4] "Let me see your wares." → action: OpenShop               │
    │   [5] "Not interested." → action: Leave                          │
    └───────────────────────────────────────────────────────────────────┘
                │               │               │
                ▼               ▼               ▼
           ┌────────┐     ┌────────┐     ┌─────────┐
           │more_info│    │reward  │     │ accepted│
           │ Node   │     │ info   │     │  Node   │
           └────────┘     └────────┘     └─────────┘
                │               │               │
                └───────────────┴───────────────┘
                                │
                                ▼
                         (End or loop back)
```

### Conditional Choices

```csharp
public class DialogueChoice
{
    // ...
    
    /// <summary>
    /// Condition that must be true for this choice to appear.
    /// </summary>
    public Func<Player, bool>? Condition { get; }
}

// Usage in DialogueService
public bool IsChoiceAvailable(DialogueChoice choice)
{
    if (choice.Condition is null) return true;
    return choice.Condition(_gameSession.Player);
}

// Example conditions
new DialogueChoice("I have the key.", ...)
{
    Condition = player => player.Inventory.HasItem("ancient-key")
}

new DialogueChoice("I'm a warrior, I can help.", ...)
{
    Condition = player => player.Class.Id == "warrior"
}
```

---

## 9. Action Handling

### DialogueAction Enum

**File:** `src/Core/RuneAndRust.Domain/Enums/DialogueAction.cs`

```csharp
namespace RuneAndRust.Domain.Enums;

/// <summary>
/// Actions that can be triggered by dialogue choices.
/// </summary>
public enum DialogueAction
{
    /// <summary>
    /// No special action, just advance dialogue.
    /// </summary>
    None,

    /// <summary>
    /// Accept a quest. ActionData = QuestId.
    /// </summary>
    AcceptQuest,

    /// <summary>
    /// Decline a quest. ActionData = QuestId.
    /// </summary>
    DeclineQuest,

    /// <summary>
    /// Open a shop window. ActionData = ShopId.
    /// </summary>
    OpenShop,

    /// <summary>
    /// Leave/end the conversation.
    /// </summary>
    Leave,

    /// <summary>
    /// NPC gives item to player. ActionData = ItemId.
    /// </summary>
    GiveItem,

    /// <summary>
    /// NPC takes item from player. ActionData = ItemId.
    /// </summary>
    TakeItem
}
```

### Action Integration Table

| Action | Service | Method | Effect |
|--------|---------|--------|--------|
| `AcceptQuest` | `IQuestService` | `AcceptQuest(questId)` | Adds quest to player's log |
| `DeclineQuest` | — | — | Continues dialogue |
| `OpenShop` | `INavigationService` | `ShowDialog<ShopWindow>(shopId)` | Opens shop window |
| `Leave` | — | — | Closes dialogue window |
| `GiveItem` | `IInventoryService` | `AddItem(itemId)` | Adds item to player |
| `TakeItem` | `IInventoryService` | `RemoveItem(itemId)` | Removes item from player |

---

## 10. Styles

**File:** `src/Presentation/RuneAndRust.Avalonia/Styles/DialogueWindowStyles.axaml`

```xml
<Styles xmlns="https://github.com/avaloniaui"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml">
    
    <!-- Dialogue Main Area -->
    <Style Selector="Border.dialogue-main">
        <Setter Property="Background" Value="{StaticResource BackgroundBrush}" />
    </Style>
    
    <!-- Portrait Frame -->
    <Style Selector="Border.portrait-frame">
        <Setter Property="Background" Value="{StaticResource SurfaceDarkBrush}" />
        <Setter Property="BorderBrush" Value="{StaticResource BorderBrush}" />
        <Setter Property="BorderThickness" Value="2" />
        <Setter Property="CornerRadius" Value="4" />
    </Style>
    
    <!-- NPC Name -->
    <Style Selector="TextBlock.npc-name">
        <Setter Property="FontSize" Value="20" />
        <Setter Property="FontWeight" Value="Bold" />
        <Setter Property="Foreground" Value="{StaticResource PrimaryBrush}" />
    </Style>
    
    <!-- Name Separator -->
    <Style Selector="Border.name-separator">
        <Setter Property="Height" Value="2" />
        <Setter Property="Width" Value="200" />
        <Setter Property="HorizontalAlignment" Value="Left" />
        <Setter Property="Background" Value="{StaticResource PrimaryBrush}" />
    </Style>
    
    <!-- Dialogue Text Area -->
    <Style Selector="Border.dialogue-text-area">
        <Setter Property="MinHeight" Value="150" />
    </Style>
    
    <!-- Dialogue Text -->
    <Style Selector="TextBlock.dialogue-text">
        <Setter Property="FontSize" Value="16" />
        <Setter Property="LineHeight" Value="24" />
        <Setter Property="Foreground" Value="{StaticResource ForegroundBrush}" />
    </Style>
    
    <!-- Typing Cursor -->
    <Style Selector="Run.typing-cursor">
        <Setter Property="Foreground" Value="{StaticResource AccentBrush}" />
        <Style.Animations>
            <Animation Duration="0:0:0.5" IterationCount="INFINITE">
                <KeyFrame Cue="0%">
                    <Setter Property="Opacity" Value="1" />
                </KeyFrame>
                <KeyFrame Cue="50%">
                    <Setter Property="Opacity" Value="0" />
                </KeyFrame>
                <KeyFrame Cue="100%">
                    <Setter Property="Opacity" Value="1" />
                </KeyFrame>
            </Animation>
        </Style.Animations>
    </Style>
    
    <!-- Dialogue Hint -->
    <Style Selector="TextBlock.dialogue-hint">
        <Setter Property="FontSize" Value="12" />
        <Setter Property="Foreground" Value="{StaticResource MutedBrush}" />
        <Setter Property="FontStyle" Value="Italic" />
    </Style>
    
    <!-- Choices Panel -->
    <Style Selector="Border.choices-panel">
        <Setter Property="Background" Value="{StaticResource SurfaceDarkBrush}" />
        <Setter Property="BorderThickness" Value="0,1,0,0" />
        <Setter Property="BorderBrush" Value="{StaticResource BorderBrush}" />
    </Style>
    
    <!-- Choice Text -->
    <Style Selector="TextBlock.choice-text">
        <Setter Property="FontSize" Value="14" />
        <Setter Property="Foreground" Value="{StaticResource ForegroundBrush}" />
    </Style>
    
    <!-- Action Badge -->
    <Style Selector="Border.action-badge">
        <Setter Property="Background" Value="{StaticResource AccentBrush}" />
        <Setter Property="Opacity" Value="0.8" />
    </Style>
    
    <Style Selector="TextBlock.action-badge-text">
        <Setter Property="FontSize" Value="10" />
        <Setter Property="FontWeight" Value="Bold" />
        <Setter Property="Foreground" Value="White" />
    </Style>
    
    <!-- Action Badge Variants -->
    <Style Selector="Border.action-badge[Tag=AcceptQuest]">
        <Setter Property="Background" Value="{StaticResource SuccessBrush}" />
    </Style>
    
    <Style Selector="Border.action-badge[Tag=OpenShop]">
        <Setter Property="Background" Value="Gold" />
    </Style>
    
    <Style Selector="Border.action-badge[Tag=Leave]">
        <Setter Property="Background" Value="{StaticResource MutedBrush}" />
    </Style>
    
</Styles>
```

---

## 11. Data Model Changes

### New Types

| Type | Layer | Description |
|------|-------|-------------|
| `DialogueWindow` | Presentation | Dialogue window |
| `DialogueChoiceControl` | Presentation | Choice control |
| `DialogueWindowViewModel` | Presentation | Dialogue logic VM |
| `DialogueChoiceViewModel` | Presentation | Choice display VM |
| `DialogueAction` | Domain | Action enum |

### Extended Domain Types

| Type | Extension | Description |
|------|-----------|-------------|
| `DialogueChoice` | `ActionData` | Payload for action (questId, shopId, etc.) |
| `DialogueNode` | `AutoAdvanceNodeId` | For nodes without choices |

---

## 12. Logging Specifications

| Component | Level | Events |
|-----------|-------|--------|
| `DialogueWindowViewModel` | Debug | Dialogue started, node shown |
| `DialogueWindowViewModel` | Debug | Choice selected, typing skipped |
| `DialogueWindowViewModel` | Information | Quest accepted |
| `DialogueWindowViewModel` | Debug | Shop opened, dialogue ended |
| `DialogueWindowViewModel` | Warning | Portrait load failed |

### Log Message Examples

```
Debug: Starting dialogue with Old Innkeeper
Debug: Showing node: greeting
Debug: Skipped typing animation
Debug: Showing 5 choices
Debug: Selected choice 3: "I'll take care of it."
Information: Accepted quest: skeleton-cave
Debug: Opening shop: innkeeper-shop
Debug: Dialogue ended with Old Innkeeper
Warning: Failed to load portrait: portraits/missing.png
```

---

## 13. Unit Testing Requirements

| Feature | Tests |
|---------|-------|
| StartDialogueAsync initialization | 2 |
| Typing animation completion | 1 |
| Skip typing (click) | 1 |
| Skip typing (keyboard) | 1 |
| Choice selection | 2 |
| AcceptQuest action | 1 |
| OpenShop action | 1 |
| Leave action | 1 |
| Conditional choice filtering | 1 |
| Node navigation | 2 |
| **Total** | **~13** |

### Test Specifications

**File:** `tests/RuneAndRust.Avalonia.UnitTests/ViewModels/DialogueWindowViewModelTests.cs`

```csharp
[TestFixture]
public class DialogueWindowViewModelTests
{
    [Test]
    public void StartDialogueAsync_SetsNpcNameAndPortrait();

    [Test]
    public void StartDialogueAsync_ShowsFirstNode();

    [Test]
    public void TypeTextAsync_RevealsTextGradually();

    [Test]
    public void ClickTextAsync_WhenTyping_SkipsToFullText();

    [Test]
    public void ClickTextAsync_WithKeyboard_SkipsToFullText();

    [Test]
    public void SelectChoiceAsync_NavigatesToNextNode();

    [Test]
    public void SelectChoiceAsync_WithNoNextNode_ClosesDialogue();

    [Test]
    public void SelectChoiceAsync_AcceptQuest_CallsQuestService();

    [Test]
    public void SelectChoiceAsync_OpenShop_CallsNavigationService();

    [Test]
    public void SelectChoiceAsync_Leave_ClosesDialogue();

    [Test]
    public void ShowChoices_FiltersUnavailableChoices();

    [Test]
    public void AdvanceToNodeAsync_UpdatesCurrentNode();

    [Test]
    public void AdvanceToNodeAsync_ClearsExistingChoices();
}
```

---

## 14. Use Cases

### UC-082b-001: Start NPC Dialogue
**Actor:** Player
**Flow:** Player interacts with NPC → Dialogue window opens → NPC portrait and name shown → Text begins typing

### UC-082b-002: Read Dialogue Text
**Actor:** Player
**Flow:** Text types character-by-character → Cursor (█) blinks at end → "[Click to continue...]" prompt shown

### UC-082b-003: Skip Typing Animation
**Actor:** Player
**Flow:** Player clicks during typing or presses Space/Enter → Full text appears instantly → Choices shown

### UC-082b-004: Select Response Choice
**Actor:** Player
**Flow:** Player clicks choice or presses number (1-9) → Action executed (if any) → Navigate to next node or end

### UC-082b-005: Accept Quest from Dialogue
**Actor:** Player
**Flow:** Player selects "[ACCEPT QUEST]" choice → Quest added to log → Dialogue continues or ends

### UC-082b-006: Open Shop from Dialogue
**Actor:** Player
**Flow:** Player selects "[SHOP]" choice → Shop window opens → Can return to dialogue after

### UC-082b-007: End Dialogue
**Actor:** Player
**Flow:** Player selects "[LEAVE]" or reaches end node → Dialogue window closes

### UC-082b-008: Navigate Branching Dialogue
**Actor:** Player
**Flow:** Player selects choice → Navigates to appropriate branch → Different text/choices shown

### UC-082b-009: Auto-Advance Dialogue
**Actor:** System
**Precondition:** Node has no choices but has AutoAdvanceNodeId
**Flow:** Text finishes typing → "[Click to continue...]" shown → Player clicks → Advance to next node

---

## 15. Deliverable Checklist

### Windows
- [ ] `Views/DialogueWindow.axaml` created
- [ ] `Views/DialogueWindow.axaml.cs` created

### Controls
- [ ] `Controls/DialogueChoiceControl.cs` created
- [ ] `Controls/DialogueChoiceControl.axaml` created

### ViewModels
- [ ] `ViewModels/DialogueWindowViewModel.cs` created
- [ ] `ViewModels/DialogueChoiceViewModel.cs` created

### Enums
- [ ] `Enums/DialogueAction.cs` created (if not existing)

### Styles
- [ ] `Styles/DialogueWindowStyles.axaml` created

### Integration
- [ ] Dialogue window opened from NPC interaction
- [ ] Quest acceptance integrated with IQuestService
- [ ] Shop opening integrated with ShopWindow (v0.8.2a)

### Testing
- [ ] ~13 unit tests implemented
- [ ] All tests passing

---

## 16. Acceptance Criteria

### Functional
- [ ] Dialogue window shows NPC portrait
- [ ] NPC name displays prominently
- [ ] Text types out character by character
- [ ] Typing cursor (█) blinks during animation
- [ ] Click anywhere skips to full text
- [ ] Space/Enter keys skip typing
- [ ] Response choices appear after text completes
- [ ] Choices are numbered (1-9)
- [ ] Clicking choice advances dialogue
- [ ] Keyboard numbers (1-9) select choices
- [ ] [ACCEPT QUEST] choice accepts quest
- [ ] [SHOP] choice opens shop window
- [ ] [LEAVE] choice closes dialogue
- [ ] Branching navigation works correctly
- [ ] Dialogue ends properly (no choices, end node)
- [ ] Conditional choices filter correctly

### Quality
- [ ] Build succeeds with 0 errors
- [ ] Build succeeds with 0 warnings
- [ ] ~13 unit tests pass
- [ ] XML documentation on all public types
- [ ] Styles consistent with application theme

---

## 17. Dependencies

### Required from v0.8.2a
- `ShopWindow` for [SHOP] action integration
- `INavigationService.ShowDialog<ShopWindow>()` pattern

### Required from Domain Layer
- `Dialogue` entity with tree structure
- `DialogueNode` with text and choices
- `DialogueChoice` with action data
- `Npc` entity with portrait

### Required from Application Layer
- `IDialogueService` for dialogue management
- `IQuestService` for quest acceptance
- `INavigationService` for window navigation

### Provides to v0.8.2c
- Modal dialogue window patterns
- Action integration patterns

---

## 18. Future Considerations

### Deferred to Later Versions
- **Voice Acting**: Audio playback with text
- **Emotion Display**: NPC mood indicators
- **Relationship Tracking**: Affinity/reputation with NPCs
- **Dialogue History**: Review past conversations
- **Skip All**: Skip entire conversation
- **Text Speed Settings**: User-configurable typing speed

### Out of Scope
- Lip sync animation
- Multiple language support (localization handled separately)
- Dialogue editor/tooling

---

*Document Version: 1.0*
*Last Updated: 2026-01-10*
