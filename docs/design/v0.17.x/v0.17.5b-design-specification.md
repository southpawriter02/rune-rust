# v0.17.5b Design Specification: Creation ViewModel

**Version:** 0.17.5b
**Theme:** Creation ViewModel
**Author:** Claude
**Created:** 2026-01-28
**Status:** Draft
**Prerequisites:** v0.17.5a Complete (Creation Step Enum & State)

---

## Table of Contents

1. [Overview](#1-overview)
2. [Dependencies](#2-dependencies)
3. [Architecture Diagrams](#3-architecture-diagrams)
4. [CharacterCreationViewModel](#4-charactercreationviewmodel)
5. [Preview Data Structures](#5-preview-data-structures)
6. [ViewModel Builder Service](#6-viewmodel-builder-service)
7. [Configuration](#7-configuration)
8. [User-Facing Changes](#8-user-facing-changes)
9. [Logging Specifications](#9-logging-specifications)
10. [Unit Testing Requirements](#10-unit-testing-requirements)
11. [Use Cases](#11-use-cases)
12. [Deliverable Checklist](#12-deliverable-checklist)
13. [Acceptance Criteria](#13-acceptance-criteria)
14. [Future Considerations](#14-future-considerations)
15. [Implementation Notes](#15-implementation-notes)
16. [Document Metadata](#16-document-metadata)

---

## 1. Overview

### 1.1 Purpose

This document provides a comprehensive design specification for v0.17.5b, the Creation ViewModel phase. This phase establishes the presentation layer data structures that transform raw `CharacterCreationState` into display-ready data for the TUI.

Key components:

1. **CharacterCreationViewModel**: Read-only value object containing all data needed to render the current creation step, including navigation state, preview data, and validation status.

2. **Preview Data Structures**: Specialized value objects for previewing derived stats, abilities, and equipment based on current selections.

3. **ViewModel Builder Service**: Service that constructs the ViewModel from state, coordinating with various providers to calculate preview data.

This infrastructure supports the TUI screens (v0.17.5f) by providing a clean separation between state management and presentation.

### 1.2 Current vs. Target Implementation

| Aspect                  | Current Implementation | Target Implementation                           |
| ----------------------- | ---------------------- | ----------------------------------------------- |
| **Presentation Data**   | Not implemented        | `CharacterCreationViewModel` value object       |
| **Preview Calculation** | Not implemented        | Real-time derived stats, abilities, equipment   |
| **Navigation State**    | State entity only      | ViewModel with computed navigation properties   |
| **Validation Display**  | Errors in state        | Processed validation with step-specific context |

### 1.3 Scope

**In Scope:**

- Define `CharacterCreationViewModel` value object
- Define `DerivedStatsPreview` value object
- Define `AbilitiesPreview` value object
- Define `EquipmentPreview` value object
- Define `IViewModelBuilder` interface and implementation
- Unit tests (~5 tests)

**Out of Scope:**

- Name validation logic - v0.17.5c
- Controller implementation - v0.17.5d
- Character factory - v0.17.5e
- TUI rendering - v0.17.5f
- Database persistence - v0.17.5g

### 1.4 Key Deliverables

| Type          | Count | Details                                                            |
| ------------- | ----- | ------------------------------------------------------------------ |
| Value Objects | 4     | ViewModel, DerivedStatsPreview, AbilitiesPreview, EquipmentPreview |
| Interfaces    | 1     | `IViewModelBuilder`                                                |
| Services      | 1     | `ViewModelBuilder`                                                 |
| Unit Tests    | ~5    | ViewModel construction, preview calculation                        |

---

## 2. Dependencies

### 2.1 Required from v0.17.5a (Creation Step Enum & State)

| Component                | Location                                          | Usage in v0.17.5b         |
| ------------------------ | ------------------------------------------------- | ------------------------- |
| `CharacterCreationStep`  | `Domain/Enums/CharacterCreationStep.cs`           | CurrentStep property      |
| `CharacterCreationState` | `Domain/Entities/CharacterCreationState.cs`       | Source data for ViewModel |
| Extension methods        | `Domain/Enums/CharacterCreationStepExtensions.cs` | Display name, description |

### 2.2 Required from v0.17.0-v0.17.4 (Character Systems)

| Component                 | Location                                            | Usage in v0.17.5b        |
| ------------------------- | --------------------------------------------------- | ------------------------ |
| `ILineageProvider`        | `Application/Interfaces/ILineageProvider.cs`        | Lineage preview data     |
| `IBackgroundProvider`     | `Application/Interfaces/IBackgroundProvider.cs`     | Equipment preview        |
| `IArchetypeProvider`      | `Application/Interfaces/IArchetypeProvider.cs`      | Abilities preview        |
| `ISpecializationProvider` | `Application/Interfaces/ISpecializationProvider.cs` | Specialization abilities |
| `IDerivedStatCalculator`  | `Application/Interfaces/IDerivedStatCalculator.cs`  | Derived stats preview    |

### 2.3 Provides to Future Versions

| Version  | Component                    | Usage                             |
| -------- | ---------------------------- | --------------------------------- |
| v0.17.5d | `CharacterCreationViewModel` | Controller uses for step display  |
| v0.17.5d | `IViewModelBuilder`          | Controller rebuilds after changes |
| v0.17.5f | `CharacterCreationViewModel` | TUI screens render from ViewModel |
| v0.17.5f | Preview value objects        | Display previews in UI            |

---

## 3. Architecture Diagrams

### 3.1 ViewModel Data Flow

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                         VIEWMODEL DATA FLOW                                  │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  ┌─────────────────────────┐                                                │
│  │ CharacterCreationState  │                                                │
│  │ (Domain Entity)         │                                                │
│  │                         │                                                │
│  │ • CurrentStep           │                                                │
│  │ • SelectedLineage       │                                                │
│  │ • SelectedBackground    │                                                │
│  │ • Attributes            │                                                │
│  │ • SelectedArchetype     │                                                │
│  │ • SelectedSpecializat.  │                                                │
│  │ • CharacterName         │                                                │
│  │ • ValidationErrors      │                                                │
│  └───────────┬─────────────┘                                                │
│              │                                                               │
│              ▼                                                               │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                      ViewModelBuilder                                │   │
│  │                                                                      │   │
│  │  BuildViewModel(state):                                              │   │
│  │    1. Extract step display info (title, description, number)        │   │
│  │    2. Calculate navigation (canGoBack, canGoForward, isPermanent)   │   │
│  │    3. Build preview data (stats, abilities, equipment)              │   │
│  │    4. Process validation errors for current step                    │   │
│  │    5. Return immutable ViewModel                                    │   │
│  │                                                                      │   │
│  └───────────┬─────────────────────────────────────────────────────────┘   │
│              │                                                               │
│              ▼                                                               │
│  ┌─────────────────────────┐                                                │
│  │ CharacterCreationView-  │                                                │
│  │ Model (Value Object)    │                                                │
│  │                         │                                                │
│  │ • Display Data          │───▶ TUI Step Header                            │
│  │ • Navigation State      │───▶ TUI Navigation Buttons                     │
│  │ • Preview Data          │───▶ TUI Preview Panels                         │
│  │ • Validation Status     │───▶ TUI Error Messages                         │
│  │                         │                                                │
│  └─────────────────────────┘                                                │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 3.2 Preview Data Dependencies

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                      PREVIEW DATA DEPENDENCIES                               │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  STEP 1: Lineage                                                            │
│  ├── DerivedStatsPreview ← ILineageProvider (attribute modifiers)          │
│  └── No abilities/equipment preview yet                                     │
│                                                                              │
│  STEP 2: Background                                                         │
│  ├── DerivedStatsPreview ← (unchanged from Step 1)                         │
│  └── EquipmentPreview ← IBackgroundProvider (starting equipment)           │
│                                                                              │
│  STEP 3: Attributes                                                         │
│  ├── DerivedStatsPreview ← IDerivedStatCalculator (live calculation)       │
│  └── EquipmentPreview ← (unchanged from Step 2)                            │
│                                                                              │
│  STEP 4: Archetype                                                          │
│  ├── DerivedStatsPreview ← IArchetypeProvider (HP/resource bonuses)        │
│  ├── AbilitiesPreview ← IArchetypeProvider (starting abilities)            │
│  └── EquipmentPreview ← (unchanged)                                         │
│                                                                              │
│  STEP 5: Specialization                                                     │
│  ├── DerivedStatsPreview ← ISpecializationProvider (resource bonuses)      │
│  ├── AbilitiesPreview ← ISpecializationProvider (Tier 1 abilities)         │
│  └── EquipmentPreview ← (unchanged)                                         │
│                                                                              │
│  STEP 6: Summary                                                            │
│  ├── DerivedStatsPreview ← Final calculated stats                          │
│  ├── AbilitiesPreview ← All granted abilities                              │
│  └── EquipmentPreview ← All starting equipment                             │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 3.3 Layer Architecture

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                          LAYER ARCHITECTURE                                  │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  ┌────────────────────────────────────────────────────────────────────┐     │
│  │                     APPLICATION LAYER                               │     │
│  │                                                                     │     │
│  │  ┌───────────────────────────────────────────────────────────────┐ │     │
│  │  │                   IViewModelBuilder                            │ │     │
│  │  │                                                                │ │     │
│  │  │  CharacterCreationViewModel Build(CharacterCreationState)     │ │     │
│  │  │                                                                │ │     │
│  │  └───────────────────────────────────────────────────────────────┘ │     │
│  │                              │                                      │     │
│  │                              ▼                                      │     │
│  │  ┌───────────────────────────────────────────────────────────────┐ │     │
│  │  │                    ViewModelBuilder                            │ │     │
│  │  │                                                                │ │     │
│  │  │  Dependencies:                                                 │ │     │
│  │  │  • ILineageProvider                                           │ │     │
│  │  │  • IBackgroundProvider                                        │ │     │
│  │  │  • IArchetypeProvider                                         │ │     │
│  │  │  • ISpecializationProvider                                    │ │     │
│  │  │  • IDerivedStatCalculator                                     │ │     │
│  │  │                                                                │ │     │
│  │  └───────────────────────────────────────────────────────────────┘ │     │
│  │                                                                     │     │
│  └────────────────────────────────────────────────────────────────────┘     │
│                                                                              │
│  ┌────────────────────────────────────────────────────────────────────┐     │
│  │                       DOMAIN LAYER                                  │     │
│  │                                                                     │     │
│  │  ┌──────────────────────┐  ┌──────────────────────┐               │     │
│  │  │ CharacterCreation-   │  │ DerivedStatsPreview  │               │     │
│  │  │ ViewModel            │  │                      │               │     │
│  │  │ (Value Object)       │  │ • MaxHp              │               │     │
│  │  │                      │  │ • MaxStamina         │               │     │
│  │  │ • CurrentStep        │  │ • MaxAp              │               │     │
│  │  │ • StepTitle          │  │ • FromLineage        │               │     │
│  │  │ • StepDescription    │  │ • FromArchetype      │               │     │
│  │  │ • Navigation props   │  │                      │               │     │
│  │  │ • Preview data       │  └──────────────────────┘               │     │
│  │  │ • Validation status  │                                         │     │
│  │  └──────────────────────┘  ┌──────────────────────┐               │     │
│  │                             │ AbilitiesPreview     │               │     │
│  │  ┌──────────────────────┐  │                      │               │     │
│  │  │ EquipmentPreview     │  │ • ArchetypeAbilities │               │     │
│  │  │                      │  │ • SpecAbilities      │               │     │
│  │  │ • Items              │  │ • TotalCount         │               │     │
│  │  │ • FromBackground     │  │                      │               │     │
│  │  │                      │  └──────────────────────┘               │     │
│  │  └──────────────────────┘                                         │     │
│  │                                                                     │     │
│  └────────────────────────────────────────────────────────────────────┘     │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 4. CharacterCreationViewModel

### 4.1 Value Object Definition

**File:** `src/Core/RuneAndRust.Domain/ValueObjects/CharacterCreationViewModel.cs`

```csharp
using RuneAndRust.Domain.Enums;

namespace RuneAndRust.Domain.ValueObjects;

/// <summary>
/// Read-only presentation data for the character creation wizard.
/// Contains all information needed to render the current step.
/// </summary>
/// <remarks>
/// This value object is rebuilt whenever the creation state changes.
/// It provides a clean separation between state management and presentation.
/// </remarks>
public readonly record struct CharacterCreationViewModel
{
    // ═══════════════════════════════════════════════════════════════════════
    // Current Step Information
    // ═══════════════════════════════════════════════════════════════════════

    /// <summary>
    /// Gets the current step in the creation workflow.
    /// </summary>
    public CharacterCreationStep CurrentStep { get; init; }

    /// <summary>
    /// Gets the display title for the current step.
    /// Example: "Choose Your Lineage"
    /// </summary>
    public string StepTitle { get; init; }

    /// <summary>
    /// Gets the thematic description for the current step.
    /// Example: "Your bloodline carries echoes of the world before."
    /// </summary>
    public string StepDescription { get; init; }

    /// <summary>
    /// Gets the 1-based step number for display (1-6).
    /// </summary>
    public int StepNumber { get; init; }

    /// <summary>
    /// Gets the total number of steps in the workflow (always 6).
    /// </summary>
    public int TotalSteps { get; init; }

    // ═══════════════════════════════════════════════════════════════════════
    // Navigation State
    // ═══════════════════════════════════════════════════════════════════════

    /// <summary>
    /// Gets whether the user can navigate to the previous step.
    /// False for Step 1 (Lineage).
    /// </summary>
    public bool CanGoBack { get; init; }

    /// <summary>
    /// Gets whether the user can navigate to the next step.
    /// Requires the current step to be complete.
    /// </summary>
    public bool CanGoForward { get; init; }

    /// <summary>
    /// Gets whether the current step represents a permanent, irreversible choice.
    /// True only for Step 4 (Archetype).
    /// </summary>
    public bool IsPermanentChoice { get; init; }

    /// <summary>
    /// Gets the warning message for permanent choices, if applicable.
    /// Null for non-permanent steps.
    /// </summary>
    public string? PermanentWarning { get; init; }

    // ═══════════════════════════════════════════════════════════════════════
    // Current Selections Display
    // ═══════════════════════════════════════════════════════════════════════

    /// <summary>
    /// Gets the display name of the selected lineage, if any.
    /// </summary>
    public string? SelectedLineageName { get; init; }

    /// <summary>
    /// Gets the display name of the selected background, if any.
    /// </summary>
    public string? SelectedBackgroundName { get; init; }

    /// <summary>
    /// Gets the display name of the selected archetype, if any.
    /// </summary>
    public string? SelectedArchetypeName { get; init; }

    /// <summary>
    /// Gets the display name of the selected specialization, if any.
    /// </summary>
    public string? SelectedSpecializationName { get; init; }

    /// <summary>
    /// Gets the character name entered in Step 6, if any.
    /// </summary>
    public string? CharacterName { get; init; }

    // ═══════════════════════════════════════════════════════════════════════
    // Preview Data
    // ═══════════════════════════════════════════════════════════════════════

    /// <summary>
    /// Gets the derived stats preview based on current selections.
    /// Updated in real-time during attribute allocation.
    /// </summary>
    public DerivedStatsPreview? DerivedStatsPreview { get; init; }

    /// <summary>
    /// Gets the abilities preview based on archetype and specialization.
    /// Null until archetype is selected.
    /// </summary>
    public AbilitiesPreview? AbilitiesPreview { get; init; }

    /// <summary>
    /// Gets the equipment preview based on background selection.
    /// Null until background is selected.
    /// </summary>
    public EquipmentPreview? EquipmentPreview { get; init; }

    // ═══════════════════════════════════════════════════════════════════════
    // Validation
    // ═══════════════════════════════════════════════════════════════════════

    /// <summary>
    /// Gets the list of validation errors for the current step.
    /// Empty if no errors.
    /// </summary>
    public IReadOnlyList<string> ValidationErrors { get; init; }

    /// <summary>
    /// Gets whether the current step has passed validation.
    /// </summary>
    public bool IsCurrentStepValid { get; init; }

    // ═══════════════════════════════════════════════════════════════════════
    // Factory Methods
    // ═══════════════════════════════════════════════════════════════════════

    /// <summary>
    /// Creates an empty ViewModel for initialization.
    /// </summary>
    public static CharacterCreationViewModel Empty => new()
    {
        CurrentStep = CharacterCreationStep.Lineage,
        StepTitle = string.Empty,
        StepDescription = string.Empty,
        StepNumber = 1,
        TotalSteps = 6,
        CanGoBack = false,
        CanGoForward = false,
        IsPermanentChoice = false,
        ValidationErrors = Array.Empty<string>(),
        IsCurrentStepValid = false
    };
}
```

---

## 5. Preview Data Structures

### 5.1 DerivedStatsPreview

**File:** `src/Core/RuneAndRust.Domain/ValueObjects/DerivedStatsPreview.cs`

```csharp
namespace RuneAndRust.Domain.ValueObjects;

/// <summary>
/// Preview of derived stats based on current character creation selections.
/// Shows the calculated HP, Stamina, and AP values with breakdown by source.
/// </summary>
public readonly record struct DerivedStatsPreview
{
    /// <summary>
    /// Gets the calculated maximum HP.
    /// Formula: (STURDINESS × 10) + 50 + ArchetypeBonus + LineageBonus
    /// </summary>
    public int MaxHp { get; init; }

    /// <summary>
    /// Gets the calculated maximum Stamina.
    /// Formula: (FINESSE × 5) + (MIGHT × 5) + 20 + ArchetypeBonus
    /// </summary>
    public int MaxStamina { get; init; }

    /// <summary>
    /// Gets the calculated maximum Aether Pool (AP).
    /// Formula: (WILL × 10) + (WITS × 5) + ArchetypeBonus + LineageBonus
    /// </summary>
    public int MaxAp { get; init; }

    /// <summary>
    /// Gets the HP bonus from lineage selection.
    /// </summary>
    public int HpFromLineage { get; init; }

    /// <summary>
    /// Gets the HP bonus from archetype selection.
    /// </summary>
    public int HpFromArchetype { get; init; }

    /// <summary>
    /// Gets the AP bonus from lineage selection.
    /// </summary>
    public int ApFromLineage { get; init; }

    /// <summary>
    /// Gets the AP bonus from archetype selection.
    /// </summary>
    public int ApFromArchetype { get; init; }

    /// <summary>
    /// Gets the Stamina bonus from archetype selection.
    /// </summary>
    public int StaminaFromArchetype { get; init; }

    /// <summary>
    /// Creates an empty preview with zero values.
    /// </summary>
    public static DerivedStatsPreview Empty => new()
    {
        MaxHp = 0,
        MaxStamina = 0,
        MaxAp = 0
    };
}
```

### 5.2 AbilitiesPreview

**File:** `src/Core/RuneAndRust.Domain/ValueObjects/AbilitiesPreview.cs`

```csharp
namespace RuneAndRust.Domain.ValueObjects;

/// <summary>
/// Preview of abilities that will be granted based on archetype and specialization.
/// </summary>
public readonly record struct AbilitiesPreview
{
    /// <summary>
    /// Gets the abilities granted by the selected archetype (typically 3).
    /// </summary>
    public IReadOnlyList<string> ArchetypeAbilities { get; init; }

    /// <summary>
    /// Gets the Tier 1 abilities granted by the selected specialization (typically 3).
    /// </summary>
    public IReadOnlyList<string> SpecializationAbilities { get; init; }

    /// <summary>
    /// Gets the total count of abilities to be granted.
    /// </summary>
    public int TotalCount => (ArchetypeAbilities?.Count ?? 0) + (SpecializationAbilities?.Count ?? 0);

    /// <summary>
    /// Creates an empty preview with no abilities.
    /// </summary>
    public static AbilitiesPreview Empty => new()
    {
        ArchetypeAbilities = Array.Empty<string>(),
        SpecializationAbilities = Array.Empty<string>()
    };
}
```

### 5.3 EquipmentPreview

**File:** `src/Core/RuneAndRust.Domain/ValueObjects/EquipmentPreview.cs`

```csharp
namespace RuneAndRust.Domain.ValueObjects;

/// <summary>
/// Preview of starting equipment based on background selection.
/// </summary>
public readonly record struct EquipmentPreview
{
    /// <summary>
    /// Gets the list of equipment items granted by the background.
    /// </summary>
    public IReadOnlyList<EquipmentPreviewItem> Items { get; init; }

    /// <summary>
    /// Gets the background that grants this equipment.
    /// </summary>
    public string FromBackground { get; init; }

    /// <summary>
    /// Creates an empty preview with no equipment.
    /// </summary>
    public static EquipmentPreview Empty => new()
    {
        Items = Array.Empty<EquipmentPreviewItem>(),
        FromBackground = string.Empty
    };
}

/// <summary>
/// Single equipment item in the preview.
/// </summary>
public readonly record struct EquipmentPreviewItem
{
    /// <summary>
    /// Gets the display name of the item.
    /// </summary>
    public string Name { get; init; }

    /// <summary>
    /// Gets the quantity (for stackable items like potions).
    /// </summary>
    public int Quantity { get; init; }

    /// <summary>
    /// Gets the item type for categorization.
    /// </summary>
    public string ItemType { get; init; }
}
```

---

## 6. ViewModel Builder Service

### 6.1 Interface Definition

**File:** `src/Core/RuneAndRust.Application/Interfaces/IViewModelBuilder.cs`

```csharp
using RuneAndRust.Domain.Entities;
using RuneAndRust.Domain.ValueObjects;

namespace RuneAndRust.Application.Interfaces;

/// <summary>
/// Builds CharacterCreationViewModel from CharacterCreationState.
/// Coordinates with various providers to calculate preview data.
/// </summary>
public interface IViewModelBuilder
{
    /// <summary>
    /// Builds a complete ViewModel from the current creation state.
    /// </summary>
    /// <param name="state">The current character creation state.</param>
    /// <returns>Immutable ViewModel ready for presentation.</returns>
    CharacterCreationViewModel Build(CharacterCreationState state);

    /// <summary>
    /// Builds only the derived stats preview for real-time updates.
    /// Used during attribute allocation for live preview.
    /// </summary>
    /// <param name="state">The current character creation state.</param>
    /// <returns>Derived stats preview based on current selections.</returns>
    DerivedStatsPreview BuildDerivedStatsPreview(CharacterCreationState state);
}
```

### 6.2 Service Implementation

**File:** `src/Core/RuneAndRust.Application/Services/ViewModelBuilder.cs`

```csharp
using Microsoft.Extensions.Logging;
using RuneAndRust.Application.Interfaces;
using RuneAndRust.Domain.Entities;
using RuneAndRust.Domain.Enums;
using RuneAndRust.Domain.ValueObjects;

namespace RuneAndRust.Application.Services;

/// <summary>
/// Builds CharacterCreationViewModel from CharacterCreationState.
/// </summary>
public class ViewModelBuilder : IViewModelBuilder
{
    private readonly ILineageProvider _lineageProvider;
    private readonly IBackgroundProvider _backgroundProvider;
    private readonly IArchetypeProvider _archetypeProvider;
    private readonly ISpecializationProvider _specializationProvider;
    private readonly IDerivedStatCalculator _derivedStatCalculator;
    private readonly ILogger<ViewModelBuilder> _logger;

    private const string PermanentWarningText =
        "This choice is PERMANENT and cannot be changed after character creation.";

    public ViewModelBuilder(
        ILineageProvider lineageProvider,
        IBackgroundProvider backgroundProvider,
        IArchetypeProvider archetypeProvider,
        ISpecializationProvider specializationProvider,
        IDerivedStatCalculator derivedStatCalculator,
        ILogger<ViewModelBuilder> logger)
    {
        _lineageProvider = lineageProvider;
        _backgroundProvider = backgroundProvider;
        _archetypeProvider = archetypeProvider;
        _specializationProvider = specializationProvider;
        _derivedStatCalculator = derivedStatCalculator;
        _logger = logger;
    }

    /// <inheritdoc />
    public CharacterCreationViewModel Build(CharacterCreationState state)
    {
        ArgumentNullException.ThrowIfNull(state);

        _logger.LogDebug(
            "Building ViewModel for step {Step}. SessionId: {SessionId}",
            state.CurrentStep, state.SessionId);

        var step = state.CurrentStep;

        return new CharacterCreationViewModel
        {
            // Step Information
            CurrentStep = step,
            StepTitle = step.GetDisplayName(),
            StepDescription = step.GetDescription(),
            StepNumber = step.GetStepNumber(),
            TotalSteps = CharacterCreationStepExtensions.GetTotalSteps(),

            // Navigation
            CanGoBack = step.CanGoBack(),
            CanGoForward = state.IsStepComplete(step),
            IsPermanentChoice = step.IsPermanentChoice(),
            PermanentWarning = step.IsPermanentChoice() ? PermanentWarningText : null,

            // Current Selections
            SelectedLineageName = GetLineageDisplayName(state.SelectedLineage),
            SelectedBackgroundName = GetBackgroundDisplayName(state.SelectedBackground),
            SelectedArchetypeName = GetArchetypeDisplayName(state.SelectedArchetype),
            SelectedSpecializationName = GetSpecializationDisplayName(state.SelectedSpecialization),
            CharacterName = state.CharacterName,

            // Preview Data
            DerivedStatsPreview = BuildDerivedStatsPreview(state),
            AbilitiesPreview = BuildAbilitiesPreview(state),
            EquipmentPreview = BuildEquipmentPreview(state),

            // Validation
            ValidationErrors = state.ValidationErrors.AsReadOnly(),
            IsCurrentStepValid = state.IsStepComplete(step) && state.ValidationErrors.Count == 0
        };
    }

    /// <inheritdoc />
    public DerivedStatsPreview BuildDerivedStatsPreview(CharacterCreationState state)
    {
        if (state.Attributes == null)
            return DerivedStatsPreview.Empty;

        var lineageDef = state.SelectedLineage.HasValue
            ? _lineageProvider.GetByLineage(state.SelectedLineage.Value)
            : null;

        var archetypeDef = state.SelectedArchetype.HasValue
            ? _archetypeProvider.GetByArchetype(state.SelectedArchetype.Value)
            : null;

        var hpFromLineage = lineageDef?.HpBonus ?? 0;
        var hpFromArchetype = archetypeDef?.HpBonus ?? 0;
        var apFromLineage = lineageDef?.ApBonus ?? 0;
        var apFromArchetype = archetypeDef?.ApBonus ?? 0;
        var staminaFromArchetype = archetypeDef?.StaminaBonus ?? 0;

        var derivedStats = _derivedStatCalculator.Calculate(
            state.Attributes,
            hpFromLineage + hpFromArchetype,
            staminaFromArchetype,
            apFromLineage + apFromArchetype);

        _logger.LogDebug(
            "Derived stats preview: HP={MaxHp}, Stamina={MaxStamina}, AP={MaxAp}",
            derivedStats.MaxHp, derivedStats.MaxStamina, derivedStats.MaxAp);

        return new DerivedStatsPreview
        {
            MaxHp = derivedStats.MaxHp,
            MaxStamina = derivedStats.MaxStamina,
            MaxAp = derivedStats.MaxAp,
            HpFromLineage = hpFromLineage,
            HpFromArchetype = hpFromArchetype,
            ApFromLineage = apFromLineage,
            ApFromArchetype = apFromArchetype,
            StaminaFromArchetype = staminaFromArchetype
        };
    }

    private AbilitiesPreview BuildAbilitiesPreview(CharacterCreationState state)
    {
        var archetypeAbilities = new List<string>();
        var specAbilities = new List<string>();

        if (state.SelectedArchetype.HasValue)
        {
            var archetypeDef = _archetypeProvider.GetByArchetype(state.SelectedArchetype.Value);
            archetypeAbilities.AddRange(archetypeDef?.StartingAbilities ?? []);
        }

        if (state.SelectedSpecialization.HasValue)
        {
            var specDef = _specializationProvider.GetBySpecializationId(state.SelectedSpecialization.Value);
            specAbilities.AddRange(specDef?.GetTier1AbilityNames() ?? []);
        }

        if (archetypeAbilities.Count == 0 && specAbilities.Count == 0)
            return AbilitiesPreview.Empty;

        return new AbilitiesPreview
        {
            ArchetypeAbilities = archetypeAbilities.AsReadOnly(),
            SpecializationAbilities = specAbilities.AsReadOnly()
        };
    }

    private EquipmentPreview BuildEquipmentPreview(CharacterCreationState state)
    {
        if (!state.SelectedBackground.HasValue)
            return EquipmentPreview.Empty;

        var backgroundDef = _backgroundProvider.GetByBackground(state.SelectedBackground.Value);
        if (backgroundDef == null)
            return EquipmentPreview.Empty;

        var items = backgroundDef.StartingEquipment
            .Select(e => new EquipmentPreviewItem
            {
                Name = e.ItemName,
                Quantity = e.Quantity,
                ItemType = e.ItemType
            })
            .ToList();

        return new EquipmentPreview
        {
            Items = items.AsReadOnly(),
            FromBackground = backgroundDef.DisplayName
        };
    }

    private string? GetLineageDisplayName(Lineage? lineage) =>
        lineage.HasValue ? _lineageProvider.GetByLineage(lineage.Value)?.DisplayName : null;

    private string? GetBackgroundDisplayName(Background? background) =>
        background.HasValue ? _backgroundProvider.GetByBackground(background.Value)?.DisplayName : null;

    private string? GetArchetypeDisplayName(Archetype? archetype) =>
        archetype.HasValue ? _archetypeProvider.GetByArchetype(archetype.Value)?.DisplayName : null;

    private string? GetSpecializationDisplayName(SpecializationId? specId) =>
        specId.HasValue ? _specializationProvider.GetBySpecializationId(specId.Value)?.DisplayName : null;
}
```

---

## 7. Configuration

No new configuration files are introduced in v0.17.5b. The ViewModel builder uses configuration from:

- `lineages.json` (v0.17.0)
- `backgrounds.json` (v0.17.1)
- `archetypes.json` (v0.17.3)
- `specializations.json` (v0.17.4)
- `creation-workflow.json` (v0.17.5a)

---

## 8. User-Facing Changes

### 8.1 No Direct User-Facing Changes

This version establishes presentation infrastructure. User-facing changes will be visible in:

- **v0.17.5f (TUI Screens)**: Uses ViewModel data for rendering
- **v0.17.5d (Controller)**: Exposes ViewModel through API

---

## 9. Logging Specifications

### 9.1 Log Levels by Component

| Component        | Level   | Events                            |
| ---------------- | ------- | --------------------------------- |
| ViewModelBuilder | Debug   | ViewModel build start/complete    |
| ViewModelBuilder | Debug   | Derived stats preview calculation |
| ViewModelBuilder | Warning | Missing provider data             |
| ViewModelBuilder | Error   | Build failure                     |

### 9.2 Log Message Examples

```csharp
// ViewModel build
_logger.LogDebug(
    "Building ViewModel for step {Step}. SessionId: {SessionId}",
    state.CurrentStep, state.SessionId);

// Derived stats calculation
_logger.LogDebug(
    "Derived stats preview: HP={MaxHp}, Stamina={MaxStamina}, AP={MaxAp}",
    derivedStats.MaxHp, derivedStats.MaxStamina, derivedStats.MaxAp);

// Missing data warning
_logger.LogWarning(
    "Lineage definition not found for {Lineage}. Using default preview.",
    lineage);
```

---

## 10. Unit Testing Requirements

### 10.1 Test Coverage Summary

| Test Category             | Test Count | Priority |
| ------------------------- | ---------- | -------- |
| ViewModel Construction    | 2          | Critical |
| Navigation State Tests    | 2          | Critical |
| Preview Calculation Tests | 3          | High     |
| Validation State Tests    | 1          | High     |
| Edge Case Tests           | 2          | Medium   |
| **Total**                 | **~10**    |          |

### 10.2 ViewModelBuilder Tests

**File:** `tests/RuneAndRust.Application.UnitTests/Services/ViewModelBuilderTests.cs`

```csharp
using FluentAssertions;
using Microsoft.Extensions.Logging;
using Moq;
using NUnit.Framework;
using RuneAndRust.Application.Interfaces;
using RuneAndRust.Application.Services;
using RuneAndRust.Domain.Entities;
using RuneAndRust.Domain.Enums;
using RuneAndRust.Domain.ValueObjects;

namespace RuneAndRust.Application.UnitTests.Services;

[TestFixture]
public class ViewModelBuilderTests
{
    private Mock<ILineageProvider> _lineageProviderMock = null!;
    private Mock<IBackgroundProvider> _backgroundProviderMock = null!;
    private Mock<IArchetypeProvider> _archetypeProviderMock = null!;
    private Mock<ISpecializationProvider> _specializationProviderMock = null!;
    private Mock<IDerivedStatCalculator> _derivedStatCalculatorMock = null!;
    private Mock<ILogger<ViewModelBuilder>> _loggerMock = null!;
    private ViewModelBuilder _builder = null!;

    [SetUp]
    public void SetUp()
    {
        _lineageProviderMock = new Mock<ILineageProvider>();
        _backgroundProviderMock = new Mock<IBackgroundProvider>();
        _archetypeProviderMock = new Mock<IArchetypeProvider>();
        _specializationProviderMock = new Mock<ISpecializationProvider>();
        _derivedStatCalculatorMock = new Mock<IDerivedStatCalculator>();
        _loggerMock = new Mock<ILogger<ViewModelBuilder>>();

        _builder = new ViewModelBuilder(
            _lineageProviderMock.Object,
            _backgroundProviderMock.Object,
            _archetypeProviderMock.Object,
            _specializationProviderMock.Object,
            _derivedStatCalculatorMock.Object,
            _loggerMock.Object);
    }

    [Test]
    public void Build_ForLineageStep_SetsCorrectStepInfo()
    {
        // Arrange
        var state = CharacterCreationState.Create();

        // Act
        var viewModel = _builder.Build(state);

        // Assert
        viewModel.CurrentStep.Should().Be(CharacterCreationStep.Lineage);
        viewModel.StepNumber.Should().Be(1);
        viewModel.TotalSteps.Should().Be(6);
        viewModel.StepTitle.Should().Be("Choose Your Lineage");
        viewModel.CanGoBack.Should().BeFalse();
        viewModel.IsPermanentChoice.Should().BeFalse();
    }

    [Test]
    public void Build_ForArchetypeStep_SetsPermanentWarning()
    {
        // Arrange
        var state = CharacterCreationState.Create();
        state.CurrentStep = CharacterCreationStep.Archetype;

        // Act
        var viewModel = _builder.Build(state);

        // Assert
        viewModel.IsPermanentChoice.Should().BeTrue();
        viewModel.PermanentWarning.Should().NotBeNullOrEmpty();
        viewModel.PermanentWarning.Should().Contain("PERMANENT");
    }

    [Test]
    public void Build_WithLineageSelected_IncludesLineageDisplayName()
    {
        // Arrange
        var state = CharacterCreationState.Create();
        state.SelectedLineage = Lineage.IronBlooded;

        _lineageProviderMock
            .Setup(p => p.GetByLineage(Lineage.IronBlooded))
            .Returns(new LineageDefinition { DisplayName = "Iron-Blooded" });

        // Act
        var viewModel = _builder.Build(state);

        // Assert
        viewModel.SelectedLineageName.Should().Be("Iron-Blooded");
    }

    [Test]
    public void Build_WithBackgroundSelected_BuildsEquipmentPreview()
    {
        // Arrange
        var state = CharacterCreationState.Create();
        state.SelectedBackground = Background.VillageSmith;

        var backgroundDef = new BackgroundDefinition
        {
            DisplayName = "Village Smith",
            StartingEquipment = new List<StartingEquipmentGrant>
            {
                new() { ItemName = "Smith's Hammer", Quantity = 1, ItemType = "Weapon" },
                new() { ItemName = "Leather Apron", Quantity = 1, ItemType = "Armor" }
            }
        };

        _backgroundProviderMock
            .Setup(p => p.GetByBackground(Background.VillageSmith))
            .Returns(backgroundDef);

        // Act
        var viewModel = _builder.Build(state);

        // Assert
        viewModel.EquipmentPreview.Should().NotBeNull();
        viewModel.EquipmentPreview!.Value.Items.Should().HaveCount(2);
        viewModel.EquipmentPreview!.Value.FromBackground.Should().Be("Village Smith");
    }

    [Test]
    public void Build_WithCompletedStep_SetsCanGoForwardTrue()
    {
        // Arrange
        var state = CharacterCreationState.Create();
        state.SelectedLineage = Lineage.ClanBorn;
        state.FlexibleAttributeBonus = CoreAttribute.Might;

        // Act
        var viewModel = _builder.Build(state);

        // Assert
        viewModel.CanGoForward.Should().BeTrue();
    }

    [Test]
    public void Build_WithIncompleteStep_SetsCanGoForwardFalse()
    {
        // Arrange
        var state = CharacterCreationState.Create();
        // No lineage selected

        // Act
        var viewModel = _builder.Build(state);

        // Assert
        viewModel.CanGoForward.Should().BeFalse();
    }

    [Test]
    public void Build_WithValidationErrors_IncludesErrorsInViewModel()
    {
        // Arrange
        var state = CharacterCreationState.Create();
        state.ValidationErrors.Add("Test error message");

        // Act
        var viewModel = _builder.Build(state);

        // Assert
        viewModel.ValidationErrors.Should().HaveCount(1);
        viewModel.ValidationErrors[0].Should().Be("Test error message");
        viewModel.IsCurrentStepValid.Should().BeFalse();
    }

    [Test]
    public void BuildDerivedStatsPreview_WithAttributes_CalculatesCorrectly()
    {
        // Arrange
        var state = CharacterCreationState.Create();
        state.Attributes = AttributeAllocationState.CreateDefault();
        state.SelectedLineage = Lineage.ClanBorn;
        state.SelectedArchetype = Archetype.Warrior;

        _lineageProviderMock
            .Setup(p => p.GetByLineage(Lineage.ClanBorn))
            .Returns(new LineageDefinition { HpBonus = 5, ApBonus = 0 });

        _archetypeProviderMock
            .Setup(p => p.GetByArchetype(Archetype.Warrior))
            .Returns(new ArchetypeDefinition { HpBonus = 49, StaminaBonus = 0, ApBonus = 0 });

        _derivedStatCalculatorMock
            .Setup(c => c.Calculate(It.IsAny<AttributeAllocationState>(), 54, 0, 0))
            .Returns(new DerivedStats { MaxHp = 104, MaxStamina = 55, MaxAp = 10 });

        // Act
        var preview = _builder.BuildDerivedStatsPreview(state);

        // Assert
        preview.MaxHp.Should().Be(104);
        preview.HpFromLineage.Should().Be(5);
        preview.HpFromArchetype.Should().Be(49);
    }

    [Test]
    public void BuildDerivedStatsPreview_WithoutAttributes_ReturnsEmpty()
    {
        // Arrange
        var state = CharacterCreationState.Create();
        // No attributes set

        // Act
        var preview = _builder.BuildDerivedStatsPreview(state);

        // Assert
        preview.Should().Be(DerivedStatsPreview.Empty);
    }
}
```

---

## 11. Use Cases

### 11.1 UC-001: Build ViewModel for Current Step

**Actor:** Controller
**Preconditions:** CharacterCreationState exists
**Flow:**

1. Controller calls `Build(state)` on ViewModelBuilder
2. Builder extracts step display information
3. Builder calculates navigation state
4. Builder queries providers for preview data
5. Builder processes validation errors
6. Builder returns immutable ViewModel

**Postconditions:** TUI has complete data for rendering

### 11.2 UC-002: Real-Time Derived Stats Preview

**Actor:** Attribute Allocation Screen
**Preconditions:** User is on Step 3 (Attributes)
**Flow:**

1. User adjusts attribute value (+/-)
2. Controller calls `BuildDerivedStatsPreview(state)`
3. Builder calculates new derived stats
4. TUI updates preview panel

**Postconditions:** User sees live preview of HP/Stamina/AP changes

### 11.3 UC-003: Display Archetype Warning

**Actor:** TUI
**Preconditions:** User navigates to Step 4 (Archetype)
**Flow:**

1. Controller builds ViewModel for Archetype step
2. ViewModel.IsPermanentChoice = true
3. ViewModel.PermanentWarning contains warning text
4. TUI renders warning prominently

**Postconditions:** User is warned about permanent choice

---

## 12. Deliverable Checklist

### 12.1 Value Objects

- [ ] `src/Core/RuneAndRust.Domain/ValueObjects/CharacterCreationViewModel.cs`
- [ ] `src/Core/RuneAndRust.Domain/ValueObjects/DerivedStatsPreview.cs`
- [ ] `src/Core/RuneAndRust.Domain/ValueObjects/AbilitiesPreview.cs`
- [ ] `src/Core/RuneAndRust.Domain/ValueObjects/EquipmentPreview.cs`

### 12.2 Interfaces

- [ ] `src/Core/RuneAndRust.Application/Interfaces/IViewModelBuilder.cs`

### 12.3 Services

- [ ] `src/Core/RuneAndRust.Application/Services/ViewModelBuilder.cs`

### 12.4 Testing

- [ ] `tests/RuneAndRust.Application.UnitTests/Services/ViewModelBuilderTests.cs`
- [ ] ~10 unit tests implemented
- [ ] All tests passing

### 12.5 Documentation

- [ ] `docs/design/v0.17.x/v0.17.5b-changelog.md`
- [ ] Update `docs/design/v0.17.x/v0.17.5-scope-breakdown.md` (mark items complete)

---

## 13. Acceptance Criteria

### 13.1 Functional

- [ ] ViewModel contains correct step display info (title, description, number)
- [ ] ViewModel.StepNumber returns 1-6 based on current step
- [ ] ViewModel.CanGoBack returns false for Lineage step
- [ ] ViewModel.CanGoBack returns true for all other steps
- [ ] ViewModel.CanGoForward returns true only when step is complete
- [ ] ViewModel.IsPermanentChoice returns true only for Archetype step
- [ ] ViewModel.PermanentWarning contains warning text for Archetype step
- [ ] DerivedStatsPreview calculates HP/Stamina/AP based on current selections
- [ ] DerivedStatsPreview shows breakdown by source (lineage, archetype)
- [ ] AbilitiesPreview lists archetype abilities when archetype selected
- [ ] AbilitiesPreview lists specialization Tier 1 abilities when spec selected
- [ ] EquipmentPreview lists background starting equipment
- [ ] ValidationErrors propagate from state to ViewModel

### 13.2 Quality

- [ ] Build succeeds with 0 errors/warnings
- [ ] All ~10 unit tests pass
- [ ] XML documentation complete on all public members
- [ ] Value objects are immutable (readonly record struct)

---

## 14. Future Considerations

### 14.1 Deferred to v0.17.5f

- **TUI Rendering**: Actual screen rendering using ViewModel data
- **ASCII Art Previews**: Visual representations of lineage/archetype

### 14.2 Out of Scope

- **Caching**: ViewModel is rebuilt on every state change (simple and correct)
- **Async Building**: Not needed for current performance requirements
- **Localization**: Display strings are currently hardcoded in extension methods

---

## 15. Implementation Notes

### 15.1 Record Struct Choice

`CharacterCreationViewModel` uses `readonly record struct` because:

- Immutable by design (rebuilt on state change)
- Value semantics (no reference tracking needed)
- Efficient for small, frequently-created objects
- Clean initialization syntax with `init` properties

### 15.2 Provider Dependencies

The ViewModelBuilder depends on all character system providers. This is intentional:

- Centralizes preview logic in one place
- Ensures consistent data transformation
- Enables easy testing via mocks

### 15.3 Null Handling

Preview data (DerivedStatsPreview, AbilitiesPreview, EquipmentPreview) uses nullable types:

- Null means "not yet applicable" (e.g., no archetype selected)
- Empty means "applicable but no items" (e.g., archetype selected but no abilities)
- TUI should handle both cases appropriately

---

## 16. Document Metadata

| Property         | Value                                                        |
| ---------------- | ------------------------------------------------------------ |
| **Document ID**  | v0.17.5b-design-specification                                |
| **Version**      | 1.0                                                          |
| **Status**       | Draft                                                        |
| **Created**      | 2026-01-28                                                   |
| **Last Updated** | 2026-01-28                                                   |
| **Author**       | Claude                                                       |
| **Reviewer**     | [Pending]                                                    |
| **Related Docs** | v0.17.5a-design-specification.md, v0.17.5-scope-breakdown.md |
