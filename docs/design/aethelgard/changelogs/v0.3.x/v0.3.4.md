# Changelog: v0.3.4 - The Facade, The Forge, and The Prologue

**Versions:** v0.3.4a through v0.3.4c

**Release Dates:** 2025-12-21

## Table of Contents

- [Overview](#overview)
- [Part A: The Facade (Visuals & Menu)](#part-a-the-facade-visuals--menu)
  - [Summary](#summary)
  - [New Files Created](#new-files-created)
  - [Files Modified](#files-modified)
  - [Code Implementation Details](#code-implementation-details)
  - [ASCII Title Art](#ascii-title-art)
  - [Test Coverage](#test-coverage)
  - [Logging Matrix](#logging-matrix)
  - [Dependencies](#dependencies)
  - [Notes](#notes)
- [Part B: The Forge (Creation Wizard)](#part-b-the-forge-creation-wizard)
  - [Summary](#summary-1)
  - [New Files Created](#new-files-created-1)
  - [Files Modified](#files-modified-1)
  - [Code Implementation Details](#code-implementation-details-1)
  - [Lineage & Archetype Data](#lineage--archetype-data)
  - [Test Coverage](#test-coverage-1)
  - [Logging Matrix](#logging-matrix-1)
  - [User Interface](#user-interface)
  - [Dependencies](#dependencies-1)
  - [Notes](#notes-1)
- [Part C: The Prologue (Narrative)](#part-c-the-prologue-narrative)
  - [Summary](#summary-2)
  - [New Files Created](#new-files-created-2)
  - [Files Modified](#files-modified-2)
  - [Code Implementation Details](#code-implementation-details-2)
  - [Background Templates (Domain 4 Compliant)](#background-templates-domain-4-compliant)
  - [Test Coverage](#test-coverage-2)
  - [Logging Matrix](#logging-matrix-2)
  - [User Interface](#user-interface-1)
  - [Dependencies](#dependencies-2)
  - [Critical Fixes](#critical-fixes)
  - [Notes](#notes-2)

---

## Overview

Version 0.3.4 represents a comprehensive overhaul of the game's entry experience, delivering a complete player onboarding flow from title screen through character creation to narrative immersion. This three-part release implements an animated ASCII title screen with Elder Futhark glitch effects, a split-screen character creation wizard with real-time stat previews, and a typewriter-style narrative engine for immersive prologue sequences. Additionally, critical architectural fixes ensure proper character bridging from creation to game state, enabling seamless world initialization. The combined release includes 84 unit tests across all components, validating menu routing, stat calculations, Domain 4 compliance, and display name retrieval.

---

## Part A: The Facade (Visuals & Menu)

**Release Date:** 2025-12-21

## Summary

This release implements the title screen and main menu system for Rune & Rust. The TitleScreenService displays an animated ASCII title logo with Elder Futhark rune glitch effects using Spectre.Console's `AnsiConsole.Live()` for smooth real-time animation. The main menu offers four options: New Game, Load Game, Options, and Quit. New Game triggers the CharacterCreationController, Load Game retrieves the most recent save via SaveManager.LoadGameAsync(), Options displays a placeholder message, and Quit exits the application. The TitleScreenResult model encapsulates menu selection with factory methods for each option. MainMenuOption enum provides strongly-typed menu choices. Program.cs has been refactored to display the title screen before entering the game loop, with proper routing based on user selection. This release includes 14 unit tests validating the TitleScreenResult factory methods and MainMenuOption enum values.

---

## New Files Created

### Core Layer
| File | Purpose |
|------|---------|
| `RuneAndRust.Core/Enums/MainMenuOption.cs` | Enum for main menu choices: NewGame, LoadGame, Options, Quit |
| `RuneAndRust.Core/Models/TitleScreenResult.cs` | Result model encapsulating menu selection with factory methods |
| `RuneAndRust.Core/Interfaces/ITitleScreenService.cs` | Interface defining ShowAsync() for title screen display |

### Terminal Layer
| File | Purpose |
|------|---------|
| `RuneAndRust.Terminal/Services/TitleScreenService.cs` | Animated title screen with Elder Futhark glitch effects and menu |

### Test Layer
| File | Purpose |
|------|---------|
| `RuneAndRust.Tests/Terminal/TitleScreenServiceTests.cs` | 14 unit tests for TitleScreenResult and MainMenuOption |

---

## Files Modified

| File | Change |
|------|--------|
| `RuneAndRust.Terminal/Program.cs` | Added ITitleScreenService registration, title screen display before game loop, menu routing for NewGame/LoadGame/Quit, updated version to v0.3.4a |

---

## Code Implementation Details

### MainMenuOption Enum

```csharp
namespace RuneAndRust.Core.Enums;

public enum MainMenuOption
{
    NewGame = 0,
    LoadGame = 1,
    Options = 2,
    Quit = 3
}
```

### TitleScreenResult Model

**Factory Methods:**
```csharp
public static TitleScreenResult CreateNewGame() =>
    new() { SelectedOption = MainMenuOption.NewGame };

public static TitleScreenResult LoadGame(int slotNumber) =>
    new() { SelectedOption = MainMenuOption.LoadGame, SaveSlotNumber = slotNumber };

public static TitleScreenResult Quit() =>
    new() { SelectedOption = MainMenuOption.Quit };
```

**Usage:**
- Private constructor ensures creation only through factory methods
- SaveSlotNumber is nullable, only set for LoadGame selections
- Immutable after creation (private init properties)

### TitleScreenService Animation

**Glitch Effect Characters:**
```csharp
private static readonly char[] GlitchChars = { 'ᚠ', 'ᚢ', 'ᚦ', 'ᚨ', 'ᚱ', 'ᚾ', 'ᛖ', '▓', '░', '▒' };
```

**Animation Parameters:**
- 15 glitch iterations
- 80ms delay between frames
- 3% probability of character replacement per non-whitespace character

**Live Animation:**
```csharp
await AnsiConsole.Live(new Markup(""))
    .StartAsync(async ctx =>
    {
        for (int i = 0; i < GlitchIterations; i++)
        {
            var glitched = ApplyGlitchEffect(lines);
            var panel = new Panel(new Markup($"[red]{Markup.Escape(glitched)}[/]"))
                .Border(BoxBorder.None);
            ctx.UpdateTarget(panel);
            await Task.Delay(GlitchDelayMs);
        }
    });
```

### Program.cs Menu Routing

```csharp
switch (menuResult.SelectedOption)
{
    case MainMenuOption.Quit:
        AnsiConsole.MarkupLine("[grey]Farewell, Traveler...[/]");
        return;

    case MainMenuOption.NewGame:
        using (var scope = host.Services.CreateScope())
        {
            var creation = scope.ServiceProvider.GetRequiredService<CharacterCreationController>();
            creation.RunCreationWizardAsync().GetAwaiter().GetResult();
        }
        break;

    case MainMenuOption.LoadGame:
        if (menuResult.SaveSlotNumber.HasValue)
        {
            using (var scope = host.Services.CreateScope())
            {
                var saveManager = scope.ServiceProvider.GetRequiredService<SaveManager>();
                var gameState = scope.ServiceProvider.GetRequiredService<GameState>();
                var loadedState = saveManager.LoadGameAsync(menuResult.SaveSlotNumber.Value).GetAwaiter().GetResult();
                if (loadedState != null)
                {
                    gameState.CurrentCharacter = loadedState.CurrentCharacter;
                    gameState.CurrentRoomId = loadedState.CurrentRoomId;
                    gameState.Phase = loadedState.Phase;
                    gameState.TurnCount = loadedState.TurnCount;
                }
            }
        }
        break;
}
```

---

## ASCII Title Art

```
╔═══════════════════════════════════════════════════════════════════╗
║                                                                   ║
║   ██████╗ ██╗   ██╗███╗   ██╗███████╗                             ║
║   ██╔══██╗██║   ██║████╗  ██║██╔════╝                             ║
║   ██████╔╝██║   ██║██╔██╗ ██║█████╗                               ║
║   ██╔══██╗██║   ██║██║╚██╗██║██╔══╝                               ║
║   ██║  ██║╚██████╔╝██║ ╚████║███████╗                             ║
║   ╚═╝  ╚═╝ ╚═════╝ ╚═╝  ╚═══╝╚══════╝                             ║
║                           ▲                                       ║
║                          ╱ ╲                                      ║
║   ██████╗ ██╗   ██╗███████╗████████╗                              ║
║   ██╔══██╗██║   ██║██╔════╝╚══██╔══╝                              ║
║   ██████╔╝██║   ██║███████╗   ██║                                 ║
║   ██╔══██╗██║   ██║╚════██║   ██║                                 ║
║   ██║  ██║╚██████╔╝███████║   ██║                                 ║
║   ╚═╝  ╚═╝ ╚═════╝ ╚══════╝   ╚═╝                                 ║
║                                                                   ║
╚═══════════════════════════════════════════════════════════════════╝
```

---

## Test Coverage

### TitleScreenServiceTests (14 tests)

| Test Name | Description |
|-----------|-------------|
| `CreateNewGame_ReturnsNewGameOption` | Verifies CreateNewGame returns NewGame option |
| `CreateNewGame_HasNoSaveSlotNumber` | Verifies CreateNewGame has null SaveSlotNumber |
| `LoadGame_ReturnsLoadGameOption` | Verifies LoadGame returns LoadGame option |
| `LoadGame_ContainsSaveSlotNumber` | Verifies LoadGame stores provided slot number |
| `Quit_ReturnsQuitOption` | Verifies Quit returns Quit option |
| `Quit_HasNoSaveSlotNumber` | Verifies Quit has null SaveSlotNumber |
| `MainMenuOption_HasFourValues` | Verifies enum has exactly 4 values |
| `MainMenuOption_HasCorrectValues` | Theory test validating each enum value |
| `MainMenuOption_AllValuesAreDistinct` | Verifies no duplicate enum values |
| `TitleScreenResult_LoadGame_PreservesSlotNumber` | Verifies slot number immutability |
| `TitleScreenResult_MultipleCalls_ReturnIndependentInstances` | Verifies factory creates new instances |

---

## Logging Matrix

| Context | Level | Template |
|---------|-------|----------|
| Title Screen Display | Info | `"[TitleScreen] Displaying title screen"` |
| New Game Selected | Info | `"[TitleScreen] User selected New Game"` |
| Load Game Selected | Info | `"[TitleScreen] User selected Load Game: Slot {SlotNumber}"` |
| Quit Selected | Info | `"[TitleScreen] User selected Quit"` |

---

## Dependencies

- `Spectre.Console` - AnsiConsole.Live() for animation, SelectionPrompt for menu
- `Microsoft.Extensions.Logging` - Structured logging
- `RuneAndRust.Core.Interfaces.ISaveGameRepository` - Save game lookup

---

## Notes

- Options menu is stubbed (displays message, returns to menu) - full implementation planned for v0.3.4c
- Load Game automatically selects most recent save by LastPlayed timestamp - save selection UI deferred
- Elder Futhark runes provide thematic "corrupted data" visual effect during animation
- Version string updated to v0.3.4a in boot message and title screen

---

## Part B: The Forge (Creation Wizard)

**Release Date:** 2025-12-21

## Summary

This release implements an interactive split-screen character creation wizard with real-time stat previews. The CreationWizard replaces the linear CharacterCreationController with a dynamic UI that shows live stat calculations as the player hovers over lineage and archetype options. The left panel displays selectable options with descriptions and bonuses, while the right panel renders a BarChart visualization of attributes and derived stats. WizardService provides preview stat calculations by combining base attributes with lineage and archetype bonuses. StatPreviewRenderer creates the visual representation using Spectre.Console's BarChart. A custom non-blocking input loop using Console.KeyAvailable and Console.ReadKey(intercept: true) enables ~60fps UI refresh while polling for arrow key navigation. This release includes 33 unit tests validating preview stat calculations, lineage/archetype bonuses, derived stat formulas, and display name retrieval.

---

## New Files Created

### Core Layer
| File | Purpose |
|------|---------|
| `RuneAndRust.Core/Models/WizardContext.cs` | Tracks partial wizard selections (Name, Lineage, Archetype, CurrentStep) |
| `RuneAndRust.Core/Interfaces/IWizardService.cs` | Interface for preview stat calculations with DerivedStats record |

### Engine Layer
| File | Purpose |
|------|---------|
| `RuneAndRust.Engine/Services/WizardService.cs` | Implementation of preview calculations using StatCalculationService |

### Terminal Layer
| File | Purpose |
|------|---------|
| `RuneAndRust.Terminal/Rendering/StatPreviewRenderer.cs` | Static renderer for BarChart stat visualization |
| `RuneAndRust.Terminal/Services/CreationWizard.cs` | Split-screen wizard controller with custom input loop |

### Test Layer
| File | Purpose |
|------|---------|
| `RuneAndRust.Tests/Engine/WizardServiceTests.cs` | 33 unit tests for preview calculations and display names |

---

## Files Modified

| File | Change |
|------|--------|
| `RuneAndRust.Terminal/Program.cs` | Added IWizardService and CreationWizard DI registration, updated NewGame case to use CreationWizard, updated version to v0.3.4b |

---

## Code Implementation Details

### WizardContext Model

```csharp
public class WizardContext
{
    public string Name { get; set; } = string.Empty;
    public LineageType? Lineage { get; set; }
    public ArchetypeType? Archetype { get; set; }
    public int CurrentStep { get; set; } = 0;

    public bool IsStepComplete(int stepIndex) => stepIndex switch
    {
        0 => !string.IsNullOrWhiteSpace(Name),
        1 => Lineage.HasValue,
        2 => Archetype.HasValue,
        _ => false
    };

    public void Reset() { /* clears all fields */ }
    public void ClearCurrentStep() { /* clears current step field */ }
}
```

### DerivedStats Record

```csharp
public record DerivedStats(int MaxHP, int MaxStamina, int ActionPoints);

// Formulas:
// MaxHP = 50 + Sturdiness * 10
// MaxStamina = 20 + Finesse * 5 + Sturdiness * 3
// ActionPoints = 2 + Wits / 4
```

### IWizardService Interface

```csharp
public interface IWizardService
{
    Dictionary<CharacterAttribute, int> GetPreviewStats(
        WizardContext context,
        LineageType? previewLineage = null,
        ArchetypeType? previewArchetype = null);

    DerivedStats GetDerivedStats(
        Dictionary<CharacterAttribute, int> stats,
        ArchetypeType? archetype);

    string GetLineageDisplayName(LineageType lineage);
    string GetLineageDescription(LineageType lineage);
    string GetLineageBonusSummary(LineageType lineage);
    string GetArchetypeDisplayName(ArchetypeType archetype);
    string GetArchetypeDescription(ArchetypeType archetype);
    string GetArchetypeBonusSummary(ArchetypeType archetype);
}
```

### StatPreviewRenderer

```csharp
public static IRenderable Render(
    Dictionary<CharacterAttribute, int> stats,
    DerivedStats derived,
    string? lineageName = null,
    string? archetypeName = null)
{
    // Creates BarChart with 5 attributes
    var chart = new BarChart()
        .Width(30)
        .AddItem("STU", stats[CharacterAttribute.Sturdiness], Color.Green)
        .AddItem("MIG", stats[CharacterAttribute.Might], Color.Red)
        .AddItem("WIT", stats[CharacterAttribute.Wits], Color.Blue)
        .AddItem("WIL", stats[CharacterAttribute.Will], Color.Purple)
        .AddItem("FIN", stats[CharacterAttribute.Finesse], Color.Yellow);

    // Plus derived stats table
    // Returns Rows composition of all elements
}
```

### CreationWizard Split-Screen Layout

```csharp
private async Task<T?> RunSelectionStepAsync<T>(...)
{
    await AnsiConsole.Live(new Text(""))
        .AutoClear(false)
        .StartAsync(async ctx =>
        {
            while (result == null && !cancelled)
            {
                var layout = new Layout("Root")
                    .SplitColumns(
                        new Layout("Left").Size(50),  // Menu panel
                        new Layout("Right"));         // Preview panel

                layout["Left"].Update(menuPanel);
                layout["Right"].Update(previewPanel);
                ctx.UpdateTarget(layout);

                // Non-blocking input check
                if (Console.KeyAvailable)
                {
                    var key = Console.ReadKey(intercept: true);
                    switch (key.Key)
                    {
                        case ConsoleKey.UpArrow:
                        case ConsoleKey.K:
                            _selectedIndex = Math.Max(0, _selectedIndex - 1);
                            break;
                        case ConsoleKey.DownArrow:
                        case ConsoleKey.J:
                            _selectedIndex = Math.Min(options.Length - 1, _selectedIndex + 1);
                            break;
                        case ConsoleKey.Enter:
                        case ConsoleKey.Spacebar:
                            result = options[_selectedIndex];
                            break;
                        case ConsoleKey.Backspace:
                        case ConsoleKey.Escape:
                        case ConsoleKey.Q:
                            cancelled = true;
                            break;
                    }
                }

                await Task.Delay(16); // ~60fps refresh
            }
        });
}
```

---

## Lineage & Archetype Data

### Lineages

| Type | Display Name | Description | Bonuses |
|------|--------------|-------------|---------|
| Human | Human | Adaptable survivors who endure through sheer determination. | +1 to all attributes |
| RuneMarked | Rune-Marked | Descendants bearing ancient runic inscriptions in their skin. | +2 Wits, +2 Will, -1 Sturdiness |
| IronBlooded | Iron-Blooded | Those with machine-integrated bloodlines from the old world. | +2 Sturdiness, +2 Might, -1 Wits |
| VargrKin | Vargr-Kin | Wolf-kin bearing the curse of the northern wastes. | +2 Finesse, +2 Wits, -1 Will |

### Archetypes

| Type | Display Name | Description | Bonuses |
|------|--------------|-------------|---------|
| Warrior | Warrior | Frontline combatant specializing in durability and melee damage. | +2 Sturdiness, +1 Might |
| Skirmisher | Skirmisher | Cunning fighter favoring speed and precision over raw power. | +2 Finesse, +1 Wits |
| Adept | Adept | Runic practitioner channeling ancient power through inscribed formulas. | +2 Wits, +1 Will |
| Mystic | Mystic | Wielder of primal forces, drawing power from the world's corruption. | +2 Will, +1 Sturdiness |

---

## Test Coverage

### WizardServiceTests (33 tests)

| Test Name | Description |
|-----------|-------------|
| `GetPreviewStats_NoSelections_ReturnsBaseStats` | All stats = 5 when nothing selected |
| `GetPreviewStats_EmptyContext_AllAttributesFive` | Verifies all 5 attributes start at 5 |
| `GetPreviewStats_HumanLineage_AddsPlusOneToAll` | Human gives +1 to all attributes |
| `GetPreviewStats_RuneMarkedLineage_AppliesBonuses` | +2 Wits, +2 Will, -1 Sturdiness |
| `GetPreviewStats_IronBloodedLineage_AppliesBonuses` | +2 Sturdiness, +2 Might, -1 Wits |
| `GetPreviewStats_VargrKinLineage_AppliesBonuses` | +2 Finesse, +2 Wits, -1 Will |
| `GetPreviewStats_WarriorArchetype_AppliesBonuses` | +2 Sturdiness, +1 Might |
| `GetPreviewStats_SkirmisherArchetype_AppliesBonuses` | +2 Finesse, +1 Wits |
| `GetPreviewStats_AdeptArchetype_AppliesBonuses` | +2 Wits, +1 Will |
| `GetPreviewStats_MysticArchetype_AppliesBonuses` | +2 Will, +1 Sturdiness |
| `GetPreviewStats_LineageAndArchetype_StackBonuses` | Combines both bonuses correctly |
| `GetPreviewStats_IronBloodedWarrior_MaxSturdiness` | Tests highest possible Sturdiness |
| `GetPreviewStats_PreviewLineage_AppliesWhenContextLineageIsNull` | Preview applied when not confirmed |
| `GetPreviewStats_PreviewLineage_IgnoredWhenContextHasLineage` | Confirmed takes precedence |
| `GetPreviewStats_PreviewArchetype_AppliesWhenContextArchetypeIsNull` | Preview applied when not confirmed |
| `GetPreviewStats_PreviewArchetype_IgnoredWhenContextHasArchetype` | Confirmed takes precedence |
| `GetDerivedStats_CalculatesHPCorrectly` | HP = 50 + Sturdiness * 10 |
| `GetDerivedStats_CalculatesStaminaCorrectly` | Stamina = 20 + Finesse * 5 + Sturdiness * 3 |
| `GetDerivedStats_CalculatesAPCorrectly` | AP = 2 + Wits / 4 |
| `GetDerivedStats_HighStats_CalculatesCorrectly` | Max stats scenario (10s) |
| `GetDerivedStats_LowStats_CalculatesCorrectly` | Min stats scenario (1s) |
| `GetLineageDisplayName_ReturnsCorrectName` | Theory test for all lineages |
| `GetArchetypeDisplayName_ReturnsCorrectName` | Theory test for all archetypes |
| `GetLineageDescription_ReturnsNonEmpty` | All lineages have descriptions |
| `GetArchetypeDescription_ReturnsNonEmpty` | All archetypes have descriptions |
| `GetLineageBonusSummary_ReturnsNonEmpty` | All lineages have bonus summaries |
| `GetArchetypeBonusSummary_ReturnsNonEmpty` | All archetypes have bonus summaries |

---

## Logging Matrix

| Context | Level | Template |
|---------|-------|----------|
| Wizard Start | Info | `"[Wizard] Starting character creation wizard"` |
| Name Entry Cancelled | Info | `"[Wizard] Character creation cancelled at name entry"` |
| Lineage Cancelled | Info | `"[Wizard] Character creation cancelled at lineage selection"` |
| Archetype Cancelled | Info | `"[Wizard] Character creation cancelled at archetype selection"` |
| Step Navigation | Debug | `"[Wizard] Step {StepIndex} - Selection: {Selection}"` |
| Preview Stats | Trace | `"[Wizard] Preview stats: STU:{} MIG:{} WIT:{} WIL:{} FIN:{}"` |
| Character Created | Info | `"[Wizard] Character created: {Name} (ID: {Id})"` |
| Duplicate Name | Warning | `"[Wizard] Duplicate character name attempted: {Name}"` |

---

## User Interface

### Keyboard Controls

| Key | Action |
|-----|--------|
| ↑ / K | Move selection up |
| ↓ / J | Move selection down |
| Enter / Space | Confirm selection |
| Esc / Q / Backspace | Cancel / Go back |

### Split-Screen Layout

```
┌─────────────────────────────────┐┌─────────────────────────────────┐
│ Choose Your Lineage             ││ Preview                         │
│                                 ││ ─────────────────────────────── │
│ ► Human                         ││ STAT PREVIEW                    │
│   Adaptable survivors who...    ││                                 │
│   +1 to all attributes          ││ Lineage: Human                  │
│                                 ││                                 │
│   Rune-Marked                   ││ STU ████████████████ 6          │
│   Descendants bearing...        ││ MIG ████████████████ 6          │
│   +2 Wits, +2 Will, -1 Stur...  ││ WIT ████████████████ 6          │
│                                 ││ WIL ████████████████ 6          │
│   Iron-Blooded                  ││ FIN ████████████████ 6          │
│   Those with machine-integrated ││                                 │
│   +2 Sturdiness, +2 Might, -1...││ Max HP     60                   │
│                                 ││ Stamina    28                   │
│   Vargr-Kin                     ││ Action Pts 2                    │
│   Wolf-kin bearing...           ││                                 │
│   +2 Finesse, +2 Wits, -1 Will  ││                                 │
│─────────────────────────────────││                                 │
│ ↑↓/JK Navigate | Enter/Space... ││                                 │
└─────────────────────────────────┘└─────────────────────────────────┘
```

---

## Dependencies

- `Spectre.Console` - Layout, BarChart, Panel, Rule, Markup for UI rendering
- `Microsoft.Extensions.Logging` - Structured logging
- `RuneAndRust.Core.Interfaces.IStatCalculationService` - Lineage/archetype bonus lookups
- `RuneAndRust.Engine.Factories.CharacterFactory` - CreateSimple() for character creation

---

## Notes

- Name entry uses blocking TextPrompt (no preview needed for name)
- Lineage/Archetype steps use custom input loop with `Console.ReadKey(intercept: true)`
- `AnsiConsole.Live()` enables real-time updates at ~60fps (16ms delay)
- Stats clamped to [1, 10] range via `StatCalculationService.ClampAttribute()`
- BarChart uses abbreviated attribute names: STU, MIG, WIT, WIL, FIN
- Vim-style navigation (J/K) supported in addition to arrow keys
- Version string updated to v0.3.4b in Program.cs boot message

---

## Part C: The Prologue (Narrative)

**Release Date:** 2025-12-21

## Summary

This release implements a narrative engine to deliver immersive, typewriter-style introductory sequences after character creation. The NarrativeService generates Domain 4-compliant prologue text based on the player's chosen Background, while the TypewriterRenderer provides animated text output with dynamic pacing and skip functionality. A critical fix bridges the character from CreationWizard to GameState, ensuring proper world initialization before the game loop starts. This release includes a new Background selection step in the character creation wizard and 37 unit tests validating prologue generation and Domain 4 compliance.

---

## New Files Created

### Core Layer
| File | Purpose |
|------|---------|
| `RuneAndRust.Core/Enums/BackgroundType.cs` | Enum for narrative backgrounds: Scavenger, Exile, Scholar, Soldier, Noble, Cultist |
| `RuneAndRust.Core/Interfaces/INarrativeService.cs` | Interface for prologue text generation |
| `RuneAndRust.Core/Interfaces/ITypewriterRenderer.cs` | Interface for typewriter animation |

### Engine Layer
| File | Purpose |
|------|---------|
| `RuneAndRust.Engine/Services/NarrativeService.cs` | Generates Domain 4-compliant prologue text for each background |

### Terminal Layer
| File | Purpose |
|------|---------|
| `RuneAndRust.Terminal/Rendering/TypewriterRenderer.cs` | Animated text output with dynamic pacing and skip functionality |

### Test Layer
| File | Purpose |
|------|---------|
| `RuneAndRust.Tests/Engine/NarrativeServiceTests.cs` | 37 unit tests for prologue generation and Domain 4 compliance |

---

## Files Modified

| File | Change |
|------|--------|
| `RuneAndRust.Core/Entities/Character.cs` | Added `BackgroundType Background` property |
| `RuneAndRust.Core/Models/WizardContext.cs` | Added `BackgroundType? Background` property, updated IsStepComplete, Reset, ClearCurrentStep |
| `RuneAndRust.Engine/Factories/CharacterFactory.cs` | Updated CreateSimple() to accept BackgroundType parameter |
| `RuneAndRust.Terminal/Services/CreationWizard.cs` | Added INarrativeService dependency, Step 3 Background selection, RunSimpleSelectionStepAsync method |
| `RuneAndRust.Terminal/Program.cs` | CRITICAL FIX: Capture character from wizard, bridge to GameState, initialize dungeon, play prologue, register new services, update version to v0.3.4c |

---

## Code Implementation Details

### BackgroundType Enum

```csharp
public enum BackgroundType
{
    Scavenger = 0,  // Born among the rust heaps, surviving on salvage
    Exile = 1,      // Cast out from a settlement for crimes real or imagined
    Scholar = 2,    // Seeker of forbidden knowledge from the old world
    Soldier = 3,    // Former soldier from a fallen outpost
    Noble = 4,      // Survivor of noble lineage, now dispossessed
    Cultist = 5     // Once a follower of a corrupted faith
}
```

### NarrativeService Prologue Generation

```csharp
public string GetPrologueText(Character character)
{
    return character.Background switch
    {
        BackgroundType.Scavenger =>
            $"The rust has always been your horizon, {character.Name}. You were born in the shadow of " +
            $"the Great Looms, scavenging the bones of dead gods...",

        BackgroundType.Scholar =>
            $"You have read the forbidden slates, {character.Name}. You know the world is not a tragedy, " +
            $"but a broken mechanism...",

        // ... other backgrounds
    };
}
```

### TypewriterRenderer with Dynamic Pacing

```csharp
public async Task PlaySequenceAsync(string text, int delayMs = 30)
{
    foreach (char c in text)
    {
        if (Console.KeyAvailable)
        {
            Console.ReadKey(intercept: true);
            // Print remaining text instantly
            var remaining = text.Substring(charIndex);
            AnsiConsole.Markup($"[grey]{Markup.Escape(remaining)}[/]");
            break;
        }

        AnsiConsole.Markup($"[grey]{Markup.Escape(c.ToString())}[/]");

        // Dynamic pacing: longer pause at punctuation
        var currentDelay = c is '.' or '!' or '?' ? delayMs * 8 :
                           c is ',' or ';' or ':' ? delayMs * 3 :
                           c is '—' ? delayMs * 4 : delayMs;
        await Task.Delay(currentDelay);
    }

    AnsiConsole.MarkupLine("[grey italic]Press any key to enter the ruins...[/]");
    Console.ReadKey(intercept: true);
}
```

### Critical Bridge Fix in Program.cs

```csharp
case MainMenuOption.NewGame:
    Character? character = null;
    using (var scope = host.Services.CreateScope())
    {
        var wizard = scope.ServiceProvider.GetRequiredService<CreationWizard>();
        character = wizard.RunAsync().GetAwaiter().GetResult();
    }

    if (character != null)
    {
        // CRITICAL FIX: Bridge character to GameState
        var gameState = host.Services.GetRequiredService<GameState>();
        gameState.CurrentCharacter = character;
        gameState.Phase = GamePhase.Exploration;

        // Generate starting dungeon
        using (var scope = host.Services.CreateScope())
        {
            var dungeonGen = scope.ServiceProvider.GetRequiredService<DungeonGenerator>();
            var startRoomId = dungeonGen.GenerateTestMapAsync().GetAwaiter().GetResult();
            gameState.CurrentRoomId = startRoomId;
        }

        // Play prologue
        using (var scope = host.Services.CreateScope())
        {
            var narrative = scope.ServiceProvider.GetRequiredService<INarrativeService>();
            var typewriter = scope.ServiceProvider.GetRequiredService<ITypewriterRenderer>();
            var prologueText = narrative.GetPrologueText(character);
            typewriter.PlaySequenceAsync(prologueText).GetAwaiter().GetResult();
        }
    }
    break;
```

---

## Background Templates (Domain 4 Compliant)

| Background | Prologue Theme | Key Imagery |
|------------|---------------|-------------|
| Scavenger | Born in rust, survival instinct | Great Looms, dead gods, thinning scrap |
| Scholar | Forbidden knowledge, broken mechanism | Forbidden slates, Iron Hearts, burden of understanding |
| Exile | Outcast, survival alone | Stones and curses, wastelands, cold stars |
| Soldier | Fallen defender, lost purpose | Screaming iron, fallen walls, forgotten peace |
| Noble | Fallen aristocracy, blood-earned respect | Black glass towers, worthless bloodline |
| Cultist | Corrupted faith, seeking silence | Corroded Altar, forbidden prayers, unhearable voice |

---

## Test Coverage

### NarrativeServiceTests (37 tests)

| Test Name | Description |
|-----------|-------------|
| `GetPrologueText_Scavenger_ContainsGreatLooms` | Scavenger text includes "Great Looms" |
| `GetPrologueText_Scholar_ContainsForbiddenSlates` | Scholar text includes "forbidden slates" |
| `GetPrologueText_AllBackgrounds_ContainsCharacterName` | Theory: All 6 prologues include character name |
| `GetPrologueText_AllBackgrounds_ContainsArchetype` | Theory: All prologues include archetype |
| `GetPrologueText_NoPrecisionMeasurements` | Theory: No "meters", "seconds", "percent" in text (Domain 4) |
| `GetPrologueText_Exile_ContainsWastelands` | Exile text includes "wastelands" |
| `GetPrologueText_Soldier_ContainsWallsFell` | Soldier text includes "walls fell" |
| `GetPrologueText_Noble_ContainsBlackGlass` | Noble text includes "black glass" |
| `GetPrologueText_Cultist_ContainsCorrodedAltar` | Cultist text includes "Corroded Altar" |
| `GetBackgroundDisplayName_ReturnsCorrectName` | Theory: All 6 backgrounds return correct names |
| `GetBackgroundDescription_ReturnsNonEmpty` | Theory: All backgrounds have descriptions |
| `GetBackgroundDescription_Scavenger_ContainsSalvage` | Scavenger description includes "salvage" |

---

## Logging Matrix

| Context | Level | Template |
|---------|-------|----------|
| Prologue Start | Info | `"[Narrative] Generating prologue for {Name}, Background: {Background}"` |
| Prologue Length | Debug | `"[Narrative] Prologue generated: {Length} characters"` |
| Typewriter Start | Info | `"[Narrative] Starting typewriter sequence, {Length} characters"` |
| Prologue Skip | Debug | `"[Narrative] User skipped prologue sequence at character {Index}"` |
| Prologue End | Info | `"[Narrative] Prologue complete. Transitioning to Exploration."` |
| Character Bridge | Debug | `"[Program] Character {Name} set to GameState"` |
| World Init | Info | `"[Program] World initialized: Starting room {RoomId}"` |

---

## User Interface

### Character Creation Flow (Updated)

```
Step 0: Name Entry (blocking TextPrompt)
   ↓
Step 1: Lineage Selection (split-screen with stat preview)
   ↓
Step 2: Archetype Selection (split-screen with stat preview)
   ↓
Step 3: Background Selection (simple menu) ← NEW
   ↓
Character Created → Dungeon Generated → Prologue Played → Game Loop
```

### Prologue Display

```
────────────────────────────────────────────────────────────────────
 PROLOGUE
────────────────────────────────────────────────────────────────────

The rust has always been your horizon, Ragnar. You were born in the
shadow of the Great Looms, scavenging the bones of dead gods while
others huddled behind their walls. But the scrap is thinning. The
whispers in the dark grow louder. You seek the Warrior path not for
glory, but to survive the silence that follows the machines.



Press any key to enter the ruins...
```

---

## Dependencies

- `Spectre.Console` - AnsiConsole, Rule, Markup for typewriter rendering
- `Microsoft.Extensions.Logging` - Structured logging
- `RuneAndRust.Core.Entities.Character` - Character entity with Background property
- `RuneAndRust.Engine.Services.DungeonGenerator` - World initialization

---

## Critical Fixes

### Issue: Character Not Bridged to GameState

**Before v0.3.4c:**
- CreationWizard returned Character but Program.cs ignored the return value
- GameState.CurrentCharacter remained null after wizard
- No dungeon was generated before GameService.StartAsync()

**After v0.3.4c:**
- Character captured from wizard return value
- GameState.CurrentCharacter properly set
- DungeonGenerator.GenerateTestMapAsync() called to create starting room
- GameState.CurrentRoomId set to starting room
- GamePhase set to Exploration before game loop
- Prologue played after world initialization

---

## Notes

- All prologue text is **Domain 4 compliant**: no precision measurements, no modern tech terms
- Typewriter uses dynamic pacing: 8x delay at periods, 3x at commas, 4x at em dashes
- Skip functionality uses `Console.KeyAvailable` check each character
- Background selection uses simple menu (no stat preview needed)
- Character must be bridged to GameState BEFORE GameService.StartAsync()
- Version string updated to v0.3.4c in Program.cs boot message
