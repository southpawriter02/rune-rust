# Design Specification: v0.19.4a - Jötunheim & Vanaheim Implementation

**Version:** v0.19.4a
**Status:** Design Phase
**Last Updated:** 2026-01-28
**Target Tests:** ~22 unit and integration tests
**Decks Implemented:** Deck 07 (Jötunheim), Deck 03 (Vanaheim)

---

## 1. Executive Summary

Version 0.19.4a introduces two Norse-themed realm decks with fundamentally different mechanical systems and environmental properties. This implementation focuses on:

- **Jötunheim (Deck 07):** Industrial graveyard with giant-scale mechanics, tripled fall damage, and catastrophic corrosion
- **Vanaheim (Deck 03):** Overgrown laboratory with mutagenic spore exposure, corruption accumulation, and full vertical stratification
- **Vertical Stratification:** Both realms feature 5-6 Z-level ranges with zone-specific difficulty progression
- **Condition Systems:** GiantScale mechanics for Jötunheim; MutagenicSpores with Corruption tracking for Vanaheim

Target coverage: ~22 comprehensive tests validating zone mechanics, fall damage calculations, spore corruption, vertical traversal, and environmental effects.

---

## 2. Feature Overview

### 2.1 Jötunheim (Deck 07) - The Industrial Graveyard

**Conceptual Theme:** A colossal graveyard of broken machinery and giant architecture, where scale effects dominate gameplay.

**Key Features:**
- GiantScale primary condition (3.0x scale multiplier)
- Three distinct zones with increasing difficulty
- Catastrophic fall damage (3d6 per 10ft instead of standard 1d6)
- Vertical range: Z-1 to Z+3
- Environmental stress: High corrosion (0.5), low humidity (40%), minimal light (0.5)
- Temperature baseline: 10°C (cold industrial environment)

**Zones:**

| Zone | Difficulty | Description | Key Mechanics |
|------|-----------|-------------|---|
| Bone Yards | DC 10 | Entry zone with scattered giant remains | Basic GiantScale, moderate fall damage |
| Utgard's Shadow | DC 12 | Transition zone under massive iron structures | Increased corrosion, equipment degradation risk |
| Grinding Hall | DC 16 | Boss area with active industrial machinery | Maximum scale effects, deadly environmental hazards |

### 2.2 Vanaheim (Deck 03) - The Overgrown Laboratory

**Conceptual Theme:** An abandoned magical research facility consumed by uncontrolled botanical mutation, where biological corruption is the primary threat.

**Key Features:**
- MutagenicSpores primary condition
- Corruption accumulation on failed checks (max DC 20)
- Full vertical stratification (Z-2 to Z+3)
- Three distinct ecological zones
- Environmental stress: High humidity (85%), warm (28°C), moderate aetheric saturation (0.5)
- Spore-based mechanics with Constitution saves

**Zones:**

| Zone | Difficulty | Corruption Multiplier | Description | Key Mechanics |
|------|-----------|--------|-------------|---|
| Undergrowth | DC 10 | 1x | Dense ground vegetation and root systems | Entry level corruption |
| Canopy Sea | DC 16 | 2x | Aerial fungal cloud layer | Accelerated corruption accumulation |
| Ymir's Roots | DC 12 | 1x | Deep cavern system with ancient biomatter | Corruption sources and repositories |

---

## 3. Architecture Overview

### 3.1 System Components

```
┌─────────────────────────────────────────────────────────────┐
│                    Realm System (v0.19.4a)                  │
├─────────────────────────────────────────────────────────────┤
│                                                               │
│  ┌──────────────────┐  ┌──────────────────┐                 │
│  │  Jötunheim Deck  │  │  Vanaheim Deck   │                 │
│  │     (Deck 07)    │  │   (Deck 03)      │                 │
│  ├──────────────────┤  ├──────────────────┤                 │
│  │ - GiantScale     │  │ - MutagenicSpores│                 │
│  │ - Fall Damage    │  │ - Corruption     │                 │
│  │ - Corrosion      │  │ - Stratification │                 │
│  │ - 3 Zones        │  │ - 3 Zones        │                 │
│  │ - Z -1 to Z +3   │  │ - Z -2 to Z +3   │                 │
│  └──────────────────┘  └──────────────────┘                 │
│         │                        │                          │
│         └────────┬───────────────┘                          │
│                  │                                          │
│         ┌────────▼─────────┐                               │
│         │ Zone Management  │                               │
│         │ - Difficulty DC  │                               │
│         │ - Properties     │                               │
│         │ - Conditions     │                               │
│         └──────────────────┘                               │
│                  │                                          │
│         ┌────────▼──────────────┐                          │
│         │ Environmental System  │                          │
│         │ - Temperature         │                          │
│         │ - Humidity            │                          │
│         │ - Aetheric Saturation │                          │
│         │ - Light Levels        │                          │
│         │ - Corrosion Rates     │                          │
│         └───────────────────────┘                          │
│                                                               │
└─────────────────────────────────────────────────────────────┘
```

### 3.2 Condition Systems

**Jötunheim Conditions:**
- `GiantScale`: Multiplier for physical effects (3.0x)
- `Corrosion`: Equipment degradation progression
- `Collapse`: Environmental hazard state

**Vanaheim Conditions:**
- `MutagenicSpores`: Spore exposure counter
- `Corruption`: Cumulative condition (0-20 DC scaling)
- `Mutation`: Character state alteration

---

## 4. Base Environment Properties

### 4.1 Jötunheim Properties

```json
{
  "realm_id": "jotunheim",
  "deck_number": 7,
  "name": "Jötunheim - The Industrial Graveyard",
  "base_properties": {
    "temperature_celsius": 10,
    "aetheric_saturation": 0.2,
    "humidity_percent": 40,
    "light_level": 0.5,
    "scale_multiplier": 3.0,
    "corrosion_rate": 0.5
  },
  "primary_condition": "GiantScale",
  "vertical_range": {
    "min_z": -1,
    "max_z": 3
  }
}
```

### 4.2 Vanaheim Properties

```json
{
  "realm_id": "vanaheim",
  "deck_number": 3,
  "name": "Vanaheim - The Overgrown Laboratory",
  "base_properties": {
    "temperature_celsius": 28,
    "aetheric_saturation": 0.5,
    "humidity_percent": 85,
    "light_level": 0.6,
    "scale_multiplier": 1.0,
    "corrosion_rate": 0.4
  },
  "primary_condition": "MutagenicSpores",
  "vertical_range": {
    "min_z": -2,
    "max_z": 3
  }
}
```

---

## 5. Zone Configuration

### 5.1 Jötunheim Zones

#### 5.1.1 The Bone Yards (DC 10)

**Location:** Z-1 to Z+1 (entry level stratification)
**Description:** Scattered remains of giant skeletons and broken mechanical parts.

**Environmental Modifiers:**
- Temperature: Base (10°C)
- Humidity: Base (40%)
- Light: Base (0.5)
- Hazard Level: Moderate

**Challenges:**
- Navigation DC 10 (slippery bone surfaces)
- Strength checks for moving debris (DC 10)
- Perception checks to find safe paths (DC 11)

#### 5.1.2 Utgard's Shadow (DC 12)

**Location:** Z+1 to Z+2 (mid-level)
**Description:** Massive iron and steel structures casting deep shadows; corroded machinery dominates.

**Environmental Modifiers:**
- Temperature: -2°C (cold shadow effect)
- Corrosion Rate: +0.2 (0.7 total)
- Visibility: Reduced by 20%

**Challenges:**
- Navigation DC 12 (treacherous corroded platforms)
- Equipment degradation checks (DC 11)
- Perception to avoid falling machinery (DC 13)

#### 5.1.3 The Grinding Hall (DC 16)

**Location:** Z+2 to Z+3 (peak difficulty)
**Description:** Central chamber with colossal grinding mechanisms still partially operational.

**Environmental Modifiers:**
- Temperature: -5°C (extreme cold)
- Corrosion Rate: +0.3 (0.8 total)
- Hazard Density: Extreme
- Noise Level: Deafening (Constitution saves required)

**Challenges:**
- Navigation DC 16 (active machinery, unpredictable movements)
- Dexterity saves to avoid grinding mechanisms (DC 14)
- Constitution saves vs. noise (DC 13)
- Multiple hazard layering

### 5.2 Vanaheim Zones

#### 5.2.1 The Undergrowth (DC 10)

**Location:** Z-1 to Z+1 (ground level and lower)
**Description:** Dense vegetation, massive root systems, initial spore exposure.

**Environmental Modifiers:**
- Temperature: Base (28°C)
- Humidity: Base (85%)
- Spore Density: Low to Moderate
- Corruption Multiplier: 1x

**Challenges:**
- Navigation DC 10 (dense vegetation)
- Constitution saves vs. spores (DC 10)
- Perception DC 11 (spotting paths through undergrowth)
- Corruption gain: 1d4 per failed save

#### 5.2.2 The Canopy Sea (DC 16, 2x Corruption)

**Location:** Z+1 to Z+3 (aerial layer)
**Description:** Dense aerial fungal cloud, floating platforms, extreme biological activity.

**Environmental Modifiers:**
- Temperature: +3°C (hot upper layer)
- Humidity: 95% (near-saturated)
- Spore Density: Extreme
- Corruption Multiplier: 2x (accelerated accumulation)

**Challenges:**
- Navigation DC 16 (limited visibility, treacherous platforms)
- Constitution saves vs. spores (DC 16)
- Reflex saves for platform stability (DC 14)
- Corruption gain: 2d4 per failed save (DOUBLED from base)

#### 5.2.3 Ymir's Roots (DC 12)

**Location:** Z-2 to Z-1 (deep cavern)
**Description:** Ancient root systems forming cavern walls; slow-moving biomass; ancient corruption sources.

**Environmental Modifiers:**
- Temperature: +5°C (geothermal warmth)
- Humidity: 90%
- Spore Density: Moderate
- Corruption Multiplier: 1x
- Aetheric Saturation: +0.1 (0.6 total)

**Challenges:**
- Navigation DC 12 (root obstacles, unstable ground)
- Arcana checks to understand ancient corruption (DC 13)
- Constitution saves vs. spores (DC 12)
- Corruption gain: 1d4 per failed save

---

## 6. Scale Mechanics (Jötunheim)

### 6.1 GiantScale System

**Definition:** The GiantScale condition applies a 3.0x multiplier to all scale-dependent effects. This fundamentally alters how damage, movement, and physical interactions work.

### 6.2 Fall Damage Calculation

**Standard D&D Fall Damage:** 1d6 per 10 feet (maximum 20d6)
**Jötunheim Fall Damage:** 3d6 per 10 feet (maximum 60d6)

```rust
/// Calculate fall damage for Jötunheim's GiantScale environment
pub fn calculate_jotunheim_fall_damage(distance_feet: i32) -> (i32, i32, i32) {
    // Returns (min_damage, max_damage, num_dice)
    // Standard: 1d6 per 10ft
    // GiantScale 3.0x: 3d6 per 10ft

    let num_ten_ft_increments = (distance_feet + 9) / 10;
    let num_dice = num_ten_ft_increments * 3; // GiantScale multiplier

    let min_damage = num_dice;
    let max_damage = num_dice * 6;

    (min_damage, max_damage, num_dice)
}

/// Example implementations
#[cfg(test)]
mod tests {
    use super::*;

    #[test]
    fn test_fall_damage_10_feet() {
        let (min, max, dice) = calculate_jotunheim_fall_damage(10);
        assert_eq!(dice, 3);        // 3d6 instead of 1d6
        assert_eq!(min, 3);         // min 3
        assert_eq!(max, 18);        // max 18
    }

    #[test]
    fn test_fall_damage_30_feet() {
        let (min, max, dice) = calculate_jotunheim_fall_damage(30);
        assert_eq!(dice, 9);        // 9d6 instead of 3d6
        assert_eq!(min, 9);
        assert_eq!(max, 54);
    }

    #[test]
    fn test_fall_damage_200_feet_capped() {
        let (min, max, dice) = calculate_jotunheim_fall_damage(200);
        assert_eq!(dice, 60);       // capped at 60d6
        assert_eq!(min, 60);
        assert_eq!(max, 360);
    }
}
```

### 6.3 GiantScale Equipment Effects

Items and equipment gain additional properties in the Jötunheim environment:

- **Weapon Damage:** Multiplied by 3.0x (e.g., a shortsword deals 3d6+3 instead of 1d6+1)
- **Armor AC Benefit:** Doubled (e.g., plate armor grants +4 AC instead of +3)
- **Carrying Capacity:** Items weigh 3x as much (gravitational scale effect)
- **Jump Distance:** Tripled (giant stride)

---

## 7. Corruption Mechanics (Vanaheim)

### 7.1 MutagenicSpores System

**Definition:** Characters exposed to Vanaheim's mutagenic spores accumulate Corruption, a cumulative condition that ranges from 0 to 20 DC (maximum). Corruption affects all Constitution-based saves and exposes characters to mutation effects.

### 7.2 Corruption Accumulation

**Base Rules:**
- Spore exposure automatically triggers Constitution saves at zone-specific DCs
- Failed saves result in Corruption gain, modified by zone multiplier
- Corruption accumulation can cause permanent mutations at threshold levels

**Corruption Gain Formula:**

```rust
pub fn calculate_corruption_gain(
    base_amount: i32,
    zone_multiplier: f32,
    character_con_modifier: i32,
) -> i32 {
    // Base corruption gain, adjusted for zone multiplier
    let multiplied = (base_amount as f32 * zone_multiplier) as i32;

    // Reduce by Constitution modifier (minimum 1)
    let reduced = std::cmp::max(1, multiplied - character_con_modifier);

    reduced
}

#[cfg(test)]
mod corruption_tests {
    use super::*;

    #[test]
    fn test_undergrowth_corruption_gain() {
        // Base 1d4 (rolling 3), 1x multiplier, +2 CON modifier
        let gain = calculate_corruption_gain(3, 1.0, 2);
        assert_eq!(gain, 1); // 3 - 2 = 1
    }

    #[test]
    fn test_canopy_sea_corruption_doubled() {
        // Base 2d4 (rolling 5), 2x multiplier, +1 CON modifier
        let gain = calculate_corruption_gain(5, 2.0, 1);
        assert_eq!(gain, 9); // (5 * 2.0) - 1 = 9
    }

    #[test]
    fn test_corruption_minimum_one() {
        // Even with high CON, minimum gain is 1
        let gain = calculate_corruption_gain(1, 1.0, 5);
        assert_eq!(gain, 1);
    }
}
```

### 7.3 Corruption Thresholds and Effects

| Corruption Level | Effect | Game Impact |
|---|---|---|
| 0-3 | Minimal | No penalties |
| 4-7 | Mild | -1 to Wisdom saves; minor skin discoloration |
| 8-11 | Moderate | -2 to Wisdom saves; visible mutations forming |
| 12-15 | Severe | -3 to Wisdom saves; significant mutations; ability penalties |
| 16-19 | Critical | -4 to Wisdom saves; major physical alterations; reduced movement |
| 20 | Catastrophic | Character transformation; possible loss of control |

### 7.4 Spore Constitution Save Mechanics

```rust
/// Represents a spore exposure event in Vanaheim
#[derive(Debug, Clone)]
pub struct SporeExposure {
    pub zone_dc: i32,
    pub base_corruption: i32,
    pub zone_multiplier: f32,
    pub character_con: i32,
}

impl SporeExposure {
    /// Determine if character succeeds vs. spore exposure
    pub fn attempt_save(&self, d20_roll: i32) -> (bool, i32) {
        let con_modifier = (self.character_con - 10) / 2;
        let total = d20_roll + con_modifier;
        let success = total >= self.zone_dc;

        if success {
            (true, 0) // No corruption gain on success
        } else {
            let corruption_gain = calculate_corruption_gain(
                self.base_corruption,
                self.zone_multiplier,
                con_modifier,
            );
            (false, corruption_gain)
        }
    }
}

#[cfg(test)]
mod spore_tests {
    use super::*;

    #[test]
    fn test_undergrowth_spore_exposure_success() {
        let exposure = SporeExposure {
            zone_dc: 10,
            base_corruption: 3,
            zone_multiplier: 1.0,
            character_con: 14,
        };

        // d20 roll of 12 + CON mod (+2) = 14, beats DC 10
        let (success, corruption) = exposure.attempt_save(12);
        assert!(success);
        assert_eq!(corruption, 0);
    }

    #[test]
    fn test_canopy_sea_spore_exposure_failure() {
        let exposure = SporeExposure {
            zone_dc: 16,
            base_corruption: 5,
            zone_multiplier: 2.0,
            character_con: 12,
        };

        // d20 roll of 8 + CON mod (+1) = 9, fails DC 16
        let (success, corruption) = exposure.attempt_save(8);
        assert!(!success);
        assert_eq!(corruption, 9); // (5 * 2.0) - 1 = 9
    }
}
```

---

## 8. Vertical Stratification System

### 8.1 Z-Level Architecture

Both realms feature complex vertical structures that impact navigation and environmental effects.

**Jötunheim Vertical Range: Z-1 to Z+3**

```
Z+3  │ ████████████░░░░░░░░░░░ Grinding Hall (peak)
     │ ████████████████░░░░░░░ - Extreme hazards
     │ ████████████████████░░░ - Maximum corrosion
     │
Z+2  │ ██████████░░░░░░░░░░░░░ Utgard's Shadow (upper)
     │ ██████████████░░░░░░░░░ - Corroded structures
     │ ██████████████████░░░░░ - High fall damage zones
     │
Z+1  │ ████░░░░░░░░░░░░░░░░░░░ Bone Yards (mid)
     │ ████████░░░░░░░░░░░░░░░ - Scattered remains
     │ ████████████░░░░░░░░░░░ - Moderate hazards
     │
Z+0  │ ██████░░░░░░░░░░░░░░░░░ Ground reference level
     │
Z-1  │ ██████████░░░░░░░░░░░░░ Collapsed sections (floor)
     │ ██████████████░░░░░░░░░ - Unstable terrain
     │ ██████████████████░░░░░ - Maximum depth
```

**Vanaheim Vertical Range: Z-2 to Z+3**

```
Z+3  │ ░░░░░░░░░░░░░░░░░░░░░░░ Canopy Sea (peak)
     │ ░░░░░░░░░░░░░░░░░░░░░░░ - Extreme spore density
     │ ░░░░░░░░░░░░░░░░░░░░░░░ - 2x Corruption multiplier
     │
Z+2  │ ▒▒▒▒▒▒▒▒▒░░░░░░░░░░░░░░ Upper Canopy (mid-high)
     │ ▒▒▒▒▒▒▒▒▒▒▒░░░░░░░░░░░░ - Fungal growth
     │ ▒▒▒▒▒▒▒▒▒▒▒▒▒░░░░░░░░░░ - Moderate spore exposure
     │
Z+1  │ ██████░░░░░░░░░░░░░░░░░ Undergrowth (mid)
     │ ██████████░░░░░░░░░░░░░ - Dense vegetation
     │ ██████████████░░░░░░░░░ - 1x Corruption
     │
Z+0  │ ██████████░░░░░░░░░░░░░ Ground reference level
     │
Z-1  │ █████████████░░░░░░░░░░ Upper Roots (shallow depth)
     │ █████████████████░░░░░░ - Root systems
     │ █████████████████████░░ - Ancient biomass
     │
Z-2  │ ███████████████████░░░░░ Ymir's Roots (deep caverns)
     │ ███████████████████████░ - Extreme corruption sources
     │ ███████████████████████░ - Geothermal activity
```

### 8.2 Vertical Traversal Mechanics

**Movement Penalties by Zone:**

```rust
pub enum ZoneVerticalEffect {
    /// Open movement, no penalties
    Clear,
    /// Movement reduced by 25%
    Obstructed,
    /// Movement reduced by 50%, difficult terrain
    Difficult,
    /// Movement reduced by 75%, hazardous navigation
    Extreme,
    /// Movement impossible without special conditions
    Impassable,
}

impl ZoneVerticalEffect {
    pub fn movement_multiplier(&self) -> f32 {
        match self {
            ZoneVerticalEffect::Clear => 1.0,
            ZoneVerticalEffect::Obstructed => 0.75,
            ZoneVerticalEffect::Difficult => 0.5,
            ZoneVerticalEffect::Extreme => 0.25,
            ZoneVerticalEffect::Impassable => 0.0,
        }
    }
}

/// Maps Jötunheim zones to vertical effects
pub fn jotunheim_vertical_effect(z_level: i32) -> ZoneVerticalEffect {
    match z_level {
        -1 => ZoneVerticalEffect::Difficult,      // Collapsed sections
        0 => ZoneVerticalEffect::Obstructed,      // Ground level
        1 => ZoneVerticalEffect::Obstructed,      // Bone Yards transition
        2 => ZoneVerticalEffect::Difficult,       // Utgard's Shadow
        3 => ZoneVerticalEffect::Extreme,         // Grinding Hall
        _ => ZoneVerticalEffect::Impassable,
    }
}

/// Maps Vanaheim zones to vertical effects
pub fn vanaheim_vertical_effect(z_level: i32) -> ZoneVerticalEffect {
    match z_level {
        -2 => ZoneVerticalEffect::Difficult,      // Ymir's Roots (deep)
        -1 => ZoneVerticalEffect::Obstructed,     // Upper roots
        0 => ZoneVerticalEffect::Clear,           // Ground level
        1 => ZoneVerticalEffect::Obstructed,      // Undergrowth upper
        2 => ZoneVerticalEffect::Difficult,       // Mid-canopy
        3 => ZoneVerticalEffect::Extreme,         // Canopy peak
        _ => ZoneVerticalEffect::Impassable,
    }
}

#[cfg(test)]
mod vertical_tests {
    use super::*;

    #[test]
    fn test_jotunheim_ground_level_obstructed() {
        assert_eq!(
            jotunheim_vertical_effect(0).movement_multiplier(),
            0.75
        );
    }

    #[test]
    fn test_vanaheim_canopy_peak_extreme() {
        assert_eq!(
            vanaheim_vertical_effect(3).movement_multiplier(),
            0.25
        );
    }
}
```

---

## 9. Configuration Files

### 9.1 jotunheim.json

```json
{
  "$schema": "https://rune-rust.dev/schemas/deck-config-v1.json",
  "realm": {
    "id": "jotunheim",
    "name": "Jötunheim - The Industrial Graveyard",
    "deck_number": 7,
    "version": "0.19.4a",
    "description": "Colossal graveyard of broken machinery with GiantScale mechanics"
  },
  "base_environment": {
    "temperature_celsius": 10,
    "humidity_percent": 40,
    "light_level": 0.5,
    "aetheric_saturation": 0.2,
    "scale_multiplier": 3.0,
    "corrosion_rate": 0.5
  },
  "primary_condition": {
    "type": "GiantScale",
    "multiplier": 3.0,
    "effects": [
      "fall_damage_tripled",
      "weapon_damage_tripled",
      "armor_benefit_doubled",
      "carrying_capacity_tripled"
    ]
  },
  "zones": [
    {
      "id": "bone_yards",
      "name": "The Bone Yards",
      "difficulty_class": 10,
      "description": "Entry-level zone with scattered giant remains",
      "vertical_range": {
        "min_z": -1,
        "max_z": 1
      },
      "environmental_modifiers": {
        "temperature_delta": 0,
        "humidity_delta": 0,
        "light_delta": 0,
        "corrosion_delta": 0.0
      },
      "challenges": [
        {
          "type": "navigation",
          "dc": 10,
          "description": "Slippery bone surfaces"
        },
        {
          "type": "strength",
          "dc": 10,
          "description": "Moving debris obstacles"
        },
        {
          "type": "perception",
          "dc": 11,
          "description": "Finding safe paths through remains"
        }
      ]
    },
    {
      "id": "utgard_shadow",
      "name": "Utgard's Shadow",
      "difficulty_class": 12,
      "description": "Transition zone under massive iron structures",
      "vertical_range": {
        "min_z": 1,
        "max_z": 2
      },
      "environmental_modifiers": {
        "temperature_delta": -2,
        "humidity_delta": 0,
        "light_delta": -0.2,
        "corrosion_delta": 0.2
      },
      "challenges": [
        {
          "type": "navigation",
          "dc": 12,
          "description": "Treacherous corroded platforms"
        },
        {
          "type": "equipment_degradation",
          "dc": 11,
          "description": "Corrosion resistance check"
        },
        {
          "type": "perception",
          "dc": 13,
          "description": "Avoiding falling machinery"
        }
      ]
    },
    {
      "id": "grinding_hall",
      "name": "The Grinding Hall",
      "difficulty_class": 16,
      "description": "Boss chamber with active industrial machinery",
      "vertical_range": {
        "min_z": 2,
        "max_z": 3
      },
      "environmental_modifiers": {
        "temperature_delta": -5,
        "humidity_delta": -5,
        "light_delta": -0.3,
        "corrosion_delta": 0.3
      },
      "challenges": [
        {
          "type": "navigation",
          "dc": 16,
          "description": "Active machinery with unpredictable movements"
        },
        {
          "type": "dexterity_save",
          "dc": 14,
          "description": "Avoiding grinding mechanisms"
        },
        {
          "type": "constitution_save",
          "dc": 13,
          "description": "Deafening noise resistance"
        }
      ],
      "hazard_density": "extreme",
      "active_threats": true
    }
  ],
  "traversal": {
    "vertical_range": {
      "min_z": -1,
      "max_z": 3
    },
    "fall_damage_multiplier": 3.0,
    "movement_effects": {
      "z_minus_1": "difficult",
      "z_0": "obstructed",
      "z_plus_1": "obstructed",
      "z_plus_2": "difficult",
      "z_plus_3": "extreme"
    }
  },
  "mechanical_systems": [
    {
      "id": "fall_damage_scaling",
      "description": "Fall damage is 3d6 per 10 feet (tripled from standard)",
      "test_cases": [
        {
          "distance_feet": 10,
          "expected_dice": 3,
          "expected_min": 3,
          "expected_max": 18
        },
        {
          "distance_feet": 30,
          "expected_dice": 9,
          "expected_min": 9,
          "expected_max": 54
        }
      ]
    }
  ]
}
```

### 9.2 vanaheim.json

```json
{
  "$schema": "https://rune-rust.dev/schemas/deck-config-v1.json",
  "realm": {
    "id": "vanaheim",
    "name": "Vanaheim - The Overgrown Laboratory",
    "deck_number": 3,
    "version": "0.19.4a",
    "description": "Abandoned magical facility consumed by mutagenic botanical mutations"
  },
  "base_environment": {
    "temperature_celsius": 28,
    "humidity_percent": 85,
    "light_level": 0.6,
    "aetheric_saturation": 0.5,
    "scale_multiplier": 1.0,
    "corrosion_rate": 0.4
  },
  "primary_condition": {
    "type": "MutagenicSpores",
    "description": "Spore exposure causes cumulative Corruption",
    "corruption_max_dc": 20,
    "effects": [
      "constitution_save_required",
      "corruption_accumulation",
      "mutation_threshold_effects",
      "wisdom_penalty_scaling"
    ]
  },
  "zones": [
    {
      "id": "undergrowth",
      "name": "The Undergrowth",
      "difficulty_class": 10,
      "corruption_multiplier": 1.0,
      "description": "Dense vegetation and root systems at ground level",
      "vertical_range": {
        "min_z": -1,
        "max_z": 1
      },
      "environmental_modifiers": {
        "temperature_delta": 0,
        "humidity_delta": 0,
        "light_delta": 0,
        "spore_density": "low_moderate"
      },
      "challenges": [
        {
          "type": "navigation",
          "dc": 10,
          "description": "Dense vegetation blocking paths"
        },
        {
          "type": "constitution_save",
          "dc": 10,
          "description": "Spore exposure",
          "corruption_gain": "1d4"
        },
        {
          "type": "perception",
          "dc": 11,
          "description": "Spotting safe passages"
        }
      ]
    },
    {
      "id": "canopy_sea",
      "name": "The Canopy Sea",
      "difficulty_class": 16,
      "corruption_multiplier": 2.0,
      "description": "Dense aerial fungal cloud with extreme spore density",
      "vertical_range": {
        "min_z": 1,
        "max_z": 3
      },
      "environmental_modifiers": {
        "temperature_delta": 3,
        "humidity_delta": 10,
        "light_delta": -0.1,
        "spore_density": "extreme"
      },
      "challenges": [
        {
          "type": "navigation",
          "dc": 16,
          "description": "Limited visibility and treacherous platforms"
        },
        {
          "type": "constitution_save",
          "dc": 16,
          "description": "Spore exposure (DOUBLED effect)",
          "corruption_gain": "2d4",
          "multiplier_note": "All corruption gains are doubled in this zone"
        },
        {
          "type": "reflex_save",
          "dc": 14,
          "description": "Platform stability maintenance"
        }
      ]
    },
    {
      "id": "ymirs_roots",
      "name": "Ymir's Roots",
      "difficulty_class": 12,
      "corruption_multiplier": 1.0,
      "description": "Deep cavern system with ancient biomass and geothermal activity",
      "vertical_range": {
        "min_z": -2,
        "max_z": -1
      },
      "environmental_modifiers": {
        "temperature_delta": 5,
        "humidity_delta": 5,
        "light_delta": 0,
        "aetheric_delta": 0.1,
        "spore_density": "moderate"
      },
      "challenges": [
        {
          "type": "navigation",
          "dc": 12,
          "description": "Root obstacles and unstable ground"
        },
        {
          "type": "arcana",
          "dc": 13,
          "description": "Understanding ancient corruption sources"
        },
        {
          "type": "constitution_save",
          "dc": 12,
          "description": "Spore exposure from ancient biomass",
          "corruption_gain": "1d4"
        }
      ]
    }
  ],
  "traversal": {
    "vertical_range": {
      "min_z": -2,
      "max_z": 3
    },
    "movement_effects": {
      "z_minus_2": "difficult",
      "z_minus_1": "obstructed",
      "z_0": "clear",
      "z_plus_1": "obstructed",
      "z_plus_2": "difficult",
      "z_plus_3": "extreme"
    }
  },
  "corruption_system": {
    "max_dc": 20,
    "thresholds": [
      {
        "level": "0-3",
        "effect_name": "minimal",
        "penalties": {}
      },
      {
        "level": "4-7",
        "effect_name": "mild",
        "penalties": {
          "wisdom_save_penalty": -1,
          "description": "Minor skin discoloration"
        }
      },
      {
        "level": "8-11",
        "effect_name": "moderate",
        "penalties": {
          "wisdom_save_penalty": -2,
          "description": "Visible mutations forming"
        }
      },
      {
        "level": "12-15",
        "effect_name": "severe",
        "penalties": {
          "wisdom_save_penalty": -3,
          "ability_penalty": -1,
          "movement_reduction": 0.8,
          "description": "Significant mutations; ability penalties"
        }
      },
      {
        "level": "16-19",
        "effect_name": "critical",
        "penalties": {
          "wisdom_save_penalty": -4,
          "ability_penalty": -2,
          "movement_reduction": 0.5,
          "description": "Major physical alterations; reduced mobility"
        }
      },
      {
        "level": "20",
        "effect_name": "catastrophic",
        "penalties": {
          "character_status": "transformation_risk",
          "description": "Character transformation; possible loss of control"
        }
      }
    ],
    "mechanical_systems": [
      {
        "id": "spore_exposure_save",
        "description": "Constitution save vs. zone DC; failure accumulates corruption",
        "test_cases": [
          {
            "zone": "undergrowth",
            "dc": 10,
            "roll": 12,
            "con_mod": 2,
            "expected_success": true,
            "expected_corruption": 0
          },
          {
            "zone": "canopy_sea",
            "dc": 16,
            "roll": 8,
            "con_mod": 1,
            "base_corruption": 5,
            "multiplier": 2.0,
            "expected_success": false,
            "expected_corruption": 9
          }
        ]
      }
    ]
  }
}
```

---

## 10. Decision Trees

### 10.1 Jötunheim Navigation Decision Tree

```
START: Enter Jötunheim
├─ Location check
│  ├─ Z-1 (Collapsed sections)
│  │  ├─ Perception DC 10 (find stable path)
│  │  │  ├─ Success → proceed safely
│  │  │  └─ Failure → Strength DC 10 or slip (fall damage)
│  │  └─ Fall occurs?
│  │     ├─ Yes → 3d6 per 10ft damage (GiantScale)
│  │     └─ No → continue
│  │
│  ├─ Z+0 to Z+1 (Bone Yards)
│  │  ├─ Navigation DC 10 (navigate remains)
│  │  │  ├─ Success → move to next zone
│  │  │  └─ Failure → encounter obstacle (Strength DC 10)
│  │  └─ Corrosion check (DC 11 for equipment)
│  │     ├─ Failure → equipment takes 1d6 corrosion damage
│  │     └─ Success → no damage
│  │
│  ├─ Z+1 to Z+2 (Utgard's Shadow)
│  │  ├─ Perception DC 13 (avoid falling machinery)
│  │  │  ├─ Success → avoid hazard
│  │  │  └─ Failure → Dexterity DC 12 or take 2d6 damage
│  │  └─ Cold exposure (DC 11 Constitution)
│  │     ├─ Failure → cold exhaustion level +1
│  │     └─ Success → resist
│  │
│  └─ Z+2 to Z+3 (Grinding Hall)
│     ├─ Navigation DC 16 (traverse machinery)
│     │  ├─ Success → approach boss area
│     │  └─ Failure → multiple hazard saves required
│     ├─ Machinery engagement (Dexterity DC 14)
│     │  ├─ Failure → 3d6 damage from grinding
│     │  └─ Success → avoid
│     └─ Noise exhaustion (Constitution DC 13)
│        ├─ 1 failure → exhaustion +1
│        ├─ 2 failures → exhaustion +2
│        └─ Cumulative penalties
```

### 10.2 Vanaheim Spore Exposure Decision Tree

```
START: Enter Vanaheim
├─ Spore exposure encounter
│  ├─ Zone check
│  │  ├─ Undergrowth (DC 10, 1x multiplier)
│  │  │  ├─ Constitution save DC 10
│  │  │  │  ├─ Success (DC beat) → no corruption
│  │  │  │  └─ Failure → Corruption +1d4
│  │  │  │     ├─ Rolling 1: Corruption +1 (after CON reduction)
│  │  │  │     ├─ Rolling 2-3: Corruption +1-2
│  │  │  │     └─ Rolling 4: Corruption +2-4
│  │  │
│  │  ├─ Canopy Sea (DC 16, 2x multiplier) *** DOUBLED EFFECT ***
│  │  │  ├─ Constitution save DC 16
│  │  │  │  ├─ Success (DC beat) → no corruption
│  │  │  │  └─ Failure → Corruption +(2d4 result)
│  │  │  │     ├─ Rolling 2: Corruption +2-2 (doubled)
│  │  │  │     ├─ Rolling 3-4: Corruption +3-4 (doubled)
│  │  │  │     ├─ Rolling 5-6: Corruption +5-6 (doubled)
│  │  │  │     ├─ Rolling 7-8: Corruption +7-8 (doubled)
│  │  │  │     └─ Maximum: Corruption +8 (doubled)
│  │  │
│  │  └─ Ymir's Roots (DC 12, 1x multiplier)
│  │     ├─ Constitution save DC 12
│  │     │  ├─ Success → no corruption
│  │     │  └─ Failure → Corruption +1d4
│  │
│  └─ Corruption thresholds reached?
│     ├─ 0-3 DC → minimal penalties
│     ├─ 4-7 DC → -1 Wisdom saves
│     ├─ 8-11 DC → -2 Wisdom saves
│     ├─ 12-15 DC → -3 Wisdom, -1 ability, 80% movement
│     ├─ 16-19 DC → -4 Wisdom, -2 ability, 50% movement
│     └─ 20 DC → transformation risk
```

---

## 11. Code Examples with XML Documentation

### 11.1 Jötunheim Fall Damage Calculator

```rust
/// Module for Jötunheim-specific mechanics
pub mod jotunheim {
    /// Calculates fall damage in the GiantScale environment.
    ///
    /// # Arguments
    /// * `distance_feet` - The distance fallen in feet
    /// * `is_levitating` - Whether the character has active levitation protection
    ///
    /// # Returns
    /// A tuple of (minimum_damage, maximum_damage, number_of_dice)
    ///
    /// # Details
    /// In Jötunheim, the GiantScale environment multiplies fall damage by 3.0x.
    /// - Standard D&D: 1d6 per 10 feet (max 20d6)
    /// - Jötunheim: 3d6 per 10 feet (max 60d6)
    ///
    /// # Examples
    /// ```
    /// let (min, max, dice) = calculate_fall_damage(30, false);
    /// assert_eq!(dice, 9); // 3 increments * 3 dice/increment
    /// assert_eq!(min, 9);  // 9d6 minimum roll
    /// assert_eq!(max, 54); // 9d6 maximum roll
    /// ```
    pub fn calculate_fall_damage(distance_feet: i32, is_levitating: bool) -> (i32, i32, i32) {
        if is_levitating {
            return (0, 0, 0);
        }

        let clamped_distance = std::cmp::min(distance_feet, 200);
        let num_ten_ft_increments = (clamped_distance + 9) / 10;
        let num_dice = num_ten_ft_increments * 3; // GiantScale 3.0x

        let min_damage = num_dice;
        let max_damage = num_dice * 6;

        (min_damage, max_damage, num_dice)
    }

    /// Determines equipment degradation from corrosion exposure.
    ///
    /// # Arguments
    /// * `base_corrosion_rate` - The zone's base corrosion rate (0.5 for Jötunheim)
    /// * `material_resistance` - Material-specific resistance (0.0-1.0)
    /// * `time_exposed_rounds` - Number of combat rounds exposed
    ///
    /// # Returns
    /// Corrosion damage in hit points
    pub fn calculate_equipment_corrosion(
        base_corrosion_rate: f32,
        material_resistance: f32,
        time_exposed_rounds: u32,
    ) -> i32 {
        let adjusted_rate = base_corrosion_rate * (1.0 - material_resistance);
        let total_corrosion = adjusted_rate * time_exposed_rounds as f32;
        total_corrosion.ceil() as i32
    }

    #[cfg(test)]
    mod tests {
        use super::*;

        #[test]
        /// Test fall damage at 10 feet in GiantScale environment
        fn test_fall_10_feet() {
            let (min, max, dice) = calculate_fall_damage(10, false);
            assert_eq!(dice, 3);
            assert_eq!(min, 3);
            assert_eq!(max, 18);
        }

        #[test]
        /// Test fall damage at 30 feet (3 increments)
        fn test_fall_30_feet() {
            let (min, max, dice) = calculate_fall_damage(30, false);
            assert_eq!(dice, 9);
            assert_eq!(min, 9);
            assert_eq!(max, 54);
        }

        #[test]
        /// Test fall damage cap at 200 feet
        fn test_fall_damage_capped_at_200() {
            let (min, max, dice) = calculate_fall_damage(200, false);
            assert_eq!(dice, 60);
            assert_eq!(min, 60);
            assert_eq!(max, 360);
        }

        #[test]
        /// Test levitation protection prevents damage
        fn test_levitation_negates_damage() {
            let (min, max, _) = calculate_fall_damage(50, true);
            assert_eq!(min, 0);
            assert_eq!(max, 0);
        }

        #[test]
        /// Test equipment corrosion calculation
        fn test_equipment_corrosion() {
            let corrosion = calculate_equipment_corrosion(0.5, 0.25, 10);
            assert_eq!(corrosion, 4); // 0.5 * 0.75 * 10 = 3.75 ≈ 4
        }
    }
}
```

### 11.2 Vanaheim Corruption Tracker

```rust
/// Module for Vanaheim spore and corruption mechanics
pub mod vanaheim {
    /// Represents a character's corruption state in Vanaheim
    #[derive(Debug, Clone)]
    pub struct CorruptionState {
        /// Current corruption DC level (0-20)
        pub corruption_dc: i32,
        /// Number of times corruption has reached a new threshold
        pub mutation_events: u32,
        /// Whether character is at risk of transformation
        pub transformation_risk: bool,
    }

    impl CorruptionState {
        /// Creates a new corruption state (starts clean)
        pub fn new() -> Self {
            CorruptionState {
                corruption_dc: 0,
                mutation_events: 0,
                transformation_risk: false,
            }
        }

        /// Applies corruption gain to the character
        ///
        /// # Arguments
        /// * `amount` - Corruption DC to add
        /// * `con_modifier` - Character's Constitution modifier (can reduce gain)
        ///
        /// # Details
        /// - Corruption is reduced by CON modifier (minimum gain of 1)
        /// - Corruption is capped at 20
        /// - Each time a threshold is passed, mutation_events increments
        pub fn add_corruption(&mut self, amount: i32, con_modifier: i32) {
            let reduced_amount = std::cmp::max(1, amount - con_modifier);
            let old_corruption = self.corruption_dc;

            self.corruption_dc = std::cmp::min(20, self.corruption_dc + reduced_amount);

            // Check if a threshold was crossed
            if self.corruption_dc > old_corruption {
                if self.corruption_dc >= 4 && old_corruption < 4 {
                    self.mutation_events += 1;
                }
                if self.corruption_dc >= 8 && old_corruption < 8 {
                    self.mutation_events += 1;
                }
                if self.corruption_dc >= 12 && old_corruption < 12 {
                    self.mutation_events += 1;
                }
                if self.corruption_dc >= 16 && old_corruption < 16 {
                    self.mutation_events += 1;
                }
                if self.corruption_dc >= 20 && old_corruption < 20 {
                    self.mutation_events += 1;
                    self.transformation_risk = true;
                }
            }
        }

        /// Gets wisdom save penalty based on corruption level
        pub fn wisdom_penalty(&self) -> i32 {
            match self.corruption_dc {
                0..=3 => 0,
                4..=7 => -1,
                8..=11 => -2,
                12..=15 => -3,
                16..=19 => -4,
                20 => -5,
                _ => 0,
            }
        }

        /// Gets ability score penalty based on corruption level
        pub fn ability_penalty(&self) -> i32 {
            match self.corruption_dc {
                0..=11 => 0,
                12..=15 => -1,
                16..=19 => -2,
                20 => -3,
                _ => 0,
            }
        }

        /// Gets movement speed multiplier based on corruption
        pub fn movement_multiplier(&self) -> f32 {
            match self.corruption_dc {
                0..=15 => 1.0,
                16..=19 => 0.5,
                20 => 0.25,
                _ => 1.0,
            }
        }
    }

    /// Represents a spore exposure event
    #[derive(Debug, Clone)]
    pub struct SporeExposureEvent {
        pub zone_dc: i32,
        pub base_corruption: i32,
        pub zone_multiplier: f32,
        pub character_con: i32,
    }

    impl SporeExposureEvent {
        /// Attempt a Constitution save vs. spore exposure
        ///
        /// # Arguments
        /// * `d20_roll` - Result of d20 roll (1-20)
        /// * `corruption_state` - Character's current corruption state
        ///
        /// # Returns
        /// A tuple of (success, corruption_gained)
        pub fn attempt_save(
            &self,
            d20_roll: i32,
            corruption_state: &mut CorruptionState,
        ) -> (bool, i32) {
            let con_modifier = (self.character_con - 10) / 2;
            let total = d20_roll + con_modifier + corruption_state.wisdom_penalty();
            let success = total >= self.zone_dc;

            if success {
                (true, 0)
            } else {
                let multiplied_corruption =
                    (self.base_corruption as f32 * self.zone_multiplier) as i32;
                let final_corruption = std::cmp::max(1, multiplied_corruption - con_modifier);

                corruption_state.add_corruption(final_corruption, con_modifier);
                (false, final_corruption)
            }
        }
    }

    #[cfg(test)]
    mod tests {
        use super::*;

        #[test]
        /// Test basic corruption accumulation
        fn test_corruption_accumulation() {
            let mut state = CorruptionState::new();
            assert_eq!(state.corruption_dc, 0);

            state.add_corruption(3, 0);
            assert_eq!(state.corruption_dc, 3);
        }

        #[test]
        /// Test corruption is capped at 20
        fn test_corruption_capped_at_20() {
            let mut state = CorruptionState::new();
            state.add_corruption(50, 0);
            assert_eq!(state.corruption_dc, 20);
        }

        #[test]
        /// Test corruption reduction by CON modifier
        fn test_corruption_con_reduction() {
            let mut state = CorruptionState::new();
            state.add_corruption(5, 2);
            assert_eq!(state.corruption_dc, 3); // 5 - 2 = 3
        }

        #[test]
        /// Test minimum corruption gain of 1
        fn test_corruption_minimum_one() {
            let mut state = CorruptionState::new();
            state.add_corruption(1, 5);
            assert_eq!(state.corruption_dc, 1); // min 1 despite CON
        }

        #[test]
        /// Test wisdom penalty scaling
        fn test_wisdom_penalty_scaling() {
            let mut state = CorruptionState::new();

            state.corruption_dc = 3;
            assert_eq!(state.wisdom_penalty(), 0);

            state.corruption_dc = 6;
            assert_eq!(state.wisdom_penalty(), -1);

            state.corruption_dc = 10;
            assert_eq!(state.wisdom_penalty(), -2);

            state.corruption_dc = 17;
            assert_eq!(state.wisdom_penalty(), -4);
        }

        #[test]
        /// Test spore exposure save success
        fn test_spore_exposure_success() {
            let exposure = SporeExposureEvent {
                zone_dc: 10,
                base_corruption: 3,
                zone_multiplier: 1.0,
                character_con: 14,
            };

            let mut state = CorruptionState::new();
            let (success, corruption) = exposure.attempt_save(12, &mut state);

            assert!(success);
            assert_eq!(corruption, 0);
            assert_eq!(state.corruption_dc, 0);
        }

        #[test]
        /// Test spore exposure save failure
        fn test_spore_exposure_failure() {
            let exposure = SporeExposureEvent {
                zone_dc: 10,
                base_corruption: 3,
                zone_multiplier: 1.0,
                character_con: 14,
            };

            let mut state = CorruptionState::new();
            let (success, corruption) = exposure.attempt_save(6, &mut state);

            assert!(!success);
            assert_eq!(corruption, 1); // 3 - 2 (CON mod) = 1
            assert_eq!(state.corruption_dc, 1);
        }

        #[test]
        /// Test canopy sea doubled corruption (zone_multiplier = 2.0)
        fn test_canopy_sea_doubled_corruption() {
            let exposure = SporeExposureEvent {
                zone_dc: 16,
                base_corruption: 5,
                zone_multiplier: 2.0,
                character_con: 12,
            };

            let mut state = CorruptionState::new();
            let (success, corruption) = exposure.attempt_save(8, &mut state);

            assert!(!success);
            assert_eq!(corruption, 9); // (5 * 2.0) - 1 = 9
        }

        #[test]
        /// Test mutation threshold detection
        fn test_mutation_threshold_events() {
            let mut state = CorruptionState::new();

            state.add_corruption(5, 0);  // crosses 4 threshold
            assert_eq!(state.mutation_events, 1);

            state.add_corruption(4, 0);  // crosses 8 threshold
            assert_eq!(state.mutation_events, 2);

            state.add_corruption(5, 0);  // crosses 12 threshold
            assert_eq!(state.mutation_events, 3);
        }

        #[test]
        /// Test transformation risk at corruption 20
        fn test_transformation_risk() {
            let mut state = CorruptionState::new();
            state.add_corruption(20, 0);

            assert!(state.transformation_risk);
            assert_eq!(state.corruption_dc, 20);
        }

        #[test]
        /// Test movement multiplier scaling
        fn test_movement_multiplier() {
            let mut state = CorruptionState::new();
            assert_eq!(state.movement_multiplier(), 1.0);

            state.corruption_dc = 17;
            assert_eq!(state.movement_multiplier(), 0.5);

            state.corruption_dc = 20;
            assert_eq!(state.movement_multiplier(), 0.25);
        }
    }
}
```

---

## 12. Logging and Debugging

### 12.1 Logging Strategy

```rust
/// Logging event types for Jötunheim and Vanaheim
#[derive(Debug, Clone)]
pub enum RealmLogEvent {
    // Jötunheim events
    FallDamageCalculated {
        distance_feet: i32,
        dice_count: i32,
        min_damage: i32,
        max_damage: i32,
    },
    CorrosionApplied {
        zone: String,
        equipment_id: String,
        damage: i32,
    },

    // Vanaheim events
    SporeExposure {
        zone: String,
        zone_dc: i32,
        save_result: i32,
        success: bool,
    },
    CorruptionGained {
        character_id: String,
        amount: i32,
        new_total: i32,
        threshold_crossed: Option<String>,
    },
    MutationOccurred {
        character_id: String,
        mutation_type: String,
        corruption_dc: i32,
    },
}

impl std::fmt::Display for RealmLogEvent {
    fn fmt(&self, f: &mut std::fmt::Formatter<'_>) -> std::fmt::Result {
        match self {
            RealmLogEvent::FallDamageCalculated { distance_feet, dice_count, min_damage, max_damage } => {
                write!(f, "JOTUNHEIM: Fall {} ft = {}d6 ({}-{})", distance_feet, dice_count, min_damage, max_damage)
            }
            RealmLogEvent::CorrosionApplied { zone, equipment_id, damage } => {
                write!(f, "JOTUNHEIM: {} corrosion to {} in {}", damage, equipment_id, zone)
            }
            RealmLogEvent::SporeExposure { zone, zone_dc, save_result, success } => {
                let result = if *success { "SUCCESS" } else { "FAILURE" };
                write!(f, "VANAHEIM: {} spore save DC {} vs roll {} [{}]", zone, zone_dc, save_result, result)
            }
            RealmLogEvent::CorruptionGained { character_id, amount, new_total, threshold_crossed } => {
                let threshold_msg = threshold_crossed.as_ref()
                    .map(|t| format!(" - THRESHOLD: {}", t))
                    .unwrap_or_default();
                write!(f, "VANAHEIM: {} gains {} corruption ({} total){}",
                       character_id, amount, new_total, threshold_msg)
            }
            RealmLogEvent::MutationOccurred { character_id, mutation_type, corruption_dc } => {
                write!(f, "VANAHEIM: {} mutation in {} (corruption {})",
                       character_id, mutation_type, corruption_dc)
            }
        }
    }
}
```

---

## 13. Unit Testing (~22 Tests)

### 13.1 Test Suite Overview

**Target: ~22 comprehensive tests covering all major mechanics**

```
JÖTUNHEIM TESTS (10 tests)
├─ Fall Damage Calculation
│  ├─ test_fall_10_feet
│  ├─ test_fall_30_feet
│  ├─ test_fall_damage_capped
│  └─ test_levitation_protection
├─ Equipment Corrosion
│  ├─ test_equipment_corrosion_calculation
│  ├─ test_corrosion_by_material
│  └─ test_corrosion_accumulation_over_time
└─ Zone Navigation
   ├─ test_bone_yards_navigation
   ├─ test_utgard_shadow_hazards
   └─ test_grinding_hall_extreme_hazards

VANAHEIM TESTS (12 tests)
├─ Corruption Accumulation
│  ├─ test_corruption_basic_gain
│  ├─ test_corruption_con_reduction
│  ├─ test_corruption_minimum_one
│  ├─ test_corruption_capped_at_20
│  └─ test_mutation_threshold_events
├─ Spore Exposure Saves
│  ├─ test_undergrowth_spore_save_success
│  ├─ test_undergrowth_spore_save_failure
│  ├─ test_canopy_sea_doubled_effect
│  └─ test_ymirs_roots_spore_exposure
├─ Corruption Effects
│  ├─ test_wisdom_penalty_scaling
│  ├─ test_movement_multiplier_scaling
│  └─ test_transformation_risk_at_dc_20

INTEGRATION TESTS (additional coverage)
└─ Vertical stratification mechanics
   └─ test_multi_zone_traversal
```

### 13.2 Test Implementation

See sections 11.1 and 11.2 for comprehensive test code with `#[cfg(test)]` blocks.

---

## 14. Deliverable Checklist

- [x] Design specification document (this file)
- [x] Jötunheim configuration (jotunheim.json)
- [x] Vanaheim configuration (vanaheim.json)
- [x] GiantScale mechanics documentation
- [x] MutagenicSpores and Corruption mechanics
- [x] Vertical stratification system design
- [x] Fall damage scaling formulas
- [x] Corruption accumulation algorithm
- [ ] Rust implementation in lib.rs
- [ ] Unit tests (target ~22 tests)
- [ ] Integration tests for cross-zone mechanics
- [ ] Logging infrastructure
- [ ] Configuration validation
- [ ] Zone transition mechanics
- [ ] Environmental effect application
- [ ] Character state mutation system
- [ ] API documentation
- [ ] Performance benchmarks
- [ ] Migration guide from v0.19.3

---

## 15. Acceptance Criteria

### Jötunheim Requirements

- [ ] Fall damage correctly implements 3.0x GiantScale multiplier
  - 10 ft fall = 3d6 (min 3, max 18)
  - 30 ft fall = 9d6 (min 9, max 54)
  - 200 ft fall capped at 60d6
- [ ] All three zones (Bone Yards, Utgard's Shadow, Grinding Hall) are navigable
- [ ] Zone difficulty progression is evident (DC 10 → 12 → 16)
- [ ] Equipment corrosion scales with time and zone exposure
- [ ] Vertical traversal respects Z-level constraints (-1 to +3)

### Vanaheim Requirements

- [ ] Spore Constitution saves trigger at zone-specific DCs
- [ ] Corruption accumulates correctly with zone multipliers
  - Undergrowth/Ymir's Roots: 1x multiplier
  - Canopy Sea: 2x multiplier (doubled effect)
- [ ] Corruption is capped at DC 20
- [ ] Wisdom penalty scales: -1 to -4 based on corruption level
- [ ] Movement multiplier reduces to 0.25 at max corruption
- [ ] Mutation thresholds trigger at corruption 4, 8, 12, 16, 20
- [ ] Vertical traversal supports full range (-2 to +3)

### System Requirements

- [ ] All ~22 unit tests pass
- [ ] Configuration files validate against schema
- [ ] Logging captures all game events
- [ ] No panic conditions under normal gameplay
- [ ] Performance: 1000 corruption calculations < 10ms
- [ ] Documentation complete with examples

---

## 16. Dependencies

### External Crates

```toml
[dependencies]
serde = { version = "1.0", features = ["derive"] }
serde_json = "1.0"
```

### Internal Modules

- `realm::base` - Base realm systems
- `condition::system` - Condition tracking
- `environment::properties` - Environmental calculations
- `zone::manager` - Zone state management

---

## 17. Deferrals for Future Versions

- **v0.19.5:** Advanced mutation system with permanent character alterations
- **v0.19.6:** Multi-player zone interactions and corruption contagion
- **v0.20.0:** Boss encounter mechanics for Grinding Hall and Ymir's Roots
- **v0.20.1:** Exotic equipment types with scale-dependent crafting
- **v0.21.0:** Full dungeon generation for procedural realm creation

---

## 18. Appendix: Quick Reference

### GiantScale Formulas

| Metric | Formula | Example |
|--------|---------|---------|
| Fall Damage | 3d6 per 10ft | 30ft = 9d6 |
| Weapon Damage | Base × 3.0 | Shortsword: 1d6+1 → 3d6+3 |
| Armor AC | Base × 2.0 | Plate +3 → +6 equivalent |
| Carrying Capacity | Base × 3.0 | 300lb → 900lb |

### Corruption Scales

| Corruption DC | Wisdom Penalty | Movement | Ability Penalty |
|---|---|---|---|
| 0-3 | 0 | 100% | 0 |
| 4-7 | -1 | 100% | 0 |
| 8-11 | -2 | 100% | 0 |
| 12-15 | -3 | 80% | -1 |
| 16-19 | -4 | 50% | -2 |
| 20 | -5 | 25% | -3 |

---

**End of Design Specification v0.19.4a**

Document prepared for implementation phase. All features, mechanics, and tests listed above should be completed prior to release candidate.
