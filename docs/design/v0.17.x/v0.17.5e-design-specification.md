# v0.17.5e Design Specification: Character Factory

**Version:** 0.17.5e
**Theme:** Character Factory
**Author:** Claude
**Created:** 2026-01-28
**Status:** Draft
**Prerequisites:** v0.17.5a-d Complete (State, ViewModel, Name Validation, Controller)

---

## Table of Contents

1. [Overview](#1-overview)
2. [Dependencies](#2-dependencies)
3. [Architecture Diagrams](#3-architecture-diagrams)
4. [ICharacterFactory Interface](#4-icharacterfactory-interface)
5. [CharacterFactory Service](#5-characterfactory-service)
6. [Character Initialization Flow](#6-character-initialization-flow)
7. [Configuration](#7-configuration)
8. [Logging Specifications](#8-logging-specifications)
9. [Unit Testing Requirements](#9-unit-testing-requirements)
10. [Use Cases](#10-use-cases)
11. [Deliverable Checklist](#11-deliverable-checklist)
12. [Acceptance Criteria](#12-acceptance-criteria)
13. [Future Considerations](#13-future-considerations)
14. [Document Metadata](#14-document-metadata)

---

## 1. Overview

### 1.1 Purpose

This document provides a comprehensive design specification for v0.17.5e, the Character Factory phase. This phase implements the factory service that transforms a completed `CharacterCreationState` into a fully initialized `Player` entity.

Key components:

1. **ICharacterFactory Interface**: Contract defining character creation and state validation methods.

2. **CharacterFactory Service**: Implements the 13-step character initialization algorithm that applies all modifiers, grants abilities/equipment, and sets initial resources.

This factory is called by `CharacterCreationController.ConfirmCharacterAsync()` (v0.17.5d) to produce the final character.

### 1.2 Current vs. Target Implementation

| Aspect                      | Current Implementation | Target Implementation                      |
| --------------------------- | ---------------------- | ------------------------------------------ |
| **Character Construction**  | Not implemented        | `CharacterFactory.CreateCharacterAsync()`  |
| **State Validation**        | Not implemented        | `CharacterFactory.ValidateState()`         |
| **Modifier Application**    | Not implemented        | Lineage, background, archetype integration |
| **Resource Initialization** | Not implemented        | HP, Stamina, AP set to maximum             |

### 1.3 Scope

**In Scope:**

- Define `ICharacterFactory` interface
- Implement `CharacterFactory` service
- 13-step character initialization algorithm
- Unit tests (~5 tests)

**Out of Scope:**

- TUI screens - v0.17.5f
- Database persistence - v0.17.5g
- Account/session management

### 1.4 Key Deliverables

| Type       | Count | Details                                |
| ---------- | ----- | -------------------------------------- |
| Interfaces | 1     | `ICharacterFactory`                    |
| Services   | 1     | `CharacterFactory`                     |
| Unit Tests | ~5    | State validation, modifier application |

---

## 2. Dependencies

### 2.1 Required from v0.17.5a-d

| Component                 | Location                                    | Usage in v0.17.5e       |
| ------------------------- | ------------------------------------------- | ----------------------- |
| `CharacterCreationState`  | `Domain/Entities/CharacterCreationState.cs` | Input state             |
| `CharacterCreationStep`   | `Domain/Enums/CharacterCreationStep.cs`     | Completeness validation |
| `CharacterCreationResult` | `Domain/ValueObjects/`                      | Return type (v0.17.5d)  |

### 2.2 Required from v0.17.0-v0.17.4

| Component                 | Location                    | Usage in v0.17.5e         |
| ------------------------- | --------------------------- | ------------------------- |
| `ILineageProvider`        | `Application/Interfaces/`   | Get lineage modifiers     |
| `IBackgroundProvider`     | `Application/Interfaces/`   | Get starting skills/equip |
| `IArchetypeProvider`      | `Application/Interfaces/`   | Get abilities, resources  |
| `ISpecializationProvider` | `Application/Interfaces/`   | Get Tier 1 abilities      |
| `IDerivedStatCalculator`  | `Application/Interfaces/`   | Calculate HP/Stamina/AP   |
| `Player`                  | `Domain/Entities/Player.cs` | Output entity             |
| `AttributeSet`            | `Domain/ValueObjects/`      | Attribute values          |

### 2.3 Provides to Future Versions

| Version  | Component           | Usage                               |
| -------- | ------------------- | ----------------------------------- |
| v0.17.5d | `ICharacterFactory` | Controller calls factory            |
| v0.17.5g | `Player`            | Database persists created character |

---

## 3. Architecture Diagrams

### 3.1 Factory Flow Overview

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                       CHARACTER FACTORY FLOW                                 │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  CharacterCreationController                                                 │
│       │                                                                      │
│       │ ConfirmCharacterAsync(name)                                          │
│       ▼                                                                      │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │                    ICharacterFactory                                 │    │
│  │                                                                      │    │
│  │  CreateCharacterAsync(state) ──────────────────────▶ Player         │    │
│  │  ValidateState(state) ─────────────────────────────▶ ValidationResult│   │
│  │                                                                      │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
│              │                                                               │
│              ▼                                                               │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │                      CharacterFactory                                │    │
│  │                                                                      │    │
│  │  Dependencies:                                                       │    │
│  │  • ILineageProvider         → Attribute mods, traits, trauma        │    │
│  │  • IBackgroundProvider      → Skills, equipment                     │    │
│  │  • IArchetypeProvider       → Abilities, resource bonuses           │    │
│  │  • ISpecializationProvider  → Tier 1 abilities, special resources   │    │
│  │  • IDerivedStatCalculator   → HP, Stamina, AP calculations          │    │
│  │  • ILogger                  → Structured logging                    │    │
│  │                                                                      │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
│              │                                                               │
│              ▼                                                               │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │                         Player Entity                                │    │
│  │  • Name, Lineage, Background, Archetype, Specialization             │    │
│  │  • Attributes (with lineage modifiers applied)                      │    │
│  │  • Derived Stats (HP, Stamina, AP at maximum)                       │    │
│  │  • Trauma (Stress: 0, Corruption: from lineage)                     │    │
│  │  • Abilities (Archetype × 3 + Spec Tier 1 × 3)                      │    │
│  │  • Equipment (from background)                                      │    │
│  │  • Skills (from background)                                         │    │
│  │  • Saga Progression (Legend: 0, PP: 0, Milestone: 0)                │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 3.2 13-Step Initialization Sequence

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                    13-STEP INITIALIZATION SEQUENCE                           │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  Input: CharacterCreationState (complete)                                    │
│                                                                              │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │  1. VALIDATE STATE                                                   │    │
│  │     • All required selections present                                │    │
│  │     • IsComplete == true                                             │    │
│  └────────────────────────────────────┬────────────────────────────────┘    │
│                                       ▼                                      │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │  2. CREATE PLAYER ENTITY                                             │    │
│  │     • Generate new Id                                                │    │
│  │     • Set Name, Lineage, Background, Archetype, Specialization      │    │
│  └────────────────────────────────────┬────────────────────────────────┘    │
│                                       ▼                                      │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │  3. APPLY BASE ATTRIBUTES                                            │    │
│  │     • Set Might, Finesse, Wits, Will, Sturdiness from allocation    │    │
│  └────────────────────────────────────┬────────────────────────────────┘    │
│                                       ▼                                      │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │  4. APPLY LINEAGE ATTRIBUTE MODIFIERS                                │    │
│  │     • Rune-Marked: +2 WILL, -1 STURDINESS                           │    │
│  │     • Iron-Blooded: +2 STURDINESS, -1 WILL                          │    │
│  │     • Vargr-Kin: +1 MIGHT, +1 FINESSE, -1 WILL                      │    │
│  │     • Clan-Born: +1 to flexible attribute                           │    │
│  └────────────────────────────────────┬────────────────────────────────┘    │
│                                       ▼                                      │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │  5. APPLY LINEAGE PASSIVE BONUSES                                    │    │
│  │     • Clan-Born: +5 Max HP, +1 Social                               │    │
│  │     • Rune-Marked: +5 Max AP, +1 Lore                               │    │
│  │     • Iron-Blooded: +2 Soak, +1 Craft                               │    │
│  │     • Vargr-Kin: +1 Movement, +1 Survival                           │    │
│  └────────────────────────────────────┬────────────────────────────────┘    │
│                                       ▼                                      │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │  6. REGISTER LINEAGE TRAIT                                           │    │
│  │     • [Survivor's Resolve], [Aether-Tainted], etc.                  │    │
│  └────────────────────────────────────┬────────────────────────────────┘    │
│                                       ▼                                      │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │  7. SET TRAUMA BASELINE                                              │    │
│  │     • Stress: 0 (all lineages)                                      │    │
│  │     • Corruption: 5 (Rune-Marked) or 0 (others)                     │    │
│  └────────────────────────────────────┬────────────────────────────────┘    │
│                                       ▼                                      │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │  8. GRANT BACKGROUND SKILLS                                          │    │
│  │     • e.g., Village Smith: Craft +2, Might +1                       │    │
│  └────────────────────────────────────┬────────────────────────────────┘    │
│                                       ▼                                      │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │  9. GRANT BACKGROUND EQUIPMENT                                       │    │
│  │     • e.g., Village Smith: Smith's Hammer, Leather Apron            │    │
│  └────────────────────────────────────┬────────────────────────────────┘    │
│                                       ▼                                      │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │  10. CALCULATE & SET DERIVED STATS                                   │    │
│  │      • HP = (STURDINESS × 10) + 50 + Archetype + Lineage            │    │
│  │      • Stamina = (FINESSE × 5) + (MIGHT × 5) + 20 + Archetype       │    │
│  │      • AP = (WILL × 10) + (WITS × 5) + Archetype + Lineage          │    │
│  └────────────────────────────────────┬────────────────────────────────┘    │
│                                       ▼                                      │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │  11. GRANT ARCHETYPE ABILITIES (3)                                   │    │
│  │      • Warrior: Strike, Defensive Stance, Warrior's Vigor           │    │
│  │      • Skirmisher: Quick Strike, Evasive Stance, Fleet Footed       │    │
│  │      • Mystic: Aether Dart, Focus Aether, Aetheric Attunement       │    │
│  │      • Adept: Exploit Weakness, Scavenge, Resourceful               │    │
│  └────────────────────────────────────┬────────────────────────────────┘    │
│                                       ▼                                      │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │  12. GRANT SPECIALIZATION TIER 1 ABILITIES (3)                       │    │
│  │      • Loaded from specialization definition                        │    │
│  │      • Initialize special resource if applicable                    │    │
│  └────────────────────────────────────┬────────────────────────────────┘    │
│                                       ▼                                      │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │  13. INITIALIZE SAGA PROGRESSION                                     │    │
│  │      • Legend: 0                                                    │    │
│  │      • Progression Points (PP): 0                                   │    │
│  │      • Milestone: 0                                                 │    │
│  │      • Set CurrentHP = MaxHP, CurrentStamina = MaxStamina, etc.     │    │
│  └────────────────────────────────────┬────────────────────────────────┘    │
│                                       ▼                                      │
│  Output: Fully initialized Player entity                                     │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 4. ICharacterFactory Interface

### 4.1 Interface Definition

**File:** `src/Core/RuneAndRust.Application/Interfaces/ICharacterFactory.cs`

```csharp
using RuneAndRust.Domain.Entities;
using RuneAndRust.Domain.ValueObjects;

namespace RuneAndRust.Application.Interfaces;

/// <summary>
/// Factory service that transforms a completed CharacterCreationState
/// into a fully initialized Player entity.
/// </summary>
public interface ICharacterFactory
{
    /// <summary>
    /// Creates a fully initialized character from the creation state.
    /// Applies all modifiers, grants abilities and equipment, and
    /// sets resources to maximum.
    /// </summary>
    /// <param name="state">The completed character creation state.</param>
    /// <param name="ct">Cancellation token.</param>
    /// <returns>The fully initialized Player entity.</returns>
    /// <exception cref="InvalidOperationException">
    /// Thrown if state is incomplete or invalid.
    /// </exception>
    Task<Player> CreateCharacterAsync(
        CharacterCreationState state,
        CancellationToken ct = default);

    /// <summary>
    /// Validates that the creation state is complete and ready for
    /// character creation.
    /// </summary>
    /// <param name="state">The state to validate.</param>
    /// <returns>Validation result with any errors.</returns>
    FactoryValidationResult ValidateState(CharacterCreationState state);
}
```

### 4.2 FactoryValidationResult Value Object

**File:** `src/Core/RuneAndRust.Domain/ValueObjects/FactoryValidationResult.cs`

```csharp
namespace RuneAndRust.Domain.ValueObjects;

/// <summary>
/// Result of factory state validation.
/// </summary>
public readonly record struct FactoryValidationResult
{
    /// <summary>
    /// Gets whether the state is valid for character creation.
    /// </summary>
    public bool IsValid { get; init; }

    /// <summary>
    /// Gets validation errors if state is invalid.
    /// </summary>
    public IReadOnlyList<string> Errors { get; init; }

    /// <summary>
    /// Creates a valid result.
    /// </summary>
    public static FactoryValidationResult Valid() => new()
    {
        IsValid = true,
        Errors = Array.Empty<string>()
    };

    /// <summary>
    /// Creates an invalid result with errors.
    /// </summary>
    public static FactoryValidationResult Invalid(params string[] errors) => new()
    {
        IsValid = false,
        Errors = errors
    };

    /// <summary>
    /// Creates an invalid result from error list.
    /// </summary>
    public static FactoryValidationResult Invalid(IReadOnlyList<string> errors) => new()
    {
        IsValid = false,
        Errors = errors
    };
}
```

---

## 5. CharacterFactory Service

### 5.1 Service Implementation

**File:** `src/Core/RuneAndRust.Application/Services/CharacterFactory.cs`

```csharp
using Microsoft.Extensions.Logging;
using RuneAndRust.Application.Interfaces;
using RuneAndRust.Domain.Entities;
using RuneAndRust.Domain.Enums;
using RuneAndRust.Domain.ValueObjects;

namespace RuneAndRust.Application.Services;

/// <summary>
/// Factory service that creates fully initialized Player entities
/// from completed CharacterCreationState.
/// </summary>
public class CharacterFactory : ICharacterFactory
{
    private readonly ILineageProvider _lineageProvider;
    private readonly IBackgroundProvider _backgroundProvider;
    private readonly IArchetypeProvider _archetypeProvider;
    private readonly ISpecializationProvider _specializationProvider;
    private readonly IDerivedStatCalculator _derivedStatCalculator;
    private readonly ILogger<CharacterFactory> _logger;

    public CharacterFactory(
        ILineageProvider lineageProvider,
        IBackgroundProvider backgroundProvider,
        IArchetypeProvider archetypeProvider,
        ISpecializationProvider specializationProvider,
        IDerivedStatCalculator derivedStatCalculator,
        ILogger<CharacterFactory> logger)
    {
        _lineageProvider = lineageProvider;
        _backgroundProvider = backgroundProvider;
        _archetypeProvider = archetypeProvider;
        _specializationProvider = specializationProvider;
        _derivedStatCalculator = derivedStatCalculator;
        _logger = logger;
    }

    /// <inheritdoc />
    public async Task<Player> CreateCharacterAsync(
        CharacterCreationState state,
        CancellationToken ct = default)
    {
        // Step 1: Validate state
        var validation = ValidateState(state);
        if (!validation.IsValid)
        {
            _logger.LogError(
                "Cannot create character: state validation failed. Errors: {Errors}",
                string.Join(", ", validation.Errors));
            throw new InvalidOperationException(
                $"State validation failed: {string.Join(", ", validation.Errors)}");
        }

        _logger.LogInformation(
            "Creating character: {Name} ({Lineage} {Archetype} {Spec})",
            state.CharacterName,
            state.SelectedLineage,
            state.SelectedArchetype,
            state.SelectedSpecialization);

        // Step 2: Create Player entity with basic info
        var player = Player.Create(
            name: state.CharacterName!,
            lineage: state.SelectedLineage!.Value,
            background: state.SelectedBackground!.Value,
            archetype: state.SelectedArchetype!.Value,
            specialization: state.SelectedSpecialization!);

        _logger.LogDebug("Player entity created with Id: {PlayerId}", player.Id);

        // Step 3: Apply base attributes from allocation
        ApplyBaseAttributes(player, state.Attributes);

        // Step 4: Apply lineage attribute modifiers
        await ApplyLineageAttributeModifiersAsync(player, state);

        // Step 5: Apply lineage passive bonuses
        await ApplyLineagePassiveBonusesAsync(player, state);

        // Step 6: Register lineage trait
        await RegisterLineageTraitAsync(player, state);

        // Step 7: Set trauma baseline
        SetTraumaBaseline(player, state);

        // Step 8: Grant background skills
        await GrantBackgroundSkillsAsync(player, state);

        // Step 9: Grant background equipment
        await GrantBackgroundEquipmentAsync(player, state);

        // Step 10: Calculate and set derived stats
        CalculateDerivedStats(player, state);

        // Step 11: Grant archetype abilities
        await GrantArchetypeAbilitiesAsync(player, state);

        // Step 12: Grant specialization Tier 1 abilities
        await GrantSpecializationAbilitiesAsync(player, state);

        // Step 13: Initialize saga progression and set resources to max
        InitializeSagaProgression(player);

        _logger.LogInformation(
            "Character created successfully: {Name} (HP: {HP}, Stamina: {Stamina}, AP: {AP})",
            player.Name,
            player.Stats.MaxHealth,
            player.Stats.MaxStamina,
            player.Stats.MaxAetherPool);

        return player;
    }

    /// <inheritdoc />
    public FactoryValidationResult ValidateState(CharacterCreationState state)
    {
        var errors = new List<string>();

        if (state.SelectedLineage == null)
            errors.Add("Lineage is required.");

        if (state.SelectedBackground == null)
            errors.Add("Background is required.");

        if (state.Attributes == null || !state.Attributes.IsValid)
            errors.Add("Valid attribute allocation is required.");

        if (state.SelectedArchetype == null)
            errors.Add("Archetype is required.");

        if (state.SelectedSpecialization == null)
            errors.Add("Specialization is required.");

        if (string.IsNullOrWhiteSpace(state.CharacterName))
            errors.Add("Character name is required.");

        // Clan-Born specific validation
        if (state.SelectedLineage == Lineage.ClanBorn &&
            state.FlexibleAttributeBonus == null)
        {
            errors.Add("Clan-Born lineage requires flexible attribute selection.");
        }

        if (errors.Count > 0)
        {
            _logger.LogDebug(
                "State validation failed with {Count} errors",
                errors.Count);
            return FactoryValidationResult.Invalid(errors);
        }

        return FactoryValidationResult.Valid();
    }

    // ═══════════════════════════════════════════════════════════════════════
    // Private Initialization Steps
    // ═══════════════════════════════════════════════════════════════════════

    private void ApplyBaseAttributes(Player player, AttributeAllocationState attributes)
    {
        player.SetBaseAttributes(
            might: attributes.Might,
            finesse: attributes.Finesse,
            wits: attributes.Wits,
            will: attributes.Will,
            sturdiness: attributes.Sturdiness);

        _logger.LogDebug(
            "Base attributes applied: M:{M} F:{F} W:{Wits} Wi:{Will} S:{S}",
            attributes.Might, attributes.Finesse, attributes.Wits,
            attributes.Will, attributes.Sturdiness);
    }

    private async Task ApplyLineageAttributeModifiersAsync(
        Player player,
        CharacterCreationState state)
    {
        var lineageDef = await _lineageProvider.GetByIdAsync(
            state.SelectedLineage!.Value.ToString().ToLowerInvariant());

        if (lineageDef == null)
        {
            _logger.LogWarning(
                "Lineage definition not found for {Lineage}",
                state.SelectedLineage);
            return;
        }

        foreach (var modifier in lineageDef.AttributeModifiers)
        {
            player.ApplyAttributeModifier(modifier.Attribute, modifier.Value);
            _logger.LogDebug(
                "Applied lineage modifier: {Attr} {Value:+#;-#}",
                modifier.Attribute, modifier.Value);
        }

        // Apply Clan-Born flexible bonus
        if (state.SelectedLineage == Lineage.ClanBorn &&
            state.FlexibleAttributeBonus.HasValue)
        {
            player.ApplyAttributeModifier(state.FlexibleAttributeBonus.Value, 1);
            _logger.LogDebug(
                "Applied Clan-Born flexible bonus: {Attr} +1",
                state.FlexibleAttributeBonus.Value);
        }
    }

    private async Task ApplyLineagePassiveBonusesAsync(
        Player player,
        CharacterCreationState state)
    {
        var lineageDef = await _lineageProvider.GetByIdAsync(
            state.SelectedLineage!.Value.ToString().ToLowerInvariant());

        if (lineageDef?.PassiveBonuses == null) return;

        foreach (var bonus in lineageDef.PassiveBonuses)
        {
            player.ApplyPassiveBonus(bonus);
            _logger.LogDebug("Applied passive bonus: {Bonus}", bonus.Description);
        }
    }

    private async Task RegisterLineageTraitAsync(
        Player player,
        CharacterCreationState state)
    {
        var lineageDef = await _lineageProvider.GetByIdAsync(
            state.SelectedLineage!.Value.ToString().ToLowerInvariant());

        if (lineageDef?.UniqueTrait != null)
        {
            player.RegisterTrait(lineageDef.UniqueTrait);
            _logger.LogDebug(
                "Registered lineage trait: [{TraitName}]",
                lineageDef.UniqueTrait.Name);
        }
    }

    private void SetTraumaBaseline(Player player, CharacterCreationState state)
    {
        var startingCorruption = state.SelectedLineage == Lineage.RuneMarked ? 5 : 0;

        player.SetTraumaBaseline(
            psychicStress: 0,
            corruption: startingCorruption);

        _logger.LogDebug(
            "Trauma baseline set: Stress={Stress}, Corruption={Corruption}",
            0, startingCorruption);
    }

    private async Task GrantBackgroundSkillsAsync(
        Player player,
        CharacterCreationState state)
    {
        var bgDef = await _backgroundProvider.GetByIdAsync(
            state.SelectedBackground!.Value.ToString().ToLowerInvariant());

        if (bgDef?.StartingSkills == null) return;

        foreach (var skillGrant in bgDef.StartingSkills)
        {
            player.GrantSkillBonus(skillGrant.SkillId, skillGrant.Bonus);
            _logger.LogDebug(
                "Granted skill: {Skill} +{Bonus}",
                skillGrant.SkillId, skillGrant.Bonus);
        }
    }

    private async Task GrantBackgroundEquipmentAsync(
        Player player,
        CharacterCreationState state)
    {
        var bgDef = await _backgroundProvider.GetByIdAsync(
            state.SelectedBackground!.Value.ToString().ToLowerInvariant());

        if (bgDef?.StartingEquipment == null) return;

        foreach (var equipGrant in bgDef.StartingEquipment)
        {
            player.AddToInventory(equipGrant.ItemId, equipGrant.Quantity);
            _logger.LogDebug(
                "Granted equipment: {Item} ×{Qty}",
                equipGrant.ItemId, equipGrant.Quantity);
        }
    }

    private void CalculateDerivedStats(Player player, CharacterCreationState state)
    {
        var derived = _derivedStatCalculator.Calculate(
            player.Attributes,
            state.SelectedArchetype!.Value,
            state.SelectedLineage!.Value);

        player.SetDerivedStats(derived);

        _logger.LogDebug(
            "Derived stats calculated: HP={HP}, Stamina={Stam}, AP={AP}",
            derived.MaxHealth, derived.MaxStamina, derived.MaxAetherPool);
    }

    private async Task GrantArchetypeAbilitiesAsync(
        Player player,
        CharacterCreationState state)
    {
        var archDef = await _archetypeProvider.GetByIdAsync(
            state.SelectedArchetype!.Value.ToString().ToLowerInvariant());

        if (archDef?.StartingAbilities == null) return;

        foreach (var abilityId in archDef.StartingAbilities)
        {
            player.UnlockAbility(abilityId);
            _logger.LogDebug("Granted archetype ability: {Ability}", abilityId);
        }
    }

    private async Task GrantSpecializationAbilitiesAsync(
        Player player,
        CharacterCreationState state)
    {
        var specDef = await _specializationProvider.GetByIdAsync(
            state.SelectedSpecialization!);

        if (specDef?.Tiers == null || specDef.Tiers.Count == 0) return;

        var tier1 = specDef.Tiers.First();
        foreach (var abilityId in tier1.Abilities)
        {
            player.UnlockAbility(abilityId);
            _logger.LogDebug(
                "Granted specialization Tier 1 ability: {Ability}",
                abilityId);
        }

        // Initialize special resource if applicable
        if (specDef.SpecialResource != null)
        {
            player.InitializeSpecialResource(specDef.SpecialResource);
            _logger.LogDebug(
                "Initialized special resource: {Resource}",
                specDef.SpecialResource.Name);
        }
    }

    private void InitializeSagaProgression(Player player)
    {
        player.InitializeSagaProgression(
            legend: 0,
            progressionPoints: 0,
            milestone: 0);

        // Set all resources to maximum
        player.SetResourcesToMaximum();

        _logger.LogDebug(
            "Saga progression initialized. Resources set to maximum.");
    }
}
```

---

## 6. Character Initialization Flow

### 6.1 Decision Tree

```
┌───────────────────────────────────────────────────────────────────┐
│                  CHARACTER CREATION DECISION TREE                  │
├───────────────────────────────────────────────────────────────────┤
│                                                                    │
│  CreateCharacterAsync(state)                                       │
│       │                                                            │
│       ├── ValidateState(state)                                     │
│       │       │                                                    │
│       │       ├── IsValid? ──[NO]──▶ Throw InvalidOperationException│
│       │       │                                                    │
│       │       └── [YES]──▶ Continue                                │
│       │                                                            │
│       ├── Lineage == ClanBorn?                                     │
│       │       │                                                    │
│       │       ├── [YES]──▶ Apply flexible +1 bonus                 │
│       │       │                                                    │
│       │       └── [NO]──▶ Apply standard modifiers only            │
│       │                                                            │
│       ├── Lineage == RuneMarked?                                   │
│       │       │                                                    │
│       │       ├── [YES]──▶ StartingCorruption = 5                  │
│       │       │                                                    │
│       │       └── [NO]──▶ StartingCorruption = 0                   │
│       │                                                            │
│       └── Return fully initialized Player                          │
│                                                                    │
└───────────────────────────────────────────────────────────────────┘
```

---

## 7. Configuration

No additional configuration files required. The factory uses:

- `lineages.json` (v0.17.0) - Lineage definitions
- `backgrounds.json` (v0.17.1) - Background definitions
- `archetypes.json` (v0.17.3) - Archetype definitions
- `specializations.json` (v0.17.4) - Specialization definitions
- `creation-workflow.json` (v0.17.5a) - Initialization parameters

---

## 8. Logging Specifications

### 8.1 Log Levels

| Level       | Usage                                          |
| ----------- | ---------------------------------------------- |
| Debug       | Each initialization step, modifier application |
| Information | Character creation start/success               |
| Warning     | Missing definitions                            |
| Error       | Validation failures                            |

### 8.2 Structured Logging Examples

```csharp
// Creation start
_logger.LogInformation(
    "Creating character: {Name} ({Lineage} {Archetype} {Spec})",
    state.CharacterName, state.SelectedLineage,
    state.SelectedArchetype, state.SelectedSpecialization);

// Modifier application
_logger.LogDebug(
    "Applied lineage modifier: {Attr} {Value:+#;-#}",
    modifier.Attribute, modifier.Value);

// Creation complete
_logger.LogInformation(
    "Character created successfully: {Name} (HP: {HP}, Stamina: {Stamina}, AP: {AP})",
    player.Name, player.Stats.MaxHealth,
    player.Stats.MaxStamina, player.Stats.MaxAetherPool);
```

---

## 9. Unit Testing Requirements

### 9.1 Test Summary

| Test # | Test Name                                   | Description                         |
| ------ | ------------------------------------------- | ----------------------------------- |
| 1      | `ValidateState_Complete_ReturnsValid`       | All fields present = valid          |
| 2      | `ValidateState_MissingLineage_ReturnsError` | Missing lineage = invalid           |
| 3      | `CreateCharacter_AppliesLineageModifiers`   | Attribute modifiers applied         |
| 4      | `CreateCharacter_RuneMarked_SetsCorruption` | Rune-Marked gets 5 starting corrupt |
| 5      | `CreateCharacter_GrantsAllAbilities`        | 6 abilities total (3+3)             |

### 9.2 Test Implementation

**File:** `tests/RuneAndRust.Application.UnitTests/Services/CharacterFactoryTests.cs`

```csharp
using FluentAssertions;
using Microsoft.Extensions.Logging;
using Moq;
using NUnit.Framework;
using RuneAndRust.Application.Interfaces;
using RuneAndRust.Application.Services;
using RuneAndRust.Domain.Entities;
using RuneAndRust.Domain.Enums;
using RuneAndRust.Domain.ValueObjects;

namespace RuneAndRust.Application.UnitTests.Services;

[TestFixture]
public class CharacterFactoryTests
{
    private Mock<ILineageProvider> _lineageProviderMock = null!;
    private Mock<IBackgroundProvider> _backgroundProviderMock = null!;
    private Mock<IArchetypeProvider> _archetypeProviderMock = null!;
    private Mock<ISpecializationProvider> _specializationProviderMock = null!;
    private Mock<IDerivedStatCalculator> _derivedStatCalculatorMock = null!;
    private Mock<ILogger<CharacterFactory>> _loggerMock = null!;
    private CharacterFactory _factory = null!;

    [SetUp]
    public void Setup()
    {
        _lineageProviderMock = new Mock<ILineageProvider>();
        _backgroundProviderMock = new Mock<IBackgroundProvider>();
        _archetypeProviderMock = new Mock<IArchetypeProvider>();
        _specializationProviderMock = new Mock<ISpecializationProvider>();
        _derivedStatCalculatorMock = new Mock<IDerivedStatCalculator>();
        _loggerMock = new Mock<ILogger<CharacterFactory>>();

        SetupDefaultMocks();

        _factory = new CharacterFactory(
            _lineageProviderMock.Object,
            _backgroundProviderMock.Object,
            _archetypeProviderMock.Object,
            _specializationProviderMock.Object,
            _derivedStatCalculatorMock.Object,
            _loggerMock.Object);
    }

    [Test]
    public void ValidateState_Complete_ReturnsValid()
    {
        // Arrange
        var state = CreateCompleteState();

        // Act
        var result = _factory.ValidateState(state);

        // Assert
        result.IsValid.Should().BeTrue();
        result.Errors.Should().BeEmpty();
    }

    [Test]
    public void ValidateState_MissingLineage_ReturnsError()
    {
        // Arrange
        var state = CreateCompleteState();
        state.SelectedLineage = null;

        // Act
        var result = _factory.ValidateState(state);

        // Assert
        result.IsValid.Should().BeFalse();
        result.Errors.Should().Contain("Lineage is required.");
    }

    [Test]
    public async Task CreateCharacter_AppliesLineageModifiers()
    {
        // Arrange
        var state = CreateCompleteState();
        state.SelectedLineage = Lineage.IronBlooded;

        // Act
        var player = await _factory.CreateCharacterAsync(state);

        // Assert
        // Iron-Blooded: +2 STURDINESS, -1 WILL applied
        _lineageProviderMock.Verify(
            x => x.GetByIdAsync(It.IsAny<string>()),
            Times.AtLeastOnce);
    }

    [Test]
    public async Task CreateCharacter_RuneMarked_SetsCorruption()
    {
        // Arrange
        var state = CreateCompleteState();
        state.SelectedLineage = Lineage.RuneMarked;

        // Act
        var player = await _factory.CreateCharacterAsync(state);

        // Assert
        player.Corruption.Should().Be(5);
    }

    [Test]
    public async Task CreateCharacter_GrantsSixAbilities()
    {
        // Arrange
        var state = CreateCompleteState();

        // Act
        var player = await _factory.CreateCharacterAsync(state);

        // Assert
        player.UnlockedAbilities.Should().HaveCount(6);
    }

    private CharacterCreationState CreateCompleteState() => new()
    {
        SelectedLineage = Lineage.ClanBorn,
        FlexibleAttributeBonus = CoreAttribute.Might,
        SelectedBackground = Background.VillageSmith,
        Attributes = AttributeAllocationState.CreateValid(4, 3, 2, 2, 4),
        SelectedArchetype = Archetype.Warrior,
        SelectedSpecialization = new SpecializationId("skjaldmaer"),
        CharacterName = "TestHero"
    };

    private void SetupDefaultMocks()
    {
        // Setup providers to return valid definitions
        // ... mock setup elided for brevity
    }
}
```

---

## 10. Use Cases

### 10.1 UC-01: Create Character from Complete State

**Actor:** CharacterCreationController
**Precondition:** Player confirmed all steps
**Steps:**

1. Controller calls `CreateCharacterAsync(state)`
2. Factory validates state is complete
3. Factory executes 13-step initialization
4. Factory returns fully initialized Player
5. Controller returns success result

### 10.2 UC-02: Validate Incomplete State

**Actor:** CharacterCreationController
**Precondition:** Some steps incomplete
**Steps:**

1. Controller calls `ValidateState(state)`
2. Factory checks all required fields
3. Factory returns errors for missing fields
4. Controller presents errors to user

---

## 11. Deliverable Checklist

### 11.1 Interfaces

- [x] `ICharacterFactory` - Application/Interfaces/

### 11.2 Value Objects

- [x] `FactoryValidationResult` - Domain/ValueObjects/

### 11.3 Services

- [x] `CharacterFactory` - Application/Services/

### 11.4 Unit Tests

- [x] `CharacterFactoryTests` (~5 tests)

### 11.5 Documentation

- [x] XML documentation on all public members
- [x] Structured logging throughout

---

## 12. Acceptance Criteria

### 12.1 Functional Requirements

- [x] `ValidateState()` returns errors for missing required fields
- [x] `CreateCharacterAsync()` applies all lineage attribute modifiers
- [x] Clan-Born flexible bonus correctly applied
- [x] Rune-Marked starts with 5 Corruption
- [x] Background skills and equipment granted
- [x] All 6 starting abilities granted (3 archetype + 3 specialization)
- [x] Derived stats calculated correctly
- [x] Resources set to maximum values
- [x] Saga progression initialized to 0

### 12.2 Non-Functional Requirements

- [x] All methods include structured logging
- [x] All public members have XML documentation
- [x] All unit tests pass

---

## 13. Future Considerations

### 13.1 Deferred to v0.17.5f

- TUI screen integration for creation flow

### 13.2 Deferred to v0.17.5g

- Database persistence of created character
- Starting location assignment

### 13.3 Out of Scope

- Character portrait/avatar selection
- Tutorial/onboarding flow

---

## 14. Document Metadata

| Field              | Value                                  |
| ------------------ | -------------------------------------- |
| Version            | 0.17.5e                                |
| Status             | Draft                                  |
| Prerequisites      | v0.17.5a, v0.17.5b, v0.17.5c, v0.17.5d |
| Dependent Versions | v0.17.5f, v0.17.5g                     |
| Est. Complexity    | Medium                                 |
| Est. Test Count    | ~5                                     |

---

_Document Version: 1.0_
_Last Updated: 2026-01-28_
_Author: Claude_
