# v0.9.2b Design Specification: Combat & Ability Sounds

**Version:** 0.9.2b
**Parent:** v0.9.2 (Sound Effects)
**Prerequisites:** v0.9.2a Complete (Sound Effect Service)
**Status:** Design Complete
**Estimated Unit Tests:** ~6

---

## 1. Overview

### Purpose

Implement event handlers that trigger combat and ability sound effects. Combat sounds include attack hits (with randomized variations), misses, criticals, blocked attacks, damage type sounds, and death sounds. Ability sounds include casting effects for different spell schools and effect application sounds.

### Key Deliverables

| Category | Items |
|----------|-------|
| **Event Handlers** | `CombatSoundHandler`, `AbilitySoundHandler` |
| **Sound Mappings** | ~15 combat/ability effects |
| **Tests** | ~6 unit tests |

---

## 2. Feature Overview

```
v0.9.2b Features
â”œâ”€â”€ CombatSoundHandler
â”‚   â”œâ”€â”€ AttackHitEvent â†’ attack-hit (randomized)
â”‚   â”œâ”€â”€ CriticalHitEvent â†’ attack-critical
â”‚   â”œâ”€â”€ AttackMissEvent â†’ attack-miss
â”‚   â”œâ”€â”€ AttackBlockedEvent â†’ attack-blocked
â”‚   â”œâ”€â”€ DamageReceivedEvent â†’ damage-{type}
â”‚   â”‚   â”œâ”€â”€ fire â†’ damage-fire
â”‚   â”‚   â”œâ”€â”€ ice â†’ damage-ice
â”‚   â”‚   â””â”€â”€ lightning â†’ damage-lightning
â”‚   â”œâ”€â”€ MonsterDeathEvent â†’ death-monster (randomized)
â”‚   â””â”€â”€ PlayerDeathEvent â†’ death-player
â”‚
â”œâ”€â”€ AbilitySoundHandler
â”‚   â”œâ”€â”€ AbilityCastEvent â†’ ability-{school} or ability-cast
â”‚   â”‚   â”œâ”€â”€ fire â†’ ability-fire
â”‚   â”‚   â”œâ”€â”€ ice â†’ ability-ice
â”‚   â”‚   â”œâ”€â”€ healing â†’ ability-heal
â”‚   â”‚   â””â”€â”€ buff â†’ ability-buff
â”‚   â”œâ”€â”€ AbilityEffectAppliedEvent â†’ ability-effect
â”‚   â””â”€â”€ AbilityExpiredEvent â†’ ability-expire
â”‚
â””â”€â”€ Event-to-Sound Mapping
    â”œâ”€â”€ EventBus subscription
    â”œâ”€â”€ ISoundEffectService.Play()
    â””â”€â”€ Logging for debugging
```

---

## 3. Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                       COMBAT EVENTS                                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  AttackHitEvent â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                             â”‚
â”‚  AttackMissEvent â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â–¶  CombatSoundHandler                     â”‚
â”‚  AttackBlockedEvent â”€â”€â”€â”€â”€â”€â”¤     â”œâ”€â”€ Maps events to effect IDs          â”‚
â”‚  DamageReceivedEvent â”€â”€â”€â”€â”€â”¤     â””â”€â”€ Calls ISoundEffectService.Play()   â”‚
â”‚  MonsterDeathEvent â”€â”€â”€â”€â”€â”€â”€â”¤                                             â”‚
â”‚  PlayerDeathEvent â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                       ABILITY EVENTS                                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  AbilityCastEvent â”€â”€â”€â”€â”€â”€â”€â”€â”                                             â”‚
â”‚  AbilityEffectAppliedEventâ”¼â”€â”€â–¶  AbilitySoundHandler                    â”‚
â”‚  AbilityExpiredEvent â”€â”€â”€â”€â”€â”˜     â”œâ”€â”€ Maps ability school to effect ID   â”‚
â”‚                                 â””â”€â”€ Calls ISoundEffectService.Play()   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                               â”‚
                                               â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                       ISoundEffectService (v0.9.2a)                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Play("attack-hit")        â†’ ğŸ”Š *thwack*                               â”‚
â”‚  Play("attack-critical")   â†’ ğŸ”Š *CRACK!*                               â”‚
â”‚  Play("damage-fire")       â†’ ğŸ”Š *sizzle*                               â”‚
â”‚  Play("ability-fire")      â†’ ğŸ”Š *whoosh*                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 4. Combat Sound Event Flow

```
COMBAT SOUND FLOW:
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

     Combat Events                  Sound Effect           Audio
     â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€           â”€â”€â”€â”€â”€

     [AttackHitEvent] â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶  attack-hit      â”€â”€â”€â–¶  ğŸ”Š *thwack*
          â”‚                         (randomized)
          â”‚ isCritical?
          â–¼
     [CriticalHitEvent] â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶  attack-critical â”€â”€â”€â–¶  ğŸ”Š *CRACK!*

     [AttackMissEvent] â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶  attack-miss     â”€â”€â”€â–¶  ğŸ”Š *whoosh*

     [AttackBlockedEvent] â”€â”€â”€â”€â”€â”€â”€â–¶  attack-blocked  â”€â”€â”€â–¶  ğŸ”Š *CLANG*

     [DamageReceivedEvent] â”€â”€â”€â”€â”€â”€â–¶  damage-{type}   â”€â”€â”€â–¶  ğŸ”Š *element*
          â”‚
          â”œâ”€ Fire â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶  damage-fire    â”€â”€â”€â–¶  ğŸ”Š *sizzle*
          â”œâ”€ Ice â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶  damage-ice     â”€â”€â”€â–¶  ğŸ”Š *crack*
          â””â”€ Lightning â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶  damage-lightning â”€â–¶  ğŸ”Š *zap*

     [MonsterDeathEvent] â”€â”€â”€â”€â”€â”€â”€â”€â–¶  death-monster   â”€â”€â”€â–¶  ğŸ”Š *death cry*
                                    (randomized)

     [PlayerDeathEvent] â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶  death-player    â”€â”€â”€â–¶  ğŸ”Š *collapse*
```

---

## 5. CombatSoundHandler

**File:** `src/Core/RuneAndRust.Application/EventHandlers/CombatSoundHandler.cs`

```csharp
namespace RuneAndRust.Application.EventHandlers;

/// <summary>
/// Subscribes to combat events and triggers sound effects.
/// </summary>
public class CombatSoundHandler : IDisposable
{
    private readonly ISoundEffectService _sfx;
    private readonly IEventBus _eventBus;
    private readonly ILogger<CombatSoundHandler> _logger;
    private readonly List<IDisposable> _subscriptions = new();

    public CombatSoundHandler(ISoundEffectService sfx, IEventBus eventBus,
        ILogger<CombatSoundHandler> logger)
    {
        _sfx = sfx;
        _eventBus = eventBus;
        _logger = logger;
        RegisterSubscriptions();
    }

    private void RegisterSubscriptions()
    {
        // Attack hit (check for critical)
        _subscriptions.Add(_eventBus.Subscribe<AttackHitEvent>(OnAttackHit));
        _subscriptions.Add(_eventBus.Subscribe<AttackMissEvent>(OnAttackMiss));
        _subscriptions.Add(_eventBus.Subscribe<AttackBlockedEvent>(OnAttackBlocked));
        _subscriptions.Add(_eventBus.Subscribe<DamageReceivedEvent>(OnDamageReceived));
        _subscriptions.Add(_eventBus.Subscribe<MonsterDeathEvent>(OnMonsterDeath));
        _subscriptions.Add(_eventBus.Subscribe<PlayerDeathEvent>(OnPlayerDeath));

        _logger.LogDebug("CombatSoundHandler registered {Count} subscriptions", _subscriptions.Count);
    }

    private void OnAttackHit(AttackHitEvent e)
    {
        if (e.IsCritical)
        {
            _sfx.Play("attack-critical");
            _logger.LogDebug("Combat sound: critical hit");
        }
        else
        {
            _sfx.Play("attack-hit");
            _logger.LogDebug("Combat sound: attack hit");
        }
    }

    private void OnAttackMiss(AttackMissEvent e)
    {
        _sfx.Play("attack-miss");
        _logger.LogDebug("Combat sound: attack miss");
    }

    private void OnAttackBlocked(AttackBlockedEvent e)
    {
        _sfx.Play("attack-blocked");
        _logger.LogDebug("Combat sound: attack blocked");
    }

    private void OnDamageReceived(DamageReceivedEvent e)
    {
        var effectId = MapDamageTypeToEffect(e.DamageType);
        if (effectId is not null)
        {
            _sfx.Play(effectId);
            _logger.LogDebug("Combat sound: {DamageType} damage", e.DamageType);
        }
    }

    private string? MapDamageTypeToEffect(string? damageType) => damageType?.ToLowerInvariant() switch
    {
        "fire" => "damage-fire",
        "ice" or "cold" or "frost" => "damage-ice",
        "lightning" or "electric" or "shock" => "damage-lightning",
        "poison" => "damage-poison",
        "holy" or "radiant" => "damage-holy",
        "shadow" or "dark" or "necrotic" => "damage-shadow",
        _ => null // No special sound for physical/untyped
    };

    private void OnMonsterDeath(MonsterDeathEvent e)
    {
        _sfx.Play("death-monster");
        _logger.LogDebug("Combat sound: monster death");
    }

    private void OnPlayerDeath(PlayerDeathEvent e)
    {
        _sfx.Play("death-player");
        _logger.LogDebug("Combat sound: player death");
    }

    public void Dispose()
    {
        foreach (var sub in _subscriptions)
            sub.Dispose();
        _subscriptions.Clear();
    }
}
```

---

## 6. AbilitySoundHandler

**File:** `src/Core/RuneAndRust.Application/EventHandlers/AbilitySoundHandler.cs`

```csharp
namespace RuneAndRust.Application.EventHandlers;

/// <summary>
/// Subscribes to ability events and triggers sound effects.
/// </summary>
public class AbilitySoundHandler : IDisposable
{
    private readonly ISoundEffectService _sfx;
    private readonly IEventBus _eventBus;
    private readonly ILogger<AbilitySoundHandler> _logger;
    private readonly List<IDisposable> _subscriptions = new();

    public AbilitySoundHandler(ISoundEffectService sfx, IEventBus eventBus,
        ILogger<AbilitySoundHandler> logger)
    {
        _sfx = sfx;
        _eventBus = eventBus;
        _logger = logger;
        RegisterSubscriptions();
    }

    private void RegisterSubscriptions()
    {
        _subscriptions.Add(_eventBus.Subscribe<AbilityCastEvent>(OnAbilityCast));
        _subscriptions.Add(_eventBus.Subscribe<AbilityEffectAppliedEvent>(OnEffectApplied));
        _subscriptions.Add(_eventBus.Subscribe<AbilityExpiredEvent>(OnAbilityExpired));
        _subscriptions.Add(_eventBus.Subscribe<BuffAppliedEvent>(OnBuffApplied));
        _subscriptions.Add(_eventBus.Subscribe<HealingReceivedEvent>(OnHealingReceived));

        _logger.LogDebug("AbilitySoundHandler registered {Count} subscriptions", _subscriptions.Count);
    }

    private void OnAbilityCast(AbilityCastEvent e)
    {
        // Try school-specific sound first, fall back to generic
        var effectId = MapAbilitySchoolToEffect(e.AbilitySchool);
        _sfx.Play(effectId);
        _logger.LogDebug("Ability sound: {School} cast â†’ {EffectId}", e.AbilitySchool, effectId);
    }

    private string MapAbilitySchoolToEffect(string? school) => school?.ToLowerInvariant() switch
    {
        "fire" or "evocation" or "pyromancy" => "ability-fire",
        "ice" or "cold" or "frost" or "cryomancy" => "ability-ice",
        "lightning" or "storm" or "electromancy" => "ability-lightning",
        "healing" or "restoration" or "holy" => "ability-heal",
        "buff" or "enhancement" or "abjuration" => "ability-buff",
        "shadow" or "dark" or "necromancy" => "ability-shadow",
        "nature" or "druid" => "ability-nature",
        _ => "ability-cast" // Generic fallback
    };

    private void OnEffectApplied(AbilityEffectAppliedEvent e)
    {
        // Status effect application sound
        if (e.IsDebuff)
            _sfx.Play("ability-debuff", volume: 0.7f);
        else
            _sfx.Play("ability-effect", volume: 0.6f);

        _logger.LogDebug("Ability sound: effect applied ({Type})", e.IsDebuff ? "debuff" : "buff");
    }

    private void OnAbilityExpired(AbilityExpiredEvent e)
    {
        _sfx.Play("ability-expire", volume: 0.5f);
        _logger.LogDebug("Ability sound: effect expired");
    }

    private void OnBuffApplied(BuffAppliedEvent e)
    {
        _sfx.Play("ability-buff");
        _logger.LogDebug("Ability sound: buff applied");
    }

    private void OnHealingReceived(HealingReceivedEvent e)
    {
        _sfx.Play("ability-heal");
        _logger.LogDebug("Ability sound: healing received ({Amount})", e.Amount);
    }

    public void Dispose()
    {
        foreach (var sub in _subscriptions)
            sub.Dispose();
        _subscriptions.Clear();
    }
}
```

---

## 7. Sound Effect Mappings

### Combat Sounds

| Event | Effect ID | Description |
|-------|-----------|-------------|
| `AttackHitEvent` | `attack-hit` | Normal hit (randomized) |
| `AttackHitEvent` (critical) | `attack-critical` | Critical hit |
| `AttackMissEvent` | `attack-miss` | Swing and miss |
| `AttackBlockedEvent` | `attack-blocked` | Shield block |
| `DamageReceivedEvent` (fire) | `damage-fire` | Fire damage |
| `DamageReceivedEvent` (ice) | `damage-ice` | Ice damage |
| `DamageReceivedEvent` (lightning) | `damage-lightning` | Lightning damage |
| `MonsterDeathEvent` | `death-monster` | Monster death (randomized) |
| `PlayerDeathEvent` | `death-player` | Player death |

### Ability Sounds

| Event | Effect ID | Description |
|-------|-----------|-------------|
| `AbilityCastEvent` (fire) | `ability-fire` | Fire spell cast |
| `AbilityCastEvent` (ice) | `ability-ice` | Ice spell cast |
| `AbilityCastEvent` (heal) | `ability-heal` | Healing cast |
| `AbilityCastEvent` (buff) | `ability-buff` | Buff applied |
| `AbilityCastEvent` (other) | `ability-cast` | Generic cast |
| `AbilityEffectAppliedEvent` | `ability-effect` | Status effect |
| `AbilityExpiredEvent` | `ability-expire` | Effect ended |
| `BuffAppliedEvent` | `ability-buff` | Buff sound |
| `HealingReceivedEvent` | `ability-heal` | Heal sound |

---

## 8. Extended Configuration

**Additional entries for `config/sound-effects.json`:**

```json
{
  "categories": {
    "combat": {
      "effects": {
        "damage-poison": {
          "files": ["audio/sfx/combat/poison_damage.ogg"],
          "volume": 0.7,
          "randomize": false
        },
        "damage-holy": {
          "files": ["audio/sfx/combat/holy_damage.ogg"],
          "volume": 0.8,
          "randomize": false
        },
        "damage-shadow": {
          "files": ["audio/sfx/combat/shadow_damage.ogg"],
          "volume": 0.8,
          "randomize": false
        }
      }
    },
    "ability": {
      "effects": {
        "ability-ice": {
          "files": ["audio/sfx/ability/ice_cast.ogg"],
          "volume": 0.8,
          "randomize": false
        },
        "ability-lightning": {
          "files": ["audio/sfx/ability/lightning_cast.ogg"],
          "volume": 0.9,
          "randomize": false
        },
        "ability-buff": {
          "files": ["audio/sfx/ability/buff_apply.ogg"],
          "volume": 0.6,
          "randomize": false
        },
        "ability-debuff": {
          "files": ["audio/sfx/ability/debuff_apply.ogg"],
          "volume": 0.7,
          "randomize": false
        },
        "ability-effect": {
          "files": ["audio/sfx/ability/effect_apply.ogg"],
          "volume": 0.6,
          "randomize": false
        },
        "ability-expire": {
          "files": ["audio/sfx/ability/effect_expire.ogg"],
          "volume": 0.5,
          "randomize": false
        },
        "ability-shadow": {
          "files": ["audio/sfx/ability/shadow_cast.ogg"],
          "volume": 0.8,
          "randomize": false
        },
        "ability-nature": {
          "files": ["audio/sfx/ability/nature_cast.ogg"],
          "volume": 0.7,
          "randomize": false
        }
      }
    }
  }
}
```

---

## 9. Unit Testing Requirements (~6 tests)

| Feature | Tests |
|---------|-------|
| AttackHitEvent triggers attack-hit | 1 |
| Critical hit triggers attack-critical | 1 |
| DamageType maps to correct effect | 1 |
| AbilityCastEvent triggers school sound | 1 |
| Unknown school falls back to generic | 1 |
| Dispose unsubscribes all events | 1 |

---

## 10. Acceptance Criteria

- [ ] CombatSoundHandler subscribes to combat events
- [ ] Attack hit plays attack-hit sound
- [ ] Critical hit plays attack-critical sound
- [ ] Attack miss plays attack-miss sound
- [ ] Attack blocked plays attack-blocked sound
- [ ] Fire damage plays damage-fire
- [ ] Ice damage plays damage-ice
- [ ] Lightning damage plays damage-lightning
- [ ] Monster death plays death-monster
- [ ] Player death plays death-player
- [ ] AbilitySoundHandler subscribes to ability events
- [ ] Fire ability plays ability-fire
- [ ] Ice ability plays ability-ice
- [ ] Healing plays ability-heal
- [ ] Buff plays ability-buff
- [ ] Unknown school falls back to ability-cast
- [ ] Effect applied plays ability-effect
- [ ] Effect expired plays ability-expire
- [ ] Handlers dispose subscriptions properly
- [ ] ~6 unit tests pass

---

## 11. Dependencies

| From | Required |
|------|----------|
| v0.9.2a | `ISoundEffectService` |
| Application | `IEventBus`, combat/ability events |
| Domain | Combat events, ability events |

---

*Document Version: 1.0 | Last Updated: 2026-01-10*
