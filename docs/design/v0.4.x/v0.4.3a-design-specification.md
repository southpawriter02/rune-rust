# v0.4.3a Design Specification: Light Core

**Version:** 0.4.3a
**Phase Name:** Light Core
**Parent Version:** v0.4.3 (Light & Environment Systems)
**Prerequisites:** v0.4.2c Complete (Riddles & Advanced)
**Estimated Tests:** ~30 unit tests

---

## Table of Contents

1. [Executive Summary](#1-executive-summary)
2. [Feature Overview](#2-feature-overview)
3. [Architecture Diagrams](#3-architecture-diagrams)
4. [LightLevel Enum](#4-lightlevel-enum)
5. [LightPenalties Constants](#5-lightpenalties-constants)
6. [Room Modifications](#6-room-modifications)
7. [Combat Integration](#7-combat-integration)
8. [Perception Integration](#8-perception-integration)
9. [User-Facing Commands](#9-user-facing-commands)
10. [Data Model Changes](#10-data-model-changes)
11. [Configuration File Schemas](#11-configuration-file-schemas)
12. [Logging Specifications](#12-logging-specifications)
13. [Unit Testing Requirements](#13-unit-testing-requirements)
14. [Use Cases](#14-use-cases)
15. [Deliverable Checklist](#15-deliverable-checklist)
16. [Acceptance Criteria](#16-acceptance-criteria)
17. [Dependencies](#17-dependencies)
18. [Future Considerations](#18-future-considerations)

---

## 1. Executive Summary

### 1.1 Purpose

This specification establishes the foundational light level system with room illumination tracking and gameplay penalties for darkness. v0.4.3a creates the core lighting mechanics that light sources (v0.4.3b) and vision types (v0.4.3b) will build upon.

Light levels represent environmental illumination that affects gameplay through combat accuracy penalties and perception difficulty modifiers. Rooms can have different base light levels, and the system integrates with the existing combat and trap detection systems to apply appropriate penalties.

### 1.2 Key Deliverables

| Category | Items |
|----------|-------|
| **Domain Enums** | `LightLevel` |
| **Domain Constants** | `LightPenalties` |
| **Room Updates** | `BaseLightLevel`, `CurrentLightLevel`, `IsOutdoor` properties |
| **Combat Updates** | Accuracy penalty integration in `CombatService` |
| **Perception Updates** | DC modifier integration in `TrapService` |
| **Renderer Updates** | Light level display in room descriptions and UI |
| **Configuration** | Room light level definitions in `rooms.json` |
| **Tests** | ~30 unit tests |

### 1.3 Architectural Significance

This version establishes the **Light Level System Pattern** that will be used throughout the game:

- **Four-Tier Illumination**: Bright, Dim, Dark, MagicalDarkness with escalating penalties
- **Base vs Current Light**: Room has base light level, current level computed from active sources
- **Combat Accuracy Penalties**: Progressive accuracy reduction based on light level
- **Perception DC Modifiers**: Progressive difficulty increase for detection checks
- **Indoor/Outdoor Classification**: Room property for future day/night cycle integration

---

## 2. Feature Overview

```
v0.4.3a Light Core
├── LightLevel Enum
│   ├── Bright (no penalties)
│   ├── Dim (minor penalties)
│   ├── Dark (significant penalties)
│   └── MagicalDarkness (maximum penalties)
├── LightPenalties Constants
│   ├── Accuracy penalties per level
│   ├── Perception DC modifiers per level
│   ├── GetAccuracyPenalty() helper
│   └── GetPerceptionDCModifier() helper
├── Room Modifications
│   ├── BaseLightLevel property
│   ├── CurrentLightLevel computed property
│   ├── IsOutdoor property
│   ├── HasActiveLightSources property (placeholder)
│   ├── SetBaseLightLevel() method
│   └── CalculateCurrentLightLevel() method
├── Combat Integration
│   ├── CombatService accuracy penalty application
│   ├── Light-based attack modifier display
│   └── Combat log messages
├── Perception Integration
│   ├── TrapService DC modifier application
│   ├── Light-based detection difficulty
│   └── Detection log messages
├── Rendering Updates
│   ├── Light level in room header
│   ├── Penalty indicator display
│   └── Exit light level hints
└── Configuration
    └── rooms.json light level fields
```

### 2.1 Scope Alignment

**In Scope:**
- `LightLevel` enum (Bright, Dim, Dark, MagicalDarkness)
- `LightPenalties` static constants class
- `Room.BaseLightLevel` property (configurable)
- `Room.CurrentLightLevel` computed property
- `Room.IsOutdoor` property (for future day/night)
- Combat accuracy penalties based on light level
- Perception DC modifiers for trap detection
- Light level display in room descriptions
- Light level indicator in UI header
- Configuration schema for room light levels
- Light penalty helper methods

**Out of Scope:**
- Light source items and entities (v0.4.3b)
- Vision types (Normal, DarkVision, TrueSight) (v0.4.3b)
- Light commands (light, extinguish, refuel) (v0.4.3b)
- Player skills (v0.4.3c)
- Day/night cycle (v0.4.3d)
- Weather effects (v0.4.3d)

---

## 3. Architecture Diagrams

### 3.1 Light Level System Flow

```
┌─────────────────────────────────────────────────────────────────────┐
│                       LIGHT LEVEL SYSTEM FLOW                        │
└─────────────────────────────────────────────────────────────────────┘

    Room Entry              Combat Action              Perception Check
        │                        │                          │
        ▼                        ▼                          ▼
┌───────────────┐       ┌───────────────┐          ┌───────────────┐
│ Get Current   │       │ Calculate     │          │ Calculate     │
│ Light Level   │       │ Base Accuracy │          │ Base DC       │
└───────┬───────┘       └───────┬───────┘          └───────┬───────┘
        │                       │                          │
        ▼                       ▼                          ▼
┌───────────────┐       ┌───────────────┐          ┌───────────────┐
│ Display Light │       │ Get Accuracy  │          │ Get Perception│
│ Level in Room │       │ Penalty       │          │ DC Modifier   │
└───────┬───────┘       └───────┬───────┘          └───────┬───────┘
        │                       │                          │
        ▼                       ▼                          ▼
┌───────────────┐       ┌───────────────┐          ┌───────────────┐
│ Show Penalty  │       │ Apply Penalty │          │ Apply Modifier│
│ Indicator     │       │ to Attack Roll│          │ to Check DC   │
└───────────────┘       └───────┬───────┘          └───────┬───────┘
                                │                          │
                                ▼                          ▼
                        ┌───────────────┐          ┌───────────────┐
                        │ Display Light │          │ Display Light │
                        │ Penalty in Log│          │ Modifier in   │
                        └───────────────┘          │ Detection Log │
                                                   └───────────────┘
```

### 3.2 Layer Diagram

```
┌─────────────────────────────────────────────────────────────────────┐
│                        PRESENTATION LAYER                            │
├─────────────────────────────────────────────────────────────────────┤
│  IGameRenderer                                                       │
│  ├── RenderRoomAsync() - includes light level in header             │
│  └── Light penalty indicator display                                │
└───────┬─────────────────────────────────────────────────────────────┘
        │
        ▼
┌─────────────────────────────────────────────────────────────────────┐
│                       APPLICATION LAYER                              │
├─────────────────────────────────────────────────────────────────────┤
│  CombatService                        TrapService                    │
│  ├── GetLightPenalty()               ├── GetLightDCModifier()       │
│  └── ApplyLightPenalty()             └── ApplyLightModifier()       │
│                                                                      │
│  GameSessionService                                                  │
│  └── Process room entry with light level display                    │
└───────┬─────────────────────────────────────────────────────────────┘
        │
        ▼
┌─────────────────────────────────────────────────────────────────────┐
│                         DOMAIN LAYER                                 │
├─────────────────────────────────────────────────────────────────────┤
│  ┌──────────────────┐  ┌────────────────────────────────────────┐  │
│  │    LightLevel    │  │             LightPenalties              │  │
│  │      (Enum)      │  │             (Constants)                 │  │
│  ├──────────────────┤  ├────────────────────────────────────────┤  │
│  │ Bright           │  │ DimLightAccuracyPenalty = -1           │  │
│  │ Dim              │  │ DarkAccuracyPenalty = -3               │  │
│  │ Dark             │  │ MagicalDarknessAccuracyPenalty = -5    │  │
│  │ MagicalDarkness  │  │ DimLightPerceptionDC = 2               │  │
│  └──────────────────┘  │ DarkPerceptionDC = 5                   │  │
│                        │ MagicalDarknessPerceptionDC = 10       │  │
│                        │ GetAccuracyPenalty(LightLevel): int    │  │
│                        │ GetPerceptionDCModifier(LightLevel): int│  │
│                        └────────────────────────────────────────┘  │
│                                                                      │
│  ┌─────────────────────────────────────────────────────────────────┐│
│  │                           Room                                   ││
│  ├─────────────────────────────────────────────────────────────────┤│
│  │  + BaseLightLevel: LightLevel     (default: Dim)                ││
│  │  + CurrentLightLevel: LightLevel  (computed)                    ││
│  │  + IsOutdoor: bool                (default: false)              ││
│  │  + HasActiveLightSources: bool    (placeholder - v0.4.3b)       ││
│  │                                                                 ││
│  │  + SetBaseLightLevel(level): void                               ││
│  │  + CalculateCurrentLightLevel(): LightLevel                     ││
│  └─────────────────────────────────────────────────────────────────┘│
│                                                                      │
└─────────────────────────────────────────────────────────────────────┘
```

### 3.3 Combat-Light Integration

```
┌─────────────────────────────────────────────────────────────────────┐
│                      COMBAT-LIGHT INTEGRATION                        │
└─────────────────────────────────────────────────────────────────────┘

    Player                CombatService              Room              LightPenalties
       │                       │                      │                      │
       │  attack <target>      │                      │                      │
       ├──────────────────────▶│                      │                      │
       │                       │  GetCurrentLightLevel│                      │
       │                       ├─────────────────────▶│                      │
       │                       │                      │                      │
       │                       │  ◀── LightLevel.Dark │                      │
       │                       │                      │                      │
       │                       │  GetAccuracyPenalty(Dark)                   │
       │                       ├─────────────────────────────────────────────▶│
       │                       │                      │                      │
       │                       │  ◀── -3 (DarkAccuracyPenalty)               │
       │                       │                      │                      │
       │                       │  Calculate Attack    │                      │
       │                       │  (base + modifiers   │                      │
       │                       │   + lightPenalty)    │                      │
       │                       │                      │                      │
       │  ◀── Attack result    │                      │                      │
       │      with light       │                      │                      │
       │      penalty shown    │                      │                      │
       ▼                       ▼                      ▼                      ▼
```

### 3.4 Perception-Light Integration

```
┌─────────────────────────────────────────────────────────────────────┐
│                    PERCEPTION-LIGHT INTEGRATION                      │
└─────────────────────────────────────────────────────────────────────┘

    Player                 TrapService              Room              LightPenalties
       │                       │                      │                      │
       │  enter room           │                      │                      │
       ├──────────────────────▶│                      │                      │
       │                       │  CheckForTraps()     │                      │
       │                       │                      │                      │
       │                       │  GetCurrentLightLevel│                      │
       │                       ├─────────────────────▶│                      │
       │                       │                      │                      │
       │                       │  ◀── LightLevel.Dark │                      │
       │                       │                      │                      │
       │                       │  GetPerceptionDCModifier(Dark)              │
       │                       ├─────────────────────────────────────────────▶│
       │                       │                      │                      │
       │                       │  ◀── +5 (DarkPerceptionDC)                  │
       │                       │                      │                      │
       │                       │  Calculate DC        │                      │
       │                       │  (baseDC + lightMod) │                      │
       │                       │                      │                      │
       │  ◀── Detection result │                      │                      │
       │      with modified DC │                      │                      │
       │      shown            │                      │                      │
       ▼                       ▼                      ▼                      ▼
```

---

## 4. LightLevel Enum

### 4.1 Purpose

The `LightLevel` enum represents the illumination level of a room or area. Each level has associated gameplay penalties that affect combat and perception.

### 4.2 Implementation

**File:** `src/Core/RuneAndRust.Domain/Enums/LightLevel.cs`

```csharp
namespace RuneAndRust.Domain.Enums;

/// <summary>
/// Represents the illumination level of an area.
/// </summary>
/// <remarks>
/// Light levels affect combat accuracy and perception checks.
/// Bright has no penalties, while MagicalDarkness has maximum penalties.
/// Vision types (v0.4.3b) can mitigate some light penalties.
/// </remarks>
public enum LightLevel
{
    /// <summary>
    /// Fully illuminated - no penalties.
    /// </summary>
    /// <remarks>
    /// Normal daylight, magical illumination, or well-lit rooms.
    /// Combat and perception operate at full effectiveness.
    /// </remarks>
    Bright = 0,

    /// <summary>
    /// Partially illuminated - minor penalties to perception.
    /// </summary>
    /// <remarks>
    /// Torch-lit corridors, twilight, or weak ambient light.
    /// Accuracy: -1, Perception DC: +2
    /// </remarks>
    Dim = 1,

    /// <summary>
    /// No illumination - significant penalties without dark vision.
    /// </summary>
    /// <remarks>
    /// Complete darkness in underground areas or moonless nights.
    /// Accuracy: -3, Perception DC: +5
    /// Dark Vision can mitigate these penalties.
    /// </remarks>
    Dark = 2,

    /// <summary>
    /// Supernatural darkness - even dark vision cannot penetrate.
    /// </summary>
    /// <remarks>
    /// Magical effect that suppresses all light and vision.
    /// Accuracy: -5, Perception DC: +10
    /// Only True Sight can see through this.
    /// </remarks>
    MagicalDarkness = 3
}
```

### 4.3 Light Level Summary Table

| Level | Accuracy Penalty | Perception DC Modifier | Notes |
|-------|-----------------|------------------------|-------|
| Bright | 0 | +0 | No penalties |
| Dim | -1 | +2 | Minor penalties |
| Dark | -3 | +5 | Significant penalties |
| MagicalDarkness | -5 | +10 | Maximum penalties |

---

## 5. LightPenalties Constants

### 5.1 Purpose

The `LightPenalties` static class provides centralized constants and helper methods for calculating light-based penalties. This ensures consistent penalty values across all systems.

### 5.2 Implementation

**File:** `src/Core/RuneAndRust.Domain/Constants/LightPenalties.cs`

```csharp
namespace RuneAndRust.Domain.Constants;

using RuneAndRust.Domain.Enums;

/// <summary>
/// Constants and helper methods for light-based penalties.
/// </summary>
/// <remarks>
/// Provides centralized penalty values for combat accuracy and perception
/// checks based on light levels. Helper methods ensure consistent application
/// across all game systems.
/// </remarks>
public static class LightPenalties
{
    #region Accuracy Penalties

    /// <summary>
    /// Accuracy penalty in dim light.
    /// </summary>
    public const int DimLightAccuracyPenalty = -1;

    /// <summary>
    /// Accuracy penalty in darkness.
    /// </summary>
    public const int DarkAccuracyPenalty = -3;

    /// <summary>
    /// Accuracy penalty in magical darkness.
    /// </summary>
    public const int MagicalDarknessAccuracyPenalty = -5;

    #endregion

    #region Perception DC Modifiers

    /// <summary>
    /// Perception DC modifier in dim light.
    /// </summary>
    public const int DimLightPerceptionDC = 2;

    /// <summary>
    /// Perception DC modifier in darkness.
    /// </summary>
    public const int DarkPerceptionDC = 5;

    /// <summary>
    /// Perception DC modifier in magical darkness.
    /// </summary>
    public const int MagicalDarknessPerceptionDC = 10;

    #endregion

    #region Helper Methods

    /// <summary>
    /// Gets the accuracy penalty for a light level.
    /// </summary>
    /// <param name="level">The current light level.</param>
    /// <returns>The accuracy penalty (0 or negative).</returns>
    public static int GetAccuracyPenalty(LightLevel level) => level switch
    {
        LightLevel.Bright => 0,
        LightLevel.Dim => DimLightAccuracyPenalty,
        LightLevel.Dark => DarkAccuracyPenalty,
        LightLevel.MagicalDarkness => MagicalDarknessAccuracyPenalty,
        _ => 0
    };

    /// <summary>
    /// Gets the perception DC modifier for a light level.
    /// </summary>
    /// <param name="level">The current light level.</param>
    /// <returns>The DC modifier to add (0 or positive).</returns>
    public static int GetPerceptionDCModifier(LightLevel level) => level switch
    {
        LightLevel.Bright => 0,
        LightLevel.Dim => DimLightPerceptionDC,
        LightLevel.Dark => DarkPerceptionDC,
        LightLevel.MagicalDarkness => MagicalDarknessPerceptionDC,
        _ => 0
    };

    /// <summary>
    /// Gets a descriptive string for the light level.
    /// </summary>
    /// <param name="level">The current light level.</param>
    /// <returns>A human-readable description.</returns>
    public static string GetDescription(LightLevel level) => level switch
    {
        LightLevel.Bright => "brightly lit",
        LightLevel.Dim => "dimly lit",
        LightLevel.Dark => "shrouded in darkness",
        LightLevel.MagicalDarkness => "consumed by supernatural darkness",
        _ => "unknown lighting"
    };

    /// <summary>
    /// Gets whether the light level imposes any penalties.
    /// </summary>
    /// <param name="level">The current light level.</param>
    /// <returns>True if any penalties apply.</returns>
    public static bool HasPenalties(LightLevel level) =>
        level != LightLevel.Bright;

    #endregion
}
```

---

## 6. Room Modifications

### 6.1 Purpose

The `Room` entity is extended with light level properties to track illumination. Base light level is configured per room, while current light level is computed based on active light sources (in v0.4.3b).

### 6.2 Property Additions

**File:** `src/Core/RuneAndRust.Domain/Entities/Room.cs`

```csharp
// Add to Room entity class:

#region Light Level Properties

/// <summary>
/// Gets the base light level of this room (from configuration).
/// </summary>
/// <remarks>
/// This is the room's natural light level without active light sources.
/// Active light sources (v0.4.3b) can raise this level.
/// </remarks>
public LightLevel BaseLightLevel { get; private set; } = LightLevel.Dim;

/// <summary>
/// Gets the current effective light level.
/// </summary>
/// <remarks>
/// Computed from base level and any active light sources.
/// In v0.4.3a, this returns BaseLightLevel.
/// In v0.4.3b, this considers active light sources.
/// </remarks>
public LightLevel CurrentLightLevel => CalculateCurrentLightLevel();

/// <summary>
/// Gets whether this room is outdoors.
/// </summary>
/// <remarks>
/// Outdoor rooms are affected by the day/night cycle (v0.4.3d).
/// Indoor rooms use only their configured BaseLightLevel.
/// </remarks>
public bool IsOutdoor { get; private set; }

/// <summary>
/// Gets whether there are active light sources in this room.
/// </summary>
/// <remarks>
/// Placeholder for v0.4.3b. Returns false in v0.4.3a.
/// </remarks>
public bool HasActiveLightSources => false; // Updated in v0.4.3b

#endregion

#region Light Level Methods

/// <summary>
/// Sets the base light level for this room.
/// </summary>
/// <param name="level">The new base light level.</param>
public void SetBaseLightLevel(LightLevel level)
{
    BaseLightLevel = level;
}

/// <summary>
/// Sets whether this room is outdoors.
/// </summary>
/// <param name="isOutdoor">True if the room is outdoors.</param>
public void SetIsOutdoor(bool isOutdoor)
{
    IsOutdoor = isOutdoor;
}

/// <summary>
/// Calculates the current effective light level.
/// </summary>
/// <returns>The effective light level.</returns>
/// <remarks>
/// In v0.4.3a, this returns BaseLightLevel.
/// In v0.4.3b, active light sources can raise the level.
/// Light sources cannot make a room darker, only brighter.
/// </remarks>
public LightLevel CalculateCurrentLightLevel()
{
    // v0.4.3a: Simple implementation - returns base level
    // v0.4.3b will add logic for active light sources
    return BaseLightLevel;
}

#endregion
```

### 6.3 Room Factory Updates

Update the `Room.Create()` factory method to include light level parameters:

```csharp
/// <summary>
/// Creates a new room.
/// </summary>
/// <param name="definitionId">The room definition ID.</param>
/// <param name="name">The display name.</param>
/// <param name="description">The room description.</param>
/// <param name="baseLightLevel">The base light level (default: Dim).</param>
/// <param name="isOutdoor">Whether the room is outdoors (default: false).</param>
/// <returns>A new Room instance.</returns>
public static Room Create(
    string definitionId,
    string name,
    string description,
    LightLevel baseLightLevel = LightLevel.Dim,
    bool isOutdoor = false)
{
    ArgumentException.ThrowIfNullOrWhiteSpace(definitionId);
    ArgumentException.ThrowIfNullOrWhiteSpace(name);

    return new Room
    {
        Id = Guid.NewGuid(),
        DefinitionId = definitionId,
        Name = name,
        Description = description,
        BaseLightLevel = baseLightLevel,
        IsOutdoor = isOutdoor
    };
}
```

---

## 7. Combat Integration

### 7.1 Purpose

Integrate light level penalties into the combat system. Attack rolls receive accuracy penalties based on the room's current light level.

### 7.2 CombatService Updates

**File:** `src/Core/RuneAndRust.Application/Services/CombatService.cs`

```csharp
// Add method to CombatService:

/// <summary>
/// Gets the accuracy penalty for the current light level.
/// </summary>
/// <param name="room">The room where combat is occurring.</param>
/// <returns>The accuracy penalty (0 or negative).</returns>
/// <remarks>
/// In v0.4.3a, this returns the penalty based on room light level.
/// In v0.4.3b, this will consider attacker's vision type.
/// </remarks>
public int GetLightPenalty(Room room)
{
    ArgumentNullException.ThrowIfNull(room);

    var lightLevel = room.CurrentLightLevel;
    var penalty = LightPenalties.GetAccuracyPenalty(lightLevel);

    if (penalty < 0)
    {
        _logger.LogDebug(
            "Light penalty of {Penalty} applied for {LightLevel} conditions",
            penalty,
            lightLevel);
    }

    return penalty;
}

/// <summary>
/// Gets the accuracy penalty for an attacker based on light and vision.
/// </summary>
/// <param name="room">The room where combat is occurring.</param>
/// <param name="attacker">The attacking entity (for future vision type).</param>
/// <returns>The accuracy penalty after vision modifiers.</returns>
/// <remarks>
/// Placeholder signature for v0.4.3b vision type integration.
/// In v0.4.3a, this ignores the attacker parameter.
/// </remarks>
public int GetLightPenalty(Room room, Player attacker)
{
    // v0.4.3a: Ignore attacker's vision type
    // v0.4.3b: Will check attacker.VisionType to mitigate penalties
    return GetLightPenalty(room);
}

/// <summary>
/// Gets the accuracy penalty for a monster attacker based on light and vision.
/// </summary>
/// <param name="room">The room where combat is occurring.</param>
/// <param name="attacker">The attacking monster.</param>
/// <returns>The accuracy penalty after vision modifiers.</returns>
public int GetLightPenalty(Room room, Monster attacker)
{
    // v0.4.3a: Ignore attacker's vision type
    // v0.4.3b: Will check monster.VisionType and LightSensitivity
    return GetLightPenalty(room);
}
```

### 7.3 Attack Roll Modification

Update the attack roll calculation to include light penalties:

```csharp
// In attack calculation method:

// Calculate base attack roll
var baseRoll = _diceService.Roll(diceCount, diceSides);
var modifiers = GetAttackModifiers(attacker);

// Apply light penalty
var lightPenalty = GetLightPenalty(currentRoom, attacker);
var totalModifier = modifiers + lightPenalty;

// Calculate final result
var finalRoll = baseRoll + totalModifier;

// Log for combat display
if (lightPenalty < 0)
{
    _logger.LogInformation(
        "Attack roll: {BaseRoll} + {Modifiers} + {LightPenalty} (light) = {FinalRoll}",
        baseRoll,
        modifiers,
        lightPenalty,
        finalRoll);
}
```

---

## 8. Perception Integration

### 8.1 Purpose

Integrate light level modifiers into perception checks, specifically trap detection. Detection DC is increased in darker conditions.

### 8.2 TrapService Updates

**File:** `src/Core/RuneAndRust.Application/Services/TrapService.cs`

```csharp
// Add method to TrapService:

/// <summary>
/// Gets the perception DC modifier for the current light level.
/// </summary>
/// <param name="room">The room to check.</param>
/// <returns>The DC modifier to add (0 or positive).</returns>
public int GetLightDCModifier(Room room)
{
    ArgumentNullException.ThrowIfNull(room);

    var lightLevel = room.CurrentLightLevel;
    var modifier = LightPenalties.GetPerceptionDCModifier(lightLevel);

    if (modifier > 0)
    {
        _logger.LogDebug(
            "Light DC modifier of +{Modifier} applied for {LightLevel} conditions",
            modifier,
            lightLevel);
    }

    return modifier;
}

/// <summary>
/// Gets the effective detection DC for a trap in current conditions.
/// </summary>
/// <param name="trap">The trap to detect.</param>
/// <param name="room">The room containing the trap.</param>
/// <returns>The effective DC including light modifiers.</returns>
public int GetEffectiveDetectionDC(Trap trap, Room room)
{
    ArgumentNullException.ThrowIfNull(trap);
    ArgumentNullException.ThrowIfNull(room);

    var baseDC = trap.DetectionDC;
    var lightModifier = GetLightDCModifier(room);

    return baseDC + lightModifier;
}
```

### 8.3 Detection Check Modification

Update passive and active detection to use light modifiers:

```csharp
// In CheckForTraps method:

foreach (var trap in room.ActiveTraps)
{
    var baseDC = trap.DetectionDC;
    var lightModifier = GetLightDCModifier(room);
    var effectiveDC = baseDC + lightModifier;

    var perceptionResult = PerformPerceptionCheck(player, effectiveDC);

    if (lightModifier > 0)
    {
        _logger.LogInformation(
            "Trap detection: Base DC {BaseDC} + Light modifier +{LightMod} = DC {EffectiveDC}",
            baseDC,
            lightModifier,
            effectiveDC);
    }

    // Continue with detection logic...
}
```

---

## 9. User-Facing Commands

### 9.1 Room Description Display

**Room with Light Level Header:**

```
The Ancient Crypt                           [Dark]
═══════════════════════════════════════════════════
You can barely make out the shapes of stone
sarcophagi in the oppressive darkness. The air
is cold and still.

[DARKNESS PENALTIES ACTIVE]
  • Accuracy: -3
  • Perception: +5 DC

Exits: north (dim light visible), south
```

### 9.2 Combat Display

**Attack in Darkness:**

```
> attack skeleton

You swing at the Skeleton in the darkness...

[Light Penalty: -3 accuracy]
[Rolling Attack: DC 12]
Roll: 2d6 + 3 - 3 = [5, 4] + 3 - 3 = 9

Your attack misses in the darkness!
```

**Successful Attack in Dim Light:**

```
> attack goblin

You strike at the Goblin in the dim torchlight...

[Light Penalty: -1 accuracy]
[Rolling Attack: DC 10]
Roll: 2d6 + 4 - 1 = [6, 3] + 4 - 1 = 12

You hit the Goblin for 8 damage!
```

### 9.3 Trap Detection Display

**Trap Detection in Darkness:**

```
You enter the Shadowy Corridor. Darkness fills
the passage ahead.

[Passive Perception check...]
[Base DC: 12, Darkness modifier: +5 = DC 17]
Roll: 2d6 + 3 = [4, 3] + 3 = 10

You don't notice anything unusual in the darkness.
```

**Trap Detection in Bright Light:**

```
You enter the Well-Lit Chamber. Sunlight streams
through cracks in the ceiling.

[Passive Perception check...]
[DC: 12]
Roll: 2d6 + 3 = [5, 6] + 3 = 14

You notice a pressure plate near the doorway!
[Trap detected: Poison Dart Trap]
```

### 9.4 Exit Light Level Hints

When describing exits, include light level information:

```
Exits:
  north - A bright glow emanates from the passage
  east - Darkness lies beyond
  south - Dim torchlight flickers in the distance
```

---

## 10. Data Model Changes

### 10.1 New Enums

| Enum | Layer | Description |
|------|-------|-------------|
| `LightLevel` | Domain | Room illumination levels |

### 10.2 New Constants

| Class | Layer | Description |
|-------|-------|-------------|
| `LightPenalties` | Domain | Penalty values and helper methods |

### 10.3 Modified Entities

| Entity | Layer | Changes |
|--------|-------|---------|
| `Room` | Domain | Add `BaseLightLevel`, `CurrentLightLevel`, `IsOutdoor`, `HasActiveLightSources` |

### 10.4 Modified Services

| Service | Layer | Changes |
|---------|-------|---------|
| `CombatService` | Application | Add `GetLightPenalty()` methods |
| `TrapService` | Application | Add `GetLightDCModifier()`, `GetEffectiveDetectionDC()` |

---

## 11. Configuration File Schemas

### 11.1 Room Configuration Schema Update

**File:** `config/schemas/rooms.schema.json`

Add light level properties to the room schema:

```json
{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "rooms.schema.json",
  "title": "Rooms Configuration",
  "type": "object",
  "properties": {
    "rooms": {
      "type": "array",
      "items": {
        "type": "object",
        "properties": {
          "id": {
            "type": "string",
            "description": "Unique room identifier"
          },
          "name": {
            "type": "string",
            "description": "Display name"
          },
          "description": {
            "type": "string",
            "description": "Room description"
          },
          "baseLightLevel": {
            "type": "string",
            "enum": ["Bright", "Dim", "Dark", "MagicalDarkness"],
            "default": "Dim",
            "description": "Base illumination level"
          },
          "isOutdoor": {
            "type": "boolean",
            "default": false,
            "description": "Whether this room is outdoors"
          }
        },
        "required": ["id", "name", "description"]
      }
    }
  }
}
```

### 11.2 Room Configuration Examples

**File:** `config/rooms.json`

```json
{
  "$schema": "./schemas/rooms.schema.json",
  "rooms": [
    {
      "id": "entrance-hall",
      "name": "Entrance Hall",
      "description": "A grand entrance hall with faded tapestries on the walls.",
      "baseLightLevel": "Dim",
      "isOutdoor": false
    },
    {
      "id": "crypt-entrance",
      "name": "Crypt Entrance",
      "description": "Stone steps descend into darkness below.",
      "baseLightLevel": "Dim",
      "isOutdoor": false
    },
    {
      "id": "ancient-crypt",
      "name": "The Ancient Crypt",
      "description": "Oppressive darkness fills this burial chamber. Stone sarcophagi line the walls.",
      "baseLightLevel": "Dark",
      "isOutdoor": false
    },
    {
      "id": "void-chamber",
      "name": "Chamber of the Void",
      "description": "Supernatural darkness consumes all light in this accursed chamber.",
      "baseLightLevel": "MagicalDarkness",
      "isOutdoor": false
    },
    {
      "id": "forest-clearing",
      "name": "Forest Clearing",
      "description": "A small clearing in the dense forest. Sunlight filters through the canopy.",
      "baseLightLevel": "Bright",
      "isOutdoor": true
    },
    {
      "id": "mountain-path",
      "name": "Mountain Path",
      "description": "A winding path along the mountainside with panoramic views.",
      "baseLightLevel": "Bright",
      "isOutdoor": true
    }
  ]
}
```

---

## 12. Logging Specifications

### 12.1 Log Levels by Component

| Component | Level | Events |
|-----------|-------|--------|
| `CombatService` | Information | Light penalty applied to attack |
| `CombatService` | Debug | Light level retrieved for combat |
| `TrapService` | Information | Light DC modifier applied to detection |
| `TrapService` | Debug | Light level retrieved for perception |
| `GameSessionService` | Information | Room entered with light level |
| `GameSessionService` | Debug | Light penalties displayed to player |

### 12.2 Example Log Messages

```
[INF] CombatService: Light penalty of -3 applied for attack in Dark conditions
[DBG] CombatService: Room "Ancient Crypt" has light level Dark
[INF] TrapService: Detection DC increased from 12 to 17 due to Dark conditions
[INF] GameSessionService: Player entered room "Ancient Crypt" [Light: Dark]
[DBG] GameSessionService: Displaying darkness penalties to player
```

---

## 13. Unit Testing Requirements

### 13.1 Test Count by Feature

| Feature | Test Count |
|---------|------------|
| LightLevel Enum | ~4 |
| LightPenalties Constants | ~8 |
| Room Light Properties | ~8 |
| CombatService Integration | ~6 |
| TrapService Integration | ~4 |
| **Total** | **~30** |

### 13.2 Test Specifications

#### LightLevelTests.cs

```csharp
[TestFixture]
public class LightLevelTests
{
    [Test]
    public void LightLevel_HasFourValues_AsExpected();

    [Test]
    public void LightLevel_BrightIsZero_ReturnsZero();

    [Test]
    public void LightLevel_MagicalDarknessIsHighest_ReturnsThree();

    [Test]
    public void LightLevel_ValuesAreOrdered_BrightToMagicalDarkness();
}
```

#### LightPenaltiesTests.cs

```csharp
[TestFixture]
public class LightPenaltiesTests
{
    [Test]
    public void GetAccuracyPenalty_Bright_ReturnsZero();

    [Test]
    public void GetAccuracyPenalty_Dim_ReturnsNegativeOne();

    [Test]
    public void GetAccuracyPenalty_Dark_ReturnsNegativeThree();

    [Test]
    public void GetAccuracyPenalty_MagicalDarkness_ReturnsNegativeFive();

    [Test]
    public void GetPerceptionDCModifier_Bright_ReturnsZero();

    [Test]
    public void GetPerceptionDCModifier_Dim_ReturnsTwo();

    [Test]
    public void GetPerceptionDCModifier_Dark_ReturnsFive();

    [Test]
    public void GetPerceptionDCModifier_MagicalDarkness_ReturnsTen();
}
```

#### RoomLightingTests.cs

```csharp
[TestFixture]
public class RoomLightingTests
{
    [Test]
    public void Room_DefaultBaseLightLevel_IsDim();

    [Test]
    public void Room_DefaultIsOutdoor_IsFalse();

    [Test]
    public void Room_SetBaseLightLevel_UpdatesProperty();

    [Test]
    public void Room_SetIsOutdoor_UpdatesProperty();

    [Test]
    public void Room_CurrentLightLevel_ReturnsBaseLightLevel();

    [Test]
    public void Room_HasActiveLightSources_ReturnsFalse();

    [Test]
    public void Room_Create_WithLightLevel_SetsCorrectly();

    [Test]
    public void Room_Create_WithIsOutdoor_SetsCorrectly();
}
```

#### CombatServiceLightTests.cs

```csharp
[TestFixture]
public class CombatServiceLightTests
{
    [Test]
    public void GetLightPenalty_BrightRoom_ReturnsZero();

    [Test]
    public void GetLightPenalty_DimRoom_ReturnsNegativeOne();

    [Test]
    public void GetLightPenalty_DarkRoom_ReturnsNegativeThree();

    [Test]
    public void GetLightPenalty_MagicalDarknessRoom_ReturnsNegativeFive();

    [Test]
    public void GetLightPenalty_WithPlayer_ReturnsRoomPenalty();

    [Test]
    public void GetLightPenalty_WithMonster_ReturnsRoomPenalty();
}
```

#### TrapServiceLightTests.cs

```csharp
[TestFixture]
public class TrapServiceLightTests
{
    [Test]
    public void GetLightDCModifier_BrightRoom_ReturnsZero();

    [Test]
    public void GetLightDCModifier_DarkRoom_ReturnsFive();

    [Test]
    public void GetEffectiveDetectionDC_BrightRoom_ReturnsBaseDC();

    [Test]
    public void GetEffectiveDetectionDC_DarkRoom_ReturnsBaseDCPlusFive();
}
```

---

## 14. Use Cases

### UC-001: Enter Dark Room

**Actor:** Player
**Flow:** Player moves → Room is Dark → Display light level → Show penalty indicator → Display room description

### UC-002: Attack in Darkness

**Actor:** Player
**Flow:** Player attacks → Get room light level → Calculate accuracy penalty → Apply to attack roll → Display penalty in combat log

### UC-003: Detect Trap in Dim Light

**Actor:** System
**Flow:** Player enters room → Check for traps → Get light DC modifier → Add to base DC → Perform perception check → Display result

### UC-004: View Room Light Level

**Actor:** Player
**Flow:** Player examines room → Display room description → Show light level in header → Show active penalties if any

### UC-005: Combat with Light Penalty

**Actor:** System
**Flow:** Monster attacks in Dark room → Get light penalty → Apply to monster attack → Display penalty in log → Resolve attack

---

## 15. Deliverable Checklist

### Domain Layer
- [ ] `LightLevel` enum with four values
- [ ] `LightPenalties` constants class with helper methods
- [ ] Room entity updated with light properties
- [ ] Room factory method updated with light parameters

### Application Layer
- [ ] `CombatService.GetLightPenalty()` methods
- [ ] Combat accuracy calculation includes light penalty
- [ ] `TrapService.GetLightDCModifier()` method
- [ ] `TrapService.GetEffectiveDetectionDC()` method
- [ ] Detection check includes light DC modifier

### Presentation Layer
- [ ] Room description includes light level indicator
- [ ] Penalty indicator displayed for non-Bright rooms
- [ ] Combat log shows light penalty when applicable
- [ ] Detection log shows light DC modifier when applicable
- [ ] Exit descriptions hint at light levels

### Configuration
- [ ] `rooms.schema.json` updated with light properties
- [ ] Sample `rooms.json` with varied light levels

### Testing
- [ ] ~30 unit tests implemented
- [ ] All tests passing

---

## 16. Acceptance Criteria

### Functional
- [ ] LightLevel enum has all four levels defined (Bright, Dim, Dark, MagicalDarkness)
- [ ] Room.BaseLightLevel stores configured light level
- [ ] Room.CurrentLightLevel computes effective light (returns BaseLightLevel in v0.4.3a)
- [ ] Room.IsOutdoor property exists for future day/night integration
- [ ] Combat accuracy applies light penalties correctly
- [ ] Trap detection DC increases in darkness
- [ ] Light level displays in room description header
- [ ] Penalty indicator shows in UI when penalties are active
- [ ] Bright light has no penalties (accuracy: 0, perception: +0 DC)
- [ ] Dim light has minor penalties (accuracy: -1, perception: +2 DC)
- [ ] Dark has significant penalties (accuracy: -3, perception: +5 DC)
- [ ] Magical darkness has maximum penalties (accuracy: -5, perception: +10 DC)

### Quality
- [ ] Build succeeds with 0 errors
- [ ] Build succeeds with 0 warnings
- [ ] ~30 unit tests pass
- [ ] Configuration files validate against schemas
- [ ] XML documentation complete for all public members

---

## 17. Dependencies

### 17.1 Required from v0.4.2c

| Type | Location | Usage in this phase |
|------|----------|---------------------|
| `Room` | `Domain/Entities/Room.cs` | Add light properties |
| `CombatService` | `Application/Services/CombatService.cs` | Add light penalty |
| `TrapService` | `Application/Services/TrapService.cs` | Add light DC modifier |
| `IGameRenderer` | `Application/Interfaces/IGameRenderer.cs` | Display light levels |

### 17.2 Provides to v0.4.3b

| Type | Usage |
|------|-------|
| `LightLevel` enum | Used by `LightSource` and vision type checks |
| `LightPenalties` | Used by vision type penalty mitigation |
| `Room.CurrentLightLevel` | Modified to consider active light sources |
| `Room.HasActiveLightSources` | Updated to check actual light source collection |

---

## 18. Future Considerations

### Deferred to v0.4.3b
- **Light Source Items**: Torches, lanterns, magical lights
- **Vision Types**: Normal, DarkVision, TrueSight
- **Light Commands**: `light`, `extinguish`, `refuel`
- **Room Light Source Collection**: Active light sources in rooms

### Deferred to v0.4.3c
- **Player Skills**: Perception skill affecting detection
- **Skill Proficiency**: Skill-based perception bonuses

### Deferred to v0.4.3d
- **Day/Night Cycle**: Time-based outdoor light changes
- **Weather Effects**: Weather-based visibility modifiers

### Out of Scope for v0.4.3
- **Light-based Puzzles**: Puzzles requiring light manipulation
- **Stealth Visibility**: Light affecting stealth effectiveness
- **Monster Light Behaviors**: Creatures avoiding/seeking light

---

*Document Version: 1.0*
*Last Updated: 2026-01-10*
*Author: AI Assistant*
