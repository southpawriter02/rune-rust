> **Archived** - This changelog has been consolidated. See the complete version at [v0.3.12](../v0.3.x/v0.3.12.md).

# Changelog: v0.3.12b - The Warrior's Trial

**Release Date:** 2025-12-24
**Total Tests:** 2616 (12 new tests added)

## Table of Contents

- [Summary](#summary)
- [New Files Created](#new-files-created)
- [Files Modified](#files-modified)
- [Code Implementation Details](#code-implementation-details)
- [Logging Matrix](#logging-matrix)
- [Test Coverage](#test-coverage)
- [Verification Results](#verification-results)
- [Directory Structure After v0.3.12b](#directory-structure-after-v0312b)
- [Running Tests](#running-tests)
- [Design Decisions](#design-decisions)
- [Next Steps](#next-steps)
- [Credits](#credits)

---

## Summary

Version 0.3.12b extends the E2E Integration Testing Infrastructure to support **Combat Journey Testing**. This release introduces the `SetupCombatAsync()` method to TestGameHost, enabling automated testing of complete combat encounters with deterministic dice rolls. The "Training Dummy" pattern provides a weak, configurable enemy for rapid test execution.

**Layers Touched:**
- **Test Layer:** Extended `TestGameHost` with combat setup, created `CombatJourneyTests` with 12 E2E combat tests

**Patterns Introduced:**
- **Training Dummy Pattern:** Configurable low-HP enemy for fast combat resolution
- **Combat Setup Composition:** `SetupCombatAsync()` builds on `SetupExplorationAsync()` for layered initialization
- **Attack Variant Testing:** Dedicated tests for standard, light, and heavy attack commands
- **Phase Verification:** Pre-run and post-run assertions on `GamePhase` transitions
- **Combat Service Access:** `GetCombatService()` helper for direct state interrogation

**Key Metrics:**
- 1 new file created (CombatJourneyTests.cs)
- 1 file modified (TestGameHost.cs)
- 12 E2E combat integration tests
- 100% test pass rate for new tests
- 0 regressions in existing ExplorationJourneyTests (9/9 passing)

---

## New Files Created

### Test Layer

| File | Purpose |
|------|---------|
| `RuneAndRust.Tests/Integration/CombatJourneyTests.cs` | 12 E2E integration tests simulating complete combat encounters through the game loop with deterministic RNG |

---

## Files Modified

| File | Change |
|------|--------|
| `RuneAndRust.Tests/Infrastructure/TestGameHost.cs` | Added `SetupCombatAsync(string characterName, int enemyHp)` method for combat test initialization. Added `GetCombatService()` helper method for direct combat state access. Uses fully qualified namespace `RuneAndRust.Core.Enums.Attribute` to avoid namespace collision with `RuneAndRust.Tests.Core.Enums`. |

---

## Code Implementation Details

### SetupCombatAsync Method

**Location:** `RuneAndRust.Tests/Infrastructure/TestGameHost.cs:288-321`

**Purpose:** Initializes game state for combat testing by creating a character, test room, and a weak "Training Dummy" enemy, then starting combat via `CombatService.StartCombat()`.

**Signature:**
```csharp
public async Task SetupCombatAsync(string characterName = "TestWarrior", int enemyHp = 15)
```

**Parameters:**

| Parameter | Type | Default | Description |
|-----------|------|---------|-------------|
| `characterName` | `string` | `"TestWarrior"` | Name for the test character created via `CharacterFactory.CreateSimple()` |
| `enemyHp` | `int` | `15` | Max/Current HP for the Training Dummy. Lower values enable faster combat resolution. |

**Implementation Flow:**
1. Calls `SetupExplorationAsync(characterName)` to create character and test rooms
2. Creates a "Training Dummy" enemy with configurable HP
3. Calls `CombatService.StartCombat()` to transition to `GamePhase.Combat`

**Training Dummy Configuration:**

| Property | Value | Rationale |
|----------|-------|-----------|
| `Name` | `"Training Dummy"` | Clear identifier for test assertions |
| `MaxHp` / `CurrentHp` | Configurable (default 15) | Low HP enables rapid combat resolution |
| `MaxStamina` / `CurrentStamina` | `50` | Sufficient for multiple enemy actions |
| `WeaponDamageDie` | `4` (d4) | Low damage to avoid killing player |
| `WeaponAccuracyBonus` | `0` | Baseline accuracy for predictable hits |
| `ArmorSoak` | `0` | No damage reduction for faster kills |
| `WeaponName` | `"Wooden Arms"` | Thematic for training dummy |
| `Archetype` | `EnemyArchetype.DPS` | Standard combat behavior |
| `Tags` | `["Training"]` | Categorization for filtering |

**Enemy Attributes:**

| Attribute | Value | Purpose |
|-----------|-------|---------|
| `Sturdiness` | `3` | Low HP pool, minimal defense |
| `Might` | `3` | Weak attacks |
| `Wits` | `1` | Low initiative bonus |
| `Will` | `1` | Minimal mental resistance |
| `Finesse` | `2` | Poor accuracy |

---

### GetCombatService Helper Method

**Location:** `RuneAndRust.Tests/Infrastructure/TestGameHost.cs:326`

**Purpose:** Provides direct access to the `ICombatService` singleton for test assertions on combat state.

**Signature:**
```csharp
public ICombatService GetCombatService() => _serviceProvider.GetRequiredService<ICombatService>();
```

**Usage:**
```csharp
var combatService = host.GetCombatService();
combatService.Should().NotBeNull();
host.GameState.Phase.Should().Be(GamePhase.Combat);
```

---

### CombatJourneyTests

**Location:** `RuneAndRust.Tests/Integration/CombatJourneyTests.cs`

**Purpose:** E2E integration tests for combat journeys simulating complete combat encounters through the game loop with deterministic RNG seeding.

**Test Categories:**

| Category | Tests | Description |
|----------|-------|-------------|
| Victory/Escape | 2 | Combat resolution paths (defeat enemy, flee) |
| Attack Commands | 4 | Standard, light, heavy attacks + damage verification |
| Determinism | 2 | Same seed = same outcome, different seeds = different outcomes |
| Turn Order | 1 | Enemy AI executes after player pass |
| Status/Info | 1 | Status command displays combatant information |
| Setup/Infrastructure | 2 | Phase verification, service access |

---

## Logging Matrix

### CombatService (Exercised by Tests)

| Event | Level | Template | Properties |
|-------|-------|----------|------------|
| Combat Initialized | Info | `"Initializing Combat. Enemies: {EnemyCount}"` | EnemyCount |
| Combat Started | Info | `"Combat Started. Round {Round}. Active: {ActiveCombatant}"` | Round, ActiveCombatant |
| Initiative Rolled | Debug | `"{CombatantName} rolled initiative: {Total} (d10:{Roll} + Vigilance:{Vigilance})"` | CombatantName, Total, Roll, Vigilance |
| Player Added | Debug | `"Added player {Name} to combat with {AbilityCount} abilities, Row: {Row}"` | Name, AbilityCount, Row |
| Enemy Added | Debug | `"Added enemy {Name} to combat, Row: {Row}"` | Name, Row |
| Turn Order | Debug | `"Turn order: {TurnOrder}"` | TurnOrder |
| AI Action Selected | Debug | `"[AI] {EnemyName} selected {ActionType} (AbilityId: {AbilityId})"` | EnemyName, ActionType, AbilityId |
| Intent Check | Debug | `"[Combat] Intent check vs {EnemyName}: {Result} ({Successes} successes, pool: {Pool})"` | EnemyName, Result, Successes, Pool |

### DiceService (Exercised by Tests)

| Event | Level | Template | Properties |
|-------|-------|----------|------------|
| Seeded Initialization | Info | `"DiceService initialized with seed {Seed} for deterministic rolls"` | Seed |
| Single Die Roll | Debug | `"Rolled {Result} on 1d{Sides} ({Context})"` | Result, Sides, Context |
| Pool Roll Complete | Debug | `"Roll complete: {Successes} successes, {Botches} botches from {PoolSize}d10 [{Rolls}] ({Context})"` | Successes, Botches, PoolSize, Rolls, Context |

---

## Test Coverage

**Summary:**
```
Test Run Successful.
Total tests: 12
     Passed: 12
 Total time: 583 ms
```

### CombatJourneyTests (12 tests)

| Test Name | Description | Commands Used |
|-----------|-------------|---------------|
| `Combat_Victory_DefeatsEnemy_ReturnsToExploration` | Repeated attacks defeat low-HP Training Dummy (15 HP). Verifies combat resolution and phase transition. | `attack training dummy` ×10, `quit` |
| `Combat_Flee_EscapesCombat_ReturnsToExploration` | Flee command ends combat gracefully without victory. Verifies `IsScriptExhausted` and phase transition. | `flee`, `quit` |
| `Combat_AttackCommand_DamagesEnemy` | Single attack produces combat feedback. Asserts output contains "attack", "damage", "hit", or "Training Dummy". | `attack training dummy`, `quit` |
| `Combat_DeterministicSeed_ProducesSameOutcome` | Two runs with seed 12345 produce byte-identical `GetFullOutput()` strings. Validates deterministic RNG. | `attack training dummy`, `flee`, `quit` |
| `Combat_EnemyTurn_ExecutesAfterPlayer` | Pass player turn, then flee. Verifies enemy AI executes and turn order processes correctly. | `end`, `flee`, `quit` |
| `Combat_Status_DisplaysCombatantInfo` | Status command during combat produces non-empty output buffer. | `status`, `quit` |
| `Combat_LightAttack_ExecutesWithReducedStamina` | Light attack variant (+1 hit, d4 damage, 15 stamina) processes without errors. | `light training dummy`, `quit` |
| `Combat_HeavyAttack_ExecutesWithIncreasedDamage` | Heavy attack variant (-1 hit, d8 damage, 40 stamina) processes without errors. | `heavy training dummy`, `quit` |
| `Combat_DifferentSeeds_ProduceDifferentOutcomes` | Seeds 100 and 999 produce different RNG sequences. Verifies test isolation. | `attack training dummy`, `quit` |
| `Combat_FullEncounter_CompletesSuccessfully` | Multi-command combat flow with mixed attack types. Verifies extended combat sessions complete. | `status`, `light`, `attack`, `heavy`, `attack` ×7, `quit` |
| `Combat_Setup_SetsCorrectPhase` | Asserts `GamePhase.Combat` immediately after `SetupCombatAsync()`, before `RunAsync()`. | `quit` |
| `Combat_GetCombatService_ReturnsValidService` | Verifies `GetCombatService()` returns non-null service and `GamePhase.Combat` is set. | `quit` |

### Test Patterns Used

**Arrange-Act-Assert Structure:**
```csharp
// Arrange - Create script and host
var script = new[] { "attack training dummy", "quit" };
using var host = TestGameHost.Create(seed: 42, script);
await host.SetupCombatAsync("TestWarrior");

// Act - Run game loop
await host.RunAsync();

// Assert - Verify outcomes
host.GameState.Phase.Should().Be(GamePhase.Quit);
host.InputHandler.OutputBuffer.Should().NotBeEmpty();
```

**Determinism Verification Pattern:**
```csharp
using var host1 = TestGameHost.Create(seed: seed, script);
await host1.SetupCombatAsync("TestWarrior", enemyHp: 100);
await host1.RunAsync();
var output1 = host1.InputHandler.GetFullOutput();

using var host2 = TestGameHost.Create(seed: seed, script);
await host2.SetupCombatAsync("TestWarrior", enemyHp: 100);
await host2.RunAsync();
var output2 = host2.InputHandler.GetFullOutput();

output1.Should().Be(output2, "Same seed should produce identical combat output");
```

**Pre-Run Phase Verification Pattern:**
```csharp
using var host = TestGameHost.Create(seed: 42, script);
await host.SetupCombatAsync("TestWarrior");

// Assert before running - verify combat phase was set
host.GameState.Phase.Should().Be(GamePhase.Combat);

await host.RunAsync();

// Assert after running - verify quit transitions correctly
host.GameState.Phase.Should().Be(GamePhase.Quit);
```

---

## Verification Results

### Build Output

```
Build succeeded.
    0 Warning(s)
    0 Error(s)
```

### CombatJourneyTests Output

```
dotnet test --filter "FullyQualifiedName~CombatJourneyTests" --no-build

Passed!  - Failed: 0, Passed: 12, Skipped: 0, Total: 12, Duration: 583 ms
```

### ExplorationJourneyTests Regression Check

```
dotnet test --filter "FullyQualifiedName~ExplorationJourneyTests" --no-build

Passed!  - Failed: 0, Passed: 9, Skipped: 0, Total: 9, Duration: 510 ms
```

### Combined E2E Test Suite

```
Total Integration Tests: 21 (9 Exploration + 12 Combat)
Pass Rate: 100%
```

---

## Directory Structure After v0.3.12b

```
RuneAndRust.Tests/
├── Infrastructure/
│   ├── ScriptedInputHandler.cs                         [v0.3.12a]
│   └── TestGameHost.cs                                 [MODIFIED - v0.3.12b]
└── Integration/
    ├── ExplorationJourneyTests.cs                      [v0.3.12a]
    └── CombatJourneyTests.cs                           [NEW - v0.3.12b]
```

---

## Running Tests

**Run all v0.3.12b combat tests:**
```bash
dotnet test --filter "FullyQualifiedName~CombatJourneyTests"
```

**Run with verbose output:**
```bash
dotnet test --filter "CombatJourneyTests" --logger "console;verbosity=detailed"
```

**Run all E2E integration tests (v0.3.12a + v0.3.12b):**
```bash
dotnet test --filter "FullyQualifiedName~JourneyTests"
```

**Run specific combat test:**
```bash
dotnet test --filter "Combat_DeterministicSeed_ProducesSameOutcome"
```

**Run with specific seed verification:**
```bash
dotnet test --filter "Combat_DeterministicSeed" -v n
```

---

## Design Decisions

### Why Composition over Duplication?

**Problem:** Combat tests need character and room setup, duplicating `SetupExplorationAsync()` logic.

**Solution:** `SetupCombatAsync()` calls `SetupExplorationAsync()` first, then adds combat-specific setup. This follows the DRY principle and ensures exploration infrastructure remains tested. Changes to character creation automatically propagate to combat tests.

### Why Training Dummy Pattern?

**Problem:** Real enemies (60+ HP) make tests slow; tests need many attack commands to achieve victory.

**Solution:** A "Training Dummy" with configurable HP (default 15) allows tests to control combat duration. Low HP enables victory in few attacks; high HP enables extended combat for determinism tests. The weak stats (d4 damage, 0 accuracy bonus) prevent player death during tests.

### Why Default 15 HP?

**Problem:** Need to balance test speed with realistic combat simulation.

**Solution:** 15 HP typically resolves in 2-4 successful hits with a Warrior character. This provides enough turns to test turn order, enemy AI, and attack resolution while completing quickly. Tests requiring extended combat can override with `enemyHp: 100`.

### Why Fully Qualified Namespace for Attribute?

**Problem:** `Core.Enums.Attribute` resolved to `RuneAndRust.Tests.Core.Enums.Attribute` within the Tests project, causing CS0234 build errors.

**Solution:** Used fully qualified namespace `RuneAndRust.Core.Enums.Attribute` in the dictionary initialization. This explicit reference eliminates namespace ambiguity without requiring using aliases.

### Why GetCombatService() Helper?

**Problem:** Tests may need to access combat state directly for assertions beyond `GameState.Phase`.

**Solution:** `GetCombatService()` exposes the singleton `ICombatService` from the DI container. This enables future tests to assert on turn order, combatant lists, or other internal combat state without modifying TestGameHost.

### Why Test Attack Variants Separately?

**Problem:** Light/Heavy attacks have different stamina costs and damage profiles that could silently break.

**Solution:** Dedicated tests (`Combat_LightAttack_ExecutesWithReducedStamina`, `Combat_HeavyAttack_ExecutesWithIncreasedDamage`) ensure all attack variants process correctly. These tests verify command parsing and attack resolution for each type.

---

## Next Steps

- **v0.3.12c (The Gauntlet):** Full gameplay loop tests including character creation, combat victory, loot acquisition, and inventory management
- **Future:** Ability usage tests with seeded ActiveAbility data
- **Future:** Multi-enemy combat tests
- **Future:** Status effect application and expiration tests
- **Future:** CI/CD integration with combat test scripts as regression gates

---

## Credits

**Primary Developer:** The Architect (Claude)
**Test Coverage:** 100% for new CombatJourneyTests (12/12 tests passing)
**Regression:** Zero regressions in ExplorationJourneyTests (9/9 tests passing)
**Documentation:** Follows CHANGELOG_GENERATION_RULES.md Extended Template
