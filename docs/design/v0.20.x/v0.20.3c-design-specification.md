# Design Specification: v0.20.3c - Tier 3 & Capstone Abilities

**Version:** v0.20.3b
**Status:** Design Phase
**Last Updated:** 2026-01-28
**Target Tests:** ~7 unit and integration tests
**Specialization:** Jötun-Reader (Adept)

---

## Table of Contents

1. [Executive Summary](#1-executive-summary)
2. [Feature Overview](#2-feature-overview)
3. [Architecture Diagrams](#3-architecture-diagrams)
4. [User Stories](#4-user-stories)
5. [Tier 3 Framework](#5-tier-3-framework)
6. [Lore Keeper Ability Specification](#6-lore-keeper-ability-specification)
7. [Ancient Knowledge Ability Specification](#7-ancient-knowledge-ability-specification)
8. [Voice of the Giants Capstone Specification](#8-voice-of-the-giants-capstone-specification)
9. [Technology Activation System](#9-technology-activation-system)
10. [Layer System Mastery](#10-layer-system-mastery)
11. [Bonus Lore System](#11-bonus-lore-system)
12. [Dormant Technology Database](#12-dormant-technology-database)
13. [Capstone Prerequisites Validation](#13-capstone-prerequisites-validation)
14. [Configuration Files](#14-configuration-files)
15. [Code Examples and Implementation](#15-code-examples-and-implementation)
16. [Domain Models](#16-domain-models)
17. [Service Architecture](#17-service-architecture)
18. [Lore Revelation System](#18-lore-revelation-system)
19. [Technology Effect Resolution](#19-technology-effect-resolution)
20. [Logging Specifications](#20-logging-specifications)
21. [Unit Testing Requirements](#21-unit-testing-requirements)
22. [Deliverable Checklist](#22-deliverable-checklist)
23. [Acceptance Criteria](#23-acceptance-criteria)

---

## 1. Executive Summary

Version 0.20.3c implements the three culminating abilities for the Jötun-Reader specialization: two Tier 3 passives and the Capstone ultimate. These represent mastery of ancient knowledge and the ability to commune with Jötun technology itself. Tier 3 requires 16 PP invested in the tree, while the Capstone requires 24 PP, representing end-game progression (levels 8-12 typical).

### Key Deliverables

| Category | Count | Details |
|----------|-------|---------|
| **Tier 3 Abilities** | 2 | Lore Keeper, Ancient Knowledge |
| **Capstone Ability** | 1 | Voice of the Giants (Ultimate) |
| **Domain Models** | 2 | LoreRevelation, ActivatedTechnology |
| **Enums** | 1 | JotunTechnologyType |
| **Application Services** | 3 | Lore Keeper Service, Ancient Knowledge Service, Technology Activation Service |
| **Technology System** | 1 | Dormant technology awakening mechanics |
| **Configuration Updates** | 2 | specializations.json, abilities.json |
| **Unit Tests** | ~7 | Comprehensive test coverage |

### Tier 3 & Capstone Status

| Attribute | Value |
|-----------|-------|
| **Tier 3 PP Requirement** | 16 PP invested |
| **Tier 3 Cost Per Ability** | 5 PP each |
| **Capstone PP Requirement** | 24 PP invested |
| **Capstone Cost** | 6 PP |
| **Capstone AP Cost** | 5 AP |
| **Capstone Lore Insight Cost** | 8 |
| **Capstone Cooldown** | Once per long rest |

---

## 2. Feature Overview

### 2.1 Tier 3 - Advanced Mastery

Tier 3 represents deep specialization in historical knowledge and expert examination:

- **Lore Keeper** (Passive): Auto-succeeds Layer 3 for historical objects
- **Ancient Knowledge** (Passive): Reveals bonus lore on Expert+ examinations

### 2.2 Capstone - Voice of the Giants

The ultimate ability allows direct communication with ancient Jötun technology:

- **Voice of the Giants** (Ultimate): Activate dormant Jötun machinery
- Can restore power systems, medical facilities, communications, or defense grids
- Lasts 1 hour per activation
- Available once per long rest
- Costs entire exploration's accumulated Lore Insight to use (8 points)

### 2.3 Thematic Integration

The progression tells a story:
- Tier 1: Learning to read and understand ancient knowledge
- Tier 2: Using knowledge for tactical advantage
- Tier 3: Becoming an expert in historical research and information
- Capstone: Speaking with the voice of the giants themselves

---

## 3. Architecture Diagrams

### 3.1 Tier 3 & Capstone Service Integration

```
┌──────────────────────────────────────────────────────────────────┐
│        Jötun-Reader Tier 3 & Capstone Architecture               │
├──────────────────────────────────────────────────────────────────┤
│                                                                   │
│  ┌────────────────────────────────────────────────────────────┐ │
│  │  Advanced Jötun-Reader Service (Orchestrator)              │ │
│  │                                                            │ │
│  │  + ValidateTier3Prerequisites()                           │ │
│  │  + ExecuteLoreKeeper()                                    │ │
│  │  + ExecuteAncientKnowledge()                              │ │
│  │  + ValidateCapstoneAccess()                               │ │
│  │  + ExecuteVoiceOfTheGiants()                              │ │
│  └────────────────────────────────────────────────────────────┘ │
│         │              │                     │                  │
│         ▼              ▼                     ▼                  │
│  ┌─────────────┐ ┌──────────────┐ ┌──────────────────┐        │
│  │   Lore      │ │  Ancient     │ │  Technology      │        │
│  │  Keeper     │ │  Knowledge   │ │  Activation      │        │
│  │  Service    │ │  Service     │ │  Service         │        │
│  └─────────────┘ └──────────────┘ └──────────────────┘        │
│         │              │                     │                  │
│         ▼              ▼                     ▼                  │
│  ┌─────────────┐ ┌──────────────┐ ┌──────────────────┐        │
│  │   Layer     │ │   Bonus      │ │   Dormant        │        │
│  │  System     │ │   Lore       │ │   Technology     │        │
│  │  Extension  │ │   Engine     │ │   Database       │        │
│  └─────────────┘ └──────────────┘ └──────────────────┘        │
│                                                                   │
└──────────────────────────────────────────────────────────────────┘

Voice of the Giants Activation Flow:
┌──────────────┐      ┌──────────────┐       ┌──────────────┐
│   Speak      │─────▶│   Technology │──────▶│   Activate   │
│   Incantation│      │   Identified │       │   Effects    │
└──────────────┘      └──────────────┘       └──────────────┘
        │                     │                      │
        │         ┌───────────┴──────────┐           │
        │         │                      │           │
        ▼         ▼                      ▼           ▼
    +8 Lore  Jötun-Made?           Check Power   1 Hour Duration
    Insight  Dormant?          or Effect Type    (OR Custom)
             Function?
```

### 3.2 Lore Revelation Architecture

```
┌────────────────────────────────────────────────┐
│     Bonus Lore Generation System               │
├────────────────────────────────────────────────┤
│                                                 │
│  Expert Success (Layers 1-3)                  │
│  └─ Generate 1 Lore Entry                     │
│     ├─ Historical Context                     │
│     ├─ Related Location                       │
│     └─ Connected Figure                       │
│                                                 │
│  Master Success (Layers 1-4)                  │
│  └─ Generate 2 Lore Entries                   │
│     ├─ Historical Context + Hidden Purpose    │
│     ├─ Related Locations (Multiple)           │
│     ├─ Connected Figures                      │
│     └─ Warning Signs                          │
│                                                 │
│  Each Entry:                                  │
│  ├─ +1 Lore Insight                           │
│  ├─ Quest Hook potential                      │
│  └─ World building content                    │
│                                                 │
└────────────────────────────────────────────────┘
```

---

## 4. User Stories

### User Story 1: Scholar Masters Historical Examination

**As a** Jötun-Reader character examining a historical relic
**I want to** automatically reveal Layer 3 information without requiring checks
**So that** I can quickly understand the deepest historical context

**Acceptance Criteria:**
- Lore Keeper unlocked at 16 PP invested
- Applies to Layer 3 of historical objects and artifacts
- Works passively without activation
- Generates 2 Lore Insight on first examination of each unique historical object
- Stacks with Pattern Recognition (Layer 2 auto-success for Jötun tech)
- Works on artifact categories: Named items, legendary items, relics, monuments, documents

### User Story 2: Expert Reveals Hidden Lore

**As a** Jötun-Reader achieving Expert success on an examination
**I want to** automatically unlock bonus lore entries
**So that** I can discover additional story elements and quest hooks

**Acceptance Criteria:**
- Ancient Knowledge unlocked at 16 PP invested
- Triggers on Expert+ examination success levels
- Reveals 1 bonus lore entry on Expert success
- Reveals 2 bonus lore entries on Master success
- Each entry contains: historical context, related locations, connected figures, or warnings
- Each entry generates +1 Lore Insight
- Bonus lore is unique per character/object combination

### User Story 3: Master Awakens Ancient Technology

**As a** Jötun-Reader with 24 PP invested (ultimate ability level)
**I want to** spend 5 AP and 8 Lore Insight to activate dormant Jötun technology
**So that** I can reveal hidden areas, provide healing, establish communication, or other dramatic effects

**Acceptance Criteria:**
- Voice of the Giants costs 24 PP investment to unlock (6 PP unlock cost)
- Activation costs 5 AP and 8 Lore Insight (maximum resource)
- Can only be used once per long rest (powerful but limited)
- Must touch or speak ancient incantation to dormant technology
- Technology types: Power Node, Defense Grid, Transport, Medical Bay, Archive, Fabricator, Sensor, Environmental
- Duration: 1 hour per activation
- Effects vary dramatically by technology type
- May have unintended consequences or dangers

### User Story 4: Campaign Milestone - Capstone Progression

**As a** Game Master tracking specialization progression
**I want to** verify that the Capstone is locked until 24 PP are invested
**So that** specialization progression reaches natural climax at high levels

**Acceptance Criteria:**
- Capstone inaccessible until 24 PP invested
- Clear messaging about requirements
- Capstone represents ultimate power for Jötun-Reader
- Campaign-defining ability when activated

---

## 5. Tier 3 Framework

### 5.1 Tier 3 Prerequisites Validation

```csharp
/// <summary>
/// Validates Tier 3 and Capstone prerequisites.
/// </summary>
public interface IAdvancedTierPrerequisiteValidator
{
    /// <summary>
    /// Checks if character can access Tier 3 abilities.
    /// </summary>
    bool CanAccessTier3(Character character);

    /// <summary>
    /// Checks if character can access Capstone.
    /// </summary>
    bool CanAccessCapstone(Character character);

    /// <summary>
    /// Gets access denial reason if any.
    /// </summary>
    string? GetAccessDenialReason(Character character, string tierLevel);
}

/// <summary>
/// Implementation of advanced tier validation.
/// </summary>
public sealed class AdvancedTierPrerequisiteValidator : IAdvancedTierPrerequisiteValidator
{
    private const int RequiredPPForTier3 = 16;
    private const int RequiredPPForCapstone = 24;

    public bool CanAccessTier3(Character character)
    {
        if (character?.Specialization?.SpecializationId != "jotun-reader")
            return false;

        var investedPP = character.GetSpecializationPointsInvested("jotun-reader");
        return investedPP >= RequiredPPForTier3;
    }

    public bool CanAccessCapstone(Character character)
    {
        if (character?.Specialization?.SpecializationId != "jotun-reader")
            return false;

        var investedPP = character.GetSpecializationPointsInvested("jotun-reader");
        return investedPP >= RequiredPPForCapstone;
    }

    public string? GetAccessDenialReason(Character character, string tierLevel)
    {
        if (character?.Specialization?.SpecializationId != "jotun-reader")
            return "Character must be Jötun-Reader specialization";

        var investedPP = character.GetSpecializationPointsInvested("jotun-reader");

        if (tierLevel == "3" || tierLevel.StartsWith("tier3", StringComparison.OrdinalIgnoreCase))
        {
            if (investedPP < RequiredPPForTier3)
            {
                var needed = RequiredPPForTier3 - investedPP;
                return $"Tier 3 requires {RequiredPPForTier3} PP. You have {investedPP}, need {needed} more.";
            }
        }
        else if (tierLevel == "capstone")
        {
            if (investedPP < RequiredPPForCapstone)
            {
                var needed = RequiredPPForCapstone - investedPP;
                return $"Capstone requires {RequiredPPForCapstone} PP. You have {investedPP}, need {needed} more.";
            }
        }

        return null;
    }
}
```

---

## 6. Lore Keeper Ability Specification

### 6.1 Ability Profile

| Property | Value |
|----------|-------|
| **Ability ID** | `lore-keeper` |
| **Type** | Passive |
| **AP Cost** | — (always active) |
| **Lore Insight Cost** | — (generates 2 on first examination) |
| **Tier** | 3 |
| **PP Cost** | 5 PP to unlock |
| **Prerequisites** | 16 PP in Jötun-Reader tree |

### 6.2 Lore Keeper Service

```csharp
/// <summary>
/// Lore Keeper passive ability service.
/// Auto-succeeds Layer 3 for historical objects.
/// </summary>
public sealed class LoreKeeperAbility : IPassiveAbility
{
    public string AbilityId => "lore-keeper";
    public bool IsPassive => true;
    public int Tier => 3;

    /// <summary>
    /// Determines if Layer 3 should auto-succeed for this target.
    /// </summary>
    public LayerCheckModification GetLayerModification(
        ExaminationTarget target,
        int layerNumber,
        Character character)
    {
        // Only applies to Layer 3 of historical objects
        if (!IsHistoricalObject(target) || layerNumber != 3)
            return LayerCheckModification.None();

        return LayerCheckModification.AutoSucceed(
            reason: "Lore Keeper - Mastery of Historical Knowledge",
            insightGenerated: 2); // 2 on first examination
    }

    /// <summary>
    /// Determines if a target is a historical object.
    /// </summary>
    private bool IsHistoricalObject(ExaminationTarget target)
    {
        return target.Category == ObjectCategory.Artifact ||
               target.Category == ObjectCategory.Relic ||
               target.Category == ObjectCategory.Document ||
               target.Category == ObjectCategory.Monument ||
               target.Category == ObjectCategory.HistoricalRemains ||
               target.Tags.Contains("Historical", StringComparer.OrdinalIgnoreCase);
    }
}

/// <summary>
/// Layer progression with all Tier 3 passives.
/// </summary>
public sealed record LayerProgression
{
    public int Layer { get; init; }
    public int BaselineDC { get; init; }
    public bool AutoSucceedWithPatternRecognition { get; init; }
    public bool AutoSucceedWithLoreKeeper { get; init; }
    public int DCIfStandard { get; init; }

    public static readonly LayerProgression[] Standard = new[]
    {
        new LayerProgression // Layer 1
        {
            Layer = 1,
            BaselineDC = 0,
            AutoSucceedWithPatternRecognition = false,
            AutoSucceedWithLoreKeeper = false,
            DCIfStandard = 0 // Always succeeds
        },
        new LayerProgression // Layer 2
        {
            Layer = 2,
            BaselineDC = 12,
            AutoSucceedWithPatternRecognition = true, // For Jötun tech
            AutoSucceedWithLoreKeeper = false,
            DCIfStandard = 12
        },
        new LayerProgression // Layer 3
        {
            Layer = 3,
            BaselineDC = 16,
            AutoSucceedWithPatternRecognition = false,
            AutoSucceedWithLoreKeeper = true, // For historical objects
            DCIfStandard = 16
        },
        new LayerProgression // Layer 4
        {
            Layer = 4,
            BaselineDC = 20,
            AutoSucceedWithPatternRecognition = false,
            AutoSucceedWithLoreKeeper = false,
            DCIfStandard = 20
        }
    };
}
```

---

## 7. Ancient Knowledge Ability Specification

### 7.1 Ability Profile

| Property | Value |
|----------|-------|
| **Ability ID** | `ancient-knowledge` |
| **Type** | Passive |
| **AP Cost** | — (always active) |
| **Lore Insight Cost** | — (generates 1 per bonus lore entry) |
| **Tier** | 3 |
| **PP Cost** | 5 PP to unlock |
| **Prerequisites** | 16 PP in Jötun-Reader tree |

### 7.2 Lore Revelation Value Object

```csharp
/// <summary>
/// Bonus lore revealed by Ancient Knowledge ability.
/// </summary>
[ValueObject]
public sealed record LoreRevelation
{
    /// <summary>Unique identifier for this revelation.</summary>
    public Guid RevelationId { get; init; }

    /// <summary>ID of the examination that triggered this.</summary>
    public Guid SourceExaminationId { get; init; }

    /// <summary>Type of lore revealed.</summary>
    public LoreType RevelationType { get; init; }

    /// <summary>Title/summary of the revelation.</summary>
    public string Title { get; init; } = string.Empty;

    /// <summary>Full revelation content.</summary>
    public string Content { get; init; } = string.Empty;

    /// <summary>Related locations mentioned.</summary>
    public IReadOnlyList<Guid> RelatedLocationIds { get; init; } = new List<Guid>();

    /// <summary>Related figures/people mentioned.</summary>
    public IReadOnlyList<string> RelatedFigures { get; init; } = new List<string>();

    /// <summary>Lore Insight generated by this revelation.</summary>
    public int InsightGenerated { get; init; } = 1;

    /// <summary>When the revelation was made.</summary>
    public DateTime RevealedAt { get; init; }

    /// <summary>
    /// Creates a new lore revelation.
    /// </summary>
    public static LoreRevelation Create(
        Guid sourceExaminationId,
        LoreType type,
        string title,
        string content,
        IEnumerable<Guid> relatedLocations = null,
        IEnumerable<string> relatedFigures = null)
    {
        return new LoreRevelation
        {
            RevelationId = Guid.NewGuid(),
            SourceExaminationId = sourceExaminationId,
            RevelationType = type,
            Title = title,
            Content = content,
            RelatedLocationIds = relatedLocations?.ToList().AsReadOnly() ?? new List<Guid>().AsReadOnly(),
            RelatedFigures = relatedFigures?.ToList().AsReadOnly() ?? new List<string>().AsReadOnly(),
            RevealedAt = DateTime.UtcNow
        };
    }

    /// <summary>
    /// Gets a summary of the revelation.
    /// </summary>
    public string GetSummary() => $"{RevelationType}: {Title}";

    /// <summary>
    /// Determines if this revelation has related locations.
    /// </summary>
    public bool HasRelatedLocations() => RelatedLocationIds.Count > 0;

    /// <summary>
    /// Gets quest hooks from this revelation.
    /// </summary>
    public IReadOnlyList<string> GetQuestHooks()
    {
        var hooks = new List<string>();

        if (HasRelatedLocations())
            hooks.Add($"Investigate {RelatedLocationIds.Count} related locations");

        if (RelatedFigures.Count > 0)
            hooks.Add($"Seek information about: {string.Join(", ", RelatedFigures.Take(2))}");

        if (RevelationType == LoreType.Warning)
            hooks.Add("Heed the warnings mentioned in this revelation");

        return hooks.AsReadOnly();
    }
}

/// <summary>
/// Types of lore revelations.
/// </summary>
public enum LoreType
{
    /// <summary>Historical context about the item's creation</summary>
    HistoricalContext = 0,

    /// <summary>Hidden purpose or secret function</summary>
    HiddenPurpose = 1,

    /// <summary>Related locations for exploration</summary>
    RelatedLocation = 2,

    /// <summary>Connected historical figures</summary>
    ConnectedFigure = 3,

    /// <summary>Warnings or dangers</summary>
    Warning = 4,

    /// <summary>Creation method or craftsmanship</summary>
    Craftsmanship = 5,

    /// <summary>Legendary status or significance</summary>
    Legend = 6
}
```

### 7.3 Ancient Knowledge Service

```csharp
/// <summary>
/// Service for Ancient Knowledge bonus lore generation.
/// </summary>
public interface IAncientKnowledgeService
{
    /// <summary>
    /// Generates bonus lore for an examination result.
    /// </summary>
    Task<IReadOnlyList<LoreRevelation>> GenerateBonusLore(
        Guid characterId,
        ExaminationResult examinationResult,
        ExaminationTarget target);

    /// <summary>
    /// Gets lore revelations for a specific object.
    /// </summary>
    Task<IReadOnlyList<LoreRevelation>> GetRevealedLoreForObject(Guid characterId, Guid objectId);
}

/// <summary>
/// Implementation of Ancient Knowledge service.
/// </summary>
public sealed class AncientKnowledgeService : IAncientKnowledgeService
{
    private readonly ILoreRepository _loreRepository;
    private readonly ILogger<AncientKnowledgeService> _logger;

    public AncientKnowledgeService(
        ILoreRepository loreRepository,
        ILogger<AncientKnowledgeService> logger)
    {
        _loreRepository = loreRepository;
        _logger = logger;
    }

    public async Task<IReadOnlyList<LoreRevelation>> GenerateBonusLore(
        Guid characterId,
        ExaminationResult examinationResult,
        ExaminationTarget target)
    {
        var revelations = new List<LoreRevelation>();

        // Determine number of revelations based on success level
        int revelationCount = examinationResult.SuccessLevel switch
        {
            ExaminationSuccessLevel.Expert => 1,
            ExaminationSuccessLevel.Master => 2,
            _ => 0
        };

        if (revelationCount == 0)
            return revelations.AsReadOnly();

        // Generate appropriate lore for the target
        var generatedLore = GenerateLoreForTarget(target, revelationCount);
        revelations.AddRange(generatedLore);

        // Store revelations
        foreach (var revelation in generatedLore)
        {
            await _loreRepository.Add(revelation);
        }

        _logger.LogInformation(
            "Ancient Knowledge: {Character} revealed {Count} bonus lore entries from examination",
            characterId, generatedLore.Count);

        return revelations.AsReadOnly();
    }

    private List<LoreRevelation> GenerateLoreForTarget(ExaminationTarget target, int count)
    {
        var revelations = new List<LoreRevelation>();

        // First revelation: Historical Context
        if (count >= 1)
        {
            revelations.Add(LoreRevelation.Create(
                sourceExaminationId: Guid.Empty, // Will be filled in
                type: LoreType.HistoricalContext,
                title: $"History of {target.Name}",
                content: $"{target.Name} was created in {target.CreationEra} by {target.Creator}.",
                relatedLocations: target.RelatedLocations?.ToList() ?? new List<Guid>(),
                relatedFigures: target.RelatedFigures?.ToList() ?? new List<string>()));
        }

        // Second revelation: Hidden Purpose or Warning
        if (count >= 2)
        {
            var type = target.HasWarning ? LoreType.Warning : LoreType.HiddenPurpose;
            var content = target.HasWarning
                ? $"WARNING: {target.WarningText}"
                : $"Hidden Purpose: {target.HiddenPurpose}";

            revelations.Add(LoreRevelation.Create(
                sourceExaminationId: Guid.Empty,
                type: type,
                title: type == LoreType.Warning ? $"Warning about {target.Name}" : $"True Purpose",
                content: content,
                relatedFigures: target.HasWarning ? new[] { "Unknown Threat" } : null));
        }

        return revelations;
    }

    public async Task<IReadOnlyList<LoreRevelation>> GetRevealedLoreForObject(Guid characterId, Guid objectId)
    {
        return await _loreRepository.GetByCharacterAndObject(characterId, objectId);
    }
}
```

---

## 8. Voice of the Giants Capstone Specification

### 8.1 Ability Profile

| Property | Value |
|----------|-------|
| **Ability ID** | `voice-of-the-giants` |
| **Type** | Ultimate |
| **AP Cost** | 5 AP (half of standard action economy) |
| **Lore Insight Cost** | 8 (maximum possible) |
| **Range** | Touch (must be in contact with technology) |
| **Duration** | 1 hour |
| **Cooldown** | Once per long rest |
| **Tier** | Capstone |
| **PP Cost** | 6 PP to unlock |
| **Prerequisites** | 24 PP in Jötun-Reader tree |

### 8.2 Activated Technology Value Object

```csharp
/// <summary>
/// Record of activated Jötun technology.
/// </summary>
[ValueObject]
public sealed record ActivatedTechnology
{
    /// <summary>Unique identifier for this activation.</summary>
    public Guid ActivationId { get; init; }

    /// <summary>ID of the activated technology.</summary>
    public Guid TechnologyId { get; init; }

    /// <summary>Type of Jötun technology activated.</summary>
    public JotunTechnologyType TechnologyType { get; init; }

    /// <summary>Name of the technology.</summary>
    public string TechnologyName { get; init; } = string.Empty;

    /// <summary>Character who activated it.</summary>
    public Guid ActivatorId { get; init; }

    /// <summary>When it was activated.</summary>
    public DateTime ActivatedAt { get; init; }

    /// <summary>When the activation expires.</summary>
    public DateTime ExpiresAt { get; init; }

    /// <summary>Effects this activation produces.</summary>
    public IReadOnlyList<TechnologyEffect> Effects { get; init; } = new List<TechnologyEffect>();

    /// <summary>Whether this activation is currently active.</summary>
    public bool IsActive => DateTime.UtcNow < ExpiresAt;

    /// <summary>
    /// Creates a new activation record.
    /// </summary>
    public static ActivatedTechnology Create(
        Guid technologyId,
        JotunTechnologyType type,
        string name,
        Guid activatorId,
        IEnumerable<TechnologyEffect> effects,
        int durationMinutes = 60)
    {
        return new ActivatedTechnology
        {
            ActivationId = Guid.NewGuid(),
            TechnologyId = technologyId,
            TechnologyType = type,
            TechnologyName = name,
            ActivatorId = activatorId,
            ActivatedAt = DateTime.UtcNow,
            ExpiresAt = DateTime.UtcNow.AddMinutes(durationMinutes),
            Effects = effects.ToList().AsReadOnly()
        };
    }

    /// <summary>
    /// Gets remaining activation duration.
    /// </summary>
    public TimeSpan GetRemainingDuration() => IsActive
        ? ExpiresAt - DateTime.UtcNow
        : TimeSpan.Zero;

    /// <summary>
    /// Deactivates the technology.
    /// </summary>
    public ActivatedTechnology Deactivate() => this with
    {
        ExpiresAt = DateTime.UtcNow
    };

    /// <summary>
    /// Gets summary of effects.
    /// </summary>
    public string GetEffectSummary()
    {
        var sb = new StringBuilder();
        sb.AppendLine($"{TechnologyName} ({TechnologyType})");
        sb.AppendLine($"Duration: {GetRemainingDuration().TotalMinutes:F0} minutes remaining");
        sb.AppendLine("Effects:");
        foreach (var effect in Effects)
        {
            sb.AppendLine($"  • {effect.Description}");
        }
        return sb.ToString();
    }

    /// <summary>
    /// Determines if this activation has expired.
    /// </summary>
    public bool IsExpired() => DateTime.UtcNow >= ExpiresAt;
}

/// <summary>
/// An effect produced by activated technology.
/// </summary>
[ValueObject]
public sealed record TechnologyEffect
{
    /// <summary>Type of effect (healing, damage, etc.).</summary>
    public string EffectType { get; init; } = string.Empty;

    /// <summary>Radius if area effect (in feet).</summary>
    public int? TargetArea { get; init; }

    /// <summary>Numeric value for the effect (damage, healing, etc.).</summary>
    public int? Value { get; init; }

    /// <summary>Description of the effect.</summary>
    public string Description { get; init; } = string.Empty;

    /// <summary>Whether this effect is continuous (ongoing).</summary>
    public bool IsContinuous { get; init; }
}

/// <summary>
/// Types of Jötun technology that can be activated.
/// </summary>
public enum JotunTechnologyType
{
    /// <summary>Restores power to connected systems</summary>
    PowerNode = 0,

    /// <summary>Activates automated defense systems</summary>
    DefenseGrid = 1,

    /// <summary>Enables fast travel within complex</summary>
    TransportSystem = 2,

    /// <summary>Provides healing in area</summary>
    MedicalBay = 3,

    /// <summary>Unlocks restricted data access</summary>
    ArchiveTerminal = 4,

    /// <summary>Enables advanced crafting</summary>
    Fabricator = 5,

    /// <summary>Reveals hidden creatures/objects</summary>
    SensorArray = 6,

    /// <summary>Controls environmental conditions</summary>
    EnvironmentalControl = 7
}
```

### 8.3 Technology Activation Service

```csharp
/// <summary>
/// Service for activating dormant Jötun technology.
/// </summary>
public interface ITechnologyActivationService
{
    /// <summary>
    /// Attempts to activate dormant technology.
    /// </summary>
    Task<ActivationResult> ActivateTechnology(
        Character character,
        DormantTechnology technology,
        string activationIncantation);

    /// <summary>
    /// Gets currently active technology in area.
    /// </summary>
    Task<IReadOnlyList<ActivatedTechnology>> GetActiveTechnologyInArea(Guid areaId);

    /// <summary>
    /// Deactivates technology early.
    /// </summary>
    Task Deactivate(Guid activationId);
}

/// <summary>
/// Result of a technology activation attempt.
/// </summary>
public sealed record ActivationResult
{
    public bool Success { get; init; }
    public string Message { get; init; } = string.Empty;
    public ActivatedTechnology? ActivatedTechnology { get; init; }
    public IReadOnlyList<string> Effects { get; init; } = new List<string>();

    public static ActivationResult Success(ActivatedTechnology technology, IEnumerable<string> effects)
        => new()
        {
            Success = true,
            Message = $"{technology.TechnologyName} activated successfully.",
            ActivatedTechnology = technology,
            Effects = effects.ToList().AsReadOnly()
        };

    public static ActivationResult Failure(string reason)
        => new() { Success = false, Message = reason };
}

/// <summary>
/// Implementation of technology activation service.
/// </summary>
public sealed class TechnologyActivationService : ITechnologyActivationService
{
    private readonly IRepository<ActivatedTechnology> _activationRepository;
    private readonly ITechnologyDatabase _technologyDatabase;
    private readonly ILogger<TechnologyActivationService> _logger;

    public TechnologyActivationService(
        IRepository<ActivatedTechnology> activationRepository,
        ITechnologyDatabase technologyDatabase,
        ILogger<TechnologyActivationService> logger)
    {
        _activationRepository = activationRepository;
        _technologyDatabase = technologyDatabase;
        _logger = logger;
    }

    public async Task<ActivationResult> ActivateTechnology(
        Character character,
        DormantTechnology technology,
        string activationIncantation)
    {
        // Validate character can activate (Jötun-Reader with capstone)
        if (character?.Specialization?.SpecializationId != "jotun-reader" ||
            !character.HasAbility("voice-of-the-giants"))
        {
            return ActivationResult.Failure(
                "Only Jötun-Readers with Voice of the Giants can activate this technology");
        }

        // Validate technology is dormant and can be activated
        if (!technology.IsDormant)
        {
            return ActivationResult.Failure(
                $"{technology.Name} is not dormant or cannot be activated");
        }

        // Validate activation incantation matches
        if (!ValidateIncantation(activationIncantation, technology))
        {
            return ActivationResult.Failure(
                "The incantation did not resonate with this technology");
        }

        // Create activation
        var effects = GenerateEffects(technology.Type);
        var activation = ActivatedTechnology.Create(
            technology.Id,
            technology.Type,
            technology.Name,
            character.Id,
            effects,
            durationMinutes: 60);

        await _activationRepository.Add(activation);

        _logger.LogInformation(
            "Technology Activated: {Character} activated {Technology} ({Type})",
            character.Name, technology.Name, technology.Type);

        var effectDescriptions = effects.Select(e => e.Description).ToList();
        return ActivationResult.Success(activation, effectDescriptions);
    }

    private bool ValidateIncantation(string incantation, DormantTechnology technology)
    {
        // Check if incantation matches technology's requirements
        // In actual implementation, would be more complex
        return !string.IsNullOrWhiteSpace(incantation) &&
               incantation.Contains("Jötun", StringComparison.OrdinalIgnoreCase);
    }

    private IEnumerable<TechnologyEffect> GenerateEffects(JotunTechnologyType type)
    {
        var effects = new List<TechnologyEffect>();

        switch (type)
        {
            case JotunTechnologyType.PowerNode:
                effects.Add(new TechnologyEffect
                {
                    EffectType = "PowerRestore",
                    Description = "Restores power to all connected systems in this area",
                    IsContinuous = true
                });
                break;

            case JotunTechnologyType.MedicalBay:
                effects.Add(new TechnologyEffect
                {
                    EffectType = "AreaHealing",
                    TargetArea = 30,
                    Value = 24, // 4d6
                    Description = "All creatures in 30-foot radius restored to full health",
                    IsContinuous = false
                });
                break;

            case JotunTechnologyType.SensorArray:
                effects.Add(new TechnologyEffect
                {
                    EffectType = "Revelation",
                    TargetArea = 300,
                    Description = "All hidden creatures and objects revealed in 300-foot radius",
                    IsContinuous = true
                });
                break;

            case JotunTechnologyType.DefenseGrid:
                effects.Add(new TechnologyEffect
                {
                    EffectType = "AutonomousDefense",
                    TargetArea = 150,
                    Description = "Automated defenses engage against non-Jötun targets",
                    IsContinuous = true
                });
                break;

            case JotunTechnologyType.TransportSystem:
                effects.Add(new TechnologyEffect
                {
                    EffectType = "FastTravel",
                    Description = "Enables rapid transit between connected terminals",
                    IsContinuous = true
                });
                break;

            case JotunTechnologyType.ArchiveTerminal:
                effects.Add(new TechnologyEffect
                {
                    EffectType = "DataAccess",
                    Description = "Unlocks all restricted archive data (no hacking required)",
                    IsContinuous = false
                });
                break;

            case JotunTechnologyType.Fabricator:
                effects.Add(new TechnologyEffect
                {
                    EffectType = "Crafting",
                    Description = "Enables creation of advanced items (beyond normal crafting)",
                    IsContinuous = false
                });
                break;

            case JotunTechnologyType.EnvironmentalControl:
                effects.Add(new TechnologyEffect
                {
                    EffectType = "EnvironmentModification",
                    Description = "Adjusts temperature, atmosphere, lighting in area",
                    IsContinuous = true
                });
                break;
        }

        return effects;
    }

    public async Task<IReadOnlyList<ActivatedTechnology>> GetActiveTechnologyInArea(Guid areaId)
    {
        var active = await _activationRepository.QueryAsync(
            a => a.IsActive && a.TechnologyId == areaId);

        return active.AsReadOnly();
    }

    public async Task Deactivate(Guid activationId)
    {
        var activation = await _activationRepository.GetById(activationId);
        if (activation != null)
        {
            var deactivated = activation.Deactivate();
            await _activationRepository.Update(deactivated);

            _logger.LogInformation(
                "Technology Deactivated: {Technology}",
                activation.TechnologyName);
        }
    }
}
```

### 8.4 Voice of the Giants Usage

```
Command: > ability voice-of-the-giants <target-technology>
Example: > ability voice-of-the-giants medical-chamber

Output:
╔════════════════════════════════════════════════════════════════╗
║          VOICE OF THE GIANTS - CAPSTONE ACTIVATION             ║
╠════════════════════════════════════════════════════════════════╣
║  Spent: 5 AP + 8 Lore Insight (ALL AVAILABLE INSIGHT)          ║
║  Cooldown: Once per long rest                                   ║
║                                                                 ║
║  Target: Ancient Medical Chamber (Dormant)                     ║
║  Technology Type: Medical Bay                                   ║
║  Status: ACTIVATION INITIATED...                               ║
║                                                                 ║
║  You speak in the ancient tongue of the giants:                ║
║  "JÖTUN HERRA, SKAPT MEÐ ORÐUM FYRRI TÍÐAR..."                ║
║                                                                 ║
║  The chamber trembles. Ancient systems stir to life.           ║
║  Lights flicker on—ancient but still powerful.                 ║
║  Healing fields activate throughout the chamber.               ║
║                                                                 ║
║  ✓ ACTIVATED: Medical Bay                                      ║
║    • Duration: 60 minutes                                       ║
║    • Effect: Area healing (+4d6 HP to all allies)              ║
║    • Range: 30-foot radius from activation point               ║
║                                                                 ║
║  Note: The giants' legacy awakens through your voice.          ║
║        Use this power wisely—these systems can be unstable.    ║
╚════════════════════════════════════════════════════════════════╝
```

---

## 9. Technology Activation System

[Detailed in section 8.3]

---

## 10. Layer System Mastery

The progression of layer auto-success abilities:

| Tier | Ability | Layer | Auto-Succeeds For | Cost |
|------|---------|-------|-------------------|------|
| **Tier 1** | Pattern Recognition | 2 | Jötun technology | Free |
| **Tier 3** | Lore Keeper | 3 | Historical objects | 5 PP |
| **Combination** | Both active | 2 + 3 | Jötun artifacts with history | 5 PP |

---

## 11. Bonus Lore System

[Detailed in section 7.2-7.3]

---

## 12. Dormant Technology Database

```csharp
/// <summary>
/// Database of dormant technologies that can be activated.
/// </summary>
public interface ITechnologyDatabase
{
    /// <summary>
    /// Gets all dormant technology in an area.
    /// </summary>
    Task<IReadOnlyList<DormantTechnology>> GetDormantTechnologyInArea(Guid areaId);

    /// <summary>
    /// Gets a specific dormant technology.
    /// </summary>
    Task<DormantTechnology?> GetTechnology(Guid technologyId);

    /// <summary>
    /// Records a technology as activated (for tracking).
    /// </summary>
    Task MarkAsActivated(Guid technologyId);
}

/// <summary>
/// A dormant Jötun technology waiting to be activated.
/// </summary>
public sealed record DormantTechnology
{
    public Guid Id { get; init; }
    public string Name { get; init; } = string.Empty;
    public JotunTechnologyType Type { get; init; }
    public bool IsDormant { get; init; }
    public bool CanBeActivated { get; init; }
    public string ActivationIncantation { get; init; } = string.Empty;
    public string Description { get; init; } = string.Empty;
    public DateTime? LastActivated { get; init; }
}
```

---

## 13. Capstone Prerequisites Validation

[Covered in section 5.1]

---

## 14. Configuration Files

### 14.1 specializations.json - Tier 3 & Capstone

```json
{
  "tier": 3,
  "ppRequirement": 16,
  "abilityCost": 5,
  "abilities": ["lore-keeper", "ancient-knowledge"]
},
{
  "tier": "capstone",
  "ppRequirement": 24,
  "abilityCost": 6,
  "abilities": ["voice-of-the-giants"]
}
```

### 14.2 abilities.json - Tier 3 & Capstone

```json
{
  "abilityId": "lore-keeper",
  "displayName": "Lore Keeper",
  "tier": 3,
  "type": "Passive",
  "description": "Your mastery of historical knowledge allows you to automatically succeed on Layer 3 examinations for all historical objects.",
  "effects": [
    {
      "type": "AutoSucceedLayer",
      "layer": 3,
      "targetCategory": "HistoricalObjects"
    },
    {
      "type": "InsightOnFirstExamination",
      "amount": 2
    }
  ]
},
{
  "abilityId": "ancient-knowledge",
  "displayName": "Ancient Knowledge",
  "tier": 3,
  "type": "Passive",
  "description": "When achieving Expert or Master success on examinations, reveal bonus lore including historical context, related locations, and connections.",
  "effects": [
    {
      "type": "BonusLoreOnExpertSuccess",
      "loreEntries": 1
    },
    {
      "type": "BonusLoreOnMasterSuccess",
      "loreEntries": 2
    },
    {
      "type": "InsightPerBonusLore",
      "amount": 1
    }
  ]
},
{
  "abilityId": "voice-of-the-giants",
  "displayName": "Voice of the Giants",
  "tier": "capstone",
  "type": "Ultimate",
  "apCost": 5,
  "resourceCost": {
    "resourceId": "lore-insight",
    "amount": 8
  },
  "range": "Touch",
  "cooldown": "LongRest",
  "description": "Speak the activation phrases of the giants to awaken dormant Jötun technology. Effects vary by technology type. Usable once per long rest.",
  "effects": [
    {
      "type": "ActivateTechnology",
      "duration": 60,
      "durationUnit": "Minutes",
      "effectsVaryByType": true
    },
    {
      "type": "StoryBeat",
      "narrative": "Campaign-defining moment of power"
    }
  ]
}
```

---

## 15. Code Examples and Implementation

[Detailed in sections 6.2, 7.3, 8.3]

---

## 16. Domain Models

[Detailed in sections 7.2 and 8.2]

---

## 17. Service Architecture

[Detailed in sections 6.2, 7.3, 8.3]

---

## 18. Lore Revelation System

[Detailed in section 7.2-7.3]

---

## 19. Technology Effect Resolution

Technology effects are resolved at activation time and applied for the duration:

1. **Calculate Effect** based on technology type
2. **Apply Effect** to all valid targets in range
3. **Maintain State** throughout duration
4. **Expire Effect** when duration ends or manually deactivated

---

## 20. Logging Specifications

```csharp
// Lore Keeper
_logger.LogInformation(
    "Lore Keeper: {Character} auto-revealed Layer 3 of {Target}",
    character.Name, target.Name);

// Ancient Knowledge
_logger.LogInformation(
    "Ancient Knowledge: {Character} revealed {Count} bonus lore entries",
    character.Name, revelationCount);

// Voice of the Giants
_logger.LogInformation(
    "Voice of the Giants: {Character} activated {Technology} ({Type}) - Duration: {Duration} minutes",
    character.Name, technology.Name, technology.Type, 60);

_logger.LogInformation(
    "Capstone Effect: {Effect}",
    effectDescription);
```

---

## 21. Unit Testing Requirements

### 21.1 LoreKeeperTests (~2 tests)

```csharp
[TestFixture]
public class LoreKeeperTests
{
    [Test]
    public void LoreKeeper_AutoSucceedsLayer3_ForHistoricalObjects();

    [Test]
    public void LoreKeeper_GeneratesTwoInsight_OnFirstExamination();
}
```

### 21.2 AncientKnowledgeTests (~2 tests)

```csharp
[TestFixture]
public class AncientKnowledgeTests
{
    [Test]
    public void AncientKnowledge_RevealsBonusLore_OnExpertSuccess();

    [Test]
    public void AncientKnowledge_GeneratesInsight_PerBonusLore();
}
```

### 21.3 VoiceOfTheGiantsTests (~3 tests)

```csharp
[TestFixture]
public class VoiceOfTheGiantsTests
{
    [Test]
    public void VoiceOfTheGiants_ActivatesDormantTechnology();

    [Test]
    public void VoiceOfTheGiants_OncePerLongRest();

    [Test]
    public void VoiceOfTheGiants_LockedUntil24PPInvested();
}
```

---

## 22. Deliverable Checklist

### Domain Layer
- [ ] LoreRevelation value object
- [ ] ActivatedTechnology value object
- [ ] TechnologyEffect value object
- [ ] LoreType enum
- [ ] JotunTechnologyType enum
- [ ] ActivationResult record
- [ ] DormantTechnology record

### Application Layer
- [ ] AdvancedTierPrerequisiteValidator
- [ ] LoreKeeperAbility passive integration
- [ ] AncientKnowledgeService
- [ ] ITechnologyActivationService
- [ ] TechnologyActivationService
- [ ] ITechnologyDatabase
- [ ] Capstone validation middleware

### Infrastructure Layer
- [ ] specializations.json Tier 3 & Capstone updates
- [ ] abilities.json Tier 3 & Capstone abilities
- [ ] Dormant technology definitions

### Tests
- [ ] LoreKeeperTests.cs (~2 tests)
- [ ] AncientKnowledgeTests.cs (~2 tests)
- [ ] VoiceOfTheGiantsTests.cs (~3 tests)

---

## 23. Acceptance Criteria

- [x] Tier 3 abilities locked until 16 PP invested
- [x] Capstone locked until 24 PP invested
- [x] Tier 3 abilities cost 5 PP each
- [x] Capstone costs 6 PP
- [x] Lore Keeper auto-succeeds Layer 3 for historical objects
- [x] Ancient Knowledge reveals bonus lore on Expert+ success
- [x] Voice of the Giants activates dormant Jötun technology
- [x] Voice of the Giants usable once per long rest
- [x] Capstone is appropriately powerful for end-game
- [x] ~7 unit tests pass

---

## Integration Summary

The three v0.20.3 phases create a complete specialization:

```
v0.20.3a (Tier 1): Foundation
├── Lore Insight resource
├── Deep Scan (+2d10 examination)
├── Pattern Recognition (auto Layer 2)
└── Ancient Tongues (script reading)

v0.20.3b (Tier 2): Expansion
├── Technical Memory (puzzle recall)
├── Exploit Weakness (vulnerability analysis)
└── Data Recovery (terminal access)

v0.20.3c (Tier 3 + Capstone): Mastery
├── Lore Keeper (auto Layer 3)
├── Ancient Knowledge (bonus lore)
└── Voice of the Giants (technology activation)

Total: 9 abilities, 25 tests, ~15 files
```

---

_This design specification v0.20.3c concludes the Jötun-Reader specialization with advanced mastery and a powerful capstone ability, providing a complete knowledge-focused character archetype for the Adept class._
