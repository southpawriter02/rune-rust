# v0.20.7c Changelog — Veiðimaðr (Hunter) Tier 3 Abilities & Capstone

## Version: 0.20.7c

## Date: 2026-02-17

## Focus: Veiðimaðr (Hunter) Specialization — Tier 3 Abilities (Apex Predator, Crippling Shot) & Capstone (The Perfect Hunt)

---

## Added

### Domain Layer — Enums

- **`ConcealmentType`** — 5 concealment types for Apex Predator evaluation: None (0), LightObscurement (1), Invisibility (2), MagicalCamo (3), Hidden (4). Distinct from `CoverType` (physical defense) — concealment affects perception-based miss chance.

### Domain Layer — Value Objects

- **`ApexPredatorResult`** — Immutable sealed record capturing the outcome of Apex Predator passive evaluation. Properties: HunterId, TargetId, TargetName, WasConcealed, ConcealmentType, ConcealmentDenied, TargetWasMarked. Static method: `ShouldDenyConcealment(ConcealmentType, bool isMarked)` returns true when marked AND concealment != None. Instance methods: `IsConcealmentLost()`, `GetDescription()`, private `FormatConcealmentType()`. Always returns a non-null result when prerequisites are met (even for unmarked targets with `ConcealmentDenied=false`).
- **`CripplingShotResult`** — Immutable sealed record capturing movement reduction from Crippling Shot. Constants: `DefaultDurationTurns = 2`, `MovementDivisor = 2`. Properties: HunterId, TargetId, TargetName, OriginalMovementSpeed, MarkConsumed. Computed: `ReducedMovementSpeed => OriginalMovementSpeed / 2` (integer division), `DurationTurns => 2`. Methods: `GetDescription()`, `GetDurationText()`, `GetStatusMessage()`.
- **`PerfectHuntResult`** — Immutable sealed record capturing the devastating capstone strike. Constant: `DefaultCriticalMultiplier = 2`. Properties: HunterId, TargetId, TargetName, BaseDamageRoll, MarkConsumed, CapstoneUsed, NarrativeDescription. Computed: `CriticalMultiplier => 2`, `TotalDamage => BaseDamageRoll * 2`, `IsCriticalHit => true`. Methods: `GetDescription()`, `GetDamageBreakdown()` (multi-line), `GetStatusMessage()`.

### Application Layer — Interface Changes

- **`IVeidimadurAbilityService`** — Extended with Tier 3 and Capstone method signatures:
  - `ApexPredatorResult? EvaluateApexPredator(Player, Guid, string, ConcealmentType)` — Passive concealment denial evaluation
  - `CripplingShotResult? ExecuteCripplingShot(Player, Guid, string, int)` — Halves target movement (1 AP + 1 mark)
  - `PerfectHuntResult? ExecuteThePerfectHunt(Player, Guid, string, int)` — Auto-crit capstone (3 AP + 1 mark + once/rest)
  - Updated class doc comment to reference Tier 3, Capstone, and v0.20.7c

### Application Layer — Service Changes

- **`VeidimadurAbilityService`** — Extended with Tier 3 and Capstone implementation:
  - 5 new constants: `CripplingShotApCost = 1`, `CripplingShotDurationTurns = 2`, `CripplingShotMovementDivisor = 2`, `ThePerfectHuntApCost = 3`, `ThePerfectHuntCriticalMultiplier = 2`
  - `EvaluateApexPredator`: Passive — no AP cost. Guard chain → queries `HasActiveMark` on quarry marks service → evaluates via `ApexPredatorResult.ShouldDenyConcealment()` → logs. Returns non-null result for all evaluated targets (not just successful denials).
  - `ExecuteCripplingShot`: 1 AP + 1 mark. Guard chain → validates mark exists → deducts AP → calls `RemoveMark` → builds result with halved movement → logs movement reduction details.
  - `ExecuteThePerfectHunt`: 3 AP + 1 mark + rest cooldown. Guard chain → validates cooldown BEFORE AP (avoids AP deduction for locked ability) → deducts AP → sets `HasUsedThePerfectHuntThisRestCycle = true` → calls `RemoveMark` → builds result with auto-crit damage → logs full damage breakdown.
  - `GetAbilityReadiness`: Updated switch with 3 new cases — ApexPredator (passive, always ready), CripplingShot (1 AP check), ThePerfectHunt (cooldown + 3 AP check).
  - Updated class doc to reference all four tiers and v0.20.7c.

### Entity Extensions

- **`Player.cs`** — Veiðimaðr Tier 3 / Capstone properties:
  - `HasUsedThePerfectHuntThisRestCycle { get; set; }` — Once-per-long-rest cooldown tracking (mirrors `HasUsedMiracleWorkerThisRestCycle`)
  - `ResetPerfectHuntCooldown()` — Resets the cooldown flag to false (mirrors `ResetMiracleWorkerCooldown()`)

### Configuration

- Updated `config/abilities.json` with 3 new abilities:
  - `apex-predator`: Passive, 0 AP, 5 PP, ppPrerequisite 16, unlockLevel 3, denies all concealment types for marked quarry
  - `crippling-shot`: Active, 1 AP, costResource quarry-mark (1), 5 PP, ppPrerequisite 16, unlockLevel 3, range 12, duration 2 turns, halves movement
  - `the-perfect-hunt`: Active, 3 AP, costResource quarry-mark (1), 6 PP, ppPrerequisite 24, unlockLevel 4, cooldown 1/LongRest, range 12, auto-crit with 2x damage

### Unit Tests

- **`ConcealmentTypeTests`** — 3 domain tests: HasExpectedValues (5 values), ParsesFromString (all 5), HasCorrectIntegerValues (None=0 through Hidden=4)
- **`ApexPredatorResultTests`** — 11 domain tests: ShouldDenyConcealment (Marked+LightObscurement=true, Marked+Invisibility=true, Marked+MagicalCamo=true, Marked+Hidden=true, Marked+None=false, NotMarked=false), IsConcealmentLost (denied/not denied), GetDescription (concealment denied, not marked, no concealment)
- **`CripplingShotResultTests`** — 8 domain tests: ReducedMovementSpeed (even=3, odd=3, speed1=0), DurationTurns (always 2), GetDescription (movement reduction), GetDurationText (turns), GetStatusMessage (CRIPPLING SHOT), MarkConsumed (preserves)
- **`PerfectHuntResultTests`** — 10 domain tests: TotalDamage (doubles, small), CriticalMultiplier (always 2), IsCriticalHit (always true), GetDescription (contains PERFECT HUNT, damage values), GetDamageBreakdown (all sections), GetStatusMessage (DEVASTATED, damage calc), NarrativeDescription (preserves)
- **`VeidimadurAbilityServiceTests`** — Extended with 29 new Tier 3 / Capstone tests:
  - Apex Predator (6): marked+concealment denies, marked+none doesn't, unmarked doesn't, not unlocked null, wrong spec null, no AP cost
  - Crippling Shot (7): valid prereqs halved movement, insufficient AP null, not unlocked null, target not marked null, wrong spec null, consumes mark (verify RemoveMark), deducts AP (10→9)
  - The Perfect Hunt (9): valid prereqs auto-crit (base*2=30), insufficient AP null, not unlocked null, already used this rest null, target not marked null, wrong spec null, sets rest cooldown, consumes mark (verify RemoveMark), deducts AP (10→7)
  - Readiness & PP (7): readiness includes T3 (ApexPredator=true, CripplingShot=true), T3 insufficient AP (CripplingShot=false, ApexPredator still true), Perfect Hunt on cooldown=false, Perfect Hunt available=true, PP invested all abilities=28, CanUnlockTier3=true, CanUnlockCapstone=true

## Modified

### Enum Documentation

- **`VeidimadurAbilityId`** — Updated XML doc comments:
  - All T2 ability docs: "Planned for v0.20.7b" → "Introduced in v0.20.7b"
  - All T3/Capstone ability docs: "Planned for v0.20.7c" → "Introduced in v0.20.7c"
  - CripplingShot: "Costs 3 AP" → "Costs 1 AP, consumes 1 Quarry Mark"
  - ThePerfectHunt: "Costs 2 AP" → "Costs 3 AP, consumes 1 Quarry Mark"

### Scope Breakdown

- **`v0.20.7-scope-breakdown.md`** — Marked v0.20.7c acceptance criteria checkboxes as complete, updated implementation checklist items for Apex Predator, Crippling Shot, The Perfect Hunt, abilities.json, and test items.

## Design Decisions

- **Apex Predator returns result for all evaluated targets**: Unlike guard-clause null returns (wrong spec, not unlocked), `EvaluateApexPredator` returns a non-null `ApexPredatorResult` even for unmarked targets (with `ConcealmentDenied=false`). This allows the combat system to differentiate "ability unavailable" from "evaluated but no effect."
- **Crippling Shot costs 1 AP** (not 3 AP as in the original VeidimadurAbilityId planning doc). The design spec and combat balance analysis settled on 1 AP + consuming 1 Quarry Mark as the cost. The mark consumption provides meaningful resource cost.
- **The Perfect Hunt costs 3 AP** (not 2 AP as in the original VeidimadurAbilityId planning doc). The higher AP cost balances the devastating auto-crit + 2x damage output.
- **Cooldown checked BEFORE AP**: The Perfect Hunt's guard chain checks `HasUsedThePerfectHuntThisRestCycle` before the AP check. This avoids deducting AP for an ability that cannot fire due to rest-cycle limitation. Matches the Bone-Setter Miracle Worker pattern.
- **Base damage as parameter**: `ExecuteThePerfectHunt` receives pre-rolled weapon base damage from the caller. The service applies the 2x critical multiplier. No new dice method is needed — the damage roll is the caller's responsibility.
- **No Corruption risk**: All three abilities follow the Coherent path, consistent with every Veiðimaðr ability. No corruption service dependency.
- **ConcealmentType separate from CoverType**: Cover provides physical defense (AC bonuses, handled by Hunter's Eye T2). Concealment provides perception-based miss chance (handled by Apex Predator T3). Having separate enums keeps the domain model clean and avoids conflating two distinct combat mechanics.
- **Integer division for Crippling Shot**: Movement halving uses C# integer division (7 → 3, not 3.5). This is consistent with TTRPG conventions and avoids floating-point complications.
- **Single service pattern**: All T3/Capstone methods are in `VeidimadurAbilityService`, matching every prior specialization's approach. No separate `IApexPredatorService` or `ICapstoneAbilityService`.

## Test Results

```
Veiðimaðr tests: 176
     Passed: 176
     Failed: 0

Breakdown:
  ConcealmentTypeTests:                    3 domain tests
  ApexPredatorResultTests:                11 domain tests
  CripplingShotResultTests:                8 domain tests
  PerfectHuntResultTests:                 10 domain tests
  HuntersEyeResultTests:                  11 domain tests (v0.20.7b)
  TrapInstanceTests:                      14 domain tests (v0.20.7b)
  TrapMasteryResultTests:                  8 domain tests (v0.20.7b)
  PredatorsPatienceStateTests:            15 domain tests (v0.20.7b)
  QuarryMarksResourceTests:              15 domain tests (v0.20.7a)
  VeidimadurAbilityServiceTests:          81 application tests (23 T1 + 29 T2 + 29 T3/Cap)
                                     ──────
                                     Total: 176 (was 115 in v0.20.7b)
```
