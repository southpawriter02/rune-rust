# v0.15.5b Design Specification: Counter-Tracking System

**Version:** 0.15.5b
**Theme:** Counter-Tracking System
**Author:** Claude
**Created:** 2026-01-18
**Status:** Draft
**Prerequisites:** v0.15.5a Complete (Extended Tracking System)

---

## Table of Contents

1. [Executive Summary](#1-executive-summary)
2. [Feature Overview](#2-feature-overview)
3. [Architecture Diagrams](#3-architecture-diagrams)
   - 3.1 [Counter-Tracking Flow Diagram](#31-counter-tracking-flow-diagram)
   - 3.2 [Contested Resolution Flow](#32-contested-resolution-flow)
   - 3.3 [Service Interaction Diagram](#33-service-interaction-diagram)
   - 3.4 [Layer Architecture](#34-layer-architecture)
4. [ConcealmentTechnique Enum](#4-concealmenttechnique-enum)
5. [CounterTrackingContext Value Object](#5-countertrackingcontext-value-object)
6. [CounterTrackingResult Value Object](#6-countertrackingresult-value-object)
7. [CounterTrackingService Implementation](#7-countertrackingservice-implementation)
8. [Integration with TrackingService](#8-integration-with-trackingservice)
9. [Data Model Changes](#9-data-model-changes)
10. [Configuration Files](#10-configuration-files)
    - 10.1 [concealment-techniques.json](#101-concealment-techniquesjson)
    - 10.2 [concealment-techniques.schema.json](#102-concealment-techniquesschemajson)
    - 10.3 [Configuration Schema Summary](#103-configuration-schema-summary)
11. [Logging Specifications](#11-logging-specifications)
12. [Unit Testing Requirements](#12-unit-testing-requirements)
13. [Use Cases](#13-use-cases)
14. [Deliverable Checklist](#14-deliverable-checklist)
15. [Acceptance Criteria](#15-acceptance-criteria)
16. [Dependencies](#16-dependencies)
17. [Future Considerations](#17-future-considerations)
18. [Document Metadata](#18-document-metadata)

---

## 1. Executive Summary

### 1.1 Purpose

This document provides a comprehensive design specification for v0.15.5b, the Counter-Tracking System. This phase implements the mechanics that allow characters to conceal their trail from pursuers, creating a contested tracking scenario where the concealer's skill directly opposes the tracker's ability to follow.

Counter-tracking in Aethelgard represents the cat-and-mouse dynamic between prey and predator. Characters being pursued can employ various concealment techniques—from simple measures like walking on hard surfaces to elaborate tactics like creating false trails—each providing bonuses to their concealment roll but often at the cost of travel time.

The system integrates seamlessly with the Extended Tracking System (v0.15.5a), replacing or augmenting the base trail DC with the concealer's Wasteland Survival check result when counter-tracking techniques are employed.

### 1.2 Key Deliverables

| Category | Items |
|----------|-------|
| **Enums** | `ConcealmentTechnique` |
| **Value Objects** | `CounterTrackingContext`, `CounterTrackingResult` |
| **Services** | `ICounterTrackingService`, `CounterTrackingService` |
| **Configuration** | `concealment-techniques.json` |
| **Tests** | ~2 new unit tests |

### 1.3 Architectural Significance

This version establishes the **contested skill pattern** that will be reused for other opposed skill checks:

- **Skill vs Skill resolution**: Concealer's roll becomes the DC for the tracker
- **Technique stacking**: Multiple concealment methods stack bonuses
- **Time-cost trade-offs**: Better concealment requires more travel time
- **Environmental requirements**: Some techniques require specific conditions

---

## 2. Feature Overview

```
v0.15.5b Counter-Tracking System
├── Concealment Techniques
│   ├── HardSurfaces (+2 bonus, no time cost)
│   ├── BrushTracks (+4 bonus, +50% travel time)
│   ├── FalseTrail (+6 bonus, +100% travel time)
│   ├── WaterCrossing (+8 bonus, requires water)
│   └── Backtracking (+4 bonus, +25% travel time)
├── Counter-Tracking Context
│   ├── ConcealerId (who is hiding)
│   ├── TechniquesUsed (list of techniques)
│   ├── TotalBonus (combined concealment bonus)
│   └── TimeMultiplier (travel time penalty)
├── Contested Resolution
│   ├── Concealer rolls Wasteland Survival + technique bonuses
│   ├── Roll result becomes DC for tracker
│   ├── Multiple techniques stack additively
│   └── Environmental requirements checked
└── Integration Points
    ├── TrackingState receives ConcealmnetDc override
    ├── TrackingService uses contested DC when applicable
    └── Trail age modifiers still apply on top
```

---

## 3. Architecture Diagrams

### 3.1 Counter-Tracking Flow Diagram

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                      COUNTER-TRACKING ATTEMPT FLOW                           │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  Concealer: "cover tracks using brush and backtracking"                     │
│           │                                                                  │
│           ▼                                                                  │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │                1. VALIDATE TECHNIQUES                               │    │
│  ├─────────────────────────────────────────────────────────────────────┤    │
│  │                                                                      │    │
│  │  Check Requirements:                                                │    │
│  │  ├── HardSurfaces: Any terrain (always available)                  │    │
│  │  ├── BrushTracks: Requires foliage or debris                       │    │
│  │  ├── FalseTrail: Requires time and materials                       │    │
│  │  ├── WaterCrossing: Requires water body                            │    │
│  │  └── Backtracking: Always available                                │    │
│  │                                                                      │    │
│  │  Example: BrushTracks (✓) + Backtracking (✓) = Valid               │    │
│  │                                                                      │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
│           │                                                                  │
│           ▼                                                                  │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │                2. CALCULATE TOTAL BONUS                             │    │
│  ├─────────────────────────────────────────────────────────────────────┤    │
│  │                                                                      │    │
│  │  Technique Bonuses (stack additively):                              │    │
│  │  ├── HardSurfaces: +2 to concealment roll                          │    │
│  │  ├── BrushTracks: +4 to concealment roll                           │    │
│  │  ├── FalseTrail: +6 to concealment roll                            │    │
│  │  ├── WaterCrossing: +8 to concealment roll                         │    │
│  │  └── Backtracking: +4 to concealment roll                          │    │
│  │                                                                      │    │
│  │  Example: BrushTracks (+4) + Backtracking (+4) = +8 total          │    │
│  │                                                                      │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
│           │                                                                  │
│           ▼                                                                  │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │                3. CALCULATE TIME COST                               │    │
│  ├─────────────────────────────────────────────────────────────────────┤    │
│  │                                                                      │    │
│  │  Time Multipliers (compound):                                       │    │
│  │  ├── HardSurfaces: x1.0 (no cost)                                  │    │
│  │  ├── BrushTracks: x1.5 (+50% travel time)                          │    │
│  │  ├── FalseTrail: x2.0 (+100% travel time)                          │    │
│  │  ├── WaterCrossing: x1.0 (no cost, but requires water)             │    │
│  │  └── Backtracking: x1.25 (+25% travel time)                        │    │
│  │                                                                      │    │
│  │  Example: BrushTracks (1.5) × Backtracking (1.25) = x1.875         │    │
│  │  A 2-hour journey becomes 3.75 hours                                │    │
│  │                                                                      │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
│           │                                                                  │
│           ▼                                                                  │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │                4. ROLL CONCEALMENT CHECK                            │    │
│  ├─────────────────────────────────────────────────────────────────────┤    │
│  │                                                                      │    │
│  │  Wasteland Survival Skill Check:                                    │    │
│  │  ├── Base dice pool from WITS + skill ranks                        │    │
│  │  ├── Add technique bonus to successes                              │    │
│  │  └── Count successes (8-10) minus botches (1s)                     │    │
│  │                                                                      │    │
│  │  Example: 5 dice pool, roll [8, 3, 10, 1, 6]                       │    │
│  │  Successes: 2, Botches: 1, Net: 1                                  │    │
│  │  With +8 bonus: Effective concealment = 9                          │    │
│  │                                                                      │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
│           │                                                                  │
│           ▼                                                                  │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │                5. SET TRACKER'S DC                                  │    │
│  ├─────────────────────────────────────────────────────────────────────┤    │
│  │                                                                      │    │
│  │  Concealment Result → Tracker's DC:                                 │    │
│  │  ├── Net successes + bonus = Base concealment DC                   │    │
│  │  ├── Minimum DC = 10 (cannot make trail easier than default)       │    │
│  │  ├── Maximum DC = 30 (cannot exceed impossible)                    │    │
│  │  └── Trail age modifiers still apply additively                    │    │
│  │                                                                      │    │
│  │  Example: Concealment 9 → Tracker DC = max(9, 10) = 10             │    │
│  │  If trail is Old (+4): Final DC = 14                               │    │
│  │                                                                      │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
│           │                                                                  │
│           ▼                                                                  │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │                6. RETURN RESULT                                     │    │
│  ├─────────────────────────────────────────────────────────────────────┤    │
│  │                                                                      │    │
│  │  CounterTrackingResult:                                             │    │
│  │  ├── ConcealmentDc: 10 (the DC tracker must beat)                  │    │
│  │  ├── TotalBonus: 8 (technique bonuses applied)                     │    │
│  │  ├── NetSuccesses: 1 (from dice roll)                              │    │
│  │  ├── TimeMultiplier: 1.875 (travel time cost)                      │    │
│  │  └── TechniquesUsed: [BrushTracks, Backtracking]                   │    │
│  │                                                                      │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 3.2 Contested Resolution Flow

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                      CONTESTED TRACKING RESOLUTION                           │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│                    CONCEALER                    TRACKER                      │
│                        │                            │                        │
│                        ▼                            │                        │
│  ┌────────────────────────────────────┐            │                        │
│  │  1. Select Techniques              │            │                        │
│  │  ────────────────────              │            │                        │
│  │  • BrushTracks (+4, x1.5)          │            │                        │
│  │  • Backtracking (+4, x1.25)        │            │                        │
│  │                                    │            │                        │
│  │  Total: +8 bonus, x1.875 time      │            │                        │
│  └─────────────────┬──────────────────┘            │                        │
│                    │                                │                        │
│                    ▼                                │                        │
│  ┌────────────────────────────────────┐            │                        │
│  │  2. Roll Wasteland Survival        │            │                        │
│  │  ──────────────────────────        │            │                        │
│  │  Dice Pool: 5 (WITS 3 + Rank 2)    │            │                        │
│  │  Roll: [8, 3, 10, 1, 6]            │            │                        │
│  │  Net Successes: 1                  │            │                        │
│  │  + Technique Bonus: +8             │            │                        │
│  │  ─────────────────────             │            │                        │
│  │  Concealment DC: 9 → clamped to 10 │            │                        │
│  └─────────────────┬──────────────────┘            │                        │
│                    │                                │                        │
│                    │  Concealment DC = 10           │                        │
│                    └────────────────────────────────┼───────┐                │
│                                                     │       │                │
│                                                     ▼       ▼                │
│                              ┌────────────────────────────────────┐          │
│                              │  3. Tracker Attempts to Follow     │          │
│                              │  ──────────────────────────────    │          │
│                              │                                    │          │
│                              │  Base DC: 10 (from concealment)    │          │
│                              │  Trail Age: +4 (Old trail)         │          │
│                              │  ────────────────────────          │          │
│                              │  Final DC: 14                      │          │
│                              │                                    │          │
│                              │  Tracker rolls Wasteland Survival  │          │
│                              │  vs DC 14                          │          │
│                              │                                    │          │
│                              └─────────────────┬──────────────────┘          │
│                                                │                             │
│                           ┌────────────────────┴────────────────────┐        │
│                           │                                         │        │
│                           ▼                                         ▼        │
│              ┌─────────────────────────┐           ┌─────────────────────────┐
│              │  SUCCESS                │           │  FAILURE                │
│              │  ───────────            │           │  ───────────            │
│              │  Tracker beats DC 14    │           │  Tracker fails DC 14    │
│              │  Trail maintained       │           │  Trail lost             │
│              │  Pursuit continues      │           │  Recovery needed        │
│              └─────────────────────────┘           └─────────────────────────┘
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 3.3 Service Interaction Diagram

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                      SERVICE INTERACTION DIAGRAM                             │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │                      COMMAND HANDLER                                 │   │
│   │                (CoverTracksCommandHandler)                          │   │
│   └─────────────────────────────────┬───────────────────────────────────┘   │
│                                     │                                        │
│                        validates & selects techniques                       │
│                                     │                                        │
│                                     ▼                                        │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │                  COUNTER-TRACKING SERVICE                            │   │
│   │                  (ICounterTrackingService)                          │   │
│   ├─────────────────────────────────────────────────────────────────────┤   │
│   │  + AttemptConcealment(concealer, context)                           │   │
│   │  + CalculateTotalBonus(techniques)                                  │   │
│   │  + CalculateTimeMultiplier(techniques)                              │   │
│   │  + ValidateTechniques(techniques, environment)                      │   │
│   │  + GetAvailableTechniques(environment)                              │   │
│   └──────────┬──────────────────────────┬───────────────────────────────┘   │
│              │                          │                                    │
│    performs check               reads technique data                        │
│              │                          │                                    │
│              ▼                          ▼                                    │
│   ┌─────────────────────────┐  ┌─────────────────────────┐                  │
│   │   SKILL CHECK SERVICE   │  │   CONFIGURATION SVC     │                  │
│   │   (ISkillCheckService)  │  │ (IConfigurationService) │                  │
│   ├─────────────────────────┤  ├─────────────────────────┤                  │
│   │ + PerformCheck()        │  │ + GetTechniques()       │                  │
│   │ + CalculateDicePool()   │  │ + GetBonusForTechnique()│                  │
│   └──────────┬──────────────┘  └─────────────────────────┘                  │
│              │                                                               │
│       rolls dice                                                            │
│              │                                                               │
│              ▼                                                               │
│   ┌─────────────────────────┐                                               │
│   │     DICE SERVICE        │                                               │
│   │     (IDiceService)      │                                               │
│   ├─────────────────────────┤                                               │
│   │ + RollPool(count)       │                                               │
│   │ + CountSuccesses()      │                                               │
│   └─────────────────────────┘                                               │
│                                                                              │
│   Integration with TrackingService:                                         │
│   ─────────────────────────────────────────────────────────────────────    │
│                                                                              │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │                     TRACKING SERVICE                                 │   │
│   │                     (ITrackingService)                              │   │
│   ├─────────────────────────────────────────────────────────────────────┤   │
│   │  + AttemptTracking(tracker, state)                                  │   │
│   │  + SetContestedDc(state, counterTrackingResult)  ◄── NEW            │   │
│   │  + GetEffectiveDc(state)  (uses contested DC if set)                │   │
│   └─────────────────────────────────────────────────────────────────────┘   │
│                                                                              │
│   Data Flow:                                                                │
│   ─────────────────────────────────────────────────────────────────────    │
│   1. Concealer selects techniques via CoverTracksCommand                   │
│   2. CounterTrackingService validates technique requirements               │
│   3. Calculates total bonus and time multiplier                            │
│   4. Performs Wasteland Survival check with bonus                          │
│   5. Result (ConcealmentDc) stored in TrackingState                        │
│   6. When tracker attempts to follow, TrackingService uses contested DC    │
│   7. Trail age and other modifiers apply on top of contested DC            │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 3.4 Layer Architecture

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           LAYER ARCHITECTURE                                 │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │                      DOMAIN LAYER                                    │    │
│  ├─────────────────────────────────────────────────────────────────────┤    │
│  │                                                                      │    │
│  │  Enums/                                                              │    │
│  │  └── ConcealmentTechnique.cs                                        │    │
│  │      ├── HardSurfaces                                               │    │
│  │      ├── BrushTracks                                                │    │
│  │      ├── FalseTrail                                                 │    │
│  │      ├── WaterCrossing                                              │    │
│  │      └── Backtracking                                               │    │
│  │                                                                      │    │
│  │  ValueObjects/                                                       │    │
│  │  ├── CounterTrackingContext.cs                                      │    │
│  │  │   ├── ConcealerId: string                                        │    │
│  │  │   ├── TechniquesUsed: IReadOnlyList<ConcealmentTechnique>       │    │
│  │  │   ├── EnvironmentId: string                                      │    │
│  │  │   └── ToSkillContext(): SkillContext                             │    │
│  │  │                                                                   │    │
│  │  └── CounterTrackingResult.cs                                       │    │
│  │      ├── ConcealmentDc: int                                         │    │
│  │      ├── TotalBonus: int                                            │    │
│  │      ├── NetSuccesses: int                                          │    │
│  │      ├── TimeMultiplier: decimal                                    │    │
│  │      └── TechniquesUsed: IReadOnlyList<ConcealmentTechnique>       │    │
│  │                                                                      │    │
│  │  Entities/ (Modified)                                               │    │
│  │  └── TrackingState.cs                                               │    │
│  │      └── NEW: ContestedDc: int? (nullable, set by counter-tracking) │    │
│  │                                                                      │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
│                                     │                                        │
│                                     ▼                                        │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │                   APPLICATION LAYER                                  │    │
│  ├─────────────────────────────────────────────────────────────────────┤    │
│  │                                                                      │    │
│  │  Services/                                                           │    │
│  │  ├── ICounterTrackingService.cs                                     │    │
│  │  │   ├── AttemptConcealment(concealer, context)                     │    │
│  │  │   ├── CalculateTotalBonus(techniques)                            │    │
│  │  │   ├── CalculateTimeMultiplier(techniques)                        │    │
│  │  │   ├── ValidateTechniques(techniques, environment)                │    │
│  │  │   └── GetAvailableTechniques(environment)                        │    │
│  │  │                                                                   │    │
│  │  └── CounterTrackingService.cs                                      │    │
│  │      └── Implementation of ICounterTrackingService                  │    │
│  │                                                                      │    │
│  │  Services/ (Modified)                                               │    │
│  │  └── TrackingService.cs                                             │    │
│  │      └── Updated GetEffectiveDc() to use ContestedDc when set       │    │
│  │                                                                      │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
│                                     │                                        │
│                                     ▼                                        │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │                  INFRASTRUCTURE LAYER                                │    │
│  ├─────────────────────────────────────────────────────────────────────┤    │
│  │                                                                      │    │
│  │  Configuration/                                                      │    │
│  │  ├── concealment-techniques.json                                    │    │
│  │  └── schemas/concealment-techniques.schema.json                     │    │
│  │                                                                      │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 4. ConcealmentTechnique Enum

**Purpose:** Classifies the different methods a character can use to conceal their trail from pursuers.

**File:** `src/Core/RuneAndRust.Domain/Enums/ConcealmentTechnique.cs`

```csharp
namespace RuneAndRust.Domain.Enums;

/// <summary>
/// Defines the concealment techniques available for counter-tracking.
/// Each technique provides a bonus to the concealment roll but may
/// impose a time cost or have environmental requirements.
/// </summary>
/// <remarks>
/// Techniques can be combined for cumulative bonuses, but time costs
/// compound multiplicatively. For example, BrushTracks (x1.5) combined
/// with FalseTrail (x2.0) results in a x3.0 time multiplier.
/// </remarks>
public enum ConcealmentTechnique
{
    /// <summary>
    /// Walking on hard surfaces (stone, metal, packed earth) that
    /// don't hold tracks well. Always available.
    /// Bonus: +2 to concealment roll.
    /// Time cost: None (x1.0 multiplier).
    /// </summary>
    HardSurfaces = 0,

    /// <summary>
    /// Using branches, debris, or other materials to brush away
    /// tracks. Requires foliage or debris in the area.
    /// Bonus: +4 to concealment roll.
    /// Time cost: +50% travel time (x1.5 multiplier).
    /// </summary>
    BrushTracks = 1,

    /// <summary>
    /// Creating a deliberate false trail to mislead pursuers.
    /// Requires significant time and materials.
    /// Bonus: +6 to concealment roll.
    /// Time cost: +100% travel time (x2.0 multiplier).
    /// </summary>
    FalseTrail = 2,

    /// <summary>
    /// Crossing through water to break the scent and visual trail.
    /// Requires a water body (stream, river, pond).
    /// Bonus: +8 to concealment roll.
    /// Time cost: None (x1.0 multiplier), but requires water.
    /// </summary>
    WaterCrossing = 3,

    /// <summary>
    /// Walking backwards over your own trail to confuse pursuers
    /// about your actual direction. Always available.
    /// Bonus: +4 to concealment roll.
    /// Time cost: +25% travel time (x1.25 multiplier).
    /// </summary>
    Backtracking = 4
}
```

### 4.1 Technique Summary Table

| Technique | Bonus | Time Multiplier | Requirements |
|-----------|-------|-----------------|--------------|
| `HardSurfaces` | +2 | x1.0 | None (always available) |
| `BrushTracks` | +4 | x1.5 | Foliage or debris present |
| `FalseTrail` | +6 | x2.0 | Time and materials |
| `WaterCrossing` | +8 | x1.0 | Water body present |
| `Backtracking` | +4 | x1.25 | None (always available) |

### 4.2 Stacking Examples

| Techniques Combined | Total Bonus | Time Multiplier | Notes |
|---------------------|-------------|-----------------|-------|
| HardSurfaces alone | +2 | x1.0 | Quick, minimal concealment |
| BrushTracks + Backtracking | +8 | x1.875 | Moderate concealment, significant time cost |
| All techniques | +24 | x3.75 | Maximum concealment, very slow |
| WaterCrossing + HardSurfaces | +10 | x1.0 | Effective if water available |

---

## 5. CounterTrackingContext Value Object

**Purpose:** Encapsulates all the information needed to perform a counter-tracking (concealment) attempt.

**File:** `src/Core/RuneAndRust.Domain/ValueObjects/CounterTrackingContext.cs`

```csharp
namespace RuneAndRust.Domain.ValueObjects;

using RuneAndRust.Domain.Enums;

/// <summary>
/// Represents the context for a counter-tracking attempt, including
/// who is concealing their trail, which techniques they're using,
/// and the environmental conditions.
/// </summary>
/// <param name="ConcealerId">The unique identifier of the character concealing their trail.</param>
/// <param name="TechniquesUsed">The concealment techniques being employed.</param>
/// <param name="EnvironmentId">The identifier of the current environment/biome.</param>
/// <param name="HasWaterNearby">Whether a water body is available for WaterCrossing.</param>
/// <param name="HasFoliageOrDebris">Whether foliage or debris is available for BrushTracks.</param>
public readonly record struct CounterTrackingContext(
    string ConcealerId,
    IReadOnlyList<ConcealmentTechnique> TechniquesUsed,
    string EnvironmentId,
    bool HasWaterNearby = false,
    bool HasFoliageOrDebris = true)
{
    /// <summary>
    /// Gets whether any techniques requiring environmental features are valid.
    /// </summary>
    /// <returns>A dictionary mapping techniques to their validity.</returns>
    public Dictionary<ConcealmentTechnique, bool> GetTechniqueValidity()
    {
        return new Dictionary<ConcealmentTechnique, bool>
        {
            { ConcealmentTechnique.HardSurfaces, true }, // Always valid
            { ConcealmentTechnique.BrushTracks, HasFoliageOrDebris },
            { ConcealmentTechnique.FalseTrail, true }, // Always valid (time is the cost)
            { ConcealmentTechnique.WaterCrossing, HasWaterNearby },
            { ConcealmentTechnique.Backtracking, true } // Always valid
        };
    }

    /// <summary>
    /// Validates that all selected techniques can be used in the current environment.
    /// </summary>
    /// <returns>True if all techniques are valid; false otherwise.</returns>
    public bool AreAllTechniquesValid()
    {
        var validity = GetTechniqueValidity();
        return TechniquesUsed.All(t => validity.GetValueOrDefault(t, false));
    }

    /// <summary>
    /// Gets the list of techniques that cannot be used due to environmental constraints.
    /// </summary>
    /// <returns>List of invalid techniques with reasons.</returns>
    public IReadOnlyList<(ConcealmentTechnique Technique, string Reason)> GetInvalidTechniques()
    {
        var validity = GetTechniqueValidity();
        var invalid = new List<(ConcealmentTechnique, string)>();

        foreach (var technique in TechniquesUsed)
        {
            if (!validity.GetValueOrDefault(technique, false))
            {
                var reason = technique switch
                {
                    ConcealmentTechnique.WaterCrossing => "No water body nearby",
                    ConcealmentTechnique.BrushTracks => "No foliage or debris available",
                    _ => "Unknown requirement not met"
                };
                invalid.Add((technique, reason));
            }
        }

        return invalid;
    }

    /// <summary>
    /// Converts this context to a SkillContext for the skill check system.
    /// </summary>
    /// <returns>A SkillContext configured for Wasteland Survival.</returns>
    public SkillContext ToSkillContext()
    {
        return new SkillContext(
            SkillId: "wasteland-survival",
            CharacterId: ConcealerId,
            EnvironmentId: EnvironmentId,
            DcModifier: 0, // Concealment doesn't have a DC; it creates the DC
            ContextDescription: $"Concealing trail using: {string.Join(", ", TechniquesUsed)}"
        );
    }
}
```

---

## 6. CounterTrackingResult Value Object

**Purpose:** Represents the outcome of a counter-tracking attempt, including the concealment DC that will oppose trackers.

**File:** `src/Core/RuneAndRust.Domain/ValueObjects/CounterTrackingResult.cs`

```csharp
namespace RuneAndRust.Domain.ValueObjects;

using RuneAndRust.Domain.Enums;

/// <summary>
/// Represents the result of a counter-tracking (concealment) attempt.
/// The ConcealmentDc becomes the base difficulty for any tracker
/// attempting to follow this character's trail.
/// </summary>
/// <param name="ConcealmentDc">The DC that trackers must beat (minimum 10, maximum 30).</param>
/// <param name="TotalBonus">The sum of all technique bonuses applied.</param>
/// <param name="NetSuccesses">The net successes from the Wasteland Survival roll.</param>
/// <param name="TimeMultiplier">The total travel time multiplier from techniques used.</param>
/// <param name="TechniquesUsed">The techniques that were successfully employed.</param>
/// <param name="RollDetails">Details about the dice roll for logging/display.</param>
public readonly record struct CounterTrackingResult(
    int ConcealmentDc,
    int TotalBonus,
    int NetSuccesses,
    decimal TimeMultiplier,
    IReadOnlyList<ConcealmentTechnique> TechniquesUsed,
    string RollDetails)
{
    /// <summary>
    /// The minimum concealment DC. A trail cannot be made easier to follow
    /// than the baseline difficulty.
    /// </summary>
    public const int MinimumDc = 10;

    /// <summary>
    /// The maximum concealment DC. Even with perfect concealment,
    /// a master tracker might still find clues.
    /// </summary>
    public const int MaximumDc = 30;

    /// <summary>
    /// Gets whether the concealment was effective (DC > minimum).
    /// </summary>
    public bool IsEffective => ConcealmentDc > MinimumDc;

    /// <summary>
    /// Gets the effectiveness rating based on the resulting DC.
    /// </summary>
    public string EffectivenessRating => ConcealmentDc switch
    {
        <= 10 => "Minimal",
        <= 14 => "Light",
        <= 18 => "Moderate",
        <= 22 => "Strong",
        <= 26 => "Excellent",
        _ => "Master-level"
    };

    /// <summary>
    /// Calculates the additional travel time for a given base journey duration.
    /// </summary>
    /// <param name="baseDurationHours">The original travel time in hours.</param>
    /// <returns>The new travel time after applying the time multiplier.</returns>
    public decimal CalculateTravelTime(decimal baseDurationHours)
    {
        return baseDurationHours * TimeMultiplier;
    }

    /// <summary>
    /// Creates a display string summarizing the concealment result.
    /// </summary>
    /// <returns>A formatted summary string.</returns>
    public string ToDisplayString()
    {
        var techniques = string.Join(", ", TechniquesUsed.Select(t => t.ToString()));
        return $"Concealment DC: {ConcealmentDc} ({EffectivenessRating}) | " +
               $"Techniques: {techniques} | " +
               $"Travel time: x{TimeMultiplier:F2}";
    }

    /// <summary>
    /// Creates a failed concealment result (no techniques used or all failed).
    /// </summary>
    /// <returns>A result with minimum DC and no time penalty.</returns>
    public static CounterTrackingResult Failed()
    {
        return new CounterTrackingResult(
            ConcealmentDc: MinimumDc,
            TotalBonus: 0,
            NetSuccesses: 0,
            TimeMultiplier: 1.0m,
            TechniquesUsed: Array.Empty<ConcealmentTechnique>(),
            RollDetails: "No concealment attempted"
        );
    }
}
```

---

## 7. CounterTrackingService Implementation

**Purpose:** Provides the core logic for performing counter-tracking attempts and calculating concealment effectiveness.

### 7.1 Interface Definition

**File:** `src/Core/RuneAndRust.Application/Services/ICounterTrackingService.cs`

```csharp
namespace RuneAndRust.Application.Services;

using RuneAndRust.Domain.Enums;
using RuneAndRust.Domain.ValueObjects;

/// <summary>
/// Service for handling counter-tracking (trail concealment) operations.
/// Allows characters to hide their trail from pursuers using various techniques.
/// </summary>
public interface ICounterTrackingService
{
    /// <summary>
    /// Attempts to conceal the character's trail using the specified techniques.
    /// </summary>
    /// <param name="concealerId">The ID of the character concealing their trail.</param>
    /// <param name="context">The context containing techniques and environment info.</param>
    /// <returns>The result of the concealment attempt.</returns>
    CounterTrackingResult AttemptConcealment(string concealerId, CounterTrackingContext context);

    /// <summary>
    /// Calculates the total bonus from the specified techniques.
    /// </summary>
    /// <param name="techniques">The techniques being used.</param>
    /// <returns>The sum of all technique bonuses.</returns>
    int CalculateTotalBonus(IEnumerable<ConcealmentTechnique> techniques);

    /// <summary>
    /// Calculates the combined time multiplier from the specified techniques.
    /// </summary>
    /// <param name="techniques">The techniques being used.</param>
    /// <returns>The compounded time multiplier.</returns>
    decimal CalculateTimeMultiplier(IEnumerable<ConcealmentTechnique> techniques);

    /// <summary>
    /// Validates that the specified techniques can be used in the given environment.
    /// </summary>
    /// <param name="techniques">The techniques to validate.</param>
    /// <param name="hasWaterNearby">Whether water is available.</param>
    /// <param name="hasFoliageOrDebris">Whether foliage/debris is available.</param>
    /// <returns>True if all techniques are valid; false otherwise.</returns>
    bool ValidateTechniques(
        IEnumerable<ConcealmentTechnique> techniques,
        bool hasWaterNearby,
        bool hasFoliageOrDebris);

    /// <summary>
    /// Gets the list of techniques available in the current environment.
    /// </summary>
    /// <param name="hasWaterNearby">Whether water is available.</param>
    /// <param name="hasFoliageOrDebris">Whether foliage/debris is available.</param>
    /// <returns>List of available techniques.</returns>
    IReadOnlyList<ConcealmentTechnique> GetAvailableTechniques(
        bool hasWaterNearby,
        bool hasFoliageOrDebris);

    /// <summary>
    /// Gets the bonus value for a specific technique.
    /// </summary>
    /// <param name="technique">The technique to query.</param>
    /// <returns>The bonus value for that technique.</returns>
    int GetTechniqueBonus(ConcealmentTechnique technique);

    /// <summary>
    /// Gets the time multiplier for a specific technique.
    /// </summary>
    /// <param name="technique">The technique to query.</param>
    /// <returns>The time multiplier for that technique.</returns>
    decimal GetTechniqueTimeMultiplier(ConcealmentTechnique technique);
}
```

### 7.2 Service Implementation

**File:** `src/Core/RuneAndRust.Application/Services/CounterTrackingService.cs`

```csharp
namespace RuneAndRust.Application.Services;

using Microsoft.Extensions.Logging;
using RuneAndRust.Domain.Enums;
using RuneAndRust.Domain.ValueObjects;

/// <summary>
/// Implementation of the counter-tracking service that handles trail concealment.
/// </summary>
public class CounterTrackingService : ICounterTrackingService
{
    private readonly ISkillCheckService _skillCheckService;
    private readonly ILogger<CounterTrackingService> _logger;

    /// <summary>
    /// Technique bonuses as defined in the Aethelgard specification.
    /// </summary>
    private static readonly Dictionary<ConcealmentTechnique, int> TechniqueBonuses = new()
    {
        { ConcealmentTechnique.HardSurfaces, 2 },
        { ConcealmentTechnique.BrushTracks, 4 },
        { ConcealmentTechnique.FalseTrail, 6 },
        { ConcealmentTechnique.WaterCrossing, 8 },
        { ConcealmentTechnique.Backtracking, 4 }
    };

    /// <summary>
    /// Time multipliers for each technique. Multipliers compound when combined.
    /// </summary>
    private static readonly Dictionary<ConcealmentTechnique, decimal> TechniqueTimeMultipliers = new()
    {
        { ConcealmentTechnique.HardSurfaces, 1.0m },
        { ConcealmentTechnique.BrushTracks, 1.5m },
        { ConcealmentTechnique.FalseTrail, 2.0m },
        { ConcealmentTechnique.WaterCrossing, 1.0m },
        { ConcealmentTechnique.Backtracking, 1.25m }
    };

    /// <summary>
    /// Creates a new instance of the CounterTrackingService.
    /// </summary>
    /// <param name="skillCheckService">The skill check service for dice rolls.</param>
    /// <param name="logger">Logger for diagnostic output.</param>
    public CounterTrackingService(
        ISkillCheckService skillCheckService,
        ILogger<CounterTrackingService> logger)
    {
        _skillCheckService = skillCheckService ?? throw new ArgumentNullException(nameof(skillCheckService));
        _logger = logger ?? throw new ArgumentNullException(nameof(logger));
    }

    /// <inheritdoc />
    public CounterTrackingResult AttemptConcealment(string concealerId, CounterTrackingContext context)
    {
        _logger.LogInformation(
            "Character {ConcealerId} attempting concealment with techniques: {Techniques}",
            concealerId,
            string.Join(", ", context.TechniquesUsed));

        // Validate techniques against environment
        if (!context.AreAllTechniquesValid())
        {
            var invalidTechniques = context.GetInvalidTechniques();
            _logger.LogWarning(
                "Concealment failed: invalid techniques for environment: {Invalid}",
                string.Join(", ", invalidTechniques.Select(t => $"{t.Technique}: {t.Reason}")));

            return CounterTrackingResult.Failed();
        }

        // Calculate bonuses and multipliers
        var totalBonus = CalculateTotalBonus(context.TechniquesUsed);
        var timeMultiplier = CalculateTimeMultiplier(context.TechniquesUsed);

        _logger.LogDebug(
            "Concealment bonuses calculated: Total bonus = {Bonus}, Time multiplier = {Multiplier}",
            totalBonus,
            timeMultiplier);

        // Perform the Wasteland Survival check
        var skillContext = context.ToSkillContext();
        var checkResult = _skillCheckService.PerformCheck(skillContext);

        // Calculate concealment DC: net successes + technique bonus
        var rawDc = checkResult.NetSuccesses + totalBonus;
        var clampedDc = Math.Clamp(rawDc, CounterTrackingResult.MinimumDc, CounterTrackingResult.MaximumDc);

        _logger.LogInformation(
            "Concealment result: Net successes = {NetSuccesses}, Bonus = {Bonus}, Raw DC = {RawDc}, Final DC = {FinalDc}",
            checkResult.NetSuccesses,
            totalBonus,
            rawDc,
            clampedDc);

        var result = new CounterTrackingResult(
            ConcealmentDc: clampedDc,
            TotalBonus: totalBonus,
            NetSuccesses: checkResult.NetSuccesses,
            TimeMultiplier: timeMultiplier,
            TechniquesUsed: context.TechniquesUsed.ToList(),
            RollDetails: checkResult.RollDescription
        );

        _logger.LogInformation(
            "Concealment complete: {Result}",
            result.ToDisplayString());

        return result;
    }

    /// <inheritdoc />
    public int CalculateTotalBonus(IEnumerable<ConcealmentTechnique> techniques)
    {
        return techniques.Sum(t => TechniqueBonuses.GetValueOrDefault(t, 0));
    }

    /// <inheritdoc />
    public decimal CalculateTimeMultiplier(IEnumerable<ConcealmentTechnique> techniques)
    {
        // Time multipliers compound (multiply together)
        return techniques.Aggregate(1.0m, (current, technique) =>
            current * TechniqueTimeMultipliers.GetValueOrDefault(technique, 1.0m));
    }

    /// <inheritdoc />
    public bool ValidateTechniques(
        IEnumerable<ConcealmentTechnique> techniques,
        bool hasWaterNearby,
        bool hasFoliageOrDebris)
    {
        foreach (var technique in techniques)
        {
            var isValid = technique switch
            {
                ConcealmentTechnique.WaterCrossing => hasWaterNearby,
                ConcealmentTechnique.BrushTracks => hasFoliageOrDebris,
                _ => true // HardSurfaces, FalseTrail, Backtracking always valid
            };

            if (!isValid)
            {
                return false;
            }
        }

        return true;
    }

    /// <inheritdoc />
    public IReadOnlyList<ConcealmentTechnique> GetAvailableTechniques(
        bool hasWaterNearby,
        bool hasFoliageOrDebris)
    {
        var available = new List<ConcealmentTechnique>
        {
            ConcealmentTechnique.HardSurfaces, // Always available
            ConcealmentTechnique.FalseTrail,   // Always available (time is the cost)
            ConcealmentTechnique.Backtracking  // Always available
        };

        if (hasWaterNearby)
        {
            available.Add(ConcealmentTechnique.WaterCrossing);
        }

        if (hasFoliageOrDebris)
        {
            available.Add(ConcealmentTechnique.BrushTracks);
        }

        return available;
    }

    /// <inheritdoc />
    public int GetTechniqueBonus(ConcealmentTechnique technique)
    {
        return TechniqueBonuses.GetValueOrDefault(technique, 0);
    }

    /// <inheritdoc />
    public decimal GetTechniqueTimeMultiplier(ConcealmentTechnique technique)
    {
        return TechniqueTimeMultipliers.GetValueOrDefault(technique, 1.0m);
    }
}
```

---

## 8. Integration with TrackingService

**Purpose:** Describes how the counter-tracking system integrates with the existing tracking system from v0.15.5a.

### 8.1 TrackingState Modifications

**File:** `src/Core/RuneAndRust.Domain/Entities/TrackingState.cs` (Modified)

```csharp
// Add to existing TrackingState entity:

/// <summary>
/// The contested DC set by counter-tracking. When set, this replaces
/// the base trail age DC for tracker checks.
/// </summary>
/// <remarks>
/// This value is nullable. When null, the tracker uses the standard
/// trail age DC. When set, it represents the concealer's skill check
/// result plus technique bonuses.
/// </remarks>
public int? ContestedDc { get; private set; }

/// <summary>
/// The time multiplier imposed by the target's concealment techniques.
/// Affects how long it takes to complete each pursuit check.
/// </summary>
public decimal ConcealmentTimeMultiplier { get; private set; } = 1.0m;

/// <summary>
/// Sets the contested DC from a counter-tracking result.
/// </summary>
/// <param name="result">The counter-tracking result.</param>
/// <exception cref="InvalidOperationException">If tracking has already concluded.</exception>
public void ApplyCounterTracking(CounterTrackingResult result)
{
    if (Status == TrackingStatus.Concluded)
    {
        throw new InvalidOperationException("Cannot apply counter-tracking to concluded tracking.");
    }

    ContestedDc = result.ConcealmentDc;
    ConcealmentTimeMultiplier = result.TimeMultiplier;

    AddHistoryEntry($"Target employed concealment (DC {result.ConcealmentDc}, x{result.TimeMultiplier:F2} time)");
}

/// <summary>
/// Clears the contested DC, reverting to standard trail age DC.
/// Called when the concealer stops actively hiding their trail.
/// </summary>
public void ClearCounterTracking()
{
    ContestedDc = null;
    ConcealmentTimeMultiplier = 1.0m;
    AddHistoryEntry("Target stopped concealing trail");
}
```

### 8.2 TrackingService Modifications

**File:** `src/Core/RuneAndRust.Application/Services/TrackingService.cs` (Modified)

```csharp
// Modify the existing GetEffectiveDc method:

/// <summary>
/// Gets the effective DC for the current tracking check, considering
/// contested DC from counter-tracking if present.
/// </summary>
/// <param name="state">The current tracking state.</param>
/// <returns>The effective DC for the tracker's check.</returns>
public int GetEffectiveDc(TrackingState state)
{
    // Base DC from trail age
    var baseDc = GetBaseDcForTrailAge(state.TrailAge);

    // If counter-tracking is active, use contested DC as base instead
    if (state.ContestedDc.HasValue)
    {
        baseDc = state.ContestedDc.Value;
        _logger.LogDebug(
            "Using contested DC {ContestedDc} instead of trail age DC",
            state.ContestedDc.Value);
    }

    // Apply cumulative modifiers (time passed, conditions, etc.)
    var effectiveDc = baseDc + state.CumulativeDcModifier;

    return Math.Clamp(effectiveDc, 1, 30);
}

// Add new method for applying counter-tracking:

/// <summary>
/// Applies a counter-tracking result to the tracking state.
/// </summary>
/// <param name="state">The tracking state to modify.</param>
/// <param name="result">The counter-tracking result.</param>
public void ApplyCounterTracking(TrackingState state, CounterTrackingResult result)
{
    state.ApplyCounterTracking(result);

    _logger.LogInformation(
        "Counter-tracking applied to tracking {TrackingId}: DC {Dc}, time multiplier x{Multiplier}",
        state.TrackingId,
        result.ConcealmentDc,
        result.TimeMultiplier);
}
```

---

## 9. Data Model Changes

### 9.1 New Enums

| Enum | Layer | Description |
|------|-------|-------------|
| `ConcealmentTechnique` | Domain | Trail concealment method classification |

### 9.2 New Value Objects

| Value Object | Layer | Description |
|--------------|-------|-------------|
| `CounterTrackingContext` | Domain | Context for a concealment attempt |
| `CounterTrackingResult` | Domain | Result of a concealment attempt |

### 9.3 Modified Entities

| Entity | Layer | Modifications |
|--------|-------|---------------|
| `TrackingState` | Domain | Added `ContestedDc`, `ConcealmentTimeMultiplier`, `ApplyCounterTracking()`, `ClearCounterTracking()` |

### 9.4 New Services

| Service | Layer | Description |
|---------|-------|-------------|
| `ICounterTrackingService` | Application | Interface for counter-tracking operations |
| `CounterTrackingService` | Application | Implementation of counter-tracking logic |

### 9.5 Modified Services

| Service | Layer | Modifications |
|---------|-------|---------------|
| `TrackingService` | Application | Updated `GetEffectiveDc()` to use contested DC, added `ApplyCounterTracking()` |

---

## 10. Configuration Files

### 10.1 concealment-techniques.json

**File:** `config/concealment-techniques.json`

```json
{
    "$schema": "./schemas/concealment-techniques.schema.json",
    "techniques": [
        {
            "id": "hard-surfaces",
            "technique": "HardSurfaces",
            "displayName": "Walk on Hard Surfaces",
            "description": "Move across stone, metal, or packed earth that doesn't hold tracks well.",
            "bonus": 2,
            "timeMultiplier": 1.0,
            "requirements": [],
            "flavorText": "The Jötun-built roads leave no trace of your passing."
        },
        {
            "id": "brush-tracks",
            "technique": "BrushTracks",
            "displayName": "Brush Away Tracks",
            "description": "Use branches or debris to obscure your footprints as you travel.",
            "bonus": 4,
            "timeMultiplier": 1.5,
            "requirements": ["foliage_or_debris"],
            "flavorText": "Each step erased, as if you were never here."
        },
        {
            "id": "false-trail",
            "technique": "FalseTrail",
            "displayName": "Create False Trail",
            "description": "Deliberately create misleading tracks leading in a different direction.",
            "bonus": 6,
            "timeMultiplier": 2.0,
            "requirements": [],
            "flavorText": "Let them chase shadows while you slip away."
        },
        {
            "id": "water-crossing",
            "technique": "WaterCrossing",
            "displayName": "Cross Through Water",
            "description": "Wade through water to break your scent and visual trail completely.",
            "bonus": 8,
            "timeMultiplier": 1.0,
            "requirements": ["water_nearby"],
            "flavorText": "The stream carries away all evidence of your passage."
        },
        {
            "id": "backtracking",
            "technique": "Backtracking",
            "displayName": "Backtrack Over Trail",
            "description": "Walk backwards over your own trail to confuse pursuers about your direction.",
            "bonus": 4,
            "timeMultiplier": 1.25,
            "requirements": [],
            "flavorText": "Your footprints tell a lie about where you went."
        }
    ],
    "dcLimits": {
        "minimum": 10,
        "maximum": 30
    },
    "environmentRequirements": {
        "foliage_or_debris": {
            "description": "Area must have bushes, leaves, branches, or debris that can be used to sweep away tracks.",
            "commonIn": ["forest", "ruins", "settlement"]
        },
        "water_nearby": {
            "description": "A stream, river, pond, or other water body must be within reasonable distance.",
            "commonIn": ["riverbank", "swamp", "oasis"]
        }
    },
    "stackingRules": {
        "bonusStacking": "additive",
        "timeMultiplierStacking": "multiplicative",
        "notes": "Bonuses add together; time multipliers compound (multiply together)."
    }
}
```

### 10.2 concealment-techniques.schema.json

**File:** `config/schemas/concealment-techniques.schema.json`

```json
{
    "$schema": "https://json-schema.org/draft/2020-12/schema",
    "$id": "https://runeandrust.game/schemas/concealment-techniques.schema.json",
    "title": "Concealment Techniques Configuration",
    "description": "Configuration schema for counter-tracking concealment techniques",
    "type": "object",
    "required": ["techniques", "dcLimits", "stackingRules"],
    "properties": {
        "techniques": {
            "type": "array",
            "description": "Array of concealment technique definitions",
            "items": {
                "type": "object",
                "required": ["id", "technique", "displayName", "description", "bonus", "timeMultiplier", "requirements"],
                "properties": {
                    "id": {
                        "type": "string",
                        "description": "Unique identifier for the technique"
                    },
                    "technique": {
                        "type": "string",
                        "enum": ["HardSurfaces", "BrushTracks", "FalseTrail", "WaterCrossing", "Backtracking"],
                        "description": "ConcealmentTechnique enum value"
                    },
                    "displayName": {
                        "type": "string",
                        "description": "Human-readable name for UI display"
                    },
                    "description": {
                        "type": "string",
                        "description": "Description of what the technique involves"
                    },
                    "bonus": {
                        "type": "integer",
                        "minimum": 0,
                        "maximum": 10,
                        "description": "Bonus added to concealment roll"
                    },
                    "timeMultiplier": {
                        "type": "number",
                        "minimum": 1.0,
                        "maximum": 5.0,
                        "description": "Travel time multiplier (1.0 = no change)"
                    },
                    "requirements": {
                        "type": "array",
                        "items": {
                            "type": "string",
                            "enum": ["foliage_or_debris", "water_nearby"]
                        },
                        "description": "Environmental requirements for this technique"
                    },
                    "flavorText": {
                        "type": "string",
                        "description": "Thematic description for narrative output"
                    }
                }
            }
        },
        "dcLimits": {
            "type": "object",
            "required": ["minimum", "maximum"],
            "properties": {
                "minimum": {
                    "type": "integer",
                    "minimum": 1,
                    "description": "Minimum concealment DC (floor)"
                },
                "maximum": {
                    "type": "integer",
                    "maximum": 30,
                    "description": "Maximum concealment DC (ceiling)"
                }
            }
        },
        "environmentRequirements": {
            "type": "object",
            "description": "Definitions of environmental requirements",
            "additionalProperties": {
                "type": "object",
                "required": ["description"],
                "properties": {
                    "description": {
                        "type": "string"
                    },
                    "commonIn": {
                        "type": "array",
                        "items": {
                            "type": "string"
                        },
                        "description": "Environment types where this requirement is commonly met"
                    }
                }
            }
        },
        "stackingRules": {
            "type": "object",
            "required": ["bonusStacking", "timeMultiplierStacking"],
            "properties": {
                "bonusStacking": {
                    "type": "string",
                    "enum": ["additive", "highest_only"],
                    "description": "How technique bonuses combine"
                },
                "timeMultiplierStacking": {
                    "type": "string",
                    "enum": ["multiplicative", "additive", "highest_only"],
                    "description": "How time multipliers combine"
                },
                "notes": {
                    "type": "string",
                    "description": "Additional notes about stacking behavior"
                }
            }
        }
    }
}
```

### 10.3 Configuration Schema Summary

| Config File | Schema File | Purpose |
|-------------|-------------|---------|
| `concealment-techniques.json` | `concealment-techniques.schema.json` | Technique definitions, bonuses, time costs, requirements |

---

## 11. Logging Specifications

### 11.1 Log Levels by Component

| Component | Level | Events |
|-----------|-------|--------|
| `CounterTrackingService` | Information | Concealment attempts, final results |
| `CounterTrackingService` | Debug | Bonus calculations, technique validation |
| `CounterTrackingService` | Warning | Invalid techniques for environment |
| `CounterTrackingService` | Error | Service failures, null references |
| `TrackingService` | Information | Counter-tracking applied to tracking |
| `TrackingService` | Debug | DC override from contested check |

### 11.2 Log Message Formats

```
// Information level
"Character {ConcealerId} attempting concealment with techniques: {Techniques}"
"Concealment result: Net successes = {NetSuccesses}, Bonus = {Bonus}, Raw DC = {RawDc}, Final DC = {FinalDc}"
"Concealment complete: {Result}"
"Counter-tracking applied to tracking {TrackingId}: DC {Dc}, time multiplier x{Multiplier}"

// Debug level
"Concealment bonuses calculated: Total bonus = {Bonus}, Time multiplier = {Multiplier}"
"Using contested DC {ContestedDc} instead of trail age DC"

// Warning level
"Concealment failed: invalid techniques for environment: {Invalid}"
```

---

## 12. Unit Testing Requirements

### 12.1 Test Count by Feature

| Feature | Test Count |
|---------|------------|
| Technique bonus calculation | ~1 |
| Contested concealment resolution | ~1 |
| **Total** | **~2** |

### 12.2 Test Specifications

**File:** `tests/RuneAndRust.Application.Tests/Services/CounterTrackingServiceTests.cs`

```csharp
[TestFixture]
public class CounterTrackingServiceTests
{
    [Test]
    public void CalculateTotalBonus_WithMultipleTechniques_ReturnsCorrectSum()
    {
        // Arrange
        var service = CreateService();
        var techniques = new[]
        {
            ConcealmentTechnique.BrushTracks,    // +4
            ConcealmentTechnique.Backtracking    // +4
        };

        // Act
        var result = service.CalculateTotalBonus(techniques);

        // Assert
        Assert.That(result, Is.EqualTo(8));
    }

    [Test]
    public void AttemptConcealment_WithValidTechniques_ReturnsContestedDc()
    {
        // Arrange
        var mockSkillCheckService = CreateMockSkillCheckService(netSuccesses: 2);
        var service = CreateService(mockSkillCheckService);
        var context = new CounterTrackingContext(
            ConcealerId: "player-1",
            TechniquesUsed: new[] { ConcealmentTechnique.HardSurfaces }, // +2
            EnvironmentId: "wasteland",
            HasWaterNearby: false,
            HasFoliageOrDebris: true);

        // Act
        var result = service.AttemptConcealment("player-1", context);

        // Assert
        // Net successes (2) + technique bonus (2) = 4, clamped to minimum 10
        Assert.That(result.ConcealmentDc, Is.EqualTo(10));
        Assert.That(result.TotalBonus, Is.EqualTo(2));
        Assert.That(result.NetSuccesses, Is.EqualTo(2));
    }

    [Test]
    public void CalculateTimeMultiplier_WithMultipleTechniques_CompoundsMultipliers()
    {
        // Arrange
        var service = CreateService();
        var techniques = new[]
        {
            ConcealmentTechnique.BrushTracks,    // x1.5
            ConcealmentTechnique.Backtracking    // x1.25
        };

        // Act
        var result = service.CalculateTimeMultiplier(techniques);

        // Assert
        // 1.5 * 1.25 = 1.875
        Assert.That(result, Is.EqualTo(1.875m));
    }

    [Test]
    public void ValidateTechniques_WaterCrossingWithoutWater_ReturnsFalse()
    {
        // Arrange
        var service = CreateService();
        var techniques = new[] { ConcealmentTechnique.WaterCrossing };

        // Act
        var result = service.ValidateTechniques(
            techniques,
            hasWaterNearby: false,
            hasFoliageOrDebris: true);

        // Assert
        Assert.That(result, Is.False);
    }
}
```

---

## 13. Use Cases

### UC-001: Basic Trail Concealment

**Actor:** Player Character
**Flow:** Select techniques → Validate environment → Roll Wasteland Survival → Calculate concealment DC → Apply to tracking state

### UC-002: Contested Tracking Attempt

**Actor:** Tracker NPC
**Flow:** Tracker attempts to follow trail → System checks for contested DC → Uses concealment DC as base → Applies trail age modifiers → Resolves check

### UC-003: Environment-Limited Concealment

**Actor:** Player Character
**Flow:** Select WaterCrossing technique → System validates water requirement → Requirement not met → Concealment fails with warning message

### UC-004: Multiple Technique Stacking

**Actor:** Player Character
**Flow:** Select BrushTracks + Backtracking + FalseTrail → Calculate total bonus (+14) → Calculate time multiplier (x3.75) → Perform concealment roll → High DC achieved but significant time cost

---

## 14. Deliverable Checklist

### 14.1 Domain Layer

- [ ] `ConcealmentTechnique.cs` enum created in `Enums/`
- [ ] `CounterTrackingContext.cs` value object created in `ValueObjects/`
- [ ] `CounterTrackingResult.cs` value object created in `ValueObjects/`
- [ ] `TrackingState.cs` modified to add `ContestedDc` and related members

### 14.2 Application Layer

- [ ] `ICounterTrackingService.cs` interface created in `Services/`
- [ ] `CounterTrackingService.cs` implementation created in `Services/`
- [ ] `TrackingService.cs` modified to use contested DC
- [ ] Service registered in dependency injection

### 14.3 Configuration

- [ ] `config/concealment-techniques.json` created
- [ ] `config/schemas/concealment-techniques.schema.json` created
- [ ] Configuration files validate against schemas

### 14.4 Testing

- [ ] `CounterTrackingServiceTests.cs` created (~2 tests)
- [ ] All tests passing

### 14.5 Documentation

- [ ] XML documentation complete on all public members
- [ ] This design specification complete

---

## 15. Acceptance Criteria

### 15.1 Functional

- [ ] ConcealmentTechnique enum contains all 5 techniques
- [ ] Technique bonuses apply correctly (+2, +4, +6, +8, +4)
- [ ] Time multipliers compound correctly (multiplicative)
- [ ] Concealment DC is clamped between 10 and 30
- [ ] Environmental requirements validated (water, foliage)
- [ ] Contested DC integrates with TrackingService
- [ ] Trail age modifiers apply on top of contested DC

### 15.2 Quality

- [ ] Build succeeds with 0 errors/warnings
- [ ] All ~2 unit tests pass
- [ ] Configuration files validate against JSON schemas
- [ ] XML documentation complete on all public types
- [ ] Logging follows specification

---

## 16. Dependencies

### 16.1 Required from Previous Versions

| Version | Type | Usage |
|---------|------|-------|
| v0.15.0 | `IDiceService` | Dice rolling for concealment checks |
| v0.15.0 | Success-counting mechanics | Net successes calculation |
| v0.15.1 | `ISkillCheckService` | Performing Wasteland Survival checks |
| v0.15.1 | `SkillContext` | Context for skill checks |
| v0.15.5a | `TrackingState` | Target entity for contested DC |
| v0.15.5a | `ITrackingService` | Integration point for contested resolution |

### 16.2 Provides to Future Versions

| Type | Usage in Future |
|------|-----------------|
| `ICounterTrackingService` | Stealth/evasion mechanics in v0.15.2 |
| `ConcealmentTechnique` | Future expansion of hiding mechanics |
| Contested skill pattern | Social deception in v0.15.3 |

---

## 17. Future Considerations

### 17.1 Deferred to v0.15.5c-i

- **Foraging System** (v0.15.5c): Resource gathering mechanics
- **Navigation System** (v0.15.5d): Terrain-based navigation
- **Hazard Detection** (v0.15.5e): Environmental hazard discovery
- **Scavenger Sign Reading** (v0.15.5f): Faction marker interpretation
- **Scout Action** (v0.15.5g): Area reconnaissance
- **Specialization Integration** (v0.15.5h): Archetype-specific bonuses
- **Exploration Synergies** (v0.15.5i): Combined skill checks

### 17.2 Out of Scope

- **Active pursuit evasion**: Real-time chase mechanics (belongs in v0.15.2 Acrobatics)
- **Counter-tracking equipment**: Specialized gear bonuses (future equipment version)
- **NPC counter-tracking AI**: Automatic technique selection for NPCs (future AI version)

---

## 18. Document Metadata

---

*Document Version: 1.0*
*Last Updated: 2026-01-18*
*Author: Claude*

---

### Revision History

| Version | Date | Author | Changes |
|---------|------|--------|---------|
| 1.0 | 2026-01-18 | Claude | Initial design specification |

---

*This design specification provides the detailed blueprint for implementing v0.15.5b Counter-Tracking System. This establishes the contested skill pattern that will be reused for other opposed skill checks throughout the game.*
