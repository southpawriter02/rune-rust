# v0.16.2f Design Specification: Combat Integration

**Version:** 0.16.2f  
**Phase Name:** Combat Integration  
**Parent Version:** v0.16.2 (Armor Proficiency System)  
**Prerequisites:** v0.16.2a-e Complete  
**Estimated Tests:** ~4 unit tests

---

## Table of Contents

1. [Executive Summary](#1-executive-summary)
2. [Feature Overview](#2-feature-overview)
3. [Architecture Diagrams](#3-architecture-diagrams)
4. [IArmorCombatModifierService Interface](#4-iarmorcombatmodifierservice-interface)
5. [ArmorCombatModifierService Implementation](#5-armorcombatmodifierservice-implementation)
6. [CombatArmorState Value Object](#6-combatarmorstate-value-object)
7. [Data Model Changes](#7-data-model-changes)
8. [Logging Specifications](#8-logging-specifications)
9. [Unit Testing Requirements](#9-unit-testing-requirements)
10. [Use Cases](#10-use-cases)
11. [Deliverable Checklist](#11-deliverable-checklist)
12. [Acceptance Criteria](#12-acceptance-criteria)
13. [Dependencies](#13-dependencies)
14. [Future Considerations](#14-future-considerations)

---

## 1. Executive Summary

### 1.1 Purpose

This specification defines combat integration for armor proficiency, applying calculated penalties to combat actions and blocking Galdr when appropriate.

**Combat Integration Points:**

| Integration Point | Effect                                |
| ----------------- | ------------------------------------- |
| Agility Checks    | Apply dice penalty from armor         |
| Stamina Costs     | Increase action costs                 |
| Movement          | Reduce movement speed                 |
| Attack Rolls      | Apply non-proficiency attack modifier |
| Defense           | Apply master defense bonus            |
| Galdr Casting     | Block or penalize based on armor      |
| Stealth           | Apply disadvantage from armor         |

### 1.2 Key Deliverables

| Category          | Items                         |
| ----------------- | ----------------------------- |
| **Value Objects** | `CombatArmorState`            |
| **Interfaces**    | `IArmorCombatModifierService` |
| **Services**      | `ArmorCombatModifierService`  |
| **Tests**         | ~4 unit tests                 |

---

## 2. Feature Overview

```
v0.16.2f Combat Integration
├── CombatArmorState Value Object
│   ├── EffectivePenalties: EffectiveArmorPenalties
│   ├── GaldrBlocked: bool
│   ├── GaldrPenalty: int
│   ├── StealthDisadvantage: bool
│   └── DisplayWarnings: List<string>
├── IArmorCombatModifierService Interface
│   ├── GetCombatState(character): CombatArmorState
│   ├── CanCastGaldr(character): bool
│   ├── GetGaldrPenalty(character): int
│   ├── GetAgilityModifier(character): int
│   ├── GetStaminaCostModifier(character): int
│   └── GetMovementModifier(character): int
└── ArmorCombatModifierService
    ├── Dependencies: IArmorPenaltyCalculator, IArchetypeArmorProficiencyProvider
    ├── ComputeCombatState(): Aggregates all modifiers
    ├── CheckGaldrInterference(): Applies v0.16.2c rules
    └── FormatWarnings(): Generates UI messages
```

---

## 3. Architecture Diagrams

### 3.1 Combat Integration Flow

```
┌─────────────────────────────────────────────────────────────────────┐
│                    COMBAT INTEGRATION FLOW                           │
└─────────────────────────────────────────────────────────────────────┘

    Combat Action Initiated
           │
           ▼
    ┌──────────────────────────────────────────────────────────────────┐
    │  GET COMBAT ARMOR STATE                                          │
    ├──────────────────────────────────────────────────────────────────┤
    │  IArmorCombatModifierService.GetCombatState(character)           │
    └──────────────────────────────────────────────────────────────────┘
           │
           ├──► Get equipped armor category
           ├──► Get character proficiency level
           ├──► Calculate effective penalties (v0.16.2d)
           ├──► Check Galdr interference (v0.16.2c)
           │
           ▼
    ┌──────────────────────────────────────────────────────────────────┐
    │  APPLY MODIFIERS TO ACTION                                       │
    ├──────────────────────────────────────────────────────────────────┤
    │  Attack Roll:                                                    │
    │    modifier += state.AttackModifier (-2 if NonProficient)        │
    │                                                                  │
    │  Defense Roll:                                                   │
    │    modifier += state.DefenseModifier (+1 if Master)              │
    │                                                                  │
    │  Agility Check:                                                  │
    │    dicePool -= state.AgilityDicePenalty                          │
    │                                                                  │
    │  Stamina Cost:                                                   │
    │    cost += state.StaminaCostModifier                             │
    │                                                                  │
    │  Movement:                                                       │
    │    speed += state.MovementModifier (negative)                    │
    └──────────────────────────────────────────────────────────────────┘
           │
           ▼
    ┌──────────────────────────────────────────────────────────────────┐
    │  CHECK GALDR (if casting)                                        │
    ├──────────────────────────────────────────────────────────────────┤
    │  if (state.GaldrBlocked)                                         │
    │    → BLOCK: "Cannot cast Galdr in heavy armor"                  │
    │                                                                  │
    │  else if (state.GaldrPenalty != 0)                               │
    │    → APPLY: Galdr check -= state.GaldrPenalty                    │
    └──────────────────────────────────────────────────────────────────┘
```

### 3.2 Galdr Blocking Decision Tree

```
┌─────────────────────────────────────────────────────────────────────┐
│                   GALDR BLOCKING DECISION TREE                       │
└─────────────────────────────────────────────────────────────────────┘

    Mystic Attempts Galdr
           │
           ▼
    ┌──────────────────────────────────────────────────────────────────┐
    │  CHECK ARCHETYPE HAS GALDR INTERFERENCE                          │
    ├──────────────────────────────────────────────────────────────────┤
    │    Warrior/Skirmisher → No interference (non-caster)             │
    │    Mystic/Adept → Continue checking                              │
    └──────────────────────────────────────────────────────────────────┘
           │ Caster
           ▼
    ┌──────────────────────────────────────────────────────────────────┐
    │  CHECK EQUIPPED ARMOR                                            │
    ├──────────────────────────────────────────────────────────────────┤
    │    Light Armor → No interference                                 │
    │    Medium Armor → -2 Galdr penalty                               │
    │    Heavy Armor → BLOCKED (Mystic) or -4 WITS (Adept)             │
    │    Shield → BLOCKED for Mystic                                   │
    └──────────────────────────────────────────────────────────────────┘
           │
           ▼
    ┌──────────────────────────────────────────────────────────────────┐
    │  RETURN GALDR STATE                                              │
    ├──────────────────────────────────────────────────────────────────┤
    │  CombatArmorState {                                              │
    │    GaldrBlocked: true/false                                      │
    │    GaldrPenalty: -2 / 0                                          │
    │    DisplayWarnings: ["Heavy armor blocks Galdr"]                 │
    │  }                                                               │
    └──────────────────────────────────────────────────────────────────┘
```

### 3.3 Layer Diagram

```
┌─────────────────────────────────────────────────────────────────────┐
│                        PRESENTATION LAYER                            │
├─────────────────────────────────────────────────────────────────────┤
│  CombatView                                                          │
│  ├── Shows active armor penalties in status bar                     │
│  ├── Grays out Galdr abilities when blocked                         │
│  └── Displays penalty warnings on hover                             │
│                                                                      │
│  AbilityBar                                                          │
│  └── Shows Galdr penalty indicator (-2)                             │
│  └── Disables blocked abilities                                     │
└───────┬─────────────────────────────────────────────────────────────┘
        │
        ▼
┌─────────────────────────────────────────────────────────────────────┐
│                       APPLICATION LAYER                              │
├─────────────────────────────────────────────────────────────────────┤
│  ┌───────────────────────────────────────────────────────────────┐  │
│  │              ArmorCombatModifierService                        │  │
│  │        (implements IArmorCombatModifierService)                │  │
│  ├───────────────────────────────────────────────────────────────┤  │
│  │  Dependencies:                                                │  │
│  │  - IArmorPenaltyCalculator (v0.16.2d)                         │  │
│  │  - IArchetypeArmorProficiencyProvider (v0.16.2c)              │  │
│  │                                                               │  │
│  │  + GetCombatState(character): CombatArmorState                │  │
│  │  + CanCastGaldr(character): bool                              │  │
│  │  + GetGaldrPenalty(character): int                            │  │
│  │  + GetAgilityModifier(character): int                         │  │
│  │  + GetStaminaCostModifier(character): int                     │  │
│  │  + GetMovementModifier(character): int                        │  │
│  │  + GetAttackModifier(character): int                          │  │
│  │  + GetDefenseModifier(character): int                         │  │
│  └───────────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────────┘
```

---

## 4. IArmorCombatModifierService Interface

**File:** `src/Core/RuneAndRust.Application/Interfaces/IArmorCombatModifierService.cs`

```csharp
namespace RuneAndRust.Application.Interfaces;

using RuneAndRust.Domain.Entities;
using RuneAndRust.Domain.ValueObjects;

/// <summary>
/// Provides armor-based combat modifiers.
/// </summary>
public interface IArmorCombatModifierService
{
    /// <summary>Gets complete combat armor state for a character.</summary>
    CombatArmorState GetCombatState(Player character);

    /// <summary>Checks if character can cast Galdr in current armor.</summary>
    bool CanCastGaldr(Player character);

    /// <summary>Gets Galdr penalty for current armor (-2 for medium, 0 otherwise).</summary>
    int GetGaldrPenalty(Player character);

    /// <summary>Gets agility dice penalty from armor.</summary>
    int GetAgilityModifier(Player character);

    /// <summary>Gets stamina cost modifier from armor.</summary>
    int GetStaminaCostModifier(Player character);

    /// <summary>Gets movement speed modifier from armor.</summary>
    int GetMovementModifier(Player character);

    /// <summary>Gets attack modifier from proficiency.</summary>
    int GetAttackModifier(Player character);

    /// <summary>Gets defense modifier from mastery.</summary>
    int GetDefenseModifier(Player character);

    /// <summary>Checks if armor causes stealth disadvantage.</summary>
    bool HasStealthDisadvantage(Player character);
}
```

---

## 5. ArmorCombatModifierService Implementation

**File:** `src/Core/RuneAndRust.Application/Services/ArmorCombatModifierService.cs`

```csharp
namespace RuneAndRust.Application.Services;

using Microsoft.Extensions.Logging;
using RuneAndRust.Application.Interfaces;
using RuneAndRust.Domain.Entities;
using RuneAndRust.Domain.Enums;
using RuneAndRust.Domain.ValueObjects;

/// <summary>
/// Provides armor-based combat modifiers by orchestrating penalty calculation
/// and Galdr interference checks.
/// </summary>
public class ArmorCombatModifierService : IArmorCombatModifierService
{
    private readonly IArmorPenaltyCalculator _penaltyCalculator;
    private readonly IArchetypeArmorProficiencyProvider _archetypeProvider;
    private readonly ILogger<ArmorCombatModifierService> _logger;

    public ArmorCombatModifierService(
        IArmorPenaltyCalculator penaltyCalculator,
        IArchetypeArmorProficiencyProvider archetypeProvider,
        ILogger<ArmorCombatModifierService> logger)
    {
        _penaltyCalculator = penaltyCalculator;
        _archetypeProvider = archetypeProvider;
        _logger = logger;
    }

    /// <inheritdoc />
    public CombatArmorState GetCombatState(Player character)
    {
        ArgumentNullException.ThrowIfNull(character);

        var armorCategory = character.EquippedArmor?.Category ?? ArmorCategory.Light;
        var profLevel = _archetypeProvider.GetStartingProficiency(
            character.ArchetypeId, armorCategory);

        var penalties = _penaltyCalculator.CalculatePenalties(armorCategory, profLevel);
        var galdrBlocked = _archetypeProvider.IsGaldrBlocked(character.ArchetypeId, armorCategory);
        var galdrPenalty = _archetypeProvider.GetGaldrPenalty(character.ArchetypeId, armorCategory);

        var warnings = BuildWarnings(penalties, galdrBlocked, galdrPenalty);

        _logger.LogDebug(
            "Combat state for {Character}: {Penalties}, GaldrBlocked={Blocked}",
            character.Name, penalties.FormatSummary(), galdrBlocked);

        return CombatArmorState.Create(
            penalties, galdrBlocked, galdrPenalty,
            penalties.EffectivePenalties.HasStealthDisadvantage, warnings);
    }

    /// <inheritdoc />
    public bool CanCastGaldr(Player character) =>
        !_archetypeProvider.IsGaldrBlocked(
            character.ArchetypeId,
            character.EquippedArmor?.Category ?? ArmorCategory.Light);

    /// <inheritdoc />
    public int GetGaldrPenalty(Player character) =>
        _archetypeProvider.GetGaldrPenalty(
            character.ArchetypeId,
            character.EquippedArmor?.Category ?? ArmorCategory.Light);

    /// <inheritdoc />
    public int GetAgilityModifier(Player character) =>
        GetCombatState(character).EffectivePenalties.EffectivePenalties.AgilityDicePenalty;

    /// <inheritdoc />
    public int GetStaminaCostModifier(Player character) =>
        GetCombatState(character).EffectivePenalties.EffectivePenalties.StaminaCostModifier;

    /// <inheritdoc />
    public int GetMovementModifier(Player character) =>
        GetCombatState(character).EffectivePenalties.EffectivePenalties.MovementPenalty;

    /// <inheritdoc />
    public int GetAttackModifier(Player character) =>
        GetCombatState(character).EffectivePenalties.AttackModifier;

    /// <inheritdoc />
    public int GetDefenseModifier(Player character) =>
        GetCombatState(character).EffectivePenalties.DefenseModifier;

    /// <inheritdoc />
    public bool HasStealthDisadvantage(Player character) =>
        GetCombatState(character).StealthDisadvantage;

    private List<string> BuildWarnings(
        EffectiveArmorPenalties penalties, bool galdrBlocked, int galdrPenalty)
    {
        var warnings = new List<string>();
        if (penalties.WasMultiplied)
            warnings.Add("Penalties doubled (non-proficient)");
        if (galdrBlocked)
            warnings.Add("Galdr blocked by armor");
        else if (galdrPenalty != 0)
            warnings.Add($"Galdr: {galdrPenalty} penalty");
        return warnings;
    }
}
```

---

## 6. CombatArmorState Value Object

**File:** `src/Core/RuneAndRust.Domain/ValueObjects/CombatArmorState.cs`

```csharp
namespace RuneAndRust.Domain.ValueObjects;

/// <summary>
/// Complete combat state derived from equipped armor and proficiency.
/// </summary>
public readonly record struct CombatArmorState(
    EffectiveArmorPenalties EffectivePenalties,
    bool GaldrBlocked,
    int GaldrPenalty,
    bool StealthDisadvantage,
    IReadOnlyList<string> DisplayWarnings)
{
    /// <summary>Gets whether any penalties are active.</summary>
    public bool HasAnyPenalty => EffectivePenalties.HasAnyPenalty || GaldrPenalty != 0;

    /// <summary>Gets whether any bonuses are active.</summary>
    public bool HasAnyBonus => EffectivePenalties.HasAnyBonus;

    /// <summary>Creates combat state with validation.</summary>
    public static CombatArmorState Create(
        EffectiveArmorPenalties penalties,
        bool galdrBlocked,
        int galdrPenalty,
        bool stealthDisadvantage,
        IReadOnlyList<string> warnings)
    {
        return new CombatArmorState(
            penalties, galdrBlocked, galdrPenalty, stealthDisadvantage, warnings);
    }

    /// <summary>Formats for combat log.</summary>
    public string FormatForCombatLog() =>
        GaldrBlocked ? "Galdr BLOCKED" :
        GaldrPenalty != 0 ? $"Galdr {GaldrPenalty}" :
        EffectivePenalties.FormatSummary();
}
```

---

## 7. Data Model Changes

| Type                          | Layer       | Category     | Description                 |
| ----------------------------- | ----------- | ------------ | --------------------------- |
| `CombatArmorState`            | Domain      | Value Object | Complete combat state       |
| `IArmorCombatModifierService` | Application | Interface    | Combat modifier access      |
| `ArmorCombatModifierService`  | Application | Service      | Combat modifier calculation |

---

## 8. Logging Specifications

```csharp
// Debug - Combat state calculated
_logger.LogDebug(
    "Combat state for {Character}: {Penalties}, GaldrBlocked={Blocked}",
    character.Name, penalties.FormatSummary(), galdrBlocked);

// Warning - Galdr blocked
_logger.LogWarning(
    "Galdr blocked for {Character} wearing {Armor}",
    character.Name, armorCategory);
```

---

## 9. Unit Testing Requirements

**File:** `tests/RuneAndRust.Application.UnitTests/Services/ArmorCombatModifierServiceTests.cs`

```csharp
[TestFixture]
public class ArmorCombatModifierServiceTests
{
    [Test]
    public void CanCastGaldr_MysticInHeavy_ReturnsFalse()
    {
        // Arrange
        var character = CreateMystic(ArmorCategory.Heavy);
        var service = CreateService();

        // Act & Assert
        service.CanCastGaldr(character).Should().BeFalse();
    }

    [Test]
    public void GetGaldrPenalty_MysticInMedium_ReturnsMinusTwo()
    {
        var character = CreateMystic(ArmorCategory.Medium);
        var service = CreateService();

        service.GetGaldrPenalty(character).Should().Be(-2);
    }

    [Test]
    public void GetAttackModifier_NonProficient_ReturnsMinusTwo()
    {
        var character = CreateMystic(ArmorCategory.Heavy);
        var service = CreateService();

        service.GetAttackModifier(character).Should().Be(-2);
    }

    [Test]
    public void GetDefenseModifier_MasterProficiency_ReturnsPlusOne()
    {
        var character = CreateWarriorMaster(ArmorCategory.Heavy);
        var service = CreateService();

        service.GetDefenseModifier(character).Should().Be(1);
    }
}
```

---

## 10. Use Cases

| ID     | Use Case               | Actor           | Flow                                        |
| ------ | ---------------------- | --------------- | ------------------------------------------- |
| UC-001 | Apply Combat Penalties | System          | Combat starts → Get state → Apply modifiers |
| UC-002 | Block Galdr            | Player (Mystic) | Cast Galdr in Heavy → Show blocked message  |
| UC-003 | Display Warnings       | Player          | View combat UI → See penalty indicators     |

---

## 11. Deliverable Checklist

- [ ] `CombatArmorState` value object
- [ ] `IArmorCombatModifierService` interface
- [ ] `ArmorCombatModifierService` service
- [ ] ~4 unit tests passing

---

## 12. Acceptance Criteria

### Functional

- [ ] NonProficient applies -2 attack modifier in combat
- [ ] Master applies +1 defense modifier in combat
- [ ] Agility penalties applied to agility checks
- [ ] Stamina costs increased by armor modifier
- [ ] Movement reduced by armor penalty
- [ ] Mystic Galdr blocked in Heavy armor
- [ ] Mystic Galdr -2 penalty in Medium armor
- [ ] Stealth disadvantage applied correctly

### Quality

- [ ] Build succeeds with 0 errors
- [ ] All ~4 tests pass
- [ ] XML documentation complete

---

## 13. Dependencies

### Required from Previous Phases

| Type                                 | Source   | Usage                |
| ------------------------------------ | -------- | -------------------- |
| `EffectiveArmorPenalties`            | v0.16.2d | Calculated penalties |
| `IArmorPenaltyCalculator`            | v0.16.2d | Penalty calculation  |
| `GaldrInterference`                  | v0.16.2c | Galdr blocking rules |
| `IArchetypeArmorProficiencyProvider` | v0.16.2c | Archetype lookups    |

---

## 14. Future Considerations

### Out of Scope

- **Buff/Debuff Interactions**: Temporary penalty modifications
- **Equipment Set Bonuses**: Set-based penalty reduction
- **Combat Log Formatting**: Detailed penalty breakdown in log

---

_Document Version: 1.0_  
_Last Updated: 2026-01-27_
