# v0.0.11a Implementation Plan: Descriptor Framework Expansion

**Version:** 0.0.11a
**Parent:** v0.0.11 (Descriptors & Ambience)
**Prerequisites:** v0.0.10 Complete (Documentation & Polish)
**Design Specification:** [v0.0.11a-design-specification.md](v0.0.11a-design-specification.md)
**Status:** Ready for Implementation
**Target Tests:** ~18 unit tests

---

## Table of Contents

1. [Executive Summary](#executive-summary)
2. [Current System Analysis](#current-system-analysis)
3. [Detailed Implementation](#detailed-implementation)
4. [Testing Strategy](#testing-strategy)
5. [Implementation Checklist](#implementation-checklist)
6. [Acceptance Criteria](#acceptance-criteria)
7. [File Summary](#file-summary)

---

## Executive Summary

### Purpose

Expand the descriptor framework to support environment categories, coherence validation, and biome-based descriptor selection. This prevents incoherent environmental descriptions (rooms that are simultaneously frozen and volcanic) and enables consistent, immersive atmosphere generation.

### Scope

- **In Scope:**
  - `EnvironmentCategory` configuration class for category definitions
  - `CategoryExclusionRule` for conflict definitions
  - `BiomeDefinition` configuration for biome-specific defaults
  - `EnvironmentContext` value object for room-level environment state
  - `EnvironmentCoherenceService` for validation and context management
  - Extension of `DescriptorContext` to include environment state
  - Configuration files: `environment-categories.json`, `biomes.json`

- **Out of Scope:**
  - Combat descriptors (v0.0.11b)
  - Sensory descriptors (v0.0.11c)
  - Interactive objects (v0.0.11d)

### Key Decisions

| Decision | Choice | Rationale |
|----------|--------|-----------|
| **Data Source** | JSON configuration | Data-driven, extensible, modifiable |
| **Validation** | Hard/soft rules | Balance strictness with flexibility |
| **Backwards Compat** | Optional constructor param | Existing code continues to work |

---

## Current System Analysis

### Existing Descriptor System (v0.0.10)

| Component | Current Capability |
|-----------|-------------------|
| `DescriptorService` | Tag-based filtering, theme support |
| `DescriptorContext` | `DamagePercent`, `HealthPercent`, `Tags` |
| `Room` entity | Name, description, exits, monsters, items |
| Configuration | Per-pool descriptors in JSON |

### Target Enhancements (v0.0.11a)

| Component | Enhancement |
|-----------|-------------|
| `DescriptorService` | Biome pool overrides, environment-aware methods |
| `DescriptorContext` | Add `EnvironmentContext`, derived tags |
| `Room` entity | Add `Environment` property |
| Configuration | Add categories, biomes, exclusion rules |

### New Components

| Component | Purpose |
|-----------|---------|
| `EnvironmentCategory` | Define category types (biome, climate, lighting, era, condition) |
| `CategoryValue` | Define values within categories with implied tags |
| `CategoryExclusionRule` | Define conflicting value combinations |
| `BiomeDefinition` | Define biome defaults and pool overrides |
| `EnvironmentContext` | Immutable value object holding category values |
| `EnvironmentCoherenceService` | Validate contexts, create from biomes |

---

## Detailed Implementation

### Layer Interactions

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                  Configuration Layer                         ‚îÇ
‚îÇ  environment-categories.json, biomes.json                    ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                              ‚îÇ
                              ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                  Infrastructure Layer                        ‚îÇ
‚îÇ  JsonConfigurationProvider                                   ‚îÇ
‚îÇ  - LoadEnvironmentCategories()                               ‚îÇ
‚îÇ  - LoadBiomes()                                              ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                              ‚îÇ
                              ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                  Application Layer                           ‚îÇ
‚îÇ  EnvironmentCoherenceService                                 ‚îÇ
‚îÇ  - CreateFromBiome(), Validate(), GetValidValues()           ‚îÇ
‚îÇ  DescriptorService (enhanced)                                ‚îÇ
‚îÇ  - GetDescriptorWithEnvironment()                            ‚îÇ
‚îÇ  - GenerateRoomAtmosphereWithEnvironment()                   ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                              ‚îÇ
                              ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                    Domain Layer                              ‚îÇ
‚îÇ  EnvironmentContext (value object)                           ‚îÇ
‚îÇ  Room.Environment (property)                                 ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

---

## Testing Strategy

### Unit Tests (~18 tests)

#### EnvironmentContextTests.cs (~5 tests)

| Test | Description |
|------|-------------|
| `GetValue_WhenCategoryExists_ReturnsValue` | Basic retrieval |
| `GetValue_WhenCategoryMissing_ReturnsNull` | Null handling |
| `WithValue_AddsNewCategory_PreservesExisting` | Immutable update |
| `Biome_Property_ReturnsBiomeValue` | Convenience property |
| `HasCategory_WhenExists_ReturnsTrue` | Category check |

#### EnvironmentCoherenceServiceTests.cs (~8 tests)

| Test | Description |
|------|-------------|
| `Validate_WithNoConflicts_ReturnsValid` | Valid context |
| `Validate_WithHardConflict_ReturnsViolation` | Hard rule detection |
| `Validate_WithSoftConflict_ReturnsWarningViolation` | Soft rule detection |
| `CreateFromBiome_WithValidBiome_CreatesContext` | Biome creation |
| `CreateFromBiome_WithUnknownBiome_ThrowsException` | Error handling |
| `CreateFromBiome_AppliesDefaultValues` | Default application |
| `CreateFromBiome_AppliesOverrides` | Override handling |
| `CreateFromBiome_WithConflictingOverride_ThrowsException` | Conflict prevention |

#### DescriptorServiceEnvironmentTests.cs (~5 tests)

| Test | Description |
|------|-------------|
| `GetDescriptorWithEnvironment_AppliesBiomeOverrides` | Pool override |
| `GetDescriptorWithEnvironment_IncludesDerivedTags` | Tag integration |
| `GenerateRoomAtmosphereWithEnvironment_ProducesCoherentOutput` | End-to-end |
| `GetEffectiveTags_CombinesExplicitAndDerivedTags` | Tag merging |
| `GetEffectiveTags_WhenEnvironmentTagsDisabled_OnlyExplicitTags` | Toggle behavior |

---

## Implementation Checklist

> **Legend:** üü¢ No dependencies | üü° Has dependencies | üî¥ Critical path
> **Complexity:** ‚≠ê Simple | ‚≠ê‚≠ê Moderate | ‚≠ê‚≠ê‚≠ê Complex

---

### Phase 1: Domain Layer

#### 1.1 Create EnvironmentContext Value Object üü¢ ‚≠ê‚≠ê üî¥

**File:** `src/Core/RuneAndRust.Domain/ValueObjects/EnvironmentContext.cs`

- [ ] Create `readonly record struct EnvironmentContext`
- [ ] Add `CategoryValues` property (IReadOnlyDictionary<string, string>)
- [ ] Add `DerivedTags` property (IReadOnlyList<string>)
- [ ] Implement parameterless constructor
- [ ] Implement constructor with parameters
- [ ] Add `GetValue(string categoryId)` method
- [ ] Add convenience properties: `Biome`, `Climate`, `Lighting`, `Era`, `Condition`
- [ ] Add `HasCategory(string categoryId)` method
- [ ] Add `WithValue(string categoryId, string valueId)` method
- [ ] Override `ToString()` for debugging

**Acceptance:** Value object is immutable and provides category access.

---

#### 1.2 Modify Room Entity üü° ‚≠ê

**File:** `src/Core/RuneAndRust.Domain/Entities/Room.cs`

- [ ] Add `Environment` property (nullable `EnvironmentContext`)
- [ ] Add `SetEnvironment(EnvironmentContext environment)` method

**Acceptance:** Room can hold environment context.

---

### Phase 2: Configuration Classes

#### 2.1 Create EnvironmentCategoryConfiguration üü¢ ‚≠ê‚≠ê

**File:** `src/Core/RuneAndRust.Application/Configuration/EnvironmentCategoryConfiguration.cs`

- [ ] Create `EnvironmentCategoryConfiguration` class
  - `Version` property
  - `Categories` dictionary
  - `ExclusionRules` list
- [ ] Create `EnvironmentCategory` class
  - `Id`, `Name`, `Description`
  - `IsRequired`, `DefaultValue`
  - `Values` list
- [ ] Create `CategoryValue` class
  - `Id`, `Name`, `Description`
  - `ImpliedTags` list
- [ ] Create `CategoryExclusionRule` class
  - `Id`, `Reason`
  - `Category1`, `Values1`
  - `Category2`, `Values2`
  - `IsHardRule`

**Acceptance:** Configuration classes deserialize from JSON.

---

#### 2.2 Create BiomeConfiguration üü¢ ‚≠ê‚≠ê

**File:** `src/Core/RuneAndRust.Application/Configuration/BiomeConfiguration.cs`

- [ ] Create `BiomeConfiguration` class
  - `Version` property
  - `Biomes` dictionary
- [ ] Create `BiomeDefinition` class
  - `Id`, `Name`, `Description`
  - `DefaultCategoryValues` dictionary
  - `ImpliedTags` list
  - `DescriptorPoolOverrides` dictionary
  - `EmphasizedTerms`, `ExcludedTerms` lists

**Acceptance:** Configuration classes deserialize from JSON.

---

### Phase 3: Configuration Files

#### 3.1 Create environment-categories.json üü° ‚≠ê‚≠ê

**File:** `config/environment-categories.json`

- [ ] Define `biome` category with 8 values (cave, dungeon, volcanic, frozen, swamp, ruins, forest, desert)
- [ ] Define `climate` category with 6 values (freezing, cold, temperate, warm, hot, scorching)
- [ ] Define `lighting` category with 5 values (pitch_black, dim, normal, bright, blinding)
- [ ] Define `era` category with 4 values (ancient, medieval, decayed, pristine)
- [ ] Define `condition` category with 5 values (flooded, burning, collapsed, overgrown, infested)
- [ ] Define 7+ exclusion rules (volcanic_freezing, frozen_hot, flooded_burning, etc.)

**Acceptance:** JSON validates and loads correctly.

---

#### 3.2 Create biomes.json üü° ‚≠ê‚≠ê

**File:** `config/biomes.json`

- [ ] Define `cave` biome with defaults, tags, pool overrides
- [ ] Define `dungeon` biome with defaults, tags, pool overrides
- [ ] Define `volcanic` biome with defaults, tags, pool overrides
- [ ] Define `frozen` biome with defaults, tags, pool overrides
- [ ] Define `swamp` biome with defaults, tags, pool overrides
- [ ] Define `ruins` biome with defaults
- [ ] Define `forest` biome with defaults, tags, pool overrides
- [ ] Define `desert` biome with defaults, tags, pool overrides

**Acceptance:** 8 biomes defined with appropriate defaults.

---

### Phase 4: Application Services

#### 4.1 Create EnvironmentCoherenceService üü° ‚≠ê‚≠ê‚≠ê üî¥

**File:** `src/Core/RuneAndRust.Application/Services/EnvironmentCoherenceService.cs`

- [ ] Create `EnvironmentCoherenceService` class
- [ ] Inject `EnvironmentCategoryConfiguration`, `BiomeConfiguration`, `ILogger`
- [ ] Implement `Validate(EnvironmentContext context)` method
- [ ] Implement `CreateFromBiome(string biomeId, overrides)` method
- [ ] Implement `GetValidValues(string categoryId, EnvironmentContext)` method
- [ ] Implement `GetBiome(string biomeId)` method
- [ ] Implement `GetAllBiomes()`, `GetAllCategories()` methods
- [ ] Implement `ViolatesRule()` private helper
- [ ] Implement `CollectDerivedTags()` private helper
- [ ] Create `EnvironmentValidationResult` record
- [ ] Create `EnvironmentViolation` record

**Acceptance:** Service validates contexts and creates from biomes.

---

#### 4.2 Modify DescriptorContext üü° ‚≠ê

**File:** `src/Core/RuneAndRust.Application/Services/DescriptorService.cs`

- [ ] Add `Environment` property (nullable `EnvironmentContext`)
- [ ] Add `IncludeEnvironmentTags` property (default true)
- [ ] Add `GetEffectiveTags()` method combining explicit and derived tags

**Acceptance:** Context supports environment and derived tags.

---

#### 4.3 Extend DescriptorService üü° ‚≠ê‚≠ê

**File:** `src/Core/RuneAndRust.Application/Services/DescriptorService.cs`

- [ ] Add optional `EnvironmentCoherenceService` constructor parameter
- [ ] Implement `GetDescriptorWithEnvironment(poolPath, context)` method
  - Apply biome pool overrides
  - Use effective tags including derived
- [ ] Implement `GenerateRoomAtmosphereWithEnvironment(environment)` method
  - Generate lighting, sound, smell, temperature descriptors
  - Combine 2-3 elements coherently

**Acceptance:** Service generates biome-coherent atmosphere.

---

### Phase 5: Infrastructure Integration

#### 5.1 Extend IGameConfigurationProvider üü° ‚≠ê

**File:** `src/Core/RuneAndRust.Application/Interfaces/IGameConfigurationProvider.cs`

- [ ] Add `GetEnvironmentCategories()` method
- [ ] Add `GetBiomeConfiguration()` method

**Acceptance:** Interface supports new configurations.

---

#### 5.2 Extend JsonConfigurationProvider üü° ‚≠ê‚≠ê

**File:** `src/Infrastructure/RuneAndRust.Infrastructure/Configuration/JsonConfigurationProvider.cs`

- [ ] Load `environment-categories.json` in initialization
- [ ] Load `biomes.json` in initialization
- [ ] Implement `GetEnvironmentCategories()` method
- [ ] Implement `GetBiomeConfiguration()` method

**Acceptance:** Provider loads and returns new configurations.

---

#### 5.3 Register EnvironmentCoherenceService üü° ‚≠ê

**File:** `src/Infrastructure/RuneAndRust.Infrastructure/DependencyInjection.cs`

- [ ] Register `EnvironmentCoherenceService` in DI container

**Acceptance:** Service available via dependency injection.

---

### Phase 6: Unit Tests

#### 6.1 EnvironmentContextTests.cs üü° ‚≠ê‚≠ê

**File:** `tests/RuneAndRust.Domain.UnitTests/ValueObjects/EnvironmentContextTests.cs`

- [ ] Implement 5 tests per specification

**Acceptance:** All value object tests pass.

---

#### 6.2 EnvironmentCoherenceServiceTests.cs üü° ‚≠ê‚≠ê

**File:** `tests/RuneAndRust.Application.UnitTests/Services/EnvironmentCoherenceServiceTests.cs`

- [ ] Implement 8 tests per specification (validation, biome creation, conflicts)

**Acceptance:** All service tests pass.

---

#### 6.3 DescriptorServiceEnvironmentTests.cs üü° ‚≠ê‚≠ê

**File:** `tests/RuneAndRust.Application.UnitTests/Services/DescriptorServiceEnvironmentTests.cs`

- [ ] Implement 5 tests per specification (overrides, tags, atmosphere)

**Acceptance:** All integration tests pass.

---

### Implementation Order Summary

```
Phase 1: Domain Layer
  1.1 EnvironmentContext value object ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
  1.2 Room.Environment property ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
                                                          ‚Üì
Phase 2: Configuration Classes
  2.1 EnvironmentCategoryConfiguration
  2.2 BiomeConfiguration
                                                          ‚Üì
Phase 3: Configuration Files
  3.1 environment-categories.json
  3.2 biomes.json
                                                          ‚Üì
Phase 4: Application Services
  4.1 EnvironmentCoherenceService ‚Üê CRITICAL
  4.2 DescriptorContext modifications
  4.3 DescriptorService extensions
                                                          ‚Üì
Phase 5: Infrastructure Integration
  5.1 IGameConfigurationProvider extensions
  5.2 JsonConfigurationProvider implementation
  5.3 DI registration
                                                          ‚Üì
Phase 6: Unit Tests
  6.1 EnvironmentContextTests
  6.2 EnvironmentCoherenceServiceTests
  6.3 DescriptorServiceEnvironmentTests
```

### Estimated Effort

| Phase | Tasks | Complexity | Est. Time |
|-------|-------|------------|-----------|
| Domain Layer | 2 items | ‚≠ê-‚≠ê‚≠ê | 1 hour |
| Configuration Classes | 2 files | ‚≠ê‚≠ê | 1.5 hours |
| Configuration Files | 2 files | ‚≠ê‚≠ê | 1.5 hours |
| Application Services | 3 items | ‚≠ê‚≠ê‚≠ê | 3 hours |
| Infrastructure | 3 items | ‚≠ê-‚≠ê‚≠ê | 1.5 hours |
| Unit Tests | 18 tests | ‚≠ê‚≠ê | 2.5 hours |
| **Total** | | | **~11 hours** |

---

## Acceptance Criteria

### Environment Categories

- [ ] Categories load from `environment-categories.json`
- [ ] Category values include implied tags
- [ ] Required categories validated on context creation
- [ ] Default values applied when not specified

### Coherence Validation

- [ ] Exclusion rules detect conflicting values
- [ ] Hard rule violations throw exceptions
- [ ] Soft rule violations log warnings but proceed
- [ ] `Validate()` returns detailed violation information

### Biome System

- [ ] Biomes load from `biomes.json`
- [ ] `CreateFromBiome()` creates valid contexts
- [ ] Biome defaults applied correctly
- [ ] Biome pool overrides affect descriptor selection

### Descriptor Integration

- [ ] `DescriptorContext` includes `EnvironmentContext`
- [ ] Derived tags from environment used in filtering
- [ ] `GenerateRoomAtmosphereWithEnvironment()` produces coherent output
- [ ] Existing `DescriptorService` methods unchanged (backwards compatible)

### Tests

- [ ] ~18 unit tests pass
- [ ] Build completes with 0 errors

---

## File Summary

### New Files (9)

| File | Purpose |
|------|---------|
| `src/Core/RuneAndRust.Domain/ValueObjects/EnvironmentContext.cs` | Environment value object |
| `src/Core/RuneAndRust.Application/Configuration/EnvironmentCategoryConfiguration.cs` | Category config classes |
| `src/Core/RuneAndRust.Application/Configuration/BiomeConfiguration.cs` | Biome config classes |
| `src/Core/RuneAndRust.Application/Services/EnvironmentCoherenceService.cs` | Coherence validation |
| `config/environment-categories.json` | Category definitions |
| `config/biomes.json` | Biome definitions |
| `tests/RuneAndRust.Domain.UnitTests/ValueObjects/EnvironmentContextTests.cs` | Context tests |
| `tests/RuneAndRust.Application.UnitTests/Services/EnvironmentCoherenceServiceTests.cs` | Service tests |
| `tests/RuneAndRust.Application.UnitTests/Services/DescriptorServiceEnvironmentTests.cs` | Integration tests |

### Modified Files (6)

| File | Changes |
|------|---------|
| `Room.cs` | Add `Environment` property and `SetEnvironment()` method |
| `DescriptorService.cs` | Add environment-aware methods, optional coherence service |
| `DescriptorContext` class | Add `Environment`, `IncludeEnvironmentTags`, `GetEffectiveTags()` |
| `IGameConfigurationProvider.cs` | Add new configuration methods |
| `JsonConfigurationProvider.cs` | Load new configuration files |
| `DependencyInjection.cs` | Register `EnvironmentCoherenceService` |

---

## Provides to Future Phases

### To v0.0.11b (Combat Descriptors)

| Type | Usage |
|------|-------|
| `EnvironmentContext` | Context for combat descriptor selection |
| `EnvironmentCoherenceService` | Biome info for combat flavor |

### To v0.0.11c (Sensory Descriptors)

| Type | Usage |
|------|-------|
| `EnvironmentContext` | Context for sensory descriptor selection |
| `BiomeDefinition` | Sensory defaults by biome |

### To v0.0.11d (Interactive Objects)

| Type | Usage |
|------|-------|
| `EnvironmentContext` | Object placement validation |
| Exclusion rules | Object/environment compatibility |

---

*This implementation plan establishes the foundation for coherent environmental descriptors by introducing categories, exclusion rules, and biome definitions. The framework prevents incoherent descriptions while enabling rich atmosphere generation.*
