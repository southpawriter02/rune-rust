# v0.20.6c Changelog — Bone-Setter Tier 3 & Capstone Abilities

## Version: 0.20.6c

## Date: 2026-02-16

## Focus: Bone-Setter Specialization — Tier 3 Abilities (Resuscitate, Preventive Care) & Capstone (Miracle Worker)

---

## Added

### Domain Layer — Enums

- **`ResurrectionMethod`** — 4 resurrection method classifications for tracking how unconscious characters are revived: SkillBasedResuscitation (0, Resuscitate ability), MiracleIntervention (1, Miracle Worker capstone), NaturalRecovery (2, future use), DivineGrace (3, future use for other specializations)

### Domain Layer — Value Objects

- **`ResuscitateResult`** — Revival outcome record for the Tier 3 Resuscitate ability. Properties: `TargetId`, `TargetName`, `HpBefore`, `SuppliesRemaining`, `Method` (ResurrectionMethod), `ResurrectionMessage`. Computed constants: `HpAfter => 1` (always restores to exactly 1 HP), `SuppliesUsed => 2` (always consumes 2 supplies). Display: `GetStatusMessage()` with "RESUSCITATED" keyword.
- **`PreventiveCareAura`** — Passive aura evaluation result for the Tier 3 Preventive Care ability. Properties: `BoneSetterId`, `AffectedAllyIds` (`IReadOnlyList<Guid>`). Computed constants: `AuraRadius => 5`, `PoisonSaveBonus => 1`, `DiseaseSaveBonus => 1`, `IsActive => true`. Display: `GetAuraSummary()` with radius, bonus values, and ally count.
- **`MiracleWorkerResult`** — Full restoration outcome record for the Capstone Miracle Worker ability. Properties: `TargetId`, `TargetName`, `HpBefore`, `MaxHp`, `ClearedConditions` (`IReadOnlyList<string>`), `MiracleMessage`. Computed: `HpAfter => MaxHp` (full HP restore), `TotalHealing => MaxHp - HpBefore`, `ConditionsCleared => ClearedConditions.Count`. Display: `GetStatusMessage()` with "FULLY RESTORED" and conditional conditions count, `GetFullBreakdown()` multi-line block with HP transition, conditions list, and cooldown info.

### Domain Layer — Entity Changes

- **`Player`** — Added 2 members for Miracle Worker cooldown tracking:
  - `bool HasUsedMiracleWorkerThisRestCycle { get; set; }` — Long-rest cooldown flag, separate from `HasUsedCapstoneThisCombat` which resets per combat. Persists across multiple combats until long rest.
  - `void ResetMiracleWorkerCooldown()` — Sets `HasUsedMiracleWorkerThisRestCycle` to false. Called when the player completes a long rest.

### Application Layer — Interface Changes

- **`IBoneSetterAbilityService`** — Added 3 Tier 3 + Capstone method signatures:
  - `ExecuteResuscitate(Player, Guid, string, int)` — Revives unconscious target (0 HP) to 1 HP, costs 4 AP + 2 supplies
  - `EvaluatePreventiveCare(Player, Guid[])` — Passive aura evaluation, no AP/supply cost
  - `ExecuteMiracleWorker(Player, Guid, string, int, int, IEnumerable<string>)` — Full HP restore + condition clearing, 5 AP, once per long rest
- Updated interface XML documentation to describe Tier 3 and Capstone abilities

### Application Layer — Service Changes

- **`BoneSetterAbilityService`** — Added Tier 3 + Capstone implementation:
  - 5 new constants: `ResuscitateApCost` (4), `ResuscitateSupplyCost` (2), `PreventiveCareRadius` (5), `PreventiveCareSaveBonus` (1), `MiracleWorkerApCost` (5)
  - `ExecuteResuscitate` — Guard-clause chain → validate target HP == 0 → validate supplies ≥ 2 (via `GetTotalSupplyCount()`, not `ValidateSupplyAvailability` which only checks ≥ 1) → deduct 4 AP → `SpendSupply(player)` twice sequentially (lowest quality first) → defensive null guard on each spend with AP restoration → build result with `SkillBasedResuscitation` method → LogInformation with both supply details
  - `EvaluatePreventiveCare` — Guard-clause chain → validate allies not null/empty → build `PreventiveCareAura` VO with ally IDs → LogInformation. No AP cost, no supply cost, no Corruption. Pure evaluation like `EvaluateTriage`.
  - `ExecuteMiracleWorker` — Guard-clause chain → validate `!HasUsedMiracleWorkerThisRestCycle` → deduct 5 AP → set rest cycle cooldown → materialize conditions list → build result with full HP restore → LogInformation with healing, conditions, cooldown status. No supply cost. No Corruption. No Steady Hands bonus (full heal, not dice-based).
  - `GetAbilityReadiness` — Updated switch expression with 3 new cases: Resuscitate (AP ≥ 4 && supplies ≥ 2), PreventiveCare (always true), MiracleWorker (!cooldown && AP ≥ 5)

### Configuration

- Updated `config/abilities.json` with 3 Tier 3 + Capstone ability entries:
  - `resuscitate` (id 606): Active, 4 AP + 2 supplies (lowest quality, sequential), revives to 1 HP, no cooldown, Coherent path
  - `preventive-care` (id 607): Passive, 5-space radius aura, +1 poison/disease saving throws, no cost, Coherent path
  - `miracle-worker` (id 608): Active, 5 AP + no supplies, full HP restore + condition clear, once per long rest, Coherent path

### Unit Tests

- **`BoneSetterAbilityServiceTests`** — 26 new Tier 3 + Capstone tests (68 total):
  - `CreateTier3BoneSetter` helper (unlocks all T1+T2+T3 = 22 PP, initializes 3 supplies)
  - `SetupResuscitateMocks` helper with `SetupSequence` for 2 sequential `SpendSupply` calls
  - Resuscitate (8 tests): valid prereqs revival, target not at 0 HP, insufficient AP, insufficient supplies (< 2), ability not unlocked, deducts correct AP, spends two supplies (verified via `Times.Exactly(2)`), wrong specialization
  - Preventive Care (5 tests): with allies returns aura, no allies returns null, null allies returns null, ability not unlocked, aura contains correct ally IDs
  - Miracle Worker (8 tests): valid prereqs full heal, clears conditions, insufficient AP, already used this rest, ability not unlocked, sets rest cycle cooldown, no supply cost (SpendSupply never called), empty conditions
  - Readiness & PP (5 tests): includes Tier 3 abilities, Resuscitate needs 2 supplies, MiracleWorker on cooldown returns false, CanUnlockTier3 with T3 unlocked, GetPPInvested with all abilities = 28 PP
- **`ResuscitateResultTests`** — 6 domain tests: HpAfter always 1, SuppliesUsed always 2, status message contains target name and HP values, status message contains RESUSCITATED, default values initialize, method preserves resurrection method
- **`PreventiveCareAuraTests`** — 5 domain tests: AuraRadius always 5, PoisonSaveBonus always 1, DiseaseSaveBonus always 1, IsActive always true, aura summary contains ally count and radius
- **`MiracleWorkerResultTests`** — 7 domain tests: HpAfter equals MaxHp, TotalHealing calculates correctly, ConditionsCleared equals list count, status message contains FULLY RESTORED, status message with conditions includes count, status message without conditions excludes text, full breakdown contains all sections

## Design Decisions

- **Simple `HasUsedMiracleWorkerThisRestCycle` bool instead of `CapstoneUsageTracker` VO**: The design spec proposed a DateTime-based tracker with repository support. A simple bool flag matches the existing `HasUsedCapstoneThisCombat` pattern and is sufficient for a single long-rest cooldown.
- **Resuscitate supply validation uses `GetTotalSupplyCount() >= 2`**: Cannot use `ValidateSupplyAvailability()` which only checks ≥ 1 supply. Resuscitate needs 2 supplies, so direct count comparison is required.
- **Two sequential `SpendSupply` calls for Resuscitate**: Each call spends the lowest-quality supply available. The second call includes a defensive null guard with AP restoration and a warning log about the first supply already being consumed.
- **Miracle Worker has no supply cost**: The design spec's scope breakdown mentioned 3 supplies, but the detailed design spec sections 7.1/7.2 explicitly state "No resource cost." The miracle transcends material requirements.
- **Miracle Worker has no Steady Hands bonus**: Unlike Field Dressing (2d6) and Emergency Surgery (4d6) which use dice rolls, Miracle Worker performs a full HP restore — no dice, no quality bonus, no Steady Hands bonus. It simply sets HP to MaxHp.
- **No DC check for Resuscitate**: Design spec section 5.1 specifies no skill check — just AP + supplies. The scope breakdown mentioned DC 16 but the detailed specification supersedes.
- **All abilities in single `BoneSetterAbilityService`**: Follows the established per-specialization single-service pattern. No separate `ResuscitateService` or `MiracleWorkerService`.
- **Synchronous methods**: Existing service is synchronous. No async wrapper needed for purely in-memory operations.
- **`PreventiveCareAura` result stores ally IDs as `IReadOnlyList<Guid>`**: Matching the immutable collection pattern from other Bone-Setter VOs. The calling code provides ally IDs already identified within radius.

## Test Results

```
Bone-Setter v0.20.6c tests: 86 new (104 total Bone-Setter tests)
     Passed: 104
     Failed: 0

Breakdown:
  BoneSetterAbilityServiceTests:       68 application tests (16 T1 + 26 T2 + 26 T3/Capstone)
  ResuscitateResultTests:              6 domain tests
  PreventiveCareAuraTests:             5 domain tests
  MiracleWorkerResultTests:            7 domain tests
  EmergencySurgeryResultTests:         6 domain tests (v0.20.6b, unchanged)
  AntidoteCraftResultTests:            5 domain tests (v0.20.6b, unchanged)
  CraftingMaterialTests:               7 domain tests (v0.20.6b, unchanged)
```
