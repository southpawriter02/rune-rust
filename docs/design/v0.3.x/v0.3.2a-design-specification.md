# v0.3.2a Design Specification: Quest Chains

## Overview

**Version:** 0.3.2a
**Parent:** v0.3.2 (Quest Chains & Advanced Features)
**Prerequisites:** v0.3.1 Complete (Quest Rewards & NPCs)
**Status:** Design Complete
**Estimated Unit Tests:** ~30

---

## Table of Contents

1. [Executive Summary](#1-executive-summary)
2. [Feature Overview](#2-feature-overview)
3. [Architecture Diagrams](#3-architecture-diagrams)
4. [User Stories](#4-user-stories)
5. [Data Models](#5-data-models)
6. [Configuration Schemas](#6-configuration-schemas)
7. [Service Specifications](#7-service-specifications)
8. [User-Facing Changes](#8-user-facing-changes)
9. [Logging Requirements](#9-logging-requirements)
10. [Unit Test Specifications](#10-unit-test-specifications)
11. [Use Cases](#11-use-cases)
12. [Acceptance Criteria](#12-acceptance-criteria)
13. [Deliverable Checklist](#13-deliverable-checklist)
14. [Dependencies](#14-dependencies)
15. [Future Considerations](#15-future-considerations)

---

## 1. Executive Summary

This phase implements quest chains that link related quests into narrative sequences. Completing one quest in a chain automatically unlocks the next, enabling story-driven progression through connected objectives. The QuestChain entity serves as a container for ordered quest sequences, while the QuestChainService manages progression and unlocking. Main quest lines receive prominent display treatment in the quest journal.

### Key Deliverables

| Category | Items |
|----------|-------|
| **Entities** | QuestChain |
| **Services** | IQuestChainService, QuestChainService |
| **Value Objects** | ChainProgress, ChainProgressionResult |
| **Quest Updates** | ChainId, ChainOrder, IsChainStart, IsChainEnd |
| **Configuration** | quest-chains.json, quest-chains.schema.json |
| **Tests** | ~30 new unit tests |

### Architectural Significance

This version establishes the **quest chain pattern** that enables:
- Narrative-driven quest sequences with automatic progression
- Main quest line prominence for story-focused gameplay
- Chain completion bonuses rewarding full sequence completion
- Foundation for complex multi-part storylines in future versions
- Integration with existing prerequisite system (v0.3.1c)

---

## 2. Feature Overview

```
v0.3.2a Features
├── QuestChain Entity
│   ├── Id (Guid - runtime instance)
│   ├── DefinitionId (string - from config)
│   ├── Name (display name)
│   ├── Description (narrative context)
│   ├── IsMainQuest (prominent display flag)
│   ├── QuestIds (ordered quest sequence)
│   ├── TotalQuests (count property)
│   ├── CompletionBonus (QuestReward)
│   ├── Prerequisites (IReadOnlyList<QuestPrerequisite>)
│   ├── GetQuestAt(order) method
│   ├── GetNextQuest(currentQuestId) method
│   ├── IsFirstQuest(questId) method
│   ├── IsLastQuest(questId) method
│   └── GetQuestOrder(questId) method
├── Quest Entity Updates
│   ├── ChainId (nullable string)
│   ├── ChainOrder (nullable int)
│   ├── IsInChain (computed property)
│   ├── IsChainStart (computed property)
│   ├── IsChainEnd (property)
│   └── SetChainMembership() method
├── IQuestChainService Interface
│   ├── GetChain(chainId) method
│   ├── GetMainQuestChain() method
│   ├── GetAvailableChains(player) method
│   ├── GetChainProgress(player, chainId) method
│   ├── ProcessQuestCompletion(player, quest) method
│   ├── UnlockNextQuest(player, chain, questId) method
│   ├── HasCompletedChain(player, chainId) method
│   └── GetChainCompletionBonus(chainId) method
├── ChainProgress Value Object
│   ├── ChainId, ChainName
│   ├── CompletedQuests, TotalQuests
│   ├── CurrentQuestId, NextQuestId
│   ├── IsComplete flag
│   ├── ProgressPercent computed
│   └── GetProgressDisplay() method
├── ChainProgressionResult Value Object
│   ├── WasInChain flag
│   ├── ChainId
│   ├── UnlockedQuest (Quest?)
│   ├── ChainCompleted flag
│   └── ChainBonus (QuestReward?)
└── Quest Journal Updates
    ├── Chain grouping display
    ├── Main quest prominence
    ├── Chain progress indicator
    └── Chain bonus preview
```

---

## 3. Architecture Diagrams

### 3.1 Layer Diagram

```
┌─────────────────────────────────────────────────────────────────────────┐
│                         PRESENTATION LAYER                              │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │                    IGameRenderer (updated)                       │   │
│  ├─────────────────────────────────────────────────────────────────┤   │
│  │ RenderQuestJournalAsync(QuestJournalDto)  // shows chains       │   │
│  │ RenderQuestDetailAsync(QuestDetailDto)    // shows chain info   │   │
│  │ RenderChainProgressAsync(ChainProgressDto) // progression       │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                         APPLICATION LAYER                               │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │                    IQuestChainService (new)                      │   │
│  ├─────────────────────────────────────────────────────────────────┤   │
│  │ + GetChain(chainId): QuestChain?                                │   │
│  │ + GetMainQuestChain(): QuestChain?                              │   │
│  │ + GetAvailableChains(player): IEnumerable<QuestChain>           │   │
│  │ + GetChainProgress(player, chainId): ChainProgress              │   │
│  │ + ProcessQuestCompletion(player, quest): ChainProgressionResult │   │
│  │ + UnlockNextQuest(player, chain, questId): Quest?               │   │
│  │ + HasCompletedChain(player, chainId): bool                      │   │
│  │ + GetChainCompletionBonus(chainId): QuestReward?                │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │                    ChainProgressDto (new)                        │   │
│  ├─────────────────────────────────────────────────────────────────┤   │
│  │ + ChainId: string                                               │   │
│  │ + ChainName: string                                             │   │
│  │ + CompletedQuests: int                                          │   │
│  │ + TotalQuests: int                                              │   │
│  │ + CurrentQuestName: string?                                     │   │
│  │ + NextQuestName: string?                                        │   │
│  │ + IsComplete: bool                                              │   │
│  │ + ProgressPercent: float                                        │   │
│  │ + CompletionBonus: RewardDisplayDto?                            │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │                    QuestDetailDto (updated)                      │   │
│  ├─────────────────────────────────────────────────────────────────┤   │
│  │ + ChainInfo: ChainMembershipDto?                    // NEW      │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │                    ChainMembershipDto (new)                      │   │
│  ├─────────────────────────────────────────────────────────────────┤   │
│  │ + ChainId: string                                               │   │
│  │ + ChainName: string                                             │   │
│  │ + QuestNumber: int (1-based for display)                        │   │
│  │ + TotalInChain: int                                             │   │
│  │ + IsMainQuest: bool                                             │   │
│  │ + ChainCompletionBonus: RewardDisplayDto?                       │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                           DOMAIN LAYER                                  │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  ENTITIES                                                               │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │                    QuestChain (new)                              │   │
│  ├─────────────────────────────────────────────────────────────────┤   │
│  │ + Id: Guid                                                       │   │
│  │ + DefinitionId: string                                           │   │
│  │ + Name: string                                                   │   │
│  │ + Description: string                                            │   │
│  │ + IsMainQuest: bool                                              │   │
│  │ + QuestIds: IReadOnlyList<string>                               │   │
│  │ + TotalQuests: int                                               │   │
│  │ + CompletionBonus: QuestReward?                                  │   │
│  │ + Prerequisites: IReadOnlyList<QuestPrerequisite>               │   │
│  ├─────────────────────────────────────────────────────────────────┤   │
│  │ + Create(...): static                                            │   │
│  │ + GetQuestAt(order): string?                                     │   │
│  │ + GetNextQuest(currentQuestId): string?                          │   │
│  │ + IsFirstQuest(questId): bool                                    │   │
│  │ + IsLastQuest(questId): bool                                     │   │
│  │ + GetQuestOrder(questId): int                                    │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │                    Quest (updated)                               │   │
│  ├─────────────────────────────────────────────────────────────────┤   │
│  │ + ChainId: string?                                   // NEW      │   │
│  │ + ChainOrder: int?                                   // NEW      │   │
│  │ + IsInChain: bool                                    // NEW      │   │
│  │ + IsChainStart: bool                                 // NEW      │   │
│  │ + IsChainEnd: bool                                   // NEW      │   │
│  ├─────────────────────────────────────────────────────────────────┤   │
│  │ + SetChainMembership(chainId, order, isEnd): void   // NEW      │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
│  VALUE OBJECTS                                                          │
│  ┌────────────────────────────┐  ┌────────────────────────────┐        │
│  │      ChainProgress         │  │  ChainProgressionResult    │        │
│  ├────────────────────────────┤  ├────────────────────────────┤        │
│  │ + ChainId: string          │  │ + WasInChain: bool         │        │
│  │ + ChainName: string        │  │ + ChainId: string?         │        │
│  │ + CompletedQuests: int     │  │ + UnlockedQuest: Quest?    │        │
│  │ + TotalQuests: int         │  │ + ChainCompleted: bool     │        │
│  │ + CurrentQuestId: string?  │  │ + ChainBonus: QuestReward? │        │
│  │ + NextQuestId: string?     │  └────────────────────────────┘        │
│  │ + IsComplete: bool         │                                        │
│  │ + ProgressPercent: float   │                                        │
│  │ + GetProgressDisplay()     │                                        │
│  └────────────────────────────┘                                        │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                        INFRASTRUCTURE LAYER                             │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  Configuration Files:                                                   │
│  ├── config/quest-chains.json (new)                                    │
│  └── config/schemas/quest-chains.schema.json (new)                     │
│                                                                         │
│  DTOs for Deserialization:                                              │
│  ├── QuestChainConfigDto                                               │
│  └── ChainPrerequisiteConfigDto                                        │
│                                                                         │
│  IConfigurationProvider Updates:                                        │
│  └── LoadQuestChainDefinitions()                                       │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

### 3.2 Quest Chain Composition

```
┌─────────────────────────────────────────────────────────────────────────┐
│                        QUEST CHAIN COMPOSITION                          │
└─────────────────────────────────────────────────────────────────────────┘

    ┌───────────────────────────────────────────────────────────────┐
    │                       QuestChain                               │
    │              "The Shadow Over Thornwood"                       │
    ├───────────────────────────────────────────────────────────────┤
    │                                                               │
    │  Properties:                                                  │
    │  ├── DefinitionId: "shadow-over-thornwood"                   │
    │  ├── IsMainQuest: true                                       │
    │  └── TotalQuests: 5                                          │
    │                                                               │
    │  QuestIds (ordered sequence):                                │
    │  ┌─────────────────────────────────────────────────────────┐  │
    │  │ [0] "shadow-chapter-1"  ─► The Village's Plea           │  │
    │  │ [1] "shadow-chapter-2"  ─► Into the Dark Forest         │  │
    │  │ [2] "shadow-chapter-3"  ─► The Heart of Corruption      │  │
    │  │ [3] "shadow-chapter-4"  ─► The Druid's Choice           │  │
    │  │ [4] "shadow-chapter-5"  ─► Shadow's End                 │  │
    │  └─────────────────────────────────────────────────────────┘  │
    │                                                               │
    │  CompletionBonus: QuestReward                                │
    │  ├── 500 XP                                                  │
    │  ├── Shadow Cloak (unique item)                              │
    │  └── +500 Thornwood Village reputation                       │
    │                                                               │
    └───────────────────────────────────────────────────────────────┘
```

### 3.3 Chain Progression Flow

```
┌─────────────────────────────────────────────────────────────────────────┐
│                      CHAIN PROGRESSION FLOW                             │
└─────────────────────────────────────────────────────────────────────────┘

    Player completes quest "shadow-chapter-2"
                    │
                    ▼
    ┌───────────────────────────────────────┐
    │   QuestChainService                   │
    │   ProcessQuestCompletion()            │
    └───────────────────────────────────────┘
                    │
                    ├──► Check: Is quest in a chain?
                    │    Yes - ChainId: "shadow-over-thornwood"
                    │
                    ├──► Check: Is this the last quest in chain?
                    │    No - ChainOrder: 1, TotalQuests: 5
                    │
                    ├──► Get next quest in chain
                    │    Next: "shadow-chapter-3"
                    │
                    ├──► Check prerequisites for next quest
                    │    All met (previous quest complete)
                    │
                    └──► Create and unlock next quest
                         │
                         ▼
    ┌───────────────────────────────────────┐
    │   ChainProgressionResult              │
    │   ├── WasInChain: true               │
    │   ├── ChainId: "shadow-over-thornwood"│
    │   ├── UnlockedQuest: Quest [ch3]      │
    │   ├── ChainCompleted: false           │
    │   └── ChainBonus: null                │
    └───────────────────────────────────────┘
                    │
                    ▼
    Display to player:
    ┌─────────────────────────────────────────────────────────────────┐
    │  CHAIN PROGRESS: The Shadow Over Thornwood                      │
    │    [■■■■■■■■░░░░░░░░░░░░] 40% (2/5)                             │
    │                                                                 │
    │  NEW QUEST UNLOCKED:                                            │
    │    "The Heart of Corruption"                                    │
    └─────────────────────────────────────────────────────────────────┘
```

### 3.4 Chain Completion Flow

```
┌─────────────────────────────────────────────────────────────────────────┐
│                      CHAIN COMPLETION FLOW                              │
└─────────────────────────────────────────────────────────────────────────┘

    Player completes quest "shadow-chapter-5" (final quest)
                    │
                    ▼
    ┌───────────────────────────────────────┐
    │   QuestChainService                   │
    │   ProcessQuestCompletion()            │
    └───────────────────────────────────────┘
                    │
                    ├──► Check: Is this the last quest in chain?
                    │    Yes - ChainOrder: 4, TotalQuests: 5
                    │
                    ├──► Mark chain as complete for player
                    │
                    └──► Get chain completion bonus
                         │
                         ▼
    ┌───────────────────────────────────────┐
    │   ChainProgressionResult              │
    │   ├── WasInChain: true               │
    │   ├── ChainId: "shadow-over-thornwood"│
    │   ├── UnlockedQuest: null             │
    │   ├── ChainCompleted: true            │
    │   └── ChainBonus: QuestReward         │
    │       ├── 500 XP                      │
    │       ├── Shadow Cloak                │
    │       └── +500 reputation             │
    └───────────────────────────────────────┘
                    │
                    ▼
    Display to player:
    ┌─────────────────────────────────────────────────────────────────┐
    │  ═══════════════════════════════════════════════════════════   │
    │                    QUEST CHAIN COMPLETE!                        │
    │  ═══════════════════════════════════════════════════════════   │
    │                                                                 │
    │    "The Shadow Over Thornwood"                                  │
    │                                                                 │
    │  CHAIN COMPLETION BONUS:                                        │
    │    + 500 XP                                                     │
    │    + Shadow Cloak                                               │
    │    + 500 Thornwood Village reputation                           │
    │                                                                 │
    └─────────────────────────────────────────────────────────────────┘
```

---

## 4. User Stories

### US-3.2a-1: Define Quest Chains
**As a** game designer
**I want to** configure quests into chains in quest-chains.json
**So that** related quests form narrative sequences

**Acceptance Criteria:**
- Chains define an ordered list of quest definition IDs
- Chains have a name and description for display
- Chains can be marked as main quest lines
- Chain completion bonuses can be configured
- Invalid chain configurations produce clear errors

### US-3.2a-2: View Quest Chain Progress
**As a** player
**I want to** see my progress through quest chains
**So that** I understand the story progression

**Acceptance Criteria:**
- Quest journal shows chain grouping
- Main quest chains display prominently
- Progress shows "Quest X of Y" format
- Chain completion percentage is visible
- Chain completion bonus is previewed

### US-3.2a-3: Automatic Quest Unlocking
**As a** player
**I want** the next quest in a chain to unlock automatically
**So that** I don't need to find quest givers for story progression

**Acceptance Criteria:**
- Completing a chain quest unlocks the next
- Unlock notification displays clearly
- Next quest appears in quest journal
- Chain progress updates immediately
- Prerequisites are checked before unlock

### US-3.2a-4: Chain Completion Bonus
**As a** player
**I want to** receive bonus rewards for completing a full chain
**So that** I'm rewarded for finishing story arcs

**Acceptance Criteria:**
- Completion bonus grants when final quest completes
- Bonus rewards display prominently
- Chain marked as complete in journal
- Bonus is separate from individual quest rewards
- Bonus uses existing QuestReward system

### US-3.2a-5: Main Quest Prominence
**As a** player
**I want** main quest chains to be visually prominent
**So that** I can easily track story progression

**Acceptance Criteria:**
- Main quests display at top of journal
- Main quest indicator is visible
- Chain progress for main quest is prominent
- Main quest has distinct styling
- Only one main quest chain active at a time

---

## 5. Data Models

### 5.1 QuestChain Entity

```csharp
namespace RuneAndRust.Domain.Entities;

/// <summary>
/// Represents a sequence of related quests forming a narrative chain.
/// </summary>
/// <remarks>
/// QuestChain is an entity that groups ordered quests into a narrative sequence.
/// Completing one quest in the chain automatically unlocks the next, enabling
/// story-driven progression. Chains can have completion bonuses and prerequisites.
/// </remarks>
public class QuestChain
{
    /// <summary>
    /// Gets the unique identifier for this chain instance.
    /// </summary>
    public Guid Id { get; private set; }

    /// <summary>
    /// Gets the definition ID from configuration.
    /// </summary>
    /// <remarks>
    /// This ID matches the chain ID in quest-chains.json.
    /// Used for lookups and persistence.
    /// </remarks>
    public string DefinitionId { get; private set; } = string.Empty;

    /// <summary>
    /// Gets the chain display name.
    /// </summary>
    /// <remarks>
    /// Shown in the quest journal and notifications.
    /// Example: "The Shadow Over Thornwood"
    /// </remarks>
    public string Name { get; private set; } = string.Empty;

    /// <summary>
    /// Gets the chain description.
    /// </summary>
    /// <remarks>
    /// Provides narrative context for the chain.
    /// Displayed when viewing chain details.
    /// </remarks>
    public string Description { get; private set; } = string.Empty;

    /// <summary>
    /// Gets whether this is the main story quest line.
    /// </summary>
    /// <remarks>
    /// Main quest chains receive prominent display treatment
    /// and typically cannot be abandoned.
    /// </remarks>
    public bool IsMainQuest { get; private set; }

    /// <summary>
    /// Gets the ordered quest definition IDs in this chain.
    /// </summary>
    /// <remarks>
    /// Quests must be completed in this order.
    /// Index 0 is the first quest, index n-1 is the last.
    /// </remarks>
    public IReadOnlyList<string> QuestIds { get; private set; } = Array.Empty<string>();

    /// <summary>
    /// Gets the total number of quests in the chain.
    /// </summary>
    public int TotalQuests => QuestIds.Count;

    /// <summary>
    /// Gets bonus rewards granted on chain completion.
    /// </summary>
    /// <remarks>
    /// Awarded when the final quest in the chain is completed.
    /// Separate from individual quest rewards.
    /// </remarks>
    public QuestReward? CompletionBonus { get; private set; }

    /// <summary>
    /// Gets prerequisites for starting the chain.
    /// </summary>
    /// <remarks>
    /// Must be satisfied before the first quest becomes available.
    /// Uses the existing QuestPrerequisite system from v0.3.1c.
    /// </remarks>
    public IReadOnlyList<QuestPrerequisite> Prerequisites { get; private set; } = Array.Empty<QuestPrerequisite>();

    /// <summary>
    /// Private constructor for factory method.
    /// </summary>
    private QuestChain() { }

    /// <summary>
    /// Creates a new quest chain.
    /// </summary>
    /// <param name="definitionId">The configuration ID.</param>
    /// <param name="name">The display name.</param>
    /// <param name="description">The narrative description.</param>
    /// <param name="questIds">The ordered quest definition IDs.</param>
    /// <param name="isMainQuest">Whether this is the main quest line.</param>
    /// <param name="completionBonus">Optional bonus for completing the chain.</param>
    /// <param name="prerequisites">Optional prerequisites for starting.</param>
    /// <returns>A new QuestChain instance.</returns>
    /// <exception cref="ArgumentException">Thrown if required parameters are invalid.</exception>
    public static QuestChain Create(
        string definitionId,
        string name,
        string description,
        IEnumerable<string> questIds,
        bool isMainQuest = false,
        QuestReward? completionBonus = null,
        IEnumerable<QuestPrerequisite>? prerequisites = null)
    {
        ArgumentException.ThrowIfNullOrWhiteSpace(definitionId);
        ArgumentException.ThrowIfNullOrWhiteSpace(name);

        var questList = questIds.ToList();
        if (questList.Count == 0)
            throw new ArgumentException("Quest chain must contain at least one quest.", nameof(questIds));

        // Validate quest IDs are not empty
        foreach (var questId in questList)
        {
            if (string.IsNullOrWhiteSpace(questId))
                throw new ArgumentException("Quest chain cannot contain empty quest IDs.", nameof(questIds));
        }

        return new QuestChain
        {
            Id = Guid.NewGuid(),
            DefinitionId = definitionId.ToLowerInvariant(),
            Name = name,
            Description = description ?? string.Empty,
            QuestIds = questList.Select(q => q.ToLowerInvariant()).ToList(),
            IsMainQuest = isMainQuest,
            CompletionBonus = completionBonus,
            Prerequisites = prerequisites?.ToList() ?? Array.Empty<QuestPrerequisite>()
        };
    }

    /// <summary>
    /// Gets the quest definition ID at a specific position.
    /// </summary>
    /// <param name="order">The 0-based position in the chain.</param>
    /// <returns>The quest definition ID, or null if order is out of range.</returns>
    public string? GetQuestAt(int order)
    {
        if (order < 0 || order >= QuestIds.Count)
            return null;
        return QuestIds[order];
    }

    /// <summary>
    /// Gets the next quest in the chain after the given quest.
    /// </summary>
    /// <param name="currentQuestId">The current quest's definition ID.</param>
    /// <returns>The next quest's definition ID, or null if at end or not found.</returns>
    public string? GetNextQuest(string currentQuestId)
    {
        if (string.IsNullOrWhiteSpace(currentQuestId))
            return null;

        var normalizedId = currentQuestId.ToLowerInvariant();
        var index = -1;

        for (int i = 0; i < QuestIds.Count; i++)
        {
            if (QuestIds[i].Equals(normalizedId, StringComparison.OrdinalIgnoreCase))
            {
                index = i;
                break;
            }
        }

        if (index < 0 || index >= QuestIds.Count - 1)
            return null;

        return QuestIds[index + 1];
    }

    /// <summary>
    /// Gets whether a quest is the first in the chain.
    /// </summary>
    /// <param name="questId">The quest definition ID to check.</param>
    /// <returns>True if this is the first quest in the chain.</returns>
    public bool IsFirstQuest(string questId)
    {
        if (string.IsNullOrWhiteSpace(questId) || QuestIds.Count == 0)
            return false;

        return QuestIds[0].Equals(questId, StringComparison.OrdinalIgnoreCase);
    }

    /// <summary>
    /// Gets whether a quest is the last in the chain.
    /// </summary>
    /// <param name="questId">The quest definition ID to check.</param>
    /// <returns>True if this is the last quest in the chain.</returns>
    public bool IsLastQuest(string questId)
    {
        if (string.IsNullOrWhiteSpace(questId) || QuestIds.Count == 0)
            return false;

        return QuestIds[^1].Equals(questId, StringComparison.OrdinalIgnoreCase);
    }

    /// <summary>
    /// Gets the order/position of a quest in the chain.
    /// </summary>
    /// <param name="questId">The quest definition ID to find.</param>
    /// <returns>The 0-based index, or -1 if not found.</returns>
    public int GetQuestOrder(string questId)
    {
        if (string.IsNullOrWhiteSpace(questId))
            return -1;

        for (int i = 0; i < QuestIds.Count; i++)
        {
            if (QuestIds[i].Equals(questId, StringComparison.OrdinalIgnoreCase))
                return i;
        }

        return -1;
    }

    /// <summary>
    /// Gets whether a quest belongs to this chain.
    /// </summary>
    /// <param name="questId">The quest definition ID to check.</param>
    /// <returns>True if the quest is part of this chain.</returns>
    public bool ContainsQuest(string questId)
    {
        return GetQuestOrder(questId) >= 0;
    }

    /// <summary>
    /// Gets whether chain prerequisites are satisfied.
    /// </summary>
    /// <param name="player">The player to check against.</param>
    /// <returns>True if all prerequisites are met.</returns>
    public bool ArePrerequisitesMet(Player player)
    {
        if (Prerequisites.Count == 0)
            return true;

        foreach (var prerequisite in Prerequisites)
        {
            if (!prerequisite.IsSatisfied(player))
                return false;
        }

        return true;
    }
}
```

### 5.2 Quest Entity Updates

```csharp
// Additions to existing Quest class in RuneAndRust.Domain.Entities

/// <summary>
/// Gets the chain ID if this quest belongs to a chain.
/// </summary>
/// <remarks>
/// Null if the quest is not part of any chain.
/// Set when quest is created from a chain sequence.
/// </remarks>
public string? ChainId { get; private set; }

/// <summary>
/// Gets the 0-based order within the chain.
/// </summary>
/// <remarks>
/// Null if the quest is not part of any chain.
/// 0 = first quest, n-1 = last quest.
/// </remarks>
public int? ChainOrder { get; private set; }

/// <summary>
/// Gets whether this quest is part of a chain.
/// </summary>
public bool IsInChain => !string.IsNullOrEmpty(ChainId);

/// <summary>
/// Gets whether this is the first quest in its chain.
/// </summary>
/// <remarks>
/// First quests typically become available when chain prerequisites are met.
/// </remarks>
public bool IsChainStart => ChainOrder == 0;

/// <summary>
/// Gets whether this is the last quest in its chain.
/// </summary>
/// <remarks>
/// Completing the last quest triggers chain completion bonuses.
/// </remarks>
public bool IsChainEnd { get; private set; }

/// <summary>
/// Sets chain membership for this quest.
/// </summary>
/// <param name="chainId">The chain definition ID.</param>
/// <param name="order">The 0-based position in the chain.</param>
/// <param name="isChainEnd">Whether this is the final quest.</param>
/// <exception cref="ArgumentException">Thrown if chainId is null/empty or order is negative.</exception>
public void SetChainMembership(string chainId, int order, bool isChainEnd = false)
{
    ArgumentException.ThrowIfNullOrWhiteSpace(chainId);

    if (order < 0)
        throw new ArgumentOutOfRangeException(nameof(order), "Chain order cannot be negative.");

    ChainId = chainId.ToLowerInvariant();
    ChainOrder = order;
    IsChainEnd = isChainEnd;
}

/// <summary>
/// Clears chain membership (for standalone quests).
/// </summary>
public void ClearChainMembership()
{
    ChainId = null;
    ChainOrder = null;
    IsChainEnd = false;
}
```

### 5.3 ChainProgress Value Object

```csharp
namespace RuneAndRust.Domain.ValueObjects;

/// <summary>
/// Progress tracking for a quest chain.
/// </summary>
/// <remarks>
/// Immutable record struct representing a player's progress through
/// a specific quest chain at a point in time.
/// </remarks>
public readonly record struct ChainProgress
{
    /// <summary>
    /// Gets the chain definition ID.
    /// </summary>
    public string ChainId { get; init; }

    /// <summary>
    /// Gets the chain display name.
    /// </summary>
    public string ChainName { get; init; }

    /// <summary>
    /// Gets the number of quests completed in this chain.
    /// </summary>
    public int CompletedQuests { get; init; }

    /// <summary>
    /// Gets the total number of quests in the chain.
    /// </summary>
    public int TotalQuests { get; init; }

    /// <summary>
    /// Gets the definition ID of the currently active quest.
    /// </summary>
    /// <remarks>
    /// Null if no quest is currently active (chain not started or complete).
    /// </remarks>
    public string? CurrentQuestId { get; init; }

    /// <summary>
    /// Gets the definition ID of the next quest to unlock.
    /// </summary>
    /// <remarks>
    /// Null if chain is complete or no next quest exists.
    /// </remarks>
    public string? NextQuestId { get; init; }

    /// <summary>
    /// Gets whether the chain is fully complete.
    /// </summary>
    public bool IsComplete { get; init; }

    /// <summary>
    /// Gets whether the chain has been started.
    /// </summary>
    public bool IsStarted => CompletedQuests > 0 || CurrentQuestId != null;

    /// <summary>
    /// Gets the progress as a percentage (0-100).
    /// </summary>
    public float ProgressPercent => TotalQuests > 0
        ? (float)CompletedQuests / TotalQuests * 100
        : 0;

    /// <summary>
    /// Gets a formatted progress display string.
    /// </summary>
    /// <returns>String in format "X/Y" or "Complete".</returns>
    public string GetProgressDisplay() => IsComplete
        ? "Complete"
        : $"{CompletedQuests}/{TotalQuests}";

    /// <summary>
    /// Gets a progress bar string representation.
    /// </summary>
    /// <param name="width">The total width in characters.</param>
    /// <returns>A progress bar string like "[■■■░░░░░]".</returns>
    public string GetProgressBar(int width = 20)
    {
        var filled = TotalQuests > 0
            ? (int)Math.Round((double)CompletedQuests / TotalQuests * width)
            : 0;
        var empty = width - filled;

        return $"[{new string('■', filled)}{new string('░', empty)}]";
    }

    /// <summary>
    /// Creates an empty progress for a chain not yet started.
    /// </summary>
    public static ChainProgress NotStarted(string chainId, string chainName, int totalQuests, string firstQuestId) => new()
    {
        ChainId = chainId,
        ChainName = chainName,
        CompletedQuests = 0,
        TotalQuests = totalQuests,
        CurrentQuestId = null,
        NextQuestId = firstQuestId,
        IsComplete = false
    };

    /// <summary>
    /// Creates a completed progress for a finished chain.
    /// </summary>
    public static ChainProgress Completed(string chainId, string chainName, int totalQuests) => new()
    {
        ChainId = chainId,
        ChainName = chainName,
        CompletedQuests = totalQuests,
        TotalQuests = totalQuests,
        CurrentQuestId = null,
        NextQuestId = null,
        IsComplete = true
    };
}
```

### 5.4 ChainProgressionResult Value Object

```csharp
namespace RuneAndRust.Domain.ValueObjects;

/// <summary>
/// Result of processing quest completion within a chain.
/// </summary>
/// <remarks>
/// Returned by QuestChainService.ProcessQuestCompletion() to indicate
/// what happened as a result of completing a quest that may be in a chain.
/// </remarks>
public readonly record struct ChainProgressionResult
{
    /// <summary>
    /// Gets whether the completed quest was part of a chain.
    /// </summary>
    public bool WasInChain { get; init; }

    /// <summary>
    /// Gets the chain definition ID (if quest was in a chain).
    /// </summary>
    public string? ChainId { get; init; }

    /// <summary>
    /// Gets the quest that was unlocked as a result (if any).
    /// </summary>
    /// <remarks>
    /// Null if no next quest was unlocked (chain complete or not in chain).
    /// </remarks>
    public Quest? UnlockedQuest { get; init; }

    /// <summary>
    /// Gets whether the entire chain was completed.
    /// </summary>
    public bool ChainCompleted { get; init; }

    /// <summary>
    /// Gets the chain completion bonus (if chain was completed).
    /// </summary>
    public QuestReward? ChainBonus { get; init; }

    /// <summary>
    /// Gets whether a new quest was unlocked.
    /// </summary>
    public bool HasUnlockedQuest => UnlockedQuest != null;

    /// <summary>
    /// Gets whether there is a chain bonus to distribute.
    /// </summary>
    public bool HasChainBonus => ChainBonus?.HasRewards == true;

    /// <summary>
    /// Creates a result for a quest that was not in any chain.
    /// </summary>
    public static ChainProgressionResult NotInChain => new()
    {
        WasInChain = false,
        ChainId = null,
        UnlockedQuest = null,
        ChainCompleted = false,
        ChainBonus = null
    };

    /// <summary>
    /// Creates a result for progressing to the next quest in a chain.
    /// </summary>
    public static ChainProgressionResult Progressed(string chainId, Quest unlockedQuest) => new()
    {
        WasInChain = true,
        ChainId = chainId,
        UnlockedQuest = unlockedQuest,
        ChainCompleted = false,
        ChainBonus = null
    };

    /// <summary>
    /// Creates a result for completing a chain.
    /// </summary>
    public static ChainProgressionResult ChainComplete(string chainId, QuestReward? bonus) => new()
    {
        WasInChain = true,
        ChainId = chainId,
        UnlockedQuest = null,
        ChainCompleted = true,
        ChainBonus = bonus
    };
}
```

---

## 6. Configuration Schemas

### 6.1 quest-chains.json

```json
{
  "$schema": "../schemas/quest-chains.schema.json",
  "questChains": [
    {
      "id": "shadow-over-thornwood",
      "name": "The Shadow Over Thornwood",
      "description": "A dark force threatens the village of Thornwood. Uncover the mystery and save the villagers from the encroaching shadow.",
      "isMainQuest": true,
      "questIds": [
        "shadow-chapter-1",
        "shadow-chapter-2",
        "shadow-chapter-3",
        "shadow-chapter-4",
        "shadow-chapter-5"
      ],
      "completionBonus": {
        "entries": [
          { "type": "XP", "amount": 500 },
          { "type": "Item", "targetId": "shadow-cloak", "displayName": "Shadow Cloak" },
          { "type": "Reputation", "targetId": "thornwood-village", "amount": 500, "displayName": "Thornwood Village" }
        ]
      }
    },
    {
      "id": "merchant-guild-intro",
      "name": "Merchant Guild Introduction",
      "description": "Prove your worth to the Merchant Guild through a series of trials.",
      "isMainQuest": false,
      "questIds": [
        "guild-trial-1",
        "guild-trial-2",
        "guild-trial-3"
      ],
      "prerequisites": [
        { "type": "Reputation", "targetId": "merchant-guild", "requiredValue": 100 }
      ],
      "completionBonus": {
        "entries": [
          { "type": "XP", "amount": 200 },
          { "type": "Gold", "amount": 100 },
          { "type": "Unlock", "targetId": "merchant-guild-membership", "displayName": "Merchant Guild Membership" }
        ]
      }
    },
    {
      "id": "dungeon-depths",
      "name": "Depths of the Dungeon",
      "description": "Explore the increasingly dangerous levels of the ancient dungeon.",
      "isMainQuest": false,
      "questIds": [
        "dungeon-level-1",
        "dungeon-level-2",
        "dungeon-level-3",
        "dungeon-boss"
      ],
      "prerequisites": [
        { "type": "Quest", "targetId": "dungeon-intro" }
      ],
      "completionBonus": {
        "entries": [
          { "type": "XP", "amount": 300 },
          { "type": "Item", "targetId": "dungeon-master-key", "displayName": "Dungeon Master Key" }
        ]
      }
    }
  ]
}
```

### 6.2 quest-chains.schema.json

```json
{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "title": "Quest Chain Configuration",
  "description": "Defines quest chains for narrative progression",
  "type": "object",
  "required": ["questChains"],
  "properties": {
    "questChains": {
      "type": "array",
      "description": "List of quest chain definitions",
      "items": {
        "$ref": "#/definitions/questChainDefinition"
      }
    }
  },
  "definitions": {
    "questChainDefinition": {
      "type": "object",
      "required": ["id", "name", "questIds"],
      "properties": {
        "id": {
          "type": "string",
          "pattern": "^[a-z][a-z0-9-]*$",
          "description": "Unique identifier (lowercase, alphanumeric with hyphens)"
        },
        "name": {
          "type": "string",
          "minLength": 1,
          "maxLength": 100,
          "description": "Display name of the quest chain"
        },
        "description": {
          "type": "string",
          "maxLength": 1000,
          "description": "Narrative description of the chain"
        },
        "isMainQuest": {
          "type": "boolean",
          "default": false,
          "description": "Whether this is the main story quest line"
        },
        "questIds": {
          "type": "array",
          "minItems": 1,
          "items": {
            "type": "string",
            "pattern": "^[a-z][a-z0-9-]*$"
          },
          "description": "Ordered list of quest definition IDs in this chain"
        },
        "prerequisites": {
          "type": "array",
          "items": {
            "$ref": "#/definitions/prerequisite"
          },
          "description": "Prerequisites for starting the chain"
        },
        "completionBonus": {
          "$ref": "#/definitions/questReward",
          "description": "Bonus rewards for completing the entire chain"
        }
      }
    },
    "prerequisite": {
      "type": "object",
      "required": ["type"],
      "properties": {
        "type": {
          "type": "string",
          "enum": ["Quest", "Level", "Reputation", "Item"],
          "description": "Type of prerequisite"
        },
        "targetId": {
          "type": "string",
          "pattern": "^[a-z][a-z0-9-]*$",
          "description": "Target ID (quest ID, faction ID, item ID)"
        },
        "requiredValue": {
          "type": "integer",
          "description": "Required value (level, reputation amount)"
        }
      },
      "allOf": [
        {
          "if": {
            "properties": { "type": { "const": "Quest" } }
          },
          "then": {
            "required": ["targetId"]
          }
        },
        {
          "if": {
            "properties": { "type": { "const": "Level" } }
          },
          "then": {
            "required": ["requiredValue"]
          }
        },
        {
          "if": {
            "properties": { "type": { "const": "Reputation" } }
          },
          "then": {
            "required": ["targetId", "requiredValue"]
          }
        },
        {
          "if": {
            "properties": { "type": { "const": "Item" } }
          },
          "then": {
            "required": ["targetId"]
          }
        }
      ]
    },
    "questReward": {
      "type": "object",
      "required": ["entries"],
      "properties": {
        "entries": {
          "type": "array",
          "items": {
            "$ref": "#/definitions/rewardEntry"
          },
          "description": "Individual reward entries"
        }
      }
    },
    "rewardEntry": {
      "type": "object",
      "required": ["type"],
      "properties": {
        "type": {
          "type": "string",
          "enum": ["XP", "Gold", "Item", "Reputation", "Unlock"],
          "description": "Type of reward"
        },
        "amount": {
          "type": "integer",
          "description": "Amount (XP, gold, quantity, reputation change)"
        },
        "targetId": {
          "type": "string",
          "pattern": "^[a-z][a-z0-9-]*$",
          "description": "Target ID (item ID, faction ID, unlock ID)"
        },
        "displayName": {
          "type": ["string", "null"],
          "description": "Display name override"
        }
      }
    }
  }
}
```

---

## 7. Service Specifications

### 7.1 IQuestChainService Interface

```csharp
namespace RuneAndRust.Application.Interfaces;

/// <summary>
/// Service for managing quest chains and progression.
/// </summary>
public interface IQuestChainService
{
    /// <summary>
    /// Gets a chain by its definition ID.
    /// </summary>
    /// <param name="chainId">The chain definition ID.</param>
    /// <returns>The chain, or null if not found.</returns>
    QuestChain? GetChain(string chainId);

    /// <summary>
    /// Gets the main quest chain.
    /// </summary>
    /// <returns>The main quest chain, or null if none exists.</returns>
    /// <remarks>
    /// Returns the first chain marked as IsMainQuest.
    /// </remarks>
    QuestChain? GetMainQuestChain();

    /// <summary>
    /// Gets all quest chains.
    /// </summary>
    /// <returns>All configured quest chains.</returns>
    IEnumerable<QuestChain> GetAllChains();

    /// <summary>
    /// Gets chains available to a player.
    /// </summary>
    /// <param name="player">The player to check against.</param>
    /// <returns>Chains whose prerequisites are met.</returns>
    IEnumerable<QuestChain> GetAvailableChains(Player player);

    /// <summary>
    /// Gets the player's progress in a specific chain.
    /// </summary>
    /// <param name="player">The player.</param>
    /// <param name="chainId">The chain definition ID.</param>
    /// <returns>The player's progress in the chain.</returns>
    ChainProgress GetChainProgress(Player player, string chainId);

    /// <summary>
    /// Gets progress for all chains the player has started.
    /// </summary>
    /// <param name="player">The player.</param>
    /// <returns>Progress for all in-progress or completed chains.</returns>
    IEnumerable<ChainProgress> GetAllChainProgress(Player player);

    /// <summary>
    /// Handles quest completion within a chain context.
    /// </summary>
    /// <param name="player">The player who completed the quest.</param>
    /// <param name="quest">The completed quest.</param>
    /// <returns>The result of chain progression.</returns>
    /// <remarks>
    /// If the quest is in a chain, this method unlocks the next quest
    /// or returns the chain completion bonus.
    /// </remarks>
    ChainProgressionResult ProcessQuestCompletion(Player player, Quest quest);

    /// <summary>
    /// Unlocks the next quest in a chain for a player.
    /// </summary>
    /// <param name="player">The player.</param>
    /// <param name="chain">The quest chain.</param>
    /// <param name="completedQuestId">The ID of the completed quest.</param>
    /// <returns>The newly unlocked quest, or null if chain is complete.</returns>
    Quest? UnlockNextQuest(Player player, QuestChain chain, string completedQuestId);

    /// <summary>
    /// Checks if a player has completed a chain.
    /// </summary>
    /// <param name="player">The player.</param>
    /// <param name="chainId">The chain definition ID.</param>
    /// <returns>True if all quests in the chain are complete.</returns>
    bool HasCompletedChain(Player player, string chainId);

    /// <summary>
    /// Gets the completion bonus for a chain.
    /// </summary>
    /// <param name="chainId">The chain definition ID.</param>
    /// <returns>The completion bonus, or null if none.</returns>
    QuestReward? GetChainCompletionBonus(string chainId);

    /// <summary>
    /// Finds the chain that contains a specific quest.
    /// </summary>
    /// <param name="questDefinitionId">The quest definition ID.</param>
    /// <returns>The containing chain, or null if quest is not in any chain.</returns>
    QuestChain? FindChainForQuest(string questDefinitionId);

    /// <summary>
    /// Starts a chain for a player by making the first quest available.
    /// </summary>
    /// <param name="player">The player.</param>
    /// <param name="chainId">The chain definition ID.</param>
    /// <returns>The first quest in the chain, or null if prerequisites not met.</returns>
    Quest? StartChain(Player player, string chainId);
}
```

### 7.2 QuestChainService Implementation

```csharp
namespace RuneAndRust.Application.Services;

/// <summary>
/// Service for managing quest chains and progression.
/// </summary>
public class QuestChainService : IQuestChainService
{
    private readonly IConfigurationProvider _configurationProvider;
    private readonly IQuestService _questService;
    private readonly ILogger<QuestChainService> _logger;
    private readonly Dictionary<string, QuestChain> _chains;
    private readonly Dictionary<string, string> _questToChainMap;

    public QuestChainService(
        IConfigurationProvider configurationProvider,
        IQuestService questService,
        ILogger<QuestChainService> logger)
    {
        _configurationProvider = configurationProvider;
        _questService = questService;
        _logger = logger;
        _chains = new Dictionary<string, QuestChain>(StringComparer.OrdinalIgnoreCase);
        _questToChainMap = new Dictionary<string, string>(StringComparer.OrdinalIgnoreCase);

        LoadChains();
    }

    private void LoadChains()
    {
        var chainDefinitions = _configurationProvider.LoadQuestChainDefinitions();

        foreach (var chain in chainDefinitions)
        {
            _chains[chain.DefinitionId] = chain;

            // Build reverse lookup
            foreach (var questId in chain.QuestIds)
            {
                _questToChainMap[questId] = chain.DefinitionId;
            }

            _logger.LogDebug(
                "Loaded quest chain '{ChainId}' with {QuestCount} quests",
                chain.DefinitionId, chain.TotalQuests);
        }

        _logger.LogInformation("Loaded {ChainCount} quest chains", _chains.Count);
    }

    /// <inheritdoc />
    public QuestChain? GetChain(string chainId)
    {
        if (string.IsNullOrWhiteSpace(chainId))
            return null;

        return _chains.TryGetValue(chainId, out var chain) ? chain : null;
    }

    /// <inheritdoc />
    public QuestChain? GetMainQuestChain()
    {
        return _chains.Values.FirstOrDefault(c => c.IsMainQuest);
    }

    /// <inheritdoc />
    public IEnumerable<QuestChain> GetAllChains()
    {
        return _chains.Values;
    }

    /// <inheritdoc />
    public IEnumerable<QuestChain> GetAvailableChains(Player player)
    {
        ArgumentNullException.ThrowIfNull(player);

        return _chains.Values.Where(c => c.ArePrerequisitesMet(player));
    }

    /// <inheritdoc />
    public ChainProgress GetChainProgress(Player player, string chainId)
    {
        ArgumentNullException.ThrowIfNull(player);
        ArgumentException.ThrowIfNullOrWhiteSpace(chainId);

        var chain = GetChain(chainId);
        if (chain == null)
        {
            return new ChainProgress
            {
                ChainId = chainId,
                ChainName = "Unknown Chain",
                CompletedQuests = 0,
                TotalQuests = 0,
                IsComplete = false
            };
        }

        var completedCount = 0;
        string? currentQuestId = null;
        string? nextQuestId = null;

        foreach (var questId in chain.QuestIds)
        {
            if (player.HasCompletedQuest(questId))
            {
                completedCount++;
            }
            else if (currentQuestId == null)
            {
                // First non-completed quest is current
                var activeQuest = player.ActiveQuests
                    .FirstOrDefault(q => q.DefinitionId.Equals(questId, StringComparison.OrdinalIgnoreCase));

                if (activeQuest != null)
                {
                    currentQuestId = questId;
                    nextQuestId = chain.GetNextQuest(questId);
                }
                else
                {
                    nextQuestId = questId; // This quest needs to be unlocked
                }
                break;
            }
        }

        var isComplete = completedCount == chain.TotalQuests;

        return new ChainProgress
        {
            ChainId = chain.DefinitionId,
            ChainName = chain.Name,
            CompletedQuests = completedCount,
            TotalQuests = chain.TotalQuests,
            CurrentQuestId = currentQuestId,
            NextQuestId = isComplete ? null : nextQuestId,
            IsComplete = isComplete
        };
    }

    /// <inheritdoc />
    public IEnumerable<ChainProgress> GetAllChainProgress(Player player)
    {
        ArgumentNullException.ThrowIfNull(player);

        return _chains.Keys.Select(chainId => GetChainProgress(player, chainId));
    }

    /// <inheritdoc />
    public ChainProgressionResult ProcessQuestCompletion(Player player, Quest quest)
    {
        ArgumentNullException.ThrowIfNull(player);
        ArgumentNullException.ThrowIfNull(quest);

        // Check if quest is in a chain
        if (!quest.IsInChain || string.IsNullOrEmpty(quest.ChainId))
        {
            _logger.LogDebug("Quest '{QuestId}' is not in a chain", quest.DefinitionId);
            return ChainProgressionResult.NotInChain;
        }

        var chain = GetChain(quest.ChainId);
        if (chain == null)
        {
            _logger.LogWarning(
                "Quest '{QuestId}' references unknown chain '{ChainId}'",
                quest.DefinitionId, quest.ChainId);
            return ChainProgressionResult.NotInChain;
        }

        _logger.LogDebug(
            "Processing chain completion for quest '{QuestId}' in chain '{ChainId}'",
            quest.DefinitionId, chain.DefinitionId);

        // Check if this is the last quest
        if (quest.IsChainEnd || chain.IsLastQuest(quest.DefinitionId))
        {
            _logger.LogInformation(
                "Player completed chain '{ChainId}' with final quest '{QuestId}'",
                chain.DefinitionId, quest.DefinitionId);

            return ChainProgressionResult.ChainComplete(chain.DefinitionId, chain.CompletionBonus);
        }

        // Unlock next quest
        var unlockedQuest = UnlockNextQuest(player, chain, quest.DefinitionId);

        if (unlockedQuest != null)
        {
            _logger.LogInformation(
                "Unlocked next quest '{NextQuestId}' in chain '{ChainId}'",
                unlockedQuest.DefinitionId, chain.DefinitionId);

            return ChainProgressionResult.Progressed(chain.DefinitionId, unlockedQuest);
        }

        // No next quest found (shouldn't happen for non-final quests)
        _logger.LogWarning(
            "No next quest found for '{QuestId}' in chain '{ChainId}'",
            quest.DefinitionId, chain.DefinitionId);

        return ChainProgressionResult.NotInChain;
    }

    /// <inheritdoc />
    public Quest? UnlockNextQuest(Player player, QuestChain chain, string completedQuestId)
    {
        ArgumentNullException.ThrowIfNull(player);
        ArgumentNullException.ThrowIfNull(chain);

        var nextQuestId = chain.GetNextQuest(completedQuestId);
        if (string.IsNullOrEmpty(nextQuestId))
        {
            return null;
        }

        // Create and assign the next quest
        var quest = _questService.CreateQuestFromDefinition(nextQuestId);
        if (quest == null)
        {
            _logger.LogWarning(
                "Failed to create quest '{QuestId}' from definition",
                nextQuestId);
            return null;
        }

        // Set chain membership
        var order = chain.GetQuestOrder(nextQuestId);
        var isEnd = chain.IsLastQuest(nextQuestId);
        quest.SetChainMembership(chain.DefinitionId, order, isEnd);

        // Assign to player
        player.AddQuest(quest);

        return quest;
    }

    /// <inheritdoc />
    public bool HasCompletedChain(Player player, string chainId)
    {
        ArgumentNullException.ThrowIfNull(player);

        var chain = GetChain(chainId);
        if (chain == null)
            return false;

        return chain.QuestIds.All(qid => player.HasCompletedQuest(qid));
    }

    /// <inheritdoc />
    public QuestReward? GetChainCompletionBonus(string chainId)
    {
        return GetChain(chainId)?.CompletionBonus;
    }

    /// <inheritdoc />
    public QuestChain? FindChainForQuest(string questDefinitionId)
    {
        if (string.IsNullOrWhiteSpace(questDefinitionId))
            return null;

        if (_questToChainMap.TryGetValue(questDefinitionId, out var chainId))
        {
            return GetChain(chainId);
        }

        return null;
    }

    /// <inheritdoc />
    public Quest? StartChain(Player player, string chainId)
    {
        ArgumentNullException.ThrowIfNull(player);
        ArgumentException.ThrowIfNullOrWhiteSpace(chainId);

        var chain = GetChain(chainId);
        if (chain == null)
        {
            _logger.LogWarning("Cannot start unknown chain '{ChainId}'", chainId);
            return null;
        }

        if (!chain.ArePrerequisitesMet(player))
        {
            _logger.LogDebug(
                "Cannot start chain '{ChainId}' - prerequisites not met",
                chainId);
            return null;
        }

        var firstQuestId = chain.GetQuestAt(0);
        if (string.IsNullOrEmpty(firstQuestId))
        {
            return null;
        }

        // Check if already started
        if (player.ActiveQuests.Any(q => q.ChainId == chainId) ||
            player.HasCompletedQuest(firstQuestId))
        {
            _logger.LogDebug("Chain '{ChainId}' already started", chainId);
            return null;
        }

        // Create first quest
        var quest = _questService.CreateQuestFromDefinition(firstQuestId);
        if (quest == null)
        {
            return null;
        }

        quest.SetChainMembership(chain.DefinitionId, 0, chain.TotalQuests == 1);
        player.AddQuest(quest);

        _logger.LogInformation(
            "Started chain '{ChainId}' for player with quest '{QuestId}'",
            chainId, firstQuestId);

        return quest;
    }
}
```

### 7.3 Configuration DTOs

```csharp
namespace RuneAndRust.Application.Configuration;

/// <summary>
/// DTO for quest chain configuration in quest-chains.json.
/// </summary>
public class QuestChainConfigDto
{
    /// <summary>
    /// Gets or sets the chain ID.
    /// </summary>
    public string Id { get; set; } = string.Empty;

    /// <summary>
    /// Gets or sets the chain name.
    /// </summary>
    public string Name { get; set; } = string.Empty;

    /// <summary>
    /// Gets or sets the chain description.
    /// </summary>
    public string Description { get; set; } = string.Empty;

    /// <summary>
    /// Gets or sets whether this is the main quest.
    /// </summary>
    public bool IsMainQuest { get; set; }

    /// <summary>
    /// Gets or sets the ordered quest IDs.
    /// </summary>
    public List<string> QuestIds { get; set; } = new();

    /// <summary>
    /// Gets or sets the chain prerequisites.
    /// </summary>
    public List<PrerequisiteConfigDto>? Prerequisites { get; set; }

    /// <summary>
    /// Gets or sets the completion bonus.
    /// </summary>
    public RewardConfigDto? CompletionBonus { get; set; }
}

/// <summary>
/// Root configuration object for quest-chains.json.
/// </summary>
public class QuestChainsConfigDto
{
    /// <summary>
    /// Gets or sets the list of quest chains.
    /// </summary>
    public List<QuestChainConfigDto> QuestChains { get; set; } = new();
}
```

### 7.4 Application DTOs

```csharp
namespace RuneAndRust.Application.DTOs;

/// <summary>
/// DTO for chain progress display.
/// </summary>
/// <param name="ChainId">The chain definition ID.</param>
/// <param name="ChainName">The chain display name.</param>
/// <param name="CompletedQuests">Number of completed quests.</param>
/// <param name="TotalQuests">Total quests in chain.</param>
/// <param name="CurrentQuestName">Current active quest name.</param>
/// <param name="NextQuestName">Next quest to unlock.</param>
/// <param name="IsComplete">Whether chain is complete.</param>
/// <param name="ProgressPercent">Progress percentage (0-100).</param>
/// <param name="IsMainQuest">Whether this is the main quest chain.</param>
/// <param name="CompletionBonus">Preview of completion bonus.</param>
public record ChainProgressDto(
    string ChainId,
    string ChainName,
    int CompletedQuests,
    int TotalQuests,
    string? CurrentQuestName,
    string? NextQuestName,
    bool IsComplete,
    float ProgressPercent,
    bool IsMainQuest,
    RewardDisplayDto? CompletionBonus)
{
    /// <summary>
    /// Gets the formatted progress string.
    /// </summary>
    public string ProgressDisplay => IsComplete ? "Complete" : $"{CompletedQuests}/{TotalQuests}";
}

/// <summary>
/// DTO for chain membership information on a quest.
/// </summary>
/// <param name="ChainId">The chain definition ID.</param>
/// <param name="ChainName">The chain display name.</param>
/// <param name="QuestNumber">1-based quest number for display.</param>
/// <param name="TotalInChain">Total quests in the chain.</param>
/// <param name="IsMainQuest">Whether this is a main quest chain.</param>
/// <param name="ChainCompletionBonus">Preview of chain completion bonus.</param>
public record ChainMembershipDto(
    string ChainId,
    string ChainName,
    int QuestNumber,
    int TotalInChain,
    bool IsMainQuest,
    RewardDisplayDto? ChainCompletionBonus)
{
    /// <summary>
    /// Gets the formatted position string.
    /// </summary>
    public string PositionDisplay => $"Quest {QuestNumber} of {TotalInChain}";
}
```

### 7.5 QuestDetailDto Updates

```csharp
// Updates to existing QuestDetailDto

/// <summary>
/// Detailed information about a quest for display.
/// </summary>
public record QuestDetailDto(
    Guid Id,
    string Name,
    string Description,
    string Status,
    int Progress,
    IReadOnlyList<ObjectiveSummaryDto> Objectives,
    string? Hint,
    string? GiverName,
    string? TurnInName,
    DateTime? AcceptedAt,
    RewardDisplayDto Rewards,
    RewardDisplayDto? BonusRewards,
    ChainMembershipDto? ChainInfo);    // NEW
```

---

## 8. User-Facing Changes

### 8.1 Quest Journal with Chains

```
┌─────────────────────────────────────────────────────────────┐
│                    QUEST JOURNAL                            │
├─────────────────────────────────────────────────────────────┤
│  [MAIN QUEST]                                   Progress    │
│  ───────────────────────────────────────────────────────────│
│  The Shadow Over Thornwood                       (2/5)      │
│    ► Into the Dark Forest [ACTIVE]                          │
│      Investigate the source of the corruption               │
│                                                             │
│  [SIDE QUESTS]                                              │
│  ───────────────────────────────────────────────────────────│
│  Merchant Guild Introduction                     (0/3)      │
│    [LOCKED] Requires: Merchant Guild reputation 100+        │
│                                                             │
│  Depths of the Dungeon                           (1/4)      │
│    ► Dungeon Level 2 [ACTIVE]                               │
│                                                             │
│  [STANDALONE QUESTS]                                        │
│  ───────────────────────────────────────────────────────────│
│  The Goblin Menace                               [COMPLETE] │
│  Lost Heirloom                                   [ACTIVE]   │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### 8.2 Quest Detail View with Chain Info

```
> quest "Into the Dark Forest"

┌─────────────────────────────────────────────────────────────┐
│                  INTO THE DARK FOREST                       │
├─────────────────────────────────────────────────────────────┤
│  Chain: The Shadow Over Thornwood  (Quest 2 of 5)           │
│  Status: Active                                             │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  The hermit spoke of a darkness spreading from deep within  │
│  the forest. Travel to the Corrupted Grove and discover     │
│  what lurks there.                                          │
│                                                             │
├─────────────────────────────────────────────────────────────┤
│  OBJECTIVES                                                 │
│  • Reach the Corrupted Grove                      [  ]      │
│  • Investigate the source of corruption           [  ]      │
│                                                             │
├─────────────────────────────────────────────────────────────┤
│  REWARDS                                                    │
│  • 100 XP                                                   │
│  • 50 gold                                                  │
│                                                             │
│  CHAIN COMPLETION BONUS (complete all 5 quests)             │
│  • 500 XP                                                   │
│  • Shadow Cloak (Unique Item)                               │
│  • +500 Thornwood Village reputation                        │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### 8.3 Chain Progression Notification

```
=== QUEST COMPLETE ===
Into the Dark Forest

REWARDS RECEIVED:
  + 100 XP
  + 50 gold

═══════════════════════════════════════════════════════════════
CHAIN PROGRESS: The Shadow Over Thornwood
  [■■■■■■■■░░░░░░░░░░░░] 40% (2/5)

NEW QUEST UNLOCKED:
  "The Heart of Corruption"
  The source has been found - a corrupted druid who must be
  confronted.

═══════════════════════════════════════════════════════════════
```

### 8.4 Chain Completion Notification

```
═══════════════════════════════════════════════════════════════
                    QUEST CHAIN COMPLETE!
═══════════════════════════════════════════════════════════════

  "The Shadow Over Thornwood"

  You have completed the main story quest line!

CHAIN COMPLETION BONUS:
  + 500 XP
  + Shadow Cloak
  + 500 Thornwood Village reputation

═══════════════════════════════════════════════════════════════
```

---

## 9. Logging Requirements

### 9.1 Log Events

| Event | Level | Message Template | Properties |
|-------|-------|------------------|------------|
| Chain Loaded | Debug | "Loaded quest chain '{ChainId}' with {QuestCount} quests" | ChainId, QuestCount |
| Chains Loaded | Info | "Loaded {ChainCount} quest chains" | ChainCount |
| Chain Started | Info | "Started chain '{ChainId}' for player with quest '{QuestId}'" | ChainId, QuestId |
| Quest Unlocked | Info | "Unlocked next quest '{NextQuestId}' in chain '{ChainId}'" | NextQuestId, ChainId |
| Chain Completed | Info | "Player completed chain '{ChainId}' with final quest '{QuestId}'" | ChainId, QuestId |
| Chain Progress | Debug | "Processing chain completion for quest '{QuestId}' in chain '{ChainId}'" | QuestId, ChainId |
| Unknown Chain | Warning | "Quest '{QuestId}' references unknown chain '{ChainId}'" | QuestId, ChainId |
| No Next Quest | Warning | "No next quest found for '{QuestId}' in chain '{ChainId}'" | QuestId, ChainId |
| Quest Creation Failed | Warning | "Failed to create quest '{QuestId}' from definition" | QuestId |
| Prerequisites Not Met | Debug | "Cannot start chain '{ChainId}' - prerequisites not met" | ChainId |

### 9.2 Example Log Output

```
[2024-01-20 14:30:15 DBG] Loaded quest chain 'shadow-over-thornwood' with 5 quests
[2024-01-20 14:30:15 DBG] Loaded quest chain 'merchant-guild-intro' with 3 quests
[2024-01-20 14:30:15 INF] Loaded 3 quest chains
[2024-01-20 15:45:22 INF] Started chain 'shadow-over-thornwood' for player with quest 'shadow-chapter-1'
[2024-01-20 16:30:45 DBG] Processing chain completion for quest 'shadow-chapter-1' in chain 'shadow-over-thornwood'
[2024-01-20 16:30:45 INF] Unlocked next quest 'shadow-chapter-2' in chain 'shadow-over-thornwood'
[2024-01-20 18:15:30 INF] Player completed chain 'shadow-over-thornwood' with final quest 'shadow-chapter-5'
```

---

## 10. Unit Test Specifications

### 10.1 QuestChain Entity Tests (~10 tests)

```csharp
namespace RuneAndRust.Domain.Tests.Entities;

[TestFixture]
public class QuestChainTests
{
    [Test]
    public void Create_WithValidParameters_CreatesChain()
    {
        var questIds = new[] { "quest-1", "quest-2", "quest-3" };

        var chain = QuestChain.Create(
            "test-chain",
            "Test Chain",
            "A test chain",
            questIds);

        chain.DefinitionId.Should().Be("test-chain");
        chain.Name.Should().Be("Test Chain");
        chain.TotalQuests.Should().Be(3);
        chain.IsMainQuest.Should().BeFalse();
    }

    [Test]
    public void Create_WithEmptyQuestIds_ThrowsArgumentException()
    {
        var act = () => QuestChain.Create(
            "test-chain",
            "Test Chain",
            "A test chain",
            Array.Empty<string>());

        act.Should().Throw<ArgumentException>()
            .WithMessage("*at least one quest*");
    }

    [Test]
    public void Create_WithNullOrEmptyId_ThrowsArgumentException()
    {
        var act = () => QuestChain.Create(
            "",
            "Test Chain",
            "A test chain",
            new[] { "quest-1" });

        act.Should().Throw<ArgumentException>();
    }

    [Test]
    public void GetQuestAt_WithValidOrder_ReturnsQuestId()
    {
        var chain = CreateTestChain();

        var questId = chain.GetQuestAt(1);

        questId.Should().Be("quest-2");
    }

    [Test]
    public void GetQuestAt_WithInvalidOrder_ReturnsNull()
    {
        var chain = CreateTestChain();

        chain.GetQuestAt(-1).Should().BeNull();
        chain.GetQuestAt(10).Should().BeNull();
    }

    [Test]
    public void GetNextQuest_WithValidCurrentQuest_ReturnsNextQuestId()
    {
        var chain = CreateTestChain();

        var nextId = chain.GetNextQuest("quest-2");

        nextId.Should().Be("quest-3");
    }

    [Test]
    public void GetNextQuest_WithLastQuest_ReturnsNull()
    {
        var chain = CreateTestChain();

        var nextId = chain.GetNextQuest("quest-3");

        nextId.Should().BeNull();
    }

    [Test]
    public void IsFirstQuest_WithFirstQuest_ReturnsTrue()
    {
        var chain = CreateTestChain();

        chain.IsFirstQuest("quest-1").Should().BeTrue();
        chain.IsFirstQuest("quest-2").Should().BeFalse();
    }

    [Test]
    public void IsLastQuest_WithLastQuest_ReturnsTrue()
    {
        var chain = CreateTestChain();

        chain.IsLastQuest("quest-3").Should().BeTrue();
        chain.IsLastQuest("quest-2").Should().BeFalse();
    }

    [Test]
    public void GetQuestOrder_ReturnsCorrectIndex()
    {
        var chain = CreateTestChain();

        chain.GetQuestOrder("quest-1").Should().Be(0);
        chain.GetQuestOrder("quest-2").Should().Be(1);
        chain.GetQuestOrder("quest-3").Should().Be(2);
        chain.GetQuestOrder("unknown").Should().Be(-1);
    }

    private QuestChain CreateTestChain()
    {
        return QuestChain.Create(
            "test-chain",
            "Test Chain",
            "A test chain",
            new[] { "quest-1", "quest-2", "quest-3" });
    }
}
```

### 10.2 ChainProgress Value Object Tests (~5 tests)

```csharp
[TestFixture]
public class ChainProgressTests
{
    [Test]
    public void ProgressPercent_CalculatesCorrectly()
    {
        var progress = new ChainProgress
        {
            ChainId = "test",
            ChainName = "Test",
            CompletedQuests = 2,
            TotalQuests = 5,
            IsComplete = false
        };

        progress.ProgressPercent.Should().Be(40f);
    }

    [Test]
    public void ProgressPercent_WithZeroTotal_ReturnsZero()
    {
        var progress = new ChainProgress
        {
            TotalQuests = 0,
            CompletedQuests = 0
        };

        progress.ProgressPercent.Should().Be(0);
    }

    [Test]
    public void GetProgressDisplay_WhenComplete_ReturnsComplete()
    {
        var progress = ChainProgress.Completed("test", "Test", 5);

        progress.GetProgressDisplay().Should().Be("Complete");
    }

    [Test]
    public void GetProgressDisplay_WhenNotComplete_ReturnsRatio()
    {
        var progress = new ChainProgress
        {
            CompletedQuests = 2,
            TotalQuests = 5,
            IsComplete = false
        };

        progress.GetProgressDisplay().Should().Be("2/5");
    }

    [Test]
    public void IsStarted_WithCompletedQuests_ReturnsTrue()
    {
        var progress = new ChainProgress
        {
            CompletedQuests = 1,
            TotalQuests = 3
        };

        progress.IsStarted.Should().BeTrue();
    }
}
```

### 10.3 Quest Chain Membership Tests (~5 tests)

```csharp
[TestFixture]
public class QuestChainMembershipTests
{
    [Test]
    public void SetChainMembership_SetsAllProperties()
    {
        var quest = CreateTestQuest();

        quest.SetChainMembership("test-chain", 2, isChainEnd: true);

        quest.ChainId.Should().Be("test-chain");
        quest.ChainOrder.Should().Be(2);
        quest.IsChainEnd.Should().BeTrue();
        quest.IsInChain.Should().BeTrue();
    }

    [Test]
    public void IsChainStart_WhenOrderZero_ReturnsTrue()
    {
        var quest = CreateTestQuest();
        quest.SetChainMembership("test-chain", 0);

        quest.IsChainStart.Should().BeTrue();
    }

    [Test]
    public void IsInChain_WhenNoChain_ReturnsFalse()
    {
        var quest = CreateTestQuest();

        quest.IsInChain.Should().BeFalse();
    }

    [Test]
    public void SetChainMembership_WithNegativeOrder_ThrowsArgumentOutOfRange()
    {
        var quest = CreateTestQuest();

        var act = () => quest.SetChainMembership("test-chain", -1);

        act.Should().Throw<ArgumentOutOfRangeException>();
    }

    [Test]
    public void ClearChainMembership_RemovesChainInfo()
    {
        var quest = CreateTestQuest();
        quest.SetChainMembership("test-chain", 1);

        quest.ClearChainMembership();

        quest.IsInChain.Should().BeFalse();
        quest.ChainId.Should().BeNull();
        quest.ChainOrder.Should().BeNull();
    }

    private Quest CreateTestQuest()
    {
        var definition = QuestDefinition.Create(
            "test-quest",
            "Test Quest",
            "A test quest.",
            Array.Empty<ObjectiveDefinition>());

        return Quest.Create(definition, Guid.NewGuid());
    }
}
```

### 10.4 QuestChainService Tests (~10 tests)

```csharp
[TestFixture]
public class QuestChainServiceTests
{
    private Mock<IConfigurationProvider> _configProviderMock;
    private Mock<IQuestService> _questServiceMock;
    private Mock<ILogger<QuestChainService>> _loggerMock;
    private QuestChainService _service;

    [SetUp]
    public void SetUp()
    {
        _configProviderMock = new Mock<IConfigurationProvider>();
        _questServiceMock = new Mock<IQuestService>();
        _loggerMock = new Mock<ILogger<QuestChainService>>();

        var testChains = new[]
        {
            QuestChain.Create(
                "main-chain",
                "Main Chain",
                "The main quest",
                new[] { "main-1", "main-2", "main-3" },
                isMainQuest: true),
            QuestChain.Create(
                "side-chain",
                "Side Chain",
                "A side quest",
                new[] { "side-1", "side-2" })
        };

        _configProviderMock
            .Setup(x => x.LoadQuestChainDefinitions())
            .Returns(testChains);

        _service = new QuestChainService(
            _configProviderMock.Object,
            _questServiceMock.Object,
            _loggerMock.Object);
    }

    [Test]
    public void GetChain_WithValidId_ReturnsChain()
    {
        var chain = _service.GetChain("main-chain");

        chain.Should().NotBeNull();
        chain!.Name.Should().Be("Main Chain");
    }

    [Test]
    public void GetChain_WithInvalidId_ReturnsNull()
    {
        var chain = _service.GetChain("unknown");

        chain.Should().BeNull();
    }

    [Test]
    public void GetMainQuestChain_ReturnsMainQuest()
    {
        var chain = _service.GetMainQuestChain();

        chain.Should().NotBeNull();
        chain!.IsMainQuest.Should().BeTrue();
        chain.DefinitionId.Should().Be("main-chain");
    }

    [Test]
    public void FindChainForQuest_WithChainQuest_ReturnsChain()
    {
        var chain = _service.FindChainForQuest("main-2");

        chain.Should().NotBeNull();
        chain!.DefinitionId.Should().Be("main-chain");
    }

    [Test]
    public void FindChainForQuest_WithStandaloneQuest_ReturnsNull()
    {
        var chain = _service.FindChainForQuest("standalone-quest");

        chain.Should().BeNull();
    }

    [Test]
    public void ProcessQuestCompletion_WithNonChainQuest_ReturnsNotInChain()
    {
        var player = CreateTestPlayer();
        var quest = CreateTestQuest("standalone");

        var result = _service.ProcessQuestCompletion(player, quest);

        result.WasInChain.Should().BeFalse();
    }

    [Test]
    public void ProcessQuestCompletion_WithMidChainQuest_UnlocksNextQuest()
    {
        var player = CreateTestPlayer();
        var quest = CreateTestQuest("main-1");
        quest.SetChainMembership("main-chain", 0);

        var nextQuest = CreateTestQuest("main-2");
        _questServiceMock
            .Setup(x => x.CreateQuestFromDefinition("main-2"))
            .Returns(nextQuest);

        var result = _service.ProcessQuestCompletion(player, quest);

        result.WasInChain.Should().BeTrue();
        result.HasUnlockedQuest.Should().BeTrue();
        result.ChainCompleted.Should().BeFalse();
    }

    [Test]
    public void ProcessQuestCompletion_WithFinalChainQuest_ReturnsChainComplete()
    {
        var player = CreateTestPlayer();
        var quest = CreateTestQuest("main-3");
        quest.SetChainMembership("main-chain", 2, isChainEnd: true);

        var result = _service.ProcessQuestCompletion(player, quest);

        result.WasInChain.Should().BeTrue();
        result.ChainCompleted.Should().BeTrue();
        result.UnlockedQuest.Should().BeNull();
    }

    [Test]
    public void HasCompletedChain_WhenAllComplete_ReturnsTrue()
    {
        var player = CreateTestPlayer();
        player.CompletedQuestIds.Add("side-1");
        player.CompletedQuestIds.Add("side-2");

        var result = _service.HasCompletedChain(player, "side-chain");

        result.Should().BeTrue();
    }

    [Test]
    public void GetChainProgress_ReturnsCorrectProgress()
    {
        var player = CreateTestPlayer();
        player.CompletedQuestIds.Add("main-1");

        var progress = _service.GetChainProgress(player, "main-chain");

        progress.CompletedQuests.Should().Be(1);
        progress.TotalQuests.Should().Be(3);
        progress.IsComplete.Should().BeFalse();
    }

    private Player CreateTestPlayer() => new Player { Id = Guid.NewGuid() };

    private Quest CreateTestQuest(string definitionId)
    {
        var definition = QuestDefinition.Create(
            definitionId,
            "Test Quest",
            "A test quest.",
            Array.Empty<ObjectiveDefinition>());

        return Quest.Create(definition, Guid.NewGuid());
    }
}
```

---

## 11. Use Cases

### UC-001: Configure Quest Chain
**Actor:** Game Designer (via configuration)
**Flow:** Edit quest-chains.json → Define chain with ordered quest IDs → Add completion bonus → Validate schema → Configuration loaded

### UC-002: Start Quest Chain
**Actor:** Player
**Flow:** Meet chain prerequisites → First quest becomes available → Accept first quest → Chain tracking begins

### UC-003: Progress Through Chain
**Actor:** Player
**Flow:** Complete chain quest → System detects chain membership → Next quest unlocked → Progress notification displayed → Journal updated

### UC-004: Complete Quest Chain
**Actor:** Player
**Flow:** Complete final quest → Chain marked complete → Completion bonus distributed → Achievement notification displayed

### UC-005: View Chain Progress
**Actor:** Player
**Flow:** Open quest journal → View chain section → See progress indicator → Preview completion bonus

---

## 12. Acceptance Criteria

### AC-3.2a-1: QuestChain Entity
- [ ] QuestChain stores ordered quest definition IDs
- [ ] QuestChain has name, description, isMainQuest properties
- [ ] QuestChain has optional completion bonus
- [ ] QuestChain has optional prerequisites
- [ ] GetQuestAt returns correct quest ID
- [ ] GetNextQuest returns next quest in sequence
- [ ] IsFirstQuest correctly identifies first quest
- [ ] IsLastQuest correctly identifies last quest
- [ ] GetQuestOrder returns correct index
- [ ] ContainsQuest identifies chain membership

### AC-3.2a-2: Quest Chain Membership
- [ ] Quest.ChainId stores chain reference
- [ ] Quest.ChainOrder stores position
- [ ] Quest.IsInChain computed correctly
- [ ] Quest.IsChainStart computed correctly
- [ ] Quest.IsChainEnd property set correctly
- [ ] SetChainMembership validates parameters
- [ ] ClearChainMembership resets chain info

### AC-3.2a-3: QuestChainService
- [ ] GetChain retrieves by definition ID
- [ ] GetMainQuestChain returns main quest
- [ ] GetAvailableChains filters by prerequisites
- [ ] GetChainProgress calculates correctly
- [ ] ProcessQuestCompletion unlocks next quest
- [ ] ProcessQuestCompletion detects chain completion
- [ ] HasCompletedChain checks all quests
- [ ] FindChainForQuest locates containing chain
- [ ] StartChain creates first quest with membership

### AC-3.2a-4: Chain Progress Tracking
- [ ] ChainProgress tracks completed count
- [ ] ChainProgress tracks current quest
- [ ] ChainProgress calculates percentage
- [ ] ChainProgress formats display string
- [ ] Progress bar renders correctly

### AC-3.2a-5: Configuration
- [ ] quest-chains.json schema validates
- [ ] Chains load from configuration
- [ ] Completion bonuses parse correctly
- [ ] Prerequisites parse correctly
- [ ] Invalid configs produce clear errors

### AC-3.2a-6: Quest Journal Display
- [ ] Main quests display prominently
- [ ] Chain grouping shows in journal
- [ ] Progress indicator displays
- [ ] Chain position shows (Quest X of Y)
- [ ] Completion bonus preview shows

### AC-3.2a-7: Notifications
- [ ] Chain progress notification displays on quest complete
- [ ] Next quest unlock notification displays
- [ ] Chain completion notification displays
- [ ] Completion bonus notification displays

### AC-3.2a-8: Unit Tests
- [ ] ~30 unit tests implemented
- [ ] All tests pass
- [ ] Tests cover happy path and error cases

---

## 13. Deliverable Checklist

### Domain Layer
- [ ] `Entities/QuestChain.cs`
- [ ] `Entities/Quest.cs` updates (ChainId, ChainOrder, IsInChain, IsChainStart, IsChainEnd, SetChainMembership)
- [ ] `ValueObjects/ChainProgress.cs`
- [ ] `ValueObjects/ChainProgressionResult.cs`

### Application Layer
- [ ] `Interfaces/IQuestChainService.cs`
- [ ] `Services/QuestChainService.cs`
- [ ] `Configuration/QuestChainConfigDto.cs`
- [ ] `Configuration/QuestChainsConfigDto.cs`
- [ ] `DTOs/ChainProgressDto.cs`
- [ ] `DTOs/ChainMembershipDto.cs`
- [ ] `DTOs/QuestDetailDto.cs` updates (ChainInfo property)

### Infrastructure Layer
- [ ] `Configuration/JsonConfigurationProvider.cs` updates (LoadQuestChainDefinitions)

### Configuration Files
- [ ] `config/quest-chains.json`
- [ ] `config/schemas/quest-chains.schema.json`

### Tests
- [ ] `Domain.Tests/Entities/QuestChainTests.cs`
- [ ] `Domain.Tests/ValueObjects/ChainProgressTests.cs`
- [ ] `Domain.Tests/Entities/QuestChainMembershipTests.cs`
- [ ] `Application.Tests/Services/QuestChainServiceTests.cs`

### Documentation
- [ ] XML documentation on all public members
- [ ] JSON schema documentation for quest chains

---

## 14. Dependencies

### Required from v0.3.1
- QuestReward value object (from v0.3.1a)
- QuestPrerequisite value object (from v0.3.1c)
- PrerequisiteType enum (from v0.3.1c)
- IQuestService interface (from v0.3.0)
- Quest entity (from v0.3.0a)
- QuestDefinition entity (from v0.3.0a)
- Player.CompletedQuests collection (from v0.3.0)
- Player.ActiveQuests collection (from v0.3.0)
- IConfigurationProvider interface (from v0.3.0)

### Provided to v0.3.2b (Failure Conditions)
- Chain-aware quest system for timed chain quests

### Provided to v0.3.2c (Categories & Management)
- Chain display integration in quest journal filters
- Chain progress in category views

---

## 15. Future Considerations

### Deferred to v0.3.2b
- **Timed Chain Quests**: Time limits that affect entire chains
- **Chain Failure**: Failing one quest fails the chain

### Deferred to v0.3.2c
- **Chain Categories**: Organizing chains by category
- **Chain Abandonment**: Abandoning entire chains

### Deferred to Future Versions
- **Branching Chains**: Choices that lead to different quest paths
- **Parallel Chain Quests**: Multiple quests from same chain active simultaneously
- **Chain Requirements**: Quests that require completing multiple chains
- **Dynamic Chains**: Chains that adjust based on player choices
- **Chain Achievements**: Special recognition for chain completion

### Out of Scope
- **Quest Scripting**: Complex scripted quest behaviors
- **Cutscene Integration**: Story cutscenes between chain quests
- **Voice Acting Hooks**: Audio narrative integration

---

*Document Version: 1.0*
*Last Updated: 2024-01-20*
*Author: Claude Code*
