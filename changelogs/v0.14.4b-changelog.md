# v0.14.4b Changelog - Room Type Schema

## Summary

Implemented `room-types.schema.json` with comprehensive validation for room type definitions, the second schema in the v0.14.4 Environment Configuration Schemas series. The schema includes 4 distinct definitions that work together to define complete room type configurations: display and description settings (entry text, indicators, description pools), multipliers (monster spawn, loot, experience), behavioral settings (allows rest, lighting override), connection rules (door types, secret passages), and feature spawn rules with conditional spawning. This schema enables full customization of room behavior and characteristics without code changes, supporting modding scenarios such as custom dungeon layouts, specialized encounter rooms, or unique environmental chambers.

## Added

### Schema Files
- **[config/schemas/room-types.schema.json](file:///Volumes/GitHub/github/southpawriter02/rune-rust/config/schemas/room-types.schema.json)** - JSON Schema Draft-07 for room type configuration

### Schema Definitions (4 Total)

| Definition | Description | Required Fields |
|------------|-------------|-----------------|
| `RoomTypeDefinition` | Complete room type with multipliers and spawn rules | id, name |
| `ConnectionRules` | Rules for room connections and passages | (all optional with defaults) |
| `FeatureSpawnRule` | Rule for spawning features in room type | featureId, spawnChance |
| `SpawnConditions` | Conditions for feature spawning | (all optional) |

### RoomTypeDefinition Properties
| Property | Type | Constraint | Description |
|----------|------|------------|-------------|
| `id` | string | Pattern: `^[a-z][a-z0-9-]*$` | Unique identifier (kebab-case) |
| `name` | string | minLength: 1 | Display name (required) |
| `entryDescription` | string | (optional) | Text on room entry |
| `indicator` | string | (optional) | UI indicator tag |
| `monsterSpawnMultiplier` | number | >= 0, default: 1.0 | Monster spawn scaling |
| `lootMultiplier` | number | >= 0, default: 1.0 | Loot drop scaling |
| `experienceMultiplier` | number | >= 0, default: 1.0 | XP gain scaling |
| `allowsRest` | boolean | default: false | Resting allowed |
| `descriptionPool` | array | (optional) | Random description pool |
| `connectionRules` | ConnectionRules | (optional) | Door and passage rules |
| `lightingOverride` | enum | dark/dim/normal/bright | Override biome lighting |
| `featureSpawnRules` | array | (optional) | Feature spawn configuration |
| `requiredFeatures` | array | (optional) | Always-spawn features |
| `forbiddenFeatures` | array | (optional) | Never-spawn features |
| `sortOrder` | integer | >= 0 | Display order |

### ConnectionRules Properties
| Property | Type | Constraint | Description |
|----------|------|------------|-------------|
| `allowedDoorTypes` | array | (optional) | Allowed door object IDs |
| `secretPassageChance` | number | 0-1, default: 0 | Secret passage probability |
| `minConnections` | integer | >= 1, default: 1 | Minimum exit count |
| `maxConnections` | integer | >= 1, default: 4 | Maximum exit count |

### FeatureSpawnRule Properties
| Property | Type | Constraint | Description |
|----------|------|------------|-------------|
| `featureId` | string | Pattern validated | Reference to interactive object |
| `spawnChance` | number | 0-1 (required) | Spawn probability |
| `minQuantity` | integer | >= 0, default: 0 | Min quantity if spawn |
| `maxQuantity` | integer | >= 0, default: 1 | Max quantity if spawn |
| `conditions` | SpawnConditions | (optional) | Conditional spawning |

### SpawnConditions Properties
| Property | Type | Description |
|----------|------|-------------|
| `minDepth` | integer | Minimum dungeon depth |
| `maxDepth` | integer | Maximum dungeon depth |
| `requiredBiome` | string | Required biome ID |
| `excludedBiomes` | array | Excluded biome IDs |

### Lighting Override Enumeration (4 values)
| Lighting | Description | Effect |
|----------|-------------|--------|
| `dark` | No natural light | Severely reduced sight |
| `dim` | Minimal light | Reduced sight range |
| `normal` | Standard lighting | Normal visibility |
| `bright` | Ample light | Extended sight range |

### Multiplier Effects Table
| Room Type | Monsters | Loot | Rest | Special |
|-----------|----------|------|------|---------|
| `standard` | 1.0x | 1.0x | No | Default |
| `treasure` | 0.5x | 2.0x | No | Guaranteed chest |
| `trap` | 1.2x | 1.0x | No | Trap features |
| `boss` | 1.0x | 3.0x | No | Boss spawn |
| `safe` | 0.0x | 0.5x | Yes | No monsters |
| `shrine` | 0.2x | 1.5x | No | Altar interaction |

### Configuration Updates
- **[config/room-types.json](file:///Volumes/GitHub/github/southpawriter02/rune-rust/config/room-types.json)** - Updated with `$schema` reference to new schema
  - All 6 existing room types validate: standard, treasure, trap, boss, safe, shrine

### Unit Tests
- **[RoomTypesSchemaTests.cs](file:///Volumes/GitHub/github/southpawriter02/rune-rust/tests/RuneAndRust.Infrastructure.IntegrationTests/Schemas/RoomTypesSchemaTests.cs)** - 9 tests
  - `Schema_IsValidJsonSchemaDraft07` - Schema structure validation (4 definitions)
  - `RoomTypesJson_ValidatesAgainstSchema` - Backwards compatibility (6 room types)
  - `MonsterSpawnMultiplier_Negative_FailsValidation` - Multiplier >= 0 validation
  - `LootMultiplier_Negative_FailsValidation` - Multiplier >= 0 validation
  - `LightingOverride_InvalidEnum_FailsValidation` - Lighting enum (4 values)
  - `SecretPassageChance_OutOfRange_FailsValidation` - Probability 0-1 range
  - `MinConnections_LessThanOne_FailsValidation` - Connection >= 1 validation
  - `SpawnChance_OutOfRange_FailsValidation` - Spawn chance 0-1 range
  - `RoomTypeId_InvalidPattern_FailsValidation` - Kebab-case pattern

## Files Changed

| File | Change Type |
|------|-------------|
| `config/schemas/room-types.schema.json` | Added |
| `config/room-types.json` | Modified ($schema reference) |
| `tests/.../Schemas/RoomTypesSchemaTests.cs` | Added |
| `changelogs/v0.14.4b-changelog.md` | Added |

## Test Results

```
Test summary: total: 9, failed: 0, succeeded: 9, skipped: 0
Build succeeded with 0 errors
```

## Example Room Type Structure

```
Treasure Room (treasure)
├── Display Configuration
│   ├── Entry Description: "Glittering objects catch your eye..."
│   ├── Indicator: "[Treasure Room]"
│   └── Description Pool:
│       ├── "Gold coins are scattered across the floor."
│       ├── "An ornate chest sits in the corner."
│       └── "Precious gems glitter from a pile of treasure."
├── Multiplier Configuration
│   ├── Monster Spawn: 0.5x (50% fewer monsters)
│   ├── Loot: 2.0x (double loot drops)
│   └── Experience: 1.0x (normal XP)
├── Behavioral Configuration
│   ├── Allows Rest: false
│   └── Lighting Override: null (uses biome default)
└── Optional Configuration
    ├── Connection Rules: Limited access (1-2 exits)
    ├── Required Features: [treasure-pile]
    └── Forbidden Features: [trap-spike]
```

## Room Type Multiplier System

```
┌─────────────────────────────────────────────────────────────────┐
│  Monster Spawn Multiplier                                       │
│  0.0x        0.5x        1.0x        1.5x        2.0x          │
│   ├───────────┼───────────┼───────────┼───────────┤            │
│   │ safe      │ treasure  │ standard  │           │ trap       │
│   │ (none)    │ shrine    │ boss      │           │ (more)     │
│                                                                 │
│  Loot Multiplier                                                │
│  0.0x        1.0x        2.0x        3.0x        4.0x          │
│   ├───────────┼───────────┼───────────┼───────────┤            │
│   │ safe      │ standard  │ treasure  │ boss      │            │
│   │           │ trap      │           │           │            │
└─────────────────────────────────────────────────────────────────┘
```

## Modding Scenarios Enabled

After this implementation, modders can:
- Create new room types with custom multipliers
- Define entry descriptions and UI indicators
- Configure description pools for variety
- Set lighting overrides per room type
- Define connection rules and secret passage chances
- Configure feature spawn rules with conditions
- Specify required and forbidden features
- Control resting behavior per room type
- Reference biomes and interactive objects

---

*Second entry in v0.14.4 Environment Configuration Schemas series. See also: v0.14.4a (Biome Schema), v0.14.4c (Terrain Schema Expansion), v0.14.4d (Interactive Object Schema).*
