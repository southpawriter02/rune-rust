# v0.4.0: The Saga (Progression Framework)

> **Status:** Planned
> **Milestone:** 5.0 - The Saga
> **Theme:** Core progression loop (XP, Levels, Attributes)

---

## Table of Contents
- [Overview](#overview)
- [Phase A: The Legend](#phase-a-the-legend)
- [Phase B: The Growth](#phase-b-the-growth)
- [Phase C: The Shrine](#phase-c-the-shrine)
- [Phase D: The Reward](#phase-d-the-reward)
- [Testing Strategy](#testing-strategy)
- [Changelog](#changelog-v040---the-saga)

---

## Overview

Milestone 5 ("The Saga") introduces the long-term progression loops that transform *Rune & Rust* from a roguelike survival test into a proper RPG. v0.4.0 focuses specifically on the "Horizontal" progression framework: accumulating experience (Legend), reaching level thresholds (Milestones), and spending earned currency (Progression Points) to improve base Attributes.

To manage the complexity of adding a persistent progression layer across the entire game loop, this version is split into 4 sub-versions:

| Phase | Codename | Focus |
|-------|----------|-------|
| A | [The Legend](./v0.4.0a.md) | Backend service for tracking Experience (Legend) and managing Level thresholds. |
| B | [The Growth](./v0.4.0b.md) | Logic for spending Progression Points (PP) and calculating Attribute costs. |
| C | [The Shrine](./v0.4.0c.md) | User Interface (TUI) for the character advancement menu. |
| D | [The Reward](./v0.4.0d.md) | Integration of XP rewards into Combat, Exploration, and Quest systems. |

---

## Phase A: The Legend (XP Backend)

**Goal:** Implement the fundamental `SagaService` to track "Legend" (Experience) accumulation and handle "Milestone" (Level Up) events.

> **Detailed Plan:** [v0.4.0a: The Legend](./v0.4.0a.md)

### Summary
This phase focuses on the backend architecture for:
- Renaming `ExperiencePoints` to `Legend` on the Character entity.
- Adding `Level` and `ProgressionPoints` fields.
- Implementing `SagaService` to manage XP thresholds (Milestones).
- Firing `LevelUpEvent`s and awarding Progression Points.

---

## Phase B: The Growth (Attribute & Skill Logic)

**Goal:** Implement the logic for spending Progression Points (PP) to improve Attributes, including cost calculation and validation.

> **Detailed Plan:** [v0.4.0b: The Growth](./v0.4.0b.md)

### 1. Architecture & Data Flow

This phase adds the transactional logic for character improvement. It defines how much an attribute upgrade costs and validates that the player can afford it.

**Components:**
- **ProgressionService (Engine):** Handles "purchasing" upgrades.
- **AttributeCostCalculator (Engine/Core):** Determines PP cost based on current attribute value (diminishing returns).
- **ValidationLogic:** Ensures caps (e.g., max 10 Attribute) are respected.

### 2. Logic Decision Trees

#### A. UpgradeAttribute
**Input:** `AttributeType` (MIGHT, WITS, etc.)

1. **Get Current Value:** `val = Character.Attributes[type]`.
2. **Check Cap:** If `val >= MaxAttribute (10)`, return `Error("Maxed")`.
3. **Calculate Cost:** `cost = GetCost(val)`.
   - E.g., Cost = 1 PP (flat) or Cost = CurrentValue (steep). Let's assume **1 PP per point** for now, or maybe tiered.
   - *Design Decision:* Milestone 5 specifies spending PP. Let's make it 1 PP = 1 Attribute Point for simplicity in v0.4.0, or maybe 1 PP for low tiers, 2 for high. Let's stick to **1 PP = 1 Stat** for now to test the loop.
4. **Check Funds:** If `Character.PP < cost`, return `Error("Insufficient PP")`.
5. **Execute:**
   - `Character.PP -= cost`.
   - `Character.Attributes[type]++`.
   - Recalculate derived stats (HP, Stamina).

### 3. Code Implementation

#### A. ProgressionService (Engine)
**File:** `RuneAndRust.Engine/Services/ProgressionService.cs`

```csharp
public class ProgressionService : IProgressionService
{
    public Result UpgradeAttribute(Character character, AttributeType attribute)
    {
        int currentVal = character.GetAttribute(attribute);
        if (currentVal >= 10) return Result.Failure("Attribute has reached its potential limit.");

        int cost = 1; // Flat cost for v0.4.0
        if (character.ProgressionPoints < cost)
            return Result.Failure($"Not enough Progression Points. Need {cost}, have {character.ProgressionPoints}.");

        character.ProgressionPoints -= cost;
        character.SetAttribute(attribute, currentVal + 1);

        // Important: Recalculate derived stats immediately
        _statCalculationService.Recalculate(character);

        return Result.Success($"Improved {attribute} to {currentVal + 1}.");
    }
}
```

### 4. Logging Requirements

| System | Event | Level | Message Template | Properties |
|--------|-------|-------|------------------|------------|
| ProgressionService | AttributeUpgrade | Info | "{Name} upgraded {Attribute} to {Value} for {Cost} PP" | Name, Attribute, Value, Cost |
| ProgressionService | UpgradeFailed | Warn | "Upgrade failed: {Reason}" | Reason |

### 5. Testing Requirements

**Unit Tests (ProgressionServiceTests.cs)**
- **Upgrade_ConsumesPP:** Verify PP decreases.
- **Upgrade_IncreasesStat:** Verify Attribute value increases.
- **Upgrade_RecalculatesDerived:** Verify HP/Stamina update if MIGHT/FINESSE change.
- **Upgrade_FailsIfInsufficientPP:** Verify no change if broke.
- **Upgrade_FailsIfCapped:** Verify no change if at 10.

### 6. Deliverable Checklist

- [ ] Core: Define `IProgressionService`.
- [ ] Engine: Implement `ProgressionService` with attribute upgrade logic.
- [ ] Engine: Ensure `StatCalculationService` is called on upgrade.
- [ ] Tests: Unit tests for spending logic.

---

## Phase C: The Shrine (Saga UI)

**Goal:** Create a dedicated TUI screen ("The Shrine") where players can visualize their Legend and spend Progression Points.

> **Detailed Plan:** [v0.4.0c: The Shrine](./v0.4.0c.md)

### 1. Architecture & Data Flow

**Components:**
- **SagaController (Terminal):** Handles input for the Saga menu.
- **SagaView (Terminal):** Spectre.Console renderer for the progression tree/list.
- **Command:** `saga` or `level` command (only available in `Rest` state?).

**Layout:**
- **Header:** "The Shrine of Echoes"
- **Top Panel:** Level, Legend Bar [|||||.....], Available PP.
- **Main Panel:** List of Attributes.
  - `[MIGHT] : 4  [+] (Cost: 1 PP)`
  - `[WITS]  : 3  [+] (Cost: 1 PP)`
- **Footer:** "Arrow Keys to Navigate, Enter to Buy, Esc to Leave"

### 2. Code Implementation

#### A. SagaView (Terminal)
**File:** `RuneAndRust.Terminal/Views/SagaView.cs`

```csharp
public void Render(Character character)
{
    var table = new Table().Title("Attributes");
    table.AddColumns("Attribute", "Value", "Cost", "Action");

    foreach (var attr in Enum.GetValues<AttributeType>())
    {
        int val = character.GetAttribute(attr);
        int cost = 1;
        bool canAfford = character.ProgressionPoints >= cost;

        table.AddRow(
            attr.ToString(),
            val.ToString(),
            cost.ToString(),
            canAfford ? "[green]Upgrade[/]" : "[grey]Locked[/]"
        );
    }

    // Wrap in a Panel with header stats
    var status = new Panel($"Level: {character.Level} | PP: {character.ProgressionPoints}");
    // ... Layout composition
}
```

### 3. Deliverable Checklist

- [ ] Terminal: Implement `SagaController` to handle navigation input.
- [ ] Terminal: Implement `SagaView` using `Spectre.Console`.
- [ ] Terminal: Register `saga` command in `CommandRegistry`.
- [ ] Terminal: Restrict command availability (Context: Rest/Campfire).

---

## Phase D: The Reward (Integration)

**Goal:** Hook the `SagaService` into gameplay loops so XP is actually awarded.

> **Detailed Plan:** [v0.4.0d: The Reward](./v0.4.0d.md)

### 1. Architecture & Data Flow

**Touchpoints:**
1. **Combat:** Enemy death -> Award XP based on Threat Tier.
2. **Exploration:** Discover Room -> Award XP (minor).
3. **Quests:** Complete Objective -> Award XP (major).

**XP Values (Draft):**
- Minion: 50 XP
- Standard: 100 XP
- Elite: 250 XP
- Boss: 1000 XP
- New Room: 10 XP

### 2. Code Implementation

#### A. CombatService Integration
**File:** `RuneAndRust.Engine/Services/CombatService.cs`

```csharp
// Inside HandleDeath method
if (target is Enemy enemy)
{
    int xp = _xpCalculator.GetExpForTier(enemy.Tier);
    _sagaService.AddLegend(player, xp, $"Defeated {enemy.Name}");
}
```

### 3. Deliverable Checklist

- [ ] Engine: Update `CombatService` to award XP on kill.
- [ ] Engine: Update `ExplorationService` to award XP on first visit (requires `Room.IsVisited` flag logic update).
- [ ] Engine: Create `XPCalculator` helper to centralize XP values.
- [ ] Data: Update `EnemyDefinitions` if custom XP is needed (optional, tier-based is fine for now).

---

## Testing Strategy

### Unit Tests
| Test Class | Focus | Key Scenarios |
|------------|-------|---------------|
| `SagaServiceTests` | XP & Leveling | Accumulation, Level Up threshold, Event firing. |
| `ProgressionServiceTests` | Spending | Valid purchase, Insufficient funds, Cap limits. |
| `XPCalculatorTests` | Values | Correct XP for Minion/Elite/Boss tiers. |

### Integration Tests
| Scenario | Components | Validation |
|----------|------------|------------|
| **Zero to Hero** | `SagaService`, `CombatService` | Kill enemy -> Gain XP -> Verify total increases. |
| **The Upgrade** | `ProgressionService`, `Character` | Add PP -> Spend on MIGHT -> Verify MIGHT increases and PP decreases. |
| **Level Up Loop** | `SagaService` | Add massive XP -> Verify Level increments multiple times if needed. |

---

## Changelog: v0.4.0 - The Saga

**Release Date:** 2025-XX-XX

### Summary
v0.4.0 introduces "The Saga," the core progression framework for Rune & Rust. Players can now accumulate Legend (Experience) from combat and exploration, reach new Levels (Milestones), and spend Progression Points to permanently upgrade their Attributes at the Shrine.

### Features
- **Legend System:** Experience tracking with defined level thresholds.
- **Progression Points:** A new currency earned via leveling.
- **The Shrine:** A dedicated UI menu for character advancement.
- **Attribute Upgrades:** Players can now increase MIGHT, WITS, FINESSE, and RESOLVE.

### Technical
- Implemented `SagaService` for XP management.
- Implemented `ProgressionService` for spending logic.
- Integrated XP rewards into `CombatService` and `ExplorationService`.
- Added `SagaView` using Spectre.Console for visual progression.
