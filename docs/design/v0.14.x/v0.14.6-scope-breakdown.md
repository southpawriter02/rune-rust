# v0.14.6 Audio Configuration Schemas - Scope Breakdown

**Version:** 0.14.6
**Theme:** Audio Configuration Schemas
**Prerequisites:** v0.14.5 Complete (Economy Configuration Schemas)
**Total Estimated Tests:** ~12 new tests

---

## Executive Summary

The Audio Configuration Schemas version creates comprehensive JSON schemas for all audio-related configuration files, enabling full customization of sound effects and music themes without code changes. This supports modding scenarios like custom soundtracks, themed sound packs, dynamic audio layers, or region-specific sound effects.

The work is divided into **two sub-parts**:

| Part | Name | Focus | Est. Tests |
|------|------|-------|------------|
| v0.14.6a | Sound Effect Schema | sound-effects.schema.json with categories, triggers, volume/pitch variance, fallbacks | 13 ✓ |
| v0.14.6b | Music Theme Schema | music-themes.schema.json with categories, transitions, intensity layers, loop points | 14 ✓ |

---

## Feature Analysis & Categorization

### From v0.14.x-overview.md - Audio Configuration Schemas

| Feature | Complexity | Dependencies | Assigned Part |
|---------|------------|--------------|---------------|
| sound-effects.schema.json | Medium | None | **v0.14.6a** |
| Sound categories | Low | sound-effects.schema.json | **v0.14.6a** |
| Trigger associations | Medium | sound-effects.schema.json | **v0.14.6a** |
| Volume/pitch variance | Low | sound-effects.schema.json | **v0.14.6a** |
| Fallback definitions | Low | sound-effects.schema.json | **v0.14.6a** |
| music-themes.schema.json | Medium | None | **v0.14.6b** |
| Theme categories | Low | music-themes.schema.json | **v0.14.6b** |
| Transition rules | Medium | music-themes.schema.json | **v0.14.6b** |
| Intensity layers | Medium | music-themes.schema.json | **v0.14.6b** |
| Loop points | Low | music-themes.schema.json | **v0.14.6b** |

---

## Existing Infrastructure

### Current Configuration Files

| File | Current State | Schema Exists |
|------|---------------|---------------|
| `config/sound-effects.json` | 6 categories with effects | No |
| `config/music-themes.json` | 5 themes, 4 stingers, transitions | No |

### Current Sound Effect Structure

```json
{
  "categories": {
    "combat": {
      "effects": {
        "attack-hit": {
          "files": [
            "audio/sfx/combat/hit_01.ogg",
            "audio/sfx/combat/hit_02.ogg"
          ],
          "volume": 0.8,
          "randomize": true
        }
      }
    }
  },
  "settings": {
    "maxSimultaneous": 8,
    "defaultVolume": 0.8
  }
}
```

### Current Music Theme Structure

```json
{
  "themes": [
    {
      "theme": "Combat",
      "tracks": ["audio/music/combat_intense.ogg"],
      "introTrack": "audio/music/combat_intro.ogg",
      "volume": 0.8,
      "loop": true,
      "shuffle": false
    }
  ],
  "stingers": [
    {
      "name": "victory",
      "track": "audio/music/victory_fanfare.ogg",
      "volume": 1.0
    }
  ],
  "transitions": {
    "defaultCrossfade": 2.0,
    "combatCrossfade": 0.5,
    "stingerFadeOut": 1.0,
    "stingerResumeDelay": 0.5
  }
}
```

### Key Schema Conventions

- JSON Schema Draft-07 format
- ID pattern: `^[a-z][a-z0-9-]*$` (lowercase kebab-case)
- Definitions section for reusable types
- Required fields explicitly listed
- Descriptions on all properties

---

## Phase Definitions

---

## v0.14.6a: Sound Effect Schema

[v0.14.6a Design Specification](v0.14.6a-design-specification.md)

### Overview

Create a comprehensive JSON schema for sound effect definitions that validates sound categories, trigger associations, volume/pitch variance, and fallback handling for missing audio files.

### Scope

**In Scope:**
- `sound-effects.schema.json` - Full schema for SFX definitions
- Sound categories (Combat, Ability, UI, Items, Puzzle, Movement, Ambient)
- Effect definitions (files, volume, randomize)
- Volume variance (min/max range)
- Pitch variance (min/max range)
- Trigger associations (event to sound mapping)
- Fallback definitions (missing sound handling)
- Global settings (max simultaneous, default volume)

**Out of Scope:**
- Music theme schema (v0.14.6b)
- Audio playback logic (runtime concern)
- Audio file format validation (external concern)

### Key Deliverables

| Type | Count | Details |
|------|-------|---------|
| JSON Schemas | 1 | `sound-effects.schema.json` |
| Schema Definitions | 4 | `SoundCategory`, `SoundEffect`, `VolumeRange`, `GlobalSettings` |
| Configuration Updates | 1 | Update `sound-effects.json` to reference new schema |
| Unit Tests | ~6 | Schema validation tests |

### Schema Structure

```
sound-effects.schema.json
|-- $schema: "http://json-schema.org/draft-07/schema#"
|-- title: "Sound Effects Configuration"
|-- description: "Schema for sound effect definitions"
|-- type: object
|-- properties:
|   |-- $schema: string
|   |-- version: string (optional)
|   |-- categories: object (additionalProperties: SoundCategory)
|   +-- settings: GlobalSettings
|-- required: ["categories"]
+-- definitions:
    |-- SoundCategory
    |   |-- description: string (optional)
    |   +-- effects: object (additionalProperties: SoundEffect)
    |-- SoundEffect
    |   |-- files: array of string (minItems: 1, file paths)
    |   |-- volume: number (minimum: 0, maximum: 1, default: 1.0)
    |   |-- volumeVariance: VolumeRange (optional)
    |   |-- pitch: number (minimum: 0.5, maximum: 2.0, default: 1.0)
    |   |-- pitchVariance: PitchRange (optional)
    |   |-- randomize: boolean (default: false, random file selection)
    |   |-- loop: boolean (default: false)
    |   |-- cooldown: number (optional, seconds between plays)
    |   |-- priority: integer (minimum: 0, maximum: 10, default: 5)
    |   |-- fallbackEffectId: string (optional, use if files missing)
    |   +-- tags: array of string (optional, for filtering)
    |-- VolumeRange
    |   |-- min: number (minimum: 0, maximum: 1)
    |   +-- max: number (minimum: 0, maximum: 1)
    |-- PitchRange
    |   |-- min: number (minimum: 0.5, maximum: 2.0)
    |   +-- max: number (minimum: 0.5, maximum: 2.0)
    +-- GlobalSettings
        |-- maxSimultaneous: integer (minimum: 1, default: 8)
        |-- defaultVolume: number (minimum: 0, maximum: 1, default: 1.0)
        |-- masterMute: boolean (default: false)
        +-- fallbackEnabled: boolean (default: true)
```

### Sound Categories

| Category | Description | Example Effects |
|----------|-------------|-----------------|
| `combat` | Battle sounds | attack-hit, attack-miss, attack-critical, death |
| `ability` | Spell/skill sounds | cast, fire, heal, buff |
| `ui` | Interface sounds | click, hover, menu-open, menu-close |
| `items` | Item interaction | pickup, equip, drop, use |
| `puzzle` | Puzzle feedback | correct, incorrect, complete |
| `movement` | Movement sounds | footsteps, door, chest |
| `ambient` | Environmental | wind, water, fire, crowd |

### Trigger Associations

| Trigger Event | Category | Effect ID |
|---------------|----------|-----------|
| `OnAttackHit` | combat | attack-hit |
| `OnAttackMiss` | combat | attack-miss |
| `OnCriticalHit` | combat | attack-critical |
| `OnEnemyDeath` | combat | death-monster |
| `OnPlayerDeath` | combat | death-player |
| `OnAbilityCast` | ability | ability-cast |
| `OnItemPickup` | items | item-pickup |
| `OnMenuOpen` | ui | menu-open |

### Acceptance Criteria

- [x] `sound-effects.schema.json` created in `config/schemas/`
- [x] Schema validates existing `sound-effects.json` without errors
- [x] Category names validated as strings (additionalProperties)
- [x] Effect IDs validated as strings (additionalProperties)
- [x] Files array validated (minItems: 1)
- [x] Volume validated (0-1 range)
- [x] Pitch validated (0.5-2.0 range)
- [x] Volume/pitch variance validated
- [x] Randomize flag validated as boolean
- [x] Global settings validated
- [x] ~6 unit tests pass (13 implemented)

---

## v0.14.6b: Music Theme Schema

[v0.14.6b Design Specification](v0.14.6b-design-specification.md)

### Overview

Create a comprehensive JSON schema for music theme definitions that validates theme categories, transition rules, intensity layers, stingers, and loop points for seamless audio playback.

### Scope

**In Scope:**
- `music-themes.schema.json` - Full schema for music definitions
- Theme categories (Menu, Exploration, Combat, BossCombat, SafeArea)
- Track lists with intro tracks
- Volume and shuffle settings
- Transition rules (crossfade durations)
- Stinger definitions (victory, defeat, level-up, quest)
- Intensity layers (dynamic music scaling)
- Loop points (seamless looping)

**Out of Scope:**
- Sound effect schema (v0.14.6a)
- Audio playback logic (runtime concern)
- Audio file format validation (external concern)

### Key Deliverables

| Type | Count | Details |
|------|-------|---------|
| JSON Schemas | 1 | `music-themes.schema.json` |
| Schema Definitions | 5 | `ThemeDefinition`, `Stinger`, `Transitions`, `IntensityLayer`, `LoopPoint` |
| Configuration Updates | 1 | Update `music-themes.json` to reference new schema |
| Unit Tests | ~6 | Schema validation tests |

### Schema Structure

```
music-themes.schema.json
|-- $schema: "http://json-schema.org/draft-07/schema#"
|-- title: "Music Theme Configuration"
|-- description: "Schema for music theme definitions"
|-- type: object
|-- properties:
|   |-- $schema: string
|   |-- version: string (optional)
|   |-- themes: array of ThemeDefinition
|   |-- stingers: array of Stinger (optional)
|   +-- transitions: Transitions
|-- required: ["themes", "transitions"]
+-- definitions:
    |-- ThemeDefinition
    |   |-- theme: string (enum: MainMenu, Exploration, Combat, BossCombat, SafeArea, Puzzle, Cinematic, Credits)
    |   |-- tracks: array of string (minItems: 1, file paths)
    |   |-- introTrack: string (optional, plays once before main loop)
    |   |-- outroTrack: string (optional, plays on theme exit)
    |   |-- volume: number (minimum: 0, maximum: 1, default: 1.0)
    |   |-- loop: boolean (default: true)
    |   |-- shuffle: boolean (default: false, randomize track order)
    |   |-- intensityLayers: array of IntensityLayer (optional)
    |   |-- loopPoints: LoopPoints (optional)
    |   +-- tags: array of string (optional, for filtering)
    |-- IntensityLayer
    |   |-- track: string (file path)
    |   |-- minIntensity: number (minimum: 0, maximum: 1)
    |   |-- maxIntensity: number (minimum: 0, maximum: 1)
    |   |-- fadeTime: number (minimum: 0, seconds to fade in/out)
    |   +-- volumeMultiplier: number (minimum: 0, maximum: 1, default: 1.0)
    |-- LoopPoints
    |   |-- loopStartSamples: integer (optional, sample position)
    |   |-- loopEndSamples: integer (optional, sample position)
    |   |-- loopStartSeconds: number (optional, time position)
    |   +-- loopEndSeconds: number (optional, time position)
    |-- Stinger
    |   |-- name: string (pattern: ^[a-z][a-z0-9-]*$)
    |   |-- track: string (file path)
    |   |-- volume: number (minimum: 0, maximum: 1, default: 1.0)
    |   |-- duckMusic: boolean (default: true, lower music volume)
    |   |-- duckAmount: number (minimum: 0, maximum: 1, default: 0.3)
    |   +-- resumeDelay: number (minimum: 0, default: 0.5, seconds)
    +-- Transitions
        |-- defaultCrossfade: number (minimum: 0, default: 2.0, seconds)
        |-- combatCrossfade: number (minimum: 0, default: 0.5, seconds)
        |-- bossCrossfade: number (minimum: 0, default: 1.0, seconds)
        |-- stingerFadeOut: number (minimum: 0, default: 1.0, seconds)
        |-- stingerResumeDelay: number (minimum: 0, default: 0.5, seconds)
        +-- transitionType: string (enum: Crossfade, Immediate, FadeOutFadeIn, default: Crossfade)
```

### Theme Categories

| Theme | Use Case | Typical Characteristics |
|-------|----------|-------------------------|
| `MainMenu` | Title/menu screens | Calm, looping, no intensity |
| `Exploration` | Dungeon/world navigation | Ambient, multiple tracks, shuffle |
| `Combat` | Standard encounters | Intense, quick transition in |
| `BossCombat` | Boss battles | Epic, multi-phase support |
| `SafeArea` | Towns, rest areas | Relaxing, peaceful |
| `Puzzle` | Puzzle rooms | Thoughtful, non-intrusive |
| `Cinematic` | Cutscenes | Non-looping, timed |
| `Credits` | End credits | Full playthrough, non-looping |

### Transition Types

| Type | Behavior | Use Case |
|------|----------|----------|
| `Crossfade` | Fade out old while fading in new | Smooth theme changes |
| `Immediate` | Cut directly to new track | Urgent transitions (combat start) |
| `FadeOutFadeIn` | Fade to silence, then fade in | Dramatic scene changes |

### Intensity Layers

Intensity layers allow dynamic music scaling based on game state:

| Intensity Level | Example Layers |
|-----------------|----------------|
| 0.0-0.3 (Low) | Base ambient layer only |
| 0.3-0.6 (Medium) | Add percussion layer |
| 0.6-0.8 (High) | Add brass/strings layer |
| 0.8-1.0 (Critical) | Full orchestra, all layers |

### Stinger Examples

| Stinger | Trigger | Behavior |
|---------|---------|----------|
| `victory` | Combat won | Duck music, play fanfare |
| `defeat` | Player dies | Duck music, play somber |
| `level-up` | Level gained | Duck music, play jingle |
| `quest-complete` | Quest finished | Duck music, play completion |
| `discovery` | Secret found | Brief overlay, no duck |

### Acceptance Criteria

- [x] `music-themes.schema.json` created in `config/schemas/`
- [x] Schema validates existing `music-themes.json` without errors
- [x] Theme enum validated (8 categories)
- [x] Tracks array validated (minItems: 1)
- [x] Intro/outro tracks validated as optional strings
- [x] Volume validated (0-1 range)
- [x] Loop and shuffle flags validated
- [x] Stingers validated with name pattern
- [x] Transitions validated with durations
- [x] Intensity layers validated with min/max
- [x] Loop points validated (samples or seconds)
- [x] ~6 unit tests pass (14 implemented)

---

## Dependencies & Prerequisites

```
v0.14.5 (Economy Configuration Schemas) - REQUIRED
    |
    +-- All economy schemas available ────────────────────────────────────────┐
                                                                              |
                                      v
v0.14.6 (Audio Configuration Schemas)
    |
    |-- v0.14.6a: Sound Effect Schema ────────────────────────────────────────┐
    |       Dependencies: None                                                 |
    |       Provides: sound-effects.schema.json                                |
    |                                                                          |
    +-- v0.14.6b: Music Theme Schema ─────────────────────────────────────────┘
            Dependencies: None
            Provides: music-themes.schema.json

Note: v0.14.6a and v0.14.6b can be implemented in parallel (no dependencies).
```

---

## Estimated Effort Summary

| Part | New Files | Modified Files | Est. Tests | Complexity |
|------|-----------|----------------|------------|------------|
| v0.14.6a | 1 | 1 | ~6 | Medium |
| v0.14.6b | 1 | 1 | ~6 | Medium |
| **Total** | **2** | **2** | **~12** | |

---

## Risk Assessment

| Risk | Impact | Probability | Mitigation |
|------|--------|-------------|------------|
| Audio file path validation complexity | Low | Low | Schema validates format, not existence |
| Intensity layer complexity scope creep | Medium | Medium | Keep to schema validation only |
| Loop point precision requirements | Low | Low | Support both samples and seconds |
| Category enum extensibility | Low | Low | Document pattern for additions |

---

## Design Decisions (Confirmed)

### Schema Standards

| Decision | Value | Notes |
|----------|-------|-------|
| **JSON Schema Version** | Draft-07 | Consistent with v0.14.0-v0.14.5 |
| **ID Pattern** | `^[a-z][a-z0-9-]*$` | Lowercase kebab-case |
| **Schema Location** | `config/schemas/` | Centralized schema storage |

### Sound Effect Design

| Decision | Value | Notes |
|----------|-------|-------|
| **Category Structure** | additionalProperties | Flexible category names |
| **Effect Structure** | additionalProperties | Flexible effect IDs |
| **Volume Range** | 0-1 | Normalized volume |
| **Pitch Range** | 0.5-2.0 | Half to double speed |
| **Fallback Support** | Optional reference | Graceful degradation |

### Music Theme Design

| Decision | Value | Notes |
|----------|-------|-------|
| **Theme Categories** | 8 types | Covers major game states |
| **Transition Types** | 3 types | Crossfade, Immediate, FadeOutFadeIn |
| **Intensity Layers** | 0-1 range | Normalized intensity |
| **Loop Points** | Samples or seconds | Flexible precision |
| **Stinger Ducking** | Configurable | Per-stinger control |

---

## Next Steps

1. **Review & Approve** - Confirm scope breakdown
2. **v0.14.6a Design Spec** - Create sound effect schema
3. **v0.14.6a Implementation** - Build sound-effects.schema.json
4. **v0.14.6b Design Spec** - Create music theme schema
5. **v0.14.6b Implementation** - Build music-themes.schema.json

---

*This scope breakdown provides a structured approach to implementing v0.14.6 Audio Configuration Schemas. Each sub-part creates a complete, validated JSON schema for audio-related configuration files. The recommended implementation order is v0.14.6a (sound effects) then v0.14.6b (music themes), though both can be implemented in parallel since they have no interdependencies. This enables full audio customization without code changes.*
