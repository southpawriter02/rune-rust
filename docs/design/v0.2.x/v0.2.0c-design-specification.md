# v0.2.0c Design Specification: Reputation & Memory

## Overview

**Version:** 0.2.0c
**Status:** Planning
**Focus:** Implement faction reputation tracking and NPC memory for persistent social dynamics
**Prerequisites:** v0.2.0a (NPC Foundation), v0.2.0b (Dialogue System)
**Estimated Unit Tests:** ~30

---

## Table of Contents

1. [Executive Summary](#1-executive-summary)
2. [Feature Overview](#2-feature-overview)
3. [Architecture Diagrams](#3-architecture-diagrams)
4. [User Stories](#4-user-stories)
5. [Data Models](#5-data-models)
6. [Configuration Schemas](#6-configuration-schemas)
7. [Service Specifications](#7-service-specifications)
8. [Reputation Command Flow](#8-reputation-command-flow)
9. [User-Facing Changes](#9-user-facing-changes)
10. [Logging Requirements](#10-logging-requirements)
11. [Unit Test Specifications](#11-unit-test-specifications)
12. [Use Cases](#12-use-cases)
13. [Acceptance Criteria](#13-acceptance-criteria)
14. [Deliverable Checklist](#14-deliverable-checklist)
15. [Dependencies](#15-dependencies)
16. [Future Considerations](#16-future-considerations)

---

## 1. Executive Summary

This version adds faction reputation tracking and NPC memory to create persistent social dynamics. NPCs remember past interactions and react differently based on the player's standing with their faction. Reputation changes propagate to allied and enemy factions, creating a web of social consequences for player actions.

### Key Deliverables

| Category | Items |
|----------|-------|
| **Definitions** | FactionDefinition |
| **Value Objects** | ReputationStanding, NPCMemory |
| **Enums** | ReputationLevel |
| **Services** | ReputationService (IReputationService) |
| **Player Updates** | Reputation tracking (Dictionary<string, int>) |
| **NPC Updates** | Memory tracking, attitude from reputation |
| **Configuration** | factions.json, factions.schema.json |
| **Commands** | `reputation`, `reputation <faction>` |
| **Tests** | ~30 new unit tests |

### Architectural Significance

This version establishes the **social dynamics pattern** that enables:
- Faction-based reputation with propagation to allies/enemies
- NPC memory of player interactions and dialogue choices
- Reputation-based attitude changes affecting dialogue availability
- Memory-based dialogue conditions (returning player vs. first-time)
- Foundation for faction-gated content and relationship consequences

---

## 2. Feature Overview

```
v0.2.0c Features
├── Faction System
│   ├── FactionDefinition (config-loaded templates)
│   ├── ReputationLevel enum (Hated to Exalted)
│   ├── Faction allies/enemies relationships
│   └── Reputation thresholds per faction
├── Reputation Tracking
│   ├── Player.Reputation dictionary (factionId -> points)
│   ├── ReputationStanding value object
│   ├── Reputation gain/loss from dialogue outcomes
│   └── Spillover to allied/enemy factions
├── NPC Memory
│   ├── NPCMemory value object
│   ├── Interaction count tracking
│   ├── Dialogue choice history
│   ├── Custom memory flags
│   └── Hostile/helpful behavior tracking
├── Attitude Integration
│   ├── NPC attitude from faction reputation
│   ├── Memory-based attitude modifiers
│   └── Attitude affects dialogue options (v0.2.0b)
├── Dialogue Conditions (v0.2.0b extension)
│   ├── ReputationAtLeast condition support
│   ├── Memory-based conditions
│   └── First-time vs returning dialogue
└── Service Layer
    ├── ReputationService (faction management)
    ├── IReputationService interface
    └── Integration with DialogueService
```

---

## 3. Architecture Diagrams

### 3.1 Layer Diagram

```
┌─────────────────────────────────────────────────────────────────────────┐
│                         PRESENTATION LAYER                              │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  ┌─────────────────────┐  ┌─────────────────────┐  ┌────────────────┐  │
│  │   InputHandler      │  │   ReputationView    │  │ IGameRenderer  │  │
│  │   (updated)         │  │   (new)             │  │ (updated)      │  │
│  │                     │  │                     │  │                │  │
│  │ - ParseReputationCmd│  │ - ShowFactionList() │  │ - RenderRep()  │  │
│  │                     │  │ - ShowFactionDetail │  │ - RenderLevel()│  │
│  └─────────┬───────────┘  └─────────┬───────────┘  └───────┬────────┘  │
│            │                        │                      │           │
└────────────┼────────────────────────┼──────────────────────┼───────────┘
             │                        │                      │
             ▼                        ▼                      ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                         APPLICATION LAYER                               │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │                      ReputationService                           │   │
│  ├─────────────────────────────────────────────────────────────────┤   │
│  │ + GetFactionDefinition(id) : FactionDefinition?                 │   │
│  │ + GetAllFactions() : IReadOnlyList<FactionDefinition>           │   │
│  │ + GetPlayerReputation(player, factionId) : int                  │   │
│  │ + GetReputationLevel(player, faction) : ReputationLevel         │   │
│  │ + ModifyReputation(player, factionId, delta) : ReputationChange │   │
│  │ + GetReputationStanding(player, faction) : ReputationStanding   │   │
│  │ + GetAllStandings(player) : IReadOnlyList<ReputationStanding>   │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │                    GameSessionService (updated)                  │   │
│  ├─────────────────────────────────────────────────────────────────┤   │
│  │ + GetReputationSummary() : IReadOnlyList<ReputationStanding>    │   │
│  │ + GetFactionReputation(factionId) : ReputationStanding?         │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │                    DialogueService (updated)                     │   │
│  ├─────────────────────────────────────────────────────────────────┤   │
│  │ + ApplyOutcome: ChangeReputation support             // UPDATED │   │
│  │ + BuildContext: Includes NPC memory                  // UPDATED │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │                    NPCService (updated)                          │   │
│  ├─────────────────────────────────────────────────────────────────┤   │
│  │ + UpdateNPCAttitudeFromReputation(npc, player) : void // UPDATED│   │
│  │ + RecordInteraction(npc, player) : void               // NEW    │   │
│  │ + RecordChoice(npc, player, choiceId) : void          // NEW    │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                           DOMAIN LAYER                                  │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  DEFINITIONS                                                            │
│  ┌────────────────────────────────────────────────────────────────┐    │
│  │                    FactionDefinition                            │    │
│  ├────────────────────────────────────────────────────────────────┤    │
│  │ + Id: string                                                    │    │
│  │ + Name: string                                                  │    │
│  │ + Description: string                                           │    │
│  │ + DefaultReputation: int                                        │    │
│  │ + Thresholds: IReadOnlyDictionary<ReputationLevel, int>         │    │
│  │ + Allies: IReadOnlyList<string>                                 │    │
│  │ + Enemies: IReadOnlyList<string>                                │    │
│  │ + AllySpilloverPercent: int (default 50)                        │    │
│  │ + EnemySpilloverPercent: int (default -25)                      │    │
│  │ + GetLevel(reputation) : ReputationLevel                        │    │
│  │ + GetProgressToNextLevel(reputation) : (current, needed, pct)   │    │
│  └────────────────────────────────────────────────────────────────┘    │
│                                                                         │
│  VALUE OBJECTS                                                          │
│  ┌──────────────────────────┐  ┌──────────────────────────┐            │
│  │   ReputationStanding     │  │       NPCMemory          │            │
│  ├──────────────────────────┤  ├──────────────────────────┤            │
│  │ + FactionId: string      │  │ + PlayerId: Guid         │            │
│  │ + FactionName: string    │  │ + InteractionCount: int  │            │
│  │ + CurrentPoints: int     │  │ + LastInteraction: Date? │            │
│  │ + Level: ReputationLevel │  │ + ChoicesMade: [string]  │            │
│  │ + PointsToNextLevel: int │  │ + Flags: Dict<str,str>   │            │
│  │ + ProgressPercent: int   │  │ + WasHostile: bool       │            │
│  │ + NextLevel: RepLevel?   │  │ + WasHelpful: bool       │            │
│  └──────────────────────────┘  │ + RecordInteraction()    │            │
│                                │ + RecordChoice(id)       │            │
│  ┌──────────────────────────┐  │ + SetFlag(key, value)    │            │
│  │   ReputationChange       │  │ + MarkHostile()          │            │
│  ├──────────────────────────┤  │ + MarkHelpful()          │            │
│  │ + FactionId: string      │  └──────────────────────────┘            │
│  │ + PreviousPoints: int    │                                          │
│  │ + NewPoints: int         │                                          │
│  │ + Delta: int             │                                          │
│  │ + PreviousLevel: RepLvl  │                                          │
│  │ + NewLevel: RepLevel     │                                          │
│  │ + LevelChanged: bool     │                                          │
│  │ + SpilloverChanges: [...]│                                          │
│  └──────────────────────────┘                                          │
│                                                                         │
│  ENUMS                                                                  │
│  ┌──────────────────────────┐                                          │
│  │     ReputationLevel      │                                          │
│  ├──────────────────────────┤                                          │
│  │ Hated = -4               │                                          │
│  │ Hostile = -3             │                                          │
│  │ Unfriendly = -2          │                                          │
│  │ Neutral = 0              │                                          │
│  │ Friendly = 1             │                                          │
│  │ Honored = 2              │                                          │
│  │ Revered = 3              │                                          │
│  │ Exalted = 4              │                                          │
│  └──────────────────────────┘                                          │
│                                                                         │
│  ENTITY UPDATES                                                         │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │                          Player                                  │   │
│  ├─────────────────────────────────────────────────────────────────┤   │
│  │ + Reputation: Dictionary<string, int>              // NEW       │   │
│  │ + GetReputation(factionId) : int                   // NEW       │   │
│  │ + ModifyReputation(factionId, delta) : void        // NEW       │   │
│  │ + GetReputationLevel(faction) : ReputationLevel    // NEW       │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │                          NPC                                     │   │
│  ├─────────────────────────────────────────────────────────────────┤   │
│  │ + Memory: Dictionary<Guid, NPCMemory>              // NEW       │   │
│  │ + GetMemory(playerId) : NPCMemory                  // NEW       │   │
│  │ + GetOrCreateMemory(playerId) : NPCMemory          // NEW       │   │
│  │ + RememberChoice(playerId, choiceId) : void        // NEW       │   │
│  │ + UpdateAttitudeFromReputation(rep, faction) : void// NEW       │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
│  FROM v0.2.0b:                                                          │
│  ┌────────────────────────────────────────────────────────────────┐    │
│  │                   DialogueContext (updated)                     │    │
│  ├────────────────────────────────────────────────────────────────┤    │
│  │ + NPCMemory: NPCMemory?                            // NEW       │    │
│  │ + GetReputation(factionId) : int                   // ENABLED   │    │
│  │ + IsFirstInteraction : bool                        // NEW       │    │
│  │ + InteractionCount : int                           // NEW       │    │
│  │ + HasMadeChoice(choiceId) : bool                   // NEW       │    │
│  └────────────────────────────────────────────────────────────────┘    │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                        INFRASTRUCTURE LAYER                             │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │                IConfigurationProvider (updated)                  │   │
│  ├─────────────────────────────────────────────────────────────────┤   │
│  │ + LoadFactionDefinitions() : IReadOnlyList<FactionDefinition>   │   │
│  │ + GetFactionDefinition(id) : FactionDefinition?                 │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
│  Configuration Files:                                                   │
│  ├── config/factions.json                                              │
│  └── config/schemas/factions.schema.json                               │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

### 3.2 Reputation Change Flow

```
┌───────────────────┐
│ Dialogue Outcome: │
│ ChangeReputation  │
│ (factionId, delta)│
└─────────┬─────────┘
          │
          ▼
┌───────────────────┐
│ ReputationService │
│ ModifyReputation()│
└─────────┬─────────┘
          │
          ▼
┌───────────────────┐
│ Get current       │
│ reputation value  │
│ from Player       │
└─────────┬─────────┘
          │
          ▼
┌───────────────────┐
│ Apply delta to    │
│ primary faction   │
└─────────┬─────────┘
          │
          ▼
┌───────────────────┐
│ Load Faction      │
│ Definition        │
└─────────┬─────────┘
          │
          ▼
┌───────────────────────────────────────────────────────────────┐
│                    SPILLOVER CALCULATION                       │
├───────────────────────────────────────────────────────────────┤
│                                                                 │
│  For each Allied Faction:                                       │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │ spillover = delta * AllySpilloverPercent / 100          │   │
│  │ (default: delta * 50% = positive spillover)             │   │
│  │ Apply spillover to ally faction                         │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                 │
│  For each Enemy Faction:                                        │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │ spillover = delta * EnemySpilloverPercent / 100         │   │
│  │ (default: delta * -25% = negative spillover)            │   │
│  │ Apply spillover to enemy faction                        │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                 │
└───────────────────────────────────────────────────────────────┘
          │
          ▼
┌───────────────────┐
│ Calculate level   │
│ changes           │
└─────────┬─────────┘
          │
          ▼
┌───────────────────┐      ┌───────────────────┐
│ Level Changed?    │──YES▶│ Update affected   │
│                   │      │ NPC attitudes     │
└─────────┬─────────┘      └───────────────────┘
          │
          NO
          │
          ▼
┌───────────────────┐
│ Return Reputation │
│ Change result     │
│ (with spillovers) │
└───────────────────┘
```

### 3.3 NPC Attitude from Reputation Flow

```
┌───────────────────┐
│ Player talks to   │
│ NPC with faction  │
└─────────┬─────────┘
          │
          ▼
┌───────────────────┐
│ Get NPC's faction │
│ from definition   │
└─────────┬─────────┘
          │
          ▼
┌───────────────────┐      ┌───────────────────┐
│ Has faction?      │──NO─▶│ Use base attitude │
│                   │      │ (no change)       │
└─────────┬─────────┘      └───────────────────┘
          │
         YES
          │
          ▼
┌───────────────────┐
│ Get player's      │
│ reputation with   │
│ faction           │
└─────────┬─────────┘
          │
          ▼
┌───────────────────┐
│ Get reputation    │
│ level from        │
│ faction thresholds│
└─────────┬─────────┘
          │
          ▼
┌───────────────────────────────────────────────────────────────┐
│                    ATTITUDE MAPPING                            │
├───────────────────────────────────────────────────────────────┤
│                                                                 │
│  ReputationLevel     →    NPCAttitude                          │
│  ─────────────────────────────────────                         │
│  Exalted, Revered    →    Friendly                             │
│  Honored, Friendly   →    Friendly                             │
│  Neutral             →    Neutral                              │
│  Unfriendly          →    Wary                                 │
│  Hostile, Hated      →    Hostile                              │
│                                                                 │
└───────────────────────────────────────────────────────────────┘
          │
          ▼
┌───────────────────┐
│ Set NPC's current │
│ attitude          │
│ (may override     │
│  base attitude)   │
└───────────────────┘
```

### 3.4 Memory-Based Dialogue Flow

```
┌───────────────────┐
│ DialogueService   │
│ BuildContext()    │
└─────────┬─────────┘
          │
          ▼
┌───────────────────┐
│ Get NPC memory    │
│ for this player   │
└─────────┬─────────┘
          │
          ▼
┌───────────────────┐      ┌───────────────────┐
│ Memory exists?    │──NO─▶│ Create new memory │
│                   │      │ (first interaction│
└─────────┬─────────┘      └───────────────────┘
          │
         YES
          │
          ▼
┌───────────────────┐
│ Populate context: │
│ - InteractionCount│
│ - ChoicesMade     │
│ - Flags           │
│ - WasHostile/     │
│   Helpful         │
└─────────┬─────────┘
          │
          ▼
┌───────────────────────────────────────────────────────────────┐
│                    CONDITION EVALUATION                        │
├───────────────────────────────────────────────────────────────┤
│                                                                 │
│  Memory-based conditions available:                             │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │ PreviousChoice: context.MadeChoice("choice-id")         │   │
│  │ FlagSet: context.HasFlag("memory-flag")                 │   │
│  │ Custom: context.InteractionCount >= N                   │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                 │
│  Example: Show "Welcome back!" only if InteractionCount > 0    │
│  Example: Show special option only if WasHelpful == true       │
│                                                                 │
└───────────────────────────────────────────────────────────────┘
          │
          ▼
┌───────────────────┐
│ After dialogue:   │
│ Record interaction│
│ Record choices    │
│ Update memory     │
└───────────────────┘
```

---

## 4. User Stories

### US-2.0c-1: View Faction Standings
**As a** player exploring the dungeon
**I want to** see my reputation with all factions
**So that** I understand my social standing

**Acceptance Criteria:**
- `reputation` command shows all discovered factions
- Each faction shows current level and points
- Progress bar shows distance to next level
- Factions are sorted by standing

### US-2.0c-2: View Specific Faction
**As a** player interested in a particular faction
**I want to** see detailed reputation information
**So that** I can track my progress with that faction

**Acceptance Criteria:**
- `reputation <faction>` shows detailed view
- Shows current level, points, and thresholds
- Shows allied and enemy factions
- Shows benefits unlocked at current level

### US-2.0c-3: Reputation Affects Dialogue
**As a** player with high/low reputation
**I want to** NPCs to treat me differently
**So that** my social choices have consequences

**Acceptance Criteria:**
- High reputation unlocks friendly dialogue options
- Low reputation blocks certain dialogue paths
- NPCs comment on player's reputation level
- Attitude changes based on faction standing

### US-2.0c-4: Reputation Spillover
**As a** player helping one faction
**I want to** reputation gains to affect allied factions
**So that** faction relationships feel interconnected

**Acceptance Criteria:**
- Gaining reputation with faction gives 50% to allies
- Gaining reputation with faction gives -25% to enemies
- Spillover is calculated automatically
- UI shows spillover effects when they occur

### US-2.0c-5: NPC Remembers Interactions
**As a** player returning to an NPC
**I want to** the NPC to remember our previous conversations
**So that** interactions feel personal and continuous

**Acceptance Criteria:**
- NPCs greet returning players differently
- Previous dialogue choices affect available options
- NPCs remember if player was hostile or helpful
- Memory persists across game sessions

### US-2.0c-6: Configure Factions via JSON
**As a** game designer
**I want to** define factions in configuration files
**So that** I can create social structures without code changes

**Acceptance Criteria:**
- Factions defined in factions.json
- Schema validation catches errors
- All faction properties are configurable
- Allied/enemy relationships are bidirectional

---

## 5. Data Models

### 5.1 FactionDefinition

```csharp
namespace RuneAndRust.Domain.Definitions;

/// <summary>
/// Configuration template for a faction that NPCs can belong to.
/// </summary>
/// <remarks>
/// FactionDefinitions are loaded from JSON configuration and define
/// the reputation thresholds, allied/enemy relationships, and spillover
/// percentages for social dynamics.
/// </remarks>
public class FactionDefinition
{
    /// <summary>
    /// Gets the unique identifier for this faction.
    /// </summary>
    /// <example>"merchant-guild", "thieves-syndicate", "adventurers-league"</example>
    public string Id { get; init; } = string.Empty;

    /// <summary>
    /// Gets the faction's display name.
    /// </summary>
    /// <example>"Merchant Guild", "Thieves' Syndicate"</example>
    public string Name { get; init; } = string.Empty;

    /// <summary>
    /// Gets the faction's description.
    /// </summary>
    /// <remarks>
    /// Shown in the reputation detail view and faction information.
    /// </remarks>
    public string Description { get; init; } = string.Empty;

    /// <summary>
    /// Gets the starting reputation value for new players.
    /// </summary>
    /// <remarks>
    /// Most factions start at 0 (Neutral). Some may start negative
    /// (hostile by default) or positive (friendly by default).
    /// </remarks>
    public int DefaultReputation { get; init; }

    /// <summary>
    /// Gets the reputation thresholds for each level.
    /// </summary>
    /// <remarks>
    /// Maps ReputationLevel to the minimum points required.
    /// Used to determine what level a player is at.
    /// </remarks>
    public IReadOnlyDictionary<ReputationLevel, int> Thresholds { get; init; }
        = new Dictionary<ReputationLevel, int>();

    /// <summary>
    /// Gets the IDs of allied factions.
    /// </summary>
    /// <remarks>
    /// When reputation changes with this faction, allies receive
    /// a positive spillover (default 50%).
    /// </remarks>
    public IReadOnlyList<string> Allies { get; init; } = [];

    /// <summary>
    /// Gets the IDs of enemy factions.
    /// </summary>
    /// <remarks>
    /// When reputation changes with this faction, enemies receive
    /// a negative spillover (default -25%).
    /// </remarks>
    public IReadOnlyList<string> Enemies { get; init; } = [];

    /// <summary>
    /// Gets the percentage of reputation change that spills over to allies.
    /// </summary>
    /// <remarks>
    /// Default is 50. A change of +100 gives allies +50.
    /// </remarks>
    public int AllySpilloverPercent { get; init; } = 50;

    /// <summary>
    /// Gets the percentage of reputation change that spills over to enemies.
    /// </summary>
    /// <remarks>
    /// Default is -25. A change of +100 gives enemies -25.
    /// Negative values mean gains hurt enemies, losses help them.
    /// </remarks>
    public int EnemySpilloverPercent { get; init; } = -25;

    /// <summary>
    /// Private constructor for deserialization.
    /// </summary>
    private FactionDefinition() { }

    /// <summary>
    /// Creates a faction definition from configuration.
    /// </summary>
    /// <param name="id">Unique identifier.</param>
    /// <param name="name">Display name.</param>
    /// <param name="description">Faction description.</param>
    /// <param name="defaultReputation">Starting reputation (default 0).</param>
    /// <param name="thresholds">Level thresholds (optional, uses defaults).</param>
    /// <param name="allies">Allied faction IDs (optional).</param>
    /// <param name="enemies">Enemy faction IDs (optional).</param>
    /// <param name="allySpilloverPercent">Ally spillover percent (default 50).</param>
    /// <param name="enemySpilloverPercent">Enemy spillover percent (default -25).</param>
    /// <returns>A new FactionDefinition instance.</returns>
    /// <exception cref="ArgumentException">Thrown if id or name is null/empty.</exception>
    public static FactionDefinition Create(
        string id,
        string name,
        string description,
        int defaultReputation = 0,
        Dictionary<ReputationLevel, int>? thresholds = null,
        IEnumerable<string>? allies = null,
        IEnumerable<string>? enemies = null,
        int allySpilloverPercent = 50,
        int enemySpilloverPercent = -25)
    {
        ArgumentException.ThrowIfNullOrWhiteSpace(id);
        ArgumentException.ThrowIfNullOrWhiteSpace(name);

        return new FactionDefinition
        {
            Id = id.ToLowerInvariant(),
            Name = name,
            Description = description ?? string.Empty,
            DefaultReputation = defaultReputation,
            Thresholds = thresholds ?? GetDefaultThresholds(),
            Allies = allies?.Select(a => a.ToLowerInvariant()).ToList() ?? [],
            Enemies = enemies?.Select(e => e.ToLowerInvariant()).ToList() ?? [],
            AllySpilloverPercent = allySpilloverPercent,
            EnemySpilloverPercent = enemySpilloverPercent
        };
    }

    /// <summary>
    /// Gets the reputation level for a given point value.
    /// </summary>
    /// <param name="reputation">The reputation points.</param>
    /// <returns>The corresponding reputation level.</returns>
    public ReputationLevel GetLevel(int reputation)
    {
        if (reputation >= Thresholds[ReputationLevel.Exalted]) return ReputationLevel.Exalted;
        if (reputation >= Thresholds[ReputationLevel.Revered]) return ReputationLevel.Revered;
        if (reputation >= Thresholds[ReputationLevel.Honored]) return ReputationLevel.Honored;
        if (reputation >= Thresholds[ReputationLevel.Friendly]) return ReputationLevel.Friendly;
        if (reputation >= Thresholds[ReputationLevel.Neutral]) return ReputationLevel.Neutral;
        if (reputation >= Thresholds[ReputationLevel.Unfriendly]) return ReputationLevel.Unfriendly;
        if (reputation >= Thresholds[ReputationLevel.Hostile]) return ReputationLevel.Hostile;
        return ReputationLevel.Hated;
    }

    /// <summary>
    /// Gets the next reputation level above the current one.
    /// </summary>
    /// <param name="current">The current level.</param>
    /// <returns>The next level, or null if already at maximum.</returns>
    public ReputationLevel? GetNextLevel(ReputationLevel current)
    {
        return current switch
        {
            ReputationLevel.Hated => ReputationLevel.Hostile,
            ReputationLevel.Hostile => ReputationLevel.Unfriendly,
            ReputationLevel.Unfriendly => ReputationLevel.Neutral,
            ReputationLevel.Neutral => ReputationLevel.Friendly,
            ReputationLevel.Friendly => ReputationLevel.Honored,
            ReputationLevel.Honored => ReputationLevel.Revered,
            ReputationLevel.Revered => ReputationLevel.Exalted,
            ReputationLevel.Exalted => null,
            _ => null
        };
    }

    /// <summary>
    /// Gets progress toward the next reputation level.
    /// </summary>
    /// <param name="reputation">Current reputation points.</param>
    /// <returns>Tuple of (current within level, needed for next, percentage).</returns>
    public (int current, int needed, int percent) GetProgressToNextLevel(int reputation)
    {
        var currentLevel = GetLevel(reputation);
        var nextLevel = GetNextLevel(currentLevel);

        if (nextLevel is null)
        {
            // Already at max level
            return (0, 0, 100);
        }

        var currentThreshold = Thresholds[currentLevel];
        var nextThreshold = Thresholds[nextLevel.Value];

        var current = reputation - currentThreshold;
        var needed = nextThreshold - currentThreshold;
        var percent = needed > 0 ? (current * 100) / needed : 100;

        return (current, needed, Math.Clamp(percent, 0, 100));
    }

    /// <summary>
    /// Gets the NPCAttitude that corresponds to a reputation level.
    /// </summary>
    /// <param name="level">The reputation level.</param>
    /// <returns>The corresponding NPC attitude.</returns>
    public static NPCAttitude GetAttitudeForLevel(ReputationLevel level)
    {
        return level switch
        {
            ReputationLevel.Exalted => NPCAttitude.Friendly,
            ReputationLevel.Revered => NPCAttitude.Friendly,
            ReputationLevel.Honored => NPCAttitude.Friendly,
            ReputationLevel.Friendly => NPCAttitude.Friendly,
            ReputationLevel.Neutral => NPCAttitude.Neutral,
            ReputationLevel.Unfriendly => NPCAttitude.Wary,
            ReputationLevel.Hostile => NPCAttitude.Hostile,
            ReputationLevel.Hated => NPCAttitude.Hostile,
            _ => NPCAttitude.Neutral
        };
    }

    /// <summary>
    /// Gets the default reputation thresholds.
    /// </summary>
    private static Dictionary<ReputationLevel, int> GetDefaultThresholds() => new()
    {
        [ReputationLevel.Hated] = int.MinValue,
        [ReputationLevel.Hostile] = -1000,
        [ReputationLevel.Unfriendly] = -500,
        [ReputationLevel.Neutral] = 0,
        [ReputationLevel.Friendly] = 500,
        [ReputationLevel.Honored] = 1000,
        [ReputationLevel.Revered] = 2000,
        [ReputationLevel.Exalted] = 3000
    };
}
```

### 5.2 ReputationLevel Enum

```csharp
namespace RuneAndRust.Domain.Enums;

/// <summary>
/// Represents standing levels with a faction.
/// </summary>
/// <remarks>
/// Numeric values are ordered from most negative (-4) to most positive (4)
/// for easy comparison. The gap between Unfriendly (-2) and Neutral (0)
/// allows for future intermediate levels if needed.
/// </remarks>
public enum ReputationLevel
{
    /// <summary>
    /// Maximum hostility - attacked on sight.
    /// </summary>
    /// <remarks>
    /// NPCs refuse all interaction and may become aggressive.
    /// Typically requires significant effort to recover from.
    /// </remarks>
    Hated = -4,

    /// <summary>
    /// NPCs refuse interaction and may attack.
    /// </summary>
    /// <remarks>
    /// Very limited or no dialogue options available.
    /// Guards may refuse entry to faction areas.
    /// </remarks>
    Hostile = -3,

    /// <summary>
    /// Limited dialogue options, poor prices.
    /// </summary>
    /// <remarks>
    /// Merchants charge higher prices. Some dialogue
    /// options are locked. NPCs are suspicious.
    /// </remarks>
    Unfriendly = -2,

    /// <summary>
    /// Standard interactions, no bonuses or penalties.
    /// </summary>
    /// <remarks>
    /// Default starting point for most factions.
    /// Standard prices and dialogue options.
    /// </remarks>
    Neutral = 0,

    /// <summary>
    /// Slightly better prices, more dialogue options.
    /// </summary>
    /// <remarks>
    /// Small discounts available. Some new dialogue
    /// paths open. NPCs are welcoming.
    /// </remarks>
    Friendly = 1,

    /// <summary>
    /// Good prices, special dialogue, respect.
    /// </summary>
    /// <remarks>
    /// Significant discounts. Access to special items.
    /// NPCs share more information willingly.
    /// </remarks>
    Honored = 2,

    /// <summary>
    /// Very good prices, unique items, high respect.
    /// </summary>
    /// <remarks>
    /// Large discounts. Unique dialogue options.
    /// May unlock faction-specific quests.
    /// </remarks>
    Revered = 3,

    /// <summary>
    /// Best prices, all options available, legendary status.
    /// </summary>
    /// <remarks>
    /// Maximum benefits. All dialogue options available.
    /// Highest level of trust and access.
    /// </remarks>
    Exalted = 4
}
```

### 5.3 ReputationStanding Value Object

```csharp
namespace RuneAndRust.Domain.ValueObjects;

/// <summary>
/// Represents a player's current standing with a faction.
/// </summary>
/// <remarks>
/// Used for display purposes and passing reputation information
/// to the presentation layer. Includes calculated progress data.
/// </remarks>
public readonly record struct ReputationStanding
{
    /// <summary>
    /// Gets the faction ID.
    /// </summary>
    public string FactionId { get; init; }

    /// <summary>
    /// Gets the faction's display name.
    /// </summary>
    public string FactionName { get; init; }

    /// <summary>
    /// Gets the current reputation points.
    /// </summary>
    public int CurrentPoints { get; init; }

    /// <summary>
    /// Gets the current reputation level.
    /// </summary>
    public ReputationLevel Level { get; init; }

    /// <summary>
    /// Gets the points needed to reach the next level.
    /// </summary>
    /// <remarks>
    /// 0 if already at maximum level (Exalted).
    /// </remarks>
    public int PointsToNextLevel { get; init; }

    /// <summary>
    /// Gets the progress percentage toward the next level.
    /// </summary>
    /// <remarks>
    /// Value from 0-100. 100 if at maximum level.
    /// </remarks>
    public int ProgressPercent { get; init; }

    /// <summary>
    /// Gets the next reputation level, if any.
    /// </summary>
    /// <remarks>
    /// Null if already at maximum level (Exalted).
    /// </remarks>
    public ReputationLevel? NextLevel { get; init; }

    /// <summary>
    /// Gets the points at which the current level starts.
    /// </summary>
    public int CurrentLevelThreshold { get; init; }

    /// <summary>
    /// Gets the points at which the next level starts.
    /// </summary>
    /// <remarks>
    /// Equal to CurrentLevelThreshold if at maximum level.
    /// </remarks>
    public int NextLevelThreshold { get; init; }

    /// <summary>
    /// Creates a reputation standing from a faction and reputation value.
    /// </summary>
    /// <param name="faction">The faction definition.</param>
    /// <param name="reputation">Current reputation points.</param>
    /// <returns>A new ReputationStanding instance.</returns>
    public static ReputationStanding Create(FactionDefinition faction, int reputation)
    {
        var level = faction.GetLevel(reputation);
        var nextLevel = faction.GetNextLevel(level);
        var (current, needed, percent) = faction.GetProgressToNextLevel(reputation);

        return new ReputationStanding
        {
            FactionId = faction.Id,
            FactionName = faction.Name,
            CurrentPoints = reputation,
            Level = level,
            PointsToNextLevel = needed - current,
            ProgressPercent = percent,
            NextLevel = nextLevel,
            CurrentLevelThreshold = faction.Thresholds[level],
            NextLevelThreshold = nextLevel.HasValue
                ? faction.Thresholds[nextLevel.Value]
                : faction.Thresholds[level]
        };
    }

    /// <summary>
    /// Gets a display string for the level.
    /// </summary>
    public string GetLevelDisplay()
    {
        return Level.ToString();
    }

    /// <summary>
    /// Gets a progress bar string.
    /// </summary>
    /// <param name="width">Total width of the progress bar.</param>
    /// <returns>ASCII progress bar.</returns>
    public string GetProgressBar(int width = 10)
    {
        if (NextLevel is null)
        {
            return new string('#', width); // Full bar at max level
        }

        var filled = (ProgressPercent * width) / 100;
        var empty = width - filled;

        return new string('#', filled) + new string('-', empty);
    }
}
```

### 5.4 ReputationChange Value Object

```csharp
namespace RuneAndRust.Domain.ValueObjects;

/// <summary>
/// Represents the result of a reputation change operation.
/// </summary>
/// <remarks>
/// Captures both the direct change and any spillover effects
/// to allied or enemy factions.
/// </remarks>
public readonly record struct ReputationChange
{
    /// <summary>
    /// Gets the faction ID that was directly affected.
    /// </summary>
    public string FactionId { get; init; }

    /// <summary>
    /// Gets the faction's display name.
    /// </summary>
    public string FactionName { get; init; }

    /// <summary>
    /// Gets the reputation before the change.
    /// </summary>
    public int PreviousPoints { get; init; }

    /// <summary>
    /// Gets the reputation after the change.
    /// </summary>
    public int NewPoints { get; init; }

    /// <summary>
    /// Gets the change amount.
    /// </summary>
    public int Delta { get; init; }

    /// <summary>
    /// Gets the level before the change.
    /// </summary>
    public ReputationLevel PreviousLevel { get; init; }

    /// <summary>
    /// Gets the level after the change.
    /// </summary>
    public ReputationLevel NewLevel { get; init; }

    /// <summary>
    /// Gets whether the level changed.
    /// </summary>
    public bool LevelChanged => PreviousLevel != NewLevel;

    /// <summary>
    /// Gets spillover changes to other factions.
    /// </summary>
    public IReadOnlyList<ReputationSpillover> SpilloverChanges { get; init; }

    /// <summary>
    /// Creates a reputation change result.
    /// </summary>
    public static ReputationChange Create(
        FactionDefinition faction,
        int previousPoints,
        int newPoints,
        IEnumerable<ReputationSpillover>? spillovers = null)
    {
        return new ReputationChange
        {
            FactionId = faction.Id,
            FactionName = faction.Name,
            PreviousPoints = previousPoints,
            NewPoints = newPoints,
            Delta = newPoints - previousPoints,
            PreviousLevel = faction.GetLevel(previousPoints),
            NewLevel = faction.GetLevel(newPoints),
            SpilloverChanges = spillovers?.ToList() ?? []
        };
    }
}

/// <summary>
/// Represents a spillover reputation change to an allied or enemy faction.
/// </summary>
public readonly record struct ReputationSpillover
{
    /// <summary>
    /// Gets the affected faction ID.
    /// </summary>
    public string FactionId { get; init; }

    /// <summary>
    /// Gets the affected faction's display name.
    /// </summary>
    public string FactionName { get; init; }

    /// <summary>
    /// Gets the spillover amount.
    /// </summary>
    public int Delta { get; init; }

    /// <summary>
    /// Gets whether this is from an ally (true) or enemy (false) relationship.
    /// </summary>
    public bool IsAlly { get; init; }

    /// <summary>
    /// Gets the new reputation level after spillover.
    /// </summary>
    public ReputationLevel NewLevel { get; init; }

    /// <summary>
    /// Gets whether the level changed due to spillover.
    /// </summary>
    public bool LevelChanged { get; init; }
}
```

### 5.5 NPCMemory Value Object

```csharp
namespace RuneAndRust.Domain.ValueObjects;

/// <summary>
/// Tracks an NPC's memory of interactions with a specific player.
/// </summary>
/// <remarks>
/// Each NPC maintains a dictionary of NPCMemory objects, one per player
/// they have interacted with. Memory persists across game sessions and
/// affects dialogue availability and NPC behavior.
/// </remarks>
public class NPCMemory
{
    /// <summary>
    /// Gets the player ID this memory belongs to.
    /// </summary>
    public Guid PlayerId { get; private set; }

    /// <summary>
    /// Gets the number of times the player has talked to this NPC.
    /// </summary>
    /// <remarks>
    /// Incremented each time dialogue is initiated.
    /// Used for "first time" vs "returning" dialogue.
    /// </remarks>
    public int InteractionCount { get; private set; }

    /// <summary>
    /// Gets the timestamp of the last interaction.
    /// </summary>
    /// <remarks>
    /// Null if never interacted. Can be used for time-based
    /// dialogue like "It's been a while since I've seen you."
    /// </remarks>
    public DateTime? LastInteraction { get; private set; }

    /// <summary>
    /// Gets dialogue choice IDs the player has made with this NPC.
    /// </summary>
    /// <remarks>
    /// Used for PreviousChoice conditions and one-time options.
    /// Only stores choices that have OptionIds defined.
    /// </remarks>
    public IReadOnlyList<string> ChoicesMade { get; private set; } = [];

    /// <summary>
    /// Gets custom memory flags for this NPC-player relationship.
    /// </summary>
    /// <remarks>
    /// Key-value pairs for tracking arbitrary state like
    /// "helped-with-quest" = "true" or "insulted" = "twice".
    /// </remarks>
    public IReadOnlyDictionary<string, string> Flags { get; private set; }
        = new Dictionary<string, string>();

    /// <summary>
    /// Gets whether the player has been hostile to this NPC.
    /// </summary>
    /// <remarks>
    /// Set when player threatens, attacks, or betrays the NPC.
    /// Permanently affects dialogue options.
    /// </remarks>
    public bool WasHostile { get; private set; }

    /// <summary>
    /// Gets whether the player has been helpful to this NPC.
    /// </summary>
    /// <remarks>
    /// Set when player helps, defends, or assists the NPC.
    /// May unlock special dialogue or rewards.
    /// </remarks>
    public bool WasHelpful { get; private set; }

    /// <summary>
    /// Private constructor for serialization.
    /// </summary>
    private NPCMemory() { }

    /// <summary>
    /// Creates a new memory instance for a player.
    /// </summary>
    /// <param name="playerId">The player's unique identifier.</param>
    /// <returns>A new NPCMemory instance.</returns>
    public static NPCMemory Create(Guid playerId)
    {
        return new NPCMemory
        {
            PlayerId = playerId,
            InteractionCount = 0,
            ChoicesMade = [],
            Flags = new Dictionary<string, string>()
        };
    }

    /// <summary>
    /// Gets whether this is the first interaction.
    /// </summary>
    public bool IsFirstInteraction => InteractionCount == 0;

    /// <summary>
    /// Records an interaction (dialogue start).
    /// </summary>
    public void RecordInteraction()
    {
        InteractionCount++;
        LastInteraction = DateTime.UtcNow;
    }

    /// <summary>
    /// Records a dialogue choice.
    /// </summary>
    /// <param name="choiceId">The option ID of the choice made.</param>
    public void RecordChoice(string choiceId)
    {
        if (string.IsNullOrWhiteSpace(choiceId)) return;

        var choices = ChoicesMade.ToList();
        if (!choices.Contains(choiceId))
        {
            choices.Add(choiceId);
            ChoicesMade = choices;
        }
    }

    /// <summary>
    /// Checks if a choice was previously made.
    /// </summary>
    /// <param name="choiceId">The option ID to check.</param>
    /// <returns>True if the choice was made.</returns>
    public bool HasMadeChoice(string choiceId)
    {
        return ChoicesMade.Contains(choiceId);
    }

    /// <summary>
    /// Sets a memory flag.
    /// </summary>
    /// <param name="key">Flag name.</param>
    /// <param name="value">Flag value.</param>
    public void SetFlag(string key, string value)
    {
        var flags = new Dictionary<string, string>(Flags)
        {
            [key] = value
        };
        Flags = flags;
    }

    /// <summary>
    /// Gets a memory flag value.
    /// </summary>
    /// <param name="key">Flag name.</param>
    /// <returns>Flag value, or null if not set.</returns>
    public string? GetFlag(string key)
    {
        return Flags.TryGetValue(key, out var value) ? value : null;
    }

    /// <summary>
    /// Checks if a flag is set.
    /// </summary>
    /// <param name="key">Flag name.</param>
    /// <returns>True if the flag exists.</returns>
    public bool HasFlag(string key)
    {
        return Flags.ContainsKey(key);
    }

    /// <summary>
    /// Records hostile behavior from the player.
    /// </summary>
    public void MarkHostile()
    {
        WasHostile = true;
    }

    /// <summary>
    /// Records helpful behavior from the player.
    /// </summary>
    public void MarkHelpful()
    {
        WasHelpful = true;
    }

    /// <summary>
    /// Clears the hostile flag (for redemption arcs).
    /// </summary>
    public void ClearHostile()
    {
        WasHostile = false;
    }
}
```

### 5.6 Player Entity Updates

```csharp
// Additions to existing Player class in RuneAndRust.Domain.Entities

/// <summary>
/// Backing field for faction reputation.
/// </summary>
private readonly Dictionary<string, int> _reputation = new();

/// <summary>
/// Gets the player's reputation with all factions.
/// </summary>
/// <remarks>
/// Key is faction ID, value is reputation points.
/// Missing entries default to the faction's DefaultReputation.
/// </remarks>
public IReadOnlyDictionary<string, int> Reputation => _reputation;

/// <summary>
/// Gets the player's reputation with a specific faction.
/// </summary>
/// <param name="factionId">The faction ID.</param>
/// <param name="defaultValue">Value to return if no reputation exists.</param>
/// <returns>The reputation points.</returns>
public int GetReputation(string factionId, int defaultValue = 0)
{
    if (string.IsNullOrWhiteSpace(factionId))
    {
        return defaultValue;
    }

    return _reputation.TryGetValue(factionId.ToLowerInvariant(), out var value)
        ? value
        : defaultValue;
}

/// <summary>
/// Modifies the player's reputation with a faction.
/// </summary>
/// <param name="factionId">The faction ID.</param>
/// <param name="delta">The change amount (positive or negative).</param>
/// <returns>The new reputation value.</returns>
public int ModifyReputation(string factionId, int delta)
{
    ArgumentException.ThrowIfNullOrWhiteSpace(factionId);

    var normalizedId = factionId.ToLowerInvariant();
    var current = GetReputation(normalizedId);
    var newValue = current + delta;

    _reputation[normalizedId] = newValue;
    return newValue;
}

/// <summary>
/// Sets the player's reputation with a faction to a specific value.
/// </summary>
/// <param name="factionId">The faction ID.</param>
/// <param name="value">The new reputation value.</param>
public void SetReputation(string factionId, int value)
{
    ArgumentException.ThrowIfNullOrWhiteSpace(factionId);
    _reputation[factionId.ToLowerInvariant()] = value;
}

/// <summary>
/// Gets the reputation level with a faction.
/// </summary>
/// <param name="faction">The faction definition.</param>
/// <returns>The current reputation level.</returns>
public ReputationLevel GetReputationLevel(FactionDefinition faction)
{
    ArgumentNullException.ThrowIfNull(faction);
    var points = GetReputation(faction.Id, faction.DefaultReputation);
    return faction.GetLevel(points);
}
```

### 5.7 NPC Entity Updates

```csharp
// Additions to existing NPC class in RuneAndRust.Domain.Entities

/// <summary>
/// Backing field for player memories.
/// </summary>
private readonly Dictionary<Guid, NPCMemory> _memory = new();

/// <summary>
/// Gets this NPC's memory of player interactions.
/// </summary>
/// <remarks>
/// Key is player ID, value is the memory record.
/// </remarks>
public IReadOnlyDictionary<Guid, NPCMemory> Memory => _memory;

/// <summary>
/// Gets this NPC's memory of a specific player.
/// </summary>
/// <param name="playerId">The player's unique identifier.</param>
/// <returns>The memory record, or null if never interacted.</returns>
public NPCMemory? GetMemory(Guid playerId)
{
    return _memory.TryGetValue(playerId, out var memory) ? memory : null;
}

/// <summary>
/// Gets or creates memory for a player.
/// </summary>
/// <param name="playerId">The player's unique identifier.</param>
/// <returns>The existing or new memory record.</returns>
public NPCMemory GetOrCreateMemory(Guid playerId)
{
    if (!_memory.TryGetValue(playerId, out var memory))
    {
        memory = NPCMemory.Create(playerId);
        _memory[playerId] = memory;
    }
    return memory;
}

/// <summary>
/// Records a dialogue choice for a player.
/// </summary>
/// <param name="playerId">The player's unique identifier.</param>
/// <param name="choiceId">The option ID of the choice made.</param>
public void RememberChoice(Guid playerId, string choiceId)
{
    var memory = GetOrCreateMemory(playerId);
    memory.RecordChoice(choiceId);
}

/// <summary>
/// Records an interaction with a player.
/// </summary>
/// <param name="playerId">The player's unique identifier.</param>
public void RecordInteraction(Guid playerId)
{
    var memory = GetOrCreateMemory(playerId);
    memory.RecordInteraction();
}

/// <summary>
/// Updates this NPC's attitude based on faction reputation.
/// </summary>
/// <param name="reputation">The player's reputation points with the faction.</param>
/// <param name="faction">The faction definition.</param>
/// <remarks>
/// Only updates if the NPC has a faction. Overrides current attitude
/// but preserves base attitude for restoration.
/// </remarks>
public void UpdateAttitudeFromReputation(int reputation, FactionDefinition faction)
{
    ArgumentNullException.ThrowIfNull(faction);

    var level = faction.GetLevel(reputation);
    var newAttitude = FactionDefinition.GetAttitudeForLevel(level);

    // Only change if reputation-based attitude is more extreme than base
    // (i.e., don't make a hostile NPC friendly just because of reputation)
    if (BaseAttitude == NPCAttitude.Hostile)
    {
        // Hostile base NPCs stay hostile unless player is Exalted
        if (level >= ReputationLevel.Exalted)
        {
            Attitude = NPCAttitude.Wary; // Best they'll do
        }
        // Otherwise stay hostile
    }
    else
    {
        Attitude = newAttitude;
    }
}
```

### 5.8 DialogueContext Updates (from v0.2.0b)

```csharp
// Additions to existing DialogueContext class

/// <summary>
/// Gets the NPC's memory of the current player.
/// </summary>
/// <remarks>
/// Null if this is the first interaction.
/// </remarks>
public NPCMemory? NPCMemory { get; init; }

/// <summary>
/// Gets whether this is the first interaction with this NPC.
/// </summary>
public bool IsFirstInteraction => NPCMemory?.IsFirstInteraction ?? true;

/// <summary>
/// Gets the number of previous interactions with this NPC.
/// </summary>
public int InteractionCount => NPCMemory?.InteractionCount ?? 0;

/// <summary>
/// Checks if a choice was previously made with this NPC.
/// </summary>
/// <param name="choiceId">The option ID to check.</param>
/// <returns>True if the choice was made.</returns>
public bool HasMadeChoiceWithNPC(string choiceId)
{
    return NPCMemory?.HasMadeChoice(choiceId) ?? false;
}

/// <summary>
/// Gets a memory flag value.
/// </summary>
/// <param name="key">Flag name.</param>
/// <returns>Flag value, or null if not set.</returns>
public string? GetMemoryFlag(string key)
{
    return NPCMemory?.GetFlag(key);
}

/// <summary>
/// Checks if a memory flag is set.
/// </summary>
/// <param name="key">Flag name.</param>
/// <returns>True if the flag exists.</returns>
public bool HasMemoryFlag(string key)
{
    return NPCMemory?.HasFlag(key) ?? false;
}
```

---

## 6. Configuration Schemas

### 6.1 factions.json

```json
{
  "$schema": "../schemas/factions.schema.json",
  "factions": [
    {
      "id": "merchant-guild",
      "name": "Merchant Guild",
      "description": "A network of traders and shopkeepers who control commerce in the dungeon depths. They value fair dealing and profitable ventures.",
      "defaultReputation": 0,
      "thresholds": {
        "hated": -2000,
        "hostile": -1000,
        "unfriendly": -500,
        "neutral": 0,
        "friendly": 500,
        "honored": 1000,
        "revered": 2000,
        "exalted": 3000
      },
      "allies": ["adventurers-league"],
      "enemies": ["thieves-syndicate"],
      "allySpilloverPercent": 50,
      "enemySpilloverPercent": -25
    },
    {
      "id": "thieves-syndicate",
      "name": "Thieves' Syndicate",
      "description": "A shadowy network of rogues and cutthroats operating in the dungeon depths. They respect cunning and discretion.",
      "defaultReputation": -200,
      "thresholds": {
        "hated": -2000,
        "hostile": -1000,
        "unfriendly": -500,
        "neutral": 0,
        "friendly": 500,
        "honored": 1000,
        "revered": 2000,
        "exalted": 3000
      },
      "allies": [],
      "enemies": ["merchant-guild"],
      "allySpilloverPercent": 50,
      "enemySpilloverPercent": -25
    },
    {
      "id": "adventurers-league",
      "name": "Adventurer's League",
      "description": "A loose confederation of dungeon delvers, treasure hunters, and glory seekers. They value bravery and camaraderie.",
      "defaultReputation": 0,
      "thresholds": {
        "hated": -2000,
        "hostile": -1000,
        "unfriendly": -500,
        "neutral": 0,
        "friendly": 500,
        "honored": 1000,
        "revered": 2000,
        "exalted": 3000
      },
      "allies": ["merchant-guild", "seekers-of-knowledge"],
      "enemies": [],
      "allySpilloverPercent": 40,
      "enemySpilloverPercent": -20
    },
    {
      "id": "seekers-of-knowledge",
      "name": "Seekers of Knowledge",
      "description": "Scholars, sages, and mystics dedicated to uncovering the dungeon's ancient secrets. They value wisdom and discovery.",
      "defaultReputation": 0,
      "thresholds": {
        "hated": -1500,
        "hostile": -750,
        "unfriendly": -300,
        "neutral": 0,
        "friendly": 300,
        "honored": 750,
        "revered": 1500,
        "exalted": 2500
      },
      "allies": ["adventurers-league"],
      "enemies": [],
      "allySpilloverPercent": 60,
      "enemySpilloverPercent": -30
    },
    {
      "id": "dungeon-wardens",
      "name": "Dungeon Wardens",
      "description": "The mysterious guardians who maintain order in the deeper levels. Their motives and origins are unknown.",
      "defaultReputation": -100,
      "thresholds": {
        "hated": -3000,
        "hostile": -1500,
        "unfriendly": -500,
        "neutral": 0,
        "friendly": 1000,
        "honored": 2000,
        "revered": 3500,
        "exalted": 5000
      },
      "allies": [],
      "enemies": ["thieves-syndicate"],
      "allySpilloverPercent": 25,
      "enemySpilloverPercent": -50
    }
  ]
}
```

### 6.2 factions.schema.json

```json
{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "title": "Faction Configuration",
  "description": "Defines factions and their reputation thresholds for the game",
  "type": "object",
  "required": ["factions"],
  "properties": {
    "factions": {
      "type": "array",
      "description": "List of faction definitions",
      "items": {
        "$ref": "#/definitions/factionDefinition"
      }
    }
  },
  "definitions": {
    "factionDefinition": {
      "type": "object",
      "required": ["id", "name", "description"],
      "properties": {
        "id": {
          "type": "string",
          "pattern": "^[a-z][a-z0-9-]*$",
          "description": "Unique identifier (lowercase, alphanumeric with hyphens)"
        },
        "name": {
          "type": "string",
          "minLength": 1,
          "maxLength": 100,
          "description": "Display name of the faction"
        },
        "description": {
          "type": "string",
          "minLength": 10,
          "maxLength": 500,
          "description": "Description of the faction's purpose and values"
        },
        "defaultReputation": {
          "type": "integer",
          "default": 0,
          "description": "Starting reputation for new players"
        },
        "thresholds": {
          "$ref": "#/definitions/reputationThresholds"
        },
        "allies": {
          "type": "array",
          "items": {
            "type": "string",
            "pattern": "^[a-z][a-z0-9-]*$"
          },
          "description": "IDs of allied factions"
        },
        "enemies": {
          "type": "array",
          "items": {
            "type": "string",
            "pattern": "^[a-z][a-z0-9-]*$"
          },
          "description": "IDs of enemy factions"
        },
        "allySpilloverPercent": {
          "type": "integer",
          "minimum": 0,
          "maximum": 100,
          "default": 50,
          "description": "Percentage of reputation change that spills to allies"
        },
        "enemySpilloverPercent": {
          "type": "integer",
          "minimum": -100,
          "maximum": 0,
          "default": -25,
          "description": "Percentage of reputation change that spills to enemies (negative)"
        }
      }
    },
    "reputationThresholds": {
      "type": "object",
      "description": "Reputation point thresholds for each level",
      "properties": {
        "hated": {
          "type": "integer",
          "description": "Threshold for Hated level"
        },
        "hostile": {
          "type": "integer",
          "description": "Threshold for Hostile level"
        },
        "unfriendly": {
          "type": "integer",
          "description": "Threshold for Unfriendly level"
        },
        "neutral": {
          "type": "integer",
          "description": "Threshold for Neutral level"
        },
        "friendly": {
          "type": "integer",
          "description": "Threshold for Friendly level"
        },
        "honored": {
          "type": "integer",
          "description": "Threshold for Honored level"
        },
        "revered": {
          "type": "integer",
          "description": "Threshold for Revered level"
        },
        "exalted": {
          "type": "integer",
          "description": "Threshold for Exalted level"
        }
      },
      "additionalProperties": false
    }
  }
}
```

---

## 7. Service Specifications

### 7.1 IReputationService Interface

```csharp
namespace RuneAndRust.Application.Interfaces;

/// <summary>
/// Provides operations for faction reputation management.
/// </summary>
public interface IReputationService
{
    /// <summary>
    /// Gets all faction definitions.
    /// </summary>
    /// <returns>List of all faction definitions.</returns>
    IReadOnlyList<FactionDefinition> GetAllFactions();

    /// <summary>
    /// Gets a faction definition by ID.
    /// </summary>
    /// <param name="factionId">The faction ID.</param>
    /// <returns>The faction definition, or null if not found.</returns>
    FactionDefinition? GetFactionDefinition(string factionId);

    /// <summary>
    /// Gets the player's current reputation with a faction.
    /// </summary>
    /// <param name="player">The player.</param>
    /// <param name="factionId">The faction ID.</param>
    /// <returns>The reputation points.</returns>
    int GetPlayerReputation(Player player, string factionId);

    /// <summary>
    /// Gets the player's reputation level with a faction.
    /// </summary>
    /// <param name="player">The player.</param>
    /// <param name="faction">The faction definition.</param>
    /// <returns>The reputation level.</returns>
    ReputationLevel GetReputationLevel(Player player, FactionDefinition faction);

    /// <summary>
    /// Modifies the player's reputation with a faction.
    /// </summary>
    /// <param name="player">The player.</param>
    /// <param name="factionId">The faction ID.</param>
    /// <param name="delta">The change amount.</param>
    /// <returns>The reputation change result with spillover effects.</returns>
    ReputationChange ModifyReputation(Player player, string factionId, int delta);

    /// <summary>
    /// Gets the player's standing with a faction.
    /// </summary>
    /// <param name="player">The player.</param>
    /// <param name="faction">The faction definition.</param>
    /// <returns>The reputation standing.</returns>
    ReputationStanding GetReputationStanding(Player player, FactionDefinition faction);

    /// <summary>
    /// Gets the player's standings with all known factions.
    /// </summary>
    /// <param name="player">The player.</param>
    /// <returns>List of all reputation standings.</returns>
    IReadOnlyList<ReputationStanding> GetAllStandings(Player player);
}
```

### 7.2 ReputationService Implementation

```csharp
namespace RuneAndRust.Application.Services;

/// <summary>
/// Manages faction reputation tracking and spillover calculations.
/// </summary>
public class ReputationService : IReputationService
{
    private readonly IReadOnlyList<FactionDefinition> _factions;
    private readonly Dictionary<string, FactionDefinition> _factionLookup;
    private readonly ILogger<ReputationService> _logger;

    /// <summary>
    /// Initializes a new instance of ReputationService.
    /// </summary>
    /// <param name="configProvider">Configuration provider for loading factions.</param>
    /// <param name="logger">Logger instance.</param>
    public ReputationService(
        IConfigurationProvider configProvider,
        ILogger<ReputationService> logger)
    {
        _logger = logger;
        _factions = configProvider.LoadFactionDefinitions();
        _factionLookup = _factions.ToDictionary(f => f.Id, StringComparer.OrdinalIgnoreCase);

        _logger.LogInformation(
            "ReputationService initialized with {FactionCount} factions",
            _factions.Count);
    }

    /// <inheritdoc/>
    public IReadOnlyList<FactionDefinition> GetAllFactions()
    {
        _logger.LogDebug("GetAllFactions called");
        return _factions;
    }

    /// <inheritdoc/>
    public FactionDefinition? GetFactionDefinition(string factionId)
    {
        _logger.LogDebug("GetFactionDefinition called for ID: {FactionId}", factionId);
        return _factionLookup.TryGetValue(factionId, out var faction) ? faction : null;
    }

    /// <inheritdoc/>
    public int GetPlayerReputation(Player player, string factionId)
    {
        ArgumentNullException.ThrowIfNull(player);
        ArgumentException.ThrowIfNullOrWhiteSpace(factionId);

        var faction = GetFactionDefinition(factionId);
        var defaultValue = faction?.DefaultReputation ?? 0;

        return player.GetReputation(factionId, defaultValue);
    }

    /// <inheritdoc/>
    public ReputationLevel GetReputationLevel(Player player, FactionDefinition faction)
    {
        ArgumentNullException.ThrowIfNull(player);
        ArgumentNullException.ThrowIfNull(faction);

        var points = GetPlayerReputation(player, faction.Id);
        return faction.GetLevel(points);
    }

    /// <inheritdoc/>
    public ReputationChange ModifyReputation(Player player, string factionId, int delta)
    {
        ArgumentNullException.ThrowIfNull(player);
        ArgumentException.ThrowIfNullOrWhiteSpace(factionId);

        var faction = GetFactionDefinition(factionId);
        if (faction is null)
        {
            _logger.LogWarning("Attempted to modify reputation for unknown faction: {FactionId}", factionId);
            throw new ArgumentException($"Unknown faction: {factionId}", nameof(factionId));
        }

        var previousPoints = GetPlayerReputation(player, factionId);
        var newPoints = player.ModifyReputation(factionId, delta);

        _logger.LogInformation(
            "Player {PlayerName} reputation with {FactionName}: {Previous} -> {New} ({Delta:+#;-#;0})",
            player.Name, faction.Name, previousPoints, newPoints, delta);

        // Calculate spillover effects
        var spillovers = new List<ReputationSpillover>();

        // Apply to allies
        foreach (var allyId in faction.Allies)
        {
            var ally = GetFactionDefinition(allyId);
            if (ally is null) continue;

            var allyDelta = (delta * faction.AllySpilloverPercent) / 100;
            if (allyDelta == 0) continue;

            var allyPrevious = GetPlayerReputation(player, allyId);
            var allyNew = player.ModifyReputation(allyId, allyDelta);
            var allyPreviousLevel = ally.GetLevel(allyPrevious);
            var allyNewLevel = ally.GetLevel(allyNew);

            spillovers.Add(new ReputationSpillover
            {
                FactionId = ally.Id,
                FactionName = ally.Name,
                Delta = allyDelta,
                IsAlly = true,
                NewLevel = allyNewLevel,
                LevelChanged = allyPreviousLevel != allyNewLevel
            });

            _logger.LogDebug(
                "Spillover to ally {FactionName}: {Delta:+#;-#;0}",
                ally.Name, allyDelta);
        }

        // Apply to enemies
        foreach (var enemyId in faction.Enemies)
        {
            var enemy = GetFactionDefinition(enemyId);
            if (enemy is null) continue;

            var enemyDelta = (delta * faction.EnemySpilloverPercent) / 100;
            if (enemyDelta == 0) continue;

            var enemyPrevious = GetPlayerReputation(player, enemyId);
            var enemyNew = player.ModifyReputation(enemyId, enemyDelta);
            var enemyPreviousLevel = enemy.GetLevel(enemyPrevious);
            var enemyNewLevel = enemy.GetLevel(enemyNew);

            spillovers.Add(new ReputationSpillover
            {
                FactionId = enemy.Id,
                FactionName = enemy.Name,
                Delta = enemyDelta,
                IsAlly = false,
                NewLevel = enemyNewLevel,
                LevelChanged = enemyPreviousLevel != enemyNewLevel
            });

            _logger.LogDebug(
                "Spillover to enemy {FactionName}: {Delta:+#;-#;0}",
                enemy.Name, enemyDelta);
        }

        return ReputationChange.Create(faction, previousPoints, newPoints, spillovers);
    }

    /// <inheritdoc/>
    public ReputationStanding GetReputationStanding(Player player, FactionDefinition faction)
    {
        ArgumentNullException.ThrowIfNull(player);
        ArgumentNullException.ThrowIfNull(faction);

        var points = GetPlayerReputation(player, faction.Id);
        return ReputationStanding.Create(faction, points);
    }

    /// <inheritdoc/>
    public IReadOnlyList<ReputationStanding> GetAllStandings(Player player)
    {
        ArgumentNullException.ThrowIfNull(player);

        return _factions
            .Select(f => GetReputationStanding(player, f))
            .OrderByDescending(s => s.CurrentPoints)
            .ToList();
    }
}
```

### 7.3 GameSessionService Updates

```csharp
// Additions to existing GameSessionService

private readonly IReputationService _reputationService;

/// <summary>
/// Gets a summary of the player's reputation with all factions.
/// </summary>
/// <returns>List of reputation standings.</returns>
public IReadOnlyList<ReputationStanding> GetReputationSummary()
{
    EnsureGameStarted();

    _logger.LogDebug("GetReputationSummary called");
    return _reputationService.GetAllStandings(_player!);
}

/// <summary>
/// Gets the player's reputation standing with a specific faction.
/// </summary>
/// <param name="factionId">The faction ID.</param>
/// <returns>The reputation standing, or null if faction not found.</returns>
public ReputationStanding? GetFactionReputation(string factionId)
{
    EnsureGameStarted();

    _logger.LogDebug("GetFactionReputation called for: {FactionId}", factionId);

    var faction = _reputationService.GetFactionDefinition(factionId);
    if (faction is null)
    {
        _logger.LogDebug("Faction not found: {FactionId}", factionId);
        return null;
    }

    return _reputationService.GetReputationStanding(_player!, faction);
}
```

### 7.4 DialogueService Updates

```csharp
// Updates to existing DialogueService for ChangeReputation outcome

/// <summary>
/// Applies dialogue outcomes to the game state.
/// </summary>
/// <param name="outcomes">Outcomes to apply.</param>
/// <param name="player">The player.</param>
/// <param name="npc">The NPC.</param>
private void ApplyOutcomes(
    IEnumerable<DialogueOutcome> outcomes,
    Player player,
    NPC npc)
{
    foreach (var outcome in outcomes)
    {
        switch (outcome.Type)
        {
            // Existing outcomes...

            case OutcomeType.ChangeReputation:
                ApplyReputationChange(outcome, player);
                break;

            // Other outcomes...
        }
    }
}

/// <summary>
/// Applies a reputation change outcome.
/// </summary>
private void ApplyReputationChange(DialogueOutcome outcome, Player player)
{
    var change = _reputationService.ModifyReputation(
        player,
        outcome.TargetId,
        outcome.Value);

    _logger.LogInformation(
        "Dialogue outcome: {FactionName} reputation {Delta:+#;-#;0} ({Previous} -> {New})",
        change.FactionName, change.Delta, change.PreviousPoints, change.NewPoints);

    if (change.LevelChanged)
    {
        _logger.LogInformation(
            "Reputation level changed: {PreviousLevel} -> {NewLevel}",
            change.PreviousLevel, change.NewLevel);
    }
}

/// <summary>
/// Builds a dialogue context including NPC memory.
/// </summary>
private DialogueContext BuildContext(Player player, NPC npc)
{
    var memory = npc.GetMemory(player.Id);

    return new DialogueContext
    {
        Player = player,
        NPC = npc,
        NPCMemory = memory,
        // ... other context properties
    };
}
```

### 7.5 NPCService Updates

```csharp
// Additions to existing NPCService

private readonly IReputationService _reputationService;

/// <summary>
/// Updates an NPC's attitude based on the player's faction reputation.
/// </summary>
/// <param name="npc">The NPC to update.</param>
/// <param name="player">The player.</param>
public void UpdateNPCAttitudeFromReputation(NPC npc, Player player)
{
    ArgumentNullException.ThrowIfNull(npc);
    ArgumentNullException.ThrowIfNull(player);

    // Get NPC's faction
    var definition = GetNPCDefinition(npc.DefinitionId);
    if (definition?.FactionId is null)
    {
        return; // No faction, attitude unchanged
    }

    var faction = _reputationService.GetFactionDefinition(definition.FactionId);
    if (faction is null)
    {
        _logger.LogWarning(
            "NPC {NPCName} has unknown faction: {FactionId}",
            npc.Name, definition.FactionId);
        return;
    }

    var reputation = _reputationService.GetPlayerReputation(player, faction.Id);
    npc.UpdateAttitudeFromReputation(reputation, faction);

    _logger.LogDebug(
        "Updated {NPCName} attitude from {FactionName} reputation ({Points} = {Level})",
        npc.Name, faction.Name, reputation, faction.GetLevel(reputation));
}

/// <summary>
/// Records an interaction between an NPC and player.
/// </summary>
/// <param name="npc">The NPC.</param>
/// <param name="player">The player.</param>
public void RecordInteraction(NPC npc, Player player)
{
    ArgumentNullException.ThrowIfNull(npc);
    ArgumentNullException.ThrowIfNull(player);

    npc.RecordInteraction(player.Id);

    _logger.LogDebug(
        "Recorded interaction: {PlayerName} with {NPCName} (count: {Count})",
        player.Name, npc.Name, npc.GetMemory(player.Id)?.InteractionCount ?? 1);
}

/// <summary>
/// Records a dialogue choice made by a player with an NPC.
/// </summary>
/// <param name="npc">The NPC.</param>
/// <param name="player">The player.</param>
/// <param name="choiceId">The option ID of the choice.</param>
public void RecordChoice(NPC npc, Player player, string choiceId)
{
    ArgumentNullException.ThrowIfNull(npc);
    ArgumentNullException.ThrowIfNull(player);

    if (string.IsNullOrWhiteSpace(choiceId)) return;

    npc.RememberChoice(player.Id, choiceId);

    _logger.LogDebug(
        "Recorded choice: {PlayerName} chose '{ChoiceId}' with {NPCName}",
        player.Name, choiceId, npc.Name);
}
```

### 7.6 IConfigurationProvider Updates

```csharp
// Additions to IConfigurationProvider interface

/// <summary>
/// Loads all faction definitions from configuration.
/// </summary>
/// <returns>List of faction definitions.</returns>
IReadOnlyList<FactionDefinition> LoadFactionDefinitions();

/// <summary>
/// Gets a specific faction definition by ID.
/// </summary>
/// <param name="id">The faction ID.</param>
/// <returns>The faction definition, or null if not found.</returns>
FactionDefinition? GetFactionDefinition(string id);
```

---

## 8. Reputation Command Flow

### 8.1 Command Parsing

```csharp
// In InputHandler or CommandParser

/// <summary>
/// Parses a reputation command.
/// </summary>
/// <param name="input">The raw input string.</param>
/// <returns>Parsed command information.</returns>
public CommandInfo ParseReputationCommand(string input)
{
    var parts = input.Trim().Split(' ', 2, StringSplitOptions.RemoveEmptyEntries);

    if (parts.Length == 0 ||
        !parts[0].Equals("reputation", StringComparison.OrdinalIgnoreCase) &&
        !parts[0].Equals("rep", StringComparison.OrdinalIgnoreCase))
    {
        return CommandInfo.Invalid("Invalid command");
    }

    var factionName = parts.Length > 1 ? parts[1].Trim() : null;

    return new CommandInfo
    {
        Command = CommandType.Reputation,
        TargetName = factionName
    };
}
```

### 8.2 Command Execution Flow

```
User Input: "reputation" or "rep merchant"
    │
    ▼
┌─────────────────┐
│  InputHandler   │
│ ParseRepCmd()   │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│GameSessionSvc   │
│GetReputation()  │
└────────┬────────┘
         │
    ┌────┴────┐
    │         │
    ▼         ▼
No Target   Has Target
    │         │
    ▼         ▼
┌─────────┐  ┌─────────┐
│GetAll   │  │GetSingle│
│Standings│  │Standing │
└────┬────┘  └────┬────┘
     │            │
     ▼            ▼
┌───────────────────────┐
│   IGameRenderer       │
│ RenderReputationView()│
└───────────────────────┘
```

---

## 9. User-Facing Changes

### 9.1 Commands

```
> reputation              # View all faction standings
> rep                     # Shorthand for reputation
> reputation <faction>    # View specific faction detail
> rep merchant            # View Merchant Guild standing
```

### 9.2 Output Examples

#### All Factions View

```
╔════════════════════════════════════════════════════════════════════════╗
║                         YOUR REPUTATION                                 ║
╠════════════════════════════════════════════════════════════════════════╣
║                                                                        ║
║  Merchant Guild: Friendly (750/1000 to Honored)                        ║
║  [########--] 75%                                                      ║
║                                                                        ║
║  ─────────────────────────────────────────────────────────────────     ║
║                                                                        ║
║  Adventurer's League: Neutral (0/500 to Friendly)                      ║
║  [----------] 0%                                                       ║
║                                                                        ║
║  ─────────────────────────────────────────────────────────────────     ║
║                                                                        ║
║  Thieves' Syndicate: Unfriendly (-350/500 to Neutral)                  ║
║  [###-------] 30%                                                      ║
║                                                                        ║
║  ─────────────────────────────────────────────────────────────────     ║
║                                                                        ║
║  Seekers of Knowledge: Neutral (100/300 to Friendly)                   ║
║  [###-------] 33%                                                      ║
║                                                                        ║
╚════════════════════════════════════════════════════════════════════════╝
```

#### Specific Faction View

```
> reputation merchant

╔════════════════════════════════════════════════════════════════════════╗
║                         MERCHANT GUILD                                  ║
╠════════════════════════════════════════════════════════════════════════╣
║                                                                        ║
║  A network of traders and shopkeepers who control commerce in the      ║
║  dungeon depths. They value fair dealing and profitable ventures.      ║
║                                                                        ║
║  ─────────────────────────────────────────────────────────────────     ║
║                                                                        ║
║  Current Standing: FRIENDLY                                            ║
║  Reputation: 750 points                                                ║
║                                                                        ║
║  Progress to Honored:                                                  ║
║  [########--] 750/1000 (75%)                                           ║
║                                                                        ║
║  ─────────────────────────────────────────────────────────────────     ║
║                                                                        ║
║  Level Thresholds:                                                     ║
║    Hated     ────── -2000                                              ║
║    Hostile   ────── -1000                                              ║
║    Unfriendly ───── -500                                               ║
║    Neutral   ────── 0                                                  ║
║  > Friendly  ────── 500    ← You are here                              ║
║    Honored   ────── 1000                                               ║
║    Revered   ────── 2000                                               ║
║    Exalted   ────── 3000                                               ║
║                                                                        ║
║  ─────────────────────────────────────────────────────────────────     ║
║                                                                        ║
║  Relationships:                                                        ║
║  Allies: Adventurer's League                                           ║
║  Enemies: Thieves' Syndicate                                           ║
║                                                                        ║
╚════════════════════════════════════════════════════════════════════════╝
```

#### Reputation Change Notification

```
> [Select dialogue option that affects reputation]

"Thank you for helping us deal with those thieves. The Guild remembers
its friends."

┌─────────────────────────────────────────────────────────────────────────┐
│ REPUTATION CHANGED                                                      │
│                                                                         │
│ Merchant Guild: +100 (650 → 750) [Friendly]                             │
│                                                                         │
│ Spillover:                                                              │
│   Adventurer's League: +50 (0 → 50) [Neutral]                           │
│   Thieves' Syndicate: -25 (-350 → -375) [Unfriendly]                    │
└─────────────────────────────────────────────────────────────────────────┘
```

#### NPC Remembers Player

```
> talk grimbold

Grimbold looks up and his face breaks into a wide grin.

"Ah, my favorite customer returns! It's been too long since your last
visit. I've set aside some special items just for you."

[The Merchant Guild's reputation unlocked new dialogue options]

[1] What special items do you have? (Friendly)
[2] I need to stock up on supplies.
[3] Any news from the depths?
[4] I remember you helped me before... (Returning player)
[5] Goodbye for now.
```

---

## 10. Logging Requirements

### 10.1 Log Events

| Event | Level | Message Template | Properties |
|-------|-------|------------------|------------|
| Service Init | Information | "ReputationService initialized with {FactionCount} factions" | FactionCount |
| Faction Loaded | Debug | "Loaded faction: {FactionId} ({FactionName})" | FactionId, FactionName |
| Rep Modified | Information | "Player {PlayerName} reputation with {FactionName}: {Previous} -> {New} ({Delta:+#;-#;0})" | PlayerName, FactionName, Previous, New, Delta |
| Level Changed | Information | "Reputation level changed: {PreviousLevel} -> {NewLevel}" | PreviousLevel, NewLevel |
| Spillover Applied | Debug | "Spillover to {RelationType} {FactionName}: {Delta:+#;-#;0}" | RelationType, FactionName, Delta |
| Attitude Updated | Debug | "Updated {NPCName} attitude from {FactionName} reputation ({Points} = {Level})" | NPCName, FactionName, Points, Level |
| Interaction Recorded | Debug | "Recorded interaction: {PlayerName} with {NPCName} (count: {Count})" | PlayerName, NPCName, Count |
| Choice Recorded | Debug | "Recorded choice: {PlayerName} chose '{ChoiceId}' with {NPCName}" | PlayerName, ChoiceId, NPCName |
| Unknown Faction | Warning | "Attempted to modify reputation for unknown faction: {FactionId}" | FactionId |
| Config Error | Error | "Failed to load faction definitions: {ErrorMessage}" | ErrorMessage |

### 10.2 Example Log Output

```
[2024-01-15 10:30:15 INF] ReputationService initialized with 5 factions
[2024-01-15 10:30:15 DBG] Loaded faction: merchant-guild (Merchant Guild)
[2024-01-15 10:30:15 DBG] Loaded faction: thieves-syndicate (Thieves' Syndicate)
[2024-01-15 10:35:20 DBG] Recorded interaction: Astrid with Grimbold (count: 3)
[2024-01-15 10:36:45 INF] Player Astrid reputation with Merchant Guild: 650 -> 750 (+100)
[2024-01-15 10:36:45 DBG] Spillover to ally Adventurer's League: +50
[2024-01-15 10:36:45 DBG] Spillover to enemy Thieves' Syndicate: -25
[2024-01-15 10:36:45 DBG] Updated Grimbold attitude from Merchant Guild reputation (750 = Friendly)
[2024-01-15 10:37:12 DBG] Recorded choice: Astrid chose 'helped-merchant' with Grimbold
```

---

## 11. Unit Test Specifications

### 11.1 FactionDefinition Tests (~6 tests)

```csharp
namespace RuneAndRust.Domain.Tests.Definitions;

[TestFixture]
public class FactionDefinitionTests
{
    [Test]
    public void Create_WithValidParameters_ReturnsFaction()
    {
        var faction = FactionDefinition.Create(
            "test-faction",
            "Test Faction",
            "A test faction for testing.");

        faction.Id.Should().Be("test-faction");
        faction.Name.Should().Be("Test Faction");
        faction.DefaultReputation.Should().Be(0);
    }

    [Test]
    public void Create_WithNullId_ThrowsArgumentException()
    {
        var act = () => FactionDefinition.Create(null!, "Name", "Description");

        act.Should().Throw<ArgumentException>();
    }

    [Test]
    public void Create_NormalizesIdToLowercase()
    {
        var faction = FactionDefinition.Create(
            "TEST-FACTION", "Test", "Description");

        faction.Id.Should().Be("test-faction");
    }

    [Test]
    public void GetLevel_ReturnsCorrectLevel()
    {
        var faction = FactionDefinition.Create("test", "Test", "Desc");

        faction.GetLevel(0).Should().Be(ReputationLevel.Neutral);
        faction.GetLevel(500).Should().Be(ReputationLevel.Friendly);
        faction.GetLevel(3000).Should().Be(ReputationLevel.Exalted);
        faction.GetLevel(-1000).Should().Be(ReputationLevel.Hostile);
    }

    [Test]
    public void GetProgressToNextLevel_CalculatesCorrectly()
    {
        var faction = FactionDefinition.Create("test", "Test", "Desc");

        var (current, needed, percent) = faction.GetProgressToNextLevel(250);

        current.Should().Be(250); // 250 into Neutral
        needed.Should().Be(500);  // 500 needed for Friendly
        percent.Should().Be(50);  // 50% progress
    }

    [Test]
    public void GetAttitudeForLevel_MapsCorrectly()
    {
        FactionDefinition.GetAttitudeForLevel(ReputationLevel.Exalted)
            .Should().Be(NPCAttitude.Friendly);
        FactionDefinition.GetAttitudeForLevel(ReputationLevel.Neutral)
            .Should().Be(NPCAttitude.Neutral);
        FactionDefinition.GetAttitudeForLevel(ReputationLevel.Hostile)
            .Should().Be(NPCAttitude.Hostile);
    }
}
```

### 11.2 ReputationStanding Tests (~4 tests)

```csharp
[TestFixture]
public class ReputationStandingTests
{
    private FactionDefinition _faction;

    [SetUp]
    public void Setup()
    {
        _faction = FactionDefinition.Create("test", "Test Faction", "Description");
    }

    [Test]
    public void Create_PopulatesAllFields()
    {
        var standing = ReputationStanding.Create(_faction, 750);

        standing.FactionId.Should().Be("test");
        standing.Level.Should().Be(ReputationLevel.Friendly);
        standing.CurrentPoints.Should().Be(750);
        standing.NextLevel.Should().Be(ReputationLevel.Honored);
    }

    [Test]
    public void Create_AtMaxLevel_HasNullNextLevel()
    {
        var standing = ReputationStanding.Create(_faction, 5000);

        standing.Level.Should().Be(ReputationLevel.Exalted);
        standing.NextLevel.Should().BeNull();
        standing.ProgressPercent.Should().Be(100);
    }

    [Test]
    public void GetProgressBar_ReturnsCorrectBar()
    {
        var standing = ReputationStanding.Create(_faction, 250);

        var bar = standing.GetProgressBar(10);

        bar.Should().Be("#####-----");
    }

    [Test]
    public void GetProgressBar_AtMaxLevel_ReturnsFull()
    {
        var standing = ReputationStanding.Create(_faction, 5000);

        var bar = standing.GetProgressBar(10);

        bar.Should().Be("##########");
    }
}
```

### 11.3 NPCMemory Tests (~6 tests)

```csharp
[TestFixture]
public class NPCMemoryTests
{
    [Test]
    public void Create_InitializesWithZeroInteractions()
    {
        var playerId = Guid.NewGuid();
        var memory = NPCMemory.Create(playerId);

        memory.PlayerId.Should().Be(playerId);
        memory.InteractionCount.Should().Be(0);
        memory.IsFirstInteraction.Should().BeTrue();
    }

    [Test]
    public void RecordInteraction_IncrementsCount()
    {
        var memory = NPCMemory.Create(Guid.NewGuid());

        memory.RecordInteraction();

        memory.InteractionCount.Should().Be(1);
        memory.IsFirstInteraction.Should().BeFalse();
        memory.LastInteraction.Should().BeCloseTo(DateTime.UtcNow, TimeSpan.FromSeconds(1));
    }

    [Test]
    public void RecordChoice_AddsToList()
    {
        var memory = NPCMemory.Create(Guid.NewGuid());

        memory.RecordChoice("choice-1");
        memory.RecordChoice("choice-2");

        memory.ChoicesMade.Should().Contain("choice-1");
        memory.ChoicesMade.Should().Contain("choice-2");
    }

    [Test]
    public void RecordChoice_DoesNotDuplicate()
    {
        var memory = NPCMemory.Create(Guid.NewGuid());

        memory.RecordChoice("choice-1");
        memory.RecordChoice("choice-1");

        memory.ChoicesMade.Should().HaveCount(1);
    }

    [Test]
    public void SetFlag_StoresValue()
    {
        var memory = NPCMemory.Create(Guid.NewGuid());

        memory.SetFlag("helped", "true");

        memory.GetFlag("helped").Should().Be("true");
        memory.HasFlag("helped").Should().BeTrue();
    }

    [Test]
    public void MarkHostile_SetsFlag()
    {
        var memory = NPCMemory.Create(Guid.NewGuid());

        memory.MarkHostile();

        memory.WasHostile.Should().BeTrue();
    }
}
```

### 11.4 Player Reputation Tests (~5 tests)

```csharp
[TestFixture]
public class PlayerReputationTests
{
    private Player _player;
    private FactionDefinition _faction;

    [SetUp]
    public void Setup()
    {
        _player = Player.Create("Test Player");
        _faction = FactionDefinition.Create("test-faction", "Test", "Desc");
    }

    [Test]
    public void GetReputation_WhenNotSet_ReturnsDefault()
    {
        var rep = _player.GetReputation("unknown-faction", defaultValue: -100);

        rep.Should().Be(-100);
    }

    [Test]
    public void ModifyReputation_AddsToExisting()
    {
        _player.ModifyReputation("test-faction", 100);
        _player.ModifyReputation("test-faction", 50);

        _player.GetReputation("test-faction").Should().Be(150);
    }

    [Test]
    public void ModifyReputation_HandlesNegative()
    {
        _player.ModifyReputation("test-faction", -500);

        _player.GetReputation("test-faction").Should().Be(-500);
    }

    [Test]
    public void SetReputation_OverwritesExisting()
    {
        _player.ModifyReputation("test-faction", 100);
        _player.SetReputation("test-faction", 500);

        _player.GetReputation("test-faction").Should().Be(500);
    }

    [Test]
    public void GetReputationLevel_UsesFactionsThresholds()
    {
        _player.SetReputation("test-faction", 750);

        var level = _player.GetReputationLevel(_faction);

        level.Should().Be(ReputationLevel.Friendly);
    }
}
```

### 11.5 NPC Memory Integration Tests (~4 tests)

```csharp
[TestFixture]
public class NPCMemoryIntegrationTests
{
    private NPC _npc;
    private Player _player;

    [SetUp]
    public void Setup()
    {
        var definition = NPCDefinition.Create(
            "test-npc", "Test NPC", NPCType.Merchant,
            NPCAttitude.Neutral, "Hello!", "Description");
        _npc = NPC.Create(definition);
        _player = Player.Create("Test Player");
    }

    [Test]
    public void GetOrCreateMemory_CreatesNewMemory()
    {
        var memory = _npc.GetOrCreateMemory(_player.Id);

        memory.Should().NotBeNull();
        memory.PlayerId.Should().Be(_player.Id);
    }

    [Test]
    public void GetOrCreateMemory_ReturnsSameInstance()
    {
        var memory1 = _npc.GetOrCreateMemory(_player.Id);
        var memory2 = _npc.GetOrCreateMemory(_player.Id);

        memory1.Should().BeSameAs(memory2);
    }

    [Test]
    public void RecordInteraction_UpdatesMemory()
    {
        _npc.RecordInteraction(_player.Id);

        var memory = _npc.GetMemory(_player.Id);
        memory.Should().NotBeNull();
        memory!.InteractionCount.Should().Be(1);
    }

    [Test]
    public void RememberChoice_StoresInMemory()
    {
        _npc.RememberChoice(_player.Id, "test-choice");

        var memory = _npc.GetMemory(_player.Id);
        memory!.HasMadeChoice("test-choice").Should().BeTrue();
    }
}
```

### 11.6 ReputationService Tests (~5 tests)

```csharp
[TestFixture]
public class ReputationServiceTests
{
    private Mock<IConfigurationProvider> _configProviderMock;
    private Mock<ILogger<ReputationService>> _loggerMock;
    private ReputationService _service;
    private List<FactionDefinition> _factions;
    private Player _player;

    [SetUp]
    public void Setup()
    {
        _factions = new List<FactionDefinition>
        {
            FactionDefinition.Create("merchant-guild", "Merchant Guild", "Traders",
                allies: new[] { "adventurers" }),
            FactionDefinition.Create("adventurers", "Adventurers", "Explorers"),
            FactionDefinition.Create("thieves", "Thieves", "Rogues",
                enemies: new[] { "merchant-guild" })
        };

        _configProviderMock = new Mock<IConfigurationProvider>();
        _configProviderMock.Setup(x => x.LoadFactionDefinitions()).Returns(_factions);

        _loggerMock = new Mock<ILogger<ReputationService>>();
        _service = new ReputationService(_configProviderMock.Object, _loggerMock.Object);
        _player = Player.Create("Test Player");
    }

    [Test]
    public void GetAllFactions_ReturnsAllFactions()
    {
        var factions = _service.GetAllFactions();

        factions.Should().HaveCount(3);
    }

    [Test]
    public void GetFactionDefinition_ReturnsCorrectFaction()
    {
        var faction = _service.GetFactionDefinition("merchant-guild");

        faction.Should().NotBeNull();
        faction!.Name.Should().Be("Merchant Guild");
    }

    [Test]
    public void ModifyReputation_AppliesSpillover()
    {
        var change = _service.ModifyReputation(_player, "merchant-guild", 100);

        change.Delta.Should().Be(100);
        change.SpilloverChanges.Should().HaveCount(1);

        var allySpillover = change.SpilloverChanges.First(s => s.IsAlly);
        allySpillover.Delta.Should().Be(50); // 50% spillover
    }

    [Test]
    public void ModifyReputation_AppliesEnemySpillover()
    {
        // First set up thieves as enemy
        _factions[0] = FactionDefinition.Create("merchant-guild", "Merchant Guild", "Traders",
            enemies: new[] { "thieves" });
        _service = new ReputationService(_configProviderMock.Object, _loggerMock.Object);

        var change = _service.ModifyReputation(_player, "merchant-guild", 100);

        var enemySpillover = change.SpilloverChanges.FirstOrDefault(s => !s.IsAlly);
        enemySpillover.Delta.Should().Be(-25); // -25% spillover
    }

    [Test]
    public void GetAllStandings_SortsByPoints()
    {
        _player.ModifyReputation("merchant-guild", 500);
        _player.ModifyReputation("adventurers", 100);
        _player.ModifyReputation("thieves", -200);

        var standings = _service.GetAllStandings(_player);

        standings[0].FactionId.Should().Be("merchant-guild");
        standings[1].FactionId.Should().Be("adventurers");
        standings[2].FactionId.Should().Be("thieves");
    }
}
```

---

## 12. Use Cases

### UC-001: View All Faction Standings
**Actor:** Player
**Flow:** Enter reputation command → See list of all factions → See levels and progress bars

### UC-002: View Specific Faction
**Actor:** Player
**Flow:** Enter reputation <faction> → See detailed faction info → See thresholds and relationships

### UC-003: Gain Reputation from Dialogue
**Actor:** Player
**Flow:** Talk to NPC → Select helpful option → Reputation increases → See notification

### UC-004: Reputation Spillover
**Actor:** Player
**Flow:** Help faction NPC → Gain reputation → Allied factions gain → Enemy factions lose

### UC-005: NPC Attitude Changes
**Actor:** Player
**Flow:** Gain enough reputation → NPC attitude improves → New dialogue options available

### UC-006: NPC Remembers Player
**Actor:** Player
**Flow:** Return to NPC → NPC greets differently → Memory-based options appear

### UC-007: First-Time vs Returning Dialogue
**Actor:** Player
**Flow:** First visit shows intro → Return visit shows "welcome back" → Different options available

---

## 13. Acceptance Criteria

### AC-2.0c-1: FactionDefinition
- [ ] FactionDefinition can be loaded from JSON configuration
- [ ] Faction stores Id, Name, Description, DefaultReputation
- [ ] Faction stores reputation thresholds for all 8 levels
- [ ] Faction stores allies and enemies lists
- [ ] Faction.GetLevel() correctly maps points to levels
- [ ] Faction.GetProgressToNextLevel() calculates correctly

### AC-2.0c-2: ReputationLevel Enum
- [ ] ReputationLevel has 8 values: Hated, Hostile, Unfriendly, Neutral, Friendly, Honored, Revered, Exalted
- [ ] Values are ordered from -4 to +4
- [ ] All values have XML documentation

### AC-2.0c-3: Player Reputation Tracking
- [ ] Player.Reputation stores faction -> points mapping
- [ ] Player.GetReputation() returns points or default
- [ ] Player.ModifyReputation() adds delta to existing
- [ ] Player.GetReputationLevel() uses faction thresholds

### AC-2.0c-4: NPCMemory
- [ ] NPCMemory tracks interaction count per player
- [ ] NPCMemory stores dialogue choices made
- [ ] NPCMemory supports custom flags
- [ ] NPCMemory tracks hostile/helpful behavior
- [ ] NPC.GetOrCreateMemory() creates new or returns existing

### AC-2.0c-5: ReputationService
- [ ] ReputationService loads factions from config
- [ ] ModifyReputation applies direct change
- [ ] ModifyReputation calculates ally spillover (50% default)
- [ ] ModifyReputation calculates enemy spillover (-25% default)
- [ ] GetAllStandings returns sorted list

### AC-2.0c-6: Attitude Integration
- [ ] NPC attitude updates based on faction reputation
- [ ] High reputation (Friendly+) gives Friendly attitude
- [ ] Low reputation (Hostile-) gives Hostile attitude
- [ ] Attitude affects dialogue options (v0.2.0b)

### AC-2.0c-7: Dialogue Integration
- [ ] ChangeReputation outcome works in dialogue
- [ ] DialogueContext includes NPC memory
- [ ] PreviousChoice condition uses NPC memory
- [ ] First-time vs returning dialogue differs

### AC-2.0c-8: Commands
- [ ] `reputation` command shows all standings
- [ ] `reputation <faction>` shows detailed view
- [ ] Progress bars display correctly
- [ ] Reputation change notifications appear

### AC-2.0c-9: Configuration
- [ ] factions.json defines all factions
- [ ] factions.schema.json validates configuration
- [ ] Invalid configuration produces clear errors

### AC-2.0c-10: Unit Tests
- [ ] ~30 unit tests implemented
- [ ] All tests pass
- [ ] Tests cover happy path and error cases

---

## 14. Deliverable Checklist

### Domain Layer
- [ ] `Definitions/FactionDefinition.cs`
- [ ] `Enums/ReputationLevel.cs`
- [ ] `ValueObjects/ReputationStanding.cs`
- [ ] `ValueObjects/ReputationChange.cs`
- [ ] `ValueObjects/NPCMemory.cs`
- [ ] `Entities/Player.cs` updates (Reputation property, methods)
- [ ] `Entities/NPC.cs` updates (Memory property, methods)
- [ ] `ValueObjects/DialogueContext.cs` updates (NPCMemory integration)

### Application Layer
- [ ] `Interfaces/IReputationService.cs`
- [ ] `Services/ReputationService.cs`
- [ ] `Services/GameSessionService.cs` updates (reputation commands)
- [ ] `Services/DialogueService.cs` updates (ChangeReputation outcome)
- [ ] `Services/NPCService.cs` updates (attitude, memory tracking)

### Infrastructure Layer
- [ ] `Configuration/JsonConfigurationProvider.cs` updates (LoadFactionDefinitions)

### Configuration Files
- [ ] `config/factions.json`
- [ ] `config/schemas/factions.schema.json`

### Presentation Layer
- [ ] Reputation command handler
- [ ] Reputation view renderer
- [ ] IGameRenderer updates (RenderReputation methods)

### Tests
- [ ] `Domain.Tests/Definitions/FactionDefinitionTests.cs`
- [ ] `Domain.Tests/ValueObjects/ReputationStandingTests.cs`
- [ ] `Domain.Tests/ValueObjects/NPCMemoryTests.cs`
- [ ] `Domain.Tests/Entities/PlayerReputationTests.cs`
- [ ] `Domain.Tests/Entities/NPCMemoryIntegrationTests.cs`
- [ ] `Application.Tests/Services/ReputationServiceTests.cs`

### Documentation
- [ ] XML documentation on all public members
- [ ] JSON schema documentation

---

## 15. Dependencies

### Required from v0.2.0a (NPC Foundation)
- NPC entity with FactionId
- NPCDefinition with FactionId
- NPCAttitude enum
- NPCService

### Required from v0.2.0b (Dialogue System)
- DialogueContext
- DialogueOutcome with ChangeReputation type
- DialogueCondition with ReputationAtLeast type
- DialogueService

### Provided to v0.2.0d (Companions)
- ReputationService for companion faction standing
- NPCMemory for companion relationship tracking
- Attitude system for companion disposition

### Provided to v0.2.2 (Merchant System)
- Faction-based pricing (reputation affects discounts)
- Reputation-gated inventory items
- Merchant attitude affects available items

### Provided to v0.3.0 (Quest System)
- Faction reputation rewards from quests
- Reputation-gated quest availability
- Faction-based quest outcomes

---

## 16. Future Considerations

### Deferred to v0.2.0d
- **Companion Relationship**: Companions have their own faction-like relationship
- **Companion Memory**: Special memory tracking for recruited companions
- **Reputation from Combat**: Defending/attacking faction members affects reputation

### Deferred to Future Versions
- **Reputation Decay**: Reputation slowly returns to default over time
- **Cross-Faction Events**: Major events that affect multiple factions
- **Faction Quests**: Exclusive quest lines for high reputation players
- **Faction Perks**: Special abilities or items unlocked at reputation levels
- **Dynamic Relationships**: Faction alliances/enemies can change based on events
- **Reputation History**: Track how reputation changed over time

### Out of Scope
- **Faction Warfare**: Factions fighting each other in the dungeon
- **Faction Leadership**: Player becoming a faction leader
- **Faction Creation**: Player creating their own faction
- **NPC Romance**: Romantic relationship systems

---

*Document Version: 1.0*
*Last Updated: 2024-01-15*
*Author: Claude Code*
