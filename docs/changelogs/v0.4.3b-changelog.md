# v0.4.3b Changelog: Light Sources & Vision

**Version:** 0.4.3b  
**Date:** 2026-01-13  
**Phase:** Light Sources & Vision

---

## Summary

Implemented light source management and vision type system. Players can now use torches and lanterns to illuminate dark areas, and creatures with special vision (DarkVision, TrueSight) receive reduced light penalties.

---

## Added

### Domain Layer

| File | Description |
|------|-------------|
| `Enums/VisionType.cs` | Normal, DarkVision, TrueSight vision types |
| `Entities/LightSource.cs` | Active light source with duration/fuel tracking |

### Player Updates (+51 lines)

| Property/Method | Description |
|-----------------|-------------|
| `VisionType` | Player's vision type (default: Normal) |
| `ActiveLightSource` | Currently active light source |
| `SetVisionType()` | Set player vision |
| `SetActiveLightSource()` | Set/clear active light |
| `GetEffectiveLightLevel(Room)` | Get perceived light level |

### Monster Updates (+64 lines)

| Property/Method | Description |
|-----------------|-------------|
| `VisionType` | Monster's vision type |
| `LightSensitivity` | Whether light-sensitive |
| `LightSensitivityPenalty` | Penalty in bright light (default -2) |
| `SetVisionType()` | Set monster vision |
| `SetLightSensitivity()` | Configure light sensitivity |
| `GetEffectiveLightLevel(Room)` | Get perceived light level |

### Room Updates (+45 lines)

| Property/Method | Description |
|-----------------|-------------|
| `LightSources` | Collection of light sources |
| `HasActiveLightSources` | Now checks actual collection |
| `AddLightSource()` | Add light source to room |
| `RemoveLightSource()` | Remove light source |
| `GetActiveLightSources()` | Get active sources |
| `CalculateCurrentLightLevel()` | Now considers active sources |

### Application Layer

| File | Description |
|------|-------------|
| `ILightService.cs` | Interface + result types |
| `LightService.cs` | Light management implementation |

---

## Vision Mitigation

| Vision Type | Bright | Dim | Dark | MagicalDarkness |
|-------------|--------|-----|------|-----------------|
| Normal | Bright | Dim | Dark | MagicalDarkness |
| DarkVision | Bright | Dim | **Dim** | MagicalDarkness |
| TrueSight | Bright | Bright | Bright | **Bright** |

---

## Test Results

| Project | Passed | Added |
|---------|--------|-------|
| Domain | 1,186 | +26 |
| Application | 457 | +3 |
| Architecture | 8 | â€” |
| **Total** | **1,651** | **+29** |

### New Test Files

- `VisionTypeTests.cs` (3 tests)
- `LightSourceTests.cs` (12 tests)
- `PlayerVisionTests.cs` (4 tests)
- `MonsterVisionTests.cs` (4 tests)
- `RoomLightSourceTests.cs` (3 tests)
- `LightServiceTests.cs` (3 tests)

---

## Logging Strategy

| Component | Level | Template |
|-----------|-------|----------|
| LightService | Information | `"Player {Player} lit {Light}"` |
| LightService | Information | `"Player {Player} extinguished {Light}"` |
| LightService | Information | `"{Light} expired for player {Player}"` |
| LightService | Debug | `"Monster {Monster} suffers light sensitivity penalty {Penalty}"` |

---

## Next Steps

v0.4.3c will add:
- Perception skill affecting trap detection in darkness
- Stealth skill interaction with light levels
