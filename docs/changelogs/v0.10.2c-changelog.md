# v0.10.2c Changelog: Prerequisites & Respec System

**Version:** 0.10.2c
**Phase:** Prerequisite Validation & Talent Respec System
**Date:** 2026-01-19
**Status:** Complete

---

## Summary

Implements full prerequisite validation and the respec (talent reallocation) system. Replaces the stub `StubPrerequisiteValidator` with a complete `PrerequisiteValidator` that validates node prerequisites (required talents must be unlocked) and stat prerequisites (player attributes must meet minimum values). Adds `RespecService` for resetting all talent allocations, refunding spent points, removing granted abilities, and charging a gold cost.

---

## Added

### Application Layer - Configuration

| Class | Properties | Description |
|-------|------------|-------------|
| `IRespecConfiguration` | BaseRespecCost, LevelMultiplier, IsRespecEnabled, MinimumLevelToRespec, CurrencyId | Interface for respec cost and eligibility settings |
| `RespecConfiguration` | BaseRespecCost=100, LevelMultiplier=10, IsRespecEnabled=true, MinimumLevelToRespec=2, CurrencyId="gold" | Default configuration implementation |

**Cost Formula:** `BaseRespecCost + (PlayerLevel × LevelMultiplier)`

Example costs with default configuration:
- Level 2: 100 + (2 × 10) = **120 gold**
- Level 5: 100 + (5 × 10) = **150 gold**
- Level 10: 100 + (10 × 10) = **200 gold**
- Level 20: 100 + (20 × 10) = **300 gold**

### Application Layer - DTOs

| DTO | Properties | Description |
|-----|------------|-------------|
| `RespecResult` | IsSuccess, ResultType, PointsRefunded, GoldSpent, AbilitiesRemoved, FailureReason | Result of respec operation |
| `RespecResultType` | enum | Success, CannotAfford, NoAllocations, Disabled, LevelTooLow |

**RespecResult Factory Methods:**
- `Success(pointsRefunded, goldSpent, abilitiesRemoved)` - Successful respec
- `CannotAfford(costRequired, goldAvailable)` - Insufficient gold
- `NothingToRespec()` - No allocations to reset
- `Disabled()` - Feature disabled in config
- `LevelTooLow(requiredLevel, currentLevel)` - Below minimum level

### Application Layer - Events

| Event | Properties | Description |
|-------|------------|-------------|
| `RespecStartedEvent` | PlayerId, CurrentLevel, AllocationsCount, EstimatedCost | Published when respec begins |
| `RespecCompletedEvent` | PlayerId, PointsRefunded, GoldSpent, AbilitiesRemoved, PlayerLevel | Published on successful respec |
| `RespecFailedEvent` | PlayerId, FailureReason, ResultType | Published when respec fails validation |

### Application Layer - Interfaces

| Interface | Methods |
|-----------|---------|
| `IRespecService` | GetRespecCost, CanAffordRespec, HasAllocations, GetRefundAmount, GetAbilitiesToRemove, Respec |
| `IRespecConfiguration` | BaseRespecCost, LevelMultiplier, IsRespecEnabled, MinimumLevelToRespec, CurrencyId |

**IRespecService Methods:**
- `GetRespecCost(player)` - Calculates gold cost based on level
- `CanAffordRespec(player)` - Checks if player has enough gold
- `HasAllocations(player)` - Checks if player has any allocations
- `GetRefundAmount(player)` - Calculates total points to refund
- `GetAbilitiesToRemove(player)` - Lists abilities that will be removed
- `Respec(player)` - Performs full respec operation

### Application Layer - Services

| Service | Dependencies | Description |
|---------|--------------|-------------|
| `PrerequisiteValidator` | IAbilityTreeProvider, ILogger | Full prerequisite validation implementation |
| `RespecService` | IAbilityTreeProvider, IRespecConfiguration, IGameEventLogger, ILogger | Talent reallocation service |

**PrerequisiteValidator Features:**
- Validates node prerequisites: Required nodes must have rank >= 1
- Validates stat prerequisites: Player effective attributes must meet minimum
- Uses `GetEffectiveAttributes().GetByName(statId)` for stat checks
- Supported stat IDs: "might", "fortitude", "will", "wits", "finesse" (with short aliases)
- Returns detailed failure reasons for UI feedback
- Provides helper methods: `MeetsNodePrerequisites()`, `MeetsStatPrerequisites()`

**RespecService Features:**
- Validates eligibility: feature enabled, minimum level, has allocations, can afford
- Refunds all spent talent points to unspent pool
- Clears all talent allocations
- Deducts gold cost from player
- Removes abilities granted by talents
- Publishes events for system integration

---

## Modified

### Application Layer - Services

| File | Change |
|------|--------|
| `DependencyInjection.cs` | Replaced `StubPrerequisiteValidator` with `PrerequisiteValidator`, added respec service registrations |

---

## Removed

| File | Reason |
|------|--------|
| `StubPrerequisiteValidator.cs` | Replaced by full `PrerequisiteValidator` implementation |

---

## Respec Flow

```
RESPEC OPERATION FLOW:
═══════════════════════════════════════════════════════════════════════

  Respec(player)
         │
         ▼
  ┌─────────────────────────────────────────────────┐
  │ 1. Check Feature Enabled                        │
  │    _config.IsRespecEnabled                      │
  │    → Disabled if false                          │
  └───────────────────────────┬─────────────────────┘
                              │
                              ▼
  ┌─────────────────────────────────────────────────┐
  │ 2. Check Minimum Level                          │
  │    player.Level >= _config.MinimumLevelToRespec │
  │    → LevelTooLow if below                       │
  └───────────────────────────┬─────────────────────┘
                              │
                              ▼
  ┌─────────────────────────────────────────────────┐
  │ 3. Check Has Allocations                        │
  │    player.TalentAllocations.Count > 0           │
  │    → NothingToRespec if empty                   │
  └───────────────────────────┬─────────────────────┘
                              │
                              ▼
  ┌─────────────────────────────────────────────────┐
  │ 4. Check Can Afford                             │
  │    player.GetCurrency("gold") >= cost           │
  │    → CannotAfford if insufficient               │
  └───────────────────────────┬─────────────────────┘
                              │
                              ▼
  ┌─────────────────────────────────────────────────┐
  │ 5. Log RespecStartedEvent                       │
  └───────────────────────────┬─────────────────────┘
                              │
                              ▼
  ┌─────────────────────────────────────────────────┐
  │ 6. Refund Points                                │
  │    player.RefundAllTalentPoints()               │
  │    → Moves spent points back to unspent pool    │
  └───────────────────────────┬─────────────────────┘
                              │
                              ▼
  ┌─────────────────────────────────────────────────┐
  │ 7. Clear Allocations                            │
  │    player.ClearTalentAllocations()              │
  │    → Removes all talent allocations             │
  └───────────────────────────┬─────────────────────┘
                              │
                              ▼
  ┌─────────────────────────────────────────────────┐
  │ 8. Deduct Gold Cost                             │
  │    player.RemoveCurrency("gold", cost)          │
  └───────────────────────────┬─────────────────────┘
                              │
                              ▼
  ┌─────────────────────────────────────────────────┐
  │ 9. Remove Abilities                             │
  │    For each allocation:                         │
  │      → Find node's ability ID                   │
  │      → player.RemoveAbility(abilityId)          │
  └───────────────────────────┬─────────────────────┘
                              │
                              ▼
  ┌─────────────────────────────────────────────────┐
  │ 10. Log RespecCompletedEvent                    │
  └───────────────────────────┬─────────────────────┘
                              │
                              ▼
  RespecResult.Success(pointsRefunded, goldSpent, abilitiesRemoved)


PREREQUISITE VALIDATION FLOW:
═══════════════════════════════════════════════════════════════════════

  ValidatePrerequisites(player, node)
         │
         ▼
  ┌─────────────────────────────────────────────────┐
  │ 1. Check Node Prerequisites                     │
  │    For each prereqNodeId in node.PrerequisiteNodeIds:   │
  │      → Get player.GetAllocation(prereqNodeId)   │
  │      → Fails if allocation is null or rank < 1  │
  │      → Adds "Requires '{Name}' to be unlocked"  │
  └───────────────────────────┬─────────────────────┘
                              │
                              ▼
  ┌─────────────────────────────────────────────────┐
  │ 2. Check Stat Prerequisites                     │
  │    attrs = player.GetEffectiveAttributes()      │
  │    For each statPrereq in node.StatPrerequisites:       │
  │      → Get attrs.GetByName(statPrereq.StatId)   │
  │      → Fails if value < statPrereq.MinValue     │
  │      → Adds "Requires {Stat} >= {Min} (have X)" │
  └───────────────────────────┬─────────────────────┘
                              │
                              ▼
  ┌─────────────────────────────────────────────────┐
  │ 3. Build Result                                 │
  │    → PrerequisiteResult.Valid() if no failures  │
  │    → PrerequisiteResult.Invalid(reasons) else   │
  └─────────────────────────────────────────────────┘
```

---

## Logging Matrix

### PrerequisiteValidator Logging

| Event | Level | Template |
|-------|-------|----------|
| Validator initialized | Debug | `"PrerequisiteValidator initialized with tree provider"` |
| Validating prerequisites | Debug | `"Validating prerequisites for player {PlayerName} on node {NodeId}"` |
| Checking node prereq | Trace | `"Checking node prerequisite {PrereqNodeId} for node {NodeId}"` |
| Node prereq not met | Debug | `"Node prerequisite not met: {PrereqNodeId} (player has rank {Rank})"` |
| Node prereq met | Trace | `"Node prerequisite {PrereqNodeId} met (rank {Rank})"` |
| Checking stat prereq | Trace | `"Checking stat prerequisite {StatId} >= {MinValue} for node {NodeId}"` |
| Stat prereq not met | Debug | `"Stat prerequisite not met: {StatId} >= {Required} (player has {Actual})"` |
| Stat prereq met | Trace | `"Stat prerequisite {StatId} met ({Actual} >= {Required})"` |
| Prerequisites not met | Debug | `"Prerequisites not met for player {PlayerName} on node {NodeId}: {Count} failures"` |
| All prerequisites met | Debug | `"All prerequisites met for player {PlayerName} on node {NodeId}"` |

### RespecService Logging

| Event | Level | Template |
|-------|-------|----------|
| Service initialized | Debug | `"RespecService initialized. Config: BaseCost={BaseCost}, LevelMultiplier={Multiplier}, MinLevel={MinLevel}, Enabled={Enabled}, Currency={Currency}"` |
| Get respec cost | Trace | `"GetRespecCost for player {PlayerName} (level {Level}): {BaseCost} + ({Level} × {Multiplier}) = {TotalCost}"` |
| Can afford check | Trace | `"CanAffordRespec for player {PlayerName}: cost={Cost}, available={Available}, result={CanAfford}"` |
| Has allocations check | Trace | `"HasAllocations for player {PlayerName}: {Count} allocation(s), result={HasAllocations}"` |
| Get refund amount | Trace | `"GetRefundAmount for player {PlayerName}: {TotalSpent} points across {Count} allocation(s)"` |
| Respec initiated | Debug | `"Respec initiated for player {PlayerId} ({PlayerName}), level {Level}"` |
| Respec denied - disabled | Debug | `"Respec denied for player {PlayerName}: feature is disabled"` |
| Respec denied - level | Debug | `"Respec denied for player {PlayerName}: level {CurrentLevel} < required {RequiredLevel}"` |
| Respec denied - no allocations | Debug | `"Respec denied for player {PlayerName}: no talent allocations to reset"` |
| Respec denied - gold | Debug | `"Respec denied for player {PlayerName}: cannot afford cost {Cost} (has {Available} {Currency})"` |
| Respec preparation | Debug | `"Respec preparation for player {PlayerName}: refunding {Points} points, removing {AbilityCount} abilities, cost {Cost} {Currency}"` |
| Points refunded | Trace | `"Refunded {Points} talent points to player {PlayerName}. New unspent: {Unspent}"` |
| Allocations cleared | Trace | `"Cleared all talent allocations for player {PlayerName}"` |
| Gold deducted | Trace | `"Deducted {Cost} {Currency} from player {PlayerName}. Remaining: {Remaining}"` |
| Ability removed | Trace | `"Removed ability {AbilityId} from player {PlayerName}"` |
| Respec completed | Information | `"Respec completed for player {PlayerName}: refunded {Points} points, removed {AbilityCount} abilities, spent {Cost} {Currency}"` |

---

## Unit Tests

**33 tests total** (14 PrerequisiteValidator + 19 RespecService)

### PrerequisiteValidatorTests (14 tests)

| Test | Description |
|------|-------------|
| ValidatePrerequisites_NoPrerequisites_ReturnsValid | Node without prereqs passes |
| ValidatePrerequisites_NodePrereqMet_ReturnsValid | Required node unlocked passes |
| ValidatePrerequisites_NodePrereqNotMet_ReturnsInvalid | Required node not unlocked fails |
| ValidatePrerequisites_StatPrereqMet_ReturnsValid | Stat requirement met passes |
| ValidatePrerequisites_StatPrereqNotMet_ReturnsInvalid | Stat requirement not met fails |
| ValidatePrerequisites_AllPrerequisitesMet_ReturnsValid | Multiple prereqs all met |
| ValidatePrerequisites_MultipleFailures_ReturnsAllReasons | Collects all failure reasons |
| ValidatePrerequisites_MissingPrereqNodeDefinition_UsesNodeIdInMessage | Falls back to node ID if name not found |
| MeetsNodePrerequisites_AllMet_ReturnsTrue | All node prereqs satisfied |
| MeetsNodePrerequisites_NotMet_ReturnsFalse | Node prereqs not satisfied |
| MeetsNodePrerequisites_NoNodePrerequisites_ReturnsTrue | No prereqs returns true |
| MeetsStatPrerequisites_AllMet_ReturnsTrue | All stat prereqs satisfied |
| MeetsStatPrerequisites_NotMet_ReturnsFalse | Stat prereqs not satisfied |
| MeetsStatPrerequisites_NoStatPrerequisites_ReturnsTrue | No prereqs returns true |

### RespecServiceTests (19 tests)

| Test | Description |
|------|-------------|
| GetRespecCost_CalculatesCorrectly | Formula: base + (level × multiplier) |
| GetRespecCost_ScalesWithLevel | Verifies cost scaling at levels 2, 10, 20 |
| CanAffordRespec_WithEnoughGold_ReturnsTrue | Player can afford |
| CanAffordRespec_WithoutEnoughGold_ReturnsFalse | Player cannot afford |
| HasAllocations_WithAllocations_ReturnsTrue | Player has allocations |
| HasAllocations_WithoutAllocations_ReturnsFalse | Player has no allocations |
| GetRefundAmount_CalculatesTotalPointsSpent | Sum of all allocation points |
| GetAbilitiesToRemove_ReturnsAbilityIdsFromAllocations | Lists abilities from nodes |
| Respec_WhenDisabled_ReturnsDisabled | Feature disabled check |
| Respec_WhenLevelTooLow_ReturnsLevelTooLow | Minimum level check |
| Respec_NoAllocations_ReturnsNothingToRespec | No allocations check |
| Respec_CannotAfford_ReturnsCannotAfford | Insufficient gold check |
| Respec_RefundsAllPoints | Points returned to unspent |
| Respec_ClearsAllocations | All allocations removed |
| Respec_DeductsGoldCost | Gold deducted correctly |
| Respec_ReturnsAbilitiesRemovedCount | Correct count returned |
| Respec_LogsRespecStartedEvent | Started event logged |
| Respec_LogsRespecCompletedEvent | Completed event logged |
| Respec_LogsRespecFailedEvent | Failed event logged |

---

## Files Changed

| Path | Change |
|------|--------|
| `src/Core/RuneAndRust.Application/Configuration/RespecConfiguration.cs` | NEW |
| `src/Core/RuneAndRust.Application/DTOs/RespecResult.cs` | NEW |
| `src/Core/RuneAndRust.Application/Events/RespecEvents.cs` | NEW |
| `src/Core/RuneAndRust.Application/Interfaces/IRespecConfiguration.cs` | NEW |
| `src/Core/RuneAndRust.Application/Interfaces/IRespecService.cs` | NEW |
| `src/Core/RuneAndRust.Application/Services/PrerequisiteValidator.cs` | NEW |
| `src/Core/RuneAndRust.Application/Services/RespecService.cs` | NEW |
| `src/Core/RuneAndRust.Application/Services/StubPrerequisiteValidator.cs` | DELETED |
| `src/Infrastructure/RuneAndRust.Infrastructure/DependencyInjection.cs` | MODIFIED |
| `tests/RuneAndRust.Application.UnitTests/Services/PrerequisiteValidatorTests.cs` | NEW |
| `tests/RuneAndRust.Application.UnitTests/Services/RespecServiceTests.cs` | NEW |

---

## DI Registration

```csharp
// In AddApplicationServices:

// Talent point system - full prerequisite validator (replaces stub from v0.10.2b)
services.AddScoped<IPrerequisiteValidator, PrerequisiteValidator>();
services.AddScoped<ITalentPointService, TalentPointService>();

// Respec system (v0.10.2c)
services.AddSingleton<IRespecConfiguration, RespecConfiguration>();
services.AddScoped<IRespecService, RespecService>();
```

---

## v0.10.2 Progress

| Version | Feature | Status |
|---------|---------|--------|
| v0.10.2a | Tree Definitions | Complete |
| v0.10.2b | Talent Point Service | Complete |
| v0.10.2c | Prerequisites & Respec | Complete |

---

## Dependencies

| Dependency | Purpose |
|------------|---------|
| v0.10.2a | `IAbilityTreeProvider`, `AbilityTreeNode`, `StatPrerequisite` |
| v0.10.2b | `TalentAllocation`, `ITalentPointService`, Player talent methods |
| Domain | `Player.GetEffectiveAttributes()`, `Player.GetCurrency()`, `Player.RemoveCurrency()` |
| Application | `IGameEventLogger`, `PrerequisiteResult` |

---

## Integration Notes

### Performing a Respec

```csharp
// Check if player can respec
var cost = _respecService.GetRespecCost(player);
var canAfford = _respecService.CanAffordRespec(player);
var hasAllocations = _respecService.HasAllocations(player);

Console.WriteLine($"Respec cost: {cost} gold");
Console.WriteLine($"Points to refund: {_respecService.GetRefundAmount(player)}");
Console.WriteLine($"Abilities to remove: {_respecService.GetAbilitiesToRemove(player).Count}");

// Perform respec
var result = _respecService.Respec(player);

if (result.IsSuccess)
{
    Console.WriteLine($"Respec complete! Refunded {result.PointsRefunded} points.");
    Console.WriteLine($"Spent {result.GoldSpent} gold, removed {result.AbilitiesRemoved} abilities.");
}
else
{
    switch (result.ResultType)
    {
        case RespecResultType.Disabled:
            Console.WriteLine("Respec is currently disabled.");
            break;
        case RespecResultType.LevelTooLow:
            Console.WriteLine(result.FailureReason); // "Must be level 2..."
            break;
        case RespecResultType.NoAllocations:
            Console.WriteLine("No talent allocations to reset.");
            break;
        case RespecResultType.CannotAfford:
            Console.WriteLine(result.FailureReason); // "Respec costs X gold, have Y"
            break;
    }
}
```

### Checking Prerequisites

```csharp
// Get the node
var node = _treeProvider.FindNode("rage");

// Validate prerequisites
var result = _prerequisiteValidator.ValidatePrerequisites(player, node);

if (result.IsValid)
{
    Console.WriteLine("All prerequisites met!");
}
else
{
    Console.WriteLine("Prerequisites not met:");
    foreach (var reason in result.FailureReasons)
    {
        Console.WriteLine($"  - {reason}");
    }
}

// Quick checks
bool meetsNodePrereqs = _prerequisiteValidator.MeetsNodePrerequisites(player, node);
bool meetsStatPrereqs = _prerequisiteValidator.MeetsStatPrerequisites(player, node);
```

### Configuring Respec Settings

```csharp
// Custom configuration (for testing or game modes)
public class CustomRespecConfiguration : IRespecConfiguration
{
    public int BaseRespecCost => 50;          // Cheaper base cost
    public int LevelMultiplier => 5;          // Lower scaling
    public bool IsRespecEnabled => true;
    public int MinimumLevelToRespec => 1;     // Available immediately
    public string CurrencyId => "gold";
}

// Register in DI
services.AddSingleton<IRespecConfiguration, CustomRespecConfiguration>();
```

---

*Document Version: 1.0 | Last Updated: 2026-01-19*
