# v0.20.7a Changelog — Veiðimaðr (Hunter) Framework & Tier 1 Abilities

## Version: 0.20.7a

## Date: 2026-02-16

## Focus: Veiðimaðr (Hunter) Specialization — Framework & Tier 1 Abilities (Mark Quarry, Keen Senses, Read the Signs)

---

## Added

### Domain Layer — Enums

- **`VeidimadurAbilityId`** — 9 ability identifiers across 4 tiers in the 700-708 range: MarkQuarry (700), KeenSenses (701), ReadTheSigns (702), HuntersEye (703), TrapMastery (704), PredatorsPatience (705), ApexPredator (706), CripplingShot (707), ThePerfectHunt (708)
- **`QuarryStatus`** — 5 lifecycle states for quarry marks: Active (0), Defeated (1), Escaped (2), Expired (3), Unmarked (4)
- **`CreatureTrackType`** — 5 track freshness classifications with associated DCs: Fresh (DC 10), Recent (DC 12), Worn (DC 15), Ancient (DC 18), Unclear (DC 20)

### Domain Layer — Value Objects

- **`QuarryMark`** — Mutable sealed record tracking a single quarry mark. Factory method `Create(Guid, string, Guid, Guid?)` with validation. Base hit bonus +2 (`DefaultHitBonus`). Mutable fields via `private set`: `Status` (with `SetStatus()`), `TurnsActive` (with `IncrementTurn()`). Additional bonuses via `AddBonus(string, int)` dictionary. Methods: `GetTotalHitBonus()`, `GetDescription()`, `IsExpired()`.
- **`QuarryMarksResource`** — Mutable sealed record managing up to 3 simultaneous quarry marks with FIFO replacement. Factory method `Create()`. `AddMark(QuarryMark)` returns replaced mark (or null). FIFO policy: when at capacity (3), the oldest mark is automatically removed before adding the new one. Methods: `RemoveMark(Guid)`, `HasMark(Guid)`, `GetMark(Guid)`, `GetOldestMark()`, `CanAddMark()`, `ClearAllMarks()`, `ClearExpiredMarks()`, `RefreshMarksForNewTurn()`, `GetFormattedValue()`.
- **`MarkQuarryResult`** — Init-only sealed record capturing the outcome of a Mark Quarry execution. Properties: HunterId, HunterName, TargetId, TargetName, MarkCreated, PreviousMarksCount, CurrentMarksCount, ReplacedMark (nullable), MarkedAt. Methods: `WasReplacement()`, `GetHitBonus()`, `GetDescription()`, `GetStatusMessage()`.
- **`ReadTheSignsResult`** — Init-only sealed record capturing the outcome of a Read the Signs investigation. Nullable creature info fields populated on success, null on failure. Properties: InvestigatorId, LocationDescription, CreatureType?, CreatureCount?, TimePassedEstimate?, DirectionOfTravel?, CreatureCondition?, TrackQuality, BonusApplied, SkillCheckRoll, SkillCheckDc, Success, InformationRevealed. Methods: `GetDescription()`, `GetFormattedOutput()` (multi-line).

### Application Layer — Interfaces

- **`IVeidimadurQuarryMarksService`** — Quarry Marks resource management contract with 8 methods: `InitializeQuarryMarks`, `GetQuarryMarks`, `AddMark`, `RemoveMark`, `HasActiveMark`, `GetMarkFor`, `CanAddMark`, `ClearAllMarks`, `GetMarkCount`
- **`IVeidimadurAbilityService`** — Ability execution contract with Tier 1 methods: `ExecuteMarkQuarry` (active targeting), `ExecuteReadTheSigns` (active investigation), `GetKeenSensesBonus` (passive query). Utility methods: `GetAbilityReadiness`, `CanUnlockTier2/3/Capstone`, `GetPPInvested`

### Application Layer — Services

- **`VeidimadurQuarryMarksService`** — Quarry Marks management implementation:
  - Mutable model — delegates to `Player.QuarryMarks` methods directly (no immutable reference swap)
  - `AddMark()`: delegates to `QuarryMarksResource.AddMark()`, logs FIFO replacement details
  - `RemoveMark()`: delegates to `QuarryMarksResource.RemoveMark()`, logs success/failure
  - `ClearAllMarks()`: bulk clear for encounter end, logs cleared count
  - Exhaustive logging: LogInformation for all successful operations, LogWarning for all failures
- **`VeidimadurAbilityService`** — Ability execution implementation:
  - Guard-clause chain: null → spec → ability unlocked → AP → execute (no Corruption step — Coherent path)
  - Mark Quarry: 1 AP, designates target as quarry via QuarryMarksService, returns MarkQuarryResult with replacement info
  - Read the Signs: 1 AP, skill check 1d20 + ability bonus (+4) + Keen Senses (+1 if unlocked) vs DC from track quality. On success: creature info populated. On failure: vague impressions only
  - Keen Senses: passive +1 bonus queried via `GetKeenSensesBonus()`, no AP cost
  - `internal virtual int Roll1D20()` for deterministic test overriding
  - `private static int GetTrackDc(CreatureTrackType)` — DC lookup: Fresh=10, Recent=12, Worn=15, Ancient=18, Unclear=20
  - `GetAbilityReadiness`: MarkQuarry checks AP, ReadTheSigns checks AP, KeenSenses always ready
  - 15 constants: MarkQuarryApCost, MarkQuarryRange, MarkQuarryHitBonus, ReadTheSignsApCost, ReadTheSignsAbilityBonus, KeenSensesPerceptionBonus, KeenSensesInvestigationBonus, FreshTrackDc, RecentTrackDc, WornTrackDc, AncientTrackDc, UnclearTrackDc, Tier2/3/CapstonePpRequirement

### Entity Extensions

- **`Player.cs`** — Veiðimaðr section added after Bone-Setter section:
  - `QuarryMarksResource? QuarryMarks` — Nullable mutable quarry marks resource
  - `HashSet<VeidimadurAbilityId> _unlockedVeidimadurAbilities` — Private backing set
  - `UnlockedVeidimadurAbilities` — Read-only collection accessor
  - `InitializeQuarryMarks()` — Creates default QuarryMarksResource (max 3, 0 active)
  - `SetQuarryMarks(QuarryMarksResource)` — Direct resource replacement
  - `HasVeidimadurAbilityUnlocked(VeidimadurAbilityId)` — Ability check
  - `UnlockVeidimadurAbility(VeidimadurAbilityId)` — Ability unlock
  - `GetVeidimadurPPInvested()` — PP calculation: T1=0, T2=4, T3=5, Capstone=6

### Configuration

- Updated `config/specializations.json` with veidimadur entry:
  - Skirmisher archetype, Coherent path
  - Special resource: quarry-marks (max 3, start 0, ability-generated, FIFO replacement, no rest restore)
  - 4 tiers: Foundation (3), Discipline (3), Mastery (2), Capstone (1) = 9 abilities total
- Updated `config/abilities.json` with 3 Tier 1 abilities:
  - `mark-quarry`: Active targeting, 1 AP, range 12 spaces, +2 hit bonus, max 3 marks with FIFO replacement
  - `keen-senses`: Passive, +1 to all Perception and Investigation checks
  - `read-the-signs`: Active investigation, 1 AP, range 1 (touch), skill check 1d20 + 4 (+ Keen Senses), DC scaling by track freshness

### Unit Tests

- **`QuarryMarksResourceTests`** — 15 domain tests: factory (default max marks), AddMark (below capacity, multiple marks within capacity, at capacity FIFO replacement), RemoveMark (valid target returns true, invalid target returns false), query (HasMark active mark, GetMark existing/non-existent), ClearAllMarks (removes all), RefreshMarksForNewTurn (increments TurnsActive), GetOldestMark (with marks/empty), display (GetFormattedValue with marks/empty)
- **`VeidimadurAbilityServiceTests`** — 23 application tests: Mark Quarry (valid prereqs, at capacity with replacement, insufficient AP, wrong spec, ability not unlocked), Read the Signs (high roll success, low roll failure, with Keen Senses bonus, without Keen Senses, all track DCs correct, insufficient AP, wrong spec), Keen Senses (unlocked returns 1, not unlocked returns 0, wrong spec returns 0), GetAbilityReadiness (with unlocked abilities, insufficient AP, wrong spec), GetPPInvested (T1 returns zero), CanUnlockTier2 (insufficient PP, wrong spec), CanUnlockTier3 (insufficient PP), CanUnlockCapstone (insufficient PP)

## Design Decisions

- **Mutable resource model**: Unlike `MedicalSuppliesResource` (immutable, returns new instances), `QuarryMarksResource` uses mutable in-place updates like `RageResource`. Marks are added/removed directly on the same resource. This is appropriate because quarry marks are discrete tracked targets that change frequently during combat, and the FIFO replacement semantics are clearer with mutation.
- **FIFO replacement policy**: When at maximum capacity (3 marks), the oldest mark is automatically replaced. `AddMark()` returns the replaced mark (or null) so the caller can report the replacement in combat logs. This avoids requiring the player to manually manage marks during combat.
- **No Corruption path**: The Veiðimaðr is the first Coherent path Skirmisher — no Corruption service dependency, no risk evaluation step in the guard-clause chain. This is an intentional design choice for the Hunter archetype, not an oversight.
- **Skill check for Read the Signs**: Unlike Mark Quarry (automatic success), Read the Signs uses a d20 skill check against a DC determined by track freshness. The bonus stacks ability (+4) with Keen Senses (+1 if unlocked) for a maximum +5. This creates meaningful investigation gameplay where track quality matters.
- **Keen Senses inline integration**: Rather than a separate passive processing method, Keen Senses is checked inline via `GetKeenSensesBonus()` during Read the Signs execution and returns 0 or 1. Other systems (perception, investigation) call this same method for consistent bonus application.
- **ID range 700-708**: Chosen to avoid collision with Berserkr (1-9) and Bone-Setter (600-608) ability IDs, following the established pattern of per-specialization ID ranges.
- **Target data as parameters**: Mark Quarry target ID and name are passed as method parameters rather than loaded from a repository, matching the established Bone-Setter and Berserkr patterns and keeping services pure.

## Test Results

```
Veiðimaðr tests: 38
     Passed: 38
     Failed: 0

Breakdown:
  QuarryMarksResourceTests:            15 domain tests
  VeidimadurAbilityServiceTests:       23 application tests
```
