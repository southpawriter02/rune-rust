# Changelog: v0.3.12a - The Explorer's Path

**Release Date:** 2025-12-23
**Total Tests:** 2604 (9 new tests added)

## Table of Contents

- [Summary](#summary)
- [New Files Created](#new-files-created)
- [Files Modified](#files-modified)
- [Code Implementation Details](#code-implementation-details)
- [Logging Matrix](#logging-matrix)
- [Test Coverage](#test-coverage)
- [Verification Results](#verification-results)
- [Directory Structure After v0.3.12a](#directory-structure-after-v0312a)
- [Running Tests](#running-tests)
- [Design Decisions](#design-decisions)
- [Next Steps](#next-steps)
- [Credits](#credits)

---

## Summary

Version 0.3.12a establishes the **E2E Integration Testing Infrastructure** for Rune & Rust, enabling automated journey testing through complete game sessions. This release introduces a scripted input system that feeds predetermined commands to the game loop, a self-contained test host with isolated dependency injection, and deterministic RNG seeding for reproducible test runs.

**Layers Touched:**
- **Engine Layer:** Modified `DiceService` to support optional seed parameter for deterministic dice rolls
- **Test Layer:** Created `ScriptedInputHandler`, `TestGameHost`, `TestSettingsService`, and `ExplorationJourneyTests`

**Patterns Introduced:**
- **Scripted Input Pattern:** Queue-based command feeding with automatic "quit" on exhaustion
- **Test Host Factory:** Static factory method creating isolated DI containers per test
- **Deterministic RNG Seeding:** Constructor-injected seed for reproducible random number sequences
- **In-Memory Database Isolation:** Unique GUID-based database names per test host instance
- **Output Capture Buffers:** Triple-buffer system (output, errors, prompts) for test assertions

**Key Metrics:**
- 3 new files created (2 infrastructure classes, 1 test class)
- 1 file modified (DiceService)
- 9 E2E integration tests covering exploration journeys
- 40+ services registered in TestGameHost DI container
- 100% test pass rate for new tests

---

## New Files Created

### Test Layer

| File | Purpose |
|------|---------|
| `RuneAndRust.Tests/Infrastructure/ScriptedInputHandler.cs` | Test implementation of `IInputHandler` that feeds commands from a `Queue<string>` and captures all output/error/prompt messages for test assertions |
| `RuneAndRust.Tests/Infrastructure/TestGameHost.cs` | Self-contained test host with isolated DI container, in-memory database, seeded RNG, and convenience methods for E2E test setup |
| `RuneAndRust.Tests/Integration/ExplorationJourneyTests.cs` | 9 E2E integration tests simulating complete exploration journeys through the game loop |

---

## Files Modified

| File | Change |
|------|--------|
| `RuneAndRust.Engine/Services/DiceService.cs` | Added constructor overload accepting optional `int? seed` parameter. When seeded, uses `new Random(seed.Value)` instead of `Random.Shared`. Original constructor chains to new overload with `null` seed for backward compatibility. Added `_random` field to replace direct `Random.Shared` calls. |

---

## Code Implementation Details

### ScriptedInputHandler

**Location:** `RuneAndRust.Tests/Infrastructure/ScriptedInputHandler.cs`

**Purpose:** A test-only implementation of `IInputHandler` that provides scripted input from a predetermined queue, simulating user keyboard input for automated E2E testing.

**Constructor:**
```csharp
public ScriptedInputHandler(IEnumerable<string> commands, ILogger<ScriptedInputHandler> logger)
```
- Initializes internal `Queue<string>` from provided commands
- Stores logger for structured diagnostic output
- Logs initialization with command count

**Properties:**

| Property | Type | Description |
|----------|------|-------------|
| `OutputBuffer` | `List<string>` | Captures all messages from `DisplayMessage()` calls |
| `ErrorBuffer` | `List<string>` | Captures all messages from `DisplayError()` calls |
| `PromptBuffer` | `List<string>` | Captures all prompts passed to `GetInput()` |
| `RemainingCommands` | `int` | Number of commands still in queue |
| `IsScriptExhausted` | `bool` | True when queue is empty |

**Key Methods:**

| Method | Behavior |
|--------|----------|
| `GetInput(string prompt)` | Dequeues next command; returns `"quit"` if queue empty (graceful termination) |
| `DisplayMessage(string)` | Appends to `OutputBuffer`; logs at Trace level |
| `DisplayError(string)` | Appends to `ErrorBuffer`; logs at Debug level |
| `OutputContains(string)` | Case-insensitive search across all output lines |
| `ErrorContains(string)` | Case-insensitive search across all error lines |
| `GetFullOutput()` | Joins all output lines with `Environment.NewLine` |
| `ClearBuffers()` | Clears all three buffers; logs buffer clear event |

**Behaviors:**
- Graceful script exhaustion: Returns `"quit"` when no commands remain, ensuring game loop terminates
- Prompt capture: Records every prompt for verifying game asked correct questions
- Case-insensitive output matching: Simplifies test assertions

---

### TestGameHost

**Location:** `RuneAndRust.Tests/Infrastructure/TestGameHost.cs`

**Purpose:** A self-contained test host providing an isolated DI container with all game services configured for E2E testing. Each instance uses a unique in-memory database and optionally seeded RNG.

**Factory Method:**
```csharp
public static TestGameHost Create(int? seed, IEnumerable<string> script, string? databaseName = null)
```

**Parameters:**
| Parameter | Type | Description |
|-----------|------|-------------|
| `seed` | `int?` | Optional RNG seed for deterministic dice rolls |
| `script` | `IEnumerable<string>` | Command sequence for ScriptedInputHandler |
| `databaseName` | `string?` | Optional database name; defaults to `TestDb_{Guid.NewGuid()}` |

**Properties:**

| Property | Type | Description |
|----------|------|-------------|
| `Services` | `IServiceProvider` | The DI container for this test host |
| `GameState` | `GameState` | The game state singleton from this container |
| `InputHandler` | `ScriptedInputHandler` | The scripted input handler for this test run |
| `Seed` | `int?` | The seed used for deterministic dice rolls |

**DI Registrations (40+ services organized by category):**

**Database:**
- `RuneAndRustDbContext` with `UseInMemoryDatabase(dbName)`

**Repositories (12 scoped):**
- `IRepository<>` → `GenericRepository<>`
- `ISaveGameRepository`, `IRoomRepository`, `ICharacterRepository`
- `IInteractableObjectRepository`, `ICodexEntryRepository`, `IDataCaptureRepository`
- `IActiveAbilityRepository`, `IItemRepository`, `IRoomTemplateRepository`
- `IBiomeDefinitionRepository`, `IBiomeElementRepository`, `IInventoryRepository`

**Core Singletons:**
- `GameState`, `IInputHandler` (ScriptedInputHandler), `ILoggerFactory`, `ILogger<>`

**Engine Services (Singletons):**
- `CommandParser`, `IGameService`, `IStatCalculationService`
- `IInitiativeService`, `IStatusEffectService`, `ITraumaService`
- `IAttackResolutionService`, `IEnemyAIService`, `ICreatureTraitService`
- `IResourceService`, `IAbilityService`, `ILibraryService`
- `ISettingsService` (TestSettingsService), `IVisualEffectService`
- `IThemeService`, `IInputConfigurationService`, `IContextHelpService`
- `EffectScriptExecutor`

**Engine Services (Scoped):**
- `SaveManager`, `DungeonGenerator`, `INavigationService`
- `IDescriptorEngine`, `IInteractionService`, `IDataCaptureService`
- `ObjectSpawner`, `IDocGenService`, `IJournalService`
- `ILootService`, `ICombatService`, `CharacterFactory`
- `CharacterCreationController`, `IEnemyFactory`, `IInventoryService`
- `IAmbushService`, `IRestService`, `ICraftingService`
- `IBodgingService`, `IHazardService`, `IConditionService`
- `IEnvironmentPopulator`, `ITemplateLoaderService`
- `ITemplateRendererService`, `IElementSpawnEvaluator`

**DiceService Registration (Conditional):**
```csharp
if (seed.HasValue)
{
    services.AddSingleton<IDiceService>(sp =>
        new DiceService(sp.GetRequiredService<ILogger<DiceService>>(), seed));
}
else
{
    services.AddSingleton<IDiceService, DiceService>();
}
```

**Key Methods:**

| Method | Behavior |
|--------|----------|
| `RunAsync()` | Resolves `IGameService` and calls `StartAsync()` to run game loop |
| `SetupExplorationAsync(string characterName)` | Creates test character, sets phase to Exploration, seeds two test rooms |
| `Dispose()` | Disposes the service provider |

**SetupExplorationAsync Implementation:**
1. Creates a Warrior character using `CharacterFactory.CreateSimple()`
2. Sets `GameState.Phase = GamePhase.Exploration`
3. Creates "Test Chamber" (starting room) at origin with exit to North
4. Creates "Northern Corridor" at (0,1,0) with exit to South
5. Links rooms bidirectionally
6. Persists rooms to in-memory database
7. Sets `CurrentRoomId` and adds to `VisitedRoomIds`

---

### TestSettingsService

**Location:** `RuneAndRust.Tests/Infrastructure/TestGameHost.cs` (internal class)

**Purpose:** A minimal no-op implementation of `ISettingsService` for tests that don't require settings functionality.

```csharp
internal class TestSettingsService : ISettingsService
{
    public Task LoadAsync() => Task.CompletedTask;
    public Task SaveAsync() => Task.CompletedTask;
    public Task ResetToDefaultsAsync() => Task.CompletedTask;
}
```

**Behaviors:**
- All methods return immediately without side effects
- Does not persist settings to disk
- Prevents file system dependencies in tests

---

### DiceService Seeded Constructor

**Location:** `RuneAndRust.Engine/Services/DiceService.cs`

**Original Constructor (preserved for backward compatibility):**
```csharp
public DiceService(ILogger<DiceService> logger)
    : this(logger, seed: null)
{
}
```

**New Seeded Constructor:**
```csharp
public DiceService(ILogger<DiceService> logger, int? seed)
{
    _logger = logger;

    if (seed.HasValue)
    {
        _random = new Random(seed.Value);
        _logger.LogInformation("DiceService initialized with seed {Seed} for deterministic rolls", seed.Value);
    }
    else
    {
        _random = Random.Shared;
        _logger.LogDebug("DiceService initialized with Random.Shared");
    }
}
```

**Changes to Roll Methods:**
- `Roll()`: Changed `Random.Shared.Next(1, 11)` to `_random.Next(1, 11)`
- `RollSingle()`: Changed `Random.Shared.Next(1, sides + 1)` to `_random.Next(1, sides + 1)`

**New Field:**
```csharp
private readonly Random _random;
```

**Behaviors:**
- Seeded mode: Uses dedicated `Random` instance with specified seed
- Unseeded mode: Uses `Random.Shared` (thread-safe, shared instance)
- Same seed always produces identical roll sequences
- Logging indicates which mode is active

---

## Logging Matrix

### ScriptedInputHandler

| Event | Level | Template | Properties |
|-------|-------|----------|------------|
| Handler Initialized | Info | `"ScriptedInputHandler initialized with {CommandCount} commands"` | CommandCount |
| Script Exhausted | Warning | `"Script exhausted at prompt: {Prompt}. Returning 'quit' to end test."` | Prompt |
| Scripted Input | Debug | `"Scripted input: '{Command}' (responding to: {Prompt}, {Remaining} commands remaining)"` | Command, Prompt, Remaining |
| Output Captured | Trace | `"Output captured: {Message}"` | Message |
| Error Captured | Debug | `"Error captured: {Message}"` | Message |
| Buffers Cleared | Debug | `"All buffers cleared"` | - |

### DiceService (New Events)

| Event | Level | Template | Properties |
|-------|-------|----------|------------|
| Seeded Initialization | Info | `"DiceService initialized with seed {Seed} for deterministic rolls"` | Seed |
| Shared Initialization | Debug | `"DiceService initialized with Random.Shared"` | - |

---

## Test Coverage

**Summary:**
```
Test Run Successful.
Total tests: 9
     Passed: 9
 Total time: 1.0232 Seconds
```

### ExplorationJourneyTests (9 tests)

| Test Name | Description |
|-----------|-------------|
| `Journey_NewGame_To_FirstRoom_DisplaysWelcome` | Verifies game initialization displays welcome message and help hint. Executes "look" then "quit", asserts output contains expected strings. |
| `Journey_Look_Command_DisplaysRoomInfo` | Verifies look command produces room description output. Asserts OutputBuffer is non-empty and script fully consumed. |
| `Journey_Navigation_MovesCharacter` | Verifies navigation commands (north, south, east, west) are processed without errors. Confirms starting room remains in VisitedRoomIds. |
| `Journey_InvalidCommand_ShowsError` | Verifies unknown command "xyzzy" produces feedback message. Asserts either ErrorBuffer has content or OutputBuffer contains "unknown"/"command". |
| `Journey_Help_Command_DisplaysOptions` | Verifies help command produces output. Asserts OutputBuffer has at least one entry after "help" command. |
| `Journey_ScriptExhaustion_ReturnsQuit` | Verifies graceful termination when script exhausts. Single "look" command followed by automatic "quit" from exhausted handler. |
| `Journey_DeterministicSeed_ProducesSameResults` | Verifies identical seeds produce identical output. Two test runs with seed 12345 produce byte-identical `GetFullOutput()` strings. |
| `Journey_DifferentSeeds_ProduceDifferentRoomIds` | Verifies test isolation between hosts. Different seeds (100 vs 200) create different database instances with different room GUIDs. |
| `Journey_ExtendedExploration_CompletesSuccessfully` | Verifies multi-command journey completes. Executes 7 commands (look, help, inventory, journal, status, look, quit), asserts all consumed and 6+ prompts displayed. |

---

## Verification Results

### Build Output

```
Build succeeded.
    0 Warning(s)
    0 Error(s)
```

### Test Output

```
dotnet test --filter "FullyQualifiedName~ExplorationJourneyTests" --no-build -v n

Test Run Successful.
Total tests: 9
     Passed: 9
 Total time: 1.0232 Seconds
```

### DiceService Tests (Regression Verification)

```
dotnet test --filter "FullyQualifiedName~DiceService" --no-build

Passed!  - Failed: 0, Passed: 35, Skipped: 0, Total: 35, Duration: 0.5173 Seconds
```

---

## Directory Structure After v0.3.12a

```
RuneAndRust.Engine/
└── Services/
    └── DiceService.cs                                  [MODIFIED]

RuneAndRust.Tests/
├── Infrastructure/
│   ├── ScriptedInputHandler.cs                         [NEW]
│   └── TestGameHost.cs                                 [NEW]
└── Integration/
    └── ExplorationJourneyTests.cs                      [NEW]
```

---

## Running Tests

**Run all v0.3.12a tests:**
```bash
dotnet test --filter "FullyQualifiedName~ExplorationJourneyTests"
```

**Run with verbose output:**
```bash
dotnet test --filter "ExplorationJourneyTests" --logger "console;verbosity=detailed"
```

**Verify DiceService regression:**
```bash
dotnet test --filter "FullyQualifiedName~DiceService"
```

**Run specific journey test:**
```bash
dotnet test --filter "Journey_DeterministicSeed_ProducesSameResults"
```

---

## Design Decisions

### Why Queue-Based Input?

**Problem:** E2E tests need to simulate keyboard input without user interaction.

**Solution:** `Queue<string>` provides FIFO ordering matching natural command sequences. The `Dequeue()` operation is O(1) and thread-safe for single-consumer scenarios. When exhausted, returning "quit" ensures graceful test termination without hanging.

### Why In-Memory Database per Test?

**Problem:** Tests must be isolated to prevent cross-contamination of game state.

**Solution:** Each `TestGameHost.Create()` call generates a unique database name using `Guid.NewGuid()`. EF Core's `UseInMemoryDatabase()` creates a fresh, isolated database instance. No cleanup required between tests; garbage collection handles disposal.

### Why TestSettingsService No-Op?

**Problem:** `ISettingsService` is required by the DI container but E2E tests don't need settings persistence.

**Solution:** A minimal implementation returning `Task.CompletedTask` satisfies the interface contract without file system dependencies. Tests remain fast and don't pollute the user's settings file.

### Why Constructor Chaining for DiceService?

**Problem:** Adding seeding support must maintain backward compatibility with existing unseeded usage.

**Solution:** The original constructor chains to the new seeded constructor with `seed: null`. Existing code continues to work unchanged. The `_random` field unifies both paths, using either a seeded `Random` or `Random.Shared`. This pattern follows .NET conventions for optional parameter extensions.

### Why Test Room Direct Creation?

**Problem:** `DungeonGenerator.GenerateTestMapAsync()` requires biome data seeding which adds complexity to test setup.

**Solution:** `SetupExplorationAsync()` creates two linked test rooms directly via EF Core. This bypasses the biome seeder dependency while still exercising the navigation and room lookup code paths. The test rooms have realistic properties (names, descriptions, exits) for meaningful assertions.

---

## Next Steps

- **v0.3.12b (The Arena):** Combat journey tests with seeded enemy spawns and attack resolution
- **v0.3.12c (The Gauntlet):** Full gameplay loop tests including character creation, loot, and inventory
- **Future:** CI/CD integration with test scripts as regression gates
- **Future:** Parameterized test data for expanded journey coverage

---

## Credits

**Primary Developer:** The Architect (Claude)
**Test Coverage:** 100% for new ExplorationJourneyTests (9/9 tests passing)
**Integration:** Zero regressions in existing DiceService tests (35/35 tests passing)
**Documentation:** Follows CHANGELOG_GENERATION_RULES.md Extended Template
