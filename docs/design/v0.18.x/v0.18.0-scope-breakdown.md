# v0.18.0 Psychic Stress System - Scope Breakdown

**Version:** 0.18.0
**Theme:** Psychic Stress System
**Prerequisites:** v0.17.5 Complete (Character Creation), v0.6.x (Dice System)
**Total Estimated Tests:** ~20 new tests

---

## Executive Summary

v0.18.0 implements the **Psychic Stress** system — the primary psychological damage resource that creates tactical pressure during combat and exploration. Stress accumulates from horror encounters and penalizes Defense, creating a death spiral that rewards proactive management.

The work is divided into **6 sub-phases**:

| Phase    | Name                         | Focus                                      | Est. Tests |
| -------- | ---------------------------- | ------------------------------------------ | ---------- |
| v0.18.0a | Stress Enums & State         | StressThreshold, StressSource, StressState | ~4         |
| v0.18.0b | Stress Result Objects        | Check, Application, Recovery results       | ~3         |
| v0.18.0c | IStressService Interface     | Service contract definition                | ~0         |
| v0.18.0d | StressService Implementation | Core stress logic                          | ~8         |
| v0.18.0e | Configuration & Schema       | stress-sources.json + schema               | ~3         |
| v0.18.0f | Database Persistence         | Schema extension, history tracking         | ~2         |

---

## Feature Analysis & Categorization

### From trauma-economy.md - Stress Tracking

| Feature                  | Complexity | Dependencies   | Assigned Phase |
| ------------------------ | ---------- | -------------- | -------------- |
| StressThreshold Enum     | Low        | None           | **v0.18.0a**   |
| StressSource Enum        | Low        | None           | **v0.18.0a**   |
| RestType Enum            | Low        | None           | **v0.18.0a**   |
| StressState Value Object | Medium     | Threshold enum | **v0.18.0a**   |

### From trauma-economy.md - Stress Operations

| Feature                    | Complexity | Dependencies | Assigned Phase |
| -------------------------- | ---------- | ------------ | -------------- |
| StressCheckResult VO       | Low        | None         | **v0.18.0b**   |
| StressApplicationResult VO | Medium     | StressState  | **v0.18.0b**   |
| StressRecoveryResult VO    | Low        | StressState  | **v0.18.0b**   |

### From trauma-economy.md - Service Layer

| Feature        | Complexity | Dependencies         | Assigned Phase |
| -------------- | ---------- | -------------------- | -------------- |
| IStressService | Medium     | All VOs              | **v0.18.0c**   |
| StressService  | High       | IStressService, Dice | **v0.18.0d**   |

### From trauma-economy.md - Configuration

| Feature                    | Complexity | Dependencies  | Assigned Phase |
| -------------------------- | ---------- | ------------- | -------------- |
| stress-sources.json        | Medium     | None          | **v0.18.0e**   |
| stress-sources.schema.json | Medium     | None          | **v0.18.0e**   |
| Database schema extension  | Medium     | StressService | **v0.18.0f**   |

---

## Phase Definitions

---

## v0.18.0a: Stress Enums & State

[v0.18.0a Design Specification](v0.18.0a-design-specification.md)

### Overview

Defines the foundational enums and StressState value object that track a character's psychological state and determine mechanical penalties.

### Scope

**In Scope:**

- `StressThreshold` enum (6 tiers: Calm → Trauma)
- `StressSource` enum (6 categories: Combat, Exploration, etc.)
- `RestType` enum (4 types: Short, Long, Sanctuary, Milestone)
- `StressState` value object with computed properties

**Out of Scope:**

- Stress application logic (v0.18.0d)
- Recovery mechanics (v0.18.0d)
- Configuration loading (v0.18.0e)

### Key Deliverables

| Type                 | Count | Details                                 |
| -------------------- | ----- | --------------------------------------- |
| Domain Enums         | 3     | StressThreshold, StressSource, RestType |
| Domain Value Objects | 1     | StressState                             |
| Unit Tests           | ~4    |                                         |

### Data Model Changes

```
NEW: StressThreshold (Enum)
├── Calm = 0       (0-19 stress)
├── Uneasy = 1     (20-39 stress)
├── Anxious = 2    (40-59 stress)
├── Panicked = 3   (60-79 stress)
├── Breaking = 4   (80-99 stress)
└── Trauma = 5     (100 stress)

NEW: StressSource (Enum)
├── Combat
├── Exploration
├── Narrative
├── Heretical
├── Environmental
└── Corruption

NEW: RestType (Enum)
├── Short          (WILL × 2 recovery)
├── Long           (WILL × 5 recovery)
├── Sanctuary      (Full reset)
└── Milestone      (25 recovery)

NEW: StressState (Value Object)
├── CurrentStress: int (0-100)
├── MaxStress: const 100
├── MinStress: const 0
├── Threshold: StressThreshold (computed)
├── DefensePenalty: int (floor(Stress/20))
├── HasSkillDisadvantage: bool (Stress >= 80)
└── RequiresTraumaCheck: bool (Stress >= 100)
```

### User-Facing Changes

**None** - Backend foundation only.

### Acceptance Criteria

- [x] StressThreshold enum has 6 values with correct stress ranges
- [x] StressSource enum has 6 categories
- [x] RestType enum has 4 types with documented formulas
- [x] StressState correctly computes DefensePenalty as floor(Stress/20)
- [x] StressState correctly flags HasSkillDisadvantage at 80+
- [x] StressState correctly flags RequiresTraumaCheck at exactly 100
- [x] ~4 unit tests pass

---

## v0.18.0b: Stress Result Objects

[v0.18.0b Design Specification](v0.18.0b-design-specification.md)

### Overview

Defines value objects that capture the results of stress operations: resistance checks, stress application, and stress recovery.

### Scope

**In Scope:**

- `StressCheckResult` value object
- `StressApplicationResult` value object
- `StressRecoveryResult` value object

**Out of Scope:**

- Service that creates these results (v0.18.0d)
- Actual dice rolling logic (uses existing `IDiceService`)

### Key Deliverables

| Type                 | Count | Details                                                          |
| -------------------- | ----- | ---------------------------------------------------------------- |
| Domain Value Objects | 3     | StressCheckResult, StressApplicationResult, StressRecoveryResult |
| Unit Tests           | ~3    |                                                                  |

### Data Model Changes

```
NEW: StressCheckResult (Record)
├── Succeeded: bool
├── Successes: int
├── BaseStress: int
├── FinalStress: int
└── ReductionPercent: decimal (computed)

NEW: StressApplicationResult (Record)
├── PreviousStress: int
├── NewStress: int
├── StressGained: int
├── PreviousThreshold: StressThreshold
├── NewThreshold: StressThreshold
├── ThresholdCrossed: bool (computed)
├── TraumaCheckTriggered: bool
└── ResistanceResult: StressCheckResult?

NEW: StressRecoveryResult (Record)
├── PreviousStress: int
├── NewStress: int
├── AmountRecovered: int
├── RecoverySource: RestType
├── PreviousThreshold: StressThreshold
├── NewThreshold: StressThreshold
└── ThresholdDropped: bool (computed)
```

### Resistance Reduction Table

| Successes | Reduction | Result         |
| --------- | --------- | -------------- |
| 0         | 0%        | Full stress    |
| 1         | 50%       | Half stress    |
| 2-3       | 75%       | Quarter stress |
| 4+        | 100%      | No stress      |

### Acceptance Criteria

- [x] StressCheckResult computes ReductionPercent from Successes
- [x] StressApplicationResult detects ThresholdCrossed correctly
- [x] StressRecoveryResult detects ThresholdDropped correctly
- [x] ~3 unit tests pass

---

## v0.18.0c: IStressService Interface

[v0.18.0c Design Specification](v0.18.0c-design-specification.md)

### Overview

Defines the service contract for all stress management operations.

### Scope

**In Scope:**

- `IStressService` interface definition
- Method signatures and XML documentation

**Out of Scope:**

- Implementation (v0.18.0d)

### Key Deliverables

| Type                   | Count | Details        |
| ---------------------- | ----- | -------------- |
| Application Interfaces | 1     | IStressService |
| Unit Tests             | ~0    | Interface only |

### Interface Definition

```csharp
public interface IStressService
{
    // Queries
    StressState GetStressState(Guid characterId);
    int GetDefensePenalty(Guid characterId);
    bool HasSkillDisadvantage(Guid characterId);
    bool RequiresTraumaCheck(Guid characterId);

    // Commands
    StressApplicationResult ApplyStress(
        Guid characterId, int amount, StressSource source, int resistDc = 0);
    StressRecoveryResult RecoverStress(Guid characterId, RestType restType);
    StressRecoveryResult RecoverStress(Guid characterId, int amount, string source);
    void ResetAfterTraumaCheck(Guid characterId, bool passed);

    // Internal
    StressCheckResult PerformResistanceCheck(Guid characterId, int baseStress, int dc);
}
```

### Acceptance Criteria

- [ ] IStressService defines all 9 methods
- [ ] All methods have XML documentation
- [ ] Interface compiles without dependencies on implementation

---

## v0.18.0d: StressService Implementation

[v0.18.0d Design Specification](v0.18.0d-design-specification.md)

### Overview

Implements the core stress logic including application, resistance checks, recovery, and Trauma Check reset.

### Scope

**In Scope:**

- `StressService` class implementing `IStressService`
- WILL-based resistance checks via `IDiceService`
- Recovery formulas for all `RestType` values
- Trauma Check reset logic

**Out of Scope:**

- Trauma Check execution (v0.18.3)
- Configuration loading (v0.18.0e)
- Database persistence (v0.18.0f)

### Key Deliverables

| Type                 | Count | Details       |
| -------------------- | ----- | ------------- |
| Application Services | 1     | StressService |
| Unit Tests           | ~8    |               |

### Dependencies

```csharp
public StressService(
    ICharacterRepository characterRepository,
    IDiceService diceService,
    ILogger<StressService> logger)
```

### Recovery Formulas

| RestType  | Formula    | Example (WILL=4) |
| --------- | ---------- | ---------------- |
| Short     | WILL × 2   | 8 stress         |
| Long      | WILL × 5   | 20 stress        |
| Sanctuary | FULL_RESET | All stress       |
| Milestone | 25 (fixed) | 25 stress        |

### Trauma Check Reset Values

| Trauma Check Result | New Stress Value |
| ------------------- | ---------------- |
| Passed              | 75               |
| Failed              | 50               |

### Acceptance Criteria

- [ ] ApplyStress clamps results to 0-100 range
- [ ] ApplyStress with resistDc > 0 performs WILL check
- [ ] Successful resistance reduces stress per formula
- [ ] Failed resistance applies full stress
- [ ] ThresholdCrossed detected on threshold boundary
- [ ] TraumaCheckTriggered true only when reaching exactly 100
- [ ] RecoverStress uses correct formula per RestType
- [ ] ResetAfterTraumaCheck sets 75 (passed) or 50 (failed)
- [ ] ~8 unit tests pass

---

## v0.18.0e: Configuration & Schema

[v0.18.0e Design Specification](v0.18.0e-design-specification.md)

### Overview

Defines the JSON configuration for stress sources and recovery rates, along with the JSON Schema for validation.

### Scope

**In Scope:**

- `config/stress-sources.json` configuration file
- `config/schemas/stress-sources.schema.json` JSON Schema
- `StressSourceDefinition` DTO for deserialization

**Out of Scope:**

- Runtime configuration loading (uses existing `IConfigurationProvider`)

### Key Deliverables

| Type                | Count | Details                    |
| ------------------- | ----- | -------------------------- |
| Configuration Files | 1     | stress-sources.json        |
| JSON Schemas        | 1     | stress-sources.schema.json |
| DTOs                | 1     | StressSourceDefinition     |
| Unit Tests          | ~3    |                            |

### Configuration Structure

```json
{
  "$schema": "./schemas/stress-sources.schema.json",
  "version": "1.0",
  "stressSources": {
    "combat": [
      { "id": "enemy-fear-aura", "baseStress": 15, "resistDc": 2 }
    ],
    "exploration": [...],
    "heretical": [...],
    "environmental": [...]
  },
  "recoveryRates": {
    "shortRest": { "formula": "WILL × 2" },
    "longRest": { "formula": "WILL × 5" },
    "sanctuary": { "formula": "FULL_RESET" },
    "milestone": { "formula": "25" }
  },
  "traumaCheckReset": { "passed": 75, "failed": 50 }
}
```

### Acceptance Criteria

- [ ] Schema validates correct stress source definitions
- [ ] Schema rejects invalid baseStress values (< 1 or > 100)
- [ ] Schema rejects invalid resistDc values (< 0 or > 10)
- [ ] Configuration loads all stress source categories
- [ ] ~3 unit tests pass

---

## v0.18.0f: Database Persistence

[v0.18.0f Design Specification](v0.18.0f-design-specification.md)

### Overview

Extends the database schema to persist stress state and track stress event history for analytics.

### Scope

**In Scope:**

- Add `psychic_stress` column to character resources
- Create `stress_history` table
- `StressHistoryEntry` entity

**Out of Scope:**

- Analytics/reporting UI (future version)

### Key Deliverables

| Type                | Count | Details                              |
| ------------------- | ----- | ------------------------------------ |
| Database Migrations | 1     | Add stress columns and history table |
| Domain Entities     | 1     | StressHistoryEntry                   |
| Unit Tests          | ~2    |                                      |

### Data Model Changes

```sql
ALTER TABLE character_resources ADD COLUMN
    psychic_stress INT NOT NULL DEFAULT 0
    CONSTRAINT chk_psychic_stress CHECK (psychic_stress >= 0 AND psychic_stress <= 100);

CREATE TABLE stress_history (
    id UUID PRIMARY KEY,
    character_id UUID NOT NULL REFERENCES characters(id),
    amount INT NOT NULL,
    source VARCHAR(50) NOT NULL,
    resist_dc INT,
    resisted BOOLEAN NOT NULL DEFAULT false,
    final_amount INT NOT NULL,
    previous_stress INT NOT NULL,
    new_stress INT NOT NULL,
    threshold_crossed VARCHAR(20),
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP
);
```

### Acceptance Criteria

- [ ] psychic_stress column added with CHECK constraint
- [ ] stress_history table created with proper indexes
- [ ] StressHistoryEntry records on each ApplyStress call
- [ ] ~2 unit tests pass

---

## Dependencies & Prerequisites

```
v0.6.x (Dice System) - REQUIRED
    │
    └── IDiceService (WILL resistance checks)
                    │
v0.17.5 (Character Creation) - REQUIRED
    │
    └── Character entity with WILL attribute
                    │
                    ▼
v0.18.0 (Psychic Stress System)
    │
    ├── v0.18.0a: Stress Enums & State ──────────────┐
    │       Dependencies: None                        │
    │                                                 │
    ├── v0.18.0b: Stress Result Objects ─────────────┤
    │       Dependencies: v0.18.0a                   │
    │                                                 │
    ├── v0.18.0c: IStressService Interface ──────────┤
    │       Dependencies: v0.18.0a, v0.18.0b         │
    │                                                 │
    ├── v0.18.0d: StressService Implementation ──────┤
    │       Dependencies: v0.18.0c, IDiceService     │
    │                                                 │
    ├── v0.18.0e: Configuration & Schema ────────────┤
    │       Dependencies: v0.18.0a                   │
    │                                                 │
    └── v0.18.0f: Database Persistence ──────────────┘
            Dependencies: v0.18.0d
```

---

## Estimated Effort Summary

| Phase     | New Files | Modified Files | Est. Tests | Complexity |
| --------- | --------- | -------------- | ---------- | ---------- |
| v0.18.0a  | 4         | 0              | ~4         | Low        |
| v0.18.0b  | 3         | 0              | ~3         | Low        |
| v0.18.0c  | 1         | 0              | ~0         | Low        |
| v0.18.0d  | 1         | 1              | ~8         | High       |
| v0.18.0e  | 3         | 0              | ~3         | Medium     |
| v0.18.0f  | 2         | 1              | ~2         | Medium     |
| **Total** | **14**    | **2**          | **~20**    |            |

---

## Risk Assessment

| Risk                             | Impact | Probability | Mitigation                         |
| -------------------------------- | ------ | ----------- | ---------------------------------- |
| WILL check integration issues    | Medium | Low         | Use existing IDiceService mocks    |
| Threshold boundary edge cases    | Low    | Medium      | Comprehensive boundary tests       |
| Performance with history logging | Low    | Low         | Async history writes, index tuning |

---

## Design Decisions (Confirmed)

### Stress Mechanics

| Decision                         | Value            | Notes                         |
| -------------------------------- | ---------------- | ----------------------------- |
| **Stress Range**                 | 0-100            | Matches d100 conceptual model |
| **Threshold Count**              | 6 tiers          | 20-point increments           |
| **Defense Penalty Formula**      | floor(Stress/20) | Maximum -5 at 100 stress      |
| **Skill Disadvantage Threshold** | 80+              | Breaking and Trauma only      |
| **Trauma Check Trigger**         | Exactly 100      | Not "100 or more"             |

### Recovery Mechanics

| Decision                | Value           | Notes                    |
| ----------------------- | --------------- | ------------------------ |
| **Short Rest Recovery** | WILL × 2        | Quick tactical recovery  |
| **Long Rest Recovery**  | WILL × 5        | Significant but not full |
| **Sanctuary Recovery**  | Full reset to 0 | Safe haven mechanic      |
| **Milestone Recovery**  | Fixed 25        | Achievement reward       |

---

## Next Steps

1. **Review & Approve** - Confirm scope breakdown with stakeholders
2. **v0.18.0a Design Spec** - Create detailed design specification for Stress Enums & State
3. **Implement v0.18.0a** - Build foundational enums and StressState
4. **Repeat for v0.18.0b through v0.18.0f**

---

_This scope breakdown provides a structured approach to implementing v0.18.0 Psychic Stress System. Each sub-phase builds on the previous, allowing for incremental development and testing._
