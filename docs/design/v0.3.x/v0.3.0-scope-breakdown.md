# v0.3.0 Quest Foundation - Scope Breakdown

**Version:** 0.3.0
**Theme:** Quest Foundation
**Prerequisites:** v0.2.2 Complete (Merchant System)
**Total Estimated Tests:** ~75 new tests

---

## Executive Summary

The Quest Foundation version establishes the core quest system that enables players to accept, track, and complete objectives. This version introduces the Quest and QuestObjective entities, a quest journal for viewing progress, and the fundamental infrastructure for tracking kill, collect, and explore objectives. The system integrates with the existing dialogue system for quest acceptance and lays the groundwork for rewards (v0.3.1) and quest chains (v0.3.2).

Key focus areas:
- **Quest Entity**: Core quest data with status tracking
- **QuestObjective Entity**: Individual goals with progress counters
- **Quest Journal**: TUI interface for viewing quests
- **Progress Tracking**: Automatic updates from game events
- **Dialogue Integration**: Accept quests through NPC conversations

The work is divided into **three sub-phases**:

| Phase | Name | Focus | Est. Tests |
|-------|------|-------|------------|
| v0.3.0a | Quest Entity & Objectives | Quest, QuestObjective, QuestDefinition, status tracking | ~25 |
| v0.3.0b | Quest Journal & Commands | Journal UI, quests command, progress display | ~25 |
| v0.3.0c | Progress Tracking & Integration | Event listeners, dialogue integration, completion | ~25 |

---

## Existing Infrastructure

### Already Implemented (from v0.2.x)

| Feature | Location | Notes |
|---------|----------|-------|
| NPC entity | `Domain/Entities/NPC.cs` | Quest givers |
| DialogueNode | `Domain/Entities/DialogueNode.cs` | Quest acceptance |
| DialogueOutcome | `Domain/ValueObjects/DialogueOutcome.cs` | StartQuest outcome |
| Player entity | `Domain/Entities/Player.cs` | Quest owner |
| Monster entity | `Domain/Entities/Monster.cs` | Kill objectives |
| Item entity | `Domain/Entities/Item.cs` | Collect objectives |
| Room entity | `Domain/Entities/Room.cs` | Explore objectives |
| GameSessionService | `Application/Services/GameSessionService.cs` | Event processing |
| IConfigurationProvider | `Application/Interfaces/IConfigurationProvider.cs` | JSON loading |
| CodexEntry | `Domain/Entities/CodexEntry.cs` | Quest lore integration |

### Needs Implementation (v0.3.0)

| Feature | Phase | Notes |
|---------|-------|-------|
| Quest entity | v0.3.0a | Core quest representation |
| QuestDefinition | v0.3.0a | Quest templates |
| QuestObjective entity | v0.3.0a | Individual goals |
| ObjectiveType enum | v0.3.0a | Kill, Collect, Explore, Talk |
| QuestStatus enum | v0.3.0a | Available, Active, Completed, Failed |
| QuestService | v0.3.0b | Quest management |
| QuestJournalView | v0.3.0b | TUI display |
| QuestProgressService | v0.3.0c | Event-driven updates |

---

## Feature Analysis & Categorization

### Quest Entity Features

| Feature | Complexity | Dependencies | Assigned Phase |
|---------|------------|--------------|----------------|
| Quest entity | High | Player | **v0.3.0a** |
| QuestDefinition configuration | Medium | IConfigurationProvider | **v0.3.0a** |
| QuestObjective entity | High | Quest | **v0.3.0a** |
| ObjectiveType enum | Low | None | **v0.3.0a** |
| QuestStatus enum | Low | None | **v0.3.0a** |
| ObjectiveProgress tracking | Medium | QuestObjective | **v0.3.0a** |

### Quest Journal Features

| Feature | Complexity | Dependencies | Assigned Phase |
|---------|------------|--------------|----------------|
| QuestService | High | Quest, QuestObjective | **v0.3.0b** |
| `quests` / `journal` command | Medium | QuestService | **v0.3.0b** |
| Quest detail view | Medium | Quest | **v0.3.0b** |
| Progress display formatting | Medium | QuestObjective | **v0.3.0b** |
| Active/Completed filtering | Low | QuestStatus | **v0.3.0b** |

### Integration Features

| Feature | Complexity | Dependencies | Assigned Phase |
|---------|------------|--------------|----------------|
| QuestProgressService | High | QuestService | **v0.3.0c** |
| Kill objective tracking | Medium | Monster defeat events | **v0.3.0c** |
| Collect objective tracking | Medium | Item pickup events | **v0.3.0c** |
| Explore objective tracking | Medium | Room entry events | **v0.3.0c** |
| Talk objective tracking | Medium | Dialogue events | **v0.3.0c** |
| Dialogue quest acceptance | Medium | DialogueOutcome | **v0.3.0c** |
| Quest completion logic | Medium | QuestService | **v0.3.0c** |

---

## Phase Definitions

---

## v0.3.0a: Quest Entity & Objectives

### Overview

Establish the core quest data model including the Quest entity, QuestObjective entity, and QuestDefinition configuration. This phase creates the foundational structures for tracking quest state and objective progress.

### Scope

**In Scope:**
- `Quest` entity with status and objectives
- `QuestDefinition` configuration for quest templates
- `QuestObjective` entity with progress tracking
- `ObjectiveType` enum (Kill, Collect, Explore, Talk)
- `QuestStatus` enum (Available, Active, Completed, Failed)
- `ObjectiveProgress` value object
- Player quest collections (ActiveQuests, CompletedQuests)
- Basic quest creation from definition

**Out of Scope:**
- Quest journal UI (v0.3.0b)
- `quests` command (v0.3.0b)
- Progress tracking from events (v0.3.0c)
- Dialogue integration (v0.3.0c)
- Quest rewards (v0.3.1)

### Key Deliverables

| Type | Count | Details |
|------|-------|---------|
| Entities | 2 | `Quest`, `QuestObjective` |
| Definitions | 1 | `QuestDefinition` |
| Value Objects | 2 | `ObjectiveProgress`, `ObjectiveTarget` |
| Enums | 2 | `ObjectiveType`, `QuestStatus` |
| Player Updates | 1 | Add quest collections |
| Configuration | 1 | `quests.json` |
| Unit Tests | ~25 | Entity, objective, status tests |

### Quest Entity

```csharp
namespace RuneAndRust.Domain.Entities;

/// <summary>
/// Represents a quest that the player can undertake.
/// </summary>
public class Quest : IEntity
{
    /// <summary>
    /// Gets the unique identifier.
    /// </summary>
    public Guid Id { get; private set; }

    /// <summary>
    /// Gets the quest's definition ID for configuration lookup.
    /// </summary>
    public string DefinitionId { get; private set; } = string.Empty;

    /// <summary>
    /// Gets the quest's display name.
    /// </summary>
    public string Name { get; private set; } = string.Empty;

    /// <summary>
    /// Gets the quest's description.
    /// </summary>
    public string Description { get; private set; } = string.Empty;

    /// <summary>
    /// Gets the current status of the quest.
    /// </summary>
    public QuestStatus Status { get; private set; }

    /// <summary>
    /// Gets the player who owns this quest instance.
    /// </summary>
    public Guid PlayerId { get; private set; }

    /// <summary>
    /// Gets the objectives for this quest.
    /// </summary>
    public IReadOnlyList<QuestObjective> Objectives { get; private set; } = Array.Empty<QuestObjective>();

    /// <summary>
    /// Gets the NPC ID who gave this quest.
    /// </summary>
    public string? GiverNpcId { get; private set; }

    /// <summary>
    /// Gets the NPC ID to turn in this quest.
    /// </summary>
    public string? TurnInNpcId { get; private set; }

    /// <summary>
    /// Gets when the quest was accepted.
    /// </summary>
    public DateTime? AcceptedAt { get; private set; }

    /// <summary>
    /// Gets when the quest was completed.
    /// </summary>
    public DateTime? CompletedAt { get; private set; }

    /// <summary>
    /// Gets brief instructions or hints for the quest.
    /// </summary>
    public string? Hint { get; private set; }

    private Quest() { /* EF Core */ }

    /// <summary>
    /// Creates a new quest from a definition.
    /// </summary>
    public static Quest Create(
        QuestDefinition definition,
        Guid playerId,
        string? giverNpcId = null)
    {
        ArgumentNullException.ThrowIfNull(definition);

        var quest = new Quest
        {
            Id = Guid.NewGuid(),
            DefinitionId = definition.Id,
            Name = definition.Name,
            Description = definition.Description,
            Status = QuestStatus.Available,
            PlayerId = playerId,
            GiverNpcId = giverNpcId,
            TurnInNpcId = definition.TurnInNpcId ?? giverNpcId,
            Hint = definition.Hint
        };

        // Create objectives from definition
        var objectives = definition.Objectives
            .Select(o => QuestObjective.Create(o, quest.Id))
            .ToList();
        quest.Objectives = objectives;

        return quest;
    }

    /// <summary>
    /// Accepts the quest, changing status to Active.
    /// </summary>
    public bool Accept()
    {
        if (Status != QuestStatus.Available)
            return false;

        Status = QuestStatus.Active;
        AcceptedAt = DateTime.UtcNow;
        return true;
    }

    /// <summary>
    /// Checks if all objectives are complete.
    /// </summary>
    public bool AreAllObjectivesComplete()
    {
        return Objectives.All(o => o.IsComplete);
    }

    /// <summary>
    /// Marks the quest as ready to turn in.
    /// </summary>
    public bool MarkReadyForTurnIn()
    {
        if (Status != QuestStatus.Active)
            return false;

        if (!AreAllObjectivesComplete())
            return false;

        // Quest stays Active but is ready for turn-in
        return true;
    }

    /// <summary>
    /// Completes the quest.
    /// </summary>
    public bool Complete()
    {
        if (Status != QuestStatus.Active)
            return false;

        if (!AreAllObjectivesComplete())
            return false;

        Status = QuestStatus.Completed;
        CompletedAt = DateTime.UtcNow;
        return true;
    }

    /// <summary>
    /// Fails the quest.
    /// </summary>
    public void Fail(string? reason = null)
    {
        if (Status == QuestStatus.Completed)
            return;

        Status = QuestStatus.Failed;
    }

    /// <summary>
    /// Gets the overall progress percentage.
    /// </summary>
    public int GetProgressPercent()
    {
        if (Objectives.Count == 0) return 100;

        var totalProgress = Objectives.Sum(o => o.GetProgressPercent());
        return totalProgress / Objectives.Count;
    }

    /// <summary>
    /// Gets an objective by ID.
    /// </summary>
    public QuestObjective? GetObjective(Guid objectiveId)
    {
        return Objectives.FirstOrDefault(o => o.Id == objectiveId);
    }

    /// <summary>
    /// Checks if quest can be turned in.
    /// </summary>
    public bool CanTurnIn()
    {
        return Status == QuestStatus.Active && AreAllObjectivesComplete();
    }
}
```

### QuestStatus Enum

```csharp
namespace RuneAndRust.Domain.Enums;

/// <summary>
/// Status of a quest.
/// </summary>
public enum QuestStatus
{
    /// <summary>Quest is available but not yet accepted.</summary>
    Available,

    /// <summary>Quest has been accepted and is in progress.</summary>
    Active,

    /// <summary>Quest has been completed successfully.</summary>
    Completed,

    /// <summary>Quest has failed and cannot be completed.</summary>
    Failed
}
```

### QuestObjective Entity

```csharp
namespace RuneAndRust.Domain.Entities;

/// <summary>
/// Represents a single objective within a quest.
/// </summary>
public class QuestObjective : IEntity
{
    /// <summary>
    /// Gets the unique identifier.
    /// </summary>
    public Guid Id { get; private set; }

    /// <summary>
    /// Gets the parent quest ID.
    /// </summary>
    public Guid QuestId { get; private set; }

    /// <summary>
    /// Gets the objective type.
    /// </summary>
    public ObjectiveType Type { get; private set; }

    /// <summary>
    /// Gets the objective's description.
    /// </summary>
    public string Description { get; private set; } = string.Empty;

    /// <summary>
    /// Gets the target for this objective.
    /// </summary>
    public ObjectiveTarget Target { get; private set; }

    /// <summary>
    /// Gets the required count to complete.
    /// </summary>
    public int RequiredCount { get; private set; }

    /// <summary>
    /// Gets the current progress count.
    /// </summary>
    public int CurrentCount { get; private set; }

    /// <summary>
    /// Gets whether this objective is complete.
    /// </summary>
    public bool IsComplete => CurrentCount >= RequiredCount;

    /// <summary>
    /// Gets whether this objective is optional.
    /// </summary>
    public bool IsOptional { get; private set; }

    /// <summary>
    /// Gets whether this objective is hidden until discovered.
    /// </summary>
    public bool IsHidden { get; private set; }

    /// <summary>
    /// Gets the order for display.
    /// </summary>
    public int Order { get; private set; }

    private QuestObjective() { /* EF Core */ }

    /// <summary>
    /// Creates an objective from a definition.
    /// </summary>
    public static QuestObjective Create(
        ObjectiveDefinition definition,
        Guid questId)
    {
        ArgumentNullException.ThrowIfNull(definition);

        return new QuestObjective
        {
            Id = Guid.NewGuid(),
            QuestId = questId,
            Type = definition.Type,
            Description = definition.Description,
            Target = definition.Target,
            RequiredCount = definition.RequiredCount,
            CurrentCount = 0,
            IsOptional = definition.IsOptional,
            IsHidden = definition.IsHidden,
            Order = definition.Order
        };
    }

    /// <summary>
    /// Increments progress toward this objective.
    /// </summary>
    public bool IncrementProgress(int amount = 1)
    {
        if (IsComplete) return false;

        CurrentCount = Math.Min(CurrentCount + amount, RequiredCount);
        return true;
    }

    /// <summary>
    /// Sets the progress to a specific value.
    /// </summary>
    public void SetProgress(int count)
    {
        CurrentCount = Math.Clamp(count, 0, RequiredCount);
    }

    /// <summary>
    /// Reveals a hidden objective.
    /// </summary>
    public void Reveal()
    {
        IsHidden = false;
    }

    /// <summary>
    /// Gets the progress percentage.
    /// </summary>
    public int GetProgressPercent()
    {
        if (RequiredCount == 0) return 100;
        return (CurrentCount * 100) / RequiredCount;
    }

    /// <summary>
    /// Gets a formatted progress string.
    /// </summary>
    public string GetProgressString()
    {
        if (RequiredCount == 1)
            return IsComplete ? "[Complete]" : "[Incomplete]";

        return $"({CurrentCount}/{RequiredCount})";
    }
}
```

### ObjectiveType Enum

```csharp
namespace RuneAndRust.Domain.Enums;

/// <summary>
/// Types of quest objectives.
/// </summary>
public enum ObjectiveType
{
    /// <summary>Defeat a specific number of enemies.</summary>
    Kill,

    /// <summary>Collect specific items.</summary>
    Collect,

    /// <summary>Visit a specific location.</summary>
    Explore,

    /// <summary>Talk to a specific NPC.</summary>
    Talk,

    /// <summary>Deliver an item to an NPC.</summary>
    Deliver,

    /// <summary>Use a specific item or ability.</summary>
    Use,

    /// <summary>Custom objective with manual completion.</summary>
    Custom
}
```

### ObjectiveTarget Value Object

```csharp
namespace RuneAndRust.Domain.ValueObjects;

/// <summary>
/// Defines the target for a quest objective.
/// </summary>
public readonly record struct ObjectiveTarget
{
    /// <summary>
    /// Gets the target ID (monster ID, item ID, room ID, NPC ID, etc.).
    /// </summary>
    public string TargetId { get; init; }

    /// <summary>
    /// Gets the display name for the target.
    /// </summary>
    public string DisplayName { get; init; }

    /// <summary>
    /// Gets optional location hint.
    /// </summary>
    public string? LocationHint { get; init; }

    /// <summary>
    /// Gets whether any target of the type counts (e.g., "any goblin").
    /// </summary>
    public bool AnyOfType { get; init; }

    /// <summary>
    /// Gets the target type for "any of type" matching.
    /// </summary>
    public string? TargetType { get; init; }

    /// <summary>
    /// Creates a specific target.
    /// </summary>
    public static ObjectiveTarget Specific(string id, string displayName, string? locationHint = null)
    {
        return new ObjectiveTarget
        {
            TargetId = id,
            DisplayName = displayName,
            LocationHint = locationHint,
            AnyOfType = false
        };
    }

    /// <summary>
    /// Creates an "any of type" target.
    /// </summary>
    public static ObjectiveTarget Any(string targetType, string displayName)
    {
        return new ObjectiveTarget
        {
            TargetId = string.Empty,
            DisplayName = displayName,
            AnyOfType = true,
            TargetType = targetType
        };
    }

    /// <summary>
    /// Checks if a given ID matches this target.
    /// </summary>
    public bool Matches(string id, string? type = null)
    {
        if (AnyOfType)
            return type == TargetType;

        return TargetId == id;
    }
}
```

### QuestDefinition

```csharp
namespace RuneAndRust.Domain.Definitions;

/// <summary>
/// Configuration template for creating quests.
/// </summary>
public class QuestDefinition
{
    /// <summary>
    /// Gets the unique identifier.
    /// </summary>
    public string Id { get; private set; } = string.Empty;

    /// <summary>
    /// Gets the quest's display name.
    /// </summary>
    public string Name { get; private set; } = string.Empty;

    /// <summary>
    /// Gets the quest's description.
    /// </summary>
    public string Description { get; private set; } = string.Empty;

    /// <summary>
    /// Gets the objective definitions.
    /// </summary>
    public IReadOnlyList<ObjectiveDefinition> Objectives { get; private set; }
        = Array.Empty<ObjectiveDefinition>();

    /// <summary>
    /// Gets the NPC ID who gives this quest.
    /// </summary>
    public string? GiverNpcId { get; private set; }

    /// <summary>
    /// Gets the NPC ID for turn-in (defaults to giver).
    /// </summary>
    public string? TurnInNpcId { get; private set; }

    /// <summary>
    /// Gets hints or instructions.
    /// </summary>
    public string? Hint { get; private set; }

    /// <summary>
    /// Gets whether this quest auto-activates on acceptance.
    /// </summary>
    public bool AutoActivate { get; private set; } = true;

    private QuestDefinition() { }

    /// <summary>
    /// Creates a quest definition.
    /// </summary>
    public static QuestDefinition Create(
        string id,
        string name,
        string description,
        IEnumerable<ObjectiveDefinition> objectives,
        string? giverNpcId = null,
        string? turnInNpcId = null,
        string? hint = null)
    {
        ArgumentException.ThrowIfNullOrWhiteSpace(id);
        ArgumentException.ThrowIfNullOrWhiteSpace(name);

        return new QuestDefinition
        {
            Id = id,
            Name = name,
            Description = description,
            Objectives = objectives.ToList(),
            GiverNpcId = giverNpcId,
            TurnInNpcId = turnInNpcId,
            Hint = hint
        };
    }
}

/// <summary>
/// Definition for a quest objective.
/// </summary>
public class ObjectiveDefinition
{
    public ObjectiveType Type { get; init; }
    public string Description { get; init; } = string.Empty;
    public ObjectiveTarget Target { get; init; }
    public int RequiredCount { get; init; } = 1;
    public bool IsOptional { get; init; }
    public bool IsHidden { get; init; }
    public int Order { get; init; }
}
```

### Player Modifications

```
MODIFY: Player
├── ADD: ActiveQuests: IReadOnlyList<Quest>
├── ADD: CompletedQuests: IReadOnlyList<Quest>
├── ADD: AcceptQuest(Quest quest): bool
├── ADD: CompleteQuest(Guid questId): bool
├── ADD: GetQuest(Guid questId): Quest?
├── ADD: GetActiveQuestCount(): int
└── ADD: HasQuest(string definitionId): bool
```

### Configuration Example

```json
{
  "$schema": "../schemas/quests.schema.json",
  "quests": [
    {
      "id": "goblin-menace",
      "name": "The Goblin Menace",
      "description": "The dungeon entrance is overrun with goblins. Clear them out to make the area safe for other adventurers.",
      "giverNpcId": "guard-captain",
      "turnInNpcId": "guard-captain",
      "hint": "Goblins are commonly found in the upper dungeon levels.",
      "objectives": [
        {
          "type": "Kill",
          "description": "Defeat goblins",
          "target": {
            "targetType": "goblin",
            "displayName": "Goblins",
            "anyOfType": true
          },
          "requiredCount": 5,
          "order": 1
        }
      ]
    },
    {
      "id": "lost-heirloom",
      "name": "The Lost Heirloom",
      "description": "A merchant has lost a family heirloom somewhere in the dungeon. Find and return it.",
      "giverNpcId": "grimbold-trader",
      "objectives": [
        {
          "type": "Collect",
          "description": "Find the Golden Locket",
          "target": {
            "targetId": "item-golden-locket",
            "displayName": "Golden Locket",
            "locationHint": "Last seen in the storage rooms"
          },
          "requiredCount": 1,
          "order": 1
        },
        {
          "type": "Talk",
          "description": "Return the locket to Grimbold",
          "target": {
            "targetId": "grimbold-trader",
            "displayName": "Grimbold"
          },
          "requiredCount": 1,
          "order": 2
        }
      ]
    },
    {
      "id": "dungeon-survey",
      "name": "Mapping the Depths",
      "description": "The Adventurer's Guild needs updated maps. Explore the key areas of the dungeon.",
      "giverNpcId": "guild-cartographer",
      "objectives": [
        {
          "type": "Explore",
          "description": "Visit the Grand Hall",
          "target": {
            "targetId": "room-grand-hall",
            "displayName": "Grand Hall"
          },
          "requiredCount": 1,
          "order": 1
        },
        {
          "type": "Explore",
          "description": "Visit the Underground Lake",
          "target": {
            "targetId": "room-underground-lake",
            "displayName": "Underground Lake"
          },
          "requiredCount": 1,
          "order": 2
        },
        {
          "type": "Explore",
          "description": "Visit the Ancient Library",
          "target": {
            "targetId": "room-ancient-library",
            "displayName": "Ancient Library"
          },
          "requiredCount": 1,
          "order": 3
        }
      ]
    }
  ]
}
```

### Acceptance Criteria

- [ ] Quest entity can be created from QuestDefinition
- [ ] QuestObjective tracks progress toward completion
- [ ] ObjectiveType enum covers Kill, Collect, Explore, Talk
- [ ] QuestStatus transitions correctly (Available → Active → Completed)
- [ ] Quest.AreAllObjectivesComplete() returns correct result
- [ ] Player can hold multiple active quests
- [ ] Quest configuration loads from JSON
- [ ] Objective progress increments correctly
- [ ] Hidden objectives remain hidden until revealed
- [ ] ~25 unit tests pass

---

## v0.3.0b: Quest Journal & Commands

### Overview

Implement the quest journal TUI interface and the `quests`/`journal` command for viewing active and completed quests. This phase provides the player-facing UI for quest management.

### Scope

**In Scope:**
- `QuestService` for quest management
- `quests` / `journal` command
- Quest list display (active/completed)
- Individual quest detail view
- Progress formatting and display
- Quest filtering by status
- `quest <name>` to view specific quest

**Out of Scope:**
- Automatic progress tracking (v0.3.0c)
- Dialogue integration (v0.3.0c)
- Quest acceptance command (v0.3.0c)
- Quest rewards (v0.3.1)

### Key Deliverables

| Type | Count | Details |
|------|-------|---------|
| Services | 1 | `QuestService` |
| Commands | 2 | `quests`/`journal`, `quest <name>` |
| TUI Views | 1 | Quest journal display |
| DTOs | 2 | `QuestSummaryDto`, `QuestDetailDto` |
| Unit Tests | ~25 | Service, display, filtering tests |

### QuestService Interface

```csharp
namespace RuneAndRust.Application.Services;

/// <summary>
/// Manages quest lifecycle and queries.
/// </summary>
public interface IQuestService
{
    /// <summary>
    /// Gets all active quests for a player.
    /// </summary>
    IEnumerable<Quest> GetActiveQuests(Guid playerId);

    /// <summary>
    /// Gets all completed quests for a player.
    /// </summary>
    IEnumerable<Quest> GetCompletedQuests(Guid playerId);

    /// <summary>
    /// Gets a specific quest by ID.
    /// </summary>
    Quest? GetQuest(Guid playerId, Guid questId);

    /// <summary>
    /// Gets a quest by definition ID.
    /// </summary>
    Quest? GetQuestByDefinition(Guid playerId, string definitionId);

    /// <summary>
    /// Searches quests by name.
    /// </summary>
    Quest? FindQuestByName(Guid playerId, string name);

    /// <summary>
    /// Creates a quest from a definition.
    /// </summary>
    Quest CreateQuest(string definitionId, Guid playerId, string? giverNpcId = null);

    /// <summary>
    /// Accepts a quest for a player.
    /// </summary>
    bool AcceptQuest(Guid playerId, Guid questId);

    /// <summary>
    /// Completes a quest for a player.
    /// </summary>
    bool CompleteQuest(Guid playerId, Guid questId);

    /// <summary>
    /// Gets quests ready for turn-in.
    /// </summary>
    IEnumerable<Quest> GetCompletableQuests(Guid playerId);

    /// <summary>
    /// Gets quest count summary for a player.
    /// </summary>
    QuestCountSummary GetQuestCounts(Guid playerId);

    /// <summary>
    /// Checks if player has a specific quest active.
    /// </summary>
    bool HasActiveQuest(Guid playerId, string definitionId);
}

/// <summary>
/// Summary of quest counts.
/// </summary>
public readonly record struct QuestCountSummary
{
    public int Active { get; init; }
    public int Completed { get; init; }
    public int ReadyToTurnIn { get; init; }
}
```

### Quest Journal TUI

```
┌─────────────────────────────────────────────────────────────┐
│                       QUEST JOURNAL                         │
├─────────────────────────────────────────────────────────────┤
│  Active Quests: 3                    Completed: 7           │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  ACTIVE QUESTS                                              │
│  ─────────────────────────────────────────────────────────  │
│                                                             │
│  [1] The Goblin Menace                              60%     │
│      Defeat goblins (3/5)                                   │
│                                                             │
│  [2] The Lost Heirloom                      [READY] 100%    │
│      ✓ Find the Golden Locket (1/1)                         │
│      • Return the locket to Grimbold (0/1)                  │
│                                                             │
│  [3] Mapping the Depths                             33%     │
│      ✓ Visit the Grand Hall (1/1)                           │
│      • Visit the Underground Lake (0/1)                     │
│      • Visit the Ancient Library (0/1)                      │
│                                                             │
├─────────────────────────────────────────────────────────────┤
│  Commands: [#] View details  [c]ompleted  [q]uit            │
└─────────────────────────────────────────────────────────────┘
```

### Quest Detail View

```
┌─────────────────────────────────────────────────────────────┐
│                    THE GOBLIN MENACE                        │
├─────────────────────────────────────────────────────────────┤
│  Status: Active                      Progress: 60%          │
│  Given by: Guard Captain                                    │
│  Turn in to: Guard Captain                                  │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  The dungeon entrance is overrun with goblins. Clear them   │
│  out to make the area safe for other adventurers.           │
│                                                             │
├─────────────────────────────────────────────────────────────┤
│  OBJECTIVES                                                 │
│  ─────────────────────────────────────────────────────────  │
│                                                             │
│  • Defeat goblins                                  (3/5)    │
│    ████████████░░░░░░░░ 60%                                 │
│                                                             │
├─────────────────────────────────────────────────────────────┤
│  HINT                                                       │
│  Goblins are commonly found in the upper dungeon levels.    │
│                                                             │
├─────────────────────────────────────────────────────────────┤
│  [b]ack to journal                                          │
└─────────────────────────────────────────────────────────────┘
```

### User-Facing Changes

**Commands:**
```
> quests                  # Open quest journal
> journal                 # Alias for quests
> quest goblin            # View quest matching "goblin"
> quest 1                 # View quest #1 from list
```

**Output Example:**
```
> quests
=== QUEST JOURNAL ===

Active Quests (3):

[1] The Goblin Menace (60%)
    • Defeat goblins (3/5)

[2] The Lost Heirloom [READY TO TURN IN]
    ✓ Find the Golden Locket
    • Return the locket to Grimbold

[3] Mapping the Depths (33%)
    ✓ Visit the Grand Hall
    • Visit the Underground Lake
    • Visit the Ancient Library

Type 'quest <number>' to view details.
Type 'quests completed' to view completed quests.

---

> quest 1
=== THE GOBLIN MENACE ===
Status: Active (60% complete)
Given by: Guard Captain

The dungeon entrance is overrun with goblins. Clear them out
to make the area safe for other adventurers.

Objectives:
  • Defeat goblins (3/5)

Hint: Goblins are commonly found in the upper dungeon levels.
```

### Acceptance Criteria

- [ ] QuestService provides quest queries
- [ ] `quests` command displays active quests
- [ ] `journal` alias works identically
- [ ] Progress percentages display correctly
- [ ] Completed objectives show checkmarks
- [ ] Ready-to-turn-in quests are marked
- [ ] `quest <name>` shows specific quest
- [ ] Completed quests can be viewed
- [ ] Quest hints display in detail view
- [ ] ~25 unit tests pass

---

## v0.3.0c: Progress Tracking & Integration

### Overview

Implement the event-driven progress tracking system that automatically updates quest objectives when players defeat monsters, collect items, explore rooms, or talk to NPCs. This phase also adds dialogue integration for accepting quests.

### Scope

**In Scope:**
- `QuestProgressService` for event handling
- Kill objective tracking (monster defeats)
- Collect objective tracking (item pickups)
- Explore objective tracking (room entries)
- Talk objective tracking (dialogue completion)
- Quest acceptance via dialogue
- `StartQuest` dialogue outcome type
- Automatic quest completion notification
- Progress notifications to player

**Out of Scope:**
- Quest rewards (v0.3.1)
- Quest prerequisites (v0.3.1)
- Quest chains (v0.3.2)
- Time limits (v0.3.2)
- Failure conditions (v0.3.2)

### Key Deliverables

| Type | Count | Details |
|------|-------|---------|
| Services | 1 | `QuestProgressService` |
| Event Handlers | 4 | Kill, Collect, Explore, Talk |
| Dialogue Updates | 1 | `StartQuest` outcome |
| Notifications | 2 | Progress, Completion |
| Unit Tests | ~25 | Progress tracking, event tests |

### QuestProgressService Interface

```csharp
namespace RuneAndRust.Application.Services;

/// <summary>
/// Tracks quest progress from game events.
/// </summary>
public interface IQuestProgressService
{
    /// <summary>
    /// Processes a monster defeat for quest progress.
    /// </summary>
    QuestProgressResult ProcessMonsterDefeated(Guid playerId, string monsterId, string? monsterType);

    /// <summary>
    /// Processes an item pickup for quest progress.
    /// </summary>
    QuestProgressResult ProcessItemCollected(Guid playerId, string itemId);

    /// <summary>
    /// Processes room entry for quest progress.
    /// </summary>
    QuestProgressResult ProcessRoomEntered(Guid playerId, string roomId);

    /// <summary>
    /// Processes NPC dialogue completion for quest progress.
    /// </summary>
    QuestProgressResult ProcessNpcTalked(Guid playerId, string npcId);

    /// <summary>
    /// Processes item delivery to NPC.
    /// </summary>
    QuestProgressResult ProcessItemDelivered(Guid playerId, string npcId, string itemId);

    /// <summary>
    /// Manually updates objective progress.
    /// </summary>
    QuestProgressResult UpdateObjective(Guid playerId, Guid questId, Guid objectiveId, int progress);
}
```

### QuestProgressResult Value Object

```csharp
namespace RuneAndRust.Domain.ValueObjects;

/// <summary>
/// Result of processing a quest progress event.
/// </summary>
public readonly record struct QuestProgressResult
{
    /// <summary>
    /// Gets whether any progress was made.
    /// </summary>
    public bool HasProgress { get; init; }

    /// <summary>
    /// Gets objectives that were updated.
    /// </summary>
    public IReadOnlyList<ObjectiveProgressUpdate> UpdatedObjectives { get; init; }

    /// <summary>
    /// Gets quests that are now completable.
    /// </summary>
    public IReadOnlyList<Quest> CompletableQuests { get; init; }

    /// <summary>
    /// Gets quests that were auto-completed.
    /// </summary>
    public IReadOnlyList<Quest> CompletedQuests { get; init; }

    /// <summary>
    /// Creates an empty result.
    /// </summary>
    public static QuestProgressResult None => new()
    {
        HasProgress = false,
        UpdatedObjectives = Array.Empty<ObjectiveProgressUpdate>(),
        CompletableQuests = Array.Empty<Quest>(),
        CompletedQuests = Array.Empty<Quest>()
    };
}

/// <summary>
/// Details of an objective progress update.
/// </summary>
public readonly record struct ObjectiveProgressUpdate
{
    public Quest Quest { get; init; }
    public QuestObjective Objective { get; init; }
    public int PreviousCount { get; init; }
    public int NewCount { get; init; }
    public bool JustCompleted { get; init; }
}
```

### DialogueOutcome Update

```csharp
// Add to OutcomeType enum
/// <summary>Starts a quest for the player.</summary>
StartQuest,

// In DialogueOutcome processing
case OutcomeType.StartQuest:
    var questDef = TargetId; // Quest definition ID
    var quest = _questService.CreateQuest(questDef, playerId, npcId);
    _questService.AcceptQuest(playerId, quest.Id);
    break;
```

### Event Integration

```csharp
// In CombatService after monster defeat
public void OnMonsterDefeated(Monster monster, Player player)
{
    // Existing defeat logic...

    // Quest progress
    var progress = _questProgressService.ProcessMonsterDefeated(
        player.Id,
        monster.DefinitionId,
        monster.Type);

    if (progress.HasProgress)
    {
        foreach (var update in progress.UpdatedObjectives)
        {
            _logger.LogInformation(
                "Quest progress: {Quest} - {Objective} ({Current}/{Required})",
                update.Quest.Name,
                update.Objective.Description,
                update.NewCount,
                update.Objective.RequiredCount);
        }
    }
}

// In Room entry
public void OnRoomEntered(Room room, Player player)
{
    // Existing room logic...

    // Quest progress
    var progress = _questProgressService.ProcessRoomEntered(
        player.Id,
        room.Id.ToString());
}

// In Inventory when item added
public void OnItemCollected(Item item, Player player)
{
    // Existing pickup logic...

    // Quest progress
    var progress = _questProgressService.ProcessItemCollected(
        player.Id,
        item.DefinitionId);
}
```

### User-Facing Changes

**Quest Acceptance:**
```
> talk guard
The Guard Captain looks you over. "You look capable enough.
We have a goblin problem that needs dealing with."

[1] Tell me about the goblin problem.
[2] I'll handle it. [Accept Quest: The Goblin Menace]
[3] Not interested right now.

> 2
You accept the quest: The Goblin Menace

=== NEW QUEST ===
The Goblin Menace
Defeat goblins (0/5)
```

**Progress Notifications:**
```
=== COMBAT VICTORY ===
You defeated the Goblin!
Experience gained: 15 XP

[QUEST] The Goblin Menace: Defeat goblins (4/5)

---

You defeated the Goblin!
Experience gained: 15 XP

[QUEST] The Goblin Menace: Defeat goblins (5/5) - COMPLETE!
[QUEST] The Goblin Menace is ready to turn in!
```

**Quest Completion:**
```
> talk guard
The Guard Captain nods approvingly. "I see you've dealt with those
goblins. Well done, adventurer."

[1] [Turn In Quest: The Goblin Menace]
[2] Just passing through.

> 1
You complete the quest: The Goblin Menace!
[Quest rewards will be implemented in v0.3.1]
```

### Acceptance Criteria

- [ ] Monster defeats update Kill objectives
- [ ] Item pickups update Collect objectives
- [ ] Room entries update Explore objectives
- [ ] NPC dialogue updates Talk objectives
- [ ] Progress notifications display to player
- [ ] Quests can be accepted via dialogue
- [ ] StartQuest dialogue outcome works
- [ ] Completed objectives trigger quest completion check
- [ ] Ready-to-turn-in quests can be turned in
- [ ] ~25 unit tests pass

---

## Dependencies & Prerequisites

```
v0.2.2 (Merchant System) - REQUIRED
    │
    ├── NPC entity ─────────────────────┐
    ├── DialogueOutcome ────────────────┤
    ├── Player entity ──────────────────┤
    └── Item entity ────────────────────┘
                                        │
                                        ▼
v0.3.0 (Quest Foundation)
    │
    ├── v0.3.0a: Quest Entity & Objectives ─────────┐
    │       Dependencies: Player, IConfigurationProvider
    │                                               │
    ├── v0.3.0b: Quest Journal & Commands ──────────┤
    │       Dependencies: v0.3.0a, IGameRenderer    │
    │                                               │
    └── v0.3.0c: Progress Tracking & Integration ───┘
            Dependencies: v0.3.0a, v0.3.0b
                          Combat, Room, Item systems
                          DialogueService
```

---

## Estimated Effort Summary

| Phase | New Files | Modified Files | Est. Tests | Complexity |
|-------|-----------|----------------|------------|------------|
| v0.3.0a | ~8 | ~2 | ~25 | Medium |
| v0.3.0b | ~5 | ~3 | ~25 | Medium |
| v0.3.0c | ~4 | ~6 | ~25 | High |
| **Total** | **~17** | **~11** | **~75** | |

---

## Risk Assessment

| Risk | Impact | Probability | Mitigation |
|------|--------|-------------|------------|
| Event integration complexity | High | Medium | Clear event contracts, thorough testing |
| Progress tracking edge cases | Medium | Medium | Comprehensive test coverage |
| UI complexity for journal | Medium | Low | Iterative UI development |
| Dialogue integration issues | Medium | Low | Reuse existing dialogue system |
| Performance with many quests | Low | Low | Efficient queries, lazy loading |

---

## Design Decisions (Confirmed)

### Quest Architecture

| Decision | Value | Notes |
|----------|-------|-------|
| **Quest Storage** | Per-player instances | Each player has own quest progress |
| **Objective Types** | 7 types | Kill, Collect, Explore, Talk, Deliver, Use, Custom |
| **Progress Tracking** | Event-driven | Game events trigger updates |
| **Status Flow** | Available → Active → Completed/Failed | Linear progression |

### Progress System

| Decision | Value | Notes |
|----------|-------|-------|
| **Update Trigger** | Automatic on events | No manual tracking needed |
| **Notification** | On each update | Player sees progress immediately |
| **Completion** | Manual turn-in | Requires talking to NPC |
| **Target Matching** | ID or Type | Support "any goblin" vs specific |

### Journal Display

| Decision | Value | Notes |
|----------|-------|-------|
| **Default View** | Active quests | Most relevant to player |
| **Sorting** | By progress % | Ready-to-complete first |
| **Progress Format** | (X/Y) with bar | Clear visual feedback |

---

## Integration Points

### From v0.2.x
- NPC entity for quest givers
- DialogueOutcome for quest acceptance
- Player entity for quest ownership
- Item entity for collect objectives

### To v0.3.1 (Quest Rewards)
- Quest entity ready for reward attachment
- Completion flow ready for reward distribution
- Turn-in dialogue ready for reward display

### To v0.3.2 (Quest Chains)
- Quest entity ready for chain linking
- QuestService ready for chain queries
- Status tracking ready for chain progression

---

## Next Steps

1. **Review & Approve** - Confirm scope breakdown
2. **v0.3.0a Design Spec** - Create detailed design specification
3. **Implement v0.3.0a** - Build quest entities
4. **v0.3.0b Design Spec** - Journal and commands
5. **Implement v0.3.0b** - Build journal UI
6. **Implement v0.3.0c** - Build progress tracking

---

*This scope breakdown provides a structured approach to implementing v0.3.0 Quest Foundation. Each sub-phase builds on the previous, allowing for incremental development and testing while establishing the core quest infrastructure.*
