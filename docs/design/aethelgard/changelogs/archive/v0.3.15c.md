> **Archived** - This changelog has been consolidated. See the complete version at [v0.3.15](../v0.3.x/v0.3.15.md).

# Changelog: v0.3.15c - The Polyglot

**Release Date:** 2025-12-24

## Summary

Version 0.3.15c completes the **Localization System** trilogy by bridging backend infrastructure to the user interface. This release adds a Language selector in the Options menu with live preview functionality and introduces Pseudo-Localization (`qps-ploc`) for QA testing. The PseudoLocalizer helper transforms English strings with diacritics and ~30% text expansion to identify hardcoded strings and UI layout issues without requiring actual translations.

**Layers Touched:**
- **Core Layer:** `ILocalizationService` interface extended with `GetAvailableLocales()` method; `OptionsViewModel` extended with `Language` property; `LocKeys` extended with `UI_Options_Setting_Language` constant
- **Engine Layer:** `LocalizationService` implements `GetAvailableLocales()` with automatic `qps-ploc` inclusion and pseudo-localization support in `Get()` and `LoadLocaleAsync()`; new `PseudoLocalizer` static helper for diacritic mapping and text expansion
- **Terminal Layer:** `OptionsController` adds Language setting to Display tab with live locale switching; `OptionsViewHelperService` converted from static class to instance service with `ILocalizationService` injection, adds `GetLanguageDisplayName()` and `CycleLanguage()` methods
- **Data Layer:** `en-US.json` updated to version 0.3.15c with `Settings.Language` entry
- **Test Layer:** 16 new `PseudoLocalizerTests` + 5 new `LocalizationServiceTests` validating pseudo-locale behavior, GetAvailableLocales() sorting, and transform correctness

**Patterns Implemented:**
- **Pseudo-Localization Pattern:** Transform strings with diacritics (`a`→`á`) + bracket boundaries (`[...]`) + ~30% expansion (`_`-padding) for QA testing; preserves format placeholders `{0}`, `{1:N2}` unchanged
- **Runtime Locale Switching Pattern:** `OptionsController.ModifyEnumValue()` calls `LoadLocaleAsync()` synchronously via `.GetAwaiter().GetResult()` for immediate UI refresh without modal exit
- **Locale Discovery Pattern:** `GetAvailableLocales()` scans `data/locales/*.json` and always includes `qps-ploc` pseudo-locale regardless of file existence
- **Dependency Injection Refactor:** `OptionsViewHelperService` changed from static utility class to constructor-injected service for `ILocalizationService` access

**Key Metrics:**
- 2 new files created (PseudoLocalizer helper + tests)
- 8 files modified (1 interface, 2 Core constants/viewmodels, 2 Engine services, 2 Terminal services, 1 locale data file)
- 21 new unit tests (16 PseudoLocalizer + 5 LocalizationService pseudo-locale tests)
- Total localization test suite: 46 tests (20 LocalizationService + 16 PseudoLocalizer + 7 LocKeys + integration tests)
- 100% test pass rate (0 failures, 0 skipped, 76ms duration)
- 0 regressions in existing tests

---

## New Files Created

### Engine Layer

| File | Purpose |
|------|---------|
| `RuneAndRust.Engine/Helpers/PseudoLocalizer.cs` | Static helper class for transforming strings into pseudo-localized versions. Applies diacritics to vowels/consonants (`a`→`á`, `n`→`ñ`), preserves format placeholders (`{0}`, `{1:N2}`), adds bracket boundaries for visual identification, and appends ~30% text expansion via underscores to simulate translated text length. Used by LocalizationService when `CurrentLocale == "qps-ploc"`. |

### Test Layer

| File | Purpose |
|------|---------|
| `RuneAndRust.Tests/Engine/PseudoLocalizerTests.cs` | Unit tests for PseudoLocalizer helper. 16 tests across 4 regions: Basic Tests (null/empty handling, bracket boundaries, expansion presence), Diacritic Transformation Tests (14 Theory tests for vowel/consonant mapping, unmapped character preservation), Format Placeholder Preservation Tests (simple/formatted/multiple placeholders), Expansion Tests (~30% length verification). Validates transform correctness, placeholder safety, and QA testing requirements. |

---

## Files Modified

| File | Change |
|------|--------|
| `RuneAndRust.Core/Interfaces/ILocalizationService.cs` | **Added GetAvailableLocales() Method (Lines 58-63):** New method signature returning `IReadOnlyList<string>` of installed locale codes. XML documentation notes automatic inclusion of `qps-ploc` pseudo-locale (v0.3.15c) and sorted return order. Returns locale codes like `["en-US", "qps-ploc"]` based on JSON files in `data/locales/` directory. |
| `RuneAndRust.Engine/Services/LocalizationService.cs` | **Added Using Directive (Line 5):** `using RuneAndRust.Engine.Helpers;` for PseudoLocalizer access. **Enhanced LoadLocaleAsync() with Pseudo-Locale Support (Lines 42-52):** Added early-exit branch for `qps-ploc`: clears `_strings` dictionary, loads en-US into `_fallbackStrings`, sets `CurrentLocale = "qps-ploc"`, logs "Pseudo-localization enabled", returns true. Pseudo-locale does not require JSON file; uses fallback dictionary as transformation source. **Enhanced Get() with Pseudo-Localization (Lines 133-141):** Added early-exit branch when `CurrentLocale == "qps-ploc"`: attempts `_fallbackStrings.TryGetValue()` for en-US source string, transforms via `PseudoLocalizer.Transform()`, returns transformed string; if key missing from fallback, transforms key itself. Ensures all UI strings display in pseudo-localized form for QA testing. **Implemented GetAvailableLocales() Method (Lines 193-213):** Scans `_localesPath` directory for `*.json` files using `Directory.GetFiles()`, extracts filenames via `Path.GetFileNameWithoutExtension()`, adds to list. Always appends `qps-ploc` if not already present (Line 206-207). Sorts list alphabetically (Line 210). Logs debug message with locale count (Line 211). Returns `IReadOnlyList<string>`. |
| `RuneAndRust.Core/Constants/LocKeys.cs` | **Added Language Setting Key (Lines 110-111):** New constant `UI_Options_Setting_Language = "UI.Options.Settings.Language"` with XML summary "Language setting label (v0.3.15c)". Located in `#region UI.Options.Settings` between `MasterVolume` and region end marker. Used by OptionsController to display "Language" label in Display tab. |
| `RuneAndRust.Core/ViewModels/OptionsViewModel.cs` | **Updated Class Documentation (Line 6):** Changed summary to include "extended v0.3.15c" annotation. **Added Language Property (Lines 59-63):** New property `public string Language { get; set; } = "en-US"` with XML summary documenting default value, purpose (current language/locale code), example values (`"en-US"`, `"qps-ploc"`), and version tag (v0.3.15c - The Polyglot). Binds to Language setting in Display tab. |
| `RuneAndRust.Terminal/Services/OptionsController.cs` | **Updated Class Documentation (Line 12):** Changed summary to reference v0.3.15c. **Updated Constructor (Lines 33-35, 39-41):** Added `ILocalizationService localizationService` parameter, assigned to `_loc` field. Updated XML param documentation to note localization service usage. **Enhanced CreateViewModelFromSettings() (Line 134):** Added `Language = GameSettings.Language` to ViewModel instantiation for initial state sync. **Enhanced RefreshItems() Display Tab Section (Lines 212-218):** Added Language setting as second item (index 1) in Display tab. SettingItemView created with: `Name` from `LocKeys.UI_Options_Setting_Language`, `ValueDisplay` from `_viewHelper.GetLanguageDisplayName(vm.Language)`, `Type` as `SettingType.Enum`, `PropertyName` as `"Language"`. Positioned between Theme and ReduceMotion settings for logical grouping. **Enhanced ModifyEnumValue() (Lines 379-386):** Added "Language" case in switch statement. Retrieves available locales via `_loc.GetAvailableLocales()`, cycles to next/previous locale via `_viewHelper.CycleLanguage()`, **immediately reloads locale** via `_loc.LoadLocaleAsync(vm.Language).GetAwaiter().GetResult()` for live preview without Options exit, logs debug message with new language display name. Synchronous reload required for immediate UI refresh in modal loop. **Enhanced ResetToDefaultsAsync() (Lines 517, 520):** Added `vm.Language = GameSettings.Language` to ViewModel refresh (Line 517). Added `await _loc.LoadLocaleAsync(vm.Language)` to reload en-US locale after reset (Line 520) with comment "v0.3.15c". **Enhanced ApplyToGameSettings() (Line 536):** Added `GameSettings.Language = vm.Language` to static settings sync. |
| `RuneAndRust.Terminal/Rendering/OptionsViewHelperService.cs` | **Converted from Static to Instance Service (Lines 8-24):** Removed `static` keyword from class declaration. Added `private readonly ILocalizationService _loc` field (Line 15). Added constructor accepting `ILocalizationService localizationService` parameter (Line 21) with XML documentation. Changed all localization lookups from hardcoded strings to `_loc.Get(LocKeys.*)` calls throughout existing methods (`FormatToggle`, `GetThemeName`, `GetTabDisplayName`, `FormatSliderValue`, `GetCommandDisplayName`, `GetCommandCategory`, `FormatKeyName`). **Added GetLanguageDisplayName() Method (Lines 194-206):** New method accepting `string locale` parameter, returning human-readable name. Switch expression maps: `"en-US"` → `"English (US)"`, `"qps-ploc"` → `"[Pseudo-Loc]"`, default → locale code. Square brackets in pseudo-locale name indicate non-production testing locale. **Added CycleLanguage() Method (Lines 208-222):** New method accepting `string current`, `int direction`, `IReadOnlyList<string> available` parameters. Finds current locale index in available list (defaults to 0 if not found), calculates new index with wraparound: `(index + direction + available.Count) % available.Count`, returns locale at new index. Supports bidirectional cycling (direction +1 for next, -1 for previous). |
| `data/locales/en-US.json` | **Updated Meta Version (Line 4):** Changed `"version"` from `"0.3.15b"` to `"0.3.15c"`. **Added Language Setting Entry (Line 43):** Added `"Language": "Language"` to `UI.Options.Settings` object between `MasterVolume` and closing brace. Provides localized label for Language selector in Options > Display tab. |
| `RuneAndRust.Tests/Engine/LocalizationServiceTests.cs` | **Added Pseudo-Localization Tests Region (Lines 232-311):** New region with 5 tests. **GetAvailableLocales_AlwaysIncludesPseudoLocale (Lines 234-244):** Asserts `GetAvailableLocales()` always returns list containing `"qps-ploc"` even with no locale files loaded. **LoadLocaleAsync_SetsPseudoLocale_WithoutFile (Lines 246-262):** Loads `qps-ploc` locale (skips if en-US.json missing), asserts `result.Should().BeTrue()` and `CurrentLocale.Should().Be("qps-ploc")`. Validates pseudo-locale activation without corresponding JSON file. **Get_ReturnsTransformedString_WhenPseudoLocaleActive (Lines 264-282):** Loads `qps-ploc`, retrieves `UI_MainMenu_NewGame` key, asserts result starts with `[`, ends with `]`, contains `_` for expansion. Validates PseudoLocalizer integration in Get() method. **GetAvailableLocales_IncludesInstalledLocales (Lines 284-299):** Asserts `GetAvailableLocales()` includes `"en-US"` when locale file exists in test output. Validates filesystem scanning. **GetAvailableLocales_ReturnsSortedList (Lines 301-309):** Asserts `GetAvailableLocales()` returns alphabetically sorted list via `Should().BeInAscendingOrder()`. Validates sorting requirement. |

---

## Code Implementation Details

### PseudoLocalizer.Transform() Method

**Location:** `RuneAndRust.Engine/Helpers/PseudoLocalizer.cs:35-69`

**Signature:**
```csharp
public static string Transform(string input)
```

**Behavior:**
1. **Null/Empty Handling:** Returns input unchanged if `string.IsNullOrEmpty(input)` (Lines 37-38)
2. **Bracket Wrapping:** Initializes StringBuilder with opening `[` bracket (Line 41)
3. **Character-by-Character Processing:** Iterates through input string (Lines 43-60)
   - **Format Placeholder Preservation:** Detects `{` character, searches for closing `}` via `IndexOf()`, copies entire placeholder unchanged (e.g., `{0}`, `{1:N2}`, `{name}`), advances index past placeholder (Lines 46-56)
   - **Diacritic Mapping:** For non-placeholder characters, checks `DiacriticMap` dictionary via `TryGetValue()`, substitutes mapped character if found, preserves original character otherwise (Lines 58-59)
4. **Text Expansion:** Calculates expansion length as `Math.Max(1, (int)(input.Length * 0.3))`, appends underscores (`_`) to simulate 30% text growth common in translations (Lines 63-64)
5. **Closing Bracket:** Appends `]` (Line 65)
6. **Return:** Returns transformed string (Line 67)

**Diacritic Mapping Table:**
| Original | Transformed | Original | Transformed |
|----------|-------------|----------|-------------|
| a | á | A | Á |
| e | é | E | É |
| i | í | I | Í |
| o | ó | O | Ó |
| u | ú | U | Ú |
| c | ç | C | Ç |
| n | ñ | N | Ñ |

**Transform Examples:**
- `"New Game"` → `"[Ñéw Gámé__]"` (8 chars → 13 chars with brackets/expansion)
- `"{0} min"` → `"[{0} míñ_]"` (placeholder preserved, expansion added)
- `"Value: {0}%"` → `"[Válúé: {0}%___]"` (text transformed, placeholder/symbol preserved)
- `""` → `""` (empty string unchanged)
- `null` → `null` (null passthrough)

**Design Rationale:**
- **Visual Boundaries:** Brackets make pseudo-localized text instantly recognizable in UI
- **Length Testing:** 30% expansion matches average German/Russian translation expansion; helps identify truncation issues
- **Non-ASCII Testing:** Diacritics validate character encoding handling (UTF-8 correctness)
- **Format Safety:** Placeholder preservation prevents runtime FormatException in string.Format() calls
- **QA Utility:** Immediately reveals hardcoded strings that bypass localization service

---

### LocalizationService Pseudo-Locale Implementation

**Location:** `RuneAndRust.Engine/Services/LocalizationService.cs`

#### LoadLocaleAsync() Pseudo-Locale Branch (Lines 42-52)

```csharp
// Handle pseudo-locale specially (v0.3.15c - The Polyglot)
if (locale == "qps-ploc")
{
    _strings.Clear();
    await LoadSingleLocaleAsync(DefaultLocale, isPrimary: false);
    CurrentLocale = "qps-ploc";
    _logger.LogInformation("[Localization] Pseudo-localization enabled");
    return true;
}
```

**Behavior:**
- Clears primary `_strings` dictionary to prevent key lookups
- Loads `en-US` into `_fallbackStrings` as transformation source
- Sets `CurrentLocale` to `"qps-ploc"` to activate transform mode
- Logs Information-level message (not Debug) for QA visibility
- Returns `true` (always succeeds; no file required)

**Design Rationale:** Pseudo-locale uses en-US as source material to avoid maintaining duplicate qps-ploc.json file

---

#### Get() Pseudo-Localization Transform (Lines 133-141)

```csharp
// Handle pseudo-localization (v0.3.15c - The Polyglot)
if (CurrentLocale == "qps-ploc")
{
    if (_fallbackStrings.TryGetValue(key, out var fallbackValue))
        return PseudoLocalizer.Transform(fallbackValue);
    return PseudoLocalizer.Transform(key);
}
```

**Behavior:**
- Checks if `CurrentLocale == "qps-ploc"` before normal lookup
- Attempts to retrieve key from `_fallbackStrings` (en-US)
- Transforms retrieved value via `PseudoLocalizer.Transform()`
- If key missing from fallback, transforms key itself (maintains debug visibility)
- Returns transformed result

**Call Chain Example:**
```
Get("UI.MainMenu.NewGame")
  → CurrentLocale check: "qps-ploc" → true
  → _fallbackStrings.TryGetValue("UI.MainMenu.NewGame") → "New Game"
  → PseudoLocalizer.Transform("New Game") → "[Ñéw Gámé__]"
  → return "[Ñéw Gámé__]"
```

---

#### GetAvailableLocales() Implementation (Lines 193-213)

```csharp
public IReadOnlyList<string> GetAvailableLocales()
{
    var locales = new List<string>();

    if (Directory.Exists(_localesPath))
    {
        foreach (var file in Directory.GetFiles(_localesPath, "*.json"))
        {
            locales.Add(Path.GetFileNameWithoutExtension(file));
        }
    }

    // Always include pseudo-locale for testing (v0.3.15c)
    if (!locales.Contains("qps-ploc"))
        locales.Add("qps-ploc");

    locales.Sort();
    _logger.LogDebug("[Localization] Found {Count} available locales", locales.Count);
    return locales;
}
```

**Behavior:**
1. **Directory Scan:** Checks if `data/locales/` exists via `Directory.Exists()`
2. **File Enumeration:** Iterates `*.json` files via `Directory.GetFiles()` glob pattern
3. **Name Extraction:** Extracts locale code from filename (e.g., `en-US.json` → `en-US`)
4. **Pseudo-Locale Injection:** Ensures `qps-ploc` present even if no corresponding file exists
5. **Alphabetical Sort:** Sorts list via `List<string>.Sort()` (ascending ASCII order)
6. **Debug Log:** Logs locale count for diagnostic purposes
7. **Immutable Return:** Returns `IReadOnlyList<string>` to prevent external modification

**Example Return Values:**
- No locale files + pseudo-locale: `["qps-ploc"]`
- en-US.json only: `["en-US", "qps-ploc"]`
- en-US.json + de-DE.json: `["de-DE", "en-US", "qps-ploc"]` (sorted)

**Design Rationale:** Always-present `qps-ploc` ensures QA testing available in all environments without file deployment

---

### OptionsController Language Integration

**Location:** `RuneAndRust.Terminal/Services/OptionsController.cs`

#### Language Setting in Display Tab (Lines 212-218)

**RefreshItems() Addition:**
```csharp
vm.CurrentItems.Add(new SettingItemView(
    Name: _loc.Get(LocKeys.UI_Options_Setting_Language),
    ValueDisplay: _viewHelper.GetLanguageDisplayName(vm.Language),
    Type: SettingType.Enum,
    IsSelected: index++ == vm.SelectedIndex,
    PropertyName: "Language"
));
```

**Positioning:** Second setting in Display tab (between Theme and ReduceMotion)

**Display Example:**
```
Language                  English (US)   ← → ←
```

---

#### Live Locale Switching (Lines 379-386)

**ModifyEnumValue() Language Case:**
```csharp
case "Language":
    var availableLocales = _loc.GetAvailableLocales();
    vm.Language = _viewHelper.CycleLanguage(vm.Language, direction, availableLocales);
    // Reload locale immediately for live preview (v0.3.15c)
    _loc.LoadLocaleAsync(vm.Language).GetAwaiter().GetResult();
    _logger.LogDebug("[Options] Language changed to {Value}", _viewHelper.GetLanguageDisplayName(vm.Language));
    break;
```

**Behavior:**
1. Retrieves available locale list from `GetAvailableLocales()`
2. Cycles to next/previous locale via `CycleLanguage()` helper
3. **Synchronously reloads locale** via `.GetAwaiter().GetResult()` pattern
4. Logs debug message with human-readable language name
5. Returns to modal loop; next `_renderer.Render(vm)` call displays all UI strings in new locale

**Live Preview Example:**
```
User presses → on Language setting:
  en-US → GetAvailableLocales() → ["en-US", "qps-ploc"]
  → CycleLanguage("en-US", +1, [...]) → "qps-ploc"
  → LoadLocaleAsync("qps-ploc") completes synchronously
  → RefreshItems(vm) called
  → _renderer.Render(vm) displays:
      [Láñgúágé_____]              [[Pséúdó-Lóç]___]   ← → ←
```

**Design Rationale:** Synchronous reload required because Options screen is modal loop; async/await would require state machine refactor. GetAwaiter().GetResult() pattern safe here (no UI thread deadlock risk in terminal app).

---

### OptionsViewHelperService Localization Integration

**Location:** `RuneAndRust.Terminal/Rendering/OptionsViewHelperService.cs`

#### Dependency Injection Refactor (Lines 13-24)

**Before (Static):**
```csharp
public static class OptionsViewHelperService
{
    public static string FormatToggle(bool value)
        => value ? "[green]ON[/]" : "[grey]OFF[/]";
}
```

**After (Injected):**
```csharp
public class OptionsViewHelperService
{
    private readonly ILocalizationService _loc;

    public OptionsViewHelperService(ILocalizationService localizationService)
    {
        _loc = localizationService;
    }

    public string FormatToggle(bool value)
        => value
            ? $"[green]{_loc.Get(LocKeys.UI_Options_Toggle_On)}[/]"
            : $"[grey]{_loc.Get(LocKeys.UI_Options_Toggle_Off)}[/]";
}
```

**Behavior Change:**
- Static methods → Instance methods requiring DI registration
- Hardcoded strings (`"ON"`, `"OFF"`) → Localized lookups (`_loc.Get(LocKeys.*)`)
- Enables Options screen to display in any loaded locale

**DI Registration Required:** Must add `services.AddSingleton<OptionsViewHelperService>();` in `App.axaml.cs` or `Program.cs`

---

#### Language Display Names (Lines 194-206)

```csharp
public string GetLanguageDisplayName(string locale)
    => locale switch
    {
        "en-US" => "English (US)",
        "qps-ploc" => "[Pseudo-Loc]",
        _ => locale
    };
```

**Behavior:**
- Maps locale codes to human-readable names
- Pseudo-locale displays with brackets to indicate non-production status
- Default case returns locale code as-is for unknown locales (future-proof)

**Example Mappings:**
- `"en-US"` → `"English (US)"`
- `"qps-ploc"` → `"[Pseudo-Loc]"`
- `"fr-FR"` → `"fr-FR"` (fallback to code if not explicitly mapped)

**Design Note:** Currently not localized (displays same regardless of active locale); future enhancement could load language names from locale files themselves.

---

#### Language Cycling Logic (Lines 208-222)

```csharp
public string CycleLanguage(string current, int direction, IReadOnlyList<string> available)
{
    var index = available.ToList().IndexOf(current);
    if (index < 0) index = 0;

    var newIndex = (index + direction + available.Count) % available.Count;
    return available[newIndex];
}
```

**Behavior:**
- Finds current locale index in available list (-1 if not found)
- Defaults to index 0 if current locale not in list (safety fallback)
- Calculates new index with wraparound: `(index + direction + count) % count`
- Returns locale at new index

**Wraparound Examples:**
```
Available: ["de-DE", "en-US", "qps-ploc"]  (3 locales)

Current: "en-US" (index 1), Direction: +1
  → (1 + 1 + 3) % 3 = 2 → "qps-ploc"

Current: "qps-ploc" (index 2), Direction: +1
  → (2 + 1 + 3) % 3 = 0 → "de-DE"  (wraps to start)

Current: "de-DE" (index 0), Direction: -1
  → (0 + -1 + 3) % 3 = 2 → "qps-ploc"  (wraps to end)
```

**Edge Case:** If current locale not in available list (e.g., user manually edited options.json), defaults to first locale in list.

---

## Logging Matrix

### LocalizationService Pseudo-Locale Logging

| Event | Level | Template |
|-------|-------|----------|
| Pseudo-locale enabled | Information | `"[Localization] Pseudo-localization enabled"` |
| GetAvailableLocales called | Debug | `"[Localization] Found {Count} available locales"` |

**Context:** Lines 50, 211 in `LocalizationService.cs`

**Notes:**
- Pseudo-locale activation logged at Information (not Debug) for QA visibility
- GetAvailableLocales logs at Debug (called frequently during UI navigation)

---

### OptionsController Language Change Logging

| Event | Level | Template |
|-------|-------|----------|
| Language setting changed | Debug | `"[Options] Language changed to {Value}"` |

**Context:** Line 384 in `OptionsController.cs`

**Notes:**
- `{Value}` parameter is human-readable language name from `GetLanguageDisplayName()` (e.g., "English (US)", "[Pseudo-Loc]")
- Logs after locale reload completes (live preview active)

---

## Test Coverage

### Summary
```
Total: 46 | Passed: 46 | Failed: 0 | Skipped: 0 | Duration: 76ms
```

### New Tests in v0.3.15c

#### PseudoLocalizerTests (16 tests)

**Transform Basic Tests (4 tests)**

| Test Name | Description |
|-----------|-------------|
| `Transform_ReturnsNull_WhenInputIsNull` | Asserts null input returns null (null-safety validation) |
| `Transform_ReturnsEmpty_WhenInputIsEmpty` | Asserts empty string input returns empty string |
| `Transform_AddsBrackets_ToSimpleString` | Asserts result starts with `[` and ends with `]` for visual boundary detection |
| `Transform_AddsExpansion_ToSimpleString` | Asserts result contains `_` character for text expansion simulation |

**Diacritic Transformation Tests (3 tests + 14 Theory tests = 17 assertions)**

| Test Name | Description |
|-----------|-------------|
| `Transform_ReplacesDiacritics_ForMappedCharacters(input, expectedChar)` | Theory test with 14 InlineData rows validating vowel/consonant diacritic mapping (a→á, e→é, i→í, o→ó, u→ú, c→ç, n→ñ for both upper/lowercase) |
| `Transform_PreservesUnmappedCharacters` | Asserts characters not in diacritic map (x, y, z, 1, 2, 3, !, @, #) remain unchanged |
| `Transform_TransformsNewGame_Correctly` | Integration test: "New Game" → contains brackets, Ñ, é, á diacritics |

**Format Placeholder Preservation Tests (4 tests)**

| Test Name | Description |
|-----------|-------------|
| `Transform_PreservesFormatPlaceholder_Simple` | Asserts `"{0} min"` input retains `{0}` unchanged in output |
| `Transform_PreservesFormatPlaceholder_WithFormat` | Asserts `"{0:N2} gold"` retains `{0:N2}` with format specifier |
| `Transform_PreservesMultiplePlaceholders` | Asserts `"{0} of {1}"` retains both `{0}` and `{1}` |
| `Transform_TransformsTextAroundPlaceholders` | Asserts `"Value: {0}%"` preserves `{0}` but transforms "Value" → contains `á` |

**Expansion Tests (2 tests)**

| Test Name | Description |
|-----------|-------------|
| `Transform_AddsAtLeastOneExpansionCharacter` | Asserts even very short strings ("Hi") receive at least one `_` expansion character (minimum 1 via Math.Max) |
| `Transform_AddsApproximately30PercentExpansion` | Asserts 29-char input produces ≥8 underscores (~30% of 29 = 8.7 → 8 after int cast) |

---

#### LocalizationServiceTests Pseudo-Locale Tests (5 tests)

| Test Name | Description |
|-----------|-------------|
| `GetAvailableLocales_AlwaysIncludesPseudoLocale` | Asserts `GetAvailableLocales()` returns list containing `"qps-ploc"` even with no locale files |
| `LoadLocaleAsync_SetsPseudoLocale_WithoutFile` | Loads `"qps-ploc"` locale, asserts `result == true` and `CurrentLocale == "qps-ploc"` without requiring qps-ploc.json file |
| `Get_ReturnsTransformedString_WhenPseudoLocaleActive` | Loads `qps-ploc`, retrieves `UI_MainMenu_NewGame`, asserts result starts with `[`, ends with `]`, contains `_` |
| `GetAvailableLocales_IncludesInstalledLocales` | Asserts `GetAvailableLocales()` includes `"en-US"` when en-US.json exists in test output directory |
| `GetAvailableLocales_ReturnsSortedList` | Asserts `GetAvailableLocales()` returns alphabetically sorted list via FluentAssertions `.Should().BeInAscendingOrder()` |

---

### Complete Localization Test Suite Inventory

**LocalizationServiceTests (20 tests)**
- LoadLocaleAsync Tests: 2
- Get Tests: 2
- GetWithArgs Tests: 1
- HasKey Tests: 2
- GetMissingKeys Tests: 2
- Fallback Chain Tests (v0.3.15b): 4
- Pseudo-Localization Tests (v0.3.15c): 5
- Integration Tests: 4

**PseudoLocalizerTests (16 tests)**
- Transform Basic Tests: 4
- Diacritic Transformation Tests: 3 (+ 14 Theory variations)
- Format Placeholder Preservation Tests: 4
- Expansion Tests: 2

**LocKeysTests (7 tests)**
- AllKeys reflection tests
- Key format validation tests

**Integration Tests (3 tests)**
- End-to-end locale loading
- Format argument substitution
- Missing key detection

---

## DI Registration

### Services Requiring Registration

**OptionsViewHelperService (Refactored in v0.3.15c)**

**Location:** `App.axaml.cs` or `Program.cs` (Terminal) DI container setup

**Registration:**
```csharp
services.AddSingleton<OptionsViewHelperService>();
```

**Lifetime:** Singleton (stateless utility service with injected ILocalizationService)

**Dependencies:**
- `ILocalizationService` (constructor-injected)

**Impact:** Breaking change for any code using `OptionsViewHelperService` as static class; requires DI container resolution.

---

## Verification Results

### Build Output
```
$ dotnet build
  RuneAndRust.Core -> /Volumes/.../RuneAndRust.Core.dll
  RuneAndRust.Engine -> /Volumes/.../RuneAndRust.Engine.dll
  RuneAndRust.Persistence -> /Volumes/.../RuneAndRust.Persistence.dll
  RuneAndRust.Terminal -> /Volumes/.../RuneAndRust.Terminal.dll

Build succeeded.
    0 Warning(s)
    0 Error(s)
```

**Status:** Clean build with no errors or warnings in project files (MSB3277 EntityFrameworkCore.Relational version conflict warning present in Tests project only, non-blocking).

---

### Test Results
```
$ dotnet test --filter "FullyQualifiedName~Localization | FullyQualifiedName~PseudoLocalizer"

Test run for RuneAndRust.Tests.dll (.NETCoreApp,Version=v9.0)
VSTest version 17.14.1 (arm64)

Starting test execution, please wait...
A total of 1 test files matched the specified pattern.

Passed!  - Failed:     0, Passed:    46, Skipped:     0, Total:    46, Duration: 76 ms
```

**Breakdown:**
- LocalizationServiceTests: 20 passed (7 from v0.3.15a, 4 from v0.3.15b, 5 from v0.3.15c, 4 integration)
- PseudoLocalizerTests: 16 passed (all new in v0.3.15c)
- LocKeysTests: 7 passed (from v0.3.15a)
- Integration tests: 3 passed

**Status:** 100% pass rate, 0 failures, 0 skipped, 76ms execution time.

---

## Directory Structure After Release

```
RuneAndRust/
├── RuneAndRust.Core/
│   ├── Constants/
│   │   └── LocKeys.cs                           [MODIFIED] - Added UI_Options_Setting_Language
│   ├── Interfaces/
│   │   └── ILocalizationService.cs              [MODIFIED] - Added GetAvailableLocales()
│   ├── ViewModels/
│   │   └── OptionsViewModel.cs                  [MODIFIED] - Added Language property
│   └── Settings/
│       └── GameSettings.cs                      (v0.3.15b - Language property)
│
├── RuneAndRust.Engine/
│   ├── Helpers/
│   │   └── PseudoLocalizer.cs                   [NEW] - Diacritic transform helper
│   └── Services/
│       └── LocalizationService.cs               [MODIFIED] - GetAvailableLocales(), qps-ploc support
│
├── RuneAndRust.Terminal/
│   ├── Services/
│   │   └── OptionsController.cs                 [MODIFIED] - Language setting in Display tab
│   └── Rendering/
│       └── OptionsViewHelperService.cs          [MODIFIED] - DI refactor, language helpers
│
├── RuneAndRust.Tests/
│   └── Engine/
│       ├── LocalizationServiceTests.cs          [MODIFIED] - 5 new pseudo-locale tests
│       └── PseudoLocalizerTests.cs              [NEW] - 16 tests for diacritic transform
│
└── data/
    └── locales/
        └── en-US.json                            [MODIFIED] - v0.3.15c, Settings.Language entry
```

---

## Dependencies

### NuGet Packages (Unchanged)
- No new package dependencies in v0.3.15c
- Existing packages: Microsoft.Extensions.Logging, System.Text.Json (for LocalizationService)

### Framework Version
- .NET 9.0 (target framework)
- C# 12 language features

### Test Dependencies
- xUnit 2.4.2
- FluentAssertions 6.12.0
- NSubstitute 5.1.0

---

## Breaking Changes

### OptionsViewHelperService Static → Instance Refactor

**Impact:** High (affects all consumers of OptionsViewHelperService)

**Before (v0.3.15b and earlier):**
```csharp
var display = OptionsViewHelperService.FormatToggle(true);
```

**After (v0.3.15c):**
```csharp
// Requires DI registration and constructor injection
public class MyController
{
    private readonly OptionsViewHelperService _viewHelper;

    public MyController(OptionsViewHelperService viewHelper)
    {
        _viewHelper = viewHelper;
    }

    public void DoSomething()
    {
        var display = _viewHelper.FormatToggle(true);
    }
}
```

**Migration Steps:**
1. Add `services.AddSingleton<OptionsViewHelperService>();` to DI container
2. Add constructor parameter `OptionsViewHelperService viewHelper` to consuming classes
3. Store as instance field: `_viewHelper = viewHelper;`
4. Change all static calls to instance calls: `OptionsViewHelperService.Method()` → `_viewHelper.Method()`

**Rationale:** Localization integration requires `ILocalizationService` dependency; static class cannot use dependency injection.

---

## Migration Notes

### For Developers

**No Action Required:** v0.3.15c is additive; existing functionality preserved. Language setting defaults to "en-US" if not set.

**Optional: Test Pseudo-Localization**
1. Launch application
2. Navigate to Options > Display tab
3. Select Language setting (second item, between Theme and Reduce Motion)
4. Press `→` to cycle to `[Pseudo-Loc]`
5. Verify UI strings transform to `[Bráçkétéd Téxt___]` format
6. Navigate Options tabs to verify all labels/values pseudo-localized
7. Exit Options and verify Main Menu displays in pseudo-locale
8. Return to Options, cycle Language back to `English (US)` to restore normal text

**Troubleshooting:**
- If Language setting not visible: Verify `en-US.json` updated to v0.3.15c with `Settings.Language` entry
- If pseudo-locale not available: Check `LocalizationService.GetAvailableLocales()` always includes `qps-ploc` (hardcoded, no file required)
- If text not transforming: Verify `LocalizationService.Get()` checks `CurrentLocale == "qps-ploc"` before normal lookup
- If OptionsViewHelperService DI errors: Ensure `AddSingleton<OptionsViewHelperService>()` registered in DI container

---

### For QA/Testing

**Pseudo-Localization Test Checklist:**
- [ ] All menu labels display with brackets `[...]`
- [ ] All setting names display with diacritics (á, é, í, ó, ú, ñ, ç)
- [ ] All setting values display pseudo-localized (e.g., `[ÓÑ___]` instead of `ON`)
- [ ] No hardcoded English text visible (indicates bypass of localization service)
- [ ] UI controls accommodate longer text (30% expansion test)
- [ ] Format placeholders preserved (e.g., `{0}` in `"5 min"` format)
- [ ] Tab labels, footers, prompts all pseudo-localized
- [ ] Character encoding correct (no mojibake/replacement characters)
- [ ] Performance acceptable (no lag during Options navigation)

**Known Limitations:**
- ASCII art (title screen logo) not pseudo-localized (expected; art is locale-invariant)
- Certain system messages may still display in English if not yet migrated to localization keys

---

## Running Tests

### Full Localization Test Suite
```bash
dotnet test --filter "FullyQualifiedName~Localization | FullyQualifiedName~PseudoLocalizer"
```

**Expected Output:**
```
Passed!  - Failed: 0, Passed: 46, Skipped: 0, Total: 46, Duration: ~76ms
```

---

### PseudoLocalizer Tests Only
```bash
dotnet test --filter "FullyQualifiedName~PseudoLocalizerTests"
```

**Expected Output:**
```
Passed!  - Failed: 0, Passed: 16, Skipped: 0, Total: 16
```

---

### LocalizationService Pseudo-Locale Tests Only
```bash
dotnet test --filter "FullyQualifiedName~LocalizationServiceTests" --filter "DisplayName~Pseudo"
```

**Expected Output:**
```
Passed!  - Failed: 0, Passed: 5, Skipped: 0, Total: 5
```

---

### Specific Test Examples
```bash
# Test diacritic mapping
dotnet test --filter "FullyQualifiedName~Transform_ReplacesDiacritics"

# Test placeholder preservation
dotnet test --filter "FullyQualifiedName~Transform_PreservesFormatPlaceholder"

# Test GetAvailableLocales sorting
dotnet test --filter "FullyQualifiedName~GetAvailableLocales_ReturnsSortedList"
```

---

## Next Steps

### Planned for v0.3.16

**Localization Coverage Expansion:**
- [ ] Migrate remaining hardcoded strings in Character Creation wizard to LocKeys
- [ ] Add localization to combat log messages (DamageLogEntry, HazardLogEntry formatters)
- [ ] Localize save game metadata (character lineage/archetype/background names)
- [ ] Add LocKeys for all item names, bestiary entries, zone descriptions

**Additional Locale Files:**
- [ ] Create German (de-DE) locale file with full translation
- [ ] Create Spanish (es-ES) locale file with full translation
- [ ] Document locale file contribution guidelines for community translations

**UI/UX Enhancements:**
- [ ] Add "Language Changed" confirmation toast/notification
- [ ] Show locale completeness percentage in Options (e.g., "German (85% complete)")
- [ ] Add in-game locale switcher (not just in Options menu)

**Tooling:**
- [ ] Create locale validation script (checks for missing keys in non-en-US files)
- [ ] Add CI/CD step to verify all LocKeys present in en-US.json
- [ ] Generate locale coverage report (which strings missing in which locales)

---

## Related Specifications

- **SPEC-LOC-001:** Localization System Design (v0.3.15a foundation)
- **SPEC-UI-012:** Options Screen Architecture (v0.3.10b baseline)
- **SPEC-TEST-003:** Unit Testing Standards (PseudoLocalizerTests compliance)

---

## Version History

- **v0.3.15a - The Lexicon:** Initial localization infrastructure (LocKeys, JSON loading, ILocalizationService)
- **v0.3.15b - The Translator:** Persistent language settings, two-tier fallback chain, GameSettings.Language integration
- **v0.3.15c - The Polyglot:** UI integration, pseudo-localization, GetAvailableLocales(), live locale switching

---

## Contributors

- **The Architect (AI Agent):** Service implementation, test authoring, DI refactoring
- **The Rune-Scribe (AI Agent):** Options UI integration, ViewModel binding
- **The Chronicle-Smith (AI Agent):** Documentation and changelog generation

---

**End of Changelog v0.3.15c**
