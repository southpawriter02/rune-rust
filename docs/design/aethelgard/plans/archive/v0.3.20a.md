> **Archived** - This plan has been consolidated. See the complete version at [v0.3.20](../v0.3.x/v0.3.20.md).

Here is the comprehensive implementation plan for v0.3.20a: The Notes (Annotations).
This sub-version transforms the map from a passive reference tool into an active record-keeping system. By allowing players to "scribble" on their maps, we reduce cognitive load and support the "meticulous preparation" fantasy of the Ruin-Stalker and Saga-Scribe.

v0.3.20a: The Notes
Goal: Implement a persistent annotation system allowing players to attach text strings to Room IDs via the notecommand, and visualize these annotations on the Minimap.
1. Architecture & Data Flow
	•	State Storage: Add UserNotes (Dictionary<Guid, string>) to the GameState model. Storing this on the GameState ensures it is automatically serialized/deserialized by the existing SaveManager (v0.0.4) without schema changes to the Rooms table.
	•	Command Logic: A new NoteCommand handles the CRUD operations (Create, Read, Update, Delete) based on player input.
	•	Visualization: The MinimapRenderer (v0.3.5b) injects a dependency on GameState to check for notes during symbol resolution.
Data Flow: The Annotation Pipeline
	1	Input: Player types note "Locked Door (Blue Key)".
	2	Validation: NoteCommand confirms CurrentRoomId is not null.
	3	Mutation: The command updates GameState.UserNotes[CurrentRoomId].
	4	Persistence: The change is held in memory until the next save command or autosave.
	5	Rendering:
	◦	ExplorationScreenRenderer calls MinimapRenderer.
	◦	MinimapRenderer checks UserNotes.ContainsKey(roomId).
	◦	If true, overrides the room symbol with ! (or color modifier).

2. Logic Decision Trees
A. Note Command Logic Input: Argument String (args)
	1	Context Check: Is CurrentRoomId null?
	◦	Yes: Error "You are not in a room."
	2	Argument Analysis:
	◦	Empty/Null: Retrieve note for CurrentRoomId.
	▪	Found: Print "[yellow]Note:[/] {text}".
	▪	Missing: Print "No note attached to this location."
	◦	"clear" / "delete": Remove key from UserNotes.
	▪	Print "Note erased."
	◦	Any other text: Assign text to UserNotes[CurrentRoomId].
	▪	Print "Note attached."
B. Minimap Symbol Resolution (Updated) Input: RoomID, GameState
	1	Is Player Here? -> Return @ (Cyan).
	2	Is Room Unvisited? -> Return ░ (Dim).
	3	Is Note Present? (UserNotes.ContainsKey(ID))
	◦	Yes: Return ! (Yellow). (New Priority High)
	4	Feature Check: (Existing Logic v0.3.5b)
	◦	Boss -> ☠
	◦	Settlement -> ⌂
	◦	Anchor -> ◆
	5	Default: Return O.

3. Code Implementation
A. GameState Extension File: RuneAndRust.Core/Models/GameState.cs
public class GameState
{
    // ... existing properties

    // Maps RoomId -> User defined text note
    // Initialized to ensure non-null serialization
    public Dictionary<Guid, string> UserNotes { get; set; } = new();
}
B. NoteCommand Implementation File: RuneAndRust.Engine/Commands/NoteCommand.cs
public class NoteCommand : ICommand
{
    private readonly GameState _gameState;
    private readonly IInputHandler _input;
    private readonly ILogger<NoteCommand> _logger;

    public NoteCommand(GameState gameState, IInputHandler input, ILogger<NoteCommand> logger)
    {
        _gameState = gameState;
        _input = input;
        _logger = logger;
    }

    public Task ExecuteAsync(ParsedCommand command)
    {
        if (_gameState.CurrentRoomId is not { } roomId)
        {
            _input.DisplayError("You cannot take notes while in the void.");
            return Task.CompletedTask;
        }

        var text = command.Target; // Assuming arguments parsed into Target for simple commands

        if (string.IsNullOrWhiteSpace(text))
        {
            // Read Mode
            if (_gameState.UserNotes.TryGetValue(roomId, out var note))
                _input.DisplayMessage($"[yellow]Note:[/] {note}");
            else
                _input.DisplayMessage("No notes for this location.");
        }
        else if (text.Trim().Equals("clear", StringComparison.OrdinalIgnoreCase))
        {
            // Delete Mode
            if (_gameState.UserNotes.Remove(roomId))
            {
                _input.DisplayMessage("[grey]Note erased.[/]");
                _logger.LogInformation("Removed note from room {RoomId}", roomId);
            }
            else
            {
                _input.DisplayMessage("There was nothing to erase.");
            }
        }
        else
        {
            // Write Mode
            _gameState.UserNotes[roomId] = text;
            _input.DisplayMessage($"[green]Note attached:[/] \"{text}\"");
            _logger.LogInformation("Added note to room {RoomId}: {Text}", roomId, text);
        }

        return Task.CompletedTask;
    }
}
C. Minimap Renderer Integration File: RuneAndRust.Terminal/Rendering/MinimapRenderer.cs
public static string GetRoomSymbol(Room room, bool isPlayerHere, bool hasNote)
{
    if (isPlayerHere) return "[bold cyan]@[/]";
    if (hasNote) return "[bold yellow]![/]"; // New high-priority symbol

    // ... existing feature checks (Boss, Stairs, etc.) ...

    return "[grey]O[/]";
}

4. Deliverable Checklist (v0.3.20a)
	•	Core:
	◦	[ ] Add UserNotes dictionary to GameState.
	◦	[ ] Ensure SaveManager serializes this new property (v0.0.4 integration).
	•	Engine:
	◦	[ ] Implement NoteCommand.
	◦	[ ] Register NoteCommand in CommandParser (triggers: note, annotate, n).
	•	Terminal:
	◦	[ ] Update MinimapRenderer to accept UserNotes or a HasNote flag.
	◦	[ ] Update ExplorationScreenRenderer to pass GameState.UserNotes to the minimap.
	•	Tests:
	◦	[ ] Verify notes persist after Save/Load cycle.

5. Logging Requirements
Reference: logging.md
System
Event
Level
Message Template
Properties
Map
Note Added
Info
"[Map] User attached note to {RoomID}: {Text}"
RoomID, Text
Map
Note Cleared
Info
"[Map] User cleared note from {RoomID}"
RoomID
Map
Read
Debug
"[Map] User read note at {RoomID}"
RoomID

6. Testing Strategy
Unit Tests (NoteCommandTests.cs):
	•	Add_PersistsToState:
	◦	Execute note "Hidden Chest".
	◦	Assert GameState.UserNotes[CurrentRoomId] == "Hidden Chest".
	•	Clear_RemovesFromState:
	◦	Setup State with note. Execute note clear.
	◦	Assert UserNotes does not contain key.
	•	Overwrite_UpdatesState:
	◦	Setup Note "A". Execute note "B".
	◦	Assert Value is "B".
Integration Tests (PersistenceJourneyTests.cs expansion):
	•	Scenario:
	1	Start Game. Move North.
	2	note "Danger".
	3	Save Game. Restart Application. Load Game.
	4	Verify UserNotes contains "Danger" at correct ID.
	5	Verify Minimap renders ! for that tile.

7. Draft Changelog (v0.3.20a)
# Changelog: v0.3.20a - The Notes

**Release Date:** 2026-02-XX

## Summary
The first phase of "The Cartographer II" enables persistent map annotations. Players can now mark rooms with custom text to track locked doors, merchants, or hazards, with visual indicators appearing automatically on the minimap.

## Changes
- **Core:** Added `UserNotes` storage to GameState, fully integrated with the Save/Load system.
- **Commands:** Added `note <text>` command. Use `note` to read the current room's note, and `note clear` to remove it.
- **UI:** The Minimap now displays a yellow `!` symbol for any room containing a user note, prioritizing it over standard room icons.
Would you like to proceed to v0.3.20b: The Atlas (Export & Legend)?
