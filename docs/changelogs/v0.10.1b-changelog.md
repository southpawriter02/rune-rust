# v0.10.1b Changelog: Combat Stances

**Version:** 0.10.1b
**Phase:** Combat Stances (Balanced, Aggressive, Defensive)
**Date:** 2026-01-18
**Status:** ✅ Complete

---

## Summary

Implements combat stances allowing combatants to adopt different tactical postures that modify their attack, defense, damage, and saving throw capabilities. Combatants can switch stances once per round as a free action.

---

## Added

### Domain Layer - Enums

| Enum | Values | Description |
|------|--------|-------------|
| `CombatStance` | Balanced (0), Aggressive (1), Defensive (2) | Combat stance options affecting stat modifiers |

### Domain Layer - Definitions

| Definition | Properties | Description |
|------------|------------|-------------|
| `StanceDefinition` | StanceId, Name, Description, AttackBonus, DamageBonus, DefenseBonus, SaveBonus, IsDefault, IconPath | Complete stance configuration with stat modifiers |

**StanceDefinition Methods:**
- `Create()` - Factory method for creating stance definitions
- `ToCombatStance()` - Converts to `CombatStance` enum
- `GetModifierSource()` - Returns modifier source tag (e.g., "stance:aggressive")
- `HasModifiers()` - Checks if stance has any non-zero modifiers

### Domain Layer - Entity Updates

| Entity | Changes |
|--------|---------|
| `Combatant` | Added `CurrentStance` property, `SetStance()` method |

### Application Layer - DTOs

| DTO | Description |
|-----|-------------|
| `StanceChangeResult` | Result of stance change with IsSuccess, OldStance, NewStance, StanceChanged, FailureReason |

**StanceChangeResult Factory Methods:**
- `Success(oldStance, newStance)` - Successful stance change
- `AlreadyInStance(stance)` - Already in requested stance (IsSuccess=true, StanceChanged=false)
- `Failed(reason)` - Change not allowed (e.g., already changed this round)

### Application Layer - Events

| Event | Description |
|-------|-------------|
| `StanceChangedEvent` | Raised when a combatant successfully changes stance |
| `StanceChangeResetEvent` | Raised when stance change availability is reset for a new round |
| `StanceModifiersAppliedEvent` | Raised when stance modifiers are applied to a combatant |
| `StanceModifiersRemovedEvent` | Raised when stance modifiers are removed from a combatant |

### Application Layer - Interfaces

| Interface | Methods |
|-----------|---------|
| `IStanceProvider` | GetStance(enum), GetStance(string), GetDefaultStance, GetAllStances, StanceExists, Count |
| `IStanceService` | GetCurrentStance, GetStanceDefinition, SetStance, CanChangeStance, GetAttackBonus, GetDamageBonus, GetDefenseBonus, GetSaveBonus, ResetStanceChange, ResetAllStanceChanges, GetAvailableStances, InitializeStance |

### Application Layer - Service

| Service | Description |
|---------|-------------|
| `StanceService` | Full implementation of stance management with once-per-round tracking, modifier retrieval, and event logging |

### Infrastructure Layer - Provider

| Provider | Description |
|----------|-------------|
| `JsonStanceProvider` | Loads stance definitions from JSON configuration file |

### Configuration

| File | Description |
|------|-------------|
| `config/stances.json` | Stance definitions (Balanced, Aggressive, Defensive) with all modifiers |
| `config/schemas/stances.schema.json` | JSON schema for stance configuration validation |

---

## Stance Mechanics

### Balanced Stance (Default)
- **Attack Bonus:** +0
- **Damage Bonus:** None
- **Defense Bonus:** +0
- **Save Bonus:** +0
- **Description:** Neutral stance suitable for most situations

### Aggressive Stance
- **Attack Bonus:** +2
- **Damage Bonus:** +1d4
- **Defense Bonus:** -2
- **Save Bonus:** -1
- **Description:** Offensive posture sacrificing defense for increased attack power

### Defensive Stance
- **Attack Bonus:** -2
- **Damage Bonus:** -1d4
- **Defense Bonus:** +2
- **Save Bonus:** +2
- **Description:** Protective posture sacrificing offense for increased survivability

---

## Once-Per-Round Limit

- Combatants can change stance **once per round** as a free action
- Tracked via `HashSet<Guid>` in `StanceService`
- Reset at round start via `ResetStanceChange()` or `ResetAllStanceChanges()`
- Attempting a second change returns `StanceChangeResult.Failed("Already changed stance this round")`

---

## Logging Matrix

| Event | Level | Template |
|-------|-------|----------|
| Stance changed | Information | `"{Combatant} changed stance from {OldStance} to {NewStance}"` |
| Already in stance | Debug | `"{Combatant} already in {Stance} stance"` |
| Change denied | Warning | `"{Combatant} already changed stance this round"` |
| Stance reset | Debug | `"{Combatant} stance change reset for new round"` |
| Modifiers applied | Debug | `"Applied {Bonus} {StatType} from {StanceName}"` |
| Modifiers removed | Debug | `"Removed modifiers from {StanceName}"` |
| Unknown stance | Error | `"Unknown stance: {Stance}"` |
| Provider loaded | Information | `"Loaded {Count} stance definitions"` |

---

## Unit Tests

**42 tests** covering:

### CombatStance Enum Tests (16 tests)
- Default value is Balanced
- All expected values exist (Balanced, Aggressive, Defensive)
- Correct integer values (0, 1, 2)
- String conversion tests
- Stance distinction tests
- Parse from string tests (case-insensitive)

### StanceService Tests (26 tests)
- GetCurrentStance returns combatant's stance
- GetStanceDefinition returns correct definition
- SetStance changes stance successfully
- SetStance returns AlreadyInStance when same stance
- SetStance fails when changed this round
- SetStance fails for unknown stance
- CanChangeStance returns true initially
- CanChangeStance returns false after change
- GetAttackBonus returns correct values for each stance
- GetDamageBonus returns dice notation for each stance
- GetDefenseBonus returns correct values for each stance
- GetSaveBonus returns correct values for each stance
- ResetStanceChange allows new change
- ResetAllStanceChanges clears all tracking
- InitializeStance sets default stance
- SetStance logs combat event on successful change
- ResetStanceChange logs combat event
- GetAvailableStances returns all stances

---

## Files Changed

| Path | Change |
|------|--------|
| `src/.../Domain/Enums/CombatStance.cs` | NEW |
| `src/.../Domain/Definitions/StanceDefinition.cs` | NEW |
| `src/.../Domain/Entities/Combatant.cs` | MODIFIED - Added CurrentStance, SetStance() |
| `src/.../Application/DTOs/StanceChangeResult.cs` | NEW |
| `src/.../Application/Events/StanceEvents.cs` | NEW |
| `src/.../Application/Interfaces/IStanceProvider.cs` | NEW |
| `src/.../Application/Interfaces/IStanceService.cs` | NEW |
| `src/.../Application/Services/StanceService.cs` | NEW |
| `src/.../Infrastructure/Providers/JsonStanceProvider.cs` | NEW |
| `src/.../Infrastructure/DependencyInjection.cs` | MODIFIED - Added stance DI registrations |
| `config/stances.json` | NEW |
| `config/schemas/stances.schema.json` | NEW |
| `tests/.../Enums/CombatStanceTests.cs` | NEW |
| `tests/.../Services/StanceServiceTests.cs` | NEW |

---

## DI Registration

```csharp
// Infrastructure (AddInfrastructure)
services.AddSingleton<IStanceProvider>(sp =>
{
    var stancesPath = Path.Combine(configPath, "stances.json");
    var logger = sp.GetRequiredService<ILogger<JsonStanceProvider>>();
    return new JsonStanceProvider(stancesPath, logger);
});

// Application (AddApplicationServices)
services.AddScoped<IStanceService, StanceService>();
```

---

## v0.10.1 Progress

| Version | Feature | Status |
|---------|---------|--------|
| v0.10.1a | Defense Actions | ✅ Complete |
| v0.10.1b | Combat Stances | ✅ Complete |
| v0.10.1c | AI Defense Behavior | Next |

---

## Dependencies

| Dependency | Purpose |
|------------|---------|
| `IStanceProvider` | Loading stance definitions from JSON |
| `IGameEventLogger` | Event logging for combat |
| `CombatStance` enum | Stance type identification |
| `Combatant.CurrentStance` | Storing combatant's current stance |

---

## Integration Notes

### Combat Calculations
To integrate stance modifiers into combat:

```csharp
// Attack roll
int attackBonus = _stanceService.GetAttackBonus(attacker);
int totalAttack = baseAttack + attackBonus;

// Damage calculation
string? damageBonus = _stanceService.GetDamageBonus(attacker);
if (!string.IsNullOrEmpty(damageBonus))
{
    // Roll and add/subtract damage dice
}

// Defense check
int defenseBonus = _stanceService.GetDefenseBonus(defender);
int effectiveDefense = baseDefense + defenseBonus;

// Saving throw
int saveBonus = _stanceService.GetSaveBonus(combatant);
int totalSave = baseSave + saveBonus;
```

### Round Transitions
Reset stance change availability at round start:

```csharp
_stanceService.ResetAllStanceChanges();
```
