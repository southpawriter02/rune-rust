# Changelog: v0.17.5d - Creation Controller

**Release Date:** 2026-01-31
**Phase:** Character Creation Workflow (4/7)
**Status:** Complete

---

## Overview

Implements the Creation Controller phase: 2 value objects (`StepResult`, `CharacterCreationResult`), 1 interface (`ICharacterCreationController`), 1 stub interface (`ICharacterFactory`), 1 application service (`CharacterCreationController`), and comprehensive unit tests. The `CharacterCreationController` orchestrates the 6-step character creation workflow, managing state transitions, validating selections against domain providers, coordinating with the ViewModel builder for TUI rendering, and delegating final character creation to the (optional) character factory.

The controller provides ten operations: `Initialize()` starts a new session at Step 1, five async step methods (`SelectLineageAsync`, `SelectBackgroundAsync`, `ConfirmAttributesAsync`, `SelectArchetypeAsync`, `SelectSpecializationAsync`) validate and advance through steps, `ConfirmCharacterAsync()` validates the name and creates the character, `GoBack()` navigates to the previous step preserving selections, `Cancel()` clears all state, and `GetCurrentState()` retrieves the current state and ViewModel.

---

## Added

### Domain Layer

#### Value Objects

- **`StepResult`** (`ValueObjects/StepResult.cs`)
    - `readonly record struct` with 5 properties: `Success` (bool), `NextStep` (CharacterCreationStep?), `CurrentStep` (CharacterCreationStep), `ValidationErrors` (IReadOnlyList\<string\>), `UpdatedViewModel` (CharacterCreationViewModel)
    - Factory methods: `Succeeded(currentStep, nextStep, viewModel)`, `Failed(currentStep, viewModel, params errors)`, `Failed(currentStep, viewModel, IReadOnlyList<string> errors)`
    - `ToString()` override: "Success: {CurrentStep} -> {NextStep}" or "Failed at {CurrentStep}: {count} error(s)"
    - Section separators: PROPERTIES, FACTORY METHODS, DEBUGGING

- **`CharacterCreationResult`** (`ValueObjects/CharacterCreationResult.cs`)
    - `readonly record struct` with 4 properties: `Success` (bool), `Character` (Player?), `Message` (string), `ValidationErrors` (IReadOnlyList\<string\>)
    - Factory methods: `Succeeded(character, message)`, `Failed(message, params errors)`
    - `ToString()` override: "Created: {Message}" or "Failed: {Message}"
    - Section separators: PROPERTIES, FACTORY METHODS, DEBUGGING

### Application Layer

#### Interfaces

- **`ICharacterCreationController`** (`Interfaces/ICharacterCreationController.cs`)
    - 10 members: `Initialize()`, 5 async step methods, `GoBack()`, `Cancel()`, `GetCurrentState()`, `IsSessionActive`
    - Rich XML documentation with `<summary>`, `<param>`, `<returns>`, `<remarks>`, `<list>`, `<seealso>`
    - Validation rules documented per method (Clan-Born bonus, attribute completeness, specialization compatibility)

- **`ICharacterFactory`** (`Interfaces/ICharacterFactory.cs`)
    - Stub interface for v0.17.5e — single method: `CreateCharacterAsync(CharacterCreationState state)` returning `Task<Player>`
    - Rich XML documentation documenting lifecycle (stub in v0.17.5d, full implementation in v0.17.5e)

#### Services

- **`CharacterCreationController`** (`Services/CharacterCreationController.cs`)
    - `public class CharacterCreationController : ICharacterCreationController`
    - Constructor: 7 required dependencies + 1 optional (`ICharacterFactory?`)
    - `ArgumentNullException.ThrowIfNull()` for all 7 required parameters
    - 6 error message constants for validation failures
    - `Initialize()`: Creates fresh `CharacterCreationState` via `CharacterCreationState.Create()`
    - `SelectLineageAsync()`: Validates Clan-Born requires `flexibleBonus`, updates state, advances to Background
    - `SelectBackgroundAsync()`: Updates state, advances to Attributes
    - `ConfirmAttributesAsync()`: Validates `attributes.IsComplete`, advances to Archetype
    - `SelectArchetypeAsync()`: Updates state, clears specialization on archetype change, advances to Specialization
    - `SelectSpecializationAsync()`: Validates via `ISpecializationProvider.GetByArchetype()` with `SpecializationId` matching, advances to Summary
    - `ConfirmCharacterAsync()`: Validates name via `INameValidator`, checks `IsComplete`, creates via factory (or returns pending)
    - `GoBack()`: Uses `GetPreviousStep()` extension method, preserves all selections
    - `Cancel()`: Sets state to null, logs session cancellation
    - `GetCurrentState()`: Builds ViewModel via `IViewModelBuilder.Build()`
    - Private helpers: `CreateSuccessResult()`, `CreateFailureResult()`, `CreateNoSessionResult()`
    - Section separators: PRIVATE FIELDS, ERROR MESSAGES, CONSTRUCTOR, ICharacterCreationController IMPLEMENTATION, PRIVATE HELPER METHODS

### Unit Tests

- **`CharacterCreationControllerTests`** (`Services/CharacterCreationControllerTests.cs`) — 9 test methods
    - **Session Lifecycle Tests (2 methods):**
        - `Initialize_CreatesNewSession_AtLineageStep`: State not null, CurrentStep = Lineage, SessionId not empty, IsSessionActive = true
        - `Cancel_ClearsSessionState`: After cancel, IsSessionActive = false
    - **Lineage Selection Tests (3 methods):**
        - `SelectLineage_ClanBorn_WithoutFlexibleBonus_Fails`: Clan-Born without bonus returns failure with "flexible attribute bonus" error
        - `SelectLineage_Valid_AdvancesToBackground`: RuneMarked succeeds, CurrentStep = Background, NextStep = Attributes
        - `SelectLineage_ClanBorn_WithFlexibleBonus_Succeeds`: Clan-Born with Might bonus succeeds
    - **Specialization Validation Tests (1 method):**
        - `SelectSpecialization_InvalidForArchetype_Fails`: Mock returns empty spec list, returns failure with "not available" error
    - **Navigation Tests (2 methods):**
        - `GoBack_FromBackground_ReturnsToLineage`: After lineage selection, GoBack returns to Lineage
        - `GoBack_FromLineage_Fails`: At first step, returns failure with "Already at first step."
    - **Character Confirmation Tests (1 method):**
        - `ConfirmCharacter_InvalidName_ReturnsError`: Mock name validator returns Invalid, returns failure
    - All tests use `FluentAssertions` with `[TestFixture]` and `[Test]` NUnit attributes
    - `#pragma warning disable NUnit2045` for readable multi-assertion tests

### Glossary

- **`config/glossary.json`** — Added 4 glossary entries
    - `step-result`: Value object for step selection results (sortOrder: 60)
    - `character-creation-result`: Value object for final creation outcome (sortOrder: 61)
    - `character-creation-controller`: Application service orchestrating creation workflow (sortOrder: 62)
    - `character-creation-controller-interface`: Interface for creation controller (sortOrder: 63)

---

## Changed

### Documentation

- **`docs/design/v0.17.x/v0.17.5-scope-breakdown.md`** — Checked off v0.17.5d unit test items
    - `[x] Initialize creates valid state`
    - `[x] Step transitions work correctly`
    - `[x] GoBack preserves previous selections`
    - `[x] Cancel clears state`

- **`docs/design/v0.17.x/v0.17.x-overview.md`** — Checked off v0.17.5d deliverables
    - `[x] ICharacterCreationController interface`
    - `[x] CharacterCreationController implementation`

---

## Design Decisions

### Clan-Born Flexible Bonus Validation Simplified

The design specification validates `flexibleBonus != lineageDef.PrimaryAttribute` (checking that the flexible bonus is not the same as the lineage's primary +2 attribute). However, `LineageDefinition` has no `PrimaryAttribute` property in the actual codebase. Furthermore, Clan-Born's `LineageAttributeModifiers` has all fixed modifiers at 0 — it has no +2 primary attribute. The only validation needed is that `flexibleBonus.HasValue` when `Lineage.ClanBorn` is selected. Any `CoreAttribute` is valid as the flexible bonus target.

| Aspect | Design Spec | Implementation |
|---|---|---|
| Validation | `flexibleBonus != PrimaryAttribute` | `flexibleBonus.HasValue` only |
| Reason | PrimaryAttribute doesn't exist; Clan-Born has no +2 | All CoreAttributes are valid targets |

### AttributeAllocationState.IsComplete vs IsValid

The design specification references `attributes.IsValid` for checking attribute allocation completeness. The actual property on `AttributeAllocationState` is `IsComplete` (returns `true` when `PointsRemaining == 0`). The implementation uses the correct property name.

### SpecializationDefinition.SpecializationId vs .Id

The design specification references `s.Id == specialization` when validating specialization-archetype compatibility. The actual property is `SpecializationDefinition.SpecializationId` (an enum), not `.Id` (which is the GUID entity identifier). The implementation uses `s.SpecializationId == specialization` for correct enum matching.

### ILineageProvider.GetLineage vs GetByLineage

The design specification calls `_lineageProvider.GetByLineage(lineage)` which does not exist. The actual method is `GetLineage(Lineage lineage)` returning `LineageDefinition?`. The implementation uses the correct method name. Note: this method is not currently called in the controller since the Clan-Born validation was simplified (see above).

### Optional ICharacterFactory for Incremental Implementation

The design specification acknowledges that `ICharacterFactory` does not exist yet (v0.17.5e). The controller accepts it as an optional constructor parameter (`ICharacterFactory? characterFactory = null`). When null, `ConfirmCharacterAsync` returns a success result with a null character and a "pending" message. A stub `ICharacterFactory` interface was created with the single method `CreateCharacterAsync(CharacterCreationState)` to formalize the dependency.

### Direct State Assignment vs Entity Navigation Methods

The `CharacterCreationState` entity provides `TryAdvance()` and `TryGoBack()` methods for step navigation. The controller uses direct property assignment (`_state.CurrentStep = CharacterCreationStep.Background`) instead, matching the design specification's approach. This gives the controller explicit control over step flow and allows bypassing the entity's `IsStepComplete()` validation (since the controller performs its own validation).

---

## Dependencies

### Prerequisites

| Type | Phase | Usage |
| --- | --- | --- |
| `CharacterCreationStep` | v0.17.5a | Step enum for navigation |
| `CharacterCreationState` | v0.17.5a | Session state management |
| `CharacterCreationStepExtensions` | v0.17.5a | `GetNextStep()`, `GetPreviousStep()` |
| `CharacterCreationViewModel` | v0.17.5b | ViewModel for TUI rendering |
| `IViewModelBuilder` | v0.17.5b | ViewModel construction |
| `INameValidator` | v0.17.5c | Name validation at confirmation |
| `NameValidationResult` | v0.17.5c | Validation result processing |
| `ILineageProvider` | v0.17.0 | Lineage validation |
| `IBackgroundProvider` | v0.17.1 | Background validation |
| `IArchetypeProvider` | v0.17.3 | Archetype validation |
| `ISpecializationProvider` | v0.17.4 | Specialization-archetype compatibility |

### Provides to Future Phases

| Type | Phase | Usage |
| --- | --- | --- |
| `ICharacterCreationController` | v0.17.5e | Factory integration |
| `ICharacterCreationController` | v0.17.5f | TUI screens call controller |
| `ICharacterFactory` | v0.17.5e | Factory implements this interface |
| `CharacterCreationResult` | v0.17.5g | Database persists created character |
| `StepResult` | v0.17.5f | TUI processes step outcomes |

---

## Logging Strategy

| Level | When |
|---|---|
| Debug | Controller initialized (FactoryAvailable) |
| Debug | Selecting lineage (Lineage, FlexibleBonus, SessionId) |
| Debug | Validation failed: Clan-Born without flexible bonus (SessionId) |
| Debug | Confirming attribute allocation (IsComplete, PointsRemaining, SessionId) |
| Debug | Validation failed: Attributes not complete (PointsRemaining, SessionId) |
| Debug | Selecting archetype (Archetype, SessionId) |
| Debug | Selecting specialization (Specialization, SessionId) |
| Debug | Validation failed: Specialization not valid for archetype (Specialization, Archetype, SessionId) |
| Debug | Confirming character name (Name, SessionId) |
| Debug | Name validation failed (Error, SessionId) |
| Debug | Creation state not complete (SessionId) |
| Debug | Cannot go back from first step (Step, SessionId) |
| Debug | Navigated back to step (Step, SessionId) |
| Information | Session initialized (SessionId, CurrentStep) |
| Information | Lineage selected (Lineage, SessionId) |
| Information | Background selected (Background, SessionId) |
| Information | Attributes confirmed (SessionId) |
| Information | Archetype selected — PERMANENT (Archetype, SessionId) |
| Information | Specialization selected (Specialization, SessionId) |
| Information | Character created (Name, Lineage, Archetype, SessionId) |
| Information | Creation cancelled (SessionId) |
| Warning | Operation attempted with no active session |
| Warning | ConfirmCharacter called with no active session |
| Warning | Character factory not available (SessionId) |

All logging uses structured format with named parameters for efficient log aggregation. SessionId is included in most log messages for session correlation.

---

## Files Created

| Path | Description |
|------|-------------|
| `src/Core/RuneAndRust.Domain/ValueObjects/StepResult.cs` | Step action result with Success, steps, errors, and ViewModel |
| `src/Core/RuneAndRust.Domain/ValueObjects/CharacterCreationResult.cs` | Final creation result with Player or errors |
| `src/Core/RuneAndRust.Application/Interfaces/ICharacterCreationController.cs` | Controller interface with 10 members |
| `src/Core/RuneAndRust.Application/Interfaces/ICharacterFactory.cs` | Stub factory interface (full impl in v0.17.5e) |
| `src/Core/RuneAndRust.Application/Services/CharacterCreationController.cs` | Controller service with 8 dependencies |
| `tests/RuneAndRust.Application.UnitTests/Services/CharacterCreationControllerTests.cs` | 9 test methods for controller behaviors |
| `changelogs/v0.17.5d-changelog.md` | This changelog |

## Files Modified

| Path | Description |
|------|-------------|
| `config/glossary.json` | Added 4 glossary entries (sortOrder 60-63) |
| `docs/design/v0.17.x/v0.17.5-scope-breakdown.md` | Checked off v0.17.5d unit test items |
| `docs/design/v0.17.x/v0.17.x-overview.md` | Checked off controller deliverables |

---

## Notes

- Total unit tests for v0.17.5d: 9 test methods (design spec estimated ~6)
- Build: 0 errors, 0 warnings
- The design specification had 6 API discrepancies with the actual codebase (see Design Decisions above)
- Both value objects use `readonly record struct` for immutability and value equality
- The `ICharacterFactory` stub interface was created as a forward declaration for v0.17.5e
- Clan-Born flexible bonus validation was simplified since `PrimaryAttribute` doesn't exist on `LineageDefinition`
- The controller uses direct state property assignment rather than `CharacterCreationState.TryAdvance()`/`TryGoBack()` methods
- Archetype selection clears the specialization selection to prevent stale archetype-specialization mismatches
- SessionId is included in most log messages for session correlation across log entries
- All new files follow established codebase patterns: `═══════` section separators, file headers with Version tag, comprehensive XML documentation, exhaustive structured logging
