using FluentAssertions;
using Microsoft.Extensions.Logging.Abstractions;
using Moq;
using RuneAndRust.Application.Interfaces;
using RuneAndRust.Presentation.Tui.Configuration;
using RuneAndRust.Presentation.Tui.DTOs;
using RuneAndRust.Presentation.Tui.Renderers;
using RuneAndRust.Presentation.Tui.UI;

namespace RuneAndRust.Presentation.Tui.UnitTests.UI;

/// <summary>
/// Unit tests for <see cref="VulnerabilityWindow"/>.
/// </summary>
[TestFixture]
public class VulnerabilityWindowTests
{
    private Mock<ITerminalService> _mockTerminal = null!;
    private BossStatusRenderer _renderer = null!;
    private VulnerabilityWindow _window = null!;

    [SetUp]
    public void SetUp()
    {
        _mockTerminal = new Mock<ITerminalService>();
        _mockTerminal.Setup(t => t.SupportsUnicode).Returns(true);
        _mockTerminal.Setup(t => t.SupportsColor).Returns(true);

        _renderer = new BossStatusRenderer(
            null,
            NullLogger<BossStatusRenderer>.Instance);

        _window = new VulnerabilityWindow(
            _renderer,
            _mockTerminal.Object,
            null,
            NullLogger<VulnerabilityWindow>.Instance);
    }

    // ═══════════════════════════════════════════════════════════════
    // RENDER WINDOW TESTS
    // ═══════════════════════════════════════════════════════════════

    [Test]
    public void RenderWindow_WhenActive_ShowsWindowOpen()
    {
        // Arrange
        var dto = new VulnerabilityDisplayDto(
            IsActive: true,
            TurnsRemaining: 2,
            DamageMultiplier: 1.5f);

        // Act
        _window.RenderWindow(dto);

        // Assert
        _mockTerminal.Verify(t => t.WriteColoredAt(
            It.IsAny<int>(), It.IsAny<int>(),
            It.Is<string>(s => s.Contains("VULNERABILITY WINDOW OPEN")),
            It.IsAny<ConsoleColor>()), Times.Once);
    }

    [Test]
    public void RenderWindow_WhenActive_SetsIsActiveTrue()
    {
        // Arrange
        var dto = new VulnerabilityDisplayDto(
            IsActive: true,
            TurnsRemaining: 2,
            DamageMultiplier: 1.5f);

        // Act
        _window.RenderWindow(dto);

        // Assert
        _window.IsActive.Should().BeTrue();
        _window.TurnsRemaining.Should().Be(2);
    }

    [Test]
    public void RenderWindow_WhenInactive_ClearsDisplay()
    {
        // Arrange
        var activeDto = new VulnerabilityDisplayDto(
            IsActive: true,
            TurnsRemaining: 2,
            DamageMultiplier: 1.5f);
        _window.RenderWindow(activeDto);
        _mockTerminal.Invocations.Clear();

        var inactiveDto = new VulnerabilityDisplayDto(
            IsActive: false,
            TurnsRemaining: 0,
            DamageMultiplier: 1.0f);

        // Act
        _window.RenderWindow(inactiveDto);

        // Assert - WriteAt called to clear
        _mockTerminal.Verify(t => t.WriteAt(
            It.IsAny<int>(), It.IsAny<int>(),
            It.Is<string>(s => s.Trim() == "")), Times.AtLeastOnce);
    }

    [Test]
    public void RenderWindow_WithNullDto_ThrowsArgumentNullException()
    {
        // Arrange
        VulnerabilityDisplayDto dto = null!;

        // Act
        var act = () => _window.RenderWindow(dto);

        // Assert
        act.Should().Throw<ArgumentNullException>();
    }

    // ═══════════════════════════════════════════════════════════════
    // SHOW WINDOW OPEN TESTS
    // ═══════════════════════════════════════════════════════════════

    [Test]
    public void ShowWindowOpen_WithMultipleTurns_RendersTurns()
    {
        // Arrange
        var turns = 3;

        // Act
        _window.ShowWindowOpen(turns);

        // Assert
        _mockTerminal.Verify(t => t.WriteColoredAt(
            It.IsAny<int>(), It.IsAny<int>(),
            It.Is<string>(s => s.Contains("3 turns")),
            It.IsAny<ConsoleColor>()), Times.AtLeastOnce);
    }

    [Test]
    public void ShowWindowOpen_WithOneTurn_TriggersFlashUrgency()
    {
        // Arrange
        var turns = 1;

        // Act
        _window.ShowWindowOpen(turns);

        // Assert - FlashDelay called multiple times for urgency flash
        _mockTerminal.Verify(t => t.FlashDelay(It.IsAny<int>()), Times.AtLeast(2));
    }

    // ═══════════════════════════════════════════════════════════════
    // SHOW WINDOW CLOSED TESTS
    // ═══════════════════════════════════════════════════════════════

    [Test]
    public void ShowWindowClosed_RendersClosedMessage()
    {
        // Arrange & Act
        _window.ShowWindowClosed();

        // Assert
        _mockTerminal.Verify(t => t.WriteColoredAt(
            It.IsAny<int>(), It.IsAny<int>(),
            It.Is<string>(s => s.Contains("closed")),
            It.IsAny<ConsoleColor>()), Times.Once);
    }

    [Test]
    public void ShowWindowClosed_CallsFlashDelay()
    {
        // Arrange & Act
        _window.ShowWindowClosed();

        // Assert
        _mockTerminal.Verify(t => t.FlashDelay(It.IsAny<int>()), Times.AtLeastOnce);
    }

    // ═══════════════════════════════════════════════════════════════
    // CLEAR TESTS
    // ═══════════════════════════════════════════════════════════════

    [Test]
    public void Clear_ResetsState()
    {
        // Arrange
        var dto = new VulnerabilityDisplayDto(
            IsActive: true,
            TurnsRemaining: 2,
            DamageMultiplier: 1.5f);
        _window.RenderWindow(dto);

        // Act
        _window.Clear();

        // Assert
        _window.IsActive.Should().BeFalse();
        _window.TurnsRemaining.Should().BeNull();
    }

    // ═══════════════════════════════════════════════════════════════
    // CONSTRUCTOR TESTS
    // ═══════════════════════════════════════════════════════════════

    [Test]
    public void Constructor_WithNullRenderer_ThrowsArgumentNullException()
    {
        // Arrange
        BossStatusRenderer renderer = null!;

        // Act
        var act = () => new VulnerabilityWindow(renderer, _mockTerminal.Object);

        // Assert
        act.Should().Throw<ArgumentNullException>();
    }

    [Test]
    public void Constructor_WithNullTerminalService_ThrowsArgumentNullException()
    {
        // Arrange
        ITerminalService terminal = null!;

        // Act
        var act = () => new VulnerabilityWindow(_renderer, terminal);

        // Assert
        act.Should().Throw<ArgumentNullException>();
    }
}
