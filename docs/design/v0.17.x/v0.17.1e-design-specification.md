# v0.17.1e Design Specification: Background Application Service

**Version:** 0.17.1e  
**Phase Name:** Background Application Service  
**Parent Version:** v0.17.1 (Background System)  
**Prerequisites:** v0.17.1d Complete (Background Provider)  
**Estimated Tests:** ~12 unit tests

---

## Table of Contents

1. [Executive Summary](#1-executive-summary)
2. [Feature Overview](#2-feature-overview)
3. [Architecture Diagrams](#3-architecture-diagrams)
4. [BackgroundApplicationResult Value Object](#4-backgroundapplicationresult-value-object)
5. [BackgroundPreview Value Object](#5-backgroundpreview-value-object)
6. [IBackgroundApplicationService Interface](#6-ibackgroundapplicationservice-interface)
7. [BackgroundApplicationService Implementation](#7-backgroundapplicationservice-implementation)
8. [Data Model Changes](#8-data-model-changes)
9. [Logging Specifications](#9-logging-specifications)
10. [Unit Testing Requirements](#10-unit-testing-requirements)
11. [Use Cases](#11-use-cases)
12. [User Stories](#12-user-stories)
13. [Deliverable Checklist](#13-deliverable-checklist)
14. [Acceptance Criteria](#14-acceptance-criteria)
15. [Dependencies](#15-dependencies)
16. [Future Considerations](#16-future-considerations)

---

## 1. Executive Summary

### 1.1 Purpose

This specification defines the `IBackgroundApplicationService` interface and its implementation, which applies background grants to characters during creation. This is the culmination of the v0.17.1 Background System, bringing together all prior components to deliver a complete background application workflow.

The application service provides:

- **Grant Application**: Applies skill and equipment grants to characters
- **Preview Generation**: Creates previews for UI display before selection
- **Validation**: Ensures backgrounds can be applied safely
- **Result Tracking**: Returns detailed results of what was granted

### 1.2 Key Deliverables

| Category          | Items                                              |
| ----------------- | -------------------------------------------------- |
| **Value Objects** | `BackgroundApplicationResult`, `BackgroundPreview` |
| **Interfaces**    | `IBackgroundApplicationService`                    |
| **Services**      | `BackgroundApplicationService`                     |
| **Tests**         | ~12 unit tests                                     |

### 1.3 Architectural Significance

This version completes the **Background System** with application logic:

- **Orchestration Pattern**: Service coordinates provider, skill, and equipment systems
- **Result Object Pattern**: Detailed results enable UI feedback and logging
- **Preview Pattern**: Previews support informed decision-making in character creation
- **Separation of Concerns**: Provider retrieves data, service applies it
- **Validation First**: `CanApplyBackground` prevents invalid applications

---

## 2. Feature Overview

```
v0.17.1e Background Application Service
├── BackgroundApplicationResult Value Object
│   ├── Success: bool
│   ├── BackgroundId: Background
│   ├── SkillsGranted: List<GrantedSkill>
│   ├── EquipmentGranted: List<GrantedEquipment>
│   └── Messages: List<string>
├── BackgroundPreview Value Object
│   ├── BackgroundId: Background
│   ├── DisplayName: string
│   ├── Description: string
│   ├── SkillSummary: string
│   ├── EquipmentSummary: string
│   └── NarrativeHookCount: int
├── IBackgroundApplicationService Interface
│   ├── ApplyBackgroundToCharacter(character, background)
│   ├── GetBackgroundPreview(background)
│   └── CanApplyBackground(background)
└── BackgroundApplicationService Implementation
    ├── Uses IBackgroundProvider
    ├── Applies skill grants to character
    ├── Creates and grants equipment
    └── Returns detailed results
```

### 2.1 Scope Alignment

**In Scope:**

- `BackgroundApplicationResult` value object for application results
- `BackgroundPreview` value object for UI display
- `IBackgroundApplicationService` interface definition
- `BackgroundApplicationService` implementation
- Skill grant application to character
- Equipment grant creation and inventory addition
- Auto-equip logic for equipped items
- Logging of all grant applications
- Unit tests for service functionality

**Out of Scope:**

- Character creation workflow orchestration → v0.17.5
- UI components for background selection → v0.17.5
- Persistence of character changes → existing save system
- Undo/rollback of applied background → future enhancement

---

## 3. Architecture Diagrams

### 3.1 Application Service Overview

```
┌─────────────────────────────────────────────────────────────────────┐
│              BACKGROUND APPLICATION SERVICE OVERVIEW                 │
└─────────────────────────────────────────────────────────────────────┘

    Character Creation Workflow
           │
           │  Requests background application
           ▼
┌─────────────────────────────────────────────────────────────────────┐
│                IBackgroundApplicationService                         │
│                        (Interface)                                   │
├─────────────────────────────────────────────────────────────────────┤
│  + ApplyBackgroundToCharacter(character, background)                │
│  + GetBackgroundPreview(background)                                 │
│  + CanApplyBackground(background)                                   │
└─────────────────────────────────────────────────────────────────────┘
           │
           │  Implemented by
           ▼
┌─────────────────────────────────────────────────────────────────────┐
│                BackgroundApplicationService                          │
│                      (Implementation)                                │
├─────────────────────────────────────────────────────────────────────┤
│  Dependencies:                                                      │
│  - IBackgroundProvider (for background data)                        │
│  - IItemFactory (for creating items)                                │
│  - ILogger<BackgroundApplicationService>                            │
└─────────────────────────────────────────────────────────────────────┘
           │
           ▼
┌─────────────────────────────────────────────────────────────────────┐
│                     IBackgroundProvider                              │
├─────────────────────────────────────────────────────────────────────┤
│  Provides background definitions, skill grants, equipment grants    │
└─────────────────────────────────────────────────────────────────────┘
```

### 3.2 Layer Diagram

```
┌─────────────────────────────────────────────────────────────────────┐
│                        PRESENTATION LAYER                            │
├─────────────────────────────────────────────────────────────────────┤
│  CharacterCreationView (v0.17.5)                                     │
│  └── Calls GetBackgroundPreview() for display                       │
│  └── Calls ApplyBackgroundToCharacter() on confirmation             │
│                                                                      │
│  BackgroundSelectionPanel                                            │
│  └── Displays BackgroundPreview data                                 │
└───────┬─────────────────────────────────────────────────────────────┘
        │
        ▼
┌─────────────────────────────────────────────────────────────────────┐
│                       APPLICATION LAYER                              │
├─────────────────────────────────────────────────────────────────────┤
│  ┌───────────────────────────────────────────────────────────────┐  │
│  │              IBackgroundApplicationService                    │  │
│  │                      (Interface)                              │  │
│  ├───────────────────────────────────────────────────────────────┤  │
│  │  + ApplyBackgroundToCharacter(character, bg): Result          │  │
│  │  + GetBackgroundPreview(bg): BackgroundPreview                │  │
│  │  + CanApplyBackground(bg): bool                               │  │
│  └───────────────────────────────────────────────────────────────┘  │
│                                                                      │
│  ┌───────────────────────────────────────────────────────────────┐  │
│  │              BackgroundApplicationResult                      │  │
│  │              BackgroundPreview                                │  │
│  │                  (Value Objects)                              │  │
│  └───────────────────────────────────────────────────────────────┘  │
│                                                                      │
│  IBackgroundProvider (from v0.17.1d)                                 │
└───────┬─────────────────────────────────────────────────────────────┘
        │
        ▼
┌─────────────────────────────────────────────────────────────────────┐
│                      INFRASTRUCTURE LAYER                            │
├─────────────────────────────────────────────────────────────────────┤
│  ┌───────────────────────────────────────────────────────────────┐  │
│  │              BackgroundApplicationService                     │  │
│  │                    (Implementation)                           │  │
│  ├───────────────────────────────────────────────────────────────┤  │
│  │  - _backgroundProvider: IBackgroundProvider                   │  │
│  │  - _itemFactory: IItemFactory                                 │  │
│  │  - _logger: ILogger<BackgroundApplicationService>             │  │
│  └───────────────────────────────────────────────────────────────┘  │
│                                                                      │
│  BackgroundProvider (from v0.17.1d)                                  │
└─────────────────────────────────────────────────────────────────────┘
```

### 3.3 Apply Background Flow

```
┌─────────────────────────────────────────────────────────────────────┐
│                APPLY BACKGROUND TO CHARACTER FLOW                    │
└─────────────────────────────────────────────────────────────────────┘

    ApplyBackgroundToCharacter(character, Background.VillageSmith)
           │
           ▼
┌─────────────────────────────────────────────────────────────────────┐
│                  STEP 1: GET BACKGROUND DEFINITION                   │
├─────────────────────────────────────────────────────────────────────┤
│  var definition = _backgroundProvider.GetBackground(background);    │
│  if (definition == null) return FailedResult("Not found");          │
└─────────────────────────────────────────────────────────────────────┘
           │
           ▼
┌─────────────────────────────────────────────────────────────────────┐
│                  STEP 2: APPLY SKILL GRANTS                          │
├─────────────────────────────────────────────────────────────────────┤
│  For each skillGrant in definition.SkillGrants:                     │
│    1. Get skill by skillGrant.SkillId                               │
│    2. Apply based on GrantType:                                     │
│       - Permanent: character.AddSkillBonus(skillId, amount)         │
│       - Proficiency: character.AddProficiency(skillId)              │
│    3. Track in result.SkillsGranted                                 │
│                                                                      │
│  Village Smith Example:                                              │
│  • Craft +2 (Permanent) → character.Skills["craft"] += 2            │
│  • Might +1 (Permanent) → character.Skills["might"] += 1            │
└─────────────────────────────────────────────────────────────────────┘
           │
           ▼
┌─────────────────────────────────────────────────────────────────────┐
│                  STEP 3: APPLY EQUIPMENT GRANTS                      │
├─────────────────────────────────────────────────────────────────────┤
│  For each equipGrant in definition.EquipmentGrants:                 │
│    1. Create item: _itemFactory.Create(itemId, quantity)            │
│    2. Add to inventory: character.Inventory.Add(item)               │
│    3. If IsEquipped && Slot has value:                              │
│       - character.EquipItem(item, slot)                             │
│    4. Track in result.EquipmentGranted                              │
│                                                                      │
│  Village Smith Example:                                              │
│  • Smith's Hammer ×1 → Create, Add, Equip to MainHand               │
│  • Leather Apron ×1 → Create, Add, Equip to Chest                   │
└─────────────────────────────────────────────────────────────────────┘
           │
           ▼
┌─────────────────────────────────────────────────────────────────────┐
│                  STEP 4: SET CHARACTER BACKGROUND                    │
├─────────────────────────────────────────────────────────────────────┤
│  character.Background = background;                                 │
│  Log: "Applied Village Smith to {CharacterName}"                    │
└─────────────────────────────────────────────────────────────────────┘
           │
           ▼
┌─────────────────────────────────────────────────────────────────────┐
│                  RETURN APPLICATION RESULT                           │
├─────────────────────────────────────────────────────────────────────┤
│  BackgroundApplicationResult {                                      │
│    Success = true,                                                  │
│    BackgroundId = VillageSmith,                                     │
│    SkillsGranted = [(Craft, 2), (Might, 1)],                        │
│    EquipmentGranted = [(smiths-hammer, 1), (leather-apron, 1)],     │
│    Messages = ["Applied Village Smith background successfully"]     │
│  }                                                                  │
└─────────────────────────────────────────────────────────────────────┘
```

### 3.4 Background Preview Flow

```
┌─────────────────────────────────────────────────────────────────────┐
│                  GET BACKGROUND PREVIEW FLOW                         │
└─────────────────────────────────────────────────────────────────────┘

    GetBackgroundPreview(Background.ClanGuard)
           │
           ▼
┌─────────────────────────────────────────────────────────────────────┐
│                  GET DEFINITION FROM PROVIDER                        │
├─────────────────────────────────────────────────────────────────────┤
│  var definition = _backgroundProvider.GetBackground(background);    │
└─────────────────────────────────────────────────────────────────────┘
           │
           ▼
┌─────────────────────────────────────────────────────────────────────┐
│                  BUILD SKILL SUMMARY                                 │
├─────────────────────────────────────────────────────────────────────┤
│  skillSummary = definition.GetSkillGrantSummary();                  │
│  // Result: "combat +2, vigilance +1"                               │
└─────────────────────────────────────────────────────────────────────┘
           │
           ▼
┌─────────────────────────────────────────────────────────────────────┐
│                  BUILD EQUIPMENT SUMMARY                             │
├─────────────────────────────────────────────────────────────────────┤
│  equipSummary = definition.GetEquipmentGrantSummary();              │
│  // Result: "shield (OffHand), spear (MainHand)"                    │
└─────────────────────────────────────────────────────────────────────┘
           │
           ▼
┌─────────────────────────────────────────────────────────────────────┐
│                  RETURN PREVIEW                                      │
├─────────────────────────────────────────────────────────────────────┤
│  BackgroundPreview {                                                │
│    BackgroundId = ClanGuard,                                        │
│    DisplayName = "Clan Guard",                                      │
│    Description = "You stood on the walls...",                       │
│    SkillSummary = "combat +2, vigilance +1",                        │
│    EquipmentSummary = "shield (OffHand), spear (MainHand)",         │
│    NarrativeHookCount = 3                                           │
│  }                                                                  │
└─────────────────────────────────────────────────────────────────────┘
```

### 3.5 Skill Grant Application Decision Tree

```
┌─────────────────────────────────────────────────────────────────────┐
│                SKILL GRANT APPLICATION DECISION                      │
└─────────────────────────────────────────────────────────────────────┘

    Processing BackgroundSkillGrant
           │
           ▼
    ┌──────────────────────┐
    │ What is GrantType?   │
    └──────────┬───────────┘
               │
    ┌──────────┼────────────────────────────────────────┐
    │          │                                        │
    ▼          ▼                                        ▼
┌────────┐ ┌────────────┐                        ┌────────────┐
│Permanent│ │StartingBonus│                       │Proficiency │
└────┬───┘ └─────┬──────┘                        └─────┬──────┘
     │           │                                     │
     ▼           ▼                                     ▼
┌──────────────────────────────────────────────────────────────────┐
│ Add to base   │ Add to starting │ Add skillId to     │
│ skill modifier│ bonus pool      │ proficient skills  │
│               │                 │ (removes -2 penalty)│
└──────────────────────────────────────────────────────────────────┘
     │           │                                     │
     ▼           ▼                                     ▼
┌──────────────────────────────────────────────────────────────────┐
│ Track:        │ Track:          │ Track:             │
│ (craft, +2)   │ (craft, +2,     │ (traps, proficient)│
│               │  starting)      │                    │
└──────────────────────────────────────────────────────────────────┘
```

---

## 4. BackgroundApplicationResult Value Object

### 4.1 Purpose

The `BackgroundApplicationResult` value object captures the outcome of applying a background to a character, including all skills granted, equipment created, and any messages or errors.

### 4.2 Implementation

**File:** `src/Core/RuneAndRust.Application/ValueObjects/BackgroundApplicationResult.cs`

```csharp
namespace RuneAndRust.Application.ValueObjects;

using RuneAndRust.Domain.Enums;

/// <summary>
/// Represents the result of applying a background to a character.
/// </summary>
/// <remarks>
/// <para>
/// BackgroundApplicationResult captures detailed information about what was
/// granted when a background was applied. This enables UI feedback, logging,
/// and character creation summaries.
/// </para>
/// </remarks>
public readonly record struct BackgroundApplicationResult
{
    /// <summary>
    /// Gets whether the background was applied successfully.
    /// </summary>
    public bool Success { get; init; }

    /// <summary>
    /// Gets the background that was applied.
    /// </summary>
    public Background BackgroundId { get; init; }

    /// <summary>
    /// Gets the list of skills granted.
    /// </summary>
    public IReadOnlyList<GrantedSkill> SkillsGranted { get; init; }

    /// <summary>
    /// Gets the list of equipment granted.
    /// </summary>
    public IReadOnlyList<GrantedEquipment> EquipmentGranted { get; init; }

    /// <summary>
    /// Gets informational and error messages from the application process.
    /// </summary>
    public IReadOnlyList<string> Messages { get; init; }

    /// <summary>
    /// Creates a successful application result.
    /// </summary>
    public static BackgroundApplicationResult Succeeded(
        Background backgroundId,
        IReadOnlyList<GrantedSkill> skills,
        IReadOnlyList<GrantedEquipment> equipment,
        string? message = null)
    {
        var messages = new List<string>();
        if (!string.IsNullOrEmpty(message))
            messages.Add(message);

        return new BackgroundApplicationResult
        {
            Success = true,
            BackgroundId = backgroundId,
            SkillsGranted = skills,
            EquipmentGranted = equipment,
            Messages = messages
        };
    }

    /// <summary>
    /// Creates a failed application result.
    /// </summary>
    public static BackgroundApplicationResult Failed(
        Background backgroundId,
        string errorMessage)
    {
        return new BackgroundApplicationResult
        {
            Success = false,
            BackgroundId = backgroundId,
            SkillsGranted = Array.Empty<GrantedSkill>(),
            EquipmentGranted = Array.Empty<GrantedEquipment>(),
            Messages = new[] { errorMessage }
        };
    }

    /// <summary>
    /// Gets a formatted summary of granted skills.
    /// </summary>
    public string GetSkillSummary() =>
        SkillsGranted.Count > 0
            ? string.Join(", ", SkillsGranted.Select(s => s.ToString()))
            : "No skills granted";

    /// <summary>
    /// Gets a formatted summary of granted equipment.
    /// </summary>
    public string GetEquipmentSummary() =>
        EquipmentGranted.Count > 0
            ? string.Join(", ", EquipmentGranted.Select(e => e.ToString()))
            : "No equipment granted";
}

/// <summary>
/// Represents a skill that was granted from a background.
/// </summary>
public readonly record struct GrantedSkill(
    string SkillId,
    int Amount,
    SkillGrantType GrantType)
{
    public override string ToString() =>
        GrantType == SkillGrantType.Proficiency
            ? $"{SkillId} (proficient)"
            : $"{SkillId} +{Amount}";
}

/// <summary>
/// Represents equipment that was granted from a background.
/// </summary>
public readonly record struct GrantedEquipment(
    string ItemId,
    int Quantity,
    bool WasEquipped,
    EquipmentSlot? Slot)
{
    public override string ToString()
    {
        var qty = Quantity > 1 ? $" ×{Quantity}" : "";
        var slot = WasEquipped && Slot.HasValue ? $" ({Slot.Value})" : "";
        return $"{ItemId}{qty}{slot}";
    }
}
```

---

## 5. BackgroundPreview Value Object

### 5.1 Purpose

The `BackgroundPreview` value object provides a summary of a background for UI display, including formatted skill and equipment summaries.

### 5.2 Implementation

**File:** `src/Core/RuneAndRust.Application/ValueObjects/BackgroundPreview.cs`

```csharp
namespace RuneAndRust.Application.ValueObjects;

using RuneAndRust.Domain.Enums;

/// <summary>
/// Provides a preview of a background for character creation UI.
/// </summary>
/// <remarks>
/// BackgroundPreview contains pre-formatted strings suitable for direct
/// display in the character creation interface. It aggregates information
/// from BackgroundDefinition into UI-ready format.
/// </remarks>
public readonly record struct BackgroundPreview
{
    /// <summary>
    /// Gets the background enum value.
    /// </summary>
    public Background BackgroundId { get; init; }

    /// <summary>
    /// Gets the display name (e.g., "Village Smith").
    /// </summary>
    public string DisplayName { get; init; }

    /// <summary>
    /// Gets the full description.
    /// </summary>
    public string Description { get; init; }

    /// <summary>
    /// Gets the selection text for the creation UI.
    /// </summary>
    public string SelectionText { get; init; }

    /// <summary>
    /// Gets the profession before the Great Silence.
    /// </summary>
    public string ProfessionBefore { get; init; }

    /// <summary>
    /// Gets how society views this background.
    /// </summary>
    public string SocialStanding { get; init; }

    /// <summary>
    /// Gets a formatted summary of skill grants (e.g., "Craft +2, Might +1").
    /// </summary>
    public string SkillSummary { get; init; }

    /// <summary>
    /// Gets a formatted summary of equipment grants.
    /// </summary>
    public string EquipmentSummary { get; init; }

    /// <summary>
    /// Gets the number of narrative hooks available.
    /// </summary>
    public int NarrativeHookCount { get; init; }

    /// <summary>
    /// Creates an empty preview for when background is not found.
    /// </summary>
    public static BackgroundPreview Empty(Background backgroundId) =>
        new()
        {
            BackgroundId = backgroundId,
            DisplayName = "Unknown",
            Description = "Background not found",
            SelectionText = string.Empty,
            ProfessionBefore = string.Empty,
            SocialStanding = string.Empty,
            SkillSummary = "None",
            EquipmentSummary = "None",
            NarrativeHookCount = 0
        };
}
```

---

## 6. IBackgroundApplicationService Interface

### 6.1 Purpose

The `IBackgroundApplicationService` interface defines the contract for applying backgrounds to characters and generating previews.

### 6.2 Implementation

**File:** `src/Core/RuneAndRust.Application/Interfaces/IBackgroundApplicationService.cs`

```csharp
namespace RuneAndRust.Application.Interfaces;

using RuneAndRust.Application.ValueObjects;
using RuneAndRust.Domain.Entities;
using RuneAndRust.Domain.Enums;

/// <summary>
/// Provides services for applying backgrounds to characters.
/// </summary>
/// <remarks>
/// <para>
/// IBackgroundApplicationService orchestrates the application of background
/// grants to characters during creation. It coordinates with IBackgroundProvider
/// for data and applies skill/equipment grants to the character.
/// </para>
/// </remarks>
public interface IBackgroundApplicationService
{
    /// <summary>
    /// Applies a background's grants to a character.
    /// </summary>
    /// <param name="character">The character to apply the background to.</param>
    /// <param name="background">The background to apply.</param>
    /// <returns>
    /// A result containing details of what was granted or any errors.
    /// </returns>
    /// <remarks>
    /// This method applies skill grants and equipment grants to the character.
    /// Equipment marked as IsEquipped will be automatically equipped to the
    /// specified slot.
    /// </remarks>
    BackgroundApplicationResult ApplyBackgroundToCharacter(
        PlayerCharacter character,
        Background background);

    /// <summary>
    /// Gets a preview of a background for UI display.
    /// </summary>
    /// <param name="background">The background to preview.</param>
    /// <returns>
    /// A preview containing formatted summaries of the background's grants.
    /// </returns>
    BackgroundPreview GetBackgroundPreview(Background background);

    /// <summary>
    /// Gets previews for all available backgrounds.
    /// </summary>
    /// <returns>A list of previews for all backgrounds.</returns>
    IReadOnlyList<BackgroundPreview> GetAllBackgroundPreviews();

    /// <summary>
    /// Validates that a background can be applied.
    /// </summary>
    /// <param name="background">The background to validate.</param>
    /// <returns>True if the background exists and can be applied.</returns>
    bool CanApplyBackground(Background background);
}
```

---

## 7. BackgroundApplicationService Implementation

### 7.1 Purpose

The `BackgroundApplicationService` class implements the background application logic, coordinating between the provider and character to apply all grants.

### 7.2 Implementation

**File:** `src/Infrastructure/RuneAndRust.Infrastructure/Services/BackgroundApplicationService.cs`

```csharp
namespace RuneAndRust.Infrastructure.Services;

using Microsoft.Extensions.Logging;
using RuneAndRust.Application.Interfaces;
using RuneAndRust.Application.ValueObjects;
using RuneAndRust.Domain.Entities;
using RuneAndRust.Domain.Enums;

/// <summary>
/// Applies backgrounds to characters during creation.
/// </summary>
public class BackgroundApplicationService : IBackgroundApplicationService
{
    private readonly IBackgroundProvider _backgroundProvider;
    private readonly IItemFactory _itemFactory;
    private readonly ILogger<BackgroundApplicationService> _logger;

    public BackgroundApplicationService(
        IBackgroundProvider backgroundProvider,
        IItemFactory itemFactory,
        ILogger<BackgroundApplicationService> logger)
    {
        _backgroundProvider = backgroundProvider;
        _itemFactory = itemFactory;
        _logger = logger;
    }

    /// <inheritdoc />
    public BackgroundApplicationResult ApplyBackgroundToCharacter(
        PlayerCharacter character,
        Background background)
    {
        _logger.LogInformation(
            "Applying background {Background} to character {CharacterName}",
            background, character.Name);

        // Get definition
        var definition = _backgroundProvider.GetBackground(background);
        if (definition == null)
        {
            _logger.LogWarning("Background {Background} not found", background);
            return BackgroundApplicationResult.Failed(
                background,
                $"Background '{background}' not found");
        }

        var grantedSkills = new List<GrantedSkill>();
        var grantedEquipment = new List<GrantedEquipment>();

        // Apply skill grants
        foreach (var skillGrant in definition.SkillGrants)
        {
            ApplySkillGrant(character, skillGrant);
            grantedSkills.Add(new GrantedSkill(
                skillGrant.SkillId,
                skillGrant.BonusAmount,
                skillGrant.GrantType));

            _logger.LogDebug(
                "Applied skill grant: {SkillId} +{Amount} ({Type})",
                skillGrant.SkillId,
                skillGrant.BonusAmount,
                skillGrant.GrantType);
        }

        // Apply equipment grants
        foreach (var equipGrant in definition.EquipmentGrants)
        {
            var wasEquipped = ApplyEquipmentGrant(character, equipGrant);
            grantedEquipment.Add(new GrantedEquipment(
                equipGrant.ItemId,
                equipGrant.Quantity,
                wasEquipped,
                equipGrant.Slot));

            _logger.LogDebug(
                "Applied equipment grant: {ItemId} ×{Qty}, Equipped={Equipped}",
                equipGrant.ItemId,
                equipGrant.Quantity,
                wasEquipped);
        }

        // Set character's background
        character.SetBackground(background);

        _logger.LogInformation(
            "Successfully applied {Background} to {CharacterName}: " +
            "{SkillCount} skills, {EquipCount} equipment items",
            background,
            character.Name,
            grantedSkills.Count,
            grantedEquipment.Count);

        return BackgroundApplicationResult.Succeeded(
            background,
            grantedSkills,
            grantedEquipment,
            $"Applied {definition.DisplayName} background successfully");
    }

    /// <inheritdoc />
    public BackgroundPreview GetBackgroundPreview(Background background)
    {
        var definition = _backgroundProvider.GetBackground(background);
        if (definition == null)
        {
            _logger.LogWarning(
                "Cannot generate preview: Background {Background} not found",
                background);
            return BackgroundPreview.Empty(background);
        }

        return new BackgroundPreview
        {
            BackgroundId = background,
            DisplayName = definition.DisplayName,
            Description = definition.Description,
            SelectionText = definition.SelectionText,
            ProfessionBefore = definition.ProfessionBefore,
            SocialStanding = definition.SocialStanding,
            SkillSummary = definition.GetSkillGrantSummary(),
            EquipmentSummary = definition.GetEquipmentGrantSummary(),
            NarrativeHookCount = definition.NarrativeHooks.Count
        };
    }

    /// <inheritdoc />
    public IReadOnlyList<BackgroundPreview> GetAllBackgroundPreviews()
    {
        var backgrounds = _backgroundProvider.GetAllBackgrounds();
        return backgrounds
            .Select(def => GetBackgroundPreview(def.BackgroundId))
            .ToList();
    }

    /// <inheritdoc />
    public bool CanApplyBackground(Background background) =>
        _backgroundProvider.HasBackground(background);

    /// <summary>
    /// Applies a single skill grant to the character.
    /// </summary>
    private void ApplySkillGrant(
        PlayerCharacter character,
        BackgroundSkillGrant grant)
    {
        switch (grant.GrantType)
        {
            case SkillGrantType.Permanent:
                character.AddSkillBonus(grant.SkillId, grant.BonusAmount, "Background");
                break;
            case SkillGrantType.StartingBonus:
                character.AddStartingSkillBonus(grant.SkillId, grant.BonusAmount);
                break;
            case SkillGrantType.Proficiency:
                character.AddSkillProficiency(grant.SkillId);
                break;
        }
    }

    /// <summary>
    /// Applies a single equipment grant to the character.
    /// </summary>
    /// <returns>True if the item was equipped.</returns>
    private bool ApplyEquipmentGrant(
        PlayerCharacter character,
        BackgroundEquipmentGrant grant)
    {
        var item = _itemFactory.CreateItem(grant.ItemId, grant.Quantity);
        character.Inventory.AddItem(item);

        if (grant.IsEquipped && grant.Slot.HasValue)
        {
            character.EquipItem(item, grant.Slot.Value);
            return true;
        }

        return false;
    }
}
```

---

## 8. Data Model Changes

### 8.1 New Types Summary

| Type                            | Layer       | Category     | Description                   |
| ------------------------------- | ----------- | ------------ | ----------------------------- |
| `BackgroundApplicationResult`   | Application | Value Object | Result of applying background |
| `GrantedSkill`                  | Application | Value Object | Skill that was granted        |
| `GrantedEquipment`              | Application | Value Object | Equipment that was granted    |
| `BackgroundPreview`             | Application | Value Object | Preview for UI display        |
| `IBackgroundApplicationService` | Application | Interface    | Service contract              |
| `BackgroundApplicationService`  | Infra       | Service      | Implementation                |

### 8.2 File Locations

```
src/Core/RuneAndRust.Application/
├── Interfaces/
│   └── IBackgroundApplicationService.cs     ← NEW
└── ValueObjects/
    ├── BackgroundApplicationResult.cs       ← NEW
    └── BackgroundPreview.cs                 ← NEW

src/Infrastructure/RuneAndRust.Infrastructure/
└── Services/
    └── BackgroundApplicationService.cs      ← NEW
```

---

## 9. Logging Specifications

### 9.1 Log Levels by Event

| Event                   | Level       | Template                                    |
| ----------------------- | ----------- | ------------------------------------------- |
| Starting application    | Information | "Applying background {Bg} to {Char}"        |
| Background not found    | Warning     | "Background {Bg} not found"                 |
| Skill grant applied     | Debug       | "Applied skill grant: {Skill} +{Amt}"       |
| Equipment grant applied | Debug       | "Applied equipment grant: {Item}"           |
| Application successful  | Information | "Successfully applied {Bg}: {Skills}, {Eq}" |
| Preview generated       | Debug       | "Generated preview for {Bg}"                |

### 9.2 Structured Logging Templates

```csharp
// Information - Starting application
_logger.LogInformation(
    "Applying background {Background} to character {CharacterName}",
    background, character.Name);

// Debug - Skill grant
_logger.LogDebug(
    "Applied skill grant: {SkillId} +{Amount} ({GrantType})",
    skillId, amount, grantType);

// Information - Success
_logger.LogInformation(
    "Successfully applied {Background} to {CharacterName}: " +
    "{SkillCount} skills, {EquipCount} equipment items",
    background, characterName, skillCount, equipCount);
```

---

## 10. Unit Testing Requirements

### 10.1 Test Count by Feature

| Feature                      | Test Count |
| ---------------------------- | ---------- |
| BackgroundApplicationResult  | ~3         |
| BackgroundPreview            | ~2         |
| BackgroundApplicationService | ~7         |
| **Total**                    | **~12**    |

### 10.2 Test Specifications

#### BackgroundApplicationResultTests.cs

```csharp
[TestFixture]
public class BackgroundApplicationResultTests
{
    [Test]
    public void Succeeded_CreatesSuccessfulResult();

    [Test]
    public void Failed_CreatesFailedResult();

    [Test]
    public void GetSkillSummary_FormatsCorrectly();

    [Test]
    public void GetEquipmentSummary_FormatsCorrectly();
}
```

#### BackgroundPreviewTests.cs

```csharp
[TestFixture]
public class BackgroundPreviewTests
{
    [Test]
    public void Empty_CreatesEmptyPreview();

    [Test]
    public void Properties_SetCorrectly();
}
```

#### BackgroundApplicationServiceTests.cs

```csharp
[TestFixture]
public class BackgroundApplicationServiceTests
{
    [Test]
    public void ApplyBackgroundToCharacter_WithValidBackground_AppliesSkills();

    [Test]
    public void ApplyBackgroundToCharacter_WithValidBackground_AppliesEquipment();

    [Test]
    public void ApplyBackgroundToCharacter_EquipsAutoEquipItems();

    [Test]
    public void ApplyBackgroundToCharacter_WithInvalidBackground_ReturnsFailure();

    [Test]
    public void GetBackgroundPreview_ReturnsCorrectPreview();

    [Test]
    public void GetAllBackgroundPreviews_ReturnsAllSixPreviews();

    [Test]
    public void CanApplyBackground_WithValidBackground_ReturnsTrue();

    [Test]
    public void CanApplyBackground_WithInvalidBackground_ReturnsFalse();
}
```

---

## 11. Use Cases

### UC-001: Apply Background During Creation

**Actor:** Character Creation Service  
**Flow:** Player confirms background → Call ApplyBackgroundToCharacter → Display result summary

### UC-002: Preview Background Before Selection

**Actor:** Background Selection Panel  
**Flow:** Player hovers background → Call GetBackgroundPreview → Display preview

### UC-003: Show All Background Options

**Actor:** Character Creation View  
**Flow:** Enter background step → Call GetAllBackgroundPreviews → Display selection grid

---

## 12. User Stories

### US-001: Apply Background Grants

**As a** player finalizing my background choice  
**I want** all grants applied automatically  
**So that** I don't have to manually add skills and equipment

### US-002: Preview Before Committing

**As a** player considering backgrounds  
**I want** to see a preview of what I'll receive  
**So that** I can make an informed choice

### US-003: See Application Summary

**As a** player after selecting a background  
**I want** to see what was granted  
**So that** I know what my character received

---

## 13. Deliverable Checklist

### Application Layer

- [ ] `IBackgroundApplicationService.cs` interface created
- [ ] `BackgroundApplicationResult.cs` value object created
- [ ] `BackgroundPreview.cs` value object created
- [ ] All types have complete XML documentation

### Infrastructure Layer

- [ ] `BackgroundApplicationService.cs` implementation created
- [ ] Service registered in DI container
- [ ] All types have complete XML documentation

### Testing

- [ ] `BackgroundApplicationResultTests.cs` created
- [ ] `BackgroundPreviewTests.cs` created
- [ ] `BackgroundApplicationServiceTests.cs` created
- [ ] ~12 unit tests passing

---

## 14. Acceptance Criteria

### Functional

- [ ] `ApplyBackgroundToCharacter` applies all skill grants to character
- [ ] `ApplyBackgroundToCharacter` creates and adds all equipment to inventory
- [ ] `ApplyBackgroundToCharacter` auto-equips items marked IsEquipped
- [ ] `ApplyBackgroundToCharacter` sets character's Background property
- [ ] `ApplyBackgroundToCharacter` returns detailed result with grants
- [ ] `GetBackgroundPreview` returns formatted preview for valid background
- [ ] `GetBackgroundPreview` returns empty preview for invalid background
- [ ] `GetAllBackgroundPreviews` returns 6 previews
- [ ] `CanApplyBackground` returns true for valid backgrounds
- [ ] Village Smith application grants Craft +2 and Might +1
- [ ] Clan Guard application equips Shield to OffHand and Spear to MainHand

### Quality

- [ ] Build succeeds with 0 errors and 0 warnings
- [ ] ~12 unit tests pass
- [ ] All public types have XML documentation
- [ ] Service is registered in DI container

---

## 15. Dependencies

### Required from Prior Versions

| Type                       | Location     | Usage                     |
| -------------------------- | ------------ | ------------------------- |
| `IBackgroundProvider`      | v0.17.1d     | Retrieves background data |
| `Background`               | v0.17.1a     | Enum for background ID    |
| `BackgroundDefinition`     | v0.17.1a/b/c | Contains grants           |
| `BackgroundSkillGrant`     | v0.17.1b     | Skill grant data          |
| `BackgroundEquipmentGrant` | v0.17.1c     | Equipment grant data      |
| `SkillGrantType`           | v0.17.1b     | Grant type enum           |

### Provides to v0.17.5

| Type                            | Usage                               |
| ------------------------------- | ----------------------------------- |
| `IBackgroundApplicationService` | Used by character creation workflow |
| `BackgroundPreview`             | Used by UI components               |
| `BackgroundApplicationResult`   | Used for result display             |

---

## 16. Future Considerations

### Deferred to v0.17.5

- **Character Creation Workflow** integration
- **UI components** for background selection
- **Step-by-step creation** flow

### Out of Scope

- Undo/rollback background application
- Background change after creation
- Background prerequisites based on lineage

---

_Document Version: 1.0_  
_Last Updated: 2026-01-27_  
_Author: AI Assistant_
