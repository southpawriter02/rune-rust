# v0.10.3b Changelog: Combo Detection

**Version:** 0.10.3b
**Phase:** Combo System - Combo Detection
**Date:** 2026-01-19
**Status:** Complete

---

## Summary

Implements the combo detection system that monitors ability usage, tracks combo progress, detects combo completion, and applies bonus effects. Builds on the combo definitions from v0.10.3a to provide runtime combo tracking with `ComboProgress`, result DTOs (`ComboResult`, `ComboActionResult`, `ComboHint`), event records, and the full `IComboService` interface with `ComboService` implementation. Enforces target requirements (SameTarget, DifferentTarget, Self) and manages window expiration. Includes 13 unit tests covering all major functionality.

---

## Added

### Application Layer - Tracking

| Class | Properties | Description |
|-------|------------|-------------|
| `ComboProgress` | ComboId, ComboName, TotalSteps, CurrentStep, WindowRemaining, LastTargetId, StartedAt, AllTargetsHit | Tracks in-progress combo state |

**ComboProgress Features:**
- Private constructor with static `Start()` factory method
- Tracks current step progression (1-indexed)
- Maintains window countdown for combo expiration
- Records last target ID for target requirement validation
- Tracks all unique targets hit during combo (for AllHitTargets bonus)

**ComboProgress Methods:**
- `Start(combo, targetId)` - Factory method to begin tracking
- `AdvanceStep(targetId)` - Progress to next step
- `DecrementWindow()` - Reduce remaining turns
- `IsComplete` - Check if all steps completed
- `IsExpired` - Check if window depleted
- `NextStep` - Get next step number
- `GetProgressString()` - Human-readable progress ("2/3 steps")

### Application Layer - DTOs

| Class | Properties | Description |
|-------|------------|-------------|
| `ComboActionResult` | ActionType, ComboId, ComboName, CurrentStep, TotalSteps, FailureReason | Single combo action result |
| `ComboHint` | ComboId, ComboName, NextAbilityId, CurrentStep, TotalSteps, WindowRemaining | UI hint for combo continuation |
| `ComboResult` | Actions, CompletedCombos | Aggregate result from ability processing |

**ComboActionResult Factory Methods:**
- `Started(comboId, name, totalSteps)` - Combo began
- `Progressed(comboId, name, currentStep, totalSteps)` - Step advanced
- `Completed(comboId, name, totalSteps)` - Combo finished
- `Failed(comboId, name, reason)` - Combo failed

**ComboActionType Enum:**
- `Started` - New combo initiated
- `Progressed` - Combo advanced to next step
- `Completed` - All steps completed
- `Failed` - Combo failed (expired or target mismatch)

**ComboHint Computed Properties:**
- `ProgressPercent` - Completion percentage
- `IsUrgent` - True when 1 turn remaining
- `NextStep` - Step number that needs completion
- `FromProgress(progress, nextAbilityId)` - Factory method

**ComboResult Features:**
- `Actions` - List of all combo state changes
- `CompletedCombos` - Full definitions for bonus application
- `HasActions` - Any combo activity occurred
- `HasCompletions` - At least one combo completed
- `StartedCount`, `ProgressedCount`, `CompletedCount`, `FailedCount` - Counts by type
- `GetSummary()` - Human-readable summary
- `GetActionDescriptions()` - List of action descriptions
- `ComboResult.None` - Empty result singleton

### Application Layer - Events

| Event Record | Parameters | Description |
|--------------|------------|-------------|
| `ComboStartedEvent` | CombatantId, ComboId, ComboName, TotalSteps, WindowTurns | Combo tracking began |
| `ComboProgressedEvent` | CombatantId, ComboId, ComboName, CurrentStep, TotalSteps, WindowRemaining | Combo advanced |
| `ComboCompletedEvent` | CombatantId, ComboId, ComboName, BonusEffectsApplied | Combo finished |
| `ComboFailedEvent` | CombatantId, ComboId, ComboName, Reason, StepReached | Combo failed |
| `ComboBonusAppliedEvent` | CombatantId, ComboId, ComboName, EffectType, EffectDescription, TargetId | Bonus effect applied |
| `ComboProgressResetEvent` | CombatantId, CombosCleared | All combos reset |

### Application Layer - Interfaces

| Interface | Methods |
|-----------|---------|
| `IComboService` | OnAbilityUsed, GetActiveProgress, GetAvailableCombos, GetComboHints, TickCombos, ResetProgress, HasActiveProgress, GetCompletedComboCount |

**IComboService Methods:**
- `OnAbilityUsed(user, abilityId, target)` - Process ability for combos, returns `ComboResult`
- `GetActiveProgress(combatant)` - Get all in-progress combos
- `GetAvailableCombos(combatant)` - Get combos available to combatant's class
- `GetComboHints(combatant)` - Get UI hints for continuing combos
- `TickCombos(combatant)` - Decrement windows at turn end
- `ResetProgress(combatant)` - Clear all combo progress
- `HasActiveProgress(combatant)` - Check if any combos in progress
- `GetCompletedComboCount(combatant)` - Get total completed combos

### Application Layer - Services

| Service | Dependencies | Description |
|---------|--------------|-------------|
| `ComboService` | IComboProvider, IBuffDebuffService, IDiceService, IGameEventLogger, ILogger | Full combo detection and bonus application |

**ComboService Features:**
- Scoped service lifetime (per combat session)
- State management via `Dictionary<Guid, List<ComboProgress>>`
- Comprehensive logging with `ILogger<ComboService>`
- Combat event logging with `IGameEventLogger.LogCombat()`
- Region separators following codebase conventions
- XML documentation on all public and private members

**ComboService Processing Flow:**
1. `OnAbilityUsed()` receives ability usage
2. `TryAdvanceActiveCombos()` checks existing progress
3. `TryStartNewCombos()` finds new combo opportunities
4. Target requirements validated (SameTarget, DifferentTarget, Self)
5. Completed combos trigger `ApplyBonusEffects()`
6. `ComboResult` returned with all actions

**Bonus Effect Application:**
- `ExtraDamage` - Rolls dice via `IDiceService`, logs damage
- `DamageMultiplier` - Logs multiplier modifier
- `ApplyStatus` - Calls `IBuffDebuffService.ApplyEffect()`
- `Heal` - Rolls dice via `IDiceService`, heals target
- `ResetCooldown` - Logs cooldown reset
- `RefundResource` - Logs resource refund
- `AreaEffect` - Logs area expansion

**Target Requirement Enforcement:**
- Detects when correct ability used with wrong target
- Creates explicit failure result with descriptive reason
- Removes failed combo from active tracking

### Tests

| Test File | Test Count | Description |
|-----------|------------|-------------|
| `ComboServiceTests.cs` | 13 | Combo detection and service tests |

**Test Coverage:**
- `OnAbilityUsed_WhenAbilityStartsCombo_StartsNewProgress` - Combo initiation
- `OnAbilityUsed_WhenAbilityNotInAnyCombo_ReturnsNoActions` - No combo match
- `OnAbilityUsed_WhenAbilityAdvancesCombo_ProgressesToNextStep` - Step progression
- `OnAbilityUsed_WhenComboCompletes_ReturnsCompletedCombo` - Combo completion
- `OnAbilityUsed_SameTargetRequired_EnforcesSameTarget` - SameTarget validation
- `OnAbilityUsed_DifferentTargetRequired_EnforcesDifferentTarget` - DifferentTarget validation
- `OnAbilityUsed_SelfTargetRequired_EnforcesSelfTarget` - Self validation
- `TickCombos_DecrementsWindowRemaining` - Window countdown
- `TickCombos_WhenWindowExpires_RemovesProgress` - Expiration handling
- `ApplyBonusEffects_ExtraDamage_RollsDamage` - Damage bonus
- `ApplyBonusEffects_ApplyStatus_CallsBuffDebuffService` - Status effect bonus
- `GetComboHints_ReturnsNextAbilityForActiveProgress` - UI hint generation
- `ResetProgress_ClearsAllProgressForCombatant` - Progress clearing

---

## Modified

### Infrastructure Layer - DependencyInjection

| File | Change |
|------|--------|
| `DependencyInjection.cs` | Added `IComboService` scoped registration |

**DI Registration:**
```csharp
// Combo detection system (v0.10.3b)
// Note: IComboProvider is registered in AddInfrastructure as it loads from JSON config
services.AddScoped<IComboService, ComboService>();
```

---

## Architecture

### Combo Detection Flow

```
1. Ability Used
   ↓
2. ComboService.OnAbilityUsed()
   ├── TryAdvanceActiveCombos()
   │   ├── Check each active ComboProgress
   │   ├── Match ability + target requirements
   │   ├── Advance step or fail combo
   │   └── Complete if final step
   │
   └── TryStartNewCombos()
       ├── Query IComboProvider.GetCombosStartingWith()
       ├── Filter by class availability
       ├── Create new ComboProgress
       └── Log ComboStartedEvent
   ↓
3. Apply Bonus Effects (if completed)
   ├── ExtraDamage → IDiceService.Roll()
   ├── ApplyStatus → IBuffDebuffService.ApplyEffect()
   ├── Heal → IDiceService.Roll() + Player.Heal()
   └── Log ComboBonusAppliedEvent
   ↓
4. Return ComboResult
```

### State Management

```
ComboService (Scoped)
├── _activeProgress: Dictionary<Guid, List<ComboProgress>>
│   └── Key: Combatant.Id
│   └── Value: List of in-progress combos
│
└── _completedCounts: Dictionary<Guid, int>
    └── Key: Combatant.Id
    └── Value: Total completed combos
```

### Target Requirement Validation

```
ComboStep.Matches(abilityId, isSameTarget, isSelfTarget)
├── Ability ID must match (case-insensitive)
└── Target requirement must be satisfied:
    ├── Any → Always true
    ├── SameTarget → Previous target == current target
    ├── DifferentTarget → Previous target != current target
    └── Self → Target is null (self-targeted)
```

---

## Dependencies

| Dependency | Usage |
|------------|-------|
| IComboProvider | Get combo definitions (from v0.10.3a) |
| IBuffDebuffService | Apply status effect bonuses |
| IDiceService | Roll dice for damage/healing |
| IGameEventLogger | Log combat events |
| Microsoft.Extensions.Logging | Diagnostic logging |

---

## Breaking Changes

None. This version adds new types without modifying existing APIs.

---

## Migration Notes

No migration required. The combo detection system is additive and integrates with existing ability usage.

**Integration Points:**
- Call `IComboService.OnAbilityUsed()` after ability execution
- Call `IComboService.TickCombos()` at end of turn
- Call `IComboService.ResetProgress()` at combat end
- Use `IComboService.GetComboHints()` for UI display

---

## Next Steps

- **v0.10.3c:** Combo Execution Integration - Wire combo system into combat flow

---

*Document Version: 1.0 | Last Updated: 2026-01-19*
