# v0.17.2e Design Specification: Attribute Provider Service

**Version:** 0.17.2e  
**Phase Name:** Attribute Provider Service  
**Parent Version:** v0.17.2 (Attribute System)  
**Prerequisites:** v0.17.2d Complete (Derived Stat Calculation)  
**Estimated Tests:** ~8 unit tests

---

## Table of Contents

1. [Executive Summary](#1-executive-summary)
2. [Feature Overview](#2-feature-overview)
3. [Architecture Diagrams](#3-architecture-diagrams)
4. [IAttributeProvider Interface](#4-iattributeprovider-interface)
5. [AttributeProvider Implementation](#5-attributeprovider-implementation)
6. [Data Model Changes](#6-data-model-changes)
7. [Configuration File Schemas](#7-configuration-file-schemas)
8. [Logging Specifications](#8-logging-specifications)
9. [Unit Testing Requirements](#9-unit-testing-requirements)
10. [Use Cases](#10-use-cases)
11. [User Stories](#11-user-stories)
12. [Deliverable Checklist](#12-deliverable-checklist)
13. [Acceptance Criteria](#13-acceptance-criteria)
14. [Dependencies](#14-dependencies)
15. [Future Considerations](#15-future-considerations)

---

## 1. Executive Summary

### 1.1 Purpose

This specification defines the `IAttributeProvider` interface and its implementation for loading and providing access to attribute definitions, descriptions, recommended builds, and point-buy configuration. This service acts as the central access point for all attribute-related data.

### 1.2 Key Deliverables

| Category       | Items                |
| -------------- | -------------------- |
| **Interfaces** | `IAttributeProvider` |
| **Services**   | `AttributeProvider`  |
| **Tests**      | ~8 unit tests        |

### 1.3 Architectural Significance

- **Single Source of Truth**: Centralized access to all attribute data
- **Configuration-Driven**: Data loaded from JSON configuration files
- **Caching**: Descriptions and builds cached after initial load
- **Dependency Injection**: Interface enables testability and flexibility

---

## 2. Feature Overview

```
v0.17.2e Attribute Provider Service
├── IAttributeProvider Interface
│   ├── GetAttributeDescription(CoreAttribute): AttributeDescription
│   ├── GetAllAttributeDescriptions(): IReadOnlyList<AttributeDescription>
│   ├── GetRecommendedBuild(string archetypeId): AttributeAllocationState
│   ├── GetPointBuyConfiguration(): PointBuyConfiguration
│   └── GetStartingPoints(string? archetypeId): int
└── AttributeProvider Implementation
    ├── Configuration Loading (attributes.json)
    ├── Description Caching
    ├── Recommended Build Lookup
    └── Point-Buy Config Access
```

### 2.1 Scope Alignment

**In Scope:**

- `IAttributeProvider` interface with 5 methods
- `AttributeProvider` implementation with caching
- Configuration loading from `attributes.json`
- Recommended build lookup by archetype ID
- Point-buy configuration access

**Out of Scope:**

- Allocation service logic → v0.17.2f
- Derived stat calculation → v0.17.2g
- UI integration → v0.17.5

---

## 3. Architecture Diagrams

### 3.1 Attribute Provider Overview

```
┌─────────────────────────────────────────────────────────────────────┐
│                  ATTRIBUTE PROVIDER OVERVIEW                         │
└─────────────────────────────────────────────────────────────────────┘

    Character Creation UI / Allocation Service
           │
           │  Request attribute data
           ▼
┌─────────────────────────────────────────────────────────────────────┐
│                    IAttributeProvider                                │
├─────────────────────────────────────────────────────────────────────┤
│  + GetAttributeDescription(CoreAttribute)                           │
│  + GetAllAttributeDescriptions()                                    │
│  + GetRecommendedBuild(archetypeId)                                 │
│  + GetPointBuyConfiguration()                                       │
│  + GetStartingPoints(archetypeId?)                                  │
└─────────────────────────────────────────────────────────────────────┘
           │
           │  Implementation
           ▼
┌─────────────────────────────────────────────────────────────────────┐
│                    AttributeProvider                                 │
├─────────────────────────────────────────────────────────────────────┤
│  - _descriptions: Dictionary<CoreAttribute, AttributeDescription>   │
│  - _recommendedBuilds: Dictionary<string, AttributeAllocationState> │
│  - _pointBuyConfig: PointBuyConfiguration                           │
│  - _configPath: string                                              │
│  - _logger: ILogger<AttributeProvider>                              │
└─────────────────────────────────────────────────────────────────────┘
           │
           │  Loads from
           ▼
┌─────────────────────────────────────────────────────────────────────┐
│                    config/attributes.json                            │
├─────────────────────────────────────────────────────────────────────┤
│  {                                                                   │
│    "attributes": [...],                                             │
│    "recommendedBuilds": [...],                                      │
│    "pointBuy": {...}                                                │
│  }                                                                   │
└─────────────────────────────────────────────────────────────────────┘
```

### 3.2 Data Flow

```
┌─────────────────────────────────────────────────────────────────────┐
│                       DATA FLOW                                      │
└─────────────────────────────────────────────────────────────────────┘

    Application Startup
           │
           ▼
    ┌──────────────────────────────────────────────────────────────────┐
    │ AttributeProvider Constructor                                    │
    ├──────────────────────────────────────────────────────────────────┤
    │  1. Load attributes.json from config path                        │
    │  2. Parse attribute descriptions into Dictionary                 │
    │  3. Parse recommended builds into Dictionary                     │
    │  4. Parse point-buy configuration                                │
    │  5. Log successful initialization                                │
    └──────────────────────────────────────────────────────────────────┘
           │
           ▼
    Data cached in memory
           │
           ▼
    ┌──────────────────────────────────────────────────────────────────┐
    │ Runtime Requests                                                 │
    ├──────────────────────────────────────────────────────────────────┤
    │  GetAttributeDescription(CoreAttribute.Might)                    │
    │    → Return _descriptions[Might]                                 │
    │                                                                  │
    │  GetRecommendedBuild("warrior")                                  │
    │    → Return _recommendedBuilds["warrior"]                        │
    │                                                                  │
    │  GetStartingPoints("adept")                                      │
    │    → Return 14                                                   │
    └──────────────────────────────────────────────────────────────────┘
```

### 3.3 Method Decision Flow

```
┌─────────────────────────────────────────────────────────────────────┐
│                   METHOD DECISION FLOW                               │
└─────────────────────────────────────────────────────────────────────┘

    GetAttributeDescription(CoreAttribute attribute)
           │
           ▼
    ┌──────────────────────┐
    │ _descriptions        │
    │ contains key?        │
    └──────────┬───────────┘
               │
        ┌──────┴──────┐
       YES            NO
        │              │
        ▼              ▼
    ┌────────────┐  ┌────────────────────────┐
    │ Return     │  │ Throw                  │
    │ cached     │  │ ArgumentException      │
    │ description│  │ "Unknown attribute: X" │
    └────────────┘  └────────────────────────┘

    GetRecommendedBuild(string archetypeId)
           │
           ▼
    ┌──────────────────────┐
    │ Normalize to         │
    │ lowercase            │
    └──────────┬───────────┘
               │
               ▼
    ┌──────────────────────┐
    │ _recommendedBuilds   │
    │ contains key?        │
    └──────────┬───────────┘
               │
        ┌──────┴──────┐
       YES            NO
        │              │
        ▼              ▼
    ┌────────────┐  ┌────────────────────────┐
    │ Return     │  │ Throw                  │
    │ cached     │  │ ArgumentException      │
    │ build      │  │ "Unknown archetype: X" │
    └────────────┘  └────────────────────────┘

    GetStartingPoints(string? archetypeId)
           │
           ▼
    ┌──────────────────────┐
    │ archetypeId == null? │
    └──────────┬───────────┘
               │
        ┌──────┴──────┐
       YES            NO
        │              │
        ▼              ▼
    ┌────────────┐  ┌────────────────────────┐
    │ Return     │  │ Is archetypeId         │
    │ default    │  │ "adept"?               │
    │ (15)       │  └───────────┬────────────┘
    └────────────┘              │
                         ┌──────┴──────┐
                        YES            NO
                         │              │
                         ▼              ▼
                    ┌────────┐    ┌────────┐
                    │Return 14│    │Return 15│
                    └────────┘    └────────┘
```

---

## 4. IAttributeProvider Interface

### 4.1 Purpose

The `IAttributeProvider` interface defines the contract for accessing attribute definitions, descriptions, and point-buy configuration.

### 4.2 Implementation

**File:** `src/Core/RuneAndRust.Application/Interfaces/IAttributeProvider.cs`

```csharp
namespace RuneAndRust.Application.Interfaces;

using RuneAndRust.Domain.Enums;
using RuneAndRust.Domain.ValueObjects;

/// <summary>
/// Provides access to attribute definitions, descriptions, and point-buy configuration.
/// </summary>
/// <remarks>
/// <para>
/// IAttributeProvider is the central service for all attribute-related data access.
/// It loads data from configuration files and caches it for efficient retrieval.
/// </para>
/// <para>
/// This interface supports:
/// - Attribute descriptions for UI display
/// - Recommended builds for Simple mode
/// - Point-buy configuration for Advanced mode
/// </para>
/// </remarks>
public interface IAttributeProvider
{
    /// <summary>
    /// Gets the description for a specific attribute.
    /// </summary>
    /// <param name="attribute">The core attribute to get the description for.</param>
    /// <returns>The attribute description containing display info and relationships.</returns>
    /// <exception cref="ArgumentException">Thrown if the attribute is unknown.</exception>
    AttributeDescription GetAttributeDescription(CoreAttribute attribute);

    /// <summary>
    /// Gets descriptions for all core attributes.
    /// </summary>
    /// <returns>A read-only list of all attribute descriptions.</returns>
    IReadOnlyList<AttributeDescription> GetAllAttributeDescriptions();

    /// <summary>
    /// Gets the recommended attribute build for an archetype.
    /// </summary>
    /// <param name="archetypeId">The archetype ID (e.g., "warrior").</param>
    /// <returns>An allocation state with the recommended attribute values.</returns>
    /// <exception cref="ArgumentException">Thrown if the archetype is unknown.</exception>
    AttributeAllocationState GetRecommendedBuild(string archetypeId);

    /// <summary>
    /// Gets the point-buy configuration for Advanced mode.
    /// </summary>
    /// <returns>The configuration including cost table and constraints.</returns>
    PointBuyConfiguration GetPointBuyConfiguration();

    /// <summary>
    /// Gets the starting points for attribute allocation.
    /// </summary>
    /// <param name="archetypeId">Optional archetype ID. Adept gets 14 points, others get 15.</param>
    /// <returns>The number of starting points (14 for Adept, 15 otherwise).</returns>
    int GetStartingPoints(string? archetypeId = null);
}
```

---

## 5. AttributeProvider Implementation

### 5.1 Purpose

The `AttributeProvider` class implements configuration loading, caching, and data access for attribute definitions.

### 5.2 Implementation

**File:** `src/Infrastructure/RuneAndRust.Infrastructure/Services/AttributeProvider.cs`

```csharp
namespace RuneAndRust.Infrastructure.Services;

using Microsoft.Extensions.Logging;
using RuneAndRust.Application.Interfaces;
using RuneAndRust.Domain.Enums;
using RuneAndRust.Domain.ValueObjects;
using System.Text.Json;

/// <summary>
/// Provides attribute data from configuration files.
/// </summary>
public class AttributeProvider : IAttributeProvider
{
    private readonly Dictionary<CoreAttribute, AttributeDescription> _descriptions;
    private readonly Dictionary<string, AttributeAllocationState> _recommendedBuilds;
    private readonly PointBuyConfiguration _pointBuyConfig;
    private readonly ILogger<AttributeProvider> _logger;

    /// <summary>
    /// Initializes the provider and loads configuration.
    /// </summary>
    public AttributeProvider(
        string configPath,
        ILogger<AttributeProvider> logger)
    {
        _logger = logger;
        _descriptions = new Dictionary<CoreAttribute, AttributeDescription>();
        _recommendedBuilds = new Dictionary<string, AttributeAllocationState>(
            StringComparer.OrdinalIgnoreCase);

        LoadConfiguration(configPath);
        _pointBuyConfig = LoadPointBuyConfiguration(configPath);

        _logger.LogInformation(
            "AttributeProvider initialized with {DescCount} descriptions, " +
            "{BuildCount} recommended builds",
            _descriptions.Count,
            _recommendedBuilds.Count);
    }

    /// <inheritdoc />
    public AttributeDescription GetAttributeDescription(CoreAttribute attribute)
    {
        if (_descriptions.TryGetValue(attribute, out var description))
        {
            _logger.LogDebug("Retrieved description for {Attribute}", attribute);
            return description;
        }

        _logger.LogWarning("Unknown attribute requested: {Attribute}", attribute);
        throw new ArgumentException($"Unknown attribute: {attribute}", nameof(attribute));
    }

    /// <inheritdoc />
    public IReadOnlyList<AttributeDescription> GetAllAttributeDescriptions()
    {
        _logger.LogDebug("Retrieved all {Count} attribute descriptions", _descriptions.Count);
        return _descriptions.Values.ToList().AsReadOnly();
    }

    /// <inheritdoc />
    public AttributeAllocationState GetRecommendedBuild(string archetypeId)
    {
        ArgumentException.ThrowIfNullOrWhiteSpace(archetypeId);

        var normalized = archetypeId.ToLowerInvariant();

        if (_recommendedBuilds.TryGetValue(normalized, out var build))
        {
            _logger.LogDebug("Retrieved recommended build for {Archetype}", archetypeId);
            return build;
        }

        _logger.LogWarning("Unknown archetype requested: {Archetype}", archetypeId);
        throw new ArgumentException($"Unknown archetype: {archetypeId}", nameof(archetypeId));
    }

    /// <inheritdoc />
    public PointBuyConfiguration GetPointBuyConfiguration()
    {
        _logger.LogDebug("Retrieved point-buy configuration");
        return _pointBuyConfig;
    }

    /// <inheritdoc />
    public int GetStartingPoints(string? archetypeId = null)
    {
        if (string.IsNullOrWhiteSpace(archetypeId))
        {
            _logger.LogDebug("Returning default starting points: {Points}",
                _pointBuyConfig.StartingPoints);
            return _pointBuyConfig.StartingPoints;
        }

        var points = _pointBuyConfig.GetStartingPointsForArchetype(archetypeId);
        _logger.LogDebug("Starting points for {Archetype}: {Points}", archetypeId, points);
        return points;
    }

    private void LoadConfiguration(string configPath)
    {
        // Implementation loads and parses attributes.json
        // Populates _descriptions and _recommendedBuilds dictionaries
        _logger.LogDebug("Loading attribute configuration from {Path}", configPath);
    }

    private PointBuyConfiguration LoadPointBuyConfiguration(string configPath)
    {
        // Implementation loads point-buy section from attributes.json
        _logger.LogDebug("Loading point-buy configuration from {Path}", configPath);
        return PointBuyConfiguration.CreateDefault();
    }
}
```

---

## 6. Data Model Changes

### 6.1 New Types Summary

| Type                 | Layer          | Category  | Description                   |
| -------------------- | -------------- | --------- | ----------------------------- |
| `IAttributeProvider` | Application    | Interface | Contract for attribute access |
| `AttributeProvider`  | Infrastructure | Service   | Implementation with caching   |

### 6.2 File Locations

```
src/Core/RuneAndRust.Application/
├── Interfaces/
│   └── IAttributeProvider.cs                ← NEW

src/Infrastructure/RuneAndRust.Infrastructure/
├── Services/
│   └── AttributeProvider.cs                 ← NEW
```

---

## 7. Configuration File Schemas

The provider loads from `config/attributes.json` which was defined in previous phases:

```json
{
    "$schema": "./schemas/attributes.schema.json",
    "attributes": [
        { "attribute": "Might", "displayName": "MIGHT", ... }
    ],
    "recommendedBuilds": [
        { "archetypeId": "warrior", "might": 4, "finesse": 3, ... }
    ],
    "pointBuy": {
        "startingPoints": 15,
        "adeptStartingPoints": 14,
        ...
    }
}
```

---

## 8. Logging Specifications

| Event                 | Level       | Template                                                                           |
| --------------------- | ----------- | ---------------------------------------------------------------------------------- |
| Provider initialized  | Information | "AttributeProvider initialized with {DescCount} descriptions, {BuildCount} builds" |
| Description retrieved | Debug       | "Retrieved description for {Attribute}"                                            |
| Build retrieved       | Debug       | "Retrieved recommended build for {Archetype}"                                      |
| Unknown attribute     | Warning     | "Unknown attribute requested: {Attribute}"                                         |
| Unknown archetype     | Warning     | "Unknown archetype requested: {Archetype}"                                         |
| Config loading        | Debug       | "Loading attribute configuration from {Path}"                                      |

---

## 9. Unit Testing Requirements

### 9.1 Test Count: ~8 tests

```csharp
[TestFixture]
public class AttributeProviderTests
{
    private Mock<ILogger<AttributeProvider>> _loggerMock;
    private IAttributeProvider _provider;

    [SetUp]
    public void Setup()
    {
        _loggerMock = new Mock<ILogger<AttributeProvider>>();
        _provider = CreateTestProvider();
    }

    [Test]
    public void GetAttributeDescription_ValidAttribute_ReturnsDescription()
    {
        var description = _provider.GetAttributeDescription(CoreAttribute.Might);

        description.DisplayName.Should().Be("MIGHT");
        description.Attribute.Should().Be(CoreAttribute.Might);
    }

    [Test]
    public void GetAllAttributeDescriptions_ReturnsFiveDescriptions()
    {
        var descriptions = _provider.GetAllAttributeDescriptions();

        descriptions.Should().HaveCount(5);
    }

    [Test]
    [TestCase("warrior", 4, 3, 2, 2, 4)]
    [TestCase("skirmisher", 3, 4, 3, 2, 3)]
    [TestCase("mystic", 2, 3, 4, 4, 2)]
    [TestCase("adept", 3, 3, 3, 2, 3)]
    public void GetRecommendedBuild_ValidArchetype_ReturnsCorrectValues(
        string archetype, int m, int f, int wi, int wl, int s)
    {
        var build = _provider.GetRecommendedBuild(archetype);

        build.CurrentMight.Should().Be(m);
        build.CurrentFinesse.Should().Be(f);
        build.CurrentWits.Should().Be(wi);
        build.CurrentWill.Should().Be(wl);
        build.CurrentSturdiness.Should().Be(s);
    }

    [Test]
    public void GetRecommendedBuild_UnknownArchetype_ThrowsArgumentException()
    {
        var act = () => _provider.GetRecommendedBuild("unknown");

        act.Should().Throw<ArgumentException>()
           .WithMessage("*Unknown archetype*");
    }

    [Test]
    public void GetStartingPoints_Adept_Returns14()
    {
        var points = _provider.GetStartingPoints("adept");

        points.Should().Be(14);
    }

    [Test]
    public void GetStartingPoints_Warrior_Returns15()
    {
        var points = _provider.GetStartingPoints("warrior");

        points.Should().Be(15);
    }

    [Test]
    public void GetStartingPoints_Null_Returns15()
    {
        var points = _provider.GetStartingPoints(null);

        points.Should().Be(15);
    }

    [Test]
    public void GetPointBuyConfiguration_ReturnsValidConfig()
    {
        var config = _provider.GetPointBuyConfiguration();

        config.StartingPoints.Should().Be(15);
        config.MinAttributeValue.Should().Be(1);
        config.MaxAttributeValue.Should().Be(10);
    }
}
```

---

## 10. Use Cases

| ID     | Use Case                 | Flow                                                       |
| ------ | ------------------------ | ---------------------------------------------------------- |
| UC-001 | Display Attribute Info   | UI → `GetAttributeDescription()` → Display tooltip         |
| UC-002 | Apply Simple Mode        | Select archetype → `GetRecommendedBuild()` → Apply values  |
| UC-003 | Initialize Advanced Mode | Start allocation → `GetPointBuyConfiguration()` → Setup UI |

---

## 11. User Stories

**US-001:** As a developer, I want a single service to access attribute data so I don't duplicate configuration loading.

**US-002:** As a player, I want consistent attribute descriptions across all UI screens.

**US-003:** As a new player choosing Simple mode, I want the correct recommended build applied for my archetype.

---

## 12. Deliverable Checklist

- [x] `IAttributeProvider` interface created with 5 methods
- [x] `AttributeProvider` implementation created
- [x] Configuration loading from `attributes.json`
- [x] Caching of descriptions and builds
- [x] Logging for all operations
- [x] ~8 unit tests implemented and passing (26 tests)
- [x] XML documentation complete

---

## 13. Acceptance Criteria

### Functional

- [x] `GetAttributeDescription()` returns correct data for all 5 attributes
- [x] `GetAllAttributeDescriptions()` returns exactly 5 descriptions
- [x] `GetRecommendedBuild("warrior")` returns M4, F3, Wi2, Wl2, S4
- [x] `GetStartingPoints("adept")` returns 14
- [x] `GetStartingPoints(null)` returns 15
- [x] Unknown archetype throws `ArgumentException`

### Quality

- [x] Build succeeds with 0 errors/warnings
- [x] All ~8 unit tests pass (26 tests passing)
- [x] XML documentation complete

---

## 14. Dependencies

### Required from Previous Phases

| Type                       | Phase    | Usage                  |
| -------------------------- | -------- | ---------------------- |
| `CoreAttribute`            | v0.17.2a | Enum for descriptions  |
| `AttributeDescription`     | v0.17.2a | Return type            |
| `AttributeAllocationState` | v0.17.2b | Return type for builds |
| `PointBuyConfiguration`    | v0.17.2c | Return type for config |

### Provides to Future Phases

| Type                 | Phase    | Usage                            |
| -------------------- | -------- | -------------------------------- |
| `IAttributeProvider` | v0.17.2f | Injected into allocation service |
| `IAttributeProvider` | v0.17.5  | Used by character creation UI    |

---

## 15. Future Considerations

### Deferred to v0.17.2f

- Allocation service that uses this provider

### Deferred to v0.17.5

- UI integration

### Out of Scope for v0.17.2

- Hot-reloading of configuration
- Multiple configuration sources
- Localization of descriptions

---

_Document Version: 1.0_  
_Last Updated: 2025-01-27_
