# v0.18.1 Scope Breakdown: Runic Blight Corruption

## Overview

v0.18.1 implements the **Runic Blight Corruption** system — the near-permanent trauma resource that represents spiritual contamination from heretical power usage. Unlike Psychic Stress, Corruption accumulates over a character's lifetime with almost no recovery options.

---

## Feature Tree

```
v0.18.1 — Runic Blight Corruption
├── Domain Layer
│   ├── CorruptionState (entity)
│   ├── CorruptionThreshold (enum)
│   ├── CorruptionSource (enum)
│   └── TerminalErrorResult (record)
│
├── Application Layer
│   ├── ICorruptionService (interface)
│   └── CorruptionService (implementation)
│
├── Infrastructure Layer
│   └── Database schema extension
│
├── Configuration
│   ├── corruption_sources.json
│   └── corruption_sources.schema.json
│
└── Tests (~15 unit tests)
```

---

## In Scope

### Domain Layer

#### CorruptionThreshold Enum

```csharp
/// <summary>
/// Defines the corruption state tiers based on current Runic Blight level.
/// Higher corruption grants tech bonuses but social penalties.
/// </summary>
public enum CorruptionThreshold
{
    /// <summary>0-20 Corruption: No effects.</summary>
    Clean = 0,

    /// <summary>21-40 Corruption: +1 Tech, -1 Social.</summary>
    Tainted = 1,

    /// <summary>41-60 Corruption: +2 Tech, -2 Social, faction lock.</summary>
    Infected = 2,

    /// <summary>61-80 Corruption: Wild Magic, Machine Affinity trauma.</summary>
    Corrupted = 3,

    /// <summary>81-99 Corruption: NPCs fear character.</summary>
    Terminal = 4,

    /// <summary>100 Corruption: Character lost to Blight.</summary>
    TerminalError = 5
}
```

#### CorruptionSource Enum

```csharp
/// <summary>
/// Categorizes the sources of Runic Blight Corruption.
/// </summary>
public enum CorruptionSource
{
    /// <summary>Standard mystic spellcasting.</summary>
    MysticMagic,

    /// <summary>Heretical ability usage (Berserker, Blót-Priest, etc.).</summary>
    HereticalAbility,

    /// <summary>Glitched artifact interaction.</summary>
    Artifact,

    /// <summary>Blight zone environmental exposure.</summary>
    Environmental,

    /// <summary>Corrupted consumable usage.</summary>
    Consumable,

    /// <summary>Forbidden ritual participation.</summary>
    Ritual,

    /// <summary>Direct Forlorn contact.</summary>
    ForlornContact,

    /// <summary>Blót-Priest Blight Transfer received.</summary>
    BlightTransfer
}
```

#### CorruptionState Entity

```csharp
/// <summary>
/// Represents the persistent Runic Blight Corruption state of a character.
/// Corruption is near-permanent and accumulates over the character's lifetime.
/// </summary>
public sealed class CorruptionState
{
    /// <summary>Character ID this state belongs to.</summary>
    public Guid CharacterId { get; init; }

    /// <summary>Current corruption value (0-100).</summary>
    public int CurrentCorruption { get; private set; }

    /// <summary>Maximum corruption cap.</summary>
    public const int MaxCorruption = 100;

    /// <summary>Whether threshold 25 effect has triggered.</summary>
    public bool Threshold25Triggered { get; private set; }

    /// <summary>Whether threshold 50 effect has triggered.</summary>
    public bool Threshold50Triggered { get; private set; }

    /// <summary>Whether threshold 75 effect has triggered.</summary>
    public bool Threshold75Triggered { get; private set; }

    /// <summary>Gets the current corruption threshold tier.</summary>
    public CorruptionThreshold Threshold => CurrentCorruption switch
    {
        <= 20 => CorruptionThreshold.Clean,
        <= 40 => CorruptionThreshold.Tainted,
        <= 60 => CorruptionThreshold.Infected,
        <= 80 => CorruptionThreshold.Corrupted,
        <= 99 => CorruptionThreshold.Terminal,
        _ => CorruptionThreshold.TerminalError
    };

    /// <summary>Gets the Max HP penalty percentage.</summary>
    public int MaxHpPenaltyPercent => (CurrentCorruption / 10) * 5;

    /// <summary>Gets the Max AP penalty percentage.</summary>
    public int MaxApPenaltyPercent => (CurrentCorruption / 10) * 5;

    /// <summary>Gets the dice penalty on Stress Resolve checks.</summary>
    public int ResolveDicePenalty => CurrentCorruption / 20;

    /// <summary>Gets the Tech check bonus.</summary>
    public int TechBonus => Threshold switch
    {
        CorruptionThreshold.Clean => 0,
        CorruptionThreshold.Tainted => 1,
        CorruptionThreshold.Infected => 2,
        _ => 2 // Corrupted and above
    };

    /// <summary>Gets the Social check penalty.</summary>
    public int SocialPenalty => Threshold switch
    {
        CorruptionThreshold.Clean => 0,
        CorruptionThreshold.Tainted => 1,
        CorruptionThreshold.Infected => 2,
        _ => 2 // Corrupted and above
    };

    /// <summary>Whether faction reputation gains are locked.</summary>
    public bool FactionReputationLocked => CurrentCorruption >= 50;

    /// <summary>Whether character has Terminal Error state.</summary>
    public bool IsTerminalError => CurrentCorruption >= 100;

    /// <summary>
    /// Adds corruption, checking for threshold crossings.
    /// </summary>
    public CorruptionAddResult AddCorruption(int amount, CorruptionSource source)
    {
        var oldValue = CurrentCorruption;
        CurrentCorruption = Math.Min(CurrentCorruption + amount, MaxCorruption);

        var thresholdCrossed = CheckThresholdCrossings(oldValue);

        return new CorruptionAddResult
        {
            PreviousCorruption = oldValue,
            NewCorruption = CurrentCorruption,
            AmountGained = CurrentCorruption - oldValue,
            Source = source,
            ThresholdCrossed = thresholdCrossed,
            IsTerminalError = IsTerminalError
        };
    }

    private int? CheckThresholdCrossings(int oldValue)
    {
        if (oldValue < 25 && CurrentCorruption >= 25 && !Threshold25Triggered)
        {
            Threshold25Triggered = true;
            return 25;
        }
        if (oldValue < 50 && CurrentCorruption >= 50 && !Threshold50Triggered)
        {
            Threshold50Triggered = true;
            return 50;
        }
        if (oldValue < 75 && CurrentCorruption >= 75 && !Threshold75Triggered)
        {
            Threshold75Triggered = true;
            return 75;
        }
        return null;
    }
}
```

#### CorruptionAddResult Record

```csharp
/// <summary>
/// Result of adding corruption to a character.
/// </summary>
public sealed record CorruptionAddResult
{
    /// <summary>Corruption before addition.</summary>
    public int PreviousCorruption { get; init; }

    /// <summary>Corruption after addition.</summary>
    public int NewCorruption { get; init; }

    /// <summary>Actual amount gained.</summary>
    public int AmountGained { get; init; }

    /// <summary>Source of the corruption.</summary>
    public CorruptionSource Source { get; init; }

    /// <summary>Threshold value crossed (null if none).</summary>
    public int? ThresholdCrossed { get; init; }

    /// <summary>Whether Terminal Error triggered.</summary>
    public bool IsTerminalError { get; init; }
}
```

#### TerminalErrorResult Record

```csharp
/// <summary>
/// Result of Terminal Error transformation check.
/// </summary>
public sealed record TerminalErrorResult
{
    /// <summary>Whether the character survived the check.</summary>
    public bool Survived { get; init; }

    /// <summary>Final corruption value (99 if survived).</summary>
    public int FinalCorruption { get; init; }

    /// <summary>Whether character became Forlorn.</summary>
    public bool BecameForlorn { get; init; }

    /// <summary>Number of successes rolled.</summary>
    public int SuccessesRolled { get; init; }

    /// <summary>DC that was required.</summary>
    public int RequiredDc { get; init; }
}
```

### Application Layer

#### ICorruptionService Interface

```csharp
/// <summary>
/// Service for managing Runic Blight Corruption mechanics.
/// </summary>
public interface ICorruptionService
{
    /// <summary>Gets the corruption state for a character.</summary>
    CorruptionState GetCorruptionState(Guid characterId);

    /// <summary>
    /// Adds corruption to a character.
    /// </summary>
    CorruptionAddResult AddCorruption(
        Guid characterId,
        int amount,
        CorruptionSource source);

    /// <summary>
    /// Transfers corruption from one character to another (Blót-Priest).
    /// </summary>
    CorruptionTransferResult TransferCorruption(
        Guid fromCharacterId,
        Guid toCharacterId,
        int amount);

    /// <summary>
    /// Removes corruption (extremely rare recovery methods).
    /// </summary>
    bool RemoveCorruption(Guid characterId, int amount, string reason);

    /// <summary>
    /// Gets the Max HP penalty percentage for a character.
    /// </summary>
    int GetMaxHpPenaltyPercent(Guid characterId);

    /// <summary>
    /// Gets the Max AP penalty percentage for a character.
    /// </summary>
    int GetMaxApPenaltyPercent(Guid characterId);

    /// <summary>
    /// Gets the Resolve dice penalty for stress checks.
    /// </summary>
    int GetResolveDicePenalty(Guid characterId);

    /// <summary>
    /// Gets skill check bonuses/penalties from corruption.
    /// </summary>
    CorruptionSkillModifiers GetSkillModifiers(Guid characterId);

    /// <summary>
    /// Performs Terminal Error transformation check.
    /// </summary>
    TerminalErrorResult PerformTerminalErrorCheck(Guid characterId);
}
```

#### CorruptionTransferResult Record

```csharp
/// <summary>
/// Result of transferring corruption between characters.
/// </summary>
public sealed record CorruptionTransferResult
{
    /// <summary>Whether the transfer succeeded.</summary>
    public bool Success { get; init; }

    /// <summary>Amount actually transferred.</summary>
    public int AmountTransferred { get; init; }

    /// <summary>Source character's new corruption.</summary>
    public int SourceNewCorruption { get; init; }

    /// <summary>Target character's new corruption.</summary>
    public int TargetNewCorruption { get; init; }

    /// <summary>Whether target hit Terminal Error.</summary>
    public bool TargetTerminalError { get; init; }
}
```

#### CorruptionSkillModifiers Record

```csharp
/// <summary>
/// Skill check modifiers from corruption level.
/// </summary>
public sealed record CorruptionSkillModifiers
{
    /// <summary>Bonus to Tech-related checks.</summary>
    public int TechBonus { get; init; }

    /// <summary>Penalty to Social checks.</summary>
    public int SocialPenalty { get; init; }

    /// <summary>Whether faction reputation gains are locked.</summary>
    public bool FactionLocked { get; init; }
}
```

### Infrastructure Layer

#### Database Schema

```sql
-- Corruption state table
CREATE TABLE IF NOT EXISTS character_corruption (
    character_id UUID PRIMARY KEY REFERENCES characters(id) ON DELETE CASCADE,
    current_corruption INT NOT NULL DEFAULT 0
        CONSTRAINT chk_corruption_range CHECK (current_corruption >= 0 AND current_corruption <= 100),
    threshold_25_triggered BOOLEAN NOT NULL DEFAULT false,
    threshold_50_triggered BOOLEAN NOT NULL DEFAULT false,
    threshold_75_triggered BOOLEAN NOT NULL DEFAULT false,
    updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP
);

-- Corruption history for analytics and debugging
CREATE TABLE IF NOT EXISTS corruption_history (
    id SERIAL PRIMARY KEY,
    character_id UUID NOT NULL REFERENCES characters(id) ON DELETE CASCADE,
    amount INT NOT NULL,
    source VARCHAR(50) NOT NULL,
    new_total INT NOT NULL,
    threshold_crossed INT,
    is_transfer BOOLEAN NOT NULL DEFAULT false,
    transfer_target_id UUID REFERENCES characters(id),
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX idx_corruption_history_char ON corruption_history(character_id);
CREATE INDEX idx_corruption_history_time ON corruption_history(created_at);
```

### Configuration

#### corruption_sources.json

```json
{
  "version": "1.0",
  "corruptionSources": {
    "mysticMagic": [
      {
        "id": "standard_spell",
        "name": "Standard Spell",
        "minCorruption": 0,
        "maxCorruption": 2,
        "description": "Low risk casting"
      },
      {
        "id": "powerful_spell",
        "name": "Powerful Spell",
        "minCorruption": 3,
        "maxCorruption": 5,
        "description": "Moderate risk casting"
      },
      {
        "id": "overcasting",
        "name": "Overcasting",
        "minCorruption": 10,
        "maxCorruption": 15,
        "description": "Emergency power surge"
      }
    ],
    "hereticalAbility": [
      {
        "id": "berserker_rage",
        "name": "Berserker Rage Abilities",
        "minCorruption": 2,
        "maxCorruption": 5,
        "description": "Per rage ability use"
      },
      {
        "id": "blot_priest_hp_cast",
        "name": "Sacrificial Casting",
        "corruptionPerHp": 1,
        "description": "1 corruption per HP spent"
      },
      {
        "id": "blot_priest_siphon",
        "name": "Life Siphon",
        "fixedCorruption": 1,
        "description": "Per siphon action"
      },
      {
        "id": "seidkona_divination",
        "name": "Forbidden Divination",
        "minCorruption": 3,
        "maxCorruption": 8,
        "description": "Peering beyond the veil"
      }
    ],
    "environmental": [
      {
        "id": "blight_zone",
        "name": "Blight Zone Exposure",
        "minCorruption": 1,
        "maxCorruption": 3,
        "perExposure": true,
        "description": "Extended Blight presence"
      },
      {
        "id": "forlorn_contact",
        "name": "Forlorn Contact",
        "minCorruption": 5,
        "maxCorruption": 10,
        "description": "Direct horror touch"
      }
    ],
    "items": [
      {
        "id": "glitched_artifact",
        "name": "Glitched Artifact Use",
        "minCorruption": 1,
        "maxCorruption": 5,
        "description": "Per artifact activation"
      },
      {
        "id": "corrupted_consumable",
        "name": "Corrupted Consumable",
        "minCorruption": 2,
        "maxCorruption": 5,
        "description": "Tainted item consumption"
      }
    ]
  },
  "thresholdEffects": {
    "25": {
      "description": "You feel the Blight's touch...",
      "uiWarning": true
    },
    "50": {
      "description": "Human faction reputation gains locked",
      "factionLock": true
    },
    "75": {
      "description": "Acquire [MACHINE AFFINITY] trauma",
      "traumaId": "machine_affinity"
    },
    "100": {
      "description": "Terminal Error - Character transformation",
      "terminalError": true
    }
  },
  "penalties": {
    "maxHpPercent": {
      "formula": "floor(corruption / 10) * 5",
      "description": "5% per 10 corruption"
    },
    "maxApPercent": {
      "formula": "floor(corruption / 10) * 5",
      "description": "5% per 10 corruption"
    },
    "resolveDice": {
      "formula": "floor(corruption / 20)",
      "description": "1 die per 20 corruption"
    }
  }
}
```

---

## Out of Scope

The following are explicitly **not** included in v0.18.1:

| Feature | Deferred To | Reason |
|---------|-------------|--------|
| Stress integration (Resolve penalty application) | v0.18.5 | Integration version |
| Wild Magic system | v0.20.x | Mystic abilities version |
| Machine Affinity trauma definition | v0.18.3 | Trauma system |
| Forlorn conversion mechanics | v0.21.x | Enemy system |
| Recovery methods (purification) | v0.22.x | Quest/ritual system |

---

## Unit Tests (~15 tests)

### CorruptionState Tests

| Test | Description |
|------|-------------|
| `CorruptionState_Threshold_Clean_WhenUnder21` | Verify Clean threshold for 0-20 |
| `CorruptionState_Threshold_Tainted_When21To40` | Verify Tainted threshold |
| `CorruptionState_Threshold_Infected_When41To60` | Verify Infected threshold |
| `CorruptionState_Threshold_Corrupted_When61To80` | Verify Corrupted threshold |
| `CorruptionState_Threshold_Terminal_When81To99` | Verify Terminal threshold |
| `CorruptionState_Threshold_TerminalError_At100` | Verify Terminal Error |
| `CorruptionState_MaxHpPenalty_CalculatesCorrectly` | Verify 5% per 10 formula |
| `CorruptionState_MaxApPenalty_CalculatesCorrectly` | Verify 5% per 10 formula |
| `CorruptionState_ResolvePenalty_CalculatesCorrectly` | Verify 1 die per 20 formula |

### CorruptionService Tests

| Test | Description |
|------|-------------|
| `AddCorruption_ClampsTo100` | Corruption cannot exceed 100 |
| `AddCorruption_DetectsThreshold25` | First crossing of 25 triggers effect |
| `AddCorruption_DetectsThreshold50` | First crossing of 50 triggers effect |
| `AddCorruption_DetectsThreshold75` | First crossing of 75 triggers effect |
| `AddCorruption_ThresholdOnlyTriggersOnce` | Repeat crossings don't re-trigger |
| `TransferCorruption_MovesFromSourceToTarget` | Blight transfer works correctly |
| `TerminalErrorCheck_SurvivedSetsTo99` | Successful check caps at 99 |

---

## Acceptance Criteria

### Functional Requirements

- [ ] Corruption accumulates correctly from all sources
- [ ] Max HP penalty calculated as `floor(Corruption/10) × 5%`
- [ ] Max AP penalty calculated as `floor(Corruption/10) × 5%`
- [ ] Resolve dice penalty calculated as `floor(Corruption/20)`
- [ ] Threshold effects trigger exactly once per threshold
- [ ] Faction reputation locked at 50+ corruption
- [ ] Terminal Error triggers at exactly 100 corruption
- [ ] Blight Transfer correctly moves corruption between characters

### Quality Requirements

- [ ] All public methods have XML documentation
- [ ] Unit test coverage ≥ 90%
- [ ] Corruption values clamped to 0-100 range
- [ ] History logging for all corruption changes

---

## Dependencies

### Requires

| Dependency | Purpose |
|------------|---------|
| Dice System (v0.6.x) | Terminal Error check |
| Attribute System (v0.17.2) | WILL for transformation check |
| Character System | Character data access |

### Provides

| Feature | Consumer |
|---------|----------|
| `CorruptionState` | Resource integration (v0.18.5) |
| `GetResolveDicePenalty` | Stress system penalty |
| HP/AP penalties | Resource calculation |

---

## Changelog

| Version | Date | Changes |
|---------|------|---------|
| 1.0 | 2026-01-17 | Initial scope breakdown |
