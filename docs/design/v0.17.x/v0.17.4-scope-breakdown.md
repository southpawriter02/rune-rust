## v0.17.4 - Specialization System

**Focus:** Specialization definitions, ability tiers, path types (Coherent/Heretical), special resources, and unlock costs

**Source Specification:** [character-creation.md](../../aethelgard/design/01-core/character-creation.md)

### Overview

This version implements the Specialization system that provides tactical identity and a unique ability tree. Each archetype has access to specific specializations, and players select their first specialization for free during character creation. Additional specializations can be unlocked later using Progression Points. Specializations are classified as either Coherent (working within stable reality) or Heretical (interfacing with corrupted Aether).

---

### Deliverables Summary

| Category | Items | Estimated Tests |
|----------|-------|-----------------|
| Enums | 2 | 2 |
| Value Objects | 4 | 5 |
| Entities | 2 | 4 |
| Services | 2 | 4 |
| **Total** | **10** | **~15** |

---

### v0.17.4a - Specialization Enum & Path Types

#### SpecializationPathType Enum
```
SpecializationPathType
├── Coherent - Works within stable reality
├── Heretical - Interfaces with corrupted Aether
```

#### SpecializationId Enum (Partial - All Specializations)
```
SpecializationId
├── // Warrior Specializations
├── Berserkr - Fury-powered damage dealer
├── IronBane - Monster hunter
├── Skjaldmaer - Living shield
├── SkarHorde - Leadership and allies
├── AtgeirWielder - Reach and control
├── GorgeMaw - Devour and consume
├── // Skirmisher Specializations
├── Veidimadr - Hunter and tracker
├── MyrkGengr - Shadow and stealth
├── Strandhogg - Naval raider tactics
├── HlekkrMaster - Chain and restraint
├── // Mystic Specializations
├── Seidkona - Traditional Aether magic
├── EchoCaller - Commune with the dead
├── // Adept Specializations
├── BoneSetter - Healer and medicine
├── JotunReader - Lore and knowledge
├── Skald - Performance and inspiration
├── ScrapTinker - Crafting and gadgets
├── Einbui - Survival and self-reliance
```

**Path Type Classifications:**
| Specialization | Path Type | Notes |
|----------------|-----------|-------|
| Berserkr | Heretical | Rage risks Corruption |
| Iron-Bane | Coherent | Righteous monster hunting |
| Skjaldmaer | Coherent | Protective defense |
| Skar-Horde | Coherent | Leadership and unity |
| Atgeir-Wielder | Coherent | Disciplined reach combat |
| Gorge-Maw | Heretical | Consuming enemies risks Corruption |
| Veiðimaðr | Coherent | Traditional hunting |
| Myrk-gengr | Heretical | Shadow manipulation |
| Strandhögg | Coherent | Tactical raiding |
| Hlekkr-master | Coherent | Control and restraint |
| Seiðkona | Heretical | Traditional Aether manipulation |
| Echo-Caller | Heretical | Communing with the dead |
| Bone-Setter | Coherent | Traditional medicine |
| Jötun-Reader | Coherent | Knowledge and lore |
| Skald | Coherent | Inspiration through song |
| Scrap-Tinker | Coherent | Practical invention |
| Einbúi | Coherent | Self-reliant survival |

**Configuration (`specializations.json` - Path Types):**
```json
{
  "specializations": [
    {
      "specializationId": "Berserkr",
      "pathType": "Heretical",
      "corruptionRisk": "Rage abilities may trigger Corruption gain"
    },
    {
      "specializationId": "Skjaldmaer",
      "pathType": "Coherent",
      "corruptionRisk": null
    }
  ]
}
```

**Unit Tests (~2):**
- [ ] SpecializationPathType enum has 2 values
- [ ] Correct path types assigned to specializations

---

### v0.17.4b - Specialization Definition

#### SpecializationDefinition Entity
```
SpecializationDefinition
├── SpecializationId: SpecializationId enum
├── DisplayName: string
├── Tagline: string
├── Description: string
├── SelectionText: string (flavor for creation UI)
├── ParentArchetype: Archetype
├── PathType: SpecializationPathType
├── SpecialResource: SpecialResourceDefinition?
├── AbilityTiers: List<SpecializationAbilityTier>
├── UnlockCost: int (3 PP for additional specs)
├── TierRequirements: List<TierRequirement>
```

#### SpecialResourceDefinition Value Object
```
SpecialResourceDefinition
├── ResourceId: string
├── ResourceName: string
├── Description: string
├── MaxValue: int
├── StartingValue: int
├── GenerationMethod: string
├── ConsumptionMethod: string
```

**Special Resources by Specialization:**
| Specialization | Resource | Max | Generation |
|----------------|----------|-----|------------|
| Berserkr | Rage | 100 | Gain on hit, gain on damage taken |
| Skjaldmaer | Block Charges | 3 | Restore on rest, abilities |
| Iron-Bane | Righteous Fervor | 50 | Gain on killing Blighted enemies |
| Seiðkona | Aether Resonance | 10 | Accumulates with spellcasting |
| Echo-Caller | Echoes | 5 | Gained from fallen enemies |

**Configuration (`specializations.json` - Definition):**
```json
{
  "specializations": [
    {
      "specializationId": "Berserkr",
      "displayName": "Berserkr",
      "tagline": "Fury Unleashed",
      "description": "The Berserkr channels primal rage into devastating attacks.",
      "selectionText": "Embrace the chaos within. Your fury is a weapon deadlier than any blade.",
      "parentArchetype": "Warrior",
      "pathType": "Heretical",
      "specialResource": {
        "resourceId": "rage",
        "resourceName": "Rage",
        "description": "Accumulated fury that powers devastating abilities",
        "maxValue": 100,
        "startingValue": 0,
        "generationMethod": "Gain 10 Rage when you deal damage, gain 5 Rage when you take damage",
        "consumptionMethod": "Spend to activate Berserkr abilities"
      },
      "unlockCost": 3
    },
    {
      "specializationId": "Skjaldmaer",
      "displayName": "Skjaldmaer",
      "tagline": "The Living Shield",
      "description": "The Skjaldmaer stands between allies and danger, absorbing blows.",
      "selectionText": "None shall fall while I stand. Your shield is the last line between the horror and the innocent.",
      "parentArchetype": "Warrior",
      "pathType": "Coherent",
      "specialResource": {
        "resourceId": "block_charges",
        "resourceName": "Block Charges",
        "description": "Consumable charges for powerful defensive abilities",
        "maxValue": 3,
        "startingValue": 3,
        "generationMethod": "Restore all on rest, restore 1 with Shield Wall",
        "consumptionMethod": "Spend to activate defensive abilities"
      },
      "unlockCost": 3
    }
  ]
}
```

**Unit Tests (~3):**
- [ ] SpecializationDefinition loads from configuration
- [ ] Special resources initialize correctly
- [ ] Parent archetype correctly linked

---

### v0.17.4c - Ability Tiers

#### SpecializationAbilityTier Entity
```
SpecializationAbilityTier
├── Tier: int (1, 2, or 3)
├── Abilities: List<SpecializationAbility>
├── UnlockCost: int (0 for Tier 1, 1 PP for Tier 2, 2 PP for Tier 3)
├── RequiresPreviousTier: bool (true for Tier 2 and 3)
```

#### SpecializationAbility Value Object
```
SpecializationAbility
├── AbilityId: string
├── AbilityName: string
├── AbilityType: AbilityType enum
├── Description: string
├── ResourceCost: int?
├── ResourceType: string?
├── Cooldown: int? (rounds)
├── IsPassive: bool
```

**Tier Structure:**
```
Tier 1 (Free at Selection):
  - 3 abilities unlocked immediately
  - Defines core specialization identity
  - No PP cost

Tier 2 (1 PP each):
  - 3-4 abilities available
  - Requires Tier 1 completion
  - Enhances core abilities

Tier 3 (2 PP each):
  - 2-3 abilities available
  - Requires Tier 2 completion
  - Ultimate/signature abilities
```

**Example: Skjaldmaer Ability Tree:**
| Tier | Ability | Type | Cost | Effect |
|------|---------|------|------|--------|
| 1 | Shield Wall | Active | 1 Block Charge | +4 Defense for 2 rounds, allies behind gain +2 |
| 1 | Guard | Active | — | Redirect attack from ally to self |
| 1 | Stalwart | Passive | — | +2 HP per STURDINESS point |
| 2 | Iron Curtain | Active | 2 Block Charges | Create wall blocking all projectiles |
| 2 | Retaliatory Strike | Active | — | Counterattack on successful block |
| 2 | Unbreakable | Passive | — | Cannot be knocked prone |
| 3 | Last Stand | Active | All Charges | Double HP for 3 rounds, then collapse |
| 3 | Living Fortress | Passive | — | Allies within 2 squares gain Soak +1 |

**Configuration (`specializations.json` - Abilities):**
```json
{
  "specializations": [
    {
      "specializationId": "Skjaldmaer",
      "abilityTiers": [
        {
          "tier": 1,
          "unlockCost": 0,
          "requiresPreviousTier": false,
          "abilities": [
            {
              "abilityId": "shield_wall",
              "abilityName": "Shield Wall",
              "abilityType": "Active",
              "description": "+4 Defense for 2 rounds. Allies behind you gain +2 Defense.",
              "resourceCost": 1,
              "resourceType": "block_charges",
              "cooldown": null,
              "isPassive": false
            },
            {
              "abilityId": "guard",
              "abilityName": "Guard",
              "abilityType": "Active",
              "description": "Redirect an attack from an adjacent ally to yourself.",
              "resourceCost": null,
              "cooldown": 3,
              "isPassive": false
            },
            {
              "abilityId": "stalwart",
              "abilityName": "Stalwart",
              "abilityType": "Passive",
              "description": "+2 maximum HP per point of STURDINESS.",
              "isPassive": true
            }
          ]
        },
        {
          "tier": 2,
          "unlockCost": 1,
          "requiresPreviousTier": true,
          "abilities": [
            {
              "abilityId": "iron_curtain",
              "abilityName": "Iron Curtain",
              "abilityType": "Active",
              "description": "Create a wall that blocks all projectiles for 2 rounds.",
              "resourceCost": 2,
              "resourceType": "block_charges",
              "cooldown": null,
              "isPassive": false
            },
            {
              "abilityId": "retaliatory_strike",
              "abilityName": "Retaliatory Strike",
              "abilityType": "Active",
              "description": "When you successfully block, make a free attack.",
              "cooldown": 2,
              "isPassive": false
            },
            {
              "abilityId": "unbreakable",
              "abilityName": "Unbreakable",
              "abilityType": "Passive",
              "description": "You cannot be knocked prone or pushed.",
              "isPassive": true
            }
          ]
        },
        {
          "tier": 3,
          "unlockCost": 2,
          "requiresPreviousTier": true,
          "abilities": [
            {
              "abilityId": "last_stand",
              "abilityName": "Last Stand",
              "abilityType": "Active",
              "description": "Double your current HP for 3 rounds. At the end, collapse to 1 HP.",
              "resourceCost": 3,
              "resourceType": "block_charges",
              "cooldown": null,
              "isPassive": false
            },
            {
              "abilityId": "living_fortress",
              "abilityName": "Living Fortress",
              "abilityType": "Passive",
              "description": "All allies within 2 squares gain Soak +1.",
              "isPassive": true
            }
          ]
        }
      ]
    }
  ]
}
```

**Unit Tests (~4):**
- [ ] Tier 1 has 0 PP cost
- [ ] Tier 2 requires Tier 1 and costs 1 PP per ability
- [ ] Tier 3 requires Tier 2 and costs 2 PP per ability
- [ ] Abilities correctly associated with tiers

---

### v0.17.4d - Specialization Provider Service

#### ISpecializationProvider Interface
```csharp
public interface ISpecializationProvider
{
    /// <summary>
    /// Gets all specialization definitions.
    /// </summary>
    IReadOnlyList<SpecializationDefinition> GetAllSpecializations();

    /// <summary>
    /// Gets a specific specialization by ID.
    /// </summary>
    SpecializationDefinition? GetSpecialization(SpecializationId specializationId);

    /// <summary>
    /// Gets all specializations available to an archetype.
    /// </summary>
    IReadOnlyList<SpecializationDefinition> GetSpecializationsForArchetype(Archetype archetype);

    /// <summary>
    /// Gets the ability tier for a specialization.
    /// </summary>
    SpecializationAbilityTier? GetAbilityTier(SpecializationId specializationId, int tier);

    /// <summary>
    /// Gets the special resource definition for a specialization.
    /// </summary>
    SpecialResourceDefinition? GetSpecialResource(SpecializationId specializationId);

    /// <summary>
    /// Checks if a specialization is Heretical (Corruption risk).
    /// </summary>
    bool IsHeretical(SpecializationId specializationId);
}
```

**Provider Implementation:**
```csharp
public class SpecializationProvider : ISpecializationProvider
{
    private readonly Dictionary<SpecializationId, SpecializationDefinition> _specializations;

    public SpecializationProvider(IConfiguration configuration)
    {
        _specializations = LoadFromConfiguration(configuration);
    }

    public IReadOnlyList<SpecializationDefinition> GetSpecializationsForArchetype(Archetype archetype)
        => _specializations.Values
            .Where(s => s.ParentArchetype == archetype)
            .ToList();

    public bool IsHeretical(SpecializationId specializationId)
        => _specializations.TryGetValue(specializationId, out var def)
            && def.PathType == SpecializationPathType.Heretical;
}
```

**Unit Tests (~2):**
- [ ] GetSpecializationsForArchetype returns correct specializations
- [ ] IsHeretical correctly identifies Heretical paths

---

### v0.17.4e - Specialization Application Service

#### ISpecializationApplicationService Interface
```csharp
public interface ISpecializationApplicationService
{
    /// <summary>
    /// Applies first specialization during character creation (free).
    /// </summary>
    SpecializationApplicationResult ApplyFirstSpecialization(
        PlayerCharacter character,
        SpecializationId specializationId);

    /// <summary>
    /// Unlocks additional specialization (costs 3 PP).
    /// </summary>
    SpecializationApplicationResult UnlockSpecialization(
        PlayerCharacter character,
        SpecializationId specializationId);

    /// <summary>
    /// Unlocks abilities in a tier (costs PP based on tier).
    /// </summary>
    AbilityUnlockResult UnlockAbilityTier(
        PlayerCharacter character,
        SpecializationId specializationId,
        int tier);

    /// <summary>
    /// Gets available specializations for a character.
    /// </summary>
    IReadOnlyList<SpecializationDefinition> GetAvailableSpecializations(
        PlayerCharacter character);

    /// <summary>
    /// Gets a preview of what the specialization provides.
    /// </summary>
    SpecializationPreview GetSpecializationPreview(
        SpecializationId specializationId);
}
```

#### SpecializationApplicationResult Value Object
```
SpecializationApplicationResult
├── Success: bool
├── AbilitiesGranted: List<string>
├── SpecialResourceInitialized: bool
├── IsHeretical: bool
├── CorruptionWarning: string?
├── Messages: List<string>
```

#### SpecializationPreview Value Object
```
SpecializationPreview
├── DisplayName: string
├── PathType: string
├── SpecialResourceSummary: string?
├── Tier1Abilities: List<string>
├── TotalAbilityCount: int
├── IsHeretical: bool
├── HereticalWarning: string?
```

**Application Logic:**
```
ApplyFirstSpecialization(character, specializationId):
  1. Validate specialization available to character's archetype
  2. Get specialization definition
  3. Set character.PrimarySpecialization
  4. Initialize special resource (if any)
  5. Grant Tier 1 abilities:
     For each ability in tier1:
       - abilityService.GrantAbility(character, ability.AbilityId)
  6. If Heretical:
     - Display Corruption warning
  7. Return result

UnlockAbilityTier(character, specializationId, tier):
  1. Validate character has this specialization
  2. Validate previous tier is unlocked
  3. Calculate PP cost (1 for Tier 2, 2 for Tier 3)
  4. Deduct PP from character
  5. Grant abilities in tier
  6. Return result
```

**Unit Tests (~2):**
- [ ] First specialization is free
- [ ] Additional specializations cost 3 PP

---

### Configuration Files

| File | Purpose |
|------|---------|
| `specializations.json` | Complete specialization definitions with ability trees |

---

### Dependencies

**Requires:**
- v0.17.3: Archetype system (determines available specializations)
- Ability system: For granting abilities
- Progression system: For PP spending

**Provides to:**
- v0.17.5: Specialization step in creation workflow
- Combat system: Specialization abilities
- Progression system: Tier unlock spending

---

### Acceptance Criteria

- [ ] SpecializationPathType enum has 2 values (Coherent, Heretical)
- [ ] Each archetype has correct specializations
- [ ] Warrior has 6 specializations
- [ ] Skirmisher has 4 specializations
- [ ] Mystic has 2 specializations
- [ ] Adept has 5 specializations
- [ ] First specialization is free at creation
- [ ] Additional specializations cost 3 PP
- [ ] Tier 1 abilities (3) are granted at selection
- [ ] Tier 2 abilities require Tier 1 and cost 1 PP each
- [ ] Tier 3 abilities require Tier 2 and cost 2 PP each
- [ ] Special resources initialize correctly
- [ ] Heretical specializations display Corruption warning
- [ ] Path type (Coherent/Heretical) is tracked
- [ ] ~15 unit tests pass
