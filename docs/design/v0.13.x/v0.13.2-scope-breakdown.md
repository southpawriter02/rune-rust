# v0.13.2 Ability Tree UI - Scope Breakdown

**Version:** 0.13.2
**Theme:** Ability Tree UI
**Prerequisites:** v0.13.1 Complete (Boss & Monster UI), v0.10.x Ability Services Complete
**Total Estimated Tests:** ~20 new tests

---

## Executive Summary

The Ability Tree UI version implements the ability tree visualization system that was deferred during v0.10.x development. This includes hierarchical node display, unlock progress indicators, talent point tracking, prerequisite connection lines, and node tooltips. These components visualize the ability tree progression introduced in v0.10.x without introducing any new domain logic or business rules.

The work is divided into **four sub-parts**:

| Part | Name | Focus | Est. Tests |
|------|------|-------|------------|
| v0.13.2a | Tree Visualization | Hierarchical layout, tier columns, visual structure | ~6 |
| v0.13.2b | Node Display & States | Locked/available/unlocked states, node rendering | ~6 |
| v0.13.2c | Prerequisite Lines | Connection lines, satisfied/unsatisfied states | ~4 |
| v0.13.2d | Tooltips & Interaction | Node tooltips, unlock action, talent point display | ~4 |

---

## Feature Analysis & Categorization

### From v0.13.0-overview.md - Ability Tree Display (v0.10.x)

| Feature | Complexity | Dependencies | Assigned Part |
|---------|------------|--------------|---------------|
| Tree Visualization | Medium | IAbilityTreeService | **v0.13.2a** |
| Hierarchical Node Display | Medium | AbilityTreeDefinition | **v0.13.2a** |
| Unlock Progress | Medium | PlayerAbilityProgress | **v0.13.2b** |
| Locked/Unlocked/Available States | Low | Node state data | **v0.13.2b** |
| Talent Point Counter | Low | PlayerAbilityProgress | **v0.13.2d** |
| Prerequisite Lines | Medium | Node prerequisites | **v0.13.2c** |
| Node Tooltips | Medium | AbilityNode details | **v0.13.2d** |

---

## Existing Infrastructure

### From v0.10.x (Required Services)

| Component | Location | Purpose for v0.13.2 |
|-----------|----------|---------------------|
| `IAbilityTreeService` | `Application/Interfaces/IAbilityTreeService.cs` | Retrieve tree definition and player progress |
| `AbilityTreeDefinition` | `Domain/Entities/AbilityTreeDefinition.cs` | Tree structure with nodes and tiers |
| `AbilityNode` | `Domain/Entities/AbilityNode.cs` | Individual node in the tree |
| `PlayerAbilityProgress` | `Domain/Entities/PlayerAbilityProgress.cs` | Player's unlocked nodes and points |
| `NodePrerequisite` | `Domain/ValueObjects/NodePrerequisite.cs` | Prerequisite requirements |

### From v0.7.x-v0.8.x (Existing UI Infrastructure)

| Component | Location | Purpose for v0.13.2 |
|-----------|----------|---------------------|
| `CharacterView` | `Presentation.Tui/Views/CharacterView.cs` | Integration point for ability tree |
| `ITerminalService` | `Presentation.Tui/Services/ITerminalService.cs` | Terminal output abstraction |

---

## Phase Definitions

---

## v0.13.2a: Tree Visualization

[v0.13.2a Design Specification](v0.13.2a-design-specification.md)

### Overview

Implement the ability tree visualization showing the hierarchical structure of ability nodes organized by tiers. The tree displays all nodes in a column-based layout with clear tier separation.

### Scope

**In Scope:**
- Hierarchical tree layout with tier columns
- Visual tree structure rendering
- Tier labels and separators
- Tree header with tree name

**Out of Scope:**
- Node state rendering (v0.13.2b)
- Prerequisite lines (v0.13.2c)
- Tooltips and interaction (v0.13.2d)

### Key Deliverables

| Type | Count | Details |
|------|-------|---------|
| UI Components | 1 | `AbilityTreeView` |
| Renderers | 1 | `TreeLayoutRenderer` |
| View Updates | 1 | `CharacterView` integration |
| Unit Tests | ~6 | Layout, tier, structure tests |

### Data Model Changes

```
NEW: AbilityTreeView (UI Component)
|-- RenderTree(AbilityTreeDefinition): void
|-- RenderTiers(IEnumerable<int>): void
|-- SetTreeHeader(string): void
+-- HandleSelection(int, int): void

NEW: TreeLayoutRenderer (Renderer)
|-- CalculateNodePositions(AbilityTreeDefinition): Dictionary<string, Position>
|-- RenderTierColumn(int, IEnumerable<AbilityNode>): string
|-- GetTierLabel(int): string
+-- GetTreeWidth(): int
```

### User-Facing Changes

**Tree Layout Example:**
```
┌─────────────────────────────────────────────────────────────────────┐
│                      WARRIOR ABILITY TREE                           │
├─────────────────────────────────────────────────────────────────────┤
│                                                                      │
│  TIER 1                    TIER 2                    TIER 3         │
│  ──────                    ──────                    ──────         │
│                                                                      │
│  ┌─────────┐              ┌─────────┐              ┌─────────┐      │
│  │  Power  │              │  Cleave │              │  Whirl  │      │
│  │  Strike │              │         │              │   wind  │      │
│  └─────────┘              └─────────┘              └─────────┘      │
│                                                                      │
│  ┌─────────┐              ┌─────────┐              ┌─────────┐      │
│  │  Iron   │              │  Shield │              │  Last   │      │
│  │   Skin  │              │   Bash  │              │  Stand  │      │
│  └─────────┘              └─────────┘              └─────────┘      │
│                                                                      │
│  ┌─────────┐              ┌─────────┐                               │
│  │ Battle  │              │   War   │                               │
│  │   Cry   │              │   Cry   │                               │
│  └─────────┘              └─────────┘                               │
│                                                                      │
└─────────────────────────────────────────────────────────────────────┘
```

### Acceptance Criteria

- [ ] Tree visualization displays hierarchical structure
- [ ] Tier columns show with clear labels
- [ ] Tree header displays tree name
- [ ] Nodes arranged in correct tier positions
- [ ] Layout handles varying node counts per tier
- [ ] ~6 unit tests pass

---

## v0.13.2b: Node Display & States

[v0.13.2b Design Specification](v0.13.2b-design-specification.md)

### Overview

Implement node state rendering showing locked, available, and unlocked states for each ability node. Nodes display visual indicators based on the player's progress.

### Scope

**In Scope:**
- Locked node state indicator
- Available node state indicator
- Unlocked node state indicator
- Node state color coding
- Progress toward unlocking

**Out of Scope:**
- Tree layout (v0.13.2a)
- Prerequisite lines (v0.13.2c)
- Tooltips (v0.13.2d)

### Key Deliverables

| Type | Count | Details |
|------|-------|---------|
| UI Components | 1 | `TreeNodeRenderer` |
| Renderers | 1 | `NodeStateRenderer` |
| View Updates | 1 | `AbilityTreeView` integration |
| Unit Tests | ~6 | State display, color, indicator tests |

### Data Model Changes

```
NEW: TreeNodeRenderer (UI Component)
|-- RenderNode(AbilityNode, NodeState): void
|-- GetNodeState(AbilityNode, PlayerAbilityProgress): NodeState
|-- SetNodeHighlight(AbilityNode, bool): void
+-- GetNodeBounds(AbilityNode): Rectangle

NEW: NodeStateRenderer (Renderer)
|-- GetStateIndicator(NodeState): string
|-- GetStateColor(NodeState): ConsoleColor
|-- FormatNodeContent(AbilityNode, NodeState): string
+-- GetProgressIndicator(int, int): string
```

### User-Facing Changes

**Node State Indicators:**
```
Legend: [x] Unlocked   ( ) Available   [L] Locked

┌─────────┐              ┌─────────┐              ┌─────────┐
│ [x]Power│              │ [x]Cleave│              │ ( )Whirl│
│  Strike │              │         │              │   wind  │
└─────────┘              └─────────┘              └─────────┘

┌─────────┐              ┌─────────┐              ┌─────────┐
│ [x]Iron │              │ ( )Shield│              │ [L]Last │
│   Skin  │              │   Bash  │              │   Stand │
└─────────┘              └─────────┘              └─────────┘
```

**State Colors:**
- Unlocked: Green with check mark `[x]`
- Available: Yellow with circle `( )`
- Locked: Gray with lock `[L]`

### Acceptance Criteria

- [x] Unlocked nodes show check mark indicator
- [x] Available nodes show circle indicator
- [x] Locked nodes show lock indicator
- [x] Node colors match state
- [x] State indicators render correctly
- [x] ~33 unit tests pass (NodeStateRendererTests: 18, TreeNodeRendererTests: 15)


---

## v0.13.2c: Prerequisite Lines

[v0.13.2c Design Specification](v0.13.2c-design-specification.md)

### Overview

Implement prerequisite connection lines between nodes showing dependencies. Lines indicate whether prerequisites are satisfied or unsatisfied with different visual states.

### Scope

**In Scope:**
- Visual connections between dependent nodes
- Satisfied prerequisite line state
- Unsatisfied prerequisite line state
- Line routing between tiers

**Out of Scope:**
- Tree layout (v0.13.2a)
- Node state rendering (v0.13.2b)
- Tooltips (v0.13.2d)

### Key Deliverables

| Type | Count | Details |
|------|-------|---------|
| UI Components | 1 | `PrerequisiteLines` |
| Renderers | 1 | `LineRenderer` |
| View Updates | 1 | `AbilityTreeView` integration |
| Unit Tests | ~4 | Line rendering, state tests |

### Data Model Changes

```
NEW: PrerequisiteLines (UI Component)
|-- RenderConnections(AbilityTreeDefinition, PlayerAbilityProgress): void
|-- GetLineState(NodePrerequisite, PlayerAbilityProgress): LineState
|-- DrawLine(Position, Position, LineState): void
+-- ClearLines(): void

NEW: LineRenderer (Renderer)
|-- GetLineCharacter(Direction): char
|-- GetLineColor(LineState): ConsoleColor
|-- CalculatePath(Position, Position): IEnumerable<Position>
+-- FormatConnectionPoint(Direction): string
```

### User-Facing Changes

**Prerequisite Lines Example:**
```
┌─────────┐              ┌─────────┐              ┌─────────┐
│ [x]Power│--------------│ [x]Cleave│--------------│ ( )Whirl│
│  Strike │              │         │              │   wind  │
└─────────┘              └─────────┘              └─────────┘
     │                        │                        │
     │                        │                        │
┌─────────┐              ┌─────────┐              ┌─────────┐
│ [x]Iron │--------------│ ( )Shield│- - - - - - -│ [L]Last │
│   Skin  │              │   Bash  │              │   Stand │
└─────────┘              └─────────┘              └─────────┘

Line States:
  ────────── Satisfied (solid line)
  - - - - -  Unsatisfied (dashed line)
```

### Acceptance Criteria

- [x] Prerequisite lines connect dependent nodes
- [x] Satisfied prerequisites show solid lines
- [x] Unsatisfied prerequisites show dashed lines
- [x] Line colors indicate state
- [x] ~4 unit tests pass (34 tests implemented)

---

## v0.13.2d: Tooltips & Interaction

[v0.13.2d Design Specification](v0.13.2d-design-specification.md)

### Overview

Implement node tooltips showing ability details on selection, the unlock action for available nodes, and talent point display showing available and spent points.

### Scope

**In Scope:**
- Node tooltips with ability details
- Requirements display in tooltip
- Unlock action for available nodes
- Talent point counter (available/spent)
- Node selection handling

**Out of Scope:**
- Tree layout (v0.13.2a)
- Node state rendering (v0.13.2b)
- Prerequisite lines (v0.13.2c)

### Key Deliverables

| Type | Count | Details |
|------|-------|---------|
| UI Components | 2 | `NodeTooltip`, `TalentPointDisplay` |
| Renderers | 1 | `TooltipRenderer` |
| Commands | 1 | `AbilityTreeCommand` |
| View Updates | 1 | `AbilityTreeView` integration |
| Unit Tests | ~4 | Tooltip, unlock, point display tests |

### Data Model Changes

```
NEW: NodeTooltip (UI Component)
|-- ShowTooltip(AbilityNode, NodeState): void
|-- HideTooltip(): void
|-- ShowRequirements(IEnumerable<NodePrerequisite>): void
+-- ShowUnlockPrompt(AbilityNode): void

NEW: TalentPointDisplay (UI Component)
|-- RenderPoints(int, int): void
|-- UpdateAvailable(int): void
+-- AnimatePointSpend(): void

NEW: TooltipRenderer (Renderer)
|-- FormatAbilityDetails(AbilityNode): string
|-- FormatRequirements(IEnumerable<NodePrerequisite>, PlayerAbilityProgress): string
|-- FormatCost(int): string
+-- GetTooltipWidth(): int
```

### User-Facing Changes

**Talent Point Display:**
```
Talent Points: 3 Available | 12 Spent
```

**Node Tooltip Example:**
```
┌─────────────────────────────────────────────┐
│             WHIRLWIND                        │
├─────────────────────────────────────────────┤
│ Tier 3 | Cost: 2 points                     │
├─────────────────────────────────────────────┤
│ Spin in a deadly arc, dealing 150% weapon   │
│ damage to all adjacent enemies.             │
├─────────────────────────────────────────────┤
│ Cooldown: 4 turns                           │
│ Resource: 25 Rage                           │
├─────────────────────────────────────────────┤
│ Prerequisites:                              │
│ [x] Cleave (Tier 2)                         │
│ [x] 8 points spent in tree                  │
├─────────────────────────────────────────────┤
│ Status: AVAILABLE - Press [U] to unlock     │
└─────────────────────────────────────────────┘
```

**Unlock Confirmation:**
```
Unlock WHIRLWIND for 2 talent points?
[Y] Yes   [N] No
```

### Acceptance Criteria

- [x] Talent point counter shows available/spent
- [x] Node tooltips show on selection
- [x] Ability details display in tooltip
- [x] Requirements display with satisfaction status
- [x] Unlock action works for available nodes
- [x] Unlock confirmation shows cost
- [x] ~4 unit tests pass (29 tests)

---

## Dependencies & Prerequisites

```
v0.10.x (Advanced Combat & Abilities) - REQUIRED
    |
    |-- v0.10.x: Ability Trees ─────────────────────┐
    |       Provides: IAbilityTreeService            |
    |       Provides: AbilityTreeDefinition          |
    |       Provides: AbilityNode                    |
    |       Provides: PlayerAbilityProgress          |
    +       Provides: NodePrerequisite               |
                                                     |
                                    v
v0.13.2 (Ability Tree UI)
    |
    |-- v0.13.2a: Tree Visualization ────────────────┐
    |       Dependencies: IAbilityTreeService        |
    |       Provides: AbilityTreeView                |
    |                                                |
    |-- v0.13.2b: Node Display & States ─────────────┤
    |       Dependencies: v0.13.2a                   |
    |       Provides: TreeNodeRenderer               |
    |                                                |
    |-- v0.13.2c: Prerequisite Lines ────────────────┤
    |       Dependencies: v0.13.2a, v0.13.2b         |
    |       Provides: PrerequisiteLines              |
    |                                                |
    +-- v0.13.2d: Tooltips & Interaction ────────────┘
            Dependencies: v0.13.2a, v0.13.2b
            Provides: NodeTooltip, TalentPointDisplay,
                      AbilityTreeCommand
```

---

## Estimated Effort Summary

| Part | New Files | Modified Files | Est. Tests | Complexity |
|------|-----------|----------------|------------|------------|
| v0.13.2a | ~3 | ~1 | ~6 | Medium-High |
| v0.13.2b | ~3 | ~1 | ~6 | Medium |
| v0.13.2c | ~3 | ~1 | ~4 | Medium |
| v0.13.2d | ~4 | ~1 | ~4 | Medium |
| **Total** | **~13** | **~4** | **~20** | |

---

## Risk Assessment

| Risk | Impact | Probability | Mitigation |
|------|--------|-------------|------------|
| Tree layout complexity for large trees | Medium | Medium | Implement scrolling, limit visible tiers |
| Line routing collisions | Low | Medium | Simple horizontal routing between tiers |
| Node selection in TUI | Low | Low | Use arrow keys and number shortcuts |
| Tooltip positioning near edges | Low | Medium | Adjust tooltip position dynamically |

---

## Design Decisions (Confirmed)

### Tree Visualization

| Decision | Value | Notes |
|----------|-------|-------|
| **Layout** | Column-based by tier | Clear tier separation |
| **Tier Labels** | `TIER #` header | Numbered tier labels |
| **Node Size** | 9x3 characters | Consistent node boxes |
| **Tree Width** | Dynamic | Based on max nodes per tier |

### Node States

| Decision | Value | Notes |
|----------|-------|-------|
| **Unlocked Indicator** | `[x]` | Green, check mark |
| **Available Indicator** | `( )` | Yellow, open circle |
| **Locked Indicator** | `[L]` | Gray, lock symbol |
| **Selection** | Arrow keys + Enter | Standard TUI navigation |

### Prerequisite Lines

| Decision | Value | Notes |
|----------|-------|-------|
| **Satisfied Line** | `──────────` | Solid horizontal line |
| **Unsatisfied Line** | `- - - - -` | Dashed horizontal line |
| **Satisfied Color** | Green | Matches unlocked state |
| **Unsatisfied Color** | Gray | Matches locked state |

### Tooltips & Interaction

| Decision | Value | Notes |
|----------|-------|-------|
| **Tooltip Trigger** | Selection (Enter) | Not hover (TUI limitation) |
| **Unlock Key** | `[U]` | Clear unlock action |
| **Point Format** | `# Available \| # Spent` | Clear point status |
| **Confirmation** | `[Y]/[N]` prompt | Prevent accidental unlocks |

---

## Next Steps

1. **Review & Approve** - Confirm scope breakdown
2. **v0.13.2a Design Spec** - Create detailed design for Tree Visualization
3. **v0.13.2a Implementation** - Build AbilityTreeView, TreeLayoutRenderer
4. **v0.13.2b Design Spec** - Create detailed design for Node Display & States
5. **v0.13.2b Implementation** - Build TreeNodeRenderer, NodeStateRenderer
6. **v0.13.2c Design Spec** - Create detailed design for Prerequisite Lines
7. **v0.13.2c Implementation** - Build PrerequisiteLines, LineRenderer
8. **v0.13.2d Design Spec** - Create detailed design for Tooltips & Interaction
9. **v0.13.2d Implementation** - Build NodeTooltip, TalentPointDisplay, AbilityTreeCommand

---

*This scope breakdown provides a structured approach to implementing v0.13.2 Ability Tree UI. Each sub-part builds incrementally, with v0.13.2a establishing the layout, v0.13.2b adding state rendering, v0.13.2c adding prerequisite visualization, and v0.13.2d completing interaction features. All sub-parts integrate with the CharacterView.*
