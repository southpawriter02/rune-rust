# v0.17.1c Design Specification: Background Equipment Grants

**Version:** 0.17.1c  
**Phase Name:** Background Equipment Grants  
**Parent Version:** v0.17.1 (Background System)  
**Prerequisites:** v0.17.1b Complete (Skill Grants)  
**Estimated Tests:** ~8 unit tests

---

## Table of Contents

1. [Executive Summary](#1-executive-summary)
2. [Feature Overview](#2-feature-overview)
3. [Architecture Diagrams](#3-architecture-diagrams)
4. [BackgroundEquipmentGrant Value Object](#4-backgroundequipmentgrant-value-object)
5. [BackgroundDefinition Extension](#5-backgrounddefinition-extension)
6. [Data Model Changes](#6-data-model-changes)
7. [Configuration File Schema Updates](#7-configuration-file-schema-updates)
8. [Logging Specifications](#8-logging-specifications)
9. [Unit Testing Requirements](#9-unit-testing-requirements)
10. [Use Cases](#10-use-cases)
11. [User Stories](#11-user-stories)
12. [Deliverable Checklist](#12-deliverable-checklist)
13. [Acceptance Criteria](#13-acceptance-criteria)
14. [Dependencies](#14-dependencies)
15. [Future Considerations](#15-future-considerations)

---

## 1. Executive Summary

### 1.1 Purpose

This specification defines the equipment grant system for backgrounds, extending the `BackgroundDefinition` entity to include starting items. Equipment grants represent tools, supplies, and gear accumulated during the character's pre-Silence profession.

Each background provides profession-appropriate starting equipment:

- **Village Smith** — Smith's Hammer (equipped), Leather Apron (equipped)
- **Traveling Healer** — Healer's Kit, Bandages ×5
- **Ruin Delver** — Lantern, Rope, Lockpicks
- **Clan Guard** — Shield (equipped), Spear (equipped)
- **Wandering Skald** — Instrument, Journal
- **Outcast Scavenger** — Rations ×3, Travel Cloak

This phase establishes the `BackgroundEquipmentGrant` value object that defines starting items with quantity and auto-equip support.

### 1.2 Key Deliverables

| Category          | Items                                                          |
| ----------------- | -------------------------------------------------------------- |
| **Value Objects** | `BackgroundEquipmentGrant`                                     |
| **Entity Update** | `BackgroundDefinition` extended with `EquipmentGrants`         |
| **Configuration** | `backgrounds.json` extended with equipment grants section      |
| **Schema Update** | `backgrounds.schema.json` extended with equipment grant schema |
| **Tests**         | ~8 unit tests                                                  |

### 1.3 Architectural Significance

This version extends the **Background Pattern** with equipment functionality:

- **Item Grant Pattern**: Equipment grants specify item ID, quantity, and equip state
- **Auto-Equip Support**: Items can be flagged to auto-equip to specific slots
- **Quantity System**: Consumables support quantity > 1 (e.g., Bandages ×5)
- **Configuration-Driven**: Equipment grants defined in JSON for easy customization
- **Profession-Thematic**: Each background's items reflect their pre-Silence work

---

## 2. Feature Overview

```
v0.17.1c Background Equipment Grants
├── BackgroundEquipmentGrant Value Object
│   ├── ItemId: string (kebab-case item identifier)
│   ├── Quantity: int (number of items, default 1)
│   ├── IsEquipped: bool (auto-equip on creation)
│   └── Slot: EquipmentSlot? (target slot if equipped)
└── BackgroundDefinition Extension
    └── EquipmentGrants: IReadOnlyList<BackgroundEquipmentGrant>
```

### 2.1 Scope Alignment

**In Scope:**

- `BackgroundEquipmentGrant` value object with item/quantity/equip data
- Extension of `BackgroundDefinition` entity with `EquipmentGrants` property
- Configuration schema updates for equipment grants section
- Equipment grant data for all 6 backgrounds
- Auto-equip logic hooks for equipped items
- Quantity support for stackable items

**Out of Scope:**

- BackgroundProvider service → v0.17.1d
- BackgroundApplicationService → v0.17.1e
- Actual item creation/inventory logic → existing item system
- Item definition validation → assumes items exist
- Character creation workflow integration → v0.17.5

---

## 3. Architecture Diagrams

### 3.1 Equipment Grant System Overview

```
┌─────────────────────────────────────────────────────────────────────┐
│                 EQUIPMENT GRANT SYSTEM OVERVIEW                      │
└─────────────────────────────────────────────────────────────────────┘

    BackgroundDefinition (from v0.17.1a/b)
           │
           │  Contains equipment grants
           ▼
┌─────────────────────────────────────────────────────────────────────┐
│                  BackgroundEquipmentGrant                            │
├─────────────────────────────────────────────────────────────────────┤
│  - ItemId: string          (e.g., "smiths-hammer", "healers-kit")   │
│  - Quantity: int           (1 for tools, 3-5 for consumables)       │
│  - IsEquipped: bool        (true = auto-equip at creation)          │
│  - Slot: EquipmentSlot?    (MainHand, OffHand, Chest, etc.)         │
└─────────────────────────────────────────────────────────────────────┘
           │
           │  References existing enum
           ▼
┌─────────────────────────────────────────────────────────────────────┐
│                     EquipmentSlot (Existing)                         │
├─────────────────────────────────────────────────────────────────────┤
│  MainHand, OffHand, Head, Chest, Hands, Feet, Accessory             │
└─────────────────────────────────────────────────────────────────────┘
```

### 3.2 Layer Diagram

```
┌─────────────────────────────────────────────────────────────────────┐
│                        PRESENTATION LAYER                            │
├─────────────────────────────────────────────────────────────────────┤
│  CharacterCreationView (v0.17.5)                                     │
│  └── Displays starting equipment during background selection         │
│                                                                      │
│  InventoryView                                                        │
│  └── Shows items granted by background with source label             │
└───────┬─────────────────────────────────────────────────────────────┘
        │
        ▼
┌─────────────────────────────────────────────────────────────────────┐
│                       APPLICATION LAYER                              │
├─────────────────────────────────────────────────────────────────────┤
│  IBackgroundApplicationService (v0.17.1e)                            │
│  └── Creates items and adds to inventory during creation             │
│                                                                      │
│  BackgroundPreview                                                   │
│  └── Generates equipment list preview for UI                         │
└───────┬─────────────────────────────────────────────────────────────┘
        │
        ▼
┌─────────────────────────────────────────────────────────────────────┐
│                         DOMAIN LAYER                                 │
├─────────────────────────────────────────────────────────────────────┤
│  ┌────────────────────────────────────────────────────────────────┐ │
│  │                 BackgroundEquipmentGrant                       │ │
│  │                    (Value Object)                              │ │
│  ├────────────────────────────────────────────────────────────────┤ │
│  │ ItemId: string                                                 │ │
│  │ Quantity: int                                                  │ │
│  │ IsEquipped: bool                                               │ │
│  │ Slot: EquipmentSlot?                                           │ │
│  └────────────────────────────────────────────────────────────────┘ │
│                                                                      │
│  ┌────────────────────────────────────────────────────────────────┐ │
│  │                    BackgroundDefinition                        │ │
│  │                    (Extended from v0.17.1b)                    │ │
│  ├────────────────────────────────────────────────────────────────┤ │
│  │ + EquipmentGrants: IReadOnlyList<BackgroundEquipmentGrant>     │ │
│  │ + HasEquipmentGrants(): bool                                   │ │
│  │ + GetEquippedItems(): IEnumerable<BackgroundEquipmentGrant>    │ │
│  │ + GetInventoryItems(): IEnumerable<BackgroundEquipmentGrant>   │ │
│  │ + GetEquipmentGrantSummary(): string                           │ │
│  └────────────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────────────┘
```

### 3.3 Equipment Grant Application Flow

```
┌─────────────────────────────────────────────────────────────────────┐
│                EQUIPMENT GRANT APPLICATION FLOW                      │
└─────────────────────────────────────────────────────────────────────┘

    Player Selects Background (e.g., Clan Guard)
           │
           ▼
┌─────────────────────────────────────────────────────────────────────┐
│               GET EQUIPMENT GRANTS FROM DEFINITION                   │
├─────────────────────────────────────────────────────────────────────┤
│  Clan Guard Equipment Grants:                                       │
│  ┌────────────────────────────────────────────────────────────────┐ │
│  │  { ItemId: "shield", Quantity: 1, IsEquipped: true,            │ │
│  │    Slot: OffHand }                                             │ │
│  │  { ItemId: "spear", Quantity: 1, IsEquipped: true,             │ │
│  │    Slot: MainHand }                                            │ │
│  └────────────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────────────┘
           │
           ▼
┌─────────────────────────────────────────────────────────────────────┐
│                  PROCESS EACH EQUIPMENT GRANT                        │
├─────────────────────────────────────────────────────────────────────┤
│  For each grant in EquipmentGrants:                                 │
│                                                                      │
│    ┌──────────────────────────────────────────────────────────────┐ │
│    │ 1. Create item instance by ItemId                            │ │
│    │ 2. Set Quantity on item                                      │ │
│    │ 3. Add to character inventory                                │ │
│    └──────────────────────────────────────────────────────────────┘ │
│                     │                                               │
│                     ▼                                               │
│    ┌──────────────────────┐                                         │
│    │ IsEquipped == true?  │                                         │
│    └──────────┬───────────┘                                         │
│         ┌─────┴─────┐                                               │
│        YES          NO                                              │
│         │            │                                              │
│         ▼            ▼                                              │
│    ┌─────────────────────┐  ┌─────────────────────────────────┐    │
│    │ Equip to Slot       │  │ Leave in inventory              │    │
│    │ (MainHand, OffHand) │  │ (Consumables, tools)            │    │
│    └─────────────────────┘  └─────────────────────────────────┘    │
└─────────────────────────────────────────────────────────────────────┘
           │
           ▼
┌─────────────────────────────────────────────────────────────────────┐
│                  RESULT: CLAN GUARD STARTING GEAR                    │
├─────────────────────────────────────────────────────────────────────┤
│  Equipment Slots:                                                   │
│  • MainHand: Spear                                                  │
│  • OffHand: Shield                                                  │
│                                                                      │
│  Displayed in character sheet as:                                   │
│  "Starting Equipment: Spear, Shield (from Clan Guard)"              │
└─────────────────────────────────────────────────────────────────────┘
```

### 3.4 Equipment Grant Comparison Matrix

```
┌─────────────────────────────────────────────────────────────────────┐
│               BACKGROUND EQUIPMENT GRANT MATRIX                      │
└─────────────────────────────────────────────────────────────────────┘

    ┌─────────────────┬────────────────────┬──────────┬─────────────┐
    │    Background   │   Item             │ Quantity │ Auto-Equip  │
    ├─────────────────┼────────────────────┼──────────┼─────────────┤
    │  Village Smith  │   Smith's Hammer   │    1     │ MainHand    │
    │                 │   Leather Apron    │    1     │ Chest       │
    ├─────────────────┼────────────────────┼──────────┼─────────────┤
    │Traveling Healer │   Healer's Kit     │    1     │ No          │
    │                 │   Bandages         │    5     │ No          │
    ├─────────────────┼────────────────────┼──────────┼─────────────┤
    │   Ruin Delver   │   Lantern          │    1     │ No          │
    │                 │   Rope             │    1     │ No          │
    │                 │   Lockpicks        │    1     │ No          │
    ├─────────────────┼────────────────────┼──────────┼─────────────┤
    │   Clan Guard    │   Shield           │    1     │ OffHand     │
    │                 │   Spear            │    1     │ MainHand    │
    ├─────────────────┼────────────────────┼──────────┼─────────────┤
    │ Wandering Skald │   Instrument       │    1     │ No          │
    │                 │   Journal          │    1     │ No          │
    ├─────────────────┼────────────────────┼──────────┼─────────────┤
    │Outcast Scavenger│   Rations          │    3     │ No          │
    │                 │   Travel Cloak     │    1     │ Chest       │
    └─────────────────┴────────────────────┴──────────┴─────────────┘

    Design Notes:
    ┌─────────────────────────────────────────────────────────────────┐
    │ • Combat backgrounds (Smith, Guard) auto-equip weapons/armor    │
    │ • Utility backgrounds store items in inventory                  │
    │ • Consumables (Bandages, Rations) have quantity > 1             │
    │ • All items thematically match pre-Silence profession           │
    └─────────────────────────────────────────────────────────────────┘
```

### 3.5 Auto-Equip Decision Tree

```
┌─────────────────────────────────────────────────────────────────────┐
│                    AUTO-EQUIP DECISION TREE                          │
└─────────────────────────────────────────────────────────────────────┘

    Equipment Grant Being Processed
           │
           ▼
    ┌──────────────────────┐
    │ IsEquipped == true?  │
    └──────────┬───────────┘
               │
        ┌──────┴──────┐
       YES            NO
        │              │
        ▼              ▼
┌───────────────┐  ┌─────────────────────────────────────────────┐
│ Has Slot?     │  │ Add to inventory only                       │
└───────┬───────┘  │ (Healer's Kit, Lockpicks, Instrument, etc.) │
        │          └─────────────────────────────────────────────┘
        │
 ┌──────┴──────┐
YES            NO
 │              │
 ▼              ▼
┌──────────────────────────────────────┐  ┌───────────────────────┐
│ Equip to specified slot              │  │ Error: IsEquipped     │
│ • MainHand: Spear, Hammer            │  │ requires Slot         │
│ • OffHand: Shield                    │  │ (validation failure)  │
│ • Chest: Apron, Cloak                │  └───────────────────────┘
└──────────────────────────────────────┘
        │
        ▼
┌──────────────────────────────────────┐
│ Check slot availability              │
│ (handled by equipment system)        │
└──────────────────────────────────────┘
```

---

## 4. BackgroundEquipmentGrant Value Object

### 4.1 Purpose

The `BackgroundEquipmentGrant` value object represents a single starting item granted by a background. It specifies the item, quantity, and whether the item should be automatically equipped.

### 4.2 Implementation

**File:** `src/Core/RuneAndRust.Domain/ValueObjects/BackgroundEquipmentGrant.cs`

```csharp
namespace RuneAndRust.Domain.ValueObjects;

using RuneAndRust.Domain.Enums;

/// <summary>
/// Represents starting equipment granted by a background.
/// </summary>
/// <remarks>
/// <para>
/// BackgroundEquipmentGrant specifies an item to add to the character's
/// inventory at creation time. Items are identified by kebab-case string
/// IDs to support configuration-driven item systems.
/// </para>
/// <para>
/// Grants can optionally specify auto-equip behavior:
/// - IsEquipped: If true, item is equipped during creation
/// - Slot: The equipment slot to equip to (required if IsEquipped is true)
/// </para>
/// <para>
/// Quantity supports stackable items like bandages (×5) or rations (×3).
/// </para>
/// </remarks>
/// <param name="ItemId">The kebab-case item identifier (e.g., "smiths-hammer").</param>
/// <param name="Quantity">Number of items to grant (default 1).</param>
/// <param name="IsEquipped">Whether to auto-equip the item at creation.</param>
/// <param name="Slot">Target equipment slot if auto-equipped.</param>
public readonly record struct BackgroundEquipmentGrant(
    string ItemId,
    int Quantity,
    bool IsEquipped,
    EquipmentSlot? Slot)
{
    /// <summary>
    /// Gets whether this grant specifies auto-equip behavior.
    /// </summary>
    public bool HasAutoEquip => IsEquipped && Slot.HasValue;

    /// <summary>
    /// Gets whether this is a stackable item (quantity > 1).
    /// </summary>
    public bool IsStackable => Quantity > 1;

    /// <summary>
    /// Gets whether this grant is for inventory only (not equipped).
    /// </summary>
    public bool IsInventoryOnly => !IsEquipped;

    /// <summary>
    /// Creates a new BackgroundEquipmentGrant with validation.
    /// </summary>
    /// <param name="itemId">The item identifier.</param>
    /// <param name="quantity">Number of items (default 1).</param>
    /// <param name="isEquipped">Auto-equip flag (default false).</param>
    /// <param name="slot">Equipment slot if equipped.</param>
    /// <returns>A new BackgroundEquipmentGrant instance.</returns>
    /// <exception cref="ArgumentException">Thrown when itemId is null/whitespace.</exception>
    /// <exception cref="ArgumentOutOfRangeException">Thrown when quantity is less than 1.</exception>
    /// <exception cref="ArgumentException">Thrown when isEquipped is true but slot is null.</exception>
    public static BackgroundEquipmentGrant Create(
        string itemId,
        int quantity = 1,
        bool isEquipped = false,
        EquipmentSlot? slot = null)
    {
        ArgumentException.ThrowIfNullOrWhiteSpace(itemId);
        ArgumentOutOfRangeException.ThrowIfLessThan(quantity, 1);

        if (isEquipped && !slot.HasValue)
        {
            throw new ArgumentException(
                "Slot must be specified when IsEquipped is true.",
                nameof(slot));
        }

        return new BackgroundEquipmentGrant(
            itemId.ToLowerInvariant(),
            quantity,
            isEquipped,
            slot);
    }

    /// <summary>
    /// Creates an equipment grant for an item to be auto-equipped.
    /// </summary>
    public static BackgroundEquipmentGrant Equipped(
        string itemId,
        EquipmentSlot slot) =>
        Create(itemId, 1, true, slot);

    /// <summary>
    /// Creates an equipment grant for an inventory-only item.
    /// </summary>
    public static BackgroundEquipmentGrant Inventory(
        string itemId,
        int quantity = 1) =>
        Create(itemId, quantity, false, null);

    /// <summary>
    /// Creates an equipment grant for a consumable with quantity.
    /// </summary>
    public static BackgroundEquipmentGrant Consumable(
        string itemId,
        int quantity) =>
        Create(itemId, quantity, false, null);

    /// <inheritdoc />
    public override string ToString()
    {
        var quantityStr = Quantity > 1 ? $" ×{Quantity}" : "";
        var slotStr = IsEquipped && Slot.HasValue ? $" ({Slot.Value})" : "";
        return $"{ItemId}{quantityStr}{slotStr}";
    }
}
```

### 4.3 Equipment Grant Reference Table

| Background        | Item ID       | Quantity | IsEquipped | Slot     |
| ----------------- | ------------- | -------- | ---------- | -------- |
| Village Smith     | smiths-hammer | 1        | true       | MainHand |
| Village Smith     | leather-apron | 1        | true       | Chest    |
| Traveling Healer  | healers-kit   | 1        | false      | null     |
| Traveling Healer  | bandages      | 5        | false      | null     |
| Ruin Delver       | lantern       | 1        | false      | null     |
| Ruin Delver       | rope          | 1        | false      | null     |
| Ruin Delver       | lockpicks     | 1        | false      | null     |
| Clan Guard        | shield        | 1        | true       | OffHand  |
| Clan Guard        | spear         | 1        | true       | MainHand |
| Wandering Skald   | instrument    | 1        | false      | null     |
| Wandering Skald   | journal       | 1        | false      | null     |
| Outcast Scavenger | rations       | 3        | false      | null     |
| Outcast Scavenger | travel-cloak  | 1        | true       | Chest    |

---

## 5. BackgroundDefinition Extension

### 5.1 Purpose

This section defines the extension to `BackgroundDefinition` to include equipment grants. The factory method is updated to accept equipment grants, and helper methods are added for equipment access.

### 5.2 Implementation Changes

**File:** `src/Core/RuneAndRust.Domain/Entities/BackgroundDefinition.cs`

```csharp
// Add to existing BackgroundDefinition class

/// <summary>
/// Gets the starting equipment granted by this background.
/// </summary>
/// <remarks>
/// Equipment grants represent tools and supplies from the character's
/// pre-Silence profession. Items may be auto-equipped or inventory-only.
/// </remarks>
public IReadOnlyList<BackgroundEquipmentGrant> EquipmentGrants { get; private set; }

// Update private constructor
private BackgroundDefinition()
{
    DisplayName = null!;
    Description = null!;
    SelectionText = null!;
    ProfessionBefore = null!;
    SocialStanding = null!;
    NarrativeHooks = Array.Empty<string>();
    SkillGrants = Array.Empty<BackgroundSkillGrant>();
    EquipmentGrants = Array.Empty<BackgroundEquipmentGrant>();
}

// Update factory method signature
public static BackgroundDefinition Create(
    Background backgroundId,
    string displayName,
    string description,
    string selectionText,
    string professionBefore,
    string socialStanding,
    IReadOnlyList<string>? narrativeHooks = null,
    IReadOnlyList<BackgroundSkillGrant>? skillGrants = null,
    IReadOnlyList<BackgroundEquipmentGrant>? equipmentGrants = null)
{
    // ... existing validation ...

    return new BackgroundDefinition
    {
        // ... existing properties ...
        EquipmentGrants = equipmentGrants ?? Array.Empty<BackgroundEquipmentGrant>()
    };
}

/// <summary>
/// Gets whether this background grants any equipment.
/// </summary>
public bool HasEquipmentGrants() => EquipmentGrants.Count > 0;

/// <summary>
/// Gets equipment grants that should be auto-equipped.
/// </summary>
public IEnumerable<BackgroundEquipmentGrant> GetEquippedItems() =>
    EquipmentGrants.Where(g => g.IsEquipped);

/// <summary>
/// Gets equipment grants that go to inventory only.
/// </summary>
public IEnumerable<BackgroundEquipmentGrant> GetInventoryItems() =>
    EquipmentGrants.Where(g => !g.IsEquipped);

/// <summary>
/// Gets the total number of items granted (including quantities).
/// </summary>
public int GetTotalItemCount() =>
    EquipmentGrants.Sum(g => g.Quantity);

/// <summary>
/// Gets a formatted summary of equipment grants for display.
/// </summary>
public string GetEquipmentGrantSummary() =>
    EquipmentGrants.Count > 0
        ? string.Join(", ", EquipmentGrants.Select(g => g.ToString()))
        : "No starting equipment";
```

---

## 6. Data Model Changes

### 6.1 New Types Summary

| Type                       | Layer  | Category     | Description                   |
| -------------------------- | ------ | ------------ | ----------------------------- |
| `BackgroundEquipmentGrant` | Domain | Value Object | Starting item from background |

### 6.2 Modified Types

| Type                   | Change                           | Description              |
| ---------------------- | -------------------------------- | ------------------------ |
| `BackgroundDefinition` | Added `EquipmentGrants` property | Collection of equipment  |
| `BackgroundDefinition` | Updated `Create` factory method  | Accepts equipment grants |
| `BackgroundDefinition` | Added helper methods             | Equipment access methods |

### 6.3 File Locations

```
src/Core/RuneAndRust.Domain/
├── ValueObjects/
│   └── BackgroundEquipmentGrant.cs          ← NEW
├── Entities/
│   └── BackgroundDefinition.cs              ← MODIFIED

config/
└── backgrounds.json                         ← MODIFIED (add equipmentGrants)
└── schemas/
    └── backgrounds.schema.json              ← MODIFIED (add schema)
```

---

## 7. Configuration File Schema Updates

### 7.1 backgrounds.json (Extended with Equipment Grants)

```json
{
    "$schema": "./schemas/backgrounds.schema.json",
    "backgrounds": [
        {
            "backgroundId": "VillageSmith",
            "displayName": "Village Smith",
            "skillGrants": [...],
            "equipmentGrants": [
                { "itemId": "smiths-hammer", "quantity": 1, "isEquipped": true, "slot": "MainHand" },
                { "itemId": "leather-apron", "quantity": 1, "isEquipped": true, "slot": "Chest" }
            ]
        },
        {
            "backgroundId": "TravelingHealer",
            "displayName": "Traveling Healer",
            "skillGrants": [...],
            "equipmentGrants": [
                { "itemId": "healers-kit", "quantity": 1, "isEquipped": false, "slot": null },
                { "itemId": "bandages", "quantity": 5, "isEquipped": false, "slot": null }
            ]
        },
        {
            "backgroundId": "RuinDelver",
            "displayName": "Ruin Delver",
            "skillGrants": [...],
            "equipmentGrants": [
                { "itemId": "lantern", "quantity": 1, "isEquipped": false, "slot": null },
                { "itemId": "rope", "quantity": 1, "isEquipped": false, "slot": null },
                { "itemId": "lockpicks", "quantity": 1, "isEquipped": false, "slot": null }
            ]
        },
        {
            "backgroundId": "ClanGuard",
            "displayName": "Clan Guard",
            "skillGrants": [...],
            "equipmentGrants": [
                { "itemId": "shield", "quantity": 1, "isEquipped": true, "slot": "OffHand" },
                { "itemId": "spear", "quantity": 1, "isEquipped": true, "slot": "MainHand" }
            ]
        },
        {
            "backgroundId": "WanderingSkald",
            "displayName": "Wandering Skald",
            "skillGrants": [...],
            "equipmentGrants": [
                { "itemId": "instrument", "quantity": 1, "isEquipped": false, "slot": null },
                { "itemId": "journal", "quantity": 1, "isEquipped": false, "slot": null }
            ]
        },
        {
            "backgroundId": "OutcastScavenger",
            "displayName": "Outcast Scavenger",
            "skillGrants": [...],
            "equipmentGrants": [
                { "itemId": "rations", "quantity": 3, "isEquipped": false, "slot": null },
                { "itemId": "travel-cloak", "quantity": 1, "isEquipped": true, "slot": "Chest" }
            ]
        }
    ]
}
```

### 7.2 backgrounds.schema.json (Equipment Grant Schema)

```json
{
    "$defs": {
        "equipmentGrant": {
            "type": "object",
            "description": "Starting equipment granted by the background",
            "required": ["itemId", "quantity", "isEquipped"],
            "properties": {
                "itemId": {
                    "type": "string",
                    "description": "Kebab-case item identifier",
                    "pattern": "^[a-z][a-z0-9-]*$",
                    "minLength": 1,
                    "maxLength": 50
                },
                "quantity": {
                    "type": "integer",
                    "description": "Number of items to grant",
                    "minimum": 1,
                    "maximum": 99
                },
                "isEquipped": {
                    "type": "boolean",
                    "description": "Whether to auto-equip at creation"
                },
                "slot": {
                    "type": ["string", "null"],
                    "description": "Equipment slot if auto-equipped",
                    "enum": [
                        null,
                        "MainHand",
                        "OffHand",
                        "Head",
                        "Chest",
                        "Hands",
                        "Feet",
                        "Accessory"
                    ]
                }
            },
            "additionalProperties": false
        },
        "backgroundDefinition": {
            "properties": {
                "equipmentGrants": {
                    "type": "array",
                    "description": "Starting equipment from this background",
                    "items": { "$ref": "#/$defs/equipmentGrant" },
                    "minItems": 0,
                    "maxItems": 10
                }
            }
        }
    }
}
```

---

## 8. Logging Specifications

### 8.1 Log Levels by Component

| Component                  | Level       | Events                                 |
| -------------------------- | ----------- | -------------------------------------- |
| `BackgroundEquipmentGrant` | Debug       | Grant created, validation performed    |
| `BackgroundDefinition`     | Debug       | Equipment grants accessed              |
| `BackgroundApplication`    | Information | Equipment added to character inventory |
| `BackgroundApplication`    | Information | Item auto-equipped to slot             |

### 8.2 Structured Logging Templates

```csharp
// Debug - Equipment grant created
_logger.LogDebug(
    "BackgroundEquipmentGrant created. ItemId={ItemId}, Quantity={Quantity}, Equipped={IsEquipped}",
    itemId, quantity, isEquipped);

// Information - Equipment granted to character
_logger.LogInformation(
    "Granted {Count} equipment items from {Background}. Items: {Items}",
    count, backgroundId, itemSummary);

// Information - Item auto-equipped
_logger.LogInformation(
    "Auto-equipped {ItemId} to {Slot} from {Background}",
    itemId, slot, backgroundId);
```

---

## 9. Unit Testing Requirements

### 9.1 Test Count by Feature

| Feature                     | Test Count |
| --------------------------- | ---------- |
| BackgroundEquipmentGrant    | ~5         |
| BackgroundDefinition update | ~3         |
| **Total**                   | **~8**     |

### 9.2 Test Specifications

#### BackgroundEquipmentGrantTests.cs

```csharp
[TestFixture]
public class BackgroundEquipmentGrantTests
{
    [Test]
    public void Create_WithValidParameters_CreatesGrant();

    [Test]
    public void Create_WithNullItemId_ThrowsArgumentException();

    [Test]
    public void Create_WithZeroQuantity_ThrowsArgumentOutOfRangeException();

    [Test]
    public void Create_WithEquippedButNoSlot_ThrowsArgumentException();

    [Test]
    public void Create_NormalizesItemIdToLowercase();

    [Test]
    public void Equipped_CreatesAutoEquipGrant();

    [Test]
    public void Inventory_CreatesInventoryOnlyGrant();

    [Test]
    public void HasAutoEquip_WithEquippedAndSlot_ReturnsTrue();

    [Test]
    public void ToString_FormatsCorrectlyWithQuantity();
}
```

#### BackgroundDefinitionEquipmentTests.cs

```csharp
[TestFixture]
public class BackgroundDefinitionEquipmentTests
{
    [Test]
    public void Create_WithEquipmentGrants_StoresGrants();

    [Test]
    public void HasEquipmentGrants_WithGrants_ReturnsTrue();

    [Test]
    public void GetEquippedItems_ReturnsOnlyEquippedGrants();

    [Test]
    public void GetInventoryItems_ReturnsOnlyNonEquippedGrants();

    [Test]
    public void ClanGuard_GrantsShieldAndSpearEquipped();
}
```

---

## 10. Use Cases

### UC-001: Display Starting Equipment During Selection

**Actor:** Character Creation UI  
**Flow:** Player views background → Get equipment grants → Display item list with quantities

### UC-002: Grant Equipment to New Character

**Actor:** BackgroundApplicationService  
**Flow:** Background selected → Get equipment grants → Create items → Add to inventory → Auto-equip marked items

### UC-003: Show Equipment Source in Inventory

**Actor:** Inventory View  
**Flow:** Display item → Check source → Show "Background: Clan Guard" label

---

## 11. User Stories

### US-001: See Starting Equipment Before Selection

**As a** player creating a new character  
**I want to** see what equipment each background provides  
**So that** I can choose a profession with useful starting gear

### US-002: Start With Professional Tools Equipped

**As a** Clan Guard  
**I want** my shield and spear equipped automatically  
**So that** I'm ready for combat from the start

### US-003: Receive Profession-Appropriate Supplies

**As a** Traveling Healer  
**I want** to start with a healer's kit and bandages  
**So that** I can fulfill my role immediately

---

## 12. Deliverable Checklist

### Domain Layer

- [ ] `BackgroundEquipmentGrant.cs` value object created
- [ ] `BackgroundDefinition.cs` extended with `EquipmentGrants`
- [ ] All types have complete XML documentation

### Configuration Files

- [ ] `config/backgrounds.json` extended with equipment grants
- [ ] `config/schemas/backgrounds.schema.json` extended
- [ ] Configuration validates against schema

### Testing

- [ ] `BackgroundEquipmentGrantTests.cs` created
- [ ] `BackgroundDefinitionEquipmentTests.cs` created
- [ ] ~8 unit tests passing

---

## 13. Acceptance Criteria

### Functional

- [ ] `BackgroundEquipmentGrant.Create()` validates itemId and quantity
- [ ] `BackgroundEquipmentGrant` requires slot when isEquipped is true
- [ ] `BackgroundEquipmentGrant` normalizes itemId to lowercase
- [ ] `BackgroundDefinition.EquipmentGrants` returns equipment collection
- [ ] Clan Guard grants Shield (OffHand) and Spear (MainHand)
- [ ] Traveling Healer grants Bandages ×5
- [ ] `GetEquippedItems()` returns only auto-equip grants
- [ ] `GetTotalItemCount()` sums all quantities

### Quality

- [ ] Build succeeds with 0 errors and 0 warnings
- [ ] ~8 unit tests pass
- [ ] Configuration validates against JSON schema
- [ ] All public types have XML documentation

---

## 14. Dependencies

### Required from Prior Versions

| Type                   | Location   | Usage                    |
| ---------------------- | ---------- | ------------------------ |
| `Background`           | v0.17.1a   | Enum for background ID   |
| `BackgroundDefinition` | v0.17.1a/b | Entity being extended    |
| `EquipmentSlot`        | Existing   | Slot enum for auto-equip |

### Provides to v0.17.1d-e

| Type                       | Usage                             |
| -------------------------- | --------------------------------- |
| `BackgroundEquipmentGrant` | Referenced by application service |

---

## 15. Future Considerations

### Deferred to v0.17.1d

- **IBackgroundProvider** interface
- **BackgroundProvider** implementation loading from JSON

### Deferred to v0.17.1e

- **IBackgroundApplicationService** for creating items and equipping
- **BackgroundApplicationResult** with granted items list

### Out of Scope

- Item creation logic (uses existing ItemFactory)
- Equipment slot conflict resolution (uses existing equipment system)
- Item quality/tier on granted items (all standard quality)

---

_Document Version: 1.0_  
_Last Updated: 2026-01-27_  
_Author: AI Assistant_
