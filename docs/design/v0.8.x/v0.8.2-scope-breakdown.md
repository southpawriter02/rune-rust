# v0.8.2 Quest Journal - Scope Breakdown

**Version:** 0.8.2
**Theme:** Interaction Windows
**Prerequisites:** v0.8.1c Complete (Navigation & Information - Tooltip Service)
**Total Estimated Tests:** ~35 new tests

---

## Executive Summary

The Interaction Windows sub-version implements specialized GUI windows for complex game interactions: a shop interface for buying and selling items, a dialogue window for NPC conversations with branching choices, and a puzzle UI for interactive puzzle solving. These windows provide dedicated interfaces for game systems that require rich user interaction.

Key focus areas:
- **Shop Interface**: Buy/sell items with comparison tooltips
- **Dialogue Window**: NPC portraits, typed text, response choices
- **Puzzle UI**: Interactive puzzle elements with hints and feedback

The work is divided into **three sub-parts**:

| Part | Name | Focus | Est. Tests |
|------|------|-------|------------|
| v0.8.2a | Shop Window | Buy/sell interface, item comparison, transactions | ~12 |
| v0.8.2b | Dialogue Window | NPC portrait, typed text, branching choices | ~13 |
| v0.8.2c | Puzzle Window | Puzzle display, interaction, hints, feedback | ~10 |

---

## Existing Infrastructure

### Already Implemented (from v0.8.2)

| Feature | Location | Notes |
|---------|----------|-------|
| MapViewPanel | `Views/MapViewPanel.axaml` | Dungeon map |
| QuestLogWindow | `Views/QuestLogWindow.axaml` | Quest tracking |
| TooltipService | `Services/TooltipService.cs` | Hover info |
| InventoryPanel | `Views/InventoryPanel.axaml` | Item grid |
| ItemSlotControl | `Controls/ItemSlotControl.cs` | Item display |

### Already Implemented (from prior versions)

| Feature | Location | Notes |
|---------|----------|-------|
| Shop | `Domain/Entities/Shop.cs` | Shop entity |
| ShopService | `Application/Services/ShopService.cs` | Buy/sell logic |
| Dialogue | `Domain/Entities/Dialogue.cs` | Dialogue trees |
| DialogueService | `Application/Services/DialogueService.cs` | Conversation logic |
| Puzzle | `Domain/Entities/Puzzle.cs` | Puzzle entity |
| PuzzleService | `Application/Services/PuzzleService.cs` | Puzzle logic |
| Npc | `Domain/Entities/Npc.cs` | NPC data |

### Needs Implementation (v0.8.2)

| Feature | Part | Notes |
|---------|------|-------|
| ShopWindow | v0.8.2a | Buy/sell window |
| ShopWindowViewModel | v0.8.2a | Shop logic |
| ShopItemControl | v0.8.2a | Buyable item |
| DialogueWindow | v0.8.2b | Conversation window |
| DialogueWindowViewModel | v0.8.2b | Dialogue state |
| DialogueChoiceControl | v0.8.2b | Response option |
| PuzzleWindow | v0.8.1c | Puzzle window |
| PuzzleWindowViewModel | v0.8.1c | Puzzle state |
| PuzzleElementControl | v0.8.1c | Interactive element |

---

## Feature Analysis & Categorization

### Shop Features

| Feature | Complexity | Dependencies | Assigned Part |
|---------|------------|--------------|---------------|
| Shop inventory display | Medium | ShopService | **v0.8.2a** |
| Player inventory display | Low | Inventory | **v0.8.2a** |
| Buy transaction | Medium | ShopService | **v0.8.2a** |
| Sell transaction | Medium | ShopService | **v0.8.2a** |
| Item comparison | Medium | TooltipService | **v0.8.2a** |
| Gold display | Low | Player | **v0.8.2a** |

### Dialogue Features

| Feature | Complexity | Dependencies | Assigned Part |
|---------|------------|--------------|---------------|
| NPC portrait display | Low | Assets | **v0.8.2b** |
| Text typing animation | Medium | Animation | **v0.8.2b** |
| Response choices | Medium | DialogueService | **v0.8.2b** |
| Branching navigation | High | Dialogue tree | **v0.8.2b** |
| Quest integration | Low | QuestService | **v0.8.2b** |

### Puzzle Features

| Feature | Complexity | Dependencies | Assigned Part |
|---------|------------|--------------|---------------|
| Puzzle state display | Medium | PuzzleService | **v0.8.1c** |
| Interactive elements | High | Click handling | **v0.8.1c** |
| Hint system | Medium | Hint data | **v0.8.1c** |
| Success/failure feedback | Medium | Animation | **v0.8.1c** |
| Attempt tracking | Low | Puzzle state | **v0.8.1c** |

---

## Part Definitions

---

## v0.8.2a: Shop Window

[v0.8.2a Design Specification](v0.8.2a-design-specification.md)

### Overview

Implement a shop window that allows buying items from a merchant and selling items from inventory. Features include dual inventory display, item selection with comparison tooltips, gold tracking, and transaction confirmation.

### Scope

**In Scope:**
- `ShopWindow` modal window
- `ShopWindowViewModel` with transaction logic
- `ShopItemControl` for shop inventory items
- Shop inventory list (what merchant sells)
- Player inventory list (what player can sell)
- Item selection and details
- Item comparison (vs equipped)
- Buy button with gold deduction
- Sell button with gold addition
- Gold display and update
- Transaction feedback (success/fail)
- Insufficient funds handling
- Inventory full handling
- Sound effects (optional)

**Out of Scope:**
- Dialogue window (v0.8.2b)
- Puzzle window (v0.8.1c)
- Haggling/bargaining (future)

### Key Deliverables

| Type | Count | Details |
|------|-------|---------|
| Windows | 1 | `ShopWindow` |
| ViewModels | 2 | `ShopWindowViewModel`, `ShopItemViewModel` |
| User Controls | 1 | `ShopItemControl` |
| Styles | 1 | `ShopWindowStyles.axaml` |
| Unit Tests | ~12 | Transaction, comparison tests |

### Shop Window Design

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      MERCHANT - Old Tom's Shop                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ SHOP INVENTORY                  â”‚ â”‚ YOUR INVENTORY              â”‚ â”‚
â”‚ â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â”‚
â”‚ â”‚ âš” Iron Sword          50g [â–¶]  â”‚ â”‚ ğŸ§ª Healing Potion    5g [â—€] â”‚ â”‚
â”‚ â”‚ ğŸ›¡ Leather Armor       75g      â”‚ â”‚ ğŸ§ª Healing Potion    5g     â”‚ â”‚
â”‚ â”‚ ğŸ§ª Healing Potion      10g      â”‚ â”‚ ğŸ“œ Old Scroll        2g     â”‚ â”‚
â”‚ â”‚ ğŸ§ª Mana Potion         15g      â”‚ â”‚ ğŸ’ Ruby             25g     â”‚ â”‚
â”‚ â”‚ ğŸ’ Ring of Protection 100g      â”‚ â”‚ ğŸ—¡ Rusty Dagger      8g     â”‚ â”‚
â”‚ â”‚ ğŸ“œ Scroll of Fire      25g      â”‚ â”‚                             â”‚ â”‚
â”‚ â”‚ ğŸ”® Wand of Sparks      60g      â”‚ â”‚                             â”‚ â”‚
â”‚ â”‚                                 â”‚ â”‚                             â”‚ â”‚
â”‚ â”‚                                 â”‚ â”‚                             â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                      â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ SELECTED: Iron Sword                              [â–¶] = Selected â”‚ â”‚
â”‚ â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚ â”‚
â”‚ â”‚ âš” Damage: 2d6+3 | Attack: +4 | Type: Slashing                   â”‚ â”‚
â”‚ â”‚                                                                  â”‚ â”‚
â”‚ â”‚ A sturdy iron blade, well-balanced and reliable in combat.       â”‚ â”‚
â”‚ â”‚                                                                  â”‚ â”‚
â”‚ â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚ â”‚
â”‚ â”‚ â”‚ COMPARISON vs. Equipped (Rusty Dagger)                       â”‚â”‚ â”‚
â”‚ â”‚ â”‚   Damage:  2d6+3 vs 1d4    â–² Better                         â”‚â”‚ â”‚
â”‚ â”‚ â”‚   Attack:  +4 vs +1        â–² Better                         â”‚â”‚ â”‚
â”‚ â”‚ â”‚   Weight:  3 lbs vs 1 lb   â–¼ Heavier                        â”‚â”‚ â”‚
â”‚ â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ğŸ’° Your Gold: 150                                                   â”‚
â”‚                                                                      â”‚
â”‚      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚      â”‚   BUY (50g)   â”‚    â”‚   SELL (5g)   â”‚    â”‚     CLOSE     â”‚    â”‚
â”‚      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ShopWindowViewModel

```csharp
namespace RuneAndRust.Avalonia.ViewModels;

public partial class ShopWindowViewModel : ViewModelBase
{
    private readonly IShopService _shopService;
    private readonly IGameSessionService _gameSession;
    private readonly ITooltipService _tooltipService;
    
    [ObservableProperty]
    private Shop _shop;
    
    [ObservableProperty]
    private string _shopName;
    
    [ObservableProperty]
    private ObservableCollection<ShopItemViewModel> _shopItems = new();
    
    [ObservableProperty]
    private ObservableCollection<ShopItemViewModel> _playerItems = new();
    
    [ObservableProperty]
    private ShopItemViewModel? _selectedShopItem;
    
    [ObservableProperty]
    private ShopItemViewModel? _selectedPlayerItem;
    
    [ObservableProperty]
    private int _playerGold;
    
    [ObservableProperty]
    private bool _canBuy;
    
    [ObservableProperty]
    private bool _canSell;
    
    [ObservableProperty]
    private string? _transactionMessage;
    
    [ObservableProperty]
    private ItemComparisonViewModel? _comparison;
    
    public ShopWindowViewModel(IShopService shopService, IGameSessionService gameSession)
    {
        _shopService = shopService;
        _gameSession = gameSession;
        
        LoadShop(_gameSession.CurrentShop);
    }
    
    [RelayCommand]
    private void SelectShopItem(ShopItemViewModel item)
    {
        SelectedShopItem = item;
        SelectedPlayerItem = null;
        
        UpdateComparison(item.Item);
        UpdateButtonStates();
    }
    
    [RelayCommand]
    private void SelectPlayerItem(ShopItemViewModel item)
    {
        SelectedPlayerItem = item;
        SelectedShopItem = null;
        
        Comparison = null;
        UpdateButtonStates();
    }
    
    [RelayCommand(CanExecute = nameof(CanBuy))]
    private void Buy()
    {
        if (SelectedShopItem is null) return;
        
        var result = _shopService.BuyItem(Shop, SelectedShopItem.Item);
        
        if (result.Success)
        {
            TransactionMessage = $"Purchased {SelectedShopItem.Item.Name}!";
            PlayerGold = _gameSession.Player.Gold;
            RefreshInventories();
        }
        else
        {
            TransactionMessage = result.FailureReason;
        }
    }
    
    [RelayCommand(CanExecute = nameof(CanSell))]
    private void Sell()
    {
        if (SelectedPlayerItem is null) return;
        
        var result = _shopService.SellItem(Shop, SelectedPlayerItem.Item);
        
        if (result.Success)
        {
            TransactionMessage = $"Sold {SelectedPlayerItem.Item.Name} for {SelectedPlayerItem.SellPrice}g!";
            PlayerGold = _gameSession.Player.Gold;
            RefreshInventories();
            SelectedPlayerItem = null;
        }
        else
        {
            TransactionMessage = result.FailureReason;
        }
    }
    
    private void UpdateComparison(Item shopItem)
    {
        var equippedItem = _gameSession.Player.GetEquippedItem(shopItem.EquipSlot);
        if (equippedItem is null)
        {
            Comparison = null;
            return;
        }
        
        Comparison = new ItemComparisonViewModel(shopItem, equippedItem);
    }
    
    private void UpdateButtonStates()
    {
        CanBuy = SelectedShopItem is not null 
              && PlayerGold >= SelectedShopItem.BuyPrice
              && !_gameSession.Player.Inventory.IsFull;
        
        CanSell = SelectedPlayerItem is not null 
               && !SelectedPlayerItem.Item.IsEquipped;
    }
}
```

### ItemComparisonViewModel

```csharp
public class ItemComparisonViewModel
{
    public string ComparedTo { get; }
    public IReadOnlyList<ComparisonLine> Lines { get; }
    
    public ItemComparisonViewModel(Item newItem, Item currentItem)
    {
        ComparedTo = currentItem.Name;
        
        var lines = new List<ComparisonLine>();
        
        // Compare damage
        if (newItem.Damage is not null || currentItem.Damage is not null)
        {
            lines.Add(new ComparisonLine(
                "Damage",
                newItem.Damage ?? "â€”",
                currentItem.Damage ?? "â€”",
                CompareDamage(newItem.Damage, currentItem.Damage)));
        }
        
        // Compare attack bonus
        lines.Add(new ComparisonLine(
            "Attack",
            $"+{newItem.AttackBonus}",
            $"+{currentItem.AttackBonus}",
            CompareValues(newItem.AttackBonus, currentItem.AttackBonus)));
        
        // Compare weight
        lines.Add(new ComparisonLine(
            "Weight",
            $"{newItem.Weight} lbs",
            $"{currentItem.Weight} lbs",
            CompareValues(currentItem.Weight, newItem.Weight, true))); // Lower is better
        
        Lines = lines;
    }
}

public record ComparisonLine(string Stat, string NewValue, string OldValue, ComparisonResult Result);

public enum ComparisonResult { Better, Worse, Same }
```

### Acceptance Criteria

- [ ] Shop window shows merchant name
- [ ] Shop inventory displays available items
- [ ] Player inventory displays sellable items
- [ ] Selecting shop item shows details
- [ ] Item comparison shows vs equipped
- [ ] Better/worse indicators display
- [ ] Buy button purchases selected item
- [ ] Gold deducted on purchase
- [ ] Sell button sells selected item
- [ ] Gold added on sale
- [ ] Insufficient gold shows error
- [ ] Full inventory shows error
- [ ] ~12 unit tests pass

---

## v0.8.2b: Dialogue Window

[v0.8.2b Design Specification](v0.8.2b-design-specification.md)

### Overview

Implement a dialogue window for NPC conversations featuring NPC portrait display, typed text animation, and clickable response choices that branch the conversation. Supports quest acceptance, shop triggers, and other dialogue outcomes.

### Scope

**In Scope:**
- `DialogueWindow` modal window
- `DialogueWindowViewModel` with conversation state
- `DialogueChoiceControl` for response options
- NPC portrait/avatar display
- NPC name display
- Dialogue text with typing animation
- Configurable typing speed
- Click to skip typing
- Response choice list
- Choice highlighting and selection
- Keyboard number selection (1-9)
- Branching dialogue navigation
- Dialogue end handling
- Quest accept/decline integration
- Shop open trigger
- Special choice indicators ([ACCEPT QUEST], [SHOP], etc.)

**Out of Scope:**
- Shop window (v0.8.2a)
- Puzzle window (v0.8.1c)
- Voice acting (future)

### Key Deliverables

| Type | Count | Details |
|------|-------|---------|
| Windows | 1 | `DialogueWindow` |
| ViewModels | 2 | `DialogueWindowViewModel`, `DialogueChoiceViewModel` |
| User Controls | 1 | `DialogueChoiceControl` |
| Animations | 1 | Typing animation |
| Styles | 1 | `DialogueWindowStyles.axaml` |
| Unit Tests | ~13 | Dialogue flow, choice tests |

### Dialogue Window Design

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                                     â”‚
â”‚  â”‚            â”‚   OLD INNKEEPER                                     â”‚
â”‚  â”‚   â”Œâ”€â”€â”€â”    â”‚   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•                                 â”‚
â”‚  â”‚   â”‚ â˜º â”‚    â”‚                                                     â”‚
â”‚  â”‚   â””â”€â”€â”€â”˜    â”‚   "Ah, a brave adventurer! I've been waiting for    â”‚
â”‚  â”‚  Portrait  â”‚   someone like you. The skeleton in the cave        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   has been causing us trouble for too long.         â”‚
â”‚                                                                      â”‚
â”‚                   You see, that cave used to be our mine, but now   â”‚
â”‚                   nobody dares enter. Will you help us?"_           â”‚
â”‚                                                                      â”‚
â”‚                                           [Click to continue...]    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ 1. "Tell me more about this skeleton."                      â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ 2. "What's in it for me?"                                   â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ 3. "I'll take care of it."               [ACCEPT QUEST]     â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ 4. "Let me see your wares."              [SHOP]             â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ 5. "I'm not interested right now."       [LEAVE]            â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


TYPING ANIMATION (in progress):
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                                     â”‚
â”‚  â”‚   â”Œâ”€â”€â”€â”    â”‚   OLD INNKEEPER                                     â”‚
â”‚  â”‚   â”‚ â˜º â”‚    â”‚   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•                                 â”‚
â”‚  â”‚   â””â”€â”€â”€â”˜    â”‚                                                     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   "Ah, a brave adventuâ–ˆ                             â”‚
â”‚                                                                      â”‚
â”‚                                                                      â”‚
â”‚                   [Click to skip...]                                 â”‚
â”‚                                                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### DialogueWindowViewModel

```csharp
namespace RuneAndRust.Avalonia.ViewModels;

public partial class DialogueWindowViewModel : ViewModelBase
{
    private readonly IDialogueService _dialogueService;
    private readonly IQuestService _questService;
    private readonly INavigationService _navigation;
    
    private DialogueNode _currentNode;
    private CancellationTokenSource? _typingCts;
    
    [ObservableProperty]
    private string _npcName;
    
    [ObservableProperty]
    private IImage? _npcPortrait;
    
    [ObservableProperty]
    private string _displayedText = string.Empty;
    
    [ObservableProperty]
    private string _fullText = string.Empty;
    
    [ObservableProperty]
    private bool _isTyping;
    
    [ObservableProperty]
    private ObservableCollection<DialogueChoiceViewModel> _choices = new();
    
    [ObservableProperty]
    private bool _hasChoices;
    
    [ObservableProperty]
    private int _typingSpeedMs = 30; // 30ms per character â‰ˆ 33 chars/sec
    
    public DialogueWindowViewModel(IDialogueService dialogueService, IQuestService questService)
    {
        _dialogueService = dialogueService;
        _questService = questService;
    }
    
    public async Task StartDialogueAsync(Npc npc)
    {
        NpcName = npc.Name;
        NpcPortrait = npc.Portrait;
        
        var dialogue = _dialogueService.StartDialogue(npc);
        _currentNode = dialogue.StartNode;
        
        await ShowNodeAsync(_currentNode);
    }
    
    [RelayCommand]
    private async Task ClickTextAsync()
    {
        if (IsTyping)
        {
            // Skip to end
            _typingCts?.Cancel();
            DisplayedText = FullText;
            IsTyping = false;
            ShowChoices();
        }
        else if (!HasChoices && _currentNode.AutoAdvanceNode is not null)
        {
            // Auto-advance to next node
            await AdvanceToNodeAsync(_currentNode.AutoAdvanceNode);
        }
    }
    
    [RelayCommand]
    private async Task SelectChoiceAsync(DialogueChoiceViewModel choice)
    {
        // Handle special actions
        switch (choice.Action)
        {
            case DialogueAction.AcceptQuest when choice.QuestId is not null:
                _questService.AcceptQuest(choice.QuestId);
                break;
            
            case DialogueAction.OpenShop when choice.ShopId is not null:
                _navigation.ShowDialog<ShopWindow>(choice.ShopId);
                break;
            
            case DialogueAction.Leave:
                CloseDialogue();
                return;
        }
        
        // Navigate to next node
        if (choice.NextNodeId is not null)
        {
            var nextNode = _dialogueService.GetNode(choice.NextNodeId);
            await AdvanceToNodeAsync(nextNode);
        }
        else
        {
            CloseDialogue();
        }
    }
    
    private async Task ShowNodeAsync(DialogueNode node)
    {
        _currentNode = node;
        FullText = node.Text;
        DisplayedText = string.Empty;
        HasChoices = false;
        Choices.Clear();
        
        await TypeTextAsync(node.Text);
        ShowChoices();
    }
    
    private async Task TypeTextAsync(string text)
    {
        IsTyping = true;
        _typingCts = new CancellationTokenSource();
        
        try
        {
            for (int i = 0; i <= text.Length; i++)
            {
                DisplayedText = text[..i];
                await Task.Delay(TypingSpeedMs, _typingCts.Token);
            }
        }
        catch (TaskCanceledException)
        {
            // Typing was skipped
        }
        
        IsTyping = false;
    }
    
    private void ShowChoices()
    {
        Choices.Clear();
        
        int index = 1;
        foreach (var choice in _currentNode.Choices)
        {
            if (_dialogueService.IsChoiceAvailable(choice))
            {
                Choices.Add(new DialogueChoiceViewModel(choice, index++));
            }
        }
        
        HasChoices = Choices.Count > 0;
    }
}
```

### DialogueChoiceViewModel

```csharp
public class DialogueChoiceViewModel : ViewModelBase
{
    public string Text { get; }
    public int Index { get; }
    public DialogueAction Action { get; }
    public string? QuestId { get; }
    public string? ShopId { get; }
    public string? NextNodeId { get; }
    
    public string DisplayText => $"{Index}. {Text}";
    
    public string? ActionBadge => Action switch
    {
        DialogueAction.AcceptQuest => "[ACCEPT QUEST]",
        DialogueAction.DeclineQuest => "[DECLINE]",
        DialogueAction.OpenShop => "[SHOP]",
        DialogueAction.Leave => "[LEAVE]",
        _ => null
    };
    
    public bool HasActionBadge => ActionBadge is not null;
}

public enum DialogueAction
{
    None,
    AcceptQuest,
    DeclineQuest,
    OpenShop,
    Leave,
    GiveItem,
    TakeItem
}
```

### Acceptance Criteria

- [ ] Dialogue window shows NPC portrait
- [ ] NPC name displays prominently
- [ ] Text types out character by character
- [ ] Click skips to full text
- [ ] Response choices appear after text
- [ ] Choices are numbered (1-9)
- [ ] Clicking choice advances dialogue
- [ ] Keyboard numbers select choices
- [ ] [ACCEPT QUEST] accepts quest
- [ ] [SHOP] opens shop window
- [ ] [LEAVE] closes dialogue
- [ ] Branching works correctly
- [ ] Dialogue ends properly
- [ ] ~13 unit tests pass

---

## v0.8.1c: Puzzle Window

[v0.8.1c Design Specification](v0.8.1c-design-specification.md)

### Overview

Implement a puzzle window that renders interactive puzzles with clickable/draggable elements, provides hints, tracks attempts, and gives visual feedback on success or failure. Supports multiple puzzle types (lever, sequence, matching).

### Scope

**In Scope:**
- `PuzzleWindow` modal window
- `PuzzleWindowViewModel` with puzzle state
- `PuzzleElementControl` for interactive pieces
- Puzzle description/instructions
- Interactive puzzle elements (click, toggle)
- Lever puzzle type (toggle up/down)
- Sequence puzzle type (order selection)
- Matching puzzle type (pair matching)
- Current input display
- Hint button with limited hints
- Attempt counter
- Reset button
- Success animation/feedback
- Failure feedback with shake
- Give Up option
- Puzzle solution validation

**Out of Scope:**
- Shop window (v0.8.2a)
- Dialogue window (v0.8.2b)
- Physics puzzles (future)
- Timed puzzles (future)

### Key Deliverables

| Type | Count | Details |
|------|-------|---------|
| Windows | 1 | `PuzzleWindow` |
| ViewModels | 2 | `PuzzleWindowViewModel`, `PuzzleElementViewModel` |
| User Controls | 3 | `LeverControl`, `SequenceSlotControl`, `MatchTileControl` |
| Animations | 2 | Success, failure animations |
| Styles | 1 | `PuzzleWindowStyles.axaml` |
| Unit Tests | ~10 | Puzzle logic, interaction tests |

### Puzzle Window Designs

```
LEVER PUZZLE:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    ANCIENT LEVER PUZZLE                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                      â”‚
â”‚  "Arrange the levers in the correct sequence to open the door."     â”‚
â”‚                                                                      â”‚
â”‚         â”Œâ”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”                â”‚
â”‚         â”‚  â†‘  â”‚     â”‚  â†“  â”‚     â”‚  â†‘  â”‚     â”‚  â†“  â”‚                â”‚
â”‚         â”‚  â”‚  â”‚     â”‚  â”‚  â”‚     â”‚  â”‚  â”‚     â”‚  â”‚  â”‚                â”‚
â”‚         â”‚ [A] â”‚     â”‚ [B] â”‚     â”‚ [C] â”‚     â”‚ [D] â”‚                â”‚
â”‚         â””â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”˜                â”‚
â”‚          Click       Click       Click       Click                  â”‚
â”‚                                                                      â”‚
â”‚  Current: â†‘ â†“ â†‘ â†“                                                   â”‚
â”‚  Target:  ? ? ? ?                                                   â”‚
â”‚                                                                      â”‚
â”‚  Attempts remaining: 3                                               â”‚
â”‚                                                                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚    [ Reset ]    [ Hint (2 left) ]    [ Solve ]    [ Give Up ]       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


SEQUENCE PUZZLE:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     SYMBOL SEQUENCE                                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                      â”‚
â”‚  "Press the symbols in the correct order."                          â”‚
â”‚                                                                      â”‚
â”‚       â”Œâ”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”                  â”‚
â”‚       â”‚  â˜€  â”‚  â”‚  â˜½  â”‚  â”‚  â˜…  â”‚  â”‚  â™¦  â”‚  â”‚  â™   â”‚                  â”‚
â”‚       â”‚     â”‚  â”‚     â”‚  â”‚     â”‚  â”‚     â”‚  â”‚     â”‚                  â”‚
â”‚       â”‚ [1] â”‚  â”‚ [2] â”‚  â”‚ [3] â”‚  â”‚ [4] â”‚  â”‚ [5] â”‚                  â”‚
â”‚       â””â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”˜                  â”‚
â”‚                                                                      â”‚
â”‚  Your sequence:  â˜€  â˜…  _  _  _                    (2 of 5)         â”‚
â”‚                                                                      â”‚
â”‚  Hint: "The moon comes before the diamond"                          â”‚
â”‚                                                                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚    [ Reset ]    [ Hint (1 left) ]    [ Solve ]    [ Give Up ]       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


MATCHING PUZZLE:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      MEMORY MATCHING                                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                      â”‚
â”‚  "Find all matching pairs."                                         â”‚
â”‚                                                                      â”‚
â”‚       â”Œâ”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”                           â”‚
â”‚       â”‚  ?  â”‚  â”‚  â˜€  â”‚  â”‚  ?  â”‚  â”‚  â˜€  â”‚  â† Matched!               â”‚
â”‚       â””â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”˜                           â”‚
â”‚       â”Œâ”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”                           â”‚
â”‚       â”‚  ?  â”‚  â”‚  ?  â”‚  â”‚  â˜…  â”‚  â”‚  ?  â”‚  â† One revealed           â”‚
â”‚       â””â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”˜                           â”‚
â”‚                                                                      â”‚
â”‚  Pairs found: 1 / 4                                                 â”‚
â”‚  Moves: 5                                                           â”‚
â”‚                                                                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                     [ Reset ]    [ Give Up ]                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


SUCCESS FEEDBACK:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                                      â”‚
â”‚                   â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—                   â”‚
â”‚                   â•‘                             â•‘                   â”‚
â”‚                   â•‘      ğŸ‰ PUZZLE SOLVED! ğŸ‰   â•‘                   â”‚
â”‚                   â•‘                             â•‘                   â”‚
â”‚                   â•‘    The door creaks open...  â•‘                   â”‚
â”‚                   â•‘                             â•‘                   â”‚
â”‚                   â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•                   â”‚
â”‚                                                                      â”‚
â”‚                          [ Continue ]                                â”‚
â”‚                                                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### PuzzleWindowViewModel

```csharp
namespace RuneAndRust.Avalonia.ViewModels;

public partial class PuzzleWindowViewModel : ViewModelBase
{
    private readonly IPuzzleService _puzzleService;
    private readonly INavigationService _navigation;
    
    [ObservableProperty]
    private Puzzle _puzzle;
    
    [ObservableProperty]
    private string _title;
    
    [ObservableProperty]
    private string _instructions;
    
    [ObservableProperty]
    private PuzzleType _puzzleType;
    
    [ObservableProperty]
    private ObservableCollection<PuzzleElementViewModel> _elements = new();
    
    [ObservableProperty]
    private string _currentInput = string.Empty;
    
    [ObservableProperty]
    private int _attemptsRemaining;
    
    [ObservableProperty]
    private int _hintsRemaining;
    
    [ObservableProperty]
    private string? _currentHint;
    
    [ObservableProperty]
    private bool _isSolved;
    
    [ObservableProperty]
    private bool _hasFailed;
    
    [ObservableProperty]
    private string? _resultMessage;
    
    public PuzzleWindowViewModel(IPuzzleService puzzleService)
    {
        _puzzleService = puzzleService;
    }
    
    public void LoadPuzzle(Puzzle puzzle)
    {
        Puzzle = puzzle;
        Title = puzzle.Name;
        Instructions = puzzle.Instructions;
        PuzzleType = puzzle.Type;
        AttemptsRemaining = puzzle.MaxAttempts;
        HintsRemaining = puzzle.Hints.Count;
        
        LoadElements(puzzle);
    }
    
    [RelayCommand]
    private void ToggleElement(PuzzleElementViewModel element)
    {
        if (PuzzleType == PuzzleType.Lever)
        {
            element.IsToggled = !element.IsToggled;
            UpdateCurrentInput();
        }
    }
    
    [RelayCommand]
    private void SelectElement(PuzzleElementViewModel element)
    {
        if (PuzzleType == PuzzleType.Sequence)
        {
            // Add to sequence
            element.SelectionOrder = GetNextSelectionOrder();
            UpdateCurrentInput();
        }
    }
    
    [RelayCommand]
    private void Solve()
    {
        var result = _puzzleService.ValidateSolution(Puzzle, GetCurrentSolution());
        
        if (result.IsCorrect)
        {
            IsSolved = true;
            ResultMessage = "ğŸ‰ PUZZLE SOLVED! ğŸ‰\n\n" + Puzzle.SuccessMessage;
            _puzzleService.MarkPuzzleSolved(Puzzle);
        }
        else
        {
            AttemptsRemaining--;
            
            if (AttemptsRemaining <= 0)
            {
                HasFailed = true;
                ResultMessage = "Puzzle failed!\n\n" + Puzzle.FailureMessage;
            }
            else
            {
                ShakeAnimation();
                ResultMessage = $"Incorrect. {AttemptsRemaining} attempts remaining.";
            }
        }
    }
    
    [RelayCommand(CanExecute = nameof(CanUseHint))]
    private void UseHint()
    {
        if (HintsRemaining <= 0) return;
        
        var hintIndex = Puzzle.Hints.Count - HintsRemaining;
        CurrentHint = Puzzle.Hints[hintIndex];
        HintsRemaining--;
    }
    
    private bool CanUseHint => HintsRemaining > 0;
    
    [RelayCommand]
    private void Reset()
    {
        foreach (var element in Elements)
        {
            element.Reset();
        }
        CurrentInput = string.Empty;
        ResultMessage = null;
    }
    
    [RelayCommand]
    private void GiveUp()
    {
        HasFailed = true;
        ResultMessage = "You gave up on the puzzle.\n\n" + Puzzle.FailureMessage;
        _navigation.CloseDialog();
    }
}
```

### PuzzleElementViewModel

```csharp
public partial class PuzzleElementViewModel : ViewModelBase
{
    [ObservableProperty]
    private string _id;
    
    [ObservableProperty]
    private string _symbol;
    
    [ObservableProperty]
    private bool _isToggled;
    
    [ObservableProperty]
    private int _selectionOrder = -1;
    
    [ObservableProperty]
    private bool _isRevealed;
    
    [ObservableProperty]
    private bool _isMatched;
    
    public string DisplaySymbol => IsToggled ? "â†“" : "â†‘"; // For lever
    
    public bool IsSelected => SelectionOrder >= 0;
    
    public void Reset()
    {
        IsToggled = false;
        SelectionOrder = -1;
        IsRevealed = false;
    }
}
```

### Acceptance Criteria

- [ ] Puzzle window shows title and instructions
- [ ] Lever puzzle toggles on click
- [ ] Sequence puzzle records order
- [ ] Matching puzzle reveals tiles
- [ ] Current input updates correctly
- [ ] Solve button validates solution
- [ ] Success shows celebration
- [ ] Failure decrements attempts
- [ ] Hint button reveals hints
- [ ] Hint count decrements
- [ ] Reset clears puzzle state
- [ ] Give Up closes with failure
- [ ] Animations play correctly
- [ ] ~10 unit tests pass

---

## Dependencies & Prerequisites

```
v0.8.1c (Tooltip Service) - REQUIRED
    â”‚
    â””â”€â”€ Navigation & Information complete â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                                                          â”‚
v0.8.2 (Interaction Windows)                                              â”‚
    â”‚                                                                     â”‚
    â”œâ”€â”€ v0.8.2a: Shop Window â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
    â”‚       Dependencies: ShopService, InventoryPanel, TooltipService     â”‚
    â”‚       Provides: ShopWindow, item comparison                         â”‚
    â”‚                                                                     â”‚
    â”œâ”€â”€ v0.8.2b: Dialogue Window â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
    â”‚       Dependencies: DialogueService, QuestService, v0.8.2a (shop)   â”‚
    â”‚       Provides: DialogueWindow, typing animation                    â”‚
    â”‚                                                                     â”‚
    â””â”€â”€ v0.8.1c: Puzzle Window â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            Dependencies: PuzzleService
            Provides: PuzzleWindow, puzzle elements
```

---

## Estimated Effort Summary

| Part | New Files | Modified Files | Est. Tests | Complexity |
|------|-----------|----------------|------------|------------|
| v0.8.2a | ~5 | ~2 | ~12 | Medium-High |
| v0.8.2b | ~5 | ~1 | ~13 | High |
| v0.8.1c | ~6 | ~1 | ~10 | High |
| **Total** | **~16** | **~4** | **~35** | |

---

## Risk Assessment

| Risk | Impact | Probability | Mitigation |
|------|--------|-------------|------------|
| Typing animation timing | Low | Low | Configurable speed |
| Dialogue tree complexity | Medium | Medium | Clear node structure |
| Puzzle variety | Medium | Medium | Abstract puzzle renderer |
| Transaction edge cases | Low | Low | Validate all conditions |

---

## Design Decisions (Confirmed)

### Shop Window

| Decision | Value | Notes |
|----------|-------|-------|
| **Layout** | Dual list | Shop + Player inventories |
| **Comparison** | Inline | Below item details |
| **Transactions** | Immediate | With feedback message |

### Dialogue Window

| Decision | Value | Notes |
|----------|-------|-------|
| **Typing Speed** | ~33 chars/sec | 30ms delay |
| **Skip** | Click anywhere | Fast-forward |
| **Choices** | Numbered | 1-9 keyboard support |

### Puzzle Window

| Decision | Value | Notes |
|----------|-------|-------|
| **Puzzle Types** | Lever, Sequence, Matching | Extensible |
| **Hints** | Limited | Per puzzle definition |
| **Attempts** | Limited | With failure state |

---

## Next Steps

1. **Review & Approve** - Confirm scope breakdown
2. **v0.8.2a Design Spec** - Create detailed design for Shop Window
3. **v0.8.2a Implementation** - Build buy/sell interface
4. **v0.8.2b Design Spec** - Create specification for Dialogue Window
5. **v0.8.2b Implementation** - Build conversation UI
6. **v0.8.1c Design Spec** - Create specification for Puzzle Window
7. **v0.8.1c Implementation** - Build puzzle interaction system

---

*This scope breakdown provides a structured approach to implementing v0.8.2 Interaction Windows. These specialized windows handle complex game interactions with rich UI patterns for shops, conversations, and puzzles.*
