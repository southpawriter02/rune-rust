# v0.11.1 Recipes & Discovery - Scope Breakdown

**Version:** 0.11.1
**Theme:** Recipes & Discovery
**Prerequisites:** v0.11.0c Complete (Resources & Gathering - Gathering Service)
**Total Estimated Tests:** ~25 new tests

---

## Executive Summary

The Recipes & Discovery sub-version implements the recipe system including recipe definitions, player recipe books, and recipe discovery through exploration. Players find recipe scrolls in the dungeon that teach new crafting recipes. Some basic recipes are known from the start.

Key focus areas:
- **Recipe Definitions**: Recipes with ingredients and outputs
- **Recipe Book**: Player's collection of known recipes
- **Discovery System**: Recipe scrolls and learning mechanics

The work is divided into **three sub-parts**:

| Part | Name | Focus | Est. Tests |
|------|------|-------|------------|
| v0.11.1a | Recipe Definitions | RecipeDefinition, ingredients, outputs, config | ~9 |
| v0.11.1b | Recipe Book | Player recipe book, known recipes tracking | ~8 |
| v0.11.1c | Recipe Discovery | Recipe scrolls, learn command, loot integration | ~8 |

---

## Existing Infrastructure

### Already Implemented (from prior versions)

| Feature | Location | Notes |
|---------|----------|-------|
| Item | `Domain/Entities/Item.cs` | Base item entity |
| ItemDefinition | `Domain/Definitions/ItemDefinition.cs` | Item templates |
| Inventory | `Domain/Entities/Inventory.cs` | Item storage |
| Player | `Domain/Entities/Player.cs` | Player entity |
| LootService | `Application/Services/LootService.cs` | Loot generation |

### Already Implemented (from v0.11.1)

| Feature | Location | Notes |
|---------|----------|-------|
| ResourceDefinition | `Domain/Definitions/ResourceDefinition.cs` | Resource types |
| IResourceProvider | `Application/Interfaces/IResourceProvider.cs` | Resource loading |
| ResourceCategory | `Domain/Enums/ResourceCategory.cs` | Category enum |

### Needs Implementation (v0.11.1)

| Feature | Part | Notes |
|---------|------|-------|
| RecipeDefinition | v0.11.1a | Recipe templates |
| RecipeIngredient | v0.11.1a | Ingredient record |
| RecipeOutput | v0.11.1a | Output record |
| RecipeCategory | v0.11.1a | Category enum |
| IRecipeProvider | v0.11.1a | Config loading |
| RecipeBook | v0.11.1b | Player's recipes |
| IRecipeService | v0.11.1b | Recipe interface |
| RecipeService | v0.11.1b | Recipe management |
| RecipeScroll | v0.11.0c | Scroll item |
| LearnRecipeCommand | v0.11.0c | Learn command |

---

## Feature Analysis & Categorization

### Recipe Definition Features

| Feature | Complexity | Dependencies | Assigned Part |
|---------|------------|--------------|---------------|
| RecipeDefinition entity | Medium | Domain | **v0.11.1a** |
| RecipeIngredient record | Low | Resources | **v0.11.1a** |
| RecipeOutput record | Low | Items | **v0.11.1a** |
| RecipeCategory enum | Low | Domain | **v0.11.1a** |
| IRecipeProvider interface | Low | Config | **v0.11.1a** |
| recipes.json config | Medium | Configuration | **v0.11.1a** |

### Recipe Book Features

| Feature | Complexity | Dependencies | Assigned Part |
|---------|------------|--------------|---------------|
| RecipeBook entity | Medium | Player | **v0.11.1b** |
| Player recipe tracking | Medium | Player update | **v0.11.1b** |
| IRecipeService interface | Medium | Application | **v0.11.1b** |
| RecipeService impl | Medium | Service | **v0.11.1b** |
| Default recipes | Low | Config | **v0.11.1b** |
| Recipe list command | Low | Commands | **v0.11.1b** |

### Recipe Discovery Features

| Feature | Complexity | Dependencies | Assigned Part |
|---------|------------|--------------|---------------|
| RecipeScroll item | Medium | Items | **v0.11.0c** |
| Recipe scroll generation | Medium | Loot | **v0.11.0c** |
| LearnRecipeCommand | Medium | Commands | **v0.11.0c** |
| Scroll consumption | Low | Inventory | **v0.11.0c** |
| Already-known check | Low | RecipeBook | **v0.11.0c** |
| Discovery events | Low | Events | **v0.11.0c** |

---

## Part Definitions

---

## v0.11.1a: Recipe Definitions

[v0.11.1a Design Specification](v0.11.1a-design-specification.md)

### Overview

Define the recipe data model including recipe definitions with ingredients, outputs, required stations, and difficulty classes. Recipes are loaded from JSON configuration and specify what resources are needed to craft items.

### Scope

**In Scope:**
- `RecipeDefinition` entity
- `RecipeIngredient` record
- `RecipeOutput` record
- `RecipeCategory` enum (Weapon, Armor, Potion, etc.)
- Required station reference
- Difficulty class for crafting
- Default recipe flag
- `IRecipeProvider` interface
- `RecipeProvider` implementation
- `recipes.json` configuration

**Out of Scope:**
- Recipe books (v0.11.1b)
- Recipe scrolls (v0.11.0c)

### Key Deliverables

| Type | Count | Details |
|------|-------|---------|
| Domain Entities | 1 | `RecipeDefinition` |
| Domain Records | 2 | `RecipeIngredient`, `RecipeOutput` |
| Domain Enums | 1 | `RecipeCategory` |
| Interfaces | 1 | `IRecipeProvider` |
| Infrastructure | 1 | `RecipeProvider` |
| Configuration | 1 | `recipes.json` |
| Unit Tests | ~9 | Definition loading, validation |

### Recipe Definition Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   RECIPE DEFINITION ARCHITECTURE                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

     Configuration                        Domain
     â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                        â”€â”€â”€â”€â”€â”€

   recipes.json                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚       RecipeDefinition      â”‚
   â”‚ {                â”‚           â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
   â”‚   "id": "iron-", â”‚  â”€â”€â”€â”€â”€â–¶   â”‚ + RecipeId: string          â”‚
   â”‚   "name": ...,   â”‚           â”‚ + Name: string              â”‚
   â”‚   "ingredients":,â”‚           â”‚ + Description: string       â”‚
   â”‚   "output": ..., â”‚           â”‚ + Category: RecipeCategory  â”‚
   â”‚   "station": ... â”‚           â”‚ + RequiredStationId: string â”‚
   â”‚ }                â”‚           â”‚ + Ingredients: List<Ingr>   â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚ + Output: RecipeOutput      â”‚
                                  â”‚ + DifficultyClass: int      â”‚
                                  â”‚ + IsDefault: bool           â”‚
                                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


    RECIPE STRUCTURE EXAMPLE
    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  RECIPE: Iron Sword                                              â”‚
    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
    â”‚                                                                  â”‚
    â”‚  Category: Weapon                         Station: Anvil ğŸ”¨     â”‚
    â”‚  Difficulty: DC 12                        Default: Yes          â”‚
    â”‚                                                                  â”‚
    â”‚  INGREDIENTS:                             OUTPUT:                â”‚
    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
    â”‚  â”‚ ğŸª¨ Iron Ore      x5  â”‚               â”‚ âš”ï¸ Iron Sword     â”‚  â”‚
    â”‚  â”‚ ğŸ¦Œ Leather       x2  â”‚        â–¶      â”‚    Quantity: 1    â”‚  â”‚
    â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
    â”‚                                                                  â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


    RECIPE CATEGORIES
    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    WEAPON          ARMOR           POTION          CONSUMABLE
    â”€â”€â”€â”€â”€â”€          â”€â”€â”€â”€â”€           â”€â”€â”€â”€â”€â”€          â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    â”Œâ”€â”€â”€â”€â”€â”        â”Œâ”€â”€â”€â”€â”€â”        â”Œâ”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”
    â”‚ âš”ï¸  â”‚        â”‚ ğŸ›¡ï¸  â”‚        â”‚ ğŸ§ª  â”‚         â”‚ ğŸ–  â”‚
    â”‚     â”‚        â”‚     â”‚        â”‚     â”‚         â”‚     â”‚
    â””â”€â”€â”€â”€â”€â”˜        â””â”€â”€â”€â”€â”€â”˜        â””â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”˜
    
    ACCESSORY       TOOL            MATERIAL
    â”€â”€â”€â”€â”€â”€â”€â”€â”€       â”€â”€â”€â”€            â”€â”€â”€â”€â”€â”€â”€â”€
    â”Œâ”€â”€â”€â”€â”€â”        â”Œâ”€â”€â”€â”€â”€â”        â”Œâ”€â”€â”€â”€â”€â”
    â”‚ ğŸ’  â”‚        â”‚ ğŸ”§  â”‚        â”‚ ğŸ§±  â”‚
    â”‚     â”‚        â”‚     â”‚        â”‚     â”‚
    â””â”€â”€â”€â”€â”€â”˜        â””â”€â”€â”€â”€â”€â”˜        â””â”€â”€â”€â”€â”€â”˜
```

### RecipeDefinition Entity

```csharp
namespace RuneAndRust.Domain.Definitions;

/// <summary>
/// Defines a crafting recipe with ingredients and output.
/// </summary>
public class RecipeDefinition : IEntity
{
    public Guid Id { get; private set; }
    public string RecipeId { get; private set; } = null!;
    public string Name { get; private set; } = null!;
    public string Description { get; private set; } = null!;
    public RecipeCategory Category { get; private set; }
    public string RequiredStationId { get; private set; } = null!;
    public IReadOnlyList<RecipeIngredient> Ingredients { get; private set; } = [];
    public RecipeOutput Output { get; private set; } = null!;
    public int DifficultyClass { get; private set; }
    public bool IsDefault { get; private set; }
    public string? IconPath { get; private set; }
    
    private RecipeDefinition() { }
    
    public static RecipeDefinition Create(
        string recipeId,
        string name,
        string description,
        RecipeCategory category,
        string requiredStationId,
        IEnumerable<RecipeIngredient> ingredients,
        RecipeOutput output,
        int difficultyClass,
        bool isDefault = false)
    {
        ArgumentException.ThrowIfNullOrWhiteSpace(recipeId);
        ArgumentException.ThrowIfNullOrWhiteSpace(name);
        ArgumentException.ThrowIfNullOrWhiteSpace(requiredStationId);
        ArgumentOutOfRangeException.ThrowIfNegativeOrZero(difficultyClass);
        
        var ingredientList = ingredients.ToList();
        if (ingredientList.Count == 0)
            throw new ArgumentException("Recipe must have at least one ingredient");
        
        return new RecipeDefinition
        {
            Id = Guid.NewGuid(),
            RecipeId = recipeId.ToLowerInvariant(),
            Name = name,
            Description = description,
            Category = category,
            RequiredStationId = requiredStationId.ToLowerInvariant(),
            Ingredients = ingredientList,
            Output = output,
            DifficultyClass = difficultyClass,
            IsDefault = isDefault
        };
    }
    
    /// <summary>Gets the total value of ingredients.</summary>
    public int GetIngredientCost(IResourceProvider resourceProvider)
    {
        return Ingredients.Sum(i => 
        {
            var resource = resourceProvider.GetResource(i.ResourceId);
            return resource?.GetActualValue() * i.Quantity ?? 0;
        });
    }
    
    /// <summary>Checks if all ingredients are available.</summary>
    public bool HasIngredients(IInventory inventory)
    {
        return Ingredients.All(i => inventory.GetResourceCount(i.ResourceId) >= i.Quantity);
    }
}
```

### RecipeIngredient and RecipeOutput Records

```csharp
namespace RuneAndRust.Domain.Definitions;

/// <summary>
/// An ingredient required for a recipe.
/// </summary>
public record RecipeIngredient(string ResourceId, int Quantity)
{
    public RecipeIngredient(string resourceId, int quantity) : this(resourceId.ToLowerInvariant(), quantity)
    {
        ArgumentException.ThrowIfNullOrWhiteSpace(resourceId);
        ArgumentOutOfRangeException.ThrowIfNegativeOrZero(quantity);
    }
}

/// <summary>
/// The output produced by a recipe.
/// </summary>
public record RecipeOutput(string ItemId, int Quantity, string? QualityFormula = null)
{
    public RecipeOutput(string itemId, int quantity, string? qualityFormula = null) 
        : this(itemId.ToLowerInvariant(), quantity, qualityFormula)
    {
        ArgumentException.ThrowIfNullOrWhiteSpace(itemId);
        ArgumentOutOfRangeException.ThrowIfNegativeOrZero(quantity);
    }
    
    /// <summary>Whether this output has quality scaling.</summary>
    public bool HasQualityScaling => QualityFormula is not null;
}
```

### RecipeCategory Enum

```csharp
namespace RuneAndRust.Domain.Enums;

/// <summary>
/// Categories of craftable recipes.
/// </summary>
public enum RecipeCategory
{
    Weapon,     // Swords, axes, bows
    Armor,      // Helmets, chestplates, boots
    Potion,     // Healing, mana, buffs
    Consumable, // Food, scrolls
    Accessory,  // Rings, amulets
    Tool,       // Pickaxes, gathering tools
    Material    // Intermediate crafting materials
}
```

### IRecipeProvider Interface

```csharp
namespace RuneAndRust.Application.Interfaces;

/// <summary>
/// Provides recipe definitions.
/// </summary>
public interface IRecipeProvider
{
    /// <summary>Gets a recipe by ID.</summary>
    RecipeDefinition? GetRecipe(string recipeId);
    
    /// <summary>Gets all recipes.</summary>
    IReadOnlyList<RecipeDefinition> GetAllRecipes();
    
    /// <summary>Gets recipes by category.</summary>
    IReadOnlyList<RecipeDefinition> GetRecipesByCategory(RecipeCategory category);
    
    /// <summary>Gets recipes for a specific station.</summary>
    IReadOnlyList<RecipeDefinition> GetRecipesForStation(string stationId);
    
    /// <summary>Gets all default (starter) recipes.</summary>
    IReadOnlyList<RecipeDefinition> GetDefaultRecipes();
    
    /// <summary>Gets recipes that produce a specific item.</summary>
    IReadOnlyList<RecipeDefinition> GetRecipesForItem(string itemId);
    
    /// <summary>Checks if a recipe exists.</summary>
    bool Exists(string recipeId);
}
```

### Recipe Configuration

```json
{
  "$schema": "./schemas/recipes.schema.json",
  "recipes": [
    {
      "id": "iron-sword",
      "name": "Iron Sword",
      "description": "Forge a basic iron sword",
      "category": "Weapon",
      "requiredStation": "anvil",
      "ingredients": [
        { "resourceId": "iron-ore", "quantity": 5 },
        { "resourceId": "leather", "quantity": 2 }
      ],
      "output": {
        "itemId": "iron-sword",
        "quantity": 1
      },
      "difficultyClass": 12,
      "isDefault": true,
      "icon": "icons/recipes/iron_sword.png"
    },
    {
      "id": "iron-helmet",
      "name": "Iron Helmet",
      "description": "Forge a protective iron helmet",
      "category": "Armor",
      "requiredStation": "anvil",
      "ingredients": [
        { "resourceId": "iron-ore", "quantity": 4 },
        { "resourceId": "leather", "quantity": 1 }
      ],
      "output": {
        "itemId": "iron-helmet",
        "quantity": 1
      },
      "difficultyClass": 12,
      "isDefault": true
    },
    {
      "id": "healing-potion",
      "name": "Healing Potion",
      "description": "Brew a restorative potion",
      "category": "Potion",
      "requiredStation": "alchemy-table",
      "ingredients": [
        { "resourceId": "healing-herb", "quantity": 3 },
        { "resourceId": "empty-vial", "quantity": 1 }
      ],
      "output": {
        "itemId": "healing-potion",
        "quantity": 1
      },
      "difficultyClass": 10,
      "isDefault": true
    },
    {
      "id": "mana-potion",
      "name": "Mana Potion",
      "description": "Brew a potion to restore mana",
      "category": "Potion",
      "requiredStation": "alchemy-table",
      "ingredients": [
        { "resourceId": "mana-leaf", "quantity": 3 },
        { "resourceId": "empty-vial", "quantity": 1 }
      ],
      "output": {
        "itemId": "mana-potion",
        "quantity": 1
      },
      "difficultyClass": 12,
      "isDefault": true
    },
    {
      "id": "leather-armor",
      "name": "Leather Armor",
      "description": "Craft a suit of leather armor",
      "category": "Armor",
      "requiredStation": "workbench",
      "ingredients": [
        { "resourceId": "leather", "quantity": 6 },
        { "resourceId": "linen", "quantity": 2 }
      ],
      "output": {
        "itemId": "leather-armor",
        "quantity": 1
      },
      "difficultyClass": 11,
      "isDefault": true
    },
    {
      "id": "steel-sword",
      "name": "Steel Sword",
      "description": "Forge a superior steel blade",
      "category": "Weapon",
      "requiredStation": "anvil",
      "ingredients": [
        { "resourceId": "iron-ore", "quantity": 8 },
        { "resourceId": "coal", "quantity": 4 },
        { "resourceId": "leather", "quantity": 2 }
      ],
      "output": {
        "itemId": "steel-sword",
        "quantity": 1
      },
      "difficultyClass": 14,
      "isDefault": false
    },
    {
      "id": "mithril-blade",
      "name": "Mithril Blade",
      "description": "Forge a legendary mithril weapon",
      "category": "Weapon",
      "requiredStation": "anvil",
      "ingredients": [
        { "resourceId": "mithril-ore", "quantity": 10 },
        { "resourceId": "dragon-scale", "quantity": 2 },
        { "resourceId": "ruby", "quantity": 1 }
      ],
      "output": {
        "itemId": "mithril-blade",
        "quantity": 1,
        "qualityFormula": "roll >= 20 ? 'Legendary' : roll >= 15 ? 'Epic' : 'Rare'"
      },
      "difficultyClass": 18,
      "isDefault": false
    },
    {
      "id": "fire-resistance-potion",
      "name": "Fire Resistance Potion",
      "description": "A potion that grants fire resistance",
      "category": "Potion",
      "requiredStation": "alchemy-table",
      "ingredients": [
        { "resourceId": "firebloom", "quantity": 2 },
        { "resourceId": "mana-leaf", "quantity": 1 },
        { "resourceId": "empty-vial", "quantity": 1 }
      ],
      "output": {
        "itemId": "fire-resistance-potion",
        "quantity": 1
      },
      "difficultyClass": 15,
      "isDefault": false
    },
    {
      "id": "iron-pickaxe",
      "name": "Iron Pickaxe",
      "description": "Forge a sturdy iron pickaxe for mining",
      "category": "Tool",
      "requiredStation": "anvil",
      "ingredients": [
        { "resourceId": "iron-ore", "quantity": 4 },
        { "resourceId": "oak-wood", "quantity": 2 }
      ],
      "output": {
        "itemId": "iron-pickaxe",
        "quantity": 1
      },
      "difficultyClass": 11,
      "isDefault": true
    },
    {
      "id": "iron-ingot",
      "name": "Iron Ingot",
      "description": "Smelt iron ore into a refined ingot",
      "category": "Material",
      "requiredStation": "anvil",
      "ingredients": [
        { "resourceId": "iron-ore", "quantity": 2 }
      ],
      "output": {
        "itemId": "iron-ingot",
        "quantity": 1
      },
      "difficultyClass": 8,
      "isDefault": true
    }
  ]
}
```

### Acceptance Criteria

- [ ] RecipeDefinition loads from JSON
- [ ] Ingredients list with resource IDs
- [ ] Output specifies item ID and quantity
- [ ] Category classifies recipes
- [ ] RequiredStationId links to stations
- [ ] DifficultyClass specifies crafting DC
- [ ] IsDefault marks starter recipes
- [ ] QualityFormula optional for outputs
- [ ] GetRecipesByCategory filters correctly
- [ ] GetRecipesForStation filters correctly
- [ ] ~9 unit tests pass

---

## v0.11.1b: Recipe Book

[v0.11.1b Design Specification](v0.11.1b-design-specification.md)

### Overview

Implement the player's recipe book that tracks which recipes they know. Players start with default recipes and learn new ones through discovery. The recipe service manages the recipe book and provides query capabilities.

### Scope

**In Scope:**
- `RecipeBook` entity
- Player.RecipeBook property
- KnownRecipes collection
- Default recipe initialization
- `IRecipeService` interface
- `RecipeService` implementation
- LearnRecipe method
- IsRecipeKnown check
- GetKnownRecipes queries
- GetCraftableRecipes (station + known)
- `RecipesCommand` for listing

**Out of Scope:**
- Recipe definitions (v0.11.1a)
- Recipe scrolls (v0.11.0c)

### Key Deliverables

| Type | Count | Details |
|------|-------|---------|
| Domain Entities | 1 | `RecipeBook` |
| Player Updates | 1 | RecipeBook property |
| Interfaces | 1 | `IRecipeService` |
| Services | 1 | `RecipeService` |
| Commands | 1 | `RecipesCommand` |
| Unit Tests | ~8 | Recipe book, service tests |

### Recipe Book Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    RECIPE BOOK ARCHITECTURE                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

                      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                      â”‚         Player             â”‚
                      â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
                      â”‚ + RecipeBook: RecipeBook  â”‚
                      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                      â”‚ contains
                                      â–¼
                      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                      â”‚        RecipeBook          â”‚
                      â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
                      â”‚ + KnownRecipeIds: Set     â”‚
                      â”‚ + LearnedAt: Dict         â”‚
                      â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
                      â”‚ + IsKnown(recipeId): bool â”‚
                      â”‚ + Learn(recipeId): bool   â”‚
                      â”‚ + GetKnownIds(): list     â”‚
                      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                      â”‚
                      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                      â”‚       IRecipeService       â”‚
                      â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
                      â”‚ + GetKnownRecipes(player) â”‚
                      â”‚ + LearnRecipe(player, id) â”‚
                      â”‚ + IsKnown(player, id)     â”‚
                      â”‚ + GetCraftable(player, st)â”‚
                      â”‚ + InitializeDefaults(plyr)â”‚
                      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


    RECIPE BOOK UI
    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    > recipes

    â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
    â•‘  RECIPE BOOK                                         Known: 7/15  â•‘
    â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
    â•‘                                                                   â•‘
    â•‘  WEAPONS (2)                                                      â•‘
    â•‘  â”œâ”€ âœ“ Iron Sword         [Default]  Station: Anvil     DC: 12    â•‘
    â•‘  â””â”€ âœ“ Steel Sword        [Learned]  Station: Anvil     DC: 14    â•‘
    â•‘                                                                   â•‘
    â•‘  ARMOR (2)                                                        â•‘
    â•‘  â”œâ”€ âœ“ Iron Helmet        [Default]  Station: Anvil     DC: 12    â•‘
    â•‘  â””â”€ âœ“ Leather Armor      [Default]  Station: Workbench DC: 11    â•‘
    â•‘                                                                   â•‘
    â•‘  POTIONS (2)                                                      â•‘
    â•‘  â”œâ”€ âœ“ Healing Potion     [Default]  Station: Alchemy   DC: 10    â•‘
    â•‘  â””â”€ âœ“ Mana Potion        [Default]  Station: Alchemy   DC: 12    â•‘
    â•‘                                                                   â•‘
    â•‘  TOOLS (1)                                                        â•‘
    â•‘  â””â”€ âœ“ Iron Pickaxe       [Default]  Station: Anvil     DC: 11    â•‘
    â•‘                                                                   â•‘
    â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
```

### RecipeBook Entity

```csharp
namespace RuneAndRust.Domain.Entities;

/// <summary>
/// Tracks recipes known by a player.
/// </summary>
public class RecipeBook : IEntity
{
    public Guid Id { get; private set; }
    public Guid PlayerId { get; private set; }
    
    private readonly HashSet<string> _knownRecipeIds = new();
    private readonly Dictionary<string, DateTime> _learnedAt = new();
    
    /// <summary>Gets all known recipe IDs.</summary>
    public IReadOnlySet<string> KnownRecipeIds => _knownRecipeIds;
    
    private RecipeBook() { }
    
    public static RecipeBook Create(Guid playerId)
    {
        return new RecipeBook
        {
            Id = Guid.NewGuid(),
            PlayerId = playerId
        };
    }
    
    /// <summary>Checks if a recipe is known.</summary>
    public bool IsKnown(string recipeId)
    {
        return _knownRecipeIds.Contains(recipeId.ToLowerInvariant());
    }
    
    /// <summary>Learns a recipe. Returns false if already known.</summary>
    public bool Learn(string recipeId)
    {
        var normalizedId = recipeId.ToLowerInvariant();
        if (_knownRecipeIds.Contains(normalizedId))
        {
            return false;
        }
        
        _knownRecipeIds.Add(normalizedId);
        _learnedAt[normalizedId] = DateTime.UtcNow;
        return true;
    }
    
    /// <summary>Gets when a recipe was learned.</summary>
    public DateTime? GetLearnedDate(string recipeId)
    {
        return _learnedAt.TryGetValue(recipeId.ToLowerInvariant(), out var date) ? date : null;
    }
    
    /// <summary>Gets the count of known recipes.</summary>
    public int KnownCount => _knownRecipeIds.Count;
    
    /// <summary>Initializes with default recipes.</summary>
    public void InitializeDefaults(IEnumerable<string> defaultRecipeIds)
    {
        foreach (var recipeId in defaultRecipeIds)
        {
            Learn(recipeId);
        }
    }
}
```

### IRecipeService Interface

```csharp
namespace RuneAndRust.Application.Interfaces;

/// <summary>
/// Service for managing player recipes.
/// </summary>
public interface IRecipeService
{
    /// <summary>Gets all recipes known by a player.</summary>
    IReadOnlyList<RecipeDefinition> GetKnownRecipes(Player player);
    
    /// <summary>Gets known recipes by category.</summary>
    IReadOnlyList<RecipeDefinition> GetKnownRecipesByCategory(Player player, RecipeCategory category);
    
    /// <summary>Gets recipes craftable at a specific station.</summary>
    IReadOnlyList<RecipeDefinition> GetCraftableRecipes(Player player, string stationId);
    
    /// <summary>Checks if a player knows a recipe.</summary>
    bool IsRecipeKnown(Player player, string recipeId);
    
    /// <summary>Teaches a recipe to a player.</summary>
    LearnRecipeResult LearnRecipe(Player player, string recipeId);
    
    /// <summary>Initializes default recipes for a new player.</summary>
    void InitializeDefaultRecipes(Player player);
    
    /// <summary>Gets a recipe by ID if the player knows it.</summary>
    RecipeDefinition? GetKnownRecipe(Player player, string recipeId);
    
    /// <summary>Checks if player can craft a recipe (knows + has ingredients).</summary>
    CraftValidation CanCraft(Player player, string recipeId, string? stationId);
}
```

### RecipeService Implementation

```csharp
namespace RuneAndRust.Application.Services;

public class RecipeService : IRecipeService
{
    private readonly IRecipeProvider _recipeProvider;
    private readonly IResourceProvider _resourceProvider;
    private readonly IEventBus _eventBus;
    private readonly ILogger<RecipeService> _logger;
    
    public RecipeService(
        IRecipeProvider recipeProvider,
        IResourceProvider resourceProvider,
        IEventBus eventBus,
        ILogger<RecipeService> logger)
    {
        _recipeProvider = recipeProvider;
        _resourceProvider = resourceProvider;
        _eventBus = eventBus;
        _logger = logger;
    }
    
    public IReadOnlyList<RecipeDefinition> GetKnownRecipes(Player player)
    {
        return _recipeProvider.GetAllRecipes()
            .Where(r => player.RecipeBook.IsKnown(r.RecipeId))
            .ToList();
    }
    
    public IReadOnlyList<RecipeDefinition> GetKnownRecipesByCategory(Player player, RecipeCategory category)
    {
        return GetKnownRecipes(player)
            .Where(r => r.Category == category)
            .ToList();
    }
    
    public IReadOnlyList<RecipeDefinition> GetCraftableRecipes(Player player, string stationId)
    {
        return _recipeProvider.GetRecipesForStation(stationId)
            .Where(r => player.RecipeBook.IsKnown(r.RecipeId))
            .ToList();
    }
    
    public bool IsRecipeKnown(Player player, string recipeId)
    {
        return player.RecipeBook.IsKnown(recipeId);
    }
    
    public LearnRecipeResult LearnRecipe(Player player, string recipeId)
    {
        var recipe = _recipeProvider.GetRecipe(recipeId);
        if (recipe is null)
        {
            return LearnRecipeResult.RecipeNotFound(recipeId);
        }
        
        if (player.RecipeBook.IsKnown(recipeId))
        {
            return LearnRecipeResult.AlreadyKnown(recipeId, recipe.Name);
        }
        
        player.RecipeBook.Learn(recipeId);
        
        _logger.LogInformation("{Player} learned recipe: {Recipe}", player.Name, recipe.Name);
        _eventBus.Publish(new RecipeLearnedEvent(player.Id, recipeId, recipe.Name));
        
        return LearnRecipeResult.Success(recipeId, recipe.Name);
    }
    
    public void InitializeDefaultRecipes(Player player)
    {
        var defaultRecipes = _recipeProvider.GetDefaultRecipes();
        player.RecipeBook.InitializeDefaults(defaultRecipes.Select(r => r.RecipeId));
        
        _logger.LogDebug("Initialized {Count} default recipes for {Player}",
            defaultRecipes.Count, player.Name);
    }
    
    public CraftValidation CanCraft(Player player, string recipeId, string? stationId)
    {
        var recipe = _recipeProvider.GetRecipe(recipeId);
        if (recipe is null)
        {
            return CraftValidation.Failed("Recipe not found.");
        }
        
        if (!player.RecipeBook.IsKnown(recipeId))
        {
            return CraftValidation.Failed("You don't know this recipe.");
        }
        
        if (stationId is not null && recipe.RequiredStationId != stationId)
        {
            return CraftValidation.Failed(
                $"This recipe requires a {recipe.RequiredStationId}.");
        }
        
        if (!recipe.HasIngredients(player.Inventory))
        {
            var missing = GetMissingIngredients(player, recipe);
            return CraftValidation.InsufficientResources(missing);
        }
        
        return CraftValidation.Success(recipe);
    }
    
    private List<MissingIngredient> GetMissingIngredients(Player player, RecipeDefinition recipe)
    {
        var missing = new List<MissingIngredient>();
        
        foreach (var ingredient in recipe.Ingredients)
        {
            var have = player.Inventory.GetResourceCount(ingredient.ResourceId);
            if (have < ingredient.Quantity)
            {
                var resource = _resourceProvider.GetResource(ingredient.ResourceId);
                missing.Add(new MissingIngredient(
                    ingredient.ResourceId,
                    resource?.Name ?? ingredient.ResourceId,
                    ingredient.Quantity - have));
            }
        }
        
        return missing;
    }
}
```

### LearnRecipeResult Record

```csharp
namespace RuneAndRust.Application.Results;

public record LearnRecipeResult(
    bool IsSuccess,
    LearnResultType ResultType,
    string RecipeId,
    string? RecipeName,
    string? FailureReason)
{
    public static LearnRecipeResult Success(string recipeId, string name)
        => new(true, LearnResultType.Success, recipeId, name, null);
    
    public static LearnRecipeResult AlreadyKnown(string recipeId, string name)
        => new(false, LearnResultType.AlreadyKnown, recipeId, name, 
            "You already know this recipe.");
    
    public static LearnRecipeResult RecipeNotFound(string recipeId)
        => new(false, LearnResultType.NotFound, recipeId, null, 
            "Recipe not found.");
}

public enum LearnResultType
{
    Success,
    AlreadyKnown,
    NotFound
}
```

### RecipesCommand

```csharp
namespace RuneAndRust.Application.Commands;

/// <summary>
/// Command to list known recipes.
/// </summary>
public class RecipesCommand : IGameCommand
{
    private readonly IRecipeService _recipeService;
    
    public string Name => "recipes";
    public string Description => "View your known recipes";
    public string Usage => "recipes [category]";
    
    public RecipesCommand(IRecipeService recipeService)
    {
        _recipeService = recipeService;
    }
    
    public CommandResult Execute(Player player, string[] args)
    {
        var recipes = _recipeService.GetKnownRecipes(player);
        
        if (recipes.Count == 0)
        {
            return CommandResult.Info("You don't know any recipes yet.");
        }
        
        // Group by category
        var byCategory = recipes
            .GroupBy(r => r.Category)
            .OrderBy(g => g.Key);
        
        var output = new StringBuilder();
        output.AppendLine($"KNOWN RECIPES ({recipes.Count})");
        output.AppendLine(new string('â”€', 50));
        
        foreach (var group in byCategory)
        {
            output.AppendLine($"\n{group.Key.ToString().ToUpperInvariant()} RECIPES:");
            
            foreach (var recipe in group.OrderBy(r => r.DifficultyClass))
            {
                var marker = recipe.IsDefault ? "[Default]" : "[Learned]";
                output.AppendLine(
                    $"  â€¢ {recipe.Name,-20} {marker,-10} " +
                    $"Station: {recipe.RequiredStationId,-12} DC: {recipe.DifficultyClass}");
            }
        }
        
        return CommandResult.Success(output.ToString());
    }
}
```

### Acceptance Criteria

- [ ] RecipeBook tracks known recipes
- [ ] Player has RecipeBook property
- [ ] IsKnown checks recipe knowledge
- [ ] Learn adds recipes to book
- [ ] Already-known returns false
- [ ] GetKnownRecipes returns player's recipes
- [ ] GetCraftableRecipes filters by station
- [ ] InitializeDefaultRecipes adds defaults
- [ ] RecipesCommand displays list
- [ ] RecipeLearnedEvent fires
- [ ] ~8 unit tests pass

---

## v0.11.0c: Recipe Discovery

[v0.11.0c Design Specification](v0.11.0c-design-specification.md)

### Overview

Implement recipe scroll items that teach new recipes when used. Scrolls are found as loot in chests and from monster drops. Using a scroll consumes it and teaches the recipe if not already known.

### Scope

**In Scope:**
- `RecipeScroll` item type
- Scroll-to-recipe linking
- `UseRecipeScrollCommand` / use command
- Scroll consumption on learn
- Already-known check with feedback
- Scroll generation in loot tables
- Recipe scroll item definitions
- Discovery events
- Scroll descriptions showing recipe

**Out of Scope:**
- Recipe definitions (v0.11.1a)
- Recipe books (v0.11.1b)

### Key Deliverables

| Type | Count | Details |
|------|-------|---------|
| Domain Extensions | 1 | `RecipeScroll` item handling |
| Commands | 1 | Use scroll integration |
| Loot Integration | 1 | Scroll generation |
| Events | 1 | `RecipeDiscoveredEvent` |
| Configuration | 1 | `recipe-scrolls.json` |
| Unit Tests | ~8 | Scroll usage, loot tests |

### Recipe Discovery Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   RECIPE DISCOVERY ARCHITECTURE                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

    LOOT GENERATION                    PLAYER FINDS SCROLL
    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  Monster Drops  â”‚               â”‚ You open the chest and find:â”‚
    â”‚  Chest Loot     â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶   â”‚   â€¢ 50 Gold                 â”‚
    â”‚  Quest Rewards  â”‚               â”‚   â€¢ Healing Potion x2       â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â”‚   â€¢ ğŸ“œ Recipe: Steel Sword  â”‚
                                      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


    USING A SCROLL
    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    > use recipe-scroll
           â”‚
           â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ 1. Check if recipe already known     â”‚
    â”‚    â†’ RecipeBook.IsKnown("steel-sword")
    â”‚    â†’ Result: false                   â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ 2. Learn the recipe                  â”‚
    â”‚    â†’ RecipeBook.Learn("steel-sword") â”‚
    â”‚    â†’ Fire RecipeDiscoveredEvent      â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ 3. Consume the scroll                â”‚
    â”‚    â†’ Inventory.Remove(scroll)        â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â–¼
    â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
    â•‘  You study the ancient scroll...     â•‘
    â•‘                                      â•‘
    â•‘  Recipe Learned: Steel Sword!        â•‘
    â•‘                                      â•‘
    â•‘  The scroll crumbles to dust after   â•‘
    â•‘  you memorize its contents.          â•‘
    â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•


    ALREADY KNOWN CASE
    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    > use recipe-scroll
           â”‚
           â–¼
    â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
    â•‘  You already know this recipe!       â•‘
    â•‘                                      â•‘
    â•‘  The scroll remains intact.          â•‘
    â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
```

### RecipeScroll Item Handling

```csharp
namespace RuneAndRust.Domain.Items;

/// <summary>
/// An item that teaches a recipe when used.
/// </summary>
public class RecipeScrollItem : Item
{
    public string RecipeId { get; private set; } = null!;
    
    private RecipeScrollItem() : base() { }
    
    public static RecipeScrollItem Create(
        string itemId,
        string name,
        string description,
        string recipeId)
    {
        return new RecipeScrollItem
        {
            Id = Guid.NewGuid(),
            ItemId = itemId,
            Name = name,
            Description = description,
            RecipeId = recipeId.ToLowerInvariant(),
            ItemType = ItemType.Consumable,
            IsUsable = true,
            IsStackable = true
        };
    }
    
    /// <summary>Gets the use action for this scroll.</summary>
    public override ItemUseAction GetUseAction() => ItemUseAction.LearnRecipe;
}
```

### Use Scroll Handler

```csharp
namespace RuneAndRust.Application.Handlers;

/// <summary>
/// Handles using recipe scroll items.
/// </summary>
public class RecipeScrollUseHandler : IItemUseHandler
{
    private readonly IRecipeService _recipeService;
    private readonly IRecipeProvider _recipeProvider;
    private readonly IInventoryService _inventoryService;
    private readonly IEventBus _eventBus;
    private readonly ILogger<RecipeScrollUseHandler> _logger;
    
    public ItemUseAction HandledAction => ItemUseAction.LearnRecipe;
    
    public RecipeScrollUseHandler(
        IRecipeService recipeService,
        IRecipeProvider recipeProvider,
        IInventoryService inventoryService,
        IEventBus eventBus,
        ILogger<RecipeScrollUseHandler> logger)
    {
        _recipeService = recipeService;
        _recipeProvider = recipeProvider;
        _inventoryService = inventoryService;
        _eventBus = eventBus;
        _logger = logger;
    }
    
    public ItemUseResult Handle(Player player, Item item)
    {
        if (item is not RecipeScrollItem scroll)
        {
            return ItemUseResult.Failed("This item is not a recipe scroll.");
        }
        
        var recipe = _recipeProvider.GetRecipe(scroll.RecipeId);
        if (recipe is null)
        {
            return ItemUseResult.Failed("The scroll contains an unknown recipe.");
        }
        
        // Check if already known
        if (_recipeService.IsRecipeKnown(player, scroll.RecipeId))
        {
            return ItemUseResult.Failed(
                $"You already know the recipe for {recipe.Name}.\n" +
                "The scroll remains intact.");
        }
        
        // Learn the recipe
        var learnResult = _recipeService.LearnRecipe(player, scroll.RecipeId);
        if (!learnResult.IsSuccess)
        {
            return ItemUseResult.Failed(learnResult.FailureReason!);
        }
        
        // Consume the scroll
        _inventoryService.RemoveItem(player.Inventory, item.Id, 1);
        
        _logger.LogInformation("{Player} learned recipe {Recipe} from scroll",
            player.Name, recipe.Name);
        
        _eventBus.Publish(new RecipeDiscoveredEvent(
            player.Id, scroll.RecipeId, recipe.Name, "scroll"));
        
        return ItemUseResult.Success(
            $"You study the ancient scroll...\n\n" +
            $"Recipe Learned: {recipe.Name}!\n\n" +
            "The scroll crumbles to dust after you memorize its contents.");
    }
}
```

### Loot Table Integration

```csharp
namespace RuneAndRust.Application.Services;

public partial class LootService
{
    /// <summary>Generates a recipe scroll for loot.</summary>
    public Item? GenerateRecipeScroll(LootContext context)
    {
        // Get non-default recipes that can appear in loot
        var learnableRecipes = _recipeProvider.GetAllRecipes()
            .Where(r => !r.IsDefault)
            .Where(r => r.DifficultyClass <= context.MaxRecipeDC)
            .ToList();
        
        if (learnableRecipes.Count == 0)
            return null;
        
        // Select random recipe weighted by difficulty
        var selected = SelectWeightedRecipe(learnableRecipes, context);
        
        var scroll = RecipeScrollItem.Create(
            $"recipe-scroll-{selected.RecipeId}",
            $"Recipe Scroll: {selected.Name}",
            $"A scroll containing the recipe for {selected.Name}. Use to learn.",
            selected.RecipeId);
        
        return scroll;
    }
}
```

### Recipe Scroll Configuration

```json
{
  "$schema": "./schemas/recipe-scrolls.schema.json",
  "recipeScrolls": [
    {
      "recipeId": "steel-sword",
      "dropWeight": 10,
      "minDungeonLevel": 3,
      "lootSources": ["chest", "boss"]
    },
    {
      "recipeId": "mithril-blade",
      "dropWeight": 2,
      "minDungeonLevel": 8,
      "lootSources": ["boss", "quest"]
    },
    {
      "recipeId": "fire-resistance-potion",
      "dropWeight": 8,
      "minDungeonLevel": 5,
      "lootSources": ["chest", "monster"]
    }
  ],
  "scrollDropChance": {
    "chest": 0.15,
    "boss": 0.30,
    "quest": 0.50,
    "monster": 0.02
  }
}
```

### Acceptance Criteria

- [ ] RecipeScrollItem links to recipe ID
- [ ] Use scroll teaches recipe
- [ ] Scroll consumed on success
- [ ] Already-known check prevents waste
- [ ] Scroll not consumed if known
- [ ] Scrolls generate in loot
- [ ] Drop weight affects rarity
- [ ] Min level gates advanced recipes
- [ ] RecipeDiscoveredEvent fires
- [ ] Scroll descriptions show recipe name
- [ ] ~8 unit tests pass

---

## Dependencies & Prerequisites

```
v0.11.0c (Gathering Service) - REQUIRED
    â”‚
    â””â”€â”€ Resources & Gathering complete â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                                                          â”‚
v0.11.1 (Recipes & Discovery)                                             â”‚
    â”‚                                                                     â”‚
    â”œâ”€â”€ v0.11.1a: Recipe Definitions â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
    â”‚       Dependencies: Domain, Resources                               â”‚
    â”‚       Provides: RecipeDefinition, ingredients, outputs              â”‚
    â”‚                                                                     â”‚
    â”œâ”€â”€ v0.11.1b: Recipe Book â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
    â”‚       Dependencies: v0.11.1a (recipes), Player                      â”‚
    â”‚       Provides: RecipeBook, IRecipeService                          â”‚
    â”‚                                                                     â”‚
    â””â”€â”€ v0.11.0c: Recipe Discovery â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            Dependencies: v0.11.1a, v0.11.1b, Loot system
            Provides: RecipeScrollItem, use handler
```

---

## Estimated Effort Summary

| Part | New Files | Modified Files | Est. Tests | Complexity |
|------|-----------|----------------|------------|------------|
| v0.11.1a | ~4 | ~1 | ~9 | Medium |
| v0.11.1b | ~4 | ~2 | ~8 | Medium |
| v0.11.0c | ~3 | ~2 | ~8 | Medium |
| **Total** | **~11** | **~5** | **~25** | |

---

## Risk Assessment

| Risk | Impact | Probability | Mitigation |
|------|--------|-------------|------------|
| Recipe balance | Medium | Medium | Configurable ingredients |
| Scroll drop rate | Low | Medium | Adjustable loot tables |
| Duplicate scrolls | Low | Low | Already-known check |
| Recipe ID typos | Low | Low | Validation on load |

---

## Design Decisions (Confirmed)

### Recipe Definitions

| Decision | Value | Notes |
|----------|-------|-------|
| **Categories** | 7 types | Weapon, armor, potion, etc. |
| **DC Range** | 8-18 | Easy to legendary |
| **Default Recipes** | 6-8 | Basic crafting start |

### Recipe Book

| Decision | Value | Notes |
|----------|-------|-------|
| **Storage** | HashSet of IDs | Fast lookup |
| **Learned Tracking** | DateTime | Audit trail |
| **Initialization** | On player creation | Automatic |

### Recipe Discovery

| Decision | Value | Notes |
|----------|-------|-------|
| **Scroll Type** | Consumable item | Standard use flow |
| **Drop Sources** | Chest, boss, monster | Configurable |
| **Already-Known** | Preserve scroll | Player friendly |

---

## Next Steps

1. **Review & Approve** - Confirm scope breakdown
2. **v0.11.1a Design Spec** - Create detailed design for Recipe Definitions
3. **v0.11.1a Implementation** - Build recipe system
4. **v0.11.1b Design Spec** - Create specification for Recipe Book
5. **v0.11.1b Implementation** - Build recipe book
6. **v0.11.0c Design Spec** - Create specification for Recipe Discovery
7. **v0.11.0c Implementation** - Build scroll system

---

*This scope breakdown provides a structured approach to implementing v0.11.1 Recipes & Discovery. The recipe system connects resources to crafted items, with discovery through exploration adding gameplay depth.*
