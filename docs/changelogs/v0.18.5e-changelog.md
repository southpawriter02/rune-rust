# v0.18.5e Changelog — ITraumaEconomyService & Configuration

**Date:** 2026-02-02  
**Phase:** 5/5 of v0.18.5 (Integration Layer — Final)

---

## Summary

Implements the **ITraumaEconomyService** interface and **TraumaEconomyConfiguration** to provide a unified entry point for all trauma economy operations. This completes the Integration Layer by adding the orchestration service that ties together all specialized handlers.

---

## Added

### Configuration Layer

- `ITraumaEconomyConfiguration.cs` — Interface for trauma economy configuration (64 lines)
    - Damage integration settings (enabled, formula, bonuses)
    - Rest recovery parameters
    - Turn effect values (decay, stress costs)
    - Thresholds and warning messages

- `TraumaEconomyConfiguration.cs` — Implementation loading from IConfiguration (288 lines)
    - Default values for all 15+ configurable properties
    - Validation on construction (throws InvalidOperationException for invalid ranges)
    - Structured logging of configuration state

- `config/trauma-economy.json` — Default configuration values (74 lines)
    - Damage-to-stress: `floor(damage / 10)`, +5 critical, +10 near-death, +15 ally death
    - Rest recovery: Rage/Momentum reset to 0 on short rest, Coherence +50 on long rest
    - Thresholds: 80 (critical warning), 100 (terminal trigger)

### Application Layer

- `ITraumaEconomyService.cs` — Unified service contract (182 lines)
    - State access: `GetState()`, `CreateSnapshot()`
    - Processing: `ProcessDamage()`, `ProcessRest()`, `ProcessTurnStart()`, `ProcessTurnEnd()`
    - Queries: `GetEffectiveMaxHp()`, `GetTotalDefensePenalty()`, `GetTotalSkillPenalty()`, `GetWarningLevel()`, `GetActiveWarnings()`

- `TraumaEconomyService.cs` — Orchestration implementation (514 lines)
    - Aggregates state from: IStressService, ICorruptionService, ICpsService, ITraumaService
    - Delegates to: UnifiedDamageHandler, UnifiedRestHandler, UnifiedTurnHandler
    - Optional resources: IRageService, IMomentumService, ICoherenceService
    - Comprehensive structured logging at Debug/Info/Warning levels

- `ApplicationServiceCollectionExtensions.cs` — DI registration (171 lines)
    - `AddTraumaEconomy()` extension method
    - Configuration: Singleton lifetime
    - Handlers & Service: Scoped lifetime

### Unit Tests

- `TraumaEconomyConfigurationTests.cs` — 11 tests covering:
    - Default value verification
    - Configuration override functionality
    - Validation error detection (threshold ranges, negative values)
    - Warning message customization

---

## API Compatibility Fixes

| Issue                                  | Resolution                     |
| -------------------------------------- | ------------------------------ |
| `CpsState.FromStress()`                | Changed to `CpsState.Create()` |
| `ITraumaService.GetCharacterTraumas()` | Changed to `GetTraumasAsync()` |
| `DamageContext.IsNearDeath`            | Changed to `IsInterrupt`       |
| `DamageContext.AllyDied`               | Changed to `IsAllyDeathEvent`  |
| `DamageIntegrationResult.TotalSoak`    | Changed to `SoakApplied`       |

---

## Verification

| Check     | Result     |
| --------- | ---------- |
| Build     | ✅ Pass    |
| New Tests | 11/11 ✅   |
| All Tests | 11,573+ ✅ |
| Warnings  | 0          |
| Errors    | 0          |
