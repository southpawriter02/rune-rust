# Changelog: v0.17.5c - Name Validation

**Release Date:** 2026-01-31
**Phase:** Character Creation Workflow (3/7)
**Status:** Complete

---

## Overview

Implements the Name Validation phase: 2 value objects (`NameValidationResult`, `NameValidationConfig`), 1 interface (`INameValidator`), 1 application service (`NameValidator`), and comprehensive unit tests. The `NameValidator` service validates character names against six sequential rules loaded from `creation-workflow.json` configuration: required, minimum length (2), maximum length (20), boundary (starts/ends with ASCII letter), allowed characters (ASCII letters, spaces, hyphens), and profanity filter (case-insensitive substring and word matching).

The service provides three operations: `Validate()` returns a detailed `NameValidationResult` with error message and optional suggestion, `IsValid()` provides a quick boolean check for TUI real-time feedback, and `Sanitize()` converts diacritics to ASCII equivalents (e.g., Björn → Bjorn) and removes invalid characters to offer corrected name suggestions.

---

## Added

### Domain Layer

#### Value Objects

- **`NameValidationResult`** (`ValueObjects/NameValidationResult.cs`)
    - `readonly record struct` with 3 properties: `IsValid` (bool), `ErrorMessage` (string?), `SuggestedName` (string?)
    - Factory methods: `Valid()` and `Invalid(string errorMessage, string? suggestedName = null)`
    - `ToString()` override: "Valid" or "Invalid: {ErrorMessage} (Suggested: {SuggestedName})"
    - Comprehensive XML documentation with `<summary>`, `<value>`, `<remarks>`, `<example>`, `<seealso>`
    - Section separators: PROPERTIES, FACTORY METHODS, DEBUGGING

- **`NameValidationConfig`** (`ValueObjects/NameValidationConfig.cs`)
    - `readonly record struct` with 4 properties: `MinLength` (int), `MaxLength` (int), `AllowedPattern` (string), `ProfanityFilter` (IReadOnlyList\<string\>)
    - Static `Default` property: MinLength=2, MaxLength=20, ASCII letter/space/hyphen pattern, empty profanity filter
    - `ToString()` override with length range, pattern, and profanity count
    - Section separators: PROPERTIES, STATIC PROPERTIES, DEBUGGING

### Application Layer

#### Interfaces

- **`INameValidator`** (`Interfaces/INameValidator.cs`)
    - `Validate(string? name)` → `NameValidationResult`: Full validation with error and suggestion
    - `IsValid(string? name)` → `bool`: Quick boolean check for TUI real-time feedback
    - `Sanitize(string name)` → `string?`: Diacritics normalization and invalid character removal
    - Rich XML documentation with `<para>`, `<list>`, `<seealso>`, `<example>` tags
    - Validation rules documented in numbered list: required, min length, max length, boundary, allowed chars, profanity

#### Services

- **`NameValidator`** (`Services/NameValidator.cs`)
    - `public partial class NameValidator : INameValidator`
    - Constructor: `NameValidationConfig` (struct) + `ILogger<NameValidator>` (null-checked)
    - Compiled regex from config pattern with `RegexOptions.Compiled` and 100ms timeout
    - Case-insensitive `HashSet<string>` for O(1) profanity lookups
    - 6 error message constants with format placeholders for configurable values
    - `Validate()`: 6 sequential rules with early return on first failure
        - Rule 1: Required — `string.IsNullOrWhiteSpace` check
        - Rule 2: MinLength — trimmed length vs config minimum
        - Rule 3: MaxLength — trimmed length vs config maximum (includes truncation suggestion)
        - Rule 4: Boundary — first/last character must be ASCII letter
        - Rule 5: AllowedCharacters — character-by-character ASCII check (rejects `c > 127`)
        - Rule 6: Profanity — substring matching + word-split matching
    - `IsValid()`: delegates to `Validate().IsValid`
    - `Sanitize()`: character-by-character processing with `NormalizeCharacter()` switch expression
        - Converts 40+ diacritics to ASCII equivalents (vowels, consonants, Nordic characters)
        - Drops non-letter/non-space/non-hyphen characters
        - Collapses consecutive spaces, trims boundaries, validates result length
    - Private helpers: `IsOnlyAllowedCharacters()`, `ContainsProfanity()`, `NormalizeCharacter()`
    - Section separators: PRIVATE FIELDS, ERROR MESSAGES, CONSTRUCTOR, INameValidator IMPLEMENTATION, PRIVATE VALIDATION HELPERS, CHARACTER NORMALIZATION

### Unit Tests

- **`NameValidatorTests`** (`Services/NameValidatorTests.cs`) — 17 test methods (24 test cases with parameterization)
    - **Valid Name Tests (2 methods):**
        - `Validate_WithValidName_ReturnsValid`: Parameterized for 5 names ("Bjorn", "Dark-Blade", "Bjorn the Swift", "Al", "Jo")
        - `Validate_WithMaxLengthName_ReturnsValid`: Exactly 20 characters
    - **Length Boundary Tests (4 methods):**
        - `Validate_WithNullName_ReturnsInvalid`: Null input → "required"
        - `Validate_WithEmptyName_ReturnsInvalid`: Empty string → "required"
        - `Validate_WithSingleCharacter_ReturnsInvalid`: 1 char → "at least 2"
        - `Validate_WithExcessiveLength_ReturnsInvalidWithSuggestion`: 25 chars → "at most 20" + truncated suggestion
    - **Character Pattern Tests (4 methods):**
        - `Validate_WithSpecialCharacters_ReturnsInvalid`: Parameterized for 4 names ("Test1Name", "Test@Name", "Test!Name", "Test_Name")
        - `Validate_WithNonAsciiLetters_ReturnsInvalidWithSuggestion`: "Björn" → suggestion "Bjorn"
        - `Validate_WithLeadingHyphen_ReturnsInvalid`: "-Blade" → "start and end with a letter"
        - `Validate_WithTrailingHyphen_ReturnsInvalid`: "Blade-" → "start and end with a letter"
    - **Profanity Filter Tests (2 methods):**
        - `Validate_WithProfanity_ReturnsInvalid`: Exact match → "different name", no suggestion
        - `Validate_WithProfanitySubstring_ReturnsInvalid`: Substring match → "different name"
    - **Sanitization Tests (3 methods):**
        - `Sanitize_WithDiacritics_ReturnsNormalized`: "Björn" → "Bjorn"
        - `Sanitize_WithSpecialCharacters_RemovesThem`: "Test!!Name" → "TestName"
        - `Sanitize_WithOnlyInvalidCharacters_ReturnsNull`: "12345" → null
    - **IsValid Convenience Tests (2 methods):**
        - `IsValid_WithValidName_ReturnsTrue`: "ValidName" → true
        - `IsValid_WithInvalidName_ReturnsFalse`: "" → false
    - All tests use `FluentAssertions` with `[TestFixture]` and `[Test]`/`[TestCase]` NUnit attributes
    - `#pragma warning disable NUnit2045` for readable multi-assertion tests

### Glossary

- **`config/glossary.json`** — Added 3 glossary entries
    - `name-validator`: Application service for configurable character name validation (sortOrder: 57)
    - `name-validation-result`: Value object containing validation status, error, and suggestion (sortOrder: 58)
    - `name-validation-config`: Configuration value object for validation rules from JSON (sortOrder: 59)

---

## Changed

### Configuration

- **`config/creation-workflow.json`** — Added profanity filter entries
    - Changed `"profanityFilter": []` to `"profanityFilter": ["admin", "moderator", "system"]`
    - Prevents character names that impersonate system roles

### Documentation

- **`docs/design/v0.17.x/v0.17.5-scope-breakdown.md`** — Checked off v0.17.5c unit test items
    - `[x] Valid names pass validation`
    - `[x] Names with special characters fail`
    - `[x] Names outside length range fail`

- **`docs/design/v0.17.x/v0.17.x-overview.md`** — Checked off v0.17.5 deliverable
    - `[x] NameValidator service`

---

## Design Decisions

### Coexistence with Existing PlayerNameValidator

The codebase already has `PlayerNameValidator` at `Domain/Validation/PlayerNameValidator.cs` — a static class with hardcoded constraints (MinLength=2, MaxLength=30, allows apostrophes, returns tuple). The new `NameValidator` is a separate application-layer service with different rules:

| Aspect | PlayerNameValidator | NameValidator (v0.17.5c) |
|---|---|---|
| Layer | Domain (static) | Application (instance, DI) |
| Configuration | Hardcoded constants | `NameValidationConfig` from JSON |
| MaxLength | 30 | 20 |
| Apostrophes | Allowed | Not allowed |
| Profanity | None | Configurable filter |
| Sanitization | Normalize (whitespace) | Sanitize (diacritics, char removal) |
| Return Type | `(bool, string?)` tuple | `NameValidationResult` value object |
| Logging | None | Exhaustive structured logging |

These coexist as separate concerns. `PlayerNameValidator` serves as a basic domain-level guard; `NameValidator` provides full configurable validation for the character creation workflow. No changes were made to `PlayerNameValidator`.

### Compiled Regex (Not Source-Generated)

The existing `PlayerNameValidator` uses `[GeneratedRegex]` with `partial class`. The new `NameValidator` uses `new Regex(..., RegexOptions.Compiled)` instead because the pattern is loaded from configuration at runtime — `[GeneratedRegex]` requires a compile-time constant pattern. The `partial class` modifier is retained on `NameValidator` for consistency and future extensibility.

### Struct Null Check Omitted for Config Parameter

`NameValidationConfig` is a `readonly record struct` (value type) and cannot be null. The design specification shows `config ?? throw new ArgumentNullException(...)` which would not compile for a non-nullable value type. The implementation accepts the struct parameter directly without a null check. The `ILogger<NameValidator>` parameter retains the null check since it is a reference type.

### Character-by-Character Validation Instead of Regex

The `Validate()` method uses `IsOnlyAllowedCharacters()` (character-by-character iteration) instead of the compiled `_allowedPatternRegex` for Rule 5. This is deliberate: character iteration is more efficient for simple ASCII checks and enables explicit non-ASCII rejection (`c > 127`). The compiled regex is constructed in the constructor for configuration completeness and potential future use.

### Test Case Adjustment: "Test123" → "Test1Name"

The design specification uses "Test123" as a test case for the special characters test. However, "Test123" ends with a digit, causing Rule 4 (boundary: must start/end with letter) to trigger before Rule 5 (allowed characters). The test was adjusted to "Test1Name" which starts and ends with letters, ensuring Rule 5 triggers with the expected "letters, spaces, and hyphens" error message.

### Profanity Substring Check Precedes Word Check

The `ContainsProfanity()` method first checks substring matching (catches "MyBadName" if "Bad" is filtered), then splits on spaces/hyphens and checks each word against the HashSet. The substring check is more permissive and catches everything the word check would. The word check is retained for semantic clarity and to leverage the O(1) HashSet lookup for exact word matching.

---

## Dependencies

### Prerequisites

| Type | Phase | Usage |
| --- | --- | --- |
| `creation-workflow.json` | v0.17.5a | Source of nameValidation configuration parameters |
| `CharacterCreationState` | v0.17.5a | State's `CharacterName` property (validated by this service) |

### Provides to Future Phases

| Type | Phase | Usage |
| --- | --- | --- |
| `INameValidator` | v0.17.5d | Controller calls `Validate()` during Step 6 |
| `NameValidationResult` | v0.17.5d | Controller processes result for UI feedback |
| `INameValidator` | v0.17.5e | Factory validates name before character creation |
| `NameValidationResult` | v0.17.5f | TUI displays error message and suggestion |

---

## Logging Strategy

| Level | When |
|---|---|
| Debug | NameValidator initialized (MinLength, MaxLength, PatternLength, ProfanityCount) |
| Debug | Validation start (name or "(null)") |
| Debug | Validation failed: name is null/whitespace (Rule=Required) |
| Debug | Validation failed: name too short (Length, MinLength, Rule=MinLength) |
| Debug | Validation failed: name too long (Length, MaxLength, SuggestedLength, Rule=MaxLength) |
| Debug | Validation failed: boundary violation (FirstChar, LastChar, Rule=Boundary) |
| Debug | Validation failed: disallowed characters (NameLength, Rule=AllowedCharacters) |
| Debug | Validation failed: profanity match (Rule=Profanity — name NOT logged) |
| Information | Validation passed (ValidName, Length) |
| Debug | Sanitization start (InputLength) |
| Debug | Sanitization failed: null/whitespace input |
| Debug | Sanitization failed: result too short (ResultLength, MinLength) |
| Debug | Sanitization truncated (NewLength, MaxLength) |
| Debug | Sanitization failed: boundary/length requirements (ResultLength) |
| Debug | Sanitization succeeded (InputLength, OutputLength, SanitizedName) |

All logging uses structured format with named parameters for efficient log aggregation. Profanity matches do NOT log the actual name to prevent sensitive content in log files.

---

## Files Created

| Path | Description |
|------|-------------|
| `src/Core/RuneAndRust.Domain/ValueObjects/NameValidationResult.cs` | Validation result with IsValid, ErrorMessage, and SuggestedName |
| `src/Core/RuneAndRust.Domain/ValueObjects/NameValidationConfig.cs` | Configuration with MinLength, MaxLength, AllowedPattern, ProfanityFilter |
| `src/Core/RuneAndRust.Application/Interfaces/INameValidator.cs` | Interface with Validate(), IsValid(), and Sanitize() |
| `src/Core/RuneAndRust.Application/Services/NameValidator.cs` | Service with 6-rule validation, sanitization, and profanity filtering |
| `tests/RuneAndRust.Application.UnitTests/Services/NameValidatorTests.cs` | 17 test methods (24 cases) for validation, sanitization, and IsValid |
| `changelogs/v0.17.5c-changelog.md` | This changelog |

## Files Modified

| Path | Description |
|------|-------------|
| `config/creation-workflow.json` | Added profanity filter entries: "admin", "moderator", "system" |
| `config/glossary.json` | Added 3 glossary entries (sortOrder 57-59) |
| `docs/design/v0.17.x/v0.17.5-scope-breakdown.md` | Checked off v0.17.5c unit test items |
| `docs/design/v0.17.x/v0.17.x-overview.md` | Checked off NameValidator deliverable |

---

## Notes

- Total unit tests for v0.17.5c: 17 test methods expanding to 24 test cases via parameterization
- Build: 0 errors, 0 warnings
- All 10,025 tests pass (5054 Domain + 3779 Application + 1184 Infrastructure + 8 Architecture)
- The design specification estimated ~16 tests; 17 methods (24 cases) were implemented matching the spec with one test case adjustment
- Both value objects use `readonly record struct` for immutability and value equality
- The `NameValidator` constructs a compiled regex from configuration but uses character-by-character validation for Rule 5 (more efficient for ASCII checks)
- Profanity filter matching is case-insensitive and checks both substrings and individual words
- Sanitization covers 40+ diacritics via a `NormalizeCharacter()` switch expression including Nordic characters (ð, þ, æ, ø)
- The `_allowedPatternRegex` is constructed but not used in the current validation flow — retained for configuration completeness
- Profanity match logging intentionally omits the actual name to prevent sensitive content in log files
- All new files follow established codebase patterns: `═══════` section separators, file headers with Version tag, comprehensive XML documentation, exhaustive structured logging
