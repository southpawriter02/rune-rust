# v0.18.3 Trauma System - Scope Breakdown

**Version:** 0.18.3
**Theme:** Permanent Trauma System
**Prerequisites:** v0.18.0 Complete (Psychic Stress), v0.18.2 Complete (CPS), v0.6.x (Dice System)
**Total Estimated Tests:** ~18 new tests

---

## Executive Summary

v0.18.3 implements the **Permanent Trauma System** — the lasting psychological and physical consequences that represent irreversible character changes. Traumas are permanent once acquired and provide both narrative weight and mechanical consequences that alter gameplay.

The work is divided into **5 sub-phases**:

| Phase    | Name                       | Focus                                  | Est. Tests |
| -------- | -------------------------- | -------------------------------------- | ---------- |
| v0.18.3a | Trauma Enums & Definitions | TraumaType, TraumaDefinition entity    | ~4         |
| v0.18.3b | CharacterTrauma Entity     | Per-character trauma tracking          | ~5         |
| v0.18.3c | Trauma Check System        | ITraumaCheckService, TraumaCheckResult | ~4         |
| v0.18.3d | ITraumaService Interface   | Service contract definition            | ~0         |
| v0.18.3e | TraumaService & Config     | Core trauma logic, JSON config         | ~5         |

---

## Feature Analysis & Categorization

### From trauma-economy.md - Trauma Definitions

| Feature                 | Complexity | Dependencies | Assigned Phase |
| ----------------------- | ---------- | ------------ | -------------- |
| TraumaType Enum         | Low        | None         | **v0.18.3a**   |
| TraumaDefinition Entity | Medium     | TraumaType   | **v0.18.3a**   |
| TraumaEffect VO         | Low        | None         | **v0.18.3a**   |
| TraumaTrigger VO        | Low        | None         | **v0.18.3a**   |

### From trauma-economy.md - Character Trauma

| Feature                    | Complexity | Dependencies     | Assigned Phase |
| -------------------------- | ---------- | ---------------- | -------------- |
| CharacterTrauma Entity     | Medium     | TraumaDefinition | **v0.18.3b**   |
| TraumaAcquisitionResult VO | Low        | CharacterTrauma  | **v0.18.3b**   |
| RetirementCheckResult VO   | Low        | CharacterTrauma  | **v0.18.3b**   |

### From trauma-economy.md - Trauma Checks

| Feature                 | Complexity | Dependencies | Assigned Phase |
| ----------------------- | ---------- | ------------ | -------------- |
| ITraumaCheckService     | Medium     | None         | **v0.18.3c**   |
| TraumaCheckResult VO    | Low        | None         | **v0.18.3c**   |
| TraumaCheckTrigger Enum | Low        | None         | **v0.18.3c**   |

### From trauma-economy.md - Service Layer

| Feature        | Complexity | Dependencies   | Assigned Phase |
| -------------- | ---------- | -------------- | -------------- |
| ITraumaService | Medium     | All VOs        | **v0.18.3d**   |
| TraumaService  | High       | ITraumaService | **v0.18.3e**   |
| traumas.json   | Medium     | None           | **v0.18.3e**   |

---

## Phase Definitions

---

## v0.18.3a: Trauma Enums & Definitions

[v0.18.3a Design Specification](v0.18.3a-design-specification.md)

### Overview

Defines the trauma type categorization, trauma definition entity for data-driven trauma types, and supporting value objects.

### Scope

**In Scope:**

- `TraumaType` enum (6 categories)
- `TraumaDefinition` entity (data-driven trauma types)
- `TraumaEffect` value object
- `TraumaTrigger` value object

**Out of Scope:**

- Per-character trauma tracking (v0.18.3b)
- Trauma Check mechanics (v0.18.3c)

### Key Deliverables

| Type                 | Count | Details                     |
| -------------------- | ----- | --------------------------- |
| Domain Enums         | 1     | TraumaType                  |
| Domain Entities      | 1     | TraumaDefinition            |
| Domain Value Objects | 2     | TraumaEffect, TraumaTrigger |
| Unit Tests           | ~4    |                             |

### Data Model Changes

```
NEW: TraumaType (Enum)
├── Cognitive    - Mental processing disorders
├── Emotional    - Affective regulation issues
├── Physical     - Somatic manifestations
├── Social       - Interpersonal difficulties
├── Existential  - Reality/identity crises
└── Corruption   - Blight-related traumas

NEW: TraumaDefinition (Entity)
├── Id: Guid
├── TraumaId: string (e.g., "survivors-guilt")
├── Name: string
├── Type: TraumaType
├── Description: string
├── FlavorText: string
├── Triggers: IReadOnlyList<TraumaTrigger>
├── Effects: IReadOnlyList<TraumaEffect>
├── IsRetirementTrauma: bool
├── RetirementCondition: string?
├── AcquisitionSources: IReadOnlyList<string>
└── IsStackable: bool

NEW: TraumaEffect (Value Object)
├── EffectType: string (e.g., "SkillPenalty", "Disadvantage")
├── Target: string (e.g., "social-skills", "morale-checks")
├── Value: int?
├── Condition: string?
└── Description: string

NEW: TraumaTrigger (Value Object)
├── TriggerType: string (e.g., "OnAllyDeath", "OnRest")
├── Condition: string?
├── CheckRequired: bool
└── CheckDifficulty: int?
```

### Trauma Catalog

| Trauma ID         | Name              | Type        | Retirement? |
| ----------------- | ----------------- | ----------- | ----------- |
| survivors-guilt   | Survivor's Guilt  | Emotional   | Yes         |
| combat-flashbacks | Combat Flashbacks | Cognitive   | No          |
| paranoid-ideation | Paranoid Ideation | Cognitive   | No          |
| chronic-pain      | Chronic Pain      | Physical    | No          |
| night-terrors     | Night Terrors     | Emotional   | No          |
| touch-aversion    | Touch Aversion    | Social      | No          |
| reality-doubt     | Reality Doubt     | Existential | Yes (5+)    |
| machine-affinity  | Machine Affinity  | Corruption  | Yes         |
| hollow-resonance  | Hollow Resonance  | Corruption  | Yes (3+)    |
| death-wish        | Death Wish        | Emotional   | Yes         |

### Acceptance Criteria

- [x] TraumaType enum has 6 categories
- [x] TraumaDefinition loads from configuration
- [x] TraumaEffect supports multiple effect types
- [x] TraumaTrigger defines check conditions
- [x] IsRetirementTrauma correctly categorizes serious traumas
- [x] ~4 unit tests pass (51 tests implemented)

---

## v0.18.3b: CharacterTrauma Entity

[v0.18.3b Design Specification](v0.18.3b-design-specification.md)

### Overview

Implements per-character trauma tracking, including acquisition history, stack counts, and retirement condition checking.

### Scope

**In Scope:**

- `CharacterTrauma` entity (per-character tracking)
- `TraumaAcquisitionResult` record
- `RetirementCheckResult` record
- Retirement condition evaluation

**Out of Scope:**

- Trauma Check service (v0.18.3c)
- External service integration (v0.18.3e)

### Key Deliverables

| Type                 | Count | Details                                        |
| -------------------- | ----- | ---------------------------------------------- |
| Domain Entities      | 1     | CharacterTrauma                                |
| Domain Value Objects | 2     | TraumaAcquisitionResult, RetirementCheckResult |
| Unit Tests           | ~5    |                                                |

### Data Model Changes

```
NEW: CharacterTrauma (Entity)
├── Id: Guid
├── CharacterId: Guid
├── TraumaDefinitionId: string
├── AcquiredAt: DateTime
├── Source: string (what caused this trauma)
├── StackCount: int (for stackable traumas)
├── IsActive: bool
├── ManagedSince: DateTime? (if suppressed)
└── Notes: string?

NEW: TraumaAcquisitionResult (Record)
├── Success: bool
├── TraumaId: string
├── TraumaName: string
├── Source: string
├── IsNewTrauma: bool
├── NewStackCount: int
├── TriggersRetirementCheck: bool
└── Message: string

NEW: RetirementCheckResult (Record)
├── CharacterId: Guid
├── MustRetire: bool
├── RetirementReason: string?
├── TraumasCausingRetirement: IReadOnlyList<string>
├── TotalRetirementTraumas: int
└── CanContinueWithPermission: bool
```

### Retirement Conditions

| Trauma            | Condition                         | Retirement Trigger |
| ----------------- | --------------------------------- | ------------------ |
| Survivor's Guilt  | First acquisition                 | Yes                |
| Reality Doubt     | 5+ instances                      | Yes                |
| Machine Affinity  | First acquisition                 | Yes                |
| Hollow Resonance  | 3+ instances                      | Yes                |
| Death Wish        | First acquisition                 | Yes                |
| Multiple Moderate | Any 3+ different moderate traumas | Optional           |

### Acceptance Criteria

- [x] CharacterTrauma tracks acquisition date and source
- [x] StackCount increments for stackable traumas
- [x] TraumaAcquisitionResult detects new vs stacked trauma
- [x] RetirementCheckResult evaluates all retirement conditions
- [x] MustRetire triggers for severe traumas
- [x] CanContinueWithPermission allows override for moderate accumulation
- [x] 37 unit tests pass

---

## v0.18.3c: Trauma Check System

[v0.18.3c Design Specification](v0.18.3c-design-specification.md)

### Overview

Implements the Trauma Check mechanics that determine when characters must roll to avoid acquiring new traumas.

### Scope

**In Scope:**

- `TraumaCheckTrigger` enum
- `TraumaCheckResult` record
- `ITraumaCheckService` interface
- `TraumaCheckService` implementation

**Out of Scope:**

- Integration with combat events (v0.18.5)
- Integration with rest mechanics (v0.18.5)

### Key Deliverables

| Type                   | Count | Details             |
| ---------------------- | ----- | ------------------- |
| Domain Enums           | 1     | TraumaCheckTrigger  |
| Domain Value Objects   | 1     | TraumaCheckResult   |
| Application Interfaces | 1     | ITraumaCheckService |
| Application Services   | 1     | TraumaCheckService  |
| Unit Tests             | ~4    |                     |

### Data Model Changes

```
NEW: TraumaCheckTrigger (Enum)
├── StressThreshold100       - Reaching max stress
├── CorruptionThreshold100   - Reaching max corruption
├── AllyDeath               - Party member dies
├── NearDeathExperience     - Reduced to 1 HP
├── CriticalFailure         - Critical failure on opposed check
├── ProlongedExposure       - Extended time in dangerous area
├── WitnessingHorror        - Seeing traumatic event
└── RuinMadnessEscape       - Surviving Ruin-Madness

NEW: TraumaCheckResult (Record)
├── CharacterId: Guid
├── Trigger: TraumaCheckTrigger
├── DiceRolled: int
├── SuccessesNeeded: int
├── SuccessesAchieved: int
├── Passed: bool
├── TraumaAcquired: string? (if failed)
├── Modifiers: IReadOnlyList<string>
└── ResolvePenaltyApplied: int

NEW: ITraumaCheckService
├── PerformTraumaCheck(characterId, trigger): TraumaCheckResult
├── GetTraumaCheckDifficulty(trigger): int
├── GetCurrentModifiers(characterId): IReadOnlyList<TraumaCheckModifier>
└── ShouldTriggerCheck(characterId, trigger): bool
```

### Trauma Check Mechanics

- **Base Roll**: RESOLVE attribute determines dice pool
- **Corruption Penalty**: -floor(Corruption/20) dice from pool
- **Target Successes**: Based on trigger severity
- **Failure**: Acquire random trauma from trigger category

| Trigger                | Required Successes | Trauma Category on Fail |
| ---------------------- | ------------------ | ----------------------- |
| StressThreshold100     | 3                  | Cognitive/Emotional     |
| CorruptionThreshold100 | 4                  | Corruption              |
| AllyDeath              | 2                  | Emotional               |
| NearDeathExperience    | 2                  | Physical/Emotional      |
| CriticalFailure        | 1                  | Context-dependent       |
| ProlongedExposure      | 2                  | Existential             |
| WitnessingHorror       | 3                  | Cognitive               |
| RuinMadnessEscape      | 4                  | Cognitive/Existential   |

### Acceptance Criteria

- [ ] TraumaCheckTrigger covers all trauma-inducing events
- [ ] TraumaCheckResult includes complete roll information
- [ ] Corruption penalty correctly reduces dice pool
- [ ] ShouldTriggerCheck prevents duplicate checks
- [ ] Random trauma selection respects categories
- [ ] ~4 unit tests pass

---

## v0.18.3d: ITraumaService Interface

[v0.18.3d Design Specification](v0.18.3d-design-specification.md)

### Overview

Defines the service contract for all trauma management operations.

### Scope

**In Scope:**

- `ITraumaService` interface definition
- Method signatures and XML documentation

**Out of Scope:**

- Implementation (v0.18.3e)

### Key Deliverables

| Type                   | Count | Details        |
| ---------------------- | ----- | -------------- |
| Application Interfaces | 1     | ITraumaService |
| Unit Tests             | ~0    | Interface only |

### Interface Definition

```csharp
public interface ITraumaService
{
    IReadOnlyList<CharacterTrauma> GetTraumas(Guid characterId);
    TraumaDefinition GetTraumaDefinition(string traumaId);
    TraumaAcquisitionResult AcquireTrauma(Guid characterId, string traumaId, string source);
    bool HasTrauma(Guid characterId, string traumaId);
    int GetTraumaCount(Guid characterId);
    int GetTraumaStackCount(Guid characterId, string traumaId);
    RetirementCheckResult CheckRetirementCondition(Guid characterId);
    IReadOnlyList<TraumaEffect> GetActiveEffects(Guid characterId);
    TraumaCheckResult PerformTraumaCheck(Guid characterId, TraumaCheckTrigger trigger);
}
```

### Acceptance Criteria

- [ ] ITraumaService defines all 9 methods
- [ ] All methods have XML documentation
- [ ] Interface compiles without dependencies on implementation

---

## v0.18.3e: TraumaService & Config

[v0.18.3e Design Specification](v0.18.3e-design-specification.md)

### Overview

Implements the core trauma logic and defines the JSON configuration file for trauma definitions.

### Scope

**In Scope:**

- `TraumaService` class implementing `ITraumaService`
- `config/traumas.json` configuration file
- `config/schemas/traumas.schema.json` JSON Schema
- Database schema for trauma persistence

**Out of Scope:**

- Trauma therapy/management (v0.22.x)
- Visual trauma indicators (v0.19.x)

### Key Deliverables

| Type                 | Count | Details             |
| -------------------- | ----- | ------------------- |
| Application Services | 1     | TraumaService       |
| Configuration Files  | 1     | traumas.json        |
| JSON Schemas         | 1     | traumas.schema.json |
| Database Migrations  | 1     | Add trauma tables   |
| Unit Tests           | ~5    |                     |

### traumas.json Structure

```json
{
    "version": "1.0",
    "traumas": [
        {
            "id": "survivors-guilt",
            "name": "Survivor's Guilt",
            "type": "Emotional",
            "description": "You carry the weight of those who didn't make it.",
            "flavorText": "Why them? Why not me?",
            "acquisitionSources": ["AllyDeath", "PartyWipe"],
            "isStackable": false,
            "isRetirementTrauma": true,
            "retirementCondition": "On acquisition",
            "triggers": [
                {
                    "triggerType": "OnRest",
                    "checkRequired": true,
                    "checkDifficulty": 2
                }
            ],
            "effects": [
                {
                    "effectType": "Disadvantage",
                    "target": "morale-checks",
                    "description": "Disadvantage on morale checks when allies are in danger"
                },
                {
                    "effectType": "StressIncrease",
                    "value": 5,
                    "condition": "OnAllyTakeCriticalHit",
                    "description": "+5 stress when ally takes critical damage"
                }
            ]
        },
        {
            "id": "machine-affinity",
            "name": "[MACHINE AFFINITY]",
            "type": "Corruption",
            "description": "You feel kinship with the machine ghosts.",
            "flavorText": "{ERROR: ORGANIC DESIGNATION DEPRECATED}",
            "acquisitionSources": ["CorruptionThreshold75", "ForlornContact"],
            "isStackable": false,
            "isRetirementTrauma": true,
            "retirementCondition": "On acquisition",
            "triggers": [
                {
                    "triggerType": "NearForlorn",
                    "checkRequired": false
                }
            ],
            "effects": [
                {
                    "effectType": "Bonus",
                    "target": "tech-checks",
                    "value": 2,
                    "description": "+2 bonus to all Technology checks"
                },
                {
                    "effectType": "Penalty",
                    "target": "social-checks",
                    "value": -3,
                    "description": "-3 penalty to Social checks with uninfected"
                }
            ]
        }
        // ... additional traumas
    ]
}
```

### Database Schema

```sql
CREATE TABLE IF NOT EXISTS character_traumas (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    character_id UUID NOT NULL REFERENCES characters(id) ON DELETE CASCADE,
    trauma_definition_id VARCHAR(50) NOT NULL,
    acquired_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    source VARCHAR(100) NOT NULL,
    stack_count INT NOT NULL DEFAULT 1,
    is_active BOOLEAN NOT NULL DEFAULT true,
    managed_since TIMESTAMP,
    notes TEXT,
    CONSTRAINT unique_character_trauma UNIQUE (character_id, trauma_definition_id)
);

CREATE INDEX idx_character_traumas_char ON character_traumas(character_id);
CREATE INDEX idx_character_traumas_def ON character_traumas(trauma_definition_id);
```

### Acceptance Criteria

- [ ] TraumaService correctly loads trauma definitions
- [ ] AcquireTrauma creates new or increments stack
- [ ] HasTrauma returns accurate results
- [ ] CheckRetirementCondition evaluates all conditions
- [ ] GetActiveEffects returns all current trauma effects
- [ ] Configuration file validates against schema
- [ ] Database persistence works correctly
- [ ] ~5 unit tests pass

---

## Dependencies & Prerequisites

```
v0.18.0 (Psychic Stress) - REQUIRED
    │
    └── Stress 100 triggers trauma check
                    │
v0.18.1 (Runic Blight Corruption) - REQUIRED
    │
    └── Corruption thresholds trigger traumas
                    │
v0.18.2 (CPS) - REQUIRED
    │
    └── CPS stages interact with trauma checks
                    │
v0.6.x (Dice System) - REQUIRED
    │
    └── IDiceService (trauma check rolls)
                    │
                    ▼
v0.18.3 (Trauma System)
    │
    ├── v0.18.3a: Trauma Enums & Definitions ────────┐
    │       Dependencies: None                        │
    │                                                 │
    ├── v0.18.3b: CharacterTrauma Entity ────────────┤
    │       Dependencies: v0.18.3a                   │
    │                                                 │
    ├── v0.18.3c: Trauma Check System ───────────────┤
    │       Dependencies: v0.18.3a, IDiceService     │
    │                                                 │
    ├── v0.18.3d: ITraumaService Interface ──────────┤
    │       Dependencies: v0.18.3a-c                 │
    │                                                 │
    └── v0.18.3e: TraumaService & Config ────────────┘
            Dependencies: v0.18.3d
```

---

## Estimated Effort Summary

| Phase     | New Files | Modified Files | Est. Tests | Complexity |
| --------- | --------- | -------------- | ---------- | ---------- |
| v0.18.3a  | 4         | 0              | ~4         | Medium     |
| v0.18.3b  | 3         | 0              | ~5         | Medium     |
| v0.18.3c  | 4         | 0              | ~4         | Medium     |
| v0.18.3d  | 1         | 0              | ~0         | Low        |
| v0.18.3e  | 4         | 1              | ~5         | High       |
| **Total** | **16**    | **1**          | **~18**    |            |

---

## Risk Assessment

| Risk                              | Impact | Probability | Mitigation                         |
| --------------------------------- | ------ | ----------- | ---------------------------------- |
| Retirement conditions too harsh   | Medium | Medium      | Configurable thresholds            |
| Trauma effect stacking complexity | Medium | Low         | Clear precedence rules             |
| Random trauma selection imbalance | Low    | Medium      | Weighted selection with categories |

---

## Design Decisions (Confirmed)

### Trauma Mechanics

| Decision               | Value               | Notes                                                           |
| ---------------------- | ------------------- | --------------------------------------------------------------- |
| **Trauma Categories**  | 6 types             | Cognitive, Emotional, Physical, Social, Existential, Corruption |
| **Permanence**         | Permanent           | Traumas never fully heal                                        |
| **Stacking**           | Per-trauma config   | Some traumas stack, some don't                                  |
| **Retirement Trigger** | Multiple conditions | Severe trauma or accumulation                                   |

### Acquisition Philosophy

| Decision             | Value             | Notes                           |
| -------------------- | ----------------- | ------------------------------- |
| **Trauma Check**     | RESOLVE-based     | Corruption reduces dice pool    |
| **Random Selection** | Category-weighted | Trigger determines category     |
| **Notification**     | Immediate         | Player always knows acquisition |

---

## Out of Scope

| Feature                        | Deferred To | Reason                   |
| ------------------------------ | ----------- | ------------------------ |
| Trauma therapy/management      | v0.22.x     | Advanced recovery system |
| Visual trauma indicators in UI | v0.19.x     | UI version               |
| Trauma-specific dialogue       | v0.20.x     | Dialogue system          |
| NPC trauma reactions           | v0.20.x     | NPC system               |
| Trauma interaction matrix      | v0.18.5     | Integration version      |

---

## Next Steps

1. **Review & Approve** - Confirm scope breakdown with stakeholders
2. **v0.18.3a Design Spec** - Create detailed design specification for Trauma Enums & Definitions
3. **Implement v0.18.3a** - Build foundational enums and TraumaDefinition
4. **Repeat for v0.18.3b through v0.18.3e**

---

_This scope breakdown provides a structured approach to implementing v0.18.3 Permanent Trauma System. Each sub-phase builds on the previous, allowing for incremental development and testing._

---

## Changelog

| Version | Date       | Changes                        |
| ------- | ---------- | ------------------------------ |
| 1.0     | 2026-01-17 | Initial scope breakdown        |
| 1.1     | 2026-01-27 | Restructured to match template |
