Here is the comprehensive implementation plan for v0.3.20: The Cartographer II (Map Polish).
This milestone enhances the navigation systems established in v0.3.5b. It shifts the map from a passive visualization tool into an active gameplay utility, allowing players to annotate their discoveries, export their journeys, and automate backtracking.
To manage the complexity of UI interaction, file I/O, and pathfinding, this version is split into three sub-versions:
	‚Ä¢	v0.3.20a: The Notes (Annotations) ‚Äì Implement persistent user-defined notes for specific rooms.
	‚Ä¢	v0.3.20b: The Atlas (Export & Legend) ‚Äì Generate external text-file maps of explored areas.
	‚Ä¢	v0.3.20c: The Pathfinder (Fast Travel) ‚Äì Implement auto-walking to previously visited safe zones.

v0.3.20a: The Notes (Annotations)
Goal: Allow players to attach custom text strings to specific Room IDs (e.g., "Locked Chest", "Merchant here"). These notes must persist in the save file and appear visually on the Minimap.
1. Architecture & Data Flow
	‚Ä¢	State Storage: Add Dictionary<Guid, string> UserNotes to GameState. Storing this on the GameState (rather than the static Room entity) ensures notes are unique to the current playthrough and easily serialized.
	‚Ä¢	Command Integration: Implement NoteCommand to handle adding, reading, and clearing notes.
	‚Ä¢	Visual Feedback: Update MinimapRenderer to display a specific symbol (e.g., !) or color override for rooms containing notes.
Data Flow: The Annotation Pipeline
	1	Input: Player types note "Needs Blue Key".
	2	Context: Engine identifies GameState.CurrentRoomId.
	3	Storage: Engine updates GameState.UserNotes[CurrentRoomId].
	4	Feedback: Log "Note attached."
	5	Rendering: On next render, MinimapRenderer checks UserNotes. If present, the room tile renders as ! (Yellow).
2. Logic Decision Trees
A. Note Command Logic Input: Argument String
	1	Validation: Is the player in a valid room?
	2	Parsing:
	‚ó¶	No Args: Display current note (if any).
	‚ó¶	Args == "clear": Remove note from Dictionary.
	‚ó¶	Otherwise: Update/Insert Dictionary with argument string.
	3	Persistence: Flag State as Dirty (needs save).
B. Minimap Symbol Resolution (Update) Input: RoomID
	1	Priority Check:
	‚ó¶	Is Player Here? -> @
	‚ó¶	Does Room Have Note? -> ! (Yellow) [New Priority]
	‚ó¶	Is Boss Lair? -> ‚ò†
	‚ó¶	Is Settlement? -> ‚åÇ
	‚ó¶	Default -> O
3. Code Implementation
A. GameState Update File: RuneAndRust.Core/Models/GameState.cs
public class GameState
{
    // ... existing properties
    public Dictionary<Guid, string> UserNotes { get; set; } = new();
}
B. Note Command File: RuneAndRust.Engine/Commands/NoteCommand.cs
public class NoteCommand : ICommand
{
    private readonly GameState _state;
    private readonly IInputHandler _io;

    public async Task ExecuteAsync(ParsedCommand command)
    {
        if (_state.CurrentRoomId == null) return;

        var roomId = _state.CurrentRoomId.Value;
        var text = command.Target; // "needs key"

        if (string.IsNullOrWhiteSpace(text))
        {
            // Read Mode
            if (_state.UserNotes.TryGetValue(roomId, out var note))
                _io.DisplayMessage($"[yellow]Note:[/] {note}");
            else
                _io.DisplayMessage("No notes for this location.");
        }
        else if (text.ToLower() == "clear")
        {
            // Delete Mode
            _state.UserNotes.Remove(roomId);
            _io.DisplayMessage("Note cleared.");
        }
        else
        {
            // Write Mode
            _state.UserNotes[roomId] = text;
            _io.DisplayMessage($"Note attached: \"{text}\"");
        }
    }
}
4. Deliverable Checklist (v0.3.20a)
	‚Ä¢	Core:
	‚ó¶	[ ] Add UserNotes dictionary to GameState.
	‚ó¶	[ ] Ensure GameStateContext (Source Generation) handles Dictionary serialization.
	‚Ä¢	Engine:
	‚ó¶	[ ] Implement NoteCommand.
	‚ó¶	[ ] Register note in CommandParser.
	‚Ä¢	Terminal:
	‚ó¶	[ ] Update MinimapRenderer to check UserNotes and render ! symbol.
	‚ó¶	[ ] Update ExplorationScreenRenderer to show an indicator (e.g., "üìù Note Found") in the header if the current room has a note.
	‚Ä¢	Tests:
	‚ó¶	[ ] Note_Persists_OnSaveLoad.

v0.3.20b: The Atlas (Export & Legend)
Goal: Allow players to export their current discovered map to a text file for external reference or sharing.
1. Architecture & Data Flow
	‚Ä¢	Map Projection: Create a MapExportService that iterates through GameState.VisitedRooms.
	‚Ä¢	Normalization: Calculate the bounds (MinX, MinY to MaxX, MaxY) to normalize coordinates into a 2D char array.
	‚Ä¢	File I/O: Write the array to data/exports/map_{timestamp}.txt.
2. Deliverable Checklist (v0.3.20b)
	‚Ä¢	Engine:
	‚ó¶	[ ] Implement MapExportService.
	‚ó¶	[ ] Implement map export command.
	‚Ä¢	Terminal:
	‚ó¶	[ ] Create ASCII legend footer for the export file.

v0.3.20c: The Pathfinder (Fast Travel)
Goal: Implement "Auto-Walk" to previously visited safe locations (Settlements/Anchors), using the VisitedRooms graph.
1. Architecture & Data Flow
	‚Ä¢	A on Visited Graph:* Pathfinding can only use rooms in VisitedRooms. It cannot path through unexplored space.
	‚Ä¢	Safety Check: Path cannot traverse rooms with DangerLevel.Lethal or active DynamicHazards (unless cleared).
	‚Ä¢	Execution: The system simulates movement tick-by-tick (fast forward) rather than teleporting, draining Stamina appropriately.
2. Deliverable Checklist (v0.3.20c)
	‚Ä¢	Engine:
	‚ó¶	[ ] Implement PathfindingService.GetPath(start, end).
	‚ó¶	[ ] Implement AutoTravelService to execute the move loop.
	‚ó¶	[ ] Add travel {settlement} command.

Logging Requirements
Reference: logging.md
System
Event
Level
Message Template
Properties
Map
Note Added
Info
"[Map] User added note to {RoomID}: {Text}"
RoomID, Text
Map
Export
Info
"[Map] Exported map to {Path} ({Count} rooms)"
Path, Count
Travel
Path Found
Debug
"[Path] Calculated route to {Target}: {Steps} steps."
Target, Steps

Testing Strategy
Unit Tests (MapTests.cs):
	‚Ä¢	Note_Add_Update:
	‚ó¶	Add note "Test". Assert Dictionary contains "Test".
	‚ó¶	Add note "Update". Assert Dictionary contains "Update".
	‚Ä¢	Export_Bounds:
	‚ó¶	Mock visited rooms at (0,0) and (10,10).
	‚ó¶	Verify exported string grid is at least 11x11 characters.
Manual QA:
	‚Ä¢	Persistence: Add a note. Save. Load. Verify note appears on map.
	‚Ä¢	Export: Run map export. Open the text file. Verify layout matches in-game minimap.

Draft Changelog (v0.3.20)
# Changelog: v0.3.20 - The Cartographer II

**Release Date:** 2026-02-XX

## Summary
A dedicated mapping update focused on navigation and record-keeping. Players can now annotate their map with custom notes and export their discoveries to share with others.

## Changes
- **Map:** Added `note` command. You can now attach text to your current location (e.g., "Locked Door").
- **UI:** Rooms with notes appear as `!` on the minimap.
- **System:** Added `map export` to dump an ASCII map of explored areas to a text file.
- **Navigation:** Added `travel` command to auto-walk to known settlements (pathfinding dependent).
Would you like to begin detailing v0.3.20a: The Notes?
