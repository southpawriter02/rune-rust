# v0.13.4d Design Specification: Dice History Panel

**Version:** 0.13.4d
**Theme:** Dice History Panel
**Author:** Claude
**Created:** 2026-01-16
**Status:** Draft
**Prerequisites:** v0.13.4c Complete (Leaderboard View), v0.12.x Dice History Services Complete

---

## Table of Contents

1. [Overview](#1-overview)
2. [Dependencies](#2-dependencies)
3. [Architecture Diagrams](#3-architecture-diagrams)
4. [Dice History Panel](#4-dice-history-panel)
5. [Streak Indicator](#5-streak-indicator)
6. [Roll Distribution Chart](#6-roll-distribution-chart)
7. [Dice Roll Renderer](#7-dice-roll-renderer)
8. [Data Model Changes](#8-data-model-changes)
9. [Configuration](#9-configuration)
10. [Commands](#10-commands)
11. [User-Facing Changes](#11-user-facing-changes)
12. [Logging Specifications](#12-logging-specifications)
13. [Unit Testing Requirements](#13-unit-testing-requirements)
14. [Use Cases](#14-use-cases)
15. [Deliverable Checklist](#15-deliverable-checklist)
16. [Acceptance Criteria](#16-acceptance-criteria)
17. [Future Considerations](#17-future-considerations)
18. [Implementation Notes](#18-implementation-notes)
19. [Document Metadata](#19-document-metadata)

---

## 1. Overview

### 1.1 Purpose

This document provides a comprehensive design specification for v0.13.4d, the Dice History Panel implementation. This part focuses on displaying recent roll history, streak indicators for lucky/unlucky runs, roll statistics including natural 20s and natural 1s, luck rating calculation, and roll distribution visualization.

### 1.2 Scope

**In Scope:**
- Roll history panel showing recent rolls
- Streak indicators (lucky/unlucky streaks)
- Roll statistics (total rolls, natural 20s/1s, average)
- Luck rating calculation and display
- Roll distribution visualization (ASCII bar chart)
- Recent roll count configuration (default 20)
- Critical roll highlighting (20!, 1!)

**Out of Scope:**
- Achievement panel (v0.13.4a - completed)
- Statistics dashboard (v0.13.4b - completed)
- Leaderboard view (v0.13.4c - completed)
- New domain logic or dice calculations (provided by v0.12.x services)
- Dice rolling mechanics (existing in Domain layer)
- Multi-die type history beyond d20 (future consideration)

### 1.3 Key Deliverables

| Type | Count | Details |
|------|-------|---------|
| UI Components | 3 | `DiceHistoryPanel`, `StreakIndicator`, `RollDistributionChart` |
| Renderers | 1 | `DiceRollRenderer` |
| DTOs | 3 | `DiceHistoryDisplayDto`, `DiceStatisticsDto`, `RollDistributionDto` |
| Configuration | 1 | `DiceHistoryPanelConfig` |
| Commands | 1 | `DiceHistoryCommand` |
| Unit Tests | ~8 | Roll history, streak, statistics, distribution tests |

---

## 2. Dependencies

### 2.1 Required Services (from v0.12.x)

| Service | Location | Purpose |
|---------|----------|---------|
| `IDiceHistoryService` | `Application/Interfaces/IDiceHistoryService.cs` | Retrieve roll history, statistics |
| `DiceRollHistory` | `Domain/Entities/DiceRollHistory.cs` | Roll history tracking entity |
| `DiceRoll` | `Domain/ValueObjects/DiceRoll.cs` | Individual roll value object |
| `DiceStatistics` | `Domain/ValueObjects/DiceStatistics.cs` | Calculated statistics value object |

### 2.2 Required UI Infrastructure (from v0.7.x-v0.8.x)

| Component | Location | Purpose |
|-----------|----------|---------|
| `ITerminalService` | `Presentation.Tui/Services/ITerminalService.cs` | Terminal output abstraction |
| `MainMenuView` | `Presentation.Tui/Views/MainMenuView.cs` | Integration point for dice history command |

### 2.3 Related v0.13.4 Components

| Component | Version | Relationship |
|-----------|---------|--------------|
| `AchievementPanel` | v0.13.4a | Similar panel patterns, shared styling conventions |
| `StatisticsDashboard` | v0.13.4b | Similar statistics display pattern |
| `SimpleChart` | v0.13.4b | Reusable chart rendering patterns |
| `LeaderboardView` | v0.13.4c | Similar panel structure, consistent styling |

---

## 3. Architecture Diagrams

### 3.1 Dice History Panel Layer Architecture

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                          PRESENTATION LAYER                                  │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │                    DiceHistoryPanel (New)                            │    │
│  ├─────────────────────────────────────────────────────────────────────┤    │
│  │ + RenderHistory(IEnumerable<DiceRoll>) : void                        │    │
│  │ + ShowStatistics(DiceStatistics) : void                              │    │
│  │ + ShowLuckRating(float deviation) : void                             │    │
│  │ + SetDisplayCount(int count) : void                                  │    │
│  │ + SetPosition(int x, int y) : void                                   │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
│                          │                                                   │
│         ┌────────────────┼────────────────┬──────────────────┐              │
│         ▼                ▼                ▼                  ▼              │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐        │
│  │DiceRoll     │  │StreakIndic  │  │RollDistrib  │  │DiceHistory  │        │
│  │Renderer     │  │ator         │  │utionChart   │  │PanelConfig  │        │
│  │   (New)     │  │   (New)     │  │   (New)     │  │   (New)     │        │
│  ├─────────────┤  ├─────────────┤  ├─────────────┤  ├─────────────┤        │
│  │FormatRoll() │  │RenderStreak │  │RenderDistri │  │PanelWidth   │        │
│  │FormatRoll   │  │()           │  │bution()     │  │DisplayCount │        │
│  │List()       │  │GetStreakDes │  │HighlightOut │  │BarWidth     │        │
│  │GetRollColor │  │cription()   │  │liers()      │  │Colors       │        │
│  │()           │  │ShowLongest  │  │ShowExpected │  └─────────────┘        │
│  │HighlightCri │  │Streaks()    │  │Line()       │                          │
│  │tical()      │  │GetStreakCol │  │FormatBar()  │                          │
│  └─────────────┘  │or()         │  └─────────────┘                          │
│                   └─────────────┘                                            │
│                                                                              │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │                    DiceHistoryDisplayDto (New DTO)                   │    │
│  ├─────────────────────────────────────────────────────────────────────┤    │
│  │ + RecentRolls: IReadOnlyList<int>                                    │    │
│  │ + DieType: string ("d20")                                            │    │
│  │ + TotalRolls: int                                                    │    │
│  │ + NaturalTwenties: int                                               │    │
│  │ + NaturalOnes: int                                                   │    │
│  │ + AverageRoll: float                                                 │    │
│  │ + ExpectedAverage: float                                             │    │
│  │ + LuckDeviation: float                                               │    │
│  │ + CurrentStreak: int (positive = lucky, negative = unlucky)          │    │
│  │ + LongestLuckyStreak: int                                            │    │
│  │ + LongestUnluckyStreak: int                                          │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
│                                                                              │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │                    DiceStatisticsDto (New DTO)                       │    │
│  ├─────────────────────────────────────────────────────────────────────┤    │
│  │ + TotalRolls: int                                                    │    │
│  │ + NaturalTwentyCount: int                                            │    │
│  │ + NaturalTwentyPercentage: float                                     │    │
│  │ + NaturalOneCount: int                                               │    │
│  │ + NaturalOnePercentage: float                                        │    │
│  │ + AverageRoll: float                                                 │    │
│  │ + ExpectedAverage: float (10.5 for d20)                              │    │
│  │ + Deviation: float (AverageRoll - ExpectedAverage)                   │    │
│  │ + DeviationPercentage: float                                         │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
│                                                                              │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │                    RollDistributionDto (New DTO)                     │    │
│  ├─────────────────────────────────────────────────────────────────────┤    │
│  │ + RollCounts: int[20] (index 0 = roll 1, index 19 = roll 20)         │    │
│  │ + TotalRolls: int                                                    │    │
│  │ + ExpectedCountPerValue: float (TotalRolls / 20)                     │    │
│  │ + GetPercentage(int rollValue): float                                │    │
│  │ + IsAboveExpected(int rollValue): bool                               │    │
│  │ + IsBelowExpected(int rollValue): bool                               │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                          APPLICATION LAYER                                   │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │                    IDiceHistoryService (v0.12.x)                     │    │
│  ├─────────────────────────────────────────────────────────────────────┤    │
│  │ + GetRecentRolls(int count) : IEnumerable<DiceRoll>                  │    │
│  │ + GetStatistics() : DiceStatistics                                   │    │
│  │ + GetRollDistribution() : int[]                                      │    │
│  │ + GetCurrentStreak() : int                                           │    │
│  │ + GetLongestStreaks() : (int lucky, int unlucky)                     │    │
│  │ + RecordRoll(DiceRoll roll) : void                                   │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                            DOMAIN LAYER                                      │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  ┌───────────────────────┐  ┌───────────────────────┐                       │
│  │  DiceRollHistory      │  │  DiceRoll             │                       │
│  │  (v0.12.x Entity)     │  │  (Value Object)       │                       │
│  ├───────────────────────┤  ├───────────────────────┤                       │
│  │ + Id: Guid            │  │ + Value: int          │                       │
│  │ + PlayerId: Guid      │  │ + DieType: DieType    │                       │
│  │ + Rolls: List<Dice    │  │ + Timestamp: DateTime │                       │
│  │   Roll>               │  │ + IsCriticalSuccess:  │                       │
│  │ + RecordRoll()        │  │   bool                │                       │
│  │ + GetStatistics()     │  │ + IsCriticalFailure:  │                       │
│  └───────────────────────┘  │   bool                │                       │
│                             └───────────────────────┘                       │
│                                                                              │
│  ┌───────────────────────┐                                                  │
│  │  DiceStatistics       │                                                  │
│  │  (Value Object)       │                                                  │
│  ├───────────────────────┤                                                  │
│  │ + TotalRolls: int     │                                                  │
│  │ + NaturalTwenties: int│                                                  │
│  │ + NaturalOnes: int    │                                                  │
│  │ + Average: float      │                                                  │
│  │ + Distribution: int[] │                                                  │
│  └───────────────────────┘                                                  │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 3.2 Dice History Display Flow

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                      DICE HISTORY DISPLAY FLOW                               │
└─────────────────────────────────────────────────────────────────────────────┘

    User Input: "dicehistory" or "dice"
           │
           ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                         COMMAND PARSING                                      │
├─────────────────────────────────────────────────────────────────────────────┤
│  ConsoleInputHandler.ParseCommand("dicehistory")                             │
│      │                                                                       │
│      └──▶ return new DiceHistoryCommand();                                   │
└─────────────────────────────────────────────────────────────────────────────┘
           │
           ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                        COMMAND EXECUTION                                     │
├─────────────────────────────────────────────────────────────────────────────┤
│  DiceHistoryCommandHandler.Handle(DiceHistoryCommand)                        │
│      │                                                                       │
│      ├──▶ IDiceHistoryService.GetRecentRolls(20)                            │
│      │        └──▶ Returns IEnumerable<DiceRoll>                             │
│      │                                                                       │
│      ├──▶ IDiceHistoryService.GetStatistics()                                │
│      │        └──▶ Returns DiceStatistics                                    │
│      │                                                                       │
│      ├──▶ IDiceHistoryService.GetRollDistribution()                          │
│      │        └──▶ Returns int[20]                                           │
│      │                                                                       │
│      ├──▶ IDiceHistoryService.GetCurrentStreak()                             │
│      │        └──▶ Returns int (positive/negative)                           │
│      │                                                                       │
│      ├──▶ IDiceHistoryService.GetLongestStreaks()                            │
│      │        └──▶ Returns (int lucky, int unlucky)                          │
│      │                                                                       │
│      └──▶ Map to DiceHistoryDisplayDto                                       │
└─────────────────────────────────────────────────────────────────────────────┘
           │
           ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                           RENDERING                                          │
├─────────────────────────────────────────────────────────────────────────────┤
│  IGameRenderer.RenderDiceHistoryAsync(DiceHistoryDisplayDto)                 │
│      │                                                                       │
│      ├──▶ DiceHistoryPanel.RenderHistory(recentRolls)                        │
│      │        └──▶ DiceRollRenderer.FormatRollList(rolls)                    │
│      │             └──▶ HighlightCritical(roll) for 20! and 1!               │
│      │                                                                       │
│      ├──▶ DiceHistoryPanel.ShowStatistics(statistics)                        │
│      │        └──▶ Format total rolls, nat 20s, nat 1s, average              │
│      │                                                                       │
│      ├──▶ StreakIndicator.RenderStreak(currentStreak, isLucky)               │
│      │        └──▶ ShowLongestStreaks(longestLucky, longestUnlucky)          │
│      │                                                                       │
│      ├──▶ DiceHistoryPanel.ShowLuckRating(luckDeviation)                     │
│      │        └──▶ Map deviation to rating: VERY LUCKY, LUCKY, etc.          │
│      │                                                                       │
│      └──▶ RollDistributionChart.RenderDistribution(distribution)             │
│               └──▶ FormatBar(count, maxCount) for each roll value 1-20       │
│               └──▶ HighlightOutliers(expectedCount)                          │
└─────────────────────────────────────────────────────────────────────────────┘
           │
           ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                         TERMINAL OUTPUT                                      │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  +=====================================================================+    │
│  |                        DICE HISTORY                                  |    │
│  +=====================================================================+    │
│  |                                                                      |    │
│  |   RECENT ROLLS (d20)                                                 |    │
│  |   ------------------                                                 |    │
│  |   18, 14, 12, 3, 20!, 8, 15, 11, 19, 7, 16, 4, 9, 13, 20!, 6        |    │
│  |                                                                      |    │
│  |   ----------------------------------------------------------------- |    │
│  |                                                                      |    │
│  |   STATISTICS                  LUCK RATING                            |    │
│  |   ----------                  -----------                            |    │
│  |   Total d20 Rolls: 523        LUCKY (+6.7%)                          |    │
│  |   Natural 20s: 47 (9.0%)                                            |    │
│  |   Natural 1s: 31 (5.9%)       Current Streak: +3                    |    │
│  |   Average Roll: 11.2          (3 above-average in a row)            |    │
│  |   Expected: 10.5                                                     |    │
│  |                               Longest Lucky: +7                      |    │
│  |                               Longest Unlucky: -5                    |    │
│  |                                                                      |    │
│  |   ----------------------------------------------------------------- |    │
│  |                                                                      |    │
│  |   ROLL DISTRIBUTION                                                  |    │
│  |   -----------------                                                  |    │
│  |   1  [####................]  31 (5.9%)                              |    │
│  |   ...                                                                |    │
│  |   20 [#########...........]  47 (9.0%) <- Above expected!           |    │
│  |                                                                      |    │
│  +=====================================================================+    │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 3.3 Streak Calculation Flow

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                      STREAK CALCULATION FLOW                                 │
└─────────────────────────────────────────────────────────────────────────────┘

    Roll History: [18, 14, 12, 3, 20, 8, 15, 11, 19]
           │
           ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│  STEP 1: Determine "above average" vs "below average" for each roll          │
├─────────────────────────────────────────────────────────────────────────────┤
│  Expected Average for d20: 10.5                                              │
│                                                                              │
│  Roll 18: 18 > 10.5 → Above Average (+)                                      │
│  Roll 14: 14 > 10.5 → Above Average (+)                                      │
│  Roll 12: 12 > 10.5 → Above Average (+)                                      │
│  Roll  3:  3 < 10.5 → Below Average (-)                                      │
│  Roll 20: 20 > 10.5 → Above Average (+)                                      │
│  Roll  8:  8 < 10.5 → Below Average (-)                                      │
│  Roll 15: 15 > 10.5 → Above Average (+)                                      │
│  Roll 11: 11 > 10.5 → Above Average (+)                                      │
│  Roll 19: 19 > 10.5 → Above Average (+)                                      │
│                                                                              │
│  Sequence: [+, +, +, -, +, -, +, +, +]                                        │
└─────────────────────────────────────────────────────────────────────────────┘
           │
           ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│  STEP 2: Count current streak (from most recent roll backwards)              │
├─────────────────────────────────────────────────────────────────────────────┤
│  Most recent: 19 (+) → Start counting                                        │
│  Previous: 11 (+) → Continue: 2                                              │
│  Previous: 15 (+) → Continue: 3                                              │
│  Previous: 8 (-) → STOP                                                      │
│                                                                              │
│  Current Streak: +3 (3 above-average rolls in a row)                         │
└─────────────────────────────────────────────────────────────────────────────┘
           │
           ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│  STEP 3: Determine longest streaks (scan full history)                       │
├─────────────────────────────────────────────────────────────────────────────┤
│  Longest Lucky Streak: Scan for longest consecutive + sequence               │
│  Longest Unlucky Streak: Scan for longest consecutive - sequence             │
│                                                                              │
│  Example Result:                                                             │
│  - Longest Lucky: +7 (7 above-average in a row at some point)               │
│  - Longest Unlucky: -5 (5 below-average in a row at some point)             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 3.4 Luck Rating Calculation Flow

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                      LUCK RATING CALCULATION FLOW                            │
└─────────────────────────────────────────────────────────────────────────────┘

    Statistics Input:
    - Total Rolls: 523
    - Sum of All Rolls: 5,858
    - Average Roll: 11.2
    - Expected Average: 10.5
           │
           ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│  STEP 1: Calculate deviation from expected                                   │
├─────────────────────────────────────────────────────────────────────────────┤
│  Deviation = Average Roll - Expected Average                                 │
│  Deviation = 11.2 - 10.5 = +0.7                                              │
│                                                                              │
│  Deviation Percentage = (Deviation / Expected Average) * 100                 │
│  Deviation Percentage = (0.7 / 10.5) * 100 = +6.67%                         │
└─────────────────────────────────────────────────────────────────────────────┘
           │
           ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│  STEP 2: Map deviation to luck rating                                        │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  Deviation >= +10%  → "VERY LUCKY"   (Color: Bright Green)                   │
│  Deviation >= +5%   → "LUCKY"        (Color: Green)                          │
│  Deviation >= -5%   → "NORMAL"       (Color: White)                          │
│  Deviation >= -10%  → "UNLUCKY"      (Color: Yellow)                         │
│  Deviation < -10%   → "VERY UNLUCKY" (Color: Red)                            │
│                                                                              │
│  +6.67% falls in "LUCKY" range                                               │
│                                                                              │
│  Output: "LUCKY (+6.7%)"                                                     │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 4. Dice History Panel

### 4.1 Purpose

The `DiceHistoryPanel` is the main container component that displays comprehensive dice roll history, statistics, luck rating, and distribution. It orchestrates the rendering of sub-components (`StreakIndicator`, `RollDistributionChart`) and provides the overall panel structure.

### 4.2 Component Design

**File:** `src/Presentation/RuneAndRust.Presentation.Tui/UI/DiceHistoryPanel.cs`

```csharp
/// <summary>
/// Panel component that displays comprehensive dice roll history including
/// recent rolls, statistics, luck rating, streaks, and distribution.
/// </summary>
/// <remarks>
/// This component visualizes data from IDiceHistoryService and does not
/// perform any dice calculations. All statistics and history are retrieved
/// from the Application layer services.
/// </remarks>
public class DiceHistoryPanel
{
    private readonly ITerminalService _terminal;
    private readonly DiceRollRenderer _rollRenderer;
    private readonly StreakIndicator _streakIndicator;
    private readonly RollDistributionChart _distributionChart;
    private readonly DiceHistoryPanelConfig _config;
    private readonly ILogger<DiceHistoryPanel> _logger;

    private int _positionX;
    private int _positionY;

    /// <summary>
    /// Creates a new dice history panel with the specified dependencies.
    /// </summary>
    /// <param name="terminal">Terminal service for output.</param>
    /// <param name="rollRenderer">Renderer for individual dice rolls.</param>
    /// <param name="streakIndicator">Streak indicator component.</param>
    /// <param name="distributionChart">Roll distribution chart component.</param>
    /// <param name="config">Panel configuration.</param>
    /// <param name="logger">Logger instance.</param>
    public DiceHistoryPanel(
        ITerminalService terminal,
        DiceRollRenderer rollRenderer,
        StreakIndicator streakIndicator,
        RollDistributionChart distributionChart,
        DiceHistoryPanelConfig config,
        ILogger<DiceHistoryPanel> logger)
    {
        _terminal = terminal ?? throw new ArgumentNullException(nameof(terminal));
        _rollRenderer = rollRenderer ?? throw new ArgumentNullException(nameof(rollRenderer));
        _streakIndicator = streakIndicator ?? throw new ArgumentNullException(nameof(streakIndicator));
        _distributionChart = distributionChart ?? throw new ArgumentNullException(nameof(distributionChart));
        _config = config ?? throw new ArgumentNullException(nameof(config));
        _logger = logger ?? throw new ArgumentNullException(nameof(logger));
    }

    /// <summary>
    /// Renders the recent roll history section.
    /// </summary>
    /// <param name="rolls">Collection of recent dice rolls.</param>
    public void RenderHistory(IEnumerable<DiceRoll> rolls)
    {
        // Implementation: Format and display recent rolls
        // Uses DiceRollRenderer.FormatRollList() for formatting
    }

    /// <summary>
    /// Shows the statistics section including total rolls, nat 20s, nat 1s, and average.
    /// </summary>
    /// <param name="statistics">Calculated dice statistics.</param>
    public void ShowStatistics(DiceStatistics statistics)
    {
        // Implementation: Display statistics in formatted columns
    }

    /// <summary>
    /// Shows the luck rating based on deviation from expected average.
    /// </summary>
    /// <param name="deviation">Deviation percentage from expected (positive = lucky).</param>
    public void ShowLuckRating(float deviation)
    {
        // Implementation: Map deviation to rating string and color
    }

    /// <summary>
    /// Sets the number of recent rolls to display.
    /// </summary>
    /// <param name="count">Number of rolls to display (default 20).</param>
    public void SetDisplayCount(int count)
    {
        // Implementation: Update config display count
    }

    /// <summary>
    /// Sets the position for rendering the panel.
    /// </summary>
    /// <param name="x">X coordinate.</param>
    /// <param name="y">Y coordinate.</param>
    public void SetPosition(int x, int y)
    {
        _positionX = x;
        _positionY = y;
    }

    /// <summary>
    /// Renders the complete dice history panel with all sections.
    /// </summary>
    /// <param name="displayDto">Complete dice history display data.</param>
    public void Render(DiceHistoryDisplayDto displayDto)
    {
        // Implementation:
        // 1. Render panel header "DICE HISTORY"
        // 2. Render recent rolls section
        // 3. Render statistics section (left column)
        // 4. Render luck rating section (right column)
        // 5. Render streak indicator
        // 6. Render roll distribution chart
        // 7. Render panel footer
    }
}
```

### 4.3 Panel Layout Specification

```
Width: 72 characters (configurable)
Height: Variable based on content

┌─────────────────────────────────────────────────────────────────────┐
│ Line 1:  Header bar "DICE HISTORY"                                   │
├─────────────────────────────────────────────────────────────────────┤
│ Line 2:  Empty line                                                  │
│ Line 3:  Section header "RECENT ROLLS (d20)"                         │
│ Line 4:  Separator dashes                                            │
│ Line 5:  Recent rolls list (comma-separated, highlighted criticals)  │
│ Line 6:  Empty line                                                  │
│ Line 7:  Full-width separator                                        │
│ Line 8:  Empty line                                                  │
│ Line 9:  Two-column headers "STATISTICS" and "LUCK RATING"           │
│ Line 10: Two-column separators                                       │
│ Lines 11-16: Statistics data (left) and luck data (right)            │
│ Line 17: Empty line                                                  │
│ Line 18: Full-width separator                                        │
│ Line 19: Empty line                                                  │
│ Line 20: Section header "ROLL DISTRIBUTION"                          │
│ Line 21: Separator dashes                                            │
│ Lines 22-41: Distribution bars (20 lines for values 1-20)            │
│ Line 42: Empty line                                                  │
│ Line 43: Footer bar                                                  │
└─────────────────────────────────────────────────────────────────────┘
```

---

## 5. Streak Indicator

### 5.1 Purpose

The `StreakIndicator` component displays the current lucky/unlucky streak and historical longest streaks. It provides visual feedback on consecutive above-average or below-average roll sequences.

### 5.2 Component Design

**File:** `src/Presentation/RuneAndRust.Presentation.Tui/UI/StreakIndicator.cs`

```csharp
/// <summary>
/// Component that displays dice roll streak information including
/// current streak and longest historical streaks.
/// </summary>
/// <remarks>
/// A "streak" is defined as consecutive rolls that are all above or
/// all below the expected average (10.5 for d20). Positive streaks
/// indicate "lucky" runs, negative indicate "unlucky" runs.
/// </remarks>
public class StreakIndicator
{
    private readonly ITerminalService _terminal;
    private readonly DiceHistoryPanelConfig _config;
    private readonly ILogger<StreakIndicator> _logger;

    /// <summary>
    /// Creates a new streak indicator with the specified dependencies.
    /// </summary>
    /// <param name="terminal">Terminal service for output.</param>
    /// <param name="config">Panel configuration.</param>
    /// <param name="logger">Logger instance.</param>
    public StreakIndicator(
        ITerminalService terminal,
        DiceHistoryPanelConfig config,
        ILogger<StreakIndicator> logger)
    {
        _terminal = terminal ?? throw new ArgumentNullException(nameof(terminal));
        _config = config ?? throw new ArgumentNullException(nameof(config));
        _logger = logger ?? throw new ArgumentNullException(nameof(logger));
    }

    /// <summary>
    /// Renders the current streak indicator.
    /// </summary>
    /// <param name="streakCount">Number of consecutive rolls in streak (positive = lucky).</param>
    /// <param name="isLucky">True if streak is above average, false if below.</param>
    public void RenderStreak(int streakCount, bool isLucky)
    {
        // Implementation: Display "+N" or "-N" with appropriate color
    }

    /// <summary>
    /// Gets a human-readable description of the streak.
    /// </summary>
    /// <param name="streakCount">Number of consecutive rolls in streak.</param>
    /// <returns>Description like "(3 above-average in a row)".</returns>
    public string GetStreakDescription(int streakCount)
    {
        // Implementation: Generate description based on count and direction
    }

    /// <summary>
    /// Displays the longest lucky and unlucky streaks from history.
    /// </summary>
    /// <param name="longestLucky">Longest above-average streak.</param>
    /// <param name="longestUnlucky">Longest below-average streak.</param>
    public void ShowLongestStreaks(int longestLucky, int longestUnlucky)
    {
        // Implementation: Display "Longest Lucky: +N" and "Longest Unlucky: -N"
    }

    /// <summary>
    /// Gets the appropriate color for the streak display.
    /// </summary>
    /// <param name="streakCount">Streak count (positive or negative).</param>
    /// <returns>Console color for the streak value.</returns>
    public ConsoleColor GetStreakColor(int streakCount)
    {
        // Implementation:
        // Positive streak: Green (lucky)
        // Negative streak: Red (unlucky)
        // Zero: White (neutral)
    }
}
```

### 5.3 Streak Display Format

```
Current Streak Display:
━━━━━━━━━━━━━━━━━━━━━
Current Streak: +3
(3 above-average in a row)

Longest Lucky: +7
Longest Unlucky: -5
━━━━━━━━━━━━━━━━━━━━━

Streak Value Formatting:
- Positive: "+N" (green color)
- Negative: "-N" (red color)
- Zero: "0" (white color)

Description Formatting:
- Positive: "(N above-average in a row)"
- Negative: "(N below-average in a row)"
- Zero: "(no streak)"
```

---

## 6. Roll Distribution Chart

### 6.1 Purpose

The `RollDistributionChart` component displays an ASCII bar chart showing the distribution of roll values from 1 to 20. It highlights outliers that are significantly above or below expected frequency.

### 6.2 Component Design

**File:** `src/Presentation/RuneAndRust.Presentation.Tui/UI/RollDistributionChart.cs`

```csharp
/// <summary>
/// Component that displays a bar chart visualization of dice roll
/// distribution across all possible values (1-20 for d20).
/// </summary>
/// <remarks>
/// Uses ASCII characters to render horizontal bars representing the
/// frequency of each roll value. Highlights values that deviate
/// significantly from the expected uniform distribution.
/// </remarks>
public class RollDistributionChart
{
    private readonly ITerminalService _terminal;
    private readonly DiceHistoryPanelConfig _config;
    private readonly ILogger<RollDistributionChart> _logger;

    /// <summary>
    /// Creates a new roll distribution chart with the specified dependencies.
    /// </summary>
    /// <param name="terminal">Terminal service for output.</param>
    /// <param name="config">Panel configuration.</param>
    /// <param name="logger">Logger instance.</param>
    public RollDistributionChart(
        ITerminalService terminal,
        DiceHistoryPanelConfig config,
        ILogger<RollDistributionChart> logger)
    {
        _terminal = terminal ?? throw new ArgumentNullException(nameof(terminal));
        _config = config ?? throw new ArgumentNullException(nameof(config));
        _logger = logger ?? throw new ArgumentNullException(nameof(logger));
    }

    /// <summary>
    /// Renders the distribution chart for all roll values.
    /// </summary>
    /// <param name="distribution">Array of counts for each roll value (index 0 = roll 1).</param>
    public void RenderDistribution(int[] distribution)
    {
        // Implementation:
        // 1. Calculate max count for scaling
        // 2. For each value 1-20, render a bar
        // 3. Highlight outliers
    }

    /// <summary>
    /// Highlights values that are significantly above or below expected.
    /// </summary>
    /// <param name="expectedCount">Expected count per value (totalRolls / 20).</param>
    /// <param name="actualCount">Actual count for the value.</param>
    public void HighlightOutliers(int expectedCount, int actualCount)
    {
        // Implementation: Add indicator arrow for outliers
    }

    /// <summary>
    /// Shows the expected distribution line (5% for each value).
    /// </summary>
    public void ShowExpectedLine()
    {
        // Implementation: Display expected percentage reference
    }

    /// <summary>
    /// Formats a single bar for the distribution chart.
    /// </summary>
    /// <param name="count">Number of occurrences for this value.</param>
    /// <param name="maxCount">Maximum count across all values (for scaling).</param>
    /// <returns>Formatted bar string like "[####............]".</returns>
    public string FormatBar(int count, int maxCount)
    {
        // Implementation:
        // Scale count to bar width (default 20 characters)
        // Use '#' for filled portion, '.' for empty
    }
}
```

### 6.3 Distribution Chart Format

```
ROLL DISTRIBUTION
-----------------

1  [####................]  31 (5.9%)
2  [####................]  28 (5.4%)
3  [#####...............]  30 (5.7%)
4  [####................]  27 (5.2%)
5  [#####...............]  29 (5.5%)
6  [####................]  26 (5.0%)
7  [#####...............]  28 (5.4%)
8  [####................]  25 (4.8%)
9  [#####...............]  27 (5.2%)
10 [#####...............]  26 (5.0%)
11 [#####...............]  28 (5.4%)
12 [####................]  24 (4.6%)
13 [#####...............]  27 (5.2%)
14 [#####...............]  26 (5.0%)
15 [######..............]  30 (5.7%)
16 [######..............]  32 (6.1%)
17 [#####...............]  28 (5.4%)
18 [######..............]  31 (5.9%)
19 [######..............]  35 (6.7%)
20 [#########...........]  47 (9.0%) <- Above expected!

Bar Components:
- Roll Value: 2 characters, right-aligned (1-20)
- Bar: 20 characters enclosed in brackets [...]
- Filled: '#' characters
- Empty: '.' characters
- Count: Right-aligned, followed by percentage
- Outlier Indicator: "<- Above expected!" or "<- Below expected!"

Outlier Threshold:
- Above expected: count > (expectedCount * 1.5)
- Below expected: count < (expectedCount * 0.5)
- Expected count = totalRolls / 20
```

---

## 7. Dice Roll Renderer

### 7.1 Purpose

The `DiceRollRenderer` provides formatting utilities for individual dice rolls and roll lists, including critical hit/miss highlighting.

### 7.2 Component Design

**File:** `src/Presentation/RuneAndRust.Presentation.Tui/Rendering/DiceRollRenderer.cs`

```csharp
/// <summary>
/// Renderer for formatting individual dice rolls and roll lists
/// with appropriate highlighting for critical successes and failures.
/// </summary>
public class DiceRollRenderer
{
    private readonly DiceHistoryPanelConfig _config;
    private readonly ILogger<DiceRollRenderer> _logger;

    /// <summary>
    /// Creates a new dice roll renderer with the specified configuration.
    /// </summary>
    /// <param name="config">Panel configuration.</param>
    /// <param name="logger">Logger instance.</param>
    public DiceRollRenderer(
        DiceHistoryPanelConfig config,
        ILogger<DiceRollRenderer> logger)
    {
        _config = config ?? throw new ArgumentNullException(nameof(config));
        _logger = logger ?? throw new ArgumentNullException(nameof(logger));
    }

    /// <summary>
    /// Formats a single roll value with critical highlighting.
    /// </summary>
    /// <param name="rollValue">The roll result (1-20).</param>
    /// <param name="isCriticalSuccess">True if natural 20.</param>
    /// <param name="isCriticalFailure">True if natural 1.</param>
    /// <returns>Formatted roll string like "20!" or "7".</returns>
    public string FormatRoll(int rollValue, bool isCriticalSuccess, bool isCriticalFailure)
    {
        // Implementation:
        // Natural 20: "20!" with gold/yellow color
        // Natural 1: "1!" with red color
        // Other: value as-is with white color
    }

    /// <summary>
    /// Formats a list of recent rolls as a comma-separated string.
    /// </summary>
    /// <param name="rolls">Collection of dice rolls to format.</param>
    /// <returns>Formatted string like "18, 14, 12, 3, 20!, 8, 15".</returns>
    public string FormatRollList(IEnumerable<DiceRoll> rolls)
    {
        // Implementation:
        // Join rolls with ", " separator
        // Apply FormatRoll to each
    }

    /// <summary>
    /// Gets the appropriate color for a roll value.
    /// </summary>
    /// <param name="rollValue">The roll result (1-20).</param>
    /// <returns>Console color for the roll.</returns>
    public ConsoleColor GetRollColor(int rollValue)
    {
        // Implementation:
        // 20: Gold/Yellow (critical success)
        // 1: Red (critical failure)
        // 15-19: Green (good rolls)
        // 11-14: White (average)
        // 6-10: Gray (below average)
        // 2-5: Yellow (poor rolls)
    }

    /// <summary>
    /// Highlights a critical roll with special formatting.
    /// </summary>
    /// <param name="rollValue">The roll result (1 or 20).</param>
    /// <returns>Highlighted string with "!" suffix.</returns>
    public string HighlightCritical(int rollValue)
    {
        // Implementation: Add "!" suffix for critical rolls
    }
}
```

### 7.3 Roll Formatting Rules

```
Roll Formatting:
━━━━━━━━━━━━━━━━
Natural 20: "20!" - Gold/Yellow color, exclamation mark
Natural 1:  "1!"  - Red color, exclamation mark
Other:      "N"   - Color based on value range

Color Mapping:
━━━━━━━━━━━━━
20        → Yellow (critical success)
15-19     → Green (good rolls)
11-14     → White (average)
6-10      → Gray (below average)
2-5       → Yellow (poor rolls)
1         → Red (critical failure)

Roll List Format:
━━━━━━━━━━━━━━━━━
"18, 14, 12, 3, 20!, 8, 15, 11, 19, 7, 16, 4, 9, 13, 20!, 6"

- Comma and space separated
- Most recent roll first
- Critical rolls highlighted with "!"
- Wraps to next line if exceeds panel width
```

---

## 8. Data Model Changes

### 8.1 New DTOs

#### DiceHistoryDisplayDto

**File:** `src/Presentation/RuneAndRust.Presentation.Tui/DTOs/DiceHistoryDisplayDto.cs`

```csharp
/// <summary>
/// Data transfer object containing all information needed to render
/// the dice history panel.
/// </summary>
/// <param name="RecentRolls">List of recent roll values in chronological order.</param>
/// <param name="DieType">Type of die (e.g., "d20").</param>
/// <param name="TotalRolls">Total number of rolls recorded.</param>
/// <param name="NaturalTwenties">Count of natural 20 rolls.</param>
/// <param name="NaturalOnes">Count of natural 1 rolls.</param>
/// <param name="AverageRoll">Calculated average roll value.</param>
/// <param name="ExpectedAverage">Expected average (10.5 for d20).</param>
/// <param name="LuckDeviation">Percentage deviation from expected.</param>
/// <param name="CurrentStreak">Current streak count (positive = lucky).</param>
/// <param name="LongestLuckyStreak">Longest recorded lucky streak.</param>
/// <param name="LongestUnluckyStreak">Longest recorded unlucky streak.</param>
/// <param name="Distribution">Array of counts for each roll value (1-20).</param>
public record DiceHistoryDisplayDto(
    IReadOnlyList<int> RecentRolls,
    string DieType,
    int TotalRolls,
    int NaturalTwenties,
    int NaturalOnes,
    float AverageRoll,
    float ExpectedAverage,
    float LuckDeviation,
    int CurrentStreak,
    int LongestLuckyStreak,
    int LongestUnluckyStreak,
    int[] Distribution);
```

#### DiceStatisticsDto

**File:** `src/Presentation/RuneAndRust.Presentation.Tui/DTOs/DiceStatisticsDto.cs`

```csharp
/// <summary>
/// Data transfer object for dice roll statistics display.
/// </summary>
/// <param name="TotalRolls">Total number of rolls recorded.</param>
/// <param name="NaturalTwentyCount">Number of natural 20 rolls.</param>
/// <param name="NaturalTwentyPercentage">Percentage of rolls that were natural 20.</param>
/// <param name="NaturalOneCount">Number of natural 1 rolls.</param>
/// <param name="NaturalOnePercentage">Percentage of rolls that were natural 1.</param>
/// <param name="AverageRoll">Calculated average roll value.</param>
/// <param name="ExpectedAverage">Expected average for this die type.</param>
/// <param name="Deviation">Deviation from expected average.</param>
/// <param name="DeviationPercentage">Deviation as a percentage.</param>
public record DiceStatisticsDto(
    int TotalRolls,
    int NaturalTwentyCount,
    float NaturalTwentyPercentage,
    int NaturalOneCount,
    float NaturalOnePercentage,
    float AverageRoll,
    float ExpectedAverage,
    float Deviation,
    float DeviationPercentage);
```

#### RollDistributionDto

**File:** `src/Presentation/RuneAndRust.Presentation.Tui/DTOs/RollDistributionDto.cs`

```csharp
/// <summary>
/// Data transfer object for roll distribution chart display.
/// </summary>
/// <param name="RollCounts">Array of counts indexed by (rollValue - 1).</param>
/// <param name="TotalRolls">Total number of rolls for percentage calculation.</param>
public record RollDistributionDto(int[] RollCounts, int TotalRolls)
{
    /// <summary>
    /// Gets the expected count per roll value for uniform distribution.
    /// </summary>
    public float ExpectedCountPerValue => TotalRolls / 20f;

    /// <summary>
    /// Gets the percentage of total rolls for a specific value.
    /// </summary>
    /// <param name="rollValue">The roll value (1-20).</param>
    /// <returns>Percentage as a float (e.g., 5.5 for 5.5%).</returns>
    public float GetPercentage(int rollValue)
    {
        if (rollValue < 1 || rollValue > 20 || TotalRolls == 0)
            return 0f;
        return (RollCounts[rollValue - 1] / (float)TotalRolls) * 100f;
    }

    /// <summary>
    /// Determines if a roll value is significantly above expected.
    /// </summary>
    /// <param name="rollValue">The roll value (1-20).</param>
    /// <returns>True if count exceeds 150% of expected.</returns>
    public bool IsAboveExpected(int rollValue)
    {
        if (rollValue < 1 || rollValue > 20)
            return false;
        return RollCounts[rollValue - 1] > ExpectedCountPerValue * 1.5f;
    }

    /// <summary>
    /// Determines if a roll value is significantly below expected.
    /// </summary>
    /// <param name="rollValue">The roll value (1-20).</param>
    /// <returns>True if count is below 50% of expected.</returns>
    public bool IsBelowExpected(int rollValue)
    {
        if (rollValue < 1 || rollValue > 20)
            return false;
        return RollCounts[rollValue - 1] < ExpectedCountPerValue * 0.5f;
    }
}
```

### 8.2 Data Model Summary

| Entity/DTO | Layer | Purpose |
|------------|-------|---------|
| `DiceHistoryDisplayDto` | Presentation | Complete display data for panel |
| `DiceStatisticsDto` | Presentation | Statistics section display data |
| `RollDistributionDto` | Presentation | Distribution chart display data |
| `DiceRollHistory` | Domain (v0.12.x) | Roll history tracking entity |
| `DiceRoll` | Domain (v0.12.x) | Individual roll value object |
| `DiceStatistics` | Domain (v0.12.x) | Calculated statistics value object |

---

## 9. Configuration

### 9.1 DiceHistoryPanelConfig

**File:** `src/Presentation/RuneAndRust.Presentation.Tui/Configuration/DiceHistoryPanelConfig.cs`

```csharp
/// <summary>
/// Configuration for the dice history panel display settings.
/// </summary>
public class DiceHistoryPanelConfig
{
    /// <summary>
    /// Total width of the panel in characters.
    /// </summary>
    public int PanelWidth { get; set; } = 72;

    /// <summary>
    /// Number of recent rolls to display.
    /// </summary>
    public int RecentRollDisplayCount { get; set; } = 20;

    /// <summary>
    /// Width of distribution chart bars in characters.
    /// </summary>
    public int DistributionBarWidth { get; set; } = 20;

    /// <summary>
    /// Threshold for "very lucky" luck rating (percentage).
    /// </summary>
    public float VeryLuckyThreshold { get; set; } = 10.0f;

    /// <summary>
    /// Threshold for "lucky" luck rating (percentage).
    /// </summary>
    public float LuckyThreshold { get; set; } = 5.0f;

    /// <summary>
    /// Threshold for "unlucky" luck rating (percentage).
    /// </summary>
    public float UnluckyThreshold { get; set; } = -5.0f;

    /// <summary>
    /// Threshold for "very unlucky" luck rating (percentage).
    /// </summary>
    public float VeryUnluckyThreshold { get; set; } = -10.0f;

    /// <summary>
    /// Color for natural 20 (critical success) display.
    /// </summary>
    public ConsoleColor CriticalSuccessColor { get; set; } = ConsoleColor.Yellow;

    /// <summary>
    /// Color for natural 1 (critical failure) display.
    /// </summary>
    public ConsoleColor CriticalFailureColor { get; set; } = ConsoleColor.Red;

    /// <summary>
    /// Color for lucky streak indicator.
    /// </summary>
    public ConsoleColor LuckyStreakColor { get; set; } = ConsoleColor.Green;

    /// <summary>
    /// Color for unlucky streak indicator.
    /// </summary>
    public ConsoleColor UnluckyStreakColor { get; set; } = ConsoleColor.Red;

    /// <summary>
    /// Color for "very lucky" luck rating.
    /// </summary>
    public ConsoleColor VeryLuckyColor { get; set; } = ConsoleColor.Green;

    /// <summary>
    /// Color for "lucky" luck rating.
    /// </summary>
    public ConsoleColor LuckyColor { get; set; } = ConsoleColor.DarkGreen;

    /// <summary>
    /// Color for "normal" luck rating.
    /// </summary>
    public ConsoleColor NormalLuckColor { get; set; } = ConsoleColor.White;

    /// <summary>
    /// Color for "unlucky" luck rating.
    /// </summary>
    public ConsoleColor UnluckyColor { get; set; } = ConsoleColor.DarkYellow;

    /// <summary>
    /// Color for "very unlucky" luck rating.
    /// </summary>
    public ConsoleColor VeryUnluckyColor { get; set; } = ConsoleColor.Red;

    /// <summary>
    /// Color for above-expected outliers in distribution.
    /// </summary>
    public ConsoleColor AboveExpectedColor { get; set; } = ConsoleColor.Green;

    /// <summary>
    /// Color for below-expected outliers in distribution.
    /// </summary>
    public ConsoleColor BelowExpectedColor { get; set; } = ConsoleColor.Red;

    /// <summary>
    /// Character for filled portion of distribution bars.
    /// </summary>
    public char BarFilledChar { get; set; } = '#';

    /// <summary>
    /// Character for empty portion of distribution bars.
    /// </summary>
    public char BarEmptyChar { get; set; } = '.';
}
```

### 9.2 Configuration JSON Schema

**File:** `config/schemas/dice-history-panel.schema.json`

```json
{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "dice-history-panel.schema.json",
  "title": "Dice History Panel Configuration",
  "type": "object",
  "properties": {
    "panelWidth": {
      "type": "integer",
      "minimum": 60,
      "maximum": 120,
      "default": 72,
      "description": "Total width of the panel in characters"
    },
    "recentRollDisplayCount": {
      "type": "integer",
      "minimum": 10,
      "maximum": 50,
      "default": 20,
      "description": "Number of recent rolls to display"
    },
    "distributionBarWidth": {
      "type": "integer",
      "minimum": 10,
      "maximum": 40,
      "default": 20,
      "description": "Width of distribution chart bars"
    },
    "thresholds": {
      "type": "object",
      "properties": {
        "veryLucky": {
          "type": "number",
          "default": 10.0,
          "description": "Percentage threshold for very lucky rating"
        },
        "lucky": {
          "type": "number",
          "default": 5.0,
          "description": "Percentage threshold for lucky rating"
        },
        "unlucky": {
          "type": "number",
          "default": -5.0,
          "description": "Percentage threshold for unlucky rating"
        },
        "veryUnlucky": {
          "type": "number",
          "default": -10.0,
          "description": "Percentage threshold for very unlucky rating"
        }
      }
    },
    "colors": {
      "type": "object",
      "properties": {
        "criticalSuccess": { "type": "string", "default": "Yellow" },
        "criticalFailure": { "type": "string", "default": "Red" },
        "luckyStreak": { "type": "string", "default": "Green" },
        "unluckyStreak": { "type": "string", "default": "Red" },
        "veryLucky": { "type": "string", "default": "Green" },
        "lucky": { "type": "string", "default": "DarkGreen" },
        "normal": { "type": "string", "default": "White" },
        "unlucky": { "type": "string", "default": "DarkYellow" },
        "veryUnlucky": { "type": "string", "default": "Red" },
        "aboveExpected": { "type": "string", "default": "Green" },
        "belowExpected": { "type": "string", "default": "Red" }
      }
    },
    "characters": {
      "type": "object",
      "properties": {
        "barFilled": { "type": "string", "maxLength": 1, "default": "#" },
        "barEmpty": { "type": "string", "maxLength": 1, "default": "." }
      }
    }
  }
}
```

### 9.3 Example Configuration File

**File:** `config/dice-history-panel.json`

```json
{
  "$schema": "./schemas/dice-history-panel.schema.json",
  "panelWidth": 72,
  "recentRollDisplayCount": 20,
  "distributionBarWidth": 20,
  "thresholds": {
    "veryLucky": 10.0,
    "lucky": 5.0,
    "unlucky": -5.0,
    "veryUnlucky": -10.0
  },
  "colors": {
    "criticalSuccess": "Yellow",
    "criticalFailure": "Red",
    "luckyStreak": "Green",
    "unluckyStreak": "Red",
    "veryLucky": "Green",
    "lucky": "DarkGreen",
    "normal": "White",
    "unlucky": "DarkYellow",
    "veryUnlucky": "Red",
    "aboveExpected": "Green",
    "belowExpected": "Red"
  },
  "characters": {
    "barFilled": "#",
    "barEmpty": "."
  }
}
```

---

## 10. Commands

### 10.1 DiceHistoryCommand

**File:** `src/Application/RuneAndRust.Application/Commands/DiceHistoryCommand.cs`

```csharp
/// <summary>
/// Command to display the dice roll history panel.
/// </summary>
public record DiceHistoryCommand() : GameCommand;
```

### 10.2 Command Parsing

**File:** `src/Presentation/RuneAndRust.Presentation.Tui/Input/ConsoleInputHandler.cs`

```csharp
// Add to ParseCommand method:

"dicehistory" or "dice" or "rolls" => new DiceHistoryCommand(),
```

### 10.3 Command Handler

**File:** `src/Application/RuneAndRust.Application/Handlers/DiceHistoryCommandHandler.cs`

```csharp
/// <summary>
/// Handler for the dice history command.
/// </summary>
public class DiceHistoryCommandHandler : ICommandHandler<DiceHistoryCommand>
{
    private readonly IDiceHistoryService _diceHistoryService;
    private readonly IGameRenderer _renderer;
    private readonly ILogger<DiceHistoryCommandHandler> _logger;

    public DiceHistoryCommandHandler(
        IDiceHistoryService diceHistoryService,
        IGameRenderer renderer,
        ILogger<DiceHistoryCommandHandler> logger)
    {
        _diceHistoryService = diceHistoryService;
        _renderer = renderer;
        _logger = logger;
    }

    public async Task<CommandResult> HandleAsync(
        DiceHistoryCommand command,
        CancellationToken ct = default)
    {
        _logger.LogDebug("Handling dice history command");

        // Retrieve data from service
        var recentRolls = _diceHistoryService.GetRecentRolls(20);
        var statistics = _diceHistoryService.GetStatistics();
        var distribution = _diceHistoryService.GetRollDistribution();
        var currentStreak = _diceHistoryService.GetCurrentStreak();
        var (longestLucky, longestUnlucky) = _diceHistoryService.GetLongestStreaks();

        // Map to display DTO
        var displayDto = new DiceHistoryDisplayDto(
            RecentRolls: recentRolls.Select(r => r.Value).ToList(),
            DieType: "d20",
            TotalRolls: statistics.TotalRolls,
            NaturalTwenties: statistics.NaturalTwenties,
            NaturalOnes: statistics.NaturalOnes,
            AverageRoll: statistics.Average,
            ExpectedAverage: 10.5f,
            LuckDeviation: ((statistics.Average - 10.5f) / 10.5f) * 100f,
            CurrentStreak: currentStreak,
            LongestLuckyStreak: longestLucky,
            LongestUnluckyStreak: longestUnlucky,
            Distribution: distribution);

        // Render the panel
        await _renderer.RenderDiceHistoryAsync(displayDto, ct);

        _logger.LogInformation("Rendered dice history panel with {TotalRolls} total rolls",
            statistics.TotalRolls);

        return CommandResult.Success();
    }
}
```

### 10.4 User Commands

| Command | Aliases | Description |
|---------|---------|-------------|
| `dicehistory` | `dice`, `rolls` | Display the dice history panel |

---

## 11. User-Facing Changes

### 11.1 Complete Dice History Panel Display

```
+=====================================================================+
|                        DICE HISTORY                                  |
+=====================================================================+
|                                                                      |
|   RECENT ROLLS (d20)                                                 |
|   ------------------                                                 |
|   18, 14, 12, 3, 20!, 8, 15, 11, 19, 7, 16, 4, 9, 13, 20!, 6        |
|                                                                      |
|   ----------------------------------------------------------------- |
|                                                                      |
|   STATISTICS                  LUCK RATING                            |
|   ----------                  -----------                            |
|   Total d20 Rolls: 523        LUCKY (+6.7%)                          |
|   Natural 20s: 47 (9.0%)                                            |
|   Natural 1s: 31 (5.9%)       Current Streak: +3                    |
|   Average Roll: 11.2          (3 above-average in a row)            |
|   Expected: 10.5                                                     |
|                               Longest Lucky: +7                      |
|                               Longest Unlucky: -5                    |
|                                                                      |
|   ----------------------------------------------------------------- |
|                                                                      |
|   ROLL DISTRIBUTION                                                  |
|   -----------------                                                  |
|                                                                      |
|   1  [####................]  31 (5.9%)                              |
|   2  [####................]  28 (5.4%)                              |
|   3  [#####...............]  30 (5.7%)                              |
|   4  [####................]  27 (5.2%)                              |
|   5  [#####...............]  29 (5.5%)                              |
|   6  [####................]  26 (5.0%)                              |
|   7  [#####...............]  28 (5.4%)                              |
|   8  [####................]  25 (4.8%)                              |
|   9  [#####...............]  27 (5.2%)                              |
|   10 [#####...............]  26 (5.0%)                              |
|   11 [#####...............]  28 (5.4%)                              |
|   12 [####................]  24 (4.6%)                              |
|   13 [#####...............]  27 (5.2%)                              |
|   14 [#####...............]  26 (5.0%)                              |
|   15 [######..............]  30 (5.7%)                              |
|   16 [######..............]  32 (6.1%)                              |
|   17 [#####...............]  28 (5.4%)                              |
|   18 [######..............]  31 (5.9%)                              |
|   19 [######..............]  35 (6.7%)                              |
|   20 [#########...........]  47 (9.0%) <- Above expected!           |
|                                                                      |
+=====================================================================+
```

### 11.2 Roll Formatting Examples

| Roll Value | Display | Color | Notes |
|------------|---------|-------|-------|
| 20 | `20!` | Yellow | Critical success indicator |
| 1 | `1!` | Red | Critical failure indicator |
| 15-19 | `15`, `16`, etc. | Green | Good rolls |
| 11-14 | `11`, `12`, etc. | White | Average rolls |
| 6-10 | `6`, `7`, etc. | Gray | Below average |
| 2-5 | `2`, `3`, etc. | Yellow | Poor rolls |

### 11.3 Luck Rating Levels

| Rating | Deviation Range | Color | Description |
|--------|-----------------|-------|-------------|
| VERY LUCKY | +10% or higher | Bright Green | Significantly above expected |
| LUCKY | +5% to +10% | Green | Above expected |
| NORMAL | -5% to +5% | White | Within expected range |
| UNLUCKY | -10% to -5% | Yellow | Below expected |
| VERY UNLUCKY | -10% or lower | Red | Significantly below expected |

### 11.4 Streak Display Examples

| Current Streak | Display | Description |
|----------------|---------|-------------|
| +5 | `Current Streak: +5 (5 above-average in a row)` | Lucky streak |
| -3 | `Current Streak: -3 (3 below-average in a row)` | Unlucky streak |
| 0 | `Current Streak: 0 (no streak)` | No active streak |

### 11.5 Distribution Outlier Indicators

| Condition | Indicator | Example |
|-----------|-----------|---------|
| Count > 150% of expected | `<- Above expected!` | `20 [#########...........]  47 (9.0%) <- Above expected!` |
| Count < 50% of expected | `<- Below expected!` | `8  [##..................]  12 (2.3%) <- Below expected!` |
| Within expected range | (none) | `10 [#####...............]  26 (5.0%)` |

---

## 12. Logging Specifications

### 12.1 Log Levels by Component

| Component | Level | Events |
|-----------|-------|--------|
| `DiceHistoryPanel` | Information | Panel rendered, total rolls displayed |
| `DiceHistoryPanel` | Debug | Section rendering details |
| `DiceHistoryPanel` | Warning | Empty roll history |
| `StreakIndicator` | Debug | Streak calculation details |
| `RollDistributionChart` | Debug | Bar rendering calculations |
| `RollDistributionChart` | Information | Outliers detected |
| `DiceRollRenderer` | Debug | Individual roll formatting |
| `DiceHistoryCommandHandler` | Information | Command handled, results summary |
| `DiceHistoryCommandHandler` | Debug | Service call details |

### 12.2 Log Message Examples

```csharp
// DiceHistoryPanel
_logger.LogInformation("Rendered dice history panel with {TotalRolls} total rolls", totalRolls);
_logger.LogDebug("Rendering recent rolls section with {Count} rolls", recentRolls.Count);
_logger.LogWarning("No roll history available to display");

// StreakIndicator
_logger.LogDebug("Current streak calculated: {Streak} ({Direction})",
    streak, streak > 0 ? "lucky" : "unlucky");

// RollDistributionChart
_logger.LogInformation("Detected {Count} outliers in roll distribution", outlierCount);
_logger.LogDebug("Rendering bar for roll {Value}: {Count}/{Max} ({Percentage}%)",
    value, count, maxCount, percentage);

// DiceHistoryCommandHandler
_logger.LogInformation("Dice history command executed: {TotalRolls} rolls, avg {Average:F1}",
    totalRolls, average);
```

---

## 13. Unit Testing Requirements

### 13.1 Test Count by Feature

| Feature | Test Count |
|---------|------------|
| DiceHistoryPanel | ~2 |
| StreakIndicator | ~2 |
| RollDistributionChart | ~2 |
| DiceRollRenderer | ~2 |
| **Total** | **~8** |

### 13.2 Test Specifications

#### DiceHistoryPanelTests.cs

```csharp
[TestFixture]
public class DiceHistoryPanelTests
{
    [Test]
    public void RenderHistory_WithValidRolls_DisplaysFormattedRollList();

    [Test]
    public void ShowStatistics_WithValidData_DisplaysAllStatistics();
}
```

#### StreakIndicatorTests.cs

```csharp
[TestFixture]
public class StreakIndicatorTests
{
    [Test]
    public void RenderStreak_PositiveStreak_DisplaysLuckyIndicator();

    [Test]
    public void GetStreakDescription_NegativeStreak_ReturnsUnluckyDescription();
}
```

#### RollDistributionChartTests.cs

```csharp
[TestFixture]
public class RollDistributionChartTests
{
    [Test]
    public void RenderDistribution_WithValidData_DisplaysAllTwentyBars();

    [Test]
    public void HighlightOutliers_AboveExpected_ShowsIndicator();
}
```

#### DiceRollRendererTests.cs

```csharp
[TestFixture]
public class DiceRollRendererTests
{
    [Test]
    public void FormatRoll_NaturalTwenty_IncludesExclamationMark();

    [Test]
    public void FormatRollList_WithCriticals_HighlightsCriticalRolls();
}
```

### 13.3 Test Categories

For each feature, tests cover:
- Happy path (valid input, expected output)
- Edge cases (empty data, single roll, all same values)
- Boundary values (exact thresholds, 0/100 percentages)
- Critical scenarios (natural 20, natural 1, streak boundaries)

---

## 14. Use Cases

### 14.1 UC-001: View Dice History

**Actor:** Player
**Precondition:** Player has made at least one dice roll during gameplay
**Flow:** Player enters "dicehistory" command → System retrieves roll history from service → System renders dice history panel with recent rolls, statistics, luck rating, streaks, and distribution → Player views comprehensive roll history

### 14.2 UC-002: Check Current Luck Status

**Actor:** Player
**Precondition:** Player has roll history
**Flow:** Player views dice history panel → System calculates luck deviation from expected average → System displays luck rating (VERY LUCKY, LUCKY, NORMAL, UNLUCKY, VERY UNLUCKY) → Player understands their current luck trend

### 14.3 UC-003: Analyze Roll Distribution

**Actor:** Player
**Precondition:** Player has sufficient roll history (10+ rolls)
**Flow:** Player views dice history panel → System renders bar chart for all 20 possible roll values → System highlights outliers significantly above or below expected frequency → Player identifies any unusual patterns in their rolls

### 14.4 UC-004: Track Lucky/Unlucky Streaks

**Actor:** Player
**Precondition:** Player has made multiple consecutive rolls
**Flow:** Player views dice history panel → System calculates current streak (consecutive above/below average rolls) → System displays longest historical streaks → Player sees streak information and understands their rolling patterns

### 14.5 UC-005: View Empty History

**Actor:** Player (new game)
**Precondition:** No rolls have been made yet
**Flow:** Player enters "dicehistory" command → System detects empty history → System displays panel with "No roll history available" message → Player understands they need to play to accumulate history

---

## 15. Deliverable Checklist

### 15.1 UI Components

- [ ] `DiceHistoryPanel` component implemented
- [ ] `StreakIndicator` component implemented
- [ ] `RollDistributionChart` component implemented

### 15.2 Renderers

- [ ] `DiceRollRenderer` implemented

### 15.3 DTOs

- [ ] `DiceHistoryDisplayDto` created
- [ ] `DiceStatisticsDto` created
- [ ] `RollDistributionDto` created

### 15.4 Configuration

- [ ] `DiceHistoryPanelConfig` class created
- [ ] `dice-history-panel.schema.json` created
- [ ] `dice-history-panel.json` configuration file created

### 15.5 Commands

- [ ] `DiceHistoryCommand` record created
- [ ] `DiceHistoryCommandHandler` implemented
- [ ] Command parsing added to `ConsoleInputHandler`

### 15.6 Renderer Integration

- [ ] `IGameRenderer.RenderDiceHistoryAsync` method added
- [ ] `SpectreGameRenderer` implementation added

### 15.7 Testing

- [ ] `DiceHistoryPanelTests` implemented (~2 tests)
- [ ] `StreakIndicatorTests` implemented (~2 tests)
- [ ] `RollDistributionChartTests` implemented (~2 tests)
- [ ] `DiceRollRendererTests` implemented (~2 tests)
- [ ] All ~8 unit tests passing

### 15.8 Documentation

- [ ] XML documentation on all public members
- [ ] Configuration schema documented

---

## 16. Acceptance Criteria

### 16.1 Functional

- [ ] Roll history panel displays recent rolls
- [ ] Natural 20s marked with `!` and yellow color
- [ ] Natural 1s marked with `!` and red color
- [ ] Total roll count displays correctly
- [ ] Natural 20/1 percentages calculate correctly
- [ ] Average roll calculates correctly
- [ ] Expected average displays as 10.5 for d20
- [ ] Luck rating displays based on deviation from expected
- [ ] Luck rating color matches rating level
- [ ] Current streak shows positive/negative value
- [ ] Current streak includes descriptive text
- [ ] Longest lucky streak displays correctly
- [ ] Longest unlucky streak displays correctly
- [ ] Roll distribution chart renders all 20 values
- [ ] Distribution bars scale correctly to max count
- [ ] Outliers above expected show indicator arrow
- [ ] Outliers below expected show indicator arrow
- [ ] `dicehistory` command triggers panel display
- [ ] `dice` alias works correctly
- [ ] `rolls` alias works correctly
- [ ] Empty history shows appropriate message

### 16.2 Quality

- [ ] Build succeeds with 0 errors
- [ ] Build succeeds with 0 warnings
- [ ] All ~8 unit tests pass
- [ ] Configuration file validates against schema
- [ ] XML documentation complete on all public members
- [ ] Consistent styling with v0.13.4a-c specifications

---

## 17. Future Considerations

### 17.1 Deferred to v0.14.x or Later

- **Multi-Die Type History**: Track history for d4, d6, d8, d10, d12 separately (beyond d20)
- **Roll Filters**: Filter history by date range, roll type, or context (combat vs skill check)
- **Animated Roll Display**: Show animated dice roll when new roll occurs
- **Export History**: Export roll history to CSV/JSON for external analysis
- **Statistical Tests**: Chi-square test for randomness validation

### 17.2 Out of Scope

- Modifying dice rolling mechanics (Domain layer)
- Adding new statistical calculations to services (Application layer)
- Persisting history across game sessions (handled by Domain/Infrastructure)

---

## 18. Implementation Notes

### 18.1 Service Integration

The `DiceHistoryPanel` relies entirely on `IDiceHistoryService` for all data. No dice calculations are performed in the presentation layer. The service is expected to provide:

- Recent rolls in chronological order
- Pre-calculated statistics (total, nat 20s, nat 1s, average)
- Roll distribution array (20 elements)
- Current streak count (positive for lucky, negative for unlucky)
- Longest streak history

### 18.2 Performance Considerations

- Recent rolls list limited to configurable count (default 20)
- Distribution chart renders fixed 20 bars regardless of total rolls
- No sorting or filtering operations in presentation layer
- All calculations performed by Application layer service

### 18.3 Accessibility Considerations

- Color is supplemented with text indicators (`!` for criticals)
- Streak direction indicated by sign (`+` or `-`) in addition to color
- Luck rating includes percentage value alongside text label
- Distribution outliers use text indicators (`<-`) alongside highlighting

### 18.4 Related Components

| Component | Relationship |
|-----------|--------------|
| `AchievementPanel` (v0.13.4a) | Similar panel structure, header/footer patterns |
| `StatisticsDashboard` (v0.13.4b) | Similar statistics display, comparison patterns |
| `SimpleChart` (v0.13.4b) | Similar bar chart rendering approach |
| `LeaderboardView` (v0.13.4c) | Similar panel layout, consistent styling |

---

## 19. Document Metadata

---

*Document Version: 1.0*
*Last Updated: 2026-01-16*
*Author: Claude*

---
