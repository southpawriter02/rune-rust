# v0.16.4c Changelog — Biome Loot Modifiers

**Version:** 0.16.4c
**Date:** 2026-01-29
**Phase:** Container Loot Generation

---

## Summary

Implements biome-specific loot modifiers that scale gold amounts, item counts, quality tiers, and rare item chances for container loot generation. Provides the `BiomeLootModifiers` value object with application methods and configuration for 5 biome definitions.

---

## Added

### Domain Layer

- **`BiomeLootModifiers`** value object — Immutable `readonly record struct` for biome loot scaling:
    - Properties:
        - `BiomeId` — Unique identifier (kebab-case, normalized to lowercase)
        - `GoldMultiplier` — Scales gold amounts (1.0 = normal)
        - `DropRateMultiplier` — Scales item counts (1.0 = normal)
        - `QualityBonus` — Additive tier bonus (0-4)
        - `RareChanceBonusPercent` — Additive rare chance (0-100%)
    - Static `Default` property for fallback (no modifications)
    - Factory method `Create()` with full validation
    - Application methods:
        - `ApplyToGold(int baseGold)` — Scales and floors gold
        - `ApplyToItemCount(int baseCount, int minCount)` — Scales with minimum floor
        - `ApplyToTier(int baseTier, int maxTier)` — Adds bonus with cap
        - `GetRareChanceBonus()` — Returns decimal fraction
    - Computed properties: `IncreasesGold`, `ReducesDropRate`, `ImprovesQuality`, `IncreasesRareChance`

### Configuration

- **`biome-loot-modifiers.json`** — 5 biome modifier definitions:
  | Biome | Gold | Drop Rate | Quality | Rare |
  |-------|------|-----------|---------|------|
  | the-roots | ×1.0 | ×1.0 | +0 | +0% |
  | muspelheim | ×1.2 | ×0.9 | +0 | +5% |
  | alfheim | ×1.5 | ×0.7 | +1 | +15% |
  | jotunheim | ×2.0 | ×0.8 | +1 | +20% |
  | boss-room | ×1.5 | ×1.0 | +1 | +25% |

- **`biome-loot-modifiers.schema.json`** — JSON Schema validation:
    - Required fields with type constraints
    - BiomeId pattern validation (kebab-case)
    - Multiplier ranges (0.1-10.0)
    - Bonus limits (quality 0-4, rare 0-100)

### Unit Tests

- **`BiomeLootModifiersTests.cs`** — 28 tests covering:
    - `ApplyToGold`: scaling, fractional flooring, zero/negative handling
    - `ApplyToItemCount`: reduced rates, minimum floors, edge cases
    - `ApplyToTier`: bonus shifting, max tier capping, zero bonus
    - `GetRareChanceBonus`: decimal conversion, zero handling
    - `Default`: no-modification behavior, property values, computed flags
    - `ComputedProperties`: active modifier detection
    - `Create` validation: ID normalization, multiplier validation, range checks
    - `ToString`: formatted output verification

---

## Design Decisions

| Decision                  | Rationale                                           |
| ------------------------- | --------------------------------------------------- |
| `readonly record struct`  | Immutability, value equality, memory efficiency     |
| `decimal` for multipliers | Precision for fractional values (1.2, 0.9, etc.)    |
| `int` for bonuses         | Simple additive values, no fractional tiers         |
| Static `Default` property | Reusable fallback for unknown biomes                |
| Normalized biome ID       | Case-insensitive matching via `ToLowerInvariant()`  |
| Floor rounding            | Consistent behavior, prevents fractional items/gold |
| Clamped outputs           | Prevents negative gold, respects quality tier caps  |

---

## Dependencies

| Dependency | Description                             | Status      |
| ---------- | --------------------------------------- | ----------- |
| v0.16.4a   | `ContainerTypeDefinition` (base values) | ✅ Complete |
| v0.16.0    | `QualityTier` enum (tier 0-4 scale)     | ✅ Complete |

---

## Provides To

| Consumer | Description                                                           |
| -------- | --------------------------------------------------------------------- |
| v0.16.4d | `ContainerLootService` applies biome modifiers during loot generation |

---

## Verification

- **Build:** 0 errors, 0 warnings
- **Unit Tests:** 28/28 passed
- **Test Coverage:** All methods, validation, edge cases, computed properties
