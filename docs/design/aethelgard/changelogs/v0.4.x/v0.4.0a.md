# Changelog: v0.4.0a - The Legend (Saga Backend)
**Release Date:** 2025-12-27

---

## Summary

Version 0.4.0a implements the **Saga System** backend, providing robust character progression mechanics through Legend (experience) accumulation, automatic level-up detection with recursive multi-level jump handling, and Progression Point awards. This release touches the **Core Layer** (entities, interfaces, events), **Engine Layer** (service implementation), **Persistence Layer** (EF Core mappings), and **Test Layer** (comprehensive unit and integration testing). Key architectural patterns include the **Service-Repository Pattern** via `ISagaService`, **Event-Driven Architecture** via `LevelUpEvent` published through `IEventBus`, and strict **Dependency Injection** registration in `Program.cs`. The system enforces a 10-level progression curve with cumulative Legend thresholds ranging from 100 (Level 2) to 4500 (Level 10), awarding a total of 22 Progression Points across all level milestones.

---

## New Files Created

### Core Layer

| File | Purpose |
|------|---------|
| `RuneAndRust.Core/Interfaces/ISagaService.cs` | Defines the service contract for character progression management with methods `AddLegend()`, `GetLegendForNextLevel()`, and `GetPpAward()` |
| `RuneAndRust.Core/Events/LevelUpEvent.cs` | Immutable record event published via IEventBus when characters level up, containing CharacterId, CharacterName, NewLevel, and ProgressionPointsAwarded |

### Engine Layer

| File | Purpose |
|------|---------|
| `RuneAndRust.Engine/Services/SagaService.cs` | Implements ISagaService with Legend accumulation logic, recursive milestone checking, full heal on level-up, and event publishing |

### Test Layer

| File | Purpose |
|------|---------|
| `RuneAndRust.Tests/Engine/SagaServiceTests.cs` | Comprehensive unit tests for SagaService covering 35 test cases across 9 categories (basic accumulation, level-up, PP awards, multi-level jumps, HP/Stamina restoration, event publishing, max level, query methods) |

---

## Files Modified

| File | Change |
|------|--------|
| `RuneAndRust.Core/Entities/Character.cs` (lines 133-151) | Renamed property `ExperiencePoints` to `Legend`, added `ProgressionPoints` property (int, default 0), updated Level max from 5 to 10, added XML documentation referencing v0.4.0a/v0.4.0b |
| `RuneAndRust.Terminal/Program.cs` (line 107) | Registered `ISagaService` as Scoped dependency in DI container: `services.AddScoped<ISagaService, SagaService>();` |
| `RuneAndRust.Persistence/Data/RuneAndRustDbContext.cs` (lines 228-230) | Updated EF Core property mapping from `ExperiencePoints` to `Legend`, added mapping for `ProgressionPoints` with `IsRequired()` constraint |
| `RuneAndRust.Tests/Integration/CharacterPersistenceTests.cs` (lines 164, 174, 436) | Updated test assertions to reference `Legend` property instead of `ExperiencePoints` in persistence validation tests |
| `RuneAndRust.Tests/Core/CharacterEntityTests.cs` (lines 96-97) | Updated default value test to assert `Legend` is 0 and added assertion for `ProgressionPoints` default value |
| `RuneAndRust.Tests/Core/Serialization/GameStateContextTests.cs` (line 75) | Updated test data initialization to use `Legend` property instead of `ExperiencePoints` |

---

## Code Implementation Details

### ISagaService Interface

```csharp
public interface ISagaService
{
    /// <summary>
    /// Adds Legend (XP) to the character and checks for level-up.
    /// If the character's Legend crosses a milestone threshold, they will level up
    /// and receive Progression Points. Multiple level-ups can occur in a single call.
    /// </summary>
    void AddLegend(Character character, int amount, string reason);

    /// <summary>
    /// Gets the Legend required to reach the next level.
    /// </summary>
    /// <returns>The total cumulative Legend needed to reach the next level, or -1 if at max level.</returns>
    int GetLegendForNextLevel(int currentLevel);

    /// <summary>
    /// Gets the Progression Points awarded for reaching a specific level.
    /// </summary>
    /// <returns>The PP awarded for reaching that level, or 0 if invalid.</returns>
    int GetPpAward(int level);
}
```

**Purpose:** Service contract for character progression management, enabling experience accumulation and milestone query operations.

---

### LevelUpEvent Record

```csharp
public record LevelUpEvent(
    Guid CharacterId,
    string CharacterName,
    int NewLevel,
    int ProgressionPointsAwarded);
```

**Purpose:** Immutable event published to IEventBus when a character levels up, consumed by UI listeners for notifications.

**Properties:**
- `CharacterId` (Guid): Unique identifier of the leveling character
- `CharacterName` (string): Display name for notification messages
- `NewLevel` (int): The level achieved after progression
- `ProgressionPointsAwarded` (int): PP awarded for reaching the new level

---

### SagaService Implementation

**Dependencies:**
- `IEventBus` - Event publishing infrastructure
- `IStatCalculationService` - Recalculates MaxHP/MaxStamina after level-up
- `ILogger<SagaService>` - Serilog structured logging

**Constants:**
- `MaxLevel = 10` - Hard cap for character progression

**Milestone Table:**

| Level | Required Legend (Cumulative) | PP Award | Notes |
|-------|------------------------------|----------|-------|
| 1 | 0 | 0 | Starting level |
| 2 | 100 | 1 | First milestone |
| 3 | 300 | 1 | Early game |
| 4 | 600 | 2 | Mid-game transition |
| 5 | 1000 | 2 | Mid-game |
| 6 | 1500 | 2 | Mid-game |
| 7 | 2100 | 3 | Late-game transition |
| 8 | 2800 | 3 | Late-game |
| 9 | 3600 | 3 | Near max |
| 10 | 4500 | 5 | Max level (final reward) |

**Total Earnable Progression Points:** 22

**Key Method Signatures:**

```csharp
public void AddLegend(Character character, int amount, string reason)
```

**Behavior:**
- Validates amount is positive (logs warning and returns early if not)
- Increments `character.Legend` by amount
- Logs Legend gain with old/new totals and reason
- Calls `CheckMilestones()` for recursive level-up detection
- Does NOT throw exceptions on invalid input (fail-safe design)

```csharp
private void CheckMilestones(Character character)
```

**Behavior:**
- Recursively checks if character has enough Legend for next level
- Terminates early if character is already at MaxLevel (10)
- Calls `PerformLevelUp()` when threshold is met
- Recursively calls itself to handle multi-level jumps (e.g., gaining 1000 Legend at Level 1 levels up to Level 5)
- Logs warning if milestone data is missing for a level

```csharp
private void PerformLevelUp(Character character, int newLevel, int ppAward)
```

**Behavior:**
- Increments `character.Level` to `newLevel`
- Adds `ppAward` to `character.ProgressionPoints`
- Calls `IStatCalculationService.RecalculateDerivedStats()` to update MaxHP/MaxStamina based on new level
- Performs full heal: Sets `CurrentHP = MaxHP` and `CurrentStamina = MaxStamina`
- Publishes `LevelUpEvent` to IEventBus for UI notification
- Logs level-up with PP award and restoration confirmation

```csharp
public int GetLegendForNextLevel(int currentLevel)
```

**Behavior:**
- Returns cumulative Legend required for `currentLevel + 1`
- Returns -1 if already at max level (sentinel value for UI to detect cap)

```csharp
public int GetPpAward(int level)
```

**Behavior:**
- Returns PP awarded for reaching specified level
- Returns 0 for invalid levels (0, 11+)

---

### Character Entity Changes

**Property Rename:**
```csharp
// OLD:
public int ExperiencePoints { get; set; } = 0;

// NEW:
/// <summary>
/// Total accumulated Legend (Experience).
/// Used to calculate Level and Milestones.
/// </summary>
/// <remarks>See: v0.4.0a (The Legend) for Saga system design.</remarks>
public int Legend { get; set; } = 0;
```

**New Property:**
```csharp
/// <summary>
/// Currency earned via Leveling, used to purchase Attribute upgrades.
/// </summary>
/// <remarks>See: v0.4.0b (The Growth) for spending logic.</remarks>
public int ProgressionPoints { get; set; } = 0;
```

**Level Cap Update:**
```csharp
// OLD: Max level was 5
// NEW: Max level is 10 (enforced in SagaService.MaxLevel constant)
public int Level { get; set; } = 1;
```

---

## Logging Matrix

### SagaService Logging

| Event | Level | Template |
|-------|-------|----------|
| AddLegend Entry | Trace | `[Saga] AddLegend called for {Name} with amount {Amount}, reason: {Reason}` |
| Invalid Amount | Warning | `[Saga] AddLegend called with non-positive amount: {Amount}` |
| Legend Gain | Information | `[Saga] {Name} gained {Amount} Legend ({Reason}). Total: {OldLegend} -> {NewLegend}` |
| Max Level Check | Trace | `[Saga] {Name} is already at max level ({MaxLevel})` |
| Missing Milestone Data | Warning | `[Saga] No milestone data found for level {Level}` |
| Level Up | Information | `[Saga] {Name} LEVELED UP to {Level}! Awarded {PP} PP. HP/Stamina restored.` |
| LevelUpEvent Published | Debug | `[Saga] LevelUpEvent published for {Name}: Level {OldLevel} -> {NewLevel}` |

**Structured Logging Properties:**
- `{Name}` - Character.Name
- `{Amount}` - Legend amount added
- `{Reason}` - Context string (e.g., "Defeated Draugr", "Quest completion")
- `{OldLegend}` / `{NewLegend}` - Before/after Legend totals
- `{Level}` / `{NewLevel}` / `{OldLevel}` - Level values
- `{PP}` - Progression Points awarded
- `{MaxLevel}` - Constant value (10)

---

## Test Coverage

### Summary

```
Total: 35 | Passed: 35 | Failed: 0 | Duration: 49ms
```

### Complete Test Inventory

#### SagaServiceTests (35 tests)

**Basic Accumulation (3 tests)**

| Test Name | Description |
|-----------|-------------|
| `AddLegend_PositiveAmount_IncreasesTotal` | Verifies that adding positive Legend increases character's total |
| `AddLegend_MultipleAdds_AccumulatesCorrectly` | Validates that sequential AddLegend calls accumulate correctly |
| `AddLegend_ZeroOrNegativeAmount_NoChange` (3 variations: 0, -10, -100) | Ensures zero/negative amounts are rejected without changing Legend |

**Level Up Detection (3 tests)**

| Test Name | Description |
|-----------|-------------|
| `AddLegend_ReachesThreshold_TriggersLevelUp` | Confirms that reaching exactly 100 Legend triggers Level 2 |
| `AddLegend_ExceedsThreshold_TriggersLevelUp` | Verifies level-up when exceeding threshold (150 Legend reaches Level 2) |
| `AddLegend_BelowThreshold_NoLevelUp` | Ensures no level-up occurs when below threshold (50 Legend stays Level 1) |

**Progression Points (2 tests)**

| Test Name | Description |
|-----------|-------------|
| `AddLegend_AwardsPP_OnLevelUp` | Validates that 1 PP is awarded when reaching Level 2 |
| `AddLegend_AwardsCorrectPP_ForHigherLevels` | Confirms 2 PP awarded for Level 4 (cumulative 4 total when starting with 2) |

**Multi-Level Jumps (2 tests)**

| Test Name | Description |
|-----------|-------------|
| `AddLegend_MultiLevelJump_HandlesRecursively` | Tests gaining 700 Legend at Level 1 correctly levels to Level 4 |
| `AddLegend_MultiLevelJump_AccumulatesAllPP` | Validates gaining 1000 Legend at Level 1 reaches Level 5 with 6 total PP |

**HP/Stamina Restoration (2 tests)**

| Test Name | Description |
|-----------|-------------|
| `AddLegend_RestoresHpStamina_OnLevelUp` | Confirms full heal (CurrentHP/Stamina set to Max) on level-up |
| `AddLegend_CallsRecalculateDerivedStats_OnLevelUp` | Verifies IStatCalculationService.RecalculateDerivedStats() is called once |

**Event Publishing (3 tests)**

| Test Name | Description |
|-----------|-------------|
| `AddLegend_PublishesLevelUpEvent` | Validates LevelUpEvent is published with correct properties (CharacterId, Name, NewLevel=2, PP=1) |
| `AddLegend_MultiLevelJump_PublishesMultipleEvents` | Confirms 3 events published when jumping from Level 1 to Level 4 |
| `AddLegend_NoLevelUp_DoesNotPublishEvent` | Ensures no event is published when Legend gain doesn't trigger level-up |

**Max Level Behavior (2 tests)**

| Test Name | Description |
|-----------|-------------|
| `AddLegend_AtMaxLevel_NoFurtherLevelUp` | Verifies Level stays at 10 when adding Legend at max level (Legend still accumulates) |
| `AddLegend_AtMaxLevel_DoesNotPublishEvent` | Confirms no LevelUpEvent is published when already at max level |

**GetLegendForNextLevel Query (7 tests)**

| Test Name | Description |
|-----------|-------------|
| `GetLegendForNextLevel_ReturnsCorrectThreshold` (6 variations: L1→100, L2→300, L3→600, L4→1000, L5→1500, L9→4500) | Validates correct cumulative Legend thresholds for each level transition |
| `GetLegendForNextLevel_AtMaxLevel_ReturnsNegativeOne` | Confirms -1 sentinel value returned when querying from Level 10 |

**GetPpAward Query (9 tests)**

| Test Name | Description |
|-----------|-------------|
| `GetPpAward_ReturnsCorrectAmount` (6 variations: L1=0, L2=1, L3=1, L4=2, L7=3, L10=5) | Validates correct PP awards for milestone levels |
| `GetPpAward_InvalidLevel_ReturnsZero` (3 variations: 0, 11, 100) | Ensures 0 is returned for invalid level queries |

---

### Related Test Suites (Modified)

**CharacterEntityTests: 29 tests, all passed, 26ms**
- Updated `Character_NewInstance_HasDefaultProgressionValues` to assert `Legend` and `ProgressionPoints` default values

**CharacterPersistenceTests: 21 tests, all passed, 558ms**
- Updated `AddAsync_ValidCharacterWithLevel_PersistsProgressionData` to use `Legend` property
- Updated `Default_MigrationApplied_CreatesCharactersTable` to assert `Legend` instead of `ExperiencePoints`

**GameStateContextTests: 7 tests, all passed, 86ms**
- Updated `SerializeDeserialize_ComplexGameState_PreservesAllData` to initialize `Legend` instead of `ExperiencePoints`

---

## DI Registration

**File:** `RuneAndRust.Terminal/Program.cs`

```csharp
// Register Engine Services
services.AddSingleton<CommandParser>();
services.AddSingleton<IGameService, GameService>();
services.AddSingleton<IDiceService, DiceService>();
services.AddSingleton<IStatCalculationService, StatCalculationService>();
services.AddScoped<ISagaService, SagaService>();  // [NEW] - Scoped lifetime
services.AddScoped<SaveManager>();
```

**Lifetime Justification:**
- `ISagaService` registered as **Scoped** because it operates on per-character state within a game session context and publishes events that may be tied to specific request/operation scopes. This aligns with the scoped nature of `SaveManager` and ensures clean state management across character operations.

---

## Verification Results

### Build Output

```
Build succeeded.
    1 Warning(s)
    0 Error(s)

Time Elapsed 00:00:01.14
```

**Warning:** MSB3277 - EntityFrameworkCore.Relational version conflict (9.0.1 vs 9.0.4). This is a non-blocking dependency resolution warning that does not affect functionality.

### Test Execution

```bash
# SagaServiceTests
dotnet test --filter "FullyQualifiedName~SagaServiceTests"
Passed!  - Failed: 0, Passed: 35, Skipped: 0, Total: 35, Duration: 49ms

# CharacterEntityTests
dotnet test --filter "FullyQualifiedName~CharacterEntityTests"
Passed!  - Failed: 0, Passed: 29, Skipped: 0, Total: 29, Duration: 26ms

# CharacterPersistenceTests
dotnet test --filter "FullyQualifiedName~CharacterPersistenceTests"
Passed!  - Failed: 0, Passed: 21, Skipped: 0, Total: 21, Duration: 558ms

# GameStateContextTests
dotnet test --filter "FullyQualifiedName~GameStateContextTests"
Passed!  - Failed: 0, Passed: 7, Skipped: 0, Total: 7, Duration: 86ms
```

**Combined Test Results:**
- **Total Tests:** 92
- **Passed:** 92
- **Failed:** 0
- **Skipped:** 0
- **Total Duration:** 719ms

---

## Directory Structure After Release

```
RuneAndRust.Core/
├── Entities/
│   └── Character.cs [MODIFIED - Renamed ExperiencePoints→Legend, added ProgressionPoints]
├── Events/
│   └── LevelUpEvent.cs [NEW]
└── Interfaces/
    └── ISagaService.cs [NEW]

RuneAndRust.Engine/
└── Services/
    └── SagaService.cs [NEW]

RuneAndRust.Persistence/
└── Data/
    └── RuneAndRustDbContext.cs [MODIFIED - EF mappings updated]

RuneAndRust.Terminal/
└── Program.cs [MODIFIED - DI registration]

RuneAndRust.Tests/
├── Core/
│   ├── CharacterEntityTests.cs [MODIFIED - Property assertions updated]
│   └── Serialization/
│       └── GameStateContextTests.cs [MODIFIED - Test data updated]
├── Engine/
│   └── SagaServiceTests.cs [NEW - 35 comprehensive tests]
└── Integration/
    └── CharacterPersistenceTests.cs [MODIFIED - Persistence validation updated]
```

---

## Running Tests

### Execute SagaService Test Suite

```bash
dotnet test --filter "FullyQualifiedName~SagaServiceTests"
```

### Execute All Modified Test Suites

```bash
dotnet test --filter "FullyQualifiedName~CharacterEntityTests|FullyQualifiedName~CharacterPersistenceTests|FullyQualifiedName~GameStateContextTests|FullyQualifiedName~SagaServiceTests"
```

### Execute All Tests

```bash
dotnet test
```

---

## Next Steps

### v0.4.0b - The Growth (Saga UI & PP Spending)

- **UI Components:**
  - Implement `CharacterSheetViewModel` with Legend/Level display
  - Create level-up notification overlay (consumes `LevelUpEvent`)
  - Add progress bar for Legend-to-next-level visualization

- **Progression Point Spending:**
  - Implement `IAttributeUpgradeService` for PP-to-Attribute conversion
  - Add attribute upgrade UI panel with cost display
  - Enforce spending rules (e.g., max +10 per attribute, diminishing returns)

- **Data Persistence:**
  - Create database migration for `Legend` and `ProgressionPoints` columns
  - Add migration script `V005__Add_Progression_Columns.sql`
  - Verify data integrity after migration

### v0.4.1 - Combat Integration

- Wire `SagaService.AddLegend()` into combat resolution (award Legend on enemy defeat)
- Implement Legend scaling formulas (base XP × enemy level multiplier)
- Add quest completion hooks for bonus Legend awards

### v0.5.0 - Advanced Progression

- Implement prestige/paragon system for post-Level 10 progression
- Add achievement-based Legend multipliers
- Create milestone rewards (unique abilities unlocked at specific levels)

---

## Technical Notes

### Design Decisions

1. **Cumulative Legend Thresholds:** Legend values in the milestone table are cumulative totals (not per-level deltas). This simplifies level-up detection (single comparison: `character.Legend >= threshold`) and avoids needing to track "remaining XP" separately.

2. **Recursive Multi-Level Jump Handling:** `CheckMilestones()` uses recursion instead of iteration to handle cases where a character gains enough Legend to skip multiple levels. This ensures `LevelUpEvent` is published once per level (critical for UI animations) and PP awards are calculated correctly for each intermediate level.

3. **Full Heal on Level-Up:** Design choice to restore HP/Stamina to max on level-up provides a strategic "second wind" during combat and rewards players for reaching milestones. This is a common RPG pattern that creates positive feedback loops.

4. **Scoped Lifetime for ISagaService:** Unlike singleton services (DiceService, GameService), SagaService is scoped because it may need to be isolated per-operation (e.g., multiple simultaneous character level-ups in multiplayer scenarios or batch processing). This also aligns with SaveManager's scoped lifetime for transactional consistency.

5. **Event-Driven UI Updates:** Publishing `LevelUpEvent` via IEventBus decouples the Engine layer from UI concerns. The Terminal/Avalonia layers can subscribe to these events without SagaService needing direct references to UI components.

### Known Limitations

1. **No Database Migration:** This release updates EF Core mappings but does NOT include a SQL migration script. The `Legend` and `ProgressionPoints` columns must be added to the `Characters` table manually or via a future migration in v0.4.0b.

2. **No UI Integration:** SagaService is fully functional but has no UI components. Players cannot see Legend gain, level-up notifications, or spend Progression Points yet. This is deferred to v0.4.0b.

3. **No Anti-Cheat Validation:** AddLegend() accepts any positive integer without bounds checking. A malicious caller could add `int.MaxValue` Legend. Future versions should add rate limiting or maximum per-operation caps.

4. **Hardcoded Milestone Table:** The milestone curve is defined in a static dictionary within SagaService. Modifying progression curves requires code changes and recompilation. A future enhancement could load this from a JSON configuration file or database table for runtime adjustability.

### Breaking Changes

- **Property Rename:** `Character.ExperiencePoints` renamed to `Character.Legend`. Any external code referencing `ExperiencePoints` will fail to compile. Update all references to use `Legend`.

- **Level Cap Increase:** Maximum character level increased from 5 to 10. Existing characters at Level 5 can now continue progressing. Ensure UI components and balance calculations account for the new cap.

### Migration Path for Existing Data

For developers with existing characters in their database:

```sql
-- Add new columns (run before deploying v0.4.0a)
ALTER TABLE "Characters"
ADD COLUMN "Legend" INTEGER NOT NULL DEFAULT 0,
ADD COLUMN "ProgressionPoints" INTEGER NOT NULL DEFAULT 0;

-- Migrate existing ExperiencePoints to Legend (if column exists)
UPDATE "Characters"
SET "Legend" = "ExperiencePoints"
WHERE "ExperiencePoints" IS NOT NULL;

-- Drop old column (optional - only if no rollback needed)
-- ALTER TABLE "Characters" DROP COLUMN "ExperiencePoints";
```

**Warning:** This migration is destructive. Back up your database before executing.

---

**Changelog prepared by The Chronicle-Smith on 2025-12-27.**
