// ------------------------------------------------------------------------------
// <copyright file="IGlitchExploitationService.cs" company="Rune &amp; Rust">
//     Copyright (c) Rune &amp; Rust. All rights reserved.
// </copyright>
// <summary>
// Service interface for exploiting glitch cycles in [Glitched] Old World technology.
// Part of v0.15.4f Glitch Exploitation System implementation.
// </summary>
// ------------------------------------------------------------------------------

using RuneAndRust.Domain.Enums;
using RuneAndRust.Domain.ValueObjects;

namespace RuneAndRust.Domain.Interfaces;

/// <summary>
/// Service interface for exploiting glitch cycles in [Glitched] Old World technology.
/// </summary>
/// <remarks>
/// <para>
/// Glitched mechanisms cycle through four phases: Stable → Unstable → Permissive → Lockdown.
/// The Glitch Exploitation System allows characters to:
/// <list type="bullet">
///   <item><description>Observe patterns (WITS DC 14) to identify the cycle timing</description></item>
///   <item><description>Exploit the Permissive phase for -4 DC bonus</description></item>
///   <item><description>Proceed blind and roll on the Chaos table (+4, +0, or -2 DC)</description></item>
/// </list>
/// </para>
/// <para>
/// This service integrates with the Jury-Rigging System (v0.15.4e) when the
/// <see cref="BypassMethod.GlitchExploitation"/> method is selected on a [Glitched] mechanism.
/// </para>
/// </remarks>
public interface IGlitchExploitationService
{
    // -------------------------------------------------------------------------
    // Pattern Observation
    // -------------------------------------------------------------------------

    /// <summary>
    /// Attempts to observe and identify the glitch cycle pattern.
    /// </summary>
    /// <param name="witsScore">The character's WITS attribute score.</param>
    /// <param name="mechanismType">The type of mechanism being observed.</param>
    /// <returns>The observation result with glitch state information.</returns>
    /// <remarks>
    /// <para>
    /// Uses WITS check against DC 14.
    /// </para>
    /// <para>
    /// Outcomes:
    /// <list type="bullet">
    ///   <item><description>Success: Pattern identified; character can time actions to exploit window (-4 DC)</description></item>
    ///   <item><description>Failure: Pattern unknown; must roll Chaos table or retry</description></item>
    /// </list>
    /// </para>
    /// <para>
    /// Observation takes 1 round of careful study.
    /// </para>
    /// </remarks>
    /// <exception cref="ArgumentOutOfRangeException">Thrown when witsScore is less than 1.</exception>
    GlitchObservationResult ObserveGlitchPattern(int witsScore, string mechanismType);

    // -------------------------------------------------------------------------
    // Cycle Phase Queries
    // -------------------------------------------------------------------------

    /// <summary>
    /// Gets the current phase of the glitch cycle.
    /// </summary>
    /// <param name="state">The glitch state to query.</param>
    /// <returns>The current glitch cycle phase.</returns>
    /// <remarks>
    /// The phase is known regardless of whether the pattern is identified,
    /// but the character only benefits from this knowledge if they've observed it.
    /// </remarks>
    GlitchCyclePhase GetCurrentCyclePhase(GlitchState state);

    /// <summary>
    /// Determines if the current state is in the exploit window.
    /// </summary>
    /// <param name="state">The glitch state to check.</param>
    /// <returns>True if in the exploit window and pattern is identified; otherwise false.</returns>
    /// <remarks>
    /// <para>
    /// The exploit window is only beneficial if the pattern has been identified.
    /// Returns true only when:
    /// <list type="bullet">
    ///   <item><description>Pattern is identified (GlitchCycleIdentified = true)</description></item>
    ///   <item><description>Current phase matches exploit window (typically Permissive)</description></item>
    /// </list>
    /// </para>
    /// </remarks>
    bool IsInExploitWindow(GlitchState state);

    // -------------------------------------------------------------------------
    // DC Modifier Calculation
    // -------------------------------------------------------------------------

    /// <summary>
    /// Calculates the DC modifier for a glitch exploitation attempt.
    /// </summary>
    /// <param name="state">The current glitch state.</param>
    /// <returns>The DC modifier to apply to the bypass check.</returns>
    /// <remarks>
    /// <para>
    /// DC Modifier calculation:
    /// <list type="bullet">
    ///   <item><description>Pattern identified + in exploit window: -4 DC</description></item>
    ///   <item><description>Pattern identified + outside window: +0 DC</description></item>
    ///   <item><description>Pattern not identified + Chaos 1-2: +4 DC</description></item>
    ///   <item><description>Pattern not identified + Chaos 3-4: +0 DC</description></item>
    ///   <item><description>Pattern not identified + Chaos 5-6: -2 DC</description></item>
    /// </list>
    /// </para>
    /// </remarks>
    int CalculateGlitchModifier(GlitchState state);

    // -------------------------------------------------------------------------
    // Chaos Roll
    // -------------------------------------------------------------------------

    /// <summary>
    /// Rolls on the Chaos table for unidentified patterns.
    /// </summary>
    /// <returns>The chaos roll result with effect and DC modifier.</returns>
    /// <remarks>
    /// <para>
    /// Chaos table (d6):
    /// <list type="bullet">
    ///   <item><description>1-2 (33%): Against - Glitch resists (+4 DC)</description></item>
    ///   <item><description>3-4 (33%): Neutral - No effect (+0 DC)</description></item>
    ///   <item><description>5-6 (33%): Helps - Glitch aids (-2 DC)</description></item>
    /// </list>
    /// </para>
    /// <para>
    /// The chaos roll represents the unpredictable nature of exploiting
    /// glitched technology without understanding its cycle.
    /// </para>
    /// </remarks>
    ChaosResult RollChaos();

    // -------------------------------------------------------------------------
    // Phase Advancement
    // -------------------------------------------------------------------------

    /// <summary>
    /// Advances the glitch state by one round.
    /// </summary>
    /// <param name="state">The current glitch state.</param>
    /// <returns>A new glitch state with advanced round/phase.</returns>
    /// <remarks>
    /// <para>
    /// Each phase lasts a set number of rounds (typically 1d4+1 = 2-5 rounds).
    /// When the round counter reaches the phase duration, the phase automatically
    /// advances to the next in the cycle.
    /// </para>
    /// <para>
    /// Phase order: Stable → Unstable → Permissive → Lockdown → (repeat)
    /// </para>
    /// </remarks>
    GlitchState AdvanceRound(GlitchState state);

    // -------------------------------------------------------------------------
    // State Initialization
    // -------------------------------------------------------------------------

    /// <summary>
    /// Initializes a new glitch state for a mechanism.
    /// </summary>
    /// <param name="mechanismType">The type of mechanism.</param>
    /// <returns>A new unobserved glitch state with random initial phase.</returns>
    /// <remarks>
    /// <para>
    /// The initial phase is randomly determined (d4 to select from 4 phases).
    /// Phase duration is randomly set (1d4+1 rounds = 2-5 rounds).
    /// </para>
    /// <para>
    /// The resulting state is unobserved—the character must call
    /// <see cref="ObserveGlitchPattern"/> to identify the pattern.
    /// </para>
    /// </remarks>
    GlitchState InitializeGlitchState(string mechanismType);
}
