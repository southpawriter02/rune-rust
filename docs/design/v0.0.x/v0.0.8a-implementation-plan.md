# v0.0.8a Implementation Plan: Core Experience System

**Version:** 0.0.8a
**Parent:** v0.0.8 (Experience & Leveling)
**Prerequisites:** v0.0.7 Complete (Equipment System)
**Design Specification:** [v0.0.8a-design-specification.md](v0.0.8a-design-specification.md)
**Status:** Ready for Implementation
**Target Tests:** ~299 -> ~317 (+18 tests)

---

## Table of Contents

1. [Executive Summary](#executive-summary)
2. [Dependencies from Previous Phases](#dependencies-from-previous-phases)
3. [Current System Analysis](#current-system-analysis)
4. [Detailed Implementation](#detailed-implementation)
   - [Domain Layer](#domain-layer)
   - [Application Layer](#application-layer)
   - [Presentation Layer](#presentation-layer)
5. [Flow Diagrams](#flow-diagrams)
6. [Testing Strategy](#testing-strategy)
7. [Logging Strategy](#logging-strategy)
8. [Implementation Checklist](#implementation-checklist)
9. [Acceptance Criteria](#acceptance-criteria)
10. [Risk Assessment](#risk-assessment)
11. [File Summary](#file-summary)

---

## Executive Summary

### Purpose

Implement the foundation for experience tracking: adding XP to the Player entity, XP values to monsters, awarding XP on combat victory, and displaying XP progress. This phase establishes the core experience infrastructure that v0.0.8b (Level-Up Mechanics) and v0.0.8c (Progression Configuration) will build upon.

### Scope

**In Scope:**
- `Experience` property on `Player` entity (default 0)
- `AddExperience(amount)` method on `Player` returning new total
- `ExperienceValue` property on `Monster` entity
- `ExperienceService` for XP calculation and awarding
- `ExperienceGainResult` value object for XP gain events
- `ExperienceGainDto` DTO for rendering
- Update `CombatResult` to include XP gained on monster defeat
- XP display in status output
- XP gain message after combat victory
- Default XP values for existing monsters (Goblin = 25 XP)

**Out of Scope:**
- Level-up detection (v0.0.8b)
- Stat increases on level-up (v0.0.8b)
- Level thresholds/progression curves (v0.0.8b)
- Configurable terminology (v0.0.8c)
- Configurable XP formulas (v0.0.8c)

### Key Decisions

| Decision | Choice | Rationale |
|----------|--------|-----------|
| XP storage | On Player entity | Simple, persists with save |
| XP source | Monster defeat only | Initial scope, quests/exploration in future |
| XP formula | Fixed per monster | Simple, configurable formulas in v0.0.8c |
| Monster XP default | 25 (Goblin) | Reasonable starting value for testing |
| XP display format | "XP: 75/200 (37%)" | Shows progress toward next level |
| Experience service location | Domain Services | Core business logic |

---

## Dependencies from Previous Phases

### Dependencies from v0.0.7 (Equipment System)

| Type | Location | Usage in this phase |
|------|----------|---------------------|
| `Player` | `Domain/Entities/Player.cs` | Extended with Experience property |
| `GameSessionService` | `Application/Services/GameSessionService.cs` | XP awarding after combat |
| `IGameRenderer` | `Application/Interfaces/IGameRenderer.cs` | XP display methods |
| `SpectreGameRenderer` | `Presentation/Adapters/SpectreGameRenderer.cs` | XP rendering |

### Dependencies from v0.0.6 (Enhanced Combat System)

| Type | Location | Usage in this phase |
|------|----------|---------------------|
| `CombatService` | `Domain/Services/CombatService.cs` | Return XP on monster defeat |
| `CombatResult` | `Domain/Services/CombatService.cs` | Extended with ExperienceGained |
| `Monster` | `Domain/Entities/Monster.cs` | Extended with ExperienceValue |

### Dependencies from v0.0.4 (Core Systems)

| Type | Location | Usage in this phase |
|------|----------|---------------------|
| `Player.Level` | `Domain/Entities/Player.cs` | Already exists (used for display) |
| `Stats` | `Domain/ValueObjects/Stats.cs` | Player stats for status display |

### Already Implemented (Existing Infrastructure)

| Feature | Location | Notes |
|---------|----------|-------|
| `Player.Level` property | `Player.cs` | Defaults to 1, has `SetLevel()` method |
| `Player.SetLevel(level)` method | `Player.cs` | Sets player level (used by v0.0.8b) |

---

## Current System Analysis

### Existing Player Entity

**Location:** `src/Core/RuneAndRust.Domain/Entities/Player.cs`

**Relevant Current Properties:**
```
Player
├── Level: int (default 1)
├── SetLevel(level): void
├── Health: int
├── Stats: Stats
├── Inventory: Inventory
├── Equipment: Dictionary<EquipmentSlot, Item>
└── ... (other properties)
```

**Required Changes:**
- Add `Experience` property (int, default 0)
- Add `AddExperience(amount)` method returning new total
- Add `ExperienceToNextLevel` computed property (placeholder for v0.0.8b)

### Existing Monster Entity

**Location:** `src/Core/RuneAndRust.Domain/Entities/Monster.cs`

**Current Properties:**
```
Monster
├── Id: Guid
├── Name: string
├── Description: string
├── Health: int
├── MaxHealth: int
├── Stats: Stats
├── IsDefeated: bool
├── IsAlive: bool
└── Factory: CreateGoblin()
```

**Required Changes:**
- Add `ExperienceValue` property (int)
- Update `CreateGoblin()` factory to include XP value (25)
- Update constructor to accept experienceValue parameter

### Existing CombatService

**Location:** `src/Core/RuneAndRust.Domain/Services/CombatService.cs`

**Current CombatResult:**
```csharp
public record CombatResult(
    int DamageDealt,
    int DamageReceived,
    bool MonsterDefeated,
    bool PlayerDefeated
);
```

**Required Changes:**
- Add `ExperienceGained` property to `CombatResult`
- Update `ResolveCombatRound()` to return XP when monster defeated

### Current Combat Flow

```
Player executes "attack" command
    │
    ├── GameSessionService.HandleAttackCommand()
    │   ├── Get current combat encounter
    │   ├── Resolve target
    │   └── Call CombatService.ResolveCombatRound()
    │
    └── CombatService.ResolveCombatRound(player, monster)
        ├── Player attacks (calculate damage)
        ├── Monster counterattacks (if alive)
        └── Return CombatResult
            ├── DamageDealt
            ├── DamageReceived
            ├── MonsterDefeated
            └── PlayerDefeated
```

**New Combat Flow (with XP):**
```
Player executes "attack" command
    │
    ├── GameSessionService.HandleAttackCommand()
    │   ├── Get current combat encounter
    │   ├── Resolve target
    │   ├── Call CombatService.ResolveCombatRound()
    │   │
    │   └── If monster defeated:
    │       ├── ExperienceService.AwardExperience(player, monster.ExperienceValue)
    │       └── Render XP gain message
    │
    └── CombatService.ResolveCombatRound(player, monster)
        ├── Player attacks (calculate damage)
        ├── Monster counterattacks (if alive)
        └── Return CombatResult
            ├── DamageDealt
            ├── DamageReceived
            ├── MonsterDefeated
            ├── PlayerDefeated
            └── ExperienceGained (NEW - monster's XP if defeated)
```

---

## Detailed Implementation

### Domain Layer

#### 1. Player.cs (MODIFY)

**File:** `src/Core/RuneAndRust.Domain/Entities/Player.cs`

**Changes:**
1. Add `Experience` property
2. Add `AddExperience()` method
3. Add `ExperienceToNextLevel` placeholder property

```csharp
// Add after Level property:

/// <summary>
/// Gets the player's current experience points.
/// </summary>
/// <remarks>
/// Experience is gained by defeating monsters. When enough XP is accumulated,
/// the player levels up (handled by ProgressionService in v0.0.8b).
/// </remarks>
public int Experience { get; private set; } = 0;

/// <summary>
/// Gets the experience points required to reach the next level.
/// </summary>
/// <remarks>
/// This is a placeholder returning a default value. The actual calculation
/// is handled by ProgressionService in v0.0.8b based on configuration.
/// </remarks>
public int ExperienceToNextLevel => GetDefaultXpForLevel(Level + 1);

/// <summary>
/// Gets the player's progress toward the next level as a percentage (0-100).
/// </summary>
/// <remarks>
/// Calculated as: (Experience / ExperienceToNextLevel) * 100, clamped to 0-100.
/// </remarks>
public int ExperienceProgressPercent
{
    get
    {
        if (ExperienceToNextLevel <= 0) return 100;
        var percent = (int)((double)Experience / ExperienceToNextLevel * 100);
        return Math.Clamp(percent, 0, 100);
    }
}

/// <summary>
/// Adds experience points to the player.
/// </summary>
/// <param name="amount">The amount of experience to add.</param>
/// <returns>The new total experience points.</returns>
/// <exception cref="ArgumentOutOfRangeException">Thrown when amount is negative.</exception>
/// <remarks>
/// This method only adds XP. Level-up detection and stat increases are
/// handled by ProgressionService in v0.0.8b.
/// </remarks>
public int AddExperience(int amount)
{
    if (amount < 0)
        throw new ArgumentOutOfRangeException(nameof(amount), "Experience amount cannot be negative.");

    Experience += amount;
    return Experience;
}

/// <summary>
/// Gets the default XP required to reach a specific level.
/// </summary>
/// <param name="level">The level to get XP for.</param>
/// <returns>The cumulative XP required.</returns>
/// <remarks>
/// Default formula: level * 100 (Level 2 = 200 XP, Level 3 = 300 XP, etc.)
/// This will be replaced with configurable curves in v0.0.8c.
/// </remarks>
private static int GetDefaultXpForLevel(int level)
{
    if (level <= 1) return 0;
    return level * 100;
}

// Update constructors to initialize Experience = 0 (already default)
```

#### 2. Monster.cs (MODIFY)

**File:** `src/Core/RuneAndRust.Domain/Entities/Monster.cs`

**Changes:**
1. Add `ExperienceValue` property
2. Update constructor to accept XP value
3. Update `CreateGoblin()` factory

```csharp
// Add after Stats property:

/// <summary>
/// Gets the experience points awarded when this monster is defeated.
/// </summary>
/// <remarks>
/// This value is added to the player's experience upon defeating the monster.
/// Higher-level or more difficult monsters award more experience.
/// </remarks>
public int ExperienceValue { get; private set; }

// Update constructor:
/// <summary>
/// Creates a new monster with the specified properties.
/// </summary>
/// <param name="name">The display name of the monster.</param>
/// <param name="description">The description shown to players.</param>
/// <param name="maxHealth">The maximum health points of the monster.</param>
/// <param name="stats">The combat statistics for the monster.</param>
/// <param name="experienceValue">The XP awarded when defeated (default 0).</param>
/// <exception cref="ArgumentNullException">Thrown when name or description is null.</exception>
/// <exception cref="ArgumentOutOfRangeException">Thrown when maxHealth is not positive.</exception>
public Monster(string name, string description, int maxHealth, Stats stats, int experienceValue = 0)
{
    Id = Guid.NewGuid();
    Name = name ?? throw new ArgumentNullException(nameof(name));
    Description = description ?? throw new ArgumentNullException(nameof(description));
    MaxHealth = maxHealth > 0 ? maxHealth : throw new ArgumentOutOfRangeException(nameof(maxHealth));
    Health = maxHealth;
    Stats = stats;
    ExperienceValue = Math.Max(0, experienceValue);
}

// Update CreateGoblin factory:
/// <summary>
/// Factory method to create a basic goblin enemy.
/// </summary>
/// <returns>A new goblin monster with 25 XP value.</returns>
public static Monster CreateGoblin() => new(
    "Goblin",
    "A small, green creature with sharp teeth and beady eyes. It looks hostile.",
    30,
    new Stats(30, 8, 2),
    experienceValue: 25  // NEW
);
```

#### 3. CombatResult (MODIFY)

**File:** `src/Core/RuneAndRust.Domain/Services/CombatService.cs`

**Changes:** Add `ExperienceGained` property to the record.

```csharp
/// <summary>
/// Represents the outcome of a single round of combat.
/// </summary>
/// <param name="DamageDealt">The amount of damage the player dealt to the monster.</param>
/// <param name="DamageReceived">The amount of damage the player received from the monster.</param>
/// <param name="MonsterDefeated">True if the monster was defeated this round.</param>
/// <param name="PlayerDefeated">True if the player was defeated this round.</param>
/// <param name="ExperienceGained">The XP gained from defeating the monster (0 if not defeated).</param>
public record CombatResult(
    int DamageDealt,
    int DamageReceived,
    bool MonsterDefeated,
    bool PlayerDefeated,
    int ExperienceGained = 0  // NEW
);
```

#### 4. CombatService.ResolveCombatRound (MODIFY)

**File:** `src/Core/RuneAndRust.Domain/Services/CombatService.cs`

**Changes:** Return XP when monster is defeated.

```csharp
// Update the result creation in ResolveCombatRound:
var result = new CombatResult(
    DamageDealt: actualPlayerDamage,
    DamageReceived: actualMonsterDamage,
    MonsterDefeated: monster.IsDefeated,
    PlayerDefeated: player.IsDead,
    ExperienceGained: monster.IsDefeated ? monster.ExperienceValue : 0  // NEW
);
```

#### 5. ExperienceGainResult.cs (NEW)

**File:** `src/Core/RuneAndRust.Domain/ValueObjects/ExperienceGainResult.cs`

```csharp
namespace RuneAndRust.Domain.ValueObjects;

/// <summary>
/// Represents the result of gaining experience points.
/// </summary>
/// <remarks>
/// <para>Contains information about the XP gained and the player's new totals.
/// Level-up information will be added in v0.0.8b.</para>
/// </remarks>
/// <param name="AmountGained">The amount of XP gained.</param>
/// <param name="NewTotal">The player's new total XP.</param>
/// <param name="PreviousTotal">The player's XP before this gain.</param>
/// <param name="Source">Description of the XP source (e.g., monster name).</param>
public readonly record struct ExperienceGainResult(
    int AmountGained,
    int NewTotal,
    int PreviousTotal,
    string Source)
{
    /// <summary>
    /// Creates an experience gain result from defeating a monster.
    /// </summary>
    /// <param name="monsterName">The name of the defeated monster.</param>
    /// <param name="xpValue">The XP value of the monster.</param>
    /// <param name="previousTotal">The player's XP before the gain.</param>
    /// <param name="newTotal">The player's XP after the gain.</param>
    /// <returns>An ExperienceGainResult for the monster defeat.</returns>
    public static ExperienceGainResult FromMonsterDefeat(
        string monsterName,
        int xpValue,
        int previousTotal,
        int newTotal) =>
        new(xpValue, newTotal, previousTotal, $"Defeated {monsterName}");

    /// <summary>
    /// Creates a result indicating no experience was gained.
    /// </summary>
    /// <param name="currentTotal">The player's current XP total.</param>
    /// <returns>An ExperienceGainResult with zero gain.</returns>
    public static ExperienceGainResult None(int currentTotal) =>
        new(0, currentTotal, currentTotal, string.Empty);

    /// <summary>
    /// Whether any experience was actually gained.
    /// </summary>
    public bool DidGainExperience => AmountGained > 0;
}
```

#### 6. ExperienceService.cs (NEW)

**File:** `src/Core/RuneAndRust.Domain/Services/ExperienceService.cs`

```csharp
using Microsoft.Extensions.Logging;
using RuneAndRust.Domain.Entities;
using RuneAndRust.Domain.ValueObjects;

namespace RuneAndRust.Domain.Services;

/// <summary>
/// Service for managing experience point operations.
/// </summary>
/// <remarks>
/// <para>Handles the logic for awarding experience points to players.
/// Level-up detection and stat increases are handled by ProgressionService in v0.0.8b.</para>
/// <para>Key responsibilities:</para>
/// <list type="bullet">
/// <item>Award XP from monster defeats</item>
/// <item>Track XP gains for logging/display</item>
/// <item>Validate XP amounts</item>
/// </list>
/// </remarks>
public class ExperienceService
{
    private readonly ILogger<ExperienceService> _logger;

    /// <summary>
    /// Creates a new ExperienceService instance.
    /// </summary>
    /// <param name="logger">The logger for experience operations.</param>
    public ExperienceService(ILogger<ExperienceService> logger)
    {
        _logger = logger;
    }

    /// <summary>
    /// Awards experience points to a player from defeating a monster.
    /// </summary>
    /// <param name="player">The player receiving experience.</param>
    /// <param name="monster">The defeated monster.</param>
    /// <returns>The result of the experience gain.</returns>
    public ExperienceGainResult AwardExperienceFromMonster(Player player, Monster monster)
    {
        ArgumentNullException.ThrowIfNull(player);
        ArgumentNullException.ThrowIfNull(monster);

        if (!monster.IsDefeated)
        {
            _logger.LogWarning("Attempted to award XP from non-defeated monster {MonsterName}",
                monster.Name);
            return ExperienceGainResult.None(player.Experience);
        }

        return AwardExperience(player, monster.ExperienceValue, $"Defeated {monster.Name}");
    }

    /// <summary>
    /// Awards a specific amount of experience points to a player.
    /// </summary>
    /// <param name="player">The player to award XP to.</param>
    /// <param name="amount">The amount of XP to award.</param>
    /// <param name="source">A description of where the XP came from.</param>
    /// <returns>The result of the XP award operation.</returns>
    /// <exception cref="ArgumentNullException">Thrown when player is null.</exception>
    /// <remarks>
    /// For zero or negative amounts, returns ExperienceGainResult.None.
    /// </remarks>
    public ExperienceGainResult AwardExperience(Player player, int amount, string source)
    {
        ArgumentNullException.ThrowIfNull(player);

        if (amount <= 0)
        {
            _logger.LogDebug("No XP to award (amount: {Amount})", amount);
            return ExperienceGainResult.None(player.Experience);
        }

        var previousXp = player.Experience;
        var newTotal = player.AddExperience(amount);

        _logger.LogInformation(
            "Player {PlayerName} gained {Amount} XP from {Source} (Total: {PreviousXp} -> {NewTotal})",
            player.Name, amount, source, previousXp, newTotal);

        return new ExperienceGainResult(amount, newTotal, previousXp, source);
    }

    /// <summary>
    /// Gets the experience value for a monster type (placeholder for future config).
    /// </summary>
    /// <param name="monsterName">The name of the monster.</param>
    /// <returns>The XP value for that monster type.</returns>
    /// <remarks>
    /// This is a simple lookup. Configurable XP values will be added in v0.0.8c.
    /// </remarks>
    public static int GetDefaultMonsterXp(string monsterName)
    {
        return monsterName.ToLowerInvariant() switch
        {
            "goblin" => 25,
            _ => 10 // Default for unknown monsters
        };
    }
}
```

---

### Application Layer

#### 1. ExperienceGainDto.cs (NEW)

**File:** `src/Core/RuneAndRust.Application/DTOs/ExperienceGainDto.cs`

```csharp
using RuneAndRust.Domain.ValueObjects;

namespace RuneAndRust.Application.DTOs;

/// <summary>
/// DTO for displaying experience gain information.
/// </summary>
/// <param name="AmountGained">The XP amount gained.</param>
/// <param name="NewTotal">The player's new total XP.</param>
/// <param name="Source">Description of the XP source.</param>
/// <param name="CurrentLevel">The player's current level.</param>
/// <param name="ExperienceToNextLevel">XP needed for next level.</param>
/// <param name="ProgressPercent">Progress toward next level (0-100).</param>
public record ExperienceGainDto(
    int AmountGained,
    int NewTotal,
    string Source,
    int CurrentLevel,
    int ExperienceToNextLevel,
    int ProgressPercent)
{
    /// <summary>
    /// Creates a DTO from an ExperienceGainResult and player state.
    /// </summary>
    /// <param name="result">The experience gain result.</param>
    /// <param name="currentLevel">The player's current level.</param>
    /// <param name="xpToNextLevel">XP needed for next level.</param>
    /// <param name="progressPercent">Progress percentage.</param>
    /// <returns>A DTO for rendering.</returns>
    public static ExperienceGainDto FromResult(
        ExperienceGainResult result,
        int currentLevel,
        int xpToNextLevel,
        int progressPercent) =>
        new(
            result.AmountGained,
            result.NewTotal,
            result.Source,
            currentLevel,
            xpToNextLevel,
            progressPercent);
}
```

#### 2. PlayerStatusDto.cs (MODIFY or extend)

If a `PlayerStatusDto` exists, add XP fields. Otherwise, ensure status display includes XP.

```csharp
// Add to existing PlayerStatusDto or create if needed:

/// <summary>
/// Current experience points.
/// </summary>
public int Experience { get; init; }

/// <summary>
/// XP required for next level.
/// </summary>
public int ExperienceToNextLevel { get; init; }

/// <summary>
/// Progress percentage toward next level.
/// </summary>
public int ExperienceProgressPercent { get; init; }

/// <summary>
/// Formatted XP string (e.g., "75/100 (75%)").
/// </summary>
public string ExperienceDisplay => $"{Experience}/{ExperienceToNextLevel} ({ExperienceProgressPercent}%)";
```

#### 3. GameSessionService.cs (MODIFY)

**File:** `src/Core/RuneAndRust.Application/Services/GameSessionService.cs`

**Changes:** Award XP after monster defeat, display XP gain message.

```csharp
// Add ExperienceService dependency:
private readonly ExperienceService _experienceService;

// Update constructor:
public GameSessionService(
    // ... existing dependencies ...
    ExperienceService experienceService)
{
    // ... existing initialization ...
    _experienceService = experienceService;
}

// Modify attack handling to award XP on monster defeat:
// In HandleAttackCommand or combat resolution:

private async Task HandleCombatResult(CombatResult result, Monster monster, CancellationToken ct)
{
    // ... existing combat result handling ...

    // Award XP if monster was defeated
    if (result.MonsterDefeated && result.ExperienceGained > 0)
    {
        var xpResult = _experienceService.AwardExperienceFromMonster(_session!.Player, monster);

        if (xpResult.DidGainExperience)
        {
            var xpDto = ExperienceGainDto.FromResult(
                xpResult,
                _session.Player.Level,
                _session.Player.ExperienceToNextLevel,
                _session.Player.ExperienceProgressPercent);

            await _renderer.RenderExperienceGainAsync(xpDto, ct);
        }
    }
}
```

---

### Presentation Layer

#### 1. IGameRenderer.cs (MODIFY)

**File:** `src/Core/RuneAndRust.Application/Interfaces/IGameRenderer.cs`

**Changes:** Add XP display methods.

```csharp
/// <summary>
/// Renders experience gain after combat.
/// </summary>
/// <param name="experienceGain">The XP gain information.</param>
/// <param name="ct">Cancellation token.</param>
Task RenderExperienceGainAsync(ExperienceGainDto experienceGain, CancellationToken ct = default);
```

#### 2. SpectreGameRenderer.cs (MODIFY)

**File:** `src/Presentation/RuneAndRust.Presentation.Tui/Adapters/SpectreGameRenderer.cs`

**Changes:** Implement XP rendering, update status display.

```csharp
/// <inheritdoc />
public Task RenderExperienceGainAsync(ExperienceGainDto experienceGain, CancellationToken ct = default)
{
    AnsiConsole.WriteLine();
    AnsiConsole.MarkupLine($"[yellow]★[/] You gained [green]{experienceGain.AmountGained} XP[/]!");
    AnsiConsole.MarkupLine(
        $"[dim]XP: {experienceGain.NewTotal}/{experienceGain.ExperienceToNextLevel} ({experienceGain.ProgressPercent}%)[/]");
    AnsiConsole.WriteLine();

    return Task.CompletedTask;
}

// Update RenderPlayerStatusAsync or equivalent to include XP:
// Add XP line to status display:

// In status rendering:
AnsiConsole.MarkupLine($"XP: [cyan]{player.Experience}[/]/[cyan]{player.ExperienceToNextLevel}[/] " +
    $"([cyan]{player.ExperienceProgressPercent}%[/])");
```

#### 3. Status Display Update

Ensure the status command displays XP information:

```
> status

=== Hero (Level 1 Warrior) ===
HP: 100/100
XP: 75/200 (37%)
Attack: 15  Defense: 8
```

#### 4. Combat Victory Display

After defeating a monster:

```
> attack goblin

You attack the Goblin for 12 damage!
The Goblin has been defeated!

★ You gained 25 XP!
XP: 25/200 (12%)
```

---

## Flow Diagrams

### XP Award Flow

```
Monster Defeated in Combat
    │
    ├─► 1. COMBAT RESULT
    │   ├── CombatResult.MonsterDefeated = true
    │   └── CombatResult.ExperienceGained = monster.ExperienceValue
    │
    ├─► 2. EXPERIENCE SERVICE
    │   ├── ExperienceService.AwardExperienceFromMonster(player, monster)
    │   │   ├── Validate monster is defeated
    │   │   ├── Get monster.ExperienceValue
    │   │   └── Call AwardExperience(player, amount, source)
    │   │
    │   └── AwardExperience(player, amount, source)
    │       ├── previousXp = player.Experience
    │       ├── newTotal = player.AddExperience(amount)
    │       ├── Log XP gain
    │       └── Return ExperienceGainResult
    │
    ├─► 3. CREATE DTO
    │   └── ExperienceGainDto.FromResult(result, level, xpToNext, progressPercent)
    │
    └─► 4. RENDER XP GAIN
        ├── "★ You gained 25 XP!"
        └── "XP: 25/100 (25%)"
```

### Player XP Addition Flow

```
player.AddExperience(amount)
    │
    ├─► Validate amount >= 0
    │   └── Negative? Throw ArgumentOutOfRangeException
    │
    ├─► Experience += amount
    │
    └─► Return new Experience total
```

### Status Display Flow

```
status command
    │
    ├─► Get player state
    │   ├── Level
    │   ├── Health / MaxHealth
    │   ├── Experience
    │   ├── ExperienceToNextLevel
    │   └── ExperienceProgressPercent
    │
    └─► Render status
        ├── "=== Hero (Level 1 Warrior) ==="
        ├── "HP: 100/100"
        ├── "XP: 75/200 (37%)"
        └── "Attack: 15  Defense: 8"
```

---

## Testing Strategy

### Test Categories

#### 1. PlayerExperienceTests.cs (~6 tests)

| Test | Description |
|------|-------------|
| `NewPlayer_HasZeroExperience` | Experience starts at 0 |
| `AddExperience_PositiveAmount_IncreasesExperience` | XP is added correctly |
| `AddExperience_NegativeAmount_ThrowsException` | Cannot add negative XP |
| `AddExperience_ReturnsNewTotal` | Returns correct new total |
| `ExperienceToNextLevel_Level1_ReturnsCorrectValue` | Returns 200 for Level 1 player |
| `ExperienceProgressPercent_CalculatesCorrectly` | 0-100 percentage (e.g., 50/200 = 25%) |

#### 2. MonsterExperienceTests.cs (~4 tests)

| Test | Description |
|------|-------------|
| `Monster_HasExperienceValue` | XP value property exists |
| `CreateGoblin_Has25ExperienceValue` | Factory sets correct XP |
| `Monster_Constructor_AcceptsExperienceValue` | Constructor parameter works |
| `Monster_NegativeExperience_DefaultsToZero` | No negative XP values |

#### 3. ExperienceServiceTests.cs (~5 tests)

| Test | Description |
|------|-------------|
| `AwardExperienceFromMonster_DefeatedMonster_AwardsXp` | XP awarded on defeat |
| `AwardExperienceFromMonster_AliveMonster_ReturnsNone` | No XP if alive |
| `AwardExperience_AddsToPlayerTotal` | Player XP increases |
| `AwardExperience_ZeroAmount_ReturnsNone` | No-op for zero |
| `AwardExperience_ReturnsCorrectResult` | Result contains correct data |

#### 4. CombatResultExperienceTests.cs (~3 tests)

| Test | Description |
|------|-------------|
| `CombatResult_MonsterDefeated_IncludesXp` | XP in result when defeated |
| `CombatResult_MonsterAlive_ZeroXp` | No XP when not defeated |
| `ResolveCombatRound_ReturnsMonsterXpOnDefeat` | Service populates XP |

### Test Data Setup

```csharp
// Test fixture for experience tests
public class ExperienceTestFixture
{
    public Player Player { get; }
    public Monster Goblin { get; }
    public ExperienceService Service { get; }

    public ExperienceTestFixture()
    {
        var loggerFactory = new NullLoggerFactory();
        Service = new ExperienceService(loggerFactory.CreateLogger<ExperienceService>());

        Player = new Player("TestPlayer");
        Goblin = Monster.CreateGoblin();
    }

    public void DefeatGoblin()
    {
        // Deal enough damage to defeat the goblin
        Goblin.TakeDamage(1000);
    }
}
```

### Sample Test Implementation

```csharp
[TestFixture]
public class ExperienceServiceTests
{
    private ExperienceService _service = null!;
    private Player _player = null!;
    private Monster _goblin = null!;

    [SetUp]
    public void SetUp()
    {
        var loggerFactory = new NullLoggerFactory();
        _service = new ExperienceService(loggerFactory.CreateLogger<ExperienceService>());
        _player = new Player("TestPlayer");
        _goblin = Monster.CreateGoblin();
    }

    [Test]
    public void AwardExperienceFromMonster_DefeatedMonster_AwardsXp()
    {
        // Arrange
        _goblin.TakeDamage(1000); // Defeat the goblin

        // Act
        var result = _service.AwardExperienceFromMonster(_player, _goblin);

        // Assert
        Assert.That(result.DidGainExperience, Is.True);
        Assert.That(result.AmountGained, Is.EqualTo(25));
        Assert.That(_player.Experience, Is.EqualTo(25));
    }

    [Test]
    public void AwardExperienceFromMonster_AliveMonster_ReturnsNone()
    {
        // Act - goblin is still alive
        var result = _service.AwardExperienceFromMonster(_player, _goblin);

        // Assert
        Assert.That(result.DidGainExperience, Is.False);
        Assert.That(result.AmountGained, Is.EqualTo(0));
        Assert.That(_player.Experience, Is.EqualTo(0));
    }

    [Test]
    public void AwardExperience_AddsToPlayerTotal()
    {
        // Arrange
        _player.AddExperience(50);

        // Act
        var result = _service.AwardExperience(_player, 25, "test");

        // Assert
        Assert.That(result.NewTotal, Is.EqualTo(75));
        Assert.That(result.PreviousTotal, Is.EqualTo(50));
        Assert.That(_player.Experience, Is.EqualTo(75));
    }
}

[TestFixture]
public class PlayerExperienceTests
{
    private Player _player = null!;

    [SetUp]
    public void SetUp()
    {
        _player = new Player("TestPlayer");
    }

    [Test]
    public void NewPlayer_HasZeroExperience()
    {
        Assert.That(_player.Experience, Is.EqualTo(0));
    }

    [Test]
    public void AddExperience_PositiveAmount_IncreasesExperience()
    {
        // Act
        _player.AddExperience(100);

        // Assert
        Assert.That(_player.Experience, Is.EqualTo(100));
    }

    [Test]
    public void AddExperience_NegativeAmount_ThrowsException()
    {
        Assert.Throws<ArgumentOutOfRangeException>(() => _player.AddExperience(-10));
    }

    [Test]
    public void ExperienceProgressPercent_AtZero_ReturnsZero()
    {
        Assert.That(_player.ExperienceProgressPercent, Is.EqualTo(0));
    }

    [Test]
    public void ExperienceProgressPercent_CalculatesCorrectly()
    {
        // Arrange - level 2 requires 200 XP (level * 100)
        _player.AddExperience(50);

        // Assert - 50/200 = 25%
        Assert.That(_player.ExperienceProgressPercent, Is.EqualTo(25));
    }
}
```

---

## Logging Strategy

### Log Levels

| Level | Usage |
|-------|-------|
| Debug | XP calculations, validation checks |
| Information | XP awards to players |
| Warning | Attempted XP award from non-defeated monster |
| Error | (None expected in this phase) |

### Log Messages

```csharp
// ExperienceService
_logger.LogInformation(
    "Player {PlayerName} gained {Amount} XP from {Source} (Total: {PreviousXp} -> {NewTotal})",
    player.Name, amount, source, previousXp, newTotal);

_logger.LogDebug("No XP to award (amount: {Amount})", amount);

_logger.LogWarning("Attempted to award XP from non-defeated monster {MonsterName}", monster.Name);
```

---

## Implementation Checklist

### Phase 1: Domain Layer
- [ ] Modify `Player.cs` - add Experience property (int, default 0)
- [ ] Modify `Player.cs` - add AddExperience(amount) method
- [ ] Modify `Player.cs` - add ExperienceToNextLevel property
- [ ] Modify `Player.cs` - add ExperienceProgressPercent property
- [ ] Modify `Player.cs` - add GetDefaultXpForLevel() helper
- [ ] Modify `Monster.cs` - add ExperienceValue property
- [ ] Modify `Monster.cs` - update constructor with experienceValue parameter
- [ ] Modify `Monster.cs` - update CreateGoblin() factory (25 XP)
- [ ] Modify `CombatResult` record - add ExperienceGained property
- [ ] Modify `CombatService.ResolveCombatRound()` - return XP on defeat
- [ ] Create `ExperienceGainResult.cs` value object
- [ ] Create `ExperienceService.cs`

### Phase 2: Application Layer
- [ ] Create `ExperienceGainDto.cs`
- [ ] Modify `GameSessionService.cs` - add ExperienceService dependency
- [ ] Modify `GameSessionService.cs` - award XP after monster defeat
- [ ] Modify `GameSessionService.cs` - render XP gain

### Phase 3: Presentation Layer
- [ ] Modify `IGameRenderer.cs` - add RenderExperienceGainAsync
- [ ] Modify `SpectreGameRenderer.cs` - implement RenderExperienceGainAsync
- [ ] Modify status display to show XP

### Phase 4: DI Registration
- [ ] Register ExperienceService in DI container

### Phase 5: Testing
- [ ] Create `PlayerExperienceTests.cs` (~6 tests)
- [ ] Create `MonsterExperienceTests.cs` (~4 tests)
- [ ] Create `ExperienceServiceTests.cs` (~5 tests)
- [ ] Create `CombatResultExperienceTests.cs` (~3 tests)

---

## Acceptance Criteria

### Player Entity
- [ ] Player has `Experience` property (int, default 0)
- [ ] `AddExperience()` adds XP and returns new total
- [ ] `AddExperience()` throws on negative amounts
- [ ] `ExperienceToNextLevel` returns correct value for level
- [ ] `ExperienceProgressPercent` returns 0-100

### Monster Entity
- [ ] Monster has `ExperienceValue` property
- [ ] `CreateGoblin()` returns monster with 25 XP
- [ ] Constructor accepts experienceValue parameter
- [ ] Negative XP defaults to 0

### CombatResult
- [ ] Includes `ExperienceGained` property
- [ ] XP is populated when monster is defeated
- [ ] XP is 0 when monster survives

### ExperienceService
- [ ] `AwardExperienceFromMonster()` awards XP from defeated monsters
- [ ] `AwardExperienceFromMonster()` returns None for alive monsters
- [ ] `AwardExperience()` adds XP to player total
- [ ] Returns correct ExperienceGainResult

### Display
- [ ] Status shows XP in "75/100 (75%)" format
- [ ] Combat victory shows "★ You gained 25 XP!"
- [ ] XP progress shown after gain

### General
- [ ] ~18 unit tests pass
- [ ] Build completes with 0 errors
- [ ] Build completes with 0 warnings

---

## Risk Assessment

| Risk | Likelihood | Impact | Mitigation |
|------|------------|--------|------------|
| Monster constructor changes break existing code | Medium | Medium | Add default parameter value |
| XP overflow at high values | Low | Low | Use int (2B+ max), consider long later |
| Status display formatting issues | Low | Low | Test with various XP values |
| Missing XP award in some combat paths | Medium | Medium | Ensure all defeat paths award XP |
| EF Core not persisting Experience | Low | High | Verify property mapping |

---

## File Summary

### New Files (3)

| Layer | File | Purpose |
|-------|------|---------|
| Domain | `ValueObjects/ExperienceGainResult.cs` | XP gain result value object |
| Domain | `Services/ExperienceService.cs` | XP awarding service |
| Application | `DTOs/ExperienceGainDto.cs` | XP gain display DTO |

### Modified Files (7)

| Layer | File | Changes |
|-------|------|---------|
| Domain | `Entities/Player.cs` | Add Experience, AddExperience(), XP helpers |
| Domain | `Entities/Monster.cs` | Add ExperienceValue, update constructor/factory |
| Domain | `Services/CombatService.cs` | Add ExperienceGained to CombatResult |
| Application | `Services/GameSessionService.cs` | Award XP, render XP gain |
| Application | `Interfaces/IGameRenderer.cs` | Add RenderExperienceGainAsync |
| Presentation | `Adapters/SpectreGameRenderer.cs` | Implement XP rendering, update status |
| - | DI Container | Register ExperienceService |

### Test Files Summary

| File | Test Count |
|------|------------|
| `PlayerExperienceTests.cs` | ~6 |
| `MonsterExperienceTests.cs` | ~4 |
| `ExperienceServiceTests.cs` | ~5 |
| `CombatResultExperienceTests.cs` | ~3 |
| **Total** | **~18** |

---

## Provides to Future Phases

### To v0.0.8b (Level-Up Mechanics)

| Type | Usage |
|------|-------|
| `Player.Experience` | Check against level thresholds |
| `Player.AddExperience()` | XP addition triggers level-up check |
| `ExperienceService` | Extended with level-up detection |
| `ExperienceGainResult` | Extended with LevelUpResult |

### To v0.0.8c (Progression Configuration)

| Type | Usage |
|------|-------|
| `Player.ExperienceToNextLevel` | Replace with config-driven calculation |
| `ExperienceService.GetDefaultMonsterXp()` | Replace with config loading |
| `ExperienceGainDto` | Extended with custom terminology |
