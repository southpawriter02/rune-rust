# v0.18.1 Runic Blight Corruption - Scope Breakdown

**Version:** 0.18.1
**Theme:** Runic Blight Corruption
**Prerequisites:** v0.18.0 Complete (Psychic Stress), v0.6.x (Dice System)
**Total Estimated Tests:** ~15 new tests

---

## Executive Summary

v0.18.1 implements the **Runic Blight Corruption** system — the near-permanent trauma resource that represents spiritual contamination from heretical power usage. Unlike Psychic Stress, Corruption accumulates over a character's lifetime with almost no recovery options, creating permanent mechanical consequences.

The work is divided into **5 sub-phases**:

| Phase    | Name                             | Focus                                 | Est. Tests |
| -------- | -------------------------------- | ------------------------------------- | ---------- |
| v0.18.1a | Corruption Enums                 | CorruptionThreshold, CorruptionSource | ~2         |
| v0.18.1b | CorruptionState Entity           | State tracking, thresholds, penalties | ~5         |
| v0.18.1c | ICorruptionService Interface     | Service contract definition           | ~0         |
| v0.18.1d | CorruptionService Implementation | Core corruption logic                 | ~5         |
| v0.18.1e | Configuration & Persistence      | JSON config, database schema          | ~3         |

---

## Feature Analysis & Categorization

### From trauma-economy.md - Corruption Tracking

| Feature                  | Complexity | Dependencies    | Assigned Phase |
| ------------------------ | ---------- | --------------- | -------------- |
| CorruptionThreshold Enum | Low        | None            | **v0.18.1a**   |
| CorruptionSource Enum    | Low        | None            | **v0.18.1a**   |
| CorruptionState Entity   | High       | Threshold enum  | **v0.18.1b**   |
| CorruptionAddResult VO   | Low        | CorruptionState | **v0.18.1b**   |
| TerminalErrorResult VO   | Low        | None            | **v0.18.1b**   |

### From trauma-economy.md - Service Layer

| Feature                     | Complexity | Dependencies       | Assigned Phase |
| --------------------------- | ---------- | ------------------ | -------------- |
| ICorruptionService          | Medium     | All VOs            | **v0.18.1c**   |
| CorruptionService           | High       | ICorruptionService | **v0.18.1d**   |
| CorruptionTransferResult VO | Low        | None               | **v0.18.1d**   |
| CorruptionSkillModifiers VO | Low        | None               | **v0.18.1d**   |

### From trauma-economy.md - Configuration

| Feature                   | Complexity | Dependencies      | Assigned Phase |
| ------------------------- | ---------- | ----------------- | -------------- |
| corruption_sources.json   | Medium     | None              | **v0.18.1e**   |
| Database schema extension | Medium     | CorruptionService | **v0.18.1e**   |

---

## Phase Definitions

---

## v0.18.1a: Corruption Enums

[v0.18.1a Design Specification](v0.18.1a-design-specification.md)

### Overview

Defines the foundational enums that categorize corruption thresholds and sources.

### Scope

**In Scope:**

- `CorruptionThreshold` enum (6 tiers: Clean → TerminalError)
- `CorruptionSource` enum (8 categories)

**Out of Scope:**

- CorruptionState entity (v0.18.1b)
- Service implementation (v0.18.1d)

### Key Deliverables

| Type         | Count | Details                               |
| ------------ | ----- | ------------------------------------- |
| Domain Enums | 2     | CorruptionThreshold, CorruptionSource |
| Unit Tests   | ~2    |                                       |

### Data Model Changes

```
NEW: CorruptionThreshold (Enum)
├── Clean = 0       (0-20 corruption)
├── Tainted = 1     (21-40 corruption)
├── Infected = 2    (41-60 corruption)
├── Corrupted = 3   (61-80 corruption)
├── Terminal = 4    (81-99 corruption)
└── TerminalError = 5 (100 corruption)

NEW: CorruptionSource (Enum)
├── MysticMagic          - Standard mystic spellcasting
├── HereticalAbility     - Berserker, Blót-Priest, etc.
├── Artifact             - Glitched artifact interaction
├── Environmental        - Blight zone exposure
├── Consumable           - Corrupted consumable usage
├── Ritual               - Forbidden ritual participation
├── ForlornContact       - Direct Forlorn contact
└── BlightTransfer       - Blót-Priest transfer received
```

### Threshold Effects Summary

| Threshold     | Corruption | Tech Bonus | Social Penalty | Special Effects         |
| ------------- | ---------- | ---------- | -------------- | ----------------------- |
| Clean         | 0-20       | +0         | -0             | None                    |
| Tainted       | 21-40      | +1         | -1             | UI Warning              |
| Infected      | 41-60      | +2         | -2             | Faction Lock            |
| Corrupted     | 61-80      | +2         | -2             | Machine Affinity Trauma |
| Terminal      | 81-99      | +2         | -2             | NPCs Fear Character     |
| TerminalError | 100        | N/A        | N/A            | Character Lost          |

### Acceptance Criteria

- [x] CorruptionThreshold enum has 6 values with correct ranges
- [x] CorruptionSource enum has 8 categories
- [x] All enum values have XML documentation
- [x] ~2 unit tests pass

---

## v0.18.1b: CorruptionState Entity

[v0.18.1b Design Specification](v0.18.1b-design-specification.md)

### Overview

Implements the CorruptionState entity that tracks corruption accumulation, threshold crossings, and computed penalties.

### Scope

**In Scope:**

- `CorruptionState` entity with threshold tracking
- `CorruptionAddResult` record
- `TerminalErrorResult` record
- Computed penalty properties (HP, AP, Resolve)
- Threshold crossing detection (25/50/75)

**Out of Scope:**

- Service layer (v0.18.1d)
- Database persistence (v0.18.1e)

### Key Deliverables

| Type                 | Count | Details                                  |
| -------------------- | ----- | ---------------------------------------- |
| Domain Entities      | 1     | CorruptionState                          |
| Domain Value Objects | 2     | CorruptionAddResult, TerminalErrorResult |
| Unit Tests           | ~5    |                                          |

### Data Model Changes

```
NEW: CorruptionState (Entity)
├── CharacterId: Guid
├── CurrentCorruption: int (0-100)
├── MaxCorruption: const 100
├── Threshold25Triggered: bool
├── Threshold50Triggered: bool
├── Threshold75Triggered: bool
├── Threshold: CorruptionThreshold (computed)
├── MaxHpPenaltyPercent: int (floor(Corruption/10) × 5)
├── MaxApPenaltyPercent: int (floor(Corruption/10) × 5)
├── ResolveDicePenalty: int (floor(Corruption/20))
├── TechBonus: int (by threshold)
├── SocialPenalty: int (by threshold)
├── FactionReputationLocked: bool (Corruption >= 50)
├── IsTerminalError: bool (Corruption >= 100)
└── AddCorruption(amount, source): CorruptionAddResult

NEW: CorruptionAddResult (Record)
├── PreviousCorruption: int
├── NewCorruption: int
├── AmountGained: int
├── Source: CorruptionSource
├── ThresholdCrossed: int?
└── IsTerminalError: bool

NEW: TerminalErrorResult (Record)
├── Survived: bool
├── FinalCorruption: int (99 if survived)
├── BecameForlorn: bool
├── SuccessesRolled: int
└── RequiredDc: int
```

### Penalty Formulas

| Penalty Type   | Formula                   | Example (Corruption=45) |
| -------------- | ------------------------- | ----------------------- |
| Max HP Penalty | floor(Corruption/10) × 5% | 20% (4 × 5)             |
| Max AP Penalty | floor(Corruption/10) × 5% | 20% (4 × 5)             |
| Resolve Dice   | floor(Corruption/20)      | -2 dice                 |

### Acceptance Criteria

- [x] CorruptionState threshold computed correctly from value
- [x] Max HP penalty calculated as floor(Corruption/10) × 5%
- [x] Max AP penalty calculated as floor(Corruption/10) × 5%
- [x] Resolve dice penalty calculated as floor(Corruption/20)
- [x] Threshold 25/50/75 crossings trigger exactly once
- [x] Faction reputation locked at 50+ corruption
- [x] Terminal Error triggers at exactly 100
- [x] ~5 unit tests pass (59 actual test methods, 140 test case executions)

---

## v0.18.1c: ICorruptionService Interface

[v0.18.1c Design Specification](v0.18.1c-design-specification.md)

### Overview

Defines the service contract for all corruption management operations.

### Scope

**In Scope:**

- `ICorruptionService` interface definition
- Method signatures and XML documentation

**Out of Scope:**

- Implementation (v0.18.1d)

### Key Deliverables

| Type                   | Count | Details            |
| ---------------------- | ----- | ------------------ |
| Application Interfaces | 1     | ICorruptionService |
| Unit Tests             | ~0    | Interface only     |

### Interface Definition

```csharp
public interface ICorruptionService
{
    CorruptionState GetCorruptionState(Guid characterId);
    CorruptionAddResult AddCorruption(Guid characterId, int amount, CorruptionSource source);
    CorruptionTransferResult TransferCorruption(Guid fromCharacterId, Guid toCharacterId, int amount);
    bool RemoveCorruption(Guid characterId, int amount, string reason);
    int GetMaxHpPenaltyPercent(Guid characterId);
    int GetMaxApPenaltyPercent(Guid characterId);
    int GetResolveDicePenalty(Guid characterId);
    CorruptionSkillModifiers GetSkillModifiers(Guid characterId);
    TerminalErrorResult PerformTerminalErrorCheck(Guid characterId);
}
```

### Acceptance Criteria

- [x] ICorruptionService defines all 9 methods
- [x] All methods have XML documentation
- [x] Interface compiles without dependencies on implementation

---

## v0.18.1d: CorruptionService Implementation

[v0.18.1d Design Specification](v0.18.1d-design-specification.md)

### Overview

Implements the core corruption logic including accumulation, Blight Transfer, skill modifiers, and Terminal Error checks.

### Scope

**In Scope:**

- `CorruptionService` class implementing `ICorruptionService`
- `CorruptionTransferResult` record (Blót-Priest transfer)
- `CorruptionSkillModifiers` record
- Terminal Error WILL check

**Out of Scope:**

- Wild Magic system (v0.20.x)
- Forlorn conversion mechanics (v0.21.x)
- Recovery/purification methods (v0.22.x)

### Key Deliverables

| Type                 | Count | Details                                            |
| -------------------- | ----- | -------------------------------------------------- |
| Application Services | 1     | CorruptionService                                  |
| Domain Value Objects | 2     | CorruptionTransferResult, CorruptionSkillModifiers |
| Unit Tests           | ~5    |                                                    |

### Data Model Changes

```
NEW: CorruptionTransferResult (Record)
├── Success: bool
├── AmountTransferred: int
├── SourceNewCorruption: int
├── TargetNewCorruption: int
└── TargetTerminalError: bool

NEW: CorruptionSkillModifiers (Record)
├── TechBonus: int
├── SocialPenalty: int
└── FactionLocked: bool
```

### Acceptance Criteria

- [ ] Corruption accumulates correctly from all sources
- [ ] TransferCorruption moves corruption between characters
- [ ] Terminal Error check uses WILL vs DC
- [ ] Skill modifiers scale with threshold correctly
- [ ] ~5 unit tests pass

---

## v0.18.1e: Configuration & Persistence

[v0.18.1e Design Specification](v0.18.1e-design-specification.md)

### Overview

Defines the JSON configuration for corruption sources and extends the database schema for persistence and history tracking.

### Scope

**In Scope:**

- `config/corruption-sources.json` configuration file
- `config/schemas/corruption-sources.schema.json` JSON Schema
- Database tables: `character_corruption`, `corruption_history`

**Out of Scope:**

- Runtime configuration loading (uses existing `IConfigurationProvider`)

### Key Deliverables

| Type                | Count | Details                        |
| ------------------- | ----- | ------------------------------ |
| Configuration Files | 1     | corruption-sources.json        |
| JSON Schemas        | 1     | corruption-sources.schema.json |
| Database Migrations | 1     | Add corruption tables          |
| Unit Tests          | ~3    |                                |

### Configuration Structure

```json
{
    "version": "1.0",
    "corruptionSources": {
        "mysticMagic": [
            {
                "id": "standard-spell",
                "name": "Standard Spell",
                "minCorruption": 0,
                "maxCorruption": 2
            },
            {
                "id": "powerful-spell",
                "name": "Powerful Spell",
                "minCorruption": 3,
                "maxCorruption": 5
            },
            {
                "id": "overcasting",
                "name": "Overcasting",
                "minCorruption": 10,
                "maxCorruption": 15
            }
        ],
        "hereticalAbility": [
            {
                "id": "berserker-rage",
                "name": "Berserker Rage Abilities",
                "minCorruption": 2,
                "maxCorruption": 5
            },
            {
                "id": "blot-priest-hp-cast",
                "name": "Sacrificial Casting",
                "corruptionPerHp": 1
            },
            {
                "id": "blot-priest-siphon",
                "name": "Life Siphon",
                "fixedCorruption": 1
            },
            {
                "id": "seidkona-divination",
                "name": "Forbidden Divination",
                "minCorruption": 3,
                "maxCorruption": 8
            }
        ],
        "environmental": [
            {
                "id": "blight-zone",
                "name": "Blight Zone Exposure",
                "minCorruption": 1,
                "maxCorruption": 3,
                "perExposure": true
            },
            {
                "id": "forlorn-contact",
                "name": "Forlorn Contact",
                "minCorruption": 5,
                "maxCorruption": 10
            }
        ],
        "items": [
            {
                "id": "glitched-artifact",
                "name": "Glitched Artifact Use",
                "minCorruption": 1,
                "maxCorruption": 5
            },
            {
                "id": "corrupted-consumable",
                "name": "Corrupted Consumable",
                "minCorruption": 2,
                "maxCorruption": 5
            }
        ]
    },
    "thresholdEffects": {
        "25": {
            "description": "You feel the Blight's touch...",
            "uiWarning": true
        },
        "50": {
            "description": "Human faction reputation gains locked",
            "factionLock": true
        },
        "75": {
            "description": "Acquire [MACHINE AFFINITY] trauma",
            "traumaId": "machine-affinity"
        },
        "100": {
            "description": "Terminal Error - Character transformation",
            "terminalError": true
        }
    },
    "penalties": {
        "maxHpPercent": { "formula": "floor(corruption / 10) * 5" },
        "maxApPercent": { "formula": "floor(corruption / 10) * 5" },
        "resolveDice": { "formula": "floor(corruption / 20)" }
    }
}
```

### Database Schema

```sql
CREATE TABLE IF NOT EXISTS character_corruption (
    character_id UUID PRIMARY KEY REFERENCES characters(id) ON DELETE CASCADE,
    current_corruption INT NOT NULL DEFAULT 0
        CONSTRAINT chk_corruption_range CHECK (current_corruption >= 0 AND current_corruption <= 100),
    threshold_25_triggered BOOLEAN NOT NULL DEFAULT false,
    threshold_50_triggered BOOLEAN NOT NULL DEFAULT false,
    threshold_75_triggered BOOLEAN NOT NULL DEFAULT false,
    updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP
);

CREATE TABLE IF NOT EXISTS corruption_history (
    id SERIAL PRIMARY KEY,
    character_id UUID NOT NULL REFERENCES characters(id) ON DELETE CASCADE,
    amount INT NOT NULL,
    source VARCHAR(50) NOT NULL,
    new_total INT NOT NULL,
    threshold_crossed INT,
    is_transfer BOOLEAN NOT NULL DEFAULT false,
    transfer_target_id UUID REFERENCES characters(id),
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX idx_corruption_history_char ON corruption_history(character_id);
CREATE INDEX idx_corruption_history_time ON corruption_history(created_at);
```

### Acceptance Criteria

- [ ] Schema validates correct corruption source definitions
- [ ] Schema rejects invalid corruption values
- [ ] Configuration loads all corruption source categories
- [ ] Database tables created with proper constraints
- [ ] Corruption history logged for all changes
- [ ] ~3 unit tests pass

---

## Dependencies & Prerequisites

```
v0.6.x (Dice System) - REQUIRED
    │
    └── IDiceService (Terminal Error check)
                    │
v0.17.2 (Attribute System) - REQUIRED
    │
    └── WILL attribute for transformation check
                    │
                    ▼
v0.18.1 (Runic Blight Corruption)
    │
    ├── v0.18.1a: Corruption Enums ──────────────────┐
    │       Dependencies: None                        │
    │                                                 │
    ├── v0.18.1b: CorruptionState Entity ────────────┤
    │       Dependencies: v0.18.1a                   │
    │                                                 │
    ├── v0.18.1c: ICorruptionService Interface ──────┤
    │       Dependencies: v0.18.1a, v0.18.1b         │
    │                                                 │
    ├── v0.18.1d: CorruptionService Implementation ──┤
    │       Dependencies: v0.18.1c, IDiceService     │
    │                                                 │
    └── v0.18.1e: Configuration & Persistence ───────┘
            Dependencies: v0.18.1d
```

---

## Estimated Effort Summary

| Phase     | New Files | Modified Files | Est. Tests | Complexity |
| --------- | --------- | -------------- | ---------- | ---------- |
| v0.18.1a  | 2         | 0              | ~2         | Low        |
| v0.18.1b  | 3         | 0              | ~5         | Medium     |
| v0.18.1c  | 1         | 0              | ~0         | Low        |
| v0.18.1d  | 3         | 1              | ~5         | High       |
| v0.18.1e  | 3         | 1              | ~3         | Medium     |
| **Total** | **12**    | **2**          | **~15**    |            |

---

## Risk Assessment

| Risk                               | Impact | Probability | Mitigation                     |
| ---------------------------------- | ------ | ----------- | ------------------------------ |
| Terminal Error check complexity    | Medium | Low         | Leverage existing dice service |
| Blight Transfer edge cases         | Low    | Medium      | Comprehensive unit tests       |
| Threshold crossing race conditions | Low    | Low         | Immutable state pattern        |

---

## Design Decisions (Confirmed)

### Corruption Mechanics

| Decision               | Value                     | Notes                             |
| ---------------------- | ------------------------- | --------------------------------- |
| **Corruption Range**   | 0-100                     | Matches Stress range              |
| **Threshold Count**    | 6 tiers                   | 20-point increments               |
| **HP Penalty Formula** | floor(Corruption/10) × 5% | Max 50% at 100                    |
| **AP Penalty Formula** | floor(Corruption/10) × 5% | Max 50% at 100                    |
| **Resolve Penalty**    | floor(Corruption/20) dice | Max -5 dice                       |
| **Faction Lock**       | At 50+ corruption         | No human faction reputation gains |
| **Terminal Error**     | At exactly 100            | Character transformation          |

### Recovery Philosophy

| Decision             | Value               | Notes                          |
| -------------------- | ------------------- | ------------------------------ |
| **Recovery Methods** | Extremely rare      | Quest/ritual only (v0.22.x)    |
| **Permanent Nature** | Near-permanent      | Core design philosophy         |
| **Blight Transfer**  | Blót-Priest ability | Moves corruption between chars |

---

## Out of Scope

| Feature                              | Deferred To | Reason                   |
| ------------------------------------ | ----------- | ------------------------ |
| Stress integration (Resolve penalty) | v0.18.5     | Integration version      |
| Wild Magic system                    | v0.20.x     | Mystic abilities version |
| Machine Affinity trauma definition   | v0.18.3     | Trauma system            |
| Forlorn conversion mechanics         | v0.21.x     | Enemy system             |
| Recovery methods (purification)      | v0.22.x     | Quest/ritual system      |

---

## Next Steps

1. **Review & Approve** - Confirm scope breakdown with stakeholders
2. **v0.18.1a Design Spec** - Create detailed design specification for Corruption Enums
3. **Implement v0.18.1a** - Build foundational enums
4. **Repeat for v0.18.1b through v0.18.1e**

---

_This scope breakdown provides a structured approach to implementing v0.18.1 Runic Blight Corruption. Each sub-phase builds on the previous, allowing for incremental development and testing._

---

## Changelog

| Version | Date       | Changes                        |
| ------- | ---------- | ------------------------------ |
| 1.0     | 2026-01-17 | Initial scope breakdown        |
| 1.1     | 2026-01-27 | Restructured to match template |
