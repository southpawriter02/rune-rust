# Changelog: v0.3.17 - The Toolbox (Debug Console & Cheat Commands)

**Versions:** v0.3.17a and v0.3.17b
**Release Dates:** 2025-12-25 (both parts)
**Total Tests:** 28 new tests (12 + 16)
**Test Results:** All passing

---

## Table of Contents

- [Overview](#overview)
- [Key Metrics](#key-metrics)
- [Part A: The Console (Overlay UI)](#part-a-the-console-overlay-ui)
  - [Summary](#summary)
  - [New Files Created](#new-files-created)
  - [Files Modified](#files-modified)
  - [Code Implementation Details](#code-implementation-details)
  - [Logging Matrix](#logging-matrix)
  - [Test Coverage](#test-coverage)
  - [DI Registration](#di-registration)
  - [Verification Results](#verification-results)
  - [Directory Structure After Release](#directory-structure-after-release)
  - [Architecture Decisions](#architecture-decisions)
  - [Running Tests](#running-tests)
  - [Usage Example](#usage-example)
- [Part B: The Toolbox (Cheat Commands)](#part-b-the-toolbox-cheat-commands)
  - [Summary](#summary-1)
  - [New Files Created](#new-files-created-1)
  - [Files Modified](#files-modified-1)
  - [Code Implementation Details](#code-implementation-details-1)
  - [God Mode Integration Points](#god-mode-integration-points)
  - [Logging Matrix](#logging-matrix-1)
  - [Test Coverage](#test-coverage-1)
  - [DI Registration](#di-registration-1)
  - [Verification Results](#verification-results-1)
  - [Directory Structure After Release](#directory-structure-after-release-1)
  - [Architecture Decisions](#architecture-decisions-1)
  - [Running Tests](#running-tests-1)
  - [Usage Examples](#usage-examples)
- [Next Steps](#next-steps)

---

## Overview

v0.3.17 "The Toolbox" implements a complete debug console system for developer testing and game state manipulation. This milestone is divided into two parts:

**Part A (The Console)** establishes the debug console infrastructure:
- Quake-style overlay accessible via `~` or `debug` command from any game phase
- Scrolling log buffer (50 entries) with command history navigation (20 entries)
- Modal rendering loop with raw keypress interception using Spectre.Console
- Built-in commands: help, clear, exit

**Part B (The Toolbox)** adds executable cheat commands:
- God mode invulnerability toggle (`/god`)
- Instant full heal (`/heal`)
- Teleportation by room GUID or name (`/tp`)
- Map fog-of-war reveal (`/reveal`)
- Item spawn placeholder (`/spawn`)

Together, these components provide a comprehensive developer toolkit for testing combat scenarios, exploring content, and debugging game state issues.

---

## Key Metrics

| Metric | Part A (Console) | Part B (Cheats) | Combined |
|--------|------------------|-----------------|----------|
| New Files | 4 | 3 | 7 |
| Modified Files | 2 | 5 | 7 (some overlap) |
| New Tests | 12 | 16 | 28 |
| Test Pass Rate | 100% | 100% | 100% |

---

## Part A: The Console (Overlay UI)

**Release Date:** 2025-12-25
**Tests Added:** 12 (DebugConsoleServiceTests)

### Summary

v0.3.17a introduces a Quake-style debug console overlay accessible from any game phase via the `~` or `debug` command. This implementation establishes the foundation for developer tooling by providing a scrolling log buffer with command history navigation, built-in console commands, and a modal rendering loop using Spectre.Console. The architecture employs interface abstraction (IDebugConsoleRenderer in Core layer) to enable the Engine layer's CommandParser to trigger the console without creating a circular dependency on the Terminal layer. Thread-safe buffer management prepares the service for future integration with Serilog sinks and background logging. This release focuses exclusively on console infrastructure; cheat command execution (heal, god mode, teleport) is deferred to v0.3.17b.

Key architectural patterns introduced: Service abstraction for cross-layer communication, bounded buffer collections with automatic pruning (50 log entries, 20 command history), and modal input loops with raw keypress interception.

---

### New Files Created

#### Core Layer

| File | Purpose |
|------|---------|
| `RuneAndRust.Core/Interfaces/IDebugConsoleService.cs` | Defines the debug console state management contract with properties for visibility, log history, and command history. Specifies buffer limits (50 logs, 20 commands). |
| `RuneAndRust.Core/Interfaces/IDebugConsoleRenderer.cs` | Abstracts the console rendering layer, allowing Engine layer to trigger modal console loop without depending on Terminal layer implementation. |

#### Engine Layer

| File | Purpose |
|------|---------|
| `RuneAndRust.Engine/Services/DebugConsoleService.cs` | Thread-safe implementation of IDebugConsoleService with lock-based synchronization for concurrent log access. Manages bounded log buffer and command history with automatic oldest-entry removal. |

#### Terminal Layer

| File | Purpose |
|------|---------|
| `RuneAndRust.Terminal/Rendering/DebugConsoleRenderer.cs` | Implements IDebugConsoleRenderer using Spectre.Console for rendering. Provides modal input loop with Console.ReadKey for raw keyboard interception, supporting Enter, Backspace, Up/Down arrow navigation, Escape, and Tilde (~) keys. Renders 15 visible log lines with color-coded output. |

#### Test Layer

| File | Purpose |
|------|---------|
| `RuneAndRust.Tests/Engine/DebugConsoleServiceTests.cs` | Unit test suite validating toggle behavior, log formatting, buffer limit enforcement, command history, and clear operations. 12 tests with FluentAssertions and NSubstitute mocking. |

---

### Files Modified

| File | Change |
|------|--------|
| `RuneAndRust.Engine/Services/CommandParser.cs` | Added field `_debugConsoleRenderer` (IDebugConsoleRenderer?). Updated constructor to accept optional `debugConsoleRenderer` parameter. Inserted phase-agnostic command interception at lines 303-316 to handle `~` and `debug` commands before phase-specific routing. |
| `RuneAndRust.Terminal/Program.cs` | Registered IDebugConsoleService and IDebugConsoleRenderer as Singleton services at lines 212-214 in dependency injection container. |

---

### Code Implementation Details

#### IDebugConsoleService Interface

**Properties:**
- `bool IsVisible { get; }` - Current visibility state of debug console
- `IReadOnlyList<string> LogHistory { get; }` - Thread-safe read-only view of log buffer (max 50 entries)
- `IReadOnlyList<string> CommandHistory { get; }` - Thread-safe read-only view of command history (max 20 entries)

**Methods:**
```csharp
void Toggle()
void WriteLog(string message, string source = "System")
void SubmitCommand(string command)
void ClearLog()
```

**Behaviors:**
- LogHistory limited to 50 entries; oldest removed when exceeded
- CommandHistory limited to 20 entries; oldest removed when exceeded
- Default log source is "System" when not specified
- Empty/whitespace commands ignored by SubmitCommand

---

#### IDebugConsoleRenderer Interface

**Methods:**
```csharp
void Run()
```

**Behaviors:**
- Runs modal console loop, blocking until user exits with ~ or Escape
- Handles all keyboard input and rendering internally

---

#### DebugConsoleService Implementation

**Constants:**
- `MaxLogHistory = 50` - Maximum log buffer size
- `MaxCommandHistory = 20` - Maximum command history size

**Thread Safety:**
- Uses `lock (_lock)` pattern for all buffer access
- LogHistory and CommandHistory properties create defensive copies with `.ToList().AsReadOnly()`

**Log Entry Format:**
```
[HH:mm:ss] [Source] Message
```

**Key Behaviors:**
- Toggle() flips IsVisible and logs state change at Trace level
- WriteLog() formats entry with timestamp, adds to buffer, prunes if needed
- SubmitCommand() ignores null/empty input, logs at Debug level, writes to log with [User] source, adds to command history
- ClearLog() empties log buffer but preserves command history
- All operations log state changes via ILogger<DebugConsoleService>

---

#### DebugConsoleRenderer Implementation

**Constants:**
- `VisibleLogLines = 15` - Number of log lines displayed in viewport

**Keyboard Handling:**
| Key | Behavior |
|-----|----------|
| Enter | Submit current input buffer, clear buffer, reset history index |
| Backspace | Remove last character from input buffer |
| Up Arrow | Navigate backward through command history (oldest to newest) |
| Down Arrow | Navigate forward through command history (newest back to current) |
| Escape / Tilde (~) | Close console and toggle visibility |
| Printable characters | Append to input buffer |

**Rendering Behavior:**
- Clears screen on each render cycle
- Displays Rule header with "[bold yellow]DEBUG CONSOLE[/]" in purple border
- Shows last 15 log entries from buffer
- Pads empty space to maintain consistent layout
- Displays input line with "> " prompt and blinking cursor
- Escapes markup to prevent injection

**Color Coding:**
| Log Source | Color |
|------------|-------|
| [User] | cyan |
| [Error] | red |
| [System] | grey |

**Built-in Commands (v0.3.17a):**
| Command | Action |
|---------|--------|
| help | Display available commands |
| clear | Clear log buffer (preserves command history) |
| exit | Close debug console |
| ~ | Close debug console |
| (other) | Display "Unknown command" error with help hint |

---

### Logging Matrix

#### DebugConsoleService

| Event | Level | Template |
|-------|-------|----------|
| Toggle visibility | Trace | `"[DEBUG] Console visibility set to {State}"` |
| Command submission | Debug | `"[DEBUG] User submitted: {Command}"` |
| Clear log buffer | Trace | `"[DEBUG] Log buffer cleared"` |

#### CommandParser

| Event | Level | Template |
|-------|-------|----------|
| Open debug console | Trace | `"[DEBUG] Opening debug console"` |

---

### Test Coverage

**Summary:**
```
Total: 12 | Passed: 12 | Failed: 0 | Duration: 50ms
```

#### DebugConsoleServiceTests (12 tests)

| Test Name | Description |
|-----------|-------------|
| Toggle_SwitchesVisibilityFalseToTrue | Verifies initial state is false and Toggle() sets to true |
| Toggle_SwitchesVisibilityTrueToFalse | Verifies Toggle() can switch from true back to false |
| WriteLog_AddsEntryToHistory | Confirms log entry is added to LogHistory collection |
| WriteLog_FormatsEntryWithTimestampAndSource | Validates regex pattern `\[\d{2}:\d{2}:\d{2}\]` and source/message presence |
| WriteLog_UsesDefaultSourceWhenNotSpecified | Asserts default "[System]" source when no source parameter provided |
| WriteLog_MaintainsBufferLimit_RemovesOldest | Adds 55 entries, confirms buffer capped at 50, validates "Message 6" is first and "Message 55" is last |
| SubmitCommand_AddsToCommandHistory | Confirms command added to CommandHistory collection |
| SubmitCommand_WritesToLogWithUserSource | Verifies log entry created with "[User]" source |
| SubmitCommand_IgnoresEmptyInput | Tests empty string, whitespace, and null inputs are ignored (no history/log entries) |
| CommandHistory_MaintainsLimit_RemovesOldest | Adds 25 commands, confirms buffer capped at 20, validates "command6" is first and "command25" is last |
| ClearLog_EmptiesLogBuffer | Verifies LogHistory.Count becomes 0 after ClearLog() |
| ClearLog_DoesNotClearCommandHistory | Confirms CommandHistory remains intact after ClearLog() |

---

### DI Registration

**Location:** `RuneAndRust.Terminal/Program.cs` (lines 212-214)

```csharp
// Register Debug Console Services (v0.3.17a)
services.AddSingleton<IDebugConsoleService, DebugConsoleService>();
services.AddSingleton<IDebugConsoleRenderer, DebugConsoleRenderer>();
```

**Lifetime:**
- Singleton - Both services registered as Singleton to maintain state across game phases
- Singleton ensures log history and command history persist for entire application lifetime

---

### Verification Results

#### Build Output

```
Build succeeded.

    1 Warning(s)
    0 Error(s)

Time Elapsed 00:00:01.13
```

#### Test Output

```
Test run for RuneAndRust.Tests.dll (.NETCoreApp,Version=v9.0)
A total of 1 test files matched the specified pattern.

Passed!  - Failed:     0, Passed:    12, Skipped:     0, Total:    12, Duration: 50 ms
```

---

### Directory Structure After Release

```
RuneAndRust.Core/
├── Interfaces/
│   ├── IDebugConsoleService.cs       [NEW]
│   └── IDebugConsoleRenderer.cs      [NEW]

RuneAndRust.Engine/
└── Services/
    ├── CommandParser.cs              [MODIFIED]
    └── DebugConsoleService.cs        [NEW]

RuneAndRust.Terminal/
├── Program.cs                        [MODIFIED]
└── Rendering/
    └── DebugConsoleRenderer.cs       [NEW]

RuneAndRust.Tests/
└── Engine/
    └── DebugConsoleServiceTests.cs   [NEW]
```

---

### Architecture Decisions

#### 1. Interface Abstraction (IDebugConsoleRenderer in Core)

**Decision:** Created IDebugConsoleRenderer in Core layer despite being implemented only in Terminal layer.

**Rationale:**
- Avoids circular dependency: Engine layer's CommandParser needs to trigger console, but Terminal depends on Engine
- Follows Dependency Inversion Principle (DIP): Engine depends on abstraction, Terminal provides implementation
- Enables future alternative renderers (Avalonia UI, web-based, logging-only modes)

---

#### 2. Command-Based Toggle vs. Global Hotkey

**Decision:** Console triggered via `~` or `debug` commands, not via raw keypress interception during normal gameplay.

**Rationale:**
- IInputHandler.GetInput() uses blocking Spectre.Console TextPrompt with no raw keypress access
- Adding global hotkey would require refactoring entire input system to use Console.ReadKey() throughout
- Command-based approach follows existing patterns (OptionsController also uses commands like "options")

---

#### 3. Thread-Safe Buffer with Lock Pattern

**Decision:** Used `lock (_lock)` synchronization in DebugConsoleService for all buffer access.

**Rationale:**
- Prepares for future Serilog sink integration that may write from background threads
- Defensive copies (`.ToList().AsReadOnly()`) prevent external mutation of collections
- Minimal performance impact for 50-entry buffer

---

#### 4. Bounded Buffers with Automatic Pruning

**Decision:** Log buffer capped at 50 entries, command history at 20 entries, both with automatic oldest-removal.

**Rationale:**
- Prevents unbounded memory growth during long play sessions
- 50 logs provide sufficient context (15 visible + 35 scrollback)
- 20 commands cover typical debug session workflow

---

#### 5. Modal Rendering Loop Pattern

**Decision:** DebugConsoleRenderer.Run() blocks in modal loop until user exits, similar to OptionsController.

**Rationale:**
- Consistent with existing UI pattern in project
- Simplifies state management (no concurrent UI updates)
- Matches user expectation (console is focused overlay, not background window)

---

#### 6. Built-in Commands Only (v0.3.17a)

**Decision:** v0.3.17a implements only console management commands (help, clear, exit), deferring cheat commands to v0.3.17b.

**Rationale:**
- Separates console infrastructure from game state manipulation
- Enables testing of rendering, input, and buffer management independently
- Reduces scope for initial release

---

### Running Tests

#### Run All Debug Console Tests
```bash
dotnet test --filter "FullyQualifiedName~DebugConsoleServiceTests"
```

#### Run Specific Test
```bash
dotnet test --filter "FullyQualifiedName~WriteLog_MaintainsBufferLimit_RemovesOldest"
```

---

### Usage Example

**Opening the Console:**
```
> ~
[DEBUG CONSOLE]
═══════════════════════════════════════════════════════════
[12:34:56] [System] Debug Console activated. Type 'help' for commands, '~' to exit.




(14 more empty lines)


═══════════════════════════════════════════════════════════
> _
```

**Using Help Command:**
```
> help
[12:35:02] [User] help
[12:35:02] [System] Available commands:
[12:35:02] [System]   help  - Show this help message
[12:35:02] [System]   clear - Clear the console log
[12:35:02] [System]   exit  - Close the debug console
[12:35:02] [System]   ~     - Close the debug console
```

**Command History Navigation:**
```
> help                    [Press Enter]
> clear                   [Press Enter]
> [Press Up Arrow]        → Input shows "clear"
> [Press Up Arrow]        → Input shows "help"
> [Press Down Arrow]      → Input shows "clear"
> [Press Down Arrow]      → Input clears (back to current)
```

**Unknown Command:**
```
> invalidcommand
[12:36:10] [User] invalidcommand
[12:36:10] [Error] Unknown command: invalidcommand
[12:36:10] [System] Type 'help' for available commands.
```

**Closing Console:**
```
> ~
[12:36:20] [System] Debug Console closed.
[Returns to previous game phase]
```

---

## Part B: The Toolbox (Cheat Commands)

**Release Date:** 2025-12-25
**Tests Added:** 16 (CheatServiceTests)

### Summary

v0.3.17b completes "The Toolbox" debug tools milestone by implementing executable cheat commands for developer testing. Building upon the debug console overlay introduced in v0.3.17a, this release adds ICheatService to the Engine layer with five core commands: god mode invulnerability toggle, instant full heal, teleportation by room GUID or name, map fog-of-war reveal, and placeholder item spawning. The architecture employs a Scoped service lifetime chain where CheatService depends on IRoomRepository for spatial queries, establishing the pattern for future debug tools that manipulate game state. God Mode protection is deeply integrated into combat and trauma systems through GameState.IsGodMode checks at damage/stress/corruption infliction points, ensuring developers can safely test high-lethality scenarios.

Key implementation patterns: Interface-based service injection into DebugConsoleRenderer to break circular dependencies, async/await command processing with GetAwaiter().GetResult() synchronization in the modal console loop, and defensive null-checking for optional GameState.CurrentCharacter access. All cheat operations emit Warning-level logs with [Cheat] prefix for audit trail visibility.

This release maintains strict separation between debug infrastructure (v0.3.17a) and gameplay manipulation (v0.3.17b), enabling future expansion of the cheat command catalog without modifying console rendering logic.

---

### New Files Created

#### Core Layer

| File | Purpose |
|------|---------|
| `RuneAndRust.Core/Interfaces/ICheatService.cs` | Defines the cheat command execution contract with 5 methods: ToggleGodMode (bool), FullHeal (bool), TeleportAsync (Task<string?>), SpawnItemAsync (Task<bool>), RevealMapAsync (Task<int>). Specifies async signatures for database-dependent operations. |

#### Engine Layer

| File | Purpose |
|------|---------|
| `RuneAndRust.Engine/Services/CheatService.cs` | Implementation of ICheatService with GameState mutation logic. Depends on IRoomRepository for spatial queries. Logs all cheat operations at Warning level with [Cheat] prefix. SpawnItemAsync placeholder returns false (not yet implemented). 132 lines. |

#### Test Layer

| File | Purpose |
|------|---------|
| `RuneAndRust.Tests/Engine/CheatServiceTests.cs` | Unit test suite validating all cheat commands using FluentAssertions and NSubstitute mocking. 16 tests covering toggle behavior, heal restoration, teleport by GUID/name, map reveal counting, and spawn placeholder. |

---

### Files Modified

| File | Change |
|------|--------|
| `RuneAndRust.Core/Models/GameState.cs` | Added `bool IsGodMode { get; set; } = false` property at line 75 with `[JsonIgnore]` attribute. Updated Reset() method at line 91 to include `IsGodMode = false`. Added XML comment documenting v0.3.17b introduction. |
| `RuneAndRust.Terminal/Rendering/DebugConsoleRenderer.cs` | Added field `_cheats` (ICheatService) at line 16. Updated constructor at line 23 to accept `ICheatService cheats` parameter. Added `ProcessCheatCommand(string cmd)` method at lines 154-215 handling slash-prefixed commands with verb parsing and async result unwrapping. Updated `ProcessCommand()` help text at lines 129-133 to document cheat commands. Updated class XML comment at line 9 to note v0.3.17b additions. |
| `RuneAndRust.Engine/Services/AttackResolutionService.cs` | Added field `_gameState` (GameState) at line 20. Updated constructor at lines 62-73 to accept `GameState gameState` parameter with XML comment noting v0.3.17b God Mode check. Inserted God Mode damage negation check at lines 169-173 in ResolveMeleeAttack() method before final damage application. Logs at Debug level with [Combat] prefix. |
| `RuneAndRust.Engine/Services/TraumaService.cs` | Added field `_gameState` (GameState) at line 21. Updated constructor at lines 29-34 to accept `GameState gameState` parameter with XML comment. Inserted God Mode stress negation at lines 40-56 in InflictStress() method, returning early with zero net stress. Inserted God Mode corruption negation at lines 337-351 in AddCorruption(Character) method, returning early with zero net corruption. All God Mode checks log at Debug level with [Trauma] prefix. |
| `RuneAndRust.Terminal/Program.cs` | Registered ICheatService as Scoped service at lines 216-217 in dependency injection container. Added inline comment noting v0.3.17b. |

---

### Code Implementation Details

#### ICheatService Interface

**Methods:**
```csharp
bool ToggleGodMode()
bool FullHeal()
Task<string?> TeleportAsync(string roomIdOrName)
Task<bool> SpawnItemAsync(string itemId, int quantity = 1)
Task<int> RevealMapAsync()
```

**Behaviors:**
- ToggleGodMode returns new state after flip (true = invulnerable, false = mortal)
- FullHeal returns false if GameState.CurrentCharacter is null, true on success
- TeleportAsync returns room name on success, null if room not found
- TeleportAsync attempts GUID parse first, falls back to case-insensitive partial name match
- SpawnItemAsync not yet implemented, returns false unconditionally (v0.3.17b placeholder)
- RevealMapAsync returns count of newly revealed rooms (0 if all already visited)

---

#### CheatService Implementation

**Dependencies:**
```csharp
public CheatService(
    GameState state,
    IRoomRepository roomRepo,
    ILogger<CheatService> logger)
```

**Key Behaviors:**

**ToggleGodMode:**
- Flips GameState.IsGodMode boolean
- Logs current state at Debug level before toggle
- Logs new state at Warning level after toggle
- Returns new state

**FullHeal:**
- Checks GameState.CurrentCharacter for null, returns false if absent
- Restores CurrentHP = MaxHP, CurrentStamina = MaxStamina, CurrentAp = MaxAp
- Sets PsychicStress = 0
- Clears ActiveStatusEffects collection entirely
- Logs at Warning level with HP/Stamina/AP values
- Returns true on success

**TeleportAsync:**
- Attempts Guid.TryParse on input, queries IRoomRepository.GetByIdAsync if valid GUID
- On GUID match: Sets GameState.CurrentRoomId, adds to VisitedRoomIds, logs at Warning level with "(GUID match)"
- On GUID miss: Calls GetAllRoomsAsync, performs LINQ FirstOrDefault with case-insensitive Contains match
- On name match: Sets CurrentRoomId, adds to VisitedRoomIds, logs at Warning level with "(name match)"
- Returns room.Name on success, null on failure
- Logs failure at Warning level with input string

**SpawnItemAsync:**
- Logs at Warning level "Spawn not yet implemented" with itemId and quantity
- Returns Task.FromResult(false)
- TODO comment references future ItemRepository lookup requirement

**RevealMapAsync:**
- Queries IRoomRepository.GetAllRoomsAsync for all rooms
- Iterates through rooms, calls VisitedRoomIds.Add(room.Id)
- Counts successful Add operations (returns false if already present)
- Logs count at Warning level
- Returns count of newly revealed rooms

---

#### DebugConsoleRenderer.ProcessCheatCommand

**Signature:**
```csharp
private void ProcessCheatCommand(string cmd)
```

**Parsing Logic:**
- Strips leading `/` character
- Splits on first space into verb and args (2-element array)
- Converts verb to lowercase for case-insensitive matching

**Command Routing:**

| Command | Verb Match | Action |
|---------|-----------|--------|
| `/god` or `/godmode` | god \| godmode | Calls ToggleGodMode(), logs result to console with "God Mode: ON/OFF" |
| `/heal` | heal | Calls FullHeal(), logs "Character fully restored" or "No active character" error |
| `/tp X` or `/teleport X` | tp \| teleport | Validates args presence, calls TeleportAsync().GetAwaiter().GetResult(), logs room name or "Room not found" error |
| `/reveal` | reveal | Calls RevealMapAsync().GetAwaiter().GetResult(), logs "Revealed {count} rooms" |
| `/spawn` | spawn | Logs "Spawn not yet implemented" error |
| (other) | - | Logs "Unknown cheat: /{verb}" error |

---

### God Mode Integration Points

**AttackResolutionService.ResolveMeleeAttack (line 169-173):**
```csharp
// v0.3.17b: God Mode check - player takes no damage
if (defender.IsPlayer && _gameState.IsGodMode)
{
    _logger.LogDebug("[Combat] God Mode active - damage negated ({OriginalDamage} -> 0)", finalDamage);
    finalDamage = 0;
}
```
- Check occurs after soak calculation but before damage application
- Only protects player combatants (defender.IsPlayer check)
- Original damage value logged for audit trail
- Does not affect hit detection or outcome classification

**TraumaService.InflictStress (lines 40-56):**
```csharp
// v0.3.17b: God Mode check - player takes no stress
if (target.IsPlayer && _gameState.IsGodMode)
{
    _logger.LogDebug("[Trauma] God Mode active - stress negated ({Amount} from {Source})", amount, source);
    var currentStatus = GetStressStatus(target.CurrentStress);
    return new StressResult(
        RawStress: amount,
        MitigatedAmount: amount,
        NetStressApplied: 0,
        CurrentTotal: target.CurrentStress,
        PreviousStatus: currentStatus,
        NewStatus: currentStatus,
        IsBreakingPoint: false,
        ResolveSuccesses: 0,
        Source: source
    );
}
```
- Early return bypasses resolve roll entirely
- MitigatedAmount set to full raw stress (100% mitigation)
- CurrentStress unchanged, status unchanged
- IsBreakingPoint always false

**TraumaService.AddCorruption(Character) (lines 337-351):**
```csharp
// v0.3.17b: God Mode check - player takes no corruption
if (_gameState.IsGodMode)
{
    _logger.LogDebug("[Trauma] God Mode active - corruption negated ({Amount} from {Source})", amount, source);
    var currentState = GetCorruptionState(character.Corruption);
    return new CorruptionResult(
        RawCorruption: amount,
        NetCorruptionApplied: 0,
        CurrentTotal: character.Corruption,
        PreviousTier: currentState.Tier,
        NewTier: currentState.Tier,
        TierChanged: false,
        IsTerminal: false,
        Source: source
    );
}
```
- Early return bypasses corruption accumulation
- NetCorruptionApplied = 0
- Corruption value unchanged, tier unchanged
- IsTerminal always false

---

### Logging Matrix

#### CheatService

| Event | Level | Template |
|-------|-------|----------|
| ToggleGodMode invoked | Debug | `"[Cheat] ToggleGodMode invoked, current state: {State}"` |
| God Mode state change | Warning | `"[Cheat] God Mode set to: {State}"` |
| FullHeal invoked | Debug | `"[Cheat] FullHeal invoked"` |
| FullHeal no character | Warning | `"[Cheat] FullHeal failed: no active character"` |
| FullHeal success | Warning | `"[Cheat] Character fully healed: HP={HP}, Stamina={Stamina}, AP={AP}"` |
| TeleportAsync invoked | Debug | `"[Cheat] TeleportAsync invoked with: {RoomIdOrName}"` |
| Teleport GUID match | Warning | `"[Cheat] Teleported to: {RoomName} (GUID match)"` |
| Teleport name match | Warning | `"[Cheat] Teleported to: {RoomName} (name match)"` |
| Teleport failure | Warning | `"[Cheat] Teleport failed: room not found for '{RoomIdOrName}'"` |
| Spawn not implemented | Warning | `"[Cheat] Spawn not yet implemented: {ItemId} x{Qty}"` |
| RevealMapAsync invoked | Debug | `"[Cheat] RevealMapAsync invoked"` |
| Map reveal complete | Warning | `"[Cheat] Revealed {Count} rooms"` |

#### AttackResolutionService (God Mode)

| Event | Level | Template |
|-------|-------|----------|
| God Mode damage negation | Debug | `"[Combat] God Mode active - damage negated ({OriginalDamage} -> 0)"` |

#### TraumaService (God Mode)

| Event | Level | Template |
|-------|-------|----------|
| God Mode stress negation | Debug | `"[Trauma] God Mode active - stress negated ({Amount} from {Source})"` |
| God Mode corruption negation | Debug | `"[Trauma] God Mode active - corruption negated ({Amount} from {Source})"` |

---

### Test Coverage

**Summary:**
```
Total: 16 | Passed: 16 | Failed: 0 | Duration: 62ms
```

#### CheatServiceTests (16 tests)

| Test Name | Description |
|-----------|-------------|
| ToggleGodMode_FlipsState_FalseToTrue | Verifies initial GameState.IsGodMode is false, ToggleGodMode() sets to true, return value matches new state |
| ToggleGodMode_FlipsState_TrueToFalse | Sets IsGodMode = true, verifies ToggleGodMode() switches to false |
| ToggleGodMode_ReturnsNewState | Calls ToggleGodMode() three times, asserts return values are true, false, true in sequence |
| FullHeal_RestoresHP | Creates damaged character (25/100 HP), verifies CurrentHP restored to MaxHP after FullHeal() |
| FullHeal_RestoresStamina | Creates character with 10/60 stamina, verifies CurrentStamina restored to MaxStamina |
| FullHeal_RestoresAP | Sets CurrentAp = 2, MaxAp = 10, verifies CurrentAp restored to MaxAp |
| FullHeal_ClearsStress | Sets PsychicStress = 75, verifies PsychicStress = 0 after FullHeal() |
| FullHeal_ClearsStatusEffects | Adds Bleeding and Poisoned status effects, verifies ActiveStatusEffects.Count = 0 after FullHeal() |
| FullHeal_ReturnsFalse_WhenNoCharacter | Sets GameState.CurrentCharacter = null, asserts FullHeal() returns false |
| TeleportAsync_ByGuid_TeleportsToRoom | Mocks GetByIdAsync to return room with specific GUID, verifies CurrentRoomId updated and room added to VisitedRoomIds |
| TeleportAsync_ByName_TeleportsToMatchingRoom | Mocks GetAllRoomsAsync with room named "Ancient Hall", passes "ancient" as partial match, verifies teleport success |
| TeleportAsync_ReturnsNull_WhenRoomNotFound | Mocks empty GetByIdAsync and GetAllRoomsAsync, passes "nonexistent", asserts result is null |
| RevealMapAsync_AddsAllRoomsToVisited | Mocks 3 rooms, verifies all 3 room IDs present in VisitedRoomIds after RevealMapAsync() |
| RevealMapAsync_ReturnsCount_OfNewlyRevealed | Pre-adds 1 room to VisitedRoomIds, mocks 3 total rooms, asserts return value is 2 (newly revealed count) |
| RevealMapAsync_ReturnsZero_WhenAllAlreadyVisited | Pre-adds all rooms to VisitedRoomIds, asserts RevealMapAsync() returns 0 |
| SpawnItemAsync_ReturnsFalse_NotYetImplemented | Calls SpawnItemAsync("test_item", 5), asserts result is false (placeholder behavior) |

---

### DI Registration

**Location:** `RuneAndRust.Terminal/Program.cs` (lines 216-217)

```csharp
// Register Cheat Service (v0.3.17b)
services.AddScoped<ICheatService, CheatService>();
```

**Lifetime:**
- Scoped - Registered as Scoped to align with IRoomRepository dependency (also Scoped)
- New instance created per service scope (per phase transition in game loop)

**Dependency Chain:**
```
ICheatService (Scoped)
  └─> IRoomRepository (Scoped)
        └─> RuneAndRustDbContext (Scoped)
```

---

### Verification Results

#### Build Output

```
Build succeeded.

    1 Warning(s)
    0 Error(s)

Time Elapsed 00:00:01.24
```

#### Test Output

```
Test run for RuneAndRust.Tests.dll (.NETCoreApp,Version=v9.0)
VSTest version 17.14.1 (arm64)

Starting test execution, please wait...
A total of 1 test files matched the specified pattern.

Passed!  - Failed:     0, Passed:    16, Skipped:     0, Total:    16, Duration: 62 ms
```

---

### Directory Structure After Release

```
RuneAndRust.Core/
├── Interfaces/
│   ├── ICheatService.cs                  [NEW]
│   ├── IDebugConsoleService.cs
│   └── IDebugConsoleRenderer.cs
└── Models/
    └── GameState.cs                      [MODIFIED]

RuneAndRust.Engine/
└── Services/
    ├── AttackResolutionService.cs        [MODIFIED]
    ├── CheatService.cs                   [NEW]
    ├── DebugConsoleService.cs
    └── TraumaService.cs                  [MODIFIED]

RuneAndRust.Terminal/
├── Program.cs                            [MODIFIED]
└── Rendering/
    └── DebugConsoleRenderer.cs           [MODIFIED]

RuneAndRust.Tests/
└── Engine/
    ├── CheatServiceTests.cs              [NEW]
    └── DebugConsoleServiceTests.cs
```

---

### Architecture Decisions

#### 1. Scoped Lifetime for Cheat Service

**Decision:** Registered ICheatService as Scoped despite being developer-only tooling.

**Rationale:**
- CheatService depends on IRoomRepository (Scoped) for TeleportAsync and RevealMapAsync
- Scoped lifetime chain: CheatService → IRoomRepository → DbContext
- Ensures proper DbContext disposal after each cheat command execution
- Prevents Entity Framework tracking conflicts across multiple operations

---

#### 2. GameState.IsGodMode as Non-Serialized Property

**Decision:** Marked IsGodMode with [JsonIgnore] attribute to exclude from save files.

**Rationale:**
- God Mode is ephemeral debug state, not gameplay progress
- Loading a save file should restore player to mortal state
- Prevents accidental cheat state persistence in production saves
- Aligns with PendingAction and CombatState (also [JsonIgnore])

---

#### 3. Deep Integration vs. Wrapper Pattern for God Mode

**Decision:** Embedded God Mode checks directly into AttackResolutionService and TraumaService rather than creating wrapper services.

**Rationale:**
- God Mode protection must occur at damage/stress/corruption application points for correctness
- Wrapper pattern would require duplicating entire combat/trauma interfaces
- Direct integration requires only 4 lines per check (conditional + log + mutation)
- Logs provide audit trail showing where God Mode intercepted damage

---

#### 4. Async Unwrapping with GetAwaiter().GetResult()

**Decision:** Used synchronous unwrapping of async cheat commands instead of converting console loop to async.

**Rationale:**
- DebugConsoleRenderer.Run() is modal loop with Console.ReadKey() blocking I/O
- Console.ReadKey() is synchronous with no async equivalent
- Converting entire render loop to async would require Task.Run() background threading
- GetAwaiter().GetResult() preserves exceptions without AggregateException wrapping

---

#### 5. Partial Name Matching for Teleport

**Decision:** Implemented case-insensitive partial name matching as fallback after GUID parsing.

**Rationale:**
- Developers rarely memorize room GUIDs for testing
- Partial matching enables "/tp ancient" instead of "/tp 3fa85f64-5717-4562-b3fc-2c963f66afa6"
- FirstOrDefault with Contains provides sufficient disambiguation for most cases
- Case-insensitive search prevents frustration with capitalization

---

### Running Tests

#### Run All Cheat Service Tests
```bash
dotnet test --filter "FullyQualifiedName~CheatServiceTests"
```

#### Run Specific Test
```bash
dotnet test --filter "FullyQualifiedName~TeleportAsync_ByGuid_TeleportsToRoom"
```

#### Run All v0.3.17 Tests
```bash
dotnet test --filter "FullyQualifiedName~DebugConsoleServiceTests|FullyQualifiedName~CheatServiceTests"
```

---

### Usage Examples

#### God Mode Toggle
```
> ~
[DEBUG CONSOLE]
═══════════════════════════════════════════════════════════
[12:34:56] [System] Debug Console activated. Type 'help' for commands, '~' to exit.

> /god
[12:35:02] [User] /god
[12:35:02] [Cheat] God Mode: ON

> /god
[12:35:10] [User] /god
[12:35:10] [Cheat] God Mode: OFF
```

**God Mode Active - Combat Scenario:**
```
[Combat Phase]
> attack
Enemy "Draugr Sentinel" attacks you with Heavy attack.
[AttackResolutionService logs: "[Combat] God Mode active - damage negated (18 -> 0)"]

You take 0 damage (18 negated by God Mode).

Your turn.
```

---

#### Full Heal Command
```
> /heal
[12:36:05] [User] /heal
[12:36:05] [Cheat] Character fully healed: HP=100, Stamina=60, AP=10

[Status effects cleared: Bleeding, Poisoned]
[Stress reset to 0]
```

**No Active Character Error:**
```
> /heal
[12:37:00] [User] /heal
[12:37:00] [Error] No active character.
```

---

#### Teleport Command (GUID Match)
```
> /tp 3fa85f64-5717-4562-b3fc-2c963f66afa6
[12:38:12] [User] /tp 3fa85f64-5717-4562-b3fc-2c963f66afa6
[12:38:12] [Cheat] Teleported to: The Sunken Archive (GUID match)

[Exploration Phase updates to show new room]
```

**Teleport by Partial Name:**
```
> /tp sunken
[12:39:01] [User] /tp sunken
[12:39:01] [Cheat] Teleported to: The Sunken Archive (name match)
```

**Teleport Not Found:**
```
> /tp nonexistent
[12:40:05] [User] /tp nonexistent
[12:40:05] [Error] Room not found: nonexistent
```

**Teleport Missing Argument:**
```
> /tp
[12:41:00] [User] /tp
[12:41:00] [Error] Usage: /tp <room-id or name>
```

---

#### Reveal Map Command
```
> /reveal
[12:42:30] [User] /reveal
[12:42:30] [Cheat] Revealed 12 rooms.

[Minimap now shows all rooms (fog of war cleared)]
```

**Reveal with Partial Coverage:**
```
> /reveal
[12:43:15] [User] /reveal
[12:43:15] [Cheat] Revealed 5 rooms.

[Only 5 new rooms revealed; 7 were already visited]
```

**Reveal All Already Visited:**
```
> /reveal
[12:44:00] [User] /reveal
[12:44:00] [Cheat] Revealed 0 rooms.
```

---

#### Spawn Command (Not Yet Implemented)
```
> /spawn health_potion 5
[12:45:10] [User] /spawn health_potion 5
[12:45:10] [Error] Spawn not yet implemented.
```

---

#### Help Command (Updated for v0.3.17b)
```
> help
[12:46:00] [User] help
[12:46:00] [System] Console commands:
[12:46:00] [System]   help   - Show this help
[12:46:00] [System]   clear  - Clear console log
[12:46:00] [System]   exit/~ - Close console
[12:46:00] [System]
[12:46:00] [System] Cheat commands (/ prefix):
[12:46:00] [System]   /god    - Toggle invincibility
[12:46:00] [System]   /heal   - Restore HP/Stamina/AP
[12:46:00] [System]   /tp X   - Teleport to room (GUID or name)
[12:46:00] [System]   /reveal - Reveal all map rooms
```

---

#### Unknown Cheat Command
```
> /fly
[12:47:00] [User] /fly
[12:47:00] [Error] Unknown cheat: /fly
```

---

## Next Steps

### v0.3.18 - The Architect (Emergency Save Enhancement)

- **Persist God Mode State**: Add IsGodMode to EmergencySavePayload for crash recovery continuity
- **Crash Report Integration**: Include last cheat command executed in crash reports for debugging
- **Debug Console Log Buffer**: Write last 50 console log entries to crash report
- **Auto-Open Console on Crash**: Modify CrashService to auto-open debug console on unhandled exceptions

### v0.3.19 - The Inspector (Advanced Debug Tools)

- **Spawn Command Implementation**: Complete SpawnItemAsync with IItemRepository lookup and inventory injection
- **Stats Inspector**: Add /stats command showing current character attributes, stress, corruption
- **Combat Log Replay**: Add /combatlog command to display last 20 combat events from CombatService
- **Time Manipulation**: Add /advance <turns> command to fast-forward game time for testing long-term effects
- **Save State Inspector**: Add /saveslots command to list all save games with metadata

---

**End of Changelog v0.3.17**
