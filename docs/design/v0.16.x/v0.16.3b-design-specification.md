# v0.16.3b Design Specification: Smart Loot Algorithm

**Version:** 0.16.3b  
**Phase Name:** Smart Loot Algorithm  
**Parent Version:** v0.16.3 (Smart Loot Generation)  
**Prerequisites:** v0.16.3a Complete (Equipment Class Mapping)  
**Estimated Tests:** ~3 unit tests

---

## Table of Contents

1. [Executive Summary](#1-executive-summary)
2. [Feature Overview](#2-feature-overview)
3. [Architecture Diagrams](#3-architecture-diagrams)
4. [SmartLootContext Value Object](#4-smartlootcontext-value-object)
5. [SmartLootResult Value Object](#5-smartlootresult-value-object)
6. [ISmartLootService Interface](#6-ismartlootservice-interface)
7. [Smart Loot Algorithm](#7-smart-loot-algorithm)
8. [Data Model Changes](#8-data-model-changes)
9. [Logging Specifications](#9-logging-specifications)
10. [Unit Testing Requirements](#10-unit-testing-requirements)
11. [Use Cases](#11-use-cases)
12. [Deliverable Checklist](#12-deliverable-checklist)
13. [Acceptance Criteria](#13-acceptance-criteria)
14. [Dependencies](#14-dependencies)
15. [Future Considerations](#15-future-considerations)

---

## 1. Executive Summary

### 1.1 Purpose

This specification defines the smart loot algorithm that biases 60% of drops toward class-appropriate equipment. This system reduces player frustration from receiving unusable gear while maintaining 40% random drops for experimentation, companion gearing, or trading.

The core algorithm:

1. Roll 0-99
2. If roll < 60: Filter for player's class-appropriate items
3. If class items found: Select from filtered pool
4. Otherwise (40% OR no class items): Select from all items of quality tier

This phase defines the context and result structures plus the service interface. The actual weighted selection (v0.16.3c) and LootService integration (v0.16.3d) are separate phases.

### 1.2 Key Deliverables

| Category          | Items                                 |
| ----------------- | ------------------------------------- |
| **Value Objects** | `SmartLootContext`, `SmartLootResult` |
| **Interfaces**    | `ISmartLootService`                   |
| **Tests**         | ~3 unit tests                         |

### 1.3 Architectural Significance

This version establishes the **Smart Loot Pattern**:

- **Context Object Pattern**: `SmartLootContext` encapsulates all inputs for loot generation
- **Result Object Pattern**: `SmartLootResult` provides rich output with metadata
- **60/40 Bias Rule**: Configurable class-appropriate bias with random fallback
- **Service Abstraction**: `ISmartLootService` enables testing and future enhancements

---

## 2. Feature Overview

```
v0.16.3b Smart Loot Algorithm
├── SmartLootContext Value Object
│   ├── PlayerArchetypeId: string (e.g., "warrior", "mystic")
│   ├── QualityTier: QualityTier (from v0.16.0)
│   ├── AvailableItems: IReadOnlyList<LootEntry>
│   ├── BiasPercentage: int (default 60)
│   └── RandomSeed: int? (optional for testing)
├── SmartLootResult Value Object
│   ├── SelectedItem: LootEntry?
│   ├── WasClassAppropriate: bool
│   ├── BiasRoll: int (0-99)
│   ├── FilteredPoolSize: int
│   ├── TotalPoolSize: int
│   └── SelectionReason: string
├── ISmartLootService Interface
│   ├── SelectItem(context): SmartLootResult
│   ├── FilterClassAppropriateItems(items, archetypeId): IReadOnlyList<LootEntry>
│   └── CalculateBiasResult(roll, biasPercentage): bool
└── Algorithm Logic
    ├── Roll random 0-99
    ├── If roll < bias (60): Try class-appropriate
    ├── Filter items by affinity
    ├── Fallback to random if no class items
    └── Return result with metadata
```

### 2.1 Scope Alignment

**In Scope:**

- `SmartLootContext` value object with generation parameters
- `SmartLootResult` value object with selection metadata
- `ISmartLootService` interface for smart selection
- 60% class-appropriate bias algorithm logic
- Fallback to random when no class items available

**Out of Scope:**

- Weighted item selection algorithm (v0.16.3c)
- LootService integration (v0.16.3d)
- Stat verification service (v0.16.3e)

---

## 3. Architecture Diagrams

### 3.1 Smart Loot System Overview

```
┌─────────────────────────────────────────────────────────────────────┐
│                  SMART LOOT SYSTEM OVERVIEW                          │
└─────────────────────────────────────────────────────────────────────┘

    Monster Death / Container Open
           │
           │  Generate loot request
           ▼
┌─────────────────────────────────────────────────────────────────────┐
│                       SmartLootContext                               │
├─────────────────────────────────────────────────────────────────────┤
│  PlayerArchetypeId: string      (e.g., "warrior")                   │
│  QualityTier: QualityTier       (e.g., ClanForged)                  │
│  AvailableItems: List<LootEntry> (items to select from)             │
│  BiasPercentage: int            (default 60)                        │
│  RandomSeed: int?               (optional, for testing)             │
└─────────────────────────────────────────────────────────────────────┘
           │
           │  Pass to service
           ▼
┌─────────────────────────────────────────────────────────────────────┐
│                      ISmartLootService                               │
├─────────────────────────────────────────────────────────────────────┤
│  + SelectItem(context): SmartLootResult                             │
│  + FilterClassAppropriateItems(items, archetypeId): List<LootEntry> │
│  + CalculateBiasResult(roll, biasPercentage): bool                  │
└─────────────────────────────────────────────────────────────────────┘
           │
           │  Returns result
           ▼
┌─────────────────────────────────────────────────────────────────────┐
│                       SmartLootResult                                │
├─────────────────────────────────────────────────────────────────────┤
│  SelectedItem: LootEntry?       (the selected item, or null)        │
│  WasClassAppropriate: bool      (true if from filtered pool)        │
│  BiasRoll: int                  (the 0-99 roll for debugging)       │
│  FilteredPoolSize: int          (class-appropriate items count)     │
│  TotalPoolSize: int             (all available items count)         │
│  SelectionReason: string        (e.g., "Class-appropriate bias")    │
└─────────────────────────────────────────────────────────────────────┘
```

### 3.2 Smart Loot Algorithm Decision Tree

```
┌─────────────────────────────────────────────────────────────────────┐
│               SMART LOOT ALGORITHM DECISION TREE                     │
└─────────────────────────────────────────────────────────────────────┘

    SelectItem(context) Called
           │
           ▼
    ┌──────────────────────────────────────────────────────────────────┐
    │  STEP 1: VALIDATE INPUTS                                         │
    ├──────────────────────────────────────────────────────────────────┤
    │  AvailableItems empty?                                           │
    │    → Return SmartLootResult.Empty                                │
    │                                                                  │
    │  PlayerArchetypeId null/empty?                                   │
    │    → Use random selection only (no bias)                         │
    └──────────────────────────────────────────────────────────────────┘
           │
           ▼
    ┌──────────────────────────────────────────────────────────────────┐
    │  STEP 2: ROLL FOR BIAS                                           │
    ├──────────────────────────────────────────────────────────────────┤
    │  Roll random 0-99                                                │
    │                                                                  │
    │  roll < BiasPercentage (default 60)?                             │
    │    ├─ YES → Go to STEP 3 (class filtering)                       │
    │    └─ NO  → Go to STEP 5 (random selection)                      │
    └──────────────────────────────────────────────────────────────────┘
           │
           ▼ (roll < 60)
    ┌──────────────────────────────────────────────────────────────────┐
    │  STEP 3: FILTER CLASS-APPROPRIATE ITEMS                          │
    ├──────────────────────────────────────────────────────────────────┤
    │  For each item in AvailableItems:                                │
    │    Get EquipmentClassMapping for item.CategoryId                 │
    │    Check if mapping.IsAppropriateFor(archetypeId)                │
    │    If true: Add to filteredPool                                  │
    │                                                                  │
    │  Include Universal items always                                  │
    └──────────────────────────────────────────────────────────────────┘
           │
           ▼
    ┌──────────────────────────────────────────────────────────────────┐
    │  STEP 4: CHECK FILTERED POOL                                     │
    ├──────────────────────────────────────────────────────────────────┤
    │  filteredPool.Count > 0?                                         │
    │    ├─ YES → Select from filteredPool                             │
    │    │        WasClassAppropriate = true                           │
    │    │        SelectionReason = "Class-appropriate bias"           │
    │    │                                                             │
    │    └─ NO  → Fall through to STEP 5                               │
    │             SelectionReason = "No class items, random fallback"  │
    └──────────────────────────────────────────────────────────────────┘
           │
           ▼ (roll >= 60 OR no class items)
    ┌──────────────────────────────────────────────────────────────────┐
    │  STEP 5: RANDOM SELECTION                                        │
    ├──────────────────────────────────────────────────────────────────┤
    │  Select from all AvailableItems                                  │
    │  WasClassAppropriate = false (unless item happens to match)      │
    │  SelectionReason = "Random selection (40% chance)"               │
    └──────────────────────────────────────────────────────────────────┘
           │
           ▼
    ┌──────────────────────────────────────────────────────────────────┐
    │  STEP 6: RETURN RESULT                                           │
    ├──────────────────────────────────────────────────────────────────┤
    │  Return SmartLootResult with:                                    │
    │    - SelectedItem                                                │
    │    - WasClassAppropriate                                         │
    │    - BiasRoll                                                    │
    │    - FilteredPoolSize                                            │
    │    - TotalPoolSize                                               │
    │    - SelectionReason                                             │
    └──────────────────────────────────────────────────────────────────┘
```

### 3.3 Bias Distribution Visualization

```
┌─────────────────────────────────────────────────────────────────────┐
│                   BIAS DISTRIBUTION (60/40 SPLIT)                    │
└─────────────────────────────────────────────────────────────────────┘

    Roll Range: 0-99

    ├────────────────────────────────────────┬────────────────────────┤
    │          CLASS-APPROPRIATE (60%)        │     RANDOM (40%)       │
    │              Rolls 0-59                 │     Rolls 60-99        │
    ├────────────────────────────────────────┴────────────────────────┤
    │████████████████████████████████████████░░░░░░░░░░░░░░░░░░░░░░░░│
    │ 0    10    20    30    40    50   60   70    80    90    99    │
    └─────────────────────────────────────────────────────────────────┘

    EXPECTED DISTRIBUTION (over 1000 drops for a Warrior):

    ┌─────────────────────────────────────────────────────────────────┐
    │  ~600 drops (60%): Class-appropriate pool                       │
    │    - Axes (Warrior affinity)                                    │
    │    - Greatswords (Warrior affinity)                             │
    │    - Hammers (Warrior affinity)                                 │
    │    - Heavy Armor (Warrior affinity)                             │
    │    - Light Armor (Universal - always included)                  │
    │    - Accessories (Universal - always included)                  │
    │                                                                 │
    │  ~400 drops (40%): Random pool (all items)                      │
    │    - Any weapon category                                        │
    │    - Any armor category                                         │
    │    - Any accessory                                              │
    └─────────────────────────────────────────────────────────────────┘
```

### 3.4 Layer Diagram

```
┌─────────────────────────────────────────────────────────────────────┐
│                        PRESENTATION LAYER                            │
├─────────────────────────────────────────────────────────────────────┤
│  LootDropNotification                                                │
│  └── Shows "Class Appropriate!" indicator based on result           │
│                                                                      │
│  LootLog                                                             │
│  └── Records WasClassAppropriate for statistics                     │
└───────┬─────────────────────────────────────────────────────────────┘
        │
        ▼
┌─────────────────────────────────────────────────────────────────────┐
│                       APPLICATION LAYER                              │
├─────────────────────────────────────────────────────────────────────┤
│  ┌───────────────────────────────────────────────────────────────┐  │
│  │                   SmartLootService                             │  │
│  │              (implements ISmartLootService)                    │  │
│  ├───────────────────────────────────────────────────────────────┤  │
│  │  + SelectItem(context): SmartLootResult                       │  │
│  │  + FilterClassAppropriateItems(items, archetype): List        │  │
│  │  + CalculateBiasResult(roll, biasPercent): bool               │  │
│  │                                                               │  │
│  │  Dependencies:                                                │  │
│  │  - IEquipmentClassMappingProvider (from v0.16.3a)             │  │
│  │  - ILogger<SmartLootService>                                  │  │
│  │  - Random (or injected for testing)                           │  │
│  └───────────────────────────────────────────────────────────────┘  │
│                                                                      │
│  Uses from v0.16.3a:                                                 │
│  ┌─────────────────────────────────────────────────────────────┐    │
│  │  IEquipmentClassMappingProvider                              │    │
│  │  └── IsClassAppropriate(categoryId, archetypeId): bool       │    │
│  └─────────────────────────────────────────────────────────────┘    │
└───────┬─────────────────────────────────────────────────────────────┘
        │
        ▼
┌─────────────────────────────────────────────────────────────────────┐
│                         DOMAIN LAYER                                 │
├─────────────────────────────────────────────────────────────────────┤
│  ┌─────────────────────────┐  ┌────────────────────────────────┐   │
│  │    SmartLootContext     │  │      SmartLootResult           │   │
│  │     (Value Object)      │  │      (Value Object)            │   │
│  ├─────────────────────────┤  ├────────────────────────────────┤   │
│  │ PlayerArchetypeId       │  │ SelectedItem: LootEntry?       │   │
│  │ QualityTier             │  │ WasClassAppropriate: bool      │   │
│  │ AvailableItems          │  │ BiasRoll: int                  │   │
│  │ BiasPercentage          │  │ FilteredPoolSize: int          │   │
│  │ RandomSeed              │  │ TotalPoolSize: int             │   │
│  └─────────────────────────┘  │ SelectionReason: string        │   │
│                               └────────────────────────────────┘   │
│                                                                      │
│  Uses from v0.16.0:                                                 │
│  ┌────────────────────┐                                             │
│  │    QualityTier     │                                             │
│  │      (Enum)        │                                             │
│  └────────────────────┘                                             │
└─────────────────────────────────────────────────────────────────────┘
```

---

## 4. SmartLootContext Value Object

### 4.1 Purpose

The `SmartLootContext` value object encapsulates all inputs required for smart loot selection, enabling clean service interfaces and testability.

### 4.2 Implementation

**File:** `src/Core/RuneAndRust.Domain/ValueObjects/SmartLootContext.cs`

```csharp
namespace RuneAndRust.Domain.ValueObjects;

using RuneAndRust.Domain.Enums;

/// <summary>
/// Encapsulates context for smart loot selection.
/// </summary>
/// <remarks>
/// <para>
/// SmartLootContext provides all inputs needed for the smart loot algorithm:
/// the player's archetype, the quality tier for drops, available items,
/// and optional configuration for bias percentage and random seeding.
/// </para>
/// <para>
/// The BiasPercentage defaults to 60, meaning 60% of drops will attempt
/// to be class-appropriate before falling back to random selection.
/// </para>
/// </remarks>
/// <param name="PlayerArchetypeId">The player's archetype (e.g., "warrior", "mystic"). Null for random-only.</param>
/// <param name="QualityTier">The quality tier for filtering items.</param>
/// <param name="AvailableItems">The pool of items to select from.</param>
/// <param name="BiasPercentage">Percentage chance for class-appropriate selection (default 60).</param>
/// <param name="RandomSeed">Optional seed for deterministic testing.</param>
public readonly record struct SmartLootContext(
    string? PlayerArchetypeId,
    QualityTier QualityTier,
    IReadOnlyList<LootEntry> AvailableItems,
    int BiasPercentage = 60,
    int? RandomSeed = null)
{
    /// <summary>
    /// Default bias percentage for class-appropriate drops.
    /// </summary>
    public const int DefaultBiasPercentage = 60;

    /// <summary>
    /// Gets whether a player archetype is specified.
    /// </summary>
    public bool HasPlayerArchetype => !string.IsNullOrWhiteSpace(PlayerArchetypeId);

    /// <summary>
    /// Gets whether items are available for selection.
    /// </summary>
    public bool HasAvailableItems => AvailableItems?.Count > 0;

    /// <summary>
    /// Gets the normalized archetype ID (lowercase).
    /// </summary>
    public string? NormalizedArchetypeId => PlayerArchetypeId?.ToLowerInvariant();

    /// <summary>
    /// Gets the count of available items.
    /// </summary>
    public int AvailableItemCount => AvailableItems?.Count ?? 0;

    /// <summary>
    /// Creates a SmartLootContext with validation.
    /// </summary>
    public static SmartLootContext Create(
        string? playerArchetypeId,
        QualityTier qualityTier,
        IReadOnlyList<LootEntry> availableItems,
        int biasPercentage = DefaultBiasPercentage,
        int? randomSeed = null)
    {
        ArgumentNullException.ThrowIfNull(availableItems);
        ArgumentOutOfRangeException.ThrowIfNegative(biasPercentage);
        ArgumentOutOfRangeException.ThrowIfGreaterThan(biasPercentage, 100);

        return new SmartLootContext(
            playerArchetypeId,
            qualityTier,
            availableItems,
            biasPercentage,
            randomSeed);
    }

    /// <summary>
    /// Creates a context for random-only selection (no class bias).
    /// </summary>
    public static SmartLootContext CreateRandomOnly(
        QualityTier qualityTier,
        IReadOnlyList<LootEntry> availableItems) =>
        new(null, qualityTier, availableItems, 0, null);

    /// <summary>
    /// Creates a context for testing with a fixed seed.
    /// </summary>
    public static SmartLootContext CreateForTesting(
        string playerArchetypeId,
        QualityTier qualityTier,
        IReadOnlyList<LootEntry> availableItems,
        int randomSeed,
        int biasPercentage = DefaultBiasPercentage) =>
        new(playerArchetypeId, qualityTier, availableItems, biasPercentage, randomSeed);

    /// <summary>
    /// Creates a display string for debug/logging.
    /// </summary>
    public override string ToString() =>
        $"SmartLootContext: Archetype={PlayerArchetypeId ?? "None"}, " +
        $"Tier={QualityTier}, Items={AvailableItemCount}, Bias={BiasPercentage}%";
}
```

---

## 5. SmartLootResult Value Object

### 5.1 Purpose

The `SmartLootResult` value object provides rich output from smart loot selection, including the selected item, whether it was class-appropriate, and diagnostic metadata.

### 5.2 Implementation

**File:** `src/Core/RuneAndRust.Domain/ValueObjects/SmartLootResult.cs`

```csharp
namespace RuneAndRust.Domain.ValueObjects;

/// <summary>
/// Contains the result of smart loot selection.
/// </summary>
/// <remarks>
/// <para>
/// SmartLootResult provides comprehensive output from the smart loot algorithm,
/// including the selected item, whether it matched the player's class, and
/// diagnostic information for logging and statistics.
/// </para>
/// </remarks>
/// <param name="SelectedItem">The selected loot entry, or null if no selection.</param>
/// <param name="WasClassAppropriate">True if selected from class-filtered pool.</param>
/// <param name="BiasRoll">The random roll (0-99) used for bias determination.</param>
/// <param name="FilteredPoolSize">Count of class-appropriate items available.</param>
/// <param name="TotalPoolSize">Count of all items in the pool.</param>
/// <param name="SelectionReason">Human-readable explanation of selection.</param>
public readonly record struct SmartLootResult(
    LootEntry? SelectedItem,
    bool WasClassAppropriate,
    int BiasRoll,
    int FilteredPoolSize,
    int TotalPoolSize,
    string SelectionReason)
{
    /// <summary>
    /// Gets an empty result (no item selected).
    /// </summary>
    public static SmartLootResult Empty => new(
        null, false, -1, 0, 0, "No items available");

    /// <summary>
    /// Gets whether an item was selected.
    /// </summary>
    public bool HasSelection => SelectedItem != null;

    /// <summary>
    /// Gets whether the bias roll favored class-appropriate selection.
    /// </summary>
    public bool BiasRollFavoredClass => BiasRoll >= 0 && BiasRoll < 60;

    /// <summary>
    /// Gets the percentage of class-appropriate items in the pool.
    /// </summary>
    public double FilteredPoolPercentage =>
        TotalPoolSize > 0 ? (double)FilteredPoolSize / TotalPoolSize * 100 : 0;

    /// <summary>
    /// Creates a result for class-appropriate selection.
    /// </summary>
    public static SmartLootResult CreateClassAppropriate(
        LootEntry item,
        int biasRoll,
        int filteredPoolSize,
        int totalPoolSize) =>
        new(item, true, biasRoll, filteredPoolSize, totalPoolSize,
            "Class-appropriate bias selection");

    /// <summary>
    /// Creates a result for random selection (40% path).
    /// </summary>
    public static SmartLootResult CreateRandom(
        LootEntry item,
        int biasRoll,
        int filteredPoolSize,
        int totalPoolSize) =>
        new(item, false, biasRoll, filteredPoolSize, totalPoolSize,
            "Random selection (40% chance)");

    /// <summary>
    /// Creates a result for fallback when no class items exist.
    /// </summary>
    public static SmartLootResult CreateFallback(
        LootEntry item,
        int biasRoll,
        int totalPoolSize) =>
        new(item, false, biasRoll, 0, totalPoolSize,
            "No class-appropriate items, random fallback");

    /// <summary>
    /// Creates a result for random-only mode (no archetype specified).
    /// </summary>
    public static SmartLootResult CreateRandomOnly(
        LootEntry item,
        int totalPoolSize) =>
        new(item, false, -1, 0, totalPoolSize,
            "Random selection (no archetype specified)");

    /// <summary>
    /// Creates a display string for debug/logging.
    /// </summary>
    public override string ToString() =>
        HasSelection
            ? $"SmartLootResult: {SelectedItem!.ItemId} (ClassAppropriate={WasClassAppropriate}, " +
              $"Roll={BiasRoll}, Pool={FilteredPoolSize}/{TotalPoolSize})"
            : $"SmartLootResult: Empty ({SelectionReason})";
}
```

---

## 6. ISmartLootService Interface

### 6.1 Purpose

The `ISmartLootService` interface defines the contract for smart loot selection, abstracting the algorithm for testability and future enhancements.

### 6.2 Implementation

**File:** `src/Core/RuneAndRust.Application/Interfaces/ISmartLootService.cs`

```csharp
namespace RuneAndRust.Application.Interfaces;

using RuneAndRust.Domain.ValueObjects;

/// <summary>
/// Provides smart loot selection with class-appropriate bias.
/// </summary>
/// <remarks>
/// <para>
/// The smart loot service implements a 60/40 bias algorithm: 60% of the time,
/// drops are selected from class-appropriate items; 40% of the time, drops
/// are fully random.
/// </para>
/// <para>
/// If no class-appropriate items exist when the bias roll succeeds, the
/// service falls back to random selection from the entire pool.
/// </para>
/// </remarks>
public interface ISmartLootService
{
    /// <summary>
    /// Selects an item using smart loot algorithm.
    /// </summary>
    /// <param name="context">The selection context with archetype, tier, and available items.</param>
    /// <returns>A result containing the selected item and metadata.</returns>
    SmartLootResult SelectItem(SmartLootContext context);

    /// <summary>
    /// Filters items to only those appropriate for an archetype.
    /// </summary>
    /// <param name="items">The full list of available items.</param>
    /// <param name="archetypeId">The player's archetype ID.</param>
    /// <returns>Items with matching affinity or Universal affinity.</returns>
    IReadOnlyList<LootEntry> FilterClassAppropriateItems(
        IReadOnlyList<LootEntry> items,
        string archetypeId);

    /// <summary>
    /// Determines if a roll results in class-appropriate bias.
    /// </summary>
    /// <param name="roll">The random roll (0-99).</param>
    /// <param name="biasPercentage">The bias threshold (default 60).</param>
    /// <returns>True if roll falls within bias range.</returns>
    bool CalculateBiasResult(int roll, int biasPercentage);

    /// <summary>
    /// Gets statistics for smart loot operations.
    /// </summary>
    /// <returns>Current session statistics.</returns>
    SmartLootStatistics GetStatistics();

    /// <summary>
    /// Resets session statistics.
    /// </summary>
    void ResetStatistics();
}

/// <summary>
/// Statistics for smart loot operations.
/// </summary>
/// <param name="TotalSelections">Total items selected.</param>
/// <param name="ClassAppropriateSelections">Count of class-appropriate selections.</param>
/// <param name="RandomSelections">Count of random selections.</param>
/// <param name="FallbackSelections">Count of fallback selections (no class items).</param>
public readonly record struct SmartLootStatistics(
    int TotalSelections,
    int ClassAppropriateSelections,
    int RandomSelections,
    int FallbackSelections)
{
    /// <summary>
    /// Gets the class-appropriate selection percentage.
    /// </summary>
    public double ClassAppropriatePercentage =>
        TotalSelections > 0
            ? (double)ClassAppropriateSelections / TotalSelections * 100
            : 0;

    /// <summary>
    /// Gets an empty statistics instance.
    /// </summary>
    public static SmartLootStatistics Empty => new(0, 0, 0, 0);
}
```

### 6.3 Usage Examples

```csharp
// Create context for a Warrior
var context = SmartLootContext.Create(
    playerArchetypeId: "warrior",
    qualityTier: QualityTier.ClanForged,
    availableItems: lootPool);

// Select an item using smart loot
var result = _smartLootService.SelectItem(context);

if (result.HasSelection)
{
    Console.WriteLine($"Selected: {result.SelectedItem!.ItemId}");
    Console.WriteLine($"Class Appropriate: {result.WasClassAppropriate}");
    Console.WriteLine($"Reason: {result.SelectionReason}");
}

// Get session statistics
var stats = _smartLootService.GetStatistics();
Console.WriteLine($"Class-appropriate rate: {stats.ClassAppropriatePercentage:F1}%");
```

---

## 7. Smart Loot Algorithm

### 7.1 Algorithm Pseudocode

```
FUNCTION SelectItem(context: SmartLootContext) -> SmartLootResult:

    // Step 1: Validate inputs
    IF context.AvailableItems is empty:
        RETURN SmartLootResult.Empty

    totalPoolSize = context.AvailableItems.Count

    // Step 2: Handle no-archetype case (random only)
    IF context.PlayerArchetypeId is null or empty:
        item = SelectRandomItem(context.AvailableItems)
        RETURN SmartLootResult.CreateRandomOnly(item, totalPoolSize)

    // Step 3: Roll for bias (0-99)
    roll = Random.Next(0, 100)  // Uses RandomSeed if provided

    // Step 4: Determine selection path
    IF roll < context.BiasPercentage (default 60):
        // Try class-appropriate selection
        filteredItems = FilterClassAppropriateItems(
            context.AvailableItems,
            context.PlayerArchetypeId)

        IF filteredItems.Count > 0:
            item = SelectRandomItem(filteredItems)
            RETURN SmartLootResult.CreateClassAppropriate(
                item, roll, filteredItems.Count, totalPoolSize)
        ELSE:
            // Fallback: no class items available
            item = SelectRandomItem(context.AvailableItems)
            RETURN SmartLootResult.CreateFallback(
                item, roll, totalPoolSize)
    ELSE:
        // Random selection (40% path)
        filteredItems = FilterClassAppropriateItems(
            context.AvailableItems,
            context.PlayerArchetypeId)

        item = SelectRandomItem(context.AvailableItems)
        RETURN SmartLootResult.CreateRandom(
            item, roll, filteredItems.Count, totalPoolSize)

FUNCTION FilterClassAppropriateItems(items, archetypeId) -> List<LootEntry>:
    result = []
    FOR each item in items:
        mapping = mappingProvider.GetMapping(item.CategoryId)
        IF mapping.IsAppropriateFor(archetypeId):
            result.Add(item)
    RETURN result

FUNCTION SelectRandomItem(items) -> LootEntry:
    // Note: Weighted selection is v0.16.3c
    // This phase uses simple random
    index = Random.Next(0, items.Count)
    RETURN items[index]
```

### 7.2 Bias Calculation

```
┌─────────────────────────────────────────────────────────────────────┐
│                    BIAS CALCULATION EXAMPLES                         │
└─────────────────────────────────────────────────────────────────────┘

Example 1: Roll = 35, Bias = 60
─────────────────────────────────────
  35 < 60 = TRUE → Class-appropriate path
  If class items exist: Select from filtered pool
  WasClassAppropriate = true

Example 2: Roll = 72, Bias = 60
─────────────────────────────────────
  72 < 60 = FALSE → Random path
  Select from full pool
  WasClassAppropriate = false

Example 3: Roll = 15, Bias = 60, No class items
─────────────────────────────────────
  15 < 60 = TRUE → Class-appropriate path
  filteredPool.Count = 0 → Fallback to random
  SelectionReason = "No class-appropriate items, random fallback"
  WasClassAppropriate = false

Example 4: Custom bias = 80
─────────────────────────────────────
  Roll < 80 → 80% chance of class-appropriate
  Roll >= 80 → 20% chance of random
```

---

## 8. Data Model Changes

### 8.1 New Types Summary

| Type                  | Layer       | Category     | Description                      |
| --------------------- | ----------- | ------------ | -------------------------------- |
| `SmartLootContext`    | Domain      | Value Object | Selection input parameters       |
| `SmartLootResult`     | Domain      | Value Object | Selection output with metadata   |
| `SmartLootStatistics` | Application | Value Object | Session statistics tracking      |
| `ISmartLootService`   | Application | Interface    | Smart selection service contract |

### 8.2 File Locations

```
src/Core/RuneAndRust.Domain/
└── ValueObjects/
    ├── SmartLootContext.cs                    ← NEW
    └── SmartLootResult.cs                     ← NEW

src/Core/RuneAndRust.Application/
└── Interfaces/
    └── ISmartLootService.cs                   ← NEW
```

### 8.3 Dependencies on Existing Types

```
SmartLootContext
    └── Uses: QualityTier (v0.16.0), LootEntry (existing)

SmartLootResult
    └── Uses: LootEntry (existing)

ISmartLootService (implementation)
    └── Uses: IEquipmentClassMappingProvider (v0.16.3a)
```

---

## 9. Logging Specifications

### 9.1 Log Levels by Component

| Component          | Level       | Events                                |
| ------------------ | ----------- | ------------------------------------- |
| `SmartLootService` | Information | Item selected, statistics summary     |
| `SmartLootService` | Debug       | Bias roll, pool sizes, selection path |
| `SmartLootService` | Warning     | Empty pool, unknown category          |
| `SmartLootService` | Error       | Selection failure, invalid context    |

### 9.2 Log Message Templates

```csharp
// Information - Item selected
_logger.LogInformation(
    "Smart loot selected {ItemId} for {Archetype} (ClassAppropriate={IsAppropriate}, Roll={Roll})",
    result.SelectedItem?.ItemId, context.PlayerArchetypeId,
    result.WasClassAppropriate, result.BiasRoll);

// Debug - Selection path
_logger.LogDebug(
    "Smart loot bias roll {Roll} (threshold {Bias}%): {Path}",
    roll, context.BiasPercentage,
    roll < context.BiasPercentage ? "Class-appropriate" : "Random");

// Debug - Pool sizes
_logger.LogDebug(
    "Smart loot pools: Filtered={FilteredCount}/{TotalCount} for archetype {Archetype}",
    filteredItems.Count, context.AvailableItemCount, context.PlayerArchetypeId);

// Warning - Empty pool
_logger.LogWarning(
    "Smart loot called with empty item pool for archetype {Archetype}",
    context.PlayerArchetypeId);

// Warning - Fallback triggered
_logger.LogWarning(
    "No class-appropriate items for {Archetype}, falling back to random selection",
    context.PlayerArchetypeId);
```

---

## 10. Unit Testing Requirements

### 10.1 Test Count by Feature

| Feature           | Test Count |
| ----------------- | ---------- |
| SmartLootContext  | ~1         |
| SmartLootResult   | ~1         |
| ISmartLootService | ~1         |
| **Total**         | **~3**     |

### 10.2 Test Specifications

**File:** `tests/RuneAndRust.Domain.UnitTests/ValueObjects/SmartLootContextTests.cs`

```csharp
[TestFixture]
public class SmartLootContextTests
{
    [Test]
    public void Create_WithValidParameters_ReturnsCorrectContext()
    {
        // Arrange
        var items = new List<LootEntry>
        {
            new LootEntry("axe-01", "Hand Axe", "axes"),
            new LootEntry("dagger-01", "Knife", "daggers")
        };

        // Act
        var context = SmartLootContext.Create(
            "warrior",
            QualityTier.ClanForged,
            items,
            biasPercentage: 60);

        // Assert
        context.PlayerArchetypeId.Should().Be("warrior");
        context.QualityTier.Should().Be(QualityTier.ClanForged);
        context.AvailableItemCount.Should().Be(2);
        context.BiasPercentage.Should().Be(60);
        context.HasPlayerArchetype.Should().BeTrue();
        context.HasAvailableItems.Should().BeTrue();
    }

    [Test]
    public void CreateRandomOnly_SetsZeroBias()
    {
        // Arrange
        var items = new List<LootEntry> { new LootEntry("item-01", "Item", "misc") };

        // Act
        var context = SmartLootContext.CreateRandomOnly(QualityTier.Scavenged, items);

        // Assert
        context.HasPlayerArchetype.Should().BeFalse();
        context.BiasPercentage.Should().Be(0);
    }
}
```

**File:** `tests/RuneAndRust.Domain.UnitTests/ValueObjects/SmartLootResultTests.cs`

```csharp
[TestFixture]
public class SmartLootResultTests
{
    [Test]
    public void CreateClassAppropriate_SetsCorrectFlags()
    {
        // Arrange
        var item = new LootEntry("axe-01", "Hand Axe", "axes");

        // Act
        var result = SmartLootResult.CreateClassAppropriate(
            item, biasRoll: 35, filteredPoolSize: 5, totalPoolSize: 20);

        // Assert
        result.HasSelection.Should().BeTrue();
        result.WasClassAppropriate.Should().BeTrue();
        result.BiasRoll.Should().Be(35);
        result.BiasRollFavoredClass.Should().BeTrue();
        result.FilteredPoolSize.Should().Be(5);
        result.TotalPoolSize.Should().Be(20);
        result.SelectionReason.Should().Contain("Class-appropriate");
    }

    [Test]
    public void Empty_HasNoSelection()
    {
        // Act
        var result = SmartLootResult.Empty;

        // Assert
        result.HasSelection.Should().BeFalse();
        result.SelectedItem.Should().BeNull();
        result.SelectionReason.Should().Contain("No items");
    }
}
```

**File:** `tests/RuneAndRust.Application.UnitTests/Services/SmartLootServiceTests.cs`

```csharp
[TestFixture]
public class SmartLootServiceTests
{
    [Test]
    public void SelectItem_WithBiasRollUnder60_SelectsFromClassAppropriatePool()
    {
        // Arrange
        var mockMappingProvider = CreateMockMappingProvider();
        var service = new SmartLootService(mockMappingProvider, Mock.Of<ILogger>());

        var items = CreateMixedItemPool(); // Warrior and Mystic items
        var context = SmartLootContext.CreateForTesting(
            "warrior", QualityTier.ClanForged, items,
            randomSeed: 42, biasPercentage: 60);  // Seed produces roll < 60

        // Act
        var result = service.SelectItem(context);

        // Assert
        result.HasSelection.Should().BeTrue();
        // The selected item should be from Warrior-appropriate categories
        // (axes, greatswords, hammers, heavy-armor, or universal)
    }
}
```

---

## 11. Use Cases

### UC-001: Select Class-Appropriate Loot

**Actor:** Loot Generation System  
**Precondition:** Monster defeated, player archetype known  
**Flow:** Create context with archetype → Call SelectItem → Roll succeeds (< 60) → Filter class items → Select from filtered pool → Return class-appropriate result  
**Postcondition:** Player receives loot matching their build

### UC-002: Fall Back to Random Selection

**Actor:** Loot Generation System  
**Precondition:** Roll fails (>= 60) OR no class items available  
**Flow:** Create context → Call SelectItem → Roll >= 60 → Select from full pool → Return random result  
**Postcondition:** Player receives any valid loot item

### UC-003: Generate Loot Without Player Context

**Actor:** Container Loot System  
**Precondition:** Container opened, no player archetype available  
**Flow:** Create context with null archetype → Call SelectItem → Skip bias → Select randomly → Return random-only result  
**Postcondition:** Container provides unbiased loot

### UC-004: Track Smart Loot Statistics

**Actor:** Analytics System  
**Flow:** Multiple SelectItem calls → Call GetStatistics → Display class-appropriate percentage  
**Postcondition:** Game can verify 60% target is being met

---

## 12. Deliverable Checklist

### Domain Layer

- [ ] `SmartLootContext` value object created
- [ ] `SmartLootResult` value object created

### Application Layer

- [ ] `ISmartLootService` interface created
- [ ] `SmartLootStatistics` record created

### Testing

- [ ] ~3 unit tests implemented
- [ ] All tests passing

### Documentation

- [ ] XML documentation on all public types
- [ ] Inline comments for algorithm logic

---

## 13. Acceptance Criteria

### Functional

- [ ] `SmartLootContext` encapsulates archetype, tier, items, and bias
- [ ] `SmartLootResult` includes item, class-appropriate flag, and metadata
- [ ] `ISmartLootService.SelectItem()` returns correct result type
- [ ] 60% of drops target class-appropriate (over large sample)
- [ ] Falls back to random when no class items exist
- [ ] Universal items included in class-appropriate pool
- [ ] Random seed produces deterministic results for testing

### Quality

- [ ] Build succeeds with 0 errors/warnings
- [ ] All ~3 tests pass
- [ ] XML documentation complete on all public members
- [ ] Code follows established patterns from v0.16.3a

---

## 14. Dependencies

### 14.1 Required from Previous Versions

| Type                             | Location               | Usage in this phase         |
| -------------------------------- | ---------------------- | --------------------------- |
| `EquipmentClassAffinity`         | Domain/Enums           | Affinity checking           |
| `EquipmentClassMapping`          | Domain/ValueObjects    | IsAppropriateFor() method   |
| `IEquipmentClassMappingProvider` | Application/Interfaces | Category-to-affinity lookup |
| `QualityTier`                    | Domain/Enums           | Context quality filtering   |
| `LootEntry`                      | Domain/Entities        | Item representation         |

### 14.2 Provides to Future Phases

| Type                | Usage                                       |
| ------------------- | ------------------------------------------- |
| `SmartLootContext`  | v0.16.3c-d: Weighted selection, LootService |
| `SmartLootResult`   | v0.16.3d: Integration with LootDrop entity  |
| `ISmartLootService` | v0.16.3d: LootService dependency injection  |

---

## 15. Future Considerations

### 15.1 Deferred to v0.16.3c

- **Weighted Selection**: Using item weights for non-uniform random selection

### 15.2 Deferred to v0.16.3d

- **LootService Integration**: Connecting SmartLootService to monster drops
- **LootDrop.WasClassAppropriate**: Persisting class-appropriate flag

### 15.3 Deferred to v0.16.3e

- **Stat Verification**: Ensuring generated items have tier-appropriate stats

### 15.4 Out of Scope

- **Configurable Bias**: Config file for bias percentage (future consideration)
- **Multi-class Support**: Companions with different archetypes (future consideration)
- **Pity System**: Guaranteed class-appropriate after N random drops (future consideration)

---

_Document Version: 1.0_  
_Last Updated: 2026-01-27_  
_Author: Assistant_
