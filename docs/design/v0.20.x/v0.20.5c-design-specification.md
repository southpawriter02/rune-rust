# v0.20.5c Design Specification: Tier 3 Abilities & Capstone

**Version:** 0.20.5c
**Phase Name:** Tier 3 Abilities & Capstone
**Parent Version:** v0.20.5 (Berserkr Specialization)
**Prerequisites:** v0.20.5a & v0.20.5b Complete
**Estimated Tests:** ~7 unit tests

---

## Table of Contents

1. [Executive Summary](#1-executive-summary)
2. [Feature Overview](#2-feature-overview)
3. [Architecture Overview](#3-architecture-overview)
4. [FuryCleavesResult Value Object](#4-furycleavesresult-value-object)
5. [DeathDefianceState Value Object](#5-deathdefiancestate-value-object)
6. [AvatarState Value Object](#6-avatarstate-value-object)
7. [CrowdControlType Enum](#7-crowdcontroltype-enum)
8. [Tier 3 & Capstone Ability Specifications](#8-tier-3--capstone-ability-specifications)
9. [Cleave Attack Mechanics](#9-cleave-attack-mechanics)
10. [Death Prevention System](#10-death-prevention-system)
11. [Avatar Transformation Mechanics](#11-avatar-transformation-mechanics)
12. [Crowd Control Immunity System](#12-crowd-control-immunity-system)
13. [Exhaustion Aftermath](#13-exhaustion-aftermath)
14. [Combat Integration Points](#14-combat-integration-points)
15. [Data Model Changes](#15-data-model-changes)
16. [Configuration Updates](#16-configuration-updates)
17. [Corruption Risk Evaluation](#17-corruption-risk-evaluation)
18. [Combat Flow Examples](#18-combat-flow-examples)
19. [Logging Specifications](#19-logging-specifications)
20. [Unit Testing Requirements](#20-unit-testing-requirements)

---

## 1. Executive Summary

### 1.1 Purpose

This specification details the three ultimate abilities of the Berserkr specialization, representing the pinnacle of berserker fury and Heretical corruption:

- **Fury of the Forlorn** (Tier 3): Cleave attack hitting all adjacent enemies simultaneously at 80+ Rage requirement
- **Death Defiance** (Tier 3): Passive death prevention that grants a second chance in combat
- **Avatar of Destruction** (Capstone): Ultimate transformation doubling damage for 2 turns with total CC immunity

These abilities introduce advanced mechanics including area attacks, death prevention, damage multiplication, crowd control immunity, and the highest Corruption risks in the specialization.

### 1.2 Key Deliverables

| Category | Count | Items |
|----------|-------|-------|
| **Domain Value Objects** | 3 | FuryCleavesResult, DeathDefianceState, AvatarState |
| **Domain Enums** | 1 | CrowdControlType |
| **Application Services** | 1 | Tier3CapstoneService (or extend BerserkrAbilityService) |
| **Ability Implementations** | 3 | Fury of the Forlorn, Death Defiance, Avatar of Destruction |
| **Upgrade Validation** | 2 | Tier 3 unlock (16 PP), Capstone unlock (24 PP) |
| **Advanced Mechanics** | 3 | Cleave attacks, death prevention, CC immunity |
| **Corruption Integration** | 2 | High-risk triggers, always-triggers |
| **Tests** | ~7 | Unit tests across all mechanics |

### 1.3 Architectural Significance

This version introduces:

- **Cleave Mechanics**: Single attack roll hitting multiple adjacent targets
- **Death Prevention System**: Passive ability that negates death once per combat
- **Transformation State**: Avatar mode with damage multipliers and immunity lists
- **Crowd Control Immunity Framework**: Comprehensive CC immunity tracking across 10+ types
- **Maximum Corruption Risk**: +2 Corruption on capstone use (highest in game)
- **Aftermath Mechanics**: Exhaustion condition following Avatar transformation

---

## 2. Feature Overview

```
v0.20.5c Tier 3 & Capstone Abilities
├── FuryCleavesResult (Value Object)
│   ├── AttackRoll: int
│   ├── TargetsHit: List<Guid>
│   ├── TargetsMissed: List<Guid>
│   ├── DamageDealt: int (single roll)
│   ├── TotalDamageAcrossTargets: int (per target)
│   ├── RageSpent: int (30)
│   ├── CorruptionTriggered: bool (always true)
│   └── Methods: GetHitCount(), GetDamageBreakdown()
├── DeathDefianceState (Value Object)
│   ├── StateId: Guid
│   ├── CharacterId: Guid
│   ├── HasTriggeredThisCombat: bool
│   ├── TriggeredAt: DateTime?
│   ├── DamagePreventedOnTrigger: int
│   ├── RageGainedOnTrigger: int (20)
│   └── Methods: Trigger(), ResetForNewCombat(), CanTrigger()
├── AvatarState (Value Object)
│   ├── StateId: Guid
│   ├── CharacterId: Guid
│   ├── StartedAt: DateTime
│   ├── TurnsRemaining: int (2)
│   ├── DamageMultiplier: float (2.0)
│   ├── MovementBonus: int (+2 spaces/turn)
│   ├── ImmuneToCrowdControl: bool (true)
│   ├── CorruptionGenerated: int (2)
│   ├── WillCauseExhaustion: bool (true)
│   └── Methods: Tick(), End(), IsActive()
├── CrowdControlType (Enum)
│   ├── Stun, Root, Fear, Charm, Paralyze
│   ├── Slow, Prone, ForcedMovement, Sleep, Confusion
│   └── Methods for immunity checking
├── Tier 3 Abilities
│   ├── Fury of the Forlorn (Active)
│   │   ├── 3 AP, 30 Rage cost
│   │   ├── Requires 80+ Rage to use
│   │   ├── Single attack roll vs all adjacent
│   │   ├── Single damage roll applied to all
│   │   ├── +1 Corruption (always)
│   │   └── Requires 16 PP in tree, 5 PP per ability
│   ├── Death Defiance (Passive)
│   │   ├── Prevent death once per combat
│   │   ├── Stay at 1 HP instead of dying
│   │   ├── Gain 20 Rage when triggered
│   │   ├── Resets on rest/new combat
│   │   └── Requires 16 PP in tree, 5 PP per ability
│   └── Avatar of Destruction (Capstone, Ultimate)
│       ├── 3 AP, 100 Rage cost (requires exactly 100)
│       ├── Lasts 2 turns
│       ├── Double all damage dealt
│       ├── Immune to all crowd control
│       ├── +2 spaces movement/turn
│       ├── Exhausted condition after Avatar ends
│       ├── +2 Corruption (always)
│       ├── Once per combat
│       └── Requires 24 PP in tree, 6 PP to unlock
└── Integration
    ├── Tier 3 unlock validation (16 PP)
    ├── Capstone unlock validation (24 PP)
    ├── Corruption checks (always or conditions)
    └── Effect tracking & cleanup
```

---

## 3. Architecture Overview

### 3.1 Layered Integration

```
┌────────────────────────────────────────────────────────┐
│      v0.20.5c Tier 3 & Capstone Integration             │
├────────────────────────────────────────────────────────┤
│  Presentation Layer                                    │
│  > ability fury-of-the-forlorn          (area attack)  │
│  > status                               (shows active) │
│  > ability avatar-of-destruction        (transform)    │
└────────────────────┬─────────────────────────────────────┘
                     │
┌────────────────────▼─────────────────────────────────────┐
│  Application Layer                                       │
│  ┌────────────────────────────────┐                     │
│  │ Tier3CapstoneAbilityService    │                     │
│  │                                │                     │
│  │ - ExecuteFuryOfTheForlorn()    │                     │
│  │ - CheckDeathDefiance()         │                     │
│  │ - ExecuteAvatarOfDestruction() │                     │
│  └──────┬────────────────────────┘                      │
│         │                                                │
│         ├─ Uses IRageService (v0.20.5a)                │
│         ├─ Uses IBerserkrCorruptionService (v0.20.5a)  │
│         ├─ Uses ICombatService (external)              │
│         └─ Uses IStatusEffectService (external)        │
└─────────────────────┬────────────────────────────────────┘
                      │
┌─────────────────────▼────────────────────────────────────┐
│  Domain Layer                                            │
│  ┌──────────────┐ ┌──────────────┐ ┌──────────────┐    │
│  │ FuryCleavesResult │ DeathDefianceState │ AvatarState   │
│  └──────────────┘ └──────────────┘ └──────────────┘    │
│                                                         │
│  ┌──────────────┐                                        │
│  │CrowdControl  │                                        │
│  │Type (Enum)   │                                        │
│  └──────────────┘                                        │
└────────────────────────────────────────────────────────────┘

Ability Flow:
Fury of the Forlorn
├─ Check: 80+ Rage required
├─ Check: Adjacent enemies
├─ Single attack roll vs all
├─ Single damage roll to all
└─ +1 Corruption (always)

Death Defiance
├─ Passive: Always active
├─ Trigger: Damage would kill
├─ Action: Stay at 1 HP
├─ Effect: +20 Rage
└─ Limit: Once per combat

Avatar of Destruction
├─ Check: Exactly 100 Rage
├─ Transform: 2 turns duration
├─ Effect 1: Double damage
├─ Effect 2: CC immunity
├─ Aftermath: Exhausted (1 turn)
└─ +2 Corruption (always)
```

### 3.2 Tier 3 Ability Service Flow

```
ExecuteFuryOfTheForlorn(characterId)
├─ Check: Tier 3 unlocked? (16 PP)
├─ Check: AP available? (3 AP)
├─ Check: Rage available? (30)
├─ Check: Rage >= 80? (ability requirement)
├─ Get adjacent enemies (up to 8)
├─ Make single attack roll
├─ Roll damage once
├─ Apply to each hit enemy
├─ Spend 30 Rage
├─ Always trigger +1 Corruption
└─ Return FuryCleavesResult

CheckDeathDefiance(characterId, damageWouldInflict)
├─ Check: DeathDefiance active?
├─ Check: Has triggered this combat?
├─ If HP - damage <= 0:
│  ├─ Trigger effect
│  ├─ Set HP to 1
│  ├─ Gain 20 Rage
│  ├─ +1 Corruption? (or 0 - not dark power)
│  └─ Mark: triggered this combat
└─ Return DeathDefianceState

ExecuteAvatarOfDestruction(characterId)
├─ Check: Capstone unlocked? (24 PP)
├─ Check: AP available? (3 AP)
├─ Check: Rage exactly 100?
├─ Create AvatarState (2 turns)
├─ Apply state to character
├─ Consume all Rage (100 → 0)
├─ Schedule: Exhausted after Avatar ends
├─ Always trigger +2 Corruption
├─ Once per combat limit
└─ Return AvatarState
```

---

## 4. FuryCleavesResult Value Object

### 4.1 Definition

```csharp
/// <summary>
/// Result of Fury of the Forlorn cleave attack ability.
/// </summary>
public sealed record FuryCleavesResult
{
    /// <summary>
    /// The attack roll (1-20 + modifiers).
    /// </summary>
    public int AttackRoll { get; init; }

    /// <summary>
    /// IDs of all enemies hit by the cleave.
    /// </summary>
    public IReadOnlyList<Guid> TargetsHit { get; init; } = new List<Guid>();

    /// <summary>
    /// IDs of all adjacent enemies that missed.
    /// </summary>
    public IReadOnlyList<Guid> TargetsMissed { get; init; } = new List<Guid>();

    /// <summary>
    /// Damage rolled once for this ability (applied to all hit targets).
    /// </summary>
    public int DamageDealt { get; init; }

    /// <summary>
    /// Total damage across all hit targets (DamageDealt * TargetsHit.Count).
    /// </summary>
    public int TotalDamageAcrossTargets => DamageDealt * TargetsHit.Count;

    /// <summary>
    /// Rage spent for this ability (30).
    /// </summary>
    public int RageSpent { get; init; } = 30;

    /// <summary>
    /// Whether Corruption was triggered (always true for Fury of the Forlorn).
    /// </summary>
    public bool CorruptionTriggered { get; init; } = true;

    /// <summary>
    /// Always "+1 Corruption" for this ability.
    /// </summary>
    public int CorruptionAmount => 1;

    /// <summary>
    /// Gets the number of enemies successfully hit.
    /// </summary>
    public int GetHitCount() => TargetsHit.Count;

    /// <summary>
    /// Gets the number of enemies that missed.
    /// </summary>
    public int GetMissCount() => TargetsMissed.Count;

    /// <summary>
    /// Checks if the cleave was effective (hit at least one target).
    /// </summary>
    public bool WasEffective() => GetHitCount() > 0;

    /// <summary>
    /// Gets a formatted damage breakdown string.
    /// </summary>
    public string GetDamageBreakdown()
    {
        var hit = GetHitCount();
        var miss = GetMissCount();
        var totalDamage = TotalDamageAcrossTargets;

        return hit > 0
            ? $"{DamageDealt} × {hit} targets = {totalDamage} total damage"
            : $"No targets hit";
    }

    /// <summary>
    /// Gets a human-readable result string for combat log.
    /// </summary>
    public string GetResultString()
    {
        var result = $"Fury of the Forlorn - Attack Roll: {AttackRoll}";

        if (WasEffective())
        {
            result += $" | {GetDamageBreakdown()}";
        }
        else
        {
            result += " | ALL MISSED!";
        }

        if (TargetsMissed.Count > 0)
        {
            result += $" ({GetMissCount()} missed)";
        }

        result += " [+1 CORRUPTION]";

        return result;
    }
}
```

---

## 5. DeathDefianceState Value Object

### 5.1 Definition

```csharp
/// <summary>
/// Represents the Death Defiance passive ability state.
/// Tracks whether the death prevention has been used this combat.
/// </summary>
public sealed record DeathDefianceState
{
    /// <summary>
    /// Unique identifier for this state instance.
    /// </summary>
    public Guid StateId { get; init; } = Guid.NewGuid();

    /// <summary>
    /// Character who has this death prevention ability.
    /// </summary>
    public Guid CharacterId { get; init; }

    /// <summary>
    /// Whether Death Defiance has been triggered this combat encounter.
    /// </summary>
    public bool HasTriggeredThisCombat { get; private set; }

    /// <summary>
    /// DateTime when Death Defiance was triggered (if at all).
    /// </summary>
    public DateTime? TriggeredAt { get; private set; }

    /// <summary>
    /// Amount of damage prevented when triggered.
    /// </summary>
    public int DamagePreventedOnTrigger { get; private set; }

    /// <summary>
    /// Rage gained when Death Defiance triggers (20).
    /// </summary>
    public static readonly int RageGainOnTrigger = 20;

    /// <summary>
    /// Checks if Death Defiance can still trigger this combat.
    /// </summary>
    public bool CanTrigger() => !HasTriggeredThisCombat;

    /// <summary>
    /// Records Death Defiance activation with damage data.
    /// </summary>
    /// <param name="damageWouldHaveCaused">Damage that would have killed the character.</param>
    public void Trigger(int damageWouldHaveCaused)
    {
        HasTriggeredThisCombat = true;
        TriggeredAt = DateTime.UtcNow;
        DamagePreventedOnTrigger = damageWouldHaveCaused;
    }

    /// <summary>
    /// Resets Death Defiance for a new combat encounter.
    /// </summary>
    public void ResetForNewCombat()
    {
        HasTriggeredThisCombat = false;
        TriggeredAt = null;
        DamagePreventedOnTrigger = 0;
    }

    /// <summary>
    /// Gets description of the Death Defiance state.
    /// </summary>
    public string GetDescription()
    {
        if (HasTriggeredThisCombat)
        {
            return $"Death Defiance (USED) - Triggered at {TriggeredAt:HH:mm:ss}, prevented {DamagePreventedOnTrigger} damage";
        }

        return "Death Defiance (Ready) - Will prevent death once this combat";
    }
}
```

---

## 6. AvatarState Value Object

### 6.1 Definition

```csharp
/// <summary>
/// Represents the Avatar of Destruction capstone transformation state.
/// Tracks damage multipliers, CC immunity, and duration.
/// </summary>
public sealed record AvatarState
{
    /// <summary>
    /// Unique identifier for this transformation.
    /// </summary>
    public Guid StateId { get; init; } = Guid.NewGuid();

    /// <summary>
    /// Character undergoing transformation.
    /// </summary>
    public Guid CharacterId { get; init; }

    /// <summary>
    /// DateTime when Avatar transformation began.
    /// </summary>
    public DateTime StartedAt { get; init; }

    /// <summary>
    /// Turns remaining in Avatar state (2).
    /// </summary>
    public int TurnsRemaining { get; private set; } = 2;

    /// <summary>
    /// Damage multiplier while in Avatar state (2.0x).
    /// </summary>
    public float DamageMultiplier { get; init; } = 2.0f;

    /// <summary>
    /// Additional movement spaces per turn (2).
    /// </summary>
    public int MovementBonus { get; init; } = 2;

    /// <summary>
    /// Whether character is immune to crowd control.
    /// </summary>
    public bool ImmuneToCrowdControl { get; init; } = true;

    /// <summary>
    /// List of specific CC types ignored (10 types).
    /// </summary>
    public IReadOnlyList<CrowdControlType> CCImmunityList { get; init; }
        = new[]
        {
            CrowdControlType.Stun,
            CrowdControlType.Root,
            CrowdControlType.Fear,
            CrowdControlType.Charm,
            CrowdControlType.Paralyze,
            CrowdControlType.Slow,
            CrowdControlType.Prone,
            CrowdControlType.ForcedMovement,
            CrowdControlType.Sleep,
            CrowdControlType.Confusion
        };

    /// <summary>
    /// Corruption generated by using Avatar (2).
    /// </summary>
    public int CorruptionGenerated { get; init; } = 2;

    /// <summary>
    /// Whether Avatar ending will cause Exhausted condition.
    /// </summary>
    public bool WillCauseExhaustion { get; init; } = true;

    /// <summary>
    /// Marks one turn has passed in Avatar state.
    /// </summary>
    public void Tick()
    {
        TurnsRemaining = Math.Max(0, TurnsRemaining - 1);
    }

    /// <summary>
    /// Ends the Avatar transformation early (if needed).
    /// </summary>
    public void End()
    {
        TurnsRemaining = 0;
    }

    /// <summary>
    /// Checks if Avatar is currently active.
    /// </summary>
    public bool IsActive() => TurnsRemaining > 0;

    /// <summary>
    /// Gets the current damage multiplier to apply.
    /// </summary>
    public float GetDamageMultiplier() => IsActive() ? DamageMultiplier : 1.0f;

    /// <summary>
    /// Checks if a specific crowd control type is immune.
    /// </summary>
    public bool IsImmuneToCC(CrowdControlType ccType)
        => ImmuneToCrowdControl && CCImmunityList.Contains(ccType);

    /// <summary>
    /// Gets description of Avatar state.
    /// </summary>
    public string GetDescription()
    {
        if (!IsActive())
            return "Avatar of Destruction: Inactive";

        return $"Avatar of Destruction ({TurnsRemaining} turns): 2x damage, CC immune, +2 movement";
    }
}
```

---

## 7. CrowdControlType Enum

### 7.1 Definition

```csharp
/// <summary>
/// Enumeration of crowd control effect types.
/// Avatar of Destruction grants immunity to all of these.
/// </summary>
public enum CrowdControlType
{
    /// <summary>Cannot act or move (complete incapacitation).</summary>
    Stun = 1,

    /// <summary>Cannot move but can act (rooted in place).</summary>
    Root = 2,

    /// <summary>Fear effect (must flee or cower).</summary>
    Fear = 3,

    /// <summary>Charm effect (attack altered or redirected).</summary>
    Charm = 4,

    /// <summary>Cannot move or act (like stun but magical).</summary>
    Paralyze = 5,

    /// <summary>Movement speed reduced (but still movable).</summary>
    Slow = 6,

    /// <summary>Knocked down (disadvantage on attacks until standing).</summary>
    Prone = 7,

    /// <summary>Forcibly moved (push, pull, teleport).</summary>
    ForcedMovement = 8,

    /// <summary>Unconscious (cannot act, vulnerable).</summary>
    Sleep = 9,

    /// <summary>Confused (random or wrong actions).</summary>
    Confusion = 10
}
```

---

## 8. Tier 3 & Capstone Ability Specifications

### 8.1 Fury of the Forlorn (Tier 3 Active)

**Specifications:**

| Property | Value |
|----------|-------|
| **ID** | `fury-of-the-forlorn` |
| **Type** | Active Attack |
| **Tier** | 3 |
| **AP Cost** | 3 AP |
| **Rage Cost** | 30 |
| **Rage Requirement** | 80+ Rage minimum |
| **Effect** | Single attack roll hitting all adjacent enemies |
| **Damage** | Single damage roll applied to all hit targets |
| **PP Requirement** | 16 PP in tree to unlock Tier 3 |
| **PP Cost** | 5 PP to learn ability |
| **Corruption Risk** | +1 (always, independent of Rage) |
| **Cooldown** | None |
| **Special** | Requires at least one adjacent enemy |

**Mechanics:**

- Costs 3 AP and 30 Rage to use
- Can only be used at 80+ Rage (enables high-fury state)
- Make a single melee attack roll
- That one attack roll is compared against each adjacent enemy's Defense individually
- Roll damage once (e.g., 3d6 + STR)
- Apply that same damage roll to every enemy hit
- Each miss is separate (enemy A hits, Enemy B misses possible)
- Does NOT provoke opportunity attacks during the sweep
- Always triggers +1 Corruption (regardless of Rage level or targets)
- Cannot be used in same turn as Avatar of Destruction

**Adjacent Space Definition:**

```
┌───┬───┬───┐
│ E │ E │ E │
├───┼───┼───┤
│ E │ B │ E │
├───┼───┼───┤
│ E │ E │ E │
└───┴───┴───┘

B = Berserkr
E = Adjacent enemies (up to 8 in a square around Berserkr)
```

**Damage Calculation:**

| Component | Calculation |
|-----------|-------------|
| Attack Roll | 1d20 + STR modifier |
| Weapon Damage | Base weapon (rolled once) |
| Fury Bonus | +3d6 (same roll for all) |
| Critical Bonus | +1d6 (if nat 20, same bonus for all) |
| Total per Target | Weapon + Fury ± Crit |

**Usage Example:**

```
Berserkr is surrounded by 3 Draugr Warriors
Rage: 85/100 (meets 80+ requirement)

> ability fury-of-the-forlorn

You raise your weapon high and sweep it in a whirlwind of destruction!
Fury of the Forlorn - Attack Roll: 17 (all targets must defend)

Draugr Warrior 1 (Defense 12): 17 > 12 (HIT!)
Draugr Warrior 2 (Defense 14): 17 > 14 (HIT!)
Draugr Warrior 3 (Defense 11): 17 > 11 (HIT!)

Damage Rolled: 8 (weapon) + 11 (3d6 fury) = 19 total

All three Draugr Warriors take 19 damage!
├─ Draugr 1: 30 → 11/30
├─ Draugr 2: 28 → 9/28
└─ Draugr 3: 25 → 6/25

Rage: 85 → 55/100 (-30)
[HERETICAL] +1 Corruption from Fury of the Forlorn

Scenario 2: Different Defense values
├─ Enemy A (Defense 10): MISSED (not all hit same)
├─ Enemy B (Defense 14): HIT
├─ Enemy C (Defense 12): HIT
Result: 2 hit, 1 missed; each roll separately
```

### 8.2 Death Defiance (Tier 3 Passive)

**Specifications:**

| Property | Value |
|----------|-------|
| **ID** | `death-defiance` |
| **Type** | Passive |
| **Tier** | 3 |
| **Effect** | Prevent death once per combat |
| **Limit** | Once per combat encounter |
| **Trigger** | Automatic when damage would reduce HP to 0 |
| **Result** | Stay at 1 HP instead |
| **Rage Gain** | +20 Rage when triggered |
| **PP Requirement** | 16 PP in tree to unlock Tier 3 |
| **PP Cost** | 5 PP to learn ability |
| **Corruption Risk** | None (0) – survival instinct, not dark power |
| **Cooldown** | Until next combat/rest |

**Mechanics:**

- Passive ability that is always active once learned
- When damage would reduce HP to 0 or below, Death Defiance triggers
- Character remains at 1 HP instead of dying
- Cannot trigger twice in same combat (once per encounter limit)
- Resets after combat ends or after resting (short/long)
- Grants 20 Rage when triggered (motivation from near-death)
- Does NOT prevent instant death effects (like Power Word Kill)
- Does NOT prevent massive damage thresholds (e.g., damage > 2x HP)
- Triggers automatically (no action required)
- No Corruption risk (represents primal survival, not Heretical power)

**Trigger Conditions:**

| Scenario | Triggers? | Result |
|----------|-----------|--------|
| HP 10, take 15 damage | Yes | HP → 1 |
| HP 5, take 10 damage | Yes | HP → 1 |
| Already triggered this combat, take lethal | No | Character dies |
| Instant death (Power Word Kill) | No | Character dies |
| Massive damage (50 to 10 HP creature) | No | Character dies |
| Resets after long rest | Yes | Ready again |

**Usage Example:**

```
Turn 1:
├─ Berserkr HP: 20/20
├─ Enemy casts Massive Fireball
├─ Takes 25 damage (would be -5)
├─ Death Defiance triggers!
├─ HP: 20 → 1/20 (stays alive!)
├─ [Death Defiance] +20 Rage (desperation fuels fury!)
├─ Rage: 45 → 65/100
└─ Status: "You cling to life by sheer will alone!"

Turn 2:
├─ Player options:
│  ├─ Fight with renewed vigor
│  ├─ Use Avatar of Destruction if Rage reaches 100
│  └─ Heal before next hit (since already used Death Defiance)
│
└─ Death Defiance: SPENT (cannot trigger again this combat)

Turn 5 (Later combat):
├─ Same enemy in new encounter
├─ Takes lethal damage again
├─ Death Defiance active again (new combat)
├─ Triggers successfully
└─ HP → 1 (second chance granted)
```

### 8.3 Avatar of Destruction (Capstone Ultimate)

**Specifications:**

| Property | Value |
|----------|-------|
| **ID** | `avatar-of-destruction` |
| **Type** | Ultimate / Capstone |
| **Tier** | Capstone |
| **AP Cost** | 3 AP |
| **Rage Cost** | Exactly 100 (all) |
| **Rage Requirement** | Must have exactly 100 Rage |
| **Duration** | 2 turns |
| **PP Requirement** | 24 PP in tree to unlock Capstone |
| **PP Cost** | 6 PP to learn ability |
| **Cooldown** | Once per combat |
| **Corruption Risk** | +2 (always, maximum risk) |
| **Aftermath** | Exhausted (1 turn) when Avatar ends |
| **Special** | Consumes ALL Rage |

**Mechanics:**

- Requires EXACTLY 100 Rage to activate (not 100+, exactly 100)
- Costs 3 AP to activate
- Lasts 2 turns from activation
- On activation, ALL Rage is consumed (100 → 0)
- For 2 turns, all damage dealt is doubled:
  - Weapon attacks: 2x damage
  - Ability damage: 2x damage
  - Other damage sources: 2x damage
- Immune to all crowd control effects (10 types listed)
- Cannot be knocked prone
- Cannot be forcibly moved
- Cannot be stunned, rooted, feared, charmed, paralyzed, slowed, sleep, confused
- Movement speed increased by 2 spaces per turn
- At end of Avatar (turn 2 complete), gain Exhausted condition (1 turn)
- While Exhausted: Disadvantage on all rolls
- Always triggers +2 Corruption (highest in game)
- Can only use once per combat encounter
- After Avatar ends, must wait until next combat to use again

**Avatar State Effects Summary:**

| Effect | Description | Duration |
|--------|-------------|----------|
| Double Damage | All damage × 2 | 2 turns |
| CC Immunity | All CC types negated | 2 turns |
| Knockdown Immunity | Cannot be knocked prone | 2 turns |
| Push Immunity | Cannot be moved forcibly | 2 turns |
| Movement Bonus | +2 spaces/turn | 2 turns |
| Exhaustion | Disadvantage all rolls | 1 turn after |
| Corruption | +2 applied immediately | Permanent |

**Crowd Control Immunity List:**

| CC Type | Immune | Prevented Effect |
|---------|--------|-----------------|
| Stun | Yes | Cannot prevent action |
| Root | Yes | Cannot prevent movement |
| Fear | Yes | Cannot induce fleeing |
| Charm | Yes | Cannot redirect attacks |
| Paralyze | Yes | Cannot freeze movement |
| Slow | Yes | Cannot reduce speed |
| Prone | Yes | Cannot be knocked down |
| Forced Movement | Yes | Cannot be pushed/pulled |
| Sleep | Yes | Cannot be unconscious |
| Confusion | Yes | Cannot randomize actions |

**Usage Example:**

```
Turn 1: Pre-Avatar buildup
├─ Combat continues, Rage building
├─ Pain is Fuel: +5 per hit taken
├─ Blood Scent: +10 per enemy bloodied
├─ Fury Strike usage: builds Corruption risk
└─ Goal: Reach exactly 100 Rage

Turn 5: 100 Rage achieved!
├─ Berserkr: 100/100 Rage
├─ > ability avatar-of-destruction
├─ You become an AVATAR OF PURE DESTRUCTION!
├─ Rage: 100 → 0/100 (consumed)
├─ Transformation begins!
├─ Duration: 2 turns remaining
├─ Damage: 2x multiplier active
├─ Immunity: All crowd control negated
├─ Movement: +2 spaces/turn
└─ [HERETICAL] +2 Corruption (maximum risk!)

Turn 5 (continued): Avatar turn 1
├─ Attack: Normally 12 damage → 24 damage
├─ Fury Strike: Normally 19 damage → 38 damage
├─ Enemy attempts Root: Resisted!
├─ Enemy attempts Charm: Resisted!
├─ Can move 4+2=6 spaces instead of 4
└─ Avatar: 1 turn remaining

Turn 6: Avatar turn 2
├─ Attack: 2x damage active
├─ Still immune to CC
├─ Still extra movement
└─ Avatar: 0 turns remaining (expires end of turn)

Turn 7: Aftermath
├─ Avatar effect ended
├─ [EXHAUSTED] -Disadvantage on all rolls
├─ Cannot use Avatar again this combat
├─ Next turn: Exhaustion wears off
└─ Must rebuild Rage for potential future combats

Scenario: Avatar + Multiple Enemies
├─ Avatar active, 2x damage
├─ Enemy A casts Root: Resisted (no movement block)
├─ Enemy B casts Stun: Resisted (can still act)
├─ Enemy C attacks for 10 damage: Reflected as 20 damage to them
│  (if Avatar gives damage reflection - depends on rules)
└─ Result: Overwhelming dominance for 2 turns
```

---

## 9. Cleave Attack Mechanics

### 9.1 Adjacent Enemy Detection

```csharp
/// <summary>
/// Finds all adjacent enemies to the Berserkr.
/// </summary>
public List<Character> GetAdjacentEnemies(Character berserkr)
{
    var grid = combatGrid.GetGrid();
    var berserkrPosition = grid.GetEntityPosition(berserkr.Id);

    var adjacent = new List<Character>();

    // Check all 8 adjacent squares
    for (int x = -1; x <= 1; x++)
    {
        for (int y = -1; y <= 1; y++)
        {
            if (x == 0 && y == 0) continue; // Skip center

            var checkPos = new GridPosition(
                berserkrPosition.X + x,
                berserkrPosition.Y + y);

            var cell = grid.GetCell(checkPos);
            if (cell?.IsOccupied == true)
            {
                var occupant = combatService.GetCharacter(cell.OccupantId);
                if (occupant?.IsEnemy(berserkr) == true)
                {
                    adjacent.Add(occupant);
                }
            }
        }
    }

    return adjacent;
}
```

### 9.2 Cleave Attack Resolution

```csharp
/// <summary>
/// Resolves Fury of the Forlorn cleave attack.
/// </summary>
public FuryCleavesResult ExecuteFuryOfTheForlorn(
    Character attacker,
    IReadOnlyList<Character> adjacentEnemies)
{
    if (adjacentEnemies.Count == 0)
    {
        logger.LogWarning("No adjacent enemies for Fury of the Forlorn");
        return new FuryCleavesResult { AttackRoll = 0 };
    }

    // Make single attack roll
    int attackRoll = Roll1d20() + attacker.StrengthModifier;

    // Roll damage once
    int baseDamage = RollWeaponDamage(attacker);
    int furyDamage = Roll(3, 6);
    int totalDamage = baseDamage + furyDamage;

    var targetsHit = new List<Guid>();
    var targetsMissed = new List<Guid>();

    // Compare single attack roll against each enemy's defense
    foreach (var enemy in adjacentEnemies)
    {
        if (attackRoll >= enemy.Defense)
        {
            targetsHit.Add(enemy.Id);
            enemy.TakeDamage(totalDamage);
        }
        else
        {
            targetsMissed.Add(enemy.Id);
        }
    }

    return new FuryCleavesResult
    {
        AttackRoll = attackRoll,
        TargetsHit = targetsHit,
        TargetsMissed = targetsMissed,
        DamageDealt = totalDamage,
        CorruptionTriggered = true
    };
}
```

---

## 10. Death Prevention System

### 10.1 Death Check Integration

```csharp
/// <summary>
/// Called when damage would reduce HP to 0 or below.
/// </summary>
public bool CheckDeathDefiance(Character character, int damageWouldInflict)
{
    var deathDefiance = character.DeathDefianceState;

    if (deathDefiance == null || !deathDefiance.CanTrigger())
        return false; // Cannot prevent death

    // Calculate actual HP after damage
    int hpAfterDamage = character.CurrentHp - damageWouldInflict;

    if (hpAfterDamage > 0)
        return false; // Not lethal, no need to trigger

    // Trigger Death Defiance
    deathDefiance.Trigger(damageWouldInflict);
    character.SetHp(1); // Stay at 1 HP

    rageService.AddRage(character.Id, DeathDefianceState.RageGainOnTrigger, "Death Defiance");

    logger.LogWarning(
        "Death Defiance triggered for {CharacterName}: Prevented {Damage} damage, now at 1 HP",
        character.Name, damageWouldInflict);

    return true; // Death prevented
}
```

### 10.2 Combat Lifecycle

```csharp
/// <summary>
/// Called when combat encounter begins.
/// </summary>
public void OnCombatStart(Character character)
{
    // Death Defiance doesn't need reset at start; already ready
    if (character.DeathDefianceState != null)
    {
        logger.LogInformation(
            "Combat started: {CharacterName} has Death Defiance ready (once per combat)",
            character.Name);
    }
}

/// <summary>
/// Called when combat encounter ends.
/// </summary>
public void OnCombatEnd(Character character)
{
    // Don't reset Death Defiance here; reset only on rest
}

/// <summary>
/// Called on short or long rest.
/// </summary>
public void OnRest(Character character)
{
    character.DeathDefianceState?.ResetForNewCombat();

    logger.LogInformation(
        "Rest complete: {CharacterName} Death Defiance reset (ready for next combat)",
        character.Name);
}
```

---

## 11. Avatar Transformation Mechanics

### 11.1 Avatar Activation

```csharp
/// <summary>
/// Activates Avatar of Destruction transformation.
/// </summary>
public AvatarState ExecuteAvatarOfDestruction(Character character)
{
    // Check preconditions
    if (character.Rage?.CurrentRage != 100)
    {
        logger.LogWarning(
            "Avatar of Destruction requires exactly 100 Rage ({Actual} present)",
            character.Rage?.CurrentRage ?? 0);
        return null;
    }

    // Create Avatar state
    var avatarState = new AvatarState
    {
        StateId = Guid.NewGuid(),
        CharacterId = character.Id,
        StartedAt = DateTime.UtcNow
    };

    // Apply to character
    character.BerserkrState.AvatarOfDestruction = avatarState;

    // Consume all Rage
    rageService.SpendRage(character.Id, 100);

    // Apply Corruption
    var riskResult = new CorruptionRiskResult
    {
        CorruptionAmount = 2,
        Trigger = BerserkrCorruptionTrigger.CapstoneActivation,
        Reason = "Used Avatar of Destruction"
    };
    corruptionService.ApplyCorruption(character.Id, riskResult);

    logger.LogWarning(
        "Avatar of Destruction activated for {CharacterName}: 2x damage, CC immune, 2 turns",
        character.Name);

    // Schedule Exhaustion at end of Avatar
    scheduler.ScheduleCallback(TimeSpan.FromTurns(2), () =>
    {
        character.ApplyCondition(Condition.Exhausted, turns: 1);
        logger.LogInformation(
            "Avatar of Destruction ended for {CharacterName}: Exhausted (1 turn)",
            character.Name);
    });

    return avatarState;
}
```

### 11.2 Damage Multiplication

```csharp
/// <summary>
/// Calculates final damage with Avatar multiplier.
/// </summary>
public int CalculateFinalDamage(Character attacker, int baseDamage)
{
    if (attacker.BerserkrState?.AvatarOfDestruction?.IsActive() == true)
    {
        float multiplier = attacker.BerserkrState.AvatarOfDestruction.DamageMultiplier;
        return (int)(baseDamage * multiplier);
    }

    return baseDamage;
}

// Usage in combat
var weaponDamage = Roll(2, 6) + attacker.StrengthModifier; // 12 damage
var finalDamage = CalculateFinalDamage(attacker, weaponDamage); // 24 damage if Avatar active
```

---

## 12. Crowd Control Immunity System

### 12.1 CC Application Check

```csharp
/// <summary>
/// Checks if a crowd control effect can be applied to character.
/// </summary>
public bool CanApplyCC(Character target, CrowdControlType ccType)
{
    // Check Avatar immunity first
    if (target.BerserkrState?.AvatarOfDestruction?.IsActive() == true)
    {
        if (target.BerserkrState.AvatarOfDestruction.IsImmuneToCC(ccType))
        {
            logger.LogInformation(
                "{TargetName} immune to {CCType} (Avatar of Destruction active)",
                target.Name, ccType);
            return false;
        }
    }

    // Other immunity checks (non-Avatar)
    if (target.HasGeneralCCImmunity)
        return false;

    return true; // Can apply CC
}
```

### 12.2 CC Application Flow

```csharp
/// <summary>
/// Attempts to apply CC to target.
/// </summary>
public void ApplyCrowdControl(Character target, CrowdControlEffect effect)
{
    if (!CanApplyCC(target, effect.Type))
    {
        logger.LogInformation(
            "CC effect {Type} resisted by {TargetName}",
            effect.Type, target.Name);
        return;
    }

    target.ActiveConditions.Add(effect);
    logger.LogWarning(
        "{TargetName} affected by {Type}: {Description}",
        target.Name, effect.Type, effect.Description);
}
```

---

## 13. Exhaustion Aftermath

### 13.1 Exhaustion Mechanics

```csharp
public enum ExhaustionLevel
{
    None = 0,
    Fatigued = 1, // Disadvantage on checks
    Exhausted = 2 // Disadvantage on all rolls
}

/// <summary>
/// Represents Exhaustion condition from Avatar aftermath.
/// </summary>
public class ExhaustionCondition
{
    public ExhaustionLevel Level { get; set; } = ExhaustionLevel.Exhausted;
    public int TurnsRemaining { get; set; } = 1;

    /// <summary>
    /// Gets the roll penalty.
    /// </summary>
    public int GetPenalty()
    {
        return Level switch
        {
            ExhaustionLevel.Fatigued => -2,
            ExhaustionLevel.Exhausted => -4, // Or use disadvantage system
            _ => 0
        };
    }
}

/// <summary>
/// Applied when Avatar ends.
/// </summary>
public void ApplyAvatarExhaustion(Character character)
{
    character.AddCondition(new ExhaustionCondition
    {
        Level = ExhaustionLevel.Exhausted,
        TurnsRemaining = 1
    });

    logger.LogWarning(
        "Avatar of Destruction ended for {CharacterName}: Exhausted for 1 turn",
        character.Name);
}
```

### 13.2 Exhaustion Application

```csharp
/// <summary>
/// Called when Avatar duration expires.
/// </summary>
public void OnAvatarEnd(Character character)
{
    character.BerserkrState.AvatarOfDestruction = null;
    ApplyAvatarExhaustion(character);

    // Apply to rolls
    var exhaustion = character.GetCondition(ConditionType.Exhausted);
    logger.LogInformation(
        "Exhaustion applied: {CharacterName} has {Penalty} penalty for 1 turn",
        character.Name, exhaustion.GetPenalty());
}
```

---

## 14. Combat Integration Points

### 14.1 Damage Resolution

```csharp
// When resolving damage to target
public void ResolveDamage(Character attacker, Character target, int baseDamage)
{
    // Apply Avatar multiplier if attacker is in Avatar
    int finalDamage = CalculateFinalDamage(attacker, baseDamage);

    // Apply to target
    target.TakeDamage(finalDamage);

    // Check Death Defiance on target
    if (target.CurrentHp <= 0)
    {
        if (!CheckDeathDefiance(target, -target.CurrentHp))
        {
            target.Die();
        }
    }
}
```

### 14.2 CC Application

```csharp
// When attempting to apply CC
public void ApplyCC(Character caster, Character target, CrowdControlType type)
{
    // Check if target is Avatar-immune
    if (target.BerserkrState?.AvatarOfDestruction?.IsImmuneToCC(type) == true)
    {
        logger.LogInformation(
            "{Target} resists {CCType} (Avatar immunity)",
            target.Name, type);
        return;
    }

    // Apply normally
    target.AddCC(type);
}
```

### 14.3 Movement Resolution

```csharp
// When calculating movement range
public int GetMovementRange(Character character)
{
    int baseRange = 4; // Default movement

    // Check Avatar bonus
    if (character.BerserkrState?.AvatarOfDestruction?.IsActive() == true)
    {
        baseRange += character.BerserkrState.AvatarOfDestruction.MovementBonus; // +2
    }

    return baseRange; // 6 spaces if Avatar active
}
```

---

## 15. Data Model Changes

### 15.1 Character Entity Modifications

```csharp
MODIFY: Character (Entity)
├── ADD: DeathDefianceState? (v0.20.5c)
├── ADD: HasDeathDefianceTriggered: bool (computed)
├── ADD: CanPreventDeath(): bool
└── ADD: TryPreventDeath(damageInflicted): bool

MODIFY: Character (Entity)
├── ADD: AvatarOfDestruction: AvatarState? (v0.20.5c)
├── ADD: IsInAvatarState: bool (computed)
├── ADD: GetDamageMultiplier(): float
├── ADD: IsImmuneToCC(ccType): bool
└── ADD: GetMovementBonus(): int
```

### 15.2 BerserkrState Extension

```csharp
public class BerserkrState
{
    // v0.20.5a-b
    public Guid CharacterId { get; init; }
    public RageResource Rage { get; private set; }
    public RecklessAssaultState? RecklessAssault { get; set; }
    public UnstoppableEffect? Unstoppable { get; set; }
    public List<IntimidationEffect> IntimidationEffects { get; }

    // v0.20.5c
    public DeathDefianceState? DeathDefiance { get; init; }
    public AvatarState? AvatarOfDestruction { get; set; }

    // Methods
    public void TickAllEffects()
    {
        RecklessAssault?.Tick();
        Unstoppable?.Tick();
        DeathDefiance?.CheckExpirations();

        foreach (var effect in IntimidationEffects.ToList())
        {
            effect.Tick();
        }

        AvatarOfDestruction?.Tick();
    }
}
```

---

## 16. Configuration Updates

### 16.1 abilities.json (Tier 3 & Capstone)

```json
{
  "abilities": [
    {
      "abilityId": "fury-of-the-forlorn",
      "displayName": "Fury of the Forlorn",
      "specializationId": "Berserkr",
      "tier": 3,
      "type": "Active",
      "apCost": 3,
      "resourceCost": {
        "resourceId": "rage",
        "amount": 30
      },
      "description": "At the height of fury, your attacks become a whirlwind of destruction. Requires 80+ Rage. Make a single melee attack that hits all adjacent enemies. Damage is rolled once and applied to all hit targets.",
      "shortDescription": "Attack: Single roll hits all adjacent enemies",
      "requirements": {
        "minimumRage": 80,
        "ppInTree": 16,
        "ppCost": 5
      },
      "effects": [
        {
          "type": "MeleeAttack",
          "areaType": "Adjacent",
          "singleAttackRoll": true,
          "singleDamageRoll": true,
          "maxTargets": 8
        }
      ],
      "corruptionRisk": {
        "trigger": "Always",
        "amount": 1,
        "description": "Fury of the Forlorn always triggers +1 Corruption"
      }
    },
    {
      "abilityId": "death-defiance",
      "displayName": "Death Defiance",
      "specializationId": "Berserkr",
      "tier": 3,
      "type": "Passive",
      "apCost": 0,
      "resourceCost": null,
      "description": "Your fury refuses to let you fall. Once per combat, when damage would reduce you to 0 HP, you instead remain at 1 HP. When triggered, gain 20 Rage.",
      "shortDescription": "Passive: Prevent death once per combat",
      "requirements": {
        "ppInTree": 16,
        "ppCost": 5
      },
      "effects": [
        {
          "type": "DeathPrevention",
          "usesPerCombat": 1,
          "hpAfterTrigger": 1,
          "rageGainOnTrigger": 20
        }
      ],
      "corruptionRisk": null
    },
    {
      "abilityId": "avatar-of-destruction",
      "displayName": "Avatar of Destruction",
      "specializationId": "Berserkr",
      "tier": "capstone",
      "type": "Ultimate",
      "apCost": 3,
      "resourceCost": {
        "resourceId": "rage",
        "amount": 100,
        "exact": true,
        "consumeAll": true
      },
      "duration": 2,
      "durationUnit": "Turns",
      "cooldown": "Combat",
      "description": "At maximum fury, become an avatar of pure destruction. Requires exactly 100 Rage (consumes all). For 2 turns, all damage is doubled and you are immune to crowd control. After Avatar ends, you are Exhausted for 1 turn.",
      "shortDescription": "Ultimate: 2x damage, CC immune, 2 turns, +2 Corruption",
      "requirements": {
        "exactRage": 100,
        "ppInTree": 24,
        "ppCost": 6
      },
      "effects": [
        {
          "type": "DamageMultiplier",
          "multiplier": 2.0,
          "appliesToAllDamage": true
        },
        {
          "type": "CrowdControlImmunity",
          "immuneTo": [
            "Stun",
            "Root",
            "Fear",
            "Charm",
            "Paralyze",
            "Slow",
            "Prone",
            "ForcedMovement",
            "Sleep",
            "Confusion"
          ]
        },
        {
          "type": "MovementBonus",
          "value": 2,
          "unit": "Spaces"
        },
        {
          "type": "OnEnd",
          "applyCondition": "Exhausted",
          "duration": 1
        }
      ],
      "corruptionRisk": {
        "trigger": "Always",
        "amount": 2,
        "description": "Avatar of Destruction always triggers +2 Corruption (maximum)"
      }
    }
  ]
}
```

---

## 17. Corruption Risk Evaluation

### 17.1 Tier 3 & Capstone Corruption

```csharp
public CorruptionRiskResult EvaluateTier3CapstoneRisk(
    BerserkrAbilityId abilityId,
    int currentRage)
{
    return abilityId switch
    {
        BerserkrAbilityId.FuryOfTheForlorn =>
            new CorruptionRiskResult
            {
                CorruptionAmount = 1,
                Trigger = BerserkrCorruptionTrigger.FuryOfTheForlornUsage,
                Reason = "Used Fury of the Forlorn (requires 80+ Rage)"
            },

        BerserkrAbilityId.DeathDefiance =>
            new CorruptionRiskResult
            {
                CorruptionAmount = 0,
                Reason = "Passive ability (survival instinct, not dark power)"
            },

        BerserkrAbilityId.AvatarOfDestruction =>
            new CorruptionRiskResult
            {
                CorruptionAmount = 2,
                Trigger = BerserkrCorruptionTrigger.CapstoneActivation,
                Reason = "Used Avatar of Destruction (ultimate power, ultimate cost)"
            },

        _ => new CorruptionRiskResult { CorruptionAmount = 0, Reason = "Unknown" }
    };
}
```

---

## 18. Combat Flow Examples

### 18.1 Fury of the Forlorn in Action

```
TURN 1: Setup
├─ Berserkr surrounded by 4 enemies (all adjacent)
├─ Rage: 85/100 (meets 80+ requirement)
├─ Enemies: Draugr (Defense 12), Draugr (14), Skeleton (11), Goblin (13)
│
└─ > ability fury-of-the-forlorn

TURN 1 (continued): Execution
├─ Attack Roll: 17 (vs each enemy's Defense)
│
├─ Draugr 1 (Def 12): 17 > 12 (HIT!)
├─ Draugr 2 (Def 14): 17 > 14 (HIT!)
├─ Skeleton (Def 11): 17 > 11 (HIT!)
├─ Goblin (Def 13): 17 > 13 (HIT!)
│
├─ Damage Roll: 8 (weapon) + 13 (3d6 fury) = 21 damage
│
├─ All four enemies take 21 damage:
│  ├─ Draugr 1: 30 → 9/30
│  ├─ Draugr 2: 28 → 7/28
│  ├─ Skeleton: 20 → -1/20 (DIES!)
│  └─ Goblin: 18 → -3/18 (DIES!)
│
├─ Rage: 85 → 55/100 (-30)
├─ [HERETICAL] +1 Corruption
└─ Result: Eliminated 2 enemies, damaged 2 survivors!
```

### 18.2 Death Defiance Trigger

```
TURN 3: Enemy turn
├─ Big Boss casts Meteor strike
├─ Damage calculated: 35 HP
├─ Berserkr HP: 18/18
├─ Would die: 18 - 35 = -17
│
├─ Death Defiance TRIGGERS!
├─ HP: 18 → 1/18 (clings to life!)
├─ Rage: 30 → 50/100 (+20 from desperation!)
│
└─ Status: "You cling to life by sheer will!"

TURN 4: Berserkr turn
├─ At 1 HP but alive
├─ Rage boosted to 50
├─ Must be strategic (already used Death Defiance)
├─ Options:
│  ├─ Heal if possible
│  ├─ Finish Boss with Fury Strike
│  └─ Build Rage to 100 for Avatar (if combat continues)
│
└─ Death Defiance spent (unavailable rest of combat)
```

### 18.3 Avatar of Destruction Sequence

```
TURN 6: Avatar activation
├─ Berserkr: 100/100 Rage (exactly)
├─ > ability avatar-of-destruction
├─ TRANSFORMATION BEGIN!
├─ Rage: 100 → 0/100 (consumed)
│
├─ Avatar: ACTIVE (2 turns)
├─ Damage: 2x multiplier
├─ Immunity: All CC types (10)
├─ Movement: +2 spaces/turn
├─ [HERETICAL] +2 Corruption (maximum!)
│
└─ Status: "You become an avatar of pure destruction!"

TURN 6 (continued): Avatar action
├─ Normal attack: 12 damage → 24 damage (2x)
├─ Fury Strike: Would deal 19 → 38 damage (2x)
├─ Enemy casts Root: RESISTED (Avatar immune)
├─ Enemy casts Stun: RESISTED (Avatar immune)
├─ Movement: 4 → 6 spaces this turn
│
└─ Avatar: 1 turn remaining

TURN 7: Avatar turn 2
├─ Damage still 2x
├─ Still immune to CC
├─ Still extra movement
├─ Avatar: 0 turns remaining (expires end of turn)
│
└─ Result: Devastating 2-turn rampage!

TURN 8: Aftermath
├─ Avatar ends
├─ [EXHAUSTED] -Disadvantage on all rolls
├─ Cannot act effectively
├─ Damage multiplier gone
├─ CC immunity gone
│
├─ Exhaustion: 1 turn remaining
│
└─ Must recover before next major ability
```

### 18.4 Full Combat Arc (Multiple Phases)

```
PHASE 1: Early Combat (Rage building)
├─ Rage: 0 → 20 (via Pain is Fuel, Blood Scent)
├─ Use Tier 1: Fury Strike, maintain stance
├─ Low Corruption risk (below 80 Rage)

PHASE 2: Escalation (Rage 40-60)
├─ Tier 2 abilities become valuable
├─ Enter Reckless Assault for +4 Attack
├─ Use Unstoppable to navigate battlefield
├─ Corruption risk increasing

PHASE 3: High Fury (Rage 80+)
├─ Every ability action risks +1 Corruption
├─ Fury Strike cost/benefit analysis
├─ Fury of the Forlorn available (if 80+)
├─ Combat entry at this Rage: +1 Corruption

PHASE 4: Avatar State (Rage 100)
├─ Avatar of Destruction unleashed
├─ 2 turns of overwhelming power
├─ +2 Corruption cost
├─ Exhaustion aftermath (disadvantage 1 turn)

PHASE 5: Recovery
├─ Rebuild Rage or disengage
├─ Use Death Defiance if threatened
├─ Prepare for next combat phase
└─ Total Corruption: Significant (risk vs reward)
```

---

## 19. Logging Specifications

### 19.1 Key Log Events

**Information Level:**
```
[INFO] Fury of the Forlorn: Attack Roll 17, Hit 3/4 enemies (Draugr 1, 2, Goblin)
[INFO] Damage: 21 per target, 63 total damage
[INFO] Adjacent enemies detected: 4 targets in range
[INFO] Character 123e Death Defiance triggered: Prevented 25 damage, HP now 1
[INFO] Death Defiance: +20 Rage gained (desperation)
[INFO] Avatar of Destruction: Damage multiplier 2x active
[INFO] Avatar of Destruction: CC immunity active (all 10 types)
```

**Warning Level:**
```
[WARN] Fury of the Forlorn: Single attack roll 15, Hit 2/4 enemies (missed others)
[WARN] Avatar of Destruction: +2 Corruption (MAXIMUM RISK!)
[WARN] Character 123e Avatar state ending: Exhausted condition applied (1 turn)
[WARN] Character 123e Death Defiance: Cannot trigger again this combat
```

**Error Level:**
```
[ERROR] Fury of the Forlorn: No adjacent enemies found
[ERROR] Avatar of Destruction: Rage not exactly 100 (actual: 95)
[ERROR] Death Defiance: Already triggered this combat
```

---

## 20. Unit Testing Requirements

### 20.1 FuryCleavesTests.cs (~2 tests)

```csharp
[TestFixture]
public class FuryCleavesTests
{
    [Test]
    public void FuryOfTheForlorn_HitsAllAdjacentEnemies()
    {
        var berserkr = new Character { /* setup */ };
        var enemies = new[] { enemy1, enemy2, enemy3 };

        var result = abilityService.ExecuteFuryOfTheForlorn(berserkr, enemies);

        Assert.That(result.GetHitCount(), Is.GreaterThan(0));
        Assert.That(result.CorruptionTriggered, Is.True);
        Assert.That(result.CorruptionAmount, Is.EqualTo(1));
    }

    [Test]
    public void FuryOfTheForlorn_AlwaysTriggersCorruption()
    {
        var result = new FuryCleavesResult
        {
            AttackRoll = 15,
            TargetsHit = new[] { Guid.NewGuid() }.ToList(),
            DamageDealt = 20,
            CorruptionTriggered = true
        };

        Assert.That(result.CorruptionTriggered, Is.True);
        Assert.That(result.CorruptionAmount, Is.EqualTo(1));
    }
}
```

### 20.2 DeathDefianceTests.cs (~2 tests)

```csharp
[TestFixture]
public class DeathDefianceTests
{
    [Test]
    public void DeathDefiance_CanTriggerOnce()
    {
        var state = new DeathDefianceState { CharacterId = Guid.NewGuid() };

        Assert.That(state.CanTrigger(), Is.True);

        state.Trigger(damageWouldHaveCaused: 25);

        Assert.That(state.CanTrigger(), Is.False);
        Assert.That(state.HasTriggeredThisCombat, Is.True);
    }

    [Test]
    public void DeathDefiance_ResetsAfterCombat()
    {
        var state = new DeathDefianceState { CharacterId = Guid.NewGuid() };
        state.Trigger(25);

        state.ResetForNewCombat();

        Assert.That(state.CanTrigger(), Is.True);
        Assert.That(state.HasTriggeredThisCombat, Is.False);
    }
}
```

### 20.3 AvatarStateTests.cs (~3 tests)

```csharp
[TestFixture]
public class AvatarStateTests
{
    [Test]
    public void AvatarState_DoublesDamage()
    {
        var avatar = new AvatarState { CharacterId = Guid.NewGuid() };

        var multiplier = avatar.GetDamageMultiplier();

        Assert.That(multiplier, Is.EqualTo(2.0f));
    }

    [Test]
    public void AvatarState_GrantsCCImmunity()
    {
        var avatar = new AvatarState { CharacterId = Guid.NewGuid() };

        Assert.That(avatar.IsImmuneToCC(CrowdControlType.Stun), Is.True);
        Assert.That(avatar.IsImmuneToCC(CrowdControlType.Root), Is.True);
        Assert.That(avatar.IsImmuneToCC(CrowdControlType.Fear), Is.True);
    }

    [Test]
    public void AvatarState_ExpiresAfterTwoTurns()
    {
        var avatar = new AvatarState { TurnsRemaining = 2 };

        Assert.That(avatar.IsActive(), Is.True);

        avatar.Tick(); // 1 turn remaining
        Assert.That(avatar.IsActive(), Is.True);

        avatar.Tick(); // 0 turns remaining
        Assert.That(avatar.IsActive(), Is.False);
    }
}
```

---

_This specification provides comprehensive detail for v0.20.5c: Tier 3 Abilities & Capstone. It introduces the ultimate mechanics of the Berserkr specialization, including cleave attacks, death prevention, and ultimate transformation with crowd control immunity._

