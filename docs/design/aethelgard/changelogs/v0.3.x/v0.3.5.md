# Changelog: v0.3.5 - Exploration HUD System (Dashboard, Minimap, Room View, Stabilization)

**Versions:** v0.3.5a through v0.3.5d
**Release Dates:** 2025-12-21 (all parts)

## Table of Contents

- [Overview](#overview)
- [Part A: The Dashboard (Layout & Status)](#part-a-the-dashboard-layout--status)
  - [Summary](#summary)
  - [New Files Created](#new-files-created)
  - [Files Modified](#files-modified)
  - [Code Implementation Details](#code-implementation-details)
  - [Status Bar Color Thresholds](#status-bar-color-thresholds)
  - [User Interface](#user-interface)
  - [Test Coverage](#test-coverage)
  - [Logging Matrix](#logging-matrix)
  - [DI Registration](#di-registration)
  - [Architecture Notes](#architecture-notes)
  - [Build Verification](#build-verification)
  - [Directory Structure Changes](#directory-structure-changes)
  - [Next Steps (v0.3.5b: The Minimap)](#next-steps-v035b-the-minimap)
  - [Notes](#notes)
- [Part B: The Cartographer (Minimap)](#part-b-the-cartographer-minimap)
  - [Summary](#summary-1)
  - [New Files Created](#new-files-created-1)
  - [Files Modified](#files-modified-1)
  - [Code Implementation Details](#code-implementation-details-1)
  - [Symbol Reference Table](#symbol-reference-table)
  - [User Interface](#user-interface-1)
  - [Test Coverage](#test-coverage-1)
  - [Logging Matrix](#logging-matrix-1)
  - [Architecture Notes](#architecture-notes-1)
  - [Build Verification](#build-verification-1)
  - [Directory Structure Changes](#directory-structure-changes-1)
  - [Next Steps (v0.3.5c: The Room View)](#next-steps-v035c-the-room-view)
  - [Notes](#notes-1)
- [Part C: The Surveyor (Room Rendering)](#part-c-the-surveyor-room-rendering)
  - [Summary](#summary-2)
  - [New Features](#new-features)
  - [Visual Example](#visual-example)
  - [Color Coding Reference](#color-coding-reference)
  - [Files Created](#files-created)
  - [Files Modified](#files-modified-2)
  - [Test Coverage](#test-coverage-2)
  - [Implementation Details](#implementation-details)
  - [Logging Matrix](#logging-matrix-2)
  - [Dependencies](#dependencies)
  - [Breaking Changes](#breaking-changes)
  - [Known Limitations](#known-limitations)
  - [Version History](#version-history)
  - [Next Steps (v0.3.5d Candidates)](#next-steps-v035d-candidates)
- [Part D: The Stabilizer (Bug Fixes & Polish)](#part-d-the-stabilizer-bug-fixes--polish)
  - [Summary](#summary-3)
  - [Bug Fixes](#bug-fixes)
  - [New Files](#new-files)
  - [Implementation Details](#implementation-details-1)
  - [Test Coverage](#test-coverage-3)
  - [Logging Matrix](#logging-matrix-3)
  - [Breaking Changes](#breaking-changes-1)
  - [Known Limitations](#known-limitations-1)
  - [Migration Required](#migration-required)
  - [Version History](#version-history-1)
  - [Next Steps (v0.3.6 Candidates)](#next-steps-v036-candidates)

---

## Overview

Version 0.3.5 implements a complete terminal-based Exploration HUD system, replacing scrolling text logs with a persistent three-pane interface. This major release introduces the ExplorationScreenRenderer with status bars, resource tracking, and color-coded thresholds (Part A); a 3x3 minimap with Fog of War visibility tracking (Part B); rich room rendering with object lists, enemy listings, and exit indicators (Part C); and critical bug fixes addressing EF Core TPH index conflicts, missing migrations, and console input interference (Part D).

The HUD system uses Spectre.Console Layout to create a fixed "windowed" TUI with Header (status bars), Body (room view + minimap), and Footer (turn counter) panels. Resource bars display HP, Stamina, and Stress with color-coded Unicode block characters. The minimap renders a 3x3 grid centered on the player with symbol-based room features and danger level coloring. Room views show biome-themed headers, formatted object listings with container/lock detection, and enemy health status.

---

## Part A: The Dashboard (Layout & Status)

**Release Date:** 2025-12-21

### Summary

This release implements the first part of the Exploration HUD system - a persistent, three-pane terminal interface that replaces the scrolling text log with a fixed "windowed" TUI. The ExplorationScreenRenderer uses Spectre.Console Layout to compose Header (status bars), Body (room view + minimap placeholder), and Footer (turn counter) panels. StatusWidget provides color-coded resource bars using Unicode block characters, with 4-tier HP coloring, 2-tier Stamina coloring, and 5-tier Stress coloring. GameService is updated to render the exploration HUD before each input prompt during the Exploration phase. This release includes 18 unit tests for color threshold logic and bar rendering.

---

### New Files Created

#### Core Layer
| File | Purpose |
|------|---------|
| `RuneAndRust.Core/Interfaces/IExplorationScreenRenderer.cs` | Interface for exploration HUD rendering |
| `RuneAndRust.Core/ViewModels/ExplorationViewModel.cs` | Immutable record for exploration display data |

#### Terminal Layer
| File | Purpose |
|------|---------|
| `RuneAndRust.Terminal/Rendering/StatusWidget.cs` | Static helper for colored resource bars (HP/Stamina/Stress) |
| `RuneAndRust.Terminal/Rendering/ExplorationScreenRenderer.cs` | Layout engine with 3-pane interface using Spectre.Console |

#### Test Layer
| File | Purpose |
|------|---------|
| `RuneAndRust.Tests/Terminal/StatusWidgetTests.cs` | 18 unit tests for color logic and bar rendering |

---

### Files Modified

| File | Change |
|------|--------|
| `RuneAndRust.Engine/Services/GameService.cs` | Added IExplorationScreenRenderer + IServiceScopeFactory injection, render call in exploration phase, BuildExplorationViewModelAsync() helper method |
| `RuneAndRust.Terminal/Program.cs` | Registered IExplorationScreenRenderer in DI, updated version to v0.3.5a |
| `RuneAndRust.Tests/Engine/GameServiceTests.cs` | Added Mock<IServiceScopeFactory> for updated constructor |
| `RuneAndRust.Tests/Engine/GameLoopTests.cs` | Added Mock<IServiceScopeFactory> for updated constructor |

---

### Code Implementation Details

#### IExplorationScreenRenderer Interface

```csharp
namespace RuneAndRust.Core.Interfaces;

/// <summary>
/// Defines the contract for rendering the exploration HUD (v0.3.5a).
/// Implementations use Spectre.Console Layout for a persistent, three-pane interface.
/// </summary>
public interface IExplorationScreenRenderer
{
    /// <summary>
    /// Renders the complete exploration screen with status bar, room view, and minimap.
    /// Clears the screen before rendering for a clean display.
    /// </summary>
    /// <param name="viewModel">The exploration view model containing all display data.</param>
    void Render(ExplorationViewModel viewModel);
}
```

#### ExplorationViewModel Record

```csharp
namespace RuneAndRust.Core.ViewModels;

/// <summary>
/// Immutable view model for the exploration screen HUD (v0.3.5a).
/// Contains all display data for the persistent three-pane interface.
/// </summary>
public record ExplorationViewModel(
    string CharacterName,
    int CurrentHp,
    int MaxHp,
    int CurrentStamina,
    int MaxStamina,
    int CurrentStress,
    int MaxStress,
    int CurrentCorruption,
    int MaxCorruption,
    string RoomName,
    string RoomDescription,
    int TurnCount
);
```

#### StatusWidget Color Logic

```csharp
namespace RuneAndRust.Terminal.Rendering;

public static class StatusWidget
{
    /// <summary>
    /// Gets the color for HP based on percentage thresholds (4-tier).
    /// </summary>
    public static Color GetHpColor(int current, int max)
    {
        if (max == 0) return Color.Grey;

        var pct = (double)current / max * 100;
        return pct switch
        {
            <= 25 => Color.Red1,     // Critical
            <= 50 => Color.Orange1,  // Danger
            <= 75 => Color.Yellow,   // Wounded
            _ => Color.Green         // Healthy
        };
    }

    /// <summary>
    /// Gets the color for Stamina based on percentage thresholds (2-tier).
    /// </summary>
    public static Color GetStaminaColor(int current, int max)
    {
        if (max == 0) return Color.Grey;
        var pct = (double)current / max * 100;
        return pct < 20 ? Color.Grey : Color.Cyan1;
    }

    /// <summary>
    /// Gets the color for Stress based on absolute value thresholds (5-tier).
    /// </summary>
    public static Color GetStressColor(int stress)
    {
        return stress switch
        {
            >= 80 => Color.Purple,   // Fractured
            >= 60 => Color.Magenta1, // Distressed
            >= 40 => Color.Yellow,   // Shaken
            >= 20 => Color.Cyan1,    // Unsettled
            _ => Color.Grey          // Stable
        };
    }

    /// <summary>
    /// Renders a text-based progress bar using Unicode block characters.
    /// </summary>
    public static string RenderBar(int current, int max, int width = 20)
    {
        if (max == 0) return new string('░', width);
        var pct = Math.Clamp((double)current / max, 0, 1);
        var filled = (int)(pct * width);
        var empty = width - filled;
        return new string('█', filled) + new string('░', empty);
    }

    /// <summary>
    /// Converts a Spectre.Console Color to its markup string representation.
    /// </summary>
    public static string ToMarkup(this Color color) => color.ToString().ToLowerInvariant();
}
```

#### ExplorationScreenRenderer Layout

```csharp
namespace RuneAndRust.Terminal.Rendering;

public class ExplorationScreenRenderer : IExplorationScreenRenderer
{
    private readonly ILogger<ExplorationScreenRenderer> _logger;

    public ExplorationScreenRenderer(ILogger<ExplorationScreenRenderer> logger)
    {
        _logger = logger;
    }

    public void Render(ExplorationViewModel vm)
    {
        _logger.LogTrace("[HUD] Rendering exploration screen. HP: {HP}/{MaxHP}, Room: {Room}",
            vm.CurrentHp, vm.MaxHp, vm.RoomName);

        // Build fresh layout each render (Layout is mutable, safer to rebuild)
        var rootLayout = new Layout("Root")
            .SplitRows(
                new Layout("Header").Size(3),
                new Layout("Body").SplitColumns(
                    new Layout("Main").Ratio(7),
                    new Layout("Sidebar").Ratio(3)
                ),
                new Layout("Footer").Size(1)
            );

        // 1. Update Header (Status Bar)
        rootLayout["Header"].Update(CreateStatusBar(vm));

        // 2. Update Main Content (Room View - placeholder for v0.3.5c)
        var roomPanel = new Panel(Markup.Escape(vm.RoomDescription))
            .Header($"[bold orange1]{Markup.Escape(vm.RoomName)}[/]")
            .Border(BoxBorder.Rounded)
            .Expand();
        rootLayout["Main"].Update(roomPanel);

        // 3. Update Sidebar (Minimap - placeholder for v0.3.5b)
        var minimapPlaceholder = new Panel("[grey]Minimap coming in v0.3.5b[/]")
            .Header("[yellow]Map[/]")
            .Border(BoxBorder.Rounded);
        rootLayout["Sidebar"].Update(minimapPlaceholder);

        // 4. Update Footer (Turn counter)
        rootLayout["Footer"].Update(new Markup($"[grey]Turn {vm.TurnCount}[/]"));

        // 5. Clear and render complete layout
        AnsiConsole.Clear();
        AnsiConsole.Write(rootLayout);

        _logger.LogTrace("[HUD] Render complete");
    }

    private Panel CreateStatusBar(ExplorationViewModel vm)
    {
        var hpColor = StatusWidget.GetHpColor(vm.CurrentHp, vm.MaxHp);
        var stamColor = StatusWidget.GetStaminaColor(vm.CurrentStamina, vm.MaxStamina);
        var stressColor = StatusWidget.GetStressColor(vm.CurrentStress);

        var grid = new Grid();
        grid.AddColumn(new GridColumn().NoWrap().PadRight(2));  // Name
        grid.AddColumn(new GridColumn().Width(30));              // HP
        grid.AddColumn(new GridColumn().Width(30));              // Stamina
        grid.AddColumn(new GridColumn().Width(18));              // Stress

        var hpBar = StatusWidget.RenderBar(vm.CurrentHp, vm.MaxHp);
        var stamBar = StatusWidget.RenderBar(vm.CurrentStamina, vm.MaxStamina);

        grid.AddRow(
            new Markup($"[bold gold1]{Markup.Escape(vm.CharacterName)}[/]"),
            new Markup($"[bold]HP:[/] [{hpColor.ToMarkup()}]{hpBar}[/] [grey]{vm.CurrentHp}/{vm.MaxHp}[/]"),
            new Markup($"[bold]STA:[/] [{stamColor.ToMarkup()}]{stamBar}[/] [grey]{vm.CurrentStamina}/{vm.MaxStamina}[/]"),
            new Markup($"[{stressColor.ToMarkup()}]Stress: {vm.CurrentStress}%[/]")
        );

        return new Panel(grid).Border(BoxBorder.None);
    }
}
```

#### GameService Integration

```csharp
// Added to GameService constructor
private readonly IExplorationScreenRenderer? _explorationRenderer;
private readonly IServiceScopeFactory _scopeFactory;

// In the game loop, before GetInput():
while (_state.Phase != GamePhase.Quit)
{
    // 1. Render phase-specific UI
    if (_state.Phase == GamePhase.Combat && _combatRenderer != null)
    {
        var viewModel = _combatService.GetViewModel();
        if (viewModel != null) _combatRenderer.Render(viewModel);
    }
    else if (_state.Phase == GamePhase.Exploration && _explorationRenderer != null)
    {
        var viewModel = await BuildExplorationViewModelAsync();
        if (viewModel != null) _explorationRenderer.Render(viewModel);
    }
    // ... rest of loop
}

// Helper method to build ViewModel
private async Task<ExplorationViewModel?> BuildExplorationViewModelAsync()
{
    if (_state.CurrentCharacter == null)
    {
        _logger.LogWarning("[HUD] Cannot build exploration ViewModel: No current character");
        return null;
    }

    string roomName = "Unknown";
    string roomDescription = "You are in an unknown location.";

    if (_state.CurrentRoomId.HasValue)
    {
        using var scope = _scopeFactory.CreateScope();
        var roomRepo = scope.ServiceProvider.GetRequiredService<IRoomRepository>();
        var room = await roomRepo.GetByIdAsync(_state.CurrentRoomId.Value);
        if (room != null)
        {
            roomName = room.Name;
            roomDescription = room.Description;
        }
    }

    var character = _state.CurrentCharacter;
    return new ExplorationViewModel(
        CharacterName: character.Name,
        CurrentHp: character.CurrentHP,
        MaxHp: character.MaxHP,
        CurrentStamina: character.CurrentStamina,
        MaxStamina: character.MaxStamina,
        CurrentStress: character.PsychicStress,
        MaxStress: character.MaxPsychicStress,
        CurrentCorruption: character.Corruption,
        MaxCorruption: character.MaxCorruption,
        RoomName: roomName,
        RoomDescription: roomDescription,
        TurnCount: _state.TurnCount
    );
}
```

---

### Status Bar Color Thresholds

#### HP Bar (4-tier)
| Threshold | Color | State | Example |
|-----------|-------|-------|---------|
| > 75% | Green | Healthy | `████████████████████ 90/100` |
| 50-75% | Yellow | Wounded | `████████████░░░░░░░░ 60/100` |
| 25-49% | Orange | Danger | `███████░░░░░░░░░░░░░ 35/100` |
| <= 25% | Red | Critical | `██░░░░░░░░░░░░░░░░░░ 10/100` |

#### Stamina Bar (2-tier)
| Threshold | Color | State |
|-----------|-------|-------|
| >= 20% | Cyan | Active |
| < 20% | Grey | Exhausted |

#### Stress Display (5-tier)
| Value | Color | State |
|-------|-------|-------|
| < 20 | Grey | Stable |
| 20-39 | Cyan | Unsettled |
| 40-59 | Yellow | Shaken |
| 60-79 | Magenta | Distressed |
| >= 80 | Purple | Fractured |

---

### User Interface

#### Exploration HUD Layout (v0.3.5a)

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                                                                             │
│  Ragnar     HP: ██████████████░░░░░░ 70/100  STA: ████████████████████ 50/50│
│                                                         Stress: 15%        │
│                                                                             │
├──────────────────────────────────────────────────────┬──────────────────────┤
│ Entry Hall                                           │ Map                  │
│ ──────────────────────────────────────────────────── │ ──────────────────── │
│                                                      │                      │
│ A vast chamber of corroded iron and crumbling        │ Minimap coming in    │
│ stone. The air is thick with the scent of ozone      │ v0.3.5b              │
│ and ancient dust. Shadows pool in the corners,       │                      │
│ and the faint hum of dormant machinery echoes        │                      │
│ from somewhere below.                                │                      │
│                                                      │                      │
│                                                      │                      │
│                                                      │                      │
├──────────────────────────────────────────────────────┴──────────────────────┤
│ Turn 1                                                                      │
└─────────────────────────────────────────────────────────────────────────────┘
```

#### Layout Structure

```
Root
├── Header (Size: 3 rows)
│   └── StatusBar Grid [Name | HP Bar | Stamina Bar | Stress]
├── Body (Flexible)
│   ├── Main (Ratio: 7)
│   │   └── Room Panel [Room Name Header, Room Description]
│   └── Sidebar (Ratio: 3)
│       └── Minimap Panel [Placeholder for v0.3.5b]
└── Footer (Size: 1 row)
    └── Turn Counter Markup
```

#### Progress Bar Rendering

```
Full HP:    ████████████████████ 100/100  (20 filled blocks)
75% HP:     ███████████████░░░░░ 75/100   (15 filled, 5 empty)
50% HP:     ██████████░░░░░░░░░░ 50/100   (10 filled, 10 empty)
25% HP:     █████░░░░░░░░░░░░░░░ 25/100   (5 filled, 15 empty)
Empty HP:   ░░░░░░░░░░░░░░░░░░░░ 0/100    (20 empty blocks)
```

---

### Test Coverage

#### StatusWidgetTests (18 tests)

| Test Name | Description |
|-----------|-------------|
| `GetHpColor_Critical_ReturnsRed` | HP at 10/100 returns Red1 |
| `GetHpColor_Danger_ReturnsOrange` | HP at 35/100 returns Orange1 |
| `GetHpColor_Wounded_ReturnsYellow` | HP at 60/100 returns Yellow |
| `GetHpColor_Healthy_ReturnsGreen` | HP at 90/100 returns Green |
| `GetHpColor_ZeroMax_ReturnsGrey` | Edge case: max HP is 0 |
| `GetStaminaColor_Exhausted_ReturnsGrey` | Stamina at 10% returns Grey |
| `GetStaminaColor_Active_ReturnsCyan` | Stamina at 60% returns Cyan1 |
| `GetStaminaColor_ExactlyTwentyPercent_ReturnsCyan` | Boundary test at 20% |
| `GetStressColor_Stable_ReturnsGrey` | Stress at 10 returns Grey |
| `GetStressColor_Unsettled_ReturnsCyan` | Stress at 25 returns Cyan1 |
| `GetStressColor_Shaken_ReturnsYellow` | Stress at 45 returns Yellow |
| `GetStressColor_Distressed_ReturnsMagenta` | Stress at 70 returns Magenta1 |
| `GetStressColor_Fractured_ReturnsPurple` | Stress at 85 returns Purple |
| `RenderBar_FullHealth_AllFilled` | 100/100 returns 20 filled blocks |
| `RenderBar_HalfHealth_HalfFilled` | 50/100 returns 10 filled, 10 empty |
| `RenderBar_Empty_AllEmpty` | 0/100 returns 20 empty blocks |
| `RenderBar_ZeroMax_AllEmpty` | Edge case: max is 0 |
| `RenderBar_OverMax_ClampedToFull` | 150/100 clamped to full bar |

---

### Logging Matrix

| Context | Level | Template |
|---------|-------|----------|
| Render Start | Trace | `"[HUD] Rendering exploration screen. HP: {HP}/{MaxHP}, Room: {Room}"` |
| Render Complete | Trace | `"[HUD] Render complete"` |
| ViewModel Build | Debug | `"[HUD] Building exploration ViewModel for {Character} in {Room}"` |
| No Character | Warning | `"[HUD] Cannot build exploration ViewModel: No current character"` |

---

### DI Registration

Added to `Program.cs`:

```csharp
// Register Exploration HUD (v0.3.5a)
services.AddSingleton<IExplorationScreenRenderer, ExplorationScreenRenderer>();

// Version update
AnsiConsole.MarkupLine("[green]Rune & Rust v0.3.5a Booting...[/]");
```

---

### Architecture Notes

#### Service Lifetime Considerations

- `IExplorationScreenRenderer` is registered as **Singleton** (same as CombatScreenRenderer)
- `IRoomRepository` is **Scoped**, so GameService uses `IServiceScopeFactory` to create a scope for room lookup
- ViewModel is built fresh each render cycle to reflect current game state

#### Layout Rendering Pattern

1. Build fresh Layout each render (Layout is mutable)
2. Update all layout regions with current data
3. AnsiConsole.Clear() before Write()
4. Single AnsiConsole.Write(rootLayout) call renders complete HUD

#### Placeholder Panels

- **Sidebar (Minimap)**: Displays "Minimap coming in v0.3.5b" - will be implemented next
- **Main (Room View)**: Currently shows room description; v0.3.5c will add object lists, exits, etc.

---

### Build Verification

```
Build succeeded.
    0 Error(s)
    (Existing warnings only)

Test run:
  Passed: 1962 (non-PostgreSQL)
  Failed: 0
  Skipped: 0
```

---

### Directory Structure Changes

```
RuneAndRust/
├── RuneAndRust.Core/
│   ├── Interfaces/
│   │   ├── IExplorationScreenRenderer.cs     [NEW]
│   │   └── ... (existing interfaces)
│   └── ViewModels/
│       ├── CombatViewModel.cs
│       └── ExplorationViewModel.cs           [NEW]
├── RuneAndRust.Engine/
│   └── Services/
│       └── GameService.cs                    [MODIFIED]
├── RuneAndRust.Terminal/
│   ├── Program.cs                            [MODIFIED]
│   └── Rendering/
│       ├── StatPreviewRenderer.cs
│       ├── TypewriterRenderer.cs
│       ├── StatusWidget.cs                   [NEW]
│       └── ExplorationScreenRenderer.cs      [NEW]
└── RuneAndRust.Tests/
    ├── Engine/
    │   ├── GameServiceTests.cs               [MODIFIED]
    │   └── GameLoopTests.cs                  [MODIFIED]
    └── Terminal/
        ├── TitleScreenServiceTests.cs
        ├── VictoryScreenRendererTests.cs
        └── StatusWidgetTests.cs              [NEW]
```

---

### Next Steps (v0.3.5b: The Minimap)

Planned features for the next sub-release:
- ASCII minimap generation from room graph
- Player position indicator
- Visited/unvisited room markers
- Exit direction indicators
- Real-time minimap updates on navigation

---

### Notes

- Unicode block characters (█, ░) used for text-based progress bars work in all modern terminals
- Color.ToMarkup() extension converts Spectre Color enum to lowercase string for markup
- Layout uses fixed sizes for Header (3 rows) and Footer (1 row), with flexible Body split 70/30
- IServiceScopeFactory pattern allows Singleton service to access Scoped dependencies safely
- Version string updated to v0.3.5a in Program.cs boot message

---

## Part B: The Cartographer (Minimap)

**Release Date:** 2025-12-21

### Summary

This release implements the MinimapRenderer to display a 3x3 grid of rooms centered on the player's position, with Fog of War visibility tracking. The minimap replaces the placeholder sidebar from v0.3.5a and introduces room symbol resolution based on features (stairs, bosses, settlements, anchors) and danger levels. A new `VisitedRoomIds` HashSet in GameState tracks explored rooms for the Fog of War system. The RoomFeature enum is extended with StairsUp, StairsDown, BossLair, and Settlement values. A batch query `GetRoomsInGridAsync()` is added to IRoomRepository to efficiently fetch the 3x3 grid without N+1 queries. This release includes 22 unit tests for symbol resolution, color logic, and Z-level indicators.

---

### New Files Created

#### Terminal Layer
| File | Purpose |
|------|---------|
| `RuneAndRust.Terminal/Rendering/MinimapRenderer.cs` | Static helper for 3x3 grid rendering with Fog of War and symbol resolution |

#### Test Layer
| File | Purpose |
|------|---------|
| `RuneAndRust.Tests/Terminal/MinimapRendererTests.cs` | 22 unit tests for symbol/color logic, Fog of War, and Z-level indicators |

---

### Files Modified

| File | Change |
|------|--------|
| `RuneAndRust.Core/Enums/RoomFeature.cs` | Added StairsUp (4), StairsDown (5), BossLair (6), Settlement (7) enum values |
| `RuneAndRust.Core/Models/GameState.cs` | Added `HashSet<Guid> VisitedRoomIds` property for Fog of War tracking |
| `RuneAndRust.Core/Interfaces/IRoomRepository.cs` | Added `GetRoomsInGridAsync(z, minX, maxX, minY, maxY)` batch query method |
| `RuneAndRust.Core/ViewModels/ExplorationViewModel.cs` | Added PlayerPosition, LocalMapRooms, VisitedRoomIds properties for minimap data |
| `RuneAndRust.Persistence/Repositories/RoomRepository.cs` | Implemented `GetRoomsInGridAsync()` using EF Core LINQ query |
| `RuneAndRust.Engine/Services/NavigationService.cs` | Added `VisitedRoomIds.Add(nextRoomId)` after each successful move |
| `RuneAndRust.Engine/Services/GameService.cs` | Updated `BuildExplorationViewModelAsync()` to fetch 3x3 grid data |
| `RuneAndRust.Terminal/Rendering/ExplorationScreenRenderer.cs` | Replaced minimap placeholder with MinimapRenderer.Render() call |
| `RuneAndRust.Terminal/Program.cs` | Added starting room to VisitedRoomIds, updated version to v0.3.5b |

---

### Code Implementation Details

#### RoomFeature Enum Extension

```csharp
public enum RoomFeature
{
    None = 0,
    RunicAnchor = 1,    // Sanctuary rest
    Workbench = 2,      // Crafting
    AlchemyTable = 3,   // Potion brewing
    StairsUp = 4,       // Vertical navigation (v0.3.5b)
    StairsDown = 5,     // Vertical navigation (v0.3.5b)
    BossLair = 6,       // Boss encounter room (v0.3.5b)
    Settlement = 7      // Safe zone/vendor (v0.3.5b)
}
```

#### GameState VisitedRoomIds

```csharp
/// <summary>
/// Tracks which rooms the player has visited for Fog of War (v0.3.5b).
/// Used by MinimapRenderer to determine visibility.
/// </summary>
public HashSet<Guid> VisitedRoomIds { get; set; } = new();

// In Reset() method:
VisitedRoomIds.Clear();
```

#### ExplorationViewModel Extension

```csharp
public record ExplorationViewModel(
    // Existing properties from v0.3.5a...
    string CharacterName,
    int CurrentHp,
    int MaxHp,
    int CurrentStamina,
    int MaxStamina,
    int CurrentStress,
    int MaxStress,
    int CurrentCorruption,
    int MaxCorruption,
    string RoomName,
    string RoomDescription,
    int TurnCount,

    // NEW: Minimap data (v0.3.5b)
    Coordinate PlayerPosition,
    List<Room> LocalMapRooms,
    HashSet<Guid> VisitedRoomIds
);
```

#### GetRoomsInGridAsync Repository Method

```csharp
/// <inheritdoc/>
public async Task<IEnumerable<Room>> GetRoomsInGridAsync(int z, int minX, int maxX, int minY, int maxY)
{
    _roomLogger.LogDebug(
        "[Room] Fetching rooms in grid Z={Z}, X=[{MinX},{MaxX}], Y=[{MinY},{MaxY}]",
        z, minX, maxX, minY, maxY);

    var rooms = await _dbSet
        .Where(r => r.Position.Z == z
                 && r.Position.X >= minX && r.Position.X <= maxX
                 && r.Position.Y >= minY && r.Position.Y <= maxY)
        .ToListAsync();

    _roomLogger.LogDebug("[Room] Retrieved {Count} rooms in grid", rooms.Count);

    return rooms;
}
```

#### NavigationService Room Visitation Tracking

```csharp
// After line 85 (TurnCount++), added:
_gameState.VisitedRoomIds.Add(nextRoomId);

_logger.LogDebug("[Navigation] Room {RoomId} marked as visited. Total visited: {Count}",
    nextRoomId, _gameState.VisitedRoomIds.Count);
```

#### MinimapRenderer Implementation

```csharp
namespace RuneAndRust.Terminal.Rendering;

/// <summary>
/// Renders a 3x3 minimap grid centered on the player position (v0.3.5b).
/// </summary>
public static class MinimapRenderer
{
    private const int Radius = 1;  // 3x3 grid (center ± 1)

    /// <summary>
    /// Renders the minimap panel for the exploration HUD sidebar.
    /// </summary>
    public static Panel Render(Coordinate center, List<Room> localMap, HashSet<Guid> visited)
    {
        var grid = new Grid();

        // Add 3 columns for the 3x3 grid
        for (int i = 0; i < (Radius * 2) + 1; i++)
        {
            grid.AddColumn(new GridColumn().Width(3).NoWrap());
        }

        // Iterate Y from top to bottom (Y+ at top, Y- at bottom)
        for (int y = center.Y + Radius; y >= center.Y - Radius; y--)
        {
            var rowItems = new List<IRenderable>();

            for (int x = center.X - Radius; x <= center.X + Radius; x++)
            {
                var cellPos = new Coordinate(x, y, center.Z);
                var room = localMap.FirstOrDefault(r =>
                    r.Position.X == x && r.Position.Y == y && r.Position.Z == center.Z);

                rowItems.Add(ResolveTile(room, center, cellPos, visited));
            }

            grid.AddRow(rowItems.ToArray());
        }

        // Add Z-level indicator row
        var zIndicator = GetZLevelIndicator(center, localMap);
        grid.AddRow(new Markup(zIndicator), new Text(""), new Text(""));

        return new Panel(grid)
            .Header("[yellow]Sector Map[/]")
            .Border(BoxBorder.Rounded);
    }

    /// <summary>
    /// Resolves the symbol and color for a minimap tile.
    /// </summary>
    public static Markup ResolveTile(Room? room, Coordinate center, Coordinate cellPos, HashSet<Guid> visited)
    {
        // Player position - always visible
        if (cellPos.X == center.X && cellPos.Y == center.Y && cellPos.Z == center.Z)
            return new Markup("[cyan]@[/]");

        // No room at this position
        if (room == null)
            return new Markup("[grey]·[/]");

        // Fog of War - room exists but not visited
        if (!visited.Contains(room.Id))
            return new Markup("[grey]░[/]");

        // Visited room - resolve by feature priority
        var (symbol, color) = GetRoomSymbol(room);
        return new Markup($"[{color}]{symbol}[/]");
    }

    /// <summary>
    /// Gets the symbol and color for a visited room based on its features.
    /// Priority order: Boss > Stairs > Settlement > Anchor > Workstation > Standard
    /// </summary>
    public static (string Symbol, string Color) GetRoomSymbol(Room room)
    {
        if (room.HasFeature(RoomFeature.BossLair))
            return ("☠", "red");

        if (room.HasFeature(RoomFeature.StairsUp))
            return ("▲", "white");

        if (room.HasFeature(RoomFeature.StairsDown))
            return ("▼", "white");

        if (room.HasFeature(RoomFeature.Settlement))
            return ("⌂", "blue");

        if (room.HasFeature(RoomFeature.RunicAnchor))
            return ("◆", "cyan");

        if (room.HasFeature(RoomFeature.Workbench) || room.HasFeature(RoomFeature.AlchemyTable))
            return ("⚒", "yellow");

        // Danger level coloring for standard rooms
        return room.DangerLevel switch
        {
            DangerLevel.Lethal => ("O", "red"),
            DangerLevel.Hostile => ("O", "orange1"),
            DangerLevel.Unstable => ("O", "yellow"),
            _ => ("O", "grey")  // Safe
        };
    }

    /// <summary>
    /// Renders Z-level context indicator showing available vertical movement.
    /// </summary>
    public static string GetZLevelIndicator(Coordinate center, List<Room> localMap)
    {
        var hasUp = localMap.Any(r => r.HasFeature(RoomFeature.StairsUp));
        var hasDown = localMap.Any(r => r.HasFeature(RoomFeature.StairsDown));

        return (hasUp, hasDown) switch
        {
            (true, true) => $"[grey]Z:{center.Z} ▲▼[/]",
            (true, false) => $"[grey]Z:{center.Z} ▲[/]",
            (false, true) => $"[grey]Z:{center.Z} ▼[/]",
            _ => $"[grey]Z:{center.Z}[/]"
        };
    }
}
```

#### ExplorationScreenRenderer Minimap Integration

```csharp
// Replaced placeholder code with:
// 3. Update Sidebar (Minimap - v0.3.5b)
var minimapPanel = MinimapRenderer.Render(
    vm.PlayerPosition,
    vm.LocalMapRooms,
    vm.VisitedRoomIds);
rootLayout["Sidebar"].Update(minimapPanel);
```

#### GameService ViewModel Building Update

```csharp
private async Task<ExplorationViewModel?> BuildExplorationViewModelAsync()
{
    // ... existing validation ...

    Coordinate playerPosition = Coordinate.Origin;
    List<Room> localMapRooms = new();

    if (_state.CurrentRoomId.HasValue)
    {
        using var scope = _scopeFactory.CreateScope();
        var roomRepo = scope.ServiceProvider.GetRequiredService<IRoomRepository>();
        var room = await roomRepo.GetByIdAsync(_state.CurrentRoomId.Value);
        if (room != null)
        {
            roomName = room.Name;
            roomDescription = room.Description;
            playerPosition = room.Position;

            // Fetch 3x3 grid around player for minimap (v0.3.5b)
            const int radius = 1;
            localMapRooms = (await roomRepo.GetRoomsInGridAsync(
                playerPosition.Z,
                playerPosition.X - radius,
                playerPosition.X + radius,
                playerPosition.Y - radius,
                playerPosition.Y + radius
            )).ToList();

            _logger.LogTrace("[HUD] Fetched {Count} rooms for minimap grid", localMapRooms.Count);
        }
    }

    return new ExplorationViewModel(
        // ... existing properties ...
        PlayerPosition: playerPosition,
        LocalMapRooms: localMapRooms,
        VisitedRoomIds: _state.VisitedRoomIds
    );
}
```

#### Program.cs Starting Room Visitation

```csharp
// After: gameState.CurrentRoomId = startRoomId;
gameState.VisitedRoomIds.Add(startRoomId);  // Mark starting room as visited (v0.3.5b)

// For loaded games:
gameState.VisitedRoomIds = loadedState.VisitedRoomIds;  // Restore fog of war (v0.3.5b)
```

---

### Symbol Reference Table

| Symbol | Color | Meaning | RoomFeature/Condition |
|--------|-------|---------|----------------------|
| `@` | Cyan | Player position | Center of grid |
| `░` | Grey | Fog of War | Room not in VisitedRoomIds |
| `·` | Grey | Empty/Void | No room at position |
| `☠` | Red | Boss Lair | BossLair feature |
| `▲` | White | Stairs Up | StairsUp feature |
| `▼` | White | Stairs Down | StairsDown feature |
| `⌂` | Blue | Settlement | Settlement feature |
| `◆` | Cyan | Runic Anchor | RunicAnchor feature |
| `⚒` | Yellow | Workstation | Workbench or AlchemyTable |
| `O` | Red | Lethal Room | DangerLevel.Lethal |
| `O` | Orange | Hostile Room | DangerLevel.Hostile |
| `O` | Yellow | Unstable Room | DangerLevel.Unstable |
| `O` | Grey | Safe Room | DangerLevel.Safe |

---

### User Interface

#### Minimap Visual Example

```
┌────────────────┐
│ Sector Map     │
├────────────────┤
│  ░   O   ·     │   ← Y+1 (North)
│  O   @   ▲     │   ← Y=0 (Player row)
│  ⌂   O   O     │   ← Y-1 (South)
│                │
│ Z:0 ▲          │   ← Z-level indicator
└────────────────┘
```

#### Complete Exploration HUD (v0.3.5b)

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                                                                             │
│  Ragnar     HP: ██████████████░░░░░░ 70/100  STA: ████████████████████ 50/50│
│                                                         Stress: 15%        │
│                                                                             │
├──────────────────────────────────────────────────────┬──────────────────────┤
│ Entry Hall                                           │ Sector Map           │
│ ──────────────────────────────────────────────────── │ ────────────────     │
│                                                      │                      │
│ A vast chamber of corroded iron and crumbling        │   ░   O   ·          │
│ stone. The air is thick with the scent of ozone      │   O   @   ▲          │
│ and ancient dust. Shadows pool in the corners,       │   ⌂   O   O          │
│ and the faint hum of dormant machinery echoes        │                      │
│ from somewhere below.                                │  Z:0 ▲               │
│                                                      │                      │
│                                                      │                      │
├──────────────────────────────────────────────────────┴──────────────────────┤
│ Turn 1                                                                      │
└─────────────────────────────────────────────────────────────────────────────┘
```

#### Minimap Grid Structure

```
       X-1    X=0    X+1
      ┌─────┬─────┬─────┐
Y+1   │  ░  │  O  │  ·  │   North (Y+)
      ├─────┼─────┼─────┤
Y=0   │  O  │  @  │  ▲  │   Player row
      ├─────┼─────┼─────┤
Y-1   │  ⌂  │  O  │  O  │   South (Y-)
      └─────┴─────┴─────┘
              ↓
          Z:0 ▲  (Z-level indicator)
```

---

### Test Coverage

#### MinimapRendererTests (22 tests)

| Test Name | Description |
|-----------|-------------|
| `ResolveTile_PlayerPosition_ReturnsCyanAt` | Center position → "@" cyan |
| `ResolveTile_NullRoom_ReturnsGreyDot` | No room → "·" grey |
| `ResolveTile_UnvisitedRoom_ReturnsGreyFog` | Not visited → "░" grey |
| `ResolveTile_VisitedRoom_ReturnsSymbol` | Visited → appropriate symbol |
| `GetRoomSymbol_BossLair_ReturnsSkullRed` | BossLair → "☠" red |
| `GetRoomSymbol_StairsUp_ReturnsArrowWhite` | StairsUp → "▲" white |
| `GetRoomSymbol_StairsDown_ReturnsArrowWhite` | StairsDown → "▼" white |
| `GetRoomSymbol_Settlement_ReturnsHouseBlue` | Settlement → "⌂" blue |
| `GetRoomSymbol_RunicAnchor_ReturnsDiamondCyan` | RunicAnchor → "◆" cyan |
| `GetRoomSymbol_Workbench_ReturnsHammerYellow` | Workbench → "⚒" yellow |
| `GetRoomSymbol_AlchemyTable_ReturnsHammerYellow` | AlchemyTable → "⚒" yellow |
| `GetRoomSymbol_LethalDanger_ReturnsRedO` | Lethal → "O" red |
| `GetRoomSymbol_HostileDanger_ReturnsOrangeO` | Hostile → "O" orange1 |
| `GetRoomSymbol_UnstableDanger_ReturnsYellowO` | Unstable → "O" yellow |
| `GetRoomSymbol_SafeRoom_ReturnsGreyO` | Safe → "O" grey |
| `GetRoomSymbol_BossOverridesStairs_ReturnsSkull` | Boss takes priority over other features |
| `GetZLevelIndicator_HasBothStairs_ShowsBothArrows` | Both stairs → "Z:0 ▲▼" |
| `GetZLevelIndicator_OnlyStairsUp_ShowsUpArrow` | Only up → "Z:0 ▲" |
| `GetZLevelIndicator_OnlyStairsDown_ShowsDownArrow` | Only down → "Z:0 ▼" |
| `GetZLevelIndicator_NoStairs_ShowsOnlyZLevel` | No stairs → "Z:5" |
| `Render_EmptyMap_ReturnsPanel` | Empty map returns valid panel |
| `Render_WithRooms_ReturnsPanel` | Map with rooms returns valid panel |

---

### Logging Matrix

| Context | Level | Template |
|---------|-------|----------|
| Room Visited | Debug | `"[Navigation] Room {RoomId} marked as visited. Total visited: {Count}"` |
| Grid Query Start | Debug | `"[Room] Fetching rooms in grid Z={Z}, X=[{MinX},{MaxX}], Y=[{MinY},{MaxY}]"` |
| Grid Query Result | Debug | `"[Room] Retrieved {Count} rooms in grid"` |
| Minimap Data Fetch | Trace | `"[HUD] Fetched {Count} rooms for minimap grid"` |

---

### Architecture Notes

#### Fog of War System

1. **VisitedRoomIds HashSet**: O(1) lookup for visited status
2. **Persisted to save files**: JSON serializes HashSet as array
3. **Cleared on Reset()**: New game starts with no visited rooms
4. **Starting room marked immediately**: Before prologue plays
5. **Rooms marked on movement**: In NavigationService.MoveAsync()

#### Batch Query Optimization

- `GetRoomsInGridAsync()` fetches all 9 potential rooms in single query
- Avoids N+1 queries (fetching each room individually)
- EF Core translates to efficient SQL WHERE clause
- Returns only rooms within coordinate bounds

#### Symbol Priority Order

When a room has multiple features, symbol resolution follows this priority:
1. BossLair (☠) - Highest priority, always shows boss indicator
2. StairsUp/StairsDown (▲/▼) - Important for navigation
3. Settlement (⌂) - Safe zone indicator
4. RunicAnchor (◆) - Rest point
5. Workbench/AlchemyTable (⚒) - Crafting stations
6. DangerLevel-based (O) - Default with color coding

#### Y-Axis Inversion

- Grid renders Y+ at top, Y- at bottom (standard map convention)
- Iteration: `for (int y = center.Y + Radius; y >= center.Y - Radius; y--)`
- Matches player expectation: "North is up"

---

### Build Verification

```
Build succeeded.
    0 Error(s)
    (Existing warnings only)

Test run:
  Passed: 1984 (non-PostgreSQL)
  Failed: 0
  Skipped: 0

New tests: 22 (MinimapRendererTests)
```

---

### Directory Structure Changes

```
RuneAndRust/
├── RuneAndRust.Core/
│   ├── Enums/
│   │   └── RoomFeature.cs                         [MODIFIED: +4 values]
│   ├── Interfaces/
│   │   └── IRoomRepository.cs                     [MODIFIED: +GetRoomsInGridAsync]
│   ├── Models/
│   │   └── GameState.cs                           [MODIFIED: +VisitedRoomIds]
│   └── ViewModels/
│       └── ExplorationViewModel.cs                [MODIFIED: +3 properties]
├── RuneAndRust.Engine/
│   └── Services/
│       ├── GameService.cs                         [MODIFIED: +minimap data fetch]
│       └── NavigationService.cs                   [MODIFIED: +room visitation]
├── RuneAndRust.Persistence/
│   └── Repositories/
│       └── RoomRepository.cs                      [MODIFIED: +GetRoomsInGridAsync]
├── RuneAndRust.Terminal/
│   ├── Program.cs                                 [MODIFIED: +start room visited]
│   └── Rendering/
│       ├── ExplorationScreenRenderer.cs           [MODIFIED: +MinimapRenderer call]
│       └── MinimapRenderer.cs                     [NEW]
└── RuneAndRust.Tests/
    └── Terminal/
        └── MinimapRendererTests.cs                [NEW: 22 tests]
```

---

### Next Steps (v0.3.5c: The Room View)

Planned features for the next sub-release:
- Enhanced room description panel with object lists
- Exit direction indicators in room view
- Interactable object highlighting
- Container contents preview
- NPC presence indicators

---

### Notes

- Unicode block characters (░, ▲, ▼, ☠, ⌂, ◆, ⚒) work in all modern terminals
- MinimapRenderer is a static class (no DI needed) for simplicity
- Grid uses fixed 3-character column width for consistent alignment
- Z-level indicator updates dynamically based on local map content
- Loaded games restore VisitedRoomIds from save file for persistent fog of war
- Starting room is marked visited before prologue plays
- Version string updated to v0.3.5b in Program.cs boot message

---

## Part C: The Surveyor (Room Rendering)

**Release Date:** 2025-12-21
**Codename:** The Surveyor
**Status:** Complete

---

### Summary

Version 0.3.5c implements the `RoomRenderer` component, which displays a rich, formatted view of the current room in the exploration HUD Body panel. This replaces the raw text room description with a structured display showing room name with biome-themed coloring, description text, visible objects with color-coded formatting, enemy listings with health status, and available exits.

---

### New Features

#### RoomRenderer (Terminal Layer)
A static helper class that renders the complete room view panel for the exploration HUD Body section.

**Key capabilities:**
- Biome-themed room name headers (Industrial=orange, Organic=green, Void=purple, Ruin=grey)
- Grey-wrapped room descriptions with markup escaping
- Color-coded object listings (containers in gold, locked items with indicator)
- Enemy listings with narrative health status (Healthy, Wounded, Bloodied, Critical, Dead)
- Exit directions in lowercase comma-separated format

#### RoomViewHelper (Engine Layer)
A static helper class providing formatting utilities used by both GameService and RoomRenderer.

**Key methods:**
- `GetBiomeColor(BiomeType)` - Maps biome to Spectre.Console color name
- `FormatObjectName(name, isContainer, isLocked)` - Formats object with markup coloring
- `FormatEnemyName(name, currentHp, maxHp)` - Formats enemy with health status
- `GetNarrativeHealth(percent)` - Converts HP percentage to narrative descriptor

#### ExplorationViewModel Extension
Four new properties added to support room rendering:

| Property | Type | Description |
|----------|------|-------------|
| `VisibleObjects` | `List<string>` | Pre-formatted object names with markup |
| `VisibleEnemies` | `List<string>` | Pre-formatted enemy names with health |
| `Exits` | `string` | Comma-separated lowercase exit directions |
| `BiomeColor` | `string` | Spectre.Console color name for biome theming |

---

### Visual Example

```
+--[orange1]Industrial Forge[/]----------------------+
|                                                     |
| [grey]The forge's ancient machinery lies dormant,  |
| pistons seized with centuries of rust. Faint       |
| heat still emanates from somewhere deep within.[/] |
|                                                     |
| -------------------------------------------------  |
|                                                     |
| [yellow]You see:[/]                                 |
|   [gold1]Iron Coffer[/] [grey](locked)[/]          |
|   [grey]Broken Anvil[/]                             |
|                                                     |
| -------------------------------------------------  |
|                                                     |
| [white]Exits:[/] [grey]north, east, down[/]         |
+-----------------------------------------------------+
```

---

### Color Coding Reference

#### Entity Colors
| Entity Type | Color | Example |
|-------------|-------|---------|
| Containers | Gold | `[gold1]Rusty Chest[/]` |
| Locked containers | Gold + Grey | `[gold1]Locked Box[/] [grey](locked)[/]` |
| Generic objects | Grey | `[grey]Pile of Debris[/]` |
| Enemies | Red | `[red]Blight-Wolf[/] [grey](Wounded)[/]` |
| Exits | White + Grey | `[white]Exits:[/] [grey]north, east[/]` |

#### Biome Colors
| BiomeType | Color | Header Example |
|-----------|-------|----------------|
| Ruin | grey | `[grey]Collapsed Atrium[/]` |
| Industrial | orange1 | `[orange1]Forge Chamber[/]` |
| Organic | green | `[green]Fungal Cavern[/]` |
| Void | purple | `[purple]Void Rift[/]` |

#### Health Status Thresholds
| HP Percentage | Status |
|---------------|--------|
| > 75% | Healthy |
| 51-75% | Wounded |
| 26-50% | Bloodied |
| 1-25% | Critical |
| 0% | Dead |

---

### Files Created

| File | Layer | Purpose |
|------|-------|---------|
| `RuneAndRust.Terminal/Rendering/RoomRenderer.cs` | Terminal | Room view panel rendering |
| `RuneAndRust.Engine/Helpers/RoomViewHelper.cs` | Engine | Formatting utilities |
| `RuneAndRust.Tests/Terminal/RoomRendererTests.cs` | Tests | 33 unit tests |

---

### Files Modified

| File | Change |
|------|--------|
| `RuneAndRust.Core/ViewModels/ExplorationViewModel.cs` | Added VisibleObjects, VisibleEnemies, Exits, BiomeColor properties |
| `RuneAndRust.Engine/Services/GameService.cs` | Updated BuildExplorationViewModelAsync() to fetch objects and format room data |
| `RuneAndRust.Terminal/Rendering/ExplorationScreenRenderer.cs` | Replaced raw description panel with RoomRenderer.Render() call |
| `RuneAndRust.Terminal/Program.cs` | Updated version to v0.3.5c |

---

### Test Coverage

#### RoomRendererTests (33 tests)
| Test Category | Test Count | Description |
|---------------|------------|-------------|
| GetBiomeColor | 5 | BiomeType to color mapping |
| FormatObjectName | 5 | Object formatting with containers and locks |
| FormatEnemyName | 4 | Enemy formatting with health status |
| GetNarrativeHealth | 7 | HP percentage to narrative descriptor |
| BuildExitsSection | 3 | Exit formatting and empty state |
| BuildEntitySection | 4 | Object/enemy list rendering |
| BuildDescription | 2 | Description rendering with escaping |
| Render Integration | 3 | Full panel rendering |

---

### Implementation Details

#### Architecture Decision: RoomViewHelper
The formatting logic was extracted to `RoomViewHelper` in the Engine layer to avoid circular dependencies. The Engine layer cannot reference the Terminal layer, so GameService uses RoomViewHelper directly while RoomRenderer delegates to it for consistency.

```
[GameService (Engine)]
       |
       +---> [RoomViewHelper.FormatObjectName()]
       +---> [RoomViewHelper.GetBiomeColor()]
                     |
[RoomRenderer (Terminal)]
       |
       +---> [RoomViewHelper.*] (delegates)
```

#### Object Fetching
Objects are fetched via `IInteractionService.GetVisibleObjectsAsync()` which returns all `InteractableObject` entities in the current room. The objects are then formatted using `RoomViewHelper.FormatObjectName()` with container and lock detection.

#### Enemy Visibility
During the Exploration phase, `VisibleEnemies` remains empty. Enemies are only spawned by `AmbushService` when entering rooms that trigger combat. Future versions may add room-based enemy presence tracking.

#### Markup Escaping
All user-facing text (room names, descriptions, object names) is escaped using either `Markup.Escape()` in RoomRenderer or custom bracket escaping in RoomViewHelper to prevent Spectre.Console markup injection.

---

### Logging Matrix

| Context | Level | Template |
|---------|-------|----------|
| Object Fetch | Trace | `"[HUD] Found {ObjectCount} visible objects in room"` |
| ViewModel Build | Debug | `"[HUD] Building exploration ViewModel for {Character} in {Room}"` |

---

### Dependencies

- `Spectre.Console` - Panel, Markup, Rows, Rule for room rendering
- `RuneAndRust.Core.Entities.InteractableObject` - Object data (Name, IsContainer, IsLocked)
- `RuneAndRust.Core.Enums.BiomeType` - Biome color mapping
- `RuneAndRust.Core.Interfaces.IInteractionService` - Object fetching

---

### Breaking Changes

None. The ExplorationViewModel record was extended with new properties, but all existing code continues to work.

---

### Known Limitations

1. **Enemies not shown during Exploration** - VisibleEnemies remains empty until combat is triggered
2. **No machinery detection** - Cyan coloring for machinery depends on future ObjectType categorization
3. **No NPC support yet** - Green coloring for NPCs awaits NPC entity implementation

---

### Version History

| Version | Codename | Focus |
|---------|----------|-------|
| v0.3.5a | The Cartographer's Easel | ExplorationScreenRenderer foundation |
| v0.3.5b | The Cartographer | MinimapRenderer with Fog of War |
| v0.3.5c | The Surveyor | RoomRenderer with entity display |

---

### Next Steps (v0.3.5d Candidates)

1. **CommandBarRenderer** - Display available commands at the bottom
2. **ContextualHelpPanel** - Show context-sensitive help based on room contents
3. **NotificationToast** - Display transient messages for actions

---

## Part D: The Stabilizer (Bug Fixes & Polish)

**Release Date:** 2025-12-21
**Codename:** The Stabilizer
**Status:** Complete

---

### Summary

Version 0.3.5d addresses critical runtime issues discovered after v0.3.5c deployment, including an EF Core TPH index conflict that prevented application startup, missing database migrations, mouse event interference with console input, and improved UX for duplicate character name handling.

---

### Bug Fixes

#### 1. EF Core TPH Index Conflict (Critical)

**Issue:** Application crashed on startup with `InvalidOperationException`:
```
The index {'RoomId'} cannot be added to the entity type 'InteractableObject'
because an unnamed index on the same properties already exists on entity type 'DynamicHazard'.
```

**Root Cause:** EF Core's Table-per-Hierarchy (TPH) configuration for `InteractableObject` and `DynamicHazard` created conflicting unnamed indexes when both entities mapped to the same table.

**Fix:**
- Removed explicit `HasIndex()` call from `InteractableObject` configuration
- Added `HasBaseType<InteractableObject>()` to `DynamicHazard` configuration
- Index on `RoomId` should be created via database migration instead

**Files Modified:**
| File | Change |
|------|--------|
| `RuneAndRust.Persistence/Data/RuneAndRustDbContext.cs` | Removed index definition, added HasBaseType |

#### 2. Missing Database Tables

**Issue:** Application failed with `relation "AmbientConditions" does not exist` after fixing the TPH issue.

**Root Cause:** The `AmbientConditions` and `HazardTemplates` tables were defined in the DbContext but never migrated to the database.

**Fix:**
- Created new EF Core migration `AddEnvironmentEcosystemTables`
- Applied pending migrations to PostgreSQL database

**Files Created:**
| File | Purpose |
|------|---------|
| `RuneAndRust.Persistence/Migrations/20251222025251_AddEnvironmentEcosystemTables.cs` | Migration for new tables |

#### 3. Mouse Event Interference (Terminal)

**Issue:** "Press any key to continue" prompts triggered repeatedly due to mouse movement events being interpreted as key presses by `Console.ReadKey()`.

**Root Cause:** Some terminals send mouse tracking escape sequences that `Console.ReadKey()` interprets as valid key presses, causing unwanted screen refreshes and infinite loops.

**Fix:**
- Created `ConsoleInputHelper` utility class that filters out:
  - Escape sequences from mouse events
  - Null/empty key events from mouse tracking
- Updated all "Press any key" prompts to use `ConsoleInputHelper.WaitForKeyPress()`

**Files Created:**
| File | Purpose |
|------|---------|
| `RuneAndRust.Terminal/Helpers/ConsoleInputHelper.cs` | Mouse event filtering utility |

**Files Modified:**
| File | Change |
|------|--------|
| `RuneAndRust.Terminal/Services/CreationWizard.cs` | Uses ConsoleInputHelper |
| `RuneAndRust.Terminal/Rendering/TypewriterRenderer.cs` | Uses ConsoleInputHelper |
| `RuneAndRust.Terminal/Services/VictoryScreenRenderer.cs` | Uses ConsoleInputHelper |
| `RuneAndRust.Terminal/Services/RestScreenRenderer.cs` | Uses ConsoleInputHelper |

#### 4. Duplicate Character Name Handling

**Issue:** When entering a duplicate character name, the wizard cancelled entirely instead of allowing retry.

**Root Cause:** The name validation logic returned `null` immediately on duplicate detection.

**Fix:**
- Changed name entry to loop until valid name is provided or user cancels
- Added helpful error message: "A character with that name already exists. Please choose another."

**Files Modified:**
| File | Change |
|------|--------|
| `RuneAndRust.Terminal/Services/CreationWizard.cs` | Name entry now loops on duplicate |

---

### New Files

| File | Layer | Purpose |
|------|-------|---------|
| `RuneAndRust.Terminal/Helpers/ConsoleInputHelper.cs` | Terminal | Mouse event filtering for console input |
| `RuneAndRust.Persistence/Migrations/20251222025251_AddEnvironmentEcosystemTables.cs` | Persistence | Database migration |

---

### Implementation Details

#### ConsoleInputHelper

```csharp
public static class ConsoleInputHelper
{
    public static ConsoleKeyInfo ReadKeyFiltered(bool intercept = true)
    {
        while (true)
        {
            var key = Console.ReadKey(intercept);

            // Filter out escape sequences from mouse events
            if (key.Key == ConsoleKey.Escape)
            {
                DrainEscapeSequence();
                continue;
            }

            // Filter out null/empty key events
            if (key.KeyChar == '\0' && key.Key == 0)
                continue;

            return key;
        }
    }

    public static void WaitForKeyPress() => ReadKeyFiltered(intercept: true);

    private static void DrainEscapeSequence()
    {
        Thread.Sleep(10);
        while (Console.KeyAvailable)
            Console.ReadKey(intercept: true);
    }
}
```

#### TPH Index Resolution

The EF Core configuration was updated to avoid index conflicts:

```csharp
// InteractableObject configuration
modelBuilder.Entity<InteractableObject>(entity =>
{
    // ... discriminator setup ...

    // Note: Index on RoomId is created via migration, not here.
    // TPH inheritance with DynamicHazard causes EF Core to create
    // conflicting unnamed indexes.

    entity.Property(o => o.RoomId).IsRequired();
});

// DynamicHazard configuration
modelBuilder.Entity<DynamicHazard>(entity =>
{
    // Explicitly set base type to prevent duplicate index creation
    entity.HasBaseType<InteractableObject>();
    // ... property configurations ...
});
```

#### Character Name Retry Loop

```csharp
// Step 0: Name entry with duplicate check loop (v0.3.5d)
string? name = null;
while (name == null)
{
    var enteredName = PromptForName();
    if (string.IsNullOrEmpty(enteredName) ||
        enteredName.Equals("cancel", StringComparison.OrdinalIgnoreCase))
    {
        return null;
    }

    if (await _characterRepository.NameExistsAsync(enteredName))
    {
        AnsiConsole.MarkupLine(
            "[red]A character with that name already exists. Please choose another.[/]");
    }
    else
    {
        name = enteredName;
    }
}
```

---

### Test Coverage

All 1880 existing unit tests continue to pass. No new tests were added as changes were primarily infrastructure/UX fixes.

---

### Logging Matrix

| Context | Level | Template |
|---------|-------|----------|
| Duplicate Name | Warning | `"[Wizard] Duplicate character name attempted: {Name}"` |
| Name Entry Cancel | Info | `"[Wizard] Character creation cancelled at name entry"` |

---

### Breaking Changes

None. All changes are backwards compatible.

---

### Known Limitations

1. **Alternative Mouse Fix:** Users can also disable mouse reporting in terminal settings as an alternative to the code fix.

2. **Terminal Compatibility:** The `ConsoleInputHelper` has been tested with common terminals. Exotic terminal emulators may have different escape sequence patterns.

---

### Migration Required

After updating to v0.3.5d, run the following to apply database migrations:

```bash
dotnet ef database update --project RuneAndRust.Persistence --startup-project RuneAndRust.Terminal
```

---

### Version History

| Version | Codename | Focus |
|---------|----------|-------|
| v0.3.5a | The Cartographer's Easel | ExplorationScreenRenderer foundation |
| v0.3.5b | The Cartographer | MinimapRenderer with Fog of War |
| v0.3.5c | The Surveyor | RoomRenderer with entity display |
| v0.3.5d | The Stabilizer | Bug fixes and polish |

---

### Next Steps (v0.3.6 Candidates)

1. **CommandBarRenderer** - Display available commands at the bottom
2. **ContextualHelpPanel** - Show context-sensitive help based on room contents
3. **NotificationToast** - Display transient messages for actions
