# v0.18.4c Design Specification: Coherence System (Arcanist)

**Version:** 0.18.4c
**Parent:** v0.18.4 (Specialization-Specific Resources)
**Prerequisites:** v0.17.4 (Specialization System), v0.18.0 (Psychic Stress System), v0.6.x (Dice System)
**Status:** Design Complete
**Estimated Unit Tests:** ~5

---

## Table of Contents

1. [Executive Summary](#1-executive-summary)
2. [Feature Overview](#2-feature-overview)
3. [Architecture Diagrams](#3-architecture-diagrams)
4. [User Stories](#4-user-stories)
5. [Domain Model](#5-domain-model)
6. [Data Model](#6-data-model)
7. [Logging Specifications](#7-logging-specifications)
8. [Unit Testing Requirements](#8-unit-testing-requirements)
9. [Deliverable Checklist](#9-deliverable-checklist)
10. [Acceptance Criteria](#10-acceptance-criteria)
11. [Dependencies](#11-dependencies)
12. [Future Considerations](#12-future-considerations)

---

## 1. Executive Summary

This design specification defines the **Coherence System** for the Arcanist specialization — a reality-stability meter with both power bonuses and dangerous instability at extremes, featuring cascade failures and ultimate apotheosis abilities.

v0.18.4c establishes the **Domain Layer Foundation** for Coherence by defining:

- `CoherenceThreshold` enum — 5 tiers of reality stability
- `CoherenceSource` enum — 4 sources of coherence generation
- `CoherenceState` entity — immutable snapshot of coherence status
- `CascadeResult` and `ApotheosisResult` value objects — special effect records

### Key Deliverables

| Category              | Items                                        |
| --------------------- | -------------------------------------------- |
| **Domain Enums**      | `CoherenceThreshold`, `CoherenceSource`      |
| **Domain Entities**   | `CoherenceState`                             |
| **Value Objects**     | `CascadeResult`, `ApotheosisResult`          |
| **Tests**             | ~5 unit tests                                |

### Coherence Threshold Overview

| Threshold    | Coherence | Spell Power | Crit Chance | Special Effects                    |
| ------------ | --------- | ----------- | ----------- | ---------------------------------- |
| Destabilized | 0-20      | -2          | 0%          | 25% Cascade risk per cast          |
| Unstable     | 21-40     | -1          | 0%          | 10% Cascade risk                   |
| Balanced     | 41-60     | +0          | 5%          | Ideal state, no risk               |
| Focused      | 61-80     | +2          | 10%         | Reduced mana costs                 |
| Apotheosis   | 81+       | +5          | 20%         | Ultimate abilities, 10 stress/turn |

---

## 2. Feature Overview

```
v0.18.4c Features
└── Coherence System (Domain Layer)
    │
    ├── CoherenceThreshold Enum
    │   ├── Destabilized (0-20 coherence) - Dangerous!
    │   ├── Unstable (21-40 coherence)
    │   ├── Balanced (41-60 coherence) - Ideal
    │   ├── Focused (61-80 coherence)
    │   └── Apotheosis (81-100 coherence) - Powerful but risky
    │
    ├── CoherenceSource Enum
    │   ├── SuccessfulCast - Coherence from spell completion
    │   ├── ControlledChannel - Bonus from maintained spells
    │   ├── MeditationAction - Active coherence recovery
    │   └── StabilityField - Environmental or ally bonus
    │
    ├── CoherenceState Entity
    │   ├── CharacterId: Guid
    │   ├── CurrentCoherence: int (0-100)
    │   ├── Threshold: CoherenceThreshold (computed)
    │   ├── SpellPowerBonus: int (by threshold)
    │   ├── CriticalCastChance: int (by threshold)
    │   ├── CascadeRisk: int (at Destabilized/Unstable)
    │   ├── InApotheosis: bool (at Apotheosis threshold)
    │   ├── ApotheosisAbilitiesUnlocked: bool
    │   ├── ApotheosisStressCost: int (10/turn)
    │   ├── CanMeditate: bool (not in combat)
    │   ├── TurnsInApotheosis: int
    │   ├── LastCastTime: DateTime?
    │   └── IsCombat: bool (for meditation availability)
    │
    ├── CascadeResult Record
    │   ├── CascadeTriggered: bool
    │   ├── CoherenceLost: int
    │   ├── SelfDamage: int?
    │   ├── StressGained: int?
    │   ├── CorruptionGained: int?
    │   ├── SpellDisrupted: bool
    │   └── CascadeEffectId: string?
    │
    └── ApotheosisResult Record
        ├── EnteredApotheosis: bool
        ├── TurnsRemaining: int?
        ├── AbilitiesUnlocked: IReadOnlyList<string>
        ├── StressCostPerTurn: int
        ├── ExitedApotheosis: bool
        ├── ExitReason: string?
        └── FinalCoherence: int
```

---

## 3. Architecture Diagrams

### 3.1 Domain Layer Structure

```
┌─────────────────────────────────────────────────────────────────────────┐
│                          DOMAIN LAYER                                    │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                          │
│  ┌─────────────────────────────────────────────────────────────────┐    │
│  │                          ENUMS                                   │    │
│  ├──────────────────────────────────┬──────────────────────────────┤    │
│  │     CoherenceThreshold           │     CoherenceSource          │    │
│  ├──────────────────────────────────┼──────────────────────────────┤    │
│  │ Destabilized = 0                 │ SuccessfulCast = 0           │    │
│  │ Unstable = 1                     │ ControlledChannel = 1        │    │
│  │ Balanced = 2                     │ MeditationAction = 2         │    │
│  │ Focused = 3                      │ StabilityField = 3           │    │
│  │ Apotheosis = 4                   │                              │    │
│  └──────────────────────────────────┴──────────────────────────────┘    │
│                                                                          │
│  ┌─────────────────────────────────────────────────────────────────┐    │
│  │                  CoherenceState (Entity)                         │    │
│  ├─────────────────────────────────────────────────────────────────┤    │
│  │  Properties:                                                     │    │
│  │  + CharacterId: Guid                                            │    │
│  │  + CurrentCoherence: int (0-100, from events)                  │    │
│  │  + Threshold: CoherenceThreshold (computed)                    │    │
│  │  + SpellPowerBonus: int (by threshold: -2/-1/0/+2/+5)         │    │
│  │  + CriticalCastChance: int (by threshold: 0/0/5/10/20 %)      │    │
│  │  + CascadeRisk: int (Destab: 25%, Unstable: 10%)              │    │
│  │  + InApotheosis: bool (threshold == Apotheosis)               │    │
│  │  + ApotheosisAbilitiesUnlocked: bool                          │    │
│  │  + ApotheosisStressCost: int (constant: 10)                   │    │
│  │  + CanMeditate: bool (!IsCombat)                              │    │
│  │  + TurnsInApotheosis: int (duration tracking)                 │    │
│  │  + LastCastTime: DateTime? (cascade tracking)                 │    │
│  │  + IsCombat: bool (for meditation check)                      │    │
│  ├─────────────────────────────────────────────────────────────────┤    │
│  │  Constants:                                                      │    │
│  │  + MinCoherence = 0                                             │    │
│  │  + MaxCoherence = 100                                           │    │
│  │  + DestabilizedThreshold = 20                                   │    │
│  │  + UnstableThreshold = 40                                       │    │
│  │  + BalancedThreshold = 60                                       │    │
│  │  + FocusedThreshold = 80                                        │    │
│  │  + ApotheosisStressCost = 10                                    │    │
│  │  + MeditationGain = 20                                          │    │
│  ├─────────────────────────────────────────────────────────────────┤    │
│  │  Factory:                                                        │    │
│  │  + Create(Guid characterId): CoherenceState                    │    │
│  │  + DetermineThreshold(int coherence): CoherenceThreshold      │    │
│  └─────────────────────────────────────────────────────────────────┘    │
│                                                                          │
│  ┌─────────────────────────────────────────────────────────────────┐    │
│  │      CascadeResult & ApotheosisResult (Records)                 │    │
│  ├─────────────────────────────────────────────────────────────────┤    │
│  │  Records: Immutable snapshots of cascade and apotheosis events  │    │
│  └─────────────────────────────────────────────────────────────────┘    │
│                                                                          │
└─────────────────────────────────────────────────────────────────────────┘
```

### 3.2 Coherence Threshold Determination Flowchart

```
                    ┌────────────────────────────┐
                    │ Current Coherence Value    │
                    └───────────┬────────────────┘
                                │
           ┌────────────────────┼────────────────────┐
           │                    │                    │
           ▼                    ▼                    ▼
    ┌─────────────┐     ┌─────────────┐      ┌─────────────┐
    │ coher ≤ 20  │     │  21 ≤ c ≤ 40│      │ 41 ≤ c ≤ 60│
    │             │     │             │      │             │
    │ = Destab    │     │  = Unstable │      │  = Balanced │
    └─────────────┘     └─────────────┘      └─────────────┘
           │                    │                    │
           │                    │                    │
           │                    ▼                    │
           │            ┌─────────────┐              │
           │            │ 61 ≤ c ≤ 80 │              │
           │            │             │              │
           │            │  = Focused  │◄─────────────┘
           │            │             │
           │            └─────────────┘
           │                    │
           │                    ▼
           │            ┌─────────────┐
           │            │  coherence≥81
           │            │             │
           └───────────►│ = Apotheosis│
                        │             │
                        └─────────────┘
```

### 3.3 Cascade Risk Decision Tree

```
              ┌────────────────────────────┐
              │   Spell Cast Attempted     │
              │   (While Destab/Unstable)  │
              └────────────┬───────────────┘
                           │
                   ┌───────┴───────┐
                   │               │
                   ▼               ▼
            ┌────────────┐  ┌──────────────┐
            │ Destab     │  │ Unstable     │
            │ 25% Risk   │  │ 10% Risk     │
            └────┬───────┘  └──────┬───────┘
                 │                 │
                 ├─────────────────┤
                 │                 │
            ┌────▼──────┐    ┌─────▼────┐
            │ d100 Roll │    │ d100 Roll │
            └────┬──────┘    └─────┬────┘
                 │                 │
        ┌────────┴────────┐    ┌────┴─────────┐
        │                 │    │              │
        ▼                 ▼    ▼              ▼
    ┌─────────┐      ┌───────┐┌──────┐   ┌────────┐
    │ ≤ 25%   │      │ > 25% ││ ≤ 10%│   │ > 10%  │
    │CASCADE  │      │ SAFE  ││CASC. │   │  SAFE  │
    └─────────┘      └───────┘└──────┘   └────────┘
```

### 3.4 Apotheosis Duration and Exit Conditions

```
┌─────────────────────────────────────────────────────────┐
│ APOTHEOSIS ACTIVE (Coherence ≥ 81)                      │
├─────────────────────────────────────────────────────────┤
│                                                          │
│  Each Turn:                                              │
│  ┌──────────────────────────────────┐                  │
│  │ Cost: -10 Stress                 │                  │
│  │ Gain: +5 Spell Power             │                  │
│  │       +20% Crit Chance           │                  │
│  │       Ultimate Abilities Enabled  │                  │
│  └──────────────────────────────────┘                  │
│                                                          │
│  Exit Conditions (Any):                                  │
│  ┌──────────────────────────────────┐                  │
│  │ 1. Coherence < 81 (drops below)  │                  │
│  │ 2. Stress reaches 100 (costs too much)              │
│  │ 3. Combat ends (Arcanist decides to exit)          │
│  │ 4. Spell backlash/cascade at Apotheosis            │
│  └──────────────────────────────────┘                  │
│                                                          │
└─────────────────────────────────────────────────────────┘
```

---

## 4. User Stories

### US-18.4c-1: Determine Coherence Threshold from Current Coherence

**As a** coherence system developer
**I want to** determine the coherence threshold from current coherence value
**So that** threshold-appropriate bonuses and risks can be applied

**Acceptance Criteria:**
- Threshold correctly determined for all coherence ranges
- Boundary values handled correctly (20 → Destabilized, 21 → Unstable)
- Coherence clamped to 0-100 range
- Computed properties reflect correct threshold

### US-18.4c-2: Calculate Spell Power and Crit Bonuses from Coherence

**As a** spell system developer
**I want to** calculate spell power and critical casting bonuses based on coherence
**So that** coherence provides meaningful casting advantages

**Acceptance Criteria:**
- Spell power scales -2 to +5 with threshold
- Critical cast chance scales 0% to 20% with threshold
- Apotheosis grants ultimate spell power (+5)
- Apotheosis grants ultimate crit chance (+20%)

### US-18.4c-3: Evaluate Cascade Risk at Low Coherence

**As a** a spell resolution system
**I want to** evaluate cascade risk when casting at low coherence
**So that** low-coherence casting has meaningful consequences

**Acceptance Criteria:**
- Destabilized has 25% cascade risk
- Unstable has 10% cascade risk
- Balanced/Focused have 0% cascade risk
- Cascade effects can be rolled (deferred to v0.19.x for effect tables)

### US-18.4c-4: Track Apotheosis State and Stress Cost

**As a** an apotheosis management system
**I want to** track when the Arcanist is in Apotheosis and manage stress costs
**So that** Apotheosis is a powerful but temporary ultimate state

**Acceptance Criteria:**
- InApotheosis true only at Apotheosis threshold
- ApotheosisStressCost is 10 stress per turn
- TurnsInApotheosis tracks duration
- Meditation not available while in Apotheosis
- Cannot voluntarily exit during combat

---

## 5. Domain Model

### 5.1 CoherenceThreshold Enum

**File:** `src/Core/RuneAndRust.Domain/Enums/CoherenceThreshold.cs`

```csharp
namespace RuneAndRust.Domain.Enums;

/// <summary>
/// Represents the stages of Coherence for the Arcanist specialization.
/// </summary>
/// <remarks>
/// <para>
/// Coherence is a reality-stability meter representing how well the Arcanist
/// maintains focus on magical reality. Low coherence risks cascades; high coherence
/// enables apotheosis.
/// </para>
/// <para>
/// Threshold Ranges (based on Coherence 0-100):
/// <list type="bullet">
/// <item>Destabilized: 0-20 coherence — Dangerous! 25% cascade risk</item>
/// <item>Unstable: 21-40 coherence — Risky, 10% cascade risk</item>
/// <item>Balanced: 41-60 coherence — Ideal state, no risk</item>
/// <item>Focused: 61-80 coherence — Enhanced power, reduced costs</item>
/// <item>Apotheosis: 81-100 coherence — Ultimate state with 10 stress/turn cost</item>
/// </list>
/// </para>
/// </remarks>
public enum CoherenceThreshold
{
    /// <summary>
    /// Destabilized state (0-20 coherence).
    /// </summary>
    /// <remarks>
    /// Reality is fragmenting. 25% cascade risk per cast. Spell power -2.
    /// </remarks>
    Destabilized = 0,

    /// <summary>
    /// Unstable state (21-40 coherence).
    /// </summary>
    /// <remarks>
    /// Reality flickering. 10% cascade risk per cast. Spell power -1.
    /// </remarks>
    Unstable = 1,

    /// <summary>
    /// Balanced state (41-60 coherence).
    /// </summary>
    /// <remarks>
    /// Ideal magical state. No cascade risk. Normal spell power.
    /// </remarks>
    Balanced = 2,

    /// <summary>
    /// Focused state (61-80 coherence).
    /// </summary>
    /// <remarks>
    /// Enhanced magical focus. No risk. +2 spell power, +10% crit.
    /// </remarks>
    Focused = 3,

    /// <summary>
    /// Apotheosis state (81-100 coherence).
    /// </summary>
    /// <remarks>
    /// Ultimate magical state. +5 spell power, +20% crit, ultimate abilities.
    /// Costs 10 stress per turn to maintain. Auto-exits if stress reaches 100.
    /// </remarks>
    Apotheosis = 4
}
```

### 5.2 CoherenceSource Enum

**File:** `src/Core/RuneAndRust.Domain/Enums/CoherenceSource.cs`

```csharp
namespace RuneAndRust.Domain.Enums;

/// <summary>
/// Represents the sources of Coherence generation.
/// </summary>
/// <remarks>
/// Each source determines how coherence is gained and has different mechanics.
/// </remarks>
public enum CoherenceSource
{
    /// <summary>
    /// Coherence from a successfully completed spell.
    /// </summary>
    /// <remarks>
    /// Flat: 5 coherence per successful cast.
    /// Encourages active casting.
    /// </remarks>
    SuccessfulCast = 0,

    /// <summary>
    /// Coherence from maintaining controlled channeled spells.
    /// </summary>
    /// <remarks>
    /// Formula: 3 coherence per turn of maintained spell.
    /// Encourages concentration and sustained magic.
    /// </remarks>
    ControlledChannel = 1,

    /// <summary>
    /// Coherence from meditation (non-combat recovery).
    /// </summary>
    /// <remarks>
    /// Flat: 20 coherence per meditation action.
    /// Only available outside combat.
    /// </remarks>
    MeditationAction = 2,

    /// <summary>
    /// Coherence bonus from environmental or ally effects.
    /// </summary>
    /// <remarks>
    /// Variable based on effect; 1-10 coherence.
    /// External stability sources.
    /// </remarks>
    StabilityField = 3
}
```

### 5.3 CoherenceState Entity

**File:** `src/Core/RuneAndRust.Domain/Entities/CoherenceState.cs`

```csharp
namespace RuneAndRust.Domain.Entities;

using RuneAndRust.Domain.Enums;

/// <summary>
/// Represents the coherence state of an Arcanist character.
/// </summary>
/// <remarks>
/// <para>
/// CoherenceState is the core domain entity for the Coherence system.
/// It represents magical reality stability and provides spell bonuses
/// or cascading failures based on coherence level.
/// </para>
/// <para>
/// Key Properties:
/// - CurrentCoherence: 0-100 integer
/// - Threshold: Computed from CurrentCoherence
/// - SpellPowerBonus: -2 to +5 by threshold
/// - CriticalCastChance: 0% to 20% by threshold
/// - CascadeRisk: 0%, 10%, or 25% at low thresholds
/// - InApotheosis: true only at Apotheosis threshold
/// - ApotheosisStressCost: 10 per turn during Apotheosis
/// - CanMeditate: false during combat
/// </para>
/// </remarks>
public class CoherenceState
{
    #region Constants

    /// <summary>Minimum coherence value.</summary>
    public const int MinCoherence = 0;

    /// <summary>Maximum coherence value.</summary>
    public const int MaxCoherence = 100;

    /// <summary>Default starting coherence (Balanced state).</summary>
    public const int DefaultCoherence = 50;

    /// <summary>Coherence threshold for Unstable state.</summary>
    public const int UnstableThreshold = 20;

    /// <summary>Coherence threshold for Balanced state.</summary>
    public const int BalancedThreshold = 40;

    /// <summary>Coherence threshold for Focused state.</summary>
    public const int FocusedThreshold = 60;

    /// <summary>Coherence threshold for Apotheosis state.</summary>
    public const int ApotheosisThreshold = 80;

    /// <summary>Cascade risk at Destabilized state (%).</summary>
    public const int CascadeRiskDestabilized = 25;

    /// <summary>Cascade risk at Unstable state (%).</summary>
    public const int CascadeRiskUnstable = 10;

    /// <summary>Stress cost per turn during Apotheosis.</summary>
    public const int ApotheosisStressCostPerTurn = 10;

    /// <summary>Coherence gained per meditation action.</summary>
    public const int MeditationGain = 20;

    /// <summary>Coherence gained per successful cast.</summary>
    public const int CastGain = 5;

    /// <summary>Coherence gained per turn of controlled channel.</summary>
    public const int ChannelGainPerTurn = 3;

    #endregion

    #region Properties

    /// <summary>
    /// Gets the character ID this coherence state belongs to.
    /// </summary>
    public Guid CharacterId { get; private init; }

    /// <summary>
    /// Gets the current coherence level (0-100).
    /// </summary>
    public int CurrentCoherence { get; private init; }

    /// <summary>
    /// Gets the current coherence threshold.
    /// </summary>
    public CoherenceThreshold Threshold { get; private init; }

    /// <summary>
    /// Gets the spell power bonus from coherence.
    /// </summary>
    /// <remarks>
    /// Ranges from -2 (Destabilized) to +5 (Apotheosis).
    /// </remarks>
    public int SpellPowerBonus { get; private init; }

    /// <summary>
    /// Gets the critical casting chance bonus from coherence.
    /// </summary>
    /// <remarks>
    /// Ranges from 0% to 20% as percentage. Null if not applicable.
    /// </remarks>
    public int? CriticalCastChance { get; private init; }

    /// <summary>
    /// Gets the cascade risk percentage at current threshold.
    /// </summary>
    /// <remarks>
    /// 0% at Balanced and above.
    /// 10% at Unstable.
    /// 25% at Destabilized.
    /// </remarks>
    public int CascadeRisk { get; private init; }

    /// <summary>
    /// Gets whether the character is in Apotheosis state.
    /// </summary>
    /// <remarks>
    /// True only at Apotheosis threshold.
    /// </remarks>
    public bool InApotheosis { get; private init; }

    /// <summary>
    /// Gets whether Apotheosis abilities are unlocked.
    /// </summary>
    /// <remarks>
    /// True once first entered Apotheosis threshold.
    /// Persists even if coherence drops.
    /// </remarks>
    public bool ApotheosisAbilitiesUnlocked { get; private init; }

    /// <summary>
    /// Gets the number of turns spent in Apotheosis.
    /// </summary>
    /// <remarks>
    /// Tracks duration for effect calculations.
    /// </remarks>
    public int TurnsInApotheosis { get; private init; }

    /// <summary>
    /// Gets the time of last spell cast.
    /// </summary>
    /// <remarks>
    /// Used for cascade tracking and cooldown calculations.
    /// </remarks>
    public DateTime? LastCastTime { get; private init; }

    /// <summary>
    /// Gets whether the character is currently in combat.
    /// </summary>
    /// <remarks>
    /// Affects meditation availability.
    /// </remarks>
    public bool IsCombat { get; private init; }

    #endregion

    #region Computed Properties

    /// <summary>
    /// Gets whether meditation is available.
    /// </summary>
    /// <remarks>
    /// Can only meditate outside of combat.
    /// </remarks>
    public bool CanMeditate => !IsCombat;

    /// <summary>
    /// Gets the stress cost per turn during Apotheosis.
    /// </summary>
    public int ApothecosisStressCost => InApotheosis ? ApotheosisStressCostPerTurn : 0;

    #endregion

    #region Constructors

    /// <summary>
    /// Private constructor for EF Core.
    /// </summary>
    private CoherenceState() { }

    #endregion

    #region Factory Methods

    /// <summary>
    /// Creates a new CoherenceState for a character.
    /// </summary>
    /// <param name="characterId">The character ID.</param>
    /// <param name="initialCoherence">Initial coherence value (default 50 for Balanced).</param>
    /// <param name="isInCombat">Whether character is in combat.</param>
    /// <returns>A new CoherenceState instance.</returns>
    public static CoherenceState Create(Guid characterId, int initialCoherence = DefaultCoherence, bool isInCombat = false)
    {
        var clampedCoherence = Math.Clamp(initialCoherence, MinCoherence, MaxCoherence);
        var threshold = DetermineThreshold(clampedCoherence);

        return new CoherenceState
        {
            CharacterId = characterId,
            CurrentCoherence = clampedCoherence,
            Threshold = threshold,
            SpellPowerBonus = CalculateSpellPowerBonus(threshold),
            CriticalCastChance = CalculateCriticalCastChance(threshold),
            CascadeRisk = CalculateCascadeRisk(threshold),
            InApotheosis = threshold == CoherenceThreshold.Apotheosis,
            ApotheosisAbilitiesUnlocked = threshold == CoherenceThreshold.Apotheosis,
            TurnsInApotheosis = 0,
            LastCastTime = null,
            IsCombat = isInCombat
        };
    }

    /// <summary>
    /// Determines the coherence threshold for a given coherence value.
    /// </summary>
    /// <param name="coherence">The coherence value (0-100).</param>
    /// <returns>The corresponding CoherenceThreshold.</returns>
    public static CoherenceThreshold DetermineThreshold(int coherence) =>
        coherence switch
        {
            > ApotheosisThreshold => CoherenceThreshold.Apotheosis,
            > FocusedThreshold => CoherenceThreshold.Focused,
            > BalancedThreshold => CoherenceThreshold.Balanced,
            > UnstableThreshold => CoherenceThreshold.Unstable,
            _ => CoherenceThreshold.Destabilized
        };

    #endregion

    #region Private Calculation Methods

    /// <summary>
    /// Calculates spell power bonus from threshold.
    /// </summary>
    private static int CalculateSpellPowerBonus(CoherenceThreshold threshold) =>
        threshold switch
        {
            CoherenceThreshold.Destabilized => -2,
            CoherenceThreshold.Unstable => -1,
            CoherenceThreshold.Balanced => 0,
            CoherenceThreshold.Focused => 2,
            CoherenceThreshold.Apotheosis => 5,
            _ => 0
        };

    /// <summary>
    /// Calculates critical casting chance from threshold.
    /// </summary>
    private static int? CalculateCriticalCastChance(CoherenceThreshold threshold) =>
        threshold switch
        {
            CoherenceThreshold.Destabilized => 0,
            CoherenceThreshold.Unstable => 0,
            CoherenceThreshold.Balanced => 5,
            CoherenceThreshold.Focused => 10,
            CoherenceThreshold.Apotheosis => 20,
            _ => 0
        };

    /// <summary>
    /// Calculates cascade risk from threshold.
    /// </summary>
    private static int CalculateCascadeRisk(CoherenceThreshold threshold) =>
        threshold switch
        {
            CoherenceThreshold.Destabilized => CascadeRiskDestabilized,
            CoherenceThreshold.Unstable => CascadeRiskUnstable,
            _ => 0
        };

    #endregion

    #region Display

    /// <inheritdoc/>
    public override string ToString() =>
        $"Coherence[{Threshold}]: {CurrentCoherence}/100 " +
        $"(Power {SpellPowerBonus:+#;-#}, Crit {CriticalCastChance}%)" +
        (CascadeRisk > 0 ? $" [CASCADE RISK {CascadeRisk}%]" : "") +
        (InApotheosis ? " [APOTHEOSIS]" : "");

    #endregion
}
```

### 5.4 CascadeResult Record

**File:** `src/Core/RuneAndRust.Domain/ValueObjects/CascadeResult.cs`

```csharp
namespace RuneAndRust.Domain.ValueObjects;

/// <summary>
/// Represents the result of a cascade check.
/// </summary>
/// <remarks>
/// Cascades occur when Arcanists cast at low coherence, causing
/// magical backslash with various effects.
/// </remarks>
/// <param name="CascadeTriggered">Whether cascade actually occurred.</param>
/// <param name="CoherenceLost">Amount of coherence lost.</param>
/// <param name="SelfDamage">Damage taken by Arcanist, if any.</param>
/// <param name="StressGained">Stress gained from cascade, if any.</param>
/// <param name="CorruptionGained">Corruption gained from cascade, if any.</param>
/// <param name="SpellDisrupted">Whether the spell was disrupted.</param>
/// <param name="CascadeEffectId">ID of cascade effect table entry (v0.19.x).</param>
public record CascadeResult(
    bool CascadeTriggered,
    int CoherenceLost,
    int? SelfDamage,
    int? StressGained,
    int? CorruptionGained,
    bool SpellDisrupted,
    string? CascadeEffectId)
{
    /// <summary>
    /// Gets whether cascade caused direct damage.
    /// </summary>
    public bool CausesDamage => SelfDamage.HasValue && SelfDamage > 0;

    /// <summary>
    /// Gets whether cascade caused stress gain.
    /// </summary>
    public bool CausesStress => StressGained.HasValue && StressGained > 0;

    /// <summary>
    /// Gets whether cascade caused corruption.
    /// </summary>
    public bool CausesCorruption => CorruptionGained.HasValue && CorruptionGained > 0;

    /// <summary>
    /// Creates a display string for this cascade event.
    /// </summary>
    public string ToDisplayString()
    {
        if (!CascadeTriggered)
            return "No cascade.";

        var effects = new List<string> { $"Coherence -{CoherenceLost}" };
        if (SelfDamage.HasValue) effects.Add($"DMG {SelfDamage}");
        if (StressGained.HasValue) effects.Add($"STRESS +{StressGained}");
        if (CorruptionGained.HasValue) effects.Add($"CORRUPTION +{CorruptionGained}");
        if (SpellDisrupted) effects.Add("SPELL DISRUPTED");

        return $"CASCADE: {string.Join(", ", effects)}";
    }
}
```

### 5.5 ApotheosisResult Record

**File:** `src/Core/RuneAndRust.Domain/ValueObjects/ApotheosisResult.cs`

```csharp
namespace RuneAndRust.Domain.ValueObjects;

/// <summary>
/// Represents the result of an Apotheosis state transition.
/// </summary>
/// <remarks>
/// Tracks entry into, maintenance of, and exit from Apotheosis state.
/// </remarks>
/// <param name="EnteredApotheosis">Whether character just entered Apotheosis.</param>
/// <param name="TurnsRemaining">Estimated turns remaining in Apotheosis based on stress.</param>
/// <param name="AbilitiesUnlocked">List of newly unlocked ultimate ability IDs.</param>
/// <param name="StressCostPerTurn">Stress cost per turn (constant 10).</param>
/// <param name="ExitedApotheosis">Whether character exited Apotheosis.</param>
/// <param name="ExitReason">Reason for exit if applicable.</param>
/// <param name="FinalCoherence">Final coherence value after transition.</param>
public record ApotheosisResult(
    bool EnteredApotheosis,
    int? TurnsRemaining,
    IReadOnlyList<string>? AbilitiesUnlocked,
    int StressCostPerTurn,
    bool ExitedApotheosis,
    string? ExitReason,
    int FinalCoherence)
{
    /// <summary>
    /// Gets whether state changed (entered or exited).
    /// </summary>
    public bool StateChanged => EnteredApotheosis || ExitedApotheosis;

    /// <summary>
    /// Gets whether abilities were newly unlocked.
    /// </summary>
    public bool AbilitiesUnlockedThisTransition =>
        AbilitiesUnlocked != null && AbilitiesUnlocked.Count > 0;

    /// <summary>
    /// Creates a display string for this Apotheosis transition.
    /// </summary>
    public string ToDisplayString()
    {
        if (EnteredApotheosis)
        {
            var abilities = AbilitiesUnlockedThisTransition
                ? $" ({string.Join(", ", AbilitiesUnlocked!)})"
                : "";
            return $"APOTHEOSIS ENTERED{abilities} (Cost: {StressCostPerTurn}/turn)";
        }

        if (ExitedApotheosis)
            return $"Apotheosis ended: {ExitReason}";

        return $"Apotheosis active ({TurnsRemaining} turns remaining)";
    }
}
```

---

## 6. Data Model

### 6.1 Coherence Entity Relationships

```csharp
// Add to Character entity:

/// <summary>
/// Gets the character's coherence state.
/// </summary>
public CoherenceState? CoherenceState { get; private set; }
```

### 6.2 Database Schema (for v0.18.4f)

```sql
CREATE TABLE IF NOT EXISTS character_coherence (
    character_id UUID PRIMARY KEY REFERENCES characters(id) ON DELETE CASCADE,
    current_coherence INT NOT NULL DEFAULT 50
        CONSTRAINT chk_coherence_range CHECK (current_coherence >= 0 AND current_coherence <= 100),
    in_apotheosis BOOLEAN NOT NULL DEFAULT false,
    apotheosis_abilities_unlocked BOOLEAN NOT NULL DEFAULT false,
    turns_in_apotheosis INT NOT NULL DEFAULT 0,
    last_cast_time TIMESTAMP,
    is_combat BOOLEAN NOT NULL DEFAULT false,
    updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX idx_character_coherence_apotheosis
    ON character_coherence(character_id, in_apotheosis);

CREATE INDEX idx_character_coherence_cast_time
    ON character_coherence(character_id, last_cast_time);
```

---

## 7. Logging Specifications

### 7.1 Domain Layer Logging

> **Note:** Enums and value objects do not log directly.
> All logging occurs in Application Layer services (v0.18.4e).

### 7.2 Expected Log Events (Future Implementation in v0.18.4e)

| Event                      | Level       | Template                                                        |
| -------------------------- | ----------- | --------------------------------------------------------------- |
| Coherence Threshold Change | Information | `"Coherence threshold changed: {CharacterId} {Old} → {New}"`    |
| Cascade Triggered          | Warning     | `"Cascade triggered: {CharacterId} Risk={Risk}% Lost={Lost}"`   |
| Entered Apotheosis         | Warning     | `"APOTHEOSIS: {CharacterId} entered ultimate state"`            |
| Exited Apotheosis          | Information | `"Apotheosis ended: {CharacterId} Reason={Reason}"`             |

---

## 8. Unit Testing Requirements

### 8.1 Test File Location

**File:** `tests/RuneAndRust.Domain.UnitTests/Entities/CoherenceStateTests.cs`

### 8.2 Required Tests

| Test Name                                                | Description                                                       |
| -------------------------------------------------------- | ----------------------------------------------------------------- |
| `Create_WithDefaultCoherence_ReturnsBalancedThreshold`   | Verify Balanced threshold at default 50 coherence                |
| `Create_AtBoundaryValues_ReturnsCorrectThresholds`       | Verify all threshold boundaries (20→Unstable, 40→Balanced, etc.)  |
| `Create_WithMaxCoherence_ReturnsApotheosisState`         | Verify Apotheosis and bonuses at 100 coherence                   |
| `SpellPowerBonus_RangesFrom_Minus2ToPlus5`               | Verify spell power -2 to +5 across thresholds                    |
| `CriticalCastChance_RangesFrom_0To20Percent`             | Verify crit chance 0% to 20% across thresholds                  |

### 8.3 Example Tests

```csharp
[TestFixture]
public class CoherenceStateTests
{
    [Test]
    public void Create_WithDefaultCoherence_ReturnsBalancedThreshold()
    {
        // Arrange & Act
        var coherenceState = CoherenceState.Create(Guid.NewGuid());

        // Assert
        coherenceState.CurrentCoherence.Should().Be(50);
        coherenceState.Threshold.Should().Be(CoherenceThreshold.Balanced);
        coherenceState.SpellPowerBonus.Should().Be(0);
        coherenceState.CriticalCastChance.Should().Be(5);
        coherenceState.CascadeRisk.Should().Be(0);
    }

    [TestCase(0, CoherenceThreshold.Destabilized)]
    [TestCase(20, CoherenceThreshold.Destabilized)]
    [TestCase(21, CoherenceThreshold.Unstable)]
    [TestCase(40, CoherenceThreshold.Unstable)]
    [TestCase(41, CoherenceThreshold.Balanced)]
    [TestCase(60, CoherenceThreshold.Balanced)]
    [TestCase(61, CoherenceThreshold.Focused)]
    [TestCase(80, CoherenceThreshold.Focused)]
    [TestCase(81, CoherenceThreshold.Apotheosis)]
    [TestCase(100, CoherenceThreshold.Apotheosis)]
    public void Create_AtBoundaryValues_ReturnsCorrectThresholds(int coherence, CoherenceThreshold expected)
    {
        // Arrange & Act
        var coherenceState = CoherenceState.Create(Guid.NewGuid(), initialCoherence: coherence);

        // Assert
        coherenceState.Threshold.Should().Be(expected);
    }

    [TestCase(CoherenceThreshold.Destabilized, -2)]
    [TestCase(CoherenceThreshold.Unstable, -1)]
    [TestCase(CoherenceThreshold.Balanced, 0)]
    [TestCase(CoherenceThreshold.Focused, 2)]
    [TestCase(CoherenceThreshold.Apotheosis, 5)]
    public void SpellPowerBonus_CalculatesCorrectly_ByThreshold(CoherenceThreshold threshold, int expectedBonus)
    {
        // Arrange
        var coherence = threshold switch
        {
            CoherenceThreshold.Destabilized => 10,
            CoherenceThreshold.Unstable => 30,
            CoherenceThreshold.Balanced => 50,
            CoherenceThreshold.Focused => 70,
            CoherenceThreshold.Apotheosis => 90,
            _ => 0
        };

        // Act
        var coherenceState = CoherenceState.Create(Guid.NewGuid(), initialCoherence: coherence);

        // Assert
        coherenceState.SpellPowerBonus.Should().Be(expectedBonus);
    }

    [TestCase(CoherenceThreshold.Destabilized, 25)]
    [TestCase(CoherenceThreshold.Unstable, 10)]
    [TestCase(CoherenceThreshold.Balanced, 0)]
    [TestCase(CoherenceThreshold.Focused, 0)]
    [TestCase(CoherenceThreshold.Apotheosis, 0)]
    public void CascadeRisk_CalculatesCorrectly_ByThreshold(CoherenceThreshold threshold, int expectedRisk)
    {
        // Arrange
        var coherence = threshold switch
        {
            CoherenceThreshold.Destabilized => 10,
            CoherenceThreshold.Unstable => 30,
            CoherenceThreshold.Balanced => 50,
            CoherenceThreshold.Focused => 70,
            CoherenceThreshold.Apotheosis => 90,
            _ => 0
        };

        // Act
        var coherenceState = CoherenceState.Create(Guid.NewGuid(), initialCoherence: coherence);

        // Assert
        coherenceState.CascadeRisk.Should().Be(expectedRisk);
    }
}
```

---

## 9. Deliverable Checklist

### 9.1 Domain Layer

- [ ] `src/Core/RuneAndRust.Domain/Enums/CoherenceThreshold.cs`
- [ ] `src/Core/RuneAndRust.Domain/Enums/CoherenceSource.cs`
- [ ] `src/Core/RuneAndRust.Domain/Entities/CoherenceState.cs`
- [ ] `src/Core/RuneAndRust.Domain/ValueObjects/CascadeResult.cs`
- [ ] `src/Core/RuneAndRust.Domain/ValueObjects/ApotheosisResult.cs`

### 9.2 Tests

- [ ] `tests/RuneAndRust.Domain.UnitTests/Entities/CoherenceStateTests.cs`

### 9.3 Documentation

- [ ] Create `docs/design/v0.18.x/v0.18.4c-design-specification.md`
- [ ] Update `docs/design/v0.18.x/v0.18.4-scope-breakdown.md` (mark v0.18.4c complete)

---

## 10. Acceptance Criteria

### 10.1 Build Verification

- [ ] Solution builds without errors
- [ ] Solution builds without warnings in new code

### 10.2 Test Verification

- [ ] All new unit tests pass
- [ ] All existing unit tests continue to pass

### 10.3 Functional Verification

- [ ] `CoherenceThreshold` enum contains all 5 thresholds
- [ ] `CoherenceSource` enum contains all 4 sources
- [ ] `CoherenceState.Create()` defaults to coherence 50 (Balanced)
- [ ] `CoherenceState.DetermineThreshold()` handles all boundary values
- [ ] Spell power correctly ranges -2 to +5 with threshold
- [ ] Critical cast chance correctly ranges 0% to 20% with threshold
- [ ] Cascade risk is 25% at Destabilized, 10% at Unstable, 0% otherwise
- [ ] `InApotheosis` true only at Apotheosis threshold
- [ ] `ApotheosisStressCost` is 10 per turn
- [ ] `CanMeditate` only true when not in combat
- [ ] `CascadeResult` and `ApotheosisResult` records serialize correctly

---

## 11. Dependencies

### 11.1 Required Prerequisites

| Dependency           | Version | Status   | Notes                              |
| -------------------- | ------- | -------- | ---------------------------------- |
| Specialization Sys   | v0.17.4 | Required | For Arcanist specialization        |
| Psychic Stress Sys   | v0.18.0 | Required | For Apotheosis stress costs        |
| Dice System          | v0.6.x  | Required | For cascade risk rolls (v0.18.4e) |
| Character Domain     | v0.6.x+ | Required | CoherenceState belongs to Char     |

### 11.2 Deferred to Later Phases

| Item                             | Deferred To | Reason                          |
| -------------------------------- | ----------- | ------------------------------- |
| `ICoherenceService` interface    | v0.18.4d    | Service contract separately     |
| `CoherenceService` implementation| v0.18.4e    | Service logic separately        |
| Cascade effect tables            | v0.19.x     | Wild Magic effect definitions   |
| Apotheosis ability definitions   | v0.19.x     | Ability system integration      |
| Configuration loading            | v0.18.4f    | Centralized in config phase     |
| Database persistence             | v0.18.4f    | Persistence layer separate      |

---

## 12. Future Considerations

### 12.1 v0.18.4d-e (Services)

- Service interfaces and implementations
- Cross-system interactions (stress, cascade effects, apotheosis triggers)
- Integration with dice system for cascade/apotheosis rolls

### 12.2 v0.19.x (Effects)

- Cascade effect table with d10 or d20 roll system
- Specific cascade effects (self damage, stress, corruption, spell disruption)
- Ultimate Apotheosis ability definitions

### 12.3 v0.18.4f (Configuration & Persistence)

- JSON configuration for all three resource systems
- Database persistence layer with migration

---

## Changelog

| Version | Date       | Changes                  |
| ------- | ---------- | ------------------------ |
| 1.0     | 2026-01-28 | Initial design complete  |
