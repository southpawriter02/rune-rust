# v0.4.0a: The Legend (Saga Backend)

## Overview

This sub-phase implements the foundational backend for the **Saga System** (Progression). It focuses on tracking **Legend** (Experience Points), managing **Level** thresholds, and awarding **Progression Points** (PP) upon leveling up.

**Parent Plan:** [v0.4.0](./v0.4.0.md)
**Status:** Planned

---

## 1. Core Architecture

The `SagaService` is the authority on character growth. It listens for gameplay events (or is called directly), accumulates Legend, and triggers Level Up events when thresholds are met.

### 1.1 Data Schema Updates

**Entity: `Character`** (`RuneAndRust.Core/Entities/Character.cs`)

| Field | Type | Change | Current (Line#) | Description |
|-------|------|--------|-----------------|-------------|
| `Legend` | `int` | **Rename** | `ExperiencePoints` (L137) | Total accumulated XP. Renamed for thematic consistency. |
| `Level` | `int` | **Keep** | `Level` (L144) | Already exists. Max level cap handled by service logic. |
| `ProgressionPoints` | `int` | **New** | N/A | Currency for buying Attribute upgrades. Earned via leveling. |

### 1.2 Service Architecture

| Component | Layer | File | Purpose |
|-----------|-------|------|---------|
| `ISagaService` | Core | `Interfaces/ISagaService.cs` | Contract for XP management. |
| `SagaService` | Engine | `Services/SagaService.cs` | Implementation: AddLegend, CheckMilestones, LevelUp. |
| `LevelUpEvent` | Core | `Events/LevelUpEvent.cs` | Domain event fired on level-up. |

### 1.3 Milestone Progression Table

The following table defines Legend (XP) thresholds for each level, along with the Progression Points (PP) awarded upon reaching that level.

| Level | Required Legend (Cumulative) | PP Award | Notes |
|-------|------------------------------|----------|-------|
| 1     | 0                            | 0        | Starting level. |
| 2     | 100                          | 1        | First milestone (easy to reach). |
| 3     | 300                          | 1        | |
| 4     | 600                          | 2        | Tier 1 PP boost. |
| 5     | 1000                         | 2        | |
| 6     | 1500                         | 2        | |
| 7     | 2100                         | 3        | Tier 2 PP boost. |
| 8     | 2800                         | 3        | |
| 9     | 3600                         | 3        | |
| 10    | 4500                         | 5        | Soft Cap: Significant milestone. |

> **Total PP earnable (Levels 2-10):** 1+1+2+2+2+3+3+3+5 = **22 PP**

---

## 2. Implementation Specifications

### 2.1 Character Entity Update

**File:** `RuneAndRust.Core/Entities/Character.cs`

**Changes:**

1.  **Rename `ExperiencePoints` → `Legend`** (Line ~137).
2.  **Add `ProgressionPoints` property** (after `Level`).
3.  **Update XML documentation** for consistency.

```diff
- /// <summary>
- /// Experience points accumulated by the character.
- /// </summary>
- /// <remarks>See: SPEC-XP-001 for XP thresholds and scaling formulas.</remarks>
- public int ExperiencePoints { get; set; } = 0;
+ /// <summary>
+ /// Total accumulated Legend (Experience).
+ /// Used to calculate Level and Milestones.
+ /// </summary>
+ /// <remarks>See: v0.4.0a (The Legend) for Saga system design.</remarks>
+ public int Legend { get; set; } = 0;

  /// <summary>
- /// Character's current level. Starts at 1, max 5.
- /// Level-up rewards (+10 HP, +5 Stamina, +1 attribute point) are NOT YET IMPLEMENTED.
+ /// Character's current level. Starts at 1.
+ /// Determines ability access tiers and combat scaling.
  /// </summary>
- /// <remarks>See: SPEC-XP-001 for level thresholds; SPEC-ADVANCEMENT-001 for level-up rewards.</remarks>
+ /// <remarks>See: v0.4.0a (The Legend) for milestone thresholds.</remarks>
  public int Level { get; set; } = 1;
+
+ /// <summary>
+ /// Currency earned via Leveling, used to purchase Attribute upgrades.
+ /// </summary>
+ /// <remarks>See: v0.4.0b (The Growth) for spending logic.</remarks>
+ public int ProgressionPoints { get; set; } = 0;
```

### 2.2 Interface Definition

**File:** `RuneAndRust.Core/Interfaces/ISagaService.cs` (New)

```csharp
using RuneAndRust.Core.Entities;

namespace RuneAndRust.Core.Interfaces;

/// <summary>
/// Service for managing character progression (Legend, Levels, Milestones).
/// </summary>
/// <remarks>See: v0.4.0a (The Legend) for implementation details.</remarks>
public interface ISagaService
{
    /// <summary>
    /// Adds Legend (XP) to the character and checks for level-up.
    /// </summary>
    /// <param name="character">The character to award.</param>
    /// <param name="amount">The amount of Legend to add.</param>
    /// <param name="reason">A log-friendly description of the source (e.g., "Defeated Draugr").</param>
    void AddLegend(Character character, int amount, string reason);

    /// <summary>
    /// Gets the Legend required to reach the next level.
    /// </summary>
    /// <param name="currentLevel">The character's current level.</param>
    /// <returns>The total Legend needed, or -1 if max level.</returns>
    int GetLegendForNextLevel(int currentLevel);

    /// <summary>
    /// Gets the PP awarded for reaching a specific level.
    /// </summary>
    /// <param name="level">The level reached.</param>
    /// <returns>The PP awarded.</returns>
    int GetPpAward(int level);
}
```

### 2.3 SagaService Implementation

**File:** `RuneAndRust.Engine/Services/SagaService.cs` (New)

```csharp
using Microsoft.Extensions.Logging;
using RuneAndRust.Core.Entities;
using RuneAndRust.Core.Events;
using RuneAndRust.Core.Interfaces;

namespace RuneAndRust.Engine.Services;

/// <summary>
/// Engine-layer service for managing character progression.
/// </summary>
public class SagaService : ISagaService
{
    private readonly IEventBus _eventBus;
    private readonly IStatCalculationService _statCalc;
    private readonly ILogger<SagaService> _logger;

    // Milestone table: Level -> (Required Legend, PP Award)
    private static readonly Dictionary<int, (int RequiredLegend, int PpAward)> Milestones = new()
    {
        { 1, (0, 0) },
        { 2, (100, 1) },
        { 3, (300, 1) },
        { 4, (600, 2) },
        { 5, (1000, 2) },
        { 6, (1500, 2) },
        { 7, (2100, 3) },
        { 8, (2800, 3) },
        { 9, (3600, 3) },
        { 10, (4500, 5) },
    };

    private const int MaxLevel = 10;

    public SagaService(
        IEventBus eventBus,
        IStatCalculationService statCalc,
        ILogger<SagaService> logger)
    {
        _eventBus = eventBus;
        _statCalc = statCalc;
        _logger = logger;
    }

    /// <inheritdoc/>
    public void AddLegend(Character character, int amount, string reason)
    {
        if (amount <= 0)
        {
            _logger.LogWarning("[Saga] AddLegend called with non-positive amount: {Amount}", amount);
            return;
        }

        var oldLegend = character.Legend;
        character.Legend += amount;
        _logger.LogInformation(
            "[Saga] {Name} gained {Amount} Legend ({Reason}). Total: {OldLegend} -> {NewLegend}",
            character.Name, amount, reason, oldLegend, character.Legend);

        CheckMilestones(character);
    }

    /// <summary>
    /// Recursively checks for level-up(s). Handles multi-level jumps.
    /// </summary>
    private void CheckMilestones(Character character)
    {
        if (character.Level >= MaxLevel)
        {
            return; // Already at max level
        }

        int nextLevel = character.Level + 1;
        if (!Milestones.TryGetValue(nextLevel, out var milestone))
        {
            return; // No milestone data
        }

        if (character.Legend >= milestone.RequiredLegend)
        {
            PerformLevelUp(character, nextLevel, milestone.PpAward);
            CheckMilestones(character); // Check for another level-up
        }
    }

    /// <summary>
    /// Performs the actual level-up: increments level, awards PP, heals, fires event.
    /// </summary>
    private void PerformLevelUp(Character character, int newLevel, int ppAward)
    {
        character.Level = newLevel;
        character.ProgressionPoints += ppAward;

        // Full heal on level-up
        _statCalc.RecalculateDerivedStats(character); // Updates MaxHP first
        character.CurrentHP = character.MaxHP;
        character.CurrentStamina = character.MaxStamina;

        _logger.LogInformation(
            "[Saga] {Name} LEVELED UP to {Level}! Awarded {PP} PP. HP/Stamina restored.",
            character.Name, newLevel, ppAward);

        _eventBus.Publish(new LevelUpEvent(character.Id, character.Name, newLevel, ppAward));
    }

    /// <inheritdoc/>
    public int GetLegendForNextLevel(int currentLevel)
    {
        int nextLevel = currentLevel + 1;
        return Milestones.TryGetValue(nextLevel, out var m) ? m.RequiredLegend : -1;
    }

    /// <inheritdoc/>
    public int GetPpAward(int level)
    {
        return Milestones.TryGetValue(level, out var m) ? m.PpAward : 0;
    }
}
```

### 2.4 LevelUpEvent Definition

**File:** `RuneAndRust.Core/Events/LevelUpEvent.cs` (New)

```csharp
namespace RuneAndRust.Core.Events;

/// <summary>
/// Published when a character reaches a new level (v0.4.0a).
/// Consumed by UI listeners to display level-up notifications.
/// </summary>
/// <param name="CharacterId">The unique identifier of the character.</param>
/// <param name="CharacterName">The display name of the character.</param>
/// <param name="NewLevel">The level achieved.</param>
/// <param name="ProgressionPointsAwarded">The PP awarded for this level.</param>
public record LevelUpEvent(
    Guid CharacterId,
    string CharacterName,
    int NewLevel,
    int ProgressionPointsAwarded);
```

---

## 3. Logging Requirements

| Component | Event | Level | Template | Properties |
|-----------|-------|-------|----------|------------|
| `SagaService` | Legend Gain | Info | `[Saga] {Name} gained {Amount} Legend ({Reason}). Total: {OldLegend} -> {NewLegend}` | Name, Amount, Reason, OldLegend, NewLegend |
| `SagaService` | Level Up | Info | `[Saga] {Name} LEVELED UP to {Level}! Awarded {PP} PP. HP/Stamina restored.` | Name, Level, PP |
| `SagaService` | Invalid Add | Warn | `[Saga] AddLegend called with non-positive amount: {Amount}` | Amount |

---

## 4. Dependency Injection Registration

**File:** `RuneAndRust.Terminal/Program.cs`

```csharp
// In service registration block
services.AddScoped<ISagaService, SagaService>();
```

---

## 5. Testing Strategy

### 5.1 Unit Tests

**File:** `RuneAndRust.Tests/Engine/SagaServiceTests.cs` (New)

Tests follow the existing pattern in `RuneAndRust.Tests/Engine/` (e.g., `StatCalculationServiceTests.cs`).

| Test Method | Scenario | Expected Outcome |
|-------------|----------|------------------|
| `AddLegend_PositiveAmount_IncreasesTotal` | Add 50 Legend to a L1 character (0 Legend). | `character.Legend == 50`. |
| `AddLegend_ZeroOrNegativeAmount_NoChange` | Add 0 or -10 Legend. | Legend unchanged. Warns in log. |
| `AddLegend_ReachesThreshold_TriggersLevelUp` | Add 100 Legend to a L1 character. | `character.Level == 2`. |
| `AddLegend_AwardsPP_OnLevelUp` | Level up to L2. | `character.ProgressionPoints == 1`. |
| `AddLegend_MultiLevelJump_HandlesRecursively` | L1 char receives 700 Legend (enough for L2, L3, L4). | `character.Level == 4`. `character.ProgressionPoints == 1+1+2 = 4`. |
| `AddLegend_RestoresHpStamina_OnLevelUp` | Level up a character at 10/100 HP. | `character.CurrentHP == character.MaxHP`. |
| `AddLegend_PublishesLevelUpEvent` | Level up. | `LevelUpEvent` is published via `IEventBus`. |
| `AddLegend_AtMaxLevel_NoFurtherLevelUp` | L10 char receives Legend. | `character.Level` remains 10. No event fired. |

### 5.2 Verification Commands

**Run all Saga tests:**
```bash
dotnet test RuneAndRust.Tests --filter "FullyQualifiedName~SagaServiceTests"
```

**Run all Engine tests (to ensure no regressions):**
```bash
dotnet test RuneAndRust.Tests --filter "FullyQualifiedName~Engine"
```

### 5.3 Manual Verification (Optional - Debug Mode)

If a debug command (`saga add <amount>`) is implemented:
1.  Start new game, check `Legend: 0`, `Level: 1`, `PP: 0`.
2.  Run `saga add 100`.
3.  Verify output: "LEVELED UP to 2! Awarded 1 PP."
4.  Check stats: `Legend: 100`, `Level: 2`, `PP: 1`.
5.  Run `saga add 600`.
6.  Verify multi-level: "LEVELED UP to 4!"
7.  Check stats: `Legend: 700`, `Level: 4`, `PP: 4`.

---

## 6. Work Breakdown

- [ ] **Core:** Rename `ExperiencePoints` → `Legend` in `Character.cs`.
- [ ] **Core:** Add `ProgressionPoints` property to `Character.cs`.
- [ ] **Core:** Create `ISagaService.cs` interface.
- [ ] **Core:** Create `LevelUpEvent.cs` event.
- [ ] **Engine:** Implement `SagaService.cs`.
- [ ] **Terminal:** Register `SagaService` in `Program.cs`.
- [ ] **Tests:** Create `SagaServiceTests.cs` with all scenarios above.

