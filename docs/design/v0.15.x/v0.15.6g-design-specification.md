# v0.15.6g Design Specification: Investigation Command

**Version:** 0.15.6g
**Parent:** v0.15.6 (Advanced Perception System)
**Prerequisites:** v0.15.6f Complete (Search Command Enhancement)
**Status:** Design Complete

---

## Table of Contents

1. [Overview](#1-overview)
2. [Scope](#2-scope)
3. [Data Model](#3-data-model)
4. [Services](#4-services)
5. [Command Changes](#5-command-changes)
6. [Rendering Changes](#6-rendering-changes)
7. [Configuration](#7-configuration)
8. [Integration with Existing Systems](#8-integration-with-existing-systems)
9. [Acceptance Criteria](#9-acceptance-criteria)
10. [Test Specifications](#10-test-specifications)
11. [Dependencies](#11-dependencies)
12. [Implementation Notes](#12-implementation-notes)
13. [Design Decisions](#13-design-decisions)
14. [Future Considerations](#14-future-considerations)
15. [Appendix A: Investigation Examples](#appendix-a-investigation-examples)
16. [Appendix B: Clue and Deduction Reference](#appendix-b-clue-and-deduction-reference)

---

## 1. Overview

### 1.1 Purpose

This phase introduces the investigation command, enabling players to perform deep analytical examination of specific targets such as crime scenes, corpses, wreckage, trails, and documents. Unlike basic examination (which reveals layered descriptions) or searching (which finds hidden elements), investigation focuses on discovering clues and forming deductions. When multiple clues are gathered, players can piece together logical conclusions that reveal hidden truths about events, creatures, or mysteries.

### 1.2 Key Changes

| Area | Current State (v0.15.6f) | Target State (v0.15.6g) |
|------|--------------------------|------------------------|
| Target Analysis | Examination reveals descriptions | Investigation discovers clues |
| Clue System | Not implemented | Clues discovered and tracked |
| Deduction System | Not implemented | Multiple clues enable deductions |
| Specialized Targets | Generic examination | Crime scene, remains, wreckage, trail, document |
| Investigation Skill | Not utilized | WITS + Investigation skill for checks |

### 1.3 Design Principles

1. **Analytical Depth**: Investigation provides deeper insight than examination alone
2. **Clue Accumulation**: Multiple clues combine to reveal larger truths
3. **Target Specialization**: Different target types require different approaches
4. **Skill Synergy**: WITS attribute plus Investigation skill determine effectiveness
5. **Narrative Integration**: Clues and deductions drive story discovery

---

## 2. Scope

### 2.1 In Scope

- InvestigationContext value object with target and clue tracking
- InvestigationTarget enum (CrimeScene, Remains, Wreckage, Trail, Document)
- InvestigationResult value object with clues and deductions
- Clue and Deduction value objects
- IInvestigationService interface for investigation operations
- `investigate <target>` command implementation
- Deduction logic for combining multiple clues
- Time cost for investigation operations
- Configuration file: investigation-config.json

### 2.2 Out of Scope (Future Phases)

- Specialization bonuses for perception (v0.15.6h)
- Room entry integration flow (v0.15.6i)
- Complex multi-scene investigations spanning multiple rooms (future version)
- NPC interrogation as investigation (covered by Rhetoric in v0.15.3)
- Forensic alchemy for remains analysis (future version)
- Investigation journal/log persistence (future version)

---

## 3. Data Model

### 3.1 InvestigationTarget Enum

```csharp
/// <summary>
/// Defines the type of target that can be investigated.
/// Each target type has different clue discovery mechanics and DC modifiers.
/// </summary>
public enum InvestigationTarget
{
    /// <summary>
    /// A crime scene such as a murder site, theft location, or sabotage area.
    /// Clues include: blood patterns, tool marks, footprints, struggle signs.
    /// </summary>
    CrimeScene,

    /// <summary>
    /// Remains of a creature or person, including corpses and skeletons.
    /// Clues include: cause of death, identity markers, last actions, equipment.
    /// </summary>
    Remains,

    /// <summary>
    /// Destroyed or damaged equipment, vehicles, or structures.
    /// Clues include: cause of destruction, salvageable parts, sabotage signs.
    /// </summary>
    Wreckage,

    /// <summary>
    /// Physical trails such as footprints, blood trails, or drag marks.
    /// Clues include: direction, creature type, time elapsed, number of travelers.
    /// </summary>
    Trail,

    /// <summary>
    /// Written documents, logs, or inscriptions.
    /// Clues include: author identity, hidden meanings, referenced locations.
    /// </summary>
    Document
}
```

### 3.2 InvestigationContext Value Object

```csharp
/// <summary>
/// Represents the context of an ongoing investigation, tracking the target,
/// character, and all clues gathered during the investigation.
/// </summary>
/// <remarks>
/// <para>
/// InvestigationContext maintains state across the investigation process,
/// allowing clues to accumulate and deductions to become available as
/// sufficient evidence is gathered. The context persists until the
/// investigation is concluded or the character leaves the area.
/// </para>
/// <para>
/// Time spent is tracked to enable tactical decisions about investigation
/// depth versus other priorities.
/// </para>
/// </remarks>
public sealed record InvestigationContext
{
    /// <summary>
    /// The type of target being investigated.
    /// </summary>
    public required InvestigationTarget TargetType { get; init; }

    /// <summary>
    /// The unique identifier of the target object or area.
    /// </summary>
    public required string TargetId { get; init; }

    /// <summary>
    /// The unique identifier of the investigating character.
    /// </summary>
    public required string CharacterId { get; init; }

    /// <summary>
    /// The room where the investigation is taking place.
    /// </summary>
    public required string RoomId { get; init; }

    /// <summary>
    /// Collection of clue identifiers gathered during this investigation.
    /// </summary>
    public required IReadOnlyList<string> CluesGathered { get; init; }

    /// <summary>
    /// Total time spent on this investigation, in minutes.
    /// </summary>
    public required int TimeSpent { get; init; }

    /// <summary>
    /// Collection of deductions that are now available based on gathered clues.
    /// </summary>
    public required IReadOnlyList<Deduction> DeductionsAvailable { get; init; }

    /// <summary>
    /// The base difficulty class for this investigation target.
    /// </summary>
    public required int BaseDc { get; init; }

    /// <summary>
    /// Indicates whether this investigation has been completed.
    /// </summary>
    public bool IsComplete { get; init; }

    /// <summary>
    /// Gets the total number of clues discovered.
    /// </summary>
    public int ClueCount => CluesGathered.Count;

    /// <summary>
    /// Gets whether any deductions are available.
    /// </summary>
    public bool HasDeductions => DeductionsAvailable.Count > 0;
}
```

### 3.3 Clue Value Object

```csharp
/// <summary>
/// Represents a piece of evidence discovered during investigation.
/// Clues can be combined to form deductions and reveal hidden truths.
/// </summary>
/// <remarks>
/// <para>
/// Each clue represents a discrete piece of information that, while
/// potentially meaningful on its own, becomes more significant when
/// combined with other related clues. Clues are categorized to help
/// the deduction system identify which clues can be combined.
/// </para>
/// </remarks>
public sealed record Clue
{
    /// <summary>
    /// Unique identifier for this clue.
    /// </summary>
    public required string ClueId { get; init; }

    /// <summary>
    /// The investigation target type this clue was found on.
    /// </summary>
    public required InvestigationTarget SourceType { get; init; }

    /// <summary>
    /// The identifier of the specific target where this clue was found.
    /// </summary>
    public required string SourceTargetId { get; init; }

    /// <summary>
    /// Category of clue for deduction matching.
    /// </summary>
    /// <remarks>
    /// Categories include: Identity, Cause, Method, Motive, Location, Time, Creature
    /// </remarks>
    public required string Category { get; init; }

    /// <summary>
    /// Difficulty class required to discover this clue.
    /// </summary>
    public required int DiscoveryDc { get; init; }

    /// <summary>
    /// Short name for the clue (for tracking/display).
    /// </summary>
    public required string ClueName { get; init; }

    /// <summary>
    /// Detailed description revealed when the clue is discovered.
    /// </summary>
    public required string Description { get; init; }

    /// <summary>
    /// Narrative text shown when the clue is discovered.
    /// </summary>
    public required string DiscoveryText { get; init; }

    /// <summary>
    /// Optional tags for grouping related clues.
    /// </summary>
    public IReadOnlyList<string> Tags { get; init; } = Array.Empty<string>();

    /// <summary>
    /// Weight for determining how significant this clue is.
    /// Higher weight clues contribute more to deduction confidence.
    /// </summary>
    public int Weight { get; init; } = 1;
}
```

### 3.4 Deduction Value Object

```csharp
/// <summary>
/// Represents a logical conclusion that can be drawn from combining
/// multiple clues. Deductions reveal hidden truths and advance understanding.
/// </summary>
/// <remarks>
/// <para>
/// Deductions become available when the required clues are gathered.
/// Each deduction specifies which clues are prerequisites. When all
/// prerequisites are met, the deduction can be made, revealing new
/// information and potentially unlocking new interactions.
/// </para>
/// </remarks>
public sealed record Deduction
{
    /// <summary>
    /// Unique identifier for this deduction.
    /// </summary>
    public required string DeductionId { get; init; }

    /// <summary>
    /// Display name for the deduction.
    /// </summary>
    public required string DeductionName { get; init; }

    /// <summary>
    /// Collection of clue IDs required to make this deduction.
    /// </summary>
    public required IReadOnlyList<string> RequiredClueIds { get; init; }

    /// <summary>
    /// The logical conclusion text revealed when deduction is made.
    /// </summary>
    public required string ConclusionText { get; init; }

    /// <summary>
    /// Narrative text shown when the deduction is made.
    /// </summary>
    public required string DeductionNarrative { get; init; }

    /// <summary>
    /// Optional: New interactions or commands unlocked by this deduction.
    /// </summary>
    public IReadOnlyList<string> UnlocksInteractions { get; init; } = Array.Empty<string>();

    /// <summary>
    /// Optional: Quest or story flags set by this deduction.
    /// </summary>
    public IReadOnlyList<string> SetsFlags { get; init; } = Array.Empty<string>();

    /// <summary>
    /// Whether this deduction reveals the identity of someone/something.
    /// </summary>
    public bool RevealsIdentity { get; init; }

    /// <summary>
    /// Whether this deduction reveals a cause or motive.
    /// </summary>
    public bool RevealsCause { get; init; }

    /// <summary>
    /// The minimum number of required clues needed to attempt this deduction.
    /// </summary>
    public int MinimumCluesRequired => RequiredClueIds.Count;

    /// <summary>
    /// Checks if all required clues have been gathered.
    /// </summary>
    public bool CanDeduce(IEnumerable<string> gatheredClueIds)
    {
        return RequiredClueIds.All(gatheredClueIds.Contains);
    }
}
```

### 3.5 InvestigationResult Value Object

```csharp
/// <summary>
/// Represents the complete results of an investigation action,
/// including clues discovered, deductions made, and narrative output.
/// </summary>
public sealed record InvestigationResult
{
    /// <summary>
    /// The target that was investigated.
    /// </summary>
    public required string TargetId { get; init; }

    /// <summary>
    /// The type of target investigated.
    /// </summary>
    public required InvestigationTarget TargetType { get; init; }

    /// <summary>
    /// Whether the investigation check succeeded.
    /// </summary>
    public required bool Success { get; init; }

    /// <summary>
    /// The number of successes from the WITS + Investigation check.
    /// </summary>
    public required int CheckResult { get; init; }

    /// <summary>
    /// The difficulty class that was checked against.
    /// </summary>
    public required int DifficultyClass { get; init; }

    /// <summary>
    /// Collection of new clues discovered in this investigation.
    /// </summary>
    public required IReadOnlyList<Clue> CluesDiscovered { get; init; }

    /// <summary>
    /// Collection of deductions made from accumulated clues.
    /// </summary>
    public required IReadOnlyList<Deduction> DeductionsMade { get; init; }

    /// <summary>
    /// Narrative text describing the investigation findings.
    /// </summary>
    public required string NarrativeText { get; init; }

    /// <summary>
    /// Time spent on this investigation action, in minutes.
    /// </summary>
    public required int TimeSpent { get; init; }

    /// <summary>
    /// Whether this was an expert-level success (net successes >= 5).
    /// Expert success reveals hidden connections.
    /// </summary>
    public bool IsExpertSuccess { get; init; }

    /// <summary>
    /// Optional: Hidden connections revealed on expert success.
    /// </summary>
    public string? HiddenConnectionsRevealed { get; init; }

    /// <summary>
    /// Gets the total number of discoveries (clues + deductions).
    /// </summary>
    public int TotalDiscoveries => CluesDiscovered.Count + DeductionsMade.Count;

    /// <summary>
    /// Gets whether any new information was discovered.
    /// </summary>
    public bool HasDiscoveries => TotalDiscoveries > 0;
}
```

### 3.6 ClueCategory Enum

```csharp
/// <summary>
/// Defines categories for organizing and matching clues for deductions.
/// </summary>
public enum ClueCategory
{
    /// <summary>
    /// Clues about who was involved (names, descriptions, affiliations).
    /// </summary>
    Identity,

    /// <summary>
    /// Clues about what caused an event (murder weapon, explosion source).
    /// </summary>
    Cause,

    /// <summary>
    /// Clues about how something was done (method, technique, tools).
    /// </summary>
    Method,

    /// <summary>
    /// Clues about why something occurred (motivation, goals, grudges).
    /// </summary>
    Motive,

    /// <summary>
    /// Clues about where something happened or leads to.
    /// </summary>
    Location,

    /// <summary>
    /// Clues about when something occurred or timeline ordering.
    /// </summary>
    Time,

    /// <summary>
    /// Clues about creatures involved (species, behavior, tracks).
    /// </summary>
    Creature,

    /// <summary>
    /// Clues about objects or artifacts involved.
    /// </summary>
    Object,

    /// <summary>
    /// Clues about historical context or past events.
    /// </summary>
    History
}
```

### 3.7 InvestigationDifficulty Reference

```csharp
/// <summary>
/// Reference values for investigation difficulty by target complexity.
/// </summary>
public static class InvestigationDifficulty
{
    /// <summary>
    /// Fresh, undisturbed scene with obvious clues. DC 8.
    /// </summary>
    public const int Obvious = 8;

    /// <summary>
    /// Standard investigation with moderate complexity. DC 12.
    /// </summary>
    public const int Standard = 12;

    /// <summary>
    /// Complex scene requiring careful analysis. DC 16.
    /// </summary>
    public const int Complex = 16;

    /// <summary>
    /// Obscured or deliberately hidden evidence. DC 20.
    /// </summary>
    public const int Obscured = 20;

    /// <summary>
    /// Ancient or heavily degraded evidence. DC 24.
    /// </summary>
    public const int Ancient = 24;
}
```

---

## 4. Services

### 4.1 IInvestigationService Interface

```csharp
/// <summary>
/// Provides investigation functionality for discovering clues and forming
/// deductions from crime scenes, remains, wreckage, trails, and documents.
/// </summary>
/// <remarks>
/// <para>
/// The investigation service manages the analytical examination of targets
/// to uncover clues. Unlike examination (which reveals descriptions) or
/// searching (which finds hidden elements), investigation focuses on
/// piecing together evidence to understand what happened.
/// </para>
/// <para>
/// Investigations use WITS + Investigation skill for checks, with DC
/// determined by target complexity. Expert successes (net >= 5) reveal
/// hidden connections between clues.
/// </para>
/// </remarks>
public interface IInvestigationService
{
    /// <summary>
    /// Investigates a target to discover clues and form deductions.
    /// </summary>
    /// <param name="characterId">The character performing the investigation.</param>
    /// <param name="targetId">The target to investigate.</param>
    /// <param name="targetType">The type of target being investigated.</param>
    /// <returns>Complete investigation results including clues and deductions.</returns>
    /// <remarks>
    /// Investigation process:
    /// 1. Validate target is investigable
    /// 2. Perform WITS + Investigation skill check
    /// 3. Calculate time cost based on target type
    /// 4. Discover clues based on check result vs clue DCs
    /// 5. Check for available deductions from accumulated clues
    /// 6. On expert success (net >= 5), reveal hidden connections
    /// 7. Return comprehensive InvestigationResult
    /// </remarks>
    Task<InvestigationResult> InvestigateAsync(
        string characterId,
        string targetId,
        InvestigationTarget targetType);

    /// <summary>
    /// Gets the current investigation context for a character and target.
    /// Returns null if no investigation is in progress.
    /// </summary>
    /// <param name="characterId">The character to check.</param>
    /// <param name="targetId">The target to check.</param>
    /// <returns>Current investigation context or null.</returns>
    InvestigationContext? GetActiveInvestigation(string characterId, string targetId);

    /// <summary>
    /// Gets all clues a character has discovered across all investigations.
    /// </summary>
    /// <param name="characterId">The character to query.</param>
    /// <returns>All discovered clues for this character.</returns>
    IReadOnlyList<Clue> GetDiscoveredClues(string characterId);

    /// <summary>
    /// Gets all deductions a character has made across all investigations.
    /// </summary>
    /// <param name="characterId">The character to query.</param>
    /// <returns>All deductions made by this character.</returns>
    IReadOnlyList<Deduction> GetMadeDeductions(string characterId);

    /// <summary>
    /// Checks what deductions are now available based on gathered clues.
    /// </summary>
    /// <param name="characterId">The character to check.</param>
    /// <returns>Deductions that can now be made.</returns>
    IReadOnlyList<Deduction> GetAvailableDeductions(string characterId);

    /// <summary>
    /// Attempts to make a specific deduction if all required clues are present.
    /// </summary>
    /// <param name="characterId">The character making the deduction.</param>
    /// <param name="deductionId">The deduction to attempt.</param>
    /// <returns>True if deduction was successful, false if missing clues.</returns>
    Task<bool> AttemptDeductionAsync(string characterId, string deductionId);

    /// <summary>
    /// Gets all investigable targets in the current room.
    /// </summary>
    /// <param name="roomId">The room to check.</param>
    /// <returns>List of investigable targets with their types.</returns>
    IReadOnlyList<(string TargetId, InvestigationTarget Type, string Name)> GetInvestigableTargets(
        string roomId);
}
```

### 4.2 InvestigationService Implementation Notes

```csharp
/// <summary>
/// Implementation of the investigation service.
/// </summary>
public sealed class InvestigationService : IInvestigationService
{
    private readonly IWitsCheckService _witsCheckService;
    private readonly ISkillService _skillService;
    private readonly IClueRepository _clueRepository;
    private readonly IDeductionRepository _deductionRepository;
    private readonly IPlayerClueTracker _playerClueTracker;
    private readonly ITimeService _timeService;
    private readonly IInvestigationConfiguration _configuration;

    public async Task<InvestigationResult> InvestigateAsync(
        string characterId,
        string targetId,
        InvestigationTarget targetType)
    {
        // 1. Get target data and base DC
        var target = await GetTargetDataAsync(targetId, targetType);
        var baseDc = CalculateBaseDc(targetType, target);

        // 2. Get character's Investigation skill rank
        var investigationRank = _skillService.GetSkillRank(characterId, "Investigation");

        // 3. Perform WITS + Investigation check
        var checkResult = await _witsCheckService.PerformSkillCheckAsync(
            characterId,
            "Wits",
            investigationRank);

        // 4. Calculate time cost
        var timeCost = CalculateTimeCost(targetType);
        await _timeService.AdvanceMinutesAsync(timeCost);

        // 5. Discover clues based on check result
        var discoveredClues = await DiscoverCluesAsync(
            characterId,
            targetId,
            targetType,
            checkResult.TotalSuccesses);

        // 6. Record clues to player tracker
        foreach (var clue in discoveredClues)
        {
            await _playerClueTracker.RecordClueDiscoveryAsync(characterId, clue.ClueId);
        }

        // 7. Check for available deductions
        var allClues = _playerClueTracker.GetAllClues(characterId);
        var availableDeductions = GetDeductionsFromClues(allClues);
        var newDeductions = await AttemptAutoDeductionsAsync(characterId, availableDeductions);

        // 8. Check for expert success (hidden connections)
        var isExpert = checkResult.TotalSuccesses >= 5;
        var hiddenConnections = isExpert
            ? await GetHiddenConnectionsAsync(targetId, targetType)
            : null;

        // 9. Generate narrative
        var narrative = GenerateNarrative(
            targetType,
            checkResult.TotalSuccesses >= baseDc,
            discoveredClues,
            newDeductions,
            isExpert);

        return new InvestigationResult
        {
            TargetId = targetId,
            TargetType = targetType,
            Success = checkResult.TotalSuccesses >= baseDc,
            CheckResult = checkResult.TotalSuccesses,
            DifficultyClass = baseDc,
            CluesDiscovered = discoveredClues,
            DeductionsMade = newDeductions,
            NarrativeText = narrative,
            TimeSpent = timeCost,
            IsExpertSuccess = isExpert,
            HiddenConnectionsRevealed = hiddenConnections
        };
    }

    private int CalculateTimeCost(InvestigationTarget targetType)
    {
        return targetType switch
        {
            InvestigationTarget.CrimeScene => _configuration.CrimeSceneTime,  // 15 minutes
            InvestigationTarget.Remains => _configuration.RemainsTime,         // 10 minutes
            InvestigationTarget.Wreckage => _configuration.WreckageTime,       // 15 minutes
            InvestigationTarget.Trail => _configuration.TrailTime,             // 5 minutes
            InvestigationTarget.Document => _configuration.DocumentTime,       // 5 minutes
            _ => _configuration.DefaultTime
        };
    }

    private async Task<IReadOnlyList<Clue>> DiscoverCluesAsync(
        string characterId,
        string targetId,
        InvestigationTarget targetType,
        int checkSuccesses)
    {
        // Get all clues associated with this target
        var targetClues = await _clueRepository.GetCluesForTargetAsync(targetId, targetType);

        // Get already-discovered clues
        var knownClues = _playerClueTracker.GetAllClues(characterId);

        // Filter to clues that:
        // 1. Haven't been discovered yet
        // 2. Have DC <= check successes
        return targetClues
            .Where(c => !knownClues.Contains(c.ClueId) &&
                       c.DiscoveryDc <= checkSuccesses)
            .ToList();
    }
}
```

### 4.3 IPlayerClueTracker Interface

```csharp
/// <summary>
/// Tracks clues and deductions discovered by each player character.
/// </summary>
public interface IPlayerClueTracker
{
    /// <summary>
    /// Records that a character has discovered a clue.
    /// </summary>
    Task RecordClueDiscoveryAsync(string characterId, string clueId);

    /// <summary>
    /// Records that a character has made a deduction.
    /// </summary>
    Task RecordDeductionAsync(string characterId, string deductionId);

    /// <summary>
    /// Gets all clue IDs discovered by a character.
    /// </summary>
    IReadOnlyList<string> GetAllClues(string characterId);

    /// <summary>
    /// Gets all deduction IDs made by a character.
    /// </summary>
    IReadOnlyList<string> GetAllDeductions(string characterId);

    /// <summary>
    /// Checks if a character has discovered a specific clue.
    /// </summary>
    bool HasClue(string characterId, string clueId);

    /// <summary>
    /// Checks if a character has made a specific deduction.
    /// </summary>
    bool HasDeduction(string characterId, string deductionId);
}
```

### 4.4 IInvestigationConfiguration Interface

```csharp
/// <summary>
/// Configuration settings for investigation operations.
/// </summary>
public interface IInvestigationConfiguration
{
    /// <summary>
    /// Time in minutes to investigate a crime scene.
    /// </summary>
    int CrimeSceneTime { get; }

    /// <summary>
    /// Time in minutes to investigate remains.
    /// </summary>
    int RemainsTime { get; }

    /// <summary>
    /// Time in minutes to investigate wreckage.
    /// </summary>
    int WreckageTime { get; }

    /// <summary>
    /// Time in minutes to investigate a trail.
    /// </summary>
    int TrailTime { get; }

    /// <summary>
    /// Time in minutes to investigate a document.
    /// </summary>
    int DocumentTime { get; }

    /// <summary>
    /// Default investigation time in minutes.
    /// </summary>
    int DefaultTime { get; }

    /// <summary>
    /// Whether to automatically attempt deductions when clues are sufficient.
    /// </summary>
    bool AutoDeduction { get; }

    /// <summary>
    /// Threshold for expert success (net successes required).
    /// </summary>
    int ExpertSuccessThreshold { get; }
}
```

---

## 5. Command Changes

### 5.1 Investigation Command

```csharp
/// <summary>
/// Handles the 'investigate' command for analytical examination of targets.
/// </summary>
/// <remarks>
/// <para>
/// The investigate command enables deep analysis of specific targets to
/// discover clues and form deductions. Unlike examine (descriptions) or
/// search (hidden elements), investigate focuses on understanding what
/// happened or what something means.
/// </para>
/// <para>
/// Syntax:
/// - investigate (lists investigable targets in room)
/// - investigate [target] (investigates specific target)
/// - investigate clues (shows all discovered clues)
/// - investigate deductions (shows all made deductions)
/// </para>
/// </remarks>
public class InvestigateCommand : ICommand
{
    public string Name => "investigate";
    public string[] Aliases => new[] { "inv", "analyze" };
    public string Description => "Investigate targets to discover clues and form deductions.";

    private readonly IInvestigationService _investigationService;
    private readonly IInvestigationRenderer _renderer;
    private readonly IGameStateService _gameStateService;
    private readonly ITargetResolver _targetResolver;

    public async Task<CommandResult> ExecuteAsync(CommandContext context)
    {
        var characterId = context.CurrentCharacterId;
        var roomId = _gameStateService.GetCurrentRoomId(characterId);

        // No arguments: list investigable targets
        if (context.Arguments.Length == 0)
        {
            var targets = _investigationService.GetInvestigableTargets(roomId);
            var output = _renderer.RenderTargetList(targets);
            return CommandResult.Success(output);
        }

        var argument = context.Arguments[0].ToLowerInvariant();

        // Special commands
        switch (argument)
        {
            case "clues":
                var clues = _investigationService.GetDiscoveredClues(characterId);
                return CommandResult.Success(_renderer.RenderClueList(clues));

            case "deductions":
                var deductions = _investigationService.GetMadeDeductions(characterId);
                return CommandResult.Success(_renderer.RenderDeductionList(deductions));
        }

        // Resolve target
        var targetResult = _targetResolver.ResolveInvestigationTarget(
            string.Join(" ", context.Arguments),
            roomId);

        if (!targetResult.Success)
        {
            return CommandResult.Failure($"Cannot investigate '{string.Join(" ", context.Arguments)}'. {targetResult.ErrorMessage}");
        }

        // Perform investigation
        var result = await _investigationService.InvestigateAsync(
            characterId,
            targetResult.TargetId,
            targetResult.TargetType);

        // Render results
        var output = _renderer.Render(result);
        return CommandResult.Success(output);
    }
}
```

### 5.2 Command Syntax Reference

| Command | Description | Example |
|---------|-------------|---------|
| `investigate` | List investigable targets in current room | `investigate` |
| `investigate <target>` | Investigate a specific target | `investigate corpse` |
| `investigate clues` | Show all discovered clues | `investigate clues` |
| `investigate deductions` | Show all made deductions | `investigate deductions` |

### 5.3 Command Flow Diagram

```
investigate command
    │
    ├─── No arguments ─────────────────────────────────────────┐
    │                                                          │
    │    ┌─────────────────────────────────────────────────────┐
    │    │ List all investigable targets in room              │
    │    └─────────────────────────────────────────────────────┘
    │                                                          │
    ├─── "clues" argument ─────────────────────────────────────┐
    │                                                          │
    │    ┌─────────────────────────────────────────────────────┐
    │    │ Display all discovered clues for character         │
    │    └─────────────────────────────────────────────────────┘
    │                                                          │
    ├─── "deductions" argument ────────────────────────────────┐
    │                                                          │
    │    ┌─────────────────────────────────────────────────────┐
    │    │ Display all deductions made by character           │
    │    └─────────────────────────────────────────────────────┘
    │                                                          │
    └─── <target> argument ────────────────────────────────────┐
         │                                                      │
         ▼                                                      │
┌─────────────────────────────────────────────────────────────┐
│ Resolve target in room                                      │
└─────────────────────────────────────────────────────────────┘
         │
         ▼
┌─────────────────────────────────────────────────────────────┐
│ Get Investigation skill rank                                │
└─────────────────────────────────────────────────────────────┘
         │
         ▼
┌─────────────────────────────────────────────────────────────┐
│ Perform WITS + Investigation check                          │
│ (success-counting dice mechanics)                           │
└─────────────────────────────────────────────────────────────┘
         │
         ▼
┌─────────────────────────────────────────────────────────────┐
│ Calculate and advance time cost                             │
└─────────────────────────────────────────────────────────────┘
         │
         ▼
┌─────────────────────────────────────────────────────────────┐
│ Discover clues where DC <= check result                     │
└─────────────────────────────────────────────────────────────┘
         │
         ▼
┌─────────────────────────────────────────────────────────────┐
│ Check for newly available deductions                        │
│ (clue combinations that now satisfy requirements)           │
└─────────────────────────────────────────────────────────────┘
         │
         ▼
┌─────────────────────────────────────────────────────────────┐
│ If expert success (net >= 5):                               │
│   Reveal hidden connections                                 │
└─────────────────────────────────────────────────────────────┘
         │
         ▼
┌─────────────────────────────────────────────────────────────┐
│ Build and return InvestigationResult                        │
└─────────────────────────────────────────────────────────────┘
         │
         ▼
┌─────────────────────────────────────────────────────────────┐
│ Render comprehensive output                                 │
└─────────────────────────────────────────────────────────────┘
```

---

## 6. Rendering Changes

### 6.1 IInvestigationRenderer Interface

```csharp
/// <summary>
/// Renders investigation results for display to the player.
/// </summary>
public interface IInvestigationRenderer
{
    /// <summary>
    /// Renders a complete investigation result.
    /// </summary>
    string Render(InvestigationResult result);

    /// <summary>
    /// Renders a list of investigable targets in the current room.
    /// </summary>
    string RenderTargetList(
        IReadOnlyList<(string TargetId, InvestigationTarget Type, string Name)> targets);

    /// <summary>
    /// Renders a list of all discovered clues.
    /// </summary>
    string RenderClueList(IReadOnlyList<Clue> clues);

    /// <summary>
    /// Renders a list of all made deductions.
    /// </summary>
    string RenderDeductionList(IReadOnlyList<Deduction> deductions);

    /// <summary>
    /// Renders a single clue discovery.
    /// </summary>
    string RenderClueDiscovery(Clue clue);

    /// <summary>
    /// Renders a deduction being made.
    /// </summary>
    string RenderDeductionMade(Deduction deduction);
}
```

### 6.2 Investigation Result Output Format

```
> investigate corpse

[WITS + Investigation Check vs DC 12]
WITS Pool: 4d10  |  Investigation Rank: 2 (+2d10)
Rolling 6d10... 3, 5, 8, 9, 10, 1
Successes: 3 (8, 9, 10) | Botch: 1 | Net: 2
Check Result: 2 successes

[Investigating Fallen Scavenger... 10 minutes]

─── Clues Discovered ───

[Clue: Cause of Death] (DC 1)
The scavenger's wounds are consistent with Draugr claw marks—three
parallel gashes across the torso. Death was likely rapid.

[Clue: Time of Death] (DC 2)
Based on the condition of the remains, death occurred approximately
2-3 hours ago. The body is still warm to the touch.

─── Deduction Available ───

You now have enough clues to form a deduction about this scene.
[New deduction available: "Draugr Attack"]
Use 'investigate deductions' to view available deductions.

Time elapsed: 10 minutes
Clues discovered: 2
```

### 6.3 Expert Success Output Format

```
> investigate crime scene

[WITS + Investigation Check vs DC 16]
WITS Pool: 5d10  |  Investigation Rank: 3 (+3d10)
Rolling 8d10... 6, 8, 8, 9, 9, 10, 10, 2
Successes: 6 (8, 8, 9, 9, 10, 10)
Check Result: 6 successes — EXPERT SUCCESS!

[Investigating Murder Scene... 15 minutes]

─── Clues Discovered ───

[Clue: Murder Weapon] (DC 2)
A bloodied maintenance tool lies discarded near the body—a heavy
wrench with Jötun manufacturing marks.

[Clue: Defensive Wounds] (DC 3)
The victim's hands show defensive wounds, indicating they fought
back against their attacker.

[Clue: Boot Prints] (DC 4)
Heavy boot prints in the dust lead away from the scene toward
the eastern corridor. Size suggests a large individual.

[Clue: Missing Badge] (DC 5)
The victim's security badge is missing from their uniform. The
badge clip remains, torn as if forcibly removed.

─── Expert Analysis: Hidden Connections ───

Your keen analytical mind pieces together subtle details others
would miss: The angle of the wounds suggests a left-handed attacker.
The boot prints are distinctive—military-grade Dvergr manufacture.
Combined with the missing badge, this appears to be a targeted
assassination rather than a random attack.

─── Deductions Made ───

[DEDUCTION: Targeted Assassination]
Combining: Murder Weapon + Missing Badge + Boot Prints

This was no random violence. The attacker specifically targeted this
individual, killed them efficiently, and took their security badge.
The Dvergr military boots suggest the killer may be connected to the
Forge-Guard or a similar organization.

[Quest Updated: Find the Killer]
[New Interaction: Examine boot prints with 'track killer']

Time elapsed: 15 minutes
Clues discovered: 4 | Deductions made: 1
```

### 6.4 Target List Output Format

```
> investigate

─── Investigable Targets ───

[Remains]
• Fallen Scavenger - A body slumped against the wall
• Ancient Skeleton - Bones partially buried in debris

[Wreckage]
• Destroyed Terminal - A shattered console, still sparking

[Trail]
• Blood Trail - Dark stains leading toward the eastern door

Use 'investigate <target>' to examine a specific target.
```

### 6.5 Clue List Output Format

```
> investigate clues

─── Discovered Clues ───

[From: Fallen Scavenger]
• Cause of Death (Identity) - Draugr claw wounds
• Time of Death (Time) - 2-3 hours ago

[From: Murder Scene]
• Murder Weapon (Cause) - Bloodied maintenance wrench
• Defensive Wounds (Method) - Victim fought back
• Boot Prints (Identity) - Large, Dvergr military manufacture
• Missing Badge (Motive) - Security access theft

Total clues: 6
```

---

## 7. Configuration

### 7.1 Investigation Configuration File

**File:** `data/config/investigation-config.json`

```json
{
  "investigationSettings": {
    "timeCosts": {
      "crimeScene": 15,
      "remains": 10,
      "wreckage": 15,
      "trail": 5,
      "document": 5,
      "default": 10
    },
    "difficultyModifiers": {
      "fresh": -2,
      "recent": 0,
      "old": 2,
      "ancient": 4,
      "disturbed": 2,
      "pristine": -1
    },
    "autoDeduction": true,
    "expertSuccessThreshold": 5,
    "showDiceRolls": true,
    "showDcValues": true
  },
  "displaySettings": {
    "groupCluesBySource": true,
    "showClueCategories": true,
    "showDeductionRequirements": false,
    "narrativeStyle": "detailed"
  }
}
```

### 7.2 Clues Data File

**File:** `data/investigation/clues.json`

```json
{
  "clues": [
    {
      "clueId": "clue-scavenger-cause-death",
      "sourceType": "Remains",
      "sourceTargetId": "corpse-fallen-scavenger",
      "category": "Cause",
      "discoveryDc": 1,
      "clueName": "Cause of Death",
      "description": "Draugr claw wounds - three parallel gashes",
      "discoveryText": "The scavenger's wounds are consistent with Draugr claw marks—three parallel gashes across the torso.",
      "tags": ["draugr", "violence", "creature-attack"],
      "weight": 2
    },
    {
      "clueId": "clue-scavenger-time-death",
      "sourceType": "Remains",
      "sourceTargetId": "corpse-fallen-scavenger",
      "category": "Time",
      "discoveryDc": 2,
      "clueName": "Time of Death",
      "description": "Death occurred 2-3 hours ago",
      "discoveryText": "Based on the condition of the remains, death occurred approximately 2-3 hours ago.",
      "tags": ["timeline", "recent"],
      "weight": 1
    },
    {
      "clueId": "clue-murder-weapon",
      "sourceType": "CrimeScene",
      "sourceTargetId": "scene-level7-murder",
      "category": "Cause",
      "discoveryDc": 2,
      "clueName": "Murder Weapon",
      "description": "Bloodied maintenance wrench with Jötun marks",
      "discoveryText": "A bloodied maintenance tool lies discarded—a heavy wrench with Jötun manufacturing marks.",
      "tags": ["weapon", "jotun", "blunt-force"],
      "weight": 3
    }
  ]
}
```

### 7.3 Deductions Data File

**File:** `data/investigation/deductions.json`

```json
{
  "deductions": [
    {
      "deductionId": "deduction-draugr-attack",
      "deductionName": "Draugr Attack",
      "requiredClueIds": [
        "clue-scavenger-cause-death",
        "clue-scavenger-time-death"
      ],
      "conclusionText": "The scavenger was killed by a Draugr within the last few hours. The creature may still be nearby.",
      "deductionNarrative": "Piecing together the evidence, you conclude that a Draugr attacked and killed this scavenger recently. The creature's hunting pattern suggests it may still be in the area.",
      "unlocksInteractions": [],
      "setsFlags": ["flag-draugr-nearby"],
      "revealsIdentity": false,
      "revealsCause": true
    },
    {
      "deductionId": "deduction-targeted-assassination",
      "deductionName": "Targeted Assassination",
      "requiredClueIds": [
        "clue-murder-weapon",
        "clue-boot-prints",
        "clue-missing-badge"
      ],
      "conclusionText": "This was a targeted assassination. The killer took the victim's security badge, suggesting the murder was committed to gain access to restricted areas.",
      "deductionNarrative": "This was no random violence. The attacker specifically targeted this individual, killed them efficiently, and took their security badge for access purposes.",
      "unlocksInteractions": ["track-killer"],
      "setsFlags": ["flag-assassination-discovered", "quest-find-killer"],
      "revealsIdentity": false,
      "revealsCause": true
    }
  ]
}
```

---

## 8. Integration with Existing Systems

### 8.1 Search Command Integration (v0.15.6f)

Investigation complements searching:

| Aspect | Search (v0.15.6f) | Investigate (v0.15.6g) |
|--------|-------------------|------------------------|
| Purpose | Find hidden elements | Discover clues |
| Target | Room or container | Specific object/scene |
| Result | Items and elements | Clues and deductions |
| Check | WITS + Active bonus | WITS + Investigation skill |
| Depth | Breadth (whole area) | Depth (single target) |

### 8.2 Examination Integration (v0.15.6b)

Investigation differs from examination:

```
Examination (examine <object>):
  - Reveals layered descriptions (Layer 1/2/3)
  - Provides physical and historical details
  - May reveal puzzle hints
  - Focus: "What is this object?"

Investigation (investigate <target>):
  - Discovers clues and evidence
  - Enables deductions from multiple clues
  - Reveals hidden connections on expert success
  - Focus: "What happened here?"
```

### 8.3 Skill System Integration (v0.15.1)

Investigation uses the skill check infrastructure:

```csharp
// Investigation skill check uses success-counting mechanics
var skillContext = new SkillContext
{
    CharacterId = characterId,
    SkillName = "Investigation",
    AttributeName = "Wits",
    BaseDc = target.BaseDc
};

var checkResult = await _skillCheckService.PerformCheckAsync(skillContext);

// Expert success at net >= 5
if (checkResult.NetSuccesses >= 5)
{
    // Reveal hidden connections
}
```

### 8.4 Puzzle Hint Integration (v0.15.6e)

Investigation can reveal puzzle hints embedded in clues:

```csharp
// When a clue is discovered, check for linked puzzle hints
if (clue.Tags.Contains("puzzle-linked"))
{
    var hint = await _puzzleHintService.GetHintForClueAsync(clue.ClueId);
    if (hint != null)
    {
        await _playerHintTracker.RecordHintDiscoveryAsync(characterId, hint.HintId);
    }
}
```

### 8.5 Time System Integration

Investigation operations consume game time:

```csharp
// Time costs by target type
var timeCost = targetType switch
{
    InvestigationTarget.CrimeScene => 15, // Thorough scene analysis
    InvestigationTarget.Remains => 10,    // Body examination
    InvestigationTarget.Wreckage => 15,   // Debris analysis
    InvestigationTarget.Trail => 5,       // Quick trail reading
    InvestigationTarget.Document => 5,    // Document analysis
    _ => 10
};

await _timeService.AdvanceMinutesAsync(timeCost);
```

---

## 9. Acceptance Criteria

### 9.1 Core Investigation Functionality

| ID | Criterion | Priority |
|----|-----------|----------|
| AC-1 | `investigate` command lists investigable targets in room | Must |
| AC-2 | `investigate <target>` performs WITS + Investigation check | Must |
| AC-3 | Clues with DC <= check result are discovered | Must |
| AC-4 | Investigation consumes time based on target type | Must |
| AC-5 | Discovered clues are tracked per character | Must |

### 9.2 Deduction System

| ID | Criterion | Priority |
|----|-----------|----------|
| AC-6 | Deductions become available when required clues are gathered | Must |
| AC-7 | Multiple clues combine to enable logical deductions | Must |
| AC-8 | Deductions can unlock new interactions/commands | Should |
| AC-9 | Deductions can set quest/story flags | Should |

### 9.3 Expert Success

| ID | Criterion | Priority |
|----|-----------|----------|
| AC-10 | Expert success (net >= 5) reveals hidden connections | Must |
| AC-11 | Hidden connections provide additional narrative insight | Should |

### 9.4 Target Types

| ID | Criterion | Priority |
|----|-----------|----------|
| AC-12 | Crime scenes can be investigated | Must |
| AC-13 | Remains (corpses, skeletons) can be investigated | Must |
| AC-14 | Wreckage can be investigated | Should |
| AC-15 | Trails can be investigated | Should |
| AC-16 | Documents can be investigated | Should |

### 9.5 User Experience

| ID | Criterion | Priority |
|----|-----------|----------|
| AC-17 | `investigate clues` shows all discovered clues | Must |
| AC-18 | `investigate deductions` shows all made deductions | Must |
| AC-19 | Results display dice roll and check calculation | Should |
| AC-20 | Clues are grouped by source in display | Should |

---

## 10. Test Specifications

### 10.1 Unit Tests

#### Test Suite: InvestigationServiceTests

```csharp
[TestClass]
public class InvestigationServiceTests
{
    /// <summary>
    /// Verifies that investigation discovers appropriate clues based on check result.
    /// </summary>
    /// <remarks>
    /// Given: Target with clues at DC 1, 2, 3, 4
    /// When: Investigation check results in 2 successes
    /// Then: Clues at DC 1 and DC 2 are discovered
    /// </remarks>
    [TestMethod]
    public async Task InvestigateAsync_WithSuccessfulCheck_DiscoversAppropriateClues()
    {
        // Arrange
        var targetClues = new[]
        {
            new Clue { ClueId = "clue-1", DiscoveryDc = 1 },
            new Clue { ClueId = "clue-2", DiscoveryDc = 2 },
            new Clue { ClueId = "clue-3", DiscoveryDc = 3 },
            new Clue { ClueId = "clue-4", DiscoveryDc = 4 }
        };

        _clueRepositoryMock.Setup(r => r.GetCluesForTargetAsync("target-1", InvestigationTarget.Remains))
            .ReturnsAsync(targetClues);
        _witsCheckMock.Setup(w => w.PerformSkillCheckAsync("char-1", "Wits", 2))
            .ReturnsAsync(new SkillCheckResult { TotalSuccesses = 2 });

        // Act
        var result = await _investigationService.InvestigateAsync(
            "char-1",
            "target-1",
            InvestigationTarget.Remains);

        // Assert
        Assert.AreEqual(2, result.CluesDiscovered.Count);
        Assert.IsTrue(result.CluesDiscovered.Any(c => c.ClueId == "clue-1"));
        Assert.IsTrue(result.CluesDiscovered.Any(c => c.ClueId == "clue-2"));
        Assert.IsFalse(result.CluesDiscovered.Any(c => c.ClueId == "clue-3"));
    }

    /// <summary>
    /// Verifies that multiple clues enable deductions.
    /// </summary>
    /// <remarks>
    /// Given: Deduction requiring clue-A and clue-B
    /// When: Both clues have been discovered
    /// Then: Deduction becomes available
    /// </remarks>
    [TestMethod]
    public async Task InvestigateAsync_WithSufficientClues_EnablesDeduction()
    {
        // Arrange
        var deduction = new Deduction
        {
            DeductionId = "deduction-1",
            RequiredClueIds = new[] { "clue-A", "clue-B" }
        };

        _playerClueTrackerMock.Setup(t => t.GetAllClues("char-1"))
            .Returns(new[] { "clue-A", "clue-B" });
        _deductionRepositoryMock.Setup(r => r.GetAllDeductionsAsync())
            .ReturnsAsync(new[] { deduction });

        // Act
        var availableDeductions = _investigationService.GetAvailableDeductions("char-1");

        // Assert
        Assert.AreEqual(1, availableDeductions.Count);
        Assert.AreEqual("deduction-1", availableDeductions[0].DeductionId);
    }

    /// <summary>
    /// Verifies that investigation includes time cost.
    /// </summary>
    [TestMethod]
    public async Task InvestigateAsync_AdvancesTime_BasedOnTargetType()
    {
        // Arrange
        var testCases = new[]
        {
            (InvestigationTarget.CrimeScene, 15),
            (InvestigationTarget.Remains, 10),
            (InvestigationTarget.Wreckage, 15),
            (InvestigationTarget.Trail, 5),
            (InvestigationTarget.Document, 5)
        };

        foreach (var (targetType, expectedTime) in testCases)
        {
            // Act
            var result = await _investigationService.InvestigateAsync(
                "char-1",
                "target-1",
                targetType);

            // Assert
            Assert.AreEqual(expectedTime, result.TimeSpent,
                $"Target type {targetType} should take {expectedTime} minutes");
        }
    }
}
```

### 10.2 Test Coverage Requirements

| Area | Minimum Coverage | Priority |
|------|------------------|----------|
| InvestigationService | 90% | Critical |
| Clue discovery logic | 95% | Critical |
| Deduction matching | 95% | Critical |
| InvestigateCommand | 85% | High |
| InvestigationRenderer | 80% | Medium |
| Time calculation | 100% | Critical |

---

## 11. Dependencies

### 11.1 Upstream Dependencies

| Dependency | Source | Usage |
|------------|--------|-------|
| IWitsCheckService | v0.15.0 | Success-counting dice mechanics |
| ISkillService | v0.15.1 | Investigation skill rank |
| SkillContext | v0.15.1 | Skill check context |
| ISearchService | v0.15.6f | Complementary discovery system |
| IPuzzleHintService | v0.15.6e | Hint discovery from clues |
| ITimeService | Core | Game time advancement |

### 11.2 External Dependencies

| Dependency | Version | Purpose |
|------------|---------|---------|
| IRoomService | Core | Room and target data |
| ITargetResolver | Core | Target name resolution |
| IConfigurationService | Core | Investigation configuration |

### 11.3 Downstream Dependencies

This phase provides to future phases:

| Provides To | Interface/Component | Purpose |
|-------------|---------------------|---------|
| v0.15.6h | IInvestigationService | Specialization bonuses for investigation |
| v0.15.6i | InvestigationResult | Room entry may highlight investigable targets |
| Future | IPlayerClueTracker | Quest system can check for clue/deduction progress |

### 11.4 Dependency Diagram

```
┌─────────────────────────────────────────────────────────────────────┐
│                      v0.15.6g Investigation                          │
├─────────────────────────────────────────────────────────────────────┤
│  IInvestigationService   Clue   Deduction   InvestigationResult     │
└───────────────────────────────┬─────────────────────────────────────┘
                                │
                    ┌───────────┴───────────┐
                    │     Depends On        │
                    ▼                       ▼
    ┌───────────────────────────┐   ┌───────────────────────────┐
    │  v0.15.6f Search          │   │  v0.15.1 Skill System     │
    │  ─────────────────────    │   │  ─────────────────────    │
    │  ISearchService           │   │  ISkillService            │
    │  (complementary system)   │   │  SkillContext             │
    └───────────────────────────┘   └───────────────────────────┘
                    │                       │
                    ▼                       ▼
    ┌───────────────────────────┐   ┌───────────────────────────┐
    │  v0.15.0 Dice Pool        │   │  v0.15.6e Puzzle Hints    │
    │  ─────────────────────    │   │  ─────────────────────    │
    │  IWitsCheckService        │   │  IPuzzleHintService       │
    │  Success-counting         │   │  (hint-linked clues)      │
    └───────────────────────────┘   └───────────────────────────┘
                    │
                    ▼
    ┌───────────────────────────────────────────────────────────────┐
    │  Core Services                                                │
    │  IRoomService  │  ITargetResolver  │  ITimeService            │
    └───────────────────────────────────────────────────────────────┘
```

---

## 12. Implementation Notes

### 12.1 Architecture Layers

```
┌─────────────────────────────────────────────────────────────────────┐
│                    Presentation Layer                                │
├─────────────────────────────────────────────────────────────────────┤
│  InvestigateCommand         InvestigationRenderer                   │
│  - Parses 'investigate'     - Formats investigation results        │
│  - Routes to subcommands    - Displays clues and deductions        │
│  - Returns CommandResult    - Renders target lists                  │
└─────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────┐
│                    Application Layer                                 │
├─────────────────────────────────────────────────────────────────────┤
│  IInvestigationService      IPlayerClueTracker                      │
│  - Orchestrates investigation - Tracks discovered clues             │
│  - Manages deduction logic    - Tracks made deductions              │
│  - Returns InvestigationResult                                      │
└─────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────┐
│                      Domain Layer                                    │
├─────────────────────────────────────────────────────────────────────┤
│  InvestigationContext       Clue                                    │
│  InvestigationResult        Deduction                               │
│  InvestigationTarget        ClueCategory                            │
└─────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────┐
│                   Infrastructure Layer                               │
├─────────────────────────────────────────────────────────────────────┤
│  ClueRepository             DeductionRepository                     │
│  InvestigationConfigLoader  PlayerClueTrackerPersistence           │
└─────────────────────────────────────────────────────────────────────┘
```

### 12.2 Implementation Order

1. **Domain Models** (~Day 1)
   - InvestigationTarget enum
   - Clue value object
   - Deduction value object
   - InvestigationContext value object
   - InvestigationResult value object
   - ClueCategory enum

2. **Configuration** (~Day 1)
   - IInvestigationConfiguration interface
   - investigation-config.json
   - clues.json data file
   - deductions.json data file

3. **Tracking Service** (~Day 1)
   - IPlayerClueTracker interface
   - PlayerClueTracker implementation

4. **Investigation Service** (~Day 2)
   - IInvestigationService interface
   - InvestigationService implementation
   - Clue discovery logic
   - Deduction matching logic
   - Time cost calculation

5. **Command and Rendering** (~Day 2)
   - InvestigateCommand implementation
   - IInvestigationRenderer interface
   - Result formatting

6. **Testing** (~Day 3)
   - InvestigationServiceTests
   - DeductionMatchingTests
   - Integration tests

### 12.3 Error Handling

```csharp
public sealed class InvestigationException : Exception
{
    public InvestigationErrorCode ErrorCode { get; }

    public InvestigationException(InvestigationErrorCode code, string message)
        : base(message)
    {
        ErrorCode = code;
    }
}

public enum InvestigationErrorCode
{
    TargetNotFound,
    TargetNotInvestigable,
    InvestigationInProgress,
    InsufficientClues,
    DeductionAlreadyMade
}
```

---

## 13. Design Decisions

### 13.1 Separate from Examination

**Decision:** Keep investigation as a distinct system from examination.

**Rationale:**
- Examination reveals object descriptions and properties
- Investigation focuses on clues and deductive reasoning
- Different skill requirements (WITS vs WITS + Investigation)
- Different outputs (layers vs clues/deductions)
- Supports different gameplay loops (exploration vs mystery-solving)

### 13.2 Clue-Deduction Model

**Decision:** Use explicit clue requirements for deductions rather than fuzzy matching.

**Rationale:**
- Deterministic gameplay—players know what they need
- Content designers have clear requirements to specify
- Avoids complex AI/NLP for natural language deductions
- Enables UI feedback about "clues needed" for partial progress
- Supports save/load without ambiguity

### 13.3 Auto-Deduction on Sufficient Clues

**Decision:** Automatically make deductions when all required clues are gathered.

**Rationale:**
- Rewards thorough investigation immediately
- Avoids frustrating "I have all the clues but nothing happens"
- Keeps investigation flow moving
- Configuration option allows disabling for more deliberate gameplay
- Players still see the deduction being made narratively

### 13.4 Expert Success Threshold

**Decision:** Set expert success at net >= 5 successes (matching v0.15.0 critical success).

**Rationale:**
- Consistency with dice system critical success threshold
- Meaningful reward for high WITS + Investigation investment
- Hidden connections provide valuable but non-essential information
- Creates aspirational goal for character builds

---

## 14. Future Considerations

### 14.1 Planned Enhancements (v0.15.6h+)

- **Specialization Bonuses:** Veiðimaðr gets bonus to creature remains investigation
- **Room Entry Hints:** Investigable targets highlighted on room entry

### 14.2 Post-v0.15.6 Potential Features

- **Investigation Journal:** Persistent log of all clues and deductions
- **Multi-Scene Investigations:** Tracking clues across multiple locations
- **Collaborative Investigation:** Party members sharing clues
- **Red Herring Clues:** False leads that misdirect players
- **Timed Evidence:** Clues that degrade or disappear over time
- **Forensic Alchemy:** Using alchemy on remains for additional clues
- **Witness Statements:** NPC dialogue as investigation source

---

## Appendix A: Investigation Examples

### A.1 Complete Investigation Flow

```
Player enters room with dead scavenger...

> investigate

─── Investigable Targets ───

[Remains]
• Fallen Scavenger - A body slumped against the wall

[Trail]
• Claw Marks - Deep gouges in the metal floor

───────────────────────────────

> investigate scavenger

[WITS + Investigation Check vs DC 12]
WITS Pool: 4d10  |  Investigation Rank: 1 (+1d10)
Rolling 5d10... 4, 8, 9, 10, 3
Successes: 3 (8, 9, 10)
Check Result: 3 successes — SUCCESS

[Investigating Fallen Scavenger... 10 minutes]

─── Clues Discovered ───

[Clue: Cause of Death] (DC 1)
The scavenger's wounds are consistent with Draugr claw marks...

[Clue: Time of Death] (DC 2)
Based on the condition, death occurred approximately 2-3 hours ago.

[Clue: Scavenger Identity] (DC 3)
A guild badge identifies the victim as "Bjorn" of the Rust-Picker guild.

Time elapsed: 10 minutes
Clues discovered: 3

───────────────────────────────

> investigate claw marks

[WITS + Investigation Check vs DC 10]
Rolling 5d10... 7, 8, 9, 2, 1
Successes: 2 (8, 9) | Botch: 1 | Net: 1
Check Result: 1 success — MARGINAL SUCCESS

[Investigating Claw Marks... 5 minutes]

─── Clues Discovered ───

[Clue: Creature Type] (DC 1)
The spacing and depth of the claw marks match a Lesser Draugr.

─── Deduction Made ───

[DEDUCTION: Draugr Attack]
Combining: Cause of Death + Creature Type

A Lesser Draugr killed Bjorn of the Rust-Picker guild within the
last few hours. The creature may still be lurking nearby.

[Alert: Draugr Presence Detected]

Time elapsed: 5 minutes
Clues discovered: 1 | Deductions made: 1
```

### A.2 Expert Success Example

```
> investigate crime scene

[WITS + Investigation Check vs DC 16]
Rolling 8d10... 6, 8, 8, 9, 9, 10, 10, 2
Successes: 6 — EXPERT SUCCESS!

─── Expert Analysis: Hidden Connections ───

Your keen analytical mind pieces together subtle details: The angle
of the wounds suggests a left-handed attacker. The boot prints are
distinctive—military-grade Dvergr manufacture. Combined with the
missing badge, this appears to be a targeted assassination by
someone with Forge-Guard connections.
```

---

## Appendix B: Clue and Deduction Reference

### B.1 Standard Clue Categories

| Category | Description | Example Clues |
|----------|-------------|---------------|
| Identity | Who was involved | Name, appearance, affiliation |
| Cause | What caused event | Weapon, explosion, poison |
| Method | How it was done | Technique, approach, tools |
| Motive | Why it happened | Revenge, theft, silencing |
| Location | Where it leads | Direction, destination |
| Time | When it occurred | Hour, day, sequence |
| Creature | Creature involvement | Species, behavior, tracks |
| Object | Artifacts involved | Items, equipment, evidence |
| History | Past context | Events, relationships |

### B.2 Standard Investigation DCs

| Clue Visibility | DC | Examples |
|-----------------|-----|----------|
| Obvious | 1-2 | Large bloodstains, obvious wounds |
| Standard | 3-4 | Footprints, tool marks |
| Hidden | 5-6 | Partial fingerprints, hidden compartments |
| Expert | 7-8 | Trace evidence, timeline reconstruction |
| Master | 9+ | Microscopic details, psychological profiling |

### B.3 Deduction Complexity

| Clues Required | Complexity | Insight Gained |
|----------------|------------|----------------|
| 2 | Simple | Basic connection (who did it) |
| 3 | Moderate | Method and motive |
| 4+ | Complex | Complete picture with hidden details |

---

*This design specification provides the detailed blueprint for implementing v0.15.6g Investigation Command. See the scope breakdown for integration context with other v0.15.6 sub-phases.*
