# v0.3.1 Quest Rewards & NPCs - Scope Breakdown

**Version:** 0.3.1
**Theme:** Quest Rewards & NPCs
**Prerequisites:** v0.3.0 Complete (Quest Foundation)
**Total Estimated Tests:** ~70 new tests

---

## Executive Summary

The Quest Rewards & NPCs version completes the core quest experience by adding meaningful rewards for quest completion and enhancing NPC integration as quest givers. Players receive XP, gold, items, and reputation when completing quests, and NPCs display visual indicators when they have available quests. Prerequisites ensure quests become available at appropriate times based on level, reputation, or prior quest completion.

Key focus areas:
- **Quest Rewards**: XP, gold, items, and reputation rewards
- **Quest Givers**: NPCs with quest availability indicators
- **Reward Distribution**: Automatic reward delivery on turn-in
- **Prerequisites**: Level, reputation, and quest requirements

The work is divided into **three sub-phases**:

| Phase | Name | Focus | Est. Tests |
|-------|------|-------|------------|
| v0.3.1a | Reward System | QuestReward, RewardType, reward configuration | ~25 |
| v0.3.1b | Quest Giver NPCs | NPC integration, indicators, dialogue enhancement | ~25 |
| v0.3.1c | Prerequisites & Distribution | Prerequisites, reward delivery, turn-in flow | ~20 |

---

## Existing Infrastructure

### Already Implemented (from v0.3.0)

| Feature | Location | Notes |
|---------|----------|-------|
| Quest entity | `Domain/Entities/Quest.cs` | Reward attachment point |
| QuestObjective entity | `Domain/Entities/QuestObjective.cs` | Completion tracking |
| QuestService | `Application/Services/QuestService.cs` | Quest management |
| QuestStatus enum | `Domain/Enums/QuestStatus.cs` | Completion detection |
| Player.ActiveQuests | `Domain/Entities/Player.cs` | Quest ownership |
| DialogueOutcome | `Domain/ValueObjects/DialogueOutcome.cs` | StartQuest type |
| NPC entity | `Domain/Entities/NPC.cs` | Quest giver base |
| FactionDefinition | `Domain/Definitions/FactionDefinition.cs` | Reputation rewards |
| ReputationService | `Application/Services/ReputationService.cs` | Rep modification |
| ExperienceService | `Domain/Services/ExperienceService.cs` | XP granting |
| Item entity | `Domain/Entities/Item.cs` | Item rewards |
| Player.Gold | `Domain/Entities/Player.cs` | Gold rewards |

### Needs Implementation (v0.3.1)

| Feature | Phase | Notes |
|---------|-------|-------|
| QuestReward value object | v0.3.1a | Reward bundles |
| RewardType enum | v0.3.1a | XP, Gold, Item, Reputation |
| QuestRewardService | v0.3.1a | Reward delivery |
| NPC.OfferedQuests | v0.3.1b | Quest giver tracking |
| QuestIndicator | v0.3.1b | Visual markers |
| QuestPrerequisite | v0.3.1c | Unlock conditions |
| PrerequisiteType enum | v0.3.1c | Level, Rep, Quest |

---

## Feature Analysis & Categorization

### Reward System Features

| Feature | Complexity | Dependencies | Assigned Phase |
|---------|------------|--------------|----------------|
| QuestReward value object | Medium | None | **v0.3.1a** |
| RewardType enum | Low | None | **v0.3.1a** |
| XP rewards | Medium | ExperienceService | **v0.3.1a** |
| Gold rewards | Low | Player.Gold | **v0.3.1a** |
| Item rewards | Medium | Item, Inventory | **v0.3.1a** |
| Reputation rewards | Medium | ReputationService | **v0.3.1a** |
| Reward configuration | Medium | QuestDefinition | **v0.3.1a** |

### Quest Giver Features

| Feature | Complexity | Dependencies | Assigned Phase |
|---------|------------|--------------|----------------|
| NPC.OfferedQuests | Medium | NPC, Quest | **v0.3.1b** |
| NPC.HasAvailableQuests | Low | NPC | **v0.3.1b** |
| Quest giver indicators | Medium | IGameRenderer | **v0.3.1b** |
| Indicator types (!, ?) | Low | None | **v0.3.1b** |
| Enhanced dialogue options | Medium | DialogueService | **v0.3.1b** |
| Quest list in talk command | Medium | NPC dialogue | **v0.3.1b** |

### Prerequisite Features

| Feature | Complexity | Dependencies | Assigned Phase |
|---------|------------|--------------|----------------|
| QuestPrerequisite value object | Medium | None | **v0.3.1c** |
| PrerequisiteType enum | Low | None | **v0.3.1c** |
| Level prerequisites | Low | Player.Level | **v0.3.1c** |
| Reputation prerequisites | Medium | Player.Reputation | **v0.3.1c** |
| Quest prerequisites | Medium | Player.CompletedQuests | **v0.3.1c** |
| QuestRewardService delivery | High | All reward types | **v0.3.1c** |
| Turn-in dialogue flow | Medium | DialogueService | **v0.3.1c** |

---

## Phase Definitions

---

## v0.3.1a: Reward System

### Overview

Implement the quest reward system including the QuestReward value object, reward types, and configuration. This phase establishes what players can earn from completing quests.

### Scope

**In Scope:**
- `QuestReward` value object for reward bundles
- `RewardType` enum (XP, Gold, Item, Reputation)
- `RewardEntry` value object for individual rewards
- XP reward integration with ExperienceService
- Gold reward integration with Player.Gold
- Item reward configuration
- Reputation reward configuration
- Update QuestDefinition with rewards
- Reward display in quest journal

**Out of Scope:**
- Quest giver NPCs (v0.3.1b)
- Visual indicators (v0.3.1b)
- Prerequisites (v0.3.1c)
- Reward delivery service (v0.3.1c)

### Key Deliverables

| Type | Count | Details |
|------|-------|---------|
| Value Objects | 2 | `QuestReward`, `RewardEntry` |
| Enums | 1 | `RewardType` |
| Definition Updates | 1 | Add rewards to `QuestDefinition` |
| Journal Updates | 1 | Show rewards in quest detail |
| Configuration | 1 | Update `quests.json` with rewards |
| Unit Tests | ~25 | Reward value object, configuration tests |

### QuestReward Value Object

```csharp
namespace RuneAndRust.Domain.ValueObjects;

/// <summary>
/// Represents rewards granted upon quest completion.
/// </summary>
public class QuestReward
{
    /// <summary>
    /// Gets the individual reward entries.
    /// </summary>
    public IReadOnlyList<RewardEntry> Entries { get; private set; } = Array.Empty<RewardEntry>();

    /// <summary>
    /// Gets the total XP reward.
    /// </summary>
    public int TotalXP => Entries
        .Where(e => e.Type == RewardType.XP)
        .Sum(e => e.Amount);

    /// <summary>
    /// Gets the total gold reward.
    /// </summary>
    public int TotalGold => Entries
        .Where(e => e.Type == RewardType.Gold)
        .Sum(e => e.Amount);

    /// <summary>
    /// Gets item rewards.
    /// </summary>
    public IEnumerable<RewardEntry> ItemRewards => Entries
        .Where(e => e.Type == RewardType.Item);

    /// <summary>
    /// Gets reputation rewards.
    /// </summary>
    public IEnumerable<RewardEntry> ReputationRewards => Entries
        .Where(e => e.Type == RewardType.Reputation);

    /// <summary>
    /// Gets whether there are any rewards.
    /// </summary>
    public bool HasRewards => Entries.Count > 0;

    private QuestReward() { }

    /// <summary>
    /// Creates an empty reward.
    /// </summary>
    public static QuestReward Empty => new() { Entries = Array.Empty<RewardEntry>() };

    /// <summary>
    /// Creates a quest reward from entries.
    /// </summary>
    public static QuestReward Create(IEnumerable<RewardEntry> entries)
    {
        return new QuestReward
        {
            Entries = entries.ToList()
        };
    }

    /// <summary>
    /// Creates a simple XP and gold reward.
    /// </summary>
    public static QuestReward Simple(int xp, int gold)
    {
        var entries = new List<RewardEntry>();

        if (xp > 0)
            entries.Add(RewardEntry.XP(xp));
        if (gold > 0)
            entries.Add(RewardEntry.Gold(gold));

        return new QuestReward { Entries = entries };
    }

    /// <summary>
    /// Adds an entry to this reward.
    /// </summary>
    public QuestReward WithEntry(RewardEntry entry)
    {
        var entries = Entries.ToList();
        entries.Add(entry);
        return new QuestReward { Entries = entries };
    }

    /// <summary>
    /// Gets a formatted display string.
    /// </summary>
    public string GetDisplayString()
    {
        var parts = new List<string>();

        if (TotalXP > 0)
            parts.Add($"{TotalXP} XP");
        if (TotalGold > 0)
            parts.Add($"{TotalGold} gold");

        foreach (var item in ItemRewards)
            parts.Add(item.DisplayName ?? item.TargetId);

        foreach (var rep in ReputationRewards)
        {
            var sign = rep.Amount >= 0 ? "+" : "";
            parts.Add($"{sign}{rep.Amount} {rep.DisplayName ?? rep.TargetId} reputation");
        }

        return parts.Count > 0 ? string.Join(", ", parts) : "None";
    }
}
```

### RewardEntry Value Object

```csharp
namespace RuneAndRust.Domain.ValueObjects;

/// <summary>
/// A single reward entry within a quest reward.
/// </summary>
public readonly record struct RewardEntry
{
    /// <summary>
    /// Gets the reward type.
    /// </summary>
    public RewardType Type { get; init; }

    /// <summary>
    /// Gets the amount (for XP, gold, or quantity).
    /// </summary>
    public int Amount { get; init; }

    /// <summary>
    /// Gets the target ID (item ID, faction ID, etc.).
    /// </summary>
    public string TargetId { get; init; }

    /// <summary>
    /// Gets the display name for this reward.
    /// </summary>
    public string? DisplayName { get; init; }

    /// <summary>
    /// Gets whether this is a choice reward (player picks one).
    /// </summary>
    public bool IsChoice { get; init; }

    /// <summary>
    /// Gets the choice group ID for choice rewards.
    /// </summary>
    public string? ChoiceGroup { get; init; }

    /// <summary>
    /// Creates an XP reward.
    /// </summary>
    public static RewardEntry XP(int amount) => new()
    {
        Type = RewardType.XP,
        Amount = amount,
        TargetId = string.Empty
    };

    /// <summary>
    /// Creates a gold reward.
    /// </summary>
    public static RewardEntry Gold(int amount) => new()
    {
        Type = RewardType.Gold,
        Amount = amount,
        TargetId = string.Empty
    };

    /// <summary>
    /// Creates an item reward.
    /// </summary>
    public static RewardEntry Item(string itemId, int quantity = 1, string? displayName = null) => new()
    {
        Type = RewardType.Item,
        Amount = quantity,
        TargetId = itemId,
        DisplayName = displayName
    };

    /// <summary>
    /// Creates a reputation reward.
    /// </summary>
    public static RewardEntry Reputation(string factionId, int amount, string? displayName = null) => new()
    {
        Type = RewardType.Reputation,
        Amount = amount,
        TargetId = factionId,
        DisplayName = displayName
    };

    /// <summary>
    /// Creates a choice item reward.
    /// </summary>
    public static RewardEntry ChoiceItem(string itemId, string choiceGroup, string? displayName = null) => new()
    {
        Type = RewardType.Item,
        Amount = 1,
        TargetId = itemId,
        DisplayName = displayName,
        IsChoice = true,
        ChoiceGroup = choiceGroup
    };
}
```

### RewardType Enum

```csharp
namespace RuneAndRust.Domain.Enums;

/// <summary>
/// Types of quest rewards.
/// </summary>
public enum RewardType
{
    /// <summary>Experience points.</summary>
    XP,

    /// <summary>Gold currency.</summary>
    Gold,

    /// <summary>An item or items.</summary>
    Item,

    /// <summary>Faction reputation change.</summary>
    Reputation,

    /// <summary>Unlocks something (ability, area, etc.).</summary>
    Unlock
}
```

### QuestDefinition Update

```
MODIFY: QuestDefinition
├── ADD: Rewards: QuestReward
└── ADD: BonusRewards: QuestReward? (for optional objectives)
```

### Quest Journal Update

```
┌─────────────────────────────────────────────────────────────┐
│                    THE GOBLIN MENACE                        │
├─────────────────────────────────────────────────────────────┤
│  Status: Active                      Progress: 60%          │
│  Given by: Guard Captain                                    │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  The dungeon entrance is overrun with goblins. Clear them   │
│  out to make the area safe for other adventurers.           │
│                                                             │
├─────────────────────────────────────────────────────────────┤
│  OBJECTIVES                                                 │
│  • Defeat goblins                                  (3/5)    │
│                                                             │
├─────────────────────────────────────────────────────────────┤
│  REWARDS                                                    │
│  • 50 XP                                                    │
│  • 25 gold                                                  │
│  • +100 Guard reputation                                    │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### Configuration Example

```json
{
  "quests": [
    {
      "id": "goblin-menace",
      "name": "The Goblin Menace",
      "description": "Clear out the goblin infestation.",
      "objectives": [
        {
          "type": "Kill",
          "description": "Defeat goblins",
          "target": { "targetType": "goblin", "anyOfType": true },
          "requiredCount": 5
        }
      ],
      "rewards": {
        "entries": [
          { "type": "XP", "amount": 50 },
          { "type": "Gold", "amount": 25 },
          { "type": "Reputation", "targetId": "city-guard", "amount": 100, "displayName": "City Guard" }
        ]
      }
    },
    {
      "id": "lost-heirloom",
      "name": "The Lost Heirloom",
      "description": "Find and return the merchant's family heirloom.",
      "objectives": [
        { "type": "Collect", "description": "Find the Golden Locket", "target": { "targetId": "item-golden-locket" } },
        { "type": "Talk", "description": "Return to Grimbold", "target": { "targetId": "grimbold-trader" } }
      ],
      "rewards": {
        "entries": [
          { "type": "XP", "amount": 75 },
          { "type": "Gold", "amount": 50 },
          { "type": "Item", "targetId": "ring-of-protection", "displayName": "Ring of Protection" },
          { "type": "Reputation", "targetId": "merchant-guild", "amount": 150, "displayName": "Merchant Guild" }
        ]
      }
    },
    {
      "id": "dangerous-errand",
      "name": "A Dangerous Errand",
      "description": "Retrieve supplies from the abandoned outpost.",
      "rewards": {
        "entries": [
          { "type": "XP", "amount": 100 },
          { "type": "Gold", "amount": 30 },
          { "type": "Item", "targetId": "iron-sword", "displayName": "Iron Sword", "isChoice": true, "choiceGroup": "weapon" },
          { "type": "Item", "targetId": "iron-axe", "displayName": "Iron Axe", "isChoice": true, "choiceGroup": "weapon" },
          { "type": "Item", "targetId": "iron-mace", "displayName": "Iron Mace", "isChoice": true, "choiceGroup": "weapon" }
        ]
      }
    }
  ]
}
```

### Acceptance Criteria

- [ ] QuestReward can hold multiple reward entries
- [ ] RewardType covers XP, Gold, Item, Reputation
- [ ] XP rewards calculate totals correctly
- [ ] Gold rewards calculate totals correctly
- [ ] Item rewards support quantity
- [ ] Reputation rewards support positive/negative
- [ ] Choice rewards grouped by choiceGroup
- [ ] Quest journal displays rewards
- [ ] Reward display formatting works
- [ ] ~25 unit tests pass

---

## v0.3.1b: Quest Giver NPCs

### Overview

Enhance NPCs with quest giver capabilities including tracking offered quests, visual indicators for quest availability, and improved dialogue integration for quest management.

### Scope

**In Scope:**
- `NPC.OfferedQuests` collection
- `NPC.HasAvailableQuests` property
- `QuestIndicator` enum (None, Available, InProgress, Complete)
- Visual indicators in room descriptions
- Quest list in NPC dialogue
- Accept quest through dialogue
- Turn-in quest through dialogue
- Multiple quests per NPC

**Out of Scope:**
- Prerequisites (v0.3.1c)
- Reward delivery (v0.3.1c)
- Quest chains (v0.3.2)

### Key Deliverables

| Type | Count | Details |
|------|-------|---------|
| Enums | 1 | `QuestIndicator` |
| NPC Updates | 3 | OfferedQuests, HasAvailableQuests, GetIndicator |
| Dialogue Updates | 1 | Quest-aware dialogue options |
| Room Display | 1 | NPC indicators in descriptions |
| Unit Tests | ~25 | NPC quest tracking, indicator tests |

### QuestIndicator Enum

```csharp
namespace RuneAndRust.Domain.Enums;

/// <summary>
/// Visual indicator for NPC quest status.
/// </summary>
public enum QuestIndicator
{
    /// <summary>No quest-related indicator.</summary>
    None,

    /// <summary>NPC has a new quest available (!).</summary>
    Available,

    /// <summary>NPC has a quest in progress (?).</summary>
    InProgress,

    /// <summary>NPC has a quest ready to turn in (?).</summary>
    ReadyToTurnIn,

    /// <summary>NPC has a repeatable quest available.</summary>
    Repeatable
}
```

### NPC Modifications

```csharp
// Add to NPC entity

/// <summary>
/// Gets the quest definition IDs this NPC offers.
/// </summary>
public IReadOnlyList<string> OfferedQuestIds { get; private set; } = Array.Empty<string>();

/// <summary>
/// Gets whether this NPC has quests to offer.
/// </summary>
public bool IsQuestGiver => OfferedQuestIds.Count > 0;

/// <summary>
/// Gets the quest indicator for display.
/// </summary>
public QuestIndicator GetQuestIndicator(Player player, IQuestService questService)
{
    // Check for ready to turn in first (highest priority)
    foreach (var questId in OfferedQuestIds)
    {
        var quest = questService.GetQuestByDefinition(player.Id, questId);
        if (quest != null && quest.CanTurnIn() && quest.TurnInNpcId == DefinitionId)
            return QuestIndicator.ReadyToTurnIn;
    }

    // Check for in-progress quests
    foreach (var questId in OfferedQuestIds)
    {
        var quest = questService.GetQuestByDefinition(player.Id, questId);
        if (quest != null && quest.Status == QuestStatus.Active)
            return QuestIndicator.InProgress;
    }

    // Check for available quests
    foreach (var questId in OfferedQuestIds)
    {
        if (!questService.HasActiveQuest(player.Id, questId) &&
            !player.HasCompletedQuest(questId))
            return QuestIndicator.Available;
    }

    return QuestIndicator.None;
}

/// <summary>
/// Gets available quests for a player.
/// </summary>
public IEnumerable<string> GetAvailableQuests(Player player, IQuestService questService)
{
    return OfferedQuestIds.Where(id =>
        !questService.HasActiveQuest(player.Id, id) &&
        !player.HasCompletedQuest(id));
}

/// <summary>
/// Gets quests ready for turn-in.
/// </summary>
public IEnumerable<Quest> GetTurnInQuests(Player player, IQuestService questService)
{
    return OfferedQuestIds
        .Select(id => questService.GetQuestByDefinition(player.Id, id))
        .Where(q => q != null && q.CanTurnIn() && q.TurnInNpcId == DefinitionId)!;
}
```

### Room Description Update

```csharp
// In room description generation

public string GetNPCListWithIndicators(Player player, IQuestService questService)
{
    var lines = new List<string>();

    foreach (var npc in NPCs.Where(n => n.IsAvailable))
    {
        var indicator = npc.GetQuestIndicator(player, questService);
        var indicatorStr = indicator switch
        {
            QuestIndicator.Available => " [!]",
            QuestIndicator.ReadyToTurnIn => " [?]",
            QuestIndicator.InProgress => " [...]",
            _ => ""
        };

        lines.Add($"  {npc.Name}{indicatorStr}");
    }

    return string.Join("\n", lines);
}
```

### User-Facing Changes

**Room Description:**
```
You are in the Guard Barracks. Soldiers practice their drills
while officers review reports at wooden desks.

You see:
  Guard Captain [!]
  Quartermaster [?]
  Recruit Tam

Exits: north, east
```

**Dialogue with Quest Giver:**
```
> talk captain
The Guard Captain looks up from his maps. "Adventurer! We could
use someone with your skills."

[QUESTS AVAILABLE]
  [!] The Goblin Menace (New)
  [!] Patrol the Eastern Tunnels (New)

[1] Tell me about the goblin problem.
[2] What's happening in the Eastern Tunnels?
[3] [Accept: The Goblin Menace]
[4] [Accept: Patrol the Eastern Tunnels]
[5] Just checking in.

---

> talk grimbold
Grimbold nods as you approach. "Ah, you found my locket!
You have my eternal gratitude."

[QUEST READY TO TURN IN]
  [?] The Lost Heirloom

[1] [Turn In: The Lost Heirloom]
[2] I'll hold onto it a bit longer.
```

### Configuration Example

```json
{
  "npcs": [
    {
      "id": "guard-captain",
      "name": "Guard Captain",
      "type": "QuestGiver",
      "offeredQuestIds": [
        "goblin-menace",
        "patrol-eastern-tunnels",
        "eliminate-goblin-chief"
      ],
      "greeting": "Adventurer! We could use someone with your skills."
    },
    {
      "id": "grimbold-trader",
      "name": "Grimbold the Trader",
      "type": "Merchant",
      "offeredQuestIds": [
        "lost-heirloom",
        "rare-ingredients"
      ],
      "greeting": "Welcome to my shop!"
    }
  ]
}
```

### Acceptance Criteria

- [ ] NPC.OfferedQuestIds tracks quest definitions
- [ ] NPC.IsQuestGiver returns true when has quests
- [ ] QuestIndicator shows correct state
- [ ] Available indicator [!] shows for new quests
- [ ] Turn-in indicator [?] shows for completable quests
- [ ] Room descriptions show indicators
- [ ] Dialogue lists available quests
- [ ] Dialogue shows turn-in option when ready
- [ ] Multiple quests per NPC work correctly
- [ ] ~25 unit tests pass

---

## v0.3.1c: Prerequisites & Distribution

### Overview

Implement quest prerequisites that control when quests become available and the reward distribution service that delivers rewards when quests are turned in.

### Scope

**In Scope:**
- `QuestPrerequisite` value object
- `PrerequisiteType` enum (Level, Reputation, Quest, Item)
- Prerequisite evaluation
- `QuestRewardService` for reward delivery
- XP delivery via ExperienceService
- Gold delivery via Player.AddGold
- Item delivery via Inventory
- Reputation delivery via ReputationService
- Turn-in dialogue completion flow
- Reward notification display

**Out of Scope:**
- Quest chains (v0.3.2)
- Time-limited quests (v0.3.2)
- Failure conditions (v0.3.2)

### Key Deliverables

| Type | Count | Details |
|------|-------|---------|
| Value Objects | 1 | `QuestPrerequisite` |
| Enums | 1 | `PrerequisiteType` |
| Services | 1 | `QuestRewardService` |
| Definition Updates | 1 | Add prerequisites to QuestDefinition |
| Turn-in Flow | 1 | Complete reward delivery |
| Unit Tests | ~20 | Prerequisite, delivery tests |

### QuestPrerequisite Value Object

```csharp
namespace RuneAndRust.Domain.ValueObjects;

/// <summary>
/// Represents a requirement for a quest to be available.
/// </summary>
public readonly record struct QuestPrerequisite
{
    /// <summary>
    /// Gets the prerequisite type.
    /// </summary>
    public PrerequisiteType Type { get; init; }

    /// <summary>
    /// Gets the target ID (quest ID, faction ID, item ID).
    /// </summary>
    public string TargetId { get; init; }

    /// <summary>
    /// Gets the required value (level, reputation amount, quantity).
    /// </summary>
    public int RequiredValue { get; init; }

    /// <summary>
    /// Gets whether this prerequisite is negated (must NOT have).
    /// </summary>
    public bool IsNegated { get; init; }

    /// <summary>
    /// Gets a description for display.
    /// </summary>
    public string? Description { get; init; }

    /// <summary>
    /// Creates a level prerequisite.
    /// </summary>
    public static QuestPrerequisite Level(int minLevel) => new()
    {
        Type = PrerequisiteType.Level,
        TargetId = string.Empty,
        RequiredValue = minLevel,
        Description = $"Requires level {minLevel}"
    };

    /// <summary>
    /// Creates a reputation prerequisite.
    /// </summary>
    public static QuestPrerequisite Reputation(string factionId, int minReputation, string? factionName = null) => new()
    {
        Type = PrerequisiteType.Reputation,
        TargetId = factionId,
        RequiredValue = minReputation,
        Description = $"Requires {factionName ?? factionId} reputation {minReputation}+"
    };

    /// <summary>
    /// Creates a quest completion prerequisite.
    /// </summary>
    public static QuestPrerequisite QuestComplete(string questId, string? questName = null) => new()
    {
        Type = PrerequisiteType.Quest,
        TargetId = questId,
        RequiredValue = 1,
        Description = $"Requires completion of \"{questName ?? questId}\""
    };

    /// <summary>
    /// Creates an item prerequisite.
    /// </summary>
    public static QuestPrerequisite HasItem(string itemId, int quantity = 1) => new()
    {
        Type = PrerequisiteType.Item,
        TargetId = itemId,
        RequiredValue = quantity
    };

    /// <summary>
    /// Evaluates this prerequisite against a player.
    /// </summary>
    public bool Evaluate(Player player)
    {
        var result = Type switch
        {
            PrerequisiteType.Level => player.Level >= RequiredValue,
            PrerequisiteType.Reputation => player.GetReputation(TargetId) >= RequiredValue,
            PrerequisiteType.Quest => player.HasCompletedQuest(TargetId),
            PrerequisiteType.Item => player.Inventory.HasItem(TargetId, RequiredValue),
            _ => false
        };

        return IsNegated ? !result : result;
    }
}
```

### PrerequisiteType Enum

```csharp
namespace RuneAndRust.Domain.Enums;

/// <summary>
/// Types of quest prerequisites.
/// </summary>
public enum PrerequisiteType
{
    /// <summary>Player must be at least a certain level.</summary>
    Level,

    /// <summary>Player must have minimum reputation with faction.</summary>
    Reputation,

    /// <summary>Player must have completed a specific quest.</summary>
    Quest,

    /// <summary>Player must have a specific item.</summary>
    Item,

    /// <summary>Player must have a specific class/archetype.</summary>
    Class,

    /// <summary>Player must have a specific skill level.</summary>
    Skill
}
```

### QuestRewardService Interface

```csharp
namespace RuneAndRust.Application.Services;

/// <summary>
/// Handles quest reward distribution.
/// </summary>
public interface IQuestRewardService
{
    /// <summary>
    /// Distributes rewards for completing a quest.
    /// </summary>
    RewardDistributionResult DistributeRewards(Player player, Quest quest);

    /// <summary>
    /// Distributes rewards with choice selection.
    /// </summary>
    RewardDistributionResult DistributeRewards(
        Player player,
        Quest quest,
        Dictionary<string, string>? choiceSelections);

    /// <summary>
    /// Gets pending choice rewards for a quest.
    /// </summary>
    IEnumerable<RewardChoiceGroup> GetPendingChoices(Quest quest);

    /// <summary>
    /// Validates that a player can receive rewards.
    /// </summary>
    bool CanReceiveRewards(Player player, Quest quest);
}

/// <summary>
/// Result of reward distribution.
/// </summary>
public readonly record struct RewardDistributionResult
{
    public bool Success { get; init; }
    public int XPGranted { get; init; }
    public int GoldGranted { get; init; }
    public IReadOnlyList<Item> ItemsGranted { get; init; }
    public IReadOnlyDictionary<string, int> ReputationChanges { get; init; }
    public string? ErrorMessage { get; init; }

    public static RewardDistributionResult Succeeded(
        int xp, int gold,
        IEnumerable<Item> items,
        IDictionary<string, int> reputation)
    {
        return new RewardDistributionResult
        {
            Success = true,
            XPGranted = xp,
            GoldGranted = gold,
            ItemsGranted = items.ToList(),
            ReputationChanges = new Dictionary<string, int>(reputation)
        };
    }

    public static RewardDistributionResult Failed(string message)
    {
        return new RewardDistributionResult
        {
            Success = false,
            ErrorMessage = message,
            ItemsGranted = Array.Empty<Item>(),
            ReputationChanges = new Dictionary<string, int>()
        };
    }
}

/// <summary>
/// A group of choice rewards.
/// </summary>
public readonly record struct RewardChoiceGroup
{
    public string GroupId { get; init; }
    public IReadOnlyList<RewardEntry> Choices { get; init; }
}
```

### QuestDefinition Update

```
MODIFY: QuestDefinition
├── ADD: Prerequisites: IReadOnlyList<QuestPrerequisite>
└── ADD: GetUnmetPrerequisites(Player): IEnumerable<QuestPrerequisite>
```

### Turn-In Flow

```csharp
// In dialogue processing for turn-in

public async Task<TurnInResult> ProcessQuestTurnIn(
    Player player,
    Quest quest,
    Dictionary<string, string>? choices = null)
{
    // Verify quest is completable
    if (!quest.CanTurnIn())
        return TurnInResult.Failed("Quest objectives not complete.");

    // Check for pending choices
    var pendingChoices = _rewardService.GetPendingChoices(quest);
    if (pendingChoices.Any() && choices == null)
        return TurnInResult.RequiresChoice(pendingChoices);

    // Distribute rewards
    var rewardResult = _rewardService.DistributeRewards(player, quest, choices);
    if (!rewardResult.Success)
        return TurnInResult.Failed(rewardResult.ErrorMessage!);

    // Complete the quest
    quest.Complete();
    player.MoveToCompleted(quest);

    return TurnInResult.Succeeded(rewardResult);
}
```

### User-Facing Changes

**Quest with Prerequisites:**
```
> talk captain
The Guard Captain looks up from his maps.

[QUESTS AVAILABLE]
  [!] The Goblin Menace (New)
  [LOCKED] Eliminate the Goblin Chief
      Requires: Complete "The Goblin Menace"
      Requires: Level 5

[1] Tell me about the goblin problem.
[2] [Accept: The Goblin Menace]
[3] Just checking in.
```

**Turn-In with Rewards:**
```
> talk captain
The Guard Captain smiles. "Outstanding work! Those goblins won't
be troubling travelers anymore."

[1] [Turn In: The Goblin Menace]
[2] I'll keep patrolling.

> 1

=== QUEST COMPLETE ===
The Goblin Menace

REWARDS RECEIVED:
  + 50 XP
  + 25 gold
  + 100 City Guard reputation

The Guard Captain hands you a pouch of coins.
"The city thanks you, adventurer. Come back if you're looking
for more work."

---

> talk weaponsmith
The Weaponsmith nods approvingly. "You've proven yourself.
As promised, pick your reward."

[QUEST COMPLETE: A Dangerous Errand]
Choose your reward:
  [1] Iron Sword
  [2] Iron Axe
  [3] Iron Mace

> 2

You receive: Iron Axe
+ 100 XP
+ 30 gold
```

### Configuration Example

```json
{
  "quests": [
    {
      "id": "eliminate-goblin-chief",
      "name": "Eliminate the Goblin Chief",
      "description": "The goblin chief must be stopped before he rallies more forces.",
      "prerequisites": [
        { "type": "Quest", "targetId": "goblin-menace", "description": "Complete \"The Goblin Menace\"" },
        { "type": "Level", "requiredValue": 5 }
      ],
      "objectives": [
        { "type": "Kill", "description": "Defeat the Goblin Chief", "target": { "targetId": "monster-goblin-chief" } }
      ],
      "rewards": {
        "entries": [
          { "type": "XP", "amount": 150 },
          { "type": "Gold", "amount": 75 },
          { "type": "Item", "targetId": "goblin-chief-crown", "displayName": "Goblin Chief's Crown" },
          { "type": "Reputation", "targetId": "city-guard", "amount": 250 }
        ]
      }
    }
  ]
}
```

### Acceptance Criteria

- [ ] QuestPrerequisite evaluates correctly
- [ ] Level prerequisites check player level
- [ ] Reputation prerequisites check faction standing
- [ ] Quest prerequisites check completion status
- [ ] Locked quests show requirements
- [ ] QuestRewardService distributes XP
- [ ] QuestRewardService distributes gold
- [ ] QuestRewardService grants items
- [ ] QuestRewardService modifies reputation
- [ ] Choice rewards prompt player selection
- [ ] Turn-in dialogue shows rewards received
- [ ] ~20 unit tests pass

---

## Dependencies & Prerequisites

```
v0.3.0 (Quest Foundation) - REQUIRED
    │
    ├── Quest entity ────────────────────┐
    ├── QuestObjective entity ───────────┤
    ├── QuestService ────────────────────┤
    └── QuestProgressService ────────────┘
                                         │
                                         ▼
v0.3.1 (Quest Rewards & NPCs)
    │
    ├── v0.3.1a: Reward System ──────────────────────┐
    │       Dependencies: ExperienceService, Player   │
    │                                                 │
    ├── v0.3.1b: Quest Giver NPCs ───────────────────┤
    │       Dependencies: v0.3.1a, NPC entity         │
    │                     DialogueService             │
    │                                                 │
    └── v0.3.1c: Prerequisites & Distribution ───────┘
            Dependencies: v0.3.1a, v0.3.1b
                          ReputationService
                          Inventory system
```

---

## Estimated Effort Summary

| Phase | New Files | Modified Files | Est. Tests | Complexity |
|-------|-----------|----------------|------------|------------|
| v0.3.1a | ~5 | ~3 | ~25 | Medium |
| v0.3.1b | ~3 | ~4 | ~25 | Medium |
| v0.3.1c | ~4 | ~4 | ~20 | High |
| **Total** | **~12** | **~11** | **~70** | |

---

## Risk Assessment

| Risk | Impact | Probability | Mitigation |
|------|--------|-------------|------------|
| Inventory full when granting items | Medium | Medium | Check space, offer alternatives |
| Reward balance issues | Medium | Medium | Configuration-driven, easy to tune |
| Prerequisite evaluation complexity | Medium | Low | Clear evaluation order |
| Choice reward UI complexity | Medium | Low | Simple numbered selection |
| Dialogue integration issues | Medium | Low | Reuse existing dialogue patterns |

---

## Design Decisions (Confirmed)

### Reward Architecture

| Decision | Value | Notes |
|----------|-------|-------|
| **Reward Storage** | Value object on Quest | Rewards defined per quest |
| **Multiple Rewards** | List of RewardEntry | Flexible reward composition |
| **Choice Rewards** | Grouped by choiceGroup | Player picks one from group |

### Prerequisite System

| Decision | Value | Notes |
|----------|-------|-------|
| **Prerequisite Evaluation** | All must pass | AND logic by default |
| **Display Locked** | Show requirements | Player knows what's needed |
| **Negation Support** | IsNegated flag | "Must NOT have" conditions |

### Distribution

| Decision | Value | Notes |
|----------|-------|-------|
| **Distribution Timing** | On turn-in | Not automatic on completion |
| **Partial Failure** | Rollback all | Atomic reward delivery |
| **Overflow Handling** | Configurable | Drop, mail, or store |

---

## Integration Points

### From v0.3.0
- Quest entity for reward attachment
- QuestService for completion detection
- Quest turn-in flow

### To v0.3.2 (Quest Chains)
- Prerequisites system ready for chain unlocks
- Reward system ready for chain bonuses
- NPC quest offerings ready for chain progression

### To v0.4.0 (Puzzles)
- Quests can have puzzle objectives
- Rewards can include puzzle-related items

---

## Next Steps

1. **Review & Approve** - Confirm scope breakdown
2. **v0.3.1a Design Spec** - Create detailed design specification
3. **Implement v0.3.1a** - Build reward system
4. **v0.3.1b Design Spec** - Quest giver details
5. **Implement v0.3.1b** - Build NPC integration
6. **Implement v0.3.1c** - Build prerequisites and distribution

---

*This scope breakdown provides a structured approach to implementing v0.3.1 Quest Rewards & NPCs. Each sub-phase builds on the previous, allowing for incremental development and testing while completing the core quest experience.*
