# v0.17.5a Design Specification: Creation Step Enum & State

**Version:** 0.17.5a
**Theme:** Creation Step Enum & State
**Author:** Claude
**Created:** 2026-01-28
**Status:** Draft
**Prerequisites:** v0.17.4 Complete (Specialization System)

---

## Table of Contents

1. [Overview](#1-overview)
2. [Dependencies](#2-dependencies)
3. [Architecture Diagrams](#3-architecture-diagrams)
4. [CharacterCreationStep Enum](#4-charactercreationstep-enum)
5. [CharacterCreationState Entity](#5-charactercreationstate-entity)
6. [Configuration](#6-configuration)
7. [Commands](#7-commands)
8. [User-Facing Changes](#8-user-facing-changes)
9. [Logging Specifications](#9-logging-specifications)
10. [Unit Testing Requirements](#10-unit-testing-requirements)
11. [Use Cases](#11-use-cases)
12. [Deliverable Checklist](#12-deliverable-checklist)
13. [Acceptance Criteria](#13-acceptance-criteria)
14. [Future Considerations](#14-future-considerations)
15. [Implementation Notes](#15-implementation-notes)
16. [Document Metadata](#16-document-metadata)

---

## 1. Overview

### 1.1 Purpose

This document provides a comprehensive design specification for v0.17.5a, the Creation Step Enum & State phase. This phase establishes the foundational enumeration and state management infrastructure for the Character Creation Workflow.

Key components:

1. **CharacterCreationStep Enum**: Defines the six sequential steps in the character creation wizard, enabling type-safe step identification and navigation control.

2. **CharacterCreationState Entity**: Maintains all player selections throughout the creation process, supporting forward/backward navigation while preserving choices.

3. **Step Configuration**: Externalized workflow configuration defining step order, navigation rules, and permanent choice markers.

This infrastructure is foundational for all subsequent Character Creation components (v0.17.5b-v0.17.5g).

### 1.2 Current vs. Target Implementation

| Aspect                    | Current Implementation | Target Implementation                          |
| ------------------------- | ---------------------- | ---------------------------------------------- |
| **Step Identification**   | Not implemented        | `CharacterCreationStep` enum with 6 values     |
| **State Management**      | Not implemented        | `CharacterCreationState` entity                |
| **Navigation Control**    | Not implemented        | Configurable step flow with back/forward       |
| **Selection Persistence** | Not implemented        | All choices stored in state until confirmation |

### 1.3 Scope

**In Scope:**

- Define `CharacterCreationStep` enum with 6 values
- Define `CharacterCreationState` entity with properties for all step selections
- Create `creation-workflow.json` configuration file
- Unit tests for enum values and state management (~3 tests)

**Out of Scope:**

- Creation ViewModel - v0.17.5b
- Name validation - v0.17.5c
- Creation controller - v0.17.5d
- Character factory - v0.17.5e
- TUI screens - v0.17.5f
- Database persistence - v0.17.5g

### 1.4 Key Deliverables

| Type          | Count | Details                                  |
| ------------- | ----- | ---------------------------------------- |
| Enums         | 1     | `CharacterCreationStep`                  |
| Entities      | 1     | `CharacterCreationState`                 |
| Configuration | 1     | `creation-workflow.json`                 |
| Unit Tests    | ~3    | Enum count, state management, navigation |

---

## 2. Dependencies

### 2.1 Required from v0.17.0 (Lineage System)

| Component       | Location                        | Usage in v0.17.5a                |
| --------------- | ------------------------------- | -------------------------------- |
| `Lineage`       | `Domain/Enums/Lineage.cs`       | Step 1 selection storage         |
| `CoreAttribute` | `Domain/Enums/CoreAttribute.cs` | Clan-Born flexible bonus storage |

### 2.2 Required from v0.17.1 (Background System)

| Component    | Location                     | Usage in v0.17.5a        |
| ------------ | ---------------------------- | ------------------------ |
| `Background` | `Domain/Enums/Background.cs` | Step 2 selection storage |

### 2.3 Required from v0.17.2 (Attribute System)

| Component                  | Location                                          | Usage in v0.17.5a         |
| -------------------------- | ------------------------------------------------- | ------------------------- |
| `AttributeAllocationMode`  | `Domain/Enums/AttributeAllocationMode.cs`         | Step 3 mode selection     |
| `AttributeAllocationState` | `Domain/ValueObjects/AttributeAllocationState.cs` | Step 3 allocation storage |

### 2.4 Required from v0.17.3 (Archetype System)

| Component   | Location                    | Usage in v0.17.5a        |
| ----------- | --------------------------- | ------------------------ |
| `Archetype` | `Domain/Enums/Archetype.cs` | Step 4 selection storage |

### 2.5 Required from v0.17.4 (Specialization System)

| Component          | Location                           | Usage in v0.17.5a        |
| ------------------ | ---------------------------------- | ------------------------ |
| `SpecializationId` | `Domain/Enums/SpecializationId.cs` | Step 5 selection storage |

### 2.6 Provides to Future Versions

| Version  | Component                | Usage                                |
| -------- | ------------------------ | ------------------------------------ |
| v0.17.5b | `CharacterCreationStep`  | ViewModel step display               |
| v0.17.5b | `CharacterCreationState` | Source data for ViewModel            |
| v0.17.5d | `CharacterCreationStep`  | Controller step navigation           |
| v0.17.5d | `CharacterCreationState` | Controller state management          |
| v0.17.5e | `CharacterCreationState` | Factory input for character creation |
| v0.17.5f | `CharacterCreationStep`  | TUI screen selection                 |

---

## 3. Architecture Diagrams

### 3.1 Creation Workflow Overview

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                      CHARACTER CREATION WORKFLOW                             │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  ┌─────────┐   ┌───────────┐   ┌────────────┐   ┌───────────┐              │
│  │ Step 1  │──▶│  Step 2   │──▶│  Step 3    │──▶│  Step 4   │──────┐       │
│  │ Lineage │   │ Background│   │ Attributes │   │ Archetype │      │       │
│  └─────────┘   └───────────┘   └────────────┘   └───────────┘      │       │
│       │              │               │                │             │       │
│       ▼              ▼               ▼                ▼             │       │
│  ┌─────────────────────────────────────────────────────────────┐   │       │
│  │                 CharacterCreationState                       │   │       │
│  │  • SelectedLineage      • AttributeAllocationMode           │   │       │
│  │  • FlexibleBonus        • AttributeAllocation               │   │       │
│  │  • SelectedBackground   • SelectedArchetype                 │   │       │
│  └─────────────────────────────────────────────────────────────┘   │       │
│                                                                     │       │
│       ┌─────────────────────────────────────────────────────────────┘       │
│       │                                                                      │
│       ▼                                                                      │
│  ┌─────────────────┐   ┌────────────┐                                       │
│  │     Step 5      │──▶│  Step 6    │──▶ Character Created                  │
│  │ Specialization  │   │  Summary   │                                       │
│  └─────────────────┘   └────────────┘                                       │
│       │                      │                                               │
│       ▼                      ▼                                               │
│  ┌─────────────────────────────────────────────────────────────┐            │
│  │                 CharacterCreationState                       │            │
│  │  • SelectedSpecialization  • CharacterName                  │            │
│  │  • IsComplete              • ValidationErrors               │            │
│  └─────────────────────────────────────────────────────────────┘            │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 3.2 State Navigation Flow

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                        STATE NAVIGATION FLOW                                 │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  STEP 1: Lineage                                                            │
│  ├── CanGoBack: FALSE (first step)                                          │
│  ├── CanGoForward: TRUE (when lineage selected)                             │
│  └── IsPermanent: FALSE                                                     │
│           │                                                                  │
│           ▼                                                                  │
│  STEP 2: Background                                                         │
│  ├── CanGoBack: TRUE                                                        │
│  ├── CanGoForward: TRUE (when background selected)                          │
│  └── IsPermanent: FALSE                                                     │
│           │                                                                  │
│           ▼                                                                  │
│  STEP 3: Attributes                                                         │
│  ├── CanGoBack: TRUE                                                        │
│  ├── CanGoForward: TRUE (when allocation confirmed)                         │
│  └── IsPermanent: FALSE                                                     │
│           │                                                                  │
│           ▼                                                                  │
│  STEP 4: Archetype                                                          │
│  ├── CanGoBack: TRUE (before selection confirmed)                           │
│  ├── CanGoForward: TRUE (when archetype selected)                           │
│  └── IsPermanent: TRUE ⚠ PERMANENT CHOICE                                   │
│           │                                                                  │
│           ▼                                                                  │
│  STEP 5: Specialization                                                     │
│  ├── CanGoBack: TRUE                                                        │
│  ├── CanGoForward: TRUE (when specialization selected)                      │
│  └── IsPermanent: FALSE                                                     │
│           │                                                                  │
│           ▼                                                                  │
│  STEP 6: Summary                                                            │
│  ├── CanGoBack: TRUE                                                        │
│  ├── CanGoForward: TRUE (when name validated)                               │
│  └── IsPermanent: FALSE                                                     │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 3.3 Layer Architecture

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                          LAYER ARCHITECTURE                                  │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  ┌────────────────────────────────────────────────────────────────────┐     │
│  │                        DOMAIN LAYER                                 │     │
│  │                                                                     │     │
│  │  ┌──────────────────────────┐    ┌─────────────────────────────┐  │     │
│  │  │  CharacterCreationStep   │    │  CharacterCreationState     │  │     │
│  │  │  (Enum)                  │    │  (Entity)                   │  │     │
│  │  │                          │    │                             │  │     │
│  │  │  • Lineage               │    │  • SessionId                │  │     │
│  │  │  • Background            │    │  • CurrentStep              │  │     │
│  │  │  • Attributes            │    │  • SelectedLineage          │  │     │
│  │  │  • Archetype             │    │  • SelectedBackground       │  │     │
│  │  │  • Specialization        │    │  • Attributes               │  │     │
│  │  │  • Summary               │    │  • SelectedArchetype        │  │     │
│  │  │                          │    │  • SelectedSpecialization   │  │     │
│  │  │                          │    │  • CharacterName            │  │     │
│  │  └──────────────────────────┘    └─────────────────────────────┘  │     │
│  │                                                                     │     │
│  └────────────────────────────────────────────────────────────────────┘     │
│                                                                              │
│  ┌────────────────────────────────────────────────────────────────────┐     │
│  │                     INFRASTRUCTURE LAYER                            │     │
│  │                                                                     │     │
│  │  ┌────────────────────────────────────────────────────────────┐   │     │
│  │  │                  creation-workflow.json                     │   │     │
│  │  │                                                             │   │     │
│  │  │  • Step definitions (order, displayName, description)      │   │     │
│  │  │  • Navigation rules (canGoBack, isPermanent)               │   │     │
│  │  │  • Name validation parameters                               │   │     │
│  │  │  • Initialization defaults                                  │   │     │
│  │  │                                                             │   │     │
│  │  └────────────────────────────────────────────────────────────┘   │     │
│  │                                                                     │     │
│  └────────────────────────────────────────────────────────────────────┘     │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 4. CharacterCreationStep Enum

### 4.1 Enum Definition

**File:** `src/Core/RuneAndRust.Domain/Enums/CharacterCreationStep.cs`

```csharp
namespace RuneAndRust.Domain.Enums;

/// <summary>
/// Defines the sequential steps in the character creation wizard.
/// Each step represents a distinct phase where the player makes foundational
/// choices for their character.
/// </summary>
/// <remarks>
/// The enum values are ordered from 0-5 matching the step order (1-6).
/// Step 4 (Archetype) is a permanent choice that cannot be changed after
/// character creation.
/// </remarks>
public enum CharacterCreationStep
{
    /// <summary>
    /// Step 1: Select blood heritage (Clan-Born, Rune-Marked, Iron-Blooded, Vargr-Kin).
    /// Determines attribute modifiers, passive bonuses, and trauma baseline.
    /// </summary>
    Lineage = 0,

    /// <summary>
    /// Step 2: Select pre-Silence profession (Village Smith, Wandering Skald, etc.).
    /// Grants starting skills and equipment.
    /// </summary>
    Background = 1,

    /// <summary>
    /// Step 3: Allocate attribute points using Simple or Advanced mode.
    /// Determines core capabilities (Might, Finesse, Wits, Will, Sturdiness).
    /// </summary>
    Attributes = 2,

    /// <summary>
    /// Step 4: Select combat role (Warrior, Skirmisher, Mystic, Adept).
    /// PERMANENT CHOICE - Cannot be changed after character creation.
    /// Determines available specializations and starting abilities.
    /// </summary>
    Archetype = 3,

    /// <summary>
    /// Step 5: Select tactical identity from archetype's available options.
    /// First specialization is free; grants Tier 1 abilities and special resource.
    /// </summary>
    Specialization = 4,

    /// <summary>
    /// Step 6: Review all choices, enter character name, and confirm creation.
    /// Final step before character is persisted to database.
    /// </summary>
    Summary = 5
}
```

### 4.2 Extension Methods

**File:** `src/Core/RuneAndRust.Domain/Enums/CharacterCreationStepExtensions.cs`

```csharp
namespace RuneAndRust.Domain.Enums;

/// <summary>
/// Extension methods for <see cref="CharacterCreationStep"/> enum.
/// Provides step order, navigation logic, and display information.
/// </summary>
public static class CharacterCreationStepExtensions
{
    /// <summary>
    /// Gets the 1-based step number for display purposes.
    /// </summary>
    /// <param name="step">The creation step.</param>
    /// <returns>Step number (1-6).</returns>
    public static int GetStepNumber(this CharacterCreationStep step) => (int)step + 1;

    /// <summary>
    /// Gets the total number of steps in the creation workflow.
    /// </summary>
    /// <returns>Total step count (6).</returns>
    public static int GetTotalSteps() => 6;

    /// <summary>
    /// Determines if navigation backward is allowed from this step.
    /// </summary>
    /// <param name="step">The creation step.</param>
    /// <returns>True if can go back; false for first step.</returns>
    public static bool CanGoBack(this CharacterCreationStep step) => step != CharacterCreationStep.Lineage;

    /// <summary>
    /// Determines if this step represents a permanent, irreversible choice.
    /// </summary>
    /// <param name="step">The creation step.</param>
    /// <returns>True if permanent choice; only Archetype step.</returns>
    public static bool IsPermanentChoice(this CharacterCreationStep step) =>
        step == CharacterCreationStep.Archetype;

    /// <summary>
    /// Gets the next step in the workflow, if available.
    /// </summary>
    /// <param name="step">The current step.</param>
    /// <returns>Next step, or null if at Summary.</returns>
    public static CharacterCreationStep? GetNextStep(this CharacterCreationStep step) =>
        step == CharacterCreationStep.Summary ? null : (CharacterCreationStep)((int)step + 1);

    /// <summary>
    /// Gets the previous step in the workflow, if available.
    /// </summary>
    /// <param name="step">The current step.</param>
    /// <returns>Previous step, or null if at Lineage.</returns>
    public static CharacterCreationStep? GetPreviousStep(this CharacterCreationStep step) =>
        step == CharacterCreationStep.Lineage ? null : (CharacterCreationStep)((int)step - 1);

    /// <summary>
    /// Gets the display name for this step.
    /// </summary>
    /// <param name="step">The creation step.</param>
    /// <returns>Human-readable step name.</returns>
    public static string GetDisplayName(this CharacterCreationStep step) => step switch
    {
        CharacterCreationStep.Lineage => "Choose Your Lineage",
        CharacterCreationStep.Background => "Choose Your Background",
        CharacterCreationStep.Attributes => "Allocate Attributes",
        CharacterCreationStep.Archetype => "Choose Your Archetype",
        CharacterCreationStep.Specialization => "Choose Your Specialization",
        CharacterCreationStep.Summary => "Confirm Your Survivor",
        _ => step.ToString()
    };

    /// <summary>
    /// Gets the thematic description for this step.
    /// </summary>
    /// <param name="step">The creation step.</param>
    /// <returns>Atmospheric step description.</returns>
    public static string GetDescription(this CharacterCreationStep step) => step switch
    {
        CharacterCreationStep.Lineage => "Your bloodline carries echoes of the world before.",
        CharacterCreationStep.Background => "What were you before the world broke?",
        CharacterCreationStep.Attributes => "Define your character's core capabilities.",
        CharacterCreationStep.Archetype => "Your fundamental approach to survival.",
        CharacterCreationStep.Specialization => "Your tactical identity and unique abilities.",
        CharacterCreationStep.Summary => "Review your choices and begin your saga.",
        _ => string.Empty
    };
}
```

---

## 5. CharacterCreationState Entity

### 5.1 Entity Definition

**File:** `src/Core/RuneAndRust.Domain/Entities/CharacterCreationState.cs`

```csharp
using RuneAndRust.Domain.Enums;
using RuneAndRust.Domain.Interfaces;
using RuneAndRust.Domain.ValueObjects;

namespace RuneAndRust.Domain.Entities;

/// <summary>
/// Maintains all player selections throughout the character creation process.
/// Supports forward/backward navigation while preserving choices until final confirmation.
/// </summary>
/// <remarks>
/// This entity is transient and exists only during the creation session.
/// It is not persisted to the database; only the final character is saved.
/// </remarks>
public class CharacterCreationState : IEntity
{
    /// <summary>
    /// Gets the unique identifier for this creation state.
    /// </summary>
    public Guid Id { get; private set; }

    /// <summary>
    /// Gets or sets the session identifier for this creation workflow.
    /// Used to track creation sessions across potential interruptions.
    /// </summary>
    public string SessionId { get; private set; }

    /// <summary>
    /// Gets or sets the current step in the creation workflow.
    /// </summary>
    public CharacterCreationStep CurrentStep { get; set; }

    // ═══════════════════════════════════════════════════════════════════════
    // Step 1: Lineage
    // ═══════════════════════════════════════════════════════════════════════

    /// <summary>
    /// Gets or sets the selected lineage (blood heritage).
    /// Null until Step 1 is completed.
    /// </summary>
    public Lineage? SelectedLineage { get; set; }

    /// <summary>
    /// Gets or sets the flexible attribute bonus selection for Clan-Born lineage.
    /// Required when SelectedLineage is Clan-Born; null otherwise.
    /// </summary>
    public CoreAttribute? FlexibleAttributeBonus { get; set; }

    // ═══════════════════════════════════════════════════════════════════════
    // Step 2: Background
    // ═══════════════════════════════════════════════════════════════════════

    /// <summary>
    /// Gets or sets the selected background (pre-Silence profession).
    /// Null until Step 2 is completed.
    /// </summary>
    public Background? SelectedBackground { get; set; }

    // ═══════════════════════════════════════════════════════════════════════
    // Step 3: Attributes
    // ═══════════════════════════════════════════════════════════════════════

    /// <summary>
    /// Gets or sets the attribute allocation mode (Simple or Advanced).
    /// Defaults to Simple for new players.
    /// </summary>
    public AttributeAllocationMode AttributeAllocationMode { get; set; }

    /// <summary>
    /// Gets or sets the attribute allocation state.
    /// Contains point allocation for all five core attributes.
    /// </summary>
    public AttributeAllocationState? Attributes { get; set; }

    // ═══════════════════════════════════════════════════════════════════════
    // Step 4: Archetype (PERMANENT)
    // ═══════════════════════════════════════════════════════════════════════

    /// <summary>
    /// Gets or sets the selected archetype (combat role).
    /// PERMANENT CHOICE - Cannot be changed after character creation.
    /// Null until Step 4 is completed.
    /// </summary>
    public Archetype? SelectedArchetype { get; set; }

    // ═══════════════════════════════════════════════════════════════════════
    // Step 5: Specialization
    // ═══════════════════════════════════════════════════════════════════════

    /// <summary>
    /// Gets or sets the selected specialization (tactical identity).
    /// Must be valid for the selected archetype.
    /// Null until Step 5 is completed.
    /// </summary>
    public SpecializationId? SelectedSpecialization { get; set; }

    // ═══════════════════════════════════════════════════════════════════════
    // Step 6: Summary
    // ═══════════════════════════════════════════════════════════════════════

    /// <summary>
    /// Gets or sets the character name entered during summary step.
    /// Subject to validation rules (2-20 chars, letters/spaces/hyphens).
    /// Null until name is entered.
    /// </summary>
    public string? CharacterName { get; set; }

    // ═══════════════════════════════════════════════════════════════════════
    // Metadata
    // ═══════════════════════════════════════════════════════════════════════

    /// <summary>
    /// Gets the timestamp when this creation session was started.
    /// </summary>
    public DateTime CreatedAt { get; private set; }

    /// <summary>
    /// Gets or sets the timestamp when this state was last modified.
    /// Updated on every selection change.
    /// </summary>
    public DateTime LastModifiedAt { get; set; }

    /// <summary>
    /// Gets a value indicating whether all required selections are complete.
    /// True when all steps have valid selections and name is validated.
    /// </summary>
    public bool IsComplete =>
        SelectedLineage.HasValue &&
        SelectedBackground.HasValue &&
        Attributes != null &&
        SelectedArchetype.HasValue &&
        SelectedSpecialization.HasValue &&
        !string.IsNullOrWhiteSpace(CharacterName) &&
        ValidationErrors.Count == 0;

    /// <summary>
    /// Gets or sets the list of validation errors for the current state.
    /// Empty list indicates valid state.
    /// </summary>
    public List<string> ValidationErrors { get; set; } = new();

    // ═══════════════════════════════════════════════════════════════════════
    // Constructors
    // ═══════════════════════════════════════════════════════════════════════

    /// <summary>
    /// Private constructor for EF Core.
    /// </summary>
    private CharacterCreationState()
    {
        SessionId = null!;
    }

    /// <summary>
    /// Creates a new character creation state with a unique session ID.
    /// </summary>
    /// <returns>Initialized creation state at Step 1 (Lineage).</returns>
    public static CharacterCreationState Create()
    {
        var now = DateTime.UtcNow;
        return new CharacterCreationState
        {
            Id = Guid.NewGuid(),
            SessionId = Guid.NewGuid().ToString("N"),
            CurrentStep = CharacterCreationStep.Lineage,
            AttributeAllocationMode = AttributeAllocationMode.Simple,
            CreatedAt = now,
            LastModifiedAt = now,
            ValidationErrors = new List<string>()
        };
    }

    // ═══════════════════════════════════════════════════════════════════════
    // Navigation Methods
    // ═══════════════════════════════════════════════════════════════════════

    /// <summary>
    /// Advances to the next step if current step requirements are met.
    /// </summary>
    /// <returns>True if advanced; false if at final step or requirements not met.</returns>
    public bool TryAdvance()
    {
        var nextStep = CurrentStep.GetNextStep();
        if (nextStep == null || !IsStepComplete(CurrentStep))
            return false;

        CurrentStep = nextStep.Value;
        LastModifiedAt = DateTime.UtcNow;
        return true;
    }

    /// <summary>
    /// Goes back to the previous step if allowed.
    /// </summary>
    /// <returns>True if went back; false if at first step.</returns>
    public bool TryGoBack()
    {
        var previousStep = CurrentStep.GetPreviousStep();
        if (previousStep == null)
            return false;

        CurrentStep = previousStep.Value;
        LastModifiedAt = DateTime.UtcNow;
        return true;
    }

    /// <summary>
    /// Determines if the specified step has all required selections.
    /// </summary>
    /// <param name="step">The step to check.</param>
    /// <returns>True if step requirements are satisfied.</returns>
    public bool IsStepComplete(CharacterCreationStep step) => step switch
    {
        CharacterCreationStep.Lineage => SelectedLineage.HasValue &&
            (SelectedLineage != Lineage.ClanBorn || FlexibleAttributeBonus.HasValue),
        CharacterCreationStep.Background => SelectedBackground.HasValue,
        CharacterCreationStep.Attributes => Attributes != null && Attributes.IsValid,
        CharacterCreationStep.Archetype => SelectedArchetype.HasValue,
        CharacterCreationStep.Specialization => SelectedSpecialization.HasValue,
        CharacterCreationStep.Summary => !string.IsNullOrWhiteSpace(CharacterName),
        _ => false
    };

    /// <summary>
    /// Resets all selections and returns to Step 1.
    /// </summary>
    public void Reset()
    {
        CurrentStep = CharacterCreationStep.Lineage;
        SelectedLineage = null;
        FlexibleAttributeBonus = null;
        SelectedBackground = null;
        AttributeAllocationMode = AttributeAllocationMode.Simple;
        Attributes = null;
        SelectedArchetype = null;
        SelectedSpecialization = null;
        CharacterName = null;
        ValidationErrors.Clear();
        LastModifiedAt = DateTime.UtcNow;
    }
}
```

---

## 6. Configuration

### 6.1 Configuration File

**File:** `config/creation-workflow.json`

```json
{
    "$schema": "./schemas/creation-workflow.schema.json",
    "workflow": {
        "steps": [
            {
                "step": "Lineage",
                "order": 1,
                "displayName": "Choose Your Lineage",
                "description": "Your bloodline carries echoes of the world before.",
                "canGoBack": false,
                "isPermanent": false
            },
            {
                "step": "Background",
                "order": 2,
                "displayName": "Choose Your Background",
                "description": "What were you before the world broke?",
                "canGoBack": true,
                "isPermanent": false
            },
            {
                "step": "Attributes",
                "order": 3,
                "displayName": "Allocate Attributes",
                "description": "Define your character's core capabilities.",
                "canGoBack": true,
                "isPermanent": false
            },
            {
                "step": "Archetype",
                "order": 4,
                "displayName": "Choose Your Archetype",
                "description": "Your fundamental approach to survival.",
                "canGoBack": true,
                "isPermanent": true,
                "permanentWarning": "This choice is PERMANENT and cannot be changed after character creation."
            },
            {
                "step": "Specialization",
                "order": 5,
                "displayName": "Choose Your Specialization",
                "description": "Your tactical identity and unique abilities.",
                "canGoBack": true,
                "isPermanent": false
            },
            {
                "step": "Summary",
                "order": 6,
                "displayName": "Confirm Your Survivor",
                "description": "Review your choices and begin your saga.",
                "canGoBack": true,
                "isPermanent": false
            }
        ]
    },
    "nameValidation": {
        "minLength": 2,
        "maxLength": 20,
        "allowedPattern": "^[a-zA-Z][a-zA-Z\\s\\-]*[a-zA-Z]$|^[a-zA-Z]{2}$",
        "profanityFilter": []
    },
    "initialization": {
        "startingLegend": 0,
        "startingPP": 0,
        "startingMilestone": 0,
        "legendToNextMilestone": 500,
        "startingStress": 0,
        "resourcesAtMax": true
    }
}
```

### 6.2 Configuration Schema

**File:** `config/schemas/creation-workflow.schema.json`

```json
{
    "$schema": "http://json-schema.org/draft-07/schema#",
    "$id": "creation-workflow.schema.json",
    "title": "Character Creation Workflow Configuration",
    "description": "Defines the character creation workflow steps, navigation rules, and validation parameters.",
    "type": "object",
    "required": ["workflow", "nameValidation", "initialization"],
    "properties": {
        "workflow": {
            "type": "object",
            "required": ["steps"],
            "properties": {
                "steps": {
                    "type": "array",
                    "minItems": 6,
                    "maxItems": 6,
                    "items": {
                        "$ref": "#/definitions/WorkflowStep"
                    }
                }
            }
        },
        "nameValidation": {
            "$ref": "#/definitions/NameValidation"
        },
        "initialization": {
            "$ref": "#/definitions/Initialization"
        }
    },
    "definitions": {
        "WorkflowStep": {
            "type": "object",
            "required": [
                "step",
                "order",
                "displayName",
                "description",
                "canGoBack",
                "isPermanent"
            ],
            "properties": {
                "step": {
                    "type": "string",
                    "enum": [
                        "Lineage",
                        "Background",
                        "Attributes",
                        "Archetype",
                        "Specialization",
                        "Summary"
                    ]
                },
                "order": {
                    "type": "integer",
                    "minimum": 1,
                    "maximum": 6
                },
                "displayName": {
                    "type": "string",
                    "minLength": 1,
                    "maxLength": 50
                },
                "description": {
                    "type": "string",
                    "minLength": 1,
                    "maxLength": 200
                },
                "canGoBack": {
                    "type": "boolean"
                },
                "isPermanent": {
                    "type": "boolean"
                },
                "permanentWarning": {
                    "type": "string",
                    "minLength": 1,
                    "maxLength": 200
                }
            }
        },
        "NameValidation": {
            "type": "object",
            "required": ["minLength", "maxLength", "allowedPattern"],
            "properties": {
                "minLength": {
                    "type": "integer",
                    "minimum": 1,
                    "maximum": 10
                },
                "maxLength": {
                    "type": "integer",
                    "minimum": 10,
                    "maximum": 50
                },
                "allowedPattern": {
                    "type": "string"
                },
                "profanityFilter": {
                    "type": "array",
                    "items": { "type": "string" }
                }
            }
        },
        "Initialization": {
            "type": "object",
            "required": [
                "startingLegend",
                "startingPP",
                "startingMilestone",
                "legendToNextMilestone",
                "startingStress",
                "resourcesAtMax"
            ],
            "properties": {
                "startingLegend": {
                    "type": "integer",
                    "minimum": 0
                },
                "startingPP": {
                    "type": "integer",
                    "minimum": 0
                },
                "startingMilestone": {
                    "type": "integer",
                    "minimum": 0
                },
                "legendToNextMilestone": {
                    "type": "integer",
                    "minimum": 100
                },
                "startingStress": {
                    "type": "integer",
                    "minimum": 0
                },
                "resourcesAtMax": {
                    "type": "boolean"
                }
            }
        }
    }
}
```

---

## 7. Commands

This version does not introduce any new player-facing commands. Command integration will be implemented in v0.17.5d (Creation Controller).

---

## 8. User-Facing Changes

### 8.1 No Direct User-Facing Changes

This version establishes foundational infrastructure. User-facing changes will be visible in:

- **v0.17.5f (TUI Screens)**: Visual creation wizard interface
- **v0.17.5d (Controller)**: Command handling for step navigation

---

## 9. Logging Specifications

### 9.1 State Lifecycle Logging

```csharp
// State creation
_logger.LogInformation(
    "Character creation session started. SessionId: {SessionId}, CreatedAt: {CreatedAt}",
    state.SessionId, state.CreatedAt);

// Step navigation
_logger.LogDebug(
    "Creation state advancing from {FromStep} to {ToStep}. SessionId: {SessionId}",
    previousStep, newStep, state.SessionId);

_logger.LogDebug(
    "Creation state going back from {FromStep} to {ToStep}. SessionId: {SessionId}",
    previousStep, newStep, state.SessionId);

// Selection changes
_logger.LogDebug(
    "Lineage selected: {Lineage}, FlexibleBonus: {FlexibleBonus}. SessionId: {SessionId}",
    state.SelectedLineage, state.FlexibleAttributeBonus, state.SessionId);

_logger.LogDebug(
    "Background selected: {Background}. SessionId: {SessionId}",
    state.SelectedBackground, state.SessionId);

_logger.LogDebug(
    "Archetype selected: {Archetype} (PERMANENT). SessionId: {SessionId}",
    state.SelectedArchetype, state.SessionId);

_logger.LogDebug(
    "Specialization selected: {Specialization}. SessionId: {SessionId}",
    state.SelectedSpecialization, state.SessionId);

// State completion
_logger.LogInformation(
    "Character creation state complete. SessionId: {SessionId}, CharacterName: {Name}",
    state.SessionId, state.CharacterName);

// State reset
_logger.LogInformation(
    "Character creation session reset. SessionId: {SessionId}",
    state.SessionId);
```

---

## 10. Unit Testing Requirements

### 10.1 Test Coverage Summary

| Test Category          | Test Count | Priority |
| ---------------------- | ---------- | -------- |
| Enum Value Tests       | 1          | Critical |
| State Creation Tests   | 2          | Critical |
| Navigation Tests       | 3          | Critical |
| Step Completion Tests  | 3          | High     |
| Extension Method Tests | 2          | Medium   |
| **Total**              | **~11**    |          |

### 10.2 CharacterCreationStep Enum Tests

**File:** `tests/RuneAndRust.Domain.UnitTests/Enums/CharacterCreationStepTests.cs`

```csharp
using FluentAssertions;
using NUnit.Framework;
using RuneAndRust.Domain.Enums;

namespace RuneAndRust.Domain.UnitTests.Enums;

[TestFixture]
public class CharacterCreationStepTests
{
    [Test]
    public void CharacterCreationStep_ShouldHave_ExactlySixValues()
    {
        // Arrange & Act
        var values = Enum.GetValues<CharacterCreationStep>();

        // Assert
        values.Should().HaveCount(6);
        values.Should().Contain(CharacterCreationStep.Lineage);
        values.Should().Contain(CharacterCreationStep.Background);
        values.Should().Contain(CharacterCreationStep.Attributes);
        values.Should().Contain(CharacterCreationStep.Archetype);
        values.Should().Contain(CharacterCreationStep.Specialization);
        values.Should().Contain(CharacterCreationStep.Summary);
    }

    [Test]
    [TestCase(CharacterCreationStep.Lineage, 1)]
    [TestCase(CharacterCreationStep.Background, 2)]
    [TestCase(CharacterCreationStep.Attributes, 3)]
    [TestCase(CharacterCreationStep.Archetype, 4)]
    [TestCase(CharacterCreationStep.Specialization, 5)]
    [TestCase(CharacterCreationStep.Summary, 6)]
    public void GetStepNumber_ReturnsCorrectOneBasedNumber(CharacterCreationStep step, int expectedNumber)
    {
        // Act
        var stepNumber = step.GetStepNumber();

        // Assert
        stepNumber.Should().Be(expectedNumber);
    }

    [Test]
    public void IsPermanentChoice_OnlyArchetypeReturnsTrue()
    {
        // Arrange
        var allSteps = Enum.GetValues<CharacterCreationStep>();

        // Act & Assert
        foreach (var step in allSteps)
        {
            var isPermanent = step.IsPermanentChoice();
            isPermanent.Should().Be(step == CharacterCreationStep.Archetype,
                because: $"{step} should {(step == CharacterCreationStep.Archetype ? "" : "not ")}be permanent");
        }
    }

    [Test]
    public void CanGoBack_ReturnsFalseOnlyForLineage()
    {
        // Arrange
        var allSteps = Enum.GetValues<CharacterCreationStep>();

        // Act & Assert
        foreach (var step in allSteps)
        {
            var canGoBack = step.CanGoBack();
            canGoBack.Should().Be(step != CharacterCreationStep.Lineage,
                because: $"{step} should {(step == CharacterCreationStep.Lineage ? "not " : "")}allow going back");
        }
    }

    [Test]
    public void GetNextStep_ReturnsNullForSummary()
    {
        // Act
        var nextStep = CharacterCreationStep.Summary.GetNextStep();

        // Assert
        nextStep.Should().BeNull();
    }

    [Test]
    public void GetPreviousStep_ReturnsNullForLineage()
    {
        // Act
        var previousStep = CharacterCreationStep.Lineage.GetPreviousStep();

        // Assert
        previousStep.Should().BeNull();
    }
}
```

### 10.3 CharacterCreationState Entity Tests

**File:** `tests/RuneAndRust.Domain.UnitTests/Entities/CharacterCreationStateTests.cs`

```csharp
using FluentAssertions;
using NUnit.Framework;
using RuneAndRust.Domain.Entities;
using RuneAndRust.Domain.Enums;
using RuneAndRust.Domain.ValueObjects;

namespace RuneAndRust.Domain.UnitTests.Entities;

[TestFixture]
public class CharacterCreationStateTests
{
    [Test]
    public void Create_InitializesWithCorrectDefaults()
    {
        // Act
        var state = CharacterCreationState.Create();

        // Assert
        state.Id.Should().NotBeEmpty();
        state.SessionId.Should().NotBeNullOrEmpty();
        state.CurrentStep.Should().Be(CharacterCreationStep.Lineage);
        state.AttributeAllocationMode.Should().Be(AttributeAllocationMode.Simple);
        state.SelectedLineage.Should().BeNull();
        state.SelectedBackground.Should().BeNull();
        state.SelectedArchetype.Should().BeNull();
        state.SelectedSpecialization.Should().BeNull();
        state.CharacterName.Should().BeNull();
        state.IsComplete.Should().BeFalse();
        state.ValidationErrors.Should().BeEmpty();
    }

    [Test]
    public void TryAdvance_FromLineage_WhenLineageNotSelected_ReturnsFalse()
    {
        // Arrange
        var state = CharacterCreationState.Create();

        // Act
        var result = state.TryAdvance();

        // Assert
        result.Should().BeFalse();
        state.CurrentStep.Should().Be(CharacterCreationStep.Lineage);
    }

    [Test]
    public void TryAdvance_FromLineage_WhenLineageSelected_ReturnsTrue()
    {
        // Arrange
        var state = CharacterCreationState.Create();
        state.SelectedLineage = Lineage.IronBlooded;

        // Act
        var result = state.TryAdvance();

        // Assert
        result.Should().BeTrue();
        state.CurrentStep.Should().Be(CharacterCreationStep.Background);
    }

    [Test]
    public void TryAdvance_FromLineage_WhenClanBornWithoutFlexibleBonus_ReturnsFalse()
    {
        // Arrange
        var state = CharacterCreationState.Create();
        state.SelectedLineage = Lineage.ClanBorn;
        state.FlexibleAttributeBonus = null;

        // Act
        var result = state.TryAdvance();

        // Assert
        result.Should().BeFalse();
        state.CurrentStep.Should().Be(CharacterCreationStep.Lineage);
    }

    [Test]
    public void TryAdvance_FromLineage_WhenClanBornWithFlexibleBonus_ReturnsTrue()
    {
        // Arrange
        var state = CharacterCreationState.Create();
        state.SelectedLineage = Lineage.ClanBorn;
        state.FlexibleAttributeBonus = CoreAttribute.Might;

        // Act
        var result = state.TryAdvance();

        // Assert
        result.Should().BeTrue();
        state.CurrentStep.Should().Be(CharacterCreationStep.Background);
    }

    [Test]
    public void TryGoBack_FromLineage_ReturnsFalse()
    {
        // Arrange
        var state = CharacterCreationState.Create();

        // Act
        var result = state.TryGoBack();

        // Assert
        result.Should().BeFalse();
        state.CurrentStep.Should().Be(CharacterCreationStep.Lineage);
    }

    [Test]
    public void TryGoBack_FromBackground_ReturnsTrue_PreservesSelections()
    {
        // Arrange
        var state = CharacterCreationState.Create();
        state.SelectedLineage = Lineage.VargrKin;
        state.CurrentStep = CharacterCreationStep.Background;
        state.SelectedBackground = Background.VillageSmith;

        // Act
        var result = state.TryGoBack();

        // Assert
        result.Should().BeTrue();
        state.CurrentStep.Should().Be(CharacterCreationStep.Lineage);
        state.SelectedLineage.Should().Be(Lineage.VargrKin);
        state.SelectedBackground.Should().Be(Background.VillageSmith);
    }

    [Test]
    public void Reset_ClearsAllSelectionsAndReturnsToLineage()
    {
        // Arrange
        var state = CharacterCreationState.Create();
        state.SelectedLineage = Lineage.RuneMarked;
        state.SelectedBackground = Background.WanderingSkald;
        state.SelectedArchetype = Archetype.Mystic;
        state.CurrentStep = CharacterCreationStep.Specialization;

        // Act
        state.Reset();

        // Assert
        state.CurrentStep.Should().Be(CharacterCreationStep.Lineage);
        state.SelectedLineage.Should().BeNull();
        state.SelectedBackground.Should().BeNull();
        state.SelectedArchetype.Should().BeNull();
        state.SelectedSpecialization.Should().BeNull();
        state.CharacterName.Should().BeNull();
    }

    [Test]
    public void IsComplete_ReturnsFalse_WhenAnySelectionMissing()
    {
        // Arrange
        var state = CharacterCreationState.Create();
        state.SelectedLineage = Lineage.IronBlooded;
        state.SelectedBackground = Background.VillageSmith;
        // Missing Attributes, Archetype, Specialization, Name

        // Act & Assert
        state.IsComplete.Should().BeFalse();
    }

    [Test]
    public void IsComplete_ReturnsTrue_WhenAllSelectionsPresent()
    {
        // Arrange
        var state = CharacterCreationState.Create();
        state.SelectedLineage = Lineage.IronBlooded;
        state.SelectedBackground = Background.VillageSmith;
        state.Attributes = AttributeAllocationState.CreateDefault();
        state.SelectedArchetype = Archetype.Warrior;
        state.SelectedSpecialization = SpecializationId.Skjaldmaer;
        state.CharacterName = "Sigurd";

        // Act & Assert
        state.IsComplete.Should().BeTrue();
    }
}
```

---

## 11. Use Cases

### 11.1 Initialize Creation Session

**Actor:** Player
**Preconditions:** Player selects "New Character" from main menu
**Flow:**

1. System creates new `CharacterCreationState` with unique SessionId
2. System sets CurrentStep to Lineage
3. System initializes all selections as null
4. System sets AttributeAllocationMode to Simple

**Postconditions:** State ready for Step 1 selection

### 11.2 Navigate Forward After Selection

**Actor:** Player
**Preconditions:** Player has made valid selection for current step
**Flow:**

1. Player confirms current step selection
2. System validates selection (e.g., Clan-Born requires FlexibleAttributeBonus)
3. If valid, system advances CurrentStep
4. System updates LastModifiedAt

**Postconditions:** State at next step, previous selection preserved

### 11.3 Navigate Backward

**Actor:** Player
**Preconditions:** Player is not on Step 1 (Lineage)
**Flow:**

1. Player requests to go back
2. System decrements CurrentStep
3. System preserves all existing selections

**Postconditions:** State at previous step, all selections intact

### 11.4 Reset Creation

**Actor:** Player
**Preconditions:** Player requests to start over
**Flow:**

1. System calls Reset() on state
2. System clears all selections
3. System returns to Step 1 (Lineage)

**Postconditions:** State reset to initial values

---

## 12. Deliverable Checklist

### 12.1 Code Deliverables

- [ ] `src/Core/RuneAndRust.Domain/Enums/CharacterCreationStep.cs`
- [ ] `src/Core/RuneAndRust.Domain/Enums/CharacterCreationStepExtensions.cs`
- [ ] `src/Core/RuneAndRust.Domain/Entities/CharacterCreationState.cs`
- [ ] `config/creation-workflow.json`
- [ ] `config/schemas/creation-workflow.schema.json`

### 12.2 Test Deliverables

- [ ] `tests/RuneAndRust.Domain.UnitTests/Enums/CharacterCreationStepTests.cs`
- [ ] `tests/RuneAndRust.Domain.UnitTests/Entities/CharacterCreationStateTests.cs`

### 12.3 Documentation Deliverables

- [ ] `docs/design/v0.17.x/v0.17.5a-changelog.md`
- [ ] Update `docs/design/v0.17.x/v0.17.5-scope-breakdown.md` (mark items complete)

---

## 13. Acceptance Criteria

- [ ] `CharacterCreationStep` enum has exactly 6 values
- [ ] Enum values are ordered 0-5 matching step order 1-6
- [ ] `CharacterCreationState.Create()` initializes with correct defaults
- [ ] State SessionId is unique for each creation instance
- [ ] TryAdvance validates step completion before advancing
- [ ] TryAdvance returns false for incomplete steps
- [ ] Clan-Born lineage requires FlexibleAttributeBonus to advance
- [ ] TryGoBack returns false from Step 1 (Lineage)
- [ ] TryGoBack preserves all existing selections
- [ ] Reset clears all selections and returns to Step 1
- [ ] IsComplete returns true only when all selections present
- [ ] Extension methods return correct values for all steps
- [ ] `creation-workflow.json` validates against schema
- [ ] All ~11 unit tests pass

---

## 14. Future Considerations

### 14.1 Session Persistence

Future versions may implement:

- Auto-save of creation state during long sessions
- Resume interrupted creation sessions
- Multiple saved creation drafts

### 14.2 Undo Archetype Selection

The current design marks Archetype as permanent. Future consideration:

- Allow single undo before final confirmation
- Track "confirmation count" for undo eligibility

### 14.3 Quick-Start Templates

Preset character configurations:

- Pre-selected Lineage + Background + Archetype combinations
- Skip to Specialization step with defaults applied

---

## 15. Implementation Notes

### 15.1 State vs. Entity Pattern

`CharacterCreationState` is an Entity (has Id) but is transient:

- Not persisted until character creation completes
- Could be stored in session/memory during creation
- Final character is a separate `PlayerCharacter` entity

### 15.2 Enum Ordering

Enum values start at 0 intentionally:

- Allows `GetStepNumber()` to simply add 1
- Allows `GetNextStep()` / `GetPreviousStep()` to cast integers

### 15.3 Configuration Override

Extension methods provide defaults, but `creation-workflow.json` is the source of truth:

- Display names and descriptions can be customized
- Permanent warnings can be localized
- Future: Step order could be configurable for different game modes

---

## 16. Document Metadata

| Property         | Value                                                        |
| ---------------- | ------------------------------------------------------------ |
| **Document ID**  | v0.17.5a-design-specification                                |
| **Version**      | 1.0                                                          |
| **Status**       | Draft                                                        |
| **Created**      | 2026-01-28                                                   |
| **Last Updated** | 2026-01-28                                                   |
| **Author**       | Claude                                                       |
| **Reviewer**     | [Pending]                                                    |
| **Related Docs** | v0.17.5-scope-breakdown.md, v0.17.4e-design-specification.md |
