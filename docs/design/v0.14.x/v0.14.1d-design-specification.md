# v0.14.1d Design Specification: Combat Rules Schema

**Version:** 0.14.1d
**Parent:** v0.14.1 (Combat Configuration Schemas)
**Prerequisites:** v0.14.0 Complete (Character Configuration Schemas)
**Status:** Design Complete

---

## Table of Contents

1. [Executive Summary](#1-executive-summary)
2. [Feature Overview](#2-feature-overview)
3. [Architecture Diagrams](#3-architecture-diagrams)
4. [Combat Schema Definition](#4-combat-schema-definition)
   - 4.1 [Root Configuration Properties](#41-root-configuration-properties)
   - 4.2 [FlankingConfig Definition](#42-flankingconfig-definition)
   - 4.3 [OpportunityAttackConfig Definition](#43-opportunityattackconfig-definition)
   - 4.4 [DisengageConfig Definition](#44-disengageconfig-definition)
   - 4.5 [InitiativeConfig Definition](#45-initiativeconfig-definition)
   - 4.6 [DeathConfig Definition](#46-deathconfig-definition)
5. [Flanking System Configuration](#5-flanking-system-configuration)
   - 5.1 [Flanking Positions](#51-flanking-positions)
   - 5.2 [Flanking Bonuses](#52-flanking-bonuses)
6. [Opportunity Attack Configuration](#6-opportunity-attack-configuration)
   - 6.1 [Opportunity Attack Rules](#61-opportunity-attack-rules)
   - 6.2 [Disengage Action](#62-disengage-action)
7. [Initiative System Configuration](#7-initiative-system-configuration)
   - 7.1 [Base Attributes](#71-base-attributes)
   - 7.2 [Dice Expressions](#72-dice-expressions)
   - 7.3 [Tie Breakers](#73-tie-breakers)
8. [Death and Unconscious Configuration](#8-death-and-unconscious-configuration)
   - 8.1 [Health Thresholds](#81-health-thresholds)
   - 8.2 [Death Saves](#82-death-saves)
9. [Validation Rules](#9-validation-rules)
   - 9.1 [Enum Validation](#91-enum-validation)
   - 9.2 [Range Validation](#92-range-validation)
   - 9.3 [Required Fields](#93-required-fields)
   - 9.4 [Pattern Validation](#94-pattern-validation)
10. [Configuration Schema](#10-configuration-schema)
11. [Configuration File Updates](#11-configuration-file-updates)
12. [Data Model Changes](#12-data-model-changes)
13. [Logging Specifications](#13-logging-specifications)
14. [Unit Testing Requirements](#14-unit-testing-requirements)
15. [Use Cases](#15-use-cases)
16. [Deliverable Checklist](#16-deliverable-checklist)
17. [Acceptance Criteria](#17-acceptance-criteria)
18. [Dependencies](#18-dependencies)
19. [Future Considerations](#19-future-considerations)

---

## 1. Executive Summary

Version 0.14.1d introduces the **Combat Rules Schema** (`combat.schema.json`), which validates combat mechanics configuration including flanking rules, opportunity attack settings, disengage actions, initiative calculations, and death/unconscious behaviors. This schema enables full customization of tactical combat rules without code changes, supporting different combat styles from simplified arcade-style to complex tactical systems.

The Combat Rules Schema validates flanking bonuses, opportunity attack requirements, reaction limitations, disengage action costs, initiative dice expressions, tie breaker rules, death thresholds, and death save mechanics.

### Key Deliverables

| Category | Items |
|----------|-------|
| **Schema Files** | `combat.schema.json` |
| **Schema Definitions** | `FlankingConfig`, `OpportunityAttackConfig`, `DisengageConfig`, `InitiativeConfig`, `DeathConfig` |
| **Configuration Updates** | Update `combat.json` with schema reference and expanded settings |
| **Tests** | ~6 new unit tests |

### Architectural Significance

This version provides:
- **Flanking configuration** - Attack and damage bonuses for positional advantage
- **Opportunity attack system** - Rules for attacks of opportunity and reactions
- **Disengage action** - Configuration for safely withdrawing from combat
- **Initiative system** - Dice expressions, tie breakers, and surprise round bonuses
- **Death system** - Thresholds for unconscious/death and death save mechanics
- **Modular combat rules** - Enable/disable individual combat subsystems

### Relationship to Other Schemas

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                     v0.14.1 COMBAT CONFIGURATION SCHEMAS                     │
└─────────────────────────────────────────────────────────────────────────────┘

  ┌─────────────────────────────────────────────────────────────────────────┐
  │  v0.14.1a: abilities.schema.json (expanded)                              │
  │  v0.14.1b: status-effects.schema.json                                    │
  │  v0.14.1c: damage-types.schema.json                                      │
  │  v0.14.1d: combat.schema.json ◀── THIS VERSION                           │
  └─────────────────────────────────────────────────────────────────────────┘

  Cross-references:
  • abilities.json → combat rules affect ability targeting and costs
  • status-effects.json → some effects interact with flanking/initiative
  • game-loop → uses combat.json for combat resolution rules

  All schemas share:
  • JSON Schema Draft-07 format
  • Schema location: config/schemas/
  • Boolean enable/disable flags
  • IDE autocomplete support
```

---

## 2. Feature Overview

```
v0.14.1d Combat Rules Schema Features
├── combat.schema.json
│   ├── Root Configuration Properties
│   │   ├── $schema (string, optional)
│   │   ├── version (string, optional)
│   │   ├── flanking (FlankingConfig)
│   │   ├── opportunityAttacks (OpportunityAttackConfig)
│   │   ├── initiative (InitiativeConfig, optional)
│   │   └── death (DeathConfig, optional)
│   └── Definitions
│       ├── FlankingConfig
│       │   ├── enabled (boolean, default: true)
│       │   ├── attackBonus (integer, minimum: 0)
│       │   ├── damageBonus (integer, minimum: 0)
│       │   ├── behindAttackBonus (integer, minimum: 0, optional)
│       │   └── behindDamageBonus (integer, minimum: 0, optional)
│       ├── OpportunityAttackConfig
│       │   ├── enabled (boolean, default: true)
│       │   ├── requiresMeleeWeapon (boolean, default: true)
│       │   ├── oneReactionPerRound (boolean, default: true)
│       │   └── disengage (DisengageConfig)
│       ├── DisengageConfig
│       │   ├── enabled (boolean, default: true)
│       │   └── consumesAction (boolean, default: true)
│       ├── InitiativeConfig
│       │   ├── baseAttribute (enum: wits, finesse, default: wits)
│       │   ├── diceExpression (string, dice notation)
│       │   ├── tieBreaker (enum: HigherAttribute, Random, PlayerFirst)
│       │   └── surpriseRoundBonus (integer, optional)
│       └── DeathConfig
│           ├── unconsciousThreshold (integer, default: 0)
│           ├── deathThreshold (integer or null, default: -10)
│           ├── deathSavesEnabled (boolean, default: false)
│           ├── deathSaveSuccesses (integer, minimum: 1)
│           └── deathSaveFailures (integer, minimum: 1)
├── Validation Rules
│   ├── Tie Breaker Enum Validation
│   ├── Base Attribute Enum Validation
│   ├── Bonus Range Validation (minimum: 0)
│   ├── Threshold Value Validation
│   └── Boolean Field Validation
└── Configuration Updates
    └── combat.json expanded with initiative and death sections
```

---

## 3. Architecture Diagrams

### 3.1 Schema Validation Flow

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                         SCHEMA VALIDATION FLOW                               │
└─────────────────────────────────────────────────────────────────────────────┘

    User edits combat.json
           │
           ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                          IDE/EDITOR                                          │
├─────────────────────────────────────────────────────────────────────────────┤
│  1. Reads $schema property from config file                                  │
│  2. Loads combat.schema.json from config/schemas/                            │
│  3. Validates content against schema                                         │
└─────────────────────────────────────────────────────────────────────────────┘
           │
           ├─── Valid ───▶ Green checkmark, autocomplete works
           │
           └─── Invalid ─▶ Error underlines with messages:
                           • "tieBreaker must be one of: HigherAttribute, ..."
                           • "attackBonus must be >= 0"
                           • "deathSaveSuccesses must be >= 1"
                           • "baseAttribute must be one of: wits, finesse"
```

### 3.2 Combat Schema Structure Diagram

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                          combat.schema.json                                  │
├─────────────────────────────────────────────────────────────────────────────┤
│  $schema: "http://json-schema.org/draft-07/schema#"                         │
│  title: "Combat Rules Configuration"                                        │
│  type: object                                                                │
├─────────────────────────────────────────────────────────────────────────────┤
│  properties:                                                                 │
│  ┌─────────────────────────┬─────────────────────────────────────────────┐  │
│  │ $schema                 │ type: string (optional)                     │  │
│  ├─────────────────────────┼─────────────────────────────────────────────┤  │
│  │ version                 │ type: string (optional)                     │  │
│  ├─────────────────────────┼─────────────────────────────────────────────┤  │
│  │ flanking                │ type: object, $ref FlankingConfig           │  │
│  ├─────────────────────────┼─────────────────────────────────────────────┤  │
│  │ opportunityAttacks      │ type: object, $ref OpportunityAttackConfig  │  │
│  ├─────────────────────────┼─────────────────────────────────────────────┤  │
│  │ initiative              │ type: object, $ref InitiativeConfig         │  │
│  ├─────────────────────────┼─────────────────────────────────────────────┤  │
│  │ death                   │ type: object, $ref DeathConfig              │  │
│  └─────────────────────────┴─────────────────────────────────────────────┘  │
├─────────────────────────────────────────────────────────────────────────────┤
│  definitions:                                                                │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │ FlankingConfig                                                       │    │
│  │ ┌───────────────────────┬───────────────────────────────────────┐   │    │
│  │ │ enabled               │ boolean, default: true                 │   │    │
│  │ │ attackBonus           │ integer, minimum: 0                    │   │    │
│  │ │ damageBonus           │ integer, minimum: 0                    │   │    │
│  │ │ behindAttackBonus     │ integer, minimum: 0 (optional)         │   │    │
│  │ │ behindDamageBonus     │ integer, minimum: 0 (optional)         │   │    │
│  │ └───────────────────────┴───────────────────────────────────────┘   │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │ OpportunityAttackConfig                                              │    │
│  │ ┌───────────────────────┬───────────────────────────────────────┐   │    │
│  │ │ enabled               │ boolean, default: true                 │   │    │
│  │ │ requiresMeleeWeapon   │ boolean, default: true                 │   │    │
│  │ │ oneReactionPerRound   │ boolean, default: true                 │   │    │
│  │ │ disengage             │ $ref DisengageConfig                   │   │    │
│  │ └───────────────────────┴───────────────────────────────────────┘   │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │ DisengageConfig                                                      │    │
│  │ ┌───────────────────────┬───────────────────────────────────────┐   │    │
│  │ │ enabled               │ boolean, default: true                 │   │    │
│  │ │ consumesAction        │ boolean, default: true                 │   │    │
│  │ └───────────────────────┴───────────────────────────────────────┘   │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │ InitiativeConfig                                                     │    │
│  │ ┌───────────────────────┬───────────────────────────────────────┐   │    │
│  │ │ baseAttribute         │ enum: wits, finesse (default: wits)   │   │    │
│  │ │ diceExpression        │ string (dice notation)                 │   │    │
│  │ │ tieBreaker            │ enum: HigherAttribute, Random,         │   │    │
│  │ │                       │       PlayerFirst                      │   │    │
│  │ │ surpriseRoundBonus    │ integer (optional)                     │   │    │
│  │ └───────────────────────┴───────────────────────────────────────┘   │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │ DeathConfig                                                          │    │
│  │ ┌───────────────────────┬───────────────────────────────────────┐   │    │
│  │ │ unconsciousThreshold  │ integer, default: 0                    │   │    │
│  │ │ deathThreshold        │ integer or null, default: -10          │   │    │
│  │ │ deathSavesEnabled     │ boolean, default: false                │   │    │
│  │ │ deathSaveSuccesses    │ integer, minimum: 1                    │   │    │
│  │ │ deathSaveFailures     │ integer, minimum: 1                    │   │    │
│  │ └───────────────────────┴───────────────────────────────────────┘   │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 3.3 Flanking Positions Diagram

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                          FLANKING POSITIONS                                  │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  STANDARD FLANKING (attackBonus + damageBonus)                               │
│                                                                              │
│                    [Enemy]                                                   │
│                       │                                                      │
│                  ┌────┼────┐                                                 │
│                  │    │    │                                                 │
│             [Ally A]  │  [Ally B]                                            │
│                       │                                                      │
│         ───────────────────────────                                          │
│         Allies on opposite sides                                             │
│         Both gain: +attackBonus to hit                                       │
│                    +damageBonus to damage                                    │
│                                                                              │
│  BEHIND ATTACK (behindAttackBonus + behindDamageBonus)                       │
│                                                                              │
│                    [Enemy]                                                   │
│                       │                                                      │
│                       │ (facing forward)                                     │
│                       │                                                      │
│                       ▼                                                      │
│                    [Ally]                                                    │
│                                                                              │
│         ───────────────────────────                                          │
│         Ally directly behind enemy                                           │
│         Gains: +behindAttackBonus to hit                                     │
│                +behindDamageBonus to damage                                  │
│                                                                              │
│  BONUS STACKING                                                              │
│  ┌──────────────────────────────────────────────────────────────────────┐   │
│  │ Standard flank: attackBonus + damageBonus                            │   │
│  │ Behind position: behindAttackBonus + behindDamageBonus               │   │
│  │ If both conditions met: all bonuses may stack (per game rules)       │   │
│  └──────────────────────────────────────────────────────────────────────┘   │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 3.4 Opportunity Attack Flow Diagram

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                       OPPORTUNITY ATTACK FLOW                                │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  Enemy attempts to leave threatened area                                     │
│           │                                                                  │
│           ▼                                                                  │
│  ┌─────────────────────────────────────────────┐                            │
│  │ opportunityAttacks.enabled == true?          │                            │
│  └───────────────┬─────────────────────────────┘                            │
│           │                                                                  │
│     No ───┤─── Yes                                                           │
│     │           │                                                            │
│     ▼           ▼                                                            │
│  Enemy      ┌─────────────────────────────────────────────┐                 │
│  moves      │ Did enemy use Disengage action?              │                 │
│  freely     └───────────────┬─────────────────────────────┘                 │
│                      │                                                       │
│                Yes ───┤─── No                                                │
│                │           │                                                 │
│                ▼           ▼                                                 │
│           Enemy      ┌─────────────────────────────────────────────┐        │
│           escapes    │ requiresMeleeWeapon == true?                 │        │
│           safely     └───────────────┬─────────────────────────────┘        │
│                               │                                              │
│                         No ───┤─── Yes                                       │
│                         │           │                                        │
│                         ▼           ▼                                        │
│                    Opportunity  ┌─────────────────────────────────────────┐ │
│                    attack       │ Attacker has melee weapon equipped?     │ │
│                    triggers     └───────────────┬─────────────────────────┘ │
│                                          │                                   │
│                                    No ───┤─── Yes                            │
│                                    │           │                             │
│                                    ▼           ▼                             │
│                                 No attack  ┌─────────────────────────────┐  │
│                                 available  │ oneReactionPerRound == true? │  │
│                                            └───────────────┬─────────────┘  │
│                                                     │                        │
│                                               No ───┤─── Yes                 │
│                                               │           │                  │
│                                               ▼           ▼                  │
│                                          Unlimited   ┌──────────────────┐   │
│                                          reactions   │ Has reaction     │   │
│                                                      │ remaining?       │   │
│                                                      └────────┬─────────┘   │
│                                                         │                    │
│                                                   No ───┤─── Yes             │
│                                                   │           │              │
│                                                   ▼           ▼              │
│                                                No OA     OPPORTUNITY         │
│                                                          ATTACK              │
│                                                          TRIGGERS            │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 3.5 Initiative Calculation Diagram

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                       INITIATIVE CALCULATION                                 │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  FORMULA                                                                     │
│  ┌──────────────────────────────────────────────────────────────────────┐   │
│  │ Initiative = diceExpression + baseAttribute modifier + bonuses       │   │
│  └──────────────────────────────────────────────────────────────────────┘   │
│                                                                              │
│  EXAMPLE (with config: baseAttribute: "wits", diceExpression: "1d20")        │
│                                                                              │
│     Character: Wits = 14 (modifier +2)                                       │
│     Roll: 1d20 = 15                                                          │
│     Initiative = 15 + 2 = 17                                                 │
│                                                                              │
│  TIE BREAKER OPTIONS                                                         │
│  ┌──────────────────┬────────────────────────────────────────────────────┐  │
│  │ HigherAttribute  │ Higher base attribute wins the tie                 │  │
│  │                  │ Example: Wits 14 beats Wits 12                     │  │
│  ├──────────────────┼────────────────────────────────────────────────────┤  │
│  │ Random           │ Random selection among tied combatants             │  │
│  │                  │ 50/50 chance for each                              │  │
│  ├──────────────────┼────────────────────────────────────────────────────┤  │
│  │ PlayerFirst      │ Player characters always win ties vs NPCs          │  │
│  │                  │ If both players tied, use secondary tie breaker    │  │
│  └──────────────────┴────────────────────────────────────────────────────┘  │
│                                                                              │
│  SURPRISE ROUND                                                              │
│  ┌──────────────────────────────────────────────────────────────────────┐   │
│  │ If surpriseRoundBonus configured:                                    │   │
│  │   Surprised combatants: -surpriseRoundBonus to initiative            │   │
│  │   Ambushing combatants: Normal initiative                            │   │
│  │                                                                      │   │
│  │ Example: surpriseRoundBonus: 10                                      │   │
│  │   Ambusher: Initiative 17                                            │   │
│  │   Surprised: Initiative 17 - 10 = 7                                  │   │
│  └──────────────────────────────────────────────────────────────────────┘   │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 3.6 Death and Unconscious System Diagram

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                    DEATH AND UNCONSCIOUS SYSTEM                              │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  HP THRESHOLD SCALE (with default values)                                    │
│                                                                              │
│  Max HP                                                                      │
│    │                                                                         │
│    │   ══════════════════════════════════════════  CONSCIOUS                 │
│    │   (Normal gameplay, all actions available)                              │
│    │                                                                         │
│    ▼ ─────────────────────────────────────────────────────────────────────   │
│    0  unconsciousThreshold (default: 0)                                      │
│    │                                                                         │
│    │   ══════════════════════════════════════════  UNCONSCIOUS               │
│    │   (Incapacitated, no actions)                                           │
│    │   If deathSavesEnabled: rolling death saves                             │
│    │                                                                         │
│    ▼ ─────────────────────────────────────────────────────────────────────   │
│  -10  deathThreshold (default: -10, or null for instant death at 0)          │
│    │                                                                         │
│    │   ══════════════════════════════════════════  DEAD                      │
│    │   (Character is permanently dead)                                       │
│    ▼                                                                         │
│                                                                              │
│  DEATH SAVES (when deathSavesEnabled: true)                                  │
│  ┌──────────────────────────────────────────────────────────────────────┐   │
│  │ Each turn while unconscious:                                         │   │
│  │                                                                      │   │
│  │   Roll d20:                                                          │   │
│  │   • 10+ = Success                                                    │   │
│  │   • <10 = Failure                                                    │   │
│  │   • Natural 20 = Regain 1 HP, wake up                                │   │
│  │   • Natural 1 = 2 failures                                           │   │
│  │                                                                      │   │
│  │   Accumulate:                                                        │   │
│  │   • deathSaveSuccesses (default: 3) → Stabilize                      │   │
│  │   • deathSaveFailures (default: 3) → Die                             │   │
│  │                                                                      │   │
│  │   Additional damage while unconscious:                               │   │
│  │   • Any damage = 1 failure                                           │   │
│  │   • Critical hit damage = 2 failures                                 │   │
│  └──────────────────────────────────────────────────────────────────────┘   │
│                                                                              │
│  ALTERNATIVE CONFIGURATIONS                                                  │
│  ┌──────────────────────────────────────────────────────────────────────┐   │
│  │ Instant Death (harsh):                                               │   │
│  │   deathThreshold: null, deathSavesEnabled: false                     │   │
│  │   Character dies immediately at 0 HP                                 │   │
│  │                                                                      │   │
│  │ Forgiving System:                                                    │   │
│  │   deathThreshold: -20, deathSavesEnabled: true,                      │   │
│  │   deathSaveSuccesses: 2, deathSaveFailures: 4                        │   │
│  │   More buffer, easier to stabilize                                   │   │
│  │                                                                      │   │
│  │ Hardcore Mode:                                                       │   │
│  │   deathThreshold: -5, deathSavesEnabled: true,                       │   │
│  │   deathSaveSuccesses: 3, deathSaveFailures: 2                        │   │
│  │   Less buffer, harder to stabilize                                   │   │
│  └──────────────────────────────────────────────────────────────────────┘   │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 3.7 File Layer Diagram

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                            CONFIG LAYER                                      │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  config/                                                                     │
│  ├── combat.json ◀───────────────────────────────┐                          │
│  │   {                                            │ references              │
│  │     "$schema": "./schemas/combat.schema.json", │                          │
│  │     "flanking": {                              │                          │
│  │       "enabled": true,                         │                          │
│  │       "attackBonus": 2,                        │                          │
│  │       "damageBonus": 0,                        │                          │
│  │       "behindAttackBonus": 2,                  │                          │
│  │       "behindDamageBonus": 2                   │                          │
│  │     },                                         │                          │
│  │     "opportunityAttacks": {                    │                          │
│  │       "enabled": true,                         │                          │
│  │       "requiresMeleeWeapon": true,             │                          │
│  │       "oneReactionPerRound": true,             │                          │
│  │       "disengage": {                           │                          │
│  │         "enabled": true,                       │                          │
│  │         "consumesAction": true                 │                          │
│  │       }                                        │                          │
│  │     },                                         │                          │
│  │     "initiative": { ... },                     │                          │
│  │     "death": { ... }                           │                          │
│  │   }                                            │                          │
│  │                                                │                          │
│  └── schemas/                                     │                          │
│      └── combat.schema.json ─────────────────────┘                          │
│          {                                                                   │
│            "$schema": "http://json-schema.org/draft-07/schema#",            │
│            "definitions": {                                                  │
│              "FlankingConfig": {...},                                        │
│              "OpportunityAttackConfig": {...},                               │
│              "DisengageConfig": {...},                                       │
│              "InitiativeConfig": {...},                                      │
│              "DeathConfig": {...}                                            │
│            }                                                                 │
│          }                                                                   │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 4. Combat Schema Definition

### 4.1 Root Configuration Properties

**File:** `config/schemas/combat.schema.json`

The combat schema follows JSON Schema Draft-07 specification, providing comprehensive validation for combat rules configuration files.

```json
{
    "$schema": "http://json-schema.org/draft-07/schema#",
    "title": "Combat Rules Configuration",
    "description": "Schema for combat mechanics and rules. Defines flanking, opportunity attacks, initiative calculation, and death/unconscious behaviors.",
    "type": "object",
    "properties": {
        "$schema": {
            "type": "string",
            "description": "Reference to the JSON schema file for validation"
        },
        "version": {
            "type": "string",
            "description": "Optional version identifier for the configuration file",
            "pattern": "^[0-9]+\\.[0-9]+\\.[0-9]+$"
        },
        "flanking": {
            "$ref": "#/definitions/FlankingConfig"
        },
        "opportunityAttacks": {
            "$ref": "#/definitions/OpportunityAttackConfig"
        },
        "initiative": {
            "$ref": "#/definitions/InitiativeConfig"
        },
        "death": {
            "$ref": "#/definitions/DeathConfig"
        }
    },
    "additionalProperties": false,
    "definitions": {
        "FlankingConfig": { ... },
        "OpportunityAttackConfig": { ... },
        "DisengageConfig": { ... },
        "InitiativeConfig": { ... },
        "DeathConfig": { ... }
    }
}
```

### 4.2 FlankingConfig Definition

The `FlankingConfig` object defines bonuses for positional advantage in combat.

```json
"FlankingConfig": {
    "type": "object",
    "description": "Configuration for flanking bonuses in tactical combat",
    "properties": {
        "enabled": {
            "type": "boolean",
            "description": "Whether flanking mechanics are enabled",
            "default": true
        },
        "attackBonus": {
            "type": "integer",
            "description": "Bonus to attack rolls when flanking an enemy",
            "minimum": 0,
            "default": 2
        },
        "damageBonus": {
            "type": "integer",
            "description": "Bonus to damage when flanking an enemy",
            "minimum": 0,
            "default": 0
        },
        "behindAttackBonus": {
            "type": "integer",
            "description": "Bonus to attack rolls when attacking from behind",
            "minimum": 0
        },
        "behindDamageBonus": {
            "type": "integer",
            "description": "Bonus to damage when attacking from behind",
            "minimum": 0
        }
    },
    "additionalProperties": false
}
```

### 4.3 OpportunityAttackConfig Definition

The `OpportunityAttackConfig` object defines rules for attacks of opportunity.

```json
"OpportunityAttackConfig": {
    "type": "object",
    "description": "Configuration for opportunity attack rules",
    "properties": {
        "enabled": {
            "type": "boolean",
            "description": "Whether opportunity attacks are enabled",
            "default": true
        },
        "requiresMeleeWeapon": {
            "type": "boolean",
            "description": "Whether opportunity attacks require a melee weapon equipped",
            "default": true
        },
        "oneReactionPerRound": {
            "type": "boolean",
            "description": "Whether combatants are limited to one reaction per round",
            "default": true
        },
        "disengage": {
            "$ref": "#/definitions/DisengageConfig"
        }
    },
    "additionalProperties": false
}
```

### 4.4 DisengageConfig Definition

The `DisengageConfig` object defines how the disengage action works.

```json
"DisengageConfig": {
    "type": "object",
    "description": "Configuration for the disengage action",
    "properties": {
        "enabled": {
            "type": "boolean",
            "description": "Whether the disengage action is available",
            "default": true
        },
        "consumesAction": {
            "type": "boolean",
            "description": "Whether disengaging consumes the character's action",
            "default": true
        }
    },
    "additionalProperties": false
}
```

### 4.5 InitiativeConfig Definition

The `InitiativeConfig` object defines initiative calculation rules.

```json
"InitiativeConfig": {
    "type": "object",
    "description": "Configuration for initiative calculation and turn order",
    "properties": {
        "baseAttribute": {
            "type": "string",
            "description": "The attribute used as the base for initiative calculation",
            "enum": ["wits", "finesse"],
            "default": "wits"
        },
        "diceExpression": {
            "type": "string",
            "description": "Dice notation for initiative roll (e.g., '1d20', '2d6')",
            "pattern": "^[0-9]+d[0-9]+([+-][0-9]+)?$",
            "default": "1d20"
        },
        "tieBreaker": {
            "type": "string",
            "description": "Method for breaking initiative ties",
            "enum": ["HigherAttribute", "Random", "PlayerFirst"],
            "default": "HigherAttribute"
        },
        "surpriseRoundBonus": {
            "type": "integer",
            "description": "Initiative penalty applied to surprised combatants"
        }
    },
    "additionalProperties": false
}
```

### 4.6 DeathConfig Definition

The `DeathConfig` object defines death and unconscious threshold rules.

```json
"DeathConfig": {
    "type": "object",
    "description": "Configuration for death and unconscious mechanics",
    "properties": {
        "unconsciousThreshold": {
            "type": "integer",
            "description": "HP threshold at or below which a character falls unconscious",
            "default": 0
        },
        "deathThreshold": {
            "type": ["integer", "null"],
            "description": "HP threshold at or below which a character dies. Null means instant death at unconscious threshold.",
            "default": -10
        },
        "deathSavesEnabled": {
            "type": "boolean",
            "description": "Whether death saving throws are enabled",
            "default": false
        },
        "deathSaveSuccesses": {
            "type": "integer",
            "description": "Number of successful death saves needed to stabilize",
            "minimum": 1,
            "default": 3
        },
        "deathSaveFailures": {
            "type": "integer",
            "description": "Number of failed death saves before death",
            "minimum": 1,
            "default": 3
        }
    },
    "additionalProperties": false
}
```

---

## 5. Flanking System Configuration

### 5.1 Flanking Positions

The flanking system provides bonuses when allies are in advantageous positions relative to an enemy.

| Position | Description | Requirements |
|----------|-------------|--------------|
| Standard Flank | Two allies on opposite sides | Enemy between two allies |
| Behind Attack | Attacking from enemy's rear | Attacker directly behind enemy's facing |

### 5.2 Flanking Bonuses

Standard flanking bonus values:

| Bonus Type | Default Value | Description |
|------------|---------------|-------------|
| `attackBonus` | 2 | Bonus to attack roll when flanking |
| `damageBonus` | 0 | Bonus to damage when flanking |
| `behindAttackBonus` | 2 | Bonus to attack when behind enemy |
| `behindDamageBonus` | 2 | Bonus to damage when behind enemy |

**Flanking Configuration Example:**

```json
{
    "flanking": {
        "enabled": true,
        "attackBonus": 2,
        "damageBonus": 0,
        "behindAttackBonus": 2,
        "behindDamageBonus": 2
    }
}
```

**Simplified Flanking (no behind bonuses):**

```json
{
    "flanking": {
        "enabled": true,
        "attackBonus": 1,
        "damageBonus": 1
    }
}
```

**Disabled Flanking:**

```json
{
    "flanking": {
        "enabled": false,
        "attackBonus": 0,
        "damageBonus": 0
    }
}
```

---

## 6. Opportunity Attack Configuration

### 6.1 Opportunity Attack Rules

Opportunity attacks trigger when an enemy leaves a threatened area without using the Disengage action.

| Setting | Default | Description |
|---------|---------|-------------|
| `enabled` | `true` | Master switch for opportunity attacks |
| `requiresMeleeWeapon` | `true` | Only melee weapons can make OAs |
| `oneReactionPerRound` | `true` | Limit of one reaction per round |

**Standard Configuration:**

```json
{
    "opportunityAttacks": {
        "enabled": true,
        "requiresMeleeWeapon": true,
        "oneReactionPerRound": true,
        "disengage": {
            "enabled": true,
            "consumesAction": true
        }
    }
}
```

**Simplified Combat (no opportunity attacks):**

```json
{
    "opportunityAttacks": {
        "enabled": false,
        "requiresMeleeWeapon": true,
        "oneReactionPerRound": true,
        "disengage": {
            "enabled": false,
            "consumesAction": false
        }
    }
}
```

### 6.2 Disengage Action

The Disengage action allows safe withdrawal from combat.

| Setting | Default | Description |
|---------|---------|-------------|
| `enabled` | `true` | Whether Disengage action exists |
| `consumesAction` | `true` | Whether it costs the character's action |

**Free Disengage (rogues-only style):**

```json
{
    "disengage": {
        "enabled": true,
        "consumesAction": false
    }
}
```

---

## 7. Initiative System Configuration

### 7.1 Base Attributes

The initiative system supports different base attributes for calculating initiative.

| Attribute | Description | Typical Use |
|-----------|-------------|-------------|
| `wits` | Mental acuity and awareness | Default, rewards perceptive characters |
| `finesse` | Physical dexterity and speed | Rewards agile characters |

### 7.2 Dice Expressions

Dice expressions follow standard notation:

| Expression | Description | Average Roll |
|------------|-------------|--------------|
| `1d20` | Single d20 (D&D style) | 10.5 |
| `2d6` | Two d6 (more predictable) | 7 |
| `1d20+5` | d20 with static bonus | 15.5 |
| `3d6` | Three d6 (bell curve) | 10.5 |

**Pattern:** `^[0-9]+d[0-9]+([+-][0-9]+)?$`

### 7.3 Tie Breakers

When multiple combatants have the same initiative value:

| Tie Breaker | Description | When to Use |
|-------------|-------------|-------------|
| `HigherAttribute` | Higher base attribute wins | Rewards investment in initiative attribute |
| `Random` | Random selection | Fair and unpredictable |
| `PlayerFirst` | Players always win ties vs NPCs | Player-friendly, reduces frustration |

**Standard Initiative Configuration:**

```json
{
    "initiative": {
        "baseAttribute": "wits",
        "diceExpression": "1d20",
        "tieBreaker": "HigherAttribute",
        "surpriseRoundBonus": 10
    }
}
```

**Dexterity-Based Initiative:**

```json
{
    "initiative": {
        "baseAttribute": "finesse",
        "diceExpression": "1d20",
        "tieBreaker": "Random"
    }
}
```

---

## 8. Death and Unconscious Configuration

### 8.1 Health Thresholds

The death system uses HP thresholds to determine character states.

| Threshold | Default | Description |
|-----------|---------|-------------|
| `unconsciousThreshold` | 0 | HP at or below this = unconscious |
| `deathThreshold` | -10 | HP at or below this = dead |

**Threshold Behavior:**

- HP > unconsciousThreshold: Conscious, normal actions
- HP <= unconsciousThreshold AND HP > deathThreshold: Unconscious
- HP <= deathThreshold: Dead
- deathThreshold = null: Instant death at unconscious threshold

### 8.2 Death Saves

When death saves are enabled, unconscious characters roll to stabilize.

| Setting | Default | Description |
|---------|---------|-------------|
| `deathSavesEnabled` | `false` | Master switch for death saves |
| `deathSaveSuccesses` | 3 | Successes needed to stabilize |
| `deathSaveFailures` | 3 | Failures before death |

**Standard Death Save Configuration:**

```json
{
    "death": {
        "unconsciousThreshold": 0,
        "deathThreshold": -10,
        "deathSavesEnabled": true,
        "deathSaveSuccesses": 3,
        "deathSaveFailures": 3
    }
}
```

**Instant Death (Hardcore Mode):**

```json
{
    "death": {
        "unconsciousThreshold": 0,
        "deathThreshold": null,
        "deathSavesEnabled": false
    }
}
```

**Forgiving Death System:**

```json
{
    "death": {
        "unconsciousThreshold": 0,
        "deathThreshold": -20,
        "deathSavesEnabled": true,
        "deathSaveSuccesses": 2,
        "deathSaveFailures": 4
    }
}
```

---

## 9. Validation Rules

### 9.1 Enum Validation

| Property | Valid Values | Validation Error |
|----------|--------------|------------------|
| `baseAttribute` | `wits`, `finesse` | "baseAttribute must be one of: wits, finesse" |
| `tieBreaker` | `HigherAttribute`, `Random`, `PlayerFirst` | "tieBreaker must be one of: HigherAttribute, Random, PlayerFirst" |

### 9.2 Range Validation

| Property | Range | Validation Error |
|----------|-------|------------------|
| `attackBonus` | >= 0 | "attackBonus must be >= 0" |
| `damageBonus` | >= 0 | "damageBonus must be >= 0" |
| `behindAttackBonus` | >= 0 | "behindAttackBonus must be >= 0" |
| `behindDamageBonus` | >= 0 | "behindDamageBonus must be >= 0" |
| `deathSaveSuccesses` | >= 1 | "deathSaveSuccesses must be >= 1" |
| `deathSaveFailures` | >= 1 | "deathSaveFailures must be >= 1" |

### 9.3 Required Fields

#### FlankingConfig Required Fields

All fields are optional with defaults.

#### OpportunityAttackConfig Required Fields

All fields are optional with defaults.

#### DisengageConfig Required Fields

All fields are optional with defaults.

#### InitiativeConfig Required Fields

All fields are optional with defaults.

#### DeathConfig Required Fields

All fields are optional with defaults.

### 9.4 Pattern Validation

| Property | Pattern | Validation Error |
|----------|---------|------------------|
| `diceExpression` | `^[0-9]+d[0-9]+([+-][0-9]+)?$` | "diceExpression must match pattern (e.g., '1d20', '2d6+3')" |
| `version` | `^[0-9]+\\.[0-9]+\\.[0-9]+$` | "version must match pattern (e.g., '1.0.0')" |

---

## 10. Configuration Schema

### Complete Combat Schema File

**File:** `config/schemas/combat.schema.json`

```json
{
    "$schema": "http://json-schema.org/draft-07/schema#",
    "title": "Combat Rules Configuration",
    "description": "Schema for combat mechanics and rules. Defines flanking, opportunity attacks, initiative calculation, and death/unconscious behaviors.",
    "type": "object",
    "properties": {
        "$schema": {
            "type": "string",
            "description": "Reference to the JSON schema file for validation"
        },
        "version": {
            "type": "string",
            "description": "Optional version identifier for the configuration file",
            "pattern": "^[0-9]+\\.[0-9]+\\.[0-9]+$"
        },
        "flanking": {
            "$ref": "#/definitions/FlankingConfig"
        },
        "opportunityAttacks": {
            "$ref": "#/definitions/OpportunityAttackConfig"
        },
        "initiative": {
            "$ref": "#/definitions/InitiativeConfig"
        },
        "death": {
            "$ref": "#/definitions/DeathConfig"
        }
    },
    "additionalProperties": false,
    "definitions": {
        "FlankingConfig": {
            "type": "object",
            "description": "Configuration for flanking bonuses in tactical combat",
            "properties": {
                "enabled": {
                    "type": "boolean",
                    "description": "Whether flanking mechanics are enabled",
                    "default": true
                },
                "attackBonus": {
                    "type": "integer",
                    "description": "Bonus to attack rolls when flanking an enemy",
                    "minimum": 0,
                    "default": 2
                },
                "damageBonus": {
                    "type": "integer",
                    "description": "Bonus to damage when flanking an enemy",
                    "minimum": 0,
                    "default": 0
                },
                "behindAttackBonus": {
                    "type": "integer",
                    "description": "Bonus to attack rolls when attacking from behind",
                    "minimum": 0
                },
                "behindDamageBonus": {
                    "type": "integer",
                    "description": "Bonus to damage when attacking from behind",
                    "minimum": 0
                }
            },
            "additionalProperties": false
        },
        "OpportunityAttackConfig": {
            "type": "object",
            "description": "Configuration for opportunity attack rules",
            "properties": {
                "enabled": {
                    "type": "boolean",
                    "description": "Whether opportunity attacks are enabled",
                    "default": true
                },
                "requiresMeleeWeapon": {
                    "type": "boolean",
                    "description": "Whether opportunity attacks require a melee weapon equipped",
                    "default": true
                },
                "oneReactionPerRound": {
                    "type": "boolean",
                    "description": "Whether combatants are limited to one reaction per round",
                    "default": true
                },
                "disengage": {
                    "$ref": "#/definitions/DisengageConfig"
                }
            },
            "additionalProperties": false
        },
        "DisengageConfig": {
            "type": "object",
            "description": "Configuration for the disengage action",
            "properties": {
                "enabled": {
                    "type": "boolean",
                    "description": "Whether the disengage action is available",
                    "default": true
                },
                "consumesAction": {
                    "type": "boolean",
                    "description": "Whether disengaging consumes the character's action",
                    "default": true
                }
            },
            "additionalProperties": false
        },
        "InitiativeConfig": {
            "type": "object",
            "description": "Configuration for initiative calculation and turn order",
            "properties": {
                "baseAttribute": {
                    "type": "string",
                    "description": "The attribute used as the base for initiative calculation",
                    "enum": ["wits", "finesse"],
                    "default": "wits"
                },
                "diceExpression": {
                    "type": "string",
                    "description": "Dice notation for initiative roll (e.g., '1d20', '2d6')",
                    "pattern": "^[0-9]+d[0-9]+([+-][0-9]+)?$",
                    "default": "1d20"
                },
                "tieBreaker": {
                    "type": "string",
                    "description": "Method for breaking initiative ties",
                    "enum": ["HigherAttribute", "Random", "PlayerFirst"],
                    "default": "HigherAttribute"
                },
                "surpriseRoundBonus": {
                    "type": "integer",
                    "description": "Initiative penalty applied to surprised combatants"
                }
            },
            "additionalProperties": false
        },
        "DeathConfig": {
            "type": "object",
            "description": "Configuration for death and unconscious mechanics",
            "properties": {
                "unconsciousThreshold": {
                    "type": "integer",
                    "description": "HP threshold at or below which a character falls unconscious",
                    "default": 0
                },
                "deathThreshold": {
                    "type": ["integer", "null"],
                    "description": "HP threshold at or below which a character dies. Null means instant death at unconscious threshold.",
                    "default": -10
                },
                "deathSavesEnabled": {
                    "type": "boolean",
                    "description": "Whether death saving throws are enabled",
                    "default": false
                },
                "deathSaveSuccesses": {
                    "type": "integer",
                    "description": "Number of successful death saves needed to stabilize",
                    "minimum": 1,
                    "default": 3
                },
                "deathSaveFailures": {
                    "type": "integer",
                    "description": "Number of failed death saves before death",
                    "minimum": 1,
                    "default": 3
                }
            },
            "additionalProperties": false
        }
    }
}
```

---

## 11. Configuration File Updates

### Updated combat.json

The existing `combat.json` needs to be expanded with schema reference, initiative configuration, and death configuration.

**File:** `config/combat.json`

Current structure (flanking and opportunity attacks only):
```json
{
    "flanking": {
        "enabled": true,
        "attackBonus": 2,
        "damageBonus": 0,
        "behindAttackBonus": 2,
        "behindDamageBonus": 2
    },
    "opportunityAttacks": {
        "enabled": true,
        "requiresMeleeWeapon": true,
        "oneReactionPerRound": true,
        "disengage": {
            "enabled": true,
            "consumesAction": true
        }
    }
}
```

Expanded with schema reference, initiative, and death sections:
```json
{
    "$schema": "./schemas/combat.schema.json",
    "flanking": {
        "enabled": true,
        "attackBonus": 2,
        "damageBonus": 0,
        "behindAttackBonus": 2,
        "behindDamageBonus": 2
    },
    "opportunityAttacks": {
        "enabled": true,
        "requiresMeleeWeapon": true,
        "oneReactionPerRound": true,
        "disengage": {
            "enabled": true,
            "consumesAction": true
        }
    },
    "initiative": {
        "baseAttribute": "wits",
        "diceExpression": "1d20",
        "tieBreaker": "HigherAttribute",
        "surpriseRoundBonus": 10
    },
    "death": {
        "unconsciousThreshold": 0,
        "deathThreshold": -10,
        "deathSavesEnabled": false,
        "deathSaveSuccesses": 3,
        "deathSaveFailures": 3
    }
}
```

### Validation Confirmation

The existing configuration validates successfully against the schema after adding the $schema reference:

| Section | Current Properties | Valid |
|---------|-------------------|-------|
| `flanking` | enabled, attackBonus, damageBonus, behindAttackBonus, behindDamageBonus | Yes |
| `opportunityAttacks` | enabled, requiresMeleeWeapon, oneReactionPerRound, disengage | Yes |
| `opportunityAttacks.disengage` | enabled, consumesAction | Yes |
| `initiative` | (new section) | Yes |
| `death` | (new section) | Yes |

---

## 12. Data Model Changes

### No Domain Changes Required

This phase creates only a JSON Schema file for validation. No changes to domain entities, services, or application layer are required.

| Layer | Changes |
|-------|---------|
| Domain | None |
| Application | None |
| Infrastructure | None |
| Configuration | One schema file added, one config file expanded |

### Schema as Documentation

The schema serves as:
- **Validation contract** for combat rules configuration
- **IDE documentation** via description fields
- **Modding reference** for custom combat systems
- **Design specification** for tactical combat mechanics

---

## 13. Logging Specifications

### No Runtime Logging Required

Schema validation occurs at design-time in IDE/editors, not at runtime. No logging infrastructure changes are needed for this phase.

| Component | Level | Events |
|-----------|-------|--------|
| N/A | N/A | Schema validation is IDE-based |

---

## 14. Unit Testing Requirements

### Test Count by Feature

| Feature | Test Count |
|---------|------------|
| Schema Valid Structure | ~1 |
| Flanking Config Validation | ~1 |
| Opportunity Attack Config Validation | ~1 |
| Initiative Tie Breaker Enum Validation | ~1 |
| Death Threshold Null Validation | ~1 |
| Existing Configuration Validation | ~1 |
| **Total** | **~6** |

### Test Descriptions

#### CombatSchemaTests.cs

```csharp
[TestFixture]
public class CombatSchemaTests
{
    /// <summary>
    /// Verifies the schema file is valid JSON Schema Draft-07.
    /// </summary>
    [Test]
    public void Schema_IsValidJsonSchemaDraft07();

    /// <summary>
    /// Verifies the existing combat.json validates against the schema without errors.
    /// </summary>
    [Test]
    public void ExistingCombatJson_ValidatesAgainstSchema();

    /// <summary>
    /// Verifies flanking config validates bonus ranges (minimum: 0).
    /// </summary>
    [Test]
    public void FlankingConfig_NegativeBonus_FailsValidation();

    /// <summary>
    /// Verifies tieBreaker must be a valid enum value (HigherAttribute, Random, PlayerFirst).
    /// </summary>
    [Test]
    public void TieBreaker_InvalidEnumValue_FailsValidation();

    /// <summary>
    /// Verifies death threshold allows null value for instant death mode.
    /// </summary>
    [Test]
    public void DeathThreshold_NullValue_PassesValidation();

    /// <summary>
    /// Verifies disengage nested config validates correctly within opportunityAttacks.
    /// </summary>
    [Test]
    public void DisengageConfig_NestedInOpportunityAttacks_ValidatesCorrectly();
}
```

### Test Implementation Notes

Tests should use a JSON Schema validation library (e.g., `NJsonSchema` for C#) to:
1. Load the schema file
2. Validate test JSON documents
3. Assert expected validation results

---

## 15. Use Cases

### UC-001: Load Combat Configuration

**Actor:** Game System
**Flow:** System starts -> Loads `combat.json` -> Schema validates content -> Combat rules available for combat resolution

### UC-002: Edit Combat Rules in IDE

**Actor:** Developer/Modder
**Flow:** Opens `combat.json` in VS Code -> IDE loads schema -> Autocomplete suggests properties -> Validation errors shown inline

### UC-003: Disable Opportunity Attacks

**Actor:** Modder
**Flow:** Sets `opportunityAttacks.enabled` to `false` -> IDE validates boolean -> Saves file -> Combat system skips OA logic

### UC-004: Configure Death Saves

**Actor:** Modder
**Flow:** Sets `deathSavesEnabled` to `true` -> Configures `deathSaveSuccesses` and `deathSaveFailures` -> IDE validates integers >= 1

### UC-005: Invalid Tie Breaker Value

**Actor:** Modder
**Flow:** Sets `tieBreaker` to `"Fastest"` -> IDE shows error "tieBreaker must be one of: HigherAttribute, Random, PlayerFirst" -> Modder corrects to `"Random"`

### UC-006: Instant Death Mode

**Actor:** Modder
**Flow:** Sets `deathThreshold` to `null` -> IDE validates as null or integer -> Sets `deathSavesEnabled` to `false` -> Instant death at 0 HP configured

---

## 16. Deliverable Checklist

### Schema Files
- [ ] `config/schemas/combat.schema.json` created
- [ ] Schema follows JSON Schema Draft-07 format
- [ ] Schema includes all defined properties
- [ ] Schema includes definitions section (FlankingConfig, OpportunityAttackConfig, DisengageConfig, InitiativeConfig, DeathConfig)

### Validation Rules
- [ ] Tie breaker enum validation: HigherAttribute, Random, PlayerFirst
- [ ] Base attribute enum validation: wits, finesse
- [ ] Bonus range validation: minimum 0
- [ ] Death save count validation: minimum 1
- [ ] Death threshold allows null or integer
- [ ] Boolean fields validated
- [ ] Dice expression pattern validated
- [ ] Optional fields have defaults

### Configuration Updates
- [ ] `combat.json` $schema reference added as `./schemas/combat.schema.json`
- [ ] `combat.json` expanded with initiative section
- [ ] `combat.json` expanded with death section
- [ ] Existing `combat.json` validates against schema

### Testing
- [ ] ~6 unit tests implemented
- [ ] All tests passing
- [ ] Tests cover happy path and error cases

### Documentation
- [ ] Schema properties have descriptions
- [ ] This design specification complete

---

## 17. Acceptance Criteria

### Functional
- [ ] `combat.schema.json` created in `config/schemas/` directory
- [ ] Schema validates existing `combat.json` without errors
- [ ] Flanking config validates bonus ranges (minimum: 0)
- [ ] Opportunity attack config validates boolean fields
- [ ] Disengage nested config validates correctly
- [ ] Initiative attribute enum validated (wits, finesse)
- [ ] Initiative tie breaker enum validated (HigherAttribute, Random, PlayerFirst)
- [ ] Dice expression pattern validated
- [ ] Death threshold allows negative values or null
- [ ] Death save counts validated (minimum: 1)
- [ ] VS Code provides autocomplete when schema linked

### Quality
- [ ] Build succeeds with 0 errors
- [ ] Build succeeds with 0 warnings
- [ ] ~6 unit tests pass
- [ ] Schema file is valid JSON
- [ ] All schema properties have descriptions

---

## 18. Dependencies

### Required from Prior Versions

| Type | Location | Usage in this phase |
|------|----------|---------------------|
| `combat.json` | `config/combat.json` | Validated and expanded by new schema |
| Schema patterns | `config/schemas/*.schema.json` | Reference for schema structure |
| Attribute system | v0.14.0 | Initiative baseAttribute references (wits, finesse) |

### Provides to Future Versions

| Type | Usage |
|------|-------|
| `combat.schema.json` | Validates combat rules configuration |
| FlankingConfig pattern | Used by combat system for positional bonuses |
| InitiativeConfig pattern | Used by turn order system |
| DeathConfig pattern | Used by health and death system |
| Tie breaker options | Used by initiative resolver |
| Death save mechanics | Used by unconscious state handler |

### Implementation Order Note

**v0.14.1d can be implemented in parallel with other v0.14.1 parts** (a, b, c) as they have no internal dependencies.

Complete v0.14.1 implementation order options:
- All parts can be implemented in parallel
- Or sequentially in any order: v0.14.1a -> v0.14.1b -> v0.14.1c -> v0.14.1d

---

## 19. Future Considerations

### Deferred to Future Versions

- **Runtime schema validation**: Application-level validation at load time (handled by existing provider patterns)
- **Schema versioning migration**: Automatic migration between schema versions
- **Combat calculation logic**: Runtime mechanics for combat resolution (domain logic, not schema)
- **UI combat display**: How combat rules are shown to players (presentation concern)
- **Balance tuning**: Specific bonus values (design decisions)

### Out of Scope

- **Advanced initiative systems**: Side-based initiative, popcorn initiative
- **Complex death mechanics**: Resurrection, soul mechanics, permadeath settings
- **Cover system**: Partial cover, full cover, destructible cover
- **Terrain effects**: Difficult terrain, hazardous terrain
- **Weather effects**: Weather-based combat modifiers

### Potential Future Enhancements

If the combat system expands, consider adding to the schema:

**Cover System:**
```json
"cover": {
    "enabled": true,
    "halfCoverBonus": 2,
    "threequartersCoverBonus": 5,
    "fullCoverBlocks": true
}
```

**Terrain Configuration:**
```json
"terrain": {
    "difficultTerrainCost": 2,
    "hazardousDamagePerTurn": 5
}
```

**Combat Timing:**
```json
"timing": {
    "turnTimeLimitSeconds": 60,
    "roundTimeLimitSeconds": 300,
    "allowPausing": true
}
```

**Critical Hits:**
```json
"criticalHits": {
    "enabled": true,
    "naturalCritRange": 20,
    "critMultiplier": 2,
    "confirmationRequired": false
}
```

---

*Document Version: 1.0*
*Last Updated: 2026-01-17*
*Author: Claude*
