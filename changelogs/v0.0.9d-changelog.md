# v0.0.9d Changelog - Loot & Currency

**Date:** 2026-01-08

## Summary

Implements the Loot & Currency system for Rune and Rust. Monsters now drop loot (items and currency) when defeated, with drop rates and quantities defined in their loot tables. The Player can track currency (Gold), and Rooms can store dropped loot for collection. This is the final sub-phase of v0.0.9 (Monster Variety & Loot).

## Added

### Domain Layer - Value Objects (New)

- `LootEntry` readonly record struct:
  - Properties: ItemId, Weight, MinQuantity, MaxQuantity, DropChance
  - Factory `Create()` method with validation

- `CurrencyDrop` readonly record struct:
  - Properties: CurrencyId, MinAmount, MaxAmount, DropChance
  - Factory `Create()` method with validation

- `DroppedItem` readonly record struct:
  - Properties: ItemId, Name, Quantity
  - Factory `Create()` method

- `LootDrop` readonly record struct:
  - Properties: Items (IReadOnlyList<DroppedItem>), Currency (IReadOnlyDictionary<string, int>)
  - Properties: IsEmpty, HasItems, HasCurrency
  - Static `Empty` property
  - Factory `Create()` method
  - `CombineWith()` method for merging loot drops

### Domain Layer - Definitions (New)

- `CurrencyDefinition` class:
  - Properties: Id, Name, PluralName, Symbol, Color, SortOrder
  - Factory `Create()` method with validation
  - `GetDisplayName(int amount)` method for singular/plural
  - `FormatAmount(int amount)` method for display
  - Static `Gold` property for default currency

- `LootTable` class:
  - Properties: Entries (IReadOnlyList<LootEntry>), CurrencyDrops (IReadOnlyList<CurrencyDrop>)
  - Property: HasEntries
  - Static `Empty` property
  - Factory `Create()` method

### Application Layer - DTOs (New)

- `CurrencyConfigurationDto.cs`:
  - `CurrencyConfiguration` class with Currencies list
  - `CurrencyDefinitionDto` for JSON deserialization

- `LootTableDto.cs`:
  - `LootTableDto` class for loot table deserialization
  - `LootEntryDto` for item drop configuration
  - `CurrencyDropDto` for currency drop configuration

- `LootDropDto.cs`:
  - `LootDropDto` record for presenting loot to UI
  - `DroppedItemDto` record for item display
  - `CurrencyAmountDto` record for currency display
  - Static `FromDomain()` factory method

### Application Layer - Interfaces (New)

- `ILootService` interface:
  - `GenerateLoot(Monster)` - generate loot from defeated monster
  - `GenerateLoot(MonsterDefinition, float)` - generate with custom multiplier
  - `CollectLoot(Player, Room)` - collect dropped loot
  - `GetCurrency(string)` - get currency definition
  - `GetAllCurrencies()` - get all currency definitions

### Application Layer - Services (New)

- `LootService` class:
  - Implements `ILootService`
  - Weighted random item selection using drop chances
  - Tier-based loot multiplier support (uses Monster.LootMultiplier)
  - Currency amount calculation with multiplier
  - Internal constructor with explicit Random for testing

### Configuration (New)

- `config/currency.json`:
  - Gold currency definition with symbol "G" and yellow color

## Modified

### Domain Layer - Definitions

- `MonsterDefinition` class:
  - Added `LootTable` property (LootTable?)
  - Updated `Create()` factory with lootTable parameter

### Domain Layer - Entities

- `Player` entity:
  - Added `_currency` private field (Dictionary<string, int>)
  - Added `Currency` property (IReadOnlyDictionary<string, int>)
  - Added `GetCurrency(string)` method
  - Added `AddCurrency(string, int)` method
  - Added `RemoveCurrency(string, int)` method (returns bool)
  - Added `CanAfford(string, int)` method

- `Room` entity:
  - Added `_droppedItems` private field (List<DroppedItem>)
  - Added `_droppedCurrency` private field (Dictionary<string, int>)
  - Added `DroppedItems` property (IReadOnlyList<DroppedItem>)
  - Added `DroppedCurrency` property (IReadOnlyDictionary<string, int>)
  - Added `HasDroppedLoot` property
  - Added `AddLoot(LootDrop)` method
  - Added `CollectAllLoot()` method
  - Added `ClearDroppedLoot()` method

### Application Layer - Interfaces

- `IGameConfigurationProvider` interface:
  - Added `GetCurrencies()` method
  - Added `GetCurrencyById(string)` method

- `IGameRenderer` interface:
  - Added `RenderLootDropAsync(LootDropDto, CancellationToken)` method

### Application Layer - Services

- `GameSessionService` class:
  - Added `_lootService` field (ILootService)
  - Updated constructor with ILootService parameter
  - Updated `TryAttack()` return type to include LootDropDto
  - Added loot generation on monster defeat
  - Added loot drop to current room

### Infrastructure Layer - Configuration

- `JsonConfigurationProvider` class:
  - Added `_currencies` caching field
  - Added `GetCurrencies()` method
  - Added `GetCurrencyById()` method
  - Added `ToCurrencyDefinition()` mapper
  - Added `GetDefaultCurrencies()` fallback
  - Added `ToLootTable()` mapper
  - Added JSON config classes for currency and loot tables
  - Updated `MonsterDefinitionJsonConfig` with LootTable property

### Infrastructure Layer - DI

- `DependencyInjection` class:
  - Registered `ILootService` -> `LootService`

### Presentation Layer

- `SpectreGameRenderer` class:
  - Added `RenderLootDropAsync()` method with formatted output
  - Displays currency with color coding
  - Displays items with quantities
  - Shows collection hint

- `GameView` class:
  - Updated `HandleAttackAsync()` to handle loot drops
  - Calls `RenderLootDropAsync()` when loot is generated

### Configuration

- `config/monsters.json`:
  - Added `lootTable` to all 5 monsters with entries and currencyDrops
  - Goblin: 5-15 gold (80%), health_potion (15%), rusty_dagger (5%)
  - Skeleton: 8-20 gold (90%), bone_dust (30%), ancient_coin (10%)
  - Orc: 15-35 gold (100%), health_potion (25%), iron_sword (10%), orcish_helm (5%)
  - Goblin Shaman: 10-25 gold (85%), mana_potion (20%), fetish_charm (10%)
  - Slime: 1-5 gold (30%), slime_residue (50%)

## Test Results

```
Domain Tests:      578 passed
Application Tests: 148 passed
Architecture Tests:  8 passed
Total:             734 passed
```

## Loot System

### Currency Definitions

| ID | Name | Plural | Symbol | Color |
|----|------|--------|--------|-------|
| gold | Gold | Gold | G | yellow |

### Loot Drop Examples

| Monster | Gold Range | Gold Chance | Notable Items |
|---------|------------|-------------|---------------|
| Goblin | 5-15 | 80% | health_potion (15%) |
| Skeleton | 8-20 | 90% | bone_dust (30%) |
| Orc | 15-35 | 100% | iron_sword (10%) |
| Goblin Shaman | 10-25 | 85% | mana_potion (20%) |
| Slime | 1-5 | 30% | slime_residue (50%) |

### Tier Loot Multipliers

The loot system uses the `Monster.LootMultiplier` property from v0.0.9c:

| Tier | Loot Multiplier |
|------|-----------------|
| Common | 1.0x |
| Named | 2.0x |
| Elite | 3.0x |
| Boss | 5.0x |

This means an Elite Orc drops 3x the gold (45-105) and has 3x the item drop chances.

## Files Summary

### New Files (11)
| File | Purpose |
|------|---------|
| `Domain/ValueObjects/LootEntry.cs` | Loot entry configuration |
| `Domain/ValueObjects/CurrencyDrop.cs` | Currency drop configuration |
| `Domain/ValueObjects/DroppedItem.cs` | Dropped item representation |
| `Domain/ValueObjects/LootDrop.cs` | Loot drop result container |
| `Domain/Definitions/CurrencyDefinition.cs` | Currency type definition |
| `Domain/Definitions/LootTable.cs` | Loot table definition |
| `Application/Configuration/CurrencyConfigurationDto.cs` | Currency DTOs |
| `Application/Configuration/LootTableDto.cs` | Loot table DTOs |
| `Application/DTOs/LootDropDto.cs` | Loot display DTO |
| `Application/Interfaces/ILootService.cs` | Loot service interface |
| `Application/Services/LootService.cs` | Loot service implementation |
| `config/currency.json` | Currency definitions |

### Modified Files (10)
| File | Changes |
|------|---------|
| `Domain/Definitions/MonsterDefinition.cs` | +LootTable property |
| `Domain/Entities/Player.cs` | +currency tracking methods |
| `Domain/Entities/Room.cs` | +dropped loot storage and methods |
| `Application/Interfaces/IConfigurationProvider.cs` | +currency methods |
| `Application/Interfaces/IGameRenderer.cs` | +RenderLootDropAsync |
| `Application/Services/GameSessionService.cs` | +loot integration |
| `Infrastructure/Configuration/JsonConfigurationProvider.cs` | +currency/loot loading |
| `Infrastructure/DependencyInjection.cs` | +LootService registration |
| `Presentation.Tui/Adapters/SpectreGameRenderer.cs` | +loot display |
| `Presentation.Tui/Views/GameView.cs` | +loot handling |
| `config/monsters.json` | +lootTable per monster |

## Usage Example

```csharp
// Combat victory generates loot
var (success, message, xp, levelUp, loot) = gameService.TryAttack();

if (loot != null && !loot.IsEmpty)
{
    // Display loot drop
    await renderer.RenderLootDropAsync(loot);

    // Loot is now in the room
    // Player can collect it with:
    var collected = lootService.CollectLoot(player, room);
}

// Check player currency
var gold = player.GetCurrency("gold");
Console.WriteLine($"Gold: {gold}");

// Check if player can afford something
if (player.CanAfford("gold", 100))
{
    player.RemoveCurrency("gold", 100);
    // Purchase successful
}
```

## v0.0.9d Complete

This completes the Loot & Currency system:
- Data-driven currency configuration via JSON
- Data-driven loot tables per monster type
- Tier-based loot multipliers (from v0.0.9c)
- Currency tracking on Player entity
- Dropped loot storage on Room entity
- Loot generation on monster defeat
- Visual loot display in TUI

## v0.0.9 Complete

With v0.0.9d complete, the entire v0.0.9 milestone is finished:
- v0.0.9a: Monster Definitions (data-driven monsters from JSON)
- v0.0.9b: Damage Types & Resistances (elemental damage system)
- v0.0.9c: Monster Tiers & Traits (difficulty scaling and special abilities)
- v0.0.9d: Loot & Currency (drops and player gold)

The game now has a complete monster variety and loot system ready for expansion.
