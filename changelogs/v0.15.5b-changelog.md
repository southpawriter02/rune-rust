# v0.15.5b Changelog - Counter-Tracking System

## Summary

Implements the **Counter-Tracking System** for the Wasteland Survival skill. This subsystem allows characters to conceal their trail from pursuers using various techniques. The concealer's roll becomes the DC that any tracker must beat. Features 5 concealment techniques with additive bonuses (+2 to +8), multiplicative time multipliers (x1.0 to x2.0), environmental requirements for certain techniques, and DC clamping (10-30). Integrates with the Extended Tracking System (v0.15.5a) via contested DC mechanics.

## Added

### Domain Layer - Enums (1 file)

| File | Description |
|------|-------------|
| `ConcealmentTechnique.cs` | 5-value enum for concealment techniques: HardSurfaces (+2, x1.0), BrushTracks (+4, x1.5), FalseTrail (+6, x2.0), WaterCrossing (+8, x1.0), Backtracking (+4, x1.25). Environmental requirements: WaterCrossing requires water nearby, BrushTracks requires foliage or debris. |

### Domain Layer - Value Objects (2 files)

| File | Description |
|------|-------------|
| `CounterTrackingContext.cs` | `readonly record struct` for counter-tracking context. Properties: ConcealerId, TechniquesUsed, EnvironmentId, HasWaterNearby, HasFoliageOrDebris. Computed: HasTechniques, TechniqueCount, ValidTechniqueCount, InvalidTechniqueCount. Methods: `GetTechniqueValidity()`, `IsTechniqueValid()`, `AreAllTechniquesValid()`, `GetInvalidTechniques()`, `GetValidTechniques()`, `ToSkillContext()`, `ToDetailedString()`. Factory methods: `CreateDefault()`, `CreateWithDebris()`, `CreateNearWater()`. |
| `CounterTrackingResult.cs` | `readonly record struct` result container. Properties: ConcealmentDc (clamped 10-30), TotalBonus, NetSuccesses, TimeMultiplier, TechniquesUsed, RollDetails. Computed: IsEffective, EffectivenessRating (Minimal/Moderate/Effective/Excellent), HasTimePenalty, TimePenaltyPercent. Factory methods: `Create()`, `Failed()`. |

### Application Layer - Interface (1 file)

| File | Description |
|------|-------------|
| `ICounterTrackingService.cs` | Service interface: `AttemptConcealmentAsync()`, `CalculateTotalBonus()`, `CalculateTimeMultiplier()`, `ValidateTechniques()`, `GetAvailableTechniques()`, `GetTechniqueBonus()`, `GetTechniqueTimeMultiplier()`, `GetTechniqueDescription()`, `ApplyToTrackingState()`, `ClearFromTrackingState()`. Full XML documentation with examples. |

### Application Layer - Service (1 file)

| File | Description |
|------|-------------|
| `CounterTrackingService.cs` | Full implementation of ICounterTrackingService. Dependencies: SkillCheckService, ILogger. Constants: MinConcealmentDc (10), MaxConcealmentDc (30), technique bonuses (HardSurfacesBonus=2, BrushTracksBonus=4, FalseTrailBonus=6, WaterCrossingBonus=8, BacktrackingBonus=4), time multipliers (HardSurfacesTimeMultiplier=1.0m, BrushTracksTimeMultiplier=1.5m, FalseTrailTimeMultiplier=2.0m, WaterCrossingTimeMultiplier=1.0m, BacktrackingTimeMultiplier=1.25m). Comprehensive logging at Information and Debug levels. |

### Configuration (2 files)

| File | Description |
|------|-------------|
| `config/concealment-techniques.json` | Technique definitions: 5 techniques with id, technique, displayName, description, bonus, timeMultiplier, requirements, flavorText. DC limits (min: 10, max: 30). Stacking rules (bonuses: additive, timeMultipliers: multiplicative). Effectiveness ratings (Minimal 10-14, Moderate 15-19, Effective 20-24, Excellent 25-30). |
| `config/schemas/concealment-techniques.schema.json` | JSON Schema 2020-12 for concealment-techniques.json validation. Defines techniqueDefinition, requirementDefinition, effectivenessRatingDefinition, dcLimitsDefinition, stackingRulesDefinition. |

### Unit Tests (1 file, 30+ tests)

| File | Tests |
|------|-------|
| `CounterTrackingServiceTests.cs` | Technique bonus tests (6 cases: individual techniques, multiple techniques, all techniques), Time multiplier tests (6 cases: no techniques returns 1.0, individual multipliers, compound multipliers), Environmental validation tests (6 cases: WaterCrossing without water, BrushTracks without foliage, always-available techniques, available techniques by environment), Technique description tests, TrackingState integration tests (apply/clear counter-tracking, ActualBaseDc reflection), CounterTrackingResult tests (DC clamping, effectiveness ratings, Failed factory, time penalty calculation), CounterTrackingContext tests (valid/invalid filtering, factory methods, ToSkillContext conversion). |

## Modified

### Domain Layer - Entities (1 file)

| File | Modifications |
|------|---------------|
| `TrackingState.cs` | Added: `ContestedDc` (int?, nullable contested DC from counter-tracking), `ConcealmentTimeMultiplier` (decimal, default 1.0m), `HasCounterTracking` (computed: ContestedDc.HasValue), `ActualBaseDc` (computed: ContestedDc ?? BaseDc). Methods: `ApplyCounterTracking(CounterTrackingResult)`, `ClearCounterTracking()`. Updated `ToDetailedString()` to include counter-tracking info. |

### Application Layer - Service (1 file)

| File | Modifications |
|------|---------------|
| `TrackingService.cs` | Updated XML documentation to reference counter-tracking integration. Changed all DC calculations to use `state.ActualBaseDc` instead of `state.BaseDc` in: `InitiateTrackingAsync()`, `ContinuePursuitAsync()`, `AttemptRecoveryAsync()`, `CloseInAsync()`. Added logging for HasCounterTracking status in all check calculations. |

## Key Features

### Concealment Techniques

| Technique | Bonus | Time Multiplier | Requirement |
|-----------|:-----:|:---------------:|-------------|
| HardSurfaces | +2 | x1.0 | None (always available) |
| BrushTracks | +4 | x1.5 | Foliage or debris |
| FalseTrail | +6 | x2.0 | None (always available) |
| WaterCrossing | +8 | x1.0 | Water nearby |
| Backtracking | +4 | x1.25 | None (always available) |

### Stacking Rules

- **Bonuses**: Stack additively (e.g., +4 + +4 = +8)
- **Time Multipliers**: Compound multiplicatively (e.g., x1.5 × x1.25 = x1.875)

### Concealment DC Calculation

```
ConcealmentDc = Math.Clamp(NetSuccesses + TotalBonus, 10, 30)
```

### Effectiveness Ratings

| DC Range | Rating | Description |
|----------|--------|-------------|
| 10-14 | Minimal | Trail barely concealed |
| 15-19 | Moderate | Average trackers may struggle |
| 20-24 | Effective | Only skilled trackers can follow |
| 25-30 | Excellent | Only expert trackers have a chance |

### Environmental Requirements

| Technique | Requirement |
|-----------|-------------|
| WaterCrossing | `HasWaterNearby = true` |
| BrushTracks | `HasFoliageOrDebris = true` |
| HardSurfaces | None |
| FalseTrail | None |
| Backtracking | None |

### Integration with TrackingService

When counter-tracking is applied to a TrackingState:
1. `TrackingState.ContestedDc` is set to the concealment result DC
2. `TrackingState.ConcealmentTimeMultiplier` is set to the time multiplier
3. `TrackingState.ActualBaseDc` returns ContestedDc instead of BaseDc
4. All TrackingService DC calculations use ActualBaseDc
5. Trackers must beat the higher contested DC to follow the concealed trail

## Files Changed

### Added (9 files)
- `src/Core/RuneAndRust.Domain/Enums/ConcealmentTechnique.cs`
- `src/Core/RuneAndRust.Domain/ValueObjects/CounterTrackingContext.cs`
- `src/Core/RuneAndRust.Domain/ValueObjects/CounterTrackingResult.cs`
- `src/Core/RuneAndRust.Application/Interfaces/ICounterTrackingService.cs`
- `src/Core/RuneAndRust.Application/Services/CounterTrackingService.cs`
- `config/concealment-techniques.json`
- `config/schemas/concealment-techniques.schema.json`
- `tests/RuneAndRust.Application.UnitTests/Services/CounterTrackingServiceTests.cs`
- `changelogs/v0.15.5b-changelog.md`

### Modified (2 files)
- `src/Core/RuneAndRust.Domain/Entities/TrackingState.cs`
- `src/Core/RuneAndRust.Application/Services/TrackingService.cs`

## Dependencies

- `SkillCheckService.cs` - For performing Wasteland Survival concealment checks
- `SkillCheckResult.cs` - Result type from skill checks
- `SkillContext.cs` - For passing situational modifiers
- `TrackingState.cs` - For applying contested DC to tracking pursuits
- `Player.cs` entity - For concealer identification
- `ILogger<CounterTrackingService>` - For comprehensive logging

## Integration Points

- **SkillCheckService**: Uses `PerformCheckWithContext()` for concealment checks
- **SkillContext**: CounterTrackingContext converts to SkillContext via `ToSkillContext()`
- **TrackingState**: Applies counter-tracking via `ApplyCounterTracking()` and `ClearCounterTracking()`
- **TrackingService**: Respects contested DC via `state.ActualBaseDc` property

## Notes

- Technique bonuses stack additively (+2 + +4 + +6 = +12)
- Time multipliers compound multiplicatively (x1.5 × x2.0 = x3.0)
- Concealment DC is clamped between 10-30
- Invalid techniques are filtered out but logged as warnings
- ContestedDc is nullable; null means no counter-tracking active
- ActualBaseDc property transparently handles contested vs base DC
- Counter-tracking establishes the contested skill pattern for future opposed checks
- This builds upon v0.15.5a (Extended Tracking System) infrastructure
